/*! For license information please see main.bundle.js.LICENSE.txt */
(()=>{var e,t,i={2461:(e,t,i)=>{"use strict";i.d(t,{B:()=>s});const s="\n#ifndef SDEFDECLARATION\n#define SDEFDECLARATION\n\n#if NUM_BONE_INFLUENCERS > 0 && defined(SDEF)\nattribute matricesSdefC: vec3f;\nattribute matricesSdefRW0: vec3f;\nattribute matricesSdefRW1: vec3f;\n\nfn rotationMatrixToQuaternion(matrix: mat3x3f) -> vec4f {\n    let trace: f32 = matrix[0][0] + matrix[1][1] + matrix[2][2];\n    var s: f32;\n\n    var sqrtParam: f32;\n    if (trace > 0.0) {\n        sqrtParam = trace + 1.0;\n    } else if (matrix[0][0] > matrix[1][1] && matrix[0][0] > matrix[2][2]) {\n        sqrtParam = 1.0 + matrix[0][0] - matrix[1][1] - matrix[2][2];\n    } else if (matrix[1][1] > matrix[2][2]) {\n        sqrtParam = 1.0 + matrix[1][1] - matrix[0][0] - matrix[2][2];\n    } else {\n        sqrtParam = 1.0 + matrix[2][2] - matrix[0][0] - matrix[1][1];\n    }\n    let sqrtValue: f32 = sqrt(sqrtParam);\n\n    if (trace > 0.0) {\n        s = 0.5 / sqrtValue;\n\n        return vec4f(\n            (matrix[1][2] - matrix[2][1]) * s,\n            (matrix[2][0] - matrix[0][2]) * s,\n            (matrix[0][1] - matrix[1][0]) * s,\n            0.25 / s\n        );\n    } else if (matrix[0][0] > matrix[1][1] && matrix[0][0] > matrix[2][2]) {\n        s = 2.0 * sqrtValue;\n\n        return vec4f(\n            0.25 * s,\n            (matrix[0][1] + matrix[1][0]) / s,\n            (matrix[2][0] + matrix[0][2]) / s,\n            (matrix[1][2] - matrix[2][1]) / s\n        );\n    } else if (matrix[1][1] > matrix[2][2]) {\n        s = 2.0 * sqrtValue;\n        \n        return vec4f(\n            (matrix[0][1] + matrix[1][0]) / s,\n            0.25 * s,\n            (matrix[1][2] + matrix[2][1]) / s,\n            (matrix[2][0] - matrix[0][2]) / s\n        );\n    } else {\n        s = 2.0 * sqrtValue;\n\n        return vec4f(\n            (matrix[2][0] + matrix[0][2]) / s,\n            (matrix[1][2] + matrix[2][1]) / s,\n            0.25 * s,\n            (matrix[0][1] - matrix[1][0]) / s\n        );\n    }\n}\n\nfn quaternionToRotationMatrix(q: vec4f) -> mat3x3f {\n    let xx: f32 = q.x * q.x;\n    let yy: f32 = q.y * q.y;\n    let zz: f32 = q.z * q.z;\n    let xy: f32 = q.x * q.y;\n    let zw: f32 = q.z * q.w;\n    let zx: f32 = q.z * q.x;\n    let yw: f32 = q.y * q.w;\n    let yz: f32 = q.y * q.z;\n    let xw: f32 = q.x * q.w;\n\n    return mat3x3f(\n        1.0 - 2.0 * (yy + zz), 2.0 * (xy + zw), 2.0 * (zx - yw),\n        2.0 * (xy - zw), 1.0 - 2.0 * (zz + xx), 2.0 * (yz + xw),\n        2.0 * (zx + yw), 2.0 * (yz - xw), 1.0 - 2.0 * (yy + xx)\n    );\n}\n\nfn slerp(q0: vec4f, _q1: vec4f, t: f32) -> vec4f {\n    var q1: vec4f = _q1;\n\n    var cosTheta: f32 = dot(q0, q1);\n\n    // if (cosTheta < 0.0) {\n    //     q1 = -q1;\n    //     cosTheta = -cosTheta;\n    // }\n    q1 = mix(-q1, q1, step(0.0, cosTheta));\n    cosTheta = abs(cosTheta);\n    \n    if (cosTheta > 0.999999) {\n        return normalize(mix(q0, q1, t));\n    }\n\n    var theta: f32 = acos(cosTheta);\n    var sinTheta: f32 = sin(theta);\n\n    var w0: f32 = sin((1.0 - t) * theta) / sinTheta;\n    var w1: f32 = sin(t * theta) / sinTheta;\n\n    return q0 * w0 + q1 * w1;\n}\n#endif\n\n#endif\n"},9711:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});const s="\n#ifndef SDEFVERTEX\n#define SDEFVERTEX\n\n#if !defined(BAKED_VERTEX_ANIMATION_TEXTURE) && defined(SDEF)\n\n#if NUM_BONE_INFLUENCERS > 0\n{\n    let weight0: f32 = vertexInputs.matricesWeights[0];\n    let weight1: f32 = vertexInputs.matricesWeights[1];\n\n    #ifdef BONETEXTURE\n        let transformMatrix0: mat4x4f = readMatrixFromRawSampler(boneSampler, vertexInputs.matricesIndices[0]);\n        let transformMatrix1: mat4x4f = readMatrixFromRawSampler(boneSampler, vertexInputs.matricesIndices[1]);\n    #else\n        let transformMatrix0: mat4x4f = uniforms.mBones[int(vertexInputs.matricesIndices[0])];\n        let transformMatrix1: mat4x4f = uniforms.mBones[int(vertexInputs.matricesIndices[1])];\n    #endif\n\n    let slerpedRotationMatrix: mat3x3f = quaternionToRotationMatrix(slerp(\n        rotationMatrixToQuaternion(mat3x3f(transformMatrix0[0].xyz, transformMatrix0[1].xyz, transformMatrix0[2].xyz)),\n        rotationMatrixToQuaternion(mat3x3f(transformMatrix1[0].xyz, transformMatrix1[1].xyz, transformMatrix1[2].xyz)),\n        weight1\n    ));\n\n    // -center transform\n    var sdefInflunce: mat4x4f = mat4x4f(\n        vec4f(1.0, 0.0, 0.0, 0.0),\n        vec4f(0.0, 1.0, 0.0, 0.0),\n        vec4f(0.0, 0.0, 1.0, 0.0),\n        vec4f(-vertexInputs.matricesSdefC, 1.0)\n    );\n\n    // rotation\n    let rotationMatrix: mat4x4f = mat4x4f(\n        vec4f(slerpedRotationMatrix[0], 0.0),\n        vec4f(slerpedRotationMatrix[1], 0.0),\n        vec4f(slerpedRotationMatrix[2], 0.0),\n        vec4f(0.0, 0.0, 0.0, 1.0)\n    );\n    sdefInflunce = rotationMatrix * sdefInflunce;\n\n    // add position offset\n    let positionOffset: vec3f =\n        (transformMatrix0 * vec4f(vertexInputs.matricesSdefRW0, 1)).xyz * weight0 +\n        (transformMatrix1 * vec4f(vertexInputs.matricesSdefRW1, 1)).xyz * weight1;\n\n    sdefInflunce[3] += vec4f(positionOffset, 0.0);\n    \n    let useLinearDeform: f32 = step(0.0, -abs(vertexInputs.matricesSdefRW0.x));\n\n    influence = mat4x4f(\n        mix(sdefInflunce[0], influence[0], useLinearDeform),\n        mix(sdefInflunce[1], influence[1], useLinearDeform),\n        mix(sdefInflunce[2], influence[2], useLinearDeform),\n        mix(sdefInflunce[3], influence[3], useLinearDeform)\n    );\n}\n#endif\n\n#endif\n\n#endif\n"},4852:(e,t,i)=>{"use strict";i.d(t,{B:()=>s});const s="\n#ifndef SDEFDECLARATION\n#define SDEFDECLARATION\n#if NUM_BONE_INFLUENCERS>0 && defined(SDEF)\nattribute vec3 matricesSdefC;attribute vec3 matricesSdefRW0;attribute vec3 matricesSdefRW1;vec4 rotationMatrixToQuaternion(mat3 matrix) {float trace=matrix[0][0]+matrix[1][1]+matrix[2][2];float s;float sqrtParam;if (trace>0.0) {sqrtParam=trace+1.0;} else if (matrix[0][0]>matrix[1][1] && matrix[0][0]>matrix[2][2]) {sqrtParam=1.0+matrix[0][0]-matrix[1][1]-matrix[2][2];} else if (matrix[1][1]>matrix[2][2]) {sqrtParam=1.0+matrix[1][1]-matrix[0][0]-matrix[2][2];} else {sqrtParam=1.0+matrix[2][2]-matrix[0][0]-matrix[1][1];}\nfloat sqrtValue=sqrt(sqrtParam);if (trace>0.0) {s=0.5/sqrtValue;return vec4(\n(matrix[1][2]-matrix[2][1])*s,\n(matrix[2][0]-matrix[0][2])*s,\n(matrix[0][1]-matrix[1][0])*s,\n0.25/s\n);} else if (matrix[0][0]>matrix[1][1] && matrix[0][0]>matrix[2][2]) {s=2.0*sqrtValue;return vec4(\n0.25*s,\n(matrix[0][1]+matrix[1][0])/s,\n(matrix[2][0]+matrix[0][2])/s,\n(matrix[1][2]-matrix[2][1])/s\n);} else if (matrix[1][1]>matrix[2][2]) {s=2.0*sqrtValue;return vec4(\n(matrix[0][1]+matrix[1][0])/s,\n0.25*s,\n(matrix[1][2]+matrix[2][1])/s,\n(matrix[2][0]-matrix[0][2])/s\n);} else {s=2.0*sqrtValue;return vec4(\n(matrix[2][0]+matrix[0][2])/s,\n(matrix[1][2]+matrix[2][1])/s,\n0.25*s,\n(matrix[0][1]-matrix[1][0])/s\n);}}\nmat3 quaternionToRotationMatrix(vec4 q) {float xx=q.x*q.x;float yy=q.y*q.y;float zz=q.z*q.z;float xy=q.x*q.y;float zw=q.z*q.w;float zx=q.z*q.x;float yw=q.y*q.w;float yz=q.y*q.z;float xw=q.x*q.w;return mat3(\n1.0-2.0*(yy+zz),2.0*(xy+zw),2.0*(zx-yw),\n2.0*(xy-zw),1.0-2.0*(zz+xx),2.0*(yz+xw),\n2.0*(zx+yw),2.0*(yz-xw),1.0-2.0*(yy+xx)\n);}\nvec4 slerp(vec4 q0,vec4 q1,float t) {float cosTheta=dot(q0,q1);q1=mix(-q1,q1,step(0.0,cosTheta));cosTheta=abs(cosTheta);if (cosTheta>0.999999) {return normalize(mix(q0,q1,t));}\nfloat theta=acos(cosTheta);float sinTheta=sin(theta);float w0=sin((1.0-t)*theta)/sinTheta;float w1=sin(t*theta)/sinTheta;return q0*w0+q1*w1;}\n#endif\n#endif\n"},3376:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});const s="\n#ifndef SDEFVERTEX\n#define SDEFVERTEX\n#if !defined(BAKED_VERTEX_ANIMATION_TEXTURE) && defined(SDEF)\n#if NUM_BONE_INFLUENCERS>0\n{float weight0=matricesWeights[0];float weight1=matricesWeights[1];\n#ifdef BONETEXTURE\nmat4 transformMatrix0=readMatrixFromRawSampler(boneSampler,matricesIndices[0]);mat4 transformMatrix1=readMatrixFromRawSampler(boneSampler,matricesIndices[1]);\n#else\nmat4 transformMatrix0=mBones[int(matricesIndices[0])];mat4 transformMatrix1=mBones[int(matricesIndices[1])];\n#endif\nmat3 slerpedRotationMatrix=quaternionToRotationMatrix(slerp(\nrotationMatrixToQuaternion(mat3(transformMatrix0)),\nrotationMatrixToQuaternion(mat3(transformMatrix1)),\nweight1\n));mat4 sdefInflunce=mat4(\nvec4(1.0,0.0,0.0,0.0),\nvec4(0.0,1.0,0.0,0.0),\nvec4(0.0,0.0,1.0,0.0),\nvec4(-matricesSdefC,1.0)\n);mat4 rotationMatrix=mat4(\nvec4(slerpedRotationMatrix[0],0.0),\nvec4(slerpedRotationMatrix[1],0.0),\nvec4(slerpedRotationMatrix[2],0.0),\nvec4(0.0,0.0,0.0,1.0)\n);sdefInflunce=rotationMatrix*sdefInflunce;vec3 positionOffset =\nvec3(transformMatrix0*vec4(matricesSdefRW0,1))*weight0 +\nvec3(transformMatrix1*vec4(matricesSdefRW1,1))*weight1;sdefInflunce[3]+=vec4(positionOffset,0.0);float useLinearDeform=step(0.0,-abs(matricesSdefRW0.x));influence=mat4(\nmix(sdefInflunce[0],influence[0],useLinearDeform),\nmix(sdefInflunce[1],influence[1],useLinearDeform),\nmix(sdefInflunce[2],influence[2],useLinearDeform),\nmix(sdefInflunce[3],influence[3],useLinearDeform)\n);}\n#endif\n#endif\n#endif\n"},471:(e,t,i)=>{"use strict";i.d(t,{V:()=>s});class s{static AdditionalUV1Kind="additionalUv1";static AdditionalUV2Kind="additionalUv2";static AdditionalUV3Kind="additionalUv3";static AdditionalUV4Kind="additionalUv4";static MatricesSdefCKind="matricesSdefC";static MatricesSdefRW0Kind="matricesSdefRW0";static MatricesSdefRW1Kind="matricesSdefRW1";static MatricesSdefR0Kind="matricesSdefR0";static MatricesSdefR1Kind="matricesSdefR1";static EdgeScaleKind="edgeScale"}},6561:(e,t,i)=>{"use strict";i.d(t,{ZL:()=>_,rw:()=>s});var s,r=i(6125),n=i(9526),a=i(2277),o=i(6041),l=i(9259),h=i(6552),c=i(471),u=function(e,t,i,s){var r,n=arguments.length,a=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(n<3?r(a):n>3?r(t,i,a):r(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a};class d extends n.M{SPHERE_TEXTURE=!1;SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1;SPHERE_TEXTURE_BLEND_MODE_ADD=!1;TOON_TEXTURE=!1;IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1;APPLY_AMBIENT_COLOR_TO_DIFFUSE=!1;CLAMP_ALPHA=!1;TEXTURE_COLOR=!1;SPHERE_TEXTURE_COLOR=!1;TOON_TEXTURE_COLOR=!1;SDEF=!1}!function(e){e[e.Multiply=1]="Multiply",e[e.Add=2]="Add",e[e.SubTexture=3]="SubTexture"}(s||(s={}));class _ extends a.y{_sphereTexture=null;_sphereTextureBlendMode=s.Add;_toonTexture=null;_ignoreDiffuseWhenToonTextureIsNull=!1;textureMultiplicativeColor=new o.ov(1,1,1,1);textureAdditiveColor=new o.ov(0,0,0,0);sphereTextureMultiplicativeColor=new o.ov(1,1,1,1);sphereTextureAdditiveColor=new o.ov(0,0,0,0);toonTextureMultiplicativeColor=new o.ov(1,1,1,1);toonTextureAdditiveColor=new o.ov(0,0,0,0);_applyAmbientColorToDiffuse=!0;_clampAlpha=!0;_useTextureColor=!1;_useSphereTextureColor=!1;_useToonTextureColor=!1;_isEnabled=!1;get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this.markAllDefinesAsDirty(),this._enable(e))}get sphereTexture(){return this._sphereTexture}set sphereTexture(e){this._sphereTexture!==e&&(this._sphereTexture=e,this._markAllSubMeshesAsTexturesDirty())}get sphereTextureBlendMode(){return this._sphereTextureBlendMode}set sphereTextureBlendMode(e){this._sphereTextureBlendMode!==e&&(this._sphereTextureBlendMode=e,this.markAllDefinesAsDirty())}get toonTexture(){return this._toonTexture}set toonTexture(e){this._toonTexture!==e&&(this._toonTexture=e,this._markAllSubMeshesAsTexturesDirty())}get ignoreDiffuseWhenToonTextureIsNull(){return this._ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._ignoreDiffuseWhenToonTextureIsNull!==e&&(this._ignoreDiffuseWhenToonTextureIsNull=e,this.markAllDefinesAsDirty())}get applyAmbientColorToDiffuse(){return this._applyAmbientColorToDiffuse}set applyAmbientColorToDiffuse(e){this._applyAmbientColorToDiffuse!==e&&(this._applyAmbientColorToDiffuse=e,this.markAllDefinesAsDirty())}get clampAlpha(){return this._clampAlpha}set clampAlpha(e){this._clampAlpha!==e&&(this._clampAlpha=e,this.markAllDefinesAsDirty())}get useTextureColor(){return this._useTextureColor}set useTextureColor(e){this._useTextureColor!==e&&(this._useTextureColor=e,this.markAllDefinesAsDirty())}get useSphereTextureColor(){return this._useSphereTextureColor}set useSphereTextureColor(e){this._useSphereTextureColor!==e&&(this._useSphereTextureColor=e,this.markAllDefinesAsDirty())}get useToonTextureColor(){return this._useToonTextureColor}set useToonTextureColor(e){this._useToonTextureColor!==e&&(this._useToonTextureColor=e,this.markAllDefinesAsDirty())}_internalMarkAllSubMeshesAsTexturesDirty;_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(e){return!0}constructor(e,t=!0,i=!1,s=!1){super(e,"MmdMaterial",100,new d,t,i,s),this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[r.Y.MATERIAL_TextureDirtyFlag]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._sphereTexture&&!this._sphereTexture.isReadyOrNotBlocking())}bindForSubMesh(e,t,i,s){if(!this._isEnabled)return;const r=s.materialDefines,n=this._material.isFrozen;e.useUbo&&n&&e.isSync||(r.DIFFUSE&&r.TEXTURE_COLOR&&(e.updateDirectColor4("textureMultiplicativeColor",this.textureMultiplicativeColor),e.updateDirectColor4("textureAdditiveColor",this.textureAdditiveColor)),r.NORMAL&&r.SPHERE_TEXTURE&&r.SPHERE_TEXTURE_COLOR&&(e.updateDirectColor4("sphereTextureMultiplicativeColor",this.sphereTextureMultiplicativeColor),e.updateDirectColor4("sphereTextureAdditiveColor",this.sphereTextureAdditiveColor)),r.TOON_TEXTURE&&r.TOON_TEXTURE_COLOR&&(e.updateDirectColor4("toonTextureMultiplicativeColor",this.toonTextureMultiplicativeColor),e.updateDirectColor4("toonTextureAdditiveColor",this.toonTextureAdditiveColor)),r.SPHERE_TEXTURE&&null!==s.effect&&this._material.bindView(s.effect)),t.texturesEnabled&&(r.NORMAL&&this._sphereTexture&&e.setTexture("sphereSampler",this._sphereTexture),this._toonTexture&&e.setTexture("toonSampler",this._toonTexture))}dispose(e){e&&(this._sphereTexture?.dispose(),this._toonTexture?.dispose())}prepareDefines(e,t,i){if(this._isEnabled){const r=t.texturesEnabled;e.SPHERE_TEXTURE=null!==this._sphereTexture&&r,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=this._sphereTextureBlendMode===s.Multiply,e.SPHERE_TEXTURE_BLEND_MODE_ADD=this._sphereTextureBlendMode===s.Add,e.TOON_TEXTURE=null!==this._toonTexture&&r,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=this._ignoreDiffuseWhenToonTextureIsNull,e.APPLY_AMBIENT_COLOR_TO_DIFFUSE=this._applyAmbientColorToDiffuse,e.CLAMP_ALPHA=this._clampAlpha,e.TEXTURE_COLOR=this._useTextureColor,e.SPHERE_TEXTURE_COLOR=this._useSphereTextureColor,e.TOON_TEXTURE_COLOR=this._useToonTextureColor,e.SDEF=i.useBones&&i.computeBonesUsingShaders&&!!i.skeleton&&i.isVerticesDataPresent(c.V.MatricesSdefCKind)}else e.SPHERE_TEXTURE=!1,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1,e.SPHERE_TEXTURE_BLEND_MODE_ADD=!1,e.TOON_TEXTURE=!1,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1,e.APPLY_AMBIENT_COLOR_TO_DIFFUSE=!1,e.CLAMP_ALPHA=!1,e.TEXTURE_COLOR=!1,e.SPHERE_TEXTURE_COLOR=!1,e.TOON_TEXTURE_COLOR=!1,e.SDEF=!1}hasTexture(e){return this._sphereTexture===e||this._toonTexture===e}getActiveTextures(e){this._sphereTexture&&e.push(this._sphereTexture),this._toonTexture&&e.push(this._toonTexture)}getAnimatables(e){this._sphereTexture&&this._sphereTexture.animations&&0<this._sphereTexture.animations.length&&e.push(this._sphereTexture),this._toonTexture&&this._toonTexture.animations&&0<this._toonTexture.animations.length&&e.push(this._toonTexture)}getSamplers(e){e.push("sphereSampler","toonSampler")}getAttributes(e,t,i){this._isEnabled&&i.useBones&&i.computeBonesUsingShaders&&i.skeleton&&i.isVerticesDataPresent(c.V.MatricesSdefCKind)&&(e.push(c.V.MatricesSdefCKind),e.push(c.V.MatricesSdefRW0Kind),e.push(c.V.MatricesSdefRW1Kind))}getUniforms(e){return{ubo:[{name:"textureMultiplicativeColor",size:4,type:"vec4"},{name:"textureAdditiveColor",size:4,type:"vec4"},{name:"sphereTextureMultiplicativeColor",size:4,type:"vec4"},{name:"sphereTextureAdditiveColor",size:4,type:"vec4"},{name:"toonTextureMultiplicativeColor",size:4,type:"vec4"},{name:"toonTextureAdditiveColor",size:4,type:"vec4"}]}}getClassName(){return"MmdPluginMaterial"}}u([(0,l.uM)("sphereTexture")],_.prototype,"_sphereTexture",void 0),u([(0,l.lK)("sphereTextureBlendMode")],_.prototype,"_sphereTextureBlendMode",void 0),u([(0,l.uM)("toonTexture")],_.prototype,"_toonTexture",void 0),u([(0,l.lK)("ignoreDiffuseWhenToonTextureIsNull")],_.prototype,"_ignoreDiffuseWhenToonTextureIsNull",void 0),u([(0,l.lK)("applyAmbientColorToDiffuse")],_.prototype,"_applyAmbientColorToDiffuse",void 0),u([(0,l.lK)("clampAlpha")],_.prototype,"_clampAlpha",void 0),(0,h.Y5)("BABYLON.MmdPluginMaterial",_)},456:(e,t,i)=>{"use strict";var s=i(453),r=i(487),n=r(s("String.prototype.indexOf"));e.exports=function(e,t){var i=s(e,!!t);return"function"==typeof i&&n(e,".prototype.")>-1?r(i):i}},487:(e,t,i)=>{"use strict";var s=i(6743),r=i(453),n=i(6897),a=i(9675),o=r("%Function.prototype.apply%"),l=r("%Function.prototype.call%"),h=r("%Reflect.apply%",!0)||s.call(l,o),c=i(3036),u=r("%Math.max%");e.exports=function(e){if("function"!=typeof e)throw new a("a function is required");var t=h(s,l,arguments);return n(t,1+u(0,e.length-(arguments.length-1)),!0)};var d=function(){return h(s,o,arguments)};c?c(e.exports,"apply",{value:d}):e.exports.apply=d},836:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.apiConfig=void 0;var s=i(5373);t.apiConfig={returnRejectedPromiseOnError:!0,withCredentials:!1,timeout:3e4,baseURL:"https://api.counterapi.dev/v1/",headers:{common:{"Content-Type":"application/json",Accept:"application/json"}},paramsSerializer:function(e){return s.stringify(e,{indices:!1})},validateStatus:function(e){return 200==e}}},7798:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Count=t.Counter=void 0;t.Counter=function(e){Object.assign(this,e)};t.Count=function(e){Object.assign(this,e)}},4892:function(e,t,i){"use strict";var s=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(r,n){function a(e){try{l(s.next(e))}catch(e){n(e)}}function o(e){try{l(s.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}l((s=s.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var i,s,r,n,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return n={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function o(o){return function(l){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;n&&(n=0,o[0]&&(a=0)),a;)try{if(i=1,s&&(r=2&o[0]?s.return:o[0]?s.throw||((r=s.return)&&r.call(s),0):s.next)&&!(r=r.call(s,o[1])).done)return r;switch(s=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,s=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],s=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.CounterAPI=t.OrderByTypes=t.GroupByTypes=void 0;var n,a,o=i(836),l=i(6425),h=i(7798),c=i(8600);!function(e){e.Day="day",e.Week="week",e.Month="month",e.Year="year"}(n||(t.GroupByTypes=n={})),function(e){e.ASC="asc",e.DESC="desc"}(a||(t.OrderByTypes=a={}));var u=function(){function e(){this.axios=l.default.create(o.apiConfig)}return e.prototype.up=function(e,t,i){return void 0===i&&(i=!1),s(this,void 0,void 0,(function(){return r(this,(function(s){switch(s.label){case 0:return i&&(t=c.Hash.create(t)),[4,this.axios.get("".concat(e,"/").concat(t,"/up")).then((function(e){return new h.Counter({ID:e.data.id,Name:e.data.name,Count:e.data.count,UpdatedAt:e.data.updated_at,CreatedAt:e.data.created_at})})).catch((function(e){throw new Error(e)}))];case 1:return[2,s.sent()]}}))}))},e.prototype.down=function(e,t,i){return void 0===i&&(i=!1),s(this,void 0,void 0,(function(){return r(this,(function(s){switch(s.label){case 0:return i&&(t=c.Hash.create(t)),[4,this.axios.get("".concat(e,"/").concat(t,"/down")).then((function(e){return new h.Counter({ID:e.data.id,Name:e.data.name,Count:e.data.count,UpdatedAt:e.data.updated_at,CreatedAt:e.data.created_at})})).catch((function(e){throw new Error(e)}))];case 1:return[2,s.sent()]}}))}))},e.prototype.get=function(e,t,i){return void 0===i&&(i=!1),s(this,void 0,void 0,(function(){return r(this,(function(s){switch(s.label){case 0:return i&&(t=c.Hash.create(t)),[4,this.axios.get("".concat(e,"/").concat(t,"/")).then((function(e){return new h.Counter({ID:e.data.id,Name:e.data.name,Count:e.data.count,UpdatedAt:e.data.updated_at,CreatedAt:e.data.created_at})})).catch((function(e){throw new Error(e)}))];case 1:return[2,s.sent()]}}))}))},e.prototype.set=function(e,t,i,n){return void 0===n&&(n=!1),s(this,void 0,void 0,(function(){return r(this,(function(s){switch(s.label){case 0:return n&&(t=c.Hash.create(t)),[4,this.axios.get("".concat(e,"/").concat(t,"/set"),{params:{count:i}}).then((function(e){return new h.Counter({ID:e.data.id,Name:e.data.name,Count:e.data.count,UpdatedAt:e.data.updated_at,CreatedAt:e.data.created_at})})).catch((function(e){throw new Error(e)}))];case 1:return[2,s.sent()]}}))}))},e.prototype.counts=function(e,t,i){return s(this,void 0,void 0,(function(){return r(this,(function(s){switch(s.label){case 0:return i.hash&&(t=c.Hash.create(t)),[4,this.axios.get("".concat(e,"/").concat(t,"/list"),{params:i}).then((function(e){var t=[];return e.data.forEach((function(e){t.push(new h.Count({Count:e.count,Date:e.date}))})),t})).catch((function(e){throw new Error(e)}))];case 1:return[2,s.sent()]}}))}))},e}();t.CounterAPI=u},8600:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Hash=void 0;var s=i(1312),r=function(){function e(){}return e.create=function(e){return s.sha256.update(e).hex()},e}();t.Hash=r},2722:function(e,t,i){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),r=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||s(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),r(i(7798),t),r(i(4892),t),r(i(836),t),r(i(8600),t)},41:(e,t,i)=>{"use strict";var s=i(3036),r=i(8068),n=i(9675),a=i(5795);e.exports=function(e,t,i){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new n("`obj` must be an object or a function`");if("string"!=typeof t&&"symbol"!=typeof t)throw new n("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!=typeof arguments[3]&&null!==arguments[3])throw new n("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!=typeof arguments[4]&&null!==arguments[4])throw new n("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!=typeof arguments[5]&&null!==arguments[5])throw new n("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!=typeof arguments[6])throw new n("`loose`, if provided, must be a boolean");var o=arguments.length>3?arguments[3]:null,l=arguments.length>4?arguments[4]:null,h=arguments.length>5?arguments[5]:null,c=arguments.length>6&&arguments[6],u=!!a&&a(e,t);if(s)s(e,t,{configurable:null===h&&u?u.configurable:!h,enumerable:null===o&&u?u.enumerable:!o,value:i,writable:null===l&&u?u.writable:!l});else{if(!c&&(o||l||h))throw new r("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");e[t]=i}}},3036:(e,t,i)=>{"use strict";var s=i(453)("%Object.defineProperty%",!0)||!1;if(s)try{s({},"a",{value:1})}catch(e){s=!1}e.exports=s},1237:e=>{"use strict";e.exports=EvalError},9383:e=>{"use strict";e.exports=Error},9290:e=>{"use strict";e.exports=RangeError},9538:e=>{"use strict";e.exports=ReferenceError},8068:e=>{"use strict";e.exports=SyntaxError},9675:e=>{"use strict";e.exports=TypeError},5345:e=>{"use strict";e.exports=URIError},9353:e=>{"use strict";var t=Object.prototype.toString,i=Math.max,s=function(e,t){for(var i=[],s=0;s<e.length;s+=1)i[s]=e[s];for(var r=0;r<t.length;r+=1)i[r+e.length]=t[r];return i};e.exports=function(e){var r=this;if("function"!=typeof r||"[object Function]"!==t.apply(r))throw new TypeError("Function.prototype.bind called on incompatible "+r);for(var n,a=function(e,t){for(var i=[],s=1,r=0;s<e.length;s+=1,r+=1)i[r]=e[s];return i}(arguments),o=i(0,r.length-a.length),l=[],h=0;h<o;h++)l[h]="$"+h;if(n=Function("binder","return function ("+function(e,t){for(var i="",s=0;s<e.length;s+=1)i+=e[s],s+1<e.length&&(i+=",");return i}(l)+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof n){var t=r.apply(this,s(a,arguments));return Object(t)===t?t:this}return r.apply(e,s(a,arguments))})),r.prototype){var c=function(){};c.prototype=r.prototype,n.prototype=new c,c.prototype=null}return n}},6743:(e,t,i)=>{"use strict";var s=i(9353);e.exports=Function.prototype.bind||s},453:(e,t,i)=>{"use strict";var s,r=i(9383),n=i(1237),a=i(9290),o=i(9538),l=i(8068),h=i(9675),c=i(5345),u=Function,d=function(e){try{return u('"use strict"; return ('+e+").constructor;")()}catch(e){}},_=Object.getOwnPropertyDescriptor;if(_)try{_({},"")}catch(e){_=null}var p=function(){throw new h},f=_?function(){try{return p}catch(e){try{return _(arguments,"callee").get}catch(e){return p}}}():p,m=i(4039)(),g=i(24)(),v=Object.getPrototypeOf||(g?function(e){return e.__proto__}:null),b={},x="undefined"!=typeof Uint8Array&&v?v(Uint8Array):s,S={__proto__:null,"%AggregateError%":"undefined"==typeof AggregateError?s:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?s:ArrayBuffer,"%ArrayIteratorPrototype%":m&&v?v([][Symbol.iterator]()):s,"%AsyncFromSyncIteratorPrototype%":s,"%AsyncFunction%":b,"%AsyncGenerator%":b,"%AsyncGeneratorFunction%":b,"%AsyncIteratorPrototype%":b,"%Atomics%":"undefined"==typeof Atomics?s:Atomics,"%BigInt%":"undefined"==typeof BigInt?s:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?s:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?s:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?s:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":r,"%eval%":eval,"%EvalError%":n,"%Float32Array%":"undefined"==typeof Float32Array?s:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?s:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?s:FinalizationRegistry,"%Function%":u,"%GeneratorFunction%":b,"%Int8Array%":"undefined"==typeof Int8Array?s:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?s:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?s:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":m&&v?v(v([][Symbol.iterator]())):s,"%JSON%":"object"==typeof JSON?JSON:s,"%Map%":"undefined"==typeof Map?s:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&m&&v?v((new Map)[Symbol.iterator]()):s,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?s:Promise,"%Proxy%":"undefined"==typeof Proxy?s:Proxy,"%RangeError%":a,"%ReferenceError%":o,"%Reflect%":"undefined"==typeof Reflect?s:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?s:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&m&&v?v((new Set)[Symbol.iterator]()):s,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?s:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":m&&v?v(""[Symbol.iterator]()):s,"%Symbol%":m?Symbol:s,"%SyntaxError%":l,"%ThrowTypeError%":f,"%TypedArray%":x,"%TypeError%":h,"%Uint8Array%":"undefined"==typeof Uint8Array?s:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?s:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?s:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?s:Uint32Array,"%URIError%":c,"%WeakMap%":"undefined"==typeof WeakMap?s:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?s:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?s:WeakSet};if(v)try{null.error}catch(e){var T=v(v(e));S["%Error.prototype%"]=T}var y=function e(t){var i;if("%AsyncFunction%"===t)i=d("async function () {}");else if("%GeneratorFunction%"===t)i=d("function* () {}");else if("%AsyncGeneratorFunction%"===t)i=d("async function* () {}");else if("%AsyncGenerator%"===t){var s=e("%AsyncGeneratorFunction%");s&&(i=s.prototype)}else if("%AsyncIteratorPrototype%"===t){var r=e("%AsyncGenerator%");r&&v&&(i=v(r.prototype))}return S[t]=i,i},C={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},P=i(6743),E=i(9957),A=P.call(Function.call,Array.prototype.concat),R=P.call(Function.apply,Array.prototype.splice),I=P.call(Function.call,String.prototype.replace),M=P.call(Function.call,String.prototype.slice),O=P.call(Function.call,RegExp.prototype.exec),w=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,D=/\\(\\)?/g,F=function(e,t){var i,s=e;if(E(C,s)&&(s="%"+(i=C[s])[0]+"%"),E(S,s)){var r=S[s];if(r===b&&(r=y(s)),void 0===r&&!t)throw new h("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:i,name:s,value:r}}throw new l("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!=typeof e||0===e.length)throw new h("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new h('"allowMissing" argument must be a boolean');if(null===O(/^%?[^%]*%?$/,e))throw new l("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var i=function(e){var t=M(e,0,1),i=M(e,-1);if("%"===t&&"%"!==i)throw new l("invalid intrinsic syntax, expected closing `%`");if("%"===i&&"%"!==t)throw new l("invalid intrinsic syntax, expected opening `%`");var s=[];return I(e,w,(function(e,t,i,r){s[s.length]=i?I(r,D,"$1"):t||e})),s}(e),s=i.length>0?i[0]:"",r=F("%"+s+"%",t),n=r.name,a=r.value,o=!1,c=r.alias;c&&(s=c[0],R(i,A([0,1],c)));for(var u=1,d=!0;u<i.length;u+=1){var p=i[u],f=M(p,0,1),m=M(p,-1);if(('"'===f||"'"===f||"`"===f||'"'===m||"'"===m||"`"===m)&&f!==m)throw new l("property names with quotes must have matching quotes");if("constructor"!==p&&d||(o=!0),E(S,n="%"+(s+="."+p)+"%"))a=S[n];else if(null!=a){if(!(p in a)){if(!t)throw new h("base intrinsic for "+e+" exists, but the property is not available.");return}if(_&&u+1>=i.length){var g=_(a,p);a=(d=!!g)&&"get"in g&&!("originalValue"in g.get)?g.get:a[p]}else d=E(a,p),a=a[p];d&&!o&&(S[n]=a)}}return a}},5795:(e,t,i)=>{"use strict";var s=i(453)("%Object.getOwnPropertyDescriptor%",!0);if(s)try{s([],"length")}catch(e){s=null}e.exports=s},592:(e,t,i)=>{"use strict";var s=i(3036),r=function(){return!!s};r.hasArrayLengthDefineBug=function(){if(!s)return null;try{return 1!==s([],"length",{value:1}).length}catch(e){return!0}},e.exports=r},24:e=>{"use strict";var t={__proto__:null,foo:{}},i=Object;e.exports=function(){return{__proto__:t}.foo===t.foo&&!(t instanceof i)}},4039:(e,t,i)=>{"use strict";var s="undefined"!=typeof Symbol&&Symbol,r=i(1333);e.exports=function(){return"function"==typeof s&&"function"==typeof Symbol&&"symbol"==typeof s("foo")&&"symbol"==typeof Symbol("bar")&&r()}},1333:e=>{"use strict";e.exports=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),i=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(i))return!1;for(t in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var s=Object.getOwnPropertySymbols(e);if(1!==s.length||s[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var r=Object.getOwnPropertyDescriptor(e,t);if(42!==r.value||!0!==r.enumerable)return!1}return!0}},9957:(e,t,i)=>{"use strict";var s=Function.prototype.call,r=Object.prototype.hasOwnProperty,n=i(6743);e.exports=n.call(s,r)},1312:(e,t,i)=>{var s;!function(){"use strict";var t="input is invalid type",r="object"==typeof window,n=r?window:{};n.JS_SHA256_NO_WINDOW&&(r=!1);var a=!r&&"object"==typeof self,o=!n.JS_SHA256_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;o?n=i.g:a&&(n=self);var l=!n.JS_SHA256_NO_COMMON_JS&&e.exports,h=i.amdO,c=!n.JS_SHA256_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,u="0123456789abcdef".split(""),d=[-2147483648,8388608,32768,128],_=[24,16,8,0],p=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],f=["hex","array","digest","arrayBuffer"],m=[];!n.JS_SHA256_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),!c||!n.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var g=function(e,t){return function(i){return new T(t,!0).update(i)[e]()}},v=function(e){var t=g("hex",e);o&&(t=b(t,e)),t.create=function(){return new T(e)},t.update=function(e){return t.create().update(e)};for(var i=0;i<f.length;++i){var s=f[i];t[s]=g(s,e)}return t},b=function(e,s){var r,a=i(4394),o=i(4284).Buffer,l=s?"sha224":"sha256";return r=o.from&&!n.JS_SHA256_NO_BUFFER_FROM?o.from:function(e){return new o(e)},function(i){if("string"==typeof i)return a.createHash(l).update(i,"utf8").digest("hex");if(null==i)throw new Error(t);return i.constructor===ArrayBuffer&&(i=new Uint8Array(i)),Array.isArray(i)||ArrayBuffer.isView(i)||i.constructor===o?a.createHash(l).update(r(i)).digest("hex"):e(i)}},x=function(e,t){return function(i,s){return new y(i,t,!0).update(s)[e]()}},S=function(e){var t=x("hex",e);t.create=function(t){return new y(t,e)},t.update=function(e,i){return t.create(e).update(i)};for(var i=0;i<f.length;++i){var s=f[i];t[s]=x(s,e)}return t};function T(e,t){t?(m[0]=m[16]=m[1]=m[2]=m[3]=m[4]=m[5]=m[6]=m[7]=m[8]=m[9]=m[10]=m[11]=m[12]=m[13]=m[14]=m[15]=0,this.blocks=m):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}function y(e,i,s){var r,n=typeof e;if("string"===n){var a,o=[],l=e.length,h=0;for(r=0;r<l;++r)(a=e.charCodeAt(r))<128?o[h++]=a:a<2048?(o[h++]=192|a>>>6,o[h++]=128|63&a):a<55296||a>=57344?(o[h++]=224|a>>>12,o[h++]=128|a>>>6&63,o[h++]=128|63&a):(a=65536+((1023&a)<<10|1023&e.charCodeAt(++r)),o[h++]=240|a>>>18,o[h++]=128|a>>>12&63,o[h++]=128|a>>>6&63,o[h++]=128|63&a);e=o}else{if("object"!==n)throw new Error(t);if(null===e)throw new Error(t);if(c&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||c&&ArrayBuffer.isView(e)))throw new Error(t)}e.length>64&&(e=new T(i,!0).update(e).array());var u=[],d=[];for(r=0;r<64;++r){var _=e[r]||0;u[r]=92^_,d[r]=54^_}T.call(this,i,s),this.update(d),this.oKeyPad=u,this.inner=!0,this.sharedMemory=s}T.prototype.update=function(e){if(!this.finalized){var i,s=typeof e;if("string"!==s){if("object"!==s)throw new Error(t);if(null===e)throw new Error(t);if(c&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||c&&ArrayBuffer.isView(e)))throw new Error(t);i=!0}for(var r,n,a=0,o=e.length,l=this.blocks;a<o;){if(this.hashed&&(this.hashed=!1,l[0]=this.block,this.block=l[16]=l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=l[7]=l[8]=l[9]=l[10]=l[11]=l[12]=l[13]=l[14]=l[15]=0),i)for(n=this.start;a<o&&n<64;++a)l[n>>>2]|=e[a]<<_[3&n++];else for(n=this.start;a<o&&n<64;++a)(r=e.charCodeAt(a))<128?l[n>>>2]|=r<<_[3&n++]:r<2048?(l[n>>>2]|=(192|r>>>6)<<_[3&n++],l[n>>>2]|=(128|63&r)<<_[3&n++]):r<55296||r>=57344?(l[n>>>2]|=(224|r>>>12)<<_[3&n++],l[n>>>2]|=(128|r>>>6&63)<<_[3&n++],l[n>>>2]|=(128|63&r)<<_[3&n++]):(r=65536+((1023&r)<<10|1023&e.charCodeAt(++a)),l[n>>>2]|=(240|r>>>18)<<_[3&n++],l[n>>>2]|=(128|r>>>12&63)<<_[3&n++],l[n>>>2]|=(128|r>>>6&63)<<_[3&n++],l[n>>>2]|=(128|63&r)<<_[3&n++]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=l[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},T.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=d[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},T.prototype.hash=function(){var e,t,i,s,r,n,a,o,l,h=this.h0,c=this.h1,u=this.h2,d=this.h3,_=this.h4,f=this.h5,m=this.h6,g=this.h7,v=this.blocks;for(e=16;e<64;++e)t=((r=v[e-15])>>>7|r<<25)^(r>>>18|r<<14)^r>>>3,i=((r=v[e-2])>>>17|r<<15)^(r>>>19|r<<13)^r>>>10,v[e]=v[e-16]+t+v[e-7]+i|0;for(l=c&u,e=0;e<64;e+=4)this.first?(this.is224?(n=300032,g=(r=v[0]-1413257819)-150054599|0,d=r+24177077|0):(n=704751109,g=(r=v[0]-210244248)-1521486534|0,d=r+143694565|0),this.first=!1):(t=(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),s=(n=h&c)^h&u^l,g=d+(r=g+(i=(_>>>6|_<<26)^(_>>>11|_<<21)^(_>>>25|_<<7))+(_&f^~_&m)+p[e]+v[e])|0,d=r+(t+s)|0),t=(d>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),s=(a=d&h)^d&c^n,m=u+(r=m+(i=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7))+(g&_^~g&f)+p[e+1]+v[e+1])|0,t=((u=r+(t+s)|0)>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),s=(o=u&d)^u&h^a,f=c+(r=f+(i=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7))+(m&g^~m&_)+p[e+2]+v[e+2])|0,t=((c=r+(t+s)|0)>>>2|c<<30)^(c>>>13|c<<19)^(c>>>22|c<<10),s=(l=c&u)^c&d^o,_=h+(r=_+(i=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7))+(f&m^~f&g)+p[e+3]+v[e+3])|0,h=r+(t+s)|0,this.chromeBugWorkAround=!0;this.h0=this.h0+h|0,this.h1=this.h1+c|0,this.h2=this.h2+u|0,this.h3=this.h3+d|0,this.h4=this.h4+_|0,this.h5=this.h5+f|0,this.h6=this.h6+m|0,this.h7=this.h7+g|0},T.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,s=this.h3,r=this.h4,n=this.h5,a=this.h6,o=this.h7,l=u[e>>>28&15]+u[e>>>24&15]+u[e>>>20&15]+u[e>>>16&15]+u[e>>>12&15]+u[e>>>8&15]+u[e>>>4&15]+u[15&e]+u[t>>>28&15]+u[t>>>24&15]+u[t>>>20&15]+u[t>>>16&15]+u[t>>>12&15]+u[t>>>8&15]+u[t>>>4&15]+u[15&t]+u[i>>>28&15]+u[i>>>24&15]+u[i>>>20&15]+u[i>>>16&15]+u[i>>>12&15]+u[i>>>8&15]+u[i>>>4&15]+u[15&i]+u[s>>>28&15]+u[s>>>24&15]+u[s>>>20&15]+u[s>>>16&15]+u[s>>>12&15]+u[s>>>8&15]+u[s>>>4&15]+u[15&s]+u[r>>>28&15]+u[r>>>24&15]+u[r>>>20&15]+u[r>>>16&15]+u[r>>>12&15]+u[r>>>8&15]+u[r>>>4&15]+u[15&r]+u[n>>>28&15]+u[n>>>24&15]+u[n>>>20&15]+u[n>>>16&15]+u[n>>>12&15]+u[n>>>8&15]+u[n>>>4&15]+u[15&n]+u[a>>>28&15]+u[a>>>24&15]+u[a>>>20&15]+u[a>>>16&15]+u[a>>>12&15]+u[a>>>8&15]+u[a>>>4&15]+u[15&a];return this.is224||(l+=u[o>>>28&15]+u[o>>>24&15]+u[o>>>20&15]+u[o>>>16&15]+u[o>>>12&15]+u[o>>>8&15]+u[o>>>4&15]+u[15&o]),l},T.prototype.toString=T.prototype.hex,T.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,s=this.h3,r=this.h4,n=this.h5,a=this.h6,o=this.h7,l=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,s>>>24&255,s>>>16&255,s>>>8&255,255&s,r>>>24&255,r>>>16&255,r>>>8&255,255&r,n>>>24&255,n>>>16&255,n>>>8&255,255&n,a>>>24&255,a>>>16&255,a>>>8&255,255&a];return this.is224||l.push(o>>>24&255,o>>>16&255,o>>>8&255,255&o),l},T.prototype.array=T.prototype.digest,T.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e},y.prototype=new T,y.prototype.finalize=function(){if(T.prototype.finalize.call(this),this.inner){this.inner=!1;var e=this.array();T.call(this,this.is224,this.sharedMemory),this.update(this.oKeyPad),this.update(e),T.prototype.finalize.call(this)}};var C=v();C.sha256=C,C.sha224=v(!0),C.sha256.hmac=S(),C.sha224.hmac=S(!0),l?e.exports=C:(n.sha256=C.sha256,n.sha224=C.sha224,h&&(void 0===(s=function(){return C}.call(C,i,C,e))||(e.exports=s)))}()},8859:(e,t,i)=>{var s="function"==typeof Map&&Map.prototype,r=Object.getOwnPropertyDescriptor&&s?Object.getOwnPropertyDescriptor(Map.prototype,"size"):null,n=s&&r&&"function"==typeof r.get?r.get:null,a=s&&Map.prototype.forEach,o="function"==typeof Set&&Set.prototype,l=Object.getOwnPropertyDescriptor&&o?Object.getOwnPropertyDescriptor(Set.prototype,"size"):null,h=o&&l&&"function"==typeof l.get?l.get:null,c=o&&Set.prototype.forEach,u="function"==typeof WeakMap&&WeakMap.prototype?WeakMap.prototype.has:null,d="function"==typeof WeakSet&&WeakSet.prototype?WeakSet.prototype.has:null,_="function"==typeof WeakRef&&WeakRef.prototype?WeakRef.prototype.deref:null,p=Boolean.prototype.valueOf,f=Object.prototype.toString,m=Function.prototype.toString,g=String.prototype.match,v=String.prototype.slice,b=String.prototype.replace,x=String.prototype.toUpperCase,S=String.prototype.toLowerCase,T=RegExp.prototype.test,y=Array.prototype.concat,C=Array.prototype.join,P=Array.prototype.slice,E=Math.floor,A="function"==typeof BigInt?BigInt.prototype.valueOf:null,R=Object.getOwnPropertySymbols,I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?Symbol.prototype.toString:null,M="function"==typeof Symbol&&"object"==typeof Symbol.iterator,O="function"==typeof Symbol&&Symbol.toStringTag&&(Symbol.toStringTag,1)?Symbol.toStringTag:null,w=Object.prototype.propertyIsEnumerable,D=("function"==typeof Reflect?Reflect.getPrototypeOf:Object.getPrototypeOf)||([].__proto__===Array.prototype?function(e){return e.__proto__}:null);function F(e,t){if(e===1/0||e===-1/0||e!=e||e&&e>-1e3&&e<1e3||T.call(/e/,t))return t;var i=/[0-9](?=(?:[0-9]{3})+(?![0-9]))/g;if("number"==typeof e){var s=e<0?-E(-e):E(e);if(s!==e){var r=String(s),n=v.call(t,r.length+1);return b.call(r,i,"$&_")+"."+b.call(b.call(n,/([0-9]{3})/g,"$&_"),/_$/,"")}}return b.call(t,i,"$&_")}var N=i(2634),L=N.custom,B=G(L)?L:null;function k(e,t,i){var s="double"===(i.quoteStyle||t)?'"':"'";return s+e+s}function V(e){return b.call(String(e),/"/g,"&quot;")}function U(e){return!("[object Array]"!==X(e)||O&&"object"==typeof e&&O in e)}function z(e){return!("[object RegExp]"!==X(e)||O&&"object"==typeof e&&O in e)}function G(e){if(M)return e&&"object"==typeof e&&e instanceof Symbol;if("symbol"==typeof e)return!0;if(!e||"object"!=typeof e||!I)return!1;try{return I.call(e),!0}catch(e){}return!1}e.exports=function e(t,s,r,o){var l=s||{};if(W(l,"quoteStyle")&&"single"!==l.quoteStyle&&"double"!==l.quoteStyle)throw new TypeError('option "quoteStyle" must be "single" or "double"');if(W(l,"maxStringLength")&&("number"==typeof l.maxStringLength?l.maxStringLength<0&&l.maxStringLength!==1/0:null!==l.maxStringLength))throw new TypeError('option "maxStringLength", if provided, must be a positive integer, Infinity, or `null`');var f=!W(l,"customInspect")||l.customInspect;if("boolean"!=typeof f&&"symbol"!==f)throw new TypeError("option \"customInspect\", if provided, must be `true`, `false`, or `'symbol'`");if(W(l,"indent")&&null!==l.indent&&"\t"!==l.indent&&!(parseInt(l.indent,10)===l.indent&&l.indent>0))throw new TypeError('option "indent" must be "\\t", an integer > 0, or `null`');if(W(l,"numericSeparator")&&"boolean"!=typeof l.numericSeparator)throw new TypeError('option "numericSeparator", if provided, must be `true` or `false`');var x=l.numericSeparator;if(void 0===t)return"undefined";if(null===t)return"null";if("boolean"==typeof t)return t?"true":"false";if("string"==typeof t)return Q(t,l);if("number"==typeof t){if(0===t)return 1/0/t>0?"0":"-0";var T=String(t);return x?F(t,T):T}if("bigint"==typeof t){var E=String(t)+"n";return x?F(t,E):E}var R=void 0===l.depth?5:l.depth;if(void 0===r&&(r=0),r>=R&&R>0&&"object"==typeof t)return U(t)?"[Array]":"[Object]";var L,H=function(e,t){var i;if("\t"===e.indent)i="\t";else{if(!("number"==typeof e.indent&&e.indent>0))return null;i=C.call(Array(e.indent+1)," ")}return{base:i,prev:C.call(Array(t+1),i)}}(l,r);if(void 0===o)o=[];else if(K(o,t)>=0)return"[Circular]";function Y(t,i,s){if(i&&(o=P.call(o)).push(i),s){var n={depth:l.depth};return W(l,"quoteStyle")&&(n.quoteStyle=l.quoteStyle),e(t,n,r+1,o)}return e(t,l,r+1,o)}if("function"==typeof t&&!z(t)){var ee=function(e){if(e.name)return e.name;var t=g.call(m.call(e),/^function\s*([\w$]+)/);return t?t[1]:null}(t),te=J(t,Y);return"[Function"+(ee?": "+ee:" (anonymous)")+"]"+(te.length>0?" { "+C.call(te,", ")+" }":"")}if(G(t)){var ie=M?b.call(String(t),/^(Symbol\(.*\))_[^)]*$/,"$1"):I.call(t);return"object"!=typeof t||M?ie:q(ie)}if((L=t)&&"object"==typeof L&&("undefined"!=typeof HTMLElement&&L instanceof HTMLElement||"string"==typeof L.nodeName&&"function"==typeof L.getAttribute)){for(var se="<"+S.call(String(t.nodeName)),re=t.attributes||[],ne=0;ne<re.length;ne++)se+=" "+re[ne].name+"="+k(V(re[ne].value),"double",l);return se+=">",t.childNodes&&t.childNodes.length&&(se+="..."),se+"</"+S.call(String(t.nodeName))+">"}if(U(t)){if(0===t.length)return"[]";var ae=J(t,Y);return H&&!function(e){for(var t=0;t<e.length;t++)if(K(e[t],"\n")>=0)return!1;return!0}(ae)?"["+Z(ae,H)+"]":"[ "+C.call(ae,", ")+" ]"}if(function(e){return!("[object Error]"!==X(e)||O&&"object"==typeof e&&O in e)}(t)){var oe=J(t,Y);return"cause"in Error.prototype||!("cause"in t)||w.call(t,"cause")?0===oe.length?"["+String(t)+"]":"{ ["+String(t)+"] "+C.call(oe,", ")+" }":"{ ["+String(t)+"] "+C.call(y.call("[cause]: "+Y(t.cause),oe),", ")+" }"}if("object"==typeof t&&f){if(B&&"function"==typeof t[B]&&N)return N(t,{depth:R-r});if("symbol"!==f&&"function"==typeof t.inspect)return t.inspect()}if(function(e){if(!n||!e||"object"!=typeof e)return!1;try{n.call(e);try{h.call(e)}catch(e){return!0}return e instanceof Map}catch(e){}return!1}(t)){var le=[];return a&&a.call(t,(function(e,i){le.push(Y(i,t,!0)+" => "+Y(e,t))})),j("Map",n.call(t),le,H)}if(function(e){if(!h||!e||"object"!=typeof e)return!1;try{h.call(e);try{n.call(e)}catch(e){return!0}return e instanceof Set}catch(e){}return!1}(t)){var he=[];return c&&c.call(t,(function(e){he.push(Y(e,t))})),j("Set",h.call(t),he,H)}if(function(e){if(!u||!e||"object"!=typeof e)return!1;try{u.call(e,u);try{d.call(e,d)}catch(e){return!0}return e instanceof WeakMap}catch(e){}return!1}(t))return $("WeakMap");if(function(e){if(!d||!e||"object"!=typeof e)return!1;try{d.call(e,d);try{u.call(e,u)}catch(e){return!0}return e instanceof WeakSet}catch(e){}return!1}(t))return $("WeakSet");if(function(e){if(!_||!e||"object"!=typeof e)return!1;try{return _.call(e),!0}catch(e){}return!1}(t))return $("WeakRef");if(function(e){return!("[object Number]"!==X(e)||O&&"object"==typeof e&&O in e)}(t))return q(Y(Number(t)));if(function(e){if(!e||"object"!=typeof e||!A)return!1;try{return A.call(e),!0}catch(e){}return!1}(t))return q(Y(A.call(t)));if(function(e){return!("[object Boolean]"!==X(e)||O&&"object"==typeof e&&O in e)}(t))return q(p.call(t));if(function(e){return!("[object String]"!==X(e)||O&&"object"==typeof e&&O in e)}(t))return q(Y(String(t)));if("undefined"!=typeof window&&t===window)return"{ [object Window] }";if(t===i.g)return"{ [object globalThis] }";if(!function(e){return!("[object Date]"!==X(e)||O&&"object"==typeof e&&O in e)}(t)&&!z(t)){var ce=J(t,Y),ue=D?D(t)===Object.prototype:t instanceof Object||t.constructor===Object,de=t instanceof Object?"":"null prototype",_e=!ue&&O&&Object(t)===t&&O in t?v.call(X(t),8,-1):de?"Object":"",pe=(ue||"function"!=typeof t.constructor?"":t.constructor.name?t.constructor.name+" ":"")+(_e||de?"["+C.call(y.call([],_e||[],de||[]),": ")+"] ":"");return 0===ce.length?pe+"{}":H?pe+"{"+Z(ce,H)+"}":pe+"{ "+C.call(ce,", ")+" }"}return String(t)};var H=Object.prototype.hasOwnProperty||function(e){return e in this};function W(e,t){return H.call(e,t)}function X(e){return f.call(e)}function K(e,t){if(e.indexOf)return e.indexOf(t);for(var i=0,s=e.length;i<s;i++)if(e[i]===t)return i;return-1}function Q(e,t){if(e.length>t.maxStringLength){var i=e.length-t.maxStringLength,s="... "+i+" more character"+(i>1?"s":"");return Q(v.call(e,0,t.maxStringLength),t)+s}return k(b.call(b.call(e,/(['\\])/g,"\\$1"),/[\x00-\x1f]/g,Y),"single",t)}function Y(e){var t=e.charCodeAt(0),i={8:"b",9:"t",10:"n",12:"f",13:"r"}[t];return i?"\\"+i:"\\x"+(t<16?"0":"")+x.call(t.toString(16))}function q(e){return"Object("+e+")"}function $(e){return e+" { ? }"}function j(e,t,i,s){return e+" ("+t+") {"+(s?Z(i,s):C.call(i,", "))+"}"}function Z(e,t){if(0===e.length)return"";var i="\n"+t.prev+t.base;return i+C.call(e,","+i)+"\n"+t.prev}function J(e,t){var i=U(e),s=[];if(i){s.length=e.length;for(var r=0;r<e.length;r++)s[r]=W(e,r)?t(e[r],e):""}var n,a="function"==typeof R?R(e):[];if(M){n={};for(var o=0;o<a.length;o++)n["$"+a[o]]=a[o]}for(var l in e)W(e,l)&&(i&&String(Number(l))===l&&l<e.length||M&&n["$"+l]instanceof Symbol||(T.call(/[^\w$]/,l)?s.push(t(l,e)+": "+t(e[l],e)):s.push(l+": "+t(e[l],e))));if("function"==typeof R)for(var h=0;h<a.length;h++)w.call(e,a[h])&&s.push("["+t(a[h])+"]: "+t(e[a[h]],e));return s}},4765:e=>{"use strict";var t=String.prototype.replace,i=/%20/g,s="RFC3986";e.exports={default:s,formatters:{RFC1738:function(e){return t.call(e,i,"+")},RFC3986:function(e){return String(e)}},RFC1738:"RFC1738",RFC3986:s}},5373:(e,t,i)=>{"use strict";var s=i(8636),r=i(2642),n=i(4765);e.exports={formats:n,parse:r,stringify:s}},2642:(e,t,i)=>{"use strict";var s=i(7720),r=Object.prototype.hasOwnProperty,n=Array.isArray,a={allowDots:!1,allowEmptyArrays:!1,allowPrototypes:!1,allowSparse:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decodeDotInKeys:!1,decoder:s.decode,delimiter:"&",depth:5,duplicates:"combine",ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictDepth:!1,strictNullHandling:!1},o=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},l=function(e,t){return e&&"string"==typeof e&&t.comma&&e.indexOf(",")>-1?e.split(","):e},h=function(e,t,i,s){if(e){var n=i.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,a=/(\[[^[\]]*])/g,o=i.depth>0&&/(\[[^[\]]*])/.exec(n),h=o?n.slice(0,o.index):n,c=[];if(h){if(!i.plainObjects&&r.call(Object.prototype,h)&&!i.allowPrototypes)return;c.push(h)}for(var u=0;i.depth>0&&null!==(o=a.exec(n))&&u<i.depth;){if(u+=1,!i.plainObjects&&r.call(Object.prototype,o[1].slice(1,-1))&&!i.allowPrototypes)return;c.push(o[1])}if(o){if(!0===i.strictDepth)throw new RangeError("Input depth exceeded depth option of "+i.depth+" and strictDepth is true");c.push("["+n.slice(o.index)+"]")}return function(e,t,i,s){for(var r=s?t:l(t,i),n=e.length-1;n>=0;--n){var a,o=e[n];if("[]"===o&&i.parseArrays)a=i.allowEmptyArrays&&(""===r||i.strictNullHandling&&null===r)?[]:[].concat(r);else{a=i.plainObjects?Object.create(null):{};var h="["===o.charAt(0)&&"]"===o.charAt(o.length-1)?o.slice(1,-1):o,c=i.decodeDotInKeys?h.replace(/%2E/g,"."):h,u=parseInt(c,10);i.parseArrays||""!==c?!isNaN(u)&&o!==c&&String(u)===c&&u>=0&&i.parseArrays&&u<=i.arrayLimit?(a=[])[u]=r:"__proto__"!==c&&(a[c]=r):a={0:r}}r=a}return r}(c,t,i,s)}};e.exports=function(e,t){var i=function(e){if(!e)return a;if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.decodeDotInKeys&&"boolean"!=typeof e.decodeDotInKeys)throw new TypeError("`decodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.decoder&&void 0!==e.decoder&&"function"!=typeof e.decoder)throw new TypeError("Decoder has to be a function.");if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var t=void 0===e.charset?a.charset:e.charset,i=void 0===e.duplicates?a.duplicates:e.duplicates;if("combine"!==i&&"first"!==i&&"last"!==i)throw new TypeError("The duplicates option must be either combine, first, or last");return{allowDots:void 0===e.allowDots?!0===e.decodeDotInKeys||a.allowDots:!!e.allowDots,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:a.allowEmptyArrays,allowPrototypes:"boolean"==typeof e.allowPrototypes?e.allowPrototypes:a.allowPrototypes,allowSparse:"boolean"==typeof e.allowSparse?e.allowSparse:a.allowSparse,arrayLimit:"number"==typeof e.arrayLimit?e.arrayLimit:a.arrayLimit,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:a.charsetSentinel,comma:"boolean"==typeof e.comma?e.comma:a.comma,decodeDotInKeys:"boolean"==typeof e.decodeDotInKeys?e.decodeDotInKeys:a.decodeDotInKeys,decoder:"function"==typeof e.decoder?e.decoder:a.decoder,delimiter:"string"==typeof e.delimiter||s.isRegExp(e.delimiter)?e.delimiter:a.delimiter,depth:"number"==typeof e.depth||!1===e.depth?+e.depth:a.depth,duplicates:i,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"==typeof e.interpretNumericEntities?e.interpretNumericEntities:a.interpretNumericEntities,parameterLimit:"number"==typeof e.parameterLimit?e.parameterLimit:a.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"==typeof e.plainObjects?e.plainObjects:a.plainObjects,strictDepth:"boolean"==typeof e.strictDepth?!!e.strictDepth:a.strictDepth,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:a.strictNullHandling}}(t);if(""===e||null==e)return i.plainObjects?Object.create(null):{};for(var c="string"==typeof e?function(e,t){var i={__proto__:null},h=t.ignoreQueryPrefix?e.replace(/^\?/,""):e;h=h.replace(/%5B/gi,"[").replace(/%5D/gi,"]");var c,u=t.parameterLimit===1/0?void 0:t.parameterLimit,d=h.split(t.delimiter,u),_=-1,p=t.charset;if(t.charsetSentinel)for(c=0;c<d.length;++c)0===d[c].indexOf("utf8=")&&("utf8=%E2%9C%93"===d[c]?p="utf-8":"utf8=%26%2310003%3B"===d[c]&&(p="iso-8859-1"),_=c,c=d.length);for(c=0;c<d.length;++c)if(c!==_){var f,m,g=d[c],v=g.indexOf("]="),b=-1===v?g.indexOf("="):v+1;-1===b?(f=t.decoder(g,a.decoder,p,"key"),m=t.strictNullHandling?null:""):(f=t.decoder(g.slice(0,b),a.decoder,p,"key"),m=s.maybeMap(l(g.slice(b+1),t),(function(e){return t.decoder(e,a.decoder,p,"value")}))),m&&t.interpretNumericEntities&&"iso-8859-1"===p&&(m=o(m)),g.indexOf("[]=")>-1&&(m=n(m)?[m]:m);var x=r.call(i,f);x&&"combine"===t.duplicates?i[f]=s.combine(i[f],m):x&&"last"!==t.duplicates||(i[f]=m)}return i}(e,i):e,u=i.plainObjects?Object.create(null):{},d=Object.keys(c),_=0;_<d.length;++_){var p=d[_],f=h(p,c[p],i,"string"==typeof e);u=s.merge(u,f,i)}return!0===i.allowSparse?u:s.compact(u)}},8636:(e,t,i)=>{"use strict";var s=i(920),r=i(7720),n=i(4765),a=Object.prototype.hasOwnProperty,o={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},l=Array.isArray,h=Array.prototype.push,c=function(e,t){h.apply(e,l(t)?t:[t])},u=Date.prototype.toISOString,d=n.default,_={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:r.encode,encodeValuesOnly:!1,format:d,formatter:n.formatters[d],indices:!1,serializeDate:function(e){return u.call(e)},skipNulls:!1,strictNullHandling:!1},p={},f=function e(t,i,n,a,o,h,u,d,f,m,g,v,b,x,S,T,y,C){for(var P,E=t,A=C,R=0,I=!1;void 0!==(A=A.get(p))&&!I;){var M=A.get(t);if(R+=1,void 0!==M){if(M===R)throw new RangeError("Cyclic object value");I=!0}void 0===A.get(p)&&(R=0)}if("function"==typeof m?E=m(i,E):E instanceof Date?E=b(E):"comma"===n&&l(E)&&(E=r.maybeMap(E,(function(e){return e instanceof Date?b(e):e}))),null===E){if(h)return f&&!T?f(i,_.encoder,y,"key",x):i;E=""}if("string"==typeof(P=E)||"number"==typeof P||"boolean"==typeof P||"symbol"==typeof P||"bigint"==typeof P||r.isBuffer(E))return f?[S(T?i:f(i,_.encoder,y,"key",x))+"="+S(f(E,_.encoder,y,"value",x))]:[S(i)+"="+S(String(E))];var O,w=[];if(void 0===E)return w;if("comma"===n&&l(E))T&&f&&(E=r.maybeMap(E,f)),O=[{value:E.length>0?E.join(",")||null:void 0}];else if(l(m))O=m;else{var D=Object.keys(E);O=g?D.sort(g):D}var F=d?i.replace(/\./g,"%2E"):i,N=a&&l(E)&&1===E.length?F+"[]":F;if(o&&l(E)&&0===E.length)return N+"[]";for(var L=0;L<O.length;++L){var B=O[L],k="object"==typeof B&&void 0!==B.value?B.value:E[B];if(!u||null!==k){var V=v&&d?B.replace(/\./g,"%2E"):B,U=l(E)?"function"==typeof n?n(N,V):N:N+(v?"."+V:"["+V+"]");C.set(t,R);var z=s();z.set(p,C),c(w,e(k,U,n,a,o,h,u,d,"comma"===n&&T&&l(E)?null:f,m,g,v,b,x,S,T,y,z))}}return w};e.exports=function(e,t){var i,r=e,h=function(e){if(!e)return _;if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||_.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var i=n.default;if(void 0!==e.format){if(!a.call(n.formatters,e.format))throw new TypeError("Unknown format option provided.");i=e.format}var s,r=n.formatters[i],h=_.filter;if(("function"==typeof e.filter||l(e.filter))&&(h=e.filter),s=e.arrayFormat in o?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":_.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");var c=void 0===e.allowDots?!0===e.encodeDotInKeys||_.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:_.addQueryPrefix,allowDots:c,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:_.allowEmptyArrays,arrayFormat:s,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:_.charsetSentinel,commaRoundTrip:e.commaRoundTrip,delimiter:void 0===e.delimiter?_.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:_.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:_.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:_.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:_.encodeValuesOnly,filter:h,format:i,formatter:r,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:_.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:_.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:_.strictNullHandling}}(t);"function"==typeof h.filter?r=(0,h.filter)("",r):l(h.filter)&&(i=h.filter);var u=[];if("object"!=typeof r||null===r)return"";var d=o[h.arrayFormat],p="comma"===d&&h.commaRoundTrip;i||(i=Object.keys(r)),h.sort&&i.sort(h.sort);for(var m=s(),g=0;g<i.length;++g){var v=i[g];h.skipNulls&&null===r[v]||c(u,f(r[v],v,d,p,h.allowEmptyArrays,h.strictNullHandling,h.skipNulls,h.encodeDotInKeys,h.encode?h.encoder:null,h.filter,h.sort,h.allowDots,h.serializeDate,h.format,h.formatter,h.encodeValuesOnly,h.charset,m))}var b=u.join(h.delimiter),x=!0===h.addQueryPrefix?"?":"";return h.charsetSentinel&&("iso-8859-1"===h.charset?x+="utf8=%26%2310003%3B&":x+="utf8=%E2%9C%93&"),b.length>0?x+b:""}},7720:(e,t,i)=>{"use strict";var s=i(4765),r=Object.prototype.hasOwnProperty,n=Array.isArray,a=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),o=function(e,t){for(var i=t&&t.plainObjects?Object.create(null):{},s=0;s<e.length;++s)void 0!==e[s]&&(i[s]=e[s]);return i},l=1024;e.exports={arrayToObject:o,assign:function(e,t){return Object.keys(t).reduce((function(e,i){return e[i]=t[i],e}),e)},combine:function(e,t){return[].concat(e,t)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],i=[],s=0;s<t.length;++s)for(var r=t[s],a=r.obj[r.prop],o=Object.keys(a),l=0;l<o.length;++l){var h=o[l],c=a[h];"object"==typeof c&&null!==c&&-1===i.indexOf(c)&&(t.push({obj:a,prop:h}),i.push(c))}return function(e){for(;e.length>1;){var t=e.pop(),i=t.obj[t.prop];if(n(i)){for(var s=[],r=0;r<i.length;++r)void 0!==i[r]&&s.push(i[r]);t.obj[t.prop]=s}}}(t),e},decode:function(e,t,i){var s=e.replace(/\+/g," ");if("iso-8859-1"===i)return s.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(s)}catch(e){return s}},encode:function(e,t,i,r,n){if(0===e.length)return e;var o=e;if("symbol"==typeof e?o=Symbol.prototype.toString.call(e):"string"!=typeof e&&(o=String(e)),"iso-8859-1"===i)return escape(o).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var h="",c=0;c<o.length;c+=l){for(var u=o.length>=l?o.slice(c,c+l):o,d=[],_=0;_<u.length;++_){var p=u.charCodeAt(_);45===p||46===p||95===p||126===p||p>=48&&p<=57||p>=65&&p<=90||p>=97&&p<=122||n===s.RFC1738&&(40===p||41===p)?d[d.length]=u.charAt(_):p<128?d[d.length]=a[p]:p<2048?d[d.length]=a[192|p>>6]+a[128|63&p]:p<55296||p>=57344?d[d.length]=a[224|p>>12]+a[128|p>>6&63]+a[128|63&p]:(_+=1,p=65536+((1023&p)<<10|1023&u.charCodeAt(_)),d[d.length]=a[240|p>>18]+a[128|p>>12&63]+a[128|p>>6&63]+a[128|63&p])}h+=d.join("")}return h},isBuffer:function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},maybeMap:function(e,t){if(n(e)){for(var i=[],s=0;s<e.length;s+=1)i.push(t(e[s]));return i}return t(e)},merge:function e(t,i,s){if(!i)return t;if("object"!=typeof i){if(n(t))t.push(i);else{if(!t||"object"!=typeof t)return[t,i];(s&&(s.plainObjects||s.allowPrototypes)||!r.call(Object.prototype,i))&&(t[i]=!0)}return t}if(!t||"object"!=typeof t)return[t].concat(i);var a=t;return n(t)&&!n(i)&&(a=o(t,s)),n(t)&&n(i)?(i.forEach((function(i,n){if(r.call(t,n)){var a=t[n];a&&"object"==typeof a&&i&&"object"==typeof i?t[n]=e(a,i,s):t.push(i)}else t[n]=i})),t):Object.keys(i).reduce((function(t,n){var a=i[n];return r.call(t,n)?t[n]=e(t[n],a,s):t[n]=a,t}),a)}}},6897:(e,t,i)=>{"use strict";var s=i(453),r=i(41),n=i(592)(),a=i(5795),o=i(9675),l=s("%Math.floor%");e.exports=function(e,t){if("function"!=typeof e)throw new o("`fn` is not a function");if("number"!=typeof t||t<0||t>4294967295||l(t)!==t)throw new o("`length` must be a positive 32-bit integer");var i=arguments.length>2&&!!arguments[2],s=!0,h=!0;if("length"in e&&a){var c=a(e,"length");c&&!c.configurable&&(s=!1),c&&!c.writable&&(h=!1)}return(s||h||!i)&&(n?r(e,"length",t,!0,!0):r(e,"length",t)),e}},920:(e,t,i)=>{"use strict";var s=i(453),r=i(456),n=i(8859),a=i(9675),o=s("%WeakMap%",!0),l=s("%Map%",!0),h=r("WeakMap.prototype.get",!0),c=r("WeakMap.prototype.set",!0),u=r("WeakMap.prototype.has",!0),d=r("Map.prototype.get",!0),_=r("Map.prototype.set",!0),p=r("Map.prototype.has",!0),f=function(e,t){for(var i,s=e;null!==(i=s.next);s=i)if(i.key===t)return s.next=i.next,i.next=e.next,e.next=i,i};e.exports=function(){var e,t,i,s={assert:function(e){if(!s.has(e))throw new a("Side channel does not contain "+n(e))},get:function(s){if(o&&s&&("object"==typeof s||"function"==typeof s)){if(e)return h(e,s)}else if(l){if(t)return d(t,s)}else if(i)return function(e,t){var i=f(e,t);return i&&i.value}(i,s)},has:function(s){if(o&&s&&("object"==typeof s||"function"==typeof s)){if(e)return u(e,s)}else if(l){if(t)return p(t,s)}else if(i)return function(e,t){return!!f(e,t)}(i,s);return!1},set:function(s,r){o&&s&&("object"==typeof s||"function"==typeof s)?(e||(e=new o),c(e,s,r)):l?(t||(t=new l),_(t,s,r)):(i||(i={key:{},next:null}),function(e,t,i){var s=f(e,t);s?s.value=i:e.next={key:t,next:e.next,value:i}}(i,s,r))}};return s}},3311:(e,t,i)=>{"use strict";e.exports=i.p+"5e246a10319df8547016.wasm"},4284:()=>{},4394:()=>{},2634:()=>{},6425:(e,t,i)=>{"use strict";function s(e,t){return function(){return e.apply(t,arguments)}}const{toString:r}=Object.prototype,{getPrototypeOf:n}=Object,a=(o=Object.create(null),e=>{const t=r.call(e);return o[t]||(o[t]=t.slice(8,-1).toLowerCase())});var o;const l=e=>(e=e.toLowerCase(),t=>a(t)===e),h=e=>t=>typeof t===e,{isArray:c}=Array,u=h("undefined"),d=l("ArrayBuffer"),_=h("string"),p=h("function"),f=h("number"),m=e=>null!==e&&"object"==typeof e,g=e=>{if("object"!==a(e))return!1;const t=n(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)},v=l("Date"),b=l("File"),x=l("Blob"),S=l("FileList"),T=l("URLSearchParams"),[y,C,P,E]=["ReadableStream","Request","Response","Headers"].map(l);function A(e,t,{allOwnKeys:i=!1}={}){if(null==e)return;let s,r;if("object"!=typeof e&&(e=[e]),c(e))for(s=0,r=e.length;s<r;s++)t.call(null,e[s],s,e);else{const r=i?Object.getOwnPropertyNames(e):Object.keys(e),n=r.length;let a;for(s=0;s<n;s++)a=r[s],t.call(null,e[a],a,e)}}function R(e,t){t=t.toLowerCase();const i=Object.keys(e);let s,r=i.length;for(;r-- >0;)if(s=i[r],t===s.toLowerCase())return s;return null}const I="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:i.g,M=e=>!u(e)&&e!==I,O=(w="undefined"!=typeof Uint8Array&&n(Uint8Array),e=>w&&e instanceof w);var w;const D=l("HTMLFormElement"),F=(({hasOwnProperty:e})=>(t,i)=>e.call(t,i))(Object.prototype),N=l("RegExp"),L=(e,t)=>{const i=Object.getOwnPropertyDescriptors(e),s={};A(i,((i,r)=>{let n;!1!==(n=t(i,r,e))&&(s[r]=n||i)})),Object.defineProperties(e,s)},B="abcdefghijklmnopqrstuvwxyz",k="0123456789",V={DIGIT:k,ALPHA:B,ALPHA_DIGIT:B+B.toUpperCase()+k},U=l("AsyncFunction"),z=(G="function"==typeof setImmediate,H=p(I.postMessage),G?setImmediate:H?(W=`axios@${Math.random()}`,X=[],I.addEventListener("message",(({source:e,data:t})=>{e===I&&t===W&&X.length&&X.shift()()}),!1),e=>{X.push(e),I.postMessage(W,"*")}):e=>setTimeout(e));var G,H,W,X;const K="undefined"!=typeof queueMicrotask?queueMicrotask.bind(I):"undefined"!=typeof process&&process.nextTick||z;var Q={isArray:c,isArrayBuffer:d,isBuffer:function(e){return null!==e&&!u(e)&&null!==e.constructor&&!u(e.constructor)&&p(e.constructor.isBuffer)&&e.constructor.isBuffer(e)},isFormData:e=>{let t;return e&&("function"==typeof FormData&&e instanceof FormData||p(e.append)&&("formdata"===(t=a(e))||"object"===t&&p(e.toString)&&"[object FormData]"===e.toString()))},isArrayBufferView:function(e){let t;return t="undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&d(e.buffer),t},isString:_,isNumber:f,isBoolean:e=>!0===e||!1===e,isObject:m,isPlainObject:g,isReadableStream:y,isRequest:C,isResponse:P,isHeaders:E,isUndefined:u,isDate:v,isFile:b,isBlob:x,isRegExp:N,isFunction:p,isStream:e=>m(e)&&p(e.pipe),isURLSearchParams:T,isTypedArray:O,isFileList:S,forEach:A,merge:function e(){const{caseless:t}=M(this)&&this||{},i={},s=(s,r)=>{const n=t&&R(i,r)||r;g(i[n])&&g(s)?i[n]=e(i[n],s):g(s)?i[n]=e({},s):c(s)?i[n]=s.slice():i[n]=s};for(let e=0,t=arguments.length;e<t;e++)arguments[e]&&A(arguments[e],s);return i},extend:(e,t,i,{allOwnKeys:r}={})=>(A(t,((t,r)=>{i&&p(t)?e[r]=s(t,i):e[r]=t}),{allOwnKeys:r}),e),trim:e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(65279===e.charCodeAt(0)&&(e=e.slice(1)),e),inherits:(e,t,i,s)=>{e.prototype=Object.create(t.prototype,s),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),i&&Object.assign(e.prototype,i)},toFlatObject:(e,t,i,s)=>{let r,a,o;const l={};if(t=t||{},null==e)return t;do{for(r=Object.getOwnPropertyNames(e),a=r.length;a-- >0;)o=r[a],s&&!s(o,e,t)||l[o]||(t[o]=e[o],l[o]=!0);e=!1!==i&&n(e)}while(e&&(!i||i(e,t))&&e!==Object.prototype);return t},kindOf:a,kindOfTest:l,endsWith:(e,t,i)=>{e=String(e),(void 0===i||i>e.length)&&(i=e.length),i-=t.length;const s=e.indexOf(t,i);return-1!==s&&s===i},toArray:e=>{if(!e)return null;if(c(e))return e;let t=e.length;if(!f(t))return null;const i=new Array(t);for(;t-- >0;)i[t]=e[t];return i},forEachEntry:(e,t)=>{const i=(e&&e[Symbol.iterator]).call(e);let s;for(;(s=i.next())&&!s.done;){const i=s.value;t.call(e,i[0],i[1])}},matchAll:(e,t)=>{let i;const s=[];for(;null!==(i=e.exec(t));)s.push(i);return s},isHTMLForm:D,hasOwnProperty:F,hasOwnProp:F,reduceDescriptors:L,freezeMethods:e=>{L(e,((t,i)=>{if(p(e)&&-1!==["arguments","caller","callee"].indexOf(i))return!1;const s=e[i];p(s)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+i+"'")}))}))},toObjectSet:(e,t)=>{const i={},s=e=>{e.forEach((e=>{i[e]=!0}))};return c(e)?s(e):s(String(e).split(t)),i},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(e,t,i){return t.toUpperCase()+i})),noop:()=>{},toFiniteNumber:(e,t)=>null!=e&&Number.isFinite(e=+e)?e:t,findKey:R,global:I,isContextDefined:M,ALPHABET:V,generateString:(e=16,t=V.ALPHA_DIGIT)=>{let i="";const{length:s}=t;for(;e--;)i+=t[Math.random()*s|0];return i},isSpecCompliantForm:function(e){return!!(e&&p(e.append)&&"FormData"===e[Symbol.toStringTag]&&e[Symbol.iterator])},toJSONObject:e=>{const t=new Array(10),i=(e,s)=>{if(m(e)){if(t.indexOf(e)>=0)return;if(!("toJSON"in e)){t[s]=e;const r=c(e)?[]:{};return A(e,((e,t)=>{const n=i(e,s+1);!u(n)&&(r[t]=n)})),t[s]=void 0,r}}return e};return i(e,0)},isAsyncFn:U,isThenable:e=>e&&(m(e)||p(e))&&p(e.then)&&p(e.catch),setImmediate:z,asap:K};function Y(e,t,i,s,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=e,this.name="AxiosError",t&&(this.code=t),i&&(this.config=i),s&&(this.request=s),r&&(this.response=r,this.status=r.status?r.status:null)}Q.inherits(Y,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Q.toJSONObject(this.config),code:this.code,status:this.status}}});const q=Y.prototype,$={};function j(e){return Q.isPlainObject(e)||Q.isArray(e)}function Z(e){return Q.endsWith(e,"[]")?e.slice(0,-2):e}function J(e,t,i){return e?e.concat(t).map((function(e,t){return e=Z(e),!i&&t?"["+e+"]":e})).join(i?".":""):t}["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{$[e]={value:e}})),Object.defineProperties(Y,$),Object.defineProperty(q,"isAxiosError",{value:!0}),Y.from=(e,t,i,s,r,n)=>{const a=Object.create(q);return Q.toFlatObject(e,a,(function(e){return e!==Error.prototype}),(e=>"isAxiosError"!==e)),Y.call(a,e.message,t,i,s,r),a.cause=e,a.name=e.name,n&&Object.assign(a,n),a};const ee=Q.toFlatObject(Q,{},null,(function(e){return/^is[A-Z]/.test(e)}));function te(e,t,i){if(!Q.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const s=(i=Q.toFlatObject(i,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(e,t){return!Q.isUndefined(t[e])}))).metaTokens,r=i.visitor||h,n=i.dots,a=i.indexes,o=(i.Blob||"undefined"!=typeof Blob&&Blob)&&Q.isSpecCompliantForm(t);if(!Q.isFunction(r))throw new TypeError("visitor must be a function");function l(e){if(null===e)return"";if(Q.isDate(e))return e.toISOString();if(!o&&Q.isBlob(e))throw new Y("Blob is not supported. Use a Buffer instead.");return Q.isArrayBuffer(e)||Q.isTypedArray(e)?o&&"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}function h(e,i,r){let o=e;if(e&&!r&&"object"==typeof e)if(Q.endsWith(i,"{}"))i=s?i:i.slice(0,-2),e=JSON.stringify(e);else if(Q.isArray(e)&&function(e){return Q.isArray(e)&&!e.some(j)}(e)||(Q.isFileList(e)||Q.endsWith(i,"[]"))&&(o=Q.toArray(e)))return i=Z(i),o.forEach((function(e,s){!Q.isUndefined(e)&&null!==e&&t.append(!0===a?J([i],s,n):null===a?i:i+"[]",l(e))})),!1;return!!j(e)||(t.append(J(r,i,n),l(e)),!1)}const c=[],u=Object.assign(ee,{defaultVisitor:h,convertValue:l,isVisitable:j});if(!Q.isObject(e))throw new TypeError("data must be an object");return function e(i,s){if(!Q.isUndefined(i)){if(-1!==c.indexOf(i))throw Error("Circular reference detected in "+s.join("."));c.push(i),Q.forEach(i,(function(i,n){!0===(!(Q.isUndefined(i)||null===i)&&r.call(t,i,Q.isString(n)?n.trim():n,s,u))&&e(i,s?s.concat(n):[n])})),c.pop()}}(e),t}function ie(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(e){return t[e]}))}function se(e,t){this._pairs=[],e&&te(e,this,t)}const re=se.prototype;function ne(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function ae(e,t,i){if(!t)return e;const s=i&&i.encode||ne;Q.isFunction(i)&&(i={serialize:i});const r=i&&i.serialize;let n;if(n=r?r(t,i):Q.isURLSearchParams(t)?t.toString():new se(t,i).toString(s),n){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+n}return e}re.append=function(e,t){this._pairs.push([e,t])},re.toString=function(e){const t=e?function(t){return e.call(this,t,ie)}:ie;return this._pairs.map((function(e){return t(e[0])+"="+t(e[1])}),"").join("&")};var oe=class{constructor(){this.handlers=[]}use(e,t,i){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){Q.forEach(this.handlers,(function(t){null!==t&&e(t)}))}},le={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},he={isBrowser:!0,classes:{URLSearchParams:"undefined"!=typeof URLSearchParams?URLSearchParams:se,FormData:"undefined"!=typeof FormData?FormData:null,Blob:"undefined"!=typeof Blob?Blob:null},protocols:["http","https","file","blob","url","data"]};const ce="undefined"!=typeof window&&"undefined"!=typeof document,ue="object"==typeof navigator&&navigator||void 0,de=ce&&(!ue||["ReactNative","NativeScript","NS"].indexOf(ue.product)<0),_e="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts,pe=ce&&window.location.href||"http://localhost";var fe={...Object.freeze({__proto__:null,hasBrowserEnv:ce,hasStandardBrowserWebWorkerEnv:_e,hasStandardBrowserEnv:de,navigator:ue,origin:pe}),...he};function me(e){function t(e,i,s,r){let n=e[r++];if("__proto__"===n)return!0;const a=Number.isFinite(+n),o=r>=e.length;return n=!n&&Q.isArray(s)?s.length:n,o?(Q.hasOwnProp(s,n)?s[n]=[s[n],i]:s[n]=i,!a):(s[n]&&Q.isObject(s[n])||(s[n]=[]),t(e,i,s[n],r)&&Q.isArray(s[n])&&(s[n]=function(e){const t={},i=Object.keys(e);let s;const r=i.length;let n;for(s=0;s<r;s++)n=i[s],t[n]=e[n];return t}(s[n])),!a)}if(Q.isFormData(e)&&Q.isFunction(e.entries)){const i={};return Q.forEachEntry(e,((e,s)=>{t(function(e){return Q.matchAll(/\w+|\[(\w*)]/g,e).map((e=>"[]"===e[0]?"":e[1]||e[0]))}(e),s,i,0)})),i}return null}const ge={transitional:le,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const i=t.getContentType()||"",s=i.indexOf("application/json")>-1,r=Q.isObject(e);if(r&&Q.isHTMLForm(e)&&(e=new FormData(e)),Q.isFormData(e))return s?JSON.stringify(me(e)):e;if(Q.isArrayBuffer(e)||Q.isBuffer(e)||Q.isStream(e)||Q.isFile(e)||Q.isBlob(e)||Q.isReadableStream(e))return e;if(Q.isArrayBufferView(e))return e.buffer;if(Q.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let n;if(r){if(i.indexOf("application/x-www-form-urlencoded")>-1)return function(e,t){return te(e,new fe.classes.URLSearchParams,Object.assign({visitor:function(e,t,i,s){return fe.isNode&&Q.isBuffer(e)?(this.append(t,e.toString("base64")),!1):s.defaultVisitor.apply(this,arguments)}},t))}(e,this.formSerializer).toString();if((n=Q.isFileList(e))||i.indexOf("multipart/form-data")>-1){const t=this.env&&this.env.FormData;return te(n?{"files[]":e}:e,t&&new t,this.formSerializer)}}return r||s?(t.setContentType("application/json",!1),function(e,t,i){if(Q.isString(e))try{return(0,JSON.parse)(e),Q.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(0,JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){const t=this.transitional||ge.transitional,i=t&&t.forcedJSONParsing,s="json"===this.responseType;if(Q.isResponse(e)||Q.isReadableStream(e))return e;if(e&&Q.isString(e)&&(i&&!this.responseType||s)){const i=!(t&&t.silentJSONParsing)&&s;try{return JSON.parse(e)}catch(e){if(i){if("SyntaxError"===e.name)throw Y.from(e,Y.ERR_BAD_RESPONSE,this,null,this.response);throw e}}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:fe.classes.FormData,Blob:fe.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Q.forEach(["delete","get","head","post","put","patch"],(e=>{ge.headers[e]={}}));var ve=ge;const be=Q.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),xe=Symbol("internals");function Se(e){return e&&String(e).trim().toLowerCase()}function Te(e){return!1===e||null==e?e:Q.isArray(e)?e.map(Te):String(e)}function ye(e,t,i,s,r){return Q.isFunction(s)?s.call(this,t,i):(r&&(t=i),Q.isString(t)?Q.isString(s)?-1!==t.indexOf(s):Q.isRegExp(s)?s.test(t):void 0:void 0)}class Ce{constructor(e){e&&this.set(e)}set(e,t,i){const s=this;function r(e,t,i){const r=Se(t);if(!r)throw new Error("header name must be a non-empty string");const n=Q.findKey(s,r);(!n||void 0===s[n]||!0===i||void 0===i&&!1!==s[n])&&(s[n||t]=Te(e))}const n=(e,t)=>Q.forEach(e,((e,i)=>r(e,i,t)));if(Q.isPlainObject(e)||e instanceof this.constructor)n(e,t);else if(Q.isString(e)&&(e=e.trim())&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim()))n((e=>{const t={};let i,s,r;return e&&e.split("\n").forEach((function(e){r=e.indexOf(":"),i=e.substring(0,r).trim().toLowerCase(),s=e.substring(r+1).trim(),!i||t[i]&&be[i]||("set-cookie"===i?t[i]?t[i].push(s):t[i]=[s]:t[i]=t[i]?t[i]+", "+s:s)})),t})(e),t);else if(Q.isHeaders(e))for(const[t,s]of e.entries())r(s,t,i);else null!=e&&r(t,e,i);return this}get(e,t){if(e=Se(e)){const i=Q.findKey(this,e);if(i){const e=this[i];if(!t)return e;if(!0===t)return function(e){const t=Object.create(null),i=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let s;for(;s=i.exec(e);)t[s[1]]=s[2];return t}(e);if(Q.isFunction(t))return t.call(this,e,i);if(Q.isRegExp(t))return t.exec(e);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=Se(e)){const i=Q.findKey(this,e);return!(!i||void 0===this[i]||t&&!ye(0,this[i],i,t))}return!1}delete(e,t){const i=this;let s=!1;function r(e){if(e=Se(e)){const r=Q.findKey(i,e);!r||t&&!ye(0,i[r],r,t)||(delete i[r],s=!0)}}return Q.isArray(e)?e.forEach(r):r(e),s}clear(e){const t=Object.keys(this);let i=t.length,s=!1;for(;i--;){const r=t[i];e&&!ye(0,this[r],r,e,!0)||(delete this[r],s=!0)}return s}normalize(e){const t=this,i={};return Q.forEach(this,((s,r)=>{const n=Q.findKey(i,r);if(n)return t[n]=Te(s),void delete t[r];const a=e?function(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,((e,t,i)=>t.toUpperCase()+i))}(r):String(r).trim();a!==r&&delete t[r],t[a]=Te(s),i[a]=!0})),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return Q.forEach(this,((i,s)=>{null!=i&&!1!==i&&(t[s]=e&&Q.isArray(i)?i.join(", "):i)})),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((([e,t])=>e+": "+t)).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const i=new this(e);return t.forEach((e=>i.set(e))),i}static accessor(e){const t=(this[xe]=this[xe]={accessors:{}}).accessors,i=this.prototype;function s(e){const s=Se(e);t[s]||(function(e,t){const i=Q.toCamelCase(" "+t);["get","set","has"].forEach((s=>{Object.defineProperty(e,s+i,{value:function(e,i,r){return this[s].call(this,t,e,i,r)},configurable:!0})}))}(i,e),t[s]=!0)}return Q.isArray(e)?e.forEach(s):s(e),this}}Ce.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),Q.reduceDescriptors(Ce.prototype,(({value:e},t)=>{let i=t[0].toUpperCase()+t.slice(1);return{get:()=>e,set(e){this[i]=e}}})),Q.freezeMethods(Ce);var Pe=Ce;function Ee(e,t){const i=this||ve,s=t||i,r=Pe.from(s.headers);let n=s.data;return Q.forEach(e,(function(e){n=e.call(i,n,r.normalize(),t?t.status:void 0)})),r.normalize(),n}function Ae(e){return!(!e||!e.__CANCEL__)}function Re(e,t,i){Y.call(this,null==e?"canceled":e,Y.ERR_CANCELED,t,i),this.name="CanceledError"}function Ie(e,t,i){const s=i.config.validateStatus;i.status&&s&&!s(i.status)?t(new Y("Request failed with status code "+i.status,[Y.ERR_BAD_REQUEST,Y.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):e(i)}Q.inherits(Re,Y,{__CANCEL__:!0});const Me=(e,t,i=3)=>{let s=0;const r=function(e,t){e=e||10;const i=new Array(e),s=new Array(e);let r,n=0,a=0;return t=void 0!==t?t:1e3,function(o){const l=Date.now(),h=s[a];r||(r=l),i[n]=o,s[n]=l;let c=a,u=0;for(;c!==n;)u+=i[c++],c%=e;if(n=(n+1)%e,n===a&&(a=(a+1)%e),l-r<t)return;const d=h&&l-h;return d?Math.round(1e3*u/d):void 0}}(50,250);return function(e,t){let i,s,r=0,n=1e3/t;const a=(t,n=Date.now())=>{r=n,i=null,s&&(clearTimeout(s),s=null),e.apply(null,t)};return[(...e)=>{const t=Date.now(),o=t-r;o>=n?a(e,t):(i=e,s||(s=setTimeout((()=>{s=null,a(i)}),n-o)))},()=>i&&a(i)]}((i=>{const n=i.loaded,a=i.lengthComputable?i.total:void 0,o=n-s,l=r(o);s=n,e({loaded:n,total:a,progress:a?n/a:void 0,bytes:o,rate:l||void 0,estimated:l&&a&&n<=a?(a-n)/l:void 0,event:i,lengthComputable:null!=a,[t?"download":"upload"]:!0})}),i)},Oe=(e,t)=>{const i=null!=e;return[s=>t[0]({lengthComputable:i,total:e,loaded:s}),t[1]]},we=e=>(...t)=>Q.asap((()=>e(...t)));var De=fe.hasStandardBrowserEnv?((e,t)=>i=>(i=new URL(i,fe.origin),e.protocol===i.protocol&&e.host===i.host&&(t||e.port===i.port)))(new URL(fe.origin),fe.navigator&&/(msie|trident)/i.test(fe.navigator.userAgent)):()=>!0,Fe=fe.hasStandardBrowserEnv?{write(e,t,i,s,r,n){const a=[e+"="+encodeURIComponent(t)];Q.isNumber(i)&&a.push("expires="+new Date(i).toGMTString()),Q.isString(s)&&a.push("path="+s),Q.isString(r)&&a.push("domain="+r),!0===n&&a.push("secure"),document.cookie=a.join("; ")},read(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove(e){this.write(e,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function Ne(e,t){return e&&!/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)?function(e,t){return t?e.replace(/\/?\/$/,"")+"/"+t.replace(/^\/+/,""):e}(e,t):t}const Le=e=>e instanceof Pe?{...e}:e;function Be(e,t){t=t||{};const i={};function s(e,t,i,s){return Q.isPlainObject(e)&&Q.isPlainObject(t)?Q.merge.call({caseless:s},e,t):Q.isPlainObject(t)?Q.merge({},t):Q.isArray(t)?t.slice():t}function r(e,t,i,r){return Q.isUndefined(t)?Q.isUndefined(e)?void 0:s(void 0,e,0,r):s(e,t,0,r)}function n(e,t){if(!Q.isUndefined(t))return s(void 0,t)}function a(e,t){return Q.isUndefined(t)?Q.isUndefined(e)?void 0:s(void 0,e):s(void 0,t)}function o(i,r,n){return n in t?s(i,r):n in e?s(void 0,i):void 0}const l={url:n,method:n,data:n,baseURL:a,transformRequest:a,transformResponse:a,paramsSerializer:a,timeout:a,timeoutMessage:a,withCredentials:a,withXSRFToken:a,adapter:a,responseType:a,xsrfCookieName:a,xsrfHeaderName:a,onUploadProgress:a,onDownloadProgress:a,decompress:a,maxContentLength:a,maxBodyLength:a,beforeRedirect:a,transport:a,httpAgent:a,httpsAgent:a,cancelToken:a,socketPath:a,responseEncoding:a,validateStatus:o,headers:(e,t,i)=>r(Le(e),Le(t),0,!0)};return Q.forEach(Object.keys(Object.assign({},e,t)),(function(s){const n=l[s]||r,a=n(e[s],t[s],s);Q.isUndefined(a)&&n!==o||(i[s]=a)})),i}var ke=e=>{const t=Be({},e);let i,{data:s,withXSRFToken:r,xsrfHeaderName:n,xsrfCookieName:a,headers:o,auth:l}=t;if(t.headers=o=Pe.from(o),t.url=ae(Ne(t.baseURL,t.url),e.params,e.paramsSerializer),l&&o.set("Authorization","Basic "+btoa((l.username||"")+":"+(l.password?unescape(encodeURIComponent(l.password)):""))),Q.isFormData(s))if(fe.hasStandardBrowserEnv||fe.hasStandardBrowserWebWorkerEnv)o.setContentType(void 0);else if(!1!==(i=o.getContentType())){const[e,...t]=i?i.split(";").map((e=>e.trim())).filter(Boolean):[];o.setContentType([e||"multipart/form-data",...t].join("; "))}if(fe.hasStandardBrowserEnv&&(r&&Q.isFunction(r)&&(r=r(t)),r||!1!==r&&De(t.url))){const e=n&&a&&Fe.read(a);e&&o.set(n,e)}return t},Ve="undefined"!=typeof XMLHttpRequest&&function(e){return new Promise((function(t,i){const s=ke(e);let r=s.data;const n=Pe.from(s.headers).normalize();let a,o,l,h,c,{responseType:u,onUploadProgress:d,onDownloadProgress:_}=s;function p(){h&&h(),c&&c(),s.cancelToken&&s.cancelToken.unsubscribe(a),s.signal&&s.signal.removeEventListener("abort",a)}let f=new XMLHttpRequest;function m(){if(!f)return;const s=Pe.from("getAllResponseHeaders"in f&&f.getAllResponseHeaders());Ie((function(e){t(e),p()}),(function(e){i(e),p()}),{data:u&&"text"!==u&&"json"!==u?f.response:f.responseText,status:f.status,statusText:f.statusText,headers:s,config:e,request:f}),f=null}f.open(s.method.toUpperCase(),s.url,!0),f.timeout=s.timeout,"onloadend"in f?f.onloadend=m:f.onreadystatechange=function(){f&&4===f.readyState&&(0!==f.status||f.responseURL&&0===f.responseURL.indexOf("file:"))&&setTimeout(m)},f.onabort=function(){f&&(i(new Y("Request aborted",Y.ECONNABORTED,e,f)),f=null)},f.onerror=function(){i(new Y("Network Error",Y.ERR_NETWORK,e,f)),f=null},f.ontimeout=function(){let t=s.timeout?"timeout of "+s.timeout+"ms exceeded":"timeout exceeded";const r=s.transitional||le;s.timeoutErrorMessage&&(t=s.timeoutErrorMessage),i(new Y(t,r.clarifyTimeoutError?Y.ETIMEDOUT:Y.ECONNABORTED,e,f)),f=null},void 0===r&&n.setContentType(null),"setRequestHeader"in f&&Q.forEach(n.toJSON(),(function(e,t){f.setRequestHeader(t,e)})),Q.isUndefined(s.withCredentials)||(f.withCredentials=!!s.withCredentials),u&&"json"!==u&&(f.responseType=s.responseType),_&&([l,c]=Me(_,!0),f.addEventListener("progress",l)),d&&f.upload&&([o,h]=Me(d),f.upload.addEventListener("progress",o),f.upload.addEventListener("loadend",h)),(s.cancelToken||s.signal)&&(a=t=>{f&&(i(!t||t.type?new Re(null,e,f):t),f.abort(),f=null)},s.cancelToken&&s.cancelToken.subscribe(a),s.signal&&(s.signal.aborted?a():s.signal.addEventListener("abort",a)));const g=function(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}(s.url);g&&-1===fe.protocols.indexOf(g)?i(new Y("Unsupported protocol "+g+":",Y.ERR_BAD_REQUEST,e)):f.send(r||null)}))},Ue=(e,t)=>{const{length:i}=e=e?e.filter(Boolean):[];if(t||i){let i,s=new AbortController;const r=function(e){if(!i){i=!0,a();const t=e instanceof Error?e:this.reason;s.abort(t instanceof Y?t:new Re(t instanceof Error?t.message:t))}};let n=t&&setTimeout((()=>{n=null,r(new Y(`timeout ${t} of ms exceeded`,Y.ETIMEDOUT))}),t);const a=()=>{e&&(n&&clearTimeout(n),n=null,e.forEach((e=>{e.unsubscribe?e.unsubscribe(r):e.removeEventListener("abort",r)})),e=null)};e.forEach((e=>e.addEventListener("abort",r)));const{signal:o}=s;return o.unsubscribe=()=>Q.asap(a),o}};const ze=function*(e,t){let i=e.byteLength;if(!t||i<t)return void(yield e);let s,r=0;for(;r<i;)s=r+t,yield e.slice(r,s),r=s},Ge=(e,t,i,s)=>{const r=async function*(e,t){for await(const i of async function*(e){if(e[Symbol.asyncIterator])return void(yield*e);const t=e.getReader();try{for(;;){const{done:e,value:i}=await t.read();if(e)break;yield i}}finally{await t.cancel()}}(e))yield*ze(i,t)}(e,t);let n,a=0,o=e=>{n||(n=!0,s&&s(e))};return new ReadableStream({async pull(e){try{const{done:t,value:s}=await r.next();if(t)return o(),void e.close();let n=s.byteLength;if(i){let e=a+=n;i(e)}e.enqueue(new Uint8Array(s))}catch(e){throw o(e),e}},cancel:e=>(o(e),r.return())},{highWaterMark:2})},He="function"==typeof fetch&&"function"==typeof Request&&"function"==typeof Response,We=He&&"function"==typeof ReadableStream,Xe=He&&("function"==typeof TextEncoder?(Ke=new TextEncoder,e=>Ke.encode(e)):async e=>new Uint8Array(await new Response(e).arrayBuffer()));var Ke;const Qe=(e,...t)=>{try{return!!e(...t)}catch(e){return!1}},Ye=We&&Qe((()=>{let e=!1;const t=new Request(fe.origin,{body:new ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type");return e&&!t})),qe=We&&Qe((()=>Q.isReadableStream(new Response("").body))),$e={stream:qe&&(e=>e.body)};var je;He&&(je=new Response,["text","arrayBuffer","blob","formData","stream"].forEach((e=>{!$e[e]&&($e[e]=Q.isFunction(je[e])?t=>t[e]():(t,i)=>{throw new Y(`Response type '${e}' is not supported`,Y.ERR_NOT_SUPPORT,i)})})));const Ze={http:null,xhr:Ve,fetch:He&&(async e=>{let{url:t,method:i,data:s,signal:r,cancelToken:n,timeout:a,onDownloadProgress:o,onUploadProgress:l,responseType:h,headers:c,withCredentials:u="same-origin",fetchOptions:d}=ke(e);h=h?(h+"").toLowerCase():"text";let _,p=Ue([r,n&&n.toAbortSignal()],a);const f=p&&p.unsubscribe&&(()=>{p.unsubscribe()});let m;try{if(l&&Ye&&"get"!==i&&"head"!==i&&0!==(m=await(async(e,t)=>{const i=Q.toFiniteNumber(e.getContentLength());return null==i?(async e=>{if(null==e)return 0;if(Q.isBlob(e))return e.size;if(Q.isSpecCompliantForm(e)){const t=new Request(fe.origin,{method:"POST",body:e});return(await t.arrayBuffer()).byteLength}return Q.isArrayBufferView(e)||Q.isArrayBuffer(e)?e.byteLength:(Q.isURLSearchParams(e)&&(e+=""),Q.isString(e)?(await Xe(e)).byteLength:void 0)})(t):i})(c,s))){let e,i=new Request(t,{method:"POST",body:s,duplex:"half"});if(Q.isFormData(s)&&(e=i.headers.get("content-type"))&&c.setContentType(e),i.body){const[e,t]=Oe(m,Me(we(l)));s=Ge(i.body,65536,e,t)}}Q.isString(u)||(u=u?"include":"omit");const r="credentials"in Request.prototype;_=new Request(t,{...d,signal:p,method:i.toUpperCase(),headers:c.normalize().toJSON(),body:s,duplex:"half",credentials:r?u:void 0});let n=await fetch(_);const a=qe&&("stream"===h||"response"===h);if(qe&&(o||a&&f)){const e={};["status","statusText","headers"].forEach((t=>{e[t]=n[t]}));const t=Q.toFiniteNumber(n.headers.get("content-length")),[i,s]=o&&Oe(t,Me(we(o),!0))||[];n=new Response(Ge(n.body,65536,i,(()=>{s&&s(),f&&f()})),e)}h=h||"text";let g=await $e[Q.findKey($e,h)||"text"](n,e);return!a&&f&&f(),await new Promise(((t,i)=>{Ie(t,i,{data:g,headers:Pe.from(n.headers),status:n.status,statusText:n.statusText,config:e,request:_})}))}catch(t){if(f&&f(),t&&"TypeError"===t.name&&/fetch/i.test(t.message))throw Object.assign(new Y("Network Error",Y.ERR_NETWORK,e,_),{cause:t.cause||t});throw Y.from(t,t&&t.code,e,_)}})};Q.forEach(Ze,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch(e){}Object.defineProperty(e,"adapterName",{value:t})}}));const Je=e=>`- ${e}`,et=e=>Q.isFunction(e)||null===e||!1===e;var tt=e=>{e=Q.isArray(e)?e:[e];const{length:t}=e;let i,s;const r={};for(let n=0;n<t;n++){let t;if(i=e[n],s=i,!et(i)&&(s=Ze[(t=String(i)).toLowerCase()],void 0===s))throw new Y(`Unknown adapter '${t}'`);if(s)break;r[t||"#"+n]=s}if(!s){const e=Object.entries(r).map((([e,t])=>`adapter ${e} `+(!1===t?"is not supported by the environment":"is not available in the build")));throw new Y("There is no suitable adapter to dispatch the request "+(t?e.length>1?"since :\n"+e.map(Je).join("\n"):" "+Je(e[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return s};function it(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new Re(null,e)}function st(e){return it(e),e.headers=Pe.from(e.headers),e.data=Ee.call(e,e.transformRequest),-1!==["post","put","patch"].indexOf(e.method)&&e.headers.setContentType("application/x-www-form-urlencoded",!1),tt(e.adapter||ve.adapter)(e).then((function(t){return it(e),t.data=Ee.call(e,e.transformResponse,t),t.headers=Pe.from(t.headers),t}),(function(t){return Ae(t)||(it(e),t&&t.response&&(t.response.data=Ee.call(e,e.transformResponse,t.response),t.response.headers=Pe.from(t.response.headers))),Promise.reject(t)}))}const rt={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{rt[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}}));const nt={};rt.transitional=function(e,t,i){function s(e,t){return"[Axios v1.7.8] Transitional option '"+e+"'"+t+(i?". "+i:"")}return(i,r,n)=>{if(!1===e)throw new Y(s(r," has been removed"+(t?" in "+t:"")),Y.ERR_DEPRECATED);return t&&!nt[r]&&(nt[r]=!0,console.warn(s(r," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(i,r,n)}},rt.spelling=function(e){return(t,i)=>(console.warn(`${i} is likely a misspelling of ${e}`),!0)};var at={assertOptions:function(e,t,i){if("object"!=typeof e)throw new Y("options must be an object",Y.ERR_BAD_OPTION_VALUE);const s=Object.keys(e);let r=s.length;for(;r-- >0;){const n=s[r],a=t[n];if(a){const t=e[n],i=void 0===t||a(t,n,e);if(!0!==i)throw new Y("option "+n+" must be "+i,Y.ERR_BAD_OPTION_VALUE)}else if(!0!==i)throw new Y("Unknown option "+n,Y.ERR_BAD_OPTION)}},validators:rt};const ot=at.validators;class lt{constructor(e){this.defaults=e,this.interceptors={request:new oe,response:new oe}}async request(e,t){try{return await this._request(e,t)}catch(e){if(e instanceof Error){let t={};Error.captureStackTrace?Error.captureStackTrace(t):t=new Error;const i=t.stack?t.stack.replace(/^.+\n/,""):"";try{e.stack?i&&!String(e.stack).endsWith(i.replace(/^.+\n.+\n/,""))&&(e.stack+="\n"+i):e.stack=i}catch(e){}}throw e}}_request(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},t=Be(this.defaults,t);const{transitional:i,paramsSerializer:s,headers:r}=t;void 0!==i&&at.assertOptions(i,{silentJSONParsing:ot.transitional(ot.boolean),forcedJSONParsing:ot.transitional(ot.boolean),clarifyTimeoutError:ot.transitional(ot.boolean)},!1),null!=s&&(Q.isFunction(s)?t.paramsSerializer={serialize:s}:at.assertOptions(s,{encode:ot.function,serialize:ot.function},!0)),at.assertOptions(t,{baseUrl:ot.spelling("baseURL"),withXsrfToken:ot.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let n=r&&Q.merge(r.common,r[t.method]);r&&Q.forEach(["delete","get","head","post","put","patch","common"],(e=>{delete r[e]})),t.headers=Pe.concat(n,r);const a=[];let o=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(o=o&&e.synchronous,a.unshift(e.fulfilled,e.rejected))}));const l=[];let h;this.interceptors.response.forEach((function(e){l.push(e.fulfilled,e.rejected)}));let c,u=0;if(!o){const e=[st.bind(this),void 0];for(e.unshift.apply(e,a),e.push.apply(e,l),c=e.length,h=Promise.resolve(t);u<c;)h=h.then(e[u++],e[u++]);return h}c=a.length;let d=t;for(u=0;u<c;){const e=a[u++],t=a[u++];try{d=e(d)}catch(e){t.call(this,e);break}}try{h=st.call(this,d)}catch(e){return Promise.reject(e)}for(u=0,c=l.length;u<c;)h=h.then(l[u++],l[u++]);return h}getUri(e){return ae(Ne((e=Be(this.defaults,e)).baseURL,e.url),e.params,e.paramsSerializer)}}Q.forEach(["delete","get","head","options"],(function(e){lt.prototype[e]=function(t,i){return this.request(Be(i||{},{method:e,url:t,data:(i||{}).data}))}})),Q.forEach(["post","put","patch"],(function(e){function t(t){return function(i,s,r){return this.request(Be(r||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:i,data:s}))}}lt.prototype[e]=t(),lt.prototype[e+"Form"]=t(!0)}));var ht=lt;class ct{constructor(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");let t;this.promise=new Promise((function(e){t=e}));const i=this;this.promise.then((e=>{if(!i._listeners)return;let t=i._listeners.length;for(;t-- >0;)i._listeners[t](e);i._listeners=null})),this.promise.then=e=>{let t;const s=new Promise((e=>{i.subscribe(e),t=e})).then(e);return s.cancel=function(){i.unsubscribe(t)},s},e((function(e,s,r){i.reason||(i.reason=new Re(e,s,r),t(i.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}toAbortSignal(){const e=new AbortController,t=t=>{e.abort(t)};return this.subscribe(t),e.signal.unsubscribe=()=>this.unsubscribe(t),e.signal}static source(){let e;return{token:new ct((function(t){e=t})),cancel:e}}}var ut=ct;const dt={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(dt).forEach((([e,t])=>{dt[t]=e}));var _t=dt;const pt=function e(t){const i=new ht(t),r=s(ht.prototype.request,i);return Q.extend(r,ht.prototype,i,{allOwnKeys:!0}),Q.extend(r,i,null,{allOwnKeys:!0}),r.create=function(i){return e(Be(t,i))},r}(ve);pt.Axios=ht,pt.CanceledError=Re,pt.CancelToken=ut,pt.isCancel=Ae,pt.VERSION="1.7.8",pt.toFormData=te,pt.AxiosError=Y,pt.Cancel=pt.CanceledError,pt.all=function(e){return Promise.all(e)},pt.spread=function(e){return function(t){return e.apply(null,t)}},pt.isAxiosError=function(e){return Q.isObject(e)&&!0===e.isAxiosError},pt.mergeConfig=Be,pt.AxiosHeaders=Pe,pt.formToJSON=e=>me(Q.isHTMLForm(e)?new FormData(e):e),pt.getAdapter=tt,pt.HttpStatusCode=_t,pt.default=pt,e.exports=pt},5616:(e,t,i)=>{"use strict";i.d(t,{R:()=>a,h:()=>n});var s=i(1504),r=i(1137);class n{get isDisposed(){return this._isDisposed}constructor(e,t,i,r=0,n=!1,a=!1,o=!1,l,h){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=a,this._divisor=l||1,this._label=h,t instanceof s.n?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?r:r*Float32Array.BYTES_PER_ELEMENT,n||this.create()}createVertexBuffer(e,t,i,s,r,n=!1,o){const l=n?t:t*Float32Array.BYTES_PER_ELEMENT,h=s?n?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new a(this._engine,this,e,this._updatable,!0,h,void 0===r?this._instanced:r,l,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0)return void(this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label));r.V.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null}}update(e){this.create(e)}updateDirectly(e,t,i,s=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,s?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),this._data=0===t&&void 0===i?e:null)}_increaseReferences(){this._buffer&&(this._isAlreadyOwned?this._buffer.references++:this._isAlreadyOwned=!0)}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class a{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=0!=e;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get _maxVerticesCount(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,i,s,r,o,l,h,c,u,d=!1,_=!1,p=1,f=!1){this._isDisposed=!1;let m=!1;if(this.engine=e,"object"==typeof s&&null!==s?(m=s.updatable??!1,r=s.postponeInternalCreation,o=s.stride,l=s.instanced,h=s.offset,c=s.size,u=s.type,d=s.normalized??!1,_=s.useBytes??!1,p=s.divisor??1,f=s.takeBufferOwnership??!1,this._label=s.label):m=!!s,t instanceof n?(this._buffer=t,this._ownsBuffer=f):(this._buffer=new n(e,t,m,o,r,l,_,p,this._label),this._ownsBuffer=!0),this.uniqueId=a._Counter++,this._kind=i,void 0===u){const e=this.getData();this.type=e?a.GetDataType(e):a.FLOAT}else this.type=u;const g=a.GetTypeByteLength(this.type);_?(this._size=c||(o?o/g:a.DeduceStride(i)),this.byteStride=o||this._buffer.byteStride||this._size*g,this.byteOffset=h||0):(this._size=c||o||a.DeduceStride(i),this.byteStride=o?o*g:this._buffer.byteStride||this._size*g,this.byteOffset=(h||0)*g),this.normalized=d,this._instanced=void 0!==l&&l,this._instanceDivisor=l?p:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120|0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer?._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();return i?a.GetFloatData(i,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/a.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/a.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*a.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){a.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)}_alignBuffer(){}static DeduceStride(e){switch(e){case a.UVKind:case a.UV2Kind:case a.UV3Kind:case a.UV4Kind:case a.UV5Kind:case a.UV6Kind:return 2;case a.NormalKind:case a.PositionKind:return 3;case a.ColorKind:case a.ColorInstanceKind:case a.MatricesIndicesKind:case a.MatricesIndicesExtraKind:case a.MatricesWeightsKind:case a.MatricesWeightsExtraKind:case a.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?a.BYTE:e instanceof Uint8Array?a.UNSIGNED_BYTE:e instanceof Int16Array?a.SHORT:e instanceof Uint16Array?a.UNSIGNED_SHORT:e instanceof Int32Array?a.INT:e instanceof Uint32Array?a.UNSIGNED_INT:a.FLOAT}static GetTypeByteLength(e){switch(e){case a.BYTE:case a.UNSIGNED_BYTE:return 1;case a.SHORT:case a.UNSIGNED_SHORT:return 2;case a.INT:case a.UNSIGNED_INT:case a.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,t,i,s,r,n,o,l){if(e instanceof Array){let r=t/4;const a=i/4;for(let t=0;t<n;t+=s){for(let i=0;i<s;i++)l(e[r+i],t+i);r+=a}}else{const h=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),c=a.GetTypeByteLength(r);for(let e=0;e<n;e+=s){let n=t;for(let t=0;t<s;t++)l(a._GetFloatValue(h,r,n,o),e+t),n+=c;t+=i}}}static _GetFloatValue(e,t,i,s){switch(t){case a.BYTE:{let t=e.getInt8(i);return s&&(t=Math.max(t/127,-1)),t}case a.UNSIGNED_BYTE:{let t=e.getUint8(i);return s&&(t/=255),t}case a.SHORT:{let t=e.getInt16(i,!0);return s&&(t=Math.max(t/32767,-1)),t}case a.UNSIGNED_SHORT:{let t=e.getUint16(i,!0);return s&&(t/=65535),t}case a.INT:return e.getInt32(i,!0);case a.UNSIGNED_INT:return e.getUint32(i,!0);case a.FLOAT:return e.getFloat32(i,!0);default:throw new Error(`Invalid component type ${t}`)}}static GetFloatData(e,t,i,s,n,o,l,h){const c=t*a.GetTypeByteLength(i),u=l*t;if(i!==a.FLOAT||n!==c){const r=new Float32Array(u);return a.ForEach(e,s,n,t,i,u,o,((e,t)=>r[t]=e)),r}if(!(e instanceof Array||e instanceof Float32Array)||0!==s||e.length!==u){if(e instanceof Array){const t=s/4;return e.slice(t,t+u)}if(e instanceof ArrayBuffer)return new Float32Array(e,s,u);{const t=e.byteOffset+s;if(3&t&&(r.V.Warn("Float array must be aligned to 4-bytes border"),h=!0),h){const i=new Uint8Array(u*Float32Array.BYTES_PER_ELEMENT),s=new Uint8Array(e.buffer,t,i.length);return i.set(s),new Float32Array(i.buffer)}return new Float32Array(e.buffer,t,u)}}return h?e.slice():e}}a._Counter=0,a.BYTE=5120,a.UNSIGNED_BYTE=5121,a.SHORT=5122,a.UNSIGNED_SHORT=5123,a.INT=5124,a.UNSIGNED_INT=5125,a.FLOAT=5126,a.PositionKind="position",a.NormalKind="normal",a.TangentKind="tangent",a.UVKind="uv",a.UV2Kind="uv2",a.UV3Kind="uv3",a.UV4Kind="uv4",a.UV5Kind="uv5",a.UV6Kind="uv6",a.ColorKind="color",a.ColorInstanceKind="instanceColor",a.MatricesIndicesKind="matricesIndices",a.MatricesWeightsKind="matricesWeights",a.MatricesIndicesExtraKind="matricesIndicesExtra",a.MatricesWeightsExtraKind="matricesWeightsExtra"},1504:(e,t,i)=>{"use strict";i.d(t,{n:()=>s});class s{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=s._Counter++}}s._Counter=0},7103:(e,t,i)=>{"use strict";i.d(t,{w:()=>s});class s{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}},311:(e,t,i)=>{"use strict";i.d(t,{G:()=>n});var s=i(9923),r=i(5616);class n{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(r.R.NormalKind))return null;let i,n=this.pickedMesh.getIndices();0===n?.length&&(n=null);const a=s.AA.Vector3[0],o=s.AA.Vector3[1],l=s.AA.Vector3[2];if(t){const e=this.pickedMesh.getVerticesData(r.R.NormalKind);let t=n?s.Pq.FromArrayToRef(e,3*n[3*this.faceId],a):a.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),h=n?s.Pq.FromArrayToRef(e,3*n[3*this.faceId+1],o):o.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),c=n?s.Pq.FromArrayToRef(e,3*n[3*this.faceId+2],l):l.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]);t=t.scale(this.bu),h=h.scale(this.bv),c=c.scale(1-this.bu-this.bv),i=new s.Pq(t.x+h.x+c.x,t.y+h.y+c.y,t.z+h.z+c.z)}else{const e=this.pickedMesh.getVerticesData(r.R.PositionKind),t=n?s.Pq.FromArrayToRef(e,3*n[3*this.faceId],a):a.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),h=n?s.Pq.FromArrayToRef(e,3*n[3*this.faceId+1],o):o.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),c=n?s.Pq.FromArrayToRef(e,3*n[3*this.faceId+2],l):l.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]),u=t.subtract(h),d=c.subtract(h);i=s.Pq.Cross(u,d)}const h=(e,t)=>{let i=e.getWorldMatrix();e.nonUniformScaling&&(s.AA.Matrix[0].copyFrom(i),i=s.AA.Matrix[0],i.setTranslationFromFloats(0,0,0),i.invert(),i.transposeToRef(s.AA.Matrix[1]),i=s.AA.Matrix[1]),s.Pq.TransformNormalToRef(t,i,t)};if(e&&h(this.pickedMesh,i),this.ray){const t=s.AA.Vector3[0].copyFrom(i);e||h(this.pickedMesh,t),s.Pq.Dot(t,this.ray.direction)>0&&i.negateInPlace()}return i.normalize(),i}getTextureCoordinates(e=r.R.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let n=s.I9.FromArray(i,2*t[3*this.faceId]),a=s.I9.FromArray(i,2*t[3*this.faceId+1]),o=s.I9.FromArray(i,2*t[3*this.faceId+2]);return n=n.scale(this.bu),a=a.scale(this.bv),o=o.scale(1-this.bu-this.bv),new s.I9(n.x+a.x+o.x,n.y+a.y+o.y)}}},1313:(e,t,i)=>{"use strict";i.d(t,{rX:()=>s});let s=!1},4766:(e,t,i)=>{"use strict";i.d(t,{I:()=>a});var s=i(7309),r=i(9923),n=i(5559);class a{constructor(e,t,i){this.vectors=(0,s.mI)(8,r.Pq.Zero),this.center=r.Pq.Zero(),this.centerWorld=r.Pq.Zero(),this.extendSize=r.Pq.Zero(),this.extendSizeWorld=r.Pq.Zero(),this.directions=(0,s.mI)(3,r.Pq.Zero),this.vectorsWorld=(0,s.mI)(8,r.Pq.Zero),this.minimumWorld=r.Pq.Zero(),this.maximumWorld=r.Pq.Zero(),this.minimum=r.Pq.Zero(),this.maximum=r.Pq.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const s=e.x,n=e.y,a=e.z,o=t.x,l=t.y,h=t.z,c=this.vectors;this.minimum.copyFromFloats(s,n,a),this.maximum.copyFromFloats(o,l,h),c[0].copyFromFloats(s,n,a),c[1].copyFromFloats(o,l,h),c[2].copyFromFloats(o,n,a),c[3].copyFromFloats(s,l,a),c[4].copyFromFloats(s,n,h),c[5].copyFromFloats(o,l,a),c[6].copyFromFloats(s,l,h),c[7].copyFromFloats(o,n,h),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||r.uq.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=a._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),s=i.length();i.normalizeFromLength(s);const r=s*e,n=i.scaleInPlace(.5*r),o=this.center.subtractToRef(n,t[1]),l=this.center.addToRef(n,t[2]);return this.reConstruct(o,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,s=this.directions,n=this.vectorsWorld,a=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let e=0;e<8;++e)n[e].copyFrom(a[e]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let s=0;s<8;++s){const o=n[s];r.Pq.TransformCoordinatesToRef(a[s],e,o),t.minimizeInPlace(o),i.maximizeInPlace(o)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}r.Pq.FromArrayToRef(e.m,0,s[0]),r.Pq.FromArrayToRef(e.m,4,s[1]),r.Pq.FromArrayToRef(e.m,8,s[2]),this._worldMatrix=e}isInFrustum(e){return a.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return a.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,s=t.x,r=t.y,a=t.z,o=i.x,l=i.y,h=i.z,c=e.x,u=e.y,d=e.z,_=-n.bH;return!(o-c<_||_>c-s||l-u<_||_>u-r||h-d<_||_>d-a)}intersectsSphere(e){return a.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,s=this.maximumWorld,r=i.x,n=i.y,a=i.z,o=s.x,l=s.y,h=s.z,c=e.x,u=e.y,d=e.z,_=t.x,p=t.y,f=t.z;return!(o<c||r>_||l<u||n>p||h<d||a>f)}dispose(){this._drawWrapperFront?.dispose(),this._drawWrapperBack?.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,s){const n=a._TmpVector3[0];return r.Pq.ClampToRef(i,e,t,n),r.Pq.DistanceSquared(i,n)<=s*s}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const s=t[i];for(let t=0;t<8;++t)if(s.dotCoordinate(e[t])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let s=!0;const r=t[i];for(let t=0;t<8;++t)if(r.dotCoordinate(e[t])>=0){s=!1;break}if(s)return!1}return!0}}a._TmpVector3=(0,s.mI)(3,r.Pq.Zero)},863:(e,t,i)=>{"use strict";i.d(t,{j:()=>u});var s=i(7309),r=i(9923),n=i(4766),a=i(7906);const o={min:0,max:0},l={min:0,max:0},h=(e,t,i)=>{const s=r.Pq.Dot(t.centerWorld,e),n=Math.abs(r.Pq.Dot(t.directions[0],e))*t.extendSize.x+Math.abs(r.Pq.Dot(t.directions[1],e))*t.extendSize.y+Math.abs(r.Pq.Dot(t.directions[2],e))*t.extendSize.z;i.min=s-n,i.max=s+n},c=(e,t,i)=>(h(e,t,o),h(e,i,l),!(o.min>l.max||l.min>o.max));class u{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new n.I(e,t,i),this.boundingSphere=new a.i(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=u._TmpVector3[0].copyFrom(e).subtractInPlace(t),s=u._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=r.Pq.Minimize(this.minimum,e),i=r.Pq.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=r.AA.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const i=r.AA.Vector3[0];return r.Pq.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),r.Pq.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return!(2!==t&&3!==t||!this.boundingSphere.isCenterInFrustum(e))||!!this.boundingSphere.isInFrustum(e)&&(!(1!==t&&3!==t)||this.boundingBox.isInFrustum(e))}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,u._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!!this.boundingSphere.centerWorld&&!!this.boundingSphere.intersectsPoint(e)&&!!this.boundingBox.intersectsPoint(e)}intersects(e,t){if(!a.i.Intersects(this.boundingSphere,e.boundingSphere))return!1;if(!n.I.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,s=e.boundingBox;return!!(c(i.directions[0],i,s)&&c(i.directions[1],i,s)&&c(i.directions[2],i,s)&&c(s.directions[0],i,s)&&c(s.directions[1],i,s)&&c(s.directions[2],i,s)&&c(r.Pq.Cross(i.directions[0],s.directions[0]),i,s)&&c(r.Pq.Cross(i.directions[0],s.directions[1]),i,s)&&c(r.Pq.Cross(i.directions[0],s.directions[2]),i,s)&&c(r.Pq.Cross(i.directions[1],s.directions[0]),i,s)&&c(r.Pq.Cross(i.directions[1],s.directions[1]),i,s)&&c(r.Pq.Cross(i.directions[1],s.directions[2]),i,s)&&c(r.Pq.Cross(i.directions[2],s.directions[0]),i,s)&&c(r.Pq.Cross(i.directions[2],s.directions[1]),i,s)&&c(r.Pq.Cross(i.directions[2],s.directions[2]),i,s))}}u._TmpVector3=(0,s.mI)(2,r.Pq.Zero)},7906:(e,t,i)=>{"use strict";i.d(t,{i:()=>n});var s=i(7309),r=i(9923);class n{constructor(e,t,i){this.center=r.Pq.Zero(),this.centerWorld=r.Pq.Zero(),this.minimum=r.Pq.Zero(),this.maximum=r.Pq.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const s=r.Pq.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=.5*s,this._update(i||r.uq.IdentityReadOnly)}scale(e){const t=this.radius*e,i=n._TmpVector3,s=i[0].setAll(t),r=this.center.subtractToRef(s,i[1]),a=this.center.addToRef(s,i[2]);return this.reConstruct(r,a,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{r.Pq.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=n._TmpVector3[0];r.Pq.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let s=0;s<6;s++)if(e[s].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=r.Pq.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=r.Pq.DistanceSquared(e.centerWorld,t.centerWorld),s=e.radiusWorld+t.radiusWorld;return!(s*s<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const s=new n(this._TmpVector3[0],this._TmpVector3[2]);return s._worldMatrix=i||r.uq.Identity(),s}}n._TmpVector3=(0,s.mI)(3,r.Pq.Zero)},9195:(e,t,i)=>{"use strict";var s=i(854),r=i(1137),n=i(655),a=i(8688),o=i(6326),l=i(8454);o.$.prototype._partialLoadFile=function(e,t,i,s,r=null){this._loadFile(e,(e=>{i[t]=e,i._internalCount++,6===i._internalCount&&s(i)}),void 0,void 0,!0,((e,t)=>{r&&e&&r(e.status+" "+e.statusText,t)}))},o.$.prototype._cascadeLoadFiles=function(e,t,i,s=null){const r=[];r._internalCount=0;for(let e=0;e<6;e++)this._partialLoadFile(i[e],e,r,t,s)},o.$.prototype._cascadeLoadImgs=function(e,t,i,s,r=null,n){const a=[];a._internalCount=0;for(let o=0;o<6;o++)this._partialLoadImg(s[o],o,a,e,t,i,r,n)},o.$.prototype._partialLoadImg=function(e,t,i,s,r,o,l=null,h){const c=(0,a.z)();(0,n.W$)(e,(e=>{i[t]=e,i._internalCount++,s&&s.removePendingData(c),6===i._internalCount&&o&&o(r,i)}),((e,t)=>{s&&s.removePendingData(c),l&&l(e,t)}),s?s.offlineProvider:null,h),s&&s.addPendingData(c)},o.$.prototype.createCubeTextureBase=function(e,t,i,n,a=null,o=null,h,c=null,u=!1,d=0,_=0,p=null,f=null,m=null,g=!1,v=null){const b=p||new s.h(this,7);b.isCube=!0,b.url=e,b.generateMipMaps=!n,b._lodGenerationScale=d,b._lodGenerationOffset=_,b._useSRGBBuffer=!!g&&this._caps.supportSRGBBuffers&&(this.version>1||this.isWebGPU||!!n),b!==p&&(b.label=e.substring(0,60)),this._doNotHandleContextLost||(b._extension=c,b._files=i,b._buffer=v);const x=e;this._transformTextureUrl&&!p&&(e=this._transformTextureUrl(e));const S=e.split("?")[0],T=S.lastIndexOf("."),y=c||(T>-1?S.substring(T).toLowerCase():""),C=(0,l.gT)(y),P=(s,l)=>{e===x?o&&s&&o(s.status+" "+s.statusText,l):(r.V.Warn(`Failed to load ${e}, falling back to the ${x}`),this.createCubeTextureBase(x,t,i,!!n,a,o,h,c,u,d,_,b,f,m,g,v))};if(C)C.then((s=>{const n=e=>{f&&f(b,e),s.loadCubeData(e,b,u,a,o)};v?n(v):i&&6===i.length?s.supportCascades?this._cascadeLoadFiles(t,(e=>n(e.map((e=>new Uint8Array(e))))),i,o):o?o("Textures type does not support cascades."):r.V.Warn("Texture loader does not support cascades."):this._loadFile(e,(e=>n(new Uint8Array(e))),void 0,void 0,!0,P)}));else{if(!i||0===i.length)throw new Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(t,b,((e,t)=>{m&&m(e,t)}),i,o)}return this._internalTexturesCache.push(b),b}},9125:(e,t,i)=>{"use strict";i.d(t,{nO:()=>C,pB:()=>T,M0:()=>y,Iq:()=>I,J:()=>M});class s{constructor(){this.children=[]}isValid(e){return!0}process(e,t){let i="";if(this.line){let s=this.line;const r=t.processor;if(r){r.lineProcessor&&(s=r.lineProcessor(s,t.isFragment,t.processingContext));const i=t.processor?.attributeKeywordName??"attribute",n=t.isFragment&&t.processor?.varyingFragmentKeywordName?t.processor?.varyingFragmentKeywordName:!t.isFragment&&t.processor?.varyingVertexKeywordName?t.processor?.varyingVertexKeywordName:"varying";!t.isFragment&&r.attributeProcessor&&this.line.startsWith(i)?s=r.attributeProcessor(this.line,e,t.processingContext):r.varyingProcessor&&(r.varyingCheck?.(this.line,t.isFragment)||!r.varyingCheck&&this.line.startsWith(n))?s=r.varyingProcessor(this.line,t.isFragment,e,t.processingContext):r.uniformProcessor&&r.uniformRegexp&&r.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(s=r.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):r.uniformBufferProcessor&&r.uniformBufferRegexp&&r.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(s=r.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):r.textureProcessor&&r.textureRegexp&&r.textureRegexp.test(this.line)?s=r.textureProcessor(this.line,t.isFragment,e,t.processingContext):(r.uniformProcessor||r.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?r.uniformProcessor&&(s=r.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):r.uniformBufferProcessor&&(s=r.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,r.endOfUniformBufferProcessor&&(s=r.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}i+=s+"\n"}return this.children.forEach((s=>{i+=s.process(e,t)})),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),i}}class r{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||"\r"===t)continue;if("#"===t[0]){this._lines.push(t);continue}const e=t.trim();if(!e)continue;if(e.startsWith("//")){this._lines.push(t);continue}const i=e.indexOf(";");if(-1===i)this._lines.push(e);else if(i===e.length-1)e.length>1&&this._lines.push(e);else{const e=t.split(";");for(let t=0;t<e.length;t++){let i=e[t];i&&(i=i.trim(),i&&this._lines.push(i+(t!==e.length-1?";":"")))}}}}}class n extends s{process(e,t){for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s.isValid(e))return s.process(e,t)}return""}}class a extends s{isValid(e){return this.testExpression.isTrue(e)}}class o{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(void 0===o._OperatorPriority[i])t.push(i);else{const e=t[t.length-1],s=t[t.length-2];t.length-=2,t.push(`(${s}${i}${e})`)}return t[t.length-1]}static infixToPostfix(e){const t=o._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!(e.includes("&&")||e.includes("||")||e.includes(")")||e.includes("(")))return[e];const i=[];let s=-1;const r=()=>{c=c.trim(),""!==c&&(i.push(c),c="")},n=e=>{s<o._Stack.length-1&&(o._Stack[++s]=e)},a=()=>o._Stack[s],l=()=>-1===s?"!!INVALID EXPRESSION!!":o._Stack[s--];let h=0,c="";for(;h<e.length;){const t=e.charAt(h),u=h<e.length-1?e.substring(h,2+h):"";if("("===t)c="",n(t);else if(")"===t){for(r();-1!==s&&"("!==a();)i.push(l());l()}else if(o._OperatorPriority[u]>1){for(r();-1!==s&&o._OperatorPriority[a()]>=o._OperatorPriority[u];)i.push(l());n(u),h++}else c+=t;h++}for(r();-1!==s;)"("===a()?l():i.push(l());return o._InfixToPostfixCache.size>=o.InfixToPostfixCacheLimitSize&&o.ClearCache(),o._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(o._InfixToPostfixCache.entries()).sort(((e,t)=>e[1].accessTime-t[1].accessTime));for(let t=0;t<o.InfixToPostfixCacheCleanupSize;t++)o._InfixToPostfixCache.delete(e[t][0])}}o.InfixToPostfixCacheLimitSize=5e4,o.InfixToPostfixCacheCleanupSize=25e3,o._InfixToPostfixCache=new Map,o._OperatorPriority={")":0,"(":1,"||":2,"&&":3},o._Stack=["","","","","","","","","","","","","","","","","","","",""];class l extends o{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=void 0!==e[this.define];return this.not&&(t=!t),t}}class h extends o{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class c extends o{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class u extends o{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];void 0===t&&(t=this.define);let i=!1;const s=parseInt(t),r=parseInt(this.testValue);switch(this.operand){case">":i=s>r;break;case"<":i=s<r;break;case"<=":i=s<=r;break;case">=":i=s>=r;break;case"==":i=s===r;break;case"!=":i=s!==r}return i}}var d=i(5503),_=i(6741);const p=/defined\s*?\((.+?)\)/g,f=/defined\s*?\[(.+?)\]/g,m=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,g=/__decl__/,v=/light\{X\}.(\w*)/g,b=/\{X\}/g,x=[],S=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;function T(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}function y(e,t,i,n){t.processor?.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),I(e,t,(e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e,t.defines));const a=function(e,t,i){let n=function(e,t){if(t.processor?.noPrecision)return e;const i=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=i?"precision highp float;\n"+e:"precision mediump float;\n"+e:i||(e=e.replace("precision highp float","precision mediump float")),e}(e,t);if(!t.processor)return n;if(0===t.processor.shaderLanguage&&-1!==n.indexOf("#version 3")&&(n=n.replace("#version 300 es",""),!t.processor.parseGLES3))return n;const a=t.defines,o=function(e,t){const i=e.defines,s={};for(const e of i){const t=e.replace("#define","").replace(";","").trim().split(" ");s[t[0]]=t.length>1?t[1]:""}return 0===e.processor?.shaderLanguage&&(s.GL_ES="true"),s.__VERSION__=e.version,s[e.platformName]="true",(0,_.xt)(s,t?.isNDCHalfZRange,t?.useReverseDepthBuffer,t?.useExactSrgbConversions),s}(t,i);return t.processor.preProcessor&&(n=t.processor.preProcessor(n,a,o,t.isFragment,t.processingContext)),n=function(e,t,i){const n=new s,a=new r;return a.lineIndex=-1,a.lines=e.split("\n"),R(a,n),n.process(t,i)}(n,o,t),t.processor.postProcessor&&(n=t.processor.postProcessor(n,a,t.isFragment,t.processingContext,i?{drawBuffersExtensionDisabled:!i.getCaps().drawBuffersExtension}:{})),i?._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n}(e,t,n);i(a,e)}))}function C(e,t,i){return i.processor&&i.processor.finalizeShaders?i.processor.finalizeShaders(e,t,i.processingContext):{vertexCode:e,fragmentCode:t}}function P(e){const t=/defined\((.+)\)/.exec(e);if(t&&t.length)return new l(t[1].trim(),"!"===e[0]);const i=["==","!=",">=","<=","<",">"];let s="",r=0;for(s of i)if(r=e.indexOf(s),r>-1)break;if(-1===r)return new l(e);const n=e.substring(0,r).trim(),a=e.substring(r+s.length).trim();return new u(n,s,a)}function E(e,t){const i=new a,s=e.substring(0,t);let r=e.substring(t);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),i.testExpression="#ifdef"===s?new l(r):"#ifndef"===s?new l(r,!0):function(e){e=e.replace(p,"defined[$1]");const t=o.infixToPostfix(e),i=[];for(const e of t)if("||"!==e&&"&&"!==e)i.push(e);else if(i.length>=2){let t=i[i.length-1],s=i[i.length-2];i.length-=2;const r="&&"==e?new c:new h;"string"==typeof t&&(t=t.replace(f,"defined($1)")),"string"==typeof s&&(s=s.replace(f,"defined($1)")),r.leftOperand="string"==typeof s?P(s):s,r.rightOperand="string"==typeof t?P(t):t,i.push(r)}let s=i[i.length-1];return"string"==typeof s&&(s=s.replace(f,"defined($1)")),"string"==typeof s?P(s):s}(r),i}function A(e,t,i){let r=e.currentLine;for(;R(e,i);){r=e.currentLine;const n=r.substring(0,5).toLowerCase();if("#else"===n){const i=new s;return t.children.push(i),void R(e,i)}if("#elif"===n){const e=E(r,5);t.children.push(e),i=e}}}function R(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine;if(i.indexOf("#")>=0){const s=S.exec(i);if(s&&s.length){switch(s[0]){case"#ifdef":{const s=new n;t.children.push(s);const r=E(i,6);s.children.push(r),A(e,s,r);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const s=new n;t.children.push(s);const r=E(i,7);s.children.push(r),A(e,s,r);break}case"#if":{const s=new n,r=E(i,3);t.children.push(s),s.children.push(r),A(e,s,r);break}}continue}}const r=new s;if(r.line=i,t.children.push(r),"#"===i[0]&&"d"===i[1]){const e=i.replace(";","").split(" ");r.additionalDefineKey=e[1],3===e.length&&(r.additionalDefineValue=e[2])}}return!1}function I(e,t,i){let s;for(x.length=0;null!==(s=m.exec(e));)x.push(s);let r=String(e),n=[e],a=!1;for(const e of x){let s=e[1];if(-1!==s.indexOf("__decl__")&&(s=s.replace(g,""),t.supportsUniformBuffers&&(s=s.replace("Vertex","Ubo").replace("Fragment","Ubo")),s+="Declaration"),!t.includesShadersStore[s]){const e=t.shadersRepository+"ShadersInclude/"+s+".fx";return void M.loadFile(e,(e=>{t.includesShadersStore[s]=e,I(n.join(""),t,i)}))}{let i=t.includesShadersStore[s];if(e[2]){const t=e[3].split(",");for(let e=0;e<t.length;e+=2){const s=new RegExp(t[e],"g"),r=t[e+1];i=i.replace(s,r)}}if(e[4]){const s=e[5];if(-1!==s.indexOf("..")){const e=s.split(".."),r=parseInt(e[0]);let n=parseInt(e[1]),a=i.slice(0);i="",isNaN(n)&&(n=t.indexParameters[e[1]]);for(let e=r;e<n;e++)t.supportsUniformBuffers||(a=a.replace(v,((e,t)=>t+"{X}"))),i+=a.replace(b,e.toString())+"\n"}else t.supportsUniformBuffers||(i=i.replace(v,((e,t)=>t+"{X}"))),i=i.replace(b,s)}const r=[];for(const t of n){const s=t.split(e[0]);for(let e=0;e<s.length-1;e++)r.push(s[e]),r.push(i);r.push(s[s.length-1])}n=r,a=a||i.indexOf("#include<")>=0||i.indexOf("#include <")>=0}}x.length=0,r=n.join(""),a?I(r.toString(),t,i):i(r)}const M={loadFile:(e,t,i,s,r,n)=>{throw(0,d.n)("FileTools")}}},7716:(e,t,i)=>{"use strict";i.d(t,{d:()=>s});class s{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&!(e=t.createTexture()))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){return this._MSAARenderBuffers?.[e]??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}},6741:(e,t,i)=>{"use strict";i.d(t,{W0:()=>a,iL:()=>n,kZ:()=>l,sg:()=>r,xt:()=>o});var s=i(5503);i(8790);const r={};function n(e,t,i=""){return i+(t?t+"\n":"")+e}function a(e,t,i,n,a,o,l){const h=l||r.loadFile;if(h)return h(e,t,i,n,a,o);throw(0,s.n)("FileTools")}function o(e,t,i,s){if(e)return t?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,i?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,void(s?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS);{let e="";return t&&(e+="#define IS_NDC_HALF_ZRANGE"),i&&(e&&(e+="\n"),e+="#define USE_REVERSE_DEPTHBUFFER"),s&&(e&&(e+="\n"),e+="#define USE_EXACT_SRGB_CONVERSIONS"),e}}function l(e,t,i=!1,s){switch(e){case 3:{const e=(ArrayBuffer,new Int8Array(t));return s&&e.set(new Int8Array(s)),e}case 0:{const e=(ArrayBuffer,new Uint8Array(t));return s&&e.set(new Uint8Array(s)),e}case 4:{const e=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(i?t/2:t);return s&&e.set(new Int16Array(s)),e}case 5:case 8:case 9:case 10:case 2:{const e=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(i?t/2:t);return s&&e.set(new Uint16Array(s)),e}case 6:{const e=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(i?t/4:t);return s&&e.set(new Int32Array(s)),e}case 7:case 11:case 12:case 13:case 14:case 15:{const e=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(i?t/4:t);return s&&e.set(new Uint32Array(s)),e}case 1:{const e=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(i?t/4:t);return s&&e.set(new Float32Array(s)),e}}const r=(ArrayBuffer,new Uint8Array(t));return s&&r.set(new Uint8Array(s)),r}},6326:(e,t,i)=>{"use strict";i.d(t,{$:()=>b});var s=i(6315),r=i(1137),n=i(4420),a=i(215),o=i(6237);class l{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class h{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){this.stencilMaterial=void 0,this.stencilGlobal?.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){if(!e)return;const t=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class c{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=c.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=c.KEEP,this.opDepthFail=c.KEEP,this.opStencilDepthPass=c.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}c.ALWAYS=519,c.KEEP=7680,c.REPLACE=7681;class u{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,s){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===s||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=s,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,s){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===s||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=s,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}var d=i(5503),_=i(854),p=i(8790),f=i(9848),m=i(6741),g=i(8454);function v(e,t){if((0,p.BA)()){const{requestAnimationFrame:i}=t||window;if("function"==typeof i)return i(e)}else if("function"==typeof requestAnimationFrame)return requestAnimationFrame(e);return setTimeout(e,16)}class b{get frameId(){return this._frameId}get isWebGPU(){return this._isWebGPU}_getShaderProcessor(e){return this._shaderProcessor}get shaderPlatformName(){return this._shaderPlatformName}_clearEmptyResources(){this._emptyTexture=null,this._emptyCubeTexture=null,this._emptyTexture3D=null,this._emptyTexture2DArray=null}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,this._depthCullingState.depthFunc=e?518:515)}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}_getGlobalDefines(e){if(e)return this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,void(this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS);{let e="";return this.isNDCHalfZRange&&(e+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(e&&(e+="\n"),e+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(e&&(e+="\n"),e+="#define USE_EXACT_SRGB_CONVERSIONS"),e}}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._prepareEffect()}n.M.ResetCache()}_rebuildGraphicsResources(){this.wipeCaches(!0),this._rebuildEffects(),this._rebuildComputeEffects?.(),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0)}_flagContextRestored(){r.V.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}_restoreEngineAfterContextLost(e){setTimeout((async()=>{this._clearEmptyResources();const t=this._depthCullingState.depthTest,i=this._depthCullingState.depthFunc,s=this._depthCullingState.depthMask,r=this._stencilState.stencilTest;await e(),this._rebuildGraphicsResources(),this._depthCullingState.depthTest=t,this._depthCullingState.depthFunc=i,this._depthCullingState.depthMask=s,this._stencilState.stencilTest=r,this._flagContextRestored()}),0)}get isDisposed(){return this._isDisposed}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return 0}set snapshotRenderingMode(e){}getClassName(){return"AbstractEngine"}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get activeRenderLoops(){return this._activeRenderLoops}stopRenderLoop(e){if(!e)return this._activeRenderLoops.length=0,void this._cancelFrame();const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),0==this._activeRenderLoops.length&&this._cancelFrame())}_cancelFrame(){if(0!==this._frameHandler){const e=this._frameHandler;if(this._frameHandler=0,(0,p.BA)()){const{cancelAnimationFrame:t}=this.getHostWindow()||window;if("function"==typeof t)return t(e)}else if("function"==typeof cancelAnimationFrame)return cancelAnimationFrame(e);return clearTimeout(e)}}beginFrame(){this.onBeginFrameObservable.notifyObservers(this)}endFrame(){this._frameId++,this.onEndFrameObservable.notifyObservers(this)}_renderLoop(){if(this._frameHandler=0,!this._contextWasLost){let e=!0;(this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0&&0===this._frameHandler&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++)(0,this._activeRenderLoops[e])()}_renderViews(){return!1}_queueNewFrame(e,t){return v(e,t)}runRenderLoop(e){-1===this._activeRenderLoops.indexOf(e)&&(this._activeRenderLoops.push(e),1===this._activeRenderLoops.length&&0===this._frameHandler&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}getHostWindow(){return(0,p.BA)()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}_rebuildTextures(){for(const e of this.scenes)e._rebuildTextures();for(const e of this._virtualScenes)e._rebuildTextures()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);-1!==t&&this._renderTargetWrapperCache.splice(t,1)}get currentViewport(){return this._cachedViewport}setViewport(e,t,i){const s=t||this.getRenderWidth(),r=i||this.getRenderHeight(),n=e.x||0,a=e.y||0;this._cachedViewport=e,this._viewport(n*s,a*r,s*e.width,r*e.height)}createCanvasImage(){return document.createElement("img")}get description(){let e=this.name+this.version;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}_createTextureBase(e,t,i,n,a=3,o=null,l=null,h,c,u=null,d=null,p=null,f=null,m,v,x){const S="data:"===(e=e||"").substr(0,5),T="blob:"===e.substr(0,5),y=S&&-1!==e.indexOf(";base64,"),C=d||new _.h(this,1);C!==d&&(C.label=e.substring(0,60));const P=e;!this._transformTextureUrl||y||d||u||(e=this._transformTextureUrl(e)),P!==e&&(C._originalUrl=P);const E=e.lastIndexOf(".");let A=f||(E>-1?e.substring(E).toLowerCase():"");A.indexOf("?")>-1&&(A=A.split("?")[0]);const R=(0,g.gT)(A,m);n&&n.addPendingData(C),C.url=e,C.generateMipMaps=!t,C.samplingMode=a,C.invertY=i,C._useSRGBBuffer=this._getUseSRGBBuffer(!!x,t),this._doNotHandleContextLost||(C._buffer=u);let I=null;o&&!d&&(I=C.onLoadedObservable.add(o)),d||this._internalTexturesCache.push(C);const M=(i,d)=>{n&&n.removePendingData(C),e===P?(I&&C.onLoadedObservable.remove(I),s.q.UseFallbackTexture&&e!==s.q.FallbackTexture&&this._createTextureBase(s.q.FallbackTexture,t,C.invertY,n,a,null,l,h,c,u,C),i=(i||"Unknown error")+(s.q.UseFallbackTexture?" - Fallback texture was used":""),C.onErrorObservable.notifyObservers({message:i,exception:d}),l&&l(i,d)):(r.V.Warn(`Failed to load ${e}, falling back to ${P}`),this._createTextureBase(P,t,C.invertY,n,a,o,l,h,c,u,C,p,f,m,v,x))};if(R){const t=async e=>{(await R).loadData(e,C,((e,t,i,s,r,o)=>{o?M("TextureLoader failed to load data"):h(C,A,n,{width:e,height:t},C.invertY,!i,s,(()=>(r(),!1)),a)}),v)};u?u instanceof ArrayBuffer?t(new Uint8Array(u)):ArrayBuffer.isView(u)?t(u):l&&l("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,(e=>t(new Uint8Array(e))),void 0,n?n.offlineProvider:void 0,!0,((e,t)=>{M("Unable to load "+(e&&e.responseURL,t))}))}else{const i=e=>{T&&!this._doNotHandleContextLost&&(C._buffer=e),h(C,A,n,e,C.invertY,t,!1,c,a)};!S||y?u&&("string"==typeof u.decoding||u.close)?i(u):b._FileToolsLoadImage(e||"",i,M,n?n.offlineProvider:null,m,C.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):"string"==typeof u||u instanceof ArrayBuffer||ArrayBuffer.isView(u)||u instanceof Blob?b._FileToolsLoadImage(u,i,M,n?n.offlineProvider:null,m,C.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):u&&i(u)}return C}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuildAfterContextLost()}get _shouldUseHighPrecisionShader(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:(0,p.Nf)()?document:null}getLoadedTexturesCache(){return this._internalTexturesCache}clearInternalTexturesCache(){this._internalTexturesCache.length=0}getCaps(){return this._caps}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}get name(){return this._name}set name(e){this._name=e}static get NpmPackage(){return"babylonjs@7.28.0"}static get Version(){return"7.28.0"}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get isStencilEnable(){return this._isStencilEnable}getCreationOptions(){return this._creationOptions}constructor(e,t,i){this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new l,this._stencilStateComposer=new h,this._stencilState=new c,this._alphaState=new u,this._alphaMode=1,this._alphaEquation=0,this._activeRequests=[],this._badOS=!1,this._badDesktopOS=!1,this._compatibilityMode=!0,this._internalTexturesCache=new Array,this._currentRenderTarget=null,this._boundTexturesCache={},this._activeChannel=0,this._currentTextureChannel=-1,this._viewportCached={x:0,y:0,z:0,w:0},this._isWebGPU=!1,this.onCanvasBlurObservable=new f.cP,this.onCanvasFocusObservable=new f.cP,this.onNewSceneAddedObservable=new f.cP,this.onResizeObservable=new f.cP,this.onCanvasPointerOutObservable=new f.cP,this.disablePerformanceMonitorInBackground=!1,this.disableVertexArrayObjects=!1,this._frameId=0,this.hostInformation={isMobile:!1},this.isFullscreen=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.currentRenderPassId=0,this.isPointerLock=!1,this.postProcesses=[],this.canvasTabIndex=1,this._contextWasLost=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this._renderTargetWrapperCache=new Array,this._compiledEffects={},this._isDisposed=!1,this.scenes=[],this._virtualScenes=new Array,this.onBeforeTextureInitObservable=new f.cP,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this._frameHandler=0,this._activeRenderLoops=new Array,this._windowIsBackground=!1,this._boundRenderFunction=()=>this._renderLoop(),this.onBeforeShaderCompilationObservable=new f.cP,this.onAfterShaderCompilationObservable=new f.cP,this.onBeginFrameObservable=new f.cP,this.onEndFrameObservable=new f.cP,this._transformTextureUrl=null,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._highPrecisionShadersAllowed=!0,this.onContextLostObservable=new f.cP,this.onContextRestoredObservable=new f.cP,this._name="",this.premultipliedAlpha=!0,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._doNotHandleContextLost=!1,this.cullBackFaces=null,this._renderPassNames=["main"],this._fps=60,this._deltaTime=0,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this.onDisposeObservable=new f.cP,s.q.Instances.push(this),this.startTime=o.j.Now,this._stencilStateComposer.stencilGlobal=this._stencilState,a.I.SetMatrixPrecision(!!t.useHighPrecisionMatrix),(0,p.XD)()&&navigator.userAgent&&(this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),this.adaptToDeviceRatio=i??!1,t.antialias=e??t.antialias,t.deterministicLockstep=t.deterministicLockstep??!1,t.lockstepMaxSteps=t.lockstepMaxSteps??4,t.timeStep=t.timeStep??1/60,t.audioEngine=t.audioEngine??!0,t.stencil=t.stencil??!0,this._audioContext=t.audioEngineOptions?.audioContext??null,this._audioDestination=t.audioEngineOptions?.audioDestination??null,this.premultipliedAlpha=t.premultipliedAlpha??!0,this._doNotHandleContextLost=!!t.doNotHandleContextLost,this._isStencilEnable=!!t.stencil,this.useExactSrgbConversions=t.useExactSrgbConversions??!1;const r=(0,p.BA)()&&window.devicePixelRatio||1,n=t.limitDeviceRatio||r;i=i||t.adaptToDeviceRatio||!1,this._hardwareScalingLevel=i?1/Math.min(n,r):1,this._lastDevicePixelRatio=r,this._creationOptions=t}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const e=(0,p.BA)()&&window.devicePixelRatio||1,t=this._lastDevicePixelRatio/e;this._lastDevicePixelRatio=e,this._hardwareScalingLevel*=t}if((0,p.BA)()&&(0,p.Nf)())if(this._renderingCanvas){const e=this._renderingCanvas.getBoundingClientRect?this._renderingCanvas.getBoundingClientRect():{width:this._renderingCanvas.width*this._hardwareScalingLevel,height:this._renderingCanvas.height*this._hardwareScalingLevel};t=this._renderingCanvas.clientWidth||e.width||this._renderingCanvas.width||100,i=this._renderingCanvas.clientHeight||e.height||this._renderingCanvas.height||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){if(!this._renderingCanvas)return!1;if(e|=0,t|=0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)return!1;if(this._renderingCanvas.width=e,this._renderingCanvas.height=t,this.scenes){for(let e=0;e<this.scenes.length;e++){const t=this.scenes[e];for(let e=0;e<t.cameras.length;e++)t.cameras[e]._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}createRawTexture(e,t,i,s,r,n,a,o,l,h,c){throw(0,d.n)("engine.rawTexture")}createRawCubeTexture(e,t,i,s,r,n,a,o){throw(0,d.n)("engine.rawTexture")}createRawTexture3D(e,t,i,s,r,n,a,o,l,h,c){throw(0,d.n)("engine.rawTexture")}createRawTexture2DArray(e,t,i,s,r,n,a,o,l,h,c){throw(0,d.n)("engine.rawTexture")}_sharedInit(e){this._renderingCanvas=e}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=-1!==e.indexOf("Mobile")||-1!==e.indexOf("Mac")&&(0,p.Nf)()&&"ontouchend"in document},this._checkForMobile(),(0,p.BA)()&&window.addEventListener("resize",this._checkForMobile))}createVideoElement(e){return document.createElement("video")}_reportDrawCall(e=1){this._drawCalls?.addCount(e,!1)}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return 1e3*this._timeStep}_createImageBitmapFromSource(e,t){throw new Error("createImageBitmapFromSource is not implemented")}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){throw new Error("resizeImageBitmap is not implemented")}getFontOffset(e){throw new Error("getFontOffset is not implemented")}static _CreateCanvas(e,t){if("undefined"==typeof document)return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return b._CreateCanvas(e,t)}static _FileToolsLoadImage(e,t,i,s,r,n){throw(0,d.n)("FileTools")}_loadFile(e,t,i,s,r,n){const a=(0,m.W0)(e,t,i,s,r,n);return this._activeRequests.push(a),a.onCompleteObservable.add((()=>{const e=this._activeRequests.indexOf(a);-1!==e&&this._activeRequests.splice(e,1)})),a}static _FileToolsLoadFile(e,t,i,s,r,n){if(m.sg.loadFile)return m.sg.loadFile(e,t,i,s,r,n);throw(0,d.n)("FileTools")}dispose(){for(this.releaseEffects(),this._isDisposed=!0,this.stopRenderLoop(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._renderingCanvas=null,this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();this.releaseComputeEffects?.(),n.M.ResetCache();for(const e of this._activeRequests)e.abort();this._boundRenderFunction=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onNewSceneAddedObservable.clear(),(0,p.BA)()&&window.removeEventListener("resize",this._checkForMobile);const e=s.q.Instances.indexOf(this);e>=0&&s.q.Instances.splice(e,1),s.q.Instances.length||(s.q.OnEnginesDisposedObservable.notifyObservers(this),s.q.OnEnginesDisposedObservable.clear()),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}static DefaultLoadingScreenFactory(e){throw(0,d.n)("LoadingScreen")}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<s.q.Instances.length;i++){const r=s.q.Instances[i];for(let i=0;i<r.scenes.length;i++)r.scenes[i].markAllMaterialsAsDirty(e,t)}}}b._RenderPassIdCounter=0,b._RescalePostProcessFactory=null,b.CollisionsEpsilon=.001,b.QueueNewFrame=v},6125:(e,t,i)=>{"use strict";i.d(t,{Y:()=>s});class s{}s.AUTOSAMPLERSUFFIX="Sampler",s.DISABLEUA="#define DISABLE_UNIFORMITY_ANALYSIS",s.ALPHA_DISABLE=0,s.ALPHA_ADD=1,s.ALPHA_COMBINE=2,s.ALPHA_SUBTRACT=3,s.ALPHA_MULTIPLY=4,s.ALPHA_MAXIMIZED=5,s.ALPHA_ONEONE=6,s.ALPHA_PREMULTIPLIED=7,s.ALPHA_PREMULTIPLIED_PORTERDUFF=8,s.ALPHA_INTERPOLATE=9,s.ALPHA_SCREENMODE=10,s.ALPHA_ONEONE_ONEONE=11,s.ALPHA_ALPHATOCOLOR=12,s.ALPHA_REVERSEONEMINUS=13,s.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,s.ALPHA_ONEONE_ONEZERO=15,s.ALPHA_EXCLUSION=16,s.ALPHA_LAYER_ACCUMULATE=17,s.ALPHA_EQUATION_ADD=0,s.ALPHA_EQUATION_SUBSTRACT=1,s.ALPHA_EQUATION_REVERSE_SUBTRACT=2,s.ALPHA_EQUATION_MAX=3,s.ALPHA_EQUATION_MIN=4,s.ALPHA_EQUATION_DARKEN=5,s.DELAYLOADSTATE_NONE=0,s.DELAYLOADSTATE_LOADED=1,s.DELAYLOADSTATE_LOADING=2,s.DELAYLOADSTATE_NOTLOADED=4,s.NEVER=512,s.ALWAYS=519,s.LESS=513,s.EQUAL=514,s.LEQUAL=515,s.GREATER=516,s.GEQUAL=518,s.NOTEQUAL=517,s.KEEP=7680,s.ZERO=0,s.REPLACE=7681,s.INCR=7682,s.DECR=7683,s.INVERT=5386,s.INCR_WRAP=34055,s.DECR_WRAP=34056,s.TEXTURE_CLAMP_ADDRESSMODE=0,s.TEXTURE_WRAP_ADDRESSMODE=1,s.TEXTURE_MIRROR_ADDRESSMODE=2,s.TEXTURE_CREATIONFLAG_STORAGE=1,s.TEXTUREFORMAT_ALPHA=0,s.TEXTUREFORMAT_LUMINANCE=1,s.TEXTUREFORMAT_LUMINANCE_ALPHA=2,s.TEXTUREFORMAT_RGB=4,s.TEXTUREFORMAT_RGBA=5,s.TEXTUREFORMAT_RED=6,s.TEXTUREFORMAT_R=6,s.TEXTUREFORMAT_RG=7,s.TEXTUREFORMAT_RED_INTEGER=8,s.TEXTUREFORMAT_R_INTEGER=8,s.TEXTUREFORMAT_RG_INTEGER=9,s.TEXTUREFORMAT_RGB_INTEGER=10,s.TEXTUREFORMAT_RGBA_INTEGER=11,s.TEXTUREFORMAT_BGRA=12,s.TEXTUREFORMAT_DEPTH24_STENCIL8=13,s.TEXTUREFORMAT_DEPTH32_FLOAT=14,s.TEXTUREFORMAT_DEPTH16=15,s.TEXTUREFORMAT_DEPTH24=16,s.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,s.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,s.TEXTUREFORMAT_STENCIL8=19,s.TEXTUREFORMAT_UNDEFINED=4294967295,s.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,s.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,s.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,s.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,s.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,s.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,s.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,s.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,s.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,s.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,s.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,s.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,s.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,s.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,s.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,s.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,s.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,s.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,s.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,s.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,s.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,s.TEXTURETYPE_UNSIGNED_BYTE=0,s.TEXTURETYPE_UNSIGNED_INT=0,s.TEXTURETYPE_FLOAT=1,s.TEXTURETYPE_HALF_FLOAT=2,s.TEXTURETYPE_BYTE=3,s.TEXTURETYPE_SHORT=4,s.TEXTURETYPE_UNSIGNED_SHORT=5,s.TEXTURETYPE_INT=6,s.TEXTURETYPE_UNSIGNED_INTEGER=7,s.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,s.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,s.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,s.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,s.TEXTURETYPE_UNSIGNED_INT_24_8=12,s.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,s.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,s.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,s.TEXTURETYPE_UNDEFINED=16,s.TEXTURE_2D=3553,s.TEXTURE_2D_ARRAY=35866,s.TEXTURE_CUBE_MAP=34067,s.TEXTURE_CUBE_MAP_ARRAY=3735928559,s.TEXTURE_3D=32879,s.TEXTURE_NEAREST_SAMPLINGMODE=1,s.TEXTURE_NEAREST_NEAREST=1,s.TEXTURE_BILINEAR_SAMPLINGMODE=2,s.TEXTURE_LINEAR_LINEAR=2,s.TEXTURE_TRILINEAR_SAMPLINGMODE=3,s.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,s.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,s.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,s.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,s.TEXTURE_NEAREST_LINEAR=7,s.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,s.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,s.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,s.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,s.TEXTURE_LINEAR_NEAREST=12,s.TEXTURE_EXPLICIT_MODE=0,s.TEXTURE_SPHERICAL_MODE=1,s.TEXTURE_PLANAR_MODE=2,s.TEXTURE_CUBIC_MODE=3,s.TEXTURE_PROJECTION_MODE=4,s.TEXTURE_SKYBOX_MODE=5,s.TEXTURE_INVCUBIC_MODE=6,s.TEXTURE_EQUIRECTANGULAR_MODE=7,s.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,s.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,s.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,s.TEXTURE_FILTERING_QUALITY_HIGH=64,s.TEXTURE_FILTERING_QUALITY_MEDIUM=16,s.TEXTURE_FILTERING_QUALITY_LOW=8,s.SCALEMODE_FLOOR=1,s.SCALEMODE_NEAREST=2,s.SCALEMODE_CEILING=3,s.MATERIAL_TextureDirtyFlag=1,s.MATERIAL_LightDirtyFlag=2,s.MATERIAL_FresnelDirtyFlag=4,s.MATERIAL_AttributesDirtyFlag=8,s.MATERIAL_MiscDirtyFlag=16,s.MATERIAL_PrePassDirtyFlag=32,s.MATERIAL_AllDirtyFlag=63,s.MATERIAL_TriangleFillMode=0,s.MATERIAL_WireFrameFillMode=1,s.MATERIAL_PointFillMode=2,s.MATERIAL_PointListDrawMode=3,s.MATERIAL_LineListDrawMode=4,s.MATERIAL_LineLoopDrawMode=5,s.MATERIAL_LineStripDrawMode=6,s.MATERIAL_TriangleStripDrawMode=7,s.MATERIAL_TriangleFanDrawMode=8,s.MATERIAL_ClockWiseSideOrientation=0,s.MATERIAL_CounterClockWiseSideOrientation=1,s.ACTION_NothingTrigger=0,s.ACTION_OnPickTrigger=1,s.ACTION_OnLeftPickTrigger=2,s.ACTION_OnRightPickTrigger=3,s.ACTION_OnCenterPickTrigger=4,s.ACTION_OnPickDownTrigger=5,s.ACTION_OnDoublePickTrigger=6,s.ACTION_OnPickUpTrigger=7,s.ACTION_OnPickOutTrigger=16,s.ACTION_OnLongPressTrigger=8,s.ACTION_OnPointerOverTrigger=9,s.ACTION_OnPointerOutTrigger=10,s.ACTION_OnEveryFrameTrigger=11,s.ACTION_OnIntersectionEnterTrigger=12,s.ACTION_OnIntersectionExitTrigger=13,s.ACTION_OnKeyDownTrigger=14,s.ACTION_OnKeyUpTrigger=15,s.PARTICLES_BILLBOARDMODE_Y=2,s.PARTICLES_BILLBOARDMODE_ALL=7,s.PARTICLES_BILLBOARDMODE_STRETCHED=8,s.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,s.MESHES_CULLINGSTRATEGY_STANDARD=0,s.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,s.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,s.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,s.SCENELOADER_NO_LOGGING=0,s.SCENELOADER_MINIMAL_LOGGING=1,s.SCENELOADER_SUMMARY_LOGGING=2,s.SCENELOADER_DETAILED_LOGGING=3,s.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,s.PREPASS_POSITION_TEXTURE_TYPE=1,s.PREPASS_VELOCITY_TEXTURE_TYPE=2,s.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,s.PREPASS_COLOR_TEXTURE_TYPE=4,s.PREPASS_DEPTH_TEXTURE_TYPE=5,s.PREPASS_NORMAL_TEXTURE_TYPE=6,s.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,s.PREPASS_WORLD_NORMAL_TEXTURE_TYPE=8,s.PREPASS_LOCAL_POSITION_TEXTURE_TYPE=9,s.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE=10,s.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE=11,s.BUFFER_CREATIONFLAG_READ=1,s.BUFFER_CREATIONFLAG_WRITE=2,s.BUFFER_CREATIONFLAG_READWRITE=3,s.BUFFER_CREATIONFLAG_UNIFORM=4,s.BUFFER_CREATIONFLAG_VERTEX=8,s.BUFFER_CREATIONFLAG_INDEX=16,s.BUFFER_CREATIONFLAG_STORAGE=32,s.BUFFER_CREATIONFLAG_INDIRECT=64,s.RENDERPASS_MAIN=0,s.INPUT_ALT_KEY=18,s.INPUT_CTRL_KEY=17,s.INPUT_META_KEY1=91,s.INPUT_META_KEY2=92,s.INPUT_META_KEY3=93,s.INPUT_SHIFT_KEY=16,s.SNAPSHOTRENDERING_STANDARD=0,s.SNAPSHOTRENDERING_FAST=1,s.PERSPECTIVE_CAMERA=0,s.ORTHOGRAPHIC_CAMERA=1,s.FOVMODE_VERTICAL_FIXED=0,s.FOVMODE_HORIZONTAL_FIXED=1,s.RIG_MODE_NONE=0,s.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,s.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,s.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,s.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,s.RIG_MODE_STEREOSCOPIC_INTERLACED=14,s.RIG_MODE_VR=20,s.RIG_MODE_CUSTOM=22,s.MAX_SUPPORTED_UV_SETS=6,s.GL_ALPHA_EQUATION_ADD=32774,s.GL_ALPHA_EQUATION_MIN=32775,s.GL_ALPHA_EQUATION_MAX=32776,s.GL_ALPHA_EQUATION_SUBTRACT=32778,s.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,s.GL_ALPHA_FUNCTION_SRC=768,s.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,s.GL_ALPHA_FUNCTION_SRC_ALPHA=770,s.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,s.GL_ALPHA_FUNCTION_DST_ALPHA=772,s.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,s.GL_ALPHA_FUNCTION_DST_COLOR=774,s.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,s.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,s.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,s.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,s.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,s.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,s.SnippetUrl="https://snippet.babylonjs.com",s.FOGMODE_NONE=0,s.FOGMODE_EXP=1,s.FOGMODE_EXP2=2,s.FOGMODE_LINEAR=3,s.BYTE=5120,s.UNSIGNED_BYTE=5121,s.SHORT=5122,s.UNSIGNED_SHORT=5123,s.INT=5124,s.UNSIGNED_INT=5125,s.FLOAT=5126,s.PositionKind="position",s.NormalKind="normal",s.TangentKind="tangent",s.UVKind="uv",s.UV2Kind="uv2",s.UV3Kind="uv3",s.UV4Kind="uv4",s.UV5Kind="uv5",s.UV6Kind="uv6",s.ColorKind="color",s.ColorInstanceKind="instanceColor",s.MatricesIndicesKind="matricesIndices",s.MatricesWeightsKind="matricesWeights",s.MatricesIndicesExtraKind="matricesIndicesExtra",s.MatricesWeightsExtraKind="matricesWeightsExtra"},6315:(e,t,i)=>{"use strict";i.d(t,{q:()=>r});var s=i(9848);class r{static get LastCreatedEngine(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}r.Instances=[],r.OnEnginesDisposedObservable=new s.cP,r._LastCreatedScene=null,r.UseFallbackTexture=!0,r.FallbackTexture=""},215:(e,t,i)=>{"use strict";i.d(t,{I:()=>s});class s{static SetMatrixPrecision(e){if(s.MatrixTrackPrecisionChange=!1,e&&!s.MatrixUse64Bits&&s.MatrixTrackedMatrices)for(let e=0;e<s.MatrixTrackedMatrices.length;++e){const t=s.MatrixTrackedMatrices[e],i=t._m;t._m=new Array(16);for(let e=0;e<16;++e)t._m[e]=i[e]}s.MatrixUse64Bits=e,s.MatrixCurrentType=s.MatrixUse64Bits?Array:Float32Array,s.MatrixTrackedMatrices=null}}s.MatrixUse64Bits=!1,s.MatrixTrackPrecisionChange=!0,s.MatrixCurrentType=Float32Array,s.MatrixTrackedMatrices=[]},9610:(e,t,i)=>{"use strict";i.d(t,{l:()=>s});class s{static GetShadersRepository(e=0){return 0===e?s.ShadersRepository:s.ShadersRepositoryWGSL}static GetShadersStore(e=0){return 0===e?s.ShadersStore:s.ShadersStoreWGSL}static GetIncludesShadersStore(e=0){return 0===e?s.IncludesShadersStore:s.IncludesShadersStoreWGSL}}s.ShadersRepository="src/Shaders/",s.ShadersStore={},s.IncludesShadersStore={},s.ShadersRepositoryWGSL="src/ShadersWGSL/",s.ShadersStoreWGSL={},s.IncludesShadersStoreWGSL={}},5852:(e,t,i)=>{"use strict";i.d(t,{tI:()=>d,bS:()=>v,tg:()=>_,YM:()=>p,C5:()=>g,GX:()=>u,kf:()=>h,EX:()=>c,Cm:()=>l,N5:()=>o});class s{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}setEngine(e){this.engine=e}_fillEffectInformation(e,t,i,s,r,n,a,o){const l=this.engine;if(l.supportsUniformBuffers)for(const i in t)e.bindUniformBlock(i,t[i]);let h;for(this.engine.getUniforms(this,i).forEach(((e,t)=>{s[i[t]]=e})),this._uniforms=s,h=0;h<r.length;h++)null==e.getUniform(r[h])&&(r.splice(h,1),h--);r.forEach(((e,t)=>{n[e]=t}));for(const e of l.getAttributes(this,a))o.push(e)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_cacheFloat2(e,t,i){let s=this._valueCache[e];if(!s||2!==s.length)return s=[t,i],this._valueCache[e]=s,!0;let r=!1;return s[0]!==t&&(s[0]=t,r=!0),s[1]!==i&&(s[1]=i,r=!0),r}_cacheFloat3(e,t,i,s){let r=this._valueCache[e];if(!r||3!==r.length)return r=[t,i,s],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),r[2]!==s&&(r[2]=s,n=!0),n}_cacheFloat4(e,t,i,s,r){let n=this._valueCache[e];if(!n||4!==n.length)return n=[t,i,s,r],this._valueCache[e]=n,!0;let a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==i&&(n[1]=i,a=!0),n[2]!==s&&(n[2]=s,a=!0),n[3]!==r&&(n[3]=r,a=!0),a}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setUInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setUInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setUInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setFloat3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setFloat4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}var r=i(6741);const n=new WeakMap,a={_webGLVersion:2,cachedPipelines:{}};function o(e){let t=n.get(e);if(!t){if(!e)return a;t={_webGLVersion:e.TEXTURE_BINDING_3D?2:1,_context:e,cachedPipelines:{}},n.set(e,t)}return t}function l(e){n.delete(e)}function h(e,t,i,s,r,n){const a=o(s);return n||(n=a._createShaderProgramInjection??d),n(e,m(t,"vertex",s,a._contextWasLost),m(i,"fragment",s,a._contextWasLost),s,r,a.validateShaderPrograms)}function c(e,t,i,s,r,n=null,a){const l=o(r);a||(a=l._createShaderProgramInjection??d);const h=l._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"";return a(e,f(t,"vertex",s,h,r,l._contextWasLost),f(i,"fragment",s,h,r,l._contextWasLost),r,n,l.validateShaderPrograms)}function u(e,t){const i=new s,r=o(e);return r.parallelShaderCompile&&(i.isParallelCompiled=!0),i.context=r._context,i}function d(e,t,i,s,r=null,n){const a=s.createProgram();if(e.program=a,!a)throw new Error("Unable to create program");return s.attachShader(a,t),s.attachShader(a,i),s.linkProgram(a),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||_(e,s,n),a}function _(e,t,i){const s=e.context,r=e.vertexShader,n=e.fragmentShader,a=e.program;if(!s.getProgramParameter(a,s.LINK_STATUS)){if(!t.getShaderParameter(r,t.COMPILE_STATUS)){const i=t.getShaderInfoLog(r);if(i)throw e.vertexCompilationError=i,new Error("VERTEX SHADER "+i)}if(!t.getShaderParameter(n,t.COMPILE_STATUS)){const i=t.getShaderInfoLog(n);if(i)throw e.fragmentCompilationError=i,new Error("FRAGMENT SHADER "+i)}const i=s.getProgramInfoLog(a);if(i)throw e.programLinkError=i,new Error(i)}if(i&&(s.validateProgram(a),!s.getProgramParameter(a,s.VALIDATE_STATUS))){const t=s.getProgramInfoLog(a);if(t)throw e.programValidationError=t,new Error(t)}s.deleteShader(r),s.deleteShader(n),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}function p(e,t,i,s,r,n,a,l,u,d="",_,p,f){const m=o(e.context);p||(p=m.createRawShaderProgramInjection??h),f||(f=m.createShaderProgramInjection??c);const g=e;g.program=s?p(g,t,i,g.context,u):f(g,t,i,l,g.context,u),g.program.__SPECTOR_rebuildProgram=a,_()}function f(e,t,i,s,n,a){return m((0,r.iL)(e,i,s),t,n,a)}function m(e,t,i,s){const r=i.createShader("vertex"===t?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!r){let e=i.NO_ERROR,r=i.NO_ERROR;for(;(r=i.getError())!==i.NO_ERROR;)e=r;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${e}, gl isContextLost=${i.isContextLost()}, _contextWasLost=${s}`)}return i.shaderSource(r,e),i.compileShader(r),r}function g(e,t){t.useProgram(e)}function v(e,t){const i=e;if(!i.isParallelCompiled)return void t(e);const s=i.onCompiled;i.onCompiled=()=>{s?.(),t(e)}}},6321:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ThinEngine:()=>v});var s=i(5852),r=i(1137),n=i(8790);class a{constructor(){this.shaderLanguage=0}postProcessor(e,t,i,s,r){if(r.drawBuffersExtensionDisabled){const t=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(t,"")}return e}}const o=/(flat\s)?\s*varying\s*.*/;class l{constructor(){this.shaderLanguage=0}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return o.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const s=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const t=-1!==e.search(/layout *\(location *= *0\) *out/g);e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(s||t?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e}}var h=i(4329),c=i(1597),u=i(6326),d=i(7716),_=i(854),p=i(4420),f=i(6741),m=i(7647);class g{}class v extends u.${get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return p.M.ShadersRepository}static set ShadersRepository(e){p.M.ShadersRepository=e}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(e,t,i,n){if(i=i||{},super(t??i.antialias,i,n),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!e)return;let o=null;if(e.getContext){if(o=e,this._renderingCanvas=o,void 0===i.preserveDrawingBuffer&&(i.preserveDrawingBuffer=!1),void 0===i.xrCompatible&&(i.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();const e=navigator.userAgent;for(const t of v.ExceptionList){const s=t.key,r=t.targets;if(new RegExp(s).test(e)){if(t.capture&&t.captureConstraint){const i=t.capture,s=t.captureConstraint,r=new RegExp(i).exec(e);if(r&&r.length>0&&parseInt(r[r.length-1])>=s)continue}for(const e of r)switch(e){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost||(this._onContextLost=e=>{e.preventDefault(),this._contextWasLost=!0,r.V.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},o.addEventListener("webglcontextlost",this._onContextLost,!1),o.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=o.getContext("webgl2",i)||o.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(e){}if(!this._gl){if(!o)throw new Error("The provided canvas is null or undefined.");try{this._gl=o.getContext("webgl",i)||o.getContext("experimental-webgl",i)}catch(e){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const t=this._gl.getContextAttributes();t&&(i.stencil=t.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==i.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let e=0;e<this._caps.maxVertexAttribs;e++)this._currentBufferPointers[e]=new g;this._shaderProcessor=this.webGLVersion>1?new l:new a;const h=`Babylon.js v${v.Version}`;r.V.Log(h+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",h);const c=(0,s.N5)(this._gl);c.validateShaderPrograms=this.validateShaderPrograms,c.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const e=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=e&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{const e=this._gl.getExtension("WEBGL_draw_buffers");if(null!==e){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=e.drawBuffersWEBGL.bind(e),this._caps.maxDrawBuffers=this._gl.getParameter(e.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let t=0;t<16;t++)this._gl["COLOR_ATTACHMENT"+t+"_WEBGL"]=e["COLOR_ATTACHMENT"+t+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const e=this._gl.getExtension("WEBGL_depth_texture");null!=e&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=e.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const e=this._gl.getExtension("OES_vertex_array_object");null!=e&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=e.createVertexArrayOES.bind(e),this._gl.bindVertexArray=e.bindVertexArrayOES.bind(e),this._gl.deleteVertexArray=e.deleteVertexArrayOES.bind(e))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const e=this._gl.getExtension("ANGLE_instanced_arrays");null!=e?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),this._gl.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),this._gl.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const e=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),t=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);e&&t&&(this._caps.highPrecisionShaderSupported=0!==e.precision&&0!==t.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const e=this._gl.getExtension("EXT_blend_minmax");null!=e&&(this._caps.blendMinMax=!0,this._gl.MAX=e.MAX_EXT,this._gl.MIN=e.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const e=this._gl.getExtension("EXT_sRGB");null!=e&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:e.SRGB_EXT,SRGB8:e.SRGB_ALPHA_EXT,SRGB8_ALPHA8:e.SRGB_ALPHA_EXT})}if(this._creationOptions){const e=this._creationOptions.forceSRGBBufferSupportState;void 0!==e&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&e)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let e=0;e<this._maxSimultaneousTextures;e++)this._nextFreeTextureSlots.push(e);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:"undefined"==typeof HTMLImageElement,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportIBLShadows:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){const e=this.getGlInfo();return e&&e.renderer?e.renderer:""}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,i,s=!1){const r=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=r;let n=0;if(t&&e){let t=!0;if(this._currentRenderTarget){const i=this._currentRenderTarget.texture?.format;if(8===i||9===i||10===i||11===i){const i=this._currentRenderTarget.texture?.type;7===i||5===i?(v._TempClearColorUint32[0]=255*e.r,v._TempClearColorUint32[1]=255*e.g,v._TempClearColorUint32[2]=255*e.b,v._TempClearColorUint32[3]=255*e.a,this._gl.clearBufferuiv(this._gl.COLOR,0,v._TempClearColorUint32),t=!1):(v._TempClearColorInt32[0]=255*e.r,v._TempClearColorInt32[1]=255*e.g,v._TempClearColorInt32[2]=255*e.b,v._TempClearColorInt32[3]=255*e.a,this._gl.clearBufferiv(this._gl.COLOR,0,v._TempClearColorInt32),t=!1)}}t&&(this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),n|=this._gl.COLOR_BUFFER_BIT)}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),s&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)}_viewport(e,t,i,s){e===this._viewportCached.x&&t===this._viewportCached.y&&i===this._viewportCached.z&&s===this._viewportCached.w||(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=s,this._gl.viewport(e,t,i,s))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(e,t=0,i,s,n,a=0,o=0){const l=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(l._framebuffer);const h=this._gl;e.isMulti||(e.is2DArray||e.is3D?(h.framebufferTextureLayer(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,e.texture._hardwareTexture?.underlyingResource,a,o),l._currentLOD=a):e.isCube?h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_CUBE_MAP_POSITIVE_X+t,e.texture._hardwareTexture?.underlyingResource,a):l._currentLOD!==a&&(h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,e.texture._hardwareTexture?.underlyingResource,a),l._currentLOD=a));const c=e._depthStencilTexture;if(c){e.is3D&&(e.texture.width===c.width&&e.texture.height===c.height&&e.texture.depth===c.depth||r.V.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment"));const i=e._depthStencilTextureWithStencil?h.DEPTH_STENCIL_ATTACHMENT:h.DEPTH_ATTACHMENT;e.is2DArray||e.is3D?h.framebufferTextureLayer(h.FRAMEBUFFER,i,c._hardwareTexture?.underlyingResource,a,o):e.isCube?h.framebufferTexture2D(h.FRAMEBUFFER,i,h.TEXTURE_CUBE_MAP_POSITIVE_X+t,c._hardwareTexture?.underlyingResource,a):h.framebufferTexture2D(h.FRAMEBUFFER,i,h.TEXTURE_2D,c._hardwareTexture?.underlyingResource,a)}l._MSAAFramebuffer&&this._bindUnboundFramebuffer(l._MSAAFramebuffer),this._cachedViewport&&!n?this.setViewport(this._cachedViewport,i,s):(i||(i=e.width,a&&(i/=Math.pow(2,a))),s||(s=e.height,a&&(s/=Math.pow(2,a))),this._viewport(0,0,i,s)),this.wipeCaches()}setState(e,t=0,i,s=!1,r,n,a=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const o=this.cullBackFaces??r??1?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==o||i)&&(this._depthCullingState.cullFace=o),this.setZOffset(t),this.setZOffsetUnits(a);const l=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==l||i)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=n}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(e){const t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,!0),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null)}unBindFramebuffer(e,t=!1,i){const s=e;this._currentRenderTarget=null;const r=this._gl;if(s._MSAAFramebuffer){if(e.isMulti)return void this.unBindMultiColorAttachmentFramebuffer(e,t,i);r.bindFramebuffer(r.READ_FRAMEBUFFER,s._MSAAFramebuffer),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,s._framebuffer),r.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,r.COLOR_BUFFER_BIT,r.NEAREST)}!e.texture?.generateMipMaps||t||e.isCube||this.generateMipmaps(e.texture),i&&(s._MSAAFramebuffer&&this._bindUnboundFramebuffer(s._framebuffer),i()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,i){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const s=new h.A(i);return this.bindArrayBuffer(s),"number"!=typeof e?e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),s.capacity=4*e.length):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),s.capacity=e.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),s.capacity=e),this._resetVertexBufferBinding(),s.references=1,s}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,i){const s=this._gl.createBuffer(),r=new h.A(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);const n=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,n,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=4===n.BYTES_PER_ELEMENT,r}_normalizeIndexData(e){if(2===e.BYTES_PER_ELEMENT)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let t=0;t<e.length;t++)if(e[t]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const s=e.program,r=this._gl.getUniformBlockIndex(s,t);this._gl.uniformBlockBinding(s,r,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,s,r,n,a){const o=this._currentBufferPointers[t];if(!o)return;let l=!1;o.active?(o.buffer!==e&&(o.buffer=e,l=!0),o.size!==i&&(o.size=i,l=!0),o.type!==s&&(o.type=s,l=!0),o.normalized!==r&&(o.normalized=r,l=!0),o.stride!==n&&(o.stride=n,l=!0),o.offset!==a&&(o.offset=a,l=!0)):(l=!0,o.active=!0,o.index=t,o.size=i,o.type=s,o.normalized=r,o.stride=n,o.offset=a,o.buffer=e),(l||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),s===this._gl.UNSIGNED_INT||s===this._gl.INT?this._gl.vertexAttribIPointer(t,i,s,n,a):this._gl.vertexAttribPointer(t,i,s,r,n,a))}_bindIndexBufferWithCache(e){null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const s=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let r=0;r<s.length;r++){const n=t.getAttributeLocation(r);if(n>=0){const t=s[r];let a=null;if(i&&(a=i[t]),a||(a=e[t]),!a)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);const o=a.getBuffer();o&&(this._vertexAttribPointer(o,n,a.getSize(),a.type,a.normalized,a.byteStride,a.byteOffset),a.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,a.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(o))))}}}recordVertexArrayObject(e,t,i,s){const r=this._gl.createVertexArray();if(!r)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,s),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),r}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=t&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,s,r){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r;const t=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let n=0;for(let a=0;a<t;a++)if(a<i.length){const t=r.getAttributeLocation(a);t>=0&&(this._gl.enableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!0,this._vertexAttribPointer(e,t,i[a],this._gl.FLOAT,!1,s,n)),n+=4*i[a]}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,s){this._cachedVertexBuffers===e&&this._cachedEffectForVertexBuffers===i||(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,s)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const i=this._currentInstanceBuffers[t];e!=i&&i.references&&(e=i,this.bindArrayBuffer(i));const s=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(s,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,0===e.references&&(this._deleteBuffer(e),!0)}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==i[0].index)this.bindInstancesBuffer(e,i,!0);else for(let t=0;t<4;t++){const s=i[t];this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0),this._vertexAttribPointer(e,s,4,this._gl.FLOAT,!1,64,16*t),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let s=0;if(i)for(let e=0;e<t.length;e++)s+=4*t[e].attributeSize;for(let i=0;i<t.length;i++){const r=t[i];void 0===r.index&&(r.index=this._currentEffect.getAttributeLocationByName(r.attributeName)),r.index<0||(this._vertexAttribArraysEnabled[r.index]||(this._gl.enableVertexAttribArray(r.index),this._vertexAttribArraysEnabled[r.index]=!0),this._vertexAttribPointer(e,r.index,r.attributeSize,r.attributeType||this._gl.FLOAT,r.normalized||!1,s,r.offset),this._gl.vertexAttribDivisor(r.index,void 0===r.divisor?1:r.divisor),this._currentInstanceLocations.push(r.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t,i=!1;for(;-1!==(t=this._currentInstanceLocations.indexOf(e));)this._currentInstanceLocations.splice(t,1),this._currentInstanceBuffers.splice(t,1),i=!0,t=this._currentInstanceLocations.indexOf(e);i&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,s){this.drawElementsType(e?0:1,t,i,s)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,s){this.drawArraysType(e?0:1,t,i,s)}drawElementsType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,a=this._uintIndicesCurrentlySet?4:2;s?this._gl.drawElementsInstanced(r,i,n,t*a,s):this._gl.drawElements(r,i,n,t*a)}drawArraysType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e);s?this._gl.drawArraysInstanced(r,t,i,s):this._gl.drawArrays(r,t,i)}_drawMode(e){switch(e){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,(0,m.mO)(t),this._gl.deleteProgram(t.program))}_getGlobalDefines(e){return(0,f.xt)(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,i,r,n,a,o,l,h,c=0,u){const d="string"==typeof e?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,_="string"==typeof e?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,f=this._getGlobalDefines();let m=n??t.defines??"";f&&(m+=f);const g=d+"+"+_+"@"+m;if(this._compiledEffects[g]){const e=this._compiledEffects[g];return o&&e.isReady()&&o(e),e._refCount++,e}this._gl&&(0,s.N5)(this._gl);const v=new p.M(e,t,i,r,this,n,a,o,l,h,g,t.shaderLanguage??c,t.extraInitializationsAsync??u);return this._compiledEffects[g]=v,v}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,r,n=null){const a=(0,s.N5)(this._gl);return a._contextWasLost=this._contextWasLost,a.validateShaderPrograms=this.validateShaderPrograms,(0,s.kf)(e,t,i,r||this._gl,n)}createShaderProgram(e,t,i,r,n,a=null){const o=(0,s.N5)(this._gl);return o._contextWasLost=this._contextWasLost,o.validateShaderPrograms=this.validateShaderPrograms,(0,s.EX)(e,t,i,r,n||this._gl,a)}inlineShaderCode(e){return e}createPipelineContext(e){this._gl&&((0,s.N5)(this._gl).parallelShaderCompile=this._caps.parallelShaderCompile);const t=(0,s.GX)(this._gl,e);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return(0,s.tg)(e,this._gl,this.validateShaderPrograms)}_preparePipelineContext(e,t,i,r,n,a,o,l,h,c,u){const d=(0,s.N5)(this._gl);return d._contextWasLost=this._contextWasLost,d.validateShaderPrograms=this.validateShaderPrograms,d._createShaderProgramInjection=this._createShaderProgram.bind(this),d.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),d.createShaderProgramInjection=this.createShaderProgram.bind(this),d.loadFileInjection=this._loadFile.bind(this),(0,s.YM)(e,t,i,r,n,a,o,l,h,c,u)}_createShaderProgram(e,t,i,r,n=null){return(0,s.tI)(e,t,i,r,n)}_isRenderingStateCompiled(e){const t=e;return!(this._isDisposed||t._isDisposed||!this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)||(this._finalizePipelineContext(t),0))}_executeWhenRenderingStateIsCompiled(e,t){(0,s.bS)(e,t)}getUniforms(e,t){const i=new Array,s=e;for(let e=0;e<t.length;e++)i.push(this._gl.getUniformLocation(s.program,t[e]));return i}getAttributes(e,t){const i=[],s=e;for(let e=0;e<t.length;e++)try{i.push(this._gl.getAttribLocation(s.program,t[e]))}catch(e){i.push(-1)}return i}enableEffect(e){(e=null!==e&&function(e){return void 0===e.getPipelineContext}(e)?e.effect:e)&&e!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return!!e&&(this._gl.uniform1i(e,t),!0)}setInt2(e,t,i){return!!e&&(this._gl.uniform2i(e,t,i),!0)}setInt3(e,t,i,s){return!!e&&(this._gl.uniform3i(e,t,i,s),!0)}setInt4(e,t,i,s,r){return!!e&&(this._gl.uniform4i(e,t,i,s,r),!0)}setIntArray(e,t){return!!e&&(this._gl.uniform1iv(e,t),!0)}setIntArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2iv(e,t),0))}setIntArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3iv(e,t),0))}setIntArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4iv(e,t),0))}setUInt(e,t){return!!e&&(this._gl.uniform1ui(e,t),!0)}setUInt2(e,t,i){return!!e&&(this._gl.uniform2ui(e,t,i),!0)}setUInt3(e,t,i,s){return!!e&&(this._gl.uniform3ui(e,t,i,s),!0)}setUInt4(e,t,i,s,r){return!!e&&(this._gl.uniform4ui(e,t,i,s,r),!0)}setUIntArray(e,t){return!!e&&(this._gl.uniform1uiv(e,t),!0)}setUIntArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2uiv(e,t),0))}setUIntArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3uiv(e,t),0))}setUIntArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4uiv(e,t),0))}setArray(e,t){return!(!e||t.length<1||(this._gl.uniform1fv(e,t),0))}setArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2fv(e,t),0))}setArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3fv(e,t),0))}setArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4fv(e,t),0))}setMatrices(e,t){return!!e&&(this._gl.uniformMatrix4fv(e,!1,t),!0)}setMatrix3x3(e,t){return!!e&&(this._gl.uniformMatrix3fv(e,!1,t),!0)}setMatrix2x2(e,t){return!!e&&(this._gl.uniformMatrix2fv(e,!1,t),!0)}setFloat(e,t){return!!e&&(this._gl.uniform1f(e,t),!0)}setFloat2(e,t,i){return!!e&&(this._gl.uniform2f(e,t,i),!0)}setFloat3(e,t,i,s){return!!e&&(this._gl.uniform3f(e,t,i,s),!0)}setFloat4(e,t,i,s,r){return!!e&&(this._gl.uniform4f(e,t,i,s,r),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let s=i.NEAREST,r=i.NEAREST;switch(e){case 11:s=i.LINEAR,r=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 3:s=i.LINEAR,r=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 8:s=i.NEAREST,r=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 4:s=i.NEAREST,r=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 5:s=i.NEAREST,r=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 6:s=i.NEAREST,r=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 7:s=i.NEAREST,r=i.LINEAR;break;case 1:s=i.NEAREST,r=i.NEAREST;break;case 9:s=i.LINEAR,r=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 10:s=i.LINEAR,r=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 2:s=i.LINEAR,r=i.LINEAR;break;case 12:s=i.LINEAR,r=i.NEAREST}return{min:r,mag:s}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new d.d(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,s=0){let n,a=!1,o=0,l=3,h=5,c=!1,u=1;void 0!==t&&"object"==typeof t?(a=!!t.generateMipMaps,o=void 0===t.type?0:t.type,l=void 0===t.samplingMode?3:t.samplingMode,h=void 0===t.format?5:t.format,c=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,u=t.samples??1,n=t.label):a=!!t,c&&(c=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==o||this._caps.textureFloatLinearFiltering)&&(2!==o||this._caps.textureHalfFloatLinearFiltering)||(l=1),1!==o||this._caps.textureFloat||(o=0,r.V.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const d=this._gl,p=new _.h(this,s),f=e.width||e,m=e.height||e,g=e.depth||0,v=e.layers||0,b=this._getSamplingParameters(l,a),x=0!==v?d.TEXTURE_2D_ARRAY:0!==g?d.TEXTURE_3D:d.TEXTURE_2D,S=this._getRGBABufferInternalSizedFormat(o,h,c),T=this._getInternalFormat(h),y=this._getWebGLTextureType(o);return this._bindTextureDirectly(x,p),0!==v?(p.is2DArray=!0,d.texImage3D(x,0,S,f,m,v,0,T,y,null)):0!==g?(p.is3D=!0,d.texImage3D(x,0,S,f,m,g,0,T,y,null)):d.texImage2D(x,0,S,f,m,0,T,y,null),d.texParameteri(x,d.TEXTURE_MAG_FILTER,b.mag),d.texParameteri(x,d.TEXTURE_MIN_FILTER,b.min),d.texParameteri(x,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(x,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),a&&this._gl.generateMipmap(x),this._bindTextureDirectly(x,null),p._useSRGBBuffer=c,p.baseWidth=f,p.baseHeight=m,p.width=f,p.height=m,p.depth=v,p.isReady=!0,p.samples=u,p.generateMipMaps=a,p.samplingMode=l,p.type=o,p.format=h,p.label=n,this._internalTexturesCache.push(p),p}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,i,s,r=3,n=null,a=null,o=null,l=null,h=null,c=null,u,d,p,f){return this._createTextureBase(e,t,i,s,r,n,a,((...e)=>this._prepareWebGLTexture(...e,h)),((e,t,i,r,n,a)=>{const o=this._gl,l=i.width===e&&i.height===t;n._creationFlags=p??0;const h=this._getTexImageParametersForCreateTexture(n.format,n._useSRGBBuffer);if(l)return o.texImage2D(o.TEXTURE_2D,0,h.internalFormat,h.format,h.type,i),!1;const c=this._caps.maxTextureSize;if(i.width>c||i.height>c||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=e,this._workingCanvas.height=t,this._workingContext.drawImage(i,0,0,i.width,i.height,0,0,e,t),o.texImage2D(o.TEXTURE_2D,0,h.internalFormat,h.format,h.type,this._workingCanvas),n.width=e,n.height=t,1));{const e=new _.h(this,2);this._bindTextureDirectly(o.TEXTURE_2D,e,!0),o.texImage2D(o.TEXTURE_2D,0,h.internalFormat,h.format,h.type,i),this._rescaleTexture(e,n,s,h.format,(()=>{this._releaseTexture(e),this._bindTextureDirectly(o.TEXTURE_2D,n,!0),a()}))}return!0}),o,l,h,c,u,d,f)}_getTexImageParametersForCreateTexture(e,t){let i,s;return 1===this.webGLVersion?(i=this._getInternalFormat(e,t),s=i):(i=this._getInternalFormat(e,!1),s=this._getRGBABufferInternalSizedFormat(0,e,t)),{internalFormat:s,format:i,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,i,s,r){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const s=this._getTextureTarget(t),r=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(s,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(s,this._gl.TEXTURE_MIN_FILTER,r.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(s)),this._bindTextureDirectly(s,null),t.samplingMode=e}updateTextureDimensions(e,t,i,s=1){}updateTextureWrappingMode(e,t,i=null,s=null){const r=this._getTextureTarget(e);null!==t&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),null!==i&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&null!==s&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(s),e),e._cachedWrapR=s),this._bindTextureDirectly(r,null)}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,a=0){const o=this._gl;let l=o.TEXTURE_2D;if(e.isCube&&(l=o.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=o.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=o.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=o.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=o.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=o.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1}this._gl.compressedTexImage2D(l,a,t,i,s,0,r)}_uploadDataToTextureDirectly(e,t,i=0,s=0,r,n=!1){const a=this._gl,o=this._getWebGLTextureType(e.type),l=this._getInternalFormat(e.format),h=void 0===r?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(r,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let c=a.TEXTURE_2D;e.isCube&&(c=a.TEXTURE_CUBE_MAP_POSITIVE_X+i);const u=Math.round(Math.log(e.width)*Math.LOG2E),d=Math.round(Math.log(e.height)*Math.LOG2E),_=n?e.width:Math.pow(2,Math.max(u-s,0)),p=n?e.height:Math.pow(2,Math.max(d-s,0));a.texImage2D(c,s,h,_,p,0,l,o,t)}updateTextureData(e,t,i,s,r,n,a=0,o=0,l=!1){const h=this._gl,c=this._getWebGLTextureType(e.type),u=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let d=h.TEXTURE_2D,_=h.TEXTURE_2D;e.isCube&&(_=h.TEXTURE_CUBE_MAP_POSITIVE_X+a,d=h.TEXTURE_CUBE_MAP),this._bindTextureDirectly(d,e,!0),h.texSubImage2D(_,o,i,s,r,n,u,c,t),l&&this._gl.generateMipmap(_),this._bindTextureDirectly(d,null)}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){const r=this._gl,n=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,s),this._bindTextureDirectly(n,null,!0)}_prepareWebGLTextureContinuation(e,t,i,s,r){const n=this._gl;if(!n)return;const a=this._getSamplingParameters(r,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,a.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,a.min),i||s||n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,s,r,n,a,o,l,h){const u=this.getCaps().maxTextureSize,d=Math.min(u,this.needPOTTextures?(0,c.R)(s.width,u):s.width),_=Math.min(u,this.needPOTTextures?(0,c.R)(s.height,u):s.height),p=this._gl;p&&(e._hardwareTexture?(this._bindTextureDirectly(p.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===r||!!r),e.baseWidth=s.width,e.baseHeight=s.height,e.width=d,e.height=_,e.isReady=!0,e.type=-1!==e.type?e.type:0,e.format=-1!==e.format?e.format:h??(".jpg"!==t||e._useSRGBBuffer?5:4),o(d,_,s,t,e,(()=>{this._prepareWebGLTextureContinuation(e,i,n,a,l)}))||this._prepareWebGLTextureContinuation(e,i,n,a,l)):i&&i.removePendingData(e))}_getInternalFormatFromDepthTextureFormat(e,t,i){const s=this._gl;if(!t)return s.STENCIL_INDEX8;let r=i?s.DEPTH_STENCIL:s.DEPTH_COMPONENT;return this.webGLVersion>1?15===e?r=s.DEPTH_COMPONENT16:16===e?r=s.DEPTH_COMPONENT24:17===e||13===e?r=i?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT24:14===e?r=s.DEPTH_COMPONENT32F:18===e&&(r=i?s.DEPTH32F_STENCIL8:s.DEPTH_COMPONENT32F):r=s.DEPTH_COMPONENT16,r}_setupFramebufferDepthAttachments(e,t,i,s,r=1,n){const a=this._gl;n=n??(e?13:14);const o=this._getInternalFormatFromDepthTextureFormat(n,t,e);return e&&t?this._createRenderBuffer(i,s,r,a.DEPTH_STENCIL,o,a.DEPTH_STENCIL_ATTACHMENT):t?this._createRenderBuffer(i,s,r,o,o,a.DEPTH_ATTACHMENT):e?this._createRenderBuffer(i,s,r,o,o,a.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,s,r,n,a=!0){const o=this._gl.createRenderbuffer();return this._updateRenderBuffer(o,e,t,i,s,r,n,a)}_updateRenderBuffer(e,t,i,s,r,n,a,o=!0){const l=this._gl;return l.bindRenderbuffer(l.RENDERBUFFER,e),s>1&&l.renderbufferStorageMultisample?l.renderbufferStorageMultisample(l.RENDERBUFFER,s,n,t,i):l.renderbufferStorage(l.RENDERBUFFER,r,t,i),l.framebufferRenderbuffer(l.FRAMEBUFFER,a,l.RENDERBUFFER,e),o&&l.bindRenderbuffer(l.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();const t=this._internalTexturesCache.indexOf(e);-1!==t&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_deleteTexture(e){e?.release()}_setProgram(e){this._currentProgram!==e&&((0,s.C5)(e,this._gl),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let t=0;t<i.length;t++){const s=e.getUniform(i[t]);s&&(this._boundUniforms[t]=s)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,s=!1){let n=!1;const a=t&&t._associatedChannel>-1;if(i&&a&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||s){if(this._activateCurrentTexture(),t&&t.isMultiview)throw r.V.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,t?._hardwareTexture?.underlyingResource??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(n=!0,this._activateCurrentTexture());return a&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),n}_bindTexture(e,t,i){if(void 0===e)return;t&&(t._associatedChannel=e),this._activeChannel=e;const s=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(s,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,s){void 0!==e&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];i&&i._currentState!==t&&(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,s=!1,r=""){if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const i=t.getInternalTexture();i&&(i._associatedChannel=e),t.update()}else if(4===t.delayLoadState)return t.delayLoad(),!1;let n;n=s?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!i&&n&&(n._associatedChannel=e);let a=!0;this._boundTexturesCache[e]===n&&(i||this._bindSamplerUniformToChannel(n._associatedChannel,e),a=!1),this._activeChannel=e;const o=this._getTextureTarget(n);if(a&&this._bindTextureDirectly(o,n,i),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const e=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0;t.wrapU=e,t.wrapV=e}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(o,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(o,n,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,s){if(void 0!==e&&t){this._textureUnits&&this._textureUnits.length===i.length||(this._textureUnits=new Int32Array(i.length));for(let t=0;t<i.length;t++){const s=i[t].getInternalTexture();s?(this._textureUnits[t]=e+t,s._associatedChannel=e+t):this._textureUnits[t]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let e=0;e<i.length;e++)this._setTexture(this._textureUnits[e],i[e],!0)}}_setAnisotropicLevel(e,t,i){const s=this._caps.textureAnisotropicFilterExtension;11!==t.samplingMode&&3!==t.samplingMode&&2!==t.samplingMode&&(i=1),s&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,s){this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,s){s&&this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e)}else for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){const e=Object.keys(this._compiledEffects);for(const t of e)this._compiledEffects[t].dispose();this._compiledEffects={}}dispose(){(0,n.BA)()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored))),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&this._gl.getExtension("WEBGL_lose_context")?.loseContext(),(0,s.Cm)(this._gl)}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&n===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const e=t.RGBA,s=t.UNSIGNED_BYTE,r=new Uint8Array(4);t.readPixels(0,0,1,1,e,s,r),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(s),t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(1===this._webGLVersion){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(1===this._webGLVersion){if(void 0!==t)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(e,t,i,s,r=!0,n=!0){const a=r?4:3,o=r?this._gl.RGBA:this._gl.RGB,l=new Uint8Array(s*i*a);return n&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,s,o,this._gl.UNSIGNED_BYTE,l),Promise.resolve(l)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const e=u.$._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=null!=t&&!!window.WebGLRenderingContext}catch(e){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const e=u.$._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch(e){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}}v._TempClearColorUint32=new Uint32Array(4),v._TempClearColorInt32=new Int32Array(4),v.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],v._ConcatenateShader=f.iL,v._IsSupported=null,v._HasMajorPerformanceCaveat=null},8123:(e,t,i)=>{"use strict";var s;i.d(t,{s:()=>r}),function(e){e[e.PointerMove=0]="PointerMove",e[e.PointerDown=1]="PointerDown",e[e.PointerUp=2]="PointerUp"}(s||(s={}));class r{}r.DOM_DELTA_PIXEL=0,r.DOM_DELTA_LINE=1,r.DOM_DELTA_PAGE=2},4146:(e,t,i)=>{"use strict";i.d(t,{Bu:()=>n,TB:()=>s,W0:()=>r});class s{}s.KEYDOWN=1,s.KEYUP=2;class r{constructor(e,t){this.type=e,this.event=t}}class n extends r{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}},6240:(e,t,i)=>{"use strict";i.d(t,{Zp:()=>r,mx:()=>o,tT:()=>a});var s=i(9923);class r{}r.POINTERDOWN=1,r.POINTERUP=2,r.POINTERMOVE=4,r.POINTERWHEEL=8,r.POINTERPICK=16,r.POINTERTAP=32,r.POINTERDOUBLETAP=64;class n{constructor(e,t){this.type=e,this.event=t}}class a extends n{constructor(e,t,i,r){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new s.I9(i,r)}}class o extends n{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,s=null){super(e,t),this._pickInfo=i,this._inputManager=s}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}},5515:(e,t,i)=>{"use strict";i.d(t,{c:()=>s});class s{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}s.FALLOFF_DEFAULT=0,s.FALLOFF_PHYSICAL=1,s.FALLOFF_GLTF=2,s.FALLOFF_STANDARD=3,s.LIGHTMAP_DEFAULT=0,s.LIGHTMAP_SPECULAR=1,s.LIGHTMAP_SHADOWSONLY=2,s.INTENSITYMODE_AUTOMATIC=0,s.INTENSITYMODE_LUMINOUSPOWER=1,s.INTENSITYMODE_LUMINOUSINTENSITY=2,s.INTENSITYMODE_ILLUMINANCE=3,s.INTENSITYMODE_LUMINANCE=4,s.LIGHTTYPEID_POINTLIGHT=0,s.LIGHTTYPEID_DIRECTIONALLIGHT=1,s.LIGHTTYPEID_SPOTLIGHT=2,s.LIGHTTYPEID_HEMISPHERICLIGHT=3},994:(e,t,i)=>{"use strict";i.r(t),i.d(t,{_DDSTextureLoader:()=>n});var s=i(7517),r=i(6464);class n{constructor(){this.supportCascades=!0}loadCubeData(e,t,i,n){const a=t.getEngine();let o,l=!1,h=1e3;if(Array.isArray(e))for(let i=0;i<e.length;i++){const s=e[i];o=r.D.GetDDSInfo(s),t.width=o.width,t.height=o.height,l=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,a._unpackFlipY(o.isCompressed),r.D.UploadDDSLevels(a,t,s,o,l,6,-1,i),o.isFourCC||1!==o.mipmapCount?h=o.mipmapCount-1:a.generateMipMapsForCubemap(t)}else{const n=e;o=r.D.GetDDSInfo(n),t.width=o.width,t.height=o.height,i&&(o.sphericalPolynomial=new s.Q),l=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,a._unpackFlipY(o.isCompressed),r.D.UploadDDSLevels(a,t,n,o,l,6),o.isFourCC||1!==o.mipmapCount?h=o.mipmapCount-1:a.generateMipMapsForCubemap(t,!1)}a._setCubeMapTextureParams(t,l,h),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n({isDDS:!0,width:t.width,info:o,data:e,texture:t})}loadData(e,t,i){const s=r.D.GetDDSInfo(e),n=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&t.generateMipMaps&&Math.max(s.width,s.height)>>s.mipmapCount-1==1;i(s.width,s.height,n,s.isFourCC,(()=>{r.D.UploadDDSLevels(t.getEngine(),t,e,s,n,1)}))}}},504:(e,t,i)=>{"use strict";i.r(t),i.d(t,{_ENVTextureLoader:()=>g});var s=i(998),r=i(9923),n=i(4867),a=i(7517),o=i(854),l=i(2667),h=(i(9794),i(7891)),c=i(1137);i(7126),i(9764),i(5999);const u="image/png",d=2,_=[134,22,135,150,246,214,150,54];function p(e){if(e.version>d)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${d}".`);return 2===e.version?e:e={...e,version:2,imageType:u}}function f(e,t,r){const a=(r=p(r)).specular;return a?(e._lodGenerationScale=a.lodGenerationScale,async function(e,t,r=u){if(!s.S0.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const a=(0,n.ILog2)(e.width)+1,c=e.getEngine();let d=!1,_=!1,p=null,f=null,g=null;const v=c.getCaps();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,c.updateTextureSamplingMode(3,e),v.textureLOD?c._features.supportRenderAndCopyToLodForFloatTextures?v.textureHalfFloatRender&&v.textureHalfFloatLinearFiltering?(d=!0,e.type=2):v.textureFloatRender&&v.textureFloatLinearFiltering&&(d=!0,e.type=1):d=!1:(d=!1,_=!0,g={});let b=0;if(d)c.isWebGPU?(b=1,await i.e(371).then(i.bind(i,371))):await i.e(9682).then(i.bind(i,9682)),p=new h.w("rgbdDecode","rgbdDecode",null,null,1,null,3,c,!1,void 0,e.type,void 0,null,!1,void 0,b),e._isRGBD=!1,e.invertY=!1,f=c.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,_){const t=3,i=e._lodGenerationScale,s=e._lodGenerationOffset;for(let r=0;r<t;r++){const n=(a-1)*i+s,h=s+(n-s)*(1-r/(t-1)),u=Math.round(Math.min(Math.max(h,0),n)),d=new o.h(c,2);d.isCube=!0,d.invertY=!0,d.generateMipMaps=!1,c.updateTextureSamplingMode(2,d);const _=new l.t(null);switch(_._isCube=!0,_._texture=d,g[u]=_,r){case 0:e._lodTextureLow=_;break;case 1:e._lodTextureMid=_;break;case 2:e._lodTextureHigh=_}}}const x=[];for(let i=0;i<t.length;i++)for(let s=0;s<6;s++){const n=t[i][s],a=new Blob([n],{type:r}),o=URL.createObjectURL(a);let l;if(c._features.forceBitmapOverHTMLImageElement)l=c.createImageBitmap(a,{premultiplyAlpha:"none"}).then((t=>m(t,c,d,p,o,s,i,_,g,f,e)));else{const t=new Image;t.src=o,l=new Promise(((r,n)=>{t.onload=()=>{m(t,c,d,p,o,s,i,_,g,f,e).then((()=>r())).catch((e=>{n(e)}))},t.onerror=e=>{n(e)}}))}x.push(l)}if(t.length<a){let i;const s=Math.pow(2,a-1-t.length),r=s*s*4;switch(e.type){case 0:i=new Uint8Array(r);break;case 2:i=new Uint16Array(r);break;case 1:i=new Float32Array(r)}for(let s=t.length;s<a;s++)for(let t=0;t<6;t++)c._uploadArrayBufferViewToTexture(e,i,t,s)}return Promise.all(x).then((()=>{f&&(c._releaseTexture(e),f._swapAndDie(e)),p&&p.dispose(),_&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}))}(e,function(e,t){const i=(t=p(t)).specular;let s=Math.log2(t.width);if(s=Math.round(s)+1,i.mipmaps.length!==6*s)throw new Error(`Unsupported specular mipmaps number "${i.mipmaps.length}"`);const r=new Array(s);for(let t=0;t<s;t++){r[t]=new Array(6);for(let s=0;s<6;s++){const n=i.mipmaps[6*t+s];r[t][s]=new Uint8Array(e.buffer,e.byteOffset+i.specularDataPosition+n.position,n.length)}}return r}(t,r),r.imageType)):Promise.resolve()}function m(e,t,i,s,r,n,a,o,l,h,c){return new Promise(((u,d)=>{if(i){const i=t.createTexture(null,!0,!0,null,1,null,(e=>{d(e)}),e);s?.onEffectCreatedObservable.addOnce((o=>{o.executeWhenCompiled((()=>{s.externalTextureSamplerBinding=!0,s.onApply=s=>{s._bindTexture("textureSampler",i),s.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([s],h,!0,n,a),t.restoreDefaultFramebuffer(),i.dispose(),URL.revokeObjectURL(r),u())}))}))}else{if(t._uploadImageToTexture(c,e,n,a),o){const i=l[a];i&&t._uploadImageToTexture(i._texture,e,n,0)}u()}}))}class g{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,s,n){if(Array.isArray(e))return;const o=function(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let i=0;for(let e=0;e<_.length;e++)if(t.getUint8(i++)!==_[e])return c.V.Error("Not a babylon environment map"),null;let s="",r=0;for(;r=t.getUint8(i++);)s+=String.fromCharCode(r);let n=JSON.parse(s);return n=p(n),n.specular&&(n.specular.specularDataPosition=i,n.specular.lodGenerationScale=n.specular.lodGenerationScale||.8),n}(e);if(o){t.width=o.width,t.height=o.width;try{(function(e,t){const i=(t=p(t)).irradiance;if(!i)return;const s=new a.Q;r.Pq.FromArrayToRef(i.x,0,s.x),r.Pq.FromArrayToRef(i.y,0,s.y),r.Pq.FromArrayToRef(i.z,0,s.z),r.Pq.FromArrayToRef(i.xx,0,s.xx),r.Pq.FromArrayToRef(i.yy,0,s.yy),r.Pq.FromArrayToRef(i.zz,0,s.zz),r.Pq.FromArrayToRef(i.yz,0,s.yz),r.Pq.FromArrayToRef(i.zx,0,s.zx),r.Pq.FromArrayToRef(i.xy,0,s.xy),e._sphericalPolynomial=s})(t,o),f(t,e,o).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}),(e=>{n?.("Can not upload environment levels",e)}))}catch(e){n?.("Can not upload environment file",e)}}else n&&n("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}},788:(e,t,i)=>{"use strict";i.r(t),i.d(t,{_KTXTextureLoader:()=>p});var s=i(1137);class r{constructor(e,t){if(this.data=e,this.isInvalid=!1,!r.IsValid(e))return this.isInvalid=!0,void s.V.Error("texture missing KTX identifier");const i=Uint32Array.BYTES_PER_ELEMENT,n=new DataView(this.data.buffer,this.data.byteOffset+12,13*i),a=67305985===n.getUint32(0,!0);return this.glType=n.getUint32(1*i,a),this.glTypeSize=n.getUint32(2*i,a),this.glFormat=n.getUint32(3*i,a),this.glInternalFormat=n.getUint32(4*i,a),this.glBaseInternalFormat=n.getUint32(5*i,a),this.pixelWidth=n.getUint32(6*i,a),this.pixelHeight=n.getUint32(7*i,a),this.pixelDepth=n.getUint32(8*i,a),this.numberOfArrayElements=n.getUint32(9*i,a),this.numberOfFaces=n.getUint32(10*i,a),this.numberOfMipmapLevels=n.getUint32(11*i,a),this.bytesOfKeyValueData=n.getUint32(12*i,a),0!==this.glType?(s.V.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(s.V.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(s.V.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==t?(s.V.Error("number of faces expected"+t+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=r.COMPRESSED_2D))}uploadLevels(e,t){switch(this.loadType){case r.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);case r.TEX_2D:case r.COMPRESSED_3D:case r.TEX_3D:}}_upload2DCompressedLevels(e,t){let i=r.HEADER_LEN+this.bytesOfKeyValueData,s=this.pixelWidth,n=this.pixelHeight;const a=t?this.numberOfMipmapLevels:1;for(let t=0;t<a;t++){const r=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(let a=0;a<this.numberOfFaces;a++){const o=new Uint8Array(this.data.buffer,this.data.byteOffset+i,r);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,s,n,o,a,t),i+=r,i+=3-(r+3)%4}s=Math.max(1,.5*s),n=Math.max(1,.5*n)}}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}}r.HEADER_LEN=64,r.COMPRESSED_2D=0,r.COMPRESSED_3D=1,r.TEX_2D=2,r.TEX_3D=3;class n{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map((e=>({workerPromise:Promise.resolve(e),idle:!0})))}dispose(){for(const e of this._workerInfos)e.workerPromise.then((e=>{e.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then((i=>{t(i,(()=>{const t=this._pendingActions.shift();t?this._execute(e,t):e.idle=!0}))}))}}class a extends n{constructor(e,t,i=a.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,((i,s)=>{t(i,(()=>{s(),e.idle&&(e.timeoutId=setTimeout((()=>{e.workerPromise.then((e=>{e.terminate()}));const t=this._workerInfos.indexOf(e);-1!==t&&this._workerInfos.splice(t,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}a.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};var o,l,h,c=i(998);function u(e,t){const i=t?.jsDecoderModule||KTX2DECODER;e&&(e.wasmUASTCToASTC&&(i.LiteTranscoder_UASTC_ASTC.WasmModuleURL=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(i.LiteTranscoder_UASTC_BC7.WasmModuleURL=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(i.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(i.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(i.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(i.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(i.MSCTranscoder.JSModuleURL=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(i.MSCTranscoder.WasmModuleURL=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(i.ZSTDDecoder.WasmModuleURL=e.wasmZSTDDecoder)),t&&(t.wasmUASTCToASTC&&(i.LiteTranscoder_UASTC_ASTC.WasmBinary=t.wasmUASTCToASTC),t.wasmUASTCToBC7&&(i.LiteTranscoder_UASTC_BC7.WasmBinary=t.wasmUASTCToBC7),t.wasmUASTCToRGBA_UNORM&&(i.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=t.wasmUASTCToRGBA_UNORM),t.wasmUASTCToRGBA_SRGB&&(i.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=t.wasmUASTCToRGBA_SRGB),t.wasmUASTCToR8_UNORM&&(i.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=t.wasmUASTCToR8_UNORM),t.wasmUASTCToRG8_UNORM&&(i.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=t.wasmUASTCToRG8_UNORM),t.jsMSCTranscoder&&(i.MSCTranscoder.JSModule=t.jsMSCTranscoder),t.wasmMSCTranscoder&&(i.MSCTranscoder.WasmBinary=t.wasmMSCTranscoder),t.wasmZSTDDecoder&&(i.ZSTDDecoder.WasmBinary=t.wasmZSTDDecoder))}function d(e){let t;void 0===e&&"undefined"!=typeof KTX2DECODER&&(e=KTX2DECODER),onmessage=i=>{if(i.data)switch(i.data.action){case"init":{const s=i.data.urls;s&&(s.jsDecoderModule&&void 0===e&&(importScripts(s.jsDecoderModule),e=KTX2DECODER),u(s)),i.data.wasmBinaries&&u(void 0,{...i.data.wasmBinaries,jsDecoderModule:e}),t=new e.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":e.KTX2Decoder.DefaultDecoderOptions=i.data.options;break;case"decode":t.decode(i.data.data,i.data.caps,i.data.options).then((e=>{const t=[];for(let i=0;i<e.mipmaps.length;++i){const s=e.mipmaps[i];s&&s.data&&t.push(s.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:e},t)})).catch((e=>{postMessage({action:"decoded",success:!1,msg:e})}))}}}!function(e){e[e.ETC1S=0]="ETC1S",e[e.UASTC4x4=1]="UASTC4x4"}(o||(o={})),function(e){e[e.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",e[e.BC7_RGBA=1]="BC7_RGBA",e[e.BC3_RGBA=2]="BC3_RGBA",e[e.BC1_RGB=3]="BC1_RGB",e[e.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",e[e.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",e[e.ETC2_RGBA=6]="ETC2_RGBA",e[e.ETC1_RGB=7]="ETC1_RGB",e[e.RGBA32=8]="RGBA32",e[e.R8=9]="R8",e[e.RG8=10]="RG8"}(l||(l={})),function(e){e[e.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",e[e.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.RGBA8Format=32856]="RGBA8Format",e[e.R8Format=33321]="R8Format",e[e.RG8Format=33323]="RG8Format"}(h||(h={}));class _{static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(e){if(_._WorkerPoolPromise||_._DecoderModulePromise)return;const t={jsDecoderModule:c.S0.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:c.S0.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:c.S0.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:c.S0.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:c.S0.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:c.S0.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:c.S0.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:c.S0.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:c.S0.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:c.S0.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};e&&"function"==typeof Worker&&"undefined"!=typeof URL?_._WorkerPoolPromise=new Promise((i=>{const s=`${u}(${d})()`,r=URL.createObjectURL(new Blob([s],{type:"application/javascript"}));i(new a(e,(()=>function(e,t,i){return new Promise(((t,s)=>{const r=t=>{e.removeEventListener("error",r),e.removeEventListener("message",n),s(t)},n=i=>{"init"===i.data.action&&(e.removeEventListener("error",r),e.removeEventListener("message",n),t(e))};e.addEventListener("error",r),e.addEventListener("message",n),e.postMessage({action:"init",urls:i,wasmBinaries:undefined})}))}(new Worker(r),0,t))))})):void 0===_._KTX2DecoderModule?_._DecoderModulePromise=c.S0.LoadBabylonScriptAsync(t.jsDecoderModule).then((()=>(_._KTX2DecoderModule=KTX2DECODER,_._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,_._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,u(t,_._KTX2DecoderModule),new _._KTX2DecoderModule.KTX2Decoder))):(_._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,_._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,_._DecoderModulePromise=Promise.resolve(new _._KTX2DecoderModule.KTX2Decoder))}constructor(e,t=_.DefaultNumWorkers){this._engine=e;const i="object"==typeof t&&t.workerPool||_.WorkerPool;if(i)_._WorkerPoolPromise=Promise.resolve(i);else{"object"==typeof t?_._KTX2DecoderModule=t?.binariesAndModulesContainer?.jsDecoderModule:"undefined"!=typeof KTX2DECODER&&(_._KTX2DecoderModule=KTX2DECODER);const e="number"==typeof t?t:t.numWorkers??_.DefaultNumWorkers;_._Initialize(e)}}_uploadAsync(e,t,i){const s=this._engine.getCaps(),r={astc:!!s.astc,bptc:!!s.bptc,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,etc1:!!s.etc1};if(_._WorkerPoolPromise)return _._WorkerPoolPromise.then((s=>new Promise(((n,a)=>{s.push(((s,o)=>{const l=e=>{s.removeEventListener("error",l),s.removeEventListener("message",h),a(e),o()},h=e=>{if("decoded"===e.data.action){if(s.removeEventListener("error",l),s.removeEventListener("message",h),e.data.success)try{this._createTexture(e.data.decodedData,t,i),n()}catch(e){a({message:e})}else a({message:e.data.msg});o()}};s.addEventListener("error",l),s.addEventListener("message",h),s.postMessage({action:"setDefaultDecoderOptions",options:_.DefaultDecoderOptions._getKTX2DecoderOptions()});const c=new Uint8Array(e.byteLength);c.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),s.postMessage({action:"decode",data:c,caps:r,options:i},[c.buffer])}))}))));if(_._DecoderModulePromise)return _._DecoderModulePromise.then((i=>(_.DefaultDecoderOptions.isDirty&&(_._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=_.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise(((r,n)=>{i.decode(e,s).then((e=>{this._createTexture(e,t),r()})).catch((e=>{n({message:e})}))})))));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let s=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,s=!1}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let i=0;i<e.mipmaps.length;++i){const r=e.mipmaps[i];if(!r||!r.data)throw new Error("KTX2 container - could not transcode one of the image");s?(t.width=r.width,t.height=r.height,this._engine._uploadDataToTextureDirectly(t,r.data,0,i,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,r.width,r.height,r.data,0,i)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}}_.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},_.DefaultNumWorkers=_.GetDefaultNumWorkers(),_.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[l.BC1_RGB,l.BC3_RGBA],yes:{transcodeFormat:l.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}};class p{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,s){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const n=t.getEngine(),a=new r(e,6),o=a.numberOfMipmapLevels>1&&t.generateMipMaps;n._unpackFlipY(!0),a.uploadLevels(t,t.generateMipMaps),t.width=a.pixelWidth,t.height=a.pixelHeight,n._setCubeMapTextureParams(t,o,a.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}loadData(e,t,i,n){if(r.IsValid(e)){t._invertVScale=!t.invertY;const s=new r(e,1),n=function(e){switch(e){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(s.glInternalFormat);n?(t.format=n,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=s.glInternalFormat,i(s.pixelWidth,s.pixelHeight,t.generateMipMaps,!0,(()=>{s.uploadLevels(t,t.generateMipMaps)}),s.isInvalid)}else _.IsValid(e)?new _(t.getEngine())._uploadAsync(e,t,n).then((()=>{i(t.width,t.height,t.generateMipMaps,!0,(()=>{}),!1)}),(e=>{s.V.Warn(`Failed to load KTX2 texture data: ${e.message}`),i(0,0,!1,!1,(()=>{}),!0)})):(s.V.Error("texture missing KTX identifier"),i(0,0,!1,!1,(()=>{}),!0))}}},8454:(e,t,i)=>{"use strict";i.d(t,{gT:()=>a});var s=i(1137);const r=new Map;function n(e,t){(function(e){return r.delete(e)})(e)&&s.V.Warn(`Extension with the name '${name}' already exists`),r.set(e,t)}function a(e,t){"image/ktx"!==t&&"image/ktx2"!==t||(e=".ktx"),r.has(e)||(e.endsWith(".dds")&&n(".dds",(()=>Promise.resolve().then(i.bind(i,994)).then((e=>new e._DDSTextureLoader)))),e.endsWith(".basis")&&n(".basis",(()=>i.e(6692).then(i.bind(i,6692)).then((e=>new e._BasisTextureLoader)))),e.endsWith(".env")&&n(".env",(()=>Promise.resolve().then(i.bind(i,504)).then((e=>new e._ENVTextureLoader)))),e.endsWith(".hdr")&&n(".hdr",(()=>i.e(5608).then(i.bind(i,5608)).then((e=>new e._HDRTextureLoader)))),(e.endsWith(".ktx")||e.endsWith(".ktx2"))&&(n(".ktx",(()=>Promise.resolve().then(i.bind(i,788)).then((e=>new e._KTXTextureLoader)))),n(".ktx2",(()=>Promise.resolve().then(i.bind(i,788)).then((e=>new e._KTXTextureLoader))))),e.endsWith(".tga")&&n(".tga",(()=>Promise.resolve().then(i.bind(i,1318)).then((e=>new e._TGATextureLoader)))),e.endsWith(".exr")&&n(".exr",(()=>i.e(8685).then(i.bind(i,8685)).then((e=>new e._ExrTextureLoader)))));const s=r.get(e);return s?Promise.resolve(s(t)):null}},1318:(e,t,i)=>{"use strict";i.r(t),i.d(t,{_TGATextureLoader:()=>o});var s=i(1137);function r(e){let t=0;return{id_length:e[t++],colormap_type:e[t++],image_type:e[t++],colormap_index:e[t++]|e[t++]<<8,colormap_length:e[t++]|e[t++]<<8,colormap_size:e[t++],origin:[e[t++]|e[t++]<<8,e[t++]|e[t++]<<8],width:e[t++]|e[t++]<<8,height:e[t++]|e[t++]<<8,pixel_size:e[t++],flags:e[t++]}}function n(e,t){if(t.length<19)return void s.V.Error("Unable to load TGA file - Not enough data to contain header");let i=18;const n=r(t);if(n.id_length+i>t.length)return void s.V.Error("Unable to load TGA file - Not enough data");i+=n.id_length;let o,l=!1,h=!1,c=!1;switch(n.image_type){case 9:l=!0;case 1:h=!0;break;case 10:l=!0;case 2:break;case 11:l=!0;case 3:c=!0}const u=n.pixel_size>>3,d=n.width*n.height*u;let _,p,f,m,g,v,b;if(h&&(_=t.subarray(i,i+=n.colormap_length*(n.colormap_size>>3))),l){let e,s,r;o=new Uint8Array(d);let n=0;const a=new Uint8Array(u);for(;i<d&&n<d;)if(e=t[i++],s=1+(127&e),128&e){for(r=0;r<u;++r)a[r]=t[i++];for(r=0;r<s;++r)o.set(a,n+r*u);n+=u*s}else{for(s*=u,r=0;r<s;++r)o[n+r]=t[i++];n+=s}}else o=t.subarray(i,i+=h?n.width*n.height:d);switch((48&n.flags)>>4){default:case 2:p=0,m=1,b=n.width,f=0,g=1,v=n.height;break;case 0:p=0,m=1,b=n.width,f=n.height-1,g=-1,v=-1;break;case 3:p=n.width-1,m=-1,b=-1,f=0,g=1,v=n.height;break;case 1:p=n.width-1,m=-1,b=-1,f=n.height-1,g=-1,v=-1}const x="_getImageData"+(c?"Grey":"")+n.pixel_size+"bits",S=a[x](n,_,o,f,g,v,p,m,b);e.getEngine()._uploadDataToTextureDirectly(e,S)}const a={GetTGAHeader:r,UploadContent:n,_getImageData8bits:function(e,t,i,s,r,n,a,o,l){const h=i,c=t,u=e.width,d=e.height;let _,p,f,m=0;const g=new Uint8Array(u*d*4);for(f=s;f!==n;f+=r)for(p=a;p!==l;p+=o,m++)_=h[m],g[4*(p+u*f)+3]=255,g[4*(p+u*f)+2]=c[3*_+0],g[4*(p+u*f)+1]=c[3*_+1],g[4*(p+u*f)+0]=c[3*_+2];return g},_getImageData16bits:function(e,t,i,s,r,n,a,o,l){const h=i,c=e.width,u=e.height;let d,_,p,f=0;const m=new Uint8Array(c*u*4);for(p=s;p!==n;p+=r)for(_=a;_!==l;_+=o,f+=2){d=h[f+0]+(h[f+1]<<8);const e=255*((31744&d)>>10)/31|0,t=255*((992&d)>>5)/31|0,i=255*(31&d)/31|0;m[4*(_+c*p)+0]=e,m[4*(_+c*p)+1]=t,m[4*(_+c*p)+2]=i,m[4*(_+c*p)+3]=32768&d?0:255}return m},_getImageData24bits:function(e,t,i,s,r,n,a,o,l){const h=i,c=e.width,u=e.height;let d,_,p=0;const f=new Uint8Array(c*u*4);for(_=s;_!==n;_+=r)for(d=a;d!==l;d+=o,p+=3)f[4*(d+c*_)+3]=255,f[4*(d+c*_)+2]=h[p+0],f[4*(d+c*_)+1]=h[p+1],f[4*(d+c*_)+0]=h[p+2];return f},_getImageData32bits:function(e,t,i,s,r,n,a,o,l){const h=i,c=e.width,u=e.height;let d,_,p=0;const f=new Uint8Array(c*u*4);for(_=s;_!==n;_+=r)for(d=a;d!==l;d+=o,p+=4)f[4*(d+c*_)+2]=h[p+0],f[4*(d+c*_)+1]=h[p+1],f[4*(d+c*_)+0]=h[p+2],f[4*(d+c*_)+3]=h[p+3];return f},_getImageDataGrey8bits:function(e,t,i,s,r,n,a,o,l){const h=i,c=e.width,u=e.height;let d,_,p,f=0;const m=new Uint8Array(c*u*4);for(p=s;p!==n;p+=r)for(_=a;_!==l;_+=o,f++)d=h[f],m[4*(_+c*p)+0]=d,m[4*(_+c*p)+1]=d,m[4*(_+c*p)+2]=d,m[4*(_+c*p)+3]=255;return m},_getImageDataGrey16bits:function(e,t,i,s,r,n,a,o,l){const h=i,c=e.width,u=e.height;let d,_,p=0;const f=new Uint8Array(c*u*4);for(_=s;_!==n;_+=r)for(d=a;d!==l;d+=o,p+=2)f[4*(d+c*_)+0]=h[p+0],f[4*(d+c*_)+1]=h[p+0],f[4*(d+c*_)+2]=h[p+0],f[4*(d+c*_)+3]=h[p+1];return f}};class o{constructor(){this.supportCascades=!1}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),a=r(s);i(a.width,a.height,t.generateMipMaps,!1,(()=>{n(t,s)}))}}},2667:(e,t,i)=>{"use strict";i.d(t,{t:()=>d});var s=i(5524),r=i(9259),n=i(9848),a=i(9923),o=i(6315),l=i(8688),h=(i(655),i(521));class c{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return!!this._texture&&this._texture.isCube}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return void 0!==e?.shareDepth}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=h.o.Zero(),this._cachedBaseSize=h.o.Zero(),this._initialSamplingMode=2,this._texture=c._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return 4===this.delayLoadState?(this.delayLoad(),!1):!!this._texture&&this._texture.isReady}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return this.isReady()&&this._texture?this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize):(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}var u=i(6877);class d extends c{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){return this._texture?(null===this._texture._gammaSpace&&(this._texture._gammaSpace=this._gammaSpace),this._texture._gammaSpace&&!this._texture._useSRGBBuffer):this._gammaSpace}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this.getScene()?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this)))}get isRGBD(){return null!=this._texture&&this._texture._isRGBD}set isRGBD(e){e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),this.getScene()?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return!!this._texture&&this._texture._linearSpecularLOD}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=(0,l.z)()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=d.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new n.cP,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?d._IsScene(e)?this._scene=e:this._engine=e:this._scene=o.q.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}getTextureMatrix(){return a.uq.IdentityReadOnly}getReflectionTextureMatrix(){return a.uq.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,s,r,n){const a=this._getEngine();if(!a)return null;const o=a._getUseSRGBBuffer(!!r,t),l=a.getLoadedTexturesCache();for(let a=0;a<l.length;a++){const h=l[a];if(!(void 0!==r&&o!==h._useSRGBBuffer||void 0!==s&&s!==h.invertY||h.url!==e||h.generateMipMaps!==!t||i&&i!==h.samplingMode||void 0!==n&&n!==h.isCube))return h.incrementReferences(),h}return null}_rebuild(e=!1){}clone(){return null}get textureType(){return this._texture&&void 0!==this._texture.type?this._texture.type:0}get textureFormat(){return this._texture&&void 0!==this._texture.format?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,s=!0,r=!1,n=0,a=0,o=Number.MAX_VALUE,l=Number.MAX_VALUE){if(!this._texture)return null;const h=this._getEngine();if(!h)return null;const c=this.getSize();let u=c.width,d=c.height;0!==t&&(u/=Math.pow(2,t),d/=Math.pow(2,t),u=Math.round(u),d=Math.round(d)),o=Math.min(u,o),l=Math.min(d,l);try{return this._texture.isCube?h._readTexturePixels(this._texture,o,l,e,t,i,s,r,n,a):h._readTexturePixels(this._texture,o,l,-1,t,i,s,r,n,a)}catch(e){return null}}_readPixelsSync(e=0,t=0,i=null,s=!0,r=!1){if(!this._texture)return null;const n=this.getSize();let a=n.width,o=n.height;const l=this._getEngine();if(!l)return null;0!=t&&(a/=Math.pow(2,t),o/=Math.pow(2,t),a=Math.round(a),o=Math.round(o));try{return this._texture.isCube?l._readTexturePixelsSync(this._texture,a,o,e,t,i,s,r):l._readTexturePixelsSync(this._texture,a,o,-1,t,i,s,r)}catch(e){return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const e=this._parentContainer.textures.indexOf(this);e>-1&&this._parentContainer.textures.splice(e,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=u.p.Serialize(this);return u.p.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(0!==i)for(let s=0;s<e.length;s++){const r=e[s];if(r.isReady())0==--i&&t();else{const e=r.onLoadObservable;e?e.addOnce((()=>{0==--i&&t()})):0==--i&&t()}}else t()}static _IsScene(e){return"Scene"===e.getClassName()}}d.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,(0,s.Cg)([(0,r.lK)()],d.prototype,"uniqueId",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"name",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"metadata",void 0),(0,s.Cg)([(0,r.lK)("hasAlpha")],d.prototype,"_hasAlpha",void 0),(0,s.Cg)([(0,r.lK)("getAlphaFromRGB")],d.prototype,"_getAlphaFromRGB",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"level",void 0),(0,s.Cg)([(0,r.lK)("coordinatesIndex")],d.prototype,"_coordinatesIndex",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"optimizeUVAllocation",void 0),(0,s.Cg)([(0,r.lK)("coordinatesMode")],d.prototype,"_coordinatesMode",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"wrapU",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"wrapV",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"wrapR",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"anisotropicFilteringLevel",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"isCube",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"is3D",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"is2DArray",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"gammaSpace",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"invertZ",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"lodLevelInAlpha",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"lodGenerationOffset",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"lodGenerationScale",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"linearSpecularLOD",null),(0,s.Cg)([(0,r.uM)()],d.prototype,"irradianceTexture",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"isRenderTarget",void 0)},9764:(e,t,i)=>{"use strict";var s=i(6755),r=i(2667);r.t.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(r.t.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=s.d.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0})},854:(e,t,i)=>{"use strict";i.d(t,{h:()=>a});var s,r=i(9848);class n{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,s=1,r=2,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=s,this.samplingMode=r,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}!function(e){e[e.Unknown=0]="Unknown",e[e.Url=1]="Url",e[e.Temp=2]="Temp",e[e.Raw=3]="Raw",e[e.Dynamic=4]="Dynamic",e[e.RenderTarget=5]="RenderTarget",e[e.MultiRenderTarget=6]="MultiRenderTarget",e[e.Cube=7]="Cube",e[e.CubeRaw=8]="CubeRaw",e[e.CubePrefiltered=9]="CubePrefiltered",e[e.Raw3D=10]="Raw3D",e[e.Raw2DArray=11]="Raw2DArray",e[e.DepthStencil=12]="DepthStencil",e[e.CubeRawRGBD=13]="CubeRawRGBD",e[e.Depth=14]="Depth"}(s||(s={}));class a extends n{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new r.cP,this.onErrorObservable=new r.cP,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=0,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._creationFlags=0,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._engine=e,this._source=t,this._uniqueId=a._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const e=this.onRebuildCallback(this),t=t=>{t._swapAndDie(this,!1),this.isReady=e.isReady};return void(e.isAsync?e.proxy.then(t):t(e.proxy))}let e;switch(this.source){case 2:case 12:case 14:break;case 1:return void(e=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(e=>{e._swapAndDie(this,!1),this.isReady=!0}),null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer));case 3:e=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,this._creationFlags,this._useSRGBBuffer),e._swapAndDie(this,!1),this.isReady=!0;break;case 10:e=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 11:e=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 4:e=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),e._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case 7:return void(e=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,(()=>{e._swapAndDie(this,!1),this.isReady=!0}),null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer,ArrayBuffer.isView(this._buffer)?this._buffer:null));case 8:e=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this._originalFormat??this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),e._swapAndDie(this,!1),this.isReady=!0;break;case 13:return;case 9:return e=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,(e=>{e&&e._swapAndDie(this,!1),this.isReady=!0}),null,this.format,this._extension),void(e._sphericalPolynomial=this._sphericalPolynomial)}}_swapAndDie(e,t=!0){this._hardwareTexture?.setUsage(e._source,this.generateMipMaps,this.is2DArray,this.isCube,this.is3D,this.width,this.height,this.depth),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const i=this._engine.getLoadedTexturesCache();let s=i.indexOf(this);-1!==s&&i.splice(s,1),s=i.indexOf(e),-1===s&&i.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),0===this._references&&(this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}a._Counter=0},5474:(e,t,i)=>{"use strict";i.d(t,{$:()=>d});var s=i(9848),r=i(9923),n=i(2781),a=i(6096),o=i(3099),l=i(7309),h=i(1597),c=i(4420),u=i(1137);c.M.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)};class d extends n.g{get renderList(){return this._renderList}set renderList(e){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=(0,l.lL)(e,this._renderListHasChanged)),this._renderList=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let i;i=Array.isArray(e)?e:[e];for(let e=0;e<i.length;++e)for(let s=0;s<this._renderPassIds.length;++s)i[e].setMaterialForRenderPass(this._renderPassIds[s],void 0!==t?Array.isArray(t)?t[s]:t:void 0)}get isMulti(){return this._renderTarget?.isMulti??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){return this._renderTarget?._depthStencilTexture??null}constructor(e,t,i,a=!1,l=!0,h=0,c=!1,u=n.g.TRILINEAR_SAMPLINGMODE,d=!0,_=!1,p=!1,f=5,m=!1,g,v,b=!1,x=!1){let S,T=!0;if("object"==typeof a){const e=a;a=!!e.generateMipMaps,l=e.doNotChangeAspectRatio??!0,h=e.type??0,c=!!e.isCube,u=e.samplingMode??n.g.TRILINEAR_SAMPLINGMODE,d=e.generateDepthBuffer??!0,_=!!e.generateStencilBuffer,p=!!e.isMulti,f=e.format??5,m=!!e.delayAllocation,g=e.samples,v=e.creationFlags,b=!!e.noColorAttachment,x=!!e.useSRGBBuffer,S=e.colorAttachment,T=e.gammaSpace??T}if(super(null,i,!a,void 0,u,void 0,void 0,void 0,void 0,f),this._unObserveRenderList=null,this._renderListHasChanged=(e,t)=>{const i=this._renderList?this._renderList.length:0;(0===t&&i>0||0===i)&&this.getScene()?.meshes.forEach((e=>{e._markSubMeshesAsLightDirty()}))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new s.cP,this.onAfterUnbindObservable=new s.cP,this.onBeforeRenderObservable=new s.cP,this.onAfterRenderObservable=new s.cP,this.onClearObservable=new s.cP,this.onResizeObservable=new s.cP,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=r.Pq.Zero(),this._dumpToolsLoading=!1,!(i=this.getScene()))return;const y=this.getScene().getEngine();this._gammaSpace=T,this._coordinatesMode=n.g.PROJECTION_MODE,this.renderList=[],this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._renderPassIds=[],this._isCubeData=c,this._processSizeParameter(t),this.renderPassId=this._renderPassIds[0],this._resizeObserver=y.onResizeObservable.add((()=>{})),this._generateMipMaps=!!a,this._doNotChangeAspectRatio=l,this._renderingManager=new o.m(i),this._renderingManager._useSceneAutoClearSetup=!0,p||(this._renderTargetOptions={generateMipMaps:a,type:h,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:d,generateStencilBuffer:_,samples:g,creationFlags:v,noColorAttachment:b,useSRGBBuffer:x,colorAttachment:S,label:this.name},this.samplingMode===n.g.NEAREST_SAMPLINGMODE&&(this.wrapU=n.g.CLAMP_ADDRESSMODE,this.wrapV=n.g.CLAMP_ADDRESSMODE),m||(c?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=n.g.INVCUBIC_MODE,this._textureMatrix=r.uq.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==g&&(this.samples=g)))}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,r=14,n){this._renderTarget?.createDepthStencilTexture(e,t,i,s,r,n)}_releaseRenderPassId(){if(this._scene){const e=this._scene.getEngine();for(let t=0;t<this._renderPassIds.length;++t)e.releaseRenderPassId(this._renderPassIds[t])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine(),t=this._isCubeData?6:this.getRenderLayers()||1;for(let i=0;i<t;++i)this._renderPassIds[i]=e.createRenderPassId(`RenderTargetTexture - ${this.name}#${i}`)}_processSizeParameter(e,t=!0){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e;t&&this._createRenderPassId()}get samples(){return this._renderTarget?.samples??this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}addPostProcess(e){if(!this._postProcessManager){const e=this.getScene();if(!e)return;this._postProcessManager=new a.X(e),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const e of this._postProcesses)e.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;if(e)return e;return this._size.depth||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){const t=this.isCube;this._renderTarget?.dispose(),this._renderTarget=null;const i=this.getScene();i&&(this._processSizeParameter(e,!1),this._renderTarget=t?i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){return this._dumpToolsLoading||(this._dumpToolsLoading=!0,Promise.resolve().then(i.bind(i,5999)).then((e=>this._dumpTools=e))),this._render(!1,!1,!0)}_render(e=!1,t=!1,i=!1){const s=this.getScene();if(!s)return i;const r=s.getEngine();if(void 0!==this.useCameraPostProcesses&&(e=this.useCameraPostProcesses),this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let e=0;e<this._waitingRenderList.length;e++){const t=this._waitingRenderList[e],i=s.getMeshById(t);i&&this.renderList.push(i)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const e=this.getScene();if(!e)return i;const t=e.meshes;for(let e=0;e<t.length;e++){const i=t[e];this.renderListPredicate(i)&&this.renderList.push(i)}}const n=r.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const a=this.activeCamera??s.activeCamera,o=s.activeCamera;a&&(a!==s.activeCamera&&(s.setTransformMatrix(a.getViewMatrix(),a.getProjectionMatrix(!0)),s.activeCamera=a),r.setViewport(a.rigParent?a.rigParent.viewport:a.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let l=i;if(i){s.getViewMatrix()||s.updateTransformMatrix();const e=this.is2DArray||this.is3D?this.getRenderLayers():this.isCube?6:1;for(let t=0;t<e&&l;t++){let e=null;const n=this.renderList?this.renderList:s.getActiveMeshes().data,a=this.renderList?this.renderList.length:s.getActiveMeshes().length;r.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t),this.getCustomRenderList&&(e=this.getCustomRenderList(t,n,a)),e||(e=n),this._doNotChangeAspectRatio||s.updateTransformMatrix(!0);for(let t=0;t<e.length&&l;++t){const s=e[t];if(s.isEnabled()&&!s.isBlocked&&s.isVisible&&s.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(s,this.refreshRate,i)){l=!1;continue}}else if(!s.isReady(!0)){l=!1;continue}}this.onAfterRenderObservable.notifyObservers(t),(this.is2DArray||this.is3D||this.isCube)&&(s.incrementRenderId(),s.resetCachedMaterial())}}else if(!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let i=0;i<6;i++)this._renderToTarget(i,e,t,void 0,a),s.incrementRenderId(),s.resetCachedMaterial();else this._renderToTarget(0,e,t,void 0,a);else for(let i=0;i<this.getRenderLayers();i++)this._renderToTarget(0,e,t,i,a),s.incrementRenderId(),s.resetCachedMaterial();return this.onAfterUnbindObservable.notifyObservers(this),r.currentRenderPassId=n,o&&(s.activeCamera=o,this.activeCamera&&this.activeCamera!==s.activeCamera&&s.setTransformMatrix(s.activeCamera.getViewMatrix(),s.activeCamera.getProjectionMatrix(!0)),r.setViewport(s.activeCamera.viewport)),s.resetCachedMaterial(),l}_bestReflectionRenderTargetDimension(e,t){const i=e*t,s=(0,h.OG)(i+16384/(128+i));return Math.min((0,h.C4)(e),s)}_prepareRenderingManager(e,t,i,s){const r=this.getScene();if(!r)return;this._renderingManager.reset();const n=r.getRenderId();for(let a=0;a<t;a++){const t=e[a];if(t&&!t.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!t.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}if(!t._internalAbstractMeshDataInfo._currentLODIsUpToDate&&r.activeCamera&&(t._internalAbstractMeshDataInfo._currentLOD=r.customLODSelector?r.customLODSelector(t,this.activeCamera||r.activeCamera):t.getLOD(this.activeCamera||r.activeCamera),t._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!t._internalAbstractMeshDataInfo._currentLOD)continue;let e,a=t._internalAbstractMeshDataInfo._currentLOD;if(a._preActivateForIntermediateRendering(n),e=!(!s||!i||t.layerMask&i.layerMask),t.isEnabled()&&t.isVisible&&t.subMeshes&&!e){if(a!==t&&a._activate(n,!0),t._activate(n,!0)&&t.subMeshes.length){t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(a=t):a._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,a._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let e=0;e<a.subMeshes.length;e++){const t=a.subMeshes[e];this._renderingManager.dispatch(t,a)}}t._postActivate()}}}for(let e=0;e<r.particleSystems.length;e++){const t=r.particleSystems[e],i=t.emitter;t.isStarted()&&i&&(!i.position||i.isEnabled())&&this._renderingManager.dispatchParticles(t)}}_bindFrameBuffer(e=0,t=0){const i=this.getScene();if(!i)return;const s=i.getEngine();this._renderTarget&&s.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t)}))}_prepareFrame(e,t,i,s){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):s&&e.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(t,i)}_renderToTarget(e,t,i,s=0,r=null){const n=this.getScene();if(!n)return;const a=n.getEngine();if(a._debugPushGroup?.(`render to face #${e} layer #${s}`,1),this._prepareFrame(n,e,s,t),this.is2DArray||this.is3D?(a.currentRenderPassId=this._renderPassIds[s],this.onBeforeRenderObservable.notifyObservers(s)):(a.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),a.snapshotRendering&&1===a.snapshotRenderingMode)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(a):this.skipInitialClear||a.clear(this.clearColor||n.clearColor,!0,!0,!0);else{let o=null;const l=this.renderList?this.renderList:n.getActiveMeshes().data,h=this.renderList?this.renderList.length:n.getActiveMeshes().length;this.getCustomRenderList&&(o=this.getCustomRenderList(this.is2DArray||this.is3D?s:e,l,h)),o?this._prepareRenderingManager(o,o.length,r,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(l,h,r,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),o=l);for(const t of n._beforeRenderTargetClearStage)t.action(this,e,s);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(a):this.skipInitialClear||a.clear(this.clearColor||n.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||n.updateTransformMatrix(!0);for(const t of n._beforeRenderTargetDrawStage)t.action(this,e,s);this._renderingManager.render(this.customRenderFunction,o,this.renderParticles,this.renderSprites);for(const t of n._afterRenderTargetDrawStage)t.action(this,e,s);const c=this._texture?.generateMipMaps??!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,e,this._postProcesses,this.ignoreCameraViewport):t&&n.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,e);for(const t of n._afterRenderTargetPostProcessStage)t.action(this,e,s);this._texture&&(this._texture.generateMipMaps=c),this._doNotChangeAspectRatio||n.updateTransformMatrix(!0),i&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),a):u.V.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}this._unbindFrameBuffer(a,e),this._texture&&this.isCube&&5===e&&a.generateMipMapsForCubemap(this._texture,!0),a._debugPopGroup?.(1)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=this.getSize(),t=new d(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){this._renderTarget?.dispose(!0)}releaseInternalTexture(){this._renderTarget?.releaseTextures(),this._texture=null}dispose(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);t>=0&&e.customRenderTargets.splice(t,1);for(const i of e.cameras)t=i.customRenderTargets.indexOf(this),t>=0&&i.customRenderTargets.splice(t,1);this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===d.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=d.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}d.REFRESHRATE_RENDER_ONCE=0,d.REFRESHRATE_RENDER_ONEVERYFRAME=1,d.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,n.g._CreateRenderTargetTexture=(e,t,i,s,r)=>new d(e,t,i,s)},2781:(e,t,i)=>{"use strict";i.d(t,{g:()=>g});var s=i(5524),r=i(9259),n=i(9848),a=i(9923),o=i(2667),l=i(6552),h=i(5503),c=i(2940),u=i(9337),d=i(4100),_=i(6181);function p(e,t,i=!1){const s=t.width,r=t.height;if(e instanceof Float32Array){let t=e.byteLength/e.BYTES_PER_ELEMENT;const i=new Uint8Array(t);for(;--t>=0;){let s=e[t];s<0?s=0:s>1&&(s=1),i[t]=255*s}e=i}const n=document.createElement("canvas");n.width=s,n.height=r;const a=n.getContext("2d");if(!a)return null;const o=a.createImageData(s,r);if(o.data.set(e),a.putImageData(o,0,0),i){const e=document.createElement("canvas");e.width=s,e.height=r;const t=e.getContext("2d");return t?(t.translate(0,r),t.scale(1,-1),t.drawImage(n,0,0),e.toDataURL("image/png")):null}return n.toDataURL("image/png")}var f=i(1313),m=i(6877);class g extends o.t{static _CreateVideoTexture(e,t,i,s=!1,r=!1,n=g.TRILINEAR_SAMPLINGMODE,a={},o,l=5){throw(0,h.n)("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,s,r=g.TRILINEAR_SAMPLINGMODE,a=null,o=null,l=null,h=!1,u,d,_,p,m){let v;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedIdentity3x2=!0,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new n.cP,this._isBlocking=!0,this.name=e||"",this.url=e;let b=!1,x=null,S=!0;"object"==typeof i&&null!==i?(v=i.noMipmap??!1,s=i.invertY??!f.rX,r=i.samplingMode??g.TRILINEAR_SAMPLINGMODE,a=i.onLoad??null,o=i.onError??null,l=i.buffer??null,h=i.deleteBuffer??!1,u=i.format,d=i.mimeType,_=i.loaderOptions,p=i.creationFlags,b=i.useSRGBBuffer??!1,x=i.internalTexture??null,S=i.gammaSpace??S):v=!!i,this._gammaSpace=S,this._noMipmap=v,this._invertY=void 0===s?!f.rX:s,this._initialSamplingMode=r,this._buffer=l,this._deleteBuffer=h,this._mimeType=d,this._loaderOptions=_,this._creationFlags=p,this._useSRGBBuffer=b,this._forcedExtension=m,u&&(this._format=u);const T=this.getScene(),y=this._getEngine();if(!y)return;y.onBeforeTextureInitObservable.notifyObservers(this);const C=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),null!==this._texture._cachedWrapU&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),null!==this._texture._cachedWrapV&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),null!==this._texture._cachedWrapR&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),a&&a(),!this.isBlocking&&T&&T.resetCachedMaterial()},P=(e,t)=>{this._loadingError=!0,this._errorObject={message:e,exception:t},o&&o(e,t),g.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!x)return this._delayedOnLoad=C,void(this._delayedOnError=P);if(this._texture=x??this._getFromCache(this.url,v,r,this._invertY,b,this.isCube),this._texture)if(this._texture.isReady)c._.SetImmediate((()=>C()));else{const e=this._texture.onLoadedObservable.add(C);this._texture.onErrorObservable.add((t=>{P(t.message,t.exception),this._texture?.onLoadedObservable.remove(e)}))}else if(T&&T.useDelayedTextureLoading)this.delayLoadState=4,this._delayedOnLoad=C,this._delayedOnError=P;else{try{this._texture=y.createTexture(this.url,v,this._invertY,T,r,C,P,this._buffer,void 0,this._format,this._forcedExtension,d,_,p,b)}catch(e){throw P("error loading",e),e}h&&(this._buffer=null)}}updateURL(e,t=null,i,s){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,(e=>e.hasTexture(this)))),this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=s,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(4!==this.delayLoadState)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?c._.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,s){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,a.Pq.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,s),s.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,s.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,s.z+=this.wRotationCenter}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,this._cachedTextureMatrix&&this._rowGenerationMatrix||(this._cachedTextureMatrix=a.uq.Zero(),this._rowGenerationMatrix=new a.uq,this._t0=a.Pq.Zero(),this._t1=a.Pq.Zero(),this._t2=a.Pq.Zero()),a.uq.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(a.uq.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,a.AA.Matrix[0]),a.uq.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,a.AA.Matrix[1]),a.uq.ScalingToRef(this._cachedUScale,this._cachedVScale,0,a.AA.Matrix[2]),a.uq.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,a.AA.Matrix[3]),a.AA.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(a.AA.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(a.AA.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(a.AA.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),a.uq.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();if(!t)return this._cachedTextureMatrix;const i=this._cachedIdentity3x2;return this._cachedIdentity3x2=this._cachedTextureMatrix.isIdentityAs3x2(),this.optimizeUVAllocation&&i!==this._cachedIdentity3x2&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))),this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode){if(this.coordinatesMode!==g.PROJECTION_MODE)return this._cachedReflectionTextureMatrix;if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=a.uq.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=a.uq.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case g.PLANAR_MODE:a.uq.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break;case g.PROJECTION_MODE:{a.uq.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const t=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=t.updateFlag,t.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:a.uq.IdentityToRef(this._cachedReflectionTextureMatrix)}return t&&e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return m.p.Clone((()=>new g(this._texture?this._texture.url:null,this.getScene(),e)),this)}serialize(){const e=this.name;g.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const t=super.serialize(g._SerializeInternalTextureUniqueId);return t?((g.SerializeBuffers||g.ForceSerializeBuffers)&&("string"==typeof this._buffer&&"data:"===this._buffer.substring(0,5)?(t.base64String=this._buffer,t.name=t.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?t.base64String="data:image/png;base64,"+(0,_.EL)(this._buffer):(g.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(t.base64String=!this._engine||this._engine._features.supportSyncTextureRead?function(e,t=0,i=0){const s=e.getInternalTexture();if(!s)return null;const r=e._readPixelsSync(t,i);return r?p(r,e.getSize(),s.invertY):null}(this):async function(e,t=0,i=0){const s=e.getInternalTexture();if(!s)return null;const r=await e.readPixels(t,i);return r?p(r,e.getSize(),s.invertY):null}(this))),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t._creationFlags=this._creationFlags,t._useSRGBBuffer=this._useSRGBBuffer,g._SerializeInternalTextureUniqueId&&(t.internalTextureUniqueId=this._texture?.uniqueId??void 0),t.noMipmap=this._noMipmap,this.name=e,t):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const s=u.n.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&s.updateSamplingMode&&s._samplingMode&&s._samplingMode!==e.samplingMode&&s.updateSamplingMode(e.samplingMode),s}if(e.isCube&&!e.isRenderTarget)return g._CubeTextureParser(e,t,i);const s=void 0!==e.internalTextureUniqueId;if(!e.name&&!e.isRenderTarget&&!s)return null;let r;if(s){const i=t.getEngine().getLoadedTexturesCache();for(const t of i)if(t.uniqueId===e.internalTextureUniqueId){r=t;break}}const n=t=>{if(t&&t._texture&&(t._texture._cachedWrapU=null,t._texture._cachedWrapV=null,t._texture._cachedWrapR=null),e.samplingMode){const i=e.samplingMode;t&&t.samplingMode!==i&&t.updateSamplingMode(i)}if(t&&e.animations)for(let i=0;i<e.animations.length;i++){const s=e.animations[i],r=(0,l.n9)("BABYLON.Animation");r&&t.animations.push(r.Parse(s))}s&&!r&&t?._texture?._setUniqueId(e.internalTextureUniqueId)};return m.p.Parse((()=>{let s=!0;if(e.noMipmap&&(s=!1),e.mirrorPlane){const i=g._CreateMirror(e.name,e.renderTargetSize,t,s);return i._waitingRenderList=e.renderList,i.mirrorPlane=d.Z.FromArray(e.mirrorPlane),n(i),i}if(e.isRenderTarget){let i=null;if(e.isCube){if(t.reflectionProbes)for(let i=0;i<t.reflectionProbes.length;i++){const s=t.reflectionProbes[i];if(s.name===e.name)return s.cubeTexture}}else i=g._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,s,e._creationFlags??0),i._waitingRenderList=e.renderList;return n(i),i}if(e.isVideo){const r=g._CreateVideoTexture(i+(e.url||e.name),i+(e.src||e.url),t,s,e.invertY,e.samplingMode,e.settings||{});return n(r),r}{let a;if(e.base64String&&!r)a=g.CreateFromBase64String(e.base64String,e.base64String,t,!s,e.invertY,e.samplingMode,(()=>{n(a)}),e._creationFlags??0,e._useSRGBBuffer??!1),a.name=e.name;else{let o;o=e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?e.name:i+e.name,e.url&&(e.url.startsWith("data:")||g.UseSerializedUrlIfAny)&&(o=e.url);const l={noMipmap:!s,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{n(a)},internalTexture:r};a=new g(o,t,l)}return a}}),e,t)}static CreateFromBase64String(e,t,i,s,r,n=g.TRILINEAR_SAMPLINGMODE,a=null,o=null,l=5,h,c){return new g("data:"+t,i,s,r,n,a,o,e,!1,l,void 0,void 0,h,c)}static LoadFromDataString(e,t,i,s=!1,r,n=!0,a=g.TRILINEAR_SAMPLINGMODE,o=null,l=null,h=5,c,u){return"data:"!==e.substring(0,5)&&(e="data:"+e),new g(e,i,r,n,a,o,l,t,s,h,void 0,void 0,c,u)}}g.SerializeBuffers=!0,g.ForceSerializeBuffers=!1,g.OnTextureLoadErrorObservable=new n.cP,g._SerializeInternalTextureUniqueId=!1,g._CubeTextureParser=(e,t,i)=>{throw(0,h.n)("CubeTexture")},g._CreateMirror=(e,t,i,s)=>{throw(0,h.n)("MirrorTexture")},g._CreateRenderTargetTexture=(e,t,i,s,r)=>{throw(0,h.n)("RenderTargetTexture")},g.NEAREST_SAMPLINGMODE=1,g.NEAREST_NEAREST_MIPLINEAR=8,g.BILINEAR_SAMPLINGMODE=2,g.LINEAR_LINEAR_MIPNEAREST=11,g.TRILINEAR_SAMPLINGMODE=3,g.LINEAR_LINEAR_MIPLINEAR=3,g.NEAREST_NEAREST_MIPNEAREST=4,g.NEAREST_LINEAR_MIPNEAREST=5,g.NEAREST_LINEAR_MIPLINEAR=6,g.NEAREST_LINEAR=7,g.NEAREST_NEAREST=1,g.LINEAR_NEAREST_MIPNEAREST=9,g.LINEAR_NEAREST_MIPLINEAR=10,g.LINEAR_LINEAR=2,g.LINEAR_NEAREST=12,g.EXPLICIT_MODE=0,g.SPHERICAL_MODE=1,g.PLANAR_MODE=2,g.CUBIC_MODE=3,g.PROJECTION_MODE=4,g.SKYBOX_MODE=5,g.INVCUBIC_MODE=6,g.EQUIRECTANGULAR_MODE=7,g.FIXED_EQUIRECTANGULAR_MODE=8,g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,g.CLAMP_ADDRESSMODE=0,g.WRAP_ADDRESSMODE=1,g.MIRROR_ADDRESSMODE=2,g.UseSerializedUrlIfAny=!1,(0,s.Cg)([(0,r.lK)()],g.prototype,"url",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"uOffset",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"vOffset",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"uScale",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"vScale",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"uAng",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"vAng",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"wAng",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"uRotationCenter",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"vRotationCenter",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"wRotationCenter",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"homogeneousRotationInUVTransform",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"isBlocking",null),(0,l.Y5)("BABYLON.Texture",g),m.p._TextureParser=g.Parse},492:(e,t,i)=>{"use strict";function s(e){-1===e.indexOf("vClipPlane")&&e.push("vClipPlane"),-1===e.indexOf("vClipPlane2")&&e.push("vClipPlane2"),-1===e.indexOf("vClipPlane3")&&e.push("vClipPlane3"),-1===e.indexOf("vClipPlane4")&&e.push("vClipPlane4"),-1===e.indexOf("vClipPlane5")&&e.push("vClipPlane5"),-1===e.indexOf("vClipPlane6")&&e.push("vClipPlane6")}function r(e,t,i){const s=!!(e.clipPlane??t.clipPlane),r=!!(e.clipPlane2??t.clipPlane2),n=!!(e.clipPlane3??t.clipPlane3),a=!!(e.clipPlane4??t.clipPlane4),o=!!(e.clipPlane5??t.clipPlane5),l=!!(e.clipPlane6??t.clipPlane6);s&&i.push("#define CLIPPLANE"),r&&i.push("#define CLIPPLANE2"),n&&i.push("#define CLIPPLANE3"),a&&i.push("#define CLIPPLANE4"),o&&i.push("#define CLIPPLANE5"),l&&i.push("#define CLIPPLANE6")}function n(e,t,i){let s=!1;const r=!!(e.clipPlane??t.clipPlane),n=!!(e.clipPlane2??t.clipPlane2),a=!!(e.clipPlane3??t.clipPlane3),o=!!(e.clipPlane4??t.clipPlane4),l=!!(e.clipPlane5??t.clipPlane5),h=!!(e.clipPlane6??t.clipPlane6);return i.CLIPPLANE!==r&&(i.CLIPPLANE=r,s=!0),i.CLIPPLANE2!==n&&(i.CLIPPLANE2=n,s=!0),i.CLIPPLANE3!==a&&(i.CLIPPLANE3=a,s=!0),i.CLIPPLANE4!==o&&(i.CLIPPLANE4=o,s=!0),i.CLIPPLANE5!==l&&(i.CLIPPLANE5=l,s=!0),i.CLIPPLANE6!==h&&(i.CLIPPLANE6=h,s=!0),s}function a(e,t,i){let s=t.clipPlane??i.clipPlane;o(e,"vClipPlane",s),s=t.clipPlane2??i.clipPlane2,o(e,"vClipPlane2",s),s=t.clipPlane3??i.clipPlane3,o(e,"vClipPlane3",s),s=t.clipPlane4??i.clipPlane4,o(e,"vClipPlane4",s),s=t.clipPlane5??i.clipPlane5,o(e,"vClipPlane5",s),s=t.clipPlane6??i.clipPlane6,o(e,"vClipPlane6",s)}function o(e,t,i){i&&e.setFloat4(t,i.normal.x,i.normal.y,i.normal.z,i.d)}i.d(t,{Eq:()=>n,TV:()=>s,gS:()=>a,tv:()=>r})},5476:(e,t,i)=>{"use strict";i.d(t,{E:()=>s});class s{static GetEffect(e){return void 0===e.getPipelineContext?e.effect:e}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){this.effect=e,void 0!==t&&(this.defines=t),i&&this.drawContext?.reset()}dispose(){this.drawContext?.dispose()}}},7647:(e,t,i)=>{"use strict";i.d(t,{b4:()=>h,bu:()=>u,mO:()=>c,uR:()=>_});var s=i(8790),r=i(5852),n=i(9610),a=i(1137),o=i(9125),l=i(6741);function h(e,t){return(0,r.N5)(t).cachedPipelines[e]}function c(e){const t=e._name,i=e.context;if(t&&i){const e=(0,r.N5)(i),s=e.cachedPipelines[t];s?.dispose(),delete e.cachedPipelines[t]}}function u(e,t,i,r,n,a,l){let h,c;const u=(0,s.BA)()?a?.getHostDocument():null;h="string"==typeof t?t:t.vertexSource?"source:"+t.vertexSource:t.vertexElement?u?.getElementById(t.vertexElement)||t.vertexElement:t.vertex||t,c="string"==typeof t?t:t.fragmentSource?"source:"+t.fragmentSource:t.fragmentElement?u?.getElementById(t.fragmentElement)||t.fragmentElement:t.fragment||t;const _=[void 0,void 0],p=()=>{if(_[0]&&_[1]){e.isFragment=!0;const[s,h]=_;(0,o.M0)(h,e,((a,h)=>{l&&(l._fragmentSourceCodeBeforeMigration=h),i&&(a=i("fragment",a));const c=(0,o.nO)(s,a,e);e=null;const u=function(e,t,i,s){return i?{vertexSourceCode:(1===s?"//":"")+"#define SHADER_NAME vertex:"+(i.vertexElement||i.vertex||i.spectorName||i)+"\n"+e,fragmentSourceCode:(1===s?"//":"")+"#define SHADER_NAME fragment:"+(i.fragmentElement||i.fragment||i.spectorName||i)+"\n"+t}:{vertexSourceCode:e,fragmentSourceCode:t}}(c.vertexCode,c.fragmentCode,t,n);r?.(u.vertexSourceCode,u.fragmentSourceCode)}),a)}};d(h,"Vertex","",(t=>{(0,o.pB)(e),(0,o.M0)(t,e,((e,s)=>{l&&(l._rawVertexSourceCode=t,l._vertexSourceCodeBeforeMigration=s),i&&(e=i("vertex",e)),_[0]=e,p()}),a)}),n),d(c,"Fragment","Pixel",(e=>{l&&(l._rawFragmentSourceCode=e),_[1]=e,p()}),n)}function d(e,t,i,r,a,o){if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)return void r((0,s.Zl)(e));if("source:"===e.substring(0,7))return void r(e.substring(7));if("base64:"===e.substring(0,7))return void r(window.atob(e.substring(7)));const h=n.l.GetShadersStore(a);if(h[e+t+"Shader"])return void r(h[e+t+"Shader"]);if(i&&h[e+i+"Shader"])return void r(h[e+i+"Shader"]);let c;if(c="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:n.l.GetShadersRepository(a)+e,!(o=o||l.W0))throw new Error("loadFileInjection is not defined");o(c+"."+t.toLowerCase()+".fx",r)}const _=(e,t,i,s)=>{try{const n=e.existingPipelineContext||t(e.shaderProcessingContext);return n._name=e.name,e.name&&e.context&&((0,r.N5)(e.context).cachedPipelines[e.name]=n),i(n,e.vertex,e.fragment,!!e.createAsRaw,"","",e.rebuildRebind,e.defines,e.transformFeedbackVaryings,"",(()=>{s(n,(()=>{e.onRenderingStateCompiled?.(n)}))})),n}catch(e){throw a.V.Error("Error compiling effect"),e}}},4420:(e,t,i)=>{"use strict";i.d(t,{M:()=>o});var s=i(9848),r=i(1137),n=i(9610),a=i(7647);class o{static get ShadersRepository(){return n.l.ShadersRepository}static set ShadersRepository(e){n.l.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new s.cP),this._onBindObservable}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r=null,n,l=null,h=null,c=null,u=null,d,_="",p=0,f){this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new s.cP,this.onErrorObservable=new s.cP,this._onBindObservable=null,this._isDisposed=!1,this._refCount=1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=_;const m=this._key.replace(/\r/g,"").replace(/\n/g,"|");let g;if(t.attributes){const e=t;if(this._engine=i,this._attributesNames=e.attributes,this._uniformsNames=e.uniformsNames.concat(e.samplers),this._samplerList=e.samplers.slice(),this.defines=e.defines,this.onError=e.onError,this.onCompiled=e.onCompiled,this._fallbacks=e.fallbacks,this._indexParameters=e.indexParameters,this._transformFeedbackVaryings=e.transformFeedbackVaryings||null,this._multiTarget=!!e.multiTarget,this._shaderLanguage=e.shaderLanguage??0,e.uniformBuffersNames){this._uniformBuffersNamesList=e.uniformBuffersNames.slice();for(let t=0;t<e.uniformBuffersNames.length;t++)this._uniformBuffersNames[e.uniformBuffersNames[t]]=t}this._processFinalCode=e.processFinalCode??null,this._processCodeAfterIncludes=e.processCodeAfterIncludes??void 0,g=e.existingPipelineContext}else this._engine=n,this.defines=null==l?"":l,this._uniformsNames=i.concat(r),this._samplerList=r?r.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=p,this.onError=u,this.onCompiled=c,this._indexParameters=d,this._fallbacks=h;"WEBGL2"===this._engine.shaderPlatformName&&(g=(0,a.b4)(m,this._engine._gl)??g),this._attributeLocationByName={},this.uniqueId=o._UniqueIdSeed++,g?(this._pipelineContext=g,this._pipelineContext.setEngine(this._engine),this._onRenderingStateCompiled(this._pipelineContext),this._pipelineContext.program&&(this._pipelineContext.program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this))):this._processShaderCodeAsync(null,!1,null,f)}async _processShaderCodeAsync(e=null,t=!1,i=null,s){s&&await s(),this._processingContext=i||this._engine._getShaderProcessingContext(this._shaderLanguage,!1);const r={defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:e??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:n.l.GetShadersRepository(this._shaderLanguage),includesShadersStore:n.l.GetIncludesShadersStore(this._shaderLanguage),version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};(0,a.bu)(r,this.name,this._processFinalCode,((e,i)=>{this._vertexSourceCode=e,this._fragmentSourceCode=i,this._prepareEffect(t)}),this._shaderLanguage,this._engine,this)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return!!this._engine.isDisposed||!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add((t=>{e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||setTimeout((()=>{this._checkIsReady(null)}),16))}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){return void this._processCompilationErrors(t,e)}this._isDisposed||setTimeout((()=>{this._checkIsReady(e)}),16)}get vertexSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._pipelineContext?._getVertexShaderCode()??this._vertexSourceCode}get fragmentSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._pipelineContext?._getFragmentShaderCode()??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}getPipelineGenerationOptions(){return{platformName:this._engine.shaderPlatformName,shaderLanguage:this._shaderLanguage,shaderNameOrContent:this.name,key:this._key,defines:this.defines.split("\n"),addGlobalDefines:!1,extendedProcessingOptions:{indexParameters:this._indexParameters,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,supportsUniformBuffers:this._engine.supportsUniformBuffers},extendedCreatePipelineOptions:{transformFeedbackVaryings:this._transformFeedbackVaryings,createAsRaw:!(!this._vertexSourceCodeOverride||!this._fragmentSourceCodeOverride)}}}_rebuildProgram(e,t,i,s){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(e,t)=>{s&&s(t)},this.onCompiled=()=>{const e=this.getEngine().scenes;if(e)for(let t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback?.(i)},this._fallbacks=null,this._prepareEffect()}_onRenderingStateCompiled(e){if(this._pipelineContext=e,this._pipelineContext.setEngine(this._engine),this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,this._attributesNames,this._attributes),this._attributesNames)for(let e=0;e<this._attributesNames.length;e++){const t=this._attributesNames[e];this._attributeLocationByName[t]=this._attributes[e]}this._engine.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh()}_prepareEffect(e=!1){const t=this._pipelineContext;this._isReady=!1;try{const i=!(!this._vertexSourceCodeOverride||!this._fragmentSourceCodeOverride),s=i?null:this.defines,r=i?this._vertexSourceCodeOverride:this._vertexSourceCode,n=i?this._fragmentSourceCodeOverride:this._fragmentSourceCode,o=this._engine;this._pipelineContext=(0,a.uR)({existingPipelineContext:e?t:null,vertex:r,fragment:n,context:"WEBGL2"===o.shaderPlatformName?o._gl:void 0,rebuildRebind:(e,t,i,s)=>this._rebuildProgram(e,t,i,s),defines:s,transformFeedbackVaryings:this._transformFeedbackVaryings,name:this._key.replace(/\r/g,"").replace(/\n/g,"|"),createAsRaw:i,parallelShaderCompile:o._caps.parallelShaderCompile,shaderProcessingContext:this._processingContext,onRenderingStateCompiled:i=>{t&&!e&&this._engine._deletePipelineContext(t),i&&this._onRenderingStateCompiled(i)}},this._engine.createPipelineContext.bind(this._engine),this._engine._preparePipelineContext.bind(this._engine),this._engine._executeWhenRenderingStateIsCompiled.bind(this._engine)),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(e){this._processCompilationErrors(e,t)}}_getShaderCodeAndErrorLine(e,t,i){const s=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let r=null;if(t&&e){const n=t.match(s);if(n&&2===n.length){const t=parseInt(n[1]),s=e.split("\n",-1);s.length>=t&&(r=`Offending line [${t}] in ${i?"fragment":"vertex"} code: ${s[t-1]}`)}}return[e,r]}_processCompilationErrors(e,t=null){this._compilationError=e.message;const i=this._attributesNames,s=this._fallbacks;if(r.V.Error("Unable to compile effect:"),r.V.Error("Uniforms: "+this._uniformsNames.map((function(e){return" "+e}))),r.V.Error("Attributes: "+i.map((function(e){return" "+e}))),r.V.Error("Defines:\n"+this.defines),o.LogShaderCodeOnCompilationError){let e=null,t=null,i=null;this._pipelineContext?._getVertexShaderCode()&&([i,e]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),i&&(r.V.Error("Vertex code:"),r.V.Error(i))),this._pipelineContext?._getFragmentShaderCode()&&([i,t]=this._getShaderCodeAndErrorLine(this._pipelineContext?._getFragmentShaderCode(),this._compilationError,!0),i&&(r.V.Error("Fragment code:"),r.V.Error(i))),e&&r.V.Error(e),t&&r.V.Error(t)}r.V.Error("Error: "+this._compilationError);const n=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,n()),s?(this._pipelineContext=null,s.hasMoreFallbacks?(this._allFallbacksProcessed=!1,r.V.Error("Trying next fallback."),this.defines=s.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,n(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||n())}get isSupported(){return""===this._compilationError}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(-1===this._samplerList.indexOf(i+"0")){const s=this._samplerList.indexOf(e);for(let e=1;e<t.length;e++){const t=i+(e-1).toString();this._samplerList.splice(s+e,0,t)}let r=0;for(const e of this._samplerList)this._samplers[e]=r,r+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];void 0===i||o._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(o._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,s){return this._pipelineContext.setInt3(e,t,i,s),this}setInt4(e,t,i,s,r){return this._pipelineContext.setInt4(e,t,i,s,r),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setUInt2(e,t,i),this}setUInt3(e,t,i,s){return this._pipelineContext.setUInt3(e,t,i,s),this}setUInt4(e,t,i,s,r){return this._pipelineContext.setUInt4(e,t,i,s,r),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,s){return this._pipelineContext.setFloat3(e,t,i,s),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,s,r){return this._pipelineContext.setFloat4(e,t,i,s,r),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}dispose(){this._refCount--,this._refCount>0||(this._pipelineContext&&(0,a.mO)(this._pipelineContext),this._engine._releaseEffect(this),this._isDisposed=!0)}static RegisterShader(e,t,i,s=0){t&&(n.l.GetShadersStore(s)[`${e}PixelShader`]=t),i&&(n.l.GetShadersStore(s)[`${e}VertexShader`]=i)}static ResetCache(){o._BaseCache={}}}o.LogShaderCodeOnCompilationError=!0,o._UniqueIdSeed=0,o._BaseCache={},o.ShadersStore=n.l.ShadersStore,o.IncludesShadersStore=n.l.IncludesShadersStore},1088:(e,t,i)=>{"use strict";i.d(t,{p:()=>d});var s=i(5524),r=i(9259),n=i(9848),a=i(6041),o=i(6877);function l(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}class h{constructor(){this._dirty=!0,this._tempColor=new a.ov(0,0,0,0),this._globalCurve=new a.ov(0,0,0,0),this._highlightsCurve=new a.ov(0,0,0,0),this._midtonesCurve=new a.ov(0,0,0,0),this._shadowsCurve=new a.ov(0,0,0,0),this._positiveCurve=new a.ov(0,0,0,0),this._negativeCurve=new a.ov(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",s="vCameraColorCurveNeutral",r="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(s,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(r,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}_getColorGradingDataToRef(e,t,i,s,r){null!=e&&(e=h._Clamp(e,0,360),t=h._Clamp(t,-100,100),i=h._Clamp(i,-100,100),s=h._Clamp(s,-100,100),t=h._ApplyColorGradingSliderNonlinear(t),t*=.5,s=h._ApplyColorGradingSliderNonlinear(s),t<0&&(t*=-1,e=(e+180)%360),h._FromHSBToRef(e,t,50+.25*s,r),r.scaleToRef(2,r),r.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,s){let r=h._Clamp(e,0,360);const n=h._Clamp(t/100,0,1),a=h._Clamp(i/100,0,1);if(0===n)s.r=a,s.g=a,s.b=a;else{r/=60;const e=Math.floor(r),t=r-e,i=a*(1-n),o=a*(1-n*t),l=a*(1-n*(1-t));switch(e){case 0:s.r=a,s.g=l,s.b=i;break;case 1:s.r=o,s.g=a,s.b=i;break;case 2:s.r=i,s.g=a,s.b=l;break;case 3:s.r=i,s.g=o,s.b=a;break;case 4:s.r=l,s.g=i,s.b=a;break;default:s.r=a,s.g=i,s.b=o}}s.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return o.p.Clone((()=>new h),this)}serialize(){return o.p.Serialize(this)}static Parse(e){return o.p.Parse((()=>new h),e,null,null)}}h.PrepareUniforms=l,(0,s.Cg)([(0,r.lK)()],h.prototype,"_globalHue",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_globalDensity",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_globalSaturation",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_globalExposure",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_highlightsHue",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_highlightsDensity",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_highlightsSaturation",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_highlightsExposure",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_midtonesHue",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_midtonesDensity",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_midtonesSaturation",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_midtonesExposure",void 0),o.p._ColorCurvesParser=h.Parse;var c=i(1597),u=i(6552);class d{constructor(){this.colorCurves=new h,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=d.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new a.ov(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=d.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new n.cP}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled)return e.VIGNETTE=!1,e.TONEMAPPING=0,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled);if(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===d._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,this._toneMappingEnabled)switch(this._toneMappingType){case d.TONEMAPPING_KHR_PBR_NEUTRAL:e.TONEMAPPING=3;break;case d.TONEMAPPING_ACES:e.TONEMAPPING=2;break;default:e.TONEMAPPING=1}else e.TONEMAPPING=0;e.CONTRAST=1!==this.contrast,e.EXPOSURE=1!==this.exposure,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||!!e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&h.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),s=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,s),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const r=null!=t?t:s/i;let n=Math.tan(.5*this.vignetteCameraFov),a=n*r;const o=Math.sqrt(a*n);a=(0,c.zF)(a,o,this.vignetteStretch),n=(0,c.zF)(n,o,this.vignetteStretch),e.setFloat4("vignetteSettings1",a,n,-a*this.vignetteCenterX,-n*this.vignetteCenterY);const l=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,l)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const t=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(t-1)/t,.5/t,t,this.colorGradingTexture.level)}}clone(){return o.p.Clone((()=>new d),this)}serialize(){return o.p.Serialize(this)}static Parse(e){const t=o.p.Parse((()=>new d),e,null,null);return void 0!==e.vignetteCentreX&&(t.vignetteCenterX=e.vignetteCentreX),void 0!==e.vignetteCentreY&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}d.TONEMAPPING_STANDARD=0,d.TONEMAPPING_ACES=1,d.TONEMAPPING_KHR_PBR_NEUTRAL=2,d.PrepareUniforms=function(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&l(e),t.DITHER&&e.push("ditherIntensity")},d.PrepareSamplers=function(e,t){t.COLORGRADING&&e.push("txColorTransform")},d._VIGNETTEMODE_MULTIPLY=0,d._VIGNETTEMODE_OPAQUE=1,(0,s.Cg)([(0,r.wL)()],d.prototype,"colorCurves",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_colorCurvesEnabled",void 0),(0,s.Cg)([(0,r.uM)("colorGradingTexture")],d.prototype,"_colorGradingTexture",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_colorGradingEnabled",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_colorGradingWithGreenDepth",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_colorGradingBGR",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_exposure",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_toneMappingEnabled",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_toneMappingType",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_contrast",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"vignetteStretch",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"vignetteCenterX",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"vignetteCenterY",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"vignetteWeight",void 0),(0,s.Cg)([(0,r.qK)()],d.prototype,"vignetteColor",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"vignetteCameraFov",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_vignetteBlendMode",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_vignetteEnabled",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_ditheringEnabled",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_ditheringIntensity",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_skipFinalColorClamp",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_applyByPostProcess",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"_isEnabled",void 0),o.p._ImageProcessingConfigurationParser=d.Parse,(0,u.Y5)("BABYLON.ImageProcessingConfiguration",d)},8986:(e,t,i)=>{"use strict";i.d(t,{i:()=>m});var s=i(5524),r=i(9259),n=i(998),a=i(9848),o=i(6315),l=i(5907),h=i(935),c=i(1137),u=i(4100),d=i(5476),_=i(6877);class p{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){_.p.Clone((()=>e),this)}serialize(){return _.p.Serialize(this)}parse(e,t,i){_.p.Parse((()=>this),e,t,i)}}(0,s.Cg)([(0,r.lK)()],p.prototype,"func",null),(0,s.Cg)([(0,r.lK)()],p.prototype,"funcRef",null),(0,s.Cg)([(0,r.lK)()],p.prototype,"funcMask",null),(0,s.Cg)([(0,r.lK)()],p.prototype,"opStencilFail",null),(0,s.Cg)([(0,r.lK)()],p.prototype,"opDepthFail",null),(0,s.Cg)([(0,r.lK)()],p.prototype,"opStencilDepthPass",null),(0,s.Cg)([(0,r.lK)()],p.prototype,"mask",null),(0,s.Cg)([(0,r.lK)()],p.prototype,"enabled",null);var f=i(467);class m{get shaderLanguage(){return this._shaderLanguage}get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,1!==t&&1!==e||this.markAsDirty(m.MiscDirtyFlag+m.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(m.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(m.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new a.cP),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new a.cP),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new a.cP),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(m.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(m.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case m.WireFrameFillMode:case m.LineListDrawMode:case m.LineLoopDrawMode:case m.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?m.WireFrameFillMode:m.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case m.PointFillMode:case m.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?m.PointFillMode:m.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(m.MiscDirtyFlag))}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=this.getScene().getEngine().getCaps().fragmentDepthSupported;e&&!t&&c.V.Warn("Logarithmic depth has been requested for a material on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._markAllSubMeshesAsMiscDirty()}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this._shaderLanguage=0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.sideOrientation=null,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new a.cP,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new p,this._useUBO=!1,this._fillMode=m.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const s=t||o.q.LastCreatedScene;s&&(this._scene=s,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||n.S0.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new d.E(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._uniformBuffer=new h.D(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),m.OnEventObservable.notifyObservers(this,1))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const s=t.materialDefines;return!!s&&(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh)}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}_getEffectiveOrientation(e){return null!==this.sideOrientation?this.sideOrientation:e.sideOrientation}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===m.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===m.MATERIAL_OPAQUE||this._transparencyMode===m.MATERIAL_ALPHATEST}needAlphaBlending(){return!this._disableAlphaBlending&&this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1||!this._disableAlphaBlending&&(e.hasVertexAlpha||this.needAlphaBlending())}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const t of i.subMeshes)if(t.getMaterial()===this)for(const i of t._drawWrappers)i&&this._materialContext===i.materialContext&&(i._wasPreviouslyReady=!1,i._wasPreviouslyUsingInstances=null,i._forceRebindOnNextCall=e);e&&this.markAsDirty(m.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),s=(null==t?this.sideOrientation:t)===m.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,s,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(8,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const s=i._drawWrapper;this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),s._forceRebindOnNextCall=!1}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null,i){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,(0,f._8)(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),this._scene._cachedVisibility=e?e.visibility:1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const e=this._scene.getEngine();this._cachedDepthWriteState=e.getDepthWrite(),e.setDepthWrite(!1)}if(this.disableColorWrite){const e=this._scene.getEngine();this._cachedColorWriteState=e.getColorWrite(),e.setColorWrite(!1)}if(0!==this.depthFunction){const e=this._scene.getEngine();this._cachedDepthFunctionState=e.getDepthFunction()||0,e.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),0!==this.depthFunction&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(256,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(512,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(1024,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){const i={};if(this._serializePlugins(i),m._ParsePlugins(i,e,this._scene,t),this.pluginManager)for(const t of this.pluginManager._plugins){const i=e.pluginManager.getPlugin(t.name);i&&t.copyTo(i)}}getBindedMeshes(){if(this.meshMap){const e=[];for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}return this._scene.meshes.filter((e=>e.material===this))}forceCompilation(e,t,i,s){const r={clipPlane:!1,useInstances:!1,...i},n=this.getScene(),a=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const o=()=>{if(!this._scene||!this._scene.getEngine())return;const i=n.clipPlane;if(r.clipPlane&&(n.clipPlane=new u.Z(0,0,0,1)),this._storeEffectOnSubMeshes){let i=!0,n=null;if(e.subMeshes){const t=new l.K(0,0,0,0,0,e,void 0,!1,!1);t.materialDefines&&(t.materialDefines._renderId=-1),this.isReadyForSubMesh(e,t,r.useInstances)||(t.effect&&t.effect.getCompilationError()&&t.effect.allFallbacksProcessed()?n=t.effect.getCompilationError():(i=!1,setTimeout(o,16)))}i&&(this.allowShaderHotSwapping=a,n&&s&&s(n),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=a,t&&t(this)):setTimeout(o,16);r.clipPlane&&(n.clipPlane=i)};o()}forceCompilationAsync(e,t){return new Promise(((i,s)=>{this.forceCompilation(e,(()=>{i()}),t,(e=>{s(e)}))}))}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(m._DirtyCallbackArray.length=0,e&m.TextureDirtyFlag&&m._DirtyCallbackArray.push(m._TextureDirtyCallBack),e&m.LightDirtyFlag&&m._DirtyCallbackArray.push(m._LightsDirtyCallBack),e&m.FresnelDirtyFlag&&m._DirtyCallbackArray.push(m._FresnelDirtyCallBack),e&m.AttributesDirtyFlag&&m._DirtyCallbackArray.push(m._AttributeDirtyCallBack),e&m.MiscDirtyFlag&&m._DirtyCallbackArray.push(m._MiscDirtyCallBack),e&m.PrePassDirtyFlag&&m._DirtyCallbackArray.push(m._PrePassDirtyCallBack),m._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(m._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const e of t.subMeshes)e.getMaterial()===this&&e.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const t of i.subMeshes)if(t.getMaterial(!1)===this)for(const i of t._drawWrappers)i&&i.defines&&i.defines.markAllAsDirty&&this._materialContext===i.materialContext&&e(i.defines)}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(m._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(m._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(m._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(m._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(m._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(m._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(m._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(m._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(m._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(m._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(0!==this._scene.performancePriority){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce((()=>{this.checkReadyOnlyOnce=!1}));this.onDisposeObservable.add((()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)}))}}setPrePassRenderer(e){return!1}dispose(e,t,i){const s=this.getScene();if(s.stopAnimation(this),s.freeProcessedMaterials(),s.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(2,this._eventInfo),this._parentContainer){const e=this._parentContainer.materials.indexOf(this);e>-1&&this._parentContainer.materials.splice(e,1),this._parentContainer=null}if(!0!==i)if(this.meshMap)for(const t in this.meshMap){const i=this.meshMap[t];i&&(i.material=null,this.releaseVertexArrayObject(i,e))}else{const t=s.meshes;for(const i of t)i.material!==this||i.sourceMesh||(i.material=null,this.releaseVertexArrayObject(i,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){const i=e.geometry;if(i)if(this._storeEffectOnSubMeshes){if(e.subMeshes)for(const s of e.subMeshes)i._releaseVertexArrayObject(s.effect),t&&s.effect&&s.effect.dispose()}else i._releaseVertexArrayObject(this._drawWrapper.effect)}serialize(){const e=_.p.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(const t of this.pluginManager._plugins)e.plugins[t.getClassName()]=t.serialize()}static Parse(e,t,i){if(e.customType){if("BABYLON.PBRMaterial"===e.customType&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return c.V.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null}else e.customType="BABYLON.StandardMaterial";const s=n.S0.Instantiate(e.customType).Parse(e,t,i);return s._loadedUniqueId=e.uniqueId,s}static _ParsePlugins(e,t,i,s){if(e.plugins)for(const r in e.plugins){const a=e.plugins[r];let o=t.pluginManager?.getPlugin(a.name);if(!o){const e=n.S0.Instantiate("BABYLON."+r);e&&(o=new e(t))}o?.parse(a,i,s)}}}m.TriangleFillMode=0,m.WireFrameFillMode=1,m.PointFillMode=2,m.PointListDrawMode=3,m.LineListDrawMode=4,m.LineLoopDrawMode=5,m.LineStripDrawMode=6,m.TriangleStripDrawMode=7,m.TriangleFanDrawMode=8,m.ClockWiseSideOrientation=0,m.CounterClockWiseSideOrientation=1,m.TextureDirtyFlag=1,m.LightDirtyFlag=2,m.FresnelDirtyFlag=4,m.AttributesDirtyFlag=8,m.MiscDirtyFlag=16,m.PrePassDirtyFlag=32,m.AllDirtyFlag=63,m.MATERIAL_OPAQUE=0,m.MATERIAL_ALPHATEST=1,m.MATERIAL_ALPHABLEND=2,m.MATERIAL_ALPHATESTANDBLEND=3,m.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,m.MATERIAL_NORMALBLENDMETHOD_RNM=1,m.OnEventObservable=new a.cP,m._AllDirtyCallBack=e=>e.markAllAsDirty(),m._ImageProcessingDirtyCallBack=e=>e.markAsImageProcessingDirty(),m._TextureDirtyCallBack=e=>e.markAsTexturesDirty(),m._FresnelDirtyCallBack=e=>e.markAsFresnelDirty(),m._MiscDirtyCallBack=e=>e.markAsMiscDirty(),m._PrePassDirtyCallBack=e=>e.markAsPrePassDirty(),m._LightsDirtyCallBack=e=>e.markAsLightDirty(),m._AttributeDirtyCallBack=e=>e.markAsAttributesDirty(),m._FresnelAndMiscDirtyCallBack=e=>{m._FresnelDirtyCallBack(e),m._MiscDirtyCallBack(e)},m._TextureAndMiscDirtyCallBack=e=>{m._TextureDirtyCallBack(e),m._MiscDirtyCallBack(e)},m._DirtyCallbackArray=[],m._RunDirtyCallBacks=e=>{for(const t of m._DirtyCallbackArray)t(e)},(0,s.Cg)([(0,r.lK)()],m.prototype,"id",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"uniqueId",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"name",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"metadata",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"checkReadyOnEveryCall",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"checkReadyOnlyOnce",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"state",void 0),(0,s.Cg)([(0,r.lK)("alpha")],m.prototype,"_alpha",void 0),(0,s.Cg)([(0,r.lK)("backFaceCulling")],m.prototype,"_backFaceCulling",void 0),(0,s.Cg)([(0,r.lK)("cullBackFaces")],m.prototype,"_cullBackFaces",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"sideOrientation",void 0),(0,s.Cg)([(0,r.lK)("alphaMode")],m.prototype,"_alphaMode",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"_needDepthPrePass",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"disableDepthWrite",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"disableColorWrite",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"forceDepthWrite",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"depthFunction",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"separateCullingPass",void 0),(0,s.Cg)([(0,r.lK)("fogEnabled")],m.prototype,"_fogEnabled",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"pointSize",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"zOffset",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"zOffsetUnits",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"pointsCloud",null),(0,s.Cg)([(0,r.lK)()],m.prototype,"fillMode",null),(0,s.Cg)([(0,r.lK)()],m.prototype,"useLogarithmicDepth",null),(0,s.Cg)([(0,r.lK)()],m.prototype,"transparencyMode",null)},9526:(e,t,i)=>{"use strict";i.d(t,{M:()=>s});class s{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!1,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))"_"!==e[0]&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)-1===this._keys.indexOf(e)&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach((e=>this._setDefaultValue(e)))}_setDefaultValue(e){const t=this._externalProperties?.[e]?.type??typeof this[e],i=this._externalProperties?.[e]?.default;switch(t){case"number":this[e]=i??0;break;case"string":this[e]=i??"";break;default:this[e]=i??!1}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=this[i];switch(typeof s){case"number":case"string":e+="#define "+i+" "+s+"\n";break;default:s&&(e+="#define "+i+"\n")}}return e}}},467:(e,t,i)=>{"use strict";i.d(t,{Bb:()=>V,DL:()=>c,ER:()=>C,GD:()=>k,IC:()=>O,IF:()=>_,J2:()=>b,Jz:()=>w,Kd:()=>S,MF:()=>d,N4:()=>L,Nc:()=>N,OR:()=>M,RL:()=>T,VO:()=>F,Y7:()=>B,YT:()=>g,Yy:()=>u,_8:()=>m,az:()=>R,c4:()=>P,f$:()=>x,fm:()=>A,lo:()=>I,mA:()=>v,nR:()=>f,ni:()=>y,qB:()=>D,qL:()=>E,te:()=>p});var s=i(1137),r=i(6041),n=i(6315),a=i(5515),o=i(492);const l=r.v9.Black(),h={NUM_MORPH_INFLUENCERS:0};function c(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const e=i.activeCamera;1===e.mode&&s.V.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(e.maxZ+1)/Math.LN2))}}function u(e,t,i,s=!1){i&&e.fogEnabled&&(!t||t.applyFog)&&0!==e.fogMode&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),s?(e.fogColor.toLinearSpaceToRef(l,e.getEngine().useExactSrgbConversions),i.setColor3("vFogColor",l)):i.setColor3("vFogColor",e.fogColor))}function d(e,t,i){h.NUM_MORPH_INFLUENCERS=i,_(e,t,h)}function _(e,t,i){const r=i.NUM_MORPH_INFLUENCERS;if(r>0&&n.q.LastCreatedEngine){const a=n.q.LastCreatedEngine.getCaps().maxVertexAttribs,o=t.morphTargetManager;if(o?.isUsingTextureForTargets)return;const l=o&&o.supportsNormals&&i.NORMAL,h=o&&o.supportsTangents&&i.TANGENT,c=o&&o.supportsUVs&&i.UV1;for(let i=0;i<r;i++)e.push("position"+i),l&&e.push("normal"+i),h&&e.push("tangent"+i),c&&e.push("uv_"+i),e.length>a&&s.V.Error("Cannot add more vertex attributes for mesh "+t.name)}}function p(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}function f(e,t){const i=e.morphTargetManager;e&&i&&t.setFloatArray("morphTargetInfluences",i.influences)}function m(e,t){t.bindToEffect(e,"Scene")}function g(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}function v(e,t,i){const s=e.getTextureMatrix();t.updateMatrix(i+"Matrix",s)}function b(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}function x(e,t,i){var s;if(t&&e&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const r=e.skeleton;if(r.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const i=r.getTransformMatrixTexture(e);t.setTexture("boneSampler",i),t.setFloat("boneTextureWidth",4*(r.bones.length+1))}else{const n=r.getTransformMatrices(e);n&&(t.setMatrices("mBones",n),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=n.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),s=n,i.previousBones[e.uniqueId].set(s)))}}}function S(e,t,i,s,r,n=!0){e._bindLight(t,i,s,r,n)}function T(e,t,i,s,r=4){const n=Math.min(t.lightSources.length,r);for(let r=0;r<n;r++)S(t.lightSources[r],r,e,i,"boolean"==typeof s?s:s.SPECULARTERM,t.receiveShadows)}function y(e,t,i,s){i.NUM_BONE_INFLUENCERS>0&&(s.addCPUSkinningFallback(0,t),e.push("matricesIndices"),e.push("matricesWeights"),i.NUM_BONE_INFLUENCERS>4&&(e.push("matricesIndicesExtra"),e.push("matricesWeightsExtra")))}function C(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&p(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push("instanceColor")}function P(e,t,i=4,s=0){let r=0;for(let n=0;n<i&&e["LIGHT"+n];n++)n>0&&(r=s+n,t.addFallback(r,"LIGHT"+n)),e.SHADOWS||(e["SHADOW"+n]&&t.addFallback(s,"SHADOW"+n),e["SHADOWPCF"+n]&&t.addFallback(s,"SHADOWPCF"+n),e["SHADOWPCSS"+n]&&t.addFallback(s,"SHADOWPCSS"+n),e["SHADOWPOISSON"+n]&&t.addFallback(s,"SHADOWPOISSON"+n),e["SHADOWESM"+n]&&t.addFallback(s,"SHADOWESM"+n),e["SHADOWCLOSEESM"+n]&&t.addFallback(s,"SHADOWCLOSEESM"+n));return r++}function E(e,t){return t.fogEnabled&&e.applyFog&&0!==t.fogMode}function A(e,t,i,s,r,n,a,o=!1){a._areMiscDirty&&(a.LOGARITHMICDEPTH=i,a.POINTSIZE=s,a.FOG=r&&E(e,t),a.NONUNIFORMSCALING=e.nonUniformScaling,a.ALPHATEST=n,a.DECAL_AFTER_DETAIL=o)}function R(e,t,i,s,r=4,n=!1){if(!i._areLightsDirty)return i._needNormals;let a=0;const o={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!n)for(const n of t.lightSources)if(I(e,t,n,a,i,s,o),a++,a===r)break;i.SPECULARTERM=o.specularEnabled,i.SHADOWS=o.shadowEnabled;for(let e=a;e<r;e++)void 0!==i["LIGHT"+e]&&(i["LIGHT"+e]=!1,i["HEMILIGHT"+e]=!1,i["POINTLIGHT"+e]=!1,i["DIRLIGHT"+e]=!1,i["SPOTLIGHT"+e]=!1,i["SHADOW"+e]=!1,i["SHADOWCSM"+e]=!1,i["SHADOWCSMDEBUG"+e]=!1,i["SHADOWCSMNUM_CASCADES"+e]=!1,i["SHADOWCSMUSESHADOWMAXZ"+e]=!1,i["SHADOWCSMNOBLEND"+e]=!1,i["SHADOWCSM_RIGHTHANDED"+e]=!1,i["SHADOWPCF"+e]=!1,i["SHADOWPCSS"+e]=!1,i["SHADOWPOISSON"+e]=!1,i["SHADOWESM"+e]=!1,i["SHADOWCLOSEESM"+e]=!1,i["SHADOWCUBE"+e]=!1,i["SHADOWLOWQUALITY"+e]=!1,i["SHADOWMEDIUMQUALITY"+e]=!1);const l=e.getEngine().getCaps();return void 0===i.SHADOWFLOAT&&(o.needRebuild=!0),i.SHADOWFLOAT=o.shadowEnabled&&(l.textureFloatRender&&l.textureFloatLinearFiltering||l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=o.lightmapMode,o.needRebuild&&i.rebuild(),o.needNormals}function I(e,t,i,s,r,n,o){switch(o.needNormals=!0,void 0===r["LIGHT"+s]&&(o.needRebuild=!0),r["LIGHT"+s]=!0,r["SPOTLIGHT"+s]=!1,r["HEMILIGHT"+s]=!1,r["POINTLIGHT"+s]=!1,r["DIRLIGHT"+s]=!1,i.prepareLightSpecificDefines(r,s),r["LIGHT_FALLOFF_PHYSICAL"+s]=!1,r["LIGHT_FALLOFF_GLTF"+s]=!1,r["LIGHT_FALLOFF_STANDARD"+s]=!1,i.falloffType){case a.c.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+s]=!0;break;case a.c.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+s]=!0;break;case a.c.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+s]=!0}if(n&&!i.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),r["SHADOW"+s]=!1,r["SHADOWCSM"+s]=!1,r["SHADOWCSMDEBUG"+s]=!1,r["SHADOWCSMNUM_CASCADES"+s]=!1,r["SHADOWCSMUSESHADOWMAXZ"+s]=!1,r["SHADOWCSMNOBLEND"+s]=!1,r["SHADOWCSM_RIGHTHANDED"+s]=!1,r["SHADOWPCF"+s]=!1,r["SHADOWPCSS"+s]=!1,r["SHADOWPOISSON"+s]=!1,r["SHADOWESM"+s]=!1,r["SHADOWCLOSEESM"+s]=!1,r["SHADOWCUBE"+s]=!1,r["SHADOWLOWQUALITY"+s]=!1,r["SHADOWMEDIUMQUALITY"+s]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const t=i.getShadowGenerator(e.activeCamera)??i.getShadowGenerator();if(t){const e=t.getShadowMap();e&&e.renderList&&e.renderList.length>0&&(o.shadowEnabled=!0,t.prepareDefines(r,s))}}i.lightmapMode!=a.c.LIGHTMAP_DEFAULT?(o.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+s]=!0,r["LIGHTMAPNOSPECULAR"+s]=i.lightmapMode==a.c.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+s]=!1,r["LIGHTMAPNOSPECULAR"+s]=!1)}function M(e,t,i,s,r,n=null,a=!1){let l=B(e,s);!1!==n&&(l=(0,o.Eq)(i,e,s)),s.DEPTHPREPASS!==!t.getColorWrite()&&(s.DEPTHPREPASS=!s.DEPTHPREPASS,l=!0),s.INSTANCES!==r&&(s.INSTANCES=r,l=!0),s.THIN_INSTANCES!==a&&(s.THIN_INSTANCES=a,l=!0),l&&s.markAsUnprocessed()}function O(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=void 0!==t.BONETEXTURE;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=!i&&void 0;const s=e.getScene().prePassRenderer;if(s&&s.enabled){const i=-1===s.excludedSkinnedMesh.indexOf(e);t.BONES_VELOCITY_ENABLED=i}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,void 0!==t.BONETEXTURE&&(t.BONETEXTURE=!1)}function w(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.NUM_MORPH_INFLUENCERS=i.numMaxInfluencers||i.numInfluencers,t.MORPHTARGETS=t.NUM_MORPH_INFLUENCERS>0,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}function D(e,t,i,s,r=!1,n=!0,a=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent("normal"),t._needNormals&&e.isVerticesDataPresent("tangent")&&(t.TANGENT=!0);for(let i=1;i<=6;++i)t["UV"+i]=!!t._needUVs&&e.isVerticesDataPresent(`uv${1===i?"":i}`);if(i){const i=e.useVertexColors&&e.isVerticesDataPresent("color");t.VERTEXCOLOR=i,t.VERTEXALPHA=e.hasVertexAlpha&&i&&n}return e.isVerticesDataPresent("instanceColor")&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),s&&O(e,t),r&&w(e,t),a&&function(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!(!i||!i.isEnabled)}(e,t),!0}function F(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=null!==e.activeCamera.outputRenderTarget&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}function N(e,t,i){const s=t.ORDER_INDEPENDENT_TRANSPARENCY,r=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,s===t.ORDER_INDEPENDENT_TRANSPARENCY&&r===t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS||t.markAsUnprocessed()}function L(e,t,i){const s=t.PREPASS;if(!t._arePrePassDirty)return;const r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:9,define:"PREPASS_LOCAL_POSITION",index:"PREPASS_LOCAL_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:11,define:"PREPASS_VELOCITY_LINEAR",index:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:10,define:"PREPASS_SCREENSPACE_DEPTH",index:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"},{type:8,define:"PREPASS_WORLD_NORMAL",index:"PREPASS_WORLD_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount,t.PREPASS_NORMAL_WORLDSPACE=e.prePassRenderer.generateNormalsInWorldSpace;for(let i=0;i<r.length;i++){const s=e.prePassRenderer.getIndex(r[i].type);-1!==s?(t[r[i].define]=!0,t[r[i].index]=s):t[r[i].define]=!1}}else{t.PREPASS=!1;for(let e=0;e<r.length;e++)t[r[e].define]=!1}t.PREPASS!=s&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}function B(e,t){let i=!1;if(e.activeCamera){const s=t.CAMERA_ORTHOGRAPHIC?1:0,r=t.CAMERA_PERSPECTIVE?1:0,n=1===e.activeCamera.mode?1:0,a=0===e.activeCamera.mode?1:0;(s^n||r^a)&&(t.CAMERA_ORTHOGRAPHIC=1===n,t.CAMERA_PERSPECTIVE=1===a,i=!0)}return i}function k(e,t,i,s,r=null,n=!1){r&&r.push("Light"+e),n||(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowTexture"+e),i.push("depthTexture"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),s&&(i.push("projectionLightTexture"+e),t.push("textureProjectionMatrix"+e)))}function V(e,t,i,s=4){let r,n=null;if(e.uniformsNames){const a=e;r=a.uniformsNames,n=a.uniformBuffersNames,t=a.samplers,i=a.defines,s=a.maxSimultaneousLights||0}else r=e,t||(t=[]);for(let e=0;e<s&&i["LIGHT"+e];e++)k(e,r,t,i["PROJECTEDLIGHTTEXTURE"+e],n);i.NUM_MORPH_INFLUENCERS&&(r.push("morphTargetInfluences"),r.push("morphTargetCount")),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}},2277:(e,t,i)=>{"use strict";i.d(t,{y:()=>m});var s=i(5524),r=i(9259),n=i(8986),a=i(6315),o=i(9125),l=i(9610);const h=new RegExp("^([gimus]+)!");class c{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;if(!e.isCompatible(this._material.shaderLanguage))throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because the plugin is not compatible with the shader language of the material.`;const t=e.getClassName();c._MaterialPluginClassToMainDefine[t]||(c._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++c._MaterialPluginCounter),this._material._callbackPluginEventGeneric=(e,t)=>this._handlePluginEvent(e,t),this._plugins.push(e),this._plugins.sort(((e,t)=>e.priority-t.priority)),this._codeInjectionPoints={};const i={};i[c._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const e of this._plugins)e.collectDefines(i),this._collectPointNames("vertex",e.getCustomCode("vertex",this._material.shaderLanguage)),this._collectPointNames("fragment",e.getCustomCode("fragment",this._material.shaderLanguage));return this._defineNamesFromPlugins=i,!0}_activatePlugin(e){-1===this._activePlugins.indexOf(e)&&(this._activePlugins.push(e),this._activePlugins.sort(((e,t)=>e.priority-t.priority)),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort(((e,t)=>e.priority-t.priority)),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const e of this._activePluginsForExtraEvents)if(t=e.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){switch(e){case 512:{const e=t;for(const t of this._activePlugins)t.getActiveTextures(e.activeTextures);break}case 256:{const e=t;for(const t of this._activePlugins)t.getAnimatables(e.animatables);break}case 1024:{const e=t;let i=!1;for(const t of this._activePlugins)if(i=t.hasTexture(e.texture),i)break;e.hasTexture=i;break}case 2:{const e=t;for(const t of this._plugins)t.dispose(e.forceDisposeTextures);break}case 4:t.defineNames=this._defineNamesFromPlugins;break;case 128:{const e=t;for(const t of this._activePlugins)e.fallbackRank=t.addFallbacks(e.defines,e.fallbacks,e.fallbackRank),t.getAttributes(e.attributes,this._scene,e.mesh);this._uniformList.length>0&&e.uniforms.push(...this._uniformList),this._samplerList.length>0&&e.samplers.push(...this._samplerList),this._uboList.length>0&&e.uniformBuffersNames.push(...this._uboList),e.customCode=this._injectCustomCode(e,e.customCode);break}case 8:{const e=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];const i=1===this._material.shaderLanguage;for(const t of this._plugins){const s=t.getUniforms(this._material.shaderLanguage);if(s){if(s.ubo)for(const t of s.ubo){if(t.size&&t.type){const s=t.arraySize??0;if(e.ubo.addUniform(t.name,t.size,s),i){let e;switch(t.type){case"mat4":e="mat4x4f";break;case"float":e="f32";break;default:e=`${t.type}f`}this._uboDeclaration+=`uniform ${t.name}: ${e}${s>0?`[${s}]`:""};\n`}else this._uboDeclaration+=`${t.type} ${t.name}${s>0?`[${s}]`:""};\n`}this._uniformList.push(t.name)}s.vertex&&(this._vertexDeclaration+=s.vertex+"\n"),s.fragment&&(this._fragmentDeclaration+=s.fragment+"\n")}t.getSamplers(this._samplerList),t.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e,t){return(i,s)=>{t&&(s=t(i,s)),this._uboDeclaration&&(s=s.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(s=s.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(s=s.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const r=this._codeInjectionPoints?.[i];if(!r)return s;let n=null;for(let t in r){let r="";for(const s of this._activePlugins){let a=s.getCustomCode(i,this._material.shaderLanguage)?.[t];if(a){if(s.resolveIncludes){if(null===n){const t=0;n={defines:[],indexParameters:e.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:l.l.GetShadersRepository(t),includesShadersStore:l.l.GetIncludesShadersStore(t),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}}n.isFragment="fragment"===i,(0,o.Iq)(a,n,(e=>a=e))}r+=a+"\n"}}if(r.length>0)if("!"===t.charAt(0)){t=t.substring(1);let e="g";if("!"===t.charAt(0))e="",t=t.substring(1);else{const i=h.exec(t);i&&i.length>=2&&(e=i[1],t=t.substring(e.length+1))}e.indexOf("g")<0&&(e+="g");const i=s,n=new RegExp(t,e);let a=n.exec(i);for(;null!==a;){let e=r;for(let t=0;t<a.length;++t)e=e.replace("$"+t,a[t]);s=s.replace(a[0],e),a=n.exec(i)}}else{const e="#define "+t;s=s.replace(e,"\n"+r+"\n"+e)}}return s}}}c._MaterialPluginClassToMainDefine={},c._MaterialPluginCounter=0,a.q.OnEnginesDisposedObservable.add((()=>{u.length=0,d=!1,n.i.OnEventObservable.remove(_),_=null}));const u=[];let d=!1,_=null;var p=i(6877),f=i(6552);class m{isCompatible(e){return 0===e}_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,s,r=!0,n=!1,a=!1){this.priority=500,this.resolveIncludes=!1,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,this.resolveIncludes=a,e.pluginManager||(e.pluginManager=new c(e),e.onDisposeObservable.add((()=>{e.pluginManager=void 0}))),this._pluginDefineNames=s,this._pluginManager=e.pluginManager,r&&this._pluginManager._addPlugin(this),n&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,s){return!0}hardBindForSubMesh(e,t,i,s){}bindForSubMesh(e,t,i,s){}dispose(e){}getCustomCode(e,t=0){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if("_"===t[0])continue;const i=typeof this._pluginDefineNames[t];e[t]={type:"number"===i?"number":"string"===i?"string":"boolean"===i?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(e=0){return{}}copyTo(e){p.p.Clone((()=>e),this)}serialize(){return p.p.Serialize(this)}parse(e,t,i){p.p.Parse((()=>this),e,t,i)}}(0,s.Cg)([(0,r.lK)()],m.prototype,"name",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"priority",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"resolveIncludes",void 0),(0,s.Cg)([(0,r.lK)()],m.prototype,"registerForExtraEvents",void 0),(0,f.Y5)("BABYLON.MaterialPluginBase",m)},5662:(e,t,i)=>{"use strict";var s;i.d(t,{w:()=>s}),function(e){e[e.GLSL=0]="GLSL",e[e.WGSL=1]="WGSL"}(s||(s={}))},935:(e,t,i)=>{"use strict";i.d(t,{D:()=>n});var s=i(1137),r=i(998);class n{constructor(e,t,i,s,r=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||r,this._dynamic=i,this._name=s??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return void 0!==this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!=0){const e=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const i=this._uniformLocationPointer-e;for(let e=0;e<i;e++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO)return;if(void 0!==this._uniformLocations[e])return;let s;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},16==t?t*=i:t=t*i+(4-t)*i,s=[];for(let e=0;e<t;e++)s.push(0)}else{if(t instanceof Array)s=t,t=s.length;else{s=[];for(let e=0;e<t;e++)s.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let e=0;e<t;e++)this._data.push(s[e]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,i){const s=[t,i];this.addUniform(e,s)}addFloat3(e,t,i,s){const r=[t,i,s];this.addUniform(e,r)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const s=[t.r,t.g,t.b,i];this.addUniform(e,s)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNames(){const e=[];let t=0;for(const i in this._uniformLocations)if(e.push(i),10==++t)break;return e.join(",")}_rebuild(){!this._noUBO&&this._bufferData&&(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._engine._features.trackUbosInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO)if(this.bindUniformBuffer(),this._buffer)if(this._dynamic||this._needSync){if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1]){if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1]))return this._needSync=!1,void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1])}this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(n._UpdatedUbosInFrame[this._name]||(n._UpdatedUbosInFrame[this._name]=0),n._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}else this._createBufferOnWrite=this._engine._features.trackUbosInFrame;else this.create()}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let r=this._uniformLocations[e];if(void 0===r){if(this._buffer)return void s.V.Error("Cannot add an uniform after UBO has been created. uniformName="+e);this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let e=0;e<i;e++)this._bufferData[r+e]=t[e];else{let e=!1;for(let s=0;s<i;s++)(16===i&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[r+s]!==Math.fround(t[s]))&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+s]=t[s]);this._needSync=this._needSync||e}}updateUniformArray(e,t,i){this._checkNewFrame();const n=this._uniformLocations[e];if(void 0===n)return void s.V.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this._buffer||this.create();const a=this._uniformArraySizes[e];if(this._dynamic)for(let e=0;e<i;e++)this._bufferData[n+e]=t[e];else{let e=!1,s=0,o=0;for(let l=0;l<i;l++)if(this._bufferData[n+4*o+s]!==r.S0.FloatRound(t[l])&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+4*o+s]=t[l]),s++,s===a.strideSize){for(;s<4;s++)this._bufferData[n+4*o+s]=0;s=0,o++}this._needSync=this._needSync||e}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_updateMatrix3x3ForUniform(e,t){for(let e=0;e<3;e++)n._TempBuffer[4*e]=t[3*e],n._TempBuffer[4*e+1]=t[3*e+1],n._TempBuffer[4*e+2]=t[3*e+2],n._TempBuffer[4*e+3]=0;this.updateUniform(e,n._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let e=0;e<2;e++)n._TempBuffer[4*e]=t[2*e],n._TempBuffer[4*e+1]=t[2*e+1],n._TempBuffer[4*e+2]=0,n._TempBuffer[4*e+3]=0;this.updateUniform(e,n._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){n._TempBuffer[0]=t,this.updateUniform(e,n._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,s=""){this._currentEffect.setFloat2(e+s,t,i)}_updateFloat2ForUniform(e,t,i){n._TempBuffer[0]=t,n._TempBuffer[1]=i,this.updateUniform(e,n._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,s,r=""){this._currentEffect.setFloat3(e+r,t,i,s)}_updateFloat3ForUniform(e,t,i,s){n._TempBuffer[0]=t,n._TempBuffer[1]=i,n._TempBuffer[2]=s,this.updateUniform(e,n._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setFloat4(e+n,t,i,s,r)}_updateFloat4ForUniform(e,t,i,s,r){n._TempBuffer[0]=t,n._TempBuffer[1]=i,n._TempBuffer[2]=s,n._TempBuffer[3]=r,this.updateUniform(e,n._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){n._TempBufferInt32View.set(t),this.updateUniformArray(e,n._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){n._TempBufferUInt32View.set(t),this.updateUniformArray(e,n._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){n._TempBuffer[0]=t.x,n._TempBuffer[1]=t.y,n._TempBuffer[2]=t.z,this.updateUniform(e,n._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){n._TempBuffer[0]=t.x,n._TempBuffer[1]=t.y,n._TempBuffer[2]=t.z,n._TempBuffer[3]=t.w,this.updateUniform(e,n._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){n._TempBuffer[0]=t.r,n._TempBuffer[1]=t.g,n._TempBuffer[2]=t.b,this.updateUniform(e,n._TempBuffer,3)}_updateColor4ForEffect(e,t,i,s=""){this._currentEffect.setColor4(e+s,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){n._TempBuffer[0]=t.r,n._TempBuffer[1]=t.g,n._TempBuffer[2]=t.b,n._TempBuffer[3]=i,this.updateUniform(e,n._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){n._TempBuffer[0]=t.r,n._TempBuffer[1]=t.g,n._TempBuffer[2]=t.b,n._TempBuffer[3]=t.a,this.updateUniform(e,n._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){n._TempBufferInt32View[0]=t,this.updateUniform(e,n._TempBuffer,1)}_updateInt2ForEffect(e,t,i,s=""){this._currentEffect.setInt2(e+s,t,i)}_updateInt2ForUniform(e,t,i){n._TempBufferInt32View[0]=t,n._TempBufferInt32View[1]=i,this.updateUniform(e,n._TempBuffer,2)}_updateInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setInt3(e+r,t,i,s)}_updateInt3ForUniform(e,t,i,s){n._TempBufferInt32View[0]=t,n._TempBufferInt32View[1]=i,n._TempBufferInt32View[2]=s,this.updateUniform(e,n._TempBuffer,3)}_updateInt4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setInt4(e+n,t,i,s,r)}_updateInt4ForUniform(e,t,i,s,r){n._TempBufferInt32View[0]=t,n._TempBufferInt32View[1]=i,n._TempBufferInt32View[2]=s,n._TempBufferInt32View[3]=r,this.updateUniform(e,n._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){n._TempBufferUInt32View[0]=t,this.updateUniform(e,n._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,s=""){this._currentEffect.setUInt2(e+s,t,i)}_updateUInt2ForUniform(e,t,i){n._TempBufferUInt32View[0]=t,n._TempBufferUInt32View[1]=i,this.updateUniform(e,n._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setUInt3(e+r,t,i,s)}_updateUInt3ForUniform(e,t,i,s){n._TempBufferUInt32View[0]=t,n._TempBufferUInt32View[1]=i,n._TempBufferUInt32View[2]=s,this.updateUniform(e,n._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setUInt4(e+n,t,i,s,r)}_updateUInt4ForUniform(e,t,i,s,r){n._TempBufferUInt32View[0]=t,n._TempBufferUInt32View[1]=i,n._TempBufferUInt32View[2]=s,n._TempBufferUInt32View[3]=r,this.updateUniform(e,n._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let e=0;e<this._buffers.length;++e){const t=this._buffers[e][0];this._engine._releaseBuffer(t)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}n._UpdatedUbosInFrame={},n._MAX_UNIFORM_SIZE=256,n._TempBuffer=new Float32Array(n._MAX_UNIFORM_SIZE),n._TempBufferInt32View=new Int32Array(n._TempBuffer.buffer),n._TempBufferUInt32View=new Uint32Array(n._TempBuffer.buffer)},8733:(e,t,i)=>{"use strict";i.d(t,{$x:()=>s,_0:()=>a});var s,r,n=i(9923);!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD",e[e.BONE=2]="BONE"}(s||(s={}));class a{}a.X=new n.Pq(1,0,0),a.Y=new n.Pq(0,1,0),a.Z=new n.Pq(0,0,1),function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(r||(r={}))},6041:(e,t,i)=>{"use strict";i.d(t,{IG:()=>_,ov:()=>d,v9:()=>u});var s=i(7309),r=i(6552),n=i(5559),a=i(4867);function o(e){return Math.pow(e,n.tk)}function l(e){return e<=.04045?.0773993808*e:Math.pow(.947867299*(e+.055),2.4)}function h(e){return Math.pow(e,n.rv)}function c(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class u{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=255*this.r|0;return e=397*e^255*this.g,e=397*e^255*this.b,e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return u.FromArrayToRef(e,t,this),this}toColor4(e=1){return new d(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return.3*this.r+.59*this.g+.11*this.b}multiply(e){return new u(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyByFloats(e,t,i){return new u(this.r*e,this.g*t,this.b*i)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.r,e.g,e.b)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.r,e.g,e.b)}minimizeInPlaceFromFloats(e,t,i){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this}maximizeInPlaceFromFloats(e,t,i){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.equalsToFloats(e,t,i)}equalsToFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}equalsWithEpsilon(e,t=n.bH){return(0,a.WithinEpsilon)(this.r,e.r,t)&&(0,a.WithinEpsilon)(this.g,e.g,t)&&(0,a.WithinEpsilon)(this.b,e.b,t)}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}scale(e){return new u(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t}clampToRef(e=0,t=1,i){return i.r=(0,a.Clamp)(this.r,e,t),i.g=(0,a.Clamp)(this.g,e,t),i.b=(0,a.Clamp)(this.b,e,t),i}add(e){return new u(this.r+e.r,this.g+e.g,this.b+e.b)}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addInPlaceFromFloats(e,t,i){return this.r+=e,this.g+=t,this.b+=i,this}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t}subtract(e){return new u(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this}subtractFromFloats(e,t,i){return new u(this.r-e,this.g-t,this.b-i)}subtractFromFloatsToRef(e,t,i,s){return s.r=this.r-e,s.g=this.g-t,s.b=this.b-i,s}clone(){return new u(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this.r=this.g=this.b=e,this}toHexString(){const e=Math.round(255*this.r),t=Math.round(255*this.g),i=Math.round(255*this.b);return"#"+(0,a.ToHex)(e)+(0,a.ToHex)(t)+(0,a.ToHex)(i)}fromHexString(e){return"#"!==e.substring(0,1)||7!==e.length||(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255),this}toHSV(){return this.toHSVToRef(new u)}toHSVToRef(e){const t=this.r,i=this.g,s=this.b,r=Math.max(t,i,s),n=Math.min(t,i,s);let a=0,o=0;const l=r,h=r-n;return 0!==r&&(o=h/r),r!=n&&(r==t?(a=(i-s)/h,i<s&&(a+=6)):r==i?a=(s-t)/h+2:r==s&&(a=(t-i)/h+4),a*=60),e.r=a,e.g=o,e.b=l,e}toLinearSpace(e=!1){const t=new u;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=l(this.r),e.g=l(this.g),e.b=l(this.b)):(e.r=o(this.r),e.g=o(this.g),e.b=o(this.b)),this}toGammaSpace(e=!1){const t=new u;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=c(this.r),e.g=c(this.g),e.b=c(this.b)):(e.r=h(this.r),e.g=h(this.g),e.b=h(this.b)),this}static HSVtoRGBToRef(e,t,i,s){const r=i*t,n=e/60,a=r*(1-Math.abs(n%2-1));let o=0,l=0,h=0;n>=0&&n<=1?(o=r,l=a):n>=1&&n<=2?(o=a,l=r):n>=2&&n<=3?(l=r,h=a):n>=3&&n<=4?(l=a,h=r):n>=4&&n<=5?(o=a,h=r):n>=5&&n<=6&&(o=r,h=a);const c=i-r;return s.r=o+c,s.g=l+c,s.b=h+c,s}static FromHSV(e,t,i){const s=new u(0,0,0);return u.HSVtoRGBToRef(e,t,i,s),s}static FromHexString(e){return new u(0,0,0).fromHexString(e)}static FromArray(e,t=0){return new u(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new u(e/255,t/255,i/255)}static Lerp(e,t,i){const s=new u(0,0,0);return u.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,o=2*a-3*n+1,l=-2*a+3*n,h=a-2*n+r,c=a-n,d=e.r*o+i.r*l+t.r*h+s.r*c,_=e.g*o+i.g*l+t.g*h+s.g*c,p=e.b*o+i.b*l+t.b*h+s.b*c;return new u(d,_,p)}static Hermite1stDerivative(e,t,i,s,r){const n=u.Black();return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;n.r=6*(a-r)*e.r+(3*a-4*r+1)*t.r+6*(-a+r)*i.r+(3*a-2*r)*s.r,n.g=6*(a-r)*e.g+(3*a-4*r+1)*t.g+6*(-a+r)*i.g+(3*a-2*r)*s.g,n.b=6*(a-r)*e.b+(3*a-4*r+1)*t.b+6*(-a+r)*i.b+(3*a-2*r)*s.b}static Red(){return new u(1,0,0)}static Green(){return new u(0,1,0)}static Blue(){return new u(0,0,1)}static Black(){return new u(0,0,0)}static get BlackReadOnly(){return u._BlackReadOnly}static White(){return new u(1,1,1)}static Purple(){return new u(.5,0,.5)}static Magenta(){return new u(1,0,1)}static Yellow(){return new u(1,1,0)}static Gray(){return new u(.5,.5,.5)}static Teal(){return new u(0,1,1)}static Random(){return new u(Math.random(),Math.random(),Math.random())}}u._BlackReadOnly=u.Black(),Object.defineProperties(u.prototype,{dimension:{value:[3]},rank:{value:1}});class d{constructor(e=0,t=0,i=0,s=1){this.r=e,this.g=t,this.b=i,this.a=s}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3],this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new d(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}addInPlaceFromFloats(e,t,i,s){return this.r+=e,this.g+=t,this.b+=i,this.a+=s,this}subtract(e){return new d(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}subtractFromFloats(e,t,i,s){return new d(this.r-e,this.g-t,this.b-i,this.a-s)}subtractFromFloatsToRef(e,t,i,s,r){return r.r=this.r-e,r.g=this.g-t,r.b=this.b-i,r.a=this.a-s,r}scale(e){return new d(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,t}clampToRef(e=0,t=1,i){return i.r=(0,a.Clamp)(this.r,e,t),i.g=(0,a.Clamp)(this.g,e,t),i.b=(0,a.Clamp)(this.b,e,t),i.a=(0,a.Clamp)(this.a,e,t),i}multiply(e){return new d(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this.a*=e.a,this}multiplyByFloats(e,t,i,s){return new d(this.r*e,this.g*t,this.b*i,this.a*s)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.r=Math.min(this.r,e.r),this.g=Math.min(this.g,e.g),this.b=Math.min(this.b,e.b),this.a=Math.min(this.a,e.a),this}maximizeInPlace(e){return this.r=Math.max(this.r,e.r),this.g=Math.max(this.g,e.g),this.b=Math.max(this.b,e.b),this.a=Math.max(this.a,e.a),this}minimizeInPlaceFromFloats(e,t,i,s){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this.a=Math.min(s,this.a),this}maximizeInPlaceFromFloats(e,t,i,s){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this.a=Math.max(s,this.a),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}equalsWithEpsilon(e,t=n.bH){return(0,a.WithinEpsilon)(this.r,e.r,t)&&(0,a.WithinEpsilon)(this.g,e.g,t)&&(0,a.WithinEpsilon)(this.b,e.b,t)&&(0,a.WithinEpsilon)(this.a,e.a,t)}equalsToFloats(e,t,i,s){return this.r===e&&this.g===t&&this.b===i&&this.a===s}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=255*this.r|0;return e=397*e^255*this.g,e=397*e^255*this.b,e=397*e^255*this.a,e}clone(){return(new d).copyFrom(this)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,s){return this.r=e,this.g=t,this.b=i,this.a=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.r=this.g=this.b=this.a=e,this}toHexString(e=!1){const t=Math.round(255*this.r),i=Math.round(255*this.g),s=Math.round(255*this.b);if(e)return"#"+(0,a.ToHex)(t)+(0,a.ToHex)(i)+(0,a.ToHex)(s);const r=Math.round(255*this.a);return"#"+(0,a.ToHex)(t)+(0,a.ToHex)(i)+(0,a.ToHex)(s)+(0,a.ToHex)(r)}fromHexString(e){return"#"!==e.substring(0,1)||9!==e.length&&7!==e.length||(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,9===e.length&&(this.a=parseInt(e.substring(7,9),16)/255)),this}toLinearSpace(e=!1){const t=new d;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=l(this.r),e.g=l(this.g),e.b=l(this.b)):(e.r=o(this.r),e.g=o(this.g),e.b=o(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new d;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=c(this.r),e.g=c(this.g),e.b=c(this.b)):(e.r=h(this.r),e.g=h(this.g),e.b=h(this.b)),e.a=this.a,this}static FromHexString(e){return"#"!==e.substring(0,1)||9!==e.length&&7!==e.length?new d(0,0,0,0):new d(0,0,0,1).fromHexString(e)}static Lerp(e,t,i){return d.LerpToRef(e,t,i,new d)}static LerpToRef(e,t,i,s){return s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i,s.a=e.a+(t.a-e.a)*i,s}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,o=2*a-3*n+1,l=-2*a+3*n,h=a-2*n+r,c=a-n,u=e.r*o+i.r*l+t.r*h+s.r*c,_=e.g*o+i.g*l+t.g*h+s.g*c,p=e.b*o+i.b*l+t.b*h+s.b*c,f=e.a*o+i.a*l+t.a*h+s.a*c;return new d(u,_,p,f)}static Hermite1stDerivative(e,t,i,s,r){const n=new d;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;n.r=6*(a-r)*e.r+(3*a-4*r+1)*t.r+6*(-a+r)*i.r+(3*a-2*r)*s.r,n.g=6*(a-r)*e.g+(3*a-4*r+1)*t.g+6*(-a+r)*i.g+(3*a-2*r)*s.g,n.b=6*(a-r)*e.b+(3*a-4*r+1)*t.b+6*(-a+r)*i.b+(3*a-2*r)*s.b,n.a=6*(a-r)*e.a+(3*a-4*r+1)*t.a+6*(-a+r)*i.a+(3*a-2*r)*s.a}static FromColor3(e,t=1){return new d(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new d(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,s){return new d(e/255,t/255,i/255,s/255)}static CheckColors4(e,t){if(e.length===3*t){const t=[];for(let i=0;i<e.length;i+=3){const s=i/3*4;t[s]=e[i],t[s+1]=e[i+1],t[s+2]=e[i+2],t[s+3]=1}return t}return e}}Object.defineProperties(d.prototype,{dimension:{value:[4]},rank:{value:1}});class _{}_.Color3=(0,s.mI)(3,u.Black),_.Color4=(0,s.mI)(3,(()=>new d(0,0,0,0))),(0,r.Y5)("BABYLON.Color3",u),(0,r.Y5)("BABYLON.Color4",d)},5559:(e,t,i)=>{"use strict";i.d(t,{bH:()=>n,rv:()=>s,tk:()=>r});const s=1/2.2,r=2.2,n=(Math.sqrt(5),.001)},2572:(e,t,i)=>{"use strict";i.d(t,{P:()=>r});var s=i(4100);class r{static GetPlanes(e){const t=[];for(let e=0;e<6;e++)t.push(new s.Z(0,0,0,0));return r.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){r.GetNearPlaneToRef(e,t[0]),r.GetFarPlaneToRef(e,t[1]),r.GetLeftPlaneToRef(e,t[2]),r.GetRightPlaneToRef(e,t[3]),r.GetTopPlaneToRef(e,t[4]),r.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}},1139:(e,t,i)=>{"use strict";i.d(t,{b:()=>l,c:()=>o});var s=i(5524),r=i(9923),n=i(9259);class a{static extractMinAndMaxIndexed(e,t,i,s,r,n){for(let a=i;a<i+s;a++){const i=3*t[a],s=e[i],o=e[i+1],l=e[i+2];r.minimizeInPlaceFromFloats(s,o,l),n.maximizeInPlaceFromFloats(s,o,l)}}static extractMinAndMax(e,t,i,s,r,n){for(let a=t,o=t*s;a<t+i;a++,o+=s){const t=e[o],i=e[o+1],s=e[o+2];r.minimizeInPlaceFromFloats(t,i,s),n.maximizeInPlaceFromFloats(t,i,s)}}}function o(e,t,i,s,n=null){const o=new r.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l=new r.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return a.extractMinAndMaxIndexed(e,t,i,s,o,l),n&&(o.x-=o.x*n.x+n.y,o.y-=o.y*n.x+n.y,o.z-=o.z*n.x+n.y,l.x+=l.x*n.x+n.y,l.y+=l.y*n.x+n.y,l.z+=l.z*n.x+n.y),{minimum:o,maximum:l}}function l(e,t,i,s=null,n){const o=new r.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l=new r.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n||(n=3),a.extractMinAndMax(e,t,i,n,o,l),s&&(o.x-=o.x*s.x+s.y,o.y-=o.y*s.x+s.y,o.z-=o.z*s.x+s.y,l.x+=l.x*s.x+s.y,l.y+=l.y*s.x+s.y,l.z+=l.z*s.x+s.y),{minimum:o,maximum:l}}(0,s.Cg)([n.Cx.filter(((...[e,t])=>!Array.isArray(e)&&!Array.isArray(t)))],a,"extractMinAndMaxIndexed",null),(0,s.Cg)([n.Cx.filter(((...[e])=>!Array.isArray(e)))],a,"extractMinAndMax",null)},2956:(e,t,i)=>{"use strict";i.d(t,{v9:()=>s.v9,ov:()=>s.ov,IG:()=>s.IG,AA:()=>r.AA,IU:()=>r.IU}),i(8733);var s=i(6041),r=(i(5559),i(2572),i(1903),i(4100),i(521),i(9923));i(4494)},1903:(e,t,i)=>{"use strict";i.d(t,{jj:()=>a,vr:()=>n}),i(4867);var s,r=i(9923);i(5559),function(e){e[e.CW=0]="CW",e[e.CCW=1]="CCW"}(s||(s={}));class n{static Interpolate(e,t,i,s,r){const n=1-3*s+3*t,a=3*s-6*t,o=3*t;let l=e;for(let t=0;t<5;t++){const t=l*l;l-=1/(3*n*t+2*a*l+o)*(n*(t*l)+a*t+o*l-e),l=Math.min(1,Math.max(0,l))}return 3*Math.pow(1-l,2)*l*i+3*(1-l)*Math.pow(l,2)*r+Math.pow(l,3)}}class a{static CreateQuadraticBezier(e,t,i,s){s=s>2?s:3;const n=[],o=(e,t,i,s)=>(1-e)*(1-e)*t+2*e*(1-e)*i+e*e*s;for(let a=0;a<=s;a++)n.push(new r.Pq(o(a/s,e.x,t.x,i.x),o(a/s,e.y,t.y,i.y),o(a/s,e.z,t.z,i.z)));return new a(n)}static CreateCubicBezier(e,t,i,s,n){n=n>3?n:4;const o=[],l=(e,t,i,s,r)=>(1-e)*(1-e)*(1-e)*t+3*e*(1-e)*(1-e)*i+3*e*e*(1-e)*s+e*e*e*r;for(let a=0;a<=n;a++)o.push(new r.Pq(l(a/n,e.x,t.x,i.x,s.x),l(a/n,e.y,t.y,i.y,s.y),l(a/n,e.z,t.z,i.z,s.z)));return new a(o)}static CreateHermiteSpline(e,t,i,s,n){const o=[],l=1/n;for(let a=0;a<=n;a++)o.push(r.Pq.Hermite(e,t,i,s,a*l));return new a(o)}static CreateCatmullRomSpline(e,t,i){const s=[],n=1/t;let o=0;if(i){const i=e.length;for(let a=0;a<i;a++){o=0;for(let l=0;l<t;l++)s.push(r.Pq.CatmullRom(e[a%i],e[(a+1)%i],e[(a+2)%i],e[(a+3)%i],o)),o+=n}s.push(s[0])}else{const i=[];i.push(e[0].clone()),Array.prototype.push.apply(i,e),i.push(e[e.length-1].clone());let a=0;for(;a<i.length-3;a++){o=0;for(let e=0;e<t;e++)s.push(r.Pq.CatmullRom(i[a],i[a+1],i[a+2],i[a+3],o)),o+=n}a--,s.push(r.Pq.CatmullRom(i[a],i[a+1],i[a+2],i[a+3],o))}return new a(s)}static ArcThru3Points(e,t,i,s=32,n=!1,o=!1){const l=[],h=t.subtract(e),c=i.subtract(t),u=e.subtract(i),d=r.Pq.Cross(h,c),_=d.length();if(_<Math.pow(10,-8))return new a(l);const p=h.lengthSquared(),f=c.lengthSquared(),m=u.lengthSquared(),g=d.lengthSquared(),v=.5*h.length()*c.length()*u.length()/_,b=-.5*f*r.Pq.Dot(h,u)/g,x=-.5*m*r.Pq.Dot(h,c)/g,S=-.5*p*r.Pq.Dot(c,u)/g,T=e.scale(b).add(t.scale(x)).add(i.scale(S)),y=e.subtract(T).normalize(),C=r.Pq.Cross(d,y).normalize();if(o){const t=2*Math.PI/s;for(let e=0;e<=2*Math.PI;e+=t)l.push(T.add(y.scale(v*Math.cos(e)).add(C.scale(v*Math.sin(e)))));l.push(e)}else{const t=1/s;let a=0,o=r.Pq.Zero();do{o=T.add(y.scale(v*Math.cos(a)).add(C.scale(v*Math.sin(a)))),l.push(o),a+=t}while(!o.equalsWithEpsilon(i,v*t*1.1));l.push(i),n&&l.push(e)}return new a(l)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){const t=this._points[this._points.length-1],i=this._points.slice(),s=e.getPoints();for(let e=1;e<s.length;e++)i.push(s[e].subtract(s[0]).add(t));return new a(i)}_computeLength(e){let t=0;for(let i=1;i<e.length;i++)t+=e[i].subtract(e[i-1]).length();return t}}},4100:(e,t,i)=>{"use strict";i.d(t,{Z:()=>r});var s=i(9923);class r{constructor(e,t,i,r){this.normal=new s.Pq(e,t,i),this.d=r}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new r(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=397*e^this.d,e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=r._TmpMatrix;e.invertToRef(t);const i=t.m,s=this.normal.x,n=this.normal.y,a=this.normal.z,o=this.d,l=s*i[0]+n*i[1]+a*i[2]+o*i[3],h=s*i[4]+n*i[5]+a*i[6]+o*i[7],c=s*i[8]+n*i[9]+a*i[10]+o*i[11],u=s*i[12]+n*i[13]+a*i[14]+o*i[15];return new r(l,h,c,u)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const s=t.x-e.x,r=t.y-e.y,n=t.z-e.z,a=i.x-e.x,o=i.y-e.y,l=i.z-e.z,h=r*l-n*o,c=n*a-s*l,u=s*o-r*a,d=Math.sqrt(h*h+c*c+u*u);let _;return _=0!==d?1/d:0,this.normal.x=h*_,this.normal.y=c*_,this.normal.z=u*_,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return s.Pq.Dot(this.normal,e)<=t}signedDistanceTo(e){return s.Pq.Dot(e,this.normal)+this.d}static FromArray(e){return new r(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const s=new r(0,0,0,0);return s.copyFromPoints(e,t,i),s}static FromPositionAndNormal(e,t){const i=new r(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,i)}static FromPositionAndNormalToRef(e,t,i){return i.normal.copyFrom(t),i.normal.normalize(),i.d=-e.dot(i.normal),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const r=-(t.x*e.x+t.y*e.y+t.z*e.z);return s.Pq.Dot(i,t)+r}}r._TmpMatrix=s.uq.Identity()},4867:(e,t,i)=>{"use strict";function s(e){return parseInt(e.toString().replace(/\W/g,""))}function r(e,t,i=1401298e-51){return Math.abs(e-t)<=i}function n(e,t){return e===t?e:Math.random()*(t-e)+e}function a(e,t,i){return e+(t-e)*i}function o(e,t,i){let s=f(t-e,360);return s>180&&(s-=360),e+s*u(i)}function l(e,t,i){let s=0;return s=e!=t?u((i-e)/(t-e)):0,s}function h(e,t,i,s,r){const n=r*r,a=r*n;return e*(2*a-3*n+1)+i*(-2*a+3*n)+t*(a-2*n+r)+s*(a-n)}function c(e,t,i,s,r){const n=r*r;return 6*(n-r)*e+(3*n-4*r+1)*t+6*(-n+r)*i+(3*n-2*r)*s}function u(e,t=0,i=1){return Math.min(i,Math.max(t,e))}function d(e){return e-2*Math.PI*Math.floor((e+Math.PI)/(2*Math.PI))}function _(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}function p(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(0===e)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e*=2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}function f(e,t){return e-Math.floor(e/t)*t}function m(e,t,i){return(e-t)/(i-t)}function g(e,t,i){return e*(i-t)+t}function v(e,t){let i=f(t-e,360);return i>180&&(i-=360),i}function b(e,t){const i=f(e,2*t);return t-Math.abs(i-t)}function x(e,t,i){let s=u(i);return s=-2*s*s*s+3*s*s,t*s+e*(1-s)}function S(e,t,i){let s=0;return s=Math.abs(t-e)<=i?t:e+Math.sign(t-e)*i,s}function T(e,t,i){const s=v(e,t);let r=0;return r=-i<s&&s<i?t:S(e,t=e+s,i),r}function y(e,t,i){return(e-t)/(i-t)}function C(e,t,i){return(i-t)*e+t}function P(e,t){const i=e%t;return 0===i?t:P(t,i)}i.r(t),i.d(t,{Clamp:()=>u,DeltaAngle:()=>v,Denormalize:()=>g,ExtractAsInt:()=>s,Hermite:()=>h,Hermite1stDerivative:()=>c,HighestCommonFactor:()=>P,ILog2:()=>p,InverseLerp:()=>l,Lerp:()=>a,LerpAngle:()=>o,MoveTowards:()=>S,MoveTowardsAngle:()=>T,Normalize:()=>m,NormalizeRadians:()=>d,PercentToRange:()=>C,PingPong:()=>b,RandomRange:()=>n,RangeToPercent:()=>y,Repeat:()=>f,SmoothStep:()=>x,ToHex:()=>_,WithinEpsilon:()=>r})},521:(e,t,i)=>{"use strict";i.d(t,{o:()=>s});class s{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=0|this.width;return e=397*e^this.height,e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new s(this.width*e,this.height*t)}clone(){return new s(this.width,this.height)}equals(e){return!!e&&this.width===e.width&&this.height===e.height}get surface(){return this.width*this.height}static Zero(){return new s(0,0)}add(e){return new s(this.width+e.width,this.height+e.height)}subtract(e){return new s(this.width-e.width,this.height-e.height)}scale(e){return new s(this.width*e,this.height*e)}static Lerp(e,t,i){const r=e.width+(t.width-e.width)*i,n=e.height+(t.height-e.height)*i;return new s(r,n)}}},9923:(e,t,i)=>{"use strict";i.d(t,{AA:()=>m,I9:()=>c,IU:()=>d,PT:()=>_,Pq:()=>u,uq:()=>p});var s=i(5559),r=i(7309),n=i(6552),a=i(215),o=i(6315),l=i(4867);const h=e=>parseInt(e.toString().replace(/\W/g,""));class c{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){let e=h(this.x);return e=397*e^h(this.y),e}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return c.FromArrayToRef(e,t,this),this}asArray(){return[this.x,this.y]}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}setAll(e){return this.copyFromFloats(e,e)}add(e){return new c(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addInPlaceFromFloats(e,t){return this.x+=e,this.y+=t,this}addVector3(e){return new c(this.x+e.x,this.y+e.y)}subtract(e){return new c(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new c(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new c(this.x*e,this.y*t)}divide(e){return new c(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.x,e.y)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.x,e.y)}minimizeInPlaceFromFloats(e,t){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this}maximizeInPlaceFromFloats(e,t){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this}subtractFromFloats(e,t){return new c(this.x-e,this.y-t)}subtractFromFloatsToRef(e,t,i){return i.x=this.x-e,i.y=this.y-t,i}negate(){return new c(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){return new c(this.x*e,this.y*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=s.bH){return e&&(0,l.WithinEpsilon)(this.x,e.x,t)&&(0,l.WithinEpsilon)(this.y,e.y,t)}equalsToFloats(e,t){return this.x===e&&this.y===t}floor(){return new c(Math.floor(this.x),Math.floor(this.y))}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e}fract(){return new c(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e}rotateToRef(e,t){const i=Math.cos(e),s=Math.sin(e),r=i*this.x-s*this.y,n=s*this.x+i*this.y;return t.x=r,t.y=n,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new c;return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t&&(e.x=this.x,e.y=this.y),this.scaleToRef(1/t,e)}clone(){return new c(this.x,this.y)}dot(e){return this.x*e.x+this.y*e.y}static Zero(){return new c(0,0)}static One(){return new c(1,1)}static Random(e=0,t=1){return new c((0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats((0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t))}static get ZeroReadOnly(){return c._ZeroReadOnly}static FromArray(e,t=0){return new c(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static FromFloatsToRef(e,t,i){return i.copyFromFloats(e,t),i}static CatmullRom(e,t,i,s,r){const n=r*r,a=r*n,o=.5*(2*t.x+(-e.x+i.x)*r+(2*e.x-5*t.x+4*i.x-s.x)*n+(-e.x+3*t.x-3*i.x+s.x)*a),l=.5*(2*t.y+(-e.y+i.y)*r+(2*e.y-5*t.y+4*i.y-s.y)*n+(-e.y+3*t.y-3*i.y+s.y)*a);return new c(o,l)}static ClampToRef(e,t,i,s){return s.x=(0,l.Clamp)(e.x,t.x,i.x),s.y=(0,l.Clamp)(e.y,t.y,i.y),s}static Clamp(e,t,i){const s=(0,l.Clamp)(e.x,t.x,i.x),r=(0,l.Clamp)(e.y,t.y,i.y);return new c(s,r)}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,o=2*a-3*n+1,l=-2*a+3*n,h=a-2*n+r,u=a-n,d=e.x*o+i.x*l+t.x*h+s.x*u,_=e.y*o+i.y*l+t.y*h+s.y*u;return new c(d,_)}static Hermite1stDerivative(e,t,i,s,r){return this.Hermite1stDerivativeToRef(e,t,i,s,r,new c)}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;return n.x=6*(a-r)*e.x+(3*a-4*r+1)*t.x+6*(-a+r)*i.x+(3*a-2*r)*s.x,n.y=6*(a-r)*e.y+(3*a-4*r+1)*t.y+6*(-a+r)*i.y+(3*a-2*r)*s.y,n}static Lerp(e,t,i){return c.LerpToRef(e,t,i,new c)}static LerpToRef(e,t,i,s){return s.x=e.x+(t.x-e.x)*i,s.y=e.y+(t.y-e.y)*i,s}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){return c.NormalizeToRef(e,new c)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,s=e.y<t.y?e.y:t.y;return new c(i,s)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,s=e.y>t.y?e.y:t.y;return new c(i,s)}static Transform(e,t){return c.TransformToRef(e,t,new c)}static TransformToRef(e,t,i){const s=t.m,r=e.x*s[0]+e.y*s[4]+s[12],n=e.x*s[1]+e.y*s[5]+s[13];return i.x=r,i.y=n,i}static PointInTriangle(e,t,i,s){const r=.5*(-i.y*s.x+t.y*(-i.x+s.x)+t.x*(i.y-s.y)+i.x*s.y),n=r<0?-1:1,a=(t.y*s.x-t.x*s.y+(s.y-t.y)*e.x+(t.x-s.x)*e.y)*n,o=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*n;return a>0&&o>0&&a+o<2*r*n}static Distance(e,t){return Math.sqrt(c.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y;return i*i+s*s}static Center(e,t){return c.CenterToRef(e,t,new c)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const s=c.DistanceSquared(t,i);if(0===s)return c.Distance(e,t);const r=i.subtract(t),n=Math.max(0,Math.min(1,c.Dot(e.subtract(t),r)/s)),a=t.add(r.multiplyByFloats(n,n));return c.Distance(e,a)}}c._ZeroReadOnly=c.Zero(),Object.defineProperties(c.prototype,{dimension:{value:[2]},rank:{value:1}});class u{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){let e=h(this._x);return e=397*e^h(this._y),e=397*e^h(this._z),e}asArray(){return[this._x,this._y,this._z]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return u.FromArrayToRef(e,t,this),this}toQuaternion(){return _.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._isDirty=!0,this}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new u(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._isDirty=!0,t}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new u(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new u(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,s){return s._x=this._x-e,s._y=this._y-t,s._z=this._z-i,s._isDirty=!0,s}negate(){return new u(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e._x=-1*this._x,e._y=-1*this._y,e._z=-1*this._z,e._isDirty=!0,e}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new u(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._isDirty=!0,t}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const s=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const r=t*Math.sin(i)*Math.cos(s),n=t*Math.cos(i),a=t*Math.sin(i)*Math.sin(s);return e.set(r,n,a),e}applyRotationQuaternionToRef(e,t){const i=this._x,s=this._y,r=this._z,n=e._x,a=e._y,o=e._z,l=e._w,h=2*(a*r-o*s),c=2*(o*i-n*r),u=2*(n*s-a*i);return t._x=i+l*h+a*u-o*c,t._y=s+l*c+o*h-n*u,t._z=r+l*u+n*c-a*h,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new u)}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._isDirty=!0,t}projectOnPlane(e,t){return this.projectOnPlaneToRef(e,t,new u)}projectOnPlaneToRef(e,t,i){const s=e.normal,r=e.d,n=f.Vector3[0];this.subtractToRef(t,n),n.normalize();const a=u.Dot(n,s);if(Math.abs(a)<1e-10)i.setAll(1/0);else{const e=-(u.Dot(t,s)+r)/a,o=n.scaleInPlace(e);t.addToRef(o,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=s.bH){return e&&(0,l.WithinEpsilon)(this._x,e._x,t)&&(0,l.WithinEpsilon)(this._y,e._y,t)&&(0,l.WithinEpsilon)(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t._x=this._x*e._x,t._y=this._y*e._y,t._z=this._z*e._z,t._isDirty=!0,t}multiplyByFloats(e,t,i){return new u(this._x*e,this._y*t,this._z*i)}divide(e){return new u(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t._x=this._x/e._x,t._y=this._y/e._y,t._z=this._z/e._z,t._isDirty=!0,t}divideInPlace(e){return this._x=this._x/e._x,this._y=this._y/e._y,this._z=this._z/e._z,this._isDirty=!0,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!(0,l.WithinEpsilon)(t,i,e))return!0;const s=Math.abs(this._z);return!(0,l.WithinEpsilon)(t,s,e)||!(0,l.WithinEpsilon)(i,s,e)}get isNonUniform(){const e=Math.abs(this._x);return e!==Math.abs(this._y)||e!==Math.abs(this._z)}floorToRef(e){return e._x=Math.floor(this._x),e._y=Math.floor(this._y),e._z=Math.floor(this._z),e._isDirty=!0,e}floor(){return new u(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}fractToRef(e){return e._x=this.x-Math.floor(this._x),e._y=this.y-Math.floor(this._y),e._z=this.z-Math.floor(this._z),e._isDirty=!0,e}fract(){return new u(this.x-Math.floor(this._x),this.y-Math.floor(this._y),this.z-Math.floor(this._z))}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z==0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){if("xyz"===(e=e.toLowerCase()))return this;const t=f.Vector3[0].copyFrom(this);return this.x=t[e[0]],this.y=t[e[1]],this.z=t[e[2]],this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(f.Matrix[0]),u.TransformCoordinatesToRef(this,f.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,f.Vector3[0]),f.Vector3[0].rotateByQuaternionToRef(e,f.Vector3[0]),t.addToRef(f.Vector3[0],i),i}cross(e){return u.CrossToRef(this,e,new u)}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new u)}normalizeToRef(e){const t=this.length();return 0===t||1===t?(e._x=this._x,e._y=this._y,e._z=this._z,e._isDirty=!0,e):this.scaleToRef(1/t,e)}clone(){return new u(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,s){const r=u.Dot(e,i);return(r-s)/(r-u.Dot(t,i))}static GetAngleBetweenVectors(e,t,i){const s=e.normalizeToRef(f.Vector3[1]),r=t.normalizeToRef(f.Vector3[2]);let n=u.Dot(s,r);n=(0,l.Clamp)(n,-1,1);const a=Math.acos(n),o=f.Vector3[3];return u.CrossToRef(s,r,o),u.Dot(o,i)>0?isNaN(a)?0:a:isNaN(a)?-Math.PI:-Math.acos(n)}static GetAngleBetweenVectorsOnPlane(e,t,i){f.Vector3[0].copyFrom(e);const s=f.Vector3[0];f.Vector3[1].copyFrom(t);const r=f.Vector3[1];f.Vector3[2].copyFrom(i);const n=f.Vector3[2],a=f.Vector3[3],o=f.Vector3[4];s.normalize(),r.normalize(),n.normalize(),u.CrossToRef(n,s,a),u.CrossToRef(a,n,o);const h=Math.atan2(u.Dot(r,a),u.Dot(r,o));return(0,l.NormalizeRadians)(h)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const s=m.Vector3[0];return t.subtractToRef(e,s),i._y=Math.atan2(s.x,s.z)||0,i._x=Math.atan2(Math.sqrt(s.x**2+s.z**2),s.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=u.Zero();return u.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,r){i=(0,l.Clamp)(i,0,1);const n=f.Vector3[0],a=f.Vector3[1];n.copyFrom(e);const o=n.length();n.normalizeFromLength(o),a.copyFrom(t);const h=a.length();a.normalizeFromLength(h);const c=u.Dot(n,a);let d,_;if(c<1-s.bH){const e=Math.acos(c),t=1/Math.sin(e);d=Math.sin((1-i)*e)*t,_=Math.sin(i*e)*t}else d=1-i,_=i;return n.scaleInPlace(d),a.scaleInPlace(_),r.copyFrom(n).addInPlace(a),r.scaleInPlace((0,l.Lerp)(o,h,i)),r}static SmoothToRef(e,t,i,s,r){return u.SlerpToRef(e,t,0===s?1:i/s,r),r}static FromArray(e,t=0){return new u(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return u.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return u.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,s){return s.copyFromFloats(e,t,i),s}static Zero(){return new u(0,0,0)}static One(){return new u(1,1,1)}static Up(){return new u(0,1,0)}static get UpReadOnly(){return u._UpReadOnly}static get DownReadOnly(){return u._DownReadOnly}static get RightReadOnly(){return u._RightReadOnly}static get LeftReadOnly(){return u._LeftReadOnly}static get LeftHandedForwardReadOnly(){return u._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return u._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return u._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return u._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return u._ZeroReadOnly}static get OneReadOnly(){return u._OneReadOnly}static Down(){return new u(0,-1,0)}static Forward(e=!1){return new u(0,0,e?-1:1)}static Backward(e=!1){return new u(0,0,e?1:-1)}static Right(){return new u(1,0,0)}static Left(){return new u(-1,0,0)}static Random(e=0,t=1){return new u((0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats((0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t))}static TransformCoordinates(e,t){const i=u.Zero();return u.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return u.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,r){const n=s.m,a=e*n[0]+t*n[4]+i*n[8]+n[12],o=e*n[1]+t*n[5]+i*n[9]+n[13],l=e*n[2]+t*n[6]+i*n[10]+n[14],h=1/(e*n[3]+t*n[7]+i*n[11]+n[15]);return r._x=a*h,r._y=o*h,r._z=l*h,r._isDirty=!0,r}static TransformNormal(e,t){const i=u.Zero();return u.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,s,r){const n=s.m;return r._x=e*n[0]+t*n[4]+i*n[8],r._y=e*n[1]+t*n[5]+i*n[9],r._z=e*n[2]+t*n[6]+i*n[10],r._isDirty=!0,r}static CatmullRom(e,t,i,s,r){const n=r*r,a=r*n,o=.5*(2*t._x+(-e._x+i._x)*r+(2*e._x-5*t._x+4*i._x-s._x)*n+(-e._x+3*t._x-3*i._x+s._x)*a),l=.5*(2*t._y+(-e._y+i._y)*r+(2*e._y-5*t._y+4*i._y-s._y)*n+(-e._y+3*t._y-3*i._y+s._y)*a),h=.5*(2*t._z+(-e._z+i._z)*r+(2*e._z-5*t._z+4*i._z-s._z)*n+(-e._z+3*t._z-3*i._z+s._z)*a);return new u(o,l,h)}static Clamp(e,t,i){const s=new u;return u.ClampToRef(e,t,i,s),s}static ClampToRef(e,t,i,s){let r=e._x;r=r>i._x?i._x:r,r=r<t._x?t._x:r;let n=e._y;n=n>i._y?i._y:n,n=n<t._y?t._y:n;let a=e._z;return a=a>i._z?i._z:a,a=a<t._z?t._z:a,s.copyFromFloats(r,n,a),s}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,o=2*a-3*n+1,l=-2*a+3*n,h=a-2*n+r,c=a-n,d=e._x*o+i._x*l+t._x*h+s._x*c,_=e._y*o+i._y*l+t._y*h+s._y*c,p=e._z*o+i._z*l+t._z*h+s._z*c;return new u(d,_,p)}static Hermite1stDerivative(e,t,i,s,r){const n=new u;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;return n._x=6*(a-r)*e._x+(3*a-4*r+1)*t._x+6*(-a+r)*i._x+(3*a-2*r)*s._x,n._y=6*(a-r)*e._y+(3*a-4*r+1)*t._y+6*(-a+r)*i._y+(3*a-2*r)*s._y,n._z=6*(a-r)*e._z+(3*a-4*r+1)*t._z+6*(-a+r)*i._z+(3*a-2*r)*s._z,n._isDirty=!0,n}static Lerp(e,t,i){const s=new u(0,0,0);return u.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){return s._x=e._x+(t._x-e._x)*i,s._y=e._y+(t._y-e._y)*i,s._z=e._z+(t._z-e._z)*i,s._isDirty=!0,s}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z}static Cross(e,t){const i=new u;return u.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const s=e._y*t._z-e._z*t._y,r=e._z*t._x-e._x*t._z,n=e._x*t._y-e._y*t._x;return i.copyFromFloats(s,r,n),i}static Normalize(e){const t=u.Zero();return u.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,s){const r=new u;return u.ProjectToRef(e,t,i,s,r),r}static ProjectToRef(e,t,i,s,r){const n=s.width,a=s.height,l=s.x,h=s.y,c=f.Matrix[1],d=o.q.LastCreatedEngine?.isNDCHalfZRange,_=d?1:.5,m=d?0:.5;p.FromValuesToRef(n/2,0,0,0,0,-a/2,0,0,0,0,_,0,l+n/2,a/2+h,m,1,c);const g=f.Matrix[0];return t.multiplyToRef(i,g),g.multiplyToRef(c,g),u.TransformCoordinatesToRef(e,g,r),r}static Reflect(e,t){return this.ReflectToRef(e,t,new u)}static ReflectToRef(e,t,i){const s=m.Vector3[0];return s.copyFrom(t).scaleInPlace(2*u.Dot(e,t)),i.copyFrom(e).subtractInPlace(s)}static _UnprojectFromInvertedMatrixToRef(e,t,i){u.TransformCoordinatesToRef(e,t,i);const s=t.m,r=e._x*s[3]+e._y*s[7]+e._z*s[11]+s[15];return(0,l.WithinEpsilon)(r,1)&&i.scaleInPlace(1/r),i}static UnprojectFromTransform(e,t,i,s,r){return this.Unproject(e,t,i,s,r,p.IdentityReadOnly)}static Unproject(e,t,i,s,r,n){const a=new u;return u.UnprojectToRef(e,t,i,s,r,n,a),a}static UnprojectToRef(e,t,i,s,r,n,a){return u.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,s,r,n,a),a}static UnprojectFloatsToRef(e,t,i,s,r,n,a,l,h){const c=f.Matrix[0];n.multiplyToRef(a,c),c.multiplyToRef(l,c),c.invert();const d=f.Vector3[0];return d.x=e/s*2-1,d.y=-(t/r*2-1),o.q.LastCreatedEngine?.isNDCHalfZRange?d.z=i:d.z=2*i-1,u._UnprojectFromInvertedMatrixToRef(d,c,h),h}static Minimize(e,t){const i=new u;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new u;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(u.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,s=e._y-t._y,r=e._z-t._z;return i*i+s*s+r*r}static ProjectOnTriangleToRef(e,t,i,r,n){const a=f.Vector3[0],o=f.Vector3[1],h=f.Vector3[2],c=f.Vector3[3],d=f.Vector3[4];i.subtractToRef(t,a),r.subtractToRef(t,o),r.subtractToRef(i,h);const _=a.length(),p=o.length(),m=h.length();if(_<s.bH||p<s.bH||m<s.bH)return n.copyFrom(t),u.Distance(e,t);e.subtractToRef(t,d),u.CrossToRef(a,o,c);const g=c.length();if(g<s.bH)return n.copyFrom(t),u.Distance(e,t);c.normalizeFromLength(g);let v=d.length();if(v<s.bH)return n.copyFrom(t),0;d.normalizeFromLength(v);const b=u.Dot(c,d),x=f.Vector3[5],S=f.Vector3[6];x.copyFrom(c).scaleInPlace(-v*b),S.copyFrom(e).addInPlace(x);const T=f.Vector3[4],y=f.Vector3[5],C=f.Vector3[7],P=f.Vector3[8];T.copyFrom(a).scaleInPlace(1/_),P.copyFrom(o).scaleInPlace(1/p),T.addInPlace(P).scaleInPlace(-1),y.copyFrom(a).scaleInPlace(-1/_),P.copyFrom(h).scaleInPlace(1/m),y.addInPlace(P).scaleInPlace(-1),C.copyFrom(h).scaleInPlace(-1/m),P.copyFrom(o).scaleInPlace(-1/p),C.addInPlace(P).scaleInPlace(-1);const E=f.Vector3[9];let A;E.copyFrom(S).subtractInPlace(t),u.CrossToRef(T,E,P),A=u.Dot(P,c);const R=A;E.copyFrom(S).subtractInPlace(i),u.CrossToRef(y,E,P),A=u.Dot(P,c);const I=A;E.copyFrom(S).subtractInPlace(r),u.CrossToRef(C,E,P),A=u.Dot(P,c);const M=A,O=f.Vector3[10];let w,D;R>0&&I<0?(O.copyFrom(a),w=t,D=i):I>0&&M<0?(O.copyFrom(h),w=i,D=r):(O.copyFrom(o).scaleInPlace(-1),w=r,D=t);const F=f.Vector3[9],N=f.Vector3[4];if(w.subtractToRef(S,P),D.subtractToRef(S,F),u.CrossToRef(P,F,N),!(u.Dot(N,c)<0))return n.copyFrom(S),Math.abs(v*b);const L=f.Vector3[5];u.CrossToRef(O,N,L),L.normalize();const B=f.Vector3[9];B.copyFrom(w).subtractInPlace(S);const k=B.length();if(k<s.bH)return n.copyFrom(w),u.Distance(e,w);B.normalizeFromLength(k);const V=u.Dot(L,B),U=f.Vector3[7];U.copyFrom(S).addInPlace(L.scaleInPlace(k*V)),P.copyFrom(U).subtractInPlace(w),v=O.length(),O.normalizeFromLength(v);let z=u.Dot(P,O)/Math.max(v,s.bH);return z=(0,l.Clamp)(z,0,1),U.copyFrom(w).addInPlace(O.scaleInPlace(z*v)),n.copyFrom(U),u.Distance(e,U)}static Center(e,t){return u.CenterToRef(e,t,u.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const s=new u;return u.RotationFromAxisToRef(e,t,i,s),s}static RotationFromAxisToRef(e,t,i,s){const r=f.Quaternion[0];return _.RotationQuaternionFromAxisToRef(e,t,i,r),r.toEulerAnglesToRef(s),s}}u._UpReadOnly=u.Up(),u._DownReadOnly=u.Down(),u._LeftHandedForwardReadOnly=u.Forward(!1),u._RightHandedForwardReadOnly=u.Forward(!0),u._LeftHandedBackwardReadOnly=u.Backward(!1),u._RightHandedBackwardReadOnly=u.Backward(!0),u._RightReadOnly=u.Right(),u._LeftReadOnly=u.Left(),u._ZeroReadOnly=u.Zero(),u._OneReadOnly=u.One(),Object.defineProperties(u.prototype,{dimension:{value:[3]},rank:{value:1}});class d{constructor(e=0,t=0,i=0,s=0){this.x=e,this.y=t,this.z=i,this.w=s}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){let e=h(this.x);return e=397*e^h(this.y),e=397*e^h(this.z),e=397*e^h(this.w),e}asArray(){return[this.x,this.y,this.z,this.w]}toArray(e,t){return void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return d.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addInPlaceFromFloats(e,t,i,s){return this.x+=e,this.y+=t,this.z+=i,this.w+=s,this}add(e){return new d(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new d(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,s){return new d(this.x-e,this.y-t,this.z-i,this.w-s)}subtractFromFloatsToRef(e,t,i,s,r){return r.x=this.x-e,r.y=this.y-t,r.z=this.z-i,r.w=this.w-s,r}negate(){return new d(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=-this.w,e}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new d(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=s.bH){return e&&(0,l.WithinEpsilon)(this.x,e.x,t)&&(0,l.WithinEpsilon)(this.y,e.y,t)&&(0,l.WithinEpsilon)(this.z,e.z,t)&&(0,l.WithinEpsilon)(this.w,e.w,t)}equalsToFloats(e,t,i,s){return this.x===e&&this.y===t&&this.z===i&&this.w===s}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new d(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,s){return new d(this.x*e,this.y*t,this.z*i,this.w*s)}divide(e){return new d(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}minimizeInPlaceFromFloats(e,t,i,s){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this.z=Math.min(i,this.z),this.w=Math.min(s,this.w),this}maximizeInPlaceFromFloats(e,t,i,s){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this.z=Math.max(i,this.z),this.w=Math.max(s,this.w),this}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e.z=Math.floor(this.z),e.w=Math.floor(this.w),e}floor(){return new d(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e.z=this.z-Math.floor(this.z),e.w=this.w-Math.floor(this.w),e}fract(){return new d(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new d)}normalizeToRef(e){const t=this.length();return 0===t||1===t?(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e):this.scaleToRef(1/t,e)}toVector3(){return new u(this.x,this.y,this.z)}clone(){return new d(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.x=this.y=this.z=this.w=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}static FromArray(e,t){return t||(t=0),new d(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return d.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,s,r){return r.x=e,r.y=t,r.z=i,r.w=s,r}static Zero(){return new d(0,0,0,0)}static One(){return new d(1,1,1,1)}static Random(e=0,t=1){return new d((0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t))}static RandomToRef(e=0,t=1,i){return i.x=(0,l.RandomRange)(e,t),i.y=(0,l.RandomRange)(e,t),i.z=(0,l.RandomRange)(e,t),i.w=(0,l.RandomRange)(e,t),i}static Clamp(e,t,i){return d.ClampToRef(e,t,i,new d)}static ClampToRef(e,t,i,s){return s.x=(0,l.Clamp)(e.x,t.x,i.x),s.y=(0,l.Clamp)(e.y,t.y,i.y),s.z=(0,l.Clamp)(e.z,t.z,i.z),s.w=(0,l.Clamp)(e.w,t.w,i.w),s}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static get ZeroReadOnly(){return d._ZeroReadOnly}static Normalize(e){return d.NormalizeToRef(e,new d)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=new d;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new d;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(d.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z,n=e.w-t.w;return i*i+s*s+r*r+n*n}static Center(e,t){return d.CenterToRef(e,t,new d)}static CenterToRef(e,t,i){return i.x=(e.x+t.x)/2,i.y=(e.y+t.y)/2,i.z=(e.z+t.z)/2,i.w=(e.w+t.w)/2,i}static TransformCoordinates(e,t){return d.TransformCoordinatesToRef(e,t,new d)}static TransformCoordinatesToRef(e,t,i){return d.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,r){const n=s.m,a=e*n[0]+t*n[4]+i*n[8]+n[12],o=e*n[1]+t*n[5]+i*n[9]+n[13],l=e*n[2]+t*n[6]+i*n[10]+n[14],h=e*n[3]+t*n[7]+i*n[11]+n[15];return r.x=a,r.y=o,r.z=l,r.w=h,r}static TransformNormal(e,t){return d.TransformNormalToRef(e,t,new d)}static TransformNormalToRef(e,t,i){const s=t.m,r=e.x*s[0]+e.y*s[4]+e.z*s[8],n=e.x*s[1]+e.y*s[5]+e.z*s[9],a=e.x*s[2]+e.y*s[6]+e.z*s[10];return i.x=r,i.y=n,i.z=a,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,s,r,n){const a=r.m;return n.x=e*a[0]+t*a[4]+i*a[8],n.y=e*a[1]+t*a[5]+i*a[9],n.z=e*a[2]+t*a[6]+i*a[10],n.w=s,n}static FromVector3(e,t=0){return new d(e._x,e._y,e._z,t)}static Dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}}d._ZeroReadOnly=d.Zero(),Object.defineProperties(d.prototype,{dimension:{value:[4]},rank:{value:1}});class _{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,s=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=s}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){let e=h(this._x);return e=397*e^h(this._y),e=397*e^h(this._z),e=397*e^h(this._w),e}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}fromArray(e,t=0){return _.FromArrayToRef(e,t,this)}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=s.bH){return e&&(0,l.WithinEpsilon)(this._x,e._x,t)&&(0,l.WithinEpsilon)(this._y,e._y,t)&&(0,l.WithinEpsilon)(this._z,e._z,t)&&(0,l.WithinEpsilon)(this._w,e._w,t)}clone(){return new _(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,s){return this._x=e,this._y=t,this._z=i,this._w=s,this._isDirty=!0,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.copyFromFloats(e,e,e,e)}add(e){return new _(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._w=this._w+e._w,t._isDirty=!0,t}addInPlaceFromFloats(e,t,i,s){return this._x+=e,this._y+=t,this._z+=i,this._w+=s,this._isDirty=!0,this}subtractToRef(e,t){return t._x=this._x-e._x,t._y=this._y-e._y,t._z=this._z-e._z,t._w=this._w-e._w,t._isDirty=!0,t}subtractFromFloats(e,t,i,s){return this.subtractFromFloatsToRef(e,t,i,s,new _)}subtractFromFloatsToRef(e,t,i,s,r){return r._x=this._x-e,r._y=this._y-t,r._z=this._z-i,r._w=this._w-s,r._isDirty=!0,r}subtract(e){return new _(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new _(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new _(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,s=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,r=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,n=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,s,r,n),t}multiplyInPlace(e){return this.multiplyToRef(e,this)}multiplyByFloats(e,t,i,s){return this._x*=e,this._y*=t,this._z*=i,this._w*=s,this._isDirty=!0,this}divide(e){throw new ReferenceError("Can not divide a quaternion")}divideToRef(e,t){throw new ReferenceError("Can not divide a quaternion")}divideInPlace(e){throw new ReferenceError("Can not divide a quaternion")}minimizeInPlace(){throw new ReferenceError("Can not minimize a quaternion")}minimizeInPlaceFromFloats(){throw new ReferenceError("Can not minimize a quaternion")}maximizeInPlace(){throw new ReferenceError("Can not maximize a quaternion")}maximizeInPlaceFromFloats(){throw new ReferenceError("Can not maximize a quaternion")}negate(){return this.negateToRef(new _)}negateInPlace(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._isDirty=!0,this}negateToRef(e){return e._x=-this._x,e._y=-this._y,e._z=-this._z,e._w=-this._w,e._isDirty=!0,e}equalsToFloats(e,t,i,s){return this._x===e&&this._y===t&&this._z===i&&this._w===s}floorToRef(e){throw new ReferenceError("Can not floor a quaternion")}floor(){throw new ReferenceError("Can not floor a quaternion")}fractToRef(e){throw new ReferenceError("Can not fract a quaternion")}fract(){throw new ReferenceError("Can not fract a quaternion")}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new _(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return 0==t||1==t||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return 0==e||1==e||this.scaleInPlace(1/e),this}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new _(0,0,0,1);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z,this._w):this.scaleToRef(1/t,e)}toEulerAngles(){const e=u.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,s=this._y,r=this._w,n=s*t-i*r,a=.4999999;if(n<-a)e._y=2*Math.atan2(s,r),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(n>a)e._y=2*Math.atan2(s,r),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const a=r*r,o=t*t,l=i*i,h=s*s;e._z=Math.atan2(2*(i*s+t*r),-o-l+h+a),e._x=Math.asin(-2*n),e._y=Math.atan2(2*(t*i+s*r),o-l-h+a),e._isDirty=!0}return e}toAlphaBetaGammaToRef(e){const t=this._z,i=this._x,s=this._y,r=this._w,n=Math.sqrt(i*i+s*s),a=Math.sqrt(t*t+r*r),o=2*Math.atan2(n,a),l=2*Math.atan2(t,r),h=2*Math.atan2(s,i),c=(l+h)/2,u=(l-h)/2;return e.set(u,o,c),e}toRotationMatrix(e){return p.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return _.FromRotationMatrixToRef(e,this),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}static FromRotationMatrix(e){const t=new _;return _.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,s=i[0],r=i[4],n=i[8],a=i[1],o=i[5],l=i[9],h=i[2],c=i[6],u=i[10],d=s+o+u;let _;return d>0?(_=.5/Math.sqrt(d+1),t._w=.25/_,t._x=(c-l)*_,t._y=(n-h)*_,t._z=(a-r)*_,t._isDirty=!0):s>o&&s>u?(_=2*Math.sqrt(1+s-o-u),t._w=(c-l)/_,t._x=.25*_,t._y=(r+a)/_,t._z=(n+h)/_,t._isDirty=!0):o>u?(_=2*Math.sqrt(1+o-s-u),t._w=(n-h)/_,t._x=(r+a)/_,t._y=.25*_,t._z=(l+c)/_,t._isDirty=!0):(_=2*Math.sqrt(1+u-s-o),t._w=(a-r)/_,t._x=(n+h)/_,t._y=(l+c)/_,t._z=.25*_,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const s=_.Dot(e,t);return 1-s*s<=i}static SmoothToRef(e,t,i,s,r){let n=0===s?1:i/s;return n=(0,l.Clamp)(n,0,1),_.SlerpToRef(e,t,n,r),r}static Zero(){return new _(0,0,0,0)}static Inverse(e){return new _(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new _(0,0,0,1)}static IsIdentity(e){return e&&0===e._x&&0===e._y&&0===e._z&&1===e._w}static RotationAxis(e,t){return _.RotationAxisToRef(e,t,new _)}static RotationAxisToRef(e,t,i){i._w=Math.cos(t/2);const s=Math.sin(t/2)/e.length();return i._x=e._x*s,i._y=e._y*s,i._z=e._z*s,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new _(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromFloatsToRef(e,t,i,s,r){return r.copyFromFloats(e,t,i,s),r}static FromEulerAngles(e,t,i){const s=new _;return _.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerAnglesToRef(e,t,i,s){return _.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerVector(e){const t=new _;return _.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return _.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,r=s.bH){const n=u.Dot(e,t)+1;return n<r?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(u.CrossToRef(e,t,m.Vector3[0]),i.set(m.Vector3[0].x,m.Vector3[0].y,m.Vector3[0].z,n)),i.normalize()}static RotationYawPitchRoll(e,t,i){const s=new _;return _.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){const r=.5*i,n=.5*t,a=.5*e,o=Math.sin(r),l=Math.cos(r),h=Math.sin(n),c=Math.cos(n),u=Math.sin(a),d=Math.cos(a);return s._x=d*h*l+u*c*o,s._y=u*c*l-d*h*o,s._z=d*c*o-u*h*l,s._w=d*c*l+u*h*o,s._isDirty=!0,s}static RotationAlphaBetaGamma(e,t,i){const s=new _;return _.RotationAlphaBetaGammaToRef(e,t,i,s),s}static RotationAlphaBetaGammaToRef(e,t,i,s){const r=.5*(i+e),n=.5*(i-e),a=.5*t;return s._x=Math.cos(n)*Math.sin(a),s._y=Math.sin(n)*Math.sin(a),s._z=Math.sin(r)*Math.cos(a),s._w=Math.cos(r)*Math.cos(a),s._isDirty=!0,s}static RotationQuaternionFromAxis(e,t,i){const s=new _(0,0,0,0);return _.RotationQuaternionFromAxisToRef(e,t,i,s),s}static RotationQuaternionFromAxisToRef(e,t,i,s){const r=f.Matrix[0];return e=e.normalizeToRef(f.Vector3[0]),t=t.normalizeToRef(f.Vector3[1]),i=i.normalizeToRef(f.Vector3[2]),p.FromXYZAxesToRef(e,t,i,r),_.FromRotationMatrixToRef(r,s),s}static FromLookDirectionLH(e,t){const i=new _;return _.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const s=f.Matrix[0];return p.LookDirectionLHToRef(e,t,s),_.FromRotationMatrixToRef(s,i),i}static FromLookDirectionRH(e,t){const i=new _;return _.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const s=f.Matrix[0];return p.LookDirectionRHToRef(e,t,s),_.FromRotationMatrixToRef(s,i)}static Slerp(e,t,i){const s=_.Identity();return _.SlerpToRef(e,t,i,s),s}static SlerpToRef(e,t,i,s){let r,n,a=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,o=!1;if(a<0&&(o=!0,a=-a),a>.999999)n=1-i,r=o?-i:i;else{const e=Math.acos(a),t=1/Math.sin(e);n=Math.sin((1-i)*e)*t,r=o?-Math.sin(i*e)*t:Math.sin(i*e)*t}return s._x=n*e._x+r*t._x,s._y=n*e._y+r*t._y,s._z=n*e._z+r*t._z,s._w=n*e._w+r*t._w,s._isDirty=!0,s}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,o=2*a-3*n+1,l=-2*a+3*n,h=a-2*n+r,c=a-n,u=e._x*o+i._x*l+t._x*h+s._x*c,d=e._y*o+i._y*l+t._y*h+s._y*c,p=e._z*o+i._z*l+t._z*h+s._z*c,f=e._w*o+i._w*l+t._w*h+s._w*c;return new _(u,d,p,f)}static Hermite1stDerivative(e,t,i,s,r){const n=new _;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;return n._x=6*(a-r)*e._x+(3*a-4*r+1)*t._x+6*(-a+r)*i._x+(3*a-2*r)*s._x,n._y=6*(a-r)*e._y+(3*a-4*r+1)*t._y+6*(-a+r)*i._y+(3*a-2*r)*s._y,n._z=6*(a-r)*e._z+(3*a-4*r+1)*t._z+6*(-a+r)*i._z+(3*a-2*r)*s._z,n._w=6*(a-r)*e._w+(3*a-4*r+1)*t._w+6*(-a+r)*i._w+(3*a-2*r)*s._w,n._isDirty=!0,n}static Normalize(e){const t=_.Zero();return _.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Clamp(e,t,i){const s=new _;return _.ClampToRef(e,t,i,s),s}static ClampToRef(e,t,i,s){return s.copyFromFloats((0,l.Clamp)(e.x,t.x,i.x),(0,l.Clamp)(e.y,t.y,i.y),(0,l.Clamp)(e.z,t.z,i.z),(0,l.Clamp)(e.w,t.w,i.w))}static Random(e=0,t=1){return new _((0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats((0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t),(0,l.RandomRange)(e,t))}static Minimize(){throw new ReferenceError("Quaternion.Minimize does not make sense")}static Maximize(){throw new ReferenceError("Quaternion.Maximize does not make sense")}static Distance(e,t){return Math.sqrt(_.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z,n=e.w-t.w;return i*i+s*s+r*r+n*n}static Center(e,t){return _.CenterToRef(e,t,_.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}}Object.defineProperties(_.prototype,{dimension:{value:[4]},rank:{value:1}});class p{static get Use64Bits(){return a.I.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=p._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,s=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=!this._isIdentity&&t,this._isIdentity3x2Dirty=!this._isIdentity3x2&&s}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,a.I.MatrixTrackPrecisionChange&&a.I.MatrixTrackedMatrices.push(this),this._m=new a.I.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,1!==this._m[0]||1!==this._m[5]||1!==this._m[15]||0!==this._m[1]||0!==this._m[2]||0!==this._m[3]||0!==this._m[4]||0!==this._m[6]||0!==this._m[7]||0!==this._m[8]||0!==this._m[9]||0!==this._m[10]||0!==this._m[11]||0!==this._m[12]||0!==this._m[13]||0!==this._m[14]?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(!0===this._isIdentity)return 1;const e=this._m,t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],a=e[5],o=e[6],l=e[7],h=e[8],c=e[9],u=e[10],d=e[11],_=e[12],p=e[13],f=e[14],m=e[15],g=u*m-f*d,v=c*m-p*d,b=c*f-p*u,x=h*m-_*d,S=h*f-u*_,T=h*p-_*c;return t*+(a*g-o*v+l*b)+i*-(n*g-o*x+l*S)+s*+(n*v-a*x+l*T)+r*-(n*b-a*S+o*T)}toString(){return`{${this.m[0]}, ${this.m[1]}, ${this.m[2]}, ${this.m[3]}\n${this.m[4]}, ${this.m[5]}, ${this.m[6]}, ${this.m[7]}\n${this.m[8]}, ${this.m[9]}, ${this.m[10]}, ${this.m[11]}\n${this.m[12]}, ${this.m[13]}, ${this.m[14]}, ${this.m[15]}}`}toArray(e=null,t=0){if(!e)return this._m;const i=this._m;for(let s=0;s<16;s++)e[t+s]=i[s];return this}asArray(){return this._m}fromArray(e,t=0){return p.FromArrayToRef(e,t,this)}copyFromFloats(...e){return p.FromArrayToRef(e,0,this)}set(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=e[i];return this.markAsUpdated(),this}setAll(e){const t=this._m;for(let i=0;i<16;i++)t[i]=e;return this.markAsUpdated(),this}invert(){return this.invertToRef(this),this}reset(){return p.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new p;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,s=t._m,r=e.m;for(let e=0;e<16;e++)s[e]=i[e]+r[e];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;return t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[3],t[4]+=i[4],t[5]+=i[5],t[6]+=i[6],t[7]+=i[7],t[8]+=i[8],t[9]+=i[9],t[10]+=i[10],t[11]+=i[11],t[12]+=i[12],t[13]+=i[13],t[14]+=i[14],t[15]+=i[15],this.markAsUpdated(),this}addInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]+=i[e];return this.markAsUpdated(),this}addInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]+=e[i];return this.markAsUpdated(),this}subtract(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]-=i[e];return this.markAsUpdated(),this}subtractToRef(e,t){const i=this._m,s=e.m,r=t._m;for(let e=0;e<16;e++)r[e]=i[e]-s[e];return t.markAsUpdated(),t}subtractInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]-=i[e];return this.markAsUpdated(),this}subtractFromFloats(...e){return this.subtractFromFloatsToRef(...e,new p)}subtractFromFloatsToRef(...e){const t=e.pop(),i=this._m,s=t._m,r=e;for(let e=0;e<16;e++)s[e]=i[e]-r[e];return t.markAsUpdated(),t}invertToRef(e){if(!0===this._isIdentity)return p.IdentityToRef(e),e;const t=this._m,i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],o=t[5],l=t[6],h=t[7],c=t[8],u=t[9],d=t[10],_=t[11],f=t[12],m=t[13],g=t[14],v=t[15],b=d*v-g*_,x=u*v-m*_,S=u*g-m*d,T=c*v-f*_,y=c*g-d*f,C=c*m-f*u,P=+(o*b-l*x+h*S),E=-(a*b-l*T+h*y),A=+(a*x-o*T+h*C),R=-(a*S-o*y+l*C),I=i*P+s*E+r*A+n*R;if(0===I)return e.copyFrom(this),e;const M=1/I,O=l*v-g*h,w=o*v-m*h,D=o*g-m*l,F=a*v-f*h,N=a*g-f*l,L=a*m-f*o,B=l*_-d*h,k=o*_-u*h,V=o*d-u*l,U=a*_-c*h,z=a*d-c*l,G=a*u-c*o,H=-(s*b-r*x+n*S),W=+(i*b-r*T+n*y),X=-(i*x-s*T+n*C),K=+(i*S-s*y+r*C),Q=+(s*O-r*w+n*D),Y=-(i*O-r*F+n*N),q=+(i*w-s*F+n*L),$=-(i*D-s*N+r*L),j=-(s*B-r*k+n*V),Z=+(i*B-r*U+n*z),J=-(i*k-s*U+n*G),ee=+(i*V-s*z+r*G);return p.FromValuesToRef(P*M,H*M,Q*M,j*M,E*M,W*M,Y*M,Z*M,A*M,X*M,q*M,J*M,R*M,K*M,$*M,ee*M,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new u(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return p.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]),this}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiply(e){const t=new p;return this.multiplyToRef(e,t),t}multiplyInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]*=i[e];return this.markAsUpdated(),this}multiplyByFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]*=e[i];return this.markAsUpdated(),this}multiplyByFloatsToRef(...e){const t=e.pop(),i=this._m,s=t._m,r=e;for(let e=0;e<16;e++)s[e]=i[e]*r[e];return t.markAsUpdated(),t}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const s=this._m,r=e.m,n=s[0],a=s[1],o=s[2],l=s[3],h=s[4],c=s[5],u=s[6],d=s[7],_=s[8],p=s[9],f=s[10],m=s[11],g=s[12],v=s[13],b=s[14],x=s[15],S=r[0],T=r[1],y=r[2],C=r[3],P=r[4],E=r[5],A=r[6],R=r[7],I=r[8],M=r[9],O=r[10],w=r[11],D=r[12],F=r[13],N=r[14],L=r[15];return t[i]=n*S+a*P+o*I+l*D,t[i+1]=n*T+a*E+o*M+l*F,t[i+2]=n*y+a*A+o*O+l*N,t[i+3]=n*C+a*R+o*w+l*L,t[i+4]=h*S+c*P+u*I+d*D,t[i+5]=h*T+c*E+u*M+d*F,t[i+6]=h*y+c*A+u*O+d*N,t[i+7]=h*C+c*R+u*w+d*L,t[i+8]=_*S+p*P+f*I+m*D,t[i+9]=_*T+p*E+f*M+m*F,t[i+10]=_*y+p*A+f*O+m*N,t[i+11]=_*C+p*R+f*w+m*L,t[i+12]=g*S+v*P+b*I+x*D,t[i+13]=g*T+v*E+b*M+x*F,t[i+14]=g*y+v*A+b*O+x*N,t[i+15]=g*C+v*R+b*w+x*L,this}divide(e){return this.divideToRef(e,new p)}divideToRef(e,t){const i=this._m,s=e.m,r=t._m;for(let e=0;e<16;e++)r[e]=i[e]/s[e];return t.markAsUpdated(),t}divideInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]/=i[e];return this.markAsUpdated(),this}minimizeInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]=Math.min(t[e],i[e]);return this.markAsUpdated(),this}minimizeInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}maximizeInPlace(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]=Math.min(t[e],i[e]);return this.markAsUpdated(),this}maximizeInPlaceFromFloats(...e){const t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}negate(){return this.negateToRef(new p)}negateInPlace(){const e=this._m;for(let t=0;t<16;t++)e[t]=-e[t];return this.markAsUpdated(),this}negateToRef(e){const t=this._m,i=e._m;for(let e=0;e<16;e++)i[e]=-t[e];return e.markAsUpdated(),e}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,s=t.m;return i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]&&i[3]===s[3]&&i[4]===s[4]&&i[5]===s[5]&&i[6]===s[6]&&i[7]===s[7]&&i[8]===s[8]&&i[9]===s[9]&&i[10]===s[10]&&i[11]===s[11]&&i[12]===s[12]&&i[13]===s[13]&&i[14]===s[14]&&i[15]===s[15]}equalsWithEpsilon(e,t=0){const i=this._m,s=e.m;for(let e=0;e<16;e++)if(!(0,l.WithinEpsilon)(i[e],s[e],t))return!1;return!0}equalsToFloats(...e){const t=this._m;for(let i=0;i<16;i++)if(t[i]!=e[i])return!1;return!0}floor(){return this.floorToRef(new p)}floorToRef(e){const t=this._m,i=e._m;for(let e=0;e<16;e++)i[e]=Math.floor(t[e]);return e.markAsUpdated(),e}fract(){return this.fractToRef(new p)}fractToRef(e){const t=this._m,i=e._m;for(let e=0;e<16;e++)i[e]=t[e]-Math.floor(t[e]);return e.markAsUpdated(),e}clone(){const e=new p;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=h(this._m[0]);for(let t=1;t<16;t++)e=397*e^h(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new _,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,s,r=!0){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const n=this._m;if(i&&i.copyFromFloats(n[12],n[13],n[14]),(e=e||f.Vector3[0]).x=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),e.y=Math.sqrt(n[4]*n[4]+n[5]*n[5]+n[6]*n[6]),e.z=Math.sqrt(n[8]*n[8]+n[9]*n[9]+n[10]*n[10]),s){const t=(r?s.absoluteScaling.x:s.scaling.x)<0?-1:1,i=(r?s.absoluteScaling.y:s.scaling.y)<0?-1:1,n=(r?s.absoluteScaling.z:s.scaling.z)<0?-1:1;e.x*=t,e.y*=i,e.z*=n}else this.determinant()<=0&&(e.y*=-1);if(0===e._x||0===e._y||0===e._z)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const i=1/e._x,s=1/e._y,r=1/e._z;p.FromValuesToRef(n[0]*i,n[1]*i,n[2]*i,0,n[4]*s,n[5]*s,n[6]*s,0,n[8]*r,n[9]*r,n[10]*r,0,0,0,0,1,f.Matrix[0]),_.FromRotationMatrixToRef(f.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=4*e;return new d(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<=3){const i=4*e;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new p;return p.TransposeToRef(this,e),e}transposeToRef(e){return p.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,s,r){if(e<0||e>3)return this;const n=4*e;return this._m[n+0]=t,this._m[n+1]=i,this._m[n+2]=s,this._m[n+3]=r,this.markAsUpdated(),this}scale(e){const t=new p;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}scaleInPlace(e){const t=this._m;for(let i=0;i<16;i++)t[i]*=e;return this.markAsUpdated(),this}toNormalMatrix(e){const t=f.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return p.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new p;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=f.Vector3[0];if(!this.decompose(t))return p.IdentityToRef(e),e;const i=this._m,s=1/t._x,r=1/t._y,n=1/t._z;return p.FromValuesToRef(i[0]*s,i[1]*s,i[2]*s,0,i[4]*r,i[5]*r,i[6]*r,0,i[8]*n,i[9]*n,i[10]*n,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new p;return p.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let s=0;s<16;s++)i._m[s]=e[s+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,s){return s._m[0]=e[0+t]*i,s._m[1]=e[1+t]*i,s._m[2]=e[2+t]*i,s._m[3]=e[3+t]*i,s._m[4]=e[4+t]*i,s._m[5]=e[5+t]*i,s._m[6]=e[6+t]*i,s._m[7]=e[7+t]*i,s._m[8]=e[8+t]*i,s._m[9]=e[9+t]*i,s._m[10]=e[10+t]*i,s._m[11]=e[11+t]*i,s._m[12]=e[12+t]*i,s._m[13]=e[13+t]*i,s._m[14]=e[14+t]*i,s._m[15]=e[15+t]*i,s.markAsUpdated(),s}static get IdentityReadOnly(){return p._IdentityReadOnly}static FromValuesToRef(e,t,i,s,r,n,a,o,l,h,c,u,d,_,p,f,m){const g=m._m;g[0]=e,g[1]=t,g[2]=i,g[3]=s,g[4]=r,g[5]=n,g[6]=a,g[7]=o,g[8]=l,g[9]=h,g[10]=c,g[11]=u,g[12]=d,g[13]=_,g[14]=p,g[15]=f,m.markAsUpdated()}static FromValues(e,t,i,s,r,n,a,o,l,h,c,u,d,_,f,m){const g=new p,v=g._m;return v[0]=e,v[1]=t,v[2]=i,v[3]=s,v[4]=r,v[5]=n,v[6]=a,v[7]=o,v[8]=l,v[9]=h,v[10]=c,v[11]=u,v[12]=d,v[13]=_,v[14]=f,v[15]=m,g.markAsUpdated(),g}static Compose(e,t,i){const s=new p;return p.ComposeToRef(e,t,i,s),s}static ComposeToRef(e,t,i,s){const r=s._m,n=t._x,a=t._y,o=t._z,l=t._w,h=n+n,c=a+a,u=o+o,d=n*h,_=n*c,p=n*u,f=a*c,m=a*u,g=o*u,v=l*h,b=l*c,x=l*u,S=e._x,T=e._y,y=e._z;return r[0]=(1-(f+g))*S,r[1]=(_+x)*S,r[2]=(p-b)*S,r[3]=0,r[4]=(_-x)*T,r[5]=(1-(d+g))*T,r[6]=(m+v)*T,r[7]=0,r[8]=(p+b)*y,r[9]=(m-v)*y,r[10]=(1-(d+f))*y,r[11]=0,r[12]=i._x,r[13]=i._y,r[14]=i._z,r[15]=1,s.markAsUpdated(),s}static Identity(){const e=p.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return p.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=p.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new p;return p.RotationXToRef(e,t),t}static Invert(e){const t=new p;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return p.FromValuesToRef(1,0,0,0,0,s,i,0,0,-i,s,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationY(e){const t=new p;return p.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return p.FromValuesToRef(s,0,-i,0,0,1,0,0,i,0,s,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationZ(e){const t=new p;return p.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return p.FromValuesToRef(s,i,0,0,-i,s,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationAxis(e,t){const i=new p;return p.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const s=Math.sin(-t),r=Math.cos(-t),n=1-r;e=e.normalizeToRef(f.Vector3[0]);const a=i._m;return a[0]=e._x*e._x*n+r,a[1]=e._x*e._y*n-e._z*s,a[2]=e._x*e._z*n+e._y*s,a[3]=0,a[4]=e._y*e._x*n+e._z*s,a[5]=e._y*e._y*n+r,a[6]=e._y*e._z*n-e._x*s,a[7]=0,a[8]=e._z*e._x*n-e._y*s,a[9]=e._z*e._y*n+e._x*s,a[10]=e._z*e._z*n+r,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i,r=!1){const n=u.Dot(t,e),a=i._m;if(n<-1+s.bH)a[0]=-1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=r?1:-1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=r?-1:1,a[11]=0;else{const i=u.Cross(t,e),s=1/(1+n);a[0]=i._x*i._x*s+n,a[1]=i._y*i._x*s-i._z,a[2]=i._z*i._x*s+i._y,a[3]=0,a[4]=i._x*i._y*s+i._z,a[5]=i._y*i._y*s+n,a[6]=i._z*i._y*s-i._x,a[7]=0,a[8]=i._x*i._z*s-i._y,a[9]=i._y*i._z*s+i._x,a[10]=i._z*i._z*s+n,a[11]=0}return a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const s=new p;return p.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){return _.RotationYawPitchRollToRef(e,t,i,f.Quaternion[0]),f.Quaternion[0].toRotationMatrix(s),s}static Scaling(e,t,i){const s=new p;return p.ScalingToRef(e,t,i,s),s}static ScalingToRef(e,t,i,s){return p.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,s),s._updateIdentityStatus(1===e&&1===t&&1===i),s}static Translation(e,t,i){const s=new p;return p.TranslationToRef(e,t,i,s),s}static TranslationToRef(e,t,i,s){return p.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,s),s._updateIdentityStatus(0===e&&0===t&&0===i),s}static Lerp(e,t,i){const s=new p;return p.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){const r=s._m,n=e.m,a=t.m;for(let e=0;e<16;e++)r[e]=n[e]*(1-i)+a[e]*i;return s.markAsUpdated(),s}static DecomposeLerp(e,t,i){const s=new p;return p.DecomposeLerpToRef(e,t,i,s),s}static DecomposeLerpToRef(e,t,i,s){const r=f.Vector3[0],n=f.Quaternion[0],a=f.Vector3[1];e.decompose(r,n,a);const o=f.Vector3[2],l=f.Quaternion[1],h=f.Vector3[3];t.decompose(o,l,h);const c=f.Vector3[4];u.LerpToRef(r,o,i,c);const d=f.Quaternion[2];_.SlerpToRef(n,l,i,d);const m=f.Vector3[5];return u.LerpToRef(a,h,i,m),p.ComposeToRef(c,d,m,s),s}static LookAtLH(e,t,i){const s=new p;return p.LookAtLHToRef(e,t,i,s),s}static LookAtLHToRef(e,t,i,s){const r=f.Vector3[0],n=f.Vector3[1],a=f.Vector3[2];t.subtractToRef(e,a),a.normalize(),u.CrossToRef(i,a,r);const o=r.lengthSquared();0===o?r.x=1:r.normalizeFromLength(Math.sqrt(o)),u.CrossToRef(a,r,n),n.normalize();const l=-u.Dot(r,e),h=-u.Dot(n,e),c=-u.Dot(a,e);return p.FromValuesToRef(r._x,n._x,a._x,0,r._y,n._y,a._y,0,r._z,n._z,a._z,0,l,h,c,1,s),s}static LookAtRH(e,t,i){const s=new p;return p.LookAtRHToRef(e,t,i,s),s}static LookAtRHToRef(e,t,i,s){const r=f.Vector3[0],n=f.Vector3[1],a=f.Vector3[2];e.subtractToRef(t,a),a.normalize(),u.CrossToRef(i,a,r);const o=r.lengthSquared();0===o?r.x=1:r.normalizeFromLength(Math.sqrt(o)),u.CrossToRef(a,r,n),n.normalize();const l=-u.Dot(r,e),h=-u.Dot(n,e),c=-u.Dot(a,e);return p.FromValuesToRef(r._x,n._x,a._x,0,r._y,n._y,a._y,0,r._z,n._z,a._z,0,l,h,c,1,s),s}static LookDirectionLH(e,t){const i=new p;return p.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const s=f.Vector3[0];s.copyFrom(e),s.scaleInPlace(-1);const r=f.Vector3[1];return u.CrossToRef(t,s,r),p.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,s._x,s._y,s._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new p;return p.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const s=f.Vector3[2];return u.CrossToRef(t,e,s),p.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,s,r){const n=new p;return p.OrthoLHToRef(e,t,i,s,n,r),n}static OrthoLHToRef(e,t,i,s,r,n){const a=2/e,o=2/t,l=2/(s-i),h=-(s+i)/(s-i);return p.FromValuesToRef(a,0,0,0,0,o,0,0,0,0,l,0,0,0,h,1,r),n&&r.multiplyToRef(g,r),r._updateIdentityStatus(1===a&&1===o&&1===l&&0===h),r}static OrthoOffCenterLH(e,t,i,s,r,n,a){const o=new p;return p.OrthoOffCenterLHToRef(e,t,i,s,r,n,o,a),o}static OrthoOffCenterLHToRef(e,t,i,s,r,n,a,o){const l=2/(t-e),h=2/(s-i),c=2/(n-r),u=-(n+r)/(n-r),d=(e+t)/(e-t),_=(s+i)/(i-s);return p.FromValuesToRef(l,0,0,0,0,h,0,0,0,0,c,0,d,_,u,1,a),o&&a.multiplyToRef(g,a),a.markAsUpdated(),a}static ObliqueOffCenterLHToRef(e,t,i,s,r,n,a,o,l,h,c){const u=-a*Math.cos(o),d=-a*Math.sin(o);return p.TranslationToRef(0,0,-l,f.Matrix[1]),p.FromValuesToRef(1,0,0,0,0,1,0,0,u,d,1,0,0,0,0,1,f.Matrix[0]),f.Matrix[1].multiplyToRef(f.Matrix[0],f.Matrix[0]),p.TranslationToRef(0,0,l,f.Matrix[1]),f.Matrix[0].multiplyToRef(f.Matrix[1],f.Matrix[0]),p.OrthoOffCenterLHToRef(e,t,i,s,r,n,h,c),f.Matrix[0].multiplyToRef(h,h),h}static OrthoOffCenterRH(e,t,i,s,r,n,a){const o=new p;return p.OrthoOffCenterRHToRef(e,t,i,s,r,n,o,a),o}static OrthoOffCenterRHToRef(e,t,i,s,r,n,a,o){return p.OrthoOffCenterLHToRef(e,t,i,s,r,n,a,o),a._m[10]*=-1,a}static ObliqueOffCenterRHToRef(e,t,i,s,r,n,a,o,l,h,c){const u=a*Math.cos(o),d=a*Math.sin(o);return p.TranslationToRef(0,0,l,f.Matrix[1]),p.FromValuesToRef(1,0,0,0,0,1,0,0,u,d,1,0,0,0,0,1,f.Matrix[0]),f.Matrix[1].multiplyToRef(f.Matrix[0],f.Matrix[0]),p.TranslationToRef(0,0,-l,f.Matrix[1]),f.Matrix[0].multiplyToRef(f.Matrix[1],f.Matrix[0]),p.OrthoOffCenterRHToRef(e,t,i,s,r,n,h,c),f.Matrix[0].multiplyToRef(h,h),h}static PerspectiveLH(e,t,i,s,r,n=0){const a=new p,o=2*i/e,l=2*i/t,h=(s+i)/(s-i),c=-2*s*i/(s-i),u=Math.tan(n);return p.FromValuesToRef(o,0,0,0,0,l,0,u,0,0,h,1,0,0,c,0,a),r&&a.multiplyToRef(g,a),a._updateIdentityStatus(!1),a}static PerspectiveFovLH(e,t,i,s,r,n=0,a=!1){const o=new p;return p.PerspectiveFovLHToRef(e,t,i,s,o,!0,r,n,a),o}static PerspectiveFovLHToRef(e,t,i,s,r,n=!0,a,o=0,l=!1){const h=i,c=s,u=1/Math.tan(.5*e),d=n?u/t:u,_=n?u:u*t,f=l&&0===h?-1:0!==c?(c+h)/(c-h):1,m=l&&0===h?2*c:0!==c?-2*c*h/(c-h):-2*h,v=Math.tan(o);return p.FromValuesToRef(d,0,0,0,0,_,0,v,0,0,f,1,0,0,m,0,r),a&&r.multiplyToRef(g,r),r._updateIdentityStatus(!1),r}static PerspectiveFovReverseLHToRef(e,t,i,s,r,n=!0,a,o=0){const l=1/Math.tan(.5*e),h=n?l/t:l,c=n?l:l*t,u=Math.tan(o);return p.FromValuesToRef(h,0,0,0,0,c,0,u,0,0,-i,1,0,0,1,0,r),a&&r.multiplyToRef(g,r),r._updateIdentityStatus(!1),r}static PerspectiveFovRH(e,t,i,s,r,n=0,a=!1){const o=new p;return p.PerspectiveFovRHToRef(e,t,i,s,o,!0,r,n,a),o}static PerspectiveFovRHToRef(e,t,i,s,r,n=!0,a,o=0,l=!1){const h=i,c=s,u=1/Math.tan(.5*e),d=n?u/t:u,_=n?u:u*t,f=l&&0===h?1:0!==c?-(c+h)/(c-h):-1,m=l&&0===h?2*c:0!==c?-2*c*h/(c-h):-2*h,v=Math.tan(o);return p.FromValuesToRef(d,0,0,0,0,_,0,v,0,0,f,-1,0,0,m,0,r),a&&r.multiplyToRef(g,r),r._updateIdentityStatus(!1),r}static PerspectiveFovReverseRHToRef(e,t,i,s,r,n=!0,a,o=0){const l=1/Math.tan(.5*e),h=n?l/t:l,c=n?l:l*t,u=Math.tan(o);return p.FromValuesToRef(h,0,0,0,0,c,0,u,0,0,-i,-1,0,0,-1,0,r),a&&r.multiplyToRef(g,r),r._updateIdentityStatus(!1),r}static GetFinalMatrix(e,t,i,s,r,n){const a=e.width,o=e.height,l=e.x,h=e.y,c=p.FromValues(a/2,0,0,0,0,-o/2,0,0,0,0,n-r,0,l+a/2,o/2+h,r,1),u=new p;return t.multiplyToRef(i,u),u.multiplyToRef(s,u),u.multiplyToRef(c,u)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return a.I.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return a.I.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new p;return p.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=e.m,s=i[0],r=i[4],n=i[8],a=i[12],o=i[1],l=i[5],h=i[9],c=i[13],u=i[2],d=i[6],_=i[10],p=i[14],f=i[3],m=i[7],g=i[11],v=i[15],b=t._m;return b[0]=s,b[1]=r,b[2]=n,b[3]=a,b[4]=o,b[5]=l,b[6]=h,b[7]=c,b[8]=u,b[9]=d,b[10]=_,b[11]=p,b[12]=f,b[13]=m,b[14]=g,b[15]=v,t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new p;return p.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,s=e.normal.y,r=e.normal.z,n=-2*i,a=-2*s,o=-2*r;return p.FromValuesToRef(n*i+1,a*i,o*i,0,n*s,a*s+1,o*s,0,n*r,a*r,o*r+1,0,n*e.d,a*e.d,o*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,s){return p.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,s),s}static FromQuaternionToRef(e,t){const i=e._x*e._x,s=e._y*e._y,r=e._z*e._z,n=e._x*e._y,a=e._z*e._w,o=e._z*e._x,l=e._y*e._w,h=e._y*e._z,c=e._x*e._w;return t._m[0]=1-2*(s+r),t._m[1]=2*(n+a),t._m[2]=2*(o-l),t._m[3]=0,t._m[4]=2*(n-a),t._m[5]=1-2*(r+i),t._m[6]=2*(h+c),t._m[7]=0,t._m[8]=2*(o+l),t._m[9]=2*(h-c),t._m[10]=1-2*(s+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}p._UpdateFlagSeed=0,p._IdentityReadOnly=p.Identity(),Object.defineProperties(p.prototype,{dimension:{value:[4,4]},rank:{value:2}});class f{}f.Vector3=(0,r.ln)(11,u.Zero),f.Matrix=(0,r.ln)(2,p.Identity),f.Quaternion=(0,r.ln)(3,_.Zero);class m{}m.Vector2=(0,r.ln)(3,c.Zero),m.Vector3=(0,r.ln)(13,u.Zero),m.Vector4=(0,r.ln)(3,d.Zero),m.Quaternion=(0,r.ln)(3,_.Zero),m.Matrix=(0,r.ln)(8,p.Identity),(0,n.Y5)("BABYLON.Vector2",c),(0,n.Y5)("BABYLON.Vector3",u),(0,n.Y5)("BABYLON.Vector4",d),(0,n.Y5)("BABYLON.Matrix",p);const g=p.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1)},4494:(e,t,i)=>{"use strict";i.d(t,{L:()=>s});class s{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}toGlobal(e,t){return new s(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new s(this.x,this.y,this.width,this.height)}}},7517:(e,t,i)=>{"use strict";i.d(t,{O:()=>h,Q:()=>c});var s=i(9923),r=i(2956);const n=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],a=[()=>1,e=>e.y,e=>e.z,e=>e.x,e=>e.x*e.y,e=>e.y*e.z,e=>3*e.z*e.z-1,e=>e.x*e.z,e=>e.x*e.x-e.y*e.y],o=(e,t)=>n[e]*a[e](t),l=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class h{constructor(){this.preScaled=!1,this.l00=s.Pq.Zero(),this.l1_1=s.Pq.Zero(),this.l10=s.Pq.Zero(),this.l11=s.Pq.Zero(),this.l2_2=s.Pq.Zero(),this.l2_1=s.Pq.Zero(),this.l20=s.Pq.Zero(),this.l21=s.Pq.Zero(),this.l22=s.Pq.Zero()}addLight(e,t,i){r.AA.Vector3[0].set(t.r,t.g,t.b);const s=r.AA.Vector3[0],n=r.AA.Vector3[1];s.scaleToRef(i,n),n.scaleToRef(o(0,e),r.AA.Vector3[2]),this.l00.addInPlace(r.AA.Vector3[2]),n.scaleToRef(o(1,e),r.AA.Vector3[2]),this.l1_1.addInPlace(r.AA.Vector3[2]),n.scaleToRef(o(2,e),r.AA.Vector3[2]),this.l10.addInPlace(r.AA.Vector3[2]),n.scaleToRef(o(3,e),r.AA.Vector3[2]),this.l11.addInPlace(r.AA.Vector3[2]),n.scaleToRef(o(4,e),r.AA.Vector3[2]),this.l2_2.addInPlace(r.AA.Vector3[2]),n.scaleToRef(o(5,e),r.AA.Vector3[2]),this.l2_1.addInPlace(r.AA.Vector3[2]),n.scaleToRef(o(6,e),r.AA.Vector3[2]),this.l20.addInPlace(r.AA.Vector3[2]),n.scaleToRef(o(7,e),r.AA.Vector3[2]),this.l21.addInPlace(r.AA.Vector3[2]),n.scaleToRef(o(8,e),r.AA.Vector3[2]),this.l22.addInPlace(r.AA.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(l[0]),this.l1_1.scaleInPlace(l[1]),this.l10.scaleInPlace(l[2]),this.l11.scaleInPlace(l[3]),this.l2_2.scaleInPlace(l[4]),this.l2_1.scaleInPlace(l[5]),this.l20.scaleInPlace(l[6]),this.l21.scaleInPlace(l[7]),this.l22.scaleInPlace(l[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(n[0]),this.l1_1.scaleInPlace(n[1]),this.l10.scaleInPlace(n[2]),this.l11.scaleInPlace(n[3]),this.l2_2.scaleInPlace(n[4]),this.l2_1.scaleInPlace(n[5]),this.l20.scaleInPlace(n[6]),this.l21.scaleInPlace(n[7]),this.l22.scaleInPlace(n[8])}updateFromArray(e){return s.Pq.FromArrayToRef(e[0],0,this.l00),s.Pq.FromArrayToRef(e[1],0,this.l1_1),s.Pq.FromArrayToRef(e[2],0,this.l10),s.Pq.FromArrayToRef(e[3],0,this.l11),s.Pq.FromArrayToRef(e[4],0,this.l2_2),s.Pq.FromArrayToRef(e[5],0,this.l2_1),s.Pq.FromArrayToRef(e[6],0,this.l20),s.Pq.FromArrayToRef(e[7],0,this.l21),s.Pq.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return s.Pq.FromFloatsToRef(e[0],e[1],e[2],this.l00),s.Pq.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),s.Pq.FromFloatsToRef(e[6],e[7],e[8],this.l10),s.Pq.FromFloatsToRef(e[9],e[10],e[11],this.l11),s.Pq.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),s.Pq.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),s.Pq.FromFloatsToRef(e[18],e[19],e[20],this.l20),s.Pq.FromFloatsToRef(e[21],e[22],e[23],this.l21),s.Pq.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return(new h).updateFromArray(e)}static FromPolynomial(e){const t=new h;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class c{constructor(){this.x=s.Pq.Zero(),this.y=s.Pq.Zero(),this.z=s.Pq.Zero(),this.xx=s.Pq.Zero(),this.yy=s.Pq.Zero(),this.zz=s.Pq.Zero(),this.xy=s.Pq.Zero(),this.yz=s.Pq.Zero(),this.zx=s.Pq.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=h.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){r.AA.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=r.AA.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),r.AA.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),r.AA.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(r.AA.Vector3[0]).addInPlace(r.AA.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(r.AA.Vector3[0]).subtractInPlace(r.AA.Vector3[1]),this.zz.copyFrom(e.l00),r.AA.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(r.AA.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return(new c).updateFromHarmonics(e)}static FromArray(e){const t=new c;return s.Pq.FromArrayToRef(e[0],0,t.x),s.Pq.FromArrayToRef(e[1],0,t.y),s.Pq.FromArrayToRef(e[2],0,t.z),s.Pq.FromArrayToRef(e[3],0,t.xx),s.Pq.FromArrayToRef(e[4],0,t.yy),s.Pq.FromArrayToRef(e[5],0,t.zz),s.Pq.FromArrayToRef(e[6],0,t.yz),s.Pq.FromArrayToRef(e[7],0,t.zx),s.Pq.FromArrayToRef(e[8],0,t.xy),t}}},4329:(e,t,i)=>{"use strict";i.d(t,{A:()=>r});var s=i(1504);class r extends s.n{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}},5907:(e,t,i)=>{"use strict";i.d(t,{K:()=>l});var s=i(5616),r=i(7103),n=i(863),a=i(1139),o=i(5476);class l{get materialDefines(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:this._getDrawWrapper()?.defines}set materialDefines(e){(this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0)).defines=e}_getDrawWrapper(e,t=!1){e=e??this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new o.E(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){t&&this._drawWrappers[e]?.dispose(),this._drawWrappers[e]=void 0}get effect(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:this._getDrawWrapper()?.effect??null}get _drawWrapper(){return this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,s=!0){const r=this._drawWrapper;r.setEffect(e,t,s),void 0!==i&&(r.materialContext=i),e||(r.defines=null,r.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers){if(void 0!==e)return void this._removeDrawWrapper(e);for(const e of this._drawWrappers)e?.dispose()}this._drawWrappers=[]}static AddToMesh(e,t,i,s,r,n,a,o=!0){return new l(e,t,i,s,r,n,a,o)}constructor(e,t,i,s,r,n,a,o=!0,l=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=s,this.indexCount=r,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=n,this._renderingMesh=a||n,l&&n.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=n.subMeshes.length-1,o&&(this.refreshBoundingInfo(),n.computeWorldMatrix(!0))}get IsGlobal(){return 0===this.verticesStart&&this.verticesCount===this._mesh.getTotalVertices()&&0===this.indexStart&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){return(this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null)||this._renderingMesh}getMaterial(e=!0){const t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId)??this._renderingMesh.material;if(!t)return e?this._mesh.getScene().defaultMaterial:null;if(this._isMultiMaterial(t)){const e=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==e&&(this._currentMaterial=e,this.resetDrawCache()),e}return t}_isMultiMaterial(e){return void 0!==e.getSubMaterial}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(s.R.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(0===this.indexStart&&this.indexCount===t.length){const e=this._renderingMesh.getBoundingInfo();i={minimum:e.minimum.clone(),maximum:e.maximum.clone()}}else i=(0,a.c)(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new n.j(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isInFrustum(e,this._mesh.cullingStrategy)}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isCompletelyInFrustum(e)}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let t=this.indexStart;t<this.indexStart+this.indexCount;t+=3)i.push(e[t],e[t+1],e[t+1],e[t+2],e[t+2],e[t]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return!!t&&e.intersectsBox(t.boundingBox)}intersects(e,t,i,s,r){const n=this.getMaterial();if(!n)return null;let a=3,o=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return null;case 7:a=1,o=!0}return 4===n.fillMode?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,s):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,s):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,s,r):this._intersectTriangles(e,t,i,a,o,s,r)}_intersectLines(e,t,i,s,n){let a=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){const l=t[i[o]],h=t[i[o+1]],c=e.intersectionSegment(l,h,s);if(!(c<0)&&(n||!a||c<a.distance)&&(a=new r.w(null,null,c),a.faceId=o/2,n))break}return a}_intersectUnIndexedLines(e,t,i,s,n){let a=null;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=2){const o=t[i],l=t[i+1],h=e.intersectionSegment(o,l,s);if(!(h<0)&&(n||!a||h<a.distance)&&(a=new r.w(null,null,h),a.faceId=i/2,n))break}return a}_intersectTriangles(e,t,i,s,r,n,a){let o=null,l=-1;for(let h=this.indexStart;h<this.indexStart+this.indexCount-(3-s);h+=s){l++;const s=i[h],c=i[h+1],u=i[h+2];if(r&&4294967295===u){h+=2;continue}const d=t[s],_=t[c],p=t[u];if(!d||!_||!p)continue;if(a&&!a(d,_,p,e,s,c,u))continue;const f=e.intersectsTriangle(d,_,p);if(f){if(f.distance<0)continue;if((n||!o||f.distance<o.distance)&&(o=f,o.faceId=l,n))break}}return o}_intersectUnIndexedTriangles(e,t,i,s,r){let n=null;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){const a=t[i],o=t[i+1],l=t[i+2];if(r&&!r(a,o,l,e,-1,-1,-1))continue;const h=e.intersectsTriangle(a,o,l);if(h){if(h.distance<0)continue;if((s||!n||h.distance<n.distance)&&(n=h,n.faceId=i/3,s))break}}return n}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new l(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const e=this.getBoundingInfo();if(!e)return i;i._boundingInfo=new n.j(e.minimum,e.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,s,r,n=!0){let a=Number.MAX_VALUE,o=-Number.MAX_VALUE;const h=(r||s).getIndices();for(let e=t;e<t+i;e++){const t=h[e];t<a&&(a=t),t>o&&(o=t)}return new l(e,a,o-a+1,t,i,s,r,n)}}},6755:(e,t,i)=>{"use strict";i.d(t,{d:()=>h});var s=i(9923),r=i(4867),n=i(7517),a=i(5559),o=i(6041);class l{constructor(e,t,i,s){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=s}}class h{static ConvertCubeMapTextureToSphericalPolynomial(e){if(!e.isCube)return null;e.getScene()?.getEngine().flushFramebuffer();const t=e.getSize().width,i=e.readPixels(0,void 0,void 0,!1),s=e.readPixels(1,void 0,void 0,!1);let r,n;e.isRenderTarget?(r=e.readPixels(3,void 0,void 0,!1),n=e.readPixels(2,void 0,void 0,!1)):(r=e.readPixels(2,void 0,void 0,!1),n=e.readPixels(3,void 0,void 0,!1));const a=e.readPixels(4,void 0,void 0,!1),o=e.readPixels(5,void 0,void 0,!1),l=e.gammaSpace;let h=0;return 1!=e.textureType&&2!=e.textureType||(h=1),new Promise((e=>{Promise.all([s,i,r,n,a,o]).then((([i,s,r,n,a,o])=>{const c={size:t,right:s,left:i,up:r,down:n,front:a,back:o,format:5,type:h,gammaSpace:l};e(this.ConvertCubeMapToSphericalPolynomial(c))}))}))}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new n.O;let i=0;const s=2/e.size,l=s,h=.5*s,c=h-1;for(let n=0;n<6;n++){const u=this._FileFaces[n],d=e[u.name];let _=c;const p=5===e.format?4:3;for(let n=0;n<e.size;n++){let f=c;for(let l=0;l<e.size;l++){const c=u.worldAxisForFileX.scale(f).add(u.worldAxisForFileY.scale(_)).add(u.worldAxisForNormal);c.normalize();const m=this._AreaElement(f-h,_-h)-this._AreaElement(f-h,_+h)-this._AreaElement(f+h,_-h)+this._AreaElement(f+h,_+h);let g=d[n*e.size*p+l*p+0],v=d[n*e.size*p+l*p+1],b=d[n*e.size*p+l*p+2];isNaN(g)&&(g=0),isNaN(v)&&(v=0),isNaN(b)&&(b=0),0===e.type&&(g/=255,v/=255,b/=255),e.gammaSpace&&(g=Math.pow((0,r.Clamp)(g),a.tk),v=Math.pow((0,r.Clamp)(v),a.tk),b=Math.pow((0,r.Clamp)(b),a.tk));const x=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const e=Math.max(g,v,b);if(e>x){const t=x/e;g*=t,v*=t,b*=t}}else g=(0,r.Clamp)(g,0,x),v=(0,r.Clamp)(v,0,x),b=(0,r.Clamp)(b,0,x);const S=new o.v9(g,v,b);t.addLight(c,S,m),i+=m,f+=s}_+=l}}const u=4*Math.PI*6/6/i;return t.scaleInPlace(u),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),n.Q.FromHarmonics(t)}}h._FileFaces=[new l("right",new s.Pq(1,0,0),new s.Pq(0,0,-1),new s.Pq(0,-1,0)),new l("left",new s.Pq(-1,0,0),new s.Pq(0,0,1),new s.Pq(0,-1,0)),new l("up",new s.Pq(0,1,0),new s.Pq(1,0,0),new s.Pq(0,0,1)),new l("down",new s.Pq(0,-1,0),new s.Pq(1,0,0),new s.Pq(0,0,-1)),new l("front",new s.Pq(0,0,1),new s.Pq(1,0,0),new s.Pq(0,-1,0)),new l("back",new s.Pq(0,0,-1),new s.Pq(-1,0,0),new s.Pq(0,-1,0))],h.MAX_HDRI_VALUE=4096,h.PRESERVE_CLAMPED_COLORS=!1},7309:(e,t,i)=>{"use strict";function s(e,t){const i=[];for(let s=0;s<e;++s)i.push(t());return i}function r(e,t){return s(e,t)}i.d(t,{lL:()=>a,ln:()=>r,mI:()=>s});const n=["push","splice","pop","shift","unshift"];function a(e,t){const i=n.map((i=>function(e,t,i){const s=e[t];if("function"!=typeof s)return null;const r=function(){const s=e.length,n=r.previous.apply(e,arguments);return i(t,s),n};return s.next=r,r.previous=s,e[t]=r,()=>{const i=r.previous;if(!i)return;const s=r.next;s?(i.next=s,s.previous=i):(i.next=void 0,e[t]=i),r.next=void 0,r.previous=void 0}}(e,i,t)));return()=>{i.forEach((e=>{e?.()}))}}},6464:(e,t,i)=>{"use strict";i.d(t,{D:()=>p});var s=i(4867),r=i(1137),n=i(6755),a=i(2683);i(9195);const o=131072,l=131072;function h(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const c=h("DXT1"),u=h("DXT3"),d=h("DXT5"),_=h("DX10");class p{static GetDDSInfo(e){const t=new Int32Array(e.buffer,e.byteOffset,31),i=new Int32Array(e.buffer,e.byteOffset,35);let s=1;t[2]&o&&(s=Math.max(1,t[7]));const r=t[21],n=r===_?i[32]:0;let a=0;switch(r){case 113:a=2;break;case 116:a=1;break;case _:if(10===n){a=2;break}if(2===n){a=1;break}}return{width:t[4],height:t[3],mipmapCount:s,isFourCC:!(4&~t[20]),isRGB:!(64&~t[20]),isLuminance:(t[20]&l)===l,isCube:!(512&~t[28]),isCompressed:r===c||r===u||r===d,dxgiFormat:n,textureType:a}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,i,s,r,n){const o=new Float32Array(s),l=new Uint16Array(r,i);let h=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[h]=(0,a.SX)(l[s]),o[h+1]=(0,a.SX)(l[s+1]),o[h+2]=(0,a.SX)(l[s+2]),p.StoreLODInAlphaChannel?o[h+3]=n:o[h+3]=(0,a.SX)(l[s+3]),h+=4}return o}static _GetHalfFloatRGBAArrayBuffer(e,t,i,s,r,n){if(p.StoreLODInAlphaChannel){const o=new Uint16Array(s),l=new Uint16Array(r,i);let h=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[h]=l[s],o[h+1]=l[s+1],o[h+2]=l[s+2],o[h+3]=(0,a.LZ)(n),h+=4}return o}return new Uint16Array(r,i,s)}static _GetFloatRGBAArrayBuffer(e,t,i,s,r,n){if(p.StoreLODInAlphaChannel){const a=new Float32Array(s),o=new Float32Array(r,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);a[l]=o[s],a[l+1]=o[s+1],a[l+2]=o[s+2],a[l+3]=n,l+=4}return a}return new Float32Array(r,i,s)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,i,s,r,n){const o=new Uint16Array(s),l=new Float32Array(r,i);let h=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++)o[h]=(0,a.LZ)(l[h]),o[h+1]=(0,a.LZ)(l[h+1]),o[h+2]=(0,a.LZ)(l[h+2]),p.StoreLODInAlphaChannel?o[h+3]=(0,a.LZ)(n):o[h+3]=(0,a.LZ)(l[h+3]),h+=4;return o}static _GetFloatAsUIntRGBAArrayBuffer(e,t,i,r,n,a){const o=new Uint8Array(r),l=new Float32Array(n,i);let h=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const r=4*(t+i*e);o[h]=255*(0,s.Clamp)(l[r]),o[h+1]=255*(0,s.Clamp)(l[r+1]),o[h+2]=255*(0,s.Clamp)(l[r+2]),p.StoreLODInAlphaChannel?o[h+3]=a:o[h+3]=255*(0,s.Clamp)(l[r+3]),h+=4}return o}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,i,r,n,o){const l=new Uint8Array(r),h=new Uint16Array(n,i);let c=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const r=4*(t+i*e);l[c]=255*(0,s.Clamp)((0,a.SX)(h[r])),l[c+1]=255*(0,s.Clamp)((0,a.SX)(h[r+1])),l[c+2]=255*(0,s.Clamp)((0,a.SX)(h[r+2])),p.StoreLODInAlphaChannel?l[c+3]=o:l[c+3]=255*(0,s.Clamp)((0,a.SX)(h[r+3])),c+=4}return l}static _GetRGBAArrayBuffer(e,t,i,s,r,n,a,o,l){const h=new Uint8Array(s),c=new Uint8Array(r,i);let u=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);h[u]=c[s+n],h[u+1]=c[s+a],h[u+2]=c[s+o],h[u+3]=c[s+l],u+=4}return h}static _ExtractLongWordOrder(e){return 0===e||255===e||-16777216===e?0:1+p._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,i,s,r,n,a,o){const l=new Uint8Array(s),h=new Uint8Array(r,i);let c=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=3*(t+i*e);l[c]=h[s+n],l[c+1]=h[s+a],l[c+2]=h[s+o],c+=3}return l}static _GetLuminanceArrayBuffer(e,t,i,s,r){const n=new Uint8Array(s),a=new Uint8Array(r,i);let o=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=t+i*e;n[o]=a[s],o++}return n}static UploadDDSLevels(e,t,i,s,a,l,h=-1,f,m=!0){let g=null;s.sphericalPolynomial&&(g=[]);const v=!!e.getCaps().s3tc;t.generateMipMaps=a;const b=new Int32Array(i.buffer,i.byteOffset,31);let x,S,T,y,C,P,E,A=0,R=0,I=1;if(542327876!==b[0])return void r.V.Error("Invalid magic number in DDS header");if(!s.isFourCC&&!s.isRGB&&!s.isLuminance)return void r.V.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(s.isCompressed&&!v)return void r.V.Error("Compressed textures are not supported on this platform.");let M=b[22];y=b[1]+4;let O=!1;if(s.isFourCC)switch(x=b[21],x){case c:I=8,R=33777;break;case u:I=16,R=33778;break;case d:I=16,R=33779;break;case 113:O=!0,M=64;break;case 116:O=!0,M=128;break;case _:{y+=20;let e=!1;switch(s.dxgiFormat){case 10:O=!0,M=64,e=!0;break;case 2:O=!0,M=128,e=!0;break;case 88:s.isRGB=!0,s.isFourCC=!1,M=32,e=!0}if(e)break}default:return void r.V.Error(["Unsupported FourCC code:",(w=x,String.fromCharCode(255&w,w>>8&255,w>>16&255,w>>24&255))])}var w;const D=p._ExtractLongWordOrder(b[23]),F=p._ExtractLongWordOrder(b[24]),N=p._ExtractLongWordOrder(b[25]),L=p._ExtractLongWordOrder(b[26]);O&&(R=e._getRGBABufferInternalSizedFormat(s.textureType)),P=1,b[2]&o&&!1!==a&&(P=Math.max(1,b[7]));const B=f||0,k=e.getCaps();for(let r=B;r<l;r++){for(S=b[4],T=b[3],E=0;E<P;++E){if(-1===h||h===E){const n=-1===h?E:0;if(!s.isCompressed&&s.isFourCC){t.format=5,A=S*T*4;let s=null;if(e._badOS||e._badDesktopOS||!k.textureHalfFloat&&!k.textureFloat)128===M?(s=p._GetFloatAsUIntRGBAArrayBuffer(S,T,i.byteOffset+y,A,i.buffer,n),g&&0==n&&g.push(p._GetFloatRGBAArrayBuffer(S,T,i.byteOffset+y,A,i.buffer,n))):64===M&&(s=p._GetHalfFloatAsUIntRGBAArrayBuffer(S,T,i.byteOffset+y,A,i.buffer,n),g&&0==n&&g.push(p._GetHalfFloatAsFloatRGBAArrayBuffer(S,T,i.byteOffset+y,A,i.buffer,n))),t.type=0;else{const e=k.textureFloat&&(m&&k.textureFloatLinearFiltering||!m),r=k.textureHalfFloat&&(m&&k.textureHalfFloatLinearFiltering||!m),a=(128===M||64===M&&!r)&&e?1:(64===M||128===M&&!e)&&r?2:0;let o,l=null;if(128===M)switch(a){case 1:o=p._GetFloatRGBAArrayBuffer,l=null;break;case 2:o=p._GetFloatAsHalfFloatRGBAArrayBuffer,l=p._GetFloatRGBAArrayBuffer;break;case 0:o=p._GetFloatAsUIntRGBAArrayBuffer,l=p._GetFloatRGBAArrayBuffer}else switch(a){case 1:o=p._GetHalfFloatAsFloatRGBAArrayBuffer,l=null;break;case 2:o=p._GetHalfFloatRGBAArrayBuffer,l=p._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:o=p._GetHalfFloatAsUIntRGBAArrayBuffer,l=p._GetHalfFloatAsFloatRGBAArrayBuffer}t.type=a,s=o(S,T,i.byteOffset+y,A,i.buffer,n),g&&0==n&&g.push(l?l(S,T,i.byteOffset+y,A,i.buffer,n):s)}s&&e._uploadDataToTextureDirectly(t,s,r,n)}else if(s.isRGB)t.type=0,24===M?(t.format=4,A=S*T*3,C=p._GetRGBArrayBuffer(S,T,i.byteOffset+y,A,i.buffer,D,F,N),e._uploadDataToTextureDirectly(t,C,r,n)):(t.format=5,A=S*T*4,C=p._GetRGBAArrayBuffer(S,T,i.byteOffset+y,A,i.buffer,D,F,N,L),e._uploadDataToTextureDirectly(t,C,r,n));else if(s.isLuminance){const s=e._getUnpackAlignement(),a=S;A=Math.floor((S+s-1)/s)*s*(T-1)+a,C=p._GetLuminanceArrayBuffer(S,T,i.byteOffset+y,A,i.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,C,r,n)}else A=Math.max(4,S)/4*Math.max(4,T)/4*I,C=new Uint8Array(i.buffer,i.byteOffset+y,A),t.type=0,e._uploadCompressedDataToTextureDirectly(t,R,S,T,C,r,n)}y+=M?S*T*(M/8):A,S*=.5,T*=.5,S=Math.max(1,S),T=Math.max(1,T)}if(void 0!==f)break}g&&g.length>0?s.sphericalPolynomial=n.d.ConvertCubeMapToSphericalPolynomial({size:b[4],right:g[0],left:g[1],up:g[2],down:g[3],front:g[4],back:g[5],format:5,type:1,gammaSpace:!1}):s.sphericalPolynomial=void 0}}p.StoreLODInAlphaChannel=!1},6080:(e,t,i)=>{"use strict";i.d(t,{B:()=>n,K:()=>a});const s={},r={};function n(e){const t=e.getClassName();return r[t]||(r[t]={}),r[t]}function a(e){const t=e.getClassName();if(s[t])return s[t];s[t]={};const i=s[t];let n=e,a=t;for(;a;){const e=r[a];for(const t in e)i[t]=e[t];let t,s=!1;do{if(t=Object.getPrototypeOf(n),!t.getClassName){s=!0;break}if(t.getClassName()!==a)break;n=t}while(t);if(s)break;a=t.getClassName(),n=t}return i}},9259:(e,t,i)=>{"use strict";i.d(t,{$z:()=>n,Cx:()=>b,GG:()=>g,P_:()=>u,WM:()=>c,Y9:()=>h,bR:()=>m,fW:()=>v,jT:()=>l,lK:()=>a,n1:()=>f,qK:()=>p,uM:()=>o,wL:()=>_,xG:()=>d});var s=i(6080);function r(e,t){return(i,r)=>{const n=(0,s.B)(i);n[r]||(n[r]={type:e,sourceName:t})}}function n(e,t=null){return function(e,t=null){return(i,s)=>{const r=t||"_"+s;Object.defineProperty(i,s,{get:function(){return this[r]},set:function(t){"function"==typeof this.equals&&this.equals(t)||this[r]!==t&&(this[r]=t,i[e].apply(this))},enumerable:!0,configurable:!0})}}(e,t)}function a(e){return r(0,e)}function o(e){return r(1,e)}function l(e){return r(2,e)}function h(e){return r(3,e)}function c(e){return r(4,e)}function u(e){return r(5,e)}function d(e){return r(6,e)}function _(e){return r(7,e)}function p(e){return r(8,e)}function f(e){return r(9,e)}function m(e){return r(10,e)}function g(e){return r(12,e)}function v(e){return r(11,e)}function b(e,t,i,s){const r=i.value;i.value=(...i)=>{let n=r;if("undefined"!=typeof _native&&_native[t]){const e=_native[t];n=s?(...t)=>s(...t)?e(...t):r(...t):e}return e[t]=n,n(...i)}}b.filter=function(e){return(t,i,s)=>b(t,i,s,e)}},6877:(e,t,i)=>{"use strict";i.d(t,{p:()=>h});var s=i(5503),r=i(7503),n=i(6041),a=i(9923),o=i(6080);const l=function(e,t,i,s={}){const n=e();r.Y&&r.Y.HasTags(t)&&r.Y.AddTagsTo(n,r.Y.GetTags(t,!0));const a=(0,o.K)(n),l={};for(const e in a){const r=a[e],o=t[e],c=r.type;if(null!=o&&("uniqueId"!==e||h.AllowLoadingUniqueId))switch(c){case 0:case 6:case 11:n[e]=o;break;case 1:s.cloneTexturesOnlyOnce&&l[o.uniqueId]?n[e]=l[o.uniqueId]:(n[e]=i||o.isRenderTarget?o:o.clone(),l[o.uniqueId]=n[e]);break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:n[e]=i?o:o.clone()}}return n};class h{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const s=e.animations[i];t.animations.push(s.serialize())}}}static Serialize(e,t){t||(t={}),r.Y&&(t.tags=r.Y.GetTags(e));const i=(0,o.K)(e);for(const s in i){const r=i[s],n=r.sourceName||s,a=r.type,o=e[s];if(null!=o&&("uniqueId"!==s||h.AllowLoadingUniqueId))switch(a){case 0:t[n]=o;break;case 1:case 3:case 7:case 9:t[n]=o.serialize();break;case 2:case 4:case 5:case 8:case 10:case 12:t[n]=o.asArray();break;case 6:case 11:t[n]=o.id}}return t}static ParseProperties(e,t,i,s){s||(s="");const r=(0,o.K)(t);for(const o in r){const l=r[o],c=e[l.sourceName||o],u=l.type;if(null!=c&&("uniqueId"!==o||h.AllowLoadingUniqueId)){const e=t;switch(u){case 0:e[o]=c;break;case 1:i&&(e[o]=h._TextureParser(c,i,s));break;case 2:e[o]=n.v9.FromArray(c);break;case 3:e[o]=h._FresnelParametersParser(c);break;case 4:e[o]=a.I9.FromArray(c);break;case 5:e[o]=a.Pq.FromArray(c);break;case 6:i&&(e[o]=i.getLastMeshById(c));break;case 7:e[o]=h._ColorCurvesParser(c);break;case 8:e[o]=n.ov.FromArray(c);break;case 9:e[o]=h._ImageProcessingConfigurationParser(c);break;case 10:e[o]=a.PT.FromArray(c);break;case 11:i&&(e[o]=i.getCameraById(c));break;case 12:e[o]=a.uq.FromArray(c)}}}}static Parse(e,t,i,s=null){const n=e();return r.Y&&r.Y.AddTagsTo(n,t.tags),h.ParseProperties(t,n,i,s),n}static Clone(e,t,i={}){return l(e,t,!1,i)}static Instanciate(e,t){return l(e,t,!0)}}h.AllowLoadingUniqueId=!1,h._ImageProcessingConfigurationParser=e=>{throw(0,s.n)("ImageProcessingConfiguration")},h._FresnelParametersParser=e=>{throw(0,s.n)("FresnelParameters")},h._ColorCurvesParser=e=>{throw(0,s.n)("ColorCurves")},h._TextureParser=(e,t,i)=>{throw(0,s.n)("Texture")}},4609:(e,t,i)=>{"use strict";i.d(t,{r:()=>n});var s=i(1137);const r=(e,t,i)=>e?e.getClassName&&"Mesh"===e.getClassName()?null:!e.getClassName||"SubMesh"!==e.getClassName()&&"PhysicsBody"!==e.getClassName()?e.clone?e.clone():Array.isArray(e)?e.slice():i&&"object"==typeof e?{...e}:null:e.clone(t):null;class n{static DeepCopy(e,t,i,n,a=!1){const o=function(e){const t=[];do{Object.getOwnPropertyNames(e).forEach((function(e){-1===t.indexOf(e)&&t.push(e)}))}while(e=Object.getPrototypeOf(e));return t}(e);for(const l of o){if("_"===l[0]&&(!n||-1===n.indexOf(l)))continue;if(l.endsWith("Observable"))continue;if(i&&-1!==i.indexOf(l))continue;const o=e[l],h=typeof o;if("function"!==h)try{if("object"===h)if(o instanceof Uint8Array)t[l]=Uint8Array.from(o);else if(o instanceof Array){if(t[l]=[],o.length>0)if("object"==typeof o[0])for(let e=0;e<o.length;e++){const i=r(o[e],t,a);-1===t[l].indexOf(i)&&t[l].push(i)}else t[l]=o.slice(0)}else t[l]=r(o,t,a);else t[l]=o}catch(e){s.V.Warn(e.message)}}}}},5503:(e,t,i)=>{"use strict";i.d(t,{n:()=>r});const s={};function r(e,t=!1){if(!t||!s[e])return s[e]=!0,`${e} needs to be imported before as it contains a side-effect required by your code.`}},8790:(e,t,i)=>{"use strict";function s(){return"undefined"!=typeof window}function r(){return"undefined"!=typeof navigator}function n(){return"undefined"!=typeof document}function a(e){let t="",i=e.firstChild;for(;i;)3===i.nodeType&&(t+=i.textContent),i=i.nextSibling;return t}i.d(t,{BA:()=>s,Nf:()=>n,XD:()=>r,Zl:()=>a})},5999:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Dispose:()=>b,DumpData:()=>v,DumpDataAsync:()=>g,DumpFramebuffer:()=>m,DumpTools:()=>x});var s=i(5616),r=i(4494),n=i(9848),a=i(4420),o=i(5476);i(6612);const l={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class h{constructor(e,t=l){this._fullscreenViewport=new r.L(0,0,1,1);const i=t.positions??l.positions,n=t.indices??l.indices;this.engine=e,this._vertexBuffers={[s.R.PositionKind]:new s.R(e,i,s.R.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(n),this._onContextRestoredObserver=e.onContextRestoredObservable.add((()=>{this._indexBuffer=e.createIndexBuffer(n);for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}))}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return void 0!==e.renderTarget}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const i=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[s.R.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[s.R.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class c{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){let t;this.onApplyObservable=new n.cP;const i=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)})));const s=e.defines?e.defines.join("\n"):"";this._drawWrapper=new o.E(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],i,e.samplerNames,s,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage,e.extraInitializationsAsync)):(this.effect=new a.M(t,e.attributeNames||["position"],i,e.samplerNames,e.engine,s,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage,e.extraInitializationsAsync),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})))}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}var u=i(998),d=i(4867),_=i(6315);let p,f=null;async function m(e,t,i,s,r="image/png",n,a){const o=await i.readPixels(0,0,e,t);v(e,t,new Uint8Array(o.buffer),s,r,n,!0,void 0,a)}function g(e,t,i,s="image/png",r,n=!1,a=!1,o){return new Promise((l=>{v(e,t,i,(e=>l(e)),s,r,n,a,o)}))}function v(e,t,s,r,n="image/png",a,o=!1,l=!1,m){(async function(){return f||(f=new Promise(((e,t)=>{let s,r=null;const n={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};Promise.resolve().then(i.bind(i,6321)).then((({ThinEngine:a})=>{try{s=new OffscreenCanvas(100,100),r=new a(s,!1,n)}catch(e){s=document.createElement("canvas"),r=new a(s,!1,n)}_.q.Instances.pop(),_.q.OnEnginesDisposedObservable.add((e=>{r&&e!==r&&!r.isDisposed&&0===_.q.Instances.length&&b()})),r.getCaps().parallelShaderCompile=void 0;const o=new h(r);Promise.resolve().then(i.bind(i,9820)).then((({passPixelShader:i})=>{if(!r)return void t("Engine is not defined");const n=new c({engine:r,name:i.name,fragmentShader:i.shader,samplerNames:["textureSampler"]});p={canvas:s,engine:r,renderer:o,wrapper:n},e(p)}))})).catch(t)}))),await f})().then((i=>{if(i.engine.setSize(e,t,!0),s instanceof Float32Array){const e=new Uint8Array(s.length);let t=s.length;for(;t--;){const i=s[t];e[t]=Math.round(255*(0,d.Clamp)(i))}s=e}const h=i.engine.createRawTexture(s,e,t,5,!1,!o,1);i.renderer.setViewport(),i.renderer.applyEffectWrapper(i.wrapper),i.wrapper.effect._bindTexture("textureSampler",h),i.renderer.draw(),l?u.S0.ToBlob(i.canvas,(e=>{const t=new FileReader;t.onload=e=>{const t=e.target.result;r&&r(t)},t.readAsArrayBuffer(e)}),n,m):u.S0.EncodeScreenshotCanvasData(i.canvas,r,n,a,m),h.dispose()}))}function b(){p?(p.wrapper.dispose(),p.renderer.dispose(),p.engine.dispose()):f?.then((e=>{e.wrapper.dispose(),e.renderer.dispose(),e.engine.dispose()})),p=null}const x={DumpData:v,DumpDataAsync:g,DumpFramebuffer:m,Dispose:b};u.S0.DumpData=v,u.S0.DumpDataAsync=g,u.S0.DumpFramebuffer=m},8563:(e,t,i)=>{"use strict";i.d(t,{Cf:()=>s,bu:()=>n,tG:()=>r});class s extends Error{}s._setPrototypeOf=Object.setPrototypeOf||((e,t)=>(e.__proto__=t,e));const r={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};class n extends s{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",s._setPrototypeOf(this,n.prototype)}}},655:(e,t,i)=>{"use strict";i.d(t,{rz:()=>I,eC:()=>b,f2:()=>A,zU:()=>C,hX:()=>m,W$:()=>T,NJ:()=>y,sh:()=>P,M1:()=>x});var s=i(2366),r=i(8790),n=i(9848);class a{}a.FilesToLoad={};var o=i(8563),l=i(6181),h=i(9125),c=i(6315),u=i(1137),d=i(2940),_=i(6741),p=i(6326);const f=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class m extends o.bu{constructor(e,t){super(e,o.tG.LoadFileError),this.name="LoadFileError",o.Cf._setPrototypeOf(this,m.prototype),t instanceof s.u?this.request=t:this.file=t}}class g extends o.bu{constructor(e,t){super(e,o.tG.RequestFileError),this.request=t,this.name="RequestFileError",o.Cf._setPrototypeOf(this,g.prototype)}}class v extends o.bu{constructor(e,t){super(e,o.tG.ReadFileError),this.file=t,this.name="ReadFileError",o.Cf._setPrototypeOf(this,v.prototype)}}const b={DefaultRetryStrategy:class{static ExponentialBackoff(e=3,t=500){return(i,s,r)=>0!==s.status||r>=e||-1!==i.indexOf("file:")?-1:Math.pow(2,r)*t}}.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:e=>e,ScriptBaseUrl:"",ScriptPreprocessUrl:e=>e,CleanUrl:e=>e.replace(/#/gm,"%23")},x=(e,t)=>{if((!e||0!==e.indexOf("data:"))&&b.CorsBehavior)if("string"==typeof b.CorsBehavior||b.CorsBehavior instanceof String)t.crossOrigin=b.CorsBehavior;else{const i=b.CorsBehavior(e);i&&(t.crossOrigin=i)}},S={getRequiredSize:null},T=(e,t,i,r,n="",o)=>{const h=c.q.LastCreatedEngine;if("undefined"==typeof HTMLImageElement&&!h?._features.forceBitmapOverHTMLImageElement)return i("LoadImage is only supported in web or BabylonNative environments."),null;let u,d=!1;e instanceof ArrayBuffer||ArrayBuffer.isView(e)?"undefined"!=typeof Blob&&"undefined"!=typeof URL?(u=URL.createObjectURL(new Blob([e],{type:n})),d=!0):u=`data:${n};base64,`+(0,l.EL)(e):e instanceof Blob?(u=URL.createObjectURL(e),d=!0):(u=b.CleanUrl(e),u=b.PreprocessUrl(u));const _=t=>{if(i){const s=u||e.toString();i(`Error while trying to load image: ${0===s.indexOf("http")||s.length<=128?s:s.slice(0,128)+"..."}`,t)}};if(h?._features.forceBitmapOverHTMLImageElement)return C(u,(s=>{h.createImageBitmap(new Blob([s],{type:n}),{premultiplyAlpha:"none",...o}).then((e=>{t(e),d&&URL.revokeObjectURL(u)})).catch((t=>{i&&i("Error while trying to load image: "+e,t)}))}),void 0,r||void 0,!0,((e,t)=>{_(t)})),null;const p=new Image;if(S.getRequiredSize){const t=S.getRequiredSize(e);t.width&&(p.width=t.width),t.height&&(p.height=t.height)}x(u,p);const f=[],m=()=>{f.forEach((e=>{e.target.removeEventListener(e.name,e.handler)})),f.length=0};f.push({target:p,name:"load",handler:()=>{m(),t(p),d&&p.src&&URL.revokeObjectURL(p.src)}}),f.push({target:p,name:"error",handler:e=>{m(),_(e),d&&p.src&&URL.revokeObjectURL(p.src)}}),f.push({target:document,name:"securitypolicyviolation",handler:e=>{if(e.blockedURI!==p.src||"report"===e.disposition)return;m();const t=new Error(`CSP violation of policy ${e.effectiveDirective} ${e.blockedURI}. Current policy is ${e.originalPolicy}`);c.q.UseFallbackTexture=!1,_(t),d&&p.src&&URL.revokeObjectURL(p.src),p.src=""}}),f.forEach((e=>{e.target.addEventListener(e.name,e.handler)}));const g="blob:"===u.substring(0,5),v="data:"===u.substring(0,5),T=()=>{g||v||!s.u.IsCustomRequestAvailable?p.src=u:C(u,((e,t,i)=>{const s=new Blob([e],{type:!n&&i?i:n}),r=URL.createObjectURL(s);d=!0,p.src=r}),void 0,r||void 0,!0,((e,t)=>{_(t)}))};if(!g&&!v&&r&&r.enableTexturesOffline)r.open((()=>{r&&r.loadImage(u,p)}),T);else{if(-1!==u.indexOf("file:")){const e=decodeURIComponent(u.substring(5).toLowerCase());if(a.FilesToLoad[e]&&"undefined"!=typeof URL){try{let t;try{t=URL.createObjectURL(a.FilesToLoad[e])}catch(i){t=URL.createObjectURL(a.FilesToLoad[e])}p.src=t,d=!0}catch(e){p.src=""}return p}}T()}return p},y=(e,t,i,s,r)=>{const a=new FileReader,o={onCompleteObservable:new n.cP,abort:()=>a.abort()};return a.onloadend=()=>o.onCompleteObservable.notifyObservers(o),r&&(a.onerror=()=>{r(new v(`Unable to read ${e.name}`,e))}),a.onload=e=>{t(e.target.result)},i&&(a.onprogress=i),s?a.readAsArrayBuffer(e):a.readAsText(e),o},C=(e,t,i,s,r,o,l)=>{if(e.name)return y(e,t,i,r,o?e=>{o(void 0,e)}:void 0);const h=e;if(-1!==h.indexOf("file:")){let e=decodeURIComponent(h.substring(5).toLowerCase());0===e.indexOf("./")&&(e=e.substring(2));const s=a.FilesToLoad[e];if(s)return y(s,t,i,r,o?e=>o(void 0,new m(e.message,e.file)):void 0)}const{match:c,type:_}=R(h);if(c){const e={onCompleteObservable:new n.cP,abort:()=>()=>{}};try{const e=r?I(h):M(h);t(e,void 0,_)}catch(e){o?o(void 0,e):u.V.Error(e.message||"Failed to parse the Data URL")}return d._.SetImmediate((()=>{e.onCompleteObservable.notifyObservers(e)})),e}return P(h,((e,i)=>{t(e,i?.responseURL,i?.getResponseHeader("content-type"))}),i,s,r,o?e=>{o(e.request,new m(e.message,e.request))}:void 0,l)},P=(e,t,i,a,o,l,h)=>{e=b.CleanUrl(e),e=b.PreprocessUrl(e);const c=b.BaseUrl+e;let d=!1;const _={onCompleteObservable:new n.cP,abort:()=>d=!0},p=()=>{let e,n=new s.u,a=null;const p=()=>{n&&(i&&n.removeEventListener("progress",i),e&&n.removeEventListener("readystatechange",e),n.removeEventListener("loadend",f))};let f=()=>{p(),_.onCompleteObservable.notifyObservers(_),_.onCompleteObservable.clear(),i=void 0,e=null,f=null,l=void 0,h=void 0,t=void 0};_.abort=()=>{d=!0,f&&f(),n&&n.readyState!==(XMLHttpRequest.DONE||4)&&n.abort(),null!==a&&(clearTimeout(a),a=null),n=null};const m=e=>{const t=e.message||"Unknown error";l&&n?l(new g(t,n)):u.V.Error(t)},v=u=>{if(n){if(n.open("GET",c),h)try{h(n)}catch(e){return void m(e)}o&&(n.responseType="arraybuffer"),i&&n.addEventListener("progress",i),f&&n.addEventListener("loadend",f),e=()=>{if(!d&&n&&n.readyState===(XMLHttpRequest.DONE||4)){if(e&&n.removeEventListener("readystatechange",e),n.status>=200&&n.status<300||0===n.status&&(!(0,r.BA)()||E())){try{t&&t(o?n.response:n.responseText,n)}catch(e){m(e)}return}const i=b.DefaultRetryStrategy;if(i){const e=i(c,n,u);if(-1!==e)return p(),n=new s.u,void(a=setTimeout((()=>v(u+1)),e))}const h=new g("Error status: "+n.status+" "+n.statusText+" - Unable to load "+c,n);l&&l(h)}},n.addEventListener("readystatechange",e),n.send()}};v(0)};if(a&&a.enableSceneOffline){const s=e=>{e&&e.status>400?l&&l(e):p()},r=()=>{a&&a.loadFile(b.BaseUrl+e,(e=>{!d&&t&&t(e),_.onCompleteObservable.notifyObservers(_)}),i?e=>{!d&&i&&i(e)}:void 0,s,o)};a.open(r,s)}else p();return _},E=()=>"undefined"!=typeof location&&"file:"===location.protocol,A=e=>f.test(e),R=e=>{const t=f.exec(e);return null===t||0===t.length?{match:!1,type:""}:{match:!0,type:t[0].replace("data:","").replace("base64,","")}};function I(e){return(0,l.yS)(e.split(",")[1])}const M=e=>(0,l.AV)(e.split(",")[1]);let O;p.$._FileToolsLoadImage=T,_.sg.loadFile=C,h.J.loadFile=C,((e,t,i,s,r,n,a,o,l,h)=>{O={DecodeBase64UrlToBinary:e,DecodeBase64UrlToString:t,DefaultRetryStrategy:i.DefaultRetryStrategy,BaseUrl:i.BaseUrl,CorsBehavior:i.CorsBehavior,PreprocessUrl:i.PreprocessUrl,IsBase64DataUrl:s,IsFileURL:r,LoadFile:n,LoadImage:a,ReadFile:o,RequestFile:l,SetCorsBehavior:h},Object.defineProperty(O,"DefaultRetryStrategy",{get:function(){return i.DefaultRetryStrategy},set:function(e){i.DefaultRetryStrategy=e}}),Object.defineProperty(O,"BaseUrl",{get:function(){return i.BaseUrl},set:function(e){i.BaseUrl=e}}),Object.defineProperty(O,"PreprocessUrl",{get:function(){return i.PreprocessUrl},set:function(e){i.PreprocessUrl=e}}),Object.defineProperty(O,"CorsBehavior",{get:function(){return i.CorsBehavior},set:function(e){i.CorsBehavior=e}})})(I,M,b,A,E,C,T,y,P,x)},8688:(e,t,i)=>{"use strict";function s(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}i.d(t,{z:()=>s})},9337:(e,t,i)=>{"use strict";i.d(t,{n:()=>n});var s=i(1137),r=i(6552);class n{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=(0,r.n9)(e);if(t)return t;s.V.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let n=window||this;for(let e=0,t=i.length;e<t;e++)n=n[i[e]];return"function"!=typeof n?null:n}}n.RegisteredExternalClasses={}},1137:(e,t,i)=>{"use strict";i.d(t,{V:()=>s});class s{static _CheckLimit(e,t){let i=s._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},s._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){const i=s._LogLimitOutputs[e];if(!i||!s.MessageLimitReached)return;const r=this._Levels[t];i.current===i.limit&&s[r.name](s.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,r.name??""))}static _AddLogEntry(e){s._LogCache=e+s._LogCache,s.OnNewCacheEntry&&s.OnNewCacheEntry(e)}static _FormatMessage(e){const t=e=>e<10?"0"+e:""+e,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){const r=Array.isArray(t)?t[0]:t;if(void 0!==i&&!s._CheckLimit(r,i))return;const n=s._FormatMessage(r),a=this._Levels[e],o=Array.isArray(t)?t.slice(1):[];a.logFunc&&a.logFunc("BJS - "+n,...o);const l=`<div style='color:${a.color}'>${n}</div><br>`;s._AddLogEntry(l),s._GenerateLimitMessage(r,e)}static get LogCache(){return s._LogCache}static ClearLogCache(){s._LogCache="",s._LogLimitOutputs={},s.errorsCount=0}static set LogLevels(e){s.Log=s._LogDisabled,s.Warn=s._LogDisabled,s.Error=s._LogDisabled,[s.MessageLogLevel,s.WarningLogLevel,s.ErrorLogLevel].forEach((t=>{if((e&t)===t){const e=this._Levels[t];s[e.name]=s._LogEnabled.bind(s,t)}}))}}s.NoneLogLevel=0,s.MessageLogLevel=1,s.WarningLogLevel=2,s.ErrorLogLevel=4,s.AllLogLevel=7,s.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",s._LogCache="",s._LogLimitOutputs={},s._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],s.errorsCount=0,s.Log=s._LogEnabled.bind(s,s.MessageLogLevel),s.Warn=s._LogEnabled.bind(s,s.WarningLogLevel),s.Error=s._LogEnabled.bind(s,s.ErrorLogLevel)},9848:(e,t,i)=>{"use strict";i.d(t,{cP:()=>n});class s{constructor(e,t=!1,i,s){this.initialize(e,t,i,s)}initialize(e,t=!1,i,s){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=s,this}}class r{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(){this._remove&&this._remove()}}class n{static FromPromise(e,t){const i=new n;return e.then((e=>{i.notifyObservers(e)})).catch((e=>{if(!t)throw e;t.notifyObservers(e)})),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new s(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,s=null,n=!1){if(!e)return null;const a=new r(e,t,s);return a.unregisterOnNextCall=n,i?this._observers.unshift(a):this._observers.push(a),this._onObserverAdded&&this._onObserverAdded(a),this._hasNotified&&this.notifyIfTriggered&&void 0!==this._lastNotifiedValue&&this.notifyObserver(a,this._lastNotifiedValue),a._remove=()=>{this.remove(a)},a}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return!!e&&(e._remove=null,-1!==this._observers.indexOf(e)&&(this._deferUnregister(e),!0))}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const s=this._observers[i];if(!(s._willBeUnregistered||s.callback!==e||t&&t!==s.scope))return this._deferUnregister(s),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout((()=>{this._remove(e)}),0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return-1!==i&&(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0)}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,s,r){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const n=this._eventState;n.mask=t,n.target=i,n.currentTarget=s,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=r;for(const i of this._observers)if(!i._willBeUnregistered&&(i.mask&t&&(i.unregisterOnNextCall&&this._deferUnregister(i),i.scope?n.lastReturnValue=i.callback.apply(i.scope,[e,n]):n.lastReturnValue=i.callback(e,n)),n.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const s=this._eventState;s.mask=i,s.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,s)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new n;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}},4296:(e,t,i)=>{"use strict";i.d(t,{A:()=>r});var s=i(6237);class r{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){r.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){r.Enabled&&(this._startMonitoringTime=s.j.Now)}endMonitoring(e=!0){if(!r.Enabled)return;e&&this.fetchNewFrame();const t=s.j.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=s.j.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}r.Enabled=!0},6237:(e,t,i)=>{"use strict";i.d(t,{j:()=>r});var s=i(8790);class r{static get Now(){return(0,s.BA)()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}},7126:(e,t,i)=>{"use strict";i.d(t,{G:()=>n});var s=i(7891),r=i(2683);class n{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const r=t.getEngine(),n=r.getCaps(),a=t.isReady;let o=!1;n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?(o=!0,t.type=2):n.textureFloatRender&&n.textureFloatLinearFiltering&&(o=!0,t.type=1),o&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const l=async()=>{const n=r.isWebGPU,a=n?1:0;t.isReady=!1,n?await Promise.all([i.e(371).then(i.bind(i,371)),i.e(5035).then(i.bind(i,5035))]):await Promise.all([i.e(9682).then(i.bind(i,9682)),i.e(2646).then(i.bind(i,2646))]);const o=new s.w("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,t.type,void 0,null,!1,void 0,a);o.externalTextureSamplerBinding=!0;const l=r.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});o.onEffectCreatedObservable.addOnce((i=>{i.executeWhenCompiled((()=>{o.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([o],l,!0),r.restoreDefaultFramebuffer(),r._releaseTexture(t),o&&o.dispose(),l._swapAndDie(t),t.isReady=!0}))}))};o&&(a?l():e.onLoadObservable.addOnce(l))}static EncodeTextureToRGBD(e,t,i=0){return(0,r.Qs)("rgbdEncode",e,t,i,1,5)}}},7931:(e,t,i)=>{"use strict";i.d(t,{L:()=>s,b:()=>r});class s{constructor(e){this.length=0,this.data=new Array(e),this._id=s._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return-1!==this.indexOf(e)}}s._GlobalId=0;class r extends s{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return!(e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId||(this.push(e),0))}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}},6181:(e,t,i)=>{"use strict";i.d(t,{AV:()=>r,EL:()=>s,yS:()=>n});const s=e=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i,s,r,n,a,o,l,h="",c=0;const u=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);for(;c<u.length;)i=u[c++],s=c<u.length?u[c++]:Number.NaN,r=c<u.length?u[c++]:Number.NaN,n=i>>2,a=(3&i)<<4|s>>4,o=(15&s)<<2|r>>6,l=63&r,isNaN(s)?o=l=64:isNaN(r)&&(l=64),h+=t.charAt(n)+t.charAt(a)+t.charAt(o)+t.charAt(l);return h},r=e=>atob(e),n=e=>{const t=r(e),i=t.length,s=new Uint8Array(new ArrayBuffer(i));for(let e=0;e<i;e++)s[e]=t.charCodeAt(e);return s.buffer}},7503:(e,t,i)=>{"use strict";i.d(t,{Y:()=>r});class s{static Eval(e,t){return"true"===(e=e.match(/\([^()]*\)/g)?e.replace(/\([^()]*\)/g,(e=>(e=e.slice(1,e.length-1),s._HandleParenthesisContent(e,t)))):s._HandleParenthesisContent(e,t))||"false"!==e&&s.Eval(e,t)}static _HandleParenthesisContent(e,t){let i;t=t||(e=>"true"===e);const r=e.split("||");for(const e in r)if(Object.prototype.hasOwnProperty.call(r,e)){let n=s._SimplifyNegation(r[e].trim());const a=n.split("&&");if(a.length>1)for(let e=0;e<a.length;++e){const r=s._SimplifyNegation(a[e].trim());if(i="true"!==r&&"false"!==r?"!"===r[0]?!t(r.substring(1)):t(r):"true"===r,!i){n="false";break}}if(i||"true"===n){i=!0;break}i="true"!==n&&"false"!==n?"!"===n[0]?!t(n.substring(1)):t(n):"true"===n}return i?"true":"false"}static _SimplifyNegation(e){return"!true"===(e=(e=e.replace(/^[\s!]+/,(e=>(e=e.replace(/[\s]/g,(()=>""))).length%2?"!":""))).trim())?e="false":"!false"===e&&(e="true"),e}}class r{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>r.HasTags(e),e.addTags=t=>r.AddTagsTo(e,t),e.removeTags=t=>r.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>r.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const t=[];for(const i in e._tags)Object.prototype.hasOwnProperty.call(e._tags,i)&&!0===e._tags[i]&&t.push(i);return t.join(" ")}return e._tags}static AddTagsTo(e,t){t&&"string"==typeof t&&t.split(" ").forEach((function(t){r._AddTagTo(e,t)}))}static _AddTagTo(e,t){""!==(t=t.trim())&&"true"!==t&&"false"!==t&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(r.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!r.HasTags(e))return;const i=t.split(" ");for(const t in i)r._RemoveTagFrom(e,i[t])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return void 0===t||(""===t?r.HasTags(e):s.Eval(t,(t=>r.HasTags(e)&&e._tags[t])))}}},2683:(e,t,i)=>{"use strict";i.d(t,{LZ:()=>o,Qs:()=>r,SX:()=>l}),i(2781),i(5474),i(580);var s=i(7891);function r(e,t,i,r,n,a,o,l){const h=t.getEngine();return t.isReady=!1,n=n??t.samplingMode,r=r??t.type,a=a??t.format,o=o??t.width,l=l??t.height,-1===r&&(r=0),new Promise((c=>{const u=new s.w("postprocess",e,null,null,1,null,n,h,!1,void 0,r,void 0,null,!1,a);u.externalTextureSamplerBinding=!0;const d=h.createRenderTargetTexture({width:o,height:l},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:n,type:r,format:a});u.onEffectCreatedObservable.addOnce((e=>{e.executeWhenCompiled((()=>{u.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},i.postProcessManager.directRender([u],d,!0),h.restoreDefaultFramebuffer(),h._releaseTexture(t),u&&u.dispose(),d._swapAndDie(t),t.type=r,t.format=5,t.isReady=!0,c(t)}))}))}))}let n,a;function o(e){n||(n=new Float32Array(1),a=new Int32Array(n.buffer)),n[0]=e;const t=a[0];let i=t>>16&32768,s=t>>12&2047;const r=t>>23&255;return r<103?i:r>142?(i|=31744,i|=(255==r?0:1)&&8388607&t,i):r<113?(s|=2048,i|=(s>>114-r)+(s>>113-r&1),i):(i|=r-112<<10|s>>1,i+=1&s,i)}function l(e){const t=(32768&e)>>15,i=(31744&e)>>10,s=1023&e;return 0===i?(t?-1:1)*Math.pow(2,-14)*(s/Math.pow(2,10)):31==i?s?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,i-15)*(1+s/Math.pow(2,10))}},2940:(e,t,i)=>{"use strict";i.d(t,{_:()=>r});var s=i(8790);class r{static SetImmediate(e){(0,s.BA)()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}},1597:(e,t,i)=>{"use strict";function s(e){let t=1;do{t*=2}while(t<e);return t===e}function r(e,t,i){return e*(1-i)+t*i}function n(e){const t=a(e),i=o(e);return t-e>e-i?i:t}function a(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function o(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)-(e>>1)}function l(e,t,i=2){let s;switch(i){case 1:s=o(e);break;case 2:s=n(e);break;default:s=a(e)}return Math.min(s,t)}i.d(t,{C4:()=>o,L8:()=>s,OG:()=>n,R:()=>l,zF:()=>r})},998:(e,t,i)=>{"use strict";i.d(t,{LV:()=>g,S0:()=>m});var s=i(9848),r=i(8790),n=i(1137),a=i(4609),o=i(6237),l=i(5503),h=i(2366),c=i(6315),u=i(655),d=i(2940),_=i(9337),p=i(8688),f=i(1597);class m{static get BaseUrl(){return u.eC.BaseUrl}static set BaseUrl(e){u.eC.BaseUrl=e}static get CleanUrl(){return u.eC.CleanUrl}static set CleanUrl(e){u.eC.CleanUrl=e}static IsAbsoluteUrl(e){return 0===e.indexOf("//")||-1!==e.indexOf("://")&&-1!==e.indexOf(".")&&-1!==e.indexOf("/")&&!(e.indexOf(":")>e.indexOf("/"))&&(e.indexOf("://")<e.indexOf(".")||0===e.indexOf("data:")||0===e.indexOf("blob:"))}static set ScriptBaseUrl(e){u.eC.ScriptBaseUrl=e}static get ScriptBaseUrl(){return u.eC.ScriptBaseUrl}static set ScriptPreprocessUrl(e){u.eC.ScriptPreprocessUrl=e}static get ScriptPreprocessUrl(){return u.eC.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return u.eC.DefaultRetryStrategy}static set DefaultRetryStrategy(e){u.eC.DefaultRetryStrategy=e}static get CorsBehavior(){return u.eC.CorsBehavior}static set CorsBehavior(e){u.eC.CorsBehavior=e}static get UseFallbackTexture(){return c.q.UseFallbackTexture}static set UseFallbackTexture(e){c.q.UseFallbackTexture=e}static get RegisteredExternalClasses(){return _.n.RegisteredExternalClasses}static set RegisteredExternalClasses(e){_.n.RegisteredExternalClasses=e}static get fallbackTexture(){return c.q.FallbackTexture}static set fallbackTexture(e){c.q.FallbackTexture=e}static FetchToRef(e,t,i,s,r,n){const a=4*((Math.abs(e)*i%i|0)+(Math.abs(t)*s%s|0)*i);n.r=r[a]/255,n.g=r[a+1]/255,n.b=r[a+2]/255,n.a=r[a+3]/255}static Mix(e,t,i){return 0}static Instantiate(e){return _.n.Instantiate(e)}static SetImmediate(e){d._.SetImmediate(e)}static IsExponentOfTwo(e){return!0}static FloatRound(e){return Math.fround(e)}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return 180*e/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const s=this.ToRadians(e),r=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(r)+i*Math.sin(s),(1-i)*Math.cos(r)+i*Math.cos(s)))}static MakeArray(e,t){return!0===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null}static GetPointerPrefix(e){return(0,r.BA)()&&!window.PointerEvent?"mouse":"pointer"}static SetCorsBehavior(e,t){(0,u.M1)(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static get PreprocessUrl(){return u.eC.PreprocessUrl}static set PreprocessUrl(e){u.eC.PreprocessUrl=e}static LoadImage(e,t,i,s,r,n){return(0,u.W$)(e,t,i,s,r,n)}static LoadFile(e,t,i,s,r,n){return(0,u.zU)(e,t,i,s,r,n)}static LoadFileAsync(e,t=!0){return new Promise(((i,s)=>{(0,u.zU)(e,(e=>{i(e)}),void 0,void 0,t,((e,t)=>{s(t)}))}))}static GetBabylonScriptURL(e,t){if(!e)return"";if(m.ScriptBaseUrl&&e.startsWith(m._DefaultCdnUrl)){const t="/"===m.ScriptBaseUrl[m.ScriptBaseUrl.length-1]?m.ScriptBaseUrl.substring(0,m.ScriptBaseUrl.length-1):m.ScriptBaseUrl;e=e.replace(m._DefaultCdnUrl,t)}return e=m.ScriptPreprocessUrl(e),t&&(e=m.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,i,s){e=m.GetBabylonScriptURL(e),m.LoadScript(e,t,i)}static LoadBabylonScriptAsync(e){return e=m.GetBabylonScriptURL(e),m.LoadScriptAsync(e)}static LoadScript(e,t,i,s){if("function"==typeof importScripts){try{importScripts(e),t()}catch(t){i?.(`Unable to load script '${e}' in worker`,t)}return}if(!(0,r.BA)())return void i?.(`Cannot load script '${e}' outside of a window or a worker`);const n=document.getElementsByTagName("head")[0],a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("src",e),s&&(a.id=s),a.onload=()=>{t&&t()},a.onerror=t=>{i&&i(`Unable to load script '${e}'`,t)},n.appendChild(a)}static LoadScriptAsync(e,t){return new Promise(((i,s)=>{this.LoadScript(e,(()=>{i()}),((e,t)=>{s(t||new Error(e))}),t)}))}static ReadFileAsDataURL(e,t,i){const r=new FileReader,n={onCompleteObservable:new s.cP,abort:()=>r.abort()};return r.onloadend=()=>{n.onCompleteObservable.notifyObservers(n)},r.onload=e=>{t(e.target.result)},r.onprogress=i,r.readAsDataURL(e),n}static ReadFile(e,t,i,s,r){return(0,u.NJ)(e,t,i,s,r)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,s){a.r.DeepCopy(e,t,i,s)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.addEventListener(s.name,s.handler,!1);try{window.parent&&window.parent.addEventListener(s.name,s.handler,!1)}catch(e){}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.removeEventListener(s.name,s.handler);try{e.parent&&e.parent.removeEventListener(s.name,s.handler)}catch(e){}}}static async DumpFramebuffer(e,t,i,s,r="image/png",n,a){throw(0,l.n)("DumpTools")}static DumpData(e,t,i,s,r="image/png",n,a=!1,o=!1,h){throw(0,l.n)("DumpTools")}static DumpDataAsync(e,t,i,s="image/png",r,n=!1,a=!1,o){throw(0,l.n)("DumpTools")}static _IsOffScreenCanvas(e){return void 0!==e.convertToBlob}static ToBlob(e,t,i="image/png",s){m._IsOffScreenCanvas(e)||e.toBlob||(e.toBlob=function(e,t,i){setTimeout((()=>{const s=atob(this.toDataURL(t,i).split(",")[1]),r=s.length,n=new Uint8Array(r);for(let e=0;e<r;e++)n[e]=s.charCodeAt(e);e(new Blob([n]))}))}),m._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:s}).then((e=>t(e))):e.toBlob((function(e){t(e)}),i,s)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const e=new Date;t="screenshot_"+(e.getFullYear()+"-"+(e.getMonth()+1)).slice(2)+"-"+e.getDate()+"_"+e.getHours()+"-"+("0"+e.getMinutes()).slice(-2)+".png"}m.Download(e,t)}else if(e&&"undefined"!=typeof URL){const t=URL.createObjectURL(e),i=window.open("");if(!i)return;const s=i.document.createElement("img");s.onload=function(){URL.revokeObjectURL(t)},s.src=t,i.document.body.appendChild(s)}}static EncodeScreenshotCanvasData(e,t,i="image/png",s,r){if("string"!=typeof s&&t){if(t){if(m._IsOffScreenCanvas(e))return void e.convertToBlob({type:i,quality:r}).then((e=>{const i=new FileReader;i.readAsDataURL(e),i.onloadend=()=>{const e=i.result;t(e)}}));const s=e.toDataURL(i,r);t(s)}}else this.ToBlob(e,(function(e){e&&m.DownloadBlob(e,s),t&&t("")}),i,r)}static Download(e,t){if("undefined"==typeof URL)return;const i=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=i,s.download=t,s.addEventListener("click",(()=>{s.parentElement&&s.parentElement.removeChild(s)})),s.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return"boolean"==typeof e[0]?e[0]:"boolean"==typeof e[1]&&e[1]}static CreateScreenshot(e,t,i,s,r="image/png",n=!1,a){throw(0,l.n)("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,s="image/png",r){throw(0,l.n)("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,s,r="image/png",n=1,a=!1,o,h=!1,c=!1,u=!0,d,_){throw(0,l.n)("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,s="image/png",r=1,n=!1,a,o=!1,h=!1,c=!0,u,d){throw(0,l.n)("ScreenshotTools")}static RandomId(){return(0,p.z)()}static IsBase64(e){return(0,u.f2)(e)}static DecodeBase64(e){return(0,u.rz)(e)}static get errorsCount(){return n.V.errorsCount}static Log(e){n.V.Log(e)}static Warn(e){n.V.Warn(e)}static Error(e){n.V.Error(e)}static get LogCache(){return n.V.LogCache}static ClearLogCache(){n.V.ClearLogCache()}static set LogLevels(e){n.V.LogLevels=e}static set PerformanceLogLevel(e){return(e&m.PerformanceUserMarkLogLevel)===m.PerformanceUserMarkLogLevel?(m.StartPerformanceCounter=m._StartUserMark,void(m.EndPerformanceCounter=m._EndUserMark)):(e&m.PerformanceConsoleLogLevel)===m.PerformanceConsoleLogLevel?(m.StartPerformanceCounter=m._StartPerformanceConsole,void(m.EndPerformanceCounter=m._EndPerformanceConsole)):(m.StartPerformanceCounter=m._StartPerformanceCounterDisabled,void(m.EndPerformanceCounter=m._EndPerformanceCounterDisabled))}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!m._Performance){if(!(0,r.BA)())return;m._Performance=window.performance}t&&m._Performance.mark&&m._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){t&&m._Performance.mark&&(m._Performance.mark(e+"-End"),m._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(m._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(m._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return o.j.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,s=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const r=t?e:Object.getPrototypeOf(e);i=r.constructor.__bjsclassName__,s=r.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(null!=s?s+".":"")+i:null}static DelayAsync(e){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}static IsSafari(){return!!(0,r.XD)()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}}m.UseCustomRequestHeaders=!1,m.CustomRequestHeaders=h.u.CustomRequestHeaders,m.GetDOMTextContent=r.Zl,m._DefaultCdnUrl="https://cdn.babylonjs.com",m.GetAbsoluteUrl="object"==typeof document?e=>{const t=document.createElement("a");return t.href=e,t.href}:"function"==typeof URL&&"object"==typeof location?e=>new URL(e,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},m.NoneLogLevel=n.V.NoneLogLevel,m.MessageLogLevel=n.V.MessageLogLevel,m.WarningLogLevel=n.V.WarningLogLevel,m.ErrorLogLevel=n.V.ErrorLogLevel,m.AllLogLevel=n.V.AllLogLevel,m.IsWindowObjectExist=r.BA,m.PerformanceNoneLogLevel=0,m.PerformanceUserMarkLogLevel=1,m.PerformanceConsoleLogLevel=2,m.StartPerformanceCounter=m._StartPerformanceCounterDisabled,m.EndPerformanceCounter=m._EndPerformanceCounterDisabled;class g{constructor(e,t,i,s=0){this.iterations=e,this.index=s-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,s=0){const r=new g(e,t,i,s);return r.executeNext(),r}static SyncAsyncForLoop(e,t,i,s,r,n=0){return g.Run(Math.ceil(e/t),(s=>{r&&r()?s.breakLoop():setTimeout((()=>{for(let n=0;n<t;++n){const a=s.index*t+n;if(a>=e)break;if(i(a),r&&r()){s.breakLoop();break}}s.executeNext()}),n)}),s)}}m.Mix=f.zF,m.IsExponentOfTwo=f.L8,c.q.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z"},6552:(e,t,i)=>{"use strict";i.d(t,{Y5:()=>r,n9:()=>n});const s={};function r(e,t){s[e]=t}function n(e){return s[e]}},2678:(e,t,i)=>{"use strict";i.d(t,{K:()=>s});class s{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}s._UniqueIdCounter=1},2366:(e,t,i)=>{"use strict";i.d(t,{u:()=>s});class s{constructor(){this._xhr="undefined"!=typeof _native&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest,this._requestURL=""}static get IsCustomRequestAvailable(){return Object.keys(s.CustomRequestHeaders).length>0||s.CustomRequestModifiers.length>0}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in s.CustomRequestHeaders){const t=s.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return s.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){s.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const e of s.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;e(this._xhr,t)}t=(t=t.replace("file:http:","http:")).replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}s.CustomRequestHeaders={},s.CustomRequestModifiers=new Array,s.SkipRequestModificationForBabylonCDN=!0},580:(e,t,i)=>{"use strict";i.d(t,{v:()=>o});var s=i(7891),r=i(6326),n=i(6552),a=i(6877);class o extends s.w{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,s,r,n,a=0,o=!1){super(e,"pass",null,null,t,i,s,r,n,void 0,a,void 0,null,o)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,9965))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,9820))])),super._gatherImports(e,t)}static _Parse(e,t,i,s){return a.p.Parse((()=>new o(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable)),e,i,s)}}(0,n.Y5)("BABYLON.PassPostProcess",o),s.w,r.$._RescalePostProcessFactory=e=>new o("rescale",1,null,2,e,!1,0)},7891:(e,t,i)=>{"use strict";i.d(t,{w:()=>p});var s=i(5524),r=i(7931),n=i(9848),a=i(9923),o=i(4420),l=i(9259),h=i(6877),c=i(6552),u=i(5476),d=i(6326),_=i(1597);d.$.prototype.setTextureFromPostProcess=function(e,t,i){let s=null;t&&(t._forcedOutputTexture?s=t._forcedOutputTexture:t._textures.data[t._currentRenderTextureInd]&&(s=t._textures.data[t._currentRenderTextureInd])),this._bindTexture(e,s?.texture??null,i)},d.$.prototype.setTextureFromPostProcessOutput=function(e,t,i){this._bindTexture(e,t?._outputTexture?.texture??null,i)},o.M.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)},o.M.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)};class p{static RegisterShaderCodeProcessing(e,t){t?p._CustomShaderCodeProcessing[e??""]=t:delete p._CustomShaderCodeProcessing[e??""]}static _GetShaderCodeProcessing(e){return p._CustomShaderCodeProcessing[e]??p._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach((e=>{e.setSamples(this._samples)}))}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,s,o,l,h=1,c,d,_=null,p=0,f="postprocess",m,g=!1,v=5,b,x){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.alphaMode=0,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._shadersLoaded=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new r.L(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new a.I9(1,1),this._texelSize=a.I9.Zero(),this.onEffectCreatedObservable=new n.cP(void 0,!0),this.onActivateObservable=new n.cP,this.onSizeChangedObservable=new n.cP,this.onApplyObservable=new n.cP,this.onBeforeRenderObservable=new n.cP,this.onAfterRenderObservable=new n.cP,this._importPromises=[],this.name=e;let S=1,T=null;if(i&&!Array.isArray(i)){const e=i;i=e.uniforms??null,s=e.samplers??null,S=e.size??1,l=e.camera??null,h=e.samplingMode??1,c=e.engine,d=e.reusable,_=e.defines??null,p=e.textureType??0,f=e.vertexUrl??"postprocess",m=e.indexParameters,g=e.blockCompilation??!1,v=e.textureFormat??5,b=e.shaderLanguage??0,T=e.uniformBuffers??null,x=e.extraInitializations}else o&&(S="number"==typeof o?o:{width:o.width,height:o.height});null!=l?(this._camera=l,this._scene=l.getScene(),l.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):c&&(this._engine=c,this._engine.postProcesses.push(this)),this._options=S,this.renderTargetSamplingMode=h||1,this._reusable=d||!1,this._textureType=p,this._textureFormat=v,this._shaderLanguage=b||0,this._samplers=s||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=f,this._parameters=i||[],this._parameters.push("scale"),this._uniformBuffers=T||[],this._indexParameters=m,this._drawWrapper=new u.E(this._engine),this._webGPUReady=1===this._shaderLanguage,this._postConstructor(g,_,x)}_gatherImports(e=!1,t){e&&this._webGPUReady?t.push(Promise.all([Promise.resolve().then(i.bind(i,2083))])):t.push(Promise.all([Promise.resolve().then(i.bind(i,6612))]))}_postConstructor(e,t=null,i){const s=this.getEngine().isWebGPU&&!p.ForceGLSL;this._gatherImports(s,this._importPromises),i&&i(s,this._importPromises),s&&this._webGPUReady&&(this._shaderLanguage=1),e||this.updateEffect(t)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){0==this._textures.length&&(this._textures=new r.L(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,s,r,n,a,o){const l=p._GetShaderCodeProcessing(this.name);if(l?.defineCustomBindings){const s=t?.slice()??[];s.push(...this._parameters);const r=i?.slice()??[];r.push(...this._samplers),e=l.defineCustomBindings(this.name,e,s,r),t=s,i=r}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:a??this._vertexUrl,fragment:o??this._fragmentUrl},{attributes:["position"],uniformsNames:t||this._parameters,uniformBuffersNames:this._uniformBuffers,samplers:i||this._samplers,defines:null!==e?e:"",fallbacks:null,onCompiled:r??null,onError:n??null,indexParameters:s||this._indexParameters,processCodeAfterIncludes:l?.processCodeAfterIncludes?(e,t)=>l.processCodeAfterIncludes(this.name,e,t):null,processFinalCode:l?.processFinalCode?(e,t)=>l.processFinalCode(this.name,e,t):null,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0}},this._engine),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture.width===e.width&&this._textureCache[s].texture.height===e.height&&this._textureCache[s].postProcessChannel===i&&this._textureCache[s].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[s].texture.samples===t.samples)return this._textureCache[s].texture;const s=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:s,postProcessChannel:i,lastUsedRenderId:-1}),s}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let e=!1;for(let i=0;i<this._textures.length;i++)if(this._textures.data[i]===this._textureCache[t].texture){e=!0;break}e||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,i=null,s=!1,r=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;if(i)for(let e=0;e<i._postProcesses.length;e++)if(null!==i._postProcesses[e]){n=i._postProcesses[e];break}const a={width:this.width,height:this.height},o={generateMipMaps:s,generateDepthBuffer:r||n===this,generateStencilBuffer:(r||n===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(a,o,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(a,o,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let t;e=this.inputTexture;for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture===e){t=this._textureCache[i];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,i){const s=(e=e||this._camera).getScene(),r=s.getEngine(),n=r.getCaps().maxTextureSize,a=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,o=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let l=this._options.width||a,h=this._options.height||o;const c=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let u=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const e=r.currentViewport;e&&(l*=e.width,h*=e.height)}(c||this.alwaysForcePOT)&&(this._options.width||(l=r.needPOTTextures?(0,_.R)(l,n,this.scaleMode):l),this._options.height||(h=r.needPOTTextures?(0,_.R)(h,n,this.scaleMode):h)),this.width===l&&this.height===h&&(u=this._getTarget())||this.resize(l,h,e,c,i),this._textures.forEach((e=>{e.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(e,this.samples)})),this._flushTextureCache(),this._renderId++}return u||(u=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(a/l,o/h),this._engine.bindFramebuffer(u,0,a,o,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(u,0,void 0,void 0,this.forceFullscreenViewport)),this._engine._debugInsertMarker?.(`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:s.clearColor,s._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),u}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._drawWrapper.effect?.isReady()??!1}apply(){if(!this._drawWrapper.effect?.isReady())return null;let e;return this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),e=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",e?.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),p._GetShaderCodeProcessing(this.name)?.bindCustomBindings?.(this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(e){let t;if(e=e||this._camera,this._disposeTextures(),this._scene&&(t=this._scene.postProcesses.indexOf(this),-1!==t&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const e=this._parentContainer.postProcesses.indexOf(this);e>-1&&this._parentContainer.postProcesses.splice(e,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),-1!==t&&this._engine.postProcesses.splice(t,1),e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),0===t&&e._postProcesses.length>0){const e=this._camera._getFirstPostProcess();e&&e.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){const e=h.p.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=p.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const s=(0,c.n9)(e.customType);if(!s||!s._Parse)return null;const r=t?t.getCameraById(e.cameraId):null;return s._Parse(e,r,t,i)}static _Parse(e,t,i,s){return h.p.Parse((()=>new p(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat)),e,i,s)}}p.ForceGLSL=!1,p._CustomShaderCodeProcessing={},(0,s.Cg)([(0,l.lK)()],p.prototype,"uniqueId",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"name",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"width",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"height",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"renderTargetSamplingMode",void 0),(0,s.Cg)([(0,l.qK)()],p.prototype,"clearColor",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"autoClear",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"forceAutoClearInAlphaMode",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"alphaMode",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"alphaConstants",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"enablePixelPerfectMode",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"forceFullscreenViewport",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"scaleMode",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"alwaysForcePOT",void 0),(0,s.Cg)([(0,l.lK)("samples")],p.prototype,"_samples",void 0),(0,s.Cg)([(0,l.lK)()],p.prototype,"adaptScaleToCurrentViewport",void 0),(0,c.Y5)("BABYLON.PostProcess",p)},6096:(e,t,i)=>{"use strict";i.d(t,{X:()=>n});var s=i(5616),r=i(9848);class n{constructor(e){this._vertexBuffers={},this.onBeforeRenderObservable=new r.cP,this._scene=e}_prepareBuffers(){if(this._vertexBuffers[s.R.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[s.R.PositionKind]=new s.R(this._scene.getEngine(),e,s.R.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[s.R.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!(!i||!(t=t||i._postProcesses.filter((e=>null!=e)))||0===t.length||!this._scene.postProcessesEnabled||(t[0].activate(i,e,null!=t),0))}directRender(e,t=null,i=!1,s=0,r=0,n=!1){const a=this._scene.getEngine();for(let o=0;o<e.length;o++){o<e.length-1?e[o+1].activate(this._scene.activeCamera,t?.texture):(t?a.bindFramebuffer(t,s,void 0,void 0,i,r):n||a.restoreDefaultFramebuffer(),a._debugInsertMarker?.(`post process ${e[o].name} output`));const l=e[o],h=l.apply();h&&(l.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,h),a.drawElementsType(0,0,6),l.onAfterRenderObservable.notifyObservers(h))}a.setDepthBuffer(!0),a.setDepthWrite(!0)}_finalizeFrame(e,t,i,s,r=!1){const n=this._scene.activeCamera;if(!n)return;if(this.onBeforeRenderObservable.notifyObservers(this),0===(s=s||n._postProcesses.filter((e=>null!=e))).length||!this._scene.postProcessesEnabled)return;const a=this._scene.getEngine();for(let o=0,l=s.length;o<l;o++){const h=s[o];if(o<l-1?h._outputTexture=s[o+1].activate(n,t?.texture):(t?(a.bindFramebuffer(t,i,void 0,void 0,r),h._outputTexture=t):(a.restoreDefaultFramebuffer(),h._outputTexture=null),a._debugInsertMarker?.(`post process ${s[o].name} output`)),e)break;const c=h.apply();c&&(h.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,c),a.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(c))}a.setDepthBuffer(!0),a.setDepthWrite(!0),a.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[s.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[s.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}},3099:(e,t,i)=>{"use strict";i.d(t,{m:()=>o});var s=i(7931),r=i(9923);class n{set opaqueSortCompareFn(e){this._opaqueSortCompareFn=e||n.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){this._alphaTestSortCompareFn=e||n.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){this._transparentSortCompareFn=e||n.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,r=null,n=null){this.index=e,this._opaqueSubMeshes=new s.L(256),this._transparentSubMeshes=new s.L(256),this._alphaTestSubMeshes=new s.L(256),this._depthOnlySubMeshes=new s.L(256),this._particleSystems=new s.L(256),this._spriteManagers=new s.L(256),this._empty=!0,this._edgesRenderers=new s.b(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=n}render(e,t,i,s){if(e)return void e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);const r=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(r.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),r.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=r.getStencilBuffer();if(r.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(s),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(r.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const e=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);e.length&&this._renderTransparent(e)}else this._renderTransparent(this._transparentSubMeshes);r.setAlphaMode(0)}if(r.setStencilBuffer(!1),this._edgesRenderers.length){for(let e=0;e<this._edgesRenderers.length;e++)this._edgesRenderers.data[e].render();r.setAlphaMode(0)}r.setStencilBuffer(n)}_renderOpaqueSorted(e){n._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){n._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){n._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,s){let a,o=0;const l=i?i.globalPosition:n._ZeroVector;if(s)for(;o<e.length;o++)a=e.data[o],a._alphaIndex=a.getMesh().alphaIndex,a._distanceToCamera=r.Pq.Distance(a.getBoundingInfo().boundingSphere.centerWorld,l);const h=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&h.sort(t);const c=h[0].getMesh().getScene();for(o=0;o<h.length;o++)if(a=h[o],!c._activeMeshesFrozenButKeepClipping||a.isInFrustum(c._frustumPlanes)){if(s){const e=a.getMaterial();if(e&&e.needDepthPrePass){const t=e.getScene().getEngine();t.setColorWrite(!1),t.setAlphaMode(0),a.render(!1),t.setColorWrite(!0)}}a.render(s)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:n.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),s=t.getMesh();return i.material&&s.material?i.material.uniqueId-s.material.uniqueId:i.uniqueId-s.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){void 0===t&&(t=e.getMesh()),void 0===i&&(i=e.getMaterial()),null!=i&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(0===this._particleSystems.length)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const s=this._particleSystems.data[i];if(0===(t&&t.layerMask&s.layerMask))continue;const r=s.emitter;r.position&&e&&-1===e.indexOf(r)||this._scene._activeParticles.addCount(s.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||0===this._spriteManagers.length)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];0!==(e&&e.layerMask&i.layerMask)&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}n._ZeroVector=r.Pq.Zero();class a{}class o{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=!1;for(const e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new a,this._maintainStateBetweenFrames=!1,this._scene=e;for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++)this._autoClearDepthStencil[e]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,s){const r=this._renderingGroupInfo;if(r.scene=this._scene,r.camera=this._scene.activeCamera,this._scene.spriteManagers&&s)for(let e=0;e<this._scene.spriteManagers.length;e++){const t=this._scene.spriteManagers[e];this.dispatchSprites(t)}for(let n=o.MIN_RENDERINGGROUPS;n<o.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===o.MIN_RENDERINGGROUPS;const a=this._renderingGroups[n];if(!a||a._empty)continue;const l=1<<n;if(r.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(r,l),o.AUTOCLEAR){const e=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];e&&e.autoClear&&this._clearDepthStencilBuffer(e.depth,e.stencil)}for(const e of this._scene._beforeRenderingGroupDrawStage)e.action(n);a.render(e,s,i,t);for(const e of this._scene._afterRenderingGroupDrawStage)e.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(r,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=o.MIN_RENDERINGGROUPS;e<o.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){void 0===this._renderingGroups[e]&&(this._renderingGroups[e]=new n(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){void 0===t&&(t=e.getMesh()),this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,s=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=s,this._renderingGroups[e]){const t=this._renderingGroups[e];t.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],t.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],t.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:s}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}o.MAX_RENDERINGGROUPS=4,o.MIN_RENDERINGGROUPS=0,o.AUTOCLEAR=!0},242:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStoreWGSL.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\nlet VATStartFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.x;let VATEndFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.y;let VATOffsetFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.z;let VATSpeed: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.w;\n#else\nlet VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;\n#endif\nlet totalFrames: f32=VATEndFrame-VATStartFrame+1.0;let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;let frameCorrection: f32=select(1.0,0.0,time<1.0);let numOfFrames: f32=totalFrames-frameCorrection;var VATFrameNum: f32=fract(time)*numOfFrames;VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;VATFrameNum=floor(VATFrameNum);VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;var VATInfluence : mat4x4<f32>;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[0],VATFrameNum)*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[1],VATFrameNum)*vertexInputs.matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[2],VATFrameNum)*vertexInputs.matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[3],VATFrameNum)*vertexInputs.matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[0],VATFrameNum)*vertexInputs.matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[1],VATFrameNum)*vertexInputs.matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[2],VATFrameNum)*vertexInputs.matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[3],VATFrameNum)*vertexInputs.matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;}\n#endif\n"},8900:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStoreWGSL.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform bakedVertexAnimationTime: f32;uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;uniform bakedVertexAnimationSettings: vec4<f32>;var bakedVertexAnimationTexture : texture_2d<f32>;\n#ifdef INSTANCES\nattribute bakedVertexAnimationSettingsInstanced : vec4<f32>;\n#endif\nfn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>\n{let offset=i32(index)*4;let frameUV=i32(frame);let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);return mat4x4<f32>(m0,m1,m2,m3);}\n#endif\n"},2806:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bonesDeclarationWGSL:()=>n});const s="bonesDeclaration",r="#if NUM_BONE_INFLUENCERS>0\nattribute matricesIndices : vec4<f32>;attribute matricesWeights : vec4<f32>;\n#if NUM_BONE_INFLUENCERS>4\nattribute matricesIndicesExtra : vec4<f32>;attribute matricesWeightsExtra : vec4<f32>;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nvar boneSampler : texture_2d<f32>;uniform boneTextureWidth : f32;\n#else\nuniform mBones : array<mat4x4,BonesPerMesh>;\n#ifdef BONES_VELOCITY_ENABLED\nuniform mPreviousBones : array<mat4x4,BonesPerMesh>;\n#endif\n#endif\n#ifdef BONETEXTURE\nfn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>\n{let offset=i32(index) *4; \nlet m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},5470:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bonesVertexWGSL:()=>n});const s="bonesVertex",r="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nvar influence : mat4x4<f32>;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[0])*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[1])*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[2])*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[3])*vertexInputs.matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[0])*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[1])*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[2])*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[3])*vertexInputs.matricesWeightsExtra[3];\n#endif \n#else \ninfluence=uniforms.mBones[int(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];\n#endif \n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},727:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bumpFragmentWGSL:()=>n});const s="bumpFragment",r="var uvOffset: vec2f= vec2f(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nvar normalScale: f32=1.0;\n#elif defined(BUMP)\nvar normalScale: f32=uniforms.vBumpInfos.y;\n#else\nvar normalScale: f32=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nvar TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); \n#elif defined(BUMP)\nvar TBNUV: vec2f=select(-fragmentInputs.vBumpUV,fragmentInputs.vBumpUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV,uniforms.vTangentSpaceParams);\n#else\nvar TBNUV: vec2f=select(-fragmentInputs.vDetailUV,fragmentInputs.vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV, vec2f(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvar TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); \n#else\nvar TBNUV: vec2f=select( -fragmentInputs.vMainUV1,fragmentInputs.vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,input.vPositionW,TBNUV, vec2f(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nvar invTBN: mat3x3f=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,fragmentInputs.vBumpUV,uniforms.vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,uniforms.vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvar detailColor: vec4f=textureSample(detailSampler,detailSamplerSampler,fragmentInputs.vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3x3f(uniforms.normalMatrix[0].xyz,uniforms.normalMatrix[1].xyz,uniforms.normalMatrix[2].xyz)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz,uniforms.vBumpInfos.y);\n#else\nvar bumpNormal: vec3f=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);var blendedNormal: vec3f=normalize( vec3f(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);bumpNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,uniforms.vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);normalW=perturbNormalBase(TBN,detailNormal,uniforms.vDetailInfos.z);\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},1258:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bumpFragmentFunctionsWGSL:()=>a});var s=i(9610);i(983);const r="bumpFragmentFunctions",n="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)\n{currSampledHeight=textureSample(bumpSampler,bumpSamplerSampler,texCoord+vCurrOffset).w;if (!keepWorking)\n{}\nelse if (currSampledHeight>currRayHeight)\n{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}\nelse\n{currRayHeight-=stepSize;vLastOffset=vCurrOffset;\n#ifdef PARALLAX_RHS\nvCurrOffset-=stepSize*vMaxOffset;\n#else\nvCurrOffset+=stepSize*vMaxOffset;\n#endif\nlastSampledHeight=currSampledHeight;}}\nreturn vCurrOffset;}\nfn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f\n{var height: f32=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;\n#ifdef PARALLAX_RHS\nreturn texCoordOffset;\n#else\nreturn -texCoordOffset;\n#endif\n}\n#endif\n";s.l.IncludesShadersStoreWGSL[r]=n;const a={name:r,shader:n}},5697:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bumpFragmentMainFunctionsWGSL:()=>n});const s="bumpFragmentMainFunctions",r="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform normalMatrix: mat4x4f;fn toNormalMatrix(m: mat4x4f)->mat4x4f\n{var a00=m[0][0];var a01=m[0][1];var a02=m[0][2];var a03=m[0][3];var a10=m[1][0];var a11=m[1][1];var a12=m[1][2];var a13=m[1][3];var a20=m[2][0]; \nvar a21=m[2][1];var a22=m[2][2];var a23=m[2][3];var a30=m[3][0]; \nvar a31=m[3][1];var a32=m[3][2];var a33=m[3][3];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi=mat4x4<f32>(\n(a11*b11-a12*b10+a13*b09)/det,\n(a02*b10-a01*b11-a03*b09)/det,\n(a31*b05-a32*b04+a33*b03)/det,\n(a22*b04-a21*b05-a23*b03)/det,\n(a12*b08-a10*b11-a13*b07)/det,\n(a00*b11-a02*b08+a03*b07)/det,\n(a32*b02-a30*b05-a33*b01)/det,\n(a20*b05-a22*b02+a23*b01)/det,\n(a10*b10-a11*b08+a13*b06)/det,\n(a01*b08-a00*b10-a03*b06)/det,\n(a30*b04-a31*b02+a33*b00)/det,\n(a21*b02-a20*b04-a23*b00)/det,\n(a11*b07-a10*b09-a12*b06)/det,\n(a00*b09-a01*b07+a02*b06)/det,\n(a31*b01-a30*b03-a32*b00)/det,\n(a20*b03-a21*b01+a22*b00)/det);return mat4x4<f32>(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);}\n#endif\nfn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f\n{var output=normal;\n#ifdef NORMALXYSCALE\noutput=normalize(output* vec3f(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*output);}\nfn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f\n{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}\nfn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f\n{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},7715:(e,t,i)=>{"use strict";i.r(t),i.d(t,{clipPlaneFragmentWGSL:()=>n});const s="clipPlaneFragment",r="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fragmentInputs.fClipDistance>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE2\nelse if (fragmentInputs.fClipDistance2>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE3\nelse if (fragmentInputs.fClipDistance3>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE4\nelse if (fragmentInputs.fClipDistance4>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE5\nelse if (fragmentInputs.fClipDistance5>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE6\nelse if (fragmentInputs.fClipDistance6>0.0)\n{discard;}\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},9759:(e,t,i)=>{"use strict";i.r(t),i.d(t,{clipPlaneFragmentDeclarationWGSL:()=>n});const s="clipPlaneFragmentDeclaration",r="#ifdef CLIPPLANE\nvarying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nvarying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nvarying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nvarying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nvarying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nvarying fClipDistance6: f32;\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},5197:(e,t,i)=>{"use strict";i.r(t),i.d(t,{clipPlaneVertexWGSL:()=>n});const s="clipPlaneVertex",r="#ifdef CLIPPLANE\nvertexOutputs.fClipDistance=dot(worldPos,uniforms.vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nvertexOutputs.fClipDistance2=dot(worldPos,uniforms.vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nvertexOutputs.fClipDistance3=dot(worldPos,uniforms.vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nvertexOutputs.fClipDistance4=dot(worldPos,uniforms.vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nvertexOutputs.fClipDistance5=dot(worldPos,uniforms.vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nvertexOutputs.fClipDistance6=dot(worldPos,uniforms.vClipPlane6);\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},7029:(e,t,i)=>{"use strict";i.r(t),i.d(t,{clipPlaneVertexDeclarationWGSL:()=>n});const s="clipPlaneVertexDeclaration",r="#ifdef CLIPPLANE\nuniform vClipPlane: vec4<f32>;varying fClipDistance: f32;\n#endif\n#ifdef CLIPPLANE2\nuniform vClipPlane2: vec4<f32>;varying fClipDistance2: f32;\n#endif\n#ifdef CLIPPLANE3\nuniform vClipPlane3: vec4<f32>;varying fClipDistance3: f32;\n#endif\n#ifdef CLIPPLANE4\nuniform vClipPlane4: vec4<f32>;varying fClipDistance4: f32;\n#endif\n#ifdef CLIPPLANE5\nuniform vClipPlane5: vec4<f32>;varying fClipDistance5: f32;\n#endif\n#ifdef CLIPPLANE6\nuniform vClipPlane6: vec4<f32>;varying fClipDistance6: f32;\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},6407:(e,t,i)=>{"use strict";i.r(t),i.d(t,{fogFragmentDeclarationWGSL:()=>n});const s="fogFragmentDeclaration",r="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\nconst E=2.71828;uniform vFogInfos: vec4f;uniform vFogColor: vec3f;varying vFogDistance: vec3f;fn CalcFogFactor()->f32\n{var fogCoeff: f32=1.0;var fogStart: f32=uniforms.vFogInfos.y;var fogEnd: f32=uniforms.vFogInfos.z;var fogDensity: f32=uniforms.vFogInfos.w;var fogDistance: f32=length(fragmentInputs.vFogDistance);if (FOGMODE_LINEAR==uniforms.vFogInfos.x)\n{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}\nelse if (FOGMODE_EXP==uniforms.vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}\nelse if (FOGMODE_EXP2==uniforms.vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}\nreturn clamp(fogCoeff,0.0,1.0);}\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},9702:(e,t,i)=>{"use strict";i.r(t),i.d(t,{helperFunctionsWGSL:()=>n});const s="helperFunctions",r="const PI: f32=3.1415926535897932384626433832795;const RECIPROCAL_PI: f32=0.3183098861837907;const RECIPROCAL_PI2: f32=0.15915494309189535;const HALF_MIN: f32=5.96046448e-08; \nconst LinearEncodePowerApprox: f32=2.2;const GammaEncodePowerApprox: f32=1.0/LinearEncodePowerApprox;const LuminanceEncodeApprox: vec3<f32>=vec3<f32> (0.2126,0.7152,0.0722);const Epsilon:f32=0.0000001;fn square(x: f32)->f32 {return x*x;}\nfn saturate(x: f32)->f32 {return clamp(x,0.0,1.0);}\nfn saturateVec3(x: vec3f)->vec3f {return clamp(x,vec3f(0.0),vec3f(1.0));}\nfn saturateEps(x: f32)->f32 {return clamp(x,Epsilon,1.0);} \nfn maxEps(x: f32)->f32 {return max(x,Epsilon);}\nfn maxEpsVec3(x: vec3f)->vec3f {return max(x,vec3f(Epsilon));}\nfn absEps(x: f32)->f32 {return abs(x)+Epsilon;}\nfn transposeMat3(inMatrix: mat3x3f)->mat3x3f {let i0: vec3<f32>=inMatrix[0];let i1: vec3<f32>=inMatrix[1];let i2: vec3<f32>=inMatrix[2];let outMatrix:mat3x3f=mat3x3f(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);return outMatrix;}\nfn inverseMat3(inMatrix: mat3x3f)->mat3x3f {let a00: f32=inMatrix[0][0];let a01: f32=inMatrix[0][1];let a02: f32=inMatrix[0][2];let a10: f32=inMatrix[1][0];let a11: f32=inMatrix[1][1];let a12: f32=inMatrix[1][2];let a20: f32=inMatrix[2][0];let a21: f32=inMatrix[2][1];let a22: f32=inMatrix[2][2];let b01: f32=a22*a11-a12*a21;let b11: f32=-a22*a10+a12*a20;let b21: f32=a21*a10-a11*a20;let det: f32=a00*b01+a01*b11+a02*b21;return mat3x3f(b01/det,(-a22*a01+a02*a21)/det,(a12*a01-a02*a11)/det,\nb11/det,(a22*a00-a02*a20)/det,(-a12*a00+a02*a10)/det,\nb21/det,(-a21*a00+a01*a20)/det,(a11*a00-a01*a10)/det);}\n#if USE_EXACT_SRGB_CONVERSIONS\nfn toLinearSpaceExact(color: vec3<f32>)->vec3<f32>\n{let nearZeroSection: vec3<f32>=0.0773993808*color;let remainingSection: vec3<f32>=pow(0.947867299*(color+vec3<f32>(0.055)),vec3<f32>(2.4));return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3<f32>(0.04045)));}\nfn toGammaSpaceExact(color: vec3<f32>)->vec3<f32>\n{let nearZeroSection: vec3<f32>=12.92*color;let remainingSection: vec3<f32>=1.055*pow(color,vec3<f32>(0.41666))-vec3<f32>(0.055);return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3<f32>(0.0031308)));}\n#endif\nfn toLinearSpace(color: f32)->f32\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nvar nearZeroSection=0.0773993808*color;var remainingSection=pow(0.947867299*(color+0.055),2.4);return select(remainingSection,nearZeroSection,color<=0.04045);\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nfn toLinearSpaceVec3(color: vec3<f32>)->vec3<f32>\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3<f32>(LinearEncodePowerApprox));\n#endif\n}\nfn toLinearSpaceVec4(color: vec4<f32>)->vec4<f32>\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4f(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4f(pow(color.rgb,vec3f(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfn toGammaSpace(color: vec4<f32>)->vec4<f32>\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4<f32>(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4<f32>(pow(color.rgb,vec3<f32>(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfn toGammaSpaceVec3(color: vec3<f32>)->vec3<f32>\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3<f32>(GammaEncodePowerApprox));\n#endif\n}\nfn squareVec3(value: vec3<f32>)->vec3<f32>\n{return value*value;}\nfn pow5(value: f32)->f32 {let sq: f32=value*value;return sq*sq*value;}\nfn getLuminance(color: vec3<f32>)->f32\n{return clamp(dot(color,LuminanceEncodeApprox),0.,1.);}\nfn getRand(seed: vec2<f32>)->f32 {return fract(sin(dot(seed.xy ,vec2<f32>(12.9898,78.233)))*43758.5453);}\nfn dither(seed: vec2<f32>,varianceAmount: f32)->f32 {let rand: f32=getRand(seed);let normVariance: f32=varianceAmount/255.0;let dither: f32=mix(-normVariance,normVariance,rand);return dither;}\nconst rgbdMaxRange: f32=255.0;fn toRGBD(color: vec3<f32>)->vec4<f32> {let maxRGB: f32=max(max(color.r,max(color.g,color.b)),Epsilon);var D: f32 =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);var rgb: vec3<f32> =color.rgb*D;rgb=toGammaSpaceVec3(rgb);return vec4<f32>(clamp(rgb,vec3<f32>(0.,0.,0.),vec3<f32>(1.,1.,1.)),D); }\nfn fromRGBD(rgbd: vec4<f32>)->vec3<f32> {let rgb=toLinearSpaceVec3(rgbd.rgb);return rgb/rgbd.a;}\nfn parallaxCorrectNormal(vertexPos: vec3<f32>,origVec: vec3<f32>,cubeSize: vec3<f32>,cubePos: vec3<f32>)->vec3<f32> {let invOrigVec: vec3<f32>=vec3<f32>(1.0,1.0,1.0)/origVec;let halfSize: vec3<f32>=cubeSize*0.5;let intersecAtMaxPlane: vec3<f32>=(cubePos+halfSize-vertexPos)*invOrigVec;let intersecAtMinPlane: vec3<f32>=(cubePos-halfSize-vertexPos)*invOrigVec;let largestIntersec: vec3<f32>=max(intersecAtMaxPlane,intersecAtMinPlane);let distance: f32=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);let intersectPositionWS: vec3<f32>=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},6205:(e,t,i)=>{"use strict";i.r(t),i.d(t,{imageProcessingDeclarationWGSL:()=>n});const s="imageProcessingDeclaration",r="#ifdef EXPOSURE\nuniform exposureLinear: f32;\n#endif\n#ifdef CONTRAST\nuniform contrast: f32;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vInverseScreenSize: vec2f;\n#endif\n#ifdef VIGNETTE\nuniform vignetteSettings1: vec4f;uniform vignetteSettings2: vec4f;\n#endif\n#ifdef COLORCURVES\nuniform vCameraColorCurveNegative: vec4f;uniform vCameraColorCurveNeutral: vec4f;uniform vCameraColorCurvePositive: vec4f;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nvar txColorTransformSampler: sampler;var txColorTransform: texture_3d<f32>;\n#else\nvar txColorTransformSampler: sampler;var txColorTransform: texture_2d<f32>;\n#endif\nuniform colorTransformSettings: vec4f;\n#endif\n#ifdef DITHER\nuniform ditherIntensity: f32;\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},8996:(e,t,i)=>{"use strict";i.r(t),i.d(t,{imageProcessingFunctionsWGSL:()=>n});const s="imageProcessingFunctions",r="#if TONEMAPPING==3\nconst PBRNeutralStartCompression: f32=0.8-0.04;const PBRNeutralDesaturation: f32=0.15;fn PBRNeutralToneMapping( color: vec3f )->vec3f {var x: f32=min(color.r,min(color.g,color.b));var offset: f32=select(0.04,x-6.25*x*x,x<0.08);var result=color;result-=offset;var peak: f32=max(result.r,max(result.g,result.b));if (peak<PBRNeutralStartCompression) {return result;}\nvar d: f32=1.-PBRNeutralStartCompression;var newPeak: f32=1.-d*d/(peak+d-PBRNeutralStartCompression);result*=newPeak/peak;var g: f32=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(result,newPeak* vec3f(1,1,1),g);}\n#endif\n#if TONEMAPPING==2\nconst ACESInputMat: mat3x3f= mat3x3f(\nvec3f(0.59719,0.07600,0.02840),\nvec3f(0.35458,0.90834,0.13383),\nvec3f(0.04823,0.01566,0.83777)\n);const ACESOutputMat: mat3x3f= mat3x3f(\nvec3f( 1.60475,-0.10208,-0.00327),\nvec3f(-0.53108, 1.10813,-0.07276),\nvec3f(-0.07367,-0.00605, 1.07602)\n);fn RRTAndODTFit(v: vec3f)->vec3f\n{var a: vec3f=v*(v+0.0245786)-0.000090537;var b: vec3f=v*(0.983729*v+0.4329510)+0.238081;return a/b;}\nfn ACESFitted(color: vec3f)->vec3f\n{var output=ACESInputMat*color;output=RRTAndODTFit(output);output=ACESOutputMat*output;output=saturateVec3(output);return output;}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nfn applyImageProcessing(result: vec4f)->vec4f {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\nvar rgb=result.rgb;;\n#ifdef EXPOSURE\nrgb*=uniforms.exposureLinear;\n#endif\n#ifdef VIGNETTE\nvar viewportXY: vec2f=fragmentInputs.position.xy*uniforms.vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;var vignetteXY1: vec3f= vec3f(viewportXY*uniforms.vignetteSettings1.xy+uniforms.vignetteSettings1.zw,1.0);var vignetteTerm: f32=dot(vignetteXY1,vignetteXY1);var vignette: f32=pow(vignetteTerm,uniforms.vignetteSettings2.w);var vignetteColor: vec3f=uniforms.vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvar vignetteColorMultiplier: vec3f=mix(vignetteColor, vec3f(1,1,1),vignette);rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nrgb=mix(vignetteColor,rgb,vignette);\n#endif\n#endif\n#if TONEMAPPING==3\nrgb=PBRNeutralToneMapping(rgb);\n#elif TONEMAPPING==2\nrgb=ACESFitted(rgb);\n#elif TONEMAPPING==1\nconst tonemappingCalibration: f32=1.590579;rgb=1.0-exp2(-tonemappingCalibration*rgb);\n#endif\nrgb=toGammaSpaceVec3(rgb);rgb=saturateVec3(rgb);\n#ifdef CONTRAST\nvar resultHighContrast: vec3f=rgb*rgb*(3.0-2.0*rgb);if (uniforms.contrast<1.0) {rgb=mix( vec3f(0.5,0.5,0.5),rgb,uniforms.contrast);} else {rgb=mix(rgb,resultHighContrast,uniforms.contrast-1.0);}\n#endif\n#ifdef COLORGRADING\nvar colorTransformInput: vec3f=rgb*uniforms.colorTransformSettings.xxx+uniforms.colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvar colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput).rgb;\n#else\nvar colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput,uniforms.colorTransformSettings.yz).rgb;\n#endif\nrgb=mix(rgb,colorTransformOutput,uniforms.colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nvar luma: f32=getLuminance(rgb);var curveMix: vec2f=clamp( vec2f(luma*3.0-1.5,luma*-3.0+1.5), vec2f(0.0), vec2f(1.0));var colorCurve: vec4f=uniforms.vCameraColorCurveNeutral+curveMix.x*uniforms.vCameraColorCurvePositive-curveMix.y*uniforms.vCameraColorCurveNegative;rgb*=colorCurve.rgb;rgb=mix( vec3f(luma),rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nvar rand: f32=getRand(fragmentInputs.position.xy*uniforms.vInverseScreenSize);var dither: f32=mix(-uniforms.ditherIntensity,uniforms.ditherIntensity,rand);rgb=saturateVec3(rgb+ vec3f(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn vec4f(rgb,result.a);}";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},4559:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStoreWGSL.instancesDeclaration="#ifdef INSTANCES\nattribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;\n#ifdef INSTANCESCOLOR\nattribute instanceColor : vec4<f32>;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nattribute previousWorld0 : vec4<f32>;attribute previousWorld1 : vec4<f32>;attribute previousWorld2 : vec4<f32>;attribute previousWorld3 : vec4<f32>;\n#ifdef THIN_INSTANCES\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform world : mat4x4<f32>;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nuniform previousWorld : mat4x4<f32>;\n#endif\n#endif\n"},1277:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStoreWGSL.instancesVertex="#ifdef INSTANCES\nvar finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nvar finalPreviousWorld=mat4x4<f32>(\nvertexInputs.previousWorld0,vertexInputs.previousWorld1,\nvertexInputs.previousWorld2,vertexInputs.previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\n#if !defined(WORLD_UBO)\nfinalWorld=uniforms.world*finalWorld;\n#else\nfinalWorld=mesh.world*finalWorld;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nfinalPreviousWorld=uniforms.previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nvar finalWorld=uniforms.world;\n#else\nvar finalWorld=mesh.world;\n#endif\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nvar finalPreviousWorld=uniforms.previousWorld;\n#endif\n#endif\n"},2383:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStoreWGSL.kernelBlurVaryingDeclaration="varying sampleCoord{X}: vec2f;"},5271:(e,t,i)=>{"use strict";i.r(t),i.d(t,{lightFragmentWGSL:()=>n});const s="lightFragment",r="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\nvar diffuse{X}: vec4f=light{X}.vLightDiffuse;\n#define CUSTOM_LIGHT{X}_COLOR \n#ifdef PBR\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#ifdef HEMILIGHT{X}\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);\n#elif defined(SS_TRANSLUCENCY)\ninfo.diffuse=computeDiffuseAndTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);\n#endif\n#ifdef SPECULARTERM\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},projectionLightTexture{X}Sampler,uniforms.textureProjectionMatrix{X},fragmentInputs.vPositionW);\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSMDEBUG{X}\nvar shadowDebug{X}: vec3f;\n#endif\n#ifdef SHADOWCSM{X}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nvar index{X}: i32=-1;\n#else\nvar index{X}: i32=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nvar diff{X}: f32=0.;vPositionFromLight{X}[0]=fragmentInputs.vPositionFromLight{X}_0;vPositionFromLight{X}[1]=fragmentInputs.vPositionFromLight{X}_1;vPositionFromLight{X}[2]=fragmentInputs.vPositionFromLight{X}_2;vPositionFromLight{X}[3]=fragmentInputs.vPositionFromLight{X}_3;vDepthMetric{X}[0]=fragmentInputs.vDepthMetric{X}_0;vDepthMetric{X}[1]=fragmentInputs.vDepthMetric{X}_1;vDepthMetric{X}[2]=fragmentInputs.vDepthMetric{X}_2;vDepthMetric{X}[3]=fragmentInputs.vDepthMetric{X}_3;for (var i:i32=0; i<SHADOWCSMNUM_CASCADES{X}; i++) \n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=uniforms.viewFrustumZ{X}[i]+fragmentInputs.vPositionFromCamera{X}.z;\n#else\ndiff{X}=uniforms.viewFrustumZ{X}[i]-fragmentInputs.vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {index{X}=i;break;}}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3f(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nvar frustumLength:f32=uniforms.frustumLengths{X}[index{X}];var diffRatio:f32=clamp(diff{X}/frustumLength,0.,1.)*uniforms.cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{index{X}+=1;var nextShadow: f32=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;shadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\naggShadow+=shadow;numLights+=1.0;\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else \ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},379:(e,t,i)=>{"use strict";i.r(t),i.d(t,{lightUboDeclarationWGSL:()=>n});const s="lightUboDeclaration",r="#ifdef LIGHT{X}\nstruct Light{X}\n{vLightData: vec4f,\nvLightDiffuse: vec4f,\nvLightSpecular: vec4f,\n#ifdef SPOTLIGHT{X}\nvLightDirection: vec4f,\nvLightFalloff: vec4f,\n#elif defined(POINTLIGHT{X})\nvLightFalloff: vec4f,\n#elif defined(HEMILIGHT{X})\nvLightGround: vec3f,\n#endif\nshadowsInfo: vec4f,\ndepthValues: vec2f} ;var<uniform> light{X} : Light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform textureProjectionMatrix{X}: mat4x4f;var projectionLightTexture{X}Sampler: sampler;var projectionLightTexture{X}: texture_2d<f32>;\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;uniform viewFrustumZ{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform frustumLengths{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform cascadeBlendFactor{X}: f32;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;var<private> vPositionFromLight{X}: array<vec4f,4>;var<private> vDepthMetric{X} : array<f32,4>;\n#if defined(SHADOWPCSS{X})\nvar shadowTexture{X}Sampler: sampler_comparison; \nvar shadowTexture{X}: texture_depth_2d_array;var depthTexture{X}Sampler: sampler;var depthTexture{X}: texture_2d_array<f32>;uniform lightSizeUVCorrection{X}: array<vec2f,SHADOWCSMNUM_CASCADES{X}>;uniform depthCorrection{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform penumbraDarkness{X}: f32;\n#elif defined(SHADOWPCF{X})\nvar shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d_array;\n#else \nvar shadowTexture{X}Sampler: sampler; \nvar shadowTexture{X}: texture_2d_array<f32>;\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vCascadeColorsMultiplier{X}: array<vec3f,8>=array<vec3f,8>\n(\nvec3f ( 1.5,0.0,0.0 ),\nvec3f ( 0.0,1.5,0.0 ),\nvec3f ( 0.0,0.0,5.5 ),\nvec3f ( 1.5,0.0,5.5 ),\nvec3f ( 1.5,1.5,0.0 ),\nvec3f ( 1.0,1.0,1.0 ),\nvec3f ( 0.0,1.0,5.5 ),\nvec3f ( 0.5,3.5,0.75 )\n);\n#endif\n#elif defined(SHADOWCUBE{X})\nvar shadowTexture{X}Sampler: sampler;var shadowTexture{X}: texture_cube<f32>;\n#else\nvarying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;\n#if defined(SHADOWPCSS{X})\nvar shadowTexture{X}Sampler: sampler_comparison; \nvar shadowTexture{X}: texture_depth_2d;var depthTexture{X}Sampler: sampler; \nvar depthTexture{X}: texture_2d<f32>;\n#elif defined(SHADOWPCF{X})\nvar shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d;\n#else\nvar shadowTexture{X}Sampler: sampler; \nvar shadowTexture{X}: texture_2d<f32>;\n#endif\nuniform lightMatrix{X}: mat4x4f;\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},3925:(e,t,i)=>{"use strict";i.r(t),i.d(t,{lightVxUboDeclarationWGSL:()=>n});const s="lightVxUboDeclaration",r="#ifdef LIGHT{X}\nstruct Light{X}\n{vLightData: vec4f,\nvLightDiffuse: vec4f,\nvLightSpecular: vec4f,\n#ifdef SPOTLIGHT{X}\nvLightDirection: vec4f,\nvLightFalloff: vec4f,\n#elif defined(POINTLIGHT{X})\nvLightFalloff: vec4f,\n#elif defined(HEMILIGHT{X})\nvLightGround: vec3f,\n#endif\nshadowsInfo: vec4f,\ndepthValues: vec2f} ;var<uniform> light{X} : Light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},6493:(e,t,i)=>{"use strict";i.r(t),i.d(t,{lightsFragmentFunctionsWGSL:()=>n});const s="lightsFragmentFunctions",r="struct lightingInfo\n{diffuse: vec3f,\n#ifdef SPECULARTERM\nspecular: vec3f,\n#endif\n#ifdef NDOTL\nndl: f32,\n#endif\n};fn computeLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var lightVectorW: vec3f;var attenuation: f32=1.0;if (lightData.w==0.)\n{var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var attenuation: f32=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}\nelse\n{lightVectorW=normalize(-lightData.xyz);}\nvar ndl: f32=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nfn computeSpotLighting(viewDirectionW: vec3f,vNormal: vec3f ,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var cosAngle: f32=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)\n{cosAngle=max(0.,pow(cosAngle,lightData.w));attenuation*=cosAngle;var ndl: f32=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nresult.diffuse=vec3f(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3f(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nfn computeHemisphericLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,groundColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvar angleW: vec3f=normalize(viewDirectionW+lightData.xyz);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;\n#endif\nreturn result;}\nfn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f {var strq: vec4f=textureProjectionMatrix*vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return textureColor;}";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},9129:(e,t,i)=>{"use strict";i.r(t),i.d(t,{morphTargetsVertexWGSL:()=>n});const s="morphTargetsVertex",r="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\n#if {X}==0\nfor (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (i>=uniforms.morphTargetCount) {break;}\nvertexID=f32(vertexInputs.vertexIndex)*uniforms.morphTargetTextureInfo.x;positionUpdated=positionUpdated+(readVector3FromRawSampler(i,vertexID)-vertexInputs.position)*uniforms.morphTargetInfluences[i];vertexID=vertexID+1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated=normalUpdated+(readVector3FromRawSampler(i,vertexID) -vertexInputs.normal)*uniforms.morphTargetInfluences[i];vertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(readVector3FromRawSampler(i,vertexID).xy-vertexInputs.uv)*uniforms.morphTargetInfluences[i];vertexID=vertexID+1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated=vec4f(tangentUpdated.xyz+(readVector3FromRawSampler(i,vertexID) -vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[i],tangentUpdated.a);\n#endif\n}\n#endif\n#else\npositionUpdated=positionUpdated+(vertexInputs.position{X}-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(vertexInputs.normal{X}-vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated=vec4f(tangentUpdated.xyz+(vertexInputs.tangent{X}-vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}],tangentUpdated.a);\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated=uvUpdated+(vertexInputs.uv_{X}-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},8217:(e,t,i)=>{"use strict";i.r(t),i.d(t,{morphTargetsVertexDeclarationWGSL:()=>n});const s="morphTargetsVertexDeclaration",r="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute position{X} : vec3<f32>;\n#ifdef MORPHTARGETS_NORMAL\nattribute normal{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute tangent{X} : vec3<f32>;\n#endif\n#ifdef MORPHTARGETS_UV\nattribute uv_{X} : vec2<f32>;\n#endif\n#elif {X}==0\nuniform morphTargetCount: i32;\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},8258:(e,t,i)=>{"use strict";i.r(t),i.d(t,{morphTargetsVertexGlobalWGSL:()=>n});const s="morphTargetsVertexGlobal",r="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nvar vertexID : f32;\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},6340:(e,t,i)=>{"use strict";i.r(t),i.d(t,{morphTargetsVertexGlobalDeclarationWGSL:()=>n});const s="morphTargetsVertexGlobalDeclaration",r="#ifdef MORPHTARGETS\nuniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;\n#ifdef MORPHTARGETS_TEXTURE \nuniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;uniform morphTargetTextureInfo : vec3<f32>;var morphTargets : texture_2d_array<f32>;var morphTargetsSampler : sampler;fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>\n{ \nlet y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;}\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},5543:(e,t,i)=>{"use strict";i.r(t),i.d(t,{packingFunctionsWGSL:()=>n});const s="packingFunctions",r="fn pack(depth: f32)->vec4f\n{const bit_shift: vec4f= vec4f(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const bit_mask: vec4f= vec4f(0.0,1.0/255.0,1.0/255.0,1.0/255.0);var res: vec4f=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfn unpack(color: vec4f)->f32\n{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},5052:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStoreWGSL.pbrBRDFFunctions="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nfn getEnergyConservationFactor(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}\n#endif\n#ifdef ENVIRONMENTBRDF\nfn getBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {var UV: vec2f= vec2f(NdotV,perceptualRoughness);var brdfLookup: vec4f= textureSample(environmentBrdfSampler,environmentBrdfSamplerSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup=vec4f(fromRGBD(brdfLookup.rgba),brdfLookup.a);\n#endif\nreturn brdfLookup.rgb;}\nfn getReflectanceFromBRDFWithEnvLookup(specularEnvironmentR0: vec3f,specularEnvironmentR90: vec3f,environmentBrdf: vec3f)->vec3f {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar reflectance: vec3f=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvar reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;}\nfn getReflectanceFromBRDFLookup(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvar reflectance: vec3f=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvar reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfn getBRDFLookupCharlieSheen(NdotV: f32,perceptualRoughness: f32)->f32\n{var c: f32=1.0-NdotV;var c3: f32=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nfn getReflectanceFromAnalyticalBRDFLookup_Jones(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f\n{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nfn getSheenReflectanceFromBRDFLookup(reflectance0: vec3f,environmentBrdf: vec3f)->vec3f {var sheenEnvironmentReflectance: vec3f=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}\n#endif\nfn fresnelSchlickGGXVec3(VdotH: f32,reflectance0: vec3f,reflectance90: vec3f)->vec3f\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\nfn fresnelSchlickGGX(VdotH: f32,reflectance0: f32,reflectance90: f32)->f32\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\n#ifdef CLEARCOAT\nfn getR0RemappedForClearCoat(f0: vec3f)->vec3f {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturateVec3(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturateVec3(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvar s: vec3f=sqrt(f0);var t: vec3f=(uniforms.vClearCoatRefractionParams.z+uniforms.vClearCoatRefractionParams.w*s)/(uniforms.vClearCoatRefractionParams.w+uniforms.vClearCoatRefractionParams.z*s);return squareVec3(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst XYZ_TO_REC709: mat3x3f= mat3x3f(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);fn getIORTfromAirToSurfaceR0(f0: vec3f)->vec3f {var sqrtF0: vec3f=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}\nfn getR0fromIORsVec3(iorT: vec3f,iorI: f32)->vec3f {return squareVec3((iorT- vec3f(iorI))/(iorT+ vec3f(iorI)));}\nfn getR0fromIORs(iorT: f32,iorI: f32)->f32 {return square((iorT-iorI)/(iorT+iorI));}\nfn evalSensitivity(opd: f32,shift: vec3f)->vec3f {var phase: f32=2.0*PI*opd*1.0e-9;const val: vec3f= vec3f(5.4856e-13,4.4201e-13,5.2481e-13);const pos: vec3f= vec3f(1.6810e+06,1.7953e+06,2.2084e+06);const vr: vec3f= vec3f(4.3278e+09,9.3046e+09,6.6121e+09);var xyz: vec3f=val*sqrt(2.0*PI*vr)*cos(pos*phase+shift)*exp(-square(phase)*vr);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;var srgb: vec3f=XYZ_TO_REC709*xyz;return srgb;}\nfn evalIridescence(outsideIOR: f32,eta2: f32,cosTheta1: f32,thinFilmThickness: f32,baseF0: vec3f)->vec3f {var I: vec3f= vec3f(1.0);var iridescenceIOR: f32=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));var sinTheta2Sq: f32=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));var cosTheta2Sq: f32=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}\nvar cosTheta2: f32=sqrt(cosTheta2Sq);var R0: f32=getR0fromIORs(iridescenceIOR,outsideIOR);var R12: f32=fresnelSchlickGGX(cosTheta1,R0,1.);var R21: f32=R12;var T121: f32=1.0-R12;var phi12: f32=0.0;if (iridescenceIOR<outsideIOR) {phi12=PI;}\nvar phi21: f32=PI-phi12;var baseIOR: vec3f=getIORTfromAirToSurfaceR0(clamp(baseF0,vec3f(0.0),vec3f(0.9999))); \nvar R1: vec3f=getR0fromIORsVec3(baseIOR,iridescenceIOR);var R23: vec3f=fresnelSchlickGGXVec3(cosTheta2,R1, vec3f(1.));var phi23: vec3f= vec3f(0.0);if (baseIOR[0]<iridescenceIOR) {phi23[0]=PI;}\nif (baseIOR[1]<iridescenceIOR) {phi23[1]=PI;}\nif (baseIOR[2]<iridescenceIOR) {phi23[2]=PI;}\nvar opd: f32=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;var phi: vec3f= vec3f(phi21)+phi23;var R123: vec3f=clamp(R12*R23,vec3f(1e-5),vec3f(0.9999));var r123: vec3f=sqrt(R123);var Rs: vec3f=(T121*T121)*R23/( vec3f(1.0)-R123);var C0: vec3f=R12+Rs;I=C0;var Cm: vec3f=Rs-T121;for (var m: i32=1; m<=2; m++)\n{Cm*=r123;var Sm: vec3f=2.0*evalSensitivity( f32(m)*opd, f32(m)*phi);I+=Cm*Sm;}\nreturn max(I, vec3f(0.0));}\n#endif\nfn normalDistributionFunction_TrowbridgeReitzGGX(NdotH: f32,alphaG: f32)->f32\n{var a2: f32=alphaG*alphaG;var d: f32=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}\n#ifdef SHEEN\nfn normalDistributionFunction_CharlieSheen(NdotH: f32,alphaG: f32)->f32\n{var invR: f32=1./alphaG;var cos2h: f32=NdotH*NdotH;var sin2h: f32=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}\n#endif\n#ifdef ANISOTROPIC\nfn normalDistributionFunction_BurleyGGX_Anisotropic(NdotH: f32,TdotH: f32,BdotH: f32,alphaTB: vec2f)->f32 {var a2: f32=alphaTB.x*alphaTB.y;var v: vec3f= vec3f(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);var v2: f32=dot(v,v);var w2: f32=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfn smithVisibility_GGXCorrelated(NdotL: f32,NdotV: f32,alphaG: f32)->f32 {\n#ifdef MOBILE\nvar GGXV: f32=NdotL*(NdotV*(1.0-alphaG)+alphaG);var GGXL: f32=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);\n#else\nvar a2: f32=alphaG*alphaG;var GGXV: f32=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);var GGXL: f32=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfn smithVisibilityG1_TrowbridgeReitzGGXFast(dot: f32,alphaG: f32)->f32\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nvar alphaSquared: f32=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfn smithVisibility_TrowbridgeReitzGGXFast(NdotL: f32,NdotV: f32,alphaG: f32)->f32\n{var visibility: f32=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}\n#endif\n#ifdef ANISOTROPIC\nfn smithVisibility_GGXCorrelated_Anisotropic(NdotL: f32,NdotV: f32,TdotV: f32,BdotV: f32,TdotL: f32,BdotL: f32,alphaTB: vec2f)->f32 {var lambdaV: f32=NdotL*length( vec3f(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));var lambdaL: f32=NdotV*length( vec3f(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));var v: f32=0.5/(lambdaV+lambdaL);return v;}\n#endif\n#ifdef CLEARCOAT\nfn visibility_Kelemen(VdotH: f32)->f32 {return 0.25/(VdotH*VdotH); }\n#endif\n#ifdef SHEEN\nfn visibility_Ashikhmin(NdotL: f32,NdotV: f32)->f32\n{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfn l(x: f32,alphaG: f32)->f32\n{var oneMinusAlphaSq: f32=(1.0-alphaG)*(1.0-alphaG);var a: f32=mix(21.5473,25.3245,oneMinusAlphaSq);var b: f32=mix(3.82987,3.32435,oneMinusAlphaSq);var c: f32=mix(0.19823,0.16801,oneMinusAlphaSq);var d: f32=mix(-1.97760,-1.27393,oneMinusAlphaSq);var e: f32=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}\nfn lambdaSheen(cosTheta: f32,alphaG: f32)->f32\n{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}\nfn visibility_CharlieSheen(NdotL: f32,NdotV: f32,alphaG: f32)->f32\n{var G: f32=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}\n#endif\n*/\n#endif\nfn diffuseBRDF_Burley(NdotL: f32,NdotV: f32,VdotH: f32,roughness: f32)->f32 {var diffuseFresnelNV: f32=pow5(saturateEps(1.0-NdotL));var diffuseFresnelNL: f32=pow5(saturateEps(1.0-NdotV));var diffuseFresnel90: f32=0.5+2.0*VdotH*VdotH*roughness;var fresnel: f32 =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}\n#ifdef SS_TRANSLUCENCY\nfn transmittanceBRDF_Burley(tintColor: vec3f,diffusionDistance: vec3f,thickness: f32)->vec3f {var S: vec3f=1./maxEpsVec3(diffusionDistance);var temp: vec3f=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}\nfn computeWrappedDiffuseNdotL(NdotL: f32,w: f32)->f32 {var t: f32=1.0+w;var invt2: f32=1.0/(t*t);return saturate((NdotL+w)*invt2);}\n#endif\n"},2230:(e,t,i)=>{"use strict";i.r(t),i.d(t,{reflectionFunctionWGSL:()=>n});const s="reflectionFunction",r="fn computeFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f\n{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0); }\nfn computeMirroredFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f\n{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(1.0-s,t,0); }\nfn computeEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{var cameraToVertex: vec3f=normalize(worldPos.xyz-eyePosition);var r: vec3f=normalize(reflect(cameraToVertex,worldNormal));r= (reflectionMatrix* vec4f(r,0)).xyz;var lon: f32=atan2(r.z,r.x);var lat: f32=acos(r.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0);}\nfn computeSphericalCoords(worldPos: vec4f,worldNormal: vec3f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f\n{var viewDir: vec3f=normalize((view*worldPos).xyz);var viewNormal: vec3f=normalize((view* vec4f(worldNormal,0.0)).xyz);var r: vec3f=reflect(viewDir,viewNormal);r= (reflectionMatrix* vec4f(r,0)).xyz;r.z=r.z-1.0;var m: f32=2.0*length(r);return vec3f(r.x/m+0.5,1.0-r.y/m-0.5,0);}\nfn computePlanarCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{var viewDir: vec3f=worldPos.xyz-eyePosition;var coords: vec3f=normalize(reflect(viewDir,worldNormal));return (reflectionMatrix* vec4f(coords,1)).xyz;}\nfn computeCubicCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords= (reflectionMatrix* vec4f(coords,0)).xyz;\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nfn computeCubicLocalCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f,reflectionSize: vec3f,reflectionPosition: vec3f)->vec3f\n{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=(reflectionMatrix* vec4f(coords,0)).xyz;\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nfn computeProjectionCoords(worldPos: vec4f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f\n{return (reflectionMatrix*(view*worldPos)).xyz;}\nfn computeSkyBoxCoords(positionW: vec3f,reflectionMatrix: mat4x4f)->vec3f\n{return (reflectionMatrix* vec4f(positionW,1.)).xyz;}\n#ifdef REFLECTION\nfn computeReflectionCoords(worldPos: vec4f,worldNormal: vec3f)->vec3f\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvar direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvar direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,scene.view,uniforms.reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix,uniforms.vReflectionSize,uniforms.vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,scene.view,uniforms.reflectionMatrix);\n#endif\n#ifndef REFLECTIONMAP_CUBIC\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(fragmentInputs.vPositionUVW,uniforms.reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3f(0,0,0);\n#endif\n}\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},983:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStoreWGSL.samplerFragmentDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying v_VARYINGNAME_UV: vec2f;\n#endif\nvar _SAMPLERNAME_SamplerSampler: sampler;var _SAMPLERNAME_Sampler: texture_2d<f32>;\n#endif\n"},5228:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStoreWGSL.screenSpaceRayTrace="fn distanceSquared(a: vec2f,b: vec2f)->f32 { \nvar temp=a-b; \nreturn dot(temp,temp); }\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nfn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nreturn -(near*far)/(far-depth*(far-near));\n#else\nreturn (near*far)/(far-depth*(far-near));\n#endif\n}\n#endif\n/**\nparam csOrigin Camera-space ray origin,which must be \nwithin the view volume and must have z>0.01 and project within the valid screen rectangle\nparam csDirection Unit length camera-space ray direction\nparam projectToPixelMatrix A projection matrix that maps to **pixel** coordinates \n(**not** [-1,+1] normalized device coordinates).\nparam csZBuffer The camera-space Z buffer\nparam csZBufferSize Dimensions of csZBuffer\nparam csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer\nparam nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value\nfor clipping rays headed towards the camera. Should be the actual near plane if screen-space depth is enabled.\nparam farPlaneZ The far plane for the camera. Used when screen-space depth is enabled.\nparam stride Step in horizontal or vertical pixels between samples. This is a var because: f32 integer math is slow on GPUs,but should be set to an integer>=1\nparam jitterFraction Number between 0 and 1 for how far to bump the ray in stride units\nto conceal banding artifacts,plus the stride ray offset.\nparam maxSteps Maximum number of iterations. Higher gives better images but may be slow\nparam maxRayTraceDistance Maximum camera-space distance to trace before returning a miss\nparam selfCollisionNumSkip Number of steps to skip at start when raytracing to avar self: voidnull collisions.\n1 is a reasonable value,depending on the scene you may need to set this value to 2\nparam hitPixel Pixel coordinates of the first intersection with the scene\nparam numIterations number of iterations performed\nparam csHitPovar Camera: i32 space location of the ray hit\n*/\nfn traceScreenSpaceRay1(\ncsOrigin: vec3f,\ncsDirection: vec3f,\nprojectToPixelMatrix: mat4x4f,\ncsZBuffer: texture_2d<f32>,\ncsZBufferSize: vec2f,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\ncsZBackBuffer: texture_2d<f32>,\ncsZBackSizeFactor: f32,\n#endif\ncsZThickness: f32,\nnearPlaneZ: f32,\nfarPlaneZ: f32,\nstride: f32,\njitterFraction: f32,\nmaxSteps: f32,\nmaxRayTraceDistance: f32,\nselfCollisionNumSkip: f32,\nstartPixel: ptr<function,vec2f>,\nhitPixel: ptr<function,vec2f>,\ncsHitPoint: ptr<function,vec3f>,\nnumIterations: ptr<function,f32>\n#ifdef SSRAYTRACE_DEBUG\n,debugColor: ptr<function,vec3f>\n#endif\n)->bool\n{\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nvar rayLength: f32=select(maxRayTraceDistance,(-nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ);\n#else\nvar rayLength: f32=select(maxRayTraceDistance,(nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ);\n#endif\nvar csEndPoint: vec3f=csOrigin+csDirection*rayLength;*hitPixel= vec2f(-1.0,-1.0);var H0: vec4f=projectToPixelMatrix* vec4f(csOrigin,1.0);var H1: vec4f=projectToPixelMatrix* vec4f(csEndPoint,1.0);var k0: f32=1.0/H0.w;var k1: f32=1.0/H1.w;var Q0: vec3f=csOrigin*k0;var Q1: vec3f=csEndPoint*k1;var P0: vec2f=H0.xy*k0;var P1: vec2f=H1.xy*k1;\n#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM\nvar xMax: f32=csZBufferSize.x-0.5;var xMin=0.5;var yMax=csZBufferSize.y-0.5;var yMin=0.5;var alpha: f32=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-select(yMin,yMax,(P1.y>yMax)))/(P1.y-P0.y);}\nif ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-select(xMin,xMax,(P1.x>xMax)))/(P1.x-P0.x));}\nP1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);\n#endif\nP1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) { \npermute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }\nvar stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f= vec2f(stepDirection,delta.y*invdx);var dQ: vec3f=(Q1-Q0)*invdx;var dk: f32=(k1-k0)*invdx;var zMin: f32=min(csEndPoint.z,csOrigin.z);var zMax: f32=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;var pqk: vec4f= vec4f(P0,Q0.z,k0);var dPQK: vec4f= vec4f(dP,dQ.z,dk);*startPixel=select(P0.xy,P0.yx,permute);var prevZMaxEstimate: f32=csOrigin.z;var rayZMin: f32=prevZMaxEstimate;var rayZMax=prevZMaxEstimate;var sceneZMax: f32=rayZMax+1e4;var end: f32=P1.x*stepDirection;var hit: bool=false;var stepCount: f32;for (stepCount=0.0;(stepCount<=selfCollisionNumSkip) ||\n((pqk.x*stepDirection)<=end &&\nstepCount<maxSteps &&\n!hit &&\nsceneZMax != 0.0);pqk+=dPQK \n)\n{*hitPixel=select(pqk.xy,pqk.yx,permute);rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { \nvar t: f32=rayZMin; rayZMin=rayZMax; rayZMax=t;}\nsceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nvar sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);\n#else\nhit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);\n#endif\n#else\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nvar sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);\n#else\nhit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);\n#endif\n#endif\nstepCount+=1.0;}\npqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}\n#ifdef SSRAYTRACE_ENABLE_REFINEMENT\nif (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;var invStride: f32=1.0/stride;dPQK*=invStride;var refinementStepCount: f32=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||\n((refinementStepCount<=stride*1.4) &&\n(rayZMax<sceneZMax) && (sceneZMax != 0.0));pqk+=dPQK)\n{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);*hitPixel=select(pqk.xy,pqk.yx,permute);sceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\nrefinementStepCount+=1.0;}\npqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}\n#endif\nQ0=vec3f(Q0.xy+dQ.xy*stepCount,pqk.z);*csHitPoint=Q0/pqk.w;*numIterations=stepCount+1.0;\n#ifdef SSRAYTRACE_DEBUG\nif (((pqk.x+dPQK.x)*stepDirection)>end) {*debugColor= vec3f(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {*debugColor= vec3f(1,0,0);} else if (sceneZMax==0.0) {*debugColor= vec3f(1,1,0);} else {*debugColor= vec3f(0,stepCount/maxSteps,0);}\n#endif\nreturn hit;}\n/**\ntexCoord: in the [0,1] range\ndepth: depth in view space (range [znear,zfar]])\n*/\nfn computeViewPosFromUVDepth(texCoord: vec2f,depth: f32,projection: mat4x4f,invProjectionMatrix: mat4x4f)->vec3f {var xy=texCoord*2.0-1.0;var z: f32;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef ORTHOGRAPHIC_CAMERA\nz=-projection[2].z*depth+projection[3].z;\n#else\nz=-projection[2].z-projection[3].z/depth;\n#endif\n#else\n#ifdef ORTHOGRAPHIC_CAMERA\nz=projection[2].z*depth+projection[3].z;\n#else\nz=projection[2].z+projection[3].z/depth;\n#endif\n#endif\nvar w=1.0;var ndc=vec4f(xy,z,w);var eyePos: vec4f=invProjectionMatrix*ndc;var result=eyePos.xyz/eyePos.w;return result;}\n"},9273:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shadowMapFragmentWGSL:()=>n});const s="shadowMapFragment",r="var depthSM: f32=fragmentInputs.vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\ndepthSM=(fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\nfragmentOutputs.fragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\nfragmentOutputs.fragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,uniforms.biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\nfragmentOutputs.color= vec4f(depthSM,1.0,1.0,1.0);\n#else\nfragmentOutputs.color=pack(depthSM);\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},1311:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shadowMapVertexMetricWGSL:()=>n});const s="shadowMapVertexMetric",r="#if SM_USEDISTANCE==1\nvertexOutputs.vPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.position.z-=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;\n#else\nvertexOutputs.position.z+=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvertexOutputs.zSM=vertexOutputs.position.z;vertexOutputs.position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetricSM=(-vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#else\nvertexOutputs.vDepthMetricSM=(vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},8589:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shadowsFragmentFunctionsWGSL:()=>n});const s="shadowsFragmentFunctions",r="#ifdef SHADOWS\n#ifndef SHADOWFLOAT\nfn unpack(color: vec4f)->f32\n{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}\n#endif\nfn computeFallOff(value: f32,clipSpace: vec2f,frustumEdgeFalloff: f32)->f32\n{var mask: f32=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}\nfn computeShadowCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nvar shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));\n#else\nvar shadow: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;\n#endif\nreturn select(darkness,1.0,depth>shadow);}\nfn computeShadowWithPoissonSamplingCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;var visibility: f32=1.;var poissonDisk: array<vec3f,4>;poissonDisk[0]= vec3f(-1.0,1.0,-1.0);poissonDisk[1]= vec3f(1.0,-1.0,-1.0);poissonDisk[2]= vec3f(-1.0,-1.0,-1.0);poissonDisk[3]= vec3f(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) {visibility-=0.25;};\n#else\nif (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) {visibility-=0.25;};\n#endif\nreturn min(1.0,visibility+darkness);}\nfn computeShadowWithESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));\n#else\nvar shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;\n#endif\nvar esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}\nfn computeShadowWithCloseESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32\n{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));\n#else\nvar shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;\n#endif\nvar esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}\nfn computeShadowCSM(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d_array<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nvar shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,uv,layer));\n#else\nvar shadow: f32=textureSample(shadowTexture,shadowSampler,uv,layer).x;\n#endif\nreturn select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}\nfn computeShadow(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nvar shadow: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));\n#else\nvar shadow: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;\n#endif\nreturn select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}}\nfn computeShadowWithPoissonSampling(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);var visibility: f32=1.;var poissonDisk: array<vec2f,4>;poissonDisk[0]= vec2f(-0.94201624,-0.39906216);poissonDisk[1]= vec2f(0.94558609,-0.76890725);poissonDisk[2]= vec2f(-0.094184101,-0.92938870);poissonDisk[3]= vec2f(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\nif (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}\n#else\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\nif (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));\n#else\nvar shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;\n#endif\nvar esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithCloseESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nvar shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));\n#else\nvar shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;\n#endif\nvar esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\nfn getZInClip(clipSpace: vec3f,uvDepth: vec3f)->f32\n{\n#ifdef IS_NDC_HALF_ZRANGE\nreturn clipSpace.z;\n#else\nreturn uvDepth.z;\n#endif\n}\nconst GREATEST_LESS_THAN_ONE: f32=0.99999994;\n#define DISABLE_UNIFORMITY_ANALYSIS\nfn computeShadowWithCSMPCF1(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var shadow: f32=textureSampleCompare(shadowTexture,shadowSampler,uvDepth.xy,layer,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\nfn computeShadowWithCSMPCF3(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\nfn computeShadowWithCSMPCF5(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),layer,uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),layer,uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),layer,uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),layer,uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\nfn computeShadowWithPCF1(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var shadow: f32=textureSampleCompareLevel(shadowTexture,shadowSampler,uvDepth.xy,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithPCF3(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nfn computeShadowWithPCF5(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvar st: vec2f=fract(uv); \nvar base_uv: vec2f=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvar uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nconst PoissonSamplers32: array<vec3f,64>=array<vec3f,64> (\nvec3f(0.06407013,0.05409927,0.),\nvec3f(0.7366577,0.5789394,0.),\nvec3f(-0.6270542,-0.5320278,0.),\nvec3f(-0.4096107,0.8411095,0.),\nvec3f(0.6849564,-0.4990818,0.),\nvec3f(-0.874181,-0.04579735,0.),\nvec3f(0.9989998,0.0009880066,0.),\nvec3f(-0.004920578,-0.9151649,0.),\nvec3f(0.1805763,0.9747483,0.),\nvec3f(-0.2138451,0.2635818,0.),\nvec3f(0.109845,0.3884785,0.),\nvec3f(0.06876755,-0.3581074,0.),\nvec3f(0.374073,-0.7661266,0.),\nvec3f(0.3079132,-0.1216763,0.),\nvec3f(-0.3794335,-0.8271583,0.),\nvec3f(-0.203878,-0.07715034,0.),\nvec3f(0.5912697,0.1469799,0.),\nvec3f(-0.88069,0.3031784,0.),\nvec3f(0.5040108,0.8283722,0.),\nvec3f(-0.5844124,0.5494877,0.),\nvec3f(0.6017799,-0.1726654,0.),\nvec3f(-0.5554981,0.1559997,0.),\nvec3f(-0.3016369,-0.3900928,0.),\nvec3f(-0.5550632,-0.1723762,0.),\nvec3f(0.925029,0.2995041,0.),\nvec3f(-0.2473137,0.5538505,0.),\nvec3f(0.9183037,-0.2862392,0.),\nvec3f(0.2469421,0.6718712,0.),\nvec3f(0.3916397,-0.4328209,0.),\nvec3f(-0.03576927,-0.6220032,0.),\nvec3f(-0.04661255,0.7995201,0.),\nvec3f(0.4402924,0.3640312,0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.),\nvec3f(0.)\n);const PoissonSamplers64: array<vec3f,64>=array<vec3f,64> (\nvec3f(-0.613392,0.617481,0.),\nvec3f(0.170019,-0.040254,0.),\nvec3f(-0.299417,0.791925,0.),\nvec3f(0.645680,0.493210,0.),\nvec3f(-0.651784,0.717887,0.),\nvec3f(0.421003,0.027070,0.),\nvec3f(-0.817194,-0.271096,0.),\nvec3f(-0.705374,-0.668203,0.),\nvec3f(0.977050,-0.108615,0.),\nvec3f(0.063326,0.142369,0.),\nvec3f(0.203528,0.214331,0.),\nvec3f(-0.667531,0.326090,0.),\nvec3f(-0.098422,-0.295755,0.),\nvec3f(-0.885922,0.215369,0.),\nvec3f(0.566637,0.605213,0.),\nvec3f(0.039766,-0.396100,0.),\nvec3f(0.751946,0.453352,0.),\nvec3f(0.078707,-0.715323,0.),\nvec3f(-0.075838,-0.529344,0.),\nvec3f(0.724479,-0.580798,0.),\nvec3f(0.222999,-0.215125,0.),\nvec3f(-0.467574,-0.405438,0.),\nvec3f(-0.248268,-0.814753,0.),\nvec3f(0.354411,-0.887570,0.),\nvec3f(0.175817,0.382366,0.),\nvec3f(0.487472,-0.063082,0.),\nvec3f(-0.084078,0.898312,0.),\nvec3f(0.488876,-0.783441,0.),\nvec3f(0.470016,0.217933,0.),\nvec3f(-0.696890,-0.549791,0.),\nvec3f(-0.149693,0.605762,0.),\nvec3f(0.034211,0.979980,0.),\nvec3f(0.503098,-0.308878,0.),\nvec3f(-0.016205,-0.872921,0.),\nvec3f(0.385784,-0.393902,0.),\nvec3f(-0.146886,-0.859249,0.),\nvec3f(0.643361,0.164098,0.),\nvec3f(0.634388,-0.049471,0.),\nvec3f(-0.688894,0.007843,0.),\nvec3f(0.464034,-0.188818,0.),\nvec3f(-0.440840,0.137486,0.),\nvec3f(0.364483,0.511704,0.),\nvec3f(0.034028,0.325968,0.),\nvec3f(0.099094,-0.308023,0.),\nvec3f(0.693960,-0.366253,0.),\nvec3f(0.678884,-0.204688,0.),\nvec3f(0.001801,0.780328,0.),\nvec3f(0.145177,-0.898984,0.),\nvec3f(0.062655,-0.611866,0.),\nvec3f(0.315226,-0.604297,0.),\nvec3f(-0.780145,0.486251,0.),\nvec3f(-0.371868,0.882138,0.),\nvec3f(0.200476,0.494430,0.),\nvec3f(-0.494552,-0.711051,0.),\nvec3f(0.612476,0.705252,0.),\nvec3f(-0.578845,-0.768792,0.),\nvec3f(-0.772454,-0.090976,0.),\nvec3f(0.504440,0.372295,0.),\nvec3f(0.155736,0.065157,0.),\nvec3f(0.391522,0.849605,0.),\nvec3f(-0.620106,-0.328104,0.),\nvec3f(0.789239,-0.419965,0.),\nvec3f(-0.545396,0.538133,0.),\nvec3f(-0.178564,-0.596057,0.)\n);fn computeShadowWithCSMPCSS(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uvDepthLayer: vec4f= vec4f(uvDepth.x,uvDepth.y,f32(layer),uvDepth.z);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;for (var i: i32=0; i<searchTapCount; i ++) {blockerDepth=textureSample(depthTexture,depthSampler, uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}\nvar avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);var filterRadius: vec4f= vec4f(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {var offset: vec4f= vec4f(poissonSamplers[i],0.);offset= vec4f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);let coords=uvDepthLayer+offset*filterRadius;shadow+=textureSampleCompare(shadowTexture,shadowSampler,coords.xy,i32(coords.z),coords.w);}\nshadow/= f32(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,numBlocker<1.0);}\nfn computeShadowWithPCSS(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>)->f32\n{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;var exitCondition: bool=depthMetric>1.0 || depthMetric<0.0;for (var i: i32=0; i<searchTapCount; i ++) {if (exitCondition) {break;}\nblockerDepth=textureSampleLevel(depthTexture,depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}\nexitCondition=exitCondition || numBlocker<1.0;var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)+AAOffset);var filterRadius: f32=penumbraRatio*lightSizeUV*shadowMapSizeInverse;var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {if (exitCondition) {break;}\nvar offset: vec3f=poissonSamplers[i];offset= vec3f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);let coords=uvDepth+offset*filterRadius;shadow+=textureSampleCompareLevel(shadowTexture,shadowSampler,coords.xy,coords.z);}\nshadow/= f32(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,exitCondition);}\nfn computeShadowWithPCSS16(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}\nfn computeShadowWithPCSS32(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}\nfn computeShadowWithPCSS64(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}\nfn computeShadowWithCSMPCSS16(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\nfn computeShadowWithCSMPCSS32(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\nfn computeShadowWithCSMPCSS64(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},9456:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shadowsVertexWGSL:()=>n});const s="shadowsVertex",r="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvertexOutputs.vPositionFromCamera{X}=scene.view*worldPos;\n#if SHADOWCSMNUM_CASCADES{X}>0\nvertexOutputs.vPositionFromLight{X}_0=uniforms.lightMatrix{X}[0]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_0=(-vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_0= (vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#if SHADOWCSMNUM_CASCADES{X}>1\nvertexOutputs.vPositionFromLight{X}_1=uniforms.lightMatrix{X}[1]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_1=(-vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_1= (vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif \n#if SHADOWCSMNUM_CASCADES{X}>2\nvertexOutputs.vPositionFromLight{X}_2=uniforms.lightMatrix{X}[2]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_2=(-vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_2= (vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif \n#if SHADOWCSMNUM_CASCADES{X}>3\nvertexOutputs.vPositionFromLight{X}_3=uniforms.lightMatrix{X}[3]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}_3=(-vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}_3= (vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif \n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvertexOutputs.vPositionFromLight{X}=uniforms.lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvertexOutputs.vDepthMetric{X}=(-vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvertexOutputs.vDepthMetric{X}=(vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStoreWGSL[s]=r;const n={name:s,shader:r}},1506:(e,t,i)=>{"use strict";i.r(t),i.d(t,{anaglyphPixelShaderWGSL:()=>n});const s="anaglyphPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var leftSamplerSampler: sampler;var leftSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var leftFrag: vec4f=textureSample(leftSampler,leftSamplerSampler,input.vUV);leftFrag= vec4f(1.0,leftFrag.g,leftFrag.b,1.0);var rightFrag: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);rightFrag= vec4f(rightFrag.r,1.0,1.0,1.0);fragmentOutputs.color= vec4f(rightFrag.rgb*leftFrag.rgb,1.0);}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},5783:(e,t,i)=>{"use strict";i.r(t),i.d(t,{blackAndWhitePixelShaderWGSL:()=>n});const s="blackAndWhitePixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform degree: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var luminance: f32=dot(color, vec3f(0.3,0.59,0.11)); \nvar blackAndWhite: vec3f= vec3f(luminance,luminance,luminance);fragmentOutputs.color= vec4f(color-((color-blackAndWhite)*uniforms.degree),1.0);}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},6645:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bloomMergePixelShaderWGSL:()=>n});const s="bloomMergePixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var bloomBlurSampler: sampler;var bloomBlur: texture_2d<f32>;uniform bloomWeight: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var blurred: vec3f=textureSample(bloomBlur,bloomBlurSampler,input.vUV).rgb;fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb+(blurred.rgb*uniforms.bloomWeight),fragmentOutputs.color.a);}\n";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},9619:(e,t,i)=>{"use strict";i.r(t),i.d(t,{chromaticAberrationPixelShaderWGSL:()=>n});const s="chromaticAberrationPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform chromatic_aberration: f32;uniform radialIntensity: f32;uniform direction: vec2f;uniform centerPosition: vec2f;uniform screen_width: f32;uniform screen_height: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var centered_screen_pos: vec2f= vec2f(input.vUV.x-uniforms.centerPosition.x,input.vUV.y-uniforms.centerPosition.y);var directionOfEffect: vec2f=uniforms.direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}\nvar radius2: f32=centered_screen_pos.x*centered_screen_pos.x\n+ centered_screen_pos.y*centered_screen_pos.y;var radius: f32=sqrt(radius2);var ref_indices: vec3f= vec3f(-0.3,0.0,0.3);var ref_shiftX: f32=uniforms.chromatic_aberration*pow(radius,uniforms.radialIntensity)*directionOfEffect.x/uniforms.screen_width;var ref_shiftY: f32=uniforms.chromatic_aberration*pow(radius,uniforms.radialIntensity)*directionOfEffect.y/uniforms.screen_height;var ref_coords_r: vec2f=vec2f(input.vUV.x+ref_indices.r*ref_shiftX,input.vUV.y+ref_indices.r*ref_shiftY*0.5);var ref_coords_g: vec2f=vec2f(input.vUV.x+ref_indices.g*ref_shiftX,input.vUV.y+ref_indices.g*ref_shiftY*0.5);var ref_coords_b: vec2f=vec2f(input.vUV.x+ref_indices.b*ref_shiftX,input.vUV.y+ref_indices.b*ref_shiftY*0.5);var r=textureSample(textureSampler,textureSamplerSampler,ref_coords_r);var g=textureSample(textureSampler,textureSamplerSampler,ref_coords_g);var b=textureSample(textureSampler,textureSamplerSampler,ref_coords_b);var a=clamp(r.a+g.a+b.a,0.,1.);fragmentOutputs.color=vec4f(r.r,g.g,b.b,a);}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},2217:(e,t,i)=>{"use strict";i.r(t),i.d(t,{circleOfConfusionPixelShaderWGSL:()=>n});const s="circleOfConfusionPixelShader",r="varying vUV: vec2f;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform cameraMinMaxZ: vec2f;uniform focusDistance: f32;uniform cocPrecalculation: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var depth: f32=textureSample(depthSampler,depthSamplerSampler,input.vUV).r;\n#define CUSTOM_COC_DEPTH\nvar pixelDistance: f32=(uniforms.cameraMinMaxZ.x+uniforms.cameraMinMaxZ.y*depth)*1000.0; \n#define CUSTOM_COC_PIXELDISTANCE\nvar coc: f32=abs(uniforms.cocPrecalculation*((uniforms.focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);fragmentOutputs.color= vec4f(coc,coc,coc,1.0);}\n";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},3813:(e,t,i)=>{"use strict";i.r(t),i.d(t,{colorCorrectionPixelShaderWGSL:()=>n});const s="colorCorrectionPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;var colorTableSampler: sampler;var colorTable: texture_2d<f32>;const SLICE_COUNT: f32=16.0; \nfn sampleAs3DTexture(uv: vec3f,width: f32)->vec4f {var sliceSize: f32=1.0/width; \nvar slicePixelSize: f32=sliceSize/width; \nvar sliceInnerSize: f32=slicePixelSize*(width-1.0); \nvar zSlice0: f32=min(floor(uv.z*width),width-1.0);var zSlice1: f32=min(zSlice0+1.0,width-1.0);var xOffset: f32=slicePixelSize*0.5+uv.x*sliceInnerSize;var s0: f32=xOffset+(zSlice0*sliceSize);var s1: f32=xOffset+(zSlice1*sliceSize);var slice0Color: vec4f=textureSample(colorTable,colorTableSampler,vec2f(s0,uv.y));var slice1Color: vec4f=textureSample(colorTable,colorTableSampler,vec2f(s1,uv.y));var zOffset: f32=((uv.z*width)%(1.0));return mix(slice0Color,slice1Color,zOffset);}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var screen_color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);fragmentOutputs.color=sampleAs3DTexture(screen_color.rgb,SLICE_COUNT);}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},2906:(e,t,i)=>{"use strict";i.r(t),i.d(t,{convolutionPixelShaderWGSL:()=>n});const s="convolutionPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform kernel: array<f32,9>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var onePixel: vec2f= vec2f(1.0,1.0)/uniforms.screenSize;var colorSum: vec4f =\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,-1))*uniforms.kernel[0] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,-1))*uniforms.kernel[1] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,-1))*uniforms.kernel[2] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,0))*uniforms.kernel[3] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,0))*uniforms.kernel[4] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,0))*uniforms.kernel[5] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,1))*uniforms.kernel[6] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,1))*uniforms.kernel[7] +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,1))*uniforms.kernel[8];var kernelWeight: f32 =\nuniforms.kernel[0] +\nuniforms.kernel[1] +\nuniforms.kernel[2] +\nuniforms.kernel[3] +\nuniforms.kernel[4] +\nuniforms.kernel[5] +\nuniforms.kernel[6] +\nuniforms.kernel[7] +\nuniforms.kernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}\nfragmentOutputs.color= vec4f((colorSum/kernelWeight).rgb,1);}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},9480:(e,t,i)=>{"use strict";i.r(t),i.d(t,{depthOfFieldMergePixelShaderWGSL:()=>n});const s="depthOfFieldMergePixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;var blurStep0Sampler: sampler;var blurStep0: texture_2d<f32>;\n#if BLUR_LEVEL>0\nvar blurStep1Sampler: sampler;var blurStep1: texture_2d<f32>;\n#endif\n#if BLUR_LEVEL>1\nvar blurStep2Sampler: sampler;var blurStep2: texture_2d<f32>;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var coc: f32=textureSampleLevel(circleOfConfusionSampler,circleOfConfusionSamplerSampler,input.vUV,0.0).r;\n#if BLUR_LEVEL==0\nvar original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL==1\nif(coc<0.5){var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred1,coc/0.5);}else{var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred1,blurred0,(coc-0.5)/0.5);}\n#endif\n#if BLUR_LEVEL==2\nif(coc<0.33){var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred2: vec4f=textureSampleLevel(blurStep2,blurStep2Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred2,coc/0.33);}else if(coc<0.66){var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);var blurred2: vec4f=textureSampleLevel(blurStep2,blurStep2Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred1,blurred0,(coc-0.66)/0.34);}\n#endif\n}\n";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},4069:(e,t,i)=>{"use strict";i.r(t),i.d(t,{displayPassPixelShaderWGSL:()=>n});const s="displayPassPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var passSamplerSampler: sampler;var passSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(passSampler,passSamplerSampler,input.vUV);}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},5516:(e,t,i)=>{"use strict";i.r(t),i.d(t,{extractHighlightsPixelShaderWGSL:()=>a});var s=i(9610);i(9702);const r="extractHighlightsPixelShader",n="#include<helperFunctions>\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform threshold: f32;uniform exposure: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var luma: f32=dot(LuminanceEncodeApprox,fragmentOutputs.color.rgb*uniforms.exposure);fragmentOutputs.color=vec4f(step(uniforms.threshold,luma)*fragmentOutputs.color.rgb,fragmentOutputs.color.a);}";s.l.ShadersStoreWGSL[r]=n;const a={name:r,shader:n}},7912:(e,t,i)=>{"use strict";i.r(t),i.d(t,{filterPixelShaderWGSL:()=>n});const s="filterPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform kernelMatrix: mat4x4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var baseColor: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var updatedColor: vec3f=(uniforms.kernelMatrix* vec4f(baseColor,1.0)).rgb;fragmentOutputs.color= vec4f(updatedColor,1.0);}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},2578:(e,t,i)=>{"use strict";i.r(t),i.d(t,{fxaaPixelShaderWGSL:()=>n});const s="fxaaPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform texelSize: vec2f;varying sampleCoordS: vec2f;varying sampleCoordE: vec2f;varying sampleCoordN: vec2f;varying sampleCoordW: vec2f;varying sampleCoordNW: vec2f;varying sampleCoordSE: vec2f;varying sampleCoordNE: vec2f;varying sampleCoordSW: vec2f;const fxaaQualitySubpix: f32=1.0;const fxaaQualityEdgeThreshold: f32=0.166;const fxaaQualityEdgeThresholdMin: f32=0.0833;const kLumaCoefficients: vec3f= vec3f(0.2126,0.7152,0.0722);fn FxaaLuma(rgba: vec4f)->f32 {return dot(rgba.rgb,kLumaCoefficients);} \n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var posM: vec2f;posM.x=input.vUV.x;posM.y=input.vUV.y;var rgbyM: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var lumaM: f32=FxaaLuma(rgbyM);var lumaS: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordS,0.0));var lumaE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordE,0.0));var lumaN: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordN,0.0));var lumaW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordW,0.0));var maxSM: f32=max(lumaS,lumaM);var minSM: f32=min(lumaS,lumaM);var maxESM: f32=max(lumaE,maxSM);var minESM: f32=min(lumaE,minSM);var maxWN: f32=max(lumaN,lumaW);var minWN: f32=min(lumaN,lumaW);var rangeMax: f32=max(maxWN,maxESM);var rangeMin: f32=min(minWN,minESM);var rangeMaxScaled: f32=rangeMax*fxaaQualityEdgeThreshold;var range: f32=rangeMax-rangeMin;var rangeMaxClamped: f32=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{fragmentOutputs.color=rgbyM;return fragmentOutputs;}\n#endif\nvar lumaNW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordNW,0.0));var lumaSE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordSE,0.0));var lumaNE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordNE,0.0));var lumaSW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordSW,0.0));var lumaNS: f32=lumaN+lumaS;var lumaWE: f32=lumaW+lumaE;var subpixRcpRange: f32=1.0/range;var subpixNSWE: f32=lumaNS+lumaWE;var edgeHorz1: f32=(-2.0*lumaM)+lumaNS;var edgeVert1: f32=(-2.0*lumaM)+lumaWE;var lumaNESE: f32=lumaNE+lumaSE;var lumaNWNE: f32=lumaNW+lumaNE;var edgeHorz2: f32=(-2.0*lumaE)+lumaNESE;var edgeVert2: f32=(-2.0*lumaN)+lumaNWNE;var lumaNWSW: f32=lumaNW+lumaSW;var lumaSWSE: f32=lumaSW+lumaSE;var edgeHorz4: f32=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);var edgeVert4: f32=(abs(edgeVert1)*2.0)+abs(edgeVert2);var edgeHorz3: f32=(-2.0*lumaW)+lumaNWSW;var edgeVert3: f32=(-2.0*lumaS)+lumaSWSE;var edgeHorz: f32=abs(edgeHorz3)+edgeHorz4;var edgeVert: f32=abs(edgeVert3)+edgeVert4;var subpixNWSWNESE: f32=lumaNWSW+lumaNESE;var lengthSign: f32=uniforms.texelSize.x;var horzSpan: bool=edgeHorz>=edgeVert;var subpixA: f32=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)\n{lumaN=lumaW;}\nif (!horzSpan) \n{lumaS=lumaE;}\nif (horzSpan) \n{lengthSign=uniforms.texelSize.y;}\nvar subpixB: f32=(subpixA*(1.0/12.0))-lumaM;var gradientN: f32=lumaN-lumaM;var gradientS: f32=lumaS-lumaM;var lumaNN: f32=lumaN+lumaM;var lumaSS: f32=lumaS+lumaM;var pairN: bool=abs(gradientN)>=abs(gradientS);var gradient: f32=max(abs(gradientN),abs(gradientS));if (pairN)\n{lengthSign=-lengthSign;}\nvar subpixC: f32=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);var posB: vec2f;posB.x=posM.x;posB.y=posM.y;var offNP: vec2f;offNP.x=select(uniforms.texelSize.x,0.0,(!horzSpan));offNP.y=select(uniforms.texelSize.y,0.0,(horzSpan));if (!horzSpan) \n{posB.x+=lengthSign*0.5;}\nif (horzSpan)\n{posB.y+=lengthSign*0.5;}\nvar posN: vec2f;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;var posP: vec2f;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;var subpixD: f32=((-2.0)*subpixC)+3.0;var lumaEndN: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posN,0.0));var subpixE: f32=subpixC*subpixC;var lumaEndP: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posP,0.0));if (!pairN) \n{lumaNN=lumaSS;}\nvar gradientScaled: f32=gradient*1.0/4.0;var lumaMM: f32=lumaM-lumaNN*0.5;var subpixF: f32=subpixD*subpixE;var lumaMLTZero: bool=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;var doneN: bool=abs(lumaEndN)>=gradientScaled;var doneP: bool=abs(lumaEndP)>=gradientScaled;if (!doneN) \n{posN.x-=offNP.x*3.0;}\nif (!doneN) \n{posN.y-=offNP.y*3.0;}\nvar doneNP: bool=(!doneN) || (!doneP);if (!doneP) \n{posP.x+=offNP.x*3.0;}\nif (!doneP)\n{posP.y+=offNP.y*3.0;}\nif (doneNP)\n{if (!doneN) {lumaEndN=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posN.xy,0.0));}\nif (!doneP) {lumaEndP=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posP.xy,0.0));}\nif (!doneN) {lumaEndN=lumaEndN-lumaNN*0.5;}\nif (!doneP) {lumaEndP=lumaEndP-lumaNN*0.5;}\ndoneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) {posN.x-=offNP.x*12.0;}\nif (!doneN) {posN.y-=offNP.y*12.0;}\ndoneNP=(!doneN) || (!doneP);if (!doneP) {posP.x+=offNP.x*12.0;}\nif (!doneP) {posP.y+=offNP.y*12.0;}}\nvar dstN: f32=posM.x-posN.x;var dstP: f32=posP.x-posM.x;if (!horzSpan)\n{dstN=posM.y-posN.y;}\nif (!horzSpan) \n{dstP=posP.y-posM.y;}\nvar goodSpanN: bool=(lumaEndN<0.0) != lumaMLTZero;var spanLength: f32=(dstP+dstN);var goodSpanP: bool=(lumaEndP<0.0) != lumaMLTZero;var spanLengthRcp: f32=1.0/spanLength;var directionN: bool=dstN<dstP;var dst: f32=min(dstN,dstP);var goodSpan: bool=select(goodSpanP,goodSpanN,directionN);var subpixG: f32=subpixF*subpixF;var pixelOffset: f32=(dst*(-spanLengthRcp))+0.5;var subpixH: f32=subpixG*fxaaQualitySubpix;var pixelOffsetGood: f32=select(0.0,pixelOffset,goodSpan);var pixelOffsetSubpix: f32=max(pixelOffsetGood,subpixH);if (!horzSpan)\n{posM.x+=pixelOffsetSubpix*lengthSign;}\nif (horzSpan)\n{posM.y+=pixelOffsetSubpix*lengthSign;}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{fragmentOutputs.color=rgbyM;}\nelse\n{fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,posM,0.0);}\n#else\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,posM,0.0);\n#endif\n}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},3208:(e,t,i)=>{"use strict";i.r(t),i.d(t,{fxaaVertexShaderWGSL:()=>n});const s="fxaaVertexShader",r="attribute position: vec2f;uniform texelSize: vec2f;varying vUV: vec2f;varying sampleCoordS: vec2f;varying sampleCoordE: vec2f;varying sampleCoordN: vec2f;varying sampleCoordW: vec2f;varying sampleCoordNW: vec2f;varying sampleCoordSE: vec2f;varying sampleCoordNE: vec2f;varying sampleCoordSW: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=(input.position*madd+madd);vertexOutputs.sampleCoordS=vertexOutputs.vUV+ vec2f( 0.0,1.0)*uniforms.texelSize;vertexOutputs.sampleCoordE=vertexOutputs.vUV+ vec2f( 1.0,0.0)*uniforms.texelSize;vertexOutputs.sampleCoordN=vertexOutputs.vUV+ vec2f( 0.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordW=vertexOutputs.vUV+ vec2f(-1.0,0.0)*uniforms.texelSize;vertexOutputs.sampleCoordNW=vertexOutputs.vUV+ vec2f(-1.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordSE=vertexOutputs.vUV+ vec2f( 1.0,1.0)*uniforms.texelSize;vertexOutputs.sampleCoordNE=vertexOutputs.vUV+ vec2f( 1.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordSW=vertexOutputs.vUV+ vec2f(-1.0,1.0)*uniforms.texelSize;vertexOutputs.position=vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},2937:(e,t,i)=>{"use strict";i.r(t),i.d(t,{glowBlurPostProcessPixelShaderWGSL:()=>n});const s="glowBlurPostProcessPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform direction: vec2f;uniform blurWidth: f32;fn getLuminance(color: vec3f)->f32\n{return dot(color, vec3f(0.2126,0.7152,0.0722));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var weights: array<f32 ,7>;weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;var texelSize: vec2f= vec2f(1.0/uniforms.screenSize.x,1.0/uniforms.screenSize.y);var texelStep: vec2f=texelSize*uniforms.direction*uniforms.blurWidth;var start: vec2f=input.vUV-3.0*texelStep;var baseColor: vec4f= vec4f(0.,0.,0.,0.);var texelOffset: vec2f= vec2f(0.,0.);for (var i: i32=0; i<7; i++)\n{var texel: vec4f=textureSample(textureSampler,textureSamplerSampler,start+texelOffset);baseColor=vec4f(baseColor.rgb,baseColor.a+texel.a*weights[i]);var luminance: f32=getLuminance(baseColor.rgb);var luminanceTexel: f32=getLuminance(texel.rgb);var choice: f32=step(luminanceTexel,luminance);baseColor=vec4f(choice*baseColor.rgb+(1.0-choice)*texel.rgb,baseColor.a);texelOffset+=texelStep;}\nfragmentOutputs.color=baseColor;}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},9073:(e,t,i)=>{"use strict";i.r(t),i.d(t,{glowMapGenerationPixelShaderWGSL:()=>a});var s=i(9610);i(9702),i(9759),i(7715);const r="glowMapGenerationPixelShader",n="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vUVDiffuse: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#ifdef OPACITY\nvarying vUVOpacity: vec2f;var opacitySamplerSampler: sampler;var opacitySampler: texture_2d<f32>;uniform var opacityIntensity: f32;\n#endif\n#ifdef EMISSIVE\nvarying vUVEmissive: vec2f;var emissiveSamplerSampler: sampler;var emissiveSampler: texture_2d<f32>;\n#endif\n#ifdef VERTEXALPHA\nvarying vColor: vec4f;\n#endif\nuniform glowColor: vec4f;uniform glowIntensity: f32;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#include<clipPlaneFragment>\nvar finalColor: vec4f=uniforms.glowColor;\n#ifdef DIFFUSE\nvar albedoTexture: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor=vec4f(finalColor.rgb,finalColor.a*albedoTexture.a);\n#endif\n#ifdef HIGHLIGHT\nfinalColor=vec4f(finalColor.rgb,albedoTexture.a);\n#endif\n#endif\n#ifdef OPACITY\nvar opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor=vec4f(finalColor.rgb,finalColor.a*getLuminance(opacityMap.rgb));\n#else\nfinalColor=vec4f(finalColor.rgb,finalColor.a*opacityMap.a);\n#endif\nfinalColor=vec4f(finalColor.rgb,finalColor.a*opacityIntensity);\n#endif\n#ifdef VERTEXALPHA\nfinalColor=vec4f(finalColor.rgb,finalColor.a*vColor.a);\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifdef EMISSIVE\nvar emissive: vec4f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\nfragmentOutputs.color=emissive*finalColor*uniforms.glowIntensity;\n#else\nfragmentOutputs.color=finalColor*uniforms.glowIntensity;\n#endif\n#ifdef HIGHLIGHT\nfragmentOutputs.color=vec4f(fragmentOutputs.color.rgb,uniforms.glowColor.a);\n#endif\n}";s.l.ShadersStoreWGSL[r]=n;const a={name:r,shader:n}},8267:(e,t,i)=>{"use strict";i.r(t),i.d(t,{glowMapGenerationVertexShaderWGSL:()=>a});var s=i(9610);i(2806),i(8900),i(6340),i(8217),i(7029),i(4559),i(8258),i(9129),i(1277),i(5470),i(242),i(5197);const r="glowMapGenerationVertexShader",n="attribute position: vec3f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform viewProjection: mat4x4f;varying vPosition: vec4f;\n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#ifdef DIFFUSE\nvarying vUVDiffuse: vec2f;uniform diffuseMatrix: mat4x4f;\n#endif\n#ifdef OPACITY\nvarying vUVOpacity: vec2f;uniform opacityMatrix: mat4x4f;\n#endif\n#ifdef EMISSIVE\nvarying vUVEmissive: vec2f;uniform emissiveMatrix: mat4x4f;\n#endif\n#ifdef VERTEXALPHA\nattribute color: vec4f;varying vColor: vec4f;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;\n#ifdef UV1\nvar uvUpdated: vec2f=input.uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);\n#ifdef CUBEMAP\nvertexOutputs.vPosition=worldPos;vertexOutputs.position=uniforms.viewProjection*finalWorld* vec4f(input.position,1.0);\n#else\nvertexOutputs.vPosition=uniforms.viewProjection*worldPos;vertexOutputs.position=vertexOutputs.vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef DIFFUSEUV2\nvertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef OPACITYUV2\nvertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef EMISSIVEUV2\nvertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(input.uv2,1.0,0.0)).xy;\n#endif\n#endif\n#ifdef VERTEXALPHA\nvertexOutputs.vColor=color;\n#endif\n#include<clipPlaneVertex>\n}";s.l.ShadersStoreWGSL[r]=n;const a={name:r,shader:n}},2147:(e,t,i)=>{"use strict";i.r(t),i.d(t,{glowMapMergePixelShaderWGSL:()=>n});const s="glowMapMergePixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#ifdef EMISSIVE\nvar textureSampler2Sampler: sampler;var textureSampler2: texture_2d<f32>;\n#endif\nuniform offset: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#ifdef EMISSIVE\nbaseColor+=textureSample(textureSampler2,textureSampler2Sampler,input.vUV);baseColor*=uniforms.offset;\n#else\nbaseColor=vec4f(baseColor.rgb,abs(uniforms.offset-baseColor.a));\n#ifdef STROKE\nvar alpha: f32=smoothstep(.0,.1,baseColor.a);baseColor=vec4f(baseColor.rgb*alpha,alpha);\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,0.,1.0);\n#endif\nfragmentOutputs.color=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},7101:(e,t,i)=>{"use strict";i.r(t),i.d(t,{glowMapMergeVertexShaderWGSL:()=>n});const s="glowMapMergeVertexShader",r="attribute position: vec2f;varying vUV: vec2f;\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},8625:(e,t,i)=>{"use strict";i.r(t),i.d(t,{grainPixelShaderWGSL:()=>a});var s=i(9610);i(9702);const r="grainPixelShader",n="#include<helperFunctions>\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform intensity: f32;uniform animatedSeed: f32;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var seed: vec2f=input.vUV*uniforms.animatedSeed;var grain: f32=dither(seed,uniforms.intensity);var lum: f32=getLuminance(fragmentOutputs.color.rgb);var grainAmount: f32=(cos(-PI+(lum*PI*2.))+1.)/2.;fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb+grain*grainAmount,fragmentOutputs.color.a);fragmentOutputs.color=vec4f(max(fragmentOutputs.color.rgb,vec3f(0.0)),fragmentOutputs.color.a);}";s.l.ShadersStoreWGSL[r]=n;const a={name:r,shader:n}},265:(e,t,i)=>{"use strict";i.r(t),i.d(t,{highlightsPixelShaderWGSL:()=>n});const s="highlightsPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;const RGBLuminanceCoefficients: vec3f= vec3f(0.2126,0.7152,0.0722);\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var tex: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var c: vec3f=tex.rgb;var luma: f32=dot(c.rgb,RGBLuminanceCoefficients);fragmentOutputs.color= vec4f(pow(c, vec3f(25.0-luma*15.0)),tex.a); }";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},7614:(e,t,i)=>{"use strict";i.r(t),i.d(t,{imageProcessingPixelShaderWGSL:()=>a});var s=i(9610);i(6205),i(9702),i(8996);const r="imageProcessingPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var result: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult=vec4f(toLinearSpaceVec3(result.rgb),result.a);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\nfragmentOutputs.color=result;}";s.l.ShadersStoreWGSL[r]=n;const a={name:r,shader:n}},2850:(e,t,i)=>{"use strict";i.r(t),i.d(t,{kernelBlurPixelShaderWGSL:()=>a});var s=i(9610);i(2383),i(5543);s.l.IncludesShadersStoreWGSL.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(fragmentInputs.sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X}))*computedWeight;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X})*computedWeight;\n#endif\n";s.l.IncludesShadersStoreWGSL.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";const r="kernelBlurPixelShader",n="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform delta: vec2f;varying sampleCenter: vec2f;\n#ifdef DOF\nvar circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;fn sampleCoC(offset: vec2f)->f32 {var coc: f32=textureSample(circleOfConfusionSampler,circleOfConfusionSamplerSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var computedWeight: f32=0.0;\n#ifdef PACKEDFLOAT\nvar blend: f32=0.;\n#else\nvar blend: vec4f= vec4f(0.);\n#endif\n#ifdef DOF\nvar sumOfWeights: f32=CENTER_WEIGHT; \nvar factor: f32=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(textureSample(textureSampler,textureSamplerSampler,input.sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=textureSample(textureSampler,textureSamplerSampler,input.sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\nfragmentOutputs.color=pack(blend);\n#else\nfragmentOutputs.color=blend;\n#endif\n#ifdef DOF\nfragmentOutputs.color/=sumOfWeights;\n#endif\n}";s.l.ShadersStoreWGSL[r]=n;const a={name:r,shader:n}},5417:(e,t,i)=>{"use strict";i.r(t),i.d(t,{kernelBlurVertexShaderWGSL:()=>a});var s=i(9610);i(2383);s.l.IncludesShadersStoreWGSL.kernelBlurVertex="vertexOutputs.sampleCoord{X}=vertexOutputs.sampleCenter+uniforms.delta*KERNEL_OFFSET{X};";const r="kernelBlurVertexShader",n="attribute position: vec2f;uniform delta: vec2f;varying sampleCenter: vec2f;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.sampleCenter=(input.position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\nvertexOutputs.position= vec4f(input.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";s.l.ShadersStoreWGSL[r]=n;const a={name:r,shader:n}},711:(e,t,i)=>{"use strict";i.r(t),i.d(t,{layerPixelShaderWGSL:()=>a});var s=i(9610);i(9702);const r="layerPixelShader",n="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform color: vec4f;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#ifdef LINEAR\nbaseColor=vec4f(toGammaSpace(baseColor.rgb),baseColor.a);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\nfragmentOutputs.color=baseColor*uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";s.l.ShadersStoreWGSL[r]=n;const a={name:r,shader:n}},6913:(e,t,i)=>{"use strict";i.r(t),i.d(t,{layerVertexShaderWGSL:()=>n});const s="layerVertexShader",r="attribute position: vec2f;uniform scale: vec2f;uniform offset: vec2f;uniform textureMatrix: mat4x4f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvar shiftedPosition: vec2f=input.position*uniforms.scale+uniforms.offset;vertexOutputs.vUV=(uniforms.textureMatrix* vec4f(shiftedPosition*madd+madd,1.0,0.0)).xy;vertexOutputs.position= vec4f(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},8075:(e,t,i)=>{"use strict";i.r(t),i.d(t,{motionBlurPixelShaderWGSL:()=>n});const s="motionBlurPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform motionStrength: f32;uniform motionScale: f32;uniform screenSize: vec2f;\n#ifdef OBJECT_BASED\nvar velocitySamplerSampler: sampler;var velocitySampler: texture_2d<f32>;\n#else\nvar depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform inverseViewProjection: mat4x4f;uniform prevViewProjection: mat4x4f;uniform projection: mat4x4f;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#ifdef GEOMETRY_SUPPORTED\n#ifdef OBJECT_BASED\nvar texelSize: vec2f=1.0/uniforms.screenSize;var velocityColor: vec4f=textureSample(velocitySampler,velocitySamplerSampler,input.vUV);velocityColor=vec4f(velocityColor.rg*2.0- vec2f(1.0),velocityColor.b,velocityColor.a);var velocity: vec2f= vec2f(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=uniforms.motionScale*uniforms.motionStrength;var speed: f32=length(velocity/texelSize);var samplesCount: i32= i32(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;var hlim: f32= f32(-samplesCount)*0.5+0.5;var result: vec4f=textureSample(textureSampler,textureSamplerSampler, input.vUV);for (var i: i32=1; i< i32(SAMPLES); i++)\n{if (i>=samplesCount) {break;}\nvar offset: vec2f=input.vUV+velocity*(hlim+ f32(i));\n#if defined(WEBGPU)\nresult+=textureSampleLevel(textureSampler,textureSamplerSampler, offset,0.0);\n#else\nresult+=textureSample(textureSampler,textureSamplerSampler, offset);\n#endif\n}\nfragmentOutputs.color=vec4f(result.rgb/ f32(samplesCount),1.0);\n#else\nvar texelSize: vec2f=1.0/uniforms.screenSize;var depth: f32=textureSample(depthSampler,depthSamplerSampler,input.vUV).r;depth=uniforms.projection[2].z+uniforms.projection[3].z/depth; \nvar cpos: vec4f= vec4f(input.vUV*2.0-1.0,depth,1.0);cpos=uniforms.inverseViewProjection*cpos;cpos/=cpos.w;var ppos: vec4f=uniforms.prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;var velocity: vec2f=(ppos.xy-input.vUV)*uniforms.motionScale*uniforms.motionStrength;var speed: f32=length(velocity/texelSize);var nSamples: i32= i32(clamp(speed,1.0,SAMPLES));var result: vec4f=textureSample(textureSampler,textureSamplerSampler, input.vUV);for (var i: i32=1; i< i32(SAMPLES); i++) {if (i>=nSamples) {break;}\nvar offset1: vec2f=input.vUV+velocity*( f32(i)/ f32(nSamples-1)-0.5);\n#if defined(WEBGPU)\nresult+=textureSampleLevel(textureSampler,textureSamplerSampler, offset1,0.0);\n#else\nresult+=textureSample(textureSampler,textureSamplerSampler, offset1);\n#endif\n}\nfragmentOutputs.color=result/ f32(nSamples);\n#endif\n#else\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler, input.vUV);\n#endif\n}\n";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},9965:(e,t,i)=>{"use strict";i.r(t),i.d(t,{passPixelShaderWGSL:()=>n});const s="passPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},7682:(e,t,i)=>{"use strict";i.r(t),i.d(t,{passCubePixelShaderWGSL:()=>n});const s="passCubePixelShader",r="varying var vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f=input.vUV*2.0-1.0;\n#ifdef POSITIVEX\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,-1.001));\n#endif\n}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},2083:(e,t,i)=>{"use strict";i.r(t),i.d(t,{postprocessVertexShaderWGSL:()=>n});const s="postprocessVertexShader",r="attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input : VertexInputs)->FragmentInputs {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}\n";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},5423:(e,t,i)=>{"use strict";i.r(t),i.d(t,{screenSpaceReflection2PixelShaderWGSL:()=>a});var s=i(9610);i(9702),i(5052),i(5228);const r="screenSpaceReflection2PixelShader",n="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;\n#ifdef SSR_SUPPORTED\nvar reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;var normalSampler: texture_2d<f32>;var depthSampler: texture_2d<f32>;\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nvar backDepthSampler: texture_2d<f32>;uniform backSizeFactor: f32;\n#endif\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvar envCubeSamplerSampler: sampler;var envCubeSampler: texture_cube<f32>;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nuniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;\n#endif\n#endif\nuniform view: mat4x4f;uniform invView: mat4x4f;uniform projection: mat4x4f;uniform invProjectionMatrix: mat4x4f;uniform projectionPixel: mat4x4f;uniform nearPlaneZ: f32;uniform farPlaneZ: f32;uniform stepSize: f32;uniform maxSteps: f32;uniform strength: f32;uniform thickness: f32;uniform roughnessFactor: f32;uniform reflectionSpecularFalloffExponent: f32;uniform maxDistance: f32;uniform selfCollisionNumSkip: f32;uniform reflectivityThreshold: f32;\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nfn hash(a: vec3f)->vec3f\n{var result=fract(a*0.8);result+=dot(result,result.yxz+19.19);return fract((result.xxy+result.yxx)*result.zyx);}\nfn computeAttenuationForIntersection(ihitPixel: vec2f,hitUV: vec2f,vsRayOrigin: vec3f,vsHitPoint: vec3f,reflectionVector: vec3f,maxRayDistance: f32,numIterations: f32)->f32 {var attenuation: f32=1.0;\n#ifdef SSR_ATTENUATE_SCREEN_BORDERS\nvar dCoords: vec2f=smoothstep(vec2f(0.2),vec2f(0.6),abs( vec2f(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS\nattenuation*=1.0-(numIterations/uniforms.maxSteps);\n#endif\n#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION\nvar reflectionNormal: vec3f=texelFetch(normalSampler,hitPixel,0).xyz;var directionBasedAttenuation: f32=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;\n#endif\nreturn attenuation;}\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#ifdef SSR_SUPPORTED\nvar colorFull: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var color: vec3f=colorFull.rgb;var reflectivity: vec4f=textureSampleLevel(reflectivitySampler,reflectivitySamplerSampler,input.vUV,0.0);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=uniforms.reflectivityThreshold) {\n#ifdef SSR_USE_BLUR\nfragmentOutputs.color= vec4f(0.);\n#else\nfragmentOutputs.color=colorFull;\n#endif\nreturn fragmentOutputs;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpaceVec3(color);\n#endif\nvar texSize: vec2f= vec2f(textureDimensions(depthSampler,0));var csNormal: vec3f=textureLoad(normalSampler,vec2<i32>(input.vUV*texSize),0).xyz; \n#ifdef SSR_DECODE_NORMAL\ncsNormal=csNormal*2.0-1.0;\n#endif\n#ifdef SSR_NORMAL_IS_IN_WORLDSPACE\ncsNormal=(uniforms.view* vec4f(csNormal,0.0)).xyz;\n#endif\nvar depth: f32=textureLoad(depthSampler,vec2<i32>(input.vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,uniforms.nearPlaneZ,uniforms.farPlaneZ);\n#endif\nvar csPosition: vec3f=computeViewPosFromUVDepth(input.vUV,depth,uniforms.projection,uniforms.invProjectionMatrix);\n#ifdef ORTHOGRAPHIC_CAMERA\nvar csViewDirection: vec3f= vec3f(0.,0.,1.);\n#else\nvar csViewDirection: vec3f=normalize(csPosition);\n#endif\nvar csReflectedVector: vec3f=reflect(csViewDirection,csNormal);\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvar wReflectedVector: vec3f=(uniforms.invView* vec4f(csReflectedVector,0.0)).xyz;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nvar worldPos: vec4f=uniforms.invView* vec4f(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),uniforms.vReflectionSize,uniforms.vReflectionPosition);\n#endif\n#ifdef SSR_INVERTCUBICMAP\nwReflectedVector.y*=-1.0;\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nwReflectedVector.z*=-1.0;\n#endif\nvar envColor: vec3f=textureSampleLevel(envCubeSampler,envCubeSamplerSampler,wReflectedVector,0.0).xyz;\n#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE\nenvColor=toLinearSpaceVec3(envColor);\n#endif\n#else\nvar envColor: vec3f=color;\n#endif\nvar reflectionAttenuation: f32=1.0;var rayHasHit: bool=false;var startPixel: vec2f;var hitPixel: vec2f;var hitPoint: vec3f;var numIterations: f32;\n#ifdef SSRAYTRACE_DEBUG\nvar debugColor: vec3f;\n#endif\n#ifdef SSR_ATTENUATE_FACING_CAMERA\nreflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));\n#endif\nif (reflectionAttenuation>0.0) {\n#ifdef SSR_USE_BLUR\nvar jitt: vec3f= vec3f(0.);\n#else\nvar roughness: f32=1.0-reflectivity.a;var jitt: vec3f=mix( vec3f(0.0),hash(csPosition)- vec3f(0.5),roughness)*uniforms.roughnessFactor; \n#endif\nvar uv2: vec2f=input.vUV*texSize;var c: f32=(uv2.x+uv2.y)*0.25;var jitter: f32=((c)%(1.0)); \nrayHasHit=traceScreenSpaceRay1(\ncsPosition,\nnormalize(csReflectedVector+jitt),\nuniforms.projectionPixel,\ndepthSampler,\ntexSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nbackDepthSampler,\nuniforms.backSizeFactor,\n#endif\nuniforms.thickness,\nuniforms.nearPlaneZ,\nuniforms.farPlaneZ,\nuniforms.stepSize,\njitter,\nuniforms.maxSteps,\nuniforms.maxDistance,\nuniforms.selfCollisionNumSkip,\n&startPixel,\n&hitPixel,\n&hitPoint,\n&numIterations\n#ifdef SSRAYTRACE_DEBUG\n,&debugColor\n#endif\n);}\n#ifdef SSRAYTRACE_DEBUG\nfragmentOutputs.color= vec4f(debugColor,1.);return fragmentOutputs;\n#endif\nvar F0: vec3f=reflectivity.rgb;var fresnel: vec3f=fresnelSchlickGGXVec3(max(dot(csNormal,-csViewDirection),0.0),F0, vec3f(1.));var SSR: vec3f=envColor;if (rayHasHit) {var reflectedColor: vec3f=textureLoad(textureSampler,vec2<i32>(hitPixel),0).rgb;\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\nreflectedColor=toLinearSpaceVec3(reflectedColor);\n#endif\nreflectionAttenuation*=computeAttenuationForIntersection(hitPixel,hitPixel/texSize,csPosition,hitPoint,csReflectedVector,uniforms.maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}\n#ifndef SSR_BLEND_WITH_FRESNEL\nSSR*=fresnel;\n#endif\n#ifdef SSR_USE_BLUR\nvar blur_radius: f32=0.0;var roughness: f32=1.0-reflectivity.a*(1.0-uniforms.roughnessFactor);if (roughness>0.001) {var cone_angle: f32=min(roughness,0.999)*3.14159265*0.5;var cone_len: f32=distance(startPixel,hitPixel);var op_len: f32=2.0*tan(cone_angle)*cone_len; \nvar a: f32=op_len;var h: f32=cone_len;var a2: f32=a*a;var fh2: f32=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}\nfragmentOutputs.color= vec4f(SSR,blur_radius/255.0); \n#else\n#ifdef SSR_BLEND_WITH_FRESNEL\nvar reflectionMultiplier: vec3f=clamp(pow(fresnel*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#else\nvar reflectionMultiplier: vec3f=clamp(pow(reflectivity.rgb*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#endif\nvar colorMultiplier: vec3f=1.0-reflectionMultiplier;var finalColor: vec3f=(color*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpaceVec3(finalColor);\n#endif\nfragmentOutputs.color= vec4f(finalColor,colorFull.a);\n#endif\n#else\nfragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);\n#endif\n}\n";s.l.ShadersStoreWGSL[r]=n;const a={name:r,shader:n}},6584:(e,t,i)=>{"use strict";i.r(t),i.d(t,{screenSpaceReflection2BlurPixelShaderWGSL:()=>n});const s="screenSpaceReflection2BlurPixelShader",r="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;uniform texelOffsetScale: vec2f;const weights: array<f32,8>=array<f32,8>(0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);fn processSample(uv: vec2f,i: f32,stepSize: vec2f,accumulator: ptr<function,vec4f>,denominator: ptr<function,f32>)\n{var offsetUV: vec2f=stepSize*i+uv;var coefficient: f32=weights[ i32(2.0-abs(i))];*accumulator+=textureSampleLevel(textureSampler,textureSamplerSampler,offsetUV,0.0)*coefficient;*denominator+=coefficient;}\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var colorFull: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);if (dot(colorFull, vec4f(1.0))==0.0) {fragmentOutputs.color=colorFull;return fragmentOutputs;}\nvar blurRadius: f32=colorFull.a*255.0; \nvar stepSize: vec2f=uniforms.texelOffsetScale.xy*blurRadius;var accumulator: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0)*0.214607;var denominator: f32=0.214607;processSample(input.vUV,1.0,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.2,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.4,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.6,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.8,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.2,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.4,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.6,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.8,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*2.0,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.2,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.4,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.6,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.8,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.2,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.4,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.6,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.8,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*2.0,stepSize,&accumulator,&denominator);fragmentOutputs.color= vec4f(accumulator.rgb/denominator,colorFull.a);}\n";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},4143:(e,t,i)=>{"use strict";i.r(t),i.d(t,{screenSpaceReflection2BlurCombinerPixelShaderWGSL:()=>a});var s=i(9610);i(9702),i(5052),i(5228);const r="screenSpaceReflection2BlurCombinerPixelShader",n="var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>; \nvar mainSamplerSampler: sampler;var mainSampler: texture_2d<f32>;var reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;uniform strength: f32;uniform reflectionSpecularFalloffExponent: f32;uniform reflectivityThreshold: f32;varying vUV: vec2f;\n#include<helperFunctions>\n#ifdef SSR_BLEND_WITH_FRESNEL\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nuniform projection: mat4x4f;uniform invProjectionMatrix: mat4x4f;var normalSampler: texture_2d<f32>;var depthSampler: texture_2d<f32>;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nuniform nearPlaneZ: f32;uniform farPlaneZ: f32;\n#endif\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#ifdef SSRAYTRACE_DEBUG\nfragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);\n#else\nvar SSR: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var color: vec4f=textureSample(mainSampler,textureSamplerSampler,input.vUV);var reflectivity: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vUV);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=uniforms.reflectivityThreshold) {fragmentOutputs.color=color;return fragmentOutputs;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpaceVec4(color);\n#endif\n#ifdef SSR_BLEND_WITH_FRESNEL\nvar texSize: vec2f= vec2f(textureDimensions(depthSampler,0));var csNormal: vec3f=textureLoad(normalSampler,vec2<i32>(input.vUV*texSize),0).xyz;var depth: f32=textureLoad(depthSampler,vec2<i32>(input.vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,uniforms.nearPlaneZ,uniforms.farPlaneZ);\n#endif\nvar csPosition: vec3f=computeViewPosFromUVDepth(input.vUV,depth,uniforms.projection,uniforms.invProjectionMatrix);var csViewDirection: vec3f=normalize(csPosition);var F0: vec3f=reflectivity.rgb;var fresnel: vec3f=fresnelSchlickGGXVec3(max(dot(csNormal,-csViewDirection),0.0),F0, vec3f(1.));var reflectionMultiplier: vec3f=clamp(pow(fresnel*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#else\nvar reflectionMultiplier: vec3f=clamp(pow(reflectivity.rgb*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));\n#endif\nvar colorMultiplier: vec3f=1.0-reflectionMultiplier;var finalColor: vec3f=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpaceVec3(finalColor);\n#endif\nfragmentOutputs.color= vec4f(finalColor,color.a);\n#endif\n}\n";s.l.ShadersStoreWGSL[r]=n;const a={name:r,shader:n}},5381:(e,t,i)=>{"use strict";i.r(t),i.d(t,{sharpenPixelShaderWGSL:()=>n});const s="sharpenPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform sharpnessAmounts: vec2f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var onePixel: vec2f= vec2f(1.0,1.0)/uniforms.screenSize;var color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var edgeDetection: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(0,-1)) +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(-1,0)) +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(1,0)) +\ntextureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(0,1)) -\ncolor*4.0;fragmentOutputs.color=max(vec4f(color.rgb*uniforms.sharpnessAmounts.y,color.a)-(uniforms.sharpnessAmounts.x* vec4f(edgeDetection.rgb,0)),vec4f(0.));}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},5076:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ssao2PixelShaderWGSL:()=>n});const s="ssao2PixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;\n#ifdef SSAO\nconst scales: array<f32,16>=array<f32,16>(\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);uniform near: f32;uniform radius: f32;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;var randomSamplerSampler: sampler;var randomSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;uniform randTextureTiles: f32;uniform samplesFactor: f32;uniform sampleSphere: array<vec3f,SAMPLES>;uniform totalStrength: f32;uniform base: f32;uniform xViewport: f32;uniform yViewport: f32;uniform depthProjection: mat3x3f;uniform maxZ: f32;uniform minZAspect: f32;uniform texelSize: vec2f;uniform projection: mat4x4f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var random: vec3f=textureSampleLevel(randomSampler,randomSamplerSampler,input.vUV*uniforms.randTextureTiles,0.0).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r;var depthSign: f32=sign(depth);depth=depth*depthSign;var normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.0).rgb;var occlusion: f32=0.0;var correctedRadius: f32=min(uniforms.radius,uniforms.minZAspect*depth/uniforms.near);var vViewRay: vec3f= vec3f((input.vUV.x*2.0-1.0)*uniforms.xViewport,(input.vUV.y*2.0-1.0)*uniforms.yViewport,depthSign);var vDepthFactor: vec3f=uniforms.depthProjection* vec3f(1.0,1.0,depth);var origin: vec3f=vViewRay*vDepthFactor;var rvec: vec3f=random*2.0-1.0;rvec.z=0.0;var dotProduct: f32=dot(rvec,normal);rvec=select( vec3f(-rvec.y,0.0,rvec.x),rvec,1.0-abs(dotProduct)>1e-2);var tangent: vec3f=normalize(rvec-normal*dot(rvec,normal));var bitangent: vec3f=cross(normal,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,normal);var difference: f32;for (var i: i32=0; i<SAMPLES; i++) {var samplePosition: vec3f=scales[(i+ i32(random.x*16.0)) % 16]*tbn*uniforms.sampleSphere[(i+ i32(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;var offset: vec4f= vec4f(samplePosition,1.0);offset=uniforms.projection*offset;offset=vec4f(offset.xyz/offset.w,offset.w);offset=vec4f(offset.xy*0.5+0.5,offset.z,offset.w);if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}\nvar sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;var rangeCheck: f32=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}\nocclusion=occlusion*(1.0-smoothstep(uniforms.maxZ*0.75,uniforms.maxZ,depth));var ao: f32=1.0-uniforms.totalStrength*occlusion*uniforms.samplesFactor;var result: f32=clamp(ao+uniforms.base,0.0,1.0);fragmentOutputs.color= vec4f( vec3f(result),1.0);}\n#else\n#ifdef BLUR\nuniform outSize: f32;uniform soften: f32;uniform tolerance: f32;uniform samples: i32;\n#ifndef BLUR_BYPASS\nvar depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;\n#ifdef BLUR_LEGACY\nfn blur13Bilateral(image: texture_2d<f32>,imageSampler: sampler,uv: vec2f,step: vec2f)->f32 {var result: f32=0.0;var off1: vec2f= vec2f(1.411764705882353)*step;var off2: vec2f= vec2f(3.2941176470588234)*step;var off3: vec2f= vec2f(5.176470588235294)*step;var compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv,0.0).r);var sampleDepth: f32;var weight: f32;var weightSum: f32=30.0;result+=textureSampleLevel(image,imageSampler,uv,0.0).r*30.0;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv+off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv-off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off3,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off3,0.0).r*weight;return result/weightSum;}\n#endif\n#endif\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var result: f32=0.0;\n#ifdef BLUR_BYPASS\nresult=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvar step: vec2f= vec2f(1.0/uniforms.outSize,0.0);\n#else\nvar step: vec2f= vec2f(0.0,1.0/uniforms.outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,textureSamplerSampler,input.vUV,step);\n#else\nvar compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r);var weightSum: f32=0.0;for (var i: i32=-uniforms.samples; i<uniforms.samples; i+=2)\n{var samplePos: vec2f=input.vUV+step*( f32(i)+0.5);var sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,samplePos,0.0).r);var falloff: f32=smoothstep(0.0,\nf32(uniforms.samples),\nf32(uniforms.samples)-abs( f32(i))*uniforms.soften);var minDivider: f32=uniforms.tolerance*0.5+0.003;var weight: f32=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureSampleLevel(textureSampler,textureSamplerSampler,samplePos,0.0).r*weight;weightSum+=weight;}\nresult/=weightSum;\n#endif\n#endif\nfragmentOutputs.color=vec4f(result,result,result,1.0);}\n#endif\n#endif\n";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},598:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ssaoCombinePixelShaderWGSL:()=>n});const s="ssaoCombinePixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var originalColorSampler: sampler;var originalColor: texture_2d<f32>;uniform viewport: vec4f;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvar ssaoColor: vec4f=textureSample(textureSampler,textureSamplerSampler,uniforms.viewport.xy+input.vUV*uniforms.viewport.zw);var sceneColor: vec4f=textureSample(originalColor,originalColorSampler,input.vUV);fragmentOutputs.color=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},18:(e,t,i)=>{"use strict";i.r(t),i.d(t,{tonemapPixelShaderWGSL:()=>n});const s="tonemapPixelShader",r="varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform _ExposureAdjustment: f32;\n#if defined(HABLE_TONEMAPPING)\nconst A: f32=0.15;const B: f32=0.50;const C: f32=0.10;const D: f32=0.20;const E: f32=0.02;const F: f32=0.30;const W: f32=11.2;\n#endif\nfn Luminance(c: vec3f)->f32\n{return dot(c, vec3f(0.22,0.707,0.071));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var colour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nvar lum: f32=Luminance(colour.rgb); \nvar lumTm: f32=lum*uniforms._ExposureAdjustment;var scale: f32=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=uniforms._ExposureAdjustment;const ExposureBias: f32=2.0;var x: vec3f=ExposureBias*colour;var curr: vec3f=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x= vec3f(W,W,W);var whiteScale: vec3f=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=uniforms._ExposureAdjustment;var X: vec3f=max( vec3f(0.0,0.0,0.0),colour-0.004);var retColor: vec3f=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour= vec3f(1.0,1.0,1.0)-exp2(-uniforms._ExposureAdjustment*colour);\n#endif\nfragmentOutputs.color= vec4f(colour.rgb,1.0);}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},7811:(e,t,i)=>{"use strict";i.r(t),i.d(t,{vrDistortionCorrectionPixelShaderWGSL:()=>n});const s="vrDistortionCorrectionPixelShader",r="#define DISABLE_UNIFORMITY_ANALYSIS\nvarying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform LensCenter: vec2f;uniform Scale: vec2f;uniform ScaleIn: vec2f;uniform HmdWarpParam: vec4f;fn HmdWarp(in01: vec2f)->vec2f {var theta: vec2f=(in01-uniforms.LensCenter)*uniforms.ScaleIn; \nvar rSq: f32=theta.x*theta.x+theta.y*theta.y;var rvector: vec2f=theta*(uniforms.HmdWarpParam.x+uniforms.HmdWarpParam.y*rSq+uniforms.HmdWarpParam.z*rSq*rSq+uniforms.HmdWarpParam.w*rSq*rSq*rSq);return uniforms.LensCenter+uniforms.Scale*rvector;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {var tc: vec2f=HmdWarp(input.vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0) {fragmentOutputs.color=vec4f(0.0,0.0,0.0,0.0);}\nelse{fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,tc);}}";i(9610).l.ShadersStoreWGSL[s]=r;const n={name:s,shader:r}},5523:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\n#define BVASNAME bakedVertexAnimationSettingsInstanced\n#else\n#define BVASNAME bakedVertexAnimationSettings\n#endif\nfloat VATStartFrame=BVASNAME.x;float VATEndFrame=BVASNAME.y;float VATOffsetFrame=BVASNAME.z;float VATSpeed=BVASNAME.w;float totalFrames=VATEndFrame-VATStartFrame+1.0;float time=bakedVertexAnimationTime*VATSpeed/totalFrames;float frameCorrection=time<1.0 ? 0.0 : 1.0;float numOfFrames=totalFrames-frameCorrection;float VATFrameNum=fract(time)*numOfFrames;VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);VATFrameNum=floor(VATFrameNum);VATFrameNum+=VATStartFrame+frameCorrection;mat4 VATInfluence;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;}\n#endif\n"},8959:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform float bakedVertexAnimationTime;uniform vec2 bakedVertexAnimationTextureSizeInverted;uniform vec4 bakedVertexAnimationSettings;uniform sampler2D bakedVertexAnimationTexture;\n#ifdef INSTANCES\nattribute vec4 bakedVertexAnimationSettingsInstanced;\n#endif\n#define inline\nmat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)\n{float offset=index*4.0;float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;float dx=bakedVertexAnimationTextureSizeInverted.x;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));return mat4(m0,m1,m2,m3);}\n#endif\n"},9707:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bonesDeclaration:()=>n});const s="bonesDeclaration",r="#if NUM_BONE_INFLUENCERS>0\nattribute vec4 matricesIndices;attribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;attribute vec4 matricesWeightsExtra;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nuniform highp sampler2D boneSampler;uniform float boneTextureWidth;\n#else\nuniform mat4 mBones[BonesPerMesh];\n#endif\n#ifdef BONES_VELOCITY_ENABLED\nuniform mat4 mPreviousBones[BonesPerMesh];\n#endif\n#ifdef BONETEXTURE\n#define inline\nmat4 readMatrixFromRawSampler(sampler2D smp,float index)\n{float offset=index *4.0;float dx=1.0/boneTextureWidth;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));return mat4(m0,m1,m2,m3);}\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},3361:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bonesVertex:()=>n});const s="bonesVertex",r="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif\n#else\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},7018:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bumpFragment:()=>n});const s="bumpFragment",r="vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#elif defined(BUMP)\nfloat normalScale=vBumpInfos.y;\n#else\nfloat normalScale=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#elif defined(BUMP)\nvec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);\n#else\nvec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nvec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);\n#else\nvec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},8269:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bumpFragmentFunctions:()=>a});var s=i(9610);i(3022);const r="bumpFragmentFunctions",n="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)\n{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)\n{}\nelse if (currSampledHeight>currRayHeight)\n{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}\nelse\n{currRayHeight-=stepSize;vLastOffset=vCurrOffset;\n#ifdef PARALLAX_RHS\nvCurrOffset-=stepSize*vMaxOffset;\n#else\nvCurrOffset+=stepSize*vMaxOffset;\n#endif\nlastSampledHeight=currSampledHeight;}}\nreturn vCurrOffset;}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;\n#ifdef PARALLAX_RHS\nreturn texCoordOffset;\n#else\nreturn -texCoordOffset;\n#endif\n}\n#endif\n";s.l.IncludesShadersStore[r]=n;const a={name:r,shader:n}},7494:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bumpFragmentMainFunctions:()=>n});const s="bumpFragmentMainFunctions",r="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#if defined(WEBGL2) || defined(WEBGPU)\nmat4 toNormalMatrix(mat4 wMatrix)\n{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}\n#else\nmat4 toNormalMatrix(mat4 m)\n{float\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);}\n#endif\n#endif\nvec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)\n{\n#ifdef NORMALXYSCALE\nnormal=normalize(normal*vec3(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*normal);}\nvec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)\n{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)\n{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},7059:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.bumpVertex="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif\n"},7412:(e,t,i)=>{"use strict";i.r(t),i.d(t,{clipPlaneFragment:()=>n});const s="clipPlaneFragment",r="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{discard;}\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},6194:(e,t,i)=>{"use strict";i.r(t),i.d(t,{clipPlaneFragmentDeclaration:()=>n});const s="clipPlaneFragmentDeclaration",r="#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nvarying float fClipDistance6;\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},7314:(e,t,i)=>{"use strict";i.r(t),i.d(t,{clipPlaneVertex:()=>n});const s="clipPlaneVertex",r="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,vClipPlane6);\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},1636:(e,t,i)=>{"use strict";i.r(t),i.d(t,{clipPlaneVertexDeclaration:()=>n});const s="clipPlaneVertexDeclaration",r="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;varying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;varying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;varying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;varying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;varying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;varying float fClipDistance6;\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},2360:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.fogFragment="#ifdef FOG\nfloat fog=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor.rgb=mix(vFogColor,color.rgb,fog);\n#endif\n"},7806:(e,t,i)=>{"use strict";i.r(t),i.d(t,{fogFragmentDeclaration:()=>n});const s="fogFragmentDeclaration",r="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()\n{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)\n{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}\nelse if (FOGMODE_EXP==vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}\nelse if (FOGMODE_EXP2==vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}\nreturn clamp(fogCoeff,0.0,1.0);}\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},6470:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.fogVertex="#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif\n"},6560:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.fogVertexDeclaration="#ifdef FOG\nvarying vec3 vFogDistance;\n#endif\n"},1339:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.fresnelFunction="#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}\n#endif\n"},3325:(e,t,i)=>{"use strict";i.r(t),i.d(t,{helperFunctions:()=>n});const s="helperFunctions",r="const float PI=3.1415926535897932384626433832795;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float HALF_MIN=5.96046448e-08; \nconst float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;\n#define saturate(x) clamp(x,0.0,1.0)\n#define absEps(x) abs(x)+Epsilon\n#define maxEps(x) max(x,Epsilon)\n#define saturateEps(x) clamp(x,Epsilon,1.0)\nmat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);return outMatrix;}\nmat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}\n#if USE_EXACT_SRGB_CONVERSIONS\nvec3 toLinearSpaceExact(vec3 color)\n{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));\n#else\nreturn\nvec3(\ncolor.r<=0.04045 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.04045 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.04045 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\nvec3 toGammaSpaceExact(vec3 color)\n{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));\n#else\nreturn\nvec3(\ncolor.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\n#endif\nfloat toLinearSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nvec3 toLinearSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3(LinearEncodePowerApprox));\n#endif\n}\nvec4 toLinearSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfloat toGammaSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,GammaEncodePowerApprox);\n#endif\n}\nvec3 toGammaSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3(GammaEncodePowerApprox));\n#endif\n}\nvec4 toGammaSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfloat square(float value)\n{return value*value;}\nvec3 square(vec3 value)\n{return value*value;}\nfloat pow5(float value) {float sq=value*value;return sq*sq*value;}\nfloat getLuminance(vec3 color)\n{return clamp(dot(color,LuminanceEncodeApprox),0.,1.);}\nfloat getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}\nfloat dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}\nconst float rgbdMaxRange=255.0;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(clamp(rgb,0.,1.),D); }\nvec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},9392:(e,t,i)=>{"use strict";i.r(t),i.d(t,{imageProcessingDeclaration:()=>n});const s="imageProcessingDeclaration",r="#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vec2 vInverseScreenSize;\n#endif\n#ifdef VIGNETTE\nuniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif\n#ifdef DITHER\nuniform float ditherIntensity;\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},4017:(e,t,i)=>{"use strict";i.r(t),i.d(t,{imageProcessingFunctions:()=>n});const s="imageProcessingFunctions",r="#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n/** \n* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.\n* sampler3dSetting.x=textureOffset (0.5/textureSize).\n* sampler3dSetting.y=textureSize.\n*/\n#define inline\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{float sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;}\n#endif\n#if TONEMAPPING==3\nconst float PBRNeutralStartCompression=0.8-0.04;const float PBRNeutralDesaturation=0.15;vec3 PBRNeutralToneMapping( vec3 color ) {float x=min(color.r,min(color.g,color.b));float offset=x<0.08 ? x-6.25*x*x : 0.04;color-=offset;float peak=max(color.r,max(color.g,color.b));if (peak<PBRNeutralStartCompression) return color;float d=1.-PBRNeutralStartCompression;float newPeak=1.-d*d/(peak+d-PBRNeutralStartCompression);color*=newPeak/peak;float g=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(color,newPeak*vec3(1,1,1),g);}\n#endif\n#if TONEMAPPING==2\nconst mat3 ACESInputMat=mat3(\nvec3(0.59719,0.07600,0.02840),\nvec3(0.35458,0.90834,0.13383),\nvec3(0.04823,0.01566,0.83777)\n);const mat3 ACESOutputMat=mat3(\nvec3( 1.60475,-0.10208,-0.00327),\nvec3(-0.53108, 1.10813,-0.07276),\nvec3(-0.07367,-0.00605, 1.07602)\n);vec3 RRTAndODTFit(vec3 v)\n{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}\nvec3 ACESFitted(vec3 color)\n{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nvec4 applyImageProcessing(vec4 result) {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#if TONEMAPPING==3\nresult.rgb=PBRNeutralToneMapping(result.rgb);\n#elif TONEMAPPING==2\nresult.rgb=ACESFitted(result.rgb);\n#elif TONEMAPPING==1\nconst float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\nresult.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);\n#ifdef CONTRAST\nvec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}\n#endif\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nfloat luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nfloat rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn result;}";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},1218:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.instancesDeclaration="#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#ifdef INSTANCESCOLOR\nattribute vec4 instanceColor;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nattribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;\n#ifdef THIN_INSTANCES\nuniform mat4 previousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nuniform mat4 previousWorld;\n#endif\n#endif\n"},3298:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.instancesVertex="#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nmat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,\npreviousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\nfinalWorld=world*finalWorld;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\nmat4 finalWorld=world;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)\nmat4 finalPreviousWorld=previousWorld;\n#endif\n#endif\n"},7382:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.kernelBlurVaryingDeclaration="varying vec2 sampleCoord{X};"},7256:(e,t,i)=>{"use strict";i.r(t),i.d(t,{lightFragment:()=>n});const s="lightFragment",r="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\nvec4 diffuse{X}=light{X}.vLightDiffuse;\n#define CUSTOM_LIGHT{X}_COLOR \n#ifdef PBR\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#ifdef HEMILIGHT{X}\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);\n#elif defined(SS_TRANSLUCENCY)\ninfo.diffuse=computeDiffuseAndTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);\n#endif\n#ifdef SPECULARTERM\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) \n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;\n#else\ndiff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {index{X}=i;break;}}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nfloat frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{index{X}+=1;float nextShadow=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;shadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\naggShadow+=shadow;numLights+=1.0;\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else \ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},2270:(e,t,i)=>{"use strict";i.r(t),i.d(t,{lightFragmentDeclaration:()=>n});const s="lightFragmentDeclaration",r="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};\n#else\nuniform highp sampler2DArray shadowTexture{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);vec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowTexture{X};\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowTexture{X};\n#else\nuniform sampler2D shadowTexture{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},2448:(e,t,i)=>{"use strict";i.r(t),i.d(t,{lightUboDeclaration:()=>n});const s="lightUboDeclaration",r="#ifdef LIGHT{X}\nuniform Light{X}\n{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;vec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;vec2 depthValues;} light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowTexture{X};\n#else\nuniform highp sampler2DArray shadowTexture{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);vec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowTexture{X}; \n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowTexture{X};\n#else\nuniform sampler2D shadowTexture{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},9440:(e,t,i)=>{"use strict";i.r(t),i.d(t,{lightVxFragmentDeclaration:()=>n});const s="lightVxFragmentDeclaration",r="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},4662:(e,t,i)=>{"use strict";i.r(t),i.d(t,{lightVxUboDeclaration:()=>n});const s="lightVxUboDeclaration",r="#ifdef LIGHT{X}\nuniform Light{X}\n{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;vec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;vec2 depthValues;} light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},1962:(e,t,i)=>{"use strict";i.r(t),i.d(t,{lightsFragmentFunctions:()=>n});const s="lightsFragmentFunctions",r="struct lightingInfo\n{vec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)\n{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}\nelse\n{lightVectorW=normalize(-lightData.xyz);}\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)\n{cosAngle=max(0.,pow(cosAngle,lightData.w));attenuation*=cosAngle;float ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;\n#endif\nreturn result;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},4581:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.logDepthDeclaration="#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;varying float vFragmentDepth;\n#endif\n"},9741:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.logDepthFragment="#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif\n"},2215:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.logDepthVertex="#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif\n"},5060:(e,t,i)=>{"use strict";i.r(t),i.d(t,{morphTargetsVertex:()=>n});const s="morphTargetsVertex",r="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\n#if {X}==0\nfor (int i=0; i<NUM_MORPH_INFLUENCERS; i++) {if (i>=morphTargetCount) break;vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;positionUpdated+=(readVector3FromRawSampler(i,vertexID)-position)*morphTargetInfluences[i];vertexID+=1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(readVector3FromRawSampler(i,vertexID) -normal)*morphTargetInfluences[i];vertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(readVector3FromRawSampler(i,vertexID).xy-uv)*morphTargetInfluences[i];vertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(readVector3FromRawSampler(i,vertexID) -tangent.xyz)*morphTargetInfluences[i];\n#endif\n}\n#endif\n#else\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},738:(e,t,i)=>{"use strict";i.r(t),i.d(t,{morphTargetsVertexDeclaration:()=>n});const s="morphTargetsVertexDeclaration",r="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#ifdef MORPHTARGETS_UV\nattribute vec2 uv_{X};\n#endif\n#elif {X}==0\nuniform int morphTargetCount;\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},8451:(e,t,i)=>{"use strict";i.r(t),i.d(t,{morphTargetsVertexGlobal:()=>n});const s="morphTargetsVertexGlobal",r="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nfloat vertexID;\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},7999:(e,t,i)=>{"use strict";i.r(t),i.d(t,{morphTargetsVertexGlobalDeclaration:()=>n});const s="morphTargetsVertexGlobalDeclaration",r="#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#ifdef MORPHTARGETS_TEXTURE \nuniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];uniform vec3 morphTargetTextureInfo;uniform highp sampler2DArray morphTargets;vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV).xyz;}\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},8334:(e,t,i)=>{"use strict";i.r(t),i.d(t,{packingFunctions:()=>n});const s="packingFunctions",r="vec4 pack(float depth)\n{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},8709:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.pbrBRDFFunctions="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}\n#endif\n#ifdef ENVIRONMENTBRDF\nvec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup.rgb=fromRGBD(brdfLookup.rgba);\n#endif\nreturn brdfLookup.rgb;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfloat getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)\n{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nvec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nvec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}\n#endif\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\nfloat fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\n#ifdef CLEARCOAT\nvec3 getR0RemappedForClearCoat(vec3 f0) {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturate(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst mat3 XYZ_TO_REC709=mat3(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}\nvec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}\nfloat getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}\nvec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}\nvec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}\nfloat cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); \nvec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)\n{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}\nreturn max(I,vec3(0.0));}\n#endif\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}\n#ifdef SHEEN\nfloat normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)\n{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}\n#endif\n#ifdef ANISOTROPIC\nfloat normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {\n#ifdef MOBILE\nfloat GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);\n#else\nfloat a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfloat smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nfloat alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfloat smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)\n{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}\n#endif\n#ifdef ANISOTROPIC\nfloat smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}\n#endif\n#ifdef CLEARCOAT\nfloat visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }\n#endif\n#ifdef SHEEN\nfloat visibility_Ashikhmin(float NdotL,float NdotV)\n{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfloat l(float x,float alphaG)\n{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}\nfloat lambdaSheen(float cosTheta,float alphaG)\n{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}\nfloat visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)\n{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}\n#endif\n*/\n#endif\nfloat diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}\n#ifdef SS_TRANSLUCENCY\nvec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}\nfloat computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}\n#endif\n"},1211:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.pointCloudVertex="#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n"},8223:(e,t,i)=>{"use strict";i.r(t),i.d(t,{reflectionFunction:()=>n});const s="reflectionFunction",r="vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }\nvec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }\nvec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}\nvec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)\n{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}\nvec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}\nvec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nvec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)\n{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nvec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)\n{return vec3(reflectionMatrix*(view*worldPos));}\nvec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)\n{return vec3(reflectionMatrix*vec4(positionW,1.));}\n#ifdef REFLECTION\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(vPositionUVW,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},3022:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.samplerFragmentDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\nuniform sampler2D _SAMPLERNAME_Sampler;\n#endif\n"},8764:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.sceneUboDeclaration="layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nmat4 view;mat4 projection;vec4 vEyePosition;};\n"},9363:(e,t,i)=>{"use strict";i(9610).l.IncludesShadersStore.screenSpaceRayTrace="float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nfloat linearizeDepth(float depth,float near,float far) {\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nreturn -(near*far)/(far-depth*(far-near));\n#else\nreturn (near*far)/(far-depth*(far-near));\n#endif\n}\n#endif\n/**\nparam csOrigin Camera-space ray origin,which must be \nwithin the view volume and must have z>0.01 and project within the valid screen rectangle\nparam csDirection Unit length camera-space ray direction\nparam projectToPixelMatrix A projection matrix that maps to **pixel** coordinates \n(**not** [-1,+1] normalized device coordinates).\nparam csZBuffer The camera-space Z buffer\nparam csZBufferSize Dimensions of csZBuffer\nparam csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer\nparam nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value\nfor clipping rays headed towards the camera\nparam stride Step in horizontal or vertical pixels between samples. This is a float\nbecause integer math is slow on GPUs,but should be set to an integer>=1\nparam jitterFraction Number between 0 and 1 for how far to bump the ray in stride units\nto conceal banding artifacts,plus the stride ray offset.\nparam maxSteps Maximum number of iterations. Higher gives better images but may be slow\nparam maxRayTraceDistance Maximum camera-space distance to trace before returning a miss\nparam selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.\n1 is a reasonable value,depending on the scene you may need to set this value to 2\nparam hitPixel Pixel coordinates of the first intersection with the scene\nparam numIterations number of iterations performed\nparam csHitPoint Camera space location of the ray hit\n*/\n#define inline\nbool traceScreenSpaceRay1(\nvec3 csOrigin,\nvec3 csDirection,\nmat4 projectToPixelMatrix,\nsampler2D csZBuffer,\nvec2 csZBufferSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nsampler2D csZBackBuffer,\nfloat csZBackSizeFactor,\n#endif\nfloat csZThickness,\nfloat nearPlaneZ,\nfloat farPlaneZ,\nfloat stride,\nfloat jitterFraction,\nfloat maxSteps,\nfloat maxRayTraceDistance,\nfloat selfCollisionNumSkip,\nout vec2 startPixel,\nout vec2 hitPixel,\nout vec3 csHitPoint,\nout float numIterations\n#ifdef SSRAYTRACE_DEBUG\n,out vec3 debugColor\n#endif\n)\n{\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#else\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#endif\nvec3 csEndPoint=csOrigin+csDirection*rayLength;hitPixel=vec2(-1.0,-1.0);vec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);vec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);float k0=1.0/H0.w;float k1=1.0/H1.w;vec3 Q0=csOrigin*k0;vec3 Q1=csEndPoint*k1;vec2 P0=H0.xy*k0;vec2 P1=H1.xy*k1;\n#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM\nfloat xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;float alpha=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);}\nif ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));}\nP1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);\n#endif\nP1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) { \npermute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }\nfloat stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=vec2(stepDirection,delta.y*invdx);vec3 dQ=(Q1-Q0)*invdx;float dk=(k1-k0)*invdx;float zMin=min(csEndPoint.z,csOrigin.z);float zMax=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;vec4 pqk=vec4(P0,Q0.z,k0);vec4 dPQK=vec4(dP,dQ.z,dk);startPixel=permute ? P0.yx : P0.xy;float prevZMaxEstimate=csOrigin.z;float rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;float sceneZMax=rayZMax+1e4;float end=P1.x*stepDirection;bool hit=false;float stepCount;for (stepCount=0.0;stepCount<=selfCollisionNumSkip ||\n(pqk.x*stepDirection)<=end &&\nstepCount<maxSteps &&\n!hit &&\nsceneZMax != 0.0; \npqk+=dPQK,++stepCount)\n{hitPixel=permute ? pqk.yx : pqk.xy;rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { \nfloat t=rayZMin; rayZMin=rayZMax; rayZMax=t;}\nsceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);\n#else\nhit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);\n#endif\n#else\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);\n#endif\nhit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);\n#else\nhit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);\n#endif\n#endif\n}\npqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}\n#ifdef SSRAYTRACE_ENABLE_REFINEMENT\nif (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;float invStride=1.0/stride;dPQK*=invStride;float refinementStepCount=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||\n(refinementStepCount<=stride*1.4) &&\n(rayZMax<sceneZMax) && (sceneZMax != 0.0);pqk+=dPQK,refinementStepCount+=1.0)\n{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);hitPixel=permute ? pqk.yx : pqk.xy;sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nsceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);\n#endif\n}\npqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}\n#endif\nQ0.xy+=dQ.xy*stepCount;Q0.z=pqk.z;csHitPoint=Q0/pqk.w;numIterations=stepCount+1.0;\n#ifdef SSRAYTRACE_DEBUG\nif (((pqk.x+dPQK.x)*stepDirection)>end) {debugColor=vec3(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {debugColor=vec3(1,0,0);} else if (sceneZMax==0.0) {debugColor=vec3(1,1,0);} else {debugColor=vec3(0,stepCount/maxSteps,0);}\n#endif\nreturn hit;}\n/**\ntexCoord: in the [0,1] range\ndepth: depth in view space (range [znear,zfar]])\n*/\nvec3 computeViewPosFromUVDepth(vec2 texCoord,float depth,mat4 projection,mat4 invProjectionMatrix) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef ORTHOGRAPHIC_CAMERA\nndc.z=-projection[2].z*depth+projection[3].z;\n#else\nndc.z=-projection[2].z-projection[3].z/depth;\n#endif\n#else\n#ifdef ORTHOGRAPHIC_CAMERA\nndc.z=projection[2].z*depth+projection[3].z;\n#else\nndc.z=projection[2].z+projection[3].z/depth;\n#endif\n#endif\nndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}\n"},8322:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shadowMapFragment:()=>n});const s="shadowMapFragment",r="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},9796:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shadowMapVertexMetric:()=>n});const s="shadowMapVertexMetric",r="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;gl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},6812:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shadowsFragmentFunctions:()=>n});const s="shadowsFragmentFunctions",r="#ifdef SHADOWS\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}\n#endif\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}\n#define inline\nfloat computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nreturn depth>shadow ? darkness : 1.0;}\n#define inline\nfloat computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);}\n#define inline\nfloat computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}\n#define inline\nfloat computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define inline\nfloat computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uvLayer));\n#else\nfloat shadow=texture2D(shadowSampler,uvLayer).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}\n#endif\n#define inline\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}\n#define inline\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\n#else\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\n#ifdef IS_NDC_HALF_ZRANGE\n#define ZINCLIP clipSpace.z\n#else\n#define ZINCLIP uvDepth.z\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define GREATEST_LESS_THAN_ONE 0.99999994\n#define DISABLE_UNIFORMITY_ANALYSIS\n#define inline\nfloat computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.)\n);const vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n#define inline\nfloat computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}\nshadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}\nelse\n{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}\nif (numBlocker<1.0) {return 1.0;}\nelse\n{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}\nshadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}\n#define inline\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}\n#define inline\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}\n#define inline\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}\n#define inline\nfloat computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#define inline\nfloat computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#define inline\nfloat computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},5687:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shadowsVertex:()=>n});const s="shadowsVertex",r="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n}\n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n";i(9610).l.IncludesShadersStore[s]=r;const n={name:s,shader:r}},9723:(e,t,i)=>{"use strict";i.r(t),i.d(t,{anaglyphPixelShader:()=>n});const s="anaglyphPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D leftSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 leftFrag=texture2D(leftSampler,vUV);leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);vec4 rightFrag=texture2D(textureSampler,vUV);rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},3996:(e,t,i)=>{"use strict";i.r(t),i.d(t,{blackAndWhitePixelShader:()=>n});const s="blackAndWhitePixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform float degree;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec3 color=texture2D(textureSampler,vUV).rgb;float luminance=dot(color,vec3(0.3,0.59,0.11)); \nvec3 blackAndWhite=vec3(luminance,luminance,luminance);gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},9336:(e,t,i)=>{"use strict";i.r(t),i.d(t,{bloomMergePixelShader:()=>n});const s="bloomMergePixelShader",r="uniform sampler2D textureSampler;uniform sampler2D bloomBlur;varying vec2 vUV;uniform float bloomWeight;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(textureSampler,vUV);vec3 blurred=texture2D(bloomBlur,vUV).rgb;gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); }\n";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},2048:(e,t,i)=>{"use strict";i.r(t),i.d(t,{chromaticAberrationPixelShader:()=>n});const s="chromaticAberrationPixelShader",r="uniform sampler2D textureSampler; \nuniform float chromatic_aberration;uniform float radialIntensity;uniform vec2 direction;uniform vec2 centerPosition;uniform float screen_width;uniform float screen_height;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);vec2 directionOfEffect=direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+ centered_screen_pos.y*centered_screen_pos.y;float radius=sqrt(radius2);vec3 ref_indices=vec3(-0.3,0.0,0.3);float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);vec4 r=texture2D(textureSampler,ref_coords_r);vec4 g=texture2D(textureSampler,ref_coords_g);vec4 b=texture2D(textureSampler,ref_coords_b);float a=clamp(r.a+g.a+b.a,0.,1.);gl_FragColor=vec4(r.r,g.g,b.b,a);}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},7694:(e,t,i)=>{"use strict";i.r(t),i.d(t,{circleOfConfusionPixelShader:()=>n});const s="circleOfConfusionPixelShader",r="uniform sampler2D depthSampler;varying vec2 vUV;uniform vec2 cameraMinMaxZ;uniform float focusDistance;uniform float cocPrecalculation;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float depth=texture2D(depthSampler,vUV).r;\n#define CUSTOM_COC_DEPTH\nfloat pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; \n#define CUSTOM_COC_PIXELDISTANCE\nfloat coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);gl_FragColor=vec4(coc,coc,coc,1.0);}\n";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},7670:(e,t,i)=>{"use strict";i.r(t),i.d(t,{colorCorrectionPixelShader:()=>n});const s="colorCorrectionPixelShader",r="uniform sampler2D textureSampler; \nuniform sampler2D colorTable; \nvarying vec2 vUV;const float SLICE_COUNT=16.0; \nvec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {float sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);float zSlice1=min(zSlice0+1.0,width-1.0);float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;float s0=xOffset+(zSlice0*sliceSize);float s1=xOffset+(zSlice1*sliceSize);vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));float zOffset=mod(uv.z*width,1.0);vec4 result=mix(slice0Color,slice1Color,zOffset);return result;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 screen_color=texture2D(textureSampler,vUV);gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},1537:(e,t,i)=>{"use strict";i.r(t),i.d(t,{convolutionPixelShader:()=>n});const s="convolutionPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform float kernel[9];\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];float kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},8852:(e,t,i)=>{"use strict";i.r(t),i.d(t,{depthPixelShader:()=>a});var s=i(9610);i(6194),i(8334),i(7412);const r="depthPixelShader",n="#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vec4 vViewPos;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\ngl_FragColor=pack(vViewPos.z);\n#else\ngl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},9977:(e,t,i)=>{"use strict";i.r(t),i.d(t,{depthVertexShader:()=>a});var s=i(9610);i(9707),i(8959),i(7999),i(738),i(1636),i(1218);s.l.IncludesShadersStore.pointCloudVertexDeclaration="#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n",i(8451),i(5060),i(3298),i(3361),i(5523),i(7314),i(1211);const r="depthVertexShader",n="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform mat4 view;varying vec4 vViewPos;\n#endif\n#include<pointCloudVertexDeclaration>\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvViewPos=view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<pointCloudVertex>\n}\n";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},9411:(e,t,i)=>{"use strict";i.r(t),i.d(t,{depthOfFieldMergePixelShader:()=>n});const s="depthOfFieldMergePixelShader",r="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;uniform sampler2D circleOfConfusionSampler;uniform sampler2D blurStep0;\n#if BLUR_LEVEL>0\nuniform sampler2D blurStep1;\n#endif\n#if BLUR_LEVEL>1\nuniform sampler2D blurStep2;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float coc=TEXTUREFUNC(circleOfConfusionSampler,vUV,0.0).r;\n#if BLUR_LEVEL==0\nvec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);gl_FragColor=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL==1\nif(coc<0.5){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(original,blurred1,coc/0.5);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);}\n#endif\n#if BLUR_LEVEL==2\nif(coc<0.33){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(original,blurred2,coc/0.33);}else if(coc<0.66){vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);}\n#endif\n}\n";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},3718:(e,t,i)=>{"use strict";i.r(t),i.d(t,{displayPassPixelShader:()=>n});const s="displayPassPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D passSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(passSampler,vUV);}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},5491:(e,t,i)=>{"use strict";i.r(t),i.d(t,{extractHighlightsPixelShader:()=>a});var s=i(9610);i(3325);const r="extractHighlightsPixelShader",n="#include<helperFunctions>\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform float threshold;uniform float exposure;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);float luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;}";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},7961:(e,t,i)=>{"use strict";i.r(t),i.d(t,{filterPixelShader:()=>n});const s="filterPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform mat4 kernelMatrix;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec3 baseColor=texture2D(textureSampler,vUV).rgb;vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;gl_FragColor=vec4(updatedColor,1.0);}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},5499:(e,t,i)=>{"use strict";i.r(t),i.d(t,{fxaaPixelShader:()=>n});const s="fxaaPixelShader",r="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nuniform sampler2D textureSampler;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const float fxaaQualitySubpix=1.0;const float fxaaQualityEdgeThreshold=0.166;const float fxaaQualityEdgeThresholdMin=0.0833;const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);\n#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)\nvoid main(){vec2 posM;posM.x=vUV.x;posM.y=vUV.y;vec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);float lumaM=FxaaLuma(rgbyM);float lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));float lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));float lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));float lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));float maxSM=max(lumaS,lumaM);float minSM=min(lumaS,lumaM);float maxESM=max(lumaE,maxSM);float minESM=min(lumaE,minSM);float maxWN=max(lumaN,lumaW);float minWN=min(lumaN,lumaW);float rangeMax=max(maxWN,maxESM);float rangeMin=min(minWN,minESM);float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;float range=rangeMax-rangeMin;float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{gl_FragColor=rgbyM;return;}\n#endif\nfloat lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));float lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));float lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));float lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));float lumaNS=lumaN+lumaS;float lumaWE=lumaW+lumaE;float subpixRcpRange=1.0/range;float subpixNSWE=lumaNS+lumaWE;float edgeHorz1=(-2.0*lumaM)+lumaNS;float edgeVert1=(-2.0*lumaM)+lumaWE;float lumaNESE=lumaNE+lumaSE;float lumaNWNE=lumaNW+lumaNE;float edgeHorz2=(-2.0*lumaE)+lumaNESE;float edgeVert2=(-2.0*lumaN)+lumaNWNE;float lumaNWSW=lumaNW+lumaSW;float lumaSWSE=lumaSW+lumaSE;float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);float edgeHorz3=(-2.0*lumaW)+lumaNWSW;float edgeVert3=(-2.0*lumaS)+lumaSWSE;float edgeHorz=abs(edgeHorz3)+edgeHorz4;float edgeVert=abs(edgeVert3)+edgeVert4;float subpixNWSWNESE=lumaNWSW+lumaNESE;float lengthSign=texelSize.x;bool horzSpan=edgeHorz>=edgeVert;float subpixA=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)\n{lumaN=lumaW;}\nif (!horzSpan) \n{lumaS=lumaE;}\nif (horzSpan) \n{lengthSign=texelSize.y;}\nfloat subpixB=(subpixA*(1.0/12.0))-lumaM;float gradientN=lumaN-lumaM;float gradientS=lumaS-lumaM;float lumaNN=lumaN+lumaM;float lumaSS=lumaS+lumaM;bool pairN=abs(gradientN)>=abs(gradientS);float gradient=max(abs(gradientN),abs(gradientS));if (pairN)\n{lengthSign=-lengthSign;}\nfloat subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);vec2 posB;posB.x=posM.x;posB.y=posM.y;vec2 offNP;offNP.x=(!horzSpan) ? 0.0 : texelSize.x;offNP.y=(horzSpan) ? 0.0 : texelSize.y;if (!horzSpan) \n{posB.x+=lengthSign*0.5;}\nif (horzSpan)\n{posB.y+=lengthSign*0.5;}\nvec2 posN;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;vec2 posP;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;float subpixD=((-2.0)*subpixC)+3.0;float lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));float subpixE=subpixC*subpixC;float lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));if (!pairN) \n{lumaNN=lumaSS;}\nfloat gradientScaled=gradient*1.0/4.0;float lumaMM=lumaM-lumaNN*0.5;float subpixF=subpixD*subpixE;bool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;bool doneN=abs(lumaEndN)>=gradientScaled;bool doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) \n{posN.x-=offNP.x*3.0;}\nif (!doneN) \n{posN.y-=offNP.y*3.0;}\nbool doneNP=(!doneN) || (!doneP);if (!doneP) \n{posP.x+=offNP.x*3.0;}\nif (!doneP)\n{posP.y+=offNP.y*3.0;}\nif (doneNP)\n{if (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));if (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) posN.x-=offNP.x*12.0;if (!doneN) posN.y-=offNP.y*12.0;doneNP=(!doneN) || (!doneP);if (!doneP) posP.x+=offNP.x*12.0;if (!doneP) posP.y+=offNP.y*12.0;}\nfloat dstN=posM.x-posN.x;float dstP=posP.x-posM.x;if (!horzSpan)\n{dstN=posM.y-posN.y;}\nif (!horzSpan) \n{dstP=posP.y-posM.y;}\nbool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;float spanLength=(dstP+dstN);bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;float spanLengthRcp=1.0/spanLength;bool directionN=dstN<dstP;float dst=min(dstN,dstP);bool goodSpan=directionN ? goodSpanN : goodSpanP;float subpixG=subpixF*subpixF;float pixelOffset=(dst*(-spanLengthRcp))+0.5;float subpixH=subpixG*fxaaQualitySubpix;float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if (!horzSpan)\n{posM.x+=pixelOffsetSubpix*lengthSign;}\nif (horzSpan)\n{posM.y+=pixelOffsetSubpix*lengthSign;}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{gl_FragColor=rgbyM;}\nelse\n{gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);}\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);\n#endif\n}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},9669:(e,t,i)=>{"use strict";i.r(t),i.d(t,{fxaaVertexShader:()=>n});const s="fxaaVertexShader",r="attribute vec2 position;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd);sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},5007:(e,t,i)=>{"use strict";i.r(t),i.d(t,{geometryPixelShader:()=>a});var s=i(9610);i(6194);s.l.IncludesShadersStore.mrtFragmentDeclaration="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n",i(7494),i(8269),i(3325),i(7412),i(7018);const r="geometryPixelShader",n="#extension GL_EXT_draw_buffers : require\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n#ifdef BUMP\nvarying mat4 vWorldView;varying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#ifdef VELOCITY\nvarying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nuniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vec2 vAlbedoUV;uniform sampler2D albedoSampler;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform vec3 reflectivityColor;\n#endif\n#ifdef ALBEDOCOLOR\nuniform vec3 albedoColor;\n#endif\n#ifdef METALLIC\nuniform float metallic;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform float glossiness;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<mrtFragmentDeclaration>[SCENE_MRT_COUNT]\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\nvoid main() {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nvec3 normalOutput;\n#ifdef BUMP\nvec3 normalW=normalize(vNormalW);\n#include<bumpFragment>\n#ifdef NORMAL_WORLDSPACE\nnormalOutput=normalW;\n#else\nnormalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));\n#endif\n#else\nnormalOutput=normalize(vNormalV);\n#endif\n#ifdef ENCODE_NORMAL\nnormalOutput=normalOutput*0.5+0.5;\n#endif\n#ifdef DEPTH\ngl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef NORMAL\ngl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);\n#endif\n#ifdef SCREENSPACE_DEPTH\ngl_FragData[SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,1.0);\n#endif\n#ifdef POSITION\ngl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvec4 reflectivity=vec4(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nfloat metal=1.0;float roughness=1.0;\n#ifdef ORMTEXTURE\nmetal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;\n#endif\n#ifdef METALLIC\nmetal*=metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-glossiness); \n#endif\nreflectivity.a-=roughness;vec3 color=vec3(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=texture2D(albedoSampler,vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpace(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=albedoColor.xyz;\n#endif\nreflectivity.rgb=mix(vec3(0.04),color,metal);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=texture2D(reflectivitySampler,vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity.rgb=toLinearSpace(reflectivity.rgb);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity.a*=glossiness; \n#endif\n#endif\ngl_FragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n}\n";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},6739:(e,t,i)=>{"use strict";i.r(t),i.d(t,{geometryVertexShader:()=>a});var s=i(9610);i(9707),i(8959),i(7999),i(738),i(1218);s.l.IncludesShadersStore.geometryVertexDeclaration="uniform mat4 viewProjection;uniform mat4 view;",i(8764);s.l.IncludesShadersStore.geometryUboDeclaration="#include<sceneUboDeclaration>\n",i(1636),i(8451),i(5060),i(3298),i(3361),i(5523),i(7314),i(7059);const r="geometryVertexShader",n="precision highp float;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<__decl__geometryVertex>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;attribute vec3 normal;\n#ifdef NEED_UV\nvarying vec2 vUV;\n#ifdef ALPHATEST\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef BUMP\nuniform mat4 bumpMatrix;varying vec2 vBumpUV;\n#endif\n#ifdef REFLECTIVITY\nuniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef BUMP\nvarying mat4 vWorldView;\n#endif\n#ifdef BUMP\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#ifdef VELOCITY\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));\n#ifdef BUMP\nvWorldView=view*finalWorld;vNormalW=normalUpdated;\n#else\n#ifdef NORMAL_WORLDSPACE\nvNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));\n#else\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));\n#endif\n#endif\nvViewPos=view*worldPos;\n#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvPositionW=worldPos.xyz/worldPos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#else\nvUV=uv;\n#endif\n#ifdef BUMP_UV1\nvBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV1\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV1\nvAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#else\nvUV=uv2;\n#endif\n#ifdef BUMP_UV2\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV2\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV2\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},7094:(e,t,i)=>{"use strict";i.r(t),i.d(t,{glowBlurPostProcessPixelShader:()=>n});const s="glowBlurPostProcessPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 direction;uniform float blurWidth;float getLuminance(vec3 color)\n{return dot(color,vec3(0.2126,0.7152,0.0722));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float weights[7];weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);vec2 texelStep=texelSize*direction*blurWidth;vec2 start=vUV-3.0*texelStep;vec4 baseColor=vec4(0.,0.,0.,0.);vec2 texelOffset=vec2(0.,0.);for (int i=0; i<7; i++)\n{vec4 texel=texture2D(textureSampler,start+texelOffset);baseColor.a+=texel.a*weights[i];float luminance=getLuminance(baseColor.rgb);float luminanceTexel=getLuminance(texel.rgb);float choice=step(luminanceTexel,luminance);baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;texelOffset+=texelStep;}\ngl_FragColor=baseColor;}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},3234:(e,t,i)=>{"use strict";i.r(t),i.d(t,{glowMapGenerationPixelShader:()=>a});var s=i(9610);i(3325),i(6194),i(7412);const r="glowMapGenerationPixelShader",n="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;uniform sampler2D diffuseSampler;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;uniform sampler2D opacitySampler;uniform float opacityIntensity;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;uniform sampler2D emissiveSampler;\n#endif\n#ifdef VERTEXALPHA\nvarying vec4 vColor;\n#endif\nuniform vec4 glowColor;uniform float glowIntensity;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\nvec4 finalColor=glowColor;\n#ifdef DIFFUSE\nvec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor.a*=albedoTexture.a;\n#endif\n#ifdef HIGHLIGHT\nfinalColor.a=albedoTexture.a;\n#endif\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor.a*=getLuminance(opacityMap.rgb);\n#else\nfinalColor.a*=opacityMap.a;\n#endif\nfinalColor.a*=opacityIntensity;\n#endif\n#ifdef VERTEXALPHA\nfinalColor.a*=vColor.a;\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifdef EMISSIVE\nvec4 emissive=texture2D(emissiveSampler,vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\ngl_FragColor=emissive*finalColor*glowIntensity;\n#else\ngl_FragColor=finalColor*glowIntensity;\n#endif\n#ifdef HIGHLIGHT\ngl_FragColor.a=glowColor.a;\n#endif\n}";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},136:(e,t,i)=>{"use strict";i.r(t),i.d(t,{glowMapGenerationVertexShader:()=>a});var s=i(9610);i(9707),i(8959),i(7999),i(738),i(1636),i(1218),i(8451),i(5060),i(3298),i(3361),i(5523),i(7314);const r="glowMapGenerationVertexShader",n="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;varying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;uniform mat4 diffuseMatrix;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;uniform mat4 opacityMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;uniform mat4 emissiveMatrix;\n#endif\n#ifdef VERTEXALPHA\nattribute vec4 color;varying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef CUBEMAP\nvPosition=worldPos;gl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*worldPos;gl_Position=vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef OPACITYUV2\nvUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef VERTEXALPHA\nvColor=color;\n#endif\n#include<clipPlaneVertex>\n}";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},9858:(e,t,i)=>{"use strict";i.r(t),i.d(t,{glowMapMergePixelShader:()=>n});const s="glowMapMergePixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;\n#ifdef EMISSIVE\nuniform sampler2D textureSampler2;\n#endif\nuniform float offset;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef EMISSIVE\nbaseColor+=texture2D(textureSampler2,vUV);baseColor*=offset;\n#else\nbaseColor.a=abs(offset-baseColor.a);\n#ifdef STROKE\nfloat alpha=smoothstep(.0,.1,baseColor.a);baseColor.a=alpha;baseColor.rgb=baseColor.rgb*alpha;\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,0.,1.0);\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},1288:(e,t,i)=>{"use strict";i.r(t),i.d(t,{glowMapMergeVertexShader:()=>n});const s="glowMapMergeVertexShader",r="attribute vec2 position;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},890:(e,t,i)=>{"use strict";i.r(t),i.d(t,{grainPixelShader:()=>a});var s=i(9610);i(3325);const r="grainPixelShader",n="#include<helperFunctions>\nuniform sampler2D textureSampler; \nuniform float intensity;uniform float animatedSeed;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(textureSampler,vUV);vec2 seed=vUV*(animatedSeed);float grain=dither(seed,intensity);float lum=getLuminance(gl_FragColor.rgb);float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;gl_FragColor.rgb+=grain*grainAmount;gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);}";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},6920:(e,t,i)=>{"use strict";i.r(t),i.d(t,{highlightsPixelShader:()=>n});const s="highlightsPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec4 tex=texture2D(textureSampler,vUV);vec3 c=tex.rgb;float luma=dot(c.rgb,RGBLuminanceCoefficients);gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); }";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},3153:(e,t,i)=>{"use strict";i.r(t),i.d(t,{imageProcessingPixelShader:()=>a});var s=i(9610);i(9392),i(3325),i(4017);const r="imageProcessingPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 result=texture2D(textureSampler,vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;}";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},4509:(e,t,i)=>{"use strict";i.r(t),i.d(t,{kernelBlurPixelShader:()=>a});var s=i(9610);i(7382),i(8334);s.l.IncludesShadersStore.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n";s.l.IncludesShadersStore.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";const r="kernelBlurPixelShader",n="uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},3802:(e,t,i)=>{"use strict";i.r(t),i.d(t,{kernelBlurVertexShader:()=>a});var s=i(9610);i(7382);s.l.IncludesShadersStore.kernelBlurVertex="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";const r="kernelBlurVertexShader",n="attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},5256:(e,t,i)=>{"use strict";i.r(t),i.d(t,{layerPixelShader:()=>a});var s=i(9610);i(3325);const r="layerPixelShader",n="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef LINEAR\nbaseColor.rgb=toGammaSpace(baseColor.rgb);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},2614:(e,t,i)=>{"use strict";i.r(t),i.d(t,{layerVertexShader:()=>n});const s="layerVertexShader",r="attribute vec2 position;uniform vec2 scale;uniform vec2 offset;uniform mat4 textureMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 shiftedPosition=position*scale+offset;vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));gl_Position=vec4(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},5830:(e,t,i)=>{"use strict";i.r(t),i.d(t,{motionBlurPixelShader:()=>n});const s="motionBlurPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform float motionStrength;uniform float motionScale;uniform vec2 screenSize;\n#ifdef OBJECT_BASED\nuniform sampler2D velocitySampler;\n#else\nuniform sampler2D depthSampler;uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform mat4 projection;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#ifdef GEOMETRY_SUPPORTED\n#ifdef OBJECT_BASED\nvec2 texelSize=1.0/screenSize;vec4 velocityColor=texture2D(velocitySampler,vUV);velocityColor.rg=velocityColor.rg*2.0-vec2(1.0);vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=motionScale*motionStrength;float speed=length(velocity/texelSize);int samplesCount=int(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;float hlim=float(-samplesCount)*0.5+0.5;vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i)\n{if (i>=samplesCount)\nbreak;vec2 offset=vUV+velocity*(hlim+float(i));\n#if defined(WEBGPU)\nresult+=texture2DLodEXT(textureSampler,offset,0.0);\n#else\nresult+=texture2D(textureSampler,offset);\n#endif\n}\ngl_FragColor=result/float(samplesCount);gl_FragColor.a=1.0;\n#else\nvec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;depth=projection[2].z+projection[3].z/depth; \nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=inverseViewProjection*cpos;cpos/=cpos.w;vec4 ppos=prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i) {if (i>=nSamples)\nbreak;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\n#if defined(WEBGPU)\nresult+=texture2DLodEXT(textureSampler,offset1,0.0);\n#else\nresult+=texture2D(textureSampler,offset1);\n#endif\n}\ngl_FragColor=result/float(nSamples);\n#endif\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},9820:(e,t,i)=>{"use strict";i.r(t),i.d(t,{passPixelShader:()=>n});const s="passPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},4511:(e,t,i)=>{"use strict";i.r(t),i.d(t,{passCubePixelShader:()=>n});const s="passCubePixelShader",r="varying vec2 vUV;uniform samplerCube textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));\n#endif\n}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},6612:(e,t,i)=>{"use strict";i.r(t),i.d(t,{postprocessVertexShader:()=>n});const s="postprocessVertexShader",r="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},4354:(e,t,i)=>{"use strict";i.r(t),i.d(t,{screenSpaceReflection2PixelShader:()=>a});var s=i(9610);i(3325),i(8709),i(9363);const r="screenSpaceReflection2PixelShader",n="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#define TEXTURECUBEFUNC(s,c,lod) textureLod(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#define TEXTURECUBEFUNC(s,c,bias) textureCube(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D depthSampler;\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nuniform sampler2D backDepthSampler;uniform float backSizeFactor;\n#endif\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nuniform samplerCube envCubeSampler;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;\n#endif\n#endif\nuniform mat4 view;uniform mat4 invView;uniform mat4 projection;uniform mat4 invProjectionMatrix;uniform mat4 projectionPixel;uniform float nearPlaneZ;uniform float farPlaneZ;uniform float stepSize;uniform float maxSteps;uniform float strength;uniform float thickness;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;uniform float maxDistance;uniform float selfCollisionNumSkip;uniform float reflectivityThreshold;\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nvec3 hash(vec3 a)\n{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}\nfloat computeAttenuationForIntersection(ivec2 hitPixel,vec2 hitUV,vec3 vsRayOrigin,vec3 vsHitPoint,vec3 reflectionVector,float maxRayDistance,float numIterations) {float attenuation=1.0;\n#ifdef SSR_ATTENUATE_SCREEN_BORDERS\nvec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE\nattenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS\nattenuation*=1.0-(numIterations/maxSteps);\n#endif\n#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION\nvec3 reflectionNormal=texelFetch(normalSampler,hitPixel,0).xyz;float directionBasedAttenuation=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;\n#endif\nreturn attenuation;}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);vec3 color=colorFull.rgb;vec4 reflectivity=TEXTUREFUNC(reflectivitySampler,vUV,0.0);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {\n#ifdef SSR_USE_BLUR\ngl_FragColor=vec4(0.);\n#else\ngl_FragColor=colorFull;\n#endif\nreturn;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\nvec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz; \n#ifdef SSR_DECODE_NORMAL\ncsNormal=csNormal*2.0-1.0;\n#endif\n#ifdef SSR_NORMAL_IS_IN_WORLDSPACE\ncsNormal=(view*vec4(csNormal,0.0)).xyz;\n#endif\nfloat depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,nearPlaneZ,farPlaneZ);\n#endif\nvec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);\n#ifdef ORTHOGRAPHIC_CAMERA\nvec3 csViewDirection=vec3(0.,0.,1.);\n#else\nvec3 csViewDirection=normalize(csPosition);\n#endif\nvec3 csReflectedVector=reflect(csViewDirection,csNormal);\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvec3 wReflectedVector=vec3(invView*vec4(csReflectedVector,0.0));\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nvec4 worldPos=invView*vec4(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),vReflectionSize,vReflectionPosition);\n#endif\n#ifdef SSR_INVERTCUBICMAP\nwReflectedVector.y*=-1.0;\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nwReflectedVector.z*=-1.0;\n#endif\nvec3 envColor=TEXTURECUBEFUNC(envCubeSampler,wReflectedVector,0.0).xyz;\n#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE\nenvColor=toLinearSpace(envColor);\n#endif\n#else\nvec3 envColor=color;\n#endif\nfloat reflectionAttenuation=1.0;bool rayHasHit=false;vec2 startPixel;vec2 hitPixel;vec3 hitPoint;float numIterations;\n#ifdef SSRAYTRACE_DEBUG\nvec3 debugColor;\n#endif\n#ifdef SSR_ATTENUATE_FACING_CAMERA\nreflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));\n#endif\nif (reflectionAttenuation>0.0) {\n#ifdef SSR_USE_BLUR\nvec3 jitt=vec3(0.);\n#else\nfloat roughness=1.0-reflectivity.a;vec3 jitt=mix(vec3(0.0),hash(csPosition)-vec3(0.5),roughness)*roughnessFactor; \n#endif\nvec2 uv2=vUV*texSize;float c=(uv2.x+uv2.y)*0.25;float jitter=mod(c,1.0); \nrayHasHit=traceScreenSpaceRay1(\ncsPosition,\nnormalize(csReflectedVector+jitt),\nprojectionPixel,\ndepthSampler,\ntexSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nbackDepthSampler,\nbackSizeFactor,\n#endif\nthickness,\nnearPlaneZ,\nfarPlaneZ,\nstepSize,\njitter,\nmaxSteps,\nmaxDistance,\nselfCollisionNumSkip,\nstartPixel,\nhitPixel,\nhitPoint,\nnumIterations\n#ifdef SSRAYTRACE_DEBUG\n,debugColor\n#endif\n);}\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=vec4(debugColor,1.);return;\n#endif\nvec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 SSR=envColor;if (rayHasHit) {vec3 reflectedColor=texelFetch(textureSampler,ivec2(hitPixel),0).rgb;\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\nreflectedColor=toLinearSpace(reflectedColor);\n#endif\nreflectionAttenuation*=computeAttenuationForIntersection(ivec2(hitPixel),hitPixel/texSize,csPosition,hitPoint,csReflectedVector,maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}\n#ifndef SSR_BLEND_WITH_FRESNEL\nSSR*=fresnel;\n#endif\n#ifdef SSR_USE_BLUR\nfloat blur_radius=0.0;float roughness=1.0-reflectivity.a*(1.0-roughnessFactor);if (roughness>0.001) {float cone_angle=min(roughness,0.999)*3.14159265*0.5;float cone_len=distance(startPixel,hitPixel);float op_len=2.0*tan(cone_angle)*cone_len; \nfloat a=op_len;float h=cone_len;float a2=a*a;float fh2=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}\ngl_FragColor=vec4(SSR,blur_radius/255.0); \n#else\n#ifdef SSR_BLEND_WITH_FRESNEL\nvec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#endif\nvec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,colorFull.a);\n#endif\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,vUV,0.0);\n#endif\n}\n";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},8133:(e,t,i)=>{"use strict";i.r(t),i.d(t,{screenSpaceReflection2BlurPixelShader:()=>n});const s="screenSpaceReflection2BlurPixelShader",r="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;uniform vec2 texelOffsetScale;const float weights[8]=float[8] (0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);void processSample(vec2 uv,float i,vec2 stepSize,inout vec4 accumulator,inout float denominator)\n{vec2 offsetUV=stepSize*i+uv;float coefficient=weights[int(2.0-abs(i))];accumulator+=TEXTUREFUNC(textureSampler,offsetUV,0.0)*coefficient;denominator+=coefficient;}\nvoid main()\n{vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);if (dot(colorFull,vec4(1.0))==0.0) {gl_FragColor=colorFull;return;}\nfloat blurRadius=colorFull.a*255.0; \nvec2 stepSize=texelOffsetScale.xy*blurRadius;vec4 accumulator=TEXTUREFUNC(textureSampler,vUV,0.0)*0.214607;float denominator=0.214607;processSample(vUV,1.0,stepSize,accumulator,denominator);processSample(vUV,1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,1.0*2.0,stepSize,accumulator,denominator);processSample(vUV,-1.0,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*2.0,stepSize,accumulator,denominator);gl_FragColor=vec4(accumulator.rgb/denominator,colorFull.a);}\n";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},7406:(e,t,i)=>{"use strict";i.r(t),i.d(t,{screenSpaceReflection2BlurCombinerPixelShader:()=>a});var s=i(9610);i(3325),i(8709),i(9363);const r="screenSpaceReflection2BlurCombinerPixelShader",n="uniform sampler2D textureSampler; \nuniform sampler2D mainSampler;uniform sampler2D reflectivitySampler;uniform float strength;uniform float reflectionSpecularFalloffExponent;uniform float reflectivityThreshold;varying vec2 vUV;\n#include<helperFunctions>\n#ifdef SSR_BLEND_WITH_FRESNEL\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nuniform mat4 projection;uniform mat4 invProjectionMatrix;uniform sampler2D normalSampler;uniform sampler2D depthSampler;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\nuniform float nearPlaneZ;uniform float farPlaneZ;\n#endif\n#endif\nvoid main()\n{\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=texture2D(textureSampler,vUV);\n#else\nvec3 SSR=texture2D(textureSampler,vUV).rgb;vec4 color=texture2D(mainSampler,vUV);vec4 reflectivity=texture2D(reflectivitySampler,vUV);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {gl_FragColor=color;return;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\n#ifdef SSR_BLEND_WITH_FRESNEL\nvec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz;float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;\n#ifdef SSRAYTRACE_SCREENSPACE_DEPTH\ndepth=linearizeDepth(depth,nearPlaneZ,farPlaneZ);\n#endif\nvec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);vec3 csViewDirection=normalize(csPosition);vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#endif\nvec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,color.a);\n#endif\n}\n";s.l.ShadersStore[r]=n;const a={name:r,shader:n}},8438:(e,t,i)=>{"use strict";i.r(t),i.d(t,{sharpenPixelShader:()=>n});const s="sharpenPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 sharpnessAmounts;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 color=texture2D(textureSampler,vUV);vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1)) -\ncolor*4.0;gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},5363:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ssao2PixelShader:()=>n});const s="ssao2PixelShader",r="precision highp float;uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nfloat scales[16]=float[16](\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);uniform float near;uniform float radius;uniform sampler2D depthSampler;uniform sampler2D randomSampler;uniform sampler2D normalSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float base;uniform float xViewport;uniform float yViewport;uniform mat3 depthProjection;uniform float maxZ;uniform float minZAspect;uniform vec2 texelSize;uniform mat4 projection;void main()\n{vec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;float depth=textureLod(depthSampler,vUV,0.0).r;float depthSign=sign(depth);depth=depth*depthSign;vec3 normal=textureLod(normalSampler,vUV,0.0).rgb;float occlusion=0.0;float correctedRadius=min(radius,minZAspect*depth/near);vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);vec3 origin=vViewRay*vDepthFactor;vec3 rvec=random*2.0-1.0;rvec.z=0.0;float dotProduct=dot(rvec,normal);rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);vec3 tangent=normalize(rvec-normal*dot(rvec,normal));vec3 bitangent=cross(normal,tangent);mat3 tbn=mat3(tangent,bitangent,normal);float difference;for (int i=0; i<SAMPLES; ++i) {vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;vec4 offset=vec4(samplePosition,1.0);offset=projection*offset;offset.xyz/=offset.w;offset.xy=offset.xy*0.5+0.5;if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}\nfloat sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}\nocclusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor=vec4(vec3(result),1.0);}\n#endif\n#ifdef BLUR\nuniform float outSize;uniform float soften;uniform float tolerance;uniform int samples;\n#ifndef BLUR_BYPASS\nuniform sampler2D depthSampler;\n#ifdef BLUR_LEGACY\n#define inline\nfloat blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {float result=0.0;vec2 off1=vec2(1.411764705882353)*step;vec2 off2=vec2(3.2941176470588234)*step;vec2 off3=vec2(5.176470588235294)*step;float compareDepth=abs(textureLod(depthSampler,uv,0.0).r);float sampleDepth;float weight;float weightSum=30.0;result+=textureLod(image,uv,0.0).r*30.0;sampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv+off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv-off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off3,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off3,0.0).r*weight;return result/weightSum;}\n#endif\n#endif\nvoid main()\n{float result=0.0;\n#ifdef BLUR_BYPASS\nresult=textureLod(textureSampler,vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvec2 step=vec2(1.0/outSize,0.0);\n#else\nvec2 step=vec2(0.0,1.0/outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,vUV,step);\n#else\nfloat compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);float weightSum=0.0;for (int i=-samples; i<samples; i+=2)\n{vec2 samplePos=vUV+step*(float(i)+0.5);float sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);float falloff=smoothstep(0.0,\nfloat(samples),\nfloat(samples)-abs(float(i))*soften);float minDivider=tolerance*0.5+0.003;float weight=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureLod(textureSampler,samplePos,0.0).r*weight;weightSum+=weight;}\nresult/=weightSum;\n#endif\n#endif\ngl_FragColor.rgb=vec3(result);gl_FragColor.a=1.0;}\n#endif\n";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},4154:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ssaoCombinePixelShader:()=>n});const s="ssaoCombinePixelShader",r="uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);vec4 sceneColor=texture2D(originalColor,vUV);gl_FragColor=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},7985:(e,t,i)=>{"use strict";i.r(t),i.d(t,{tonemapPixelShader:()=>n});const s="tonemapPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;const float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{return dot(c,vec3(0.22,0.707,0.071));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;float scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;const float ExposureBias=2.0;vec3 x=ExposureBias*colour;vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x=vec3(W,W,W);vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},1830:(e,t,i)=>{"use strict";i.r(t),i.d(t,{vrDistortionCorrectionPixelShader:()=>n});const s="vrDistortionCorrectionPixelShader",r="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 LensCenter;uniform vec2 Scale;uniform vec2 ScaleIn;uniform vec4 HmdWarpParam;vec2 HmdWarp(vec2 in01) {vec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);return LensCenter+Scale*rvector;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 tc=HmdWarp(vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,0.0);else{gl_FragColor=texture2D(textureSampler,tc);}}";i(9610).l.ShadersStore[s]=r;const n={name:s,shader:r}},5877:(e,t,i)=>{"use strict";i.d(t,{h:()=>s});class s{}s._IsPickingAvailable=!1},9794:(e,t,i)=>{"use strict";i.d(t,{Z:()=>Z});var s=i(998),r=i(6237),n=i(9848),a=i(7931);class o{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach(((e,t)=>this.add(e,t)))}get(e){const t=this._data[e];if(void 0!==t)return t}getOrAddWithFactory(e,t){let i=this.get(e);return void 0!==i||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return void 0!==i?i:(this.add(e,t),t)}contains(e){return void 0!==this._data[e]}add(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)}set(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}remove(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data)e(t,this._data[t])}first(e){for(const t in this._data){const i=e(t,this._data[t]);if(i)return i}return null}}var l=i(7503),h=i(9923),c=i(1088),u=i(935),d=i(311);class _{constructor(e,t,i,s,r,n){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=s,this.sourceEvent=r,this.additionalData=n}static CreateNew(e,t,i){const s=e.getScene();return new _(e,s.pointerX,s.pointerY,s.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,s){return new _(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,s)}static CreateNewFromScene(e,t){return new _(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,s){return new _(e,t.x,t.y,null,i,s)}}var p=i(6096),f=i(3099),m=i(6945),g=i(8790),v=i(6315),b=i(5503),x=i(6240);class S{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1,this.disposeWhenUnowned=!0}static get HasTriggers(){for(const e in S.Triggers)if(Object.prototype.hasOwnProperty.call(S.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in S.Triggers)if(Object.prototype.hasOwnProperty.call(S.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in S.Triggers)if(Object.prototype.hasOwnProperty.call(S.Triggers,t)&&parseInt(t)===e)return!0;return!1}}S.Triggers={};var T,y,C,P,E,A,R,I=i(4146);!function(e){e[e.Generic=0]="Generic",e[e.Keyboard=1]="Keyboard",e[e.Mouse=2]="Mouse",e[e.Touch=3]="Touch",e[e.DualShock=4]="DualShock",e[e.Xbox=5]="Xbox",e[e.Switch=6]="Switch",e[e.DualSense=7]="DualSense"}(T||(T={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.Move=12]="Move"}(y||(y={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.DeltaHorizontal=10]="DeltaHorizontal",e[e.DeltaVertical=11]="DeltaVertical"}(C||(C={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(P||(P={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Create=8]="Create",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(E||(E={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.LT=6]="LT",e[e.RT=7]="RT",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.LStickXAxis=17]="LStickXAxis",e[e.LStickYAxis=18]="LStickYAxis",e[e.RStickXAxis=19]="RStickXAxis",e[e.RStickYAxis=20]="RStickYAxis"}(A||(A={})),function(e){e[e.B=0]="B",e[e.A=1]="A",e[e.Y=2]="Y",e[e.X=3]="X",e[e.L=4]="L",e[e.R=5]="R",e[e.ZL=6]="ZL",e[e.ZR=7]="ZR",e[e.Minus=8]="Minus",e[e.Plus=9]="Plus",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.Capture=17]="Capture",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(R||(R={}));var M=i(8123);class O{static CreateDeviceEvent(e,t,i,s,r,n,a){switch(e){case T.Keyboard:return this._CreateKeyboardEvent(i,s,r,n);case T.Mouse:if(i===y.MouseWheelX||i===y.MouseWheelY||i===y.MouseWheelZ)return this._CreateWheelEvent(e,t,i,s,r,n);case T.Touch:return this._CreatePointerEvent(e,t,i,s,r,n,a);default:throw`Unable to generate event for device ${T[e]}`}}static _CreatePointerEvent(e,t,i,s,r,n,a){const o=this._CreateMouseEvent(e,t,i,s,r,n);e===T.Mouse?(o.deviceType=T.Mouse,o.pointerId=1,o.pointerType="mouse"):(o.deviceType=T.Touch,o.pointerId=a??t,o.pointerType="touch");let l=0;return l+=r.pollInput(e,t,y.LeftClick),l+=2*r.pollInput(e,t,y.RightClick),l+=4*r.pollInput(e,t,y.MiddleClick),o.buttons=l,i===y.Move?o.type="pointermove":i>=y.LeftClick&&i<=y.RightClick&&(o.type=1===s?"pointerdown":"pointerup",o.button=i-2),o}static _CreateWheelEvent(e,t,i,s,r,n){const a=this._CreateMouseEvent(e,t,i,s,r,n);switch(a.pointerId=1,a.type="wheel",a.deltaMode=M.s.DOM_DELTA_PIXEL,a.deltaX=0,a.deltaY=0,a.deltaZ=0,i){case y.MouseWheelX:a.deltaX=s;break;case y.MouseWheelY:a.deltaY=s;break;case y.MouseWheelZ:a.deltaZ=s}return a}static _CreateMouseEvent(e,t,i,s,r,n){const a=this._CreateEvent(n),o=r.pollInput(e,t,y.Horizontal),l=r.pollInput(e,t,y.Vertical);return n?(a.movementX=0,a.movementY=0,a.offsetX=a.movementX-n.getBoundingClientRect().x,a.offsetY=a.movementY-n.getBoundingClientRect().y):(a.movementX=r.pollInput(e,t,10),a.movementY=r.pollInput(e,t,11),a.offsetX=0,a.offsetY=0),this._CheckNonCharacterKeys(a,r),a.clientX=o,a.clientY=l,a.x=o,a.y=l,a.deviceType=e,a.deviceSlot=t,a.inputIndex=i,a}static _CreateKeyboardEvent(e,t,i,s){const r=this._CreateEvent(s);return this._CheckNonCharacterKeys(r,i),r.deviceType=T.Keyboard,r.deviceSlot=0,r.inputIndex=e,r.type=1===t?"keydown":"keyup",r.key=String.fromCharCode(e),r.keyCode=e,r}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(T.Keyboard),s=i&&1===t.pollInput(T.Keyboard,0,18),r=i&&1===t.pollInput(T.Keyboard,0,17),n=i&&(1===t.pollInput(T.Keyboard,0,91)||1===t.pollInput(T.Keyboard,0,92)||1===t.pollInput(T.Keyboard,0,93)),a=i&&1===t.pollInput(T.Keyboard,0,16);e.altKey=s,e.ctrlKey=r,e.metaKey=n,e.shiftKey=a}static _CreateEvent(e){const t={preventDefault:()=>{}};return t.target=e,t}}class w{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,((e,t,s,r)=>{const n=O.CreateDeviceEvent(e,t,s,r,this);i(e,t,n)})):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===T.Mouse||e===T.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const D=Object.keys(y).length/2;class F{constructor(e,t,i,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=s.S0.IsSafari(),this._usingMacOS=(0,g.XD)()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._pointerMacOSChromeOutEvent=e=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=(0,g.XD)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._isUsingChromium=(0,g.XD)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Chrome"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=s.S0.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=r,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const r=this._inputs[e][t];if(!r)throw`Unable to find device ${T[e]}`;e>=T.DualShock&&e<=T.DualSense&&this._updateDevice(e,t,i);const n=r[i];if(void 0===n)throw`Unable to find input ${i} for device ${T[e]} in slot ${t}`;return i===y.Move&&s.S0.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),n}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=this?._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(const e of this._inputs)if(e)for(const t in e){const i=e[+t];if(i)for(let e=0;e<i.length;e++)i[e]=0}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOS&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(T.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,s){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,D);const r=this._inputs[e][t];r[0]=i,r[1]=s}_registerDevice(e,t,i){if(void 0===t)throw`Unable to register device ${T[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const s=new Array(i);s.fill(0),this._inputs[e][t]=s,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(T.Keyboard,0,255));const t=this._inputs[T.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&"Meta"!==e.key&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(T.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(T.Keyboard,0,255));const t=this._inputs[T.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&"Meta"===e.key&&this._metaKeys.length>0){for(const e of this._metaKeys){const i=O.CreateDeviceEvent(T.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(T.Keyboard,0,i)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(T.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[T.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;const i=O.CreateDeviceEvent(T.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(T.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=(0,g.XD)()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{const t=this._getPointerType(e);let i=t===T.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===T.Touch&&-1===i){const r=this._activeTouchIds.indexOf(-1);if(!(r>=0))return void s.S0.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=r,this._activeTouchIds[r]=e.pointerId,this._onDeviceConnected(t,i)}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]||this._addPointerDevice(t,i,e.clientX,e.clientY);const r=this._inputs[t][i];if(r){const s=e;s.inputIndex=y.Move,r[y.Horizontal]=e.clientX,r[y.Vertical]=e.clientY,t===T.Touch&&0===r[y.LeftClick]&&(r[y.LeftClick]=1),void 0===e.pointerId&&(e.pointerId=this._mouseId),this._onInputChanged(t,i,s),this._usingSafari||-1===e.button||(s.inputIndex=e.button+2,r[e.button+2]=r[e.button+2]?0:1,this._onInputChanged(t,i,s))}},this._pointerDownEvent=e=>{const t=this._getPointerType(e);let i=t===T.Mouse?0:e.pointerId;if(t===T.Touch){let t=this._activeTouchIds.indexOf(e.pointerId);if(-1===t&&(t=this._activeTouchIds.indexOf(-1)),!(t>=0))return void s.S0.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=t,this._activeTouchIds[t]=e.pointerId}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]?t===T.Touch&&this._onDeviceConnected(t,i):this._addPointerDevice(t,i,e.clientX,e.clientY);const r=this._inputs[t][i];if(r){const s=r[y.Horizontal],n=r[y.Vertical];if(t===T.Mouse){if(void 0===e.pointerId&&(e.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(e){}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId)}catch(e){}r[y.Horizontal]=e.clientX,r[y.Vertical]=e.clientY,r[e.button+2]=1;const a=e;a.inputIndex=e.button+2,this._onInputChanged(t,i,a),s===e.clientX&&n===e.clientY||(a.inputIndex=y.Move,this._onInputChanged(t,i,a))}},this._pointerUpEvent=e=>{const t=this._getPointerType(e),i=t===T.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===T.Touch){if(-1===i)return;this._activeTouchIds[i]=-1}const s=this._inputs[t]?.[i];if(s&&0!==s[e.button+2]){const r=s[y.Horizontal],n=s[y.Vertical];s[y.Horizontal]=e.clientX,s[y.Vertical]=e.clientY,s[e.button+2]=0;const a=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),r===e.clientX&&n===e.clientY||(a.inputIndex=y.Move,this._onInputChanged(t,i,a)),a.inputIndex=e.button+2,t===T.Mouse&&this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&this._elementToAttachTo.hasPointerCapture?.(e.pointerId)&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(t,i,a),t===T.Touch&&this._onDeviceDisconnected(t,i)}},this._pointerCancelEvent=e=>{if("mouse"===e.pointerType){const e=this._inputs[T.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=y.LeftClick;t<=y.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=O.CreateDeviceEvent(T.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(T.Mouse,0,i)}}else{const t=this._activeTouchIds.indexOf(e.pointerId);if(-1===t)return;this._elementToAttachTo.hasPointerCapture?.(e.pointerId)&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._inputs[T.Touch][t][y.LeftClick]=0;const i=O.CreateDeviceEvent(T.Touch,t,y.LeftClick,0,this,this._elementToAttachTo,e.pointerId);this._onInputChanged(T.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(T.Touch,t)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch(e){}this._pointerBlurEvent=()=>{if(this.isDeviceAvailable(T.Mouse)){const e=this._inputs[T.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=y.LeftClick;t<=y.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=O.CreateDeviceEvent(T.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(T.Mouse,0,i)}}if(this.isDeviceAvailable(T.Touch)){const e=this._inputs[T.Touch];for(let t=0;t<this._activeTouchIds.length;t++){const i=this._activeTouchIds[t];if(this._elementToAttachTo.hasPointerCapture?.(i)&&this._elementToAttachTo.releasePointerCapture(i),-1!==i&&1===e[t]?.[y.LeftClick]){e[t][y.LeftClick]=0;const s=O.CreateDeviceEvent(T.Touch,t,y.LeftClick,0,this,this._elementToAttachTo,i);this._onInputChanged(T.Touch,t,s),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(T.Touch,t)}}}},this._pointerWheelEvent=e=>{const t=T.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=!0,this._registerDevice(t,0,D));const i=this._inputs[t][0];if(i){i[y.MouseWheelX]=e.deltaX||0,i[y.MouseWheelY]=e.deltaY||e.wheelDelta||0,i[y.MouseWheelZ]=e.deltaZ||0;const s=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),0!==i[y.MouseWheelX]&&(s.inputIndex=y.MouseWheelX,this._onInputChanged(t,0,s)),0!==i[y.MouseWheelY]&&(s.inputIndex=y.MouseWheelY,this._onInputChanged(t,0,s)),0!==i[y.MouseWheelZ]&&(s.inputIndex=y.MouseWheelZ,this._onInputChanged(t,0,s))}},this._usingMacOS&&this._isUsingChromium&&(this._pointerMacOSChromeOutEvent=e=>{e.buttons>1&&this._pointerCancelEvent(e)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add((()=>{if(this.isDeviceAvailable(T.Mouse)){const e=this._inputs[T.Mouse][0];e[y.MouseWheelX]=0,e[y.MouseWheelY]=0,e[y.MouseWheelZ]=0}}))}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const s=navigator.getGamepads()[t];if(s&&e===this._gamepads[t]){const r=this._inputs[e][t];i>=s.buttons.length?r[i]=s.axes[i-s.buttons.length].valueOf():r[i]=s.buttons[i].value}}_getGamepadDeviceType(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?T.DualSense:T.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?T.Xbox:-1!==e.indexOf("057e")?T.Switch:T.Generic}_getPointerType(e){let t=T.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=T.Touch),t}}class N{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new n.cP,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class L{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){const i=this._devices[t];for(const s in i){const i=+s;e._addDevice(new N(this._deviceInputSystem,t,i))}}this._registeredManagers.push(e)},this.unregisterManager=e=>{const t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1)};const t=Object.keys(T).length/2;this._devices=new Array(t);const i=(e,t)=>{this._devices[e]||(this._devices[e]=new Array),this._devices[e][t]||(this._devices[e][t]=t);for(const i of this._registeredManagers){const s=new N(this._deviceInputSystem,e,t);i._addDevice(s)}},s=(e,t)=>{this._devices[e]?.[t]&&delete this._devices[e][t];for(const i of this._registeredManagers)i._removeDevice(e,t)},r=(e,t,i)=>{if(i)for(const s of this._registeredManagers)s._onInputChanged(e,t,i)};"undefined"!=typeof _native?this._deviceInputSystem=new w(i,s,r):this._deviceInputSystem=new F(e,i,s,r)}dispose(){this._deviceInputSystem.dispose()}}class B{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter((e=>!!e)):[]}constructor(e){const t=Object.keys(T).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new L(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new n.cP((e=>{for(const t of this._devices)if(t)for(const i of t)i&&this.onDeviceConnectedObservable.notifyObserver(e,i)})),this.onDeviceDisconnectedObservable=new n.cP,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add((()=>{this.dispose()}))}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){const i=this._devices[e]?.[t];this.onDeviceDisconnectedObservable.notifyObservers(i),this._devices[e]?.[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){this._devices[e]?.[t]?.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case T.Keyboard:case T.Mouse:this._firstDevice[e]=0;break;case T.Touch:case T.DualSense:case T.DualShock:case T.Xbox:case T.Switch:case T.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t)for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}break}}}}var k=i(5877);class V{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class U{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new h.I9(0,0),this._previousStartingPointerPosition=new h.I9(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||v.q.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new h.I9(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,s=i.getEngine(),r=s.getInputElement();r&&(r.tabIndex=s.canvasTabIndex,i.doNotHandleCursors||(r.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const s of i._pointerMoveStage){e=e||this._pickMove(t);const i=!!e?.pickedMesh;e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,i,r)}const n=t.inputIndex>=y.MouseWheelX&&t.inputIndex<=y.MouseWheelZ?x.Zp.POINTERWHEEL:x.Zp.POINTERMOVE;let a;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,n)),e?(a=new x.mx(n,t,e),this._setRayOnPointerInfo(e,t)):(a=new x.mx(n,t,null,this),this._movePointerInfo=a),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(a,n)}_setRayOnPointerInfo(e,t){const i=this._scene;e&&k.h._IsPickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,h.uq.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const s=this._scene,r=new x.tT(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(r.originalPickingInfo=e,r.ray=e.ray,"xr-near"===t.pointerType&&e.originMesh&&(r.nearInteractionPickingInfo=e)),s.onPrePointerObservable.notifyObservers(r,i),!!r.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const s=i.getEngine().getInputElement();if(e?.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&s&&this._pointerOverMesh){const e=this._pointerOverMesh._getActionManagerForTrigger();e&&e.hasPointerTriggers&&(s.style.cursor=e.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=y.Move,this._checkPrePointerObservable(e,i,x.Zp.POINTERMOVE)||this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,this._checkPrePointerObservable(e,i,x.Zp.POINTERDOWN)||this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(e?.pickedMesh){this._pickedDownMesh=e.pickedMesh;const s=e.pickedMesh._getActionManagerForTrigger();if(s){if(s.hasPickTriggers)switch(s.processTrigger(5,_.CreateNew(e.pickedMesh,t,e)),t.button){case 0:s.processTrigger(2,_.CreateNew(e.pickedMesh,t,e));break;case 1:s.processTrigger(4,_.CreateNew(e.pickedMesh,t,e));break;case 2:s.processTrigger(3,_.CreateNew(e.pickedMesh,t,e))}s.hasSpecificTrigger(8)&&window.setTimeout((()=>{const e=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,(e=>e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(8)&&e===this._pickedDownMesh),!1,i.cameraToUseForPointers);e?.pickedMesh&&s&&0!==this._totalPointersPressed&&Date.now()-this._startingPointerTime>U.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,s.processTrigger(8,_.CreateNew(e.pickedMesh,t)))}),U.LongPressDelay)}}else for(const s of i._pointerDownStage)e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let s;const r=x.Zp.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,r),s=new x.mx(r,t,e),this._setRayOnPointerInfo(e,t)):s=new x.mx(r,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(s,r)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const s=new PointerEvent("pointerup",t);s.inputIndex=y.Move;const r=new V;i?r.doubleClick=!0:r.singleClick=!0,this._checkPrePointerObservable(e,s,x.Zp.POINTERUP)||this._processPointerUp(e,s,r)}_processPointerUp(e,t,i){const s=this._scene;if(e?.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(s.onPointerPick&&s.onPointerPick(t,e),i.singleClick&&!i.ignore&&s.onPointerObservable.observers.length>this._cameraObserverCount)){const i=x.Zp.POINTERPICK,r=new x.mx(i,t,e);this._setRayOnPointerInfo(e,t),s.onPointerObservable.notifyObservers(r,i)}const r=e.pickedMesh._getActionManagerForTrigger();if(r&&!i.ignore){r.processTrigger(7,_.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&r.processTrigger(1,_.CreateNew(e.pickedMesh,t,e));const s=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&s&&s.processTrigger(6,_.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const r of s._pointerUpStage)e=r.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const e=this._pickedDownMesh._getActionManagerForTrigger(16);e&&e.processTrigger(16,_.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){const r=new x.mx(x.Zp.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),s.onPointerObservable.notifyObservers(r,x.Zp.POINTERUP),s.onPointerUp&&s.onPointerUp(t,e,x.Zp.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let r=0;if(i.singleClick?r=x.Zp.POINTERTAP:i.doubleClick&&(r=x.Zp.POINTERDOUBLETAP),r){const i=new x.mx(r,t,e);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(r)&&s.onPointerObservable.notifyObservers(i,r)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,s=null){const r=this._scene,n=r.getEngine();s||(s=n.getInputElement()),this._alreadyAttached&&this.detachControl(),s&&(this._alreadyAttachedTo=s),this._deviceSourceManager=new B(n),this._initActionManager=e=>{if(!this._meshPickProceed){const t=r.skipPointerUpPicking||0===r._registeredActions&&!this._checkForPicking()&&!r.onPointerUp?null:r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerUpPredicate,r.pointerUpFastCheck,r.cameraToUseForPointers,r.pointerUpTrianglePredicate);this._currentPickResult=t,t&&(e=t.hit&&t.pickedMesh?t.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return e},this._delayedSimpleClick=(e,t,i)=>{if((Date.now()-this._previousStartingPointerTime>U.DoubleClickDelay&&!this._doubleClickOccured||e!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,t.singleClick=!0,t.ignore=!1,this._delayedClicks[e])){const t=this._delayedClicks[e].evt,i=x.Zp.POINTERTAP,s=new x.mx(i,t,this._currentPickResult);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(i)&&r.onPointerObservable.notifyObservers(s,i),this._delayedClicks[e]=null}},this._initClickEvent=(e,t,i,s)=>{const r=new V;this._currentPickResult=null;let n=null,a=e.hasSpecificMask(x.Zp.POINTERPICK)||t.hasSpecificMask(x.Zp.POINTERPICK)||e.hasSpecificMask(x.Zp.POINTERTAP)||t.hasSpecificMask(x.Zp.POINTERTAP)||e.hasSpecificMask(x.Zp.POINTERDOUBLETAP)||t.hasSpecificMask(x.Zp.POINTERDOUBLETAP);!a&&S&&(n=this._initActionManager(n,r),n&&(a=n.hasPickTriggers));let o=!1;if(a){const a=i.button;if(r.hasSwiped=this._isPointerSwiping(),!r.hasSwiped){let l=!U.ExclusiveDoubleClickMode;if(l||(l=!e.hasSpecificMask(x.Zp.POINTERDOUBLETAP)&&!t.hasSpecificMask(x.Zp.POINTERDOUBLETAP),l&&!S.HasSpecificTrigger(6)&&(n=this._initActionManager(n,r),n&&(l=!n.hasSpecificTrigger(6)))),l)(Date.now()-this._previousStartingPointerTime>U.DoubleClickDelay||a!==this._previousButtonPressed)&&(r.singleClick=!0,s(r,this._currentPickResult),o=!0);else{const e={evt:i,clickInfo:r,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,a,r,s),U.DoubleClickDelay)};this._delayedClicks[a]=e}let h=e.hasSpecificMask(x.Zp.POINTERDOUBLETAP)||t.hasSpecificMask(x.Zp.POINTERDOUBLETAP);!h&&S.HasSpecificTrigger(6)&&(n=this._initActionManager(n,r),n&&(h=n.hasSpecificTrigger(6))),h&&(a===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<U.DoubleClickDelay&&!this._doubleClickOccured?(r.hasSwiped||this._isPointerSwiping()?(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=a,U.ExclusiveDoubleClickMode?(this._delayedClicks[a]&&(clearTimeout(this._delayedClicks[a]?.timeoutId),this._delayedClicks[a]=null),s(r,this._previousPickResult)):s(r,this._currentPickResult)):(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,r.doubleClick=!0,r.ignore=!1,U.ExclusiveDoubleClickMode&&this._delayedClicks[a]&&(clearTimeout(this._delayedClicks[a]?.timeoutId),this._delayedClicks[a]=null),s(r,this._currentPickResult)),o=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=a))}}o||s(r,this._currentPickResult)},this._onPointerMove=e=>{if(this._updatePointerPosition(e),this._isSwiping||-1===this._swipeButtonPressed||(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>U.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>U.DragMovementThreshold),n.isPointerLock&&n._verifyPointerLock(),this._checkPrePointerObservable(null,e,e.inputIndex>=y.MouseWheelX&&e.inputIndex<=y.MouseWheelZ?x.Zp.POINTERWHEEL:x.Zp.POINTERMOVE))return;if(!r.cameraToUseForPointers&&!r.activeCamera)return;if(r.skipPointerMovePicking)return void this._processPointerMove(new d.G,e);r.pointerMovePredicate||(r.pointerMovePredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||r.constantlyUpdateMeshUnderPointer||null!==e._getActionManagerForTrigger())&&(!r.cameraToUseForPointers||!!(r.cameraToUseForPointers.layerMask&e.layerMask)));const t=r._registeredActions>0||r.constantlyUpdateMeshUnderPointer?this._pickMove(e):null;this._processPointerMove(t,e)},this._onPointerDown=e=>{if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,U.ExclusiveDoubleClickMode)for(let t=0;t<this._delayedClicks.length;t++)if(this._delayedClicks[t])if(e.button===t)clearTimeout(this._delayedClicks[t]?.timeoutId);else{const e=this._delayedClicks[t].clickInfo;this._doubleClickOccured=!1,e.singleClick=!0,e.ignore=!1;const i=this._delayedClicks[t].evt,s=x.Zp.POINTERTAP,n=new x.mx(s,i,this._currentPickResult);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(s)&&r.onPointerObservable.notifyObservers(n,s),this._delayedClicks[t]=null}if(this._updatePointerPosition(e),-1===this._swipeButtonPressed&&(this._swipeButtonPressed=e.button),r.preventDefaultOnPointerDown&&s&&(e.preventDefault(),s.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,e,x.Zp.POINTERDOWN))return;if(!r.cameraToUseForPointers&&!r.activeCamera)return;let t;this._pointerCaptures[e.pointerId]=!0,r.pointerDownPredicate||(r.pointerDownPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!r.cameraToUseForPointers||!!(r.cameraToUseForPointers.layerMask&e.layerMask))),this._pickedDownMesh=null,t=r.skipPointerDownPicking||0===r._registeredActions&&!this._checkForPicking()&&!r.onPointerDown?new d.G:r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerDownPredicate,r.pointerDownFastCheck,r.cameraToUseForPointers,r.pointerDownTrianglePredicate),this._processPointerDown(t,e)},this._onPointerUp=e=>{0!==this._totalPointersPressed&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(e),r.preventDefaultOnPointerUp&&s&&(e.preventDefault(),s.focus()),this._initClickEvent(r.onPrePointerObservable,r.onPointerObservable,e,((t,i)=>{if(r.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!t.ignore)){if(this._checkPrePointerObservable(null,e,x.Zp.POINTERUP))return this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),void(0===e.buttons&&(this._pointerCaptures[e.pointerId]=!1));t.hasSwiped||(t.singleClick&&r.onPrePointerObservable.hasSpecificMask(x.Zp.POINTERTAP)&&this._checkPrePointerObservable(null,e,x.Zp.POINTERTAP)&&(this._skipPointerTap=!0),t.doubleClick&&r.onPrePointerObservable.hasSpecificMask(x.Zp.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,e,x.Zp.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}this._pointerCaptures[e.pointerId]?(0===e.buttons&&(this._pointerCaptures[e.pointerId]=!1),(r.cameraToUseForPointers||r.activeCamera)&&(r.pointerUpPredicate||(r.pointerUpPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!r.cameraToUseForPointers||!!(r.cameraToUseForPointers.layerMask&e.layerMask))),!this._meshPickProceed&&(S&&S.HasTriggers||this._checkForPicking()||r.onPointerUp)&&this._initActionManager(null,t),i||(i=this._currentPickResult),this._processPointerUp(i,e,t),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))):this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1)})))},this._onKeyDown=e=>{const t=I.TB.KEYDOWN;if(r.onPreKeyboardObservable.hasObservers()){const i=new I.Bu(t,e);if(r.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const i=new I.W0(t,e);r.onKeyboardObservable.notifyObservers(i,t)}r.actionManager&&r.actionManager.processTrigger(14,_.CreateNewFromScene(r,e))},this._onKeyUp=e=>{const t=I.TB.KEYUP;if(r.onPreKeyboardObservable.hasObservers()){const i=new I.Bu(t,e);if(r.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const i=new I.W0(t,e);r.onKeyboardObservable.notifyObservers(i,t)}r.actionManager&&r.actionManager.processTrigger(15,_.CreateNewFromScene(r,e))},this._deviceSourceManager.onDeviceConnectedObservable.add((s=>{s.deviceType===T.Mouse?s.onInputChangedObservable.add((r=>{this._originMouseEvent=r,r.inputIndex===y.LeftClick||r.inputIndex===y.MiddleClick||r.inputIndex===y.RightClick||r.inputIndex===y.BrowserBack||r.inputIndex===y.BrowserForward?t&&1===s.getInput(r.inputIndex)?this._onPointerDown(r):e&&0===s.getInput(r.inputIndex)&&this._onPointerUp(r):i&&(r.inputIndex===y.Move?this._onPointerMove(r):r.inputIndex!==y.MouseWheelX&&r.inputIndex!==y.MouseWheelY&&r.inputIndex!==y.MouseWheelZ||this._onPointerMove(r))})):s.deviceType===T.Touch?s.onInputChangedObservable.add((r=>{r.inputIndex===y.LeftClick&&(t&&1===s.getInput(r.inputIndex)?(this._onPointerDown(r),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):e&&0===s.getInput(r.inputIndex)&&(this._onPointerUp(r),0===this._totalPointersPressed&&(this._isMultiTouchGesture=!1))),i&&r.inputIndex===y.Move&&this._onPointerMove(r)})):s.deviceType===T.Keyboard&&s.onInputChangedObservable.add((e=>{"keydown"===e.type?this._onKeyDown(e):"keyup"===e.type&&this._onKeyUp(e)}))})),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,s){if(!(this._meshUnderPointerId[t]!==e||e&&e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const r=this._meshUnderPointerId[t];let n;r&&(n=r._getActionManagerForTrigger(10),n&&n.processTrigger(10,_.CreateNew(r,s,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,n=e._getActionManagerForTrigger(9),n&&n.processTrigger(9,_.CreateNew(e,s,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}U.DragMovementThreshold=10,U.LongPressDelay=500,U.DoubleClickDelay=300,U.ExclusiveDoubleClickMode=!1;var z=i(4296),G=i(6041),H=i(2572),W=i(2678),X=i(655),K=i(5515),Q=i(7309);class Y{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}}var q,$=i(1137),j=i(6552);!function(e){e[e.BackwardCompatible=0]="BackwardCompatible",e[e.Intermediate=1]="Intermediate",e[e.Aggressive=2]="Aggressive"}(q||(q={}));class Z{static DefaultMaterialFactory(e){throw(0,b.n)("StandardMaterial")}static CollisionCoordinatorFactory(){throw(0,b.n)("DefaultCollisionCoordinator")}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case 0:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case 1:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case 2:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach((t=>e=e.concat(t.bones))),e}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return U.DragMovementThreshold}static set DragMovementThreshold(e){U.DragMovementThreshold=e}static get LongPressDelay(){return U.LongPressDelay}static set LongPressDelay(e){U.LongPressDelay=e}static get DoubleClickDelay(){return U.DoubleClickDelay}static set DoubleClickDelay(e){U.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return U.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){U.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){const s=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera.globalPosition,r=this.useRightHandedSystem===(null!=this._mirroredCameraPosition);return h.AA.Vector4[0].set(s.x,s.y,s.z,r?-1:1),e&&(i?e.setFloat3(t,h.AA.Vector4[0].x,h.AA.Vector4[0].y,h.AA.Vector4[0].z):e.setVector4(t,h.AA.Vector4[0])),h.AA.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=(0,Q.lL)(e,(()=>{this.onActiveCamerasChanged.notifyObservers(this)}))),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=Z.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=Z.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}constructor(e,t){this._inputManager=new U(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new G.ov(.2,.2,.3,1),this.ambientColor=new G.v9(0,0,0),this.environmentIntensity=1,this._performancePriority=0,this.onScenePerformancePriorityChangedObservable=new n.cP,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.effectLayers=[],this.sounds=null,this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new n.cP,this._onDisposeObserver=null,this.onBeforeRenderObservable=new n.cP,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new n.cP,this.onAfterRenderCameraObservable=new n.cP,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new n.cP,this.onAfterAnimationsObservable=new n.cP,this.onBeforeDrawPhaseObservable=new n.cP,this.onAfterDrawPhaseObservable=new n.cP,this.onReadyObservable=new n.cP,this.onBeforeCameraRenderObservable=new n.cP,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new n.cP,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new n.cP,this.onAfterActiveMeshesEvaluationObservable=new n.cP,this.onBeforeParticlesRenderingObservable=new n.cP,this.onAfterParticlesRenderingObservable=new n.cP,this.onDataLoadedObservable=new n.cP,this.onNewCameraAddedObservable=new n.cP,this.onCameraRemovedObservable=new n.cP,this.onNewLightAddedObservable=new n.cP,this.onLightRemovedObservable=new n.cP,this.onNewGeometryAddedObservable=new n.cP,this.onGeometryRemovedObservable=new n.cP,this.onNewTransformNodeAddedObservable=new n.cP,this.onTransformNodeRemovedObservable=new n.cP,this.onNewMeshAddedObservable=new n.cP,this.onMeshRemovedObservable=new n.cP,this.onNewSkeletonAddedObservable=new n.cP,this.onSkeletonRemovedObservable=new n.cP,this.onNewMaterialAddedObservable=new n.cP,this.onNewMultiMaterialAddedObservable=new n.cP,this.onMaterialRemovedObservable=new n.cP,this.onMultiMaterialRemovedObservable=new n.cP,this.onNewTextureAddedObservable=new n.cP,this.onTextureRemovedObservable=new n.cP,this.onBeforeRenderTargetsRenderObservable=new n.cP,this.onAfterRenderTargetsRenderObservable=new n.cP,this.onBeforeStepObservable=new n.cP,this.onAfterStepObservable=new n.cP,this.onActiveCameraChanged=new n.cP,this.onActiveCamerasChanged=new n.cP,this.onBeforeRenderingGroupObservable=new n.cP,this.onAfterRenderingGroupObservable=new n.cP,this.onMeshImportedObservable=new n.cP,this.onAnimationFileImportedObservable=new n.cP,this._registeredForLateAnimationBindings=new a.b(256),this._pointerPickingConfiguration=new Y,this.onPrePointerObservable=new n.cP,this.onPointerObservable=new n.cP,this.onPreKeyboardObservable=new n.cP,this.onKeyboardObservable=new n.cP,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=Z.FOGMODE_NONE,this.fogColor=new G.v9(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new h.Pq(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new a.b(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new z.A,this._activeIndices=new z.A,this._activeParticles=new z.A,this._activeBones=new z.A,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new a.L(256),this._processedMaterials=new a.L(256),this._renderTargets=new a.b(256),this._materialsRenderTargets=new a.b(256),this._activeParticleSystems=new a.L(256),this._activeSkeletons=new a.b(32),this._softwareSkinnedMeshes=new a.b(32),this._activeAnimatables=new Array,this._transformMatrix=h.uq.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=m.B.Create(),this._beforeClearStage=m.B.Create(),this._beforeRenderTargetClearStage=m.B.Create(),this._gatherRenderTargetsStage=m.B.Create(),this._gatherActiveCameraRenderTargetsStage=m.B.Create(),this._isReadyForMeshStage=m.B.Create(),this._beforeEvaluateActiveMeshStage=m.B.Create(),this._evaluateSubMeshStage=m.B.Create(),this._preActiveMeshStage=m.B.Create(),this._cameraDrawRenderTargetStage=m.B.Create(),this._beforeCameraDrawStage=m.B.Create(),this._beforeRenderTargetDrawStage=m.B.Create(),this._beforeRenderingGroupDrawStage=m.B.Create(),this._beforeRenderingMeshStage=m.B.Create(),this._afterRenderingMeshStage=m.B.Create(),this._afterRenderingGroupDrawStage=m.B.Create(),this._afterCameraDrawStage=m.B.Create(),this._afterCameraPostProcessStage=m.B.Create(),this._afterRenderTargetDrawStage=m.B.Create(),this._afterRenderTargetPostProcessStage=m.B.Create(),this._afterRenderStage=m.B.Create(),this._pointerMoveStage=m.B.Create(),this._pointerDownStage=m.B.Create(),this._pointerUpStage=m.B.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[];const i={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...t};e=this._engine=e||v.q.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):(v.q._LastCreatedScene=this,e.scenes.push(this)),this._uid=null,this._renderingManager=new f.m(this),p.X&&(this.postProcessManager=new p.X(this)),(0,g.BA)()&&this.attachControl(),this._createUbo(),c.p&&(this._imageProcessingConfiguration=new c.p),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,t&&t.virtual||e.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return void 0!==this._animationRatio?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){if(this._isDisposed)return!1;let t;const i=this.getEngine(),s=i.currentRenderPassId;i.currentRenderPassId=this.activeCamera?.renderPassId??s;let r=!0;for(this._pendingData.length>0&&(r=!1),this.prePassRenderer?.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&r&&(r=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){const s=this.meshes[t];if(!s.subMeshes||0===s.subMeshes.length)continue;if(!s.isReady(!0)){r=!1;continue}const n=s.hasThinInstances||"InstancedMesh"===s.getClassName()||"InstancedLinesMesh"===s.getClassName()||i.getCaps().instancedArrays&&s.instances.length>0;for(const e of this._isReadyForMeshStage)e.action(s,n)||(r=!1);if(!e)continue;const a=s.material||this.defaultMaterial;if(a)if(a._storeEffectOnSubMeshes)for(const e of s.subMeshes){const t=e.getMaterial();t&&t.hasRenderTargetTextures&&null!=t.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(t)&&(this._processedMaterials.push(t),this._materialsRenderTargets.concatWithNoDuplicate(t.getRenderTargetTextures()))}else a.hasRenderTargetTextures&&null!=a.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(a)&&(this._processedMaterials.push(a),this._materialsRenderTargets.concatWithNoDuplicate(a.getRenderTargetTextures()))}if(e)for(t=0;t<this._materialsRenderTargets.length;++t)this._materialsRenderTargets.data[t].isReadyForRendering()||(r=!1);for(t=0;t<this.geometries.length;t++)2===this.geometries[t].delayLoadState&&(r=!1);if(this.activeCameras&&this.activeCameras.length>0)for(const e of this.activeCameras)e.isReady(!0)||(r=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(r=!1));for(const e of this.particleSystems)e.isReady()||(r=!1);if(this.layers)for(const e of this.layers)e.isReady()||(r=!1);return i.areAllEffectsReady()||(r=!1),i.currentRenderPassId=s,r}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout((()=>{this.unregisterBeforeRender(t)}))};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){void 0!==t?setTimeout((()=>{this._executeOnceBeforeRender(e)}),t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);-1!==i&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise((t=>{this.executeWhenReady((()=>{t()}),e)}))}_checkIsReady(e=!1){return this._registerTransientComponents(),this.isReady(e)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):this._isDisposed?(this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):void(this._executeWhenReadyTimeoutId=setTimeout((()=>{this.incrementRenderId(),this._checkIsReady(e)}),100))}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=r.j.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,s){i||s||!this._multiviewSceneUbo||(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag||(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?H.P.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=H.P.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,s):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new u.D(this._engine,void 0,!1,e??"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return W.K.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach((e=>{this.addMesh(e)})))}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);return-1!==i&&(this.meshes.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach((e=>{this.removeMesh(e)})),i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneTransformNodesArray||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(-1!==t){if(t!==this.transformNodes.length-1){const e=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=e,e._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return-1!==t&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return-1!==t&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(-1!==t){for(const t of this.meshes)t._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(-1!==t&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const t=this.activeCameras.indexOf(e);-1!==t&&this.activeCameras.splice(t,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return-1!==t&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return-1!==t&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return-1!==t&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return-1!==t&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(-1!==t&&t<this.materials.length){if(t!==this.materials.length-1){const e=this.materials[this.materials.length-1];this.materials[t]=e,e._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return-1!==t&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return-1!==t&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)-1===t.lightSources.indexOf(e)&&(t.lightSources.push(e),t._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(K.c.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneMaterialArray||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let e=0;e<this.materials.length;e++){const i=this.materials[e];if(t(i))return i}if(e)for(let e=0;e<this.multiMaterials.length;e++){const i=this.multiMaterials[e];if(t(i))return i}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,(t=>t.uniqueId===e))}getMaterialById(e,t=!1){return this._getMaterial(t,(t=>t.id===e))}getMaterialByName(e,t=!1){return this._getMaterial(t,(t=>t.name===e))}getLastMaterialById(e,t=!1){for(let t=this.materials.length-1;t>=0;t--)if(this.materials[t].id===e)return this.materials[t];if(t)for(let t=this.multiMaterials.length-1;t>=0;t--)if(this.multiMaterials[t].id===e)return this.multiMaterials[t];return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].id===e)return i.bones[t]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].name===e)return i.bones[t]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(void 0!==t)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!(!t&&this._getGeometryByUniqueId(e.uniqueId)||(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),0))}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],void 0===t)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const e=this.geometries[this.geometries.length-1];e&&(this.geometries[t]=e,this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter((function(t){return t.id===e}))}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter((function(t){return t.id===e}))}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const s=this.getLightById(e);if(s)return s;const r=this.getCameraById(e);if(r)return r;return this.getBoneById(e)||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const s=this.getLightByName(e);if(s)return s;const r=this.getCameraByName(e);if(r)return r;return this.getBoneByName(e)||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){const s=i.getTarget(t);if(s.id===e)return s}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){const s=i.getTarget(t);if(s.name===e)return s}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}get uid(){return this._uid||(this._uid=s.S0.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new o),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new o),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,s){if(s||e.isInFrustum(this._frustumPlanes)){for(const i of this._evaluateSubMeshStage)i.action(t,e);const i=e.getMaterial();null!=i&&(i.hasRenderTargetTextures&&null!=i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._materialsRenderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,i))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,s=!0,r=!1){return this.executeWhenReady((()=>{if(this.activeCamera){if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=r,this._skipEvaluateActiveMeshesCompletely=e,s)for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._freeze();t&&t()}else i&&i("No active camera found")})),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce((()=>e.dispose()))}_evaluateActiveMeshes(){if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)return void(this._activeMeshes.length>0&&(this.activeCamera?._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset()));if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const e=this._activeMeshes.length;for(let t=0;t<e;t++)this._activeMeshes.data[t].computeWorldMatrix()}if(this._activeParticleSystems){const e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate()}return void this._renderingManager.resetSprites()}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const e of this._beforeEvaluateActiveMeshStage)e.action();const e=this.getActiveMeshCandidates(),t=e.length;for(let i=0;i<t;i++){const t=e.data[i];if(t._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,t.isBlocked)continue;if(this._totalVertices.addCount(t.getTotalVertices(),!1),!t.isReady()||!t.isEnabled()||t.scaling.hasAZeroComponent)continue;t.computeWorldMatrix(),t.actionManager&&t.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(t);let s=this.customLODSelector?this.customLODSelector(t,this.activeCamera):t.getLOD(this.activeCamera);if(t._internalAbstractMeshDataInfo._currentLOD=s,t._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,null!=s&&(s!==t&&0!==s.billboardMode&&s.computeWorldMatrix(),t._preActivate(),t.isVisible&&t.visibility>0&&t.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||t.alwaysSelectAsActiveMesh||t.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(t),this.activeCamera._activeMeshes.push(t),s!==t&&s._activate(this._renderId,!1);for(const e of this._preActiveMeshStage)e.action(t);t._activate(this._renderId,!1)&&(t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(s=t):s._internalAbstractMeshDataInfo._onlyForInstances=!1,s._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(t,s)),t._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let e=0;e<this.particleSystems.length;e++){const t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;const i=t.emitter;i.position&&!i.isEnabled()||(this._activeParticleSystems.push(t),t.animate(),this._renderingManager.dispatchParticles(t))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,t){this._skeletonsEnabled&&null!==t.skeleton&&void 0!==t.skeleton&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t));let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const s=this.getActiveSubMeshCandidates(t),r=s.length;i=i||1===r;for(let n=0;n<r;n++){const r=s.data[n];this._evaluateSubMesh(r,t,e,i)}}}updateTransformMatrix(e){const t=this.activeCamera;if(t)if(t._renderingMultiview){const i=t._rigCameras[0],s=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),s.getViewMatrix(),s.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(e&&e._multiviewTexture);else if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||e.isRightCamera||(this.autoClear&&this._engine.clear(t.clearColor||this.clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){if(e&&e._skipRendering)return;const r=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(r.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let t=!0;e._renderingMultiview&&e.outputRenderTarget&&(t=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=t)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let e=0;e<this._softwareSkinnedMeshes.length;e++){const t=this._softwareSkinnedMeshes.data[e];t.applySkeleton(t.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const e of this._gatherActiveCameraRenderTargetsStage)e.action(this._renderTargets);let n=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){s.S0.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let e=0;e<this._renderTargets.length;e++){const t=this._renderTargets.data[e];if(t._shouldRender()){this._renderId++;const e=t.activeCamera&&t.activeCamera!==this.activeCamera;t.render(e,this.dumpNextRenderTargets),n=!0}}s.S0.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const e of this._cameraDrawRenderTargetStage)n=e.action(this.activeCamera)||n;this._intermediateRendering=!1}this._engine.currentRenderPassId=e.outputRenderTarget?.renderPassId??e.renderPassId??0,n&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),!this.postProcessManager||e._multiviewTexture||this.prePass||this.postProcessManager._prepareFrame();for(const e of this._beforeCameraDrawStage)e.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),r.snapshotRendering&&1===r.snapshotRenderingMode&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const e of this._afterCameraDrawStage)e.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const t=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,t)}for(const e of this._afterCameraPostProcessStage)e.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(0===e.cameraRigMode||e._renderingMultiview)return e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),void this.onAfterRenderCameraObservable.notifyObservers(e);if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let t=0;t<e._rigCameras.length;t++)this._renderForCamera(e._rigCameras[t],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let e=0;t.actionManager&&e<t.actionManager.actions.length;e++){const i=t.actionManager.actions[e];if(12===i.trigger||13===i.trigger){const e=i.getTriggerParameter(),s=e.mesh?e.mesh:e,r=s.intersectsMesh(t,e.usePreciseIntersection),n=t._intersectionsInProgress.indexOf(s);r&&-1===n?12===i.trigger?(i._executeCurrent(_.CreateNew(t,void 0,s)),t._intersectionsInProgress.push(s)):13===i.trigger&&t._intersectionsInProgress.push(s):!r&&n>-1&&(13===i.trigger&&i._executeCurrent(_.CreateNew(t,void 0,s)),t.actionManager.hasSpecificTrigger(13,(e=>{const t=e.mesh?e.mesh:e;return s===t}))&&13!==i.trigger||t._intersectionsInProgress.splice(n,1))}}}}_advancePhysicsEngineStep(e){}_animate(e){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(Z.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Z.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let s=0;const r=this._engine.getLockstepMaxSteps();let n=Math.floor(e/t);for(n=Math.min(n,r);e>0&&s<n;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(t),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,s++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(Z.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Z.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){if(e?.outputRenderTarget&&!e?.isRigCamera&&(e.outputRenderTarget._cleared=!1),e?.rigCameras?.length)for(let t=0;t<e.rigCameras.length;++t){const i=e.rigCameras[t].outputRenderTarget;i&&(i._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}render(e=!0,t=!1){if(!this.isDisposed){this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),this.activeCameras?.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const e of this._beforeCameraUpdateStage)e.action();if(e)if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];if(t.update(),0!==t.cameraRigMode)for(let e=0;e<t._rigCameras.length;e++)t._rigCameras[e].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(let e=0;e<this.activeCamera._rigCameras.length;e++)this.activeCamera._rigCameras[e].update();if(this.onBeforeRenderObservable.notifyObservers(this),this.customRenderFunction)this._renderId++,this._engine.currentRenderPassId=0,this.customRenderFunction();else{const e=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const t=this.activeCameras?.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){s.S0.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let i=0;i<this.customRenderTargets.length;i++){const s=this.customRenderTargets[i];if(s._shouldRender()){if(this._renderId++,this.activeCamera=s.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");e.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),s.render(t!==this.activeCamera,this.dumpNextRenderTargets)}}s.S0.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=t?.renderPassId??0,this.activeCamera=t,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const e of this._beforeClearStage)e.action();this._clearFrameBuffer(this.activeCamera);for(const e of this._gatherRenderTargetsStage)e.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++)this._processSubCameras(this.activeCameras[e],e>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}}this._checkIntersections();for(const e of this._afterRenderStage)e.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let e=0;e<this._toBeDisposed.length;e++){const t=this._toBeDisposed[e];t&&t.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this._activeAnimatables&&this.stopAllAnimations&&(this._activeAnimatables.forEach((e=>{e.onAnimationEndObservable.clear(),e.onAnimationEnd=null})),this.stopAllAnimations()),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const t of e)t.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(e){$.V.Error("An error occurred while calling onDisposeObservable!",e)}if(this.detachControl(),this._engine.getInputElement())for(let e=0;e<this.cameras.length;e++)this.cameras[e].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,(e=>e.dispose(!0))),this._disposeList(this.transformNodes,(e=>e.dispose(!0)));const t=this.cameras;this._disposeList(t),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let i=this._engine.scenes.indexOf(this);i>-1&&this._engine.scenes.splice(i,1),v.q._LastCreatedScene===this&&(this._engine.scenes.length>0?v.q._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:v.q._LastCreatedScene=null),i=this._engine._virtualScenes.indexOf(this),i>-1&&this._engine._virtualScenes.splice(i,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=t??(e=>e.dispose());for(const e of i)t(e);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e].geometry;t&&t.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new h.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new h.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach((e=>{if(e.computeWorldMatrix(!0),!e.subMeshes||0===e.subMeshes.length||e.infiniteDistance)return;const s=e.getBoundingInfo(),r=s.boundingBox.minimumWorld,n=s.boundingBox.maximumWorld;h.Pq.CheckExtends(r,t,i),h.Pq.CheckExtends(n,t,i)})),{min:t,max:i}}createPickingRay(e,t,i,s,r=!1){throw(0,b.n)("Ray")}createPickingRayToRef(e,t,i,s,r,n=!1,a=!1){throw(0,b.n)("Ray")}createPickingRayInCameraSpace(e,t,i){throw(0,b.n)("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,s){throw(0,b.n)("Ray")}pick(e,t,i,s,r,n){const a=(0,b.n)("Ray",!0);return a&&$.V.Warn(a),new d.G}pickWithBoundingInfo(e,t,i,s,r){const n=(0,b.n)("Ray",!0);return n&&$.V.Warn(n),new d.G}pickWithRay(e,t,i,s){throw(0,b.n)("Ray")}multiPick(e,t,i,s,r){throw(0,b.n)("Ray")}multiPickWithRay(e,t,i){throw(0,b.n)("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild(!0);this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(void 0===t)return e;const s=[];for(const r in e){const n=e[r];l.Y&&l.Y.MatchesQuery(n,t)&&(!i||i(n))&&s.push(n)}return s}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,s)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,s,r,n,a){const o=(0,X.zU)(e,t,i,s?this.offlineProvider:void 0,r,n,a);return this._activeRequests.push(o),o.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),o}_loadFileAsync(e,t,i,s,r){return new Promise(((n,a)=>{this._loadFile(e,(e=>{n(e)}),t,i,s,((e,t)=>{a(t)}),r)}))}_requestFile(e,t,i,s,r,n,a){const o=(0,X.sh)(e,t,i,s?this.offlineProvider:void 0,r,n,a);return this._activeRequests.push(o),o.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),o}_requestFileAsync(e,t,i,s,r){return new Promise(((n,a)=>{this._requestFile(e,(e=>{n(e)}),t,i,s,(e=>{a(e)}),r)}))}_readFile(e,t,i,s,r){const n=(0,X.NJ)(e,t,i,s,r);return this._activeRequests.push(n),n.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),n}_readFileAsync(e,t,i){return new Promise(((s,r)=>{this._readFile(e,(e=>{s(e)}),t,i,(e=>{r(e)}))}))}getPerfCollector(){throw(0,b.n)("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}Z.FOGMODE_NONE=0,Z.FOGMODE_EXP=1,Z.FOGMODE_EXP2=2,Z.FOGMODE_LINEAR=3,Z.MinDeltaTime=1,Z.MaxDeltaTime=1e3,(0,j.Y5)("BABYLON.Scene",Z)},6945:(e,t,i)=>{"use strict";i.d(t,{B:()=>r,v:()=>s});class s{}s.NAME_EFFECTLAYER="EffectLayer",s.NAME_LAYER="Layer",s.NAME_LENSFLARESYSTEM="LensFlareSystem",s.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",s.NAME_PARTICLESYSTEM="ParticleSystem",s.NAME_GAMEPAD="Gamepad",s.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",s.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",s.NAME_PREPASSRENDERER="PrePassRenderer",s.NAME_DEPTHRENDERER="DepthRenderer",s.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",s.NAME_IBLSHADOWSRENDERER="IblShadowsRenderer",s.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",s.NAME_SPRITE="Sprite",s.NAME_SUBSURFACE="SubSurface",s.NAME_OUTLINERENDERER="Outline",s.NAME_PROCEDURALTEXTURE="ProceduralTexture",s.NAME_SHADOWGENERATOR="ShadowGenerator",s.NAME_OCTREE="Octree",s.NAME_PHYSICSENGINE="PhysicsEngine",s.NAME_AUDIO="Audio",s.NAME_FLUIDRENDERER="FluidRenderer",s.STEP_ISREADYFORMESH_EFFECTLAYER=0,s.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,s.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,s.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,s.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,s.STEP_BEFORECAMERADRAW_PREPASS=0,s.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,s.STEP_BEFORECAMERADRAW_LAYER=2,s.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,s.STEP_BEFORERENDERTARGETDRAW_LAYER=1,s.STEP_BEFORERENDERINGMESH_PREPASS=0,s.STEP_BEFORERENDERINGMESH_OUTLINE=1,s.STEP_AFTERRENDERINGMESH_PREPASS=0,s.STEP_AFTERRENDERINGMESH_OUTLINE=1,s.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,s.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,s.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,s.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,s.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,s.STEP_BEFORECLEAR_PREPASS=1,s.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,s.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,s.STEP_AFTERRENDERTARGETDRAW_LAYER=1,s.STEP_AFTERCAMERADRAW_PREPASS=0,s.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,s.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,s.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,s.STEP_AFTERCAMERADRAW_LAYER=4,s.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,s.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,s.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,s.STEP_AFTERRENDER_AUDIO=0,s.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,s.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,s.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,s.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,s.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,s.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,s.STEP_POINTERMOVE_SPRITE=0,s.STEP_POINTERDOWN_SPRITE=0,s.STEP_POINTERUP_SPRITE=0;class r extends Array{constructor(e){super(...e)}static Create(){return Object.create(r.prototype)}registerStep(e,t,i){let s=0,r=Number.MAX_VALUE;for(;s<this.length&&(r=this[s].index,!(e<r));s++);this.splice(s,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}},5524:(e,t,i)=>{"use strict";function s(e,t,i,s){var r,n=arguments.length,a=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(n<3?r(a):n>3?r(t,i,a):r(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a}i.d(t,{Cg:()=>s}),Object.create,Object.create}},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return i[e].call(n.exports,n,n.exports,r),n.exports}r.m=i,r.amdO={},r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,i)=>(r.f[i](e,t),t)),[])),r.u=e=>e+".bundle.js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="model-viewer:",r.l=(i,s,n,a)=>{if(e[i])e[i].push(s);else{var o,l;if(void 0!==n)for(var h=document.getElementsByTagName("script"),c=0;c<h.length;c++){var u=h[c];if(u.getAttribute("src")==i||u.getAttribute("data-webpack")==t+n){o=u;break}}o||(l=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,r.nc&&o.setAttribute("nonce",r.nc),o.setAttribute("data-webpack",t+n),o.src=i),e[i]=[s];var d=(t,s)=>{o.onerror=o.onload=null,clearTimeout(_);var r=e[i];if(delete e[i],o.parentNode&&o.parentNode.removeChild(o),r&&r.forEach((e=>e(s))),t)return t(s)},_=setTimeout(d.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=d.bind(null,o.onerror),o.onload=d.bind(null,o.onload),l&&document.head.appendChild(o)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="",(()=>{r.b=document.baseURI||self.location.href;var e={8792:0};r.f.j=(t,i)=>{var s=r.o(e,t)?e[t]:void 0;if(0!==s)if(s)i.push(s[2]);else{var n=new Promise(((i,r)=>s=e[t]=[i,r]));i.push(s[2]=n);var a=r.p+r.u(t),o=new Error;r.l(a,(i=>{if(r.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var n=i&&("load"===i.type?"missing":i.type),a=i&&i.target&&i.target.src;o.message="Loading chunk "+t+" failed.\n("+n+": "+a+")",o.name="ChunkLoadError",o.type=n,o.request=a,s[1](o)}}),"chunk-"+t,t)}};var t=(t,i)=>{var s,n,[a,o,l]=i,h=0;if(a.some((t=>0!==e[t]))){for(s in o)r.o(o,s)&&(r.m[s]=o[s]);l&&l(r)}for(t&&t(i);h<a.length;h++)n=a[h],r.o(e,n)&&e[n]&&e[n][0](),e[n]=0},i=self.webpackChunkmodel_viewer=self.webpackChunkmodel_viewer||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})(),(()=>{"use strict";var e=r(854),t=r(6315),i=r(6321),s=r(6237);class n{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new a(e)}sampleFrame(e=s.j.Now){if(this._enabled){if(null!=this._lastFrameTimeMs){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class a{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const e=this._samples[this._pos];t=e-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(e-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}var o=r(4329),l=r(1137),h=r(7716);i.ThinEngine.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode!==e){switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}t||(this.depthCullingState.depthMask=0===e),this._alphaMode=e}else if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}};var c=r(1597);function u(e,t,i,s){let r,n=1;1===s?r=new Float32Array(t*i*4):2===s?(r=new Uint16Array(t*i*4),n=15360):r=7===s?new Uint32Array(t*i*4):new Uint8Array(t*i*4);for(let s=0;s<t;s++)for(let a=0;a<i;a++){const i=3*(a*t+s),o=4*(a*t+s);r[o+0]=e[i+0],r[o+1]=e[i+1],r[o+2]=e[i+2],r[o+3]=n}return r}function d(t){return function(i,s,r,n,a,o,l,h,c=null,u=0){const d=t?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,_=t?10:11,p=new e.h(this,_);p.baseWidth=s,p.baseHeight=r,p.baseDepth=n,p.width=s,p.height=r,p.depth=n,p.format=a,p.type=u,p.generateMipMaps=o,p.samplingMode=h,t?p.is3D=!0:p.is2DArray=!0,this._doNotHandleContextLost||(p._bufferView=i),t?this.updateRawTexture3D(p,i,a,l,c,u):this.updateRawTexture2DArray(p,i,a,l,c,u),this._bindTextureDirectly(d,p,!0);const f=this._getSamplingParameters(h,o);return this._gl.texParameteri(d,this._gl.TEXTURE_MAG_FILTER,f.mag),this._gl.texParameteri(d,this._gl.TEXTURE_MIN_FILTER,f.min),o&&this._gl.generateMipmap(d),this._bindTextureDirectly(d,null),this._internalTexturesCache.push(p),p}}function _(e){return function(t,i,s,r,n=null,a=0){const o=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(a),h=this._getInternalFormat(s),c=this._getRGBABufferInternalSizedFormat(a,s);this._bindTextureDirectly(o,t,!0),this._unpackFlipY(void 0===r||!!r),this._doNotHandleContextLost||(t._bufferView=i,t.format=s,t.invertY=r,t._compression=n),t.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&i?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[n],t.width,t.height,t.depth,0,i):this._gl.texImage3D(o,0,c,t.width,t.height,t.depth,0,h,l,i),t.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),t.isReady=!0}}i.ThinEngine.prototype.updateRawTexture=function(e,t,i,s,r=null,n=0,a=!1){if(!e)return;const o=this._getRGBABufferInternalSizedFormat(n,i,a),l=this._getInternalFormat(i),h=this._getWebGLTextureType(n);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===s||!!s),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.type=n,e.invertY=s,e._compression=r),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&t?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],e.width,e.height,0,t):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,e.width,e.height,0,l,h,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0},i.ThinEngine.prototype.createRawTexture=function(t,i,s,r,n,a,o,l=null,h=0,c=0,u=!1){const d=new e.h(this,3);d.baseWidth=i,d.baseHeight=s,d.width=i,d.height=s,d.format=r,d.generateMipMaps=n,d.samplingMode=o,d.invertY=a,d._compression=l,d.type=h,d._useSRGBBuffer=this._getUseSRGBBuffer(u,!n),this._doNotHandleContextLost||(d._bufferView=t),this.updateRawTexture(d,t,r,a,l,h,d._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,d,!0);const _=this._getSamplingParameters(o,n);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,_.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,_.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(d),d},i.ThinEngine.prototype.createRawCubeTexture=function(t,i,s,r,n,a,o,h=null){const u=this._gl,d=new e.h(this,8);d.isCube=!0,d.format=s,d.type=r,this._doNotHandleContextLost||(d._bufferViewArray=t);const _=this._getWebGLTextureType(r);let p=this._getInternalFormat(s);p===u.RGB&&(p=u.RGBA),_!==u.FLOAT||this._caps.textureFloatLinearFiltering?_!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?_!==u.FLOAT||this._caps.textureFloatRender?_!==u.HALF_FLOAT||this._caps.colorBufferFloat||(n=!1,l.V.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(n=!1,l.V.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(n=!1,o=1,l.V.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(n=!1,o=1,l.V.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const f=i,m=f;if(d.width=f,d.height=m,d.invertY=a,d._compression=h,!this.needPOTTextures||(0,c.L8)(d.width)&&(0,c.L8)(d.height)||(n=!1),t)this.updateRawCubeTexture(d,t,s,r,a,h);else{const e=this._getRGBABufferInternalSizedFormat(r),t=0;this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,d,!0);for(let i=0;i<6;i++)h?u.compressedTexImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,this.getCaps().s3tc[h],d.width,d.height,0,void 0):u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,e,d.width,d.height,0,p,_,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,d,!0),t&&n&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const g=this._getSamplingParameters(o,n);return u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_MAG_FILTER,g.mag),u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_MIN_FILTER,g.min),u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,null),d.generateMipMaps=n,d.samplingMode=o,d.isReady=!0,d},i.ThinEngine.prototype.updateRawCubeTexture=function(e,t,i,s,r,n=null,a=0){e._bufferViewArray=t,e.format=i,e.type=s,e.invertY=r,e._compression=n;const o=this._gl,l=this._getWebGLTextureType(s);let h=this._getInternalFormat(i);const d=this._getRGBABufferInternalSizedFormat(s);let _=!1;h===o.RGB&&(h=o.RGBA,_=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(void 0===r||!!r),e.width%4!=0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let i=0;i<6;i++){let r=t[i];n?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+i,a,this.getCaps().s3tc[n],e.width,e.height,0,r):(_&&(r=u(r,e.width,e.height,s)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+i,a,d,e.width,e.height,0,h,l,r))}(!this.needPOTTextures||(0,c.L8)(e.width)&&(0,c.L8)(e.height))&&e.generateMipMaps&&0===a&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),e.isReady=!0},i.ThinEngine.prototype.createRawCubeTextureFromUrl=function(e,t,i,s,r,n,a,o,l=null,h=null,c=3,d=!1){const _=this._gl,p=this.createRawCubeTexture(null,i,s,r,!n,d,c,null);t?.addPendingData(p),p.url=e,p.isReady=!1,this._internalTexturesCache.push(p);const f=e=>{const i=p.width,n=a(e);if(n){if(o){const e=this._getWebGLTextureType(r);let t=this._getInternalFormat(s);const a=this._getRGBABufferInternalSizedFormat(r);let l=!1;t===_.RGB&&(t=_.RGBA,l=!0),this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,p,!0),this._unpackFlipY(!1);const h=o(n);for(let s=0;s<h.length;s++){const n=i>>s;for(let i=0;i<6;i++){let o=h[s][i];l&&(o=u(o,n,n,r)),_.texImage2D(i,s,a,n,n,0,t,e,o)}}this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(p,n,s,r,d);p.isReady=!0,t?.removePendingData(p),p.onLoadedObservable.notifyObservers(p),p.onLoadedObservable.clear(),l&&l()}};return this._loadFile(e,(e=>{f(e)}),void 0,t?.offlineProvider,!0,((e,i)=>{t?.removePendingData(p),h&&e&&h(e.status+" "+e.statusText,i)})),p},i.ThinEngine.prototype.createRawTexture2DArray=d(!1),i.ThinEngine.prototype.createRawTexture3D=d(!0),i.ThinEngine.prototype.updateRawTexture2DArray=_(!1),i.ThinEngine.prototype.updateRawTexture3D=_(!0);var p=r(6741);i.ThinEngine.prototype._readTexturePixelsSync=function(e,t,i,s=-1,r=0,n=null,a=!0,o=!1,l=0,h=0){const c=this._gl;if(!c)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const e=c.createFramebuffer();if(!e)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=e}c.bindFramebuffer(c.FRAMEBUFFER,this._dummyFramebuffer),s>-1?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+s,e._hardwareTexture?.underlyingResource,r):c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e._hardwareTexture?.underlyingResource,r);let u=void 0!==e.type?this._getWebGLTextureType(e.type):c.UNSIGNED_BYTE;return o?n||(n=(0,p.kZ)(e.type,4*t*i)):u===c.UNSIGNED_BYTE?(n||(n=new Uint8Array(4*t*i)),u=c.UNSIGNED_BYTE):(n||(n=new Float32Array(4*t*i)),u=c.FLOAT),a&&this.flushFramebuffer(),c.readPixels(l,h,t,i,c.RGBA,u,n),c.bindFramebuffer(c.FRAMEBUFFER,this._currentFramebuffer),n},i.ThinEngine.prototype._readTexturePixels=function(e,t,i,s=-1,r=0,n=null,a=!0,o=!1,l=0,h=0){return Promise.resolve(this._readTexturePixelsSync(e,t,i,s,r,n,a,o,l,h))},i.ThinEngine.prototype.updateDynamicIndexBuffer=function(e,t,i=0){let s;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e),s=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,s,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},i.ThinEngine.prototype.updateDynamicVertexBuffer=function(e,t,i,s){this.bindArrayBuffer(e),void 0===i&&(i=0);const r=t.byteLength||t.length;void 0===s||s>=r&&0===i?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(i,i+s)):(t=t instanceof ArrayBuffer?new Uint8Array(t,i,s):new Uint8Array(t.buffer,t.byteOffset+i,s),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)),this._resetVertexBufferBinding()},i.ThinEngine.prototype._createDepthStencilCubeTexture=function(t,i){const s=new e.h(this,12);if(s.isCube=!0,1===this.webGLVersion)return l.V.Error("Depth cube texture is not supported by WebGL 1."),s;const r={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...i},n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,s,!0),this._setupDepthStencilTexture(s,t,r.bilinearFiltering,r.comparisonFunction);for(let e=0;e<6;e++)r.generateStencil?n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,n.DEPTH24_STENCIL8,t,t,0,n.DEPTH_STENCIL,n.UNSIGNED_INT_24_8,null):n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,n.DEPTH_COMPONENT24,t,t,0,n.DEPTH_COMPONENT,n.UNSIGNED_INT,null);return this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(s),s},i.ThinEngine.prototype._setCubeMapTextureParams=function(e,t,i){const s=this._gl;s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,t?s.LINEAR_MIPMAP_LINEAR:s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),e.samplingMode=t?3:2,t&&this.getCaps().textureMaxLevel&&void 0!==i&&i>0&&(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAX_LEVEL,i),e._maxLodLevel=i),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null)},i.ThinEngine.prototype.createCubeTexture=function(e,t,i,s,r=null,n=null,a,o=null,h=!1,u=0,d=0,_=null,p,f=!1,m=null){const g=this._gl;return this.createCubeTextureBase(e,t,i,!!s,r,n,a,o,h,u,d,_,(e=>this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,e,!0)),((e,t)=>{const i=this.needPOTTextures?(0,c.R)(t[0].width,this._caps.maxCubemapTextureSize):t[0].width,n=i,o=[g.TEXTURE_CUBE_MAP_POSITIVE_X,g.TEXTURE_CUBE_MAP_POSITIVE_Y,g.TEXTURE_CUBE_MAP_POSITIVE_Z,g.TEXTURE_CUBE_MAP_NEGATIVE_X,g.TEXTURE_CUBE_MAP_NEGATIVE_Y,g.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(!1);const h=a?this._getInternalFormat(a,e._useSRGBBuffer):e._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:g.RGBA;let u=a?this._getInternalFormat(a):g.RGBA;e._useSRGBBuffer&&1===this.webGLVersion&&(u=h);for(let e=0;e<o.length;e++)if(t[e].width!==i||t[e].height!==n){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void l.V.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=i,this._workingCanvas.height=n,this._workingContext.drawImage(t[e],0,0,t[e].width,t[e].height,0,0,i,n),g.texImage2D(o[e],0,h,u,g.UNSIGNED_BYTE,this._workingCanvas)}else g.texImage2D(o[e],0,h,u,g.UNSIGNED_BYTE,t[e]);s||g.generateMipmap(g.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(e,!s),e.width=i,e.height=n,e.isReady=!0,a&&(e.format=a),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),r&&r()}),!!f,m)},i.ThinEngine.prototype.generateMipMapsForCubemap=function(e,t=!0){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}};class f{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){return this._textures?.[0]??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const s=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,s}constructor(e,t,i,s,r){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=s,this._depthStencilTexture=null,this.label=r}setTextures(e){Array.isArray(e)?this._textures=e:this._textures=e?[e]:null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e)}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==t&&t>=0&&(this._layerIndices[e]=t),void 0!==i&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,r=14,n){return this._depthStencilTexture?.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTextureLabel=n,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:s,depthTextureFormat:r,label:n},this),this._depthStencilTexture}_shareDepth(e){this.shareDepth(e)}shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,e._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let e=null;if(this._isMulti){const t=this.textures;if(t&&t.length>0){let i=!1,s=t.length,r=-1;const n=t[t.length-1]._source;14!==n&&12!==n||(i=!0,r=t[t.length-1].format,s--);const a=[],o=[],l=[],h=[],c=[],u=[],d=[],_={};for(let e=0;e<s;++e){const i=t[e];a.push(i.samplingMode),o.push(i.type),l.push(i.format),void 0!==_[i.uniqueId]?(h.push(-1),d.push(0)):(_[i.uniqueId]=e,i.is2DArray?(h.push(35866),d.push(i.depth)):i.isCube?(h.push(34067),d.push(0)):i.is3D?(h.push(32879),d.push(i.depth)):(h.push(3553),d.push(0))),this._faceIndices&&c.push(this._faceIndices[e]??0),this._layerIndices&&u.push(this._layerIndices[e]??0)}const p={samplingModes:a,generateMipMaps:t[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:i,depthTextureFormat:r,types:o,formats:l,textureCount:s,targetTypes:h,faceIndex:c,layerIndex:u,layerCounts:d,label:this.label},f={width:this.width,height:this.height,depth:this.depth};e=this._engine.createMultipleRenderTarget(f,p);for(let i=0;i<s;++i){if(-1!==h[i])continue;const s=_[t[i].uniqueId];e.setTexture(e.textures[s],i)}}}else{const t={};if(t.generateDepthBuffer=this._generateDepthBuffer,t.generateMipMaps=this.texture?.generateMipMaps??!1,t.generateStencilBuffer=this._generateStencilBuffer,t.samplingMode=this.texture?.samplingMode,t.type=this.texture?.type,t.format=this.texture?.format,t.noColorAttachment=!this._textures,t.label=this.label,this.isCube)e=this._engine.createRenderTargetCubeTexture(this.width,t);else{const i={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?this.texture?.depth:void 0};e=this._engine.createRenderTargetTexture(i,t)}e.texture&&(e.texture.isReady=!0)}return e}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=this._depthStencilTexture.format,s=2===t||3===t||11===t;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,s,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,i,this._depthStencilTextureLabel)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){if(this._textures)for(let e=0;e<this._textures?.length;++e)this._textures[e].dispose();this._textures=null}dispose(e=!1){e||(this._depthStencilTexture?.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class m extends f{constructor(e,t,i,s,r){super(e,t,i,s),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=r}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,r=14,n){if(this._depthStencilBuffer){const e=this._engine,t=e._currentFramebuffer,i=this._context;e._bindUnboundFramebuffer(this._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),e._bindUnboundFramebuffer(t),i.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(e,t,i,s,r,n)}shareDepth(e){super.shareDepth(e);const t=this._context,i=this._depthStencilBuffer,s=e._MSAAFramebuffer||e._framebuffer,r=this._engine;e._depthStencilBuffer&&e._depthStencilBuffer!==i&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=i;const n=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;r._bindUnboundFramebuffer(s),t.framebufferRenderbuffer(t.FRAMEBUFFER,n,t.RENDERBUFFER,i),r._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,s=0){if(!e._hardwareTexture)return;const r=this._framebuffer,n=this._engine,a=n._currentFramebuffer;if(n._bindUnboundFramebuffer(r),n.webGLVersion>1){const r=this._context,n=r["COLOR_ATTACHMENT"+t];e.is2DArray||e.is3D?(i=i??this.layerIndices?.[t]??0,r.framebufferTextureLayer(r.FRAMEBUFFER,n,e._hardwareTexture.underlyingResource,s,i)):e.isCube?(i=i??this.faceIndices?.[t]??0,r.framebufferTexture2D(r.FRAMEBUFFER,n,r.TEXTURE_CUBE_MAP_POSITIVE_X+i,e._hardwareTexture.underlyingResource,s)):r.framebufferTexture2D(r.FRAMEBUFFER,n,r.TEXTURE_2D,e._hardwareTexture.underlyingResource,s)}else{const r=this._context,n=r["COLOR_ATTACHMENT"+t+"_WEBGL"],a=void 0!==i?r.TEXTURE_CUBE_MAP_POSITIVE_X+i:r.TEXTURE_2D;r.framebufferTexture2D(r.FRAMEBUFFER,n,a,e._hardwareTexture.underlyingResource,s)}n._bindUnboundFramebuffer(a)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const i=this._attachments?.length??this.textures.length;for(let e=0;e<i;e++){const t=this.textures[e];t&&(t.is2DArray||t.is3D?this._bindTextureRenderTarget(t,e,this.layerIndices[e]):t.isCube?this._bindTextureRenderTarget(t,e,this.faceIndices[e]):this._bindTextureRenderTarget(t,e))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const s=this.textures[e];s.is2DArray||s.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):s.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}dispose(e=this._disposeOnlyFramebuffers){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}var g=r(6326);g.$.prototype.createDepthStencilTexture=function(e,t,i){if(t.isCube){const i=e.width||e;return this._createDepthStencilCubeTexture(i,t)}return this._createDepthStencilTexture(e,t,i)},i.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(e,t,i){const s=new m(e,t,i,this,this._gl);return this._renderTargetWrapperCache.push(s),s},i.ThinEngine.prototype.createRenderTargetTexture=function(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!1,e);let s,r,n=!0,a=!1,o=!1,l=1;void 0!==t&&"object"==typeof t&&(n=t.generateDepthBuffer??!0,a=!!t.generateStencilBuffer,o=!!t.noColorAttachment,s=t.colorAttachment,l=t.samples??1,r=t.label);const h=s||(o?null:this._createInternalTexture(e,t,!0,5)),c=e.width||e,u=e.height||e,d=this._currentFramebuffer,_=this._gl,p=_.createFramebuffer();return this._bindUnboundFramebuffer(p),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(a,n,c,u),!h||h.is2DArray||h.is3D||_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,h._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(d),i.label=r??"RenderTargetWrapper",i._framebuffer=p,i._generateDepthBuffer=n,i._generateStencilBuffer=a,i.setTextures(h),this.updateRenderTargetTextureSampleCount(i,l),i},i.ThinEngine.prototype._createDepthStencilTexture=function(t,i,s){const r=this._gl,n=t.layers||0,a=t.depth||0;let o=r.TEXTURE_2D;0!==n?o=r.TEXTURE_2D_ARRAY:0!==a&&(o=r.TEXTURE_3D);const h=new e.h(this,12);if(h.label=i.label,!this._caps.depthTextureExtension)return l.V.Error("Depth texture is not supported by your browser or hardware."),h;const c={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...i};if(this._bindTextureDirectly(o,h,!0),this._setupDepthStencilTexture(h,t,0!==c.comparisonFunction&&c.bilinearFiltering,c.comparisonFunction,c.samples),void 0!==c.depthTextureFormat){if(15!==c.depthTextureFormat&&16!==c.depthTextureFormat&&17!==c.depthTextureFormat&&13!==c.depthTextureFormat&&14!==c.depthTextureFormat&&18!==c.depthTextureFormat)return l.V.Error(`Depth texture ${c.depthTextureFormat} format is not supported.`),h;h.format=c.depthTextureFormat}else h.format=c.generateStencil?13:16;const u=17===h.format||13===h.format||18===h.format;let d=r.UNSIGNED_INT;15===h.format?d=r.UNSIGNED_SHORT:17===h.format||13===h.format?d=r.UNSIGNED_INT_24_8:14===h.format?d=r.FLOAT:18===h.format&&(d=r.FLOAT_32_UNSIGNED_INT_24_8_REV);const _=u?r.DEPTH_STENCIL:r.DEPTH_COMPONENT,p=this._getInternalFormatFromDepthTextureFormat(h.format,!0,u);return h.is2DArray?r.texImage3D(o,0,p,h.width,h.height,n,0,_,d,null):h.is3D?r.texImage3D(o,0,p,h.width,h.height,a,0,_,d,null):r.texImage2D(o,0,p,h.width,h.height,0,_,d,null),this._bindTextureDirectly(o,null),this._internalTexturesCache.push(h),s._depthStencilBuffer&&(r.deleteRenderbuffer(s._depthStencilBuffer),s._depthStencilBuffer=null),this._bindUnboundFramebuffer(s._MSAAFramebuffer??s._framebuffer),s._generateStencilBuffer=u,s._depthStencilTextureWithStencil=u,s._depthStencilBuffer=this._setupFramebufferDepthAttachments(s._generateStencilBuffer,s._generateDepthBuffer,s.width,s.height,s.samples,h.format),this._bindUnboundFramebuffer(null),h},i.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e)return 1;if(e.samples===t)return t;const i=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(i.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(i.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);const s=e.texture?._hardwareTexture;s?.releaseMSAARenderBuffers();const r=i.createFramebuffer();if(!r)throw new Error("Unable to create multi sampled framebuffer");if(e._MSAAFramebuffer=r,e.texture&&t>1&&"function"==typeof i.renderbufferStorageMultisample){this._bindUnboundFramebuffer(e._MSAAFramebuffer);const r=this._createRenderBuffer(e.texture.width,e.texture.height,t,-1,this._getRGBABufferInternalSizedFormat(e.texture.type,e.texture.format,e.texture._useSRGBBuffer),i.COLOR_ATTACHMENT0,!1);if(!r)throw new Error("Unable to create multi sampled framebuffer");s?.addMSAARenderBuffer(r)}this._bindUnboundFramebuffer(e._MSAAFramebuffer??e._framebuffer),e.texture&&(e.texture.samples=t),e._samples=t;const n=e._depthStencilTexture?e._depthStencilTexture.format:void 0;return e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t,n),this._bindUnboundFramebuffer(null),t},i.ThinEngine.prototype._setupDepthStencilTexture=function(e,t,i,s,r=1){const n=t.width||t,a=t.height||t,o=t.layers||0,l=t.depth||0;e.baseWidth=n,e.baseHeight=a,e.width=n,e.height=a,e.is2DArray=o>0,e.depth=o||l,e.isReady=!0,e.samples=r,e.generateMipMaps=!1,e.samplingMode=i?2:1,e.type=0,e._comparisonFunction=s;const h=this._gl,c=this._getTextureTarget(e),u=this._getSamplingParameters(e.samplingMode,!1);h.texParameteri(c,h.TEXTURE_MAG_FILTER,u.mag),h.texParameteri(c,h.TEXTURE_MIN_FILTER,u.min),h.texParameteri(c,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(c,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===s?(h.texParameteri(c,h.TEXTURE_COMPARE_FUNC,515),h.texParameteri(c,h.TEXTURE_COMPARE_MODE,h.NONE)):(h.texParameteri(c,h.TEXTURE_COMPARE_FUNC,s),h.texParameteri(c,h.TEXTURE_COMPARE_MODE,h.COMPARE_REF_TO_TEXTURE)))},i.ThinEngine.prototype.setDepthStencilTexture=function(e,t,i,s){void 0!==e&&(t&&(this._boundUniforms[e]=t),i&&i.depthStencilTexture?this._setTexture(e,i,!1,!0,s):this._setTexture(e,null,void 0,void 0,s))},i.ThinEngine.prototype.createRenderTargetCubeTexture=function(t,i){const s=this._createHardwareRenderTargetWrapper(!1,!0,t),r={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...i};r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,(1!==r.type||this._caps.textureFloatLinearFiltering)&&(2!==r.type||this._caps.textureHalfFloatLinearFiltering)||(r.samplingMode=1);const n=this._gl,a=new e.h(this,5);this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,a,!0);const o=this._getSamplingParameters(r.samplingMode,r.generateMipMaps);1!==r.type||this._caps.textureFloat||(r.type=0,l.V.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,o.mag),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,o.min),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(let e=0;e<6;e++)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,this._getRGBABufferInternalSizedFormat(r.type,r.format),t,t,0,this._getInternalFormat(r.format),this._getWebGLTextureType(r.type),null);const h=n.createFramebuffer();return this._bindUnboundFramebuffer(h),s._depthStencilBuffer=this._setupFramebufferDepthAttachments(r.generateStencilBuffer,r.generateDepthBuffer,t,t),r.generateMipMaps&&n.generateMipmap(n.TEXTURE_CUBE_MAP),this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),s._framebuffer=h,s._generateDepthBuffer=r.generateDepthBuffer,s._generateStencilBuffer=r.generateStencilBuffer,a.width=t,a.height=t,a.isReady=!0,a.isCube=!0,a.samples=1,a.generateMipMaps=r.generateMipMaps,a.samplingMode=r.samplingMode,a.type=r.type,a.format=r.format,this._internalTexturesCache.push(a),s.setTextures(a),s};var v=r(7517),b=r(2667),x=r(6464);i.ThinEngine.prototype.createPrefilteredCubeTexture=function(t,i,s,r,n=null,a=null,o,h=null,c=!0){return this.createCubeTexture(t,i,null,!1,(t=>{if(!t)return void(n&&n(null));const a=t.texture;if(c?t.info.sphericalPolynomial&&(a._sphericalPolynomial=t.info.sphericalPolynomial):a._sphericalPolynomial=new v.Q,a._source=9,this.getCaps().textureLOD)return void(n&&n(a));const o=this._gl,h=t.width;if(!h)return;const u=[];for(let n=0;n<3;n++){const c=1-n/2,d=r,_=Math.log2(h)*s+r,p=d+(_-d)*c,f=Math.round(Math.min(Math.max(p,0),_)),m=new e.h(this,2);if(m.type=a.type,m.format=a.format,m.width=Math.pow(2,Math.max(Math.log2(h)-f,0)),m.height=m.width,m.isCube=!0,m._cachedWrapU=0,m._cachedWrapV=0,this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,m,!0),m.samplingMode=2,o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),t.isDDS){const e=t.info,i=t.data;this._unpackFlipY(e.isCompressed),x.D.UploadDDSLevels(this,m,i,e,!0,6,f)}else l.V.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,null);const g=new b.t(i);g._isCube=!0,g._texture=m,m.isReady=!0,u.push(g)}a._lodTextureHigh=u[2],a._lodTextureMid=u[1],a._lodTextureLow=u[0],n&&n(a)}),a,o,h,c,s,r)},i.ThinEngine.prototype.createUniformBuffer=function(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create uniform buffer");const s=new o.A(i);return this.bindUniformBuffer(s),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),s.references=1,s},i.ThinEngine.prototype.createDynamicUniformBuffer=function(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create dynamic uniform buffer");const s=new o.A(i);return this.bindUniformBuffer(s),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),s.references=1,s},i.ThinEngine.prototype.updateUniformBuffer=function(e,t,i,s){this.bindUniformBuffer(e),void 0===i&&(i=0),void 0===s?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(i,i+s)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(i,i+s)),this.bindUniformBuffer(null)},i.ThinEngine.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)},i.ThinEngine.prototype.bindUniformBufferBase=function(e,t,i){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null)},i.ThinEngine.prototype.bindUniformBlock=function(e,t,i){const s=e.program,r=this._gl.getUniformBlockIndex(s,t);4294967295!==r&&this._gl.uniformBlockBinding(s,r,i)};var S=r(8790);function T(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then((()=>{e.focus()})).catch((()=>{})):e.focus()}}g.$.prototype.displayLoadingUI=function(){if(!(0,S.BA)())return;const e=this.loadingScreen;e&&e.displayLoadingUI()},g.$.prototype.hideLoadingUI=function(){if(!(0,S.BA)())return;const e=this._loadingScreen;e&&e.hideLoadingUI()},Object.defineProperty(g.$.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=g.$.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(e){this._loadingScreen=e},enumerable:!0,configurable:!0}),Object.defineProperty(g.$.prototype,"loadingUIText",{set:function(e){this.loadingScreen.loadingUIText=e},enumerable:!0,configurable:!0}),Object.defineProperty(g.$.prototype,"loadingUIBackgroundColor",{set:function(e){this.loadingScreen.loadingUIBackgroundColor=e},enumerable:!0,configurable:!0}),g.$.prototype.getInputElement=function(){return this._renderingCanvas},g.$.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},g.$.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},g.$.prototype.getAspectRatio=function(e,t=!1){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)},g.$.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},g.$.prototype._verifyPointerLock=function(){this._onPointerLockChange?.()},g.$.prototype.setAlphaEquation=function(e){if(this._alphaEquation!==e){switch(e){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=e}},g.$.prototype.getInputElement=function(){return this._renderingCanvas},g.$.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},g.$.prototype.setDepthFunction=function(e){this._depthCullingState.depthFunc=e},g.$.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},g.$.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},g.$.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},g.$.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},g.$.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},g.$.prototype.setDepthWrite=function(e){this._depthCullingState.depthMask=e},g.$.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},g.$.prototype.setStencilBuffer=function(e){this._stencilState.stencilTest=e},g.$.prototype.getStencilMask=function(){return this._stencilState.stencilMask},g.$.prototype.setStencilMask=function(e){this._stencilState.stencilMask=e},g.$.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},g.$.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},g.$.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},g.$.prototype.setStencilFunction=function(e){this._stencilState.stencilFunc=e},g.$.prototype.setStencilFunctionReference=function(e){this._stencilState.stencilFuncRef=e},g.$.prototype.setStencilFunctionMask=function(e){this._stencilState.stencilFuncMask=e},g.$.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},g.$.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},g.$.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},g.$.prototype.setStencilOperationFail=function(e){this._stencilState.stencilOpStencilFail=e},g.$.prototype.setStencilOperationDepthFail=function(e){this._stencilState.stencilOpDepthFail=e},g.$.prototype.setStencilOperationPass=function(e){this._stencilState.stencilOpStencilDepthPass=e},g.$.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},g.$.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)},g.$.prototype.setAlphaConstants=function(e,t,i,s){this._alphaState.setAlphaBlendConstants(e,t,i,s)},g.$.prototype.getAlphaMode=function(){return this._alphaMode},g.$.prototype.getAlphaEquation=function(){return this._alphaEquation},g.$.prototype.getRenderPassNames=function(){return this._renderPassNames},g.$.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},g.$.prototype.createRenderPassId=function(e){const t=++g.$._RenderPassIdCounter;return this._renderPassNames[t]=e??"NONAME",t},g.$.prototype.releaseRenderPassId=function(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let t=0;t<i.meshes.length;++t){const s=i.meshes[t];if(s.subMeshes)for(let t=0;t<s.subMeshes.length;++t)s.subMeshes[t]._removeDrawWrapper(e)}}};var y=r(4296),C=r(9848);g.$.AudioEngineFactory=(e,t,i)=>new P(e,t,i);class P{get audioContext(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext}constructor(e=null,t=null,i=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new C.cP,this.onAudioLockedObservable=new C.cP,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!(0,S.BA)())return;void 0!==window.AudioContext&&(this.canUseWebAudio=!0);const s=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=i;try{s&&s.canPlayType&&(s.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||s.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch(e){}try{s&&s.canPlayType&&s.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch(e){}}lock(){this._triggerSuspendedState()}unlock(){if("running"===this._audioContext?.state)return this._hideMuteButton(),void(this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)));this._tryToRun?this._audioContext?.suspend().then((()=>{this._tryToRun=!1,this._triggerRunningState()})):this._triggerRunningState()}_resumeAudioContextOnStateChange(){this._audioContext?.addEventListener("statechange",(()=>{this.unlocked&&"running"!==this._audioContext?.state&&this._resumeAudioContext()}),{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContext(){return this._audioContext?.resume?this._audioContext.resume():Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,"running"===this._audioContext.state&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,l.V.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then((()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)})).catch((()=>{this._tryToRun=!1,this.unlocked=!1})))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";const e=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",(()=>{this._triggerRunningState()}),!0),this._muteButton.addEventListener("click",(()=>{this.unlock()}),!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}}class E extends i.ThinEngine{static get NpmPackage(){return g.$.NpmPackage}static get Version(){return g.$.Version}static get Instances(){return t.q.Instances}static get LastCreatedEngine(){return t.q.LastCreatedEngine}static get LastCreatedScene(){return t.q.LastCreatedScene}static DefaultLoadingScreenFactory(e){return g.$.DefaultLoadingScreenFactory(e)}get _supportsHardwareTextureRescaling(){return!!E._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(e,t,i,s=!1){if(super(e,t,i,s),this.customAnimationFrameRequester=null,this._performanceMonitor=new n,this._drawCalls=new y.A,e&&(this._features.supportRenderPasses=!0,i=this._creationOptions,e.getContext)){const t=e;this._sharedInit(t)}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),function(e,t,i){e._onCanvasFocus=()=>{e.onCanvasFocusObservable.notifyObservers(e)},e._onCanvasBlur=()=>{e.onCanvasBlurObservable.notifyObservers(e)},e._onCanvasContextMenu=t=>{e.disableContextMenu&&t.preventDefault()},t.addEventListener("focus",e._onCanvasFocus),t.addEventListener("blur",e._onCanvasBlur),t.addEventListener("contextmenu",e._onCanvasContextMenu),e._onBlur=()=>{e.disablePerformanceMonitorInBackground&&e.performanceMonitor.disable(),e._windowIsBackground=!0},e._onFocus=()=>{e.disablePerformanceMonitorInBackground&&e.performanceMonitor.enable(),e._windowIsBackground=!1},e._onCanvasPointerOut=i=>{document.elementFromPoint(i.clientX,i.clientY)!==t&&e.onCanvasPointerOutObservable.notifyObservers(i)};const s=e.getHostWindow();s&&"function"==typeof s.addEventListener&&(s.addEventListener("blur",e._onBlur),s.addEventListener("focus",e._onFocus)),t.addEventListener("pointerout",e._onCanvasPointerOut),i.doNotHandleTouchAction||function(e){e&&e.setAttribute&&(e.setAttribute("touch-action","none"),e.style.touchAction="none",e.style.webkitTapHighlightColor="transparent")}(t),!g.$.audioEngine&&i.audioEngine&&g.$.AudioEngineFactory&&(g.$.audioEngine=g.$.AudioEngineFactory(e.getRenderingCanvas(),e.getAudioContext(),e.getAudioDestination())),(0,S.Nf)()&&(e._onFullscreenChange=()=>{e.isFullscreen=!!document.fullscreenElement,e.isFullscreen&&e._pointerLockRequested&&t&&T(t)},document.addEventListener("fullscreenchange",e._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",e._onFullscreenChange,!1),e._onPointerLockChange=()=>{e.isPointerLock=document.pointerLockElement===t},document.addEventListener("pointerlockchange",e._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",e._onPointerLockChange,!1)),e.enableOfflineSupport=void 0!==g.$.OfflineProviderFactory,e._deterministicLockstep=!!i.deterministicLockstep,e._lockstepMaxSteps=i.lockstepMaxSteps||0,e._timeStep=i.timeStep||1/60}(this,e,this._creationOptions)}resizeImageBitmap(e,t,i){return function(e,t,i,s){const r=e.createCanvas(i,s).getContext("2d");if(!r)throw new Error("Unable to get 2d context for resizeImageBitmap");return r.drawImage(t,0,0),r.getImageData(0,0,i,s).data}(this,e,t,i)}_createImageBitmapFromSource(e,t){return function(e,t,i){return new Promise(((s,r)=>{const n=new Image;n.onload=()=>{n.decode().then((()=>{e.createImageBitmap(n,i).then((e=>{s(e)}))}))},n.onerror=()=>{r(`Error loading image ${n.src}`)},n.src=t}))}(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&function(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&function(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}()}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(e,t,i,s){const r=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,s),r}scissorClear(e,t,i,s,r){this.enableScissor(e,t,i,s),this.clear(r,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,s){const r=this._gl;r.enable(r.SCISSOR_TEST),r.scissor(e,t,i,s)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_loadFileAsync(e,t,i){return new Promise(((s,r)=>{this._loadFile(e,(e=>{s(e)}),void 0,t,i,((e,t)=>{r(t)}))}))}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries();super._rebuildBuffers()}getFontOffset(e){return function(e){const t=document.createElement("span");t.textContent="Hg",t.style.font=e;const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const s=document.createElement("div");s.style.whiteSpace="nowrap",s.appendChild(t),s.appendChild(i),document.body.appendChild(s);let r=0,n=0;try{n=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",r=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(s)}return{ascent:r,height:n,descent:n-r}}(e)}_cancelFrame(){if(this.customAnimationFrameRequester){if(0!==this._frameHandler){this._frameHandler=0;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}}else super._cancelFrame()}_renderLoop(){if(this._frameHandler=0,!this._contextWasLost){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0&&0===this._frameHandler&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&T(this._renderingCanvas)}exitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}beginFrame(){this._measureFps(),super.beginFrame()}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,s,r,n=null){r=r||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=super.createShaderProgram(e,t,i,s,r,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),a}_createShaderProgram(e,t,i,s,r=null){const n=s.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");if(s.attachShader(n,t),s.attachShader(n,i),this.webGLVersion>1&&r){const t=this.createTransformFeedback();this.bindTransformFeedback(t),this.setTranformFeedbackVaryings(n,r),e.transformFeedback=t}return s.linkProgram(n),this.webGLVersion>1&&r&&this.bindTransformFeedback(null),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach((t=>{t.postProcesses.forEach((t=>{t._outputTexture===e&&(t._outputTexture=null)})),t.cameras.forEach((t=>{t._postProcesses.forEach((t=>{t&&t._outputTexture===e&&(t._outputTexture=null)}))}))}))}_rescaleTexture(e,t,i,s,r){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const n=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&E._RescalePostProcessFactory&&(this._rescalePostProcess=E._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;const a=()=>{this._rescalePostProcess.onApply=function(t){t._bindTexture("textureSampler",e)};let a=i;a||(a=this.scenes[this.scenes.length-1]),a.postProcessManager.directRender([this._rescalePostProcess],n,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,s,0,0,t.width,t.height,0),this.unBindFramebuffer(n),n.dispose(),r&&r()},o=this._rescalePostProcess.getEffect();o?o.executeWhenCompiled(a):this._rescalePostProcess.onEffectCreatedObservable.addOnce((e=>{e.executeWhenCompiled(a)}))}}wrapWebGLTexture(t,i=!1,s=3,r=0,n=0){const a=new h.d(t,this._gl),o=new e.h(this,0,!0);return o._hardwareTexture=a,o.baseWidth=r,o.baseHeight=n,o.width=r,o.height=n,o.isReady=!0,o.useMipMaps=i,this.updateTextureSamplingMode(s,o),o}_uploadImageToTexture(e,t,i=0,s=0){const r=this._gl,n=this._getWebGLTextureType(e.type),a=this._getInternalFormat(e.format),o=this._getRGBABufferInternalSizedFormat(e.type,a),l=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(l,e,!0),this._unpackFlipY(e.invertY);let h=r.TEXTURE_2D;e.isCube&&(h=r.TEXTURE_CUBE_MAP_POSITIVE_X+i),r.texImage2D(h,s,o,a,n,t),this._bindTextureDirectly(l,null,!0)}updateTextureComparisonFunction(e,t){if(1===this.webGLVersion)return void l.V.Error("WebGL 1 does not support texture comparison.");const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),0===t?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),0===t?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new o.A(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const s=this._gl;return new Promise(((r,n)=>{const a=()=>{const o=s.clientWaitSync(e,t,0);o!=s.WAIT_FAILED?o!=s.TIMEOUT_EXPIRED?r():setTimeout(a,i):n()};a()}))}_readPixelsAsync(e,t,i,s,r,n,a){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const o=this._gl,l=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,l),o.bufferData(o.PIXEL_PACK_BUFFER,a.byteLength,o.STREAM_READ),o.readPixels(e,t,i,s,r,n,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null);const h=o.fenceSync(o.SYNC_GPU_COMMANDS_COMPLETE,0);return h?(o.flush(),this._clientWaitAsync(h,0,10).then((()=>(o.deleteSync(h),o.bindBuffer(o.PIXEL_PACK_BUFFER,l),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,a),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteBuffer(l),a)))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),function(e,i){1===t.q.Instances.length&&g.$.audioEngine&&(g.$.audioEngine.dispose(),g.$.audioEngine=null);const s=e.getHostWindow();s&&"function"==typeof s.removeEventListener&&(s.removeEventListener("blur",e._onBlur),s.removeEventListener("focus",e._onFocus)),i&&(i.removeEventListener("focus",e._onCanvasFocus),i.removeEventListener("blur",e._onCanvasBlur),i.removeEventListener("pointerout",e._onCanvasPointerOut),i.removeEventListener("contextmenu",e._onCanvasContextMenu)),(0,S.Nf)()&&(document.removeEventListener("fullscreenchange",e._onFullscreenChange),document.removeEventListener("mozfullscreenchange",e._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",e._onFullscreenChange),document.removeEventListener("msfullscreenchange",e._onFullscreenChange),document.removeEventListener("pointerlockchange",e._onPointerLockChange),document.removeEventListener("mspointerlockchange",e._onPointerLockChange),document.removeEventListener("mozpointerlockchange",e._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",e._onPointerLockChange))}(this,this._renderingCanvas),super.dispose()}}E.ALPHA_DISABLE=0,E.ALPHA_ADD=1,E.ALPHA_COMBINE=2,E.ALPHA_SUBTRACT=3,E.ALPHA_MULTIPLY=4,E.ALPHA_MAXIMIZED=5,E.ALPHA_ONEONE=6,E.ALPHA_PREMULTIPLIED=7,E.ALPHA_PREMULTIPLIED_PORTERDUFF=8,E.ALPHA_INTERPOLATE=9,E.ALPHA_SCREENMODE=10,E.DELAYLOADSTATE_NONE=0,E.DELAYLOADSTATE_LOADED=1,E.DELAYLOADSTATE_LOADING=2,E.DELAYLOADSTATE_NOTLOADED=4,E.NEVER=512,E.ALWAYS=519,E.LESS=513,E.EQUAL=514,E.LEQUAL=515,E.GREATER=516,E.GEQUAL=518,E.NOTEQUAL=517,E.KEEP=7680,E.REPLACE=7681,E.INCR=7682,E.DECR=7683,E.INVERT=5386,E.INCR_WRAP=34055,E.DECR_WRAP=34056,E.TEXTURE_CLAMP_ADDRESSMODE=0,E.TEXTURE_WRAP_ADDRESSMODE=1,E.TEXTURE_MIRROR_ADDRESSMODE=2,E.TEXTUREFORMAT_ALPHA=0,E.TEXTUREFORMAT_LUMINANCE=1,E.TEXTUREFORMAT_LUMINANCE_ALPHA=2,E.TEXTUREFORMAT_RGB=4,E.TEXTUREFORMAT_RGBA=5,E.TEXTUREFORMAT_RED=6,E.TEXTUREFORMAT_R=6,E.TEXTUREFORMAT_RG=7,E.TEXTUREFORMAT_RED_INTEGER=8,E.TEXTUREFORMAT_R_INTEGER=8,E.TEXTUREFORMAT_RG_INTEGER=9,E.TEXTUREFORMAT_RGB_INTEGER=10,E.TEXTUREFORMAT_RGBA_INTEGER=11,E.TEXTURETYPE_UNSIGNED_BYTE=0,E.TEXTURETYPE_UNSIGNED_INT=0,E.TEXTURETYPE_FLOAT=1,E.TEXTURETYPE_HALF_FLOAT=2,E.TEXTURETYPE_BYTE=3,E.TEXTURETYPE_SHORT=4,E.TEXTURETYPE_UNSIGNED_SHORT=5,E.TEXTURETYPE_INT=6,E.TEXTURETYPE_UNSIGNED_INTEGER=7,E.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,E.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,E.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,E.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,E.TEXTURETYPE_UNSIGNED_INT_24_8=12,E.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,E.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,E.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,E.TEXTURE_NEAREST_SAMPLINGMODE=1,E.TEXTURE_BILINEAR_SAMPLINGMODE=2,E.TEXTURE_TRILINEAR_SAMPLINGMODE=3,E.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,E.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,E.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,E.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,E.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,E.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,E.TEXTURE_NEAREST_LINEAR=7,E.TEXTURE_NEAREST_NEAREST=1,E.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,E.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,E.TEXTURE_LINEAR_LINEAR=2,E.TEXTURE_LINEAR_NEAREST=12,E.TEXTURE_EXPLICIT_MODE=0,E.TEXTURE_SPHERICAL_MODE=1,E.TEXTURE_PLANAR_MODE=2,E.TEXTURE_CUBIC_MODE=3,E.TEXTURE_PROJECTION_MODE=4,E.TEXTURE_SKYBOX_MODE=5,E.TEXTURE_INVCUBIC_MODE=6,E.TEXTURE_EQUIRECTANGULAR_MODE=7,E.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,E.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,E.SCALEMODE_FLOOR=1,E.SCALEMODE_NEAREST=2,E.SCALEMODE_CEILING=3;class A{_canvas;_engine;_scene;_onTick;constructor(e){this._canvas=e.canvas,this._engine=e.engine,this._scene=null,this._onTick=null}static async Create(e,t){const i=new A(e);return i._scene=await i._initialize(e.sceneBuilder,t),i._onTick=i._makeOnTick(),i}run(){const e=this._engine;window.addEventListener("resize",this._onResize),e.runRenderLoop(this._onTick)}dispose(){window.removeEventListener("resize",this._onResize),this._engine.dispose()}_onResize=()=>{this._engine.resize()};async _initialize(e,t){return await e.build(this._canvas,this._engine,t)}_makeOnTick(){const e=this._scene;return()=>e.render()}}class R{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._resizeLoadingUI=()=>{const e=this._renderingCanvas.getBoundingClientRect(),t=window.getComputedStyle(this._renderingCanvas).position;this._loadingDiv&&(this._loadingDiv.style.position="fixed"===t?"fixed":"absolute",this._loadingDiv.style.left=e.left+"px",this._loadingDiv.style.top=e.top+"px",this._loadingDiv.style.width=e.width+"px",this._loadingDiv.style.height=e.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css",this._style.innerHTML="@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }",document.getElementsByTagName("head")[0].appendChild(this._style);const e=!!window.SVGSVGElement,t=new Image;R.DefaultLogoUrl?t.src=R.DefaultLogoUrl:t.src=e?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",t.style.width="150px",t.style.gridColumn="1",t.style.gridRow="1",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.position="absolute";const i=document.createElement("div");i.style.width="300px",i.style.gridColumn="1",i.style.gridRow="1",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.position="absolute";const s=new Image;if(R.DefaultSpinnerUrl?s.src=R.DefaultSpinnerUrl:s.src=e?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",s.style.animation="spin1 0.75s infinite linear",s.style.transformOrigin="50% 50%",!e){const e={w:16,h:18.5},i={w:30,h:30};t.style.width=`${e.w}vh`,t.style.height=`${e.h}vh`,t.style.left=`calc(50% - ${e.w/2}vh)`,t.style.top=`calc(50% - ${e.h/2}vh)`,s.style.width=`${i.w}vh`,s.style.height=`${i.h}vh`,s.style.left=`calc(50% - ${i.w/2}vh)`,s.style.top=`calc(50% - ${i.h/2}vh)`}i.appendChild(s),this._loadingDiv.appendChild(t),this._loadingDiv.appendChild(i),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){this._loadingDiv&&(this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",(()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)})))}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}R.DefaultLogoUrl="",R.DefaultSpinnerUrl="",g.$.DefaultLoadingScreenFactory=e=>new R(e);var I=r(9923),M=r(6041),O=r(5616),w=r(5524),D=r(9259),F=r(5503),N=r(6877);class L{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new C.cP,this._onClonedObservable=new C.cP}}class B{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,s){const r=this._NodeConstructors[e];return r?r(t,i,s):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return!!this._nodeDataStorage._doNotSerialize||!!this._parentNode&&this._parentNode.doNotSerialize}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&void 0!==this._parentNode._children&&null!==this._parentNode._children){const t=this._parentNode._children.indexOf(this);-1!==t&&this._parentNode._children.splice(t,1),e||this._nodeDataStorage._isDisposed||this._addToSceneRootNodes()}this._parentNode=e,this._isDirty=!0,this._parentNode&&(void 0!==this._parentNode._children&&null!==this._parentNode._children||(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){-1===this._nodeDataStorage._sceneRootNodesIndex&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(-1!==this._nodeDataStorage._sceneRootNodesIndex){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,i=null,s=!0){this._isDirty=!1,this._nodeDataStorage=new L,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new C.cP,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=I.uq.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new C.cP,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=i||t.q.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache(),s&&this._addToSceneRootNodes()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return-1!==this._behaviors.indexOf(e)||(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce((()=>{e.attach(this)})):e.attach(this),this._behaviors.push(e)),this}removeBehavior(e){const t=this._behaviors.indexOf(e);return-1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={}}updateCache(e){!e&&this.isSynchronized()||this._updateCache()}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return!this._parentNode||!this._parentNode._isDirty&&this._parentUpdateId===this._parentNode._childUpdateId&&this._parentNode.isSynchronized()}isSynchronized(){return!(this._parentNode&&!this.isSynchronizedWithParent())&&this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return!1===e?this._nodeDataStorage._isEnabled:!!this._nodeDataStorage._isEnabled&&this._nodeDataStorage._isParentEnabled}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=!this._parentNode||this._parentNode.isEnabled(),this._children&&this._children.forEach((e=>{e._syncParentEnabledState()}))}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return!!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))}_getDescendants(e,t=!1,i){if(this._children)for(let s=0;s<this._children.length;s++){const r=this._children[s];i&&!i(r)||e.push(r),t||r._getDescendants(e,!1,i)}}getDescendants(e,t){const i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,(e=>(!t||t(e))&&void 0!==e.cullingStrategy)),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){e!==this._nodeDataStorage._isReady&&(e?(this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0):this._nodeDataStorage._isReady=!1)}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=B._AnimationRangeFactory(e,t,i);for(let s=0,r=this.animations.length;s<r;s++)this.animations[s]&&this.animations[s].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.animations.length;i<s;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){const s=N.p.Clone((()=>new B(e,this.getScene())),this);if(t&&(s.parent=t),!i){const t=this.getDescendants(!0);for(let i=0;i<t.length;i++){const r=t[i];r.clone(e+"."+r.name,s)}}return s}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,s){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,s):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.push(s)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=I.uq.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const s of i)s.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const e of this._behaviors)e.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let i=0;i<t.ranges.length;i++){const s=t.ranges[i];e.createAnimationRange(s.name,s.from,s.to)}}getHierarchyBoundingVectors(e=!0,t=null){let i,s;this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);const r=this;if(r.getBoundingInfo&&r.subMeshes){const e=r.getBoundingInfo();i=e.boundingBox.minimumWorld.clone(),s=e.boundingBox.maximumWorld.clone()}else i=new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new I.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const e=this.getDescendants(!1);for(const r of e){const e=r;if(e.computeWorldMatrix(!0),t&&!t(e))continue;if(!e.getBoundingInfo||0===e.getTotalVertices())continue;const n=e.getBoundingInfo().boundingBox,a=n.minimumWorld,o=n.maximumWorld;I.Pq.CheckExtends(a,i,s),I.Pq.CheckExtends(o,i,s)}}return{min:i,max:s}}}B._AnimationRangeFactory=(e,t,i)=>{throw(0,F.n)("AnimationRange")},B._NodeConstructors={},(0,w.Cg)([(0,D.lK)()],B.prototype,"name",void 0),(0,w.Cg)([(0,D.lK)()],B.prototype,"id",void 0),(0,w.Cg)([(0,D.lK)()],B.prototype,"uniqueId",void 0),(0,w.Cg)([(0,D.lK)()],B.prototype,"state",void 0),(0,w.Cg)([(0,D.lK)()],B.prototype,"metadata",void 0);var k=r(935),V=r(6552),U=r(5515);class z extends B{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t,!1),this.diffuse=new M.v9(1,1,1),this.specular=new M.v9(1,1,1),this.falloffType=z.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=z.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new k.D(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,s,r=!0){const n=e.toString();let a=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+n),this._renderId!==t.getRenderId()||this._lastUseSpecular!==s||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=s;const e=this.getScaledIntensity();this.transferToEffect(i,n),this.diffuse.scaleToRef(e,M.IG.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",M.IG.Color3[0],this.range,n),s&&(this.specular.scaleToRef(e,M.IG.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",M.IG.Color3[1],this.radius,n)),a=!0}if(this.transferTexturesToEffect(i,n),t.shadowsEnabled&&this.shadowEnabled&&r){const e=this.getShadowGenerator(t.activeCamera)??this.getShadowGenerator();e&&(e.bindShadowLight(n,i),a=!0)}a?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){return null===this._shadowGenerators?null:this._shadowGenerators.get(e)??null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return I.Pq.Zero()}canAffectMesh(e){return!(e&&(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(e)||this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)||!(0===this.includeOnlyWithLayerMask||this.includeOnlyWithLayerMask&e.layerMask)||0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&e.layerMask))}dispose(e,t=!1){if(this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const e=this._parentContainer.lights.indexOf(this);e>-1&&this._parentContainer.lights.splice(e,1),this._parentContainer=null}for(const e of this.getScene().meshes)e._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=z.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const s=N.p.Clone(i,this);return e&&(s.name=e),t&&(s.parent=t),s.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(s),s}serialize(){const e=N.p.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach((t=>{e.excludedMeshesIds.push(t.id)}))),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach((t=>{e.includedOnlyMeshesIds.push(t.id)}))),N.p.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){return B.Construct("Light_Type_"+e,t,i)||null}static Parse(e,t){const i=z.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const s=N.p.Parse(i,e,t);if(e.excludedMeshesIds&&(s._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(s._includedOnlyMeshesIds=e.includedOnlyMeshesIds),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.falloffType&&(s.falloffType=e.falloffType),void 0!==e.lightmapMode&&(s.lightmapMode=e.lightmapMode),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=(0,V.n9)("BABYLON.Animation");r&&s.animations.push(r.Parse(i))}B.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&s.setEnabled(e.isEnabled),s}_hookArrayForExcluded(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);for(const e of i)e._resyncLightSource(this);return s};const i=e.splice;e.splice=(t,s)=>{const r=i.apply(e,[t,s]);for(const e of r)e._resyncLightSource(this);return r};for(const t of e)t._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);return this._resyncMeshes(),s};const i=e.splice;e.splice=(t,s)=>{const r=i.apply(e,[t,s]);return this._resyncMeshes(),r},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)-1!==e.lightSources.indexOf(this)&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===z.INTENSITYMODE_AUTOMATIC&&(i=t===z.LIGHTTYPEID_DIRECTIONALLIGHT?z.INTENSITYMODE_ILLUMINANCE:z.INTENSITYMODE_LUMINOUSINTENSITY),t){case z.LIGHTTYPEID_POINTLIGHT:case z.LIGHTTYPEID_SPOTLIGHT:switch(i){case z.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case z.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case z.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius}break;case z.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case z.INTENSITYMODE_ILLUMINANCE:e=1;break;case z.INTENSITYMODE_LUMINANCE:{let t=this.radius;t=Math.max(t,.001),e=2*Math.PI*(1-Math.cos(t));break}}break;case z.LIGHTTYPEID_HEMISPHERICLIGHT:e=1}return e}_reorderLightsInScene(){const e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}z.FALLOFF_DEFAULT=U.c.FALLOFF_DEFAULT,z.FALLOFF_PHYSICAL=U.c.FALLOFF_PHYSICAL,z.FALLOFF_GLTF=U.c.FALLOFF_GLTF,z.FALLOFF_STANDARD=U.c.FALLOFF_STANDARD,z.LIGHTMAP_DEFAULT=U.c.LIGHTMAP_DEFAULT,z.LIGHTMAP_SPECULAR=U.c.LIGHTMAP_SPECULAR,z.LIGHTMAP_SHADOWSONLY=U.c.LIGHTMAP_SHADOWSONLY,z.INTENSITYMODE_AUTOMATIC=U.c.INTENSITYMODE_AUTOMATIC,z.INTENSITYMODE_LUMINOUSPOWER=U.c.INTENSITYMODE_LUMINOUSPOWER,z.INTENSITYMODE_LUMINOUSINTENSITY=U.c.INTENSITYMODE_LUMINOUSINTENSITY,z.INTENSITYMODE_ILLUMINANCE=U.c.INTENSITYMODE_ILLUMINANCE,z.INTENSITYMODE_LUMINANCE=U.c.INTENSITYMODE_LUMINANCE,z.LIGHTTYPEID_POINTLIGHT=U.c.LIGHTTYPEID_POINTLIGHT,z.LIGHTTYPEID_DIRECTIONALLIGHT=U.c.LIGHTTYPEID_DIRECTIONALLIGHT,z.LIGHTTYPEID_SPOTLIGHT=U.c.LIGHTTYPEID_SPOTLIGHT,z.LIGHTTYPEID_HEMISPHERICLIGHT=U.c.LIGHTTYPEID_HEMISPHERICLIGHT,(0,w.Cg)([(0,D.jT)()],z.prototype,"diffuse",void 0),(0,w.Cg)([(0,D.jT)()],z.prototype,"specular",void 0),(0,w.Cg)([(0,D.lK)()],z.prototype,"falloffType",void 0),(0,w.Cg)([(0,D.lK)()],z.prototype,"intensity",void 0),(0,w.Cg)([(0,D.lK)()],z.prototype,"range",null),(0,w.Cg)([(0,D.lK)()],z.prototype,"intensityMode",null),(0,w.Cg)([(0,D.lK)()],z.prototype,"radius",null),(0,w.Cg)([(0,D.lK)()],z.prototype,"_renderPriority",void 0),(0,w.Cg)([(0,D.$z)("_reorderLightsInScene")],z.prototype,"renderPriority",void 0),(0,w.Cg)([(0,D.lK)("shadowEnabled")],z.prototype,"_shadowEnabled",void 0),(0,w.Cg)([(0,D.lK)("excludeWithLayerMask")],z.prototype,"_excludeWithLayerMask",void 0),(0,w.Cg)([(0,D.lK)("includeOnlyWithLayerMask")],z.prototype,"_includeOnlyWithLayerMask",void 0),(0,w.Cg)([(0,D.lK)("lightmapMode")],z.prototype,"_lightmapMode",void 0);var G=r(2781),H=r(5474),W=r(7891);class X extends W.w{set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,s,r,n=G.g.BILINEAR_SAMPLINGMODE,a,o,l=0,h="",c=!1,u=5){super(e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],s,r,n,a,o,null,l,"kernelBlur",{varyingCount:0,depCount:0},!0,u),this._blockCompilation=c,this._packedFloat=!1,this._staticDefines="",this._staticDefines=h,this.direction=t,this.onApplyObservable.add((e=>{this._outputTexture?e.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):e.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)})),this.kernel=i}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(r.bind(r,2850)),Promise.resolve().then(r.bind(r,5417))]))):t.push(Promise.all([Promise.resolve().then(r.bind(r,4509)),Promise.resolve().then(r.bind(r,3802))])),super._gatherImports(e,t)}updateEffect(e=null,t=null,i=null,s,r,n){this._updateParameters(r,n)}_updateParameters(e,t){const i=this._kernel,s=(i-1)/2;let r=[],n=[],a=0;for(let e=0;e<i;e++){const t=e/(i-1),o=this._gaussianWeight(2*t-1);r[e]=e-s,n[e]=o,a+=o}for(let e=0;e<n.length;e++)n[e]/=a;const o=[],l=[],h=[];for(let e=0;e<=s;e+=2){const t=Math.min(e+1,Math.floor(s));if(e===t)h.push({o:r[e],w:n[e]});else{const i=t===s,a=n[e]+n[t]*(i?.5:1),o=r[e]+1/(1+n[e]/n[t]);0===o?(h.push({o:r[e],w:n[e]}),h.push({o:r[e+1],w:n[e+1]})):(h.push({o,w:a}),h.push({o:-o,w:a}))}}for(let e=0;e<h.length;e++)l[e]=h[e].o,o[e]=h[e].w;r=l,n=o;const c=this.getEngine().getCaps().maxVaryingVectors-(1===this.shaderLanguage?1:0),u=Math.max(c,0)-1;let d=Math.min(r.length,u),_="";_+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(_+=`#define CENTER_WEIGHT ${this._glslFloat(n[d-1])}\n`,d--);for(let e=0;e<d;e++)_+=`#define KERNEL_OFFSET${e} ${this._glslFloat(r[e])}\n`,_+=`#define KERNEL_WEIGHT${e} ${this._glslFloat(n[e])}\n`;let p=0;for(let e=u;e<r.length;e++)_+=`#define KERNEL_DEP_OFFSET${p} ${this._glslFloat(r[e])}\n`,_+=`#define KERNEL_DEP_WEIGHT${p} ${this._glslFloat(n[e])}\n`,p++;this.packedFloat&&(_+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(_,null,null,{varyingCount:d,depCount:p},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const e of[t,t-1,t+1,t-2,t+2])if(e%2!=0&&Math.floor(e/2)%2==0&&e>0)return Math.max(e,3);return Math.max(t,3)}_gaussianWeight(e){const t=1/3,i=-e*e/(2*t*t);return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(i)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}static _Parse(e,t,i,s){return N.p.Parse((()=>new X(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1)),e,i,s)}}(0,w.Cg)([(0,D.lK)("kernel")],X.prototype,"_kernel",void 0),(0,w.Cg)([(0,D.lK)("packedFloat")],X.prototype,"_packedFloat",void 0),(0,w.Cg)([(0,D.WM)()],X.prototype,"direction",void 0),(0,V.Y5)("BABYLON.BlurPostProcess",X);class K{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let e=0;e<i.meshes.length;e++){const s=i.meshes[e];if(s.material){if(s.computeBonesUsingShaders&&0!==s.numBoneInfluencers)if(s.material.getEffect()===t)s.computeBonesUsingShaders=!1;else if(s.subMeshes)for(const e of s.subMeshes)if(e.effect===t){s.computeBonesUsingShaders=!1;break}}else!this._mesh.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=!1)}}else{const t=this._defines[this._currentRank];if(t)for(let i=0;i<t.length;i++)e=e.replace("#define "+t[i],"");this._currentRank++}return e}}var Q=r(3099),Y=r(5476),q=r(492),$=r(467);class j{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===j.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(e===j.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(e===j.FILTER_PCF||e===j.FILTER_PCSS)return void(this.usePoissonSampling=!0)}e!==j.FILTER_PCF&&e!==j.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===j.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(j.FILTER_POISSONSAMPLING);(e||this.filter===j.FILTER_POISSONSAMPLING)&&(this.filter=e?t:j.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===j.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(j.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===j.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:j.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===j.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(j.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===j.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:j.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===j.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(j.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===j.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:j.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===j.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(j.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===j.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:j.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===j.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(j.FILTER_PCF);(e||this.filter===j.FILTER_PCF)&&(this.filter=e?t:j.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===j.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(j.FILTER_PCSS);(e||this.filter===j.FILTER_PCSS)&&(this.filter=e?t:j.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return this._darkness=e>=1?1:e<=0?0:e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return j.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(const t of e.getChildMeshes())-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(-1!==i&&this._shadowMap.renderList.splice(i,1),t)for(const t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,s,r,n=!1){this.onBeforeShadowMapRenderObservable=new C.cP,this.onAfterShadowMapRenderObservable=new C.cP,this.onBeforeShadowMapRenderMeshObservable=new C.cP,this.onAfterShadowMapRenderMeshObservable=new C.cP,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=j.FILTER_NONE,this._filteringQuality=j.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=I.Pq.Zero(),this._viewMatrix=I.uq.Zero(),this._projectionMatrix=I.uq.Zero(),this._transformMatrix=I.uq.Zero(),this._cachedPosition=new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=I.uq.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=s??null,this._useRedTextureType=!!r,this._initShaderSourceAsync(n);let a=t._shadowGenerators;a||(a=t._shadowGenerators=new Map),a.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),j._SceneComponentInitialization(this._scene);const o=this._scene.getEngine().getCaps();i?o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=1:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=2:o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new H.$(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new H.$(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=G.g.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=G.g.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(G.g.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,i,s)=>this._renderForShadowMap(e,t,i,s),this._shadowMap.customIsReadyFunction=()=>!0;const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add((()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`shadow map generation for pass id ${e.currentRenderPassId}`,1)})),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===j.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onAfterUnbindObservable.add((()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===j.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void e._debugPopGroup?.(1);const t=this.getShadowMapForRendering();t&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,t.renderTarget,!0),e.unBindFramebuffer(t.renderTarget,!0),e._debugPopGroup?.(1))}));const t=new M.ov(0,0,0,0),i=new M.ov(1,1,1,1);this._shadowMap.onClearObservable.add((e=>{this._filter===j.FILTER_PCF?e.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(t,!0,!0,!1):e.clear(i,!0,!0,!1)})),this._shadowMap.onResizeObservable.add((e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}));for(let e=Q.m.MIN_RENDERINGGROUPS;e<Q.m.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,!1)}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||j.ForceGLSL?await Promise.all([r.e(169).then(r.bind(r,169)),r.e(9468).then(r.bind(r,9468)),r.e(9386).then(r.bind(r,9386)),r.e(5426).then(r.bind(r,5426))]):(this._shaderLanguage=1,await Promise.all([r.e(7428).then(r.bind(r,7428)),r.e(2303).then(r.bind(r,2303)),r.e(355).then(r.bind(r,355)),r.e(5799).then(r.bind(r,5799))])),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new H.$(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=G.g.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=G.g.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(G.g.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new X(this._light.name+"KernelBlurX",new I.I9(1,0),this.blurKernel,1,null,G.g.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._shadowMap)})),this._kernelBlurYPostprocess=new X(this._light.name+"KernelBlurY",new I.I9(0,1),this.blurKernel,1,null,G.g.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new W.w(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,G.g.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add((e=>{e.setFloat2("screenSize",t,t),e.setTexture("textureSampler",this._shadowMap)})),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,s){let r;if(s.length)for(r=0;r<s.length;r++)this._renderSubMeshForShadowMap(s.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);if(this._transparencyShadow)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r],!0);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){const i=e.getRenderingMesh(),s=e.getEffectiveMesh(),r=this._scene,n=r.getEngine(),a=e.getMaterial();if(s._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!a||0===e.verticesCount||e._renderId===r.getRenderId())return;const o=r.useRightHandedSystem,l=s._getWorldMatrixDeterminant()<0;let h=a._getEffectiveOrientation(i);(l&&!o||!l&&o)&&(h=0===h?1:0);const c=0===h;n.setState(a.backFaceCulling,void 0,void 0,c,a.cullBackFaces);const u=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(u.mustReturn)return;const d=n.getCaps().instancedArrays&&(null!==u.visibleInstances[e._id]&&void 0!==u.visibleInstances[e._id]||i.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,d,t)){e._renderId=r.getRenderId();const o=a.shadowDepthWrapper,l=o?.getEffect(e,this,n.currentRenderPassId)??e._getDrawWrapper(),h=Y.E.GetEffect(l);n.enableEffect(l),d||i._bind(e,h,a.fillMode),this.getTransformMatrix(),h.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===z.LIGHTTYPEID_DIRECTIONALLIGHT?h.setVector3("lightDataSM",this._cachedDirection):h.setVector3("lightDataSM",this._cachedPosition);const c=this._getCamera();if(c&&h.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(c),this.getLight().getDepthMinZ(c)+this.getLight().getDepthMaxZ(c)),t&&this.enableSoftTransparentShadow&&h.setFloat2("softTransparentShadowSM",s.visibility*a.alpha,this._opacityTexture?.getAlphaFromRGB?1:0),o)e._setMainDrawWrapperOverride(l),o.standalone?o.baseMaterial.bindForSubMesh(s.getWorldMatrix(),i,e):a.bindForSubMesh(s.getWorldMatrix(),i,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(h.setTexture("diffuseSampler",this._opacityTexture),h.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),i.useBones&&i.computeBonesUsingShaders&&i.skeleton){const e=i.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(i);if(!t)return;h.setTexture("boneSampler",t),h.setFloat("boneTextureWidth",4*(e.bones.length+1))}else h.setMatrices("mBones",e.getTransformMatrices(i))}(0,$.nR)(i,h),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(h);const t=e.getMesh().bakedVertexAnimationManager;t&&t.isEnabled&&t.bind(h,d),(0,q.gS)(h,a,r)}this._useUBO||o||this._bindCustomEffectForRenderSubMeshForShadowMap(e,h,s),(0,$._8)(h,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const _=s.getWorldMatrix();d&&(s.getMeshUniformBuffer().bindToEffect(h,"Mesh"),s.transferToEffect(_)),this.forceBackFacesOnly&&n.setState(!0,0,!1,!0,a.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(i),this.onBeforeShadowMapRenderObservable.notifyObservers(h),i._processRendering(s,e,h,a.fillMode,u,d,((e,t)=>{s===i||e?(s.getMeshUniformBuffer().bindToEffect(h,"Mesh"),s.transferToEffect(e?t:_)):(i.getMeshUniformBuffer().bindToEffect(h,"Mesh"),i.transferToEffect(t))})),this.forceBackFacesOnly&&n.setState(!0,0,!1,!1,a.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(h),this.onAfterShadowMapRenderMeshObservable.notifyObservers(i)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===j.FILTER_NONE||this.filter===j.FILTER_PCSS?this._shadowMap.updateSamplingMode(G.g.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(G.g.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const i={useInstances:!1,...t},s=this.getShadowMap();if(!s)return void(e&&e(this));const r=s.renderList;if(!r)return void(e&&e(this));const n=[];for(const e of r)n.push(...e.subMeshes);if(0===n.length)return void(e&&e(this));let a=0;const o=()=>{if(this._scene&&this._scene.getEngine()){for(;this.isReady(n[a],i.useInstances,n[a].getMaterial()?.needAlphaBlendingForMesh(n[a].getMesh())??!1);)if(a++,a>=n.length)return void(e&&e(this));setTimeout(o,16)}};o()}forceCompilationAsync(e){return new Promise((t=>{this.forceCompilation((()=>{t()}),e)}))}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,s){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const r=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&r.isVerticesDataPresent(O.R.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===z.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){if(!this._shadersLoaded)return!1;const s=e.getMaterial(),r=s?.shadowDepthWrapper;if(this._opacityTexture=null,!s)return!1;const n=[];if(this._prepareShadowDefines(e,t,n,i),r){if(!r.isReadyForSubMesh(e,n,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const i=e._getDrawWrapper(void 0,!0);let r=i.effect,a=i.defines;const o=[O.R.PositionKind],l=e.getMesh();this.normalBias&&l.isVerticesDataPresent(O.R.NormalKind)&&(o.push(O.R.NormalKind),n.push("#define NORMAL"),l.nonUniformScaling&&n.push("#define NONUNIFORMSCALING"));const h=s.needAlphaTesting();if((h||s.needAlphaBlending())&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=s.opacityTexture:this._opacityTexture=s.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const e=s.alphaCutOff??j.DEFAULT_ALPHA_CUTOFF;n.push("#define ALPHATEXTURE"),h&&n.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),l.isVerticesDataPresent(O.R.UVKind)&&(o.push(O.R.UVKind),n.push("#define UV1")),l.isVerticesDataPresent(O.R.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(o.push(O.R.UV2Kind),n.push("#define UV2"))}const c=new K;if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton){o.push(O.R.MatricesIndicesKind),o.push(O.R.MatricesWeightsKind),l.numBoneInfluencers>4&&(o.push(O.R.MatricesIndicesExtraKind),o.push(O.R.MatricesWeightsExtraKind));const e=l.skeleton;n.push("#define NUM_BONE_INFLUENCERS "+l.numBoneInfluencers),l.numBoneInfluencers>0&&c.addCPUSkinningFallback(0,l),e.isUsingTextureForMatrices?n.push("#define BONETEXTURE"):n.push("#define BonesPerMesh "+(e.bones.length+1))}else n.push("#define NUM_BONE_INFLUENCERS 0");const u=l.morphTargetManager;let d=0;if(u&&(d=u.numMaxInfluencers||u.numInfluencers,d>0&&(n.push("#define MORPHTARGETS"),n.push("#define NUM_MORPH_INFLUENCERS "+d),u.isUsingTextureForTargets&&n.push("#define MORPHTARGETS_TEXTURE"),(0,$.MF)(o,l,d))),(0,q.tv)(s,this._scene,n),t&&(n.push("#define INSTANCES"),(0,$.te)(o),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const e of this.customShaderOptions.defines)-1===n.indexOf(e)&&n.push(e);const _=l.bakedVertexAnimationManager;_&&_.isEnabled&&(n.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&o.push("bakedVertexAnimationSettingsInstanced"));const p=n.join("\n");if(a!==p){a=p;let e="shadowMap";const t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],s=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],n=["Scene","Mesh"];if((0,q.TV)(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const e of this.customShaderOptions.attributes)-1===o.indexOf(e)&&o.push(e);if(this.customShaderOptions.uniforms)for(const e of this.customShaderOptions.uniforms)-1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(const e of this.customShaderOptions.samplers)-1===s.indexOf(e)&&s.push(e)}const l=this._scene.getEngine();r=l.createEffect(e,{attributes:o,uniformsNames:t,uniformBuffersNames:n,samplers:s,defines:p,fallbacks:c,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:d},shaderLanguage:this._shaderLanguage},l),i.setEffect(r,a)}if(!r.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this._blurPostProcesses&&this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses()),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const i=this._scene,s=this._light;i.shadowsEnabled&&s.shadowEnabled&&(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===j.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===j.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===j.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===j.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),s.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const r=this.getShadowMap();if(!r)return;i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix());const n=this.getShadowMapForRendering();this._filter===j.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),r.getSize().width,1/r.getSize().width,this.frustumEdgeFalloff,e)):this._filter===j.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,n),t.setTexture("depthTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/r.getSize().width,this._contactHardeningLightSizeUVRatio*r.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/r.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),I.Pq.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(I.Pq.Dot(this._lightDirection,I.Pq.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),I.uq.LookAtLHToRef(t,t.add(this._lightDirection),I.Pq.Up(),this._viewMatrix);const e=this.getShadowMap();if(e){const t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const e of t)this._shadowMap.renderList.push(e)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,i]=t.value;i===this&&this._light._shadowGenerators.delete(e)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){const e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=this._camera?.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const s=t.renderList[i];e.renderList.push(s.id)}return e}static Parse(e,t,i){const s=t.getLightById(e.lightId),r=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,n=i?i(e.mapSize,s,r):new j(e.mapSize,s,void 0,r),a=n.getShadowMap();for(let i=0;i<e.renderList.length;i++)t.getMeshesById(e.renderList[i]).forEach((function(e){a&&(a.renderList||(a.renderList=[]),a.renderList.push(e))}));return void 0!==e.id&&(n.id=e.id),n.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&n.setDarkness(e.darkness),e.transparencyShadow&&n.setTransparencyShadow(!0),void 0!==e.frustumEdgeFalloff&&(n.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(n.bias=e.bias),void 0!==e.normalBias&&(n.normalBias=e.normalBias),e.usePercentageCloserFiltering?n.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?n.useContactHardeningShadow=!0:e.usePoissonSampling?n.usePoissonSampling=!0:e.useExponentialShadowMap?n.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?n.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?n.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?n.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?n.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(n.useBlurExponentialShadowMap=!0),void 0!==e.contactHardeningLightSizeUVRatio&&(n.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(n.filteringQuality=e.filteringQuality),e.depthScale&&(n.depthScale=e.depthScale),e.blurScale&&(n.blurScale=e.blurScale),e.blurBoxOffset&&(n.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(n.useKernelBlur=e.useKernelBlur),e.blurKernel&&(n.blurKernel=e.blurKernel),n}}j.CLASSNAME="ShadowGenerator",j.ForceGLSL=!1,j.FILTER_NONE=0,j.FILTER_EXPONENTIALSHADOWMAP=1,j.FILTER_POISSONSAMPLING=2,j.FILTER_BLUREXPONENTIALSHADOWMAP=3,j.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,j.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,j.FILTER_PCF=6,j.FILTER_PCSS=7,j.QUALITY_HIGH=0,j.QUALITY_MEDIUM=1,j.QUALITY_LOW=2,j.DEFAULT_ALPHA_CUTOFF=.5,j._SceneComponentInitialization=e=>{throw(0,F.n)("ShadowGeneratorSceneComponent")};var Z=r(863),J=r(7931),ee=r(998),te=r(4494),ie=r(2572);class se extends B{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){let e=0,t=0;if(this.mode===se.PERSPECTIVE_CAMERA)this.fovMode===se.FOVMODE_VERTICAL_FIXED?(t=2*this.minZ*Math.tan(this.fov/2),e=this.getEngine().getAspectRatio(this)*t):(e=2*this.minZ*Math.tan(this.fov/2),t=e/this.getEngine().getAspectRatio(this));else{const i=this.getEngine().getRenderWidth()/2,s=this.getEngine().getRenderHeight()/2;e=(this.orthoRight??i)-(this.orthoLeft??-i),t=(this.orthoTop??s)-(this.orthoBottom??-s)}return e*t}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}get hasMoved(){return this._hasMoved}constructor(e,t,i,s=!0){super(e,i,!1),this._position=I.Pq.Zero(),this._upVector=I.Pq.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=se.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new te.L(0,0,1,1),this.layerMask=268435455,this.fovMode=se.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=se.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new C.cP,this.onProjectionMatrixChangedObservable=new C.cP,this.onAfterCheckInputsObservable=new C.cP,this.onRestoreStateObservable=new C.cP,this.isRigCamera=!1,this._hasMoved=!1,this._rigCameras=new Array,this._skipRendering=!1,this._projectionMatrix=new I.uq,this._postProcesses=new Array,this._activeMeshes=new J.L(256),this._globalPosition=I.Pq.Zero(),this._computedViewMatrix=I.uq.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=I.uq.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=I.PT.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),s&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}hasStateStored(){return!!this._stateStored}_restoreStateValues(){return!!this._stateStored&&(this.fov=this._storedFov,!0)}restoreState(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}isReady(e=!1){if(e)for(const e of this._postProcesses)if(e&&!e.isReady())return!1;return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return!!super._isSynchronized()&&this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===se.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._hasMoved=!1,this._checkInputs(),this.cameraRigMode!==se.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let e=0,t=this._rigCameras.length;e<t;e++){const t=this._rigCameras[e],i=t._rigPostProcess;i?("pass"===i.getEffectName()&&(t.isIntermediate=0===this._postProcesses.length),t._postProcesses=this._postProcesses.slice(0).concat(i),i.markTextureDirty()):t._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(l.V.Error("You're trying to reuse a post process not defined as reusable."),0):(null==t||t<0?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}_getViewMatrix(){return I.uq.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()||(this._hasMoved=!0,this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix)),this._computedViewMatrix}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,void 0!==e&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const t=this.getEngine(),i=this.getScene(),s=t.useReverseDepthBuffer;if(this.mode===se.PERSPECTIVE_CAMERA){let e;this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=t.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),e=i.useRightHandedSystem?I.uq.PerspectiveFovRHToRef:I.uq.PerspectiveFovLHToRef,e(this.fov,t.getAspectRatio(this),s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===se.FOVMODE_VERTICAL_FIXED,t.isNDCHalfZRange,this.projectionPlaneTilt,s)}else{const e=t.getRenderWidth()/2,r=t.getRenderHeight()/2;i.useRightHandedSystem?this.oblique?I.uq.ObliqueOffCenterRHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):I.uq.OrthoOffCenterRHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange):this.oblique?I.uq.ObliqueOffCenterLHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):I.uq.OrthoOffCenterLHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=this.oblique?.angle,this._cache.obliqueLength=this.oblique?.length,this._cache.obliqueOffset=this.oblique?.offset,this._cache.renderWidth=t.getRenderWidth(),this._cache.renderHeight=t.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){return(this.radius||(this.target?I.Pq.Distance(this.position,this.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?ie.P.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=ie.P.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let t=!1;return this.rigCameras.forEach((i=>{i._updateFrustumPlanes(),t=t||e.isInFrustum(i._frustumPlanes)})),t}return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw(0,F.n)("Ray")}getForwardRayToRef(e,t=100,i,s){throw(0,F.n)("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose()}if(this._parentContainer){const e=this._parentContainer.cameras.indexOf(this);e>-1&&this._parentContainer.cameras.splice(e,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==se.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let e=this._postProcesses.length;for(;--e>=0;){const t=this._postProcesses[e];t&&t.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=ee.S0.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==se.RIG_MODE_NONE){const e=this.createRigCamera(this.name+"_L",0);e&&(e._isLeftCamera=!0);const t=this.createRigCamera(this.name+"_R",1);t&&(t._isRightCamera=!0),e&&t&&(this._rigCameras.push(e),this._rigCameras.push(t))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return I.uq.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=ee.S0.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===se.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=N.p.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),N.p.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=N.p.Clone(se.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=I.Pq.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){I.Pq.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,s=0,r=!0){return B.Construct(e,t,i,{interaxial_distance:s,isStereoscopicSideBySide:r})||(()=>se._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,s=se.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),r=N.p.Parse(s,e,t);if(void 0!==e.parentId&&(r._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),r.inputs&&(r.inputs.parse(e),r._setupInputs()),e.upVector&&(r.upVector=I.Pq.FromArray(e.upVector)),r.setPosition&&(r.position.copyFromFloats(0,0,0),r.setPosition(I.Pq.FromArray(e.position))),e.target&&r.setTarget&&r.setTarget(I.Pq.FromArray(e.target)),e.cameraRigMode){const t=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};r.setCameraRigMode(e.cameraRigMode,t)}if(e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],s=(0,V.n9)("BABYLON.Animation");s&&r.animations.push(s.Parse(i))}B.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&r.setEnabled(e.isEnabled),r}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}se._CreateDefaultParsedCamera=(e,t)=>{throw(0,F.n)("UniversalCamera")},se.PERSPECTIVE_CAMERA=0,se.ORTHOGRAPHIC_CAMERA=1,se.FOVMODE_VERTICAL_FIXED=0,se.FOVMODE_HORIZONTAL_FIXED=1,se.RIG_MODE_NONE=0,se.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,se.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,se.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,se.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,se.RIG_MODE_STEREOSCOPIC_INTERLACED=14,se.RIG_MODE_VR=20,se.RIG_MODE_CUSTOM=22,se.ForceAttachControlToAlwaysPreventDefault=!1,(0,w.Cg)([(0,D.P_)("position")],se.prototype,"_position",void 0),(0,w.Cg)([(0,D.P_)("upVector")],se.prototype,"_upVector",void 0),(0,w.Cg)([(0,D.lK)()],se.prototype,"orthoLeft",null),(0,w.Cg)([(0,D.lK)()],se.prototype,"orthoRight",null),(0,w.Cg)([(0,D.lK)()],se.prototype,"orthoBottom",null),(0,w.Cg)([(0,D.lK)()],se.prototype,"orthoTop",null),(0,w.Cg)([(0,D.lK)()],se.prototype,"fov",void 0),(0,w.Cg)([(0,D.lK)()],se.prototype,"projectionPlaneTilt",void 0),(0,w.Cg)([(0,D.lK)()],se.prototype,"minZ",void 0),(0,w.Cg)([(0,D.lK)()],se.prototype,"maxZ",void 0),(0,w.Cg)([(0,D.lK)()],se.prototype,"inertia",void 0),(0,w.Cg)([(0,D.lK)()],se.prototype,"mode",null),(0,w.Cg)([(0,D.lK)()],se.prototype,"layerMask",void 0),(0,w.Cg)([(0,D.lK)()],se.prototype,"fovMode",void 0),(0,w.Cg)([(0,D.lK)()],se.prototype,"cameraRigMode",void 0),(0,w.Cg)([(0,D.lK)()],se.prototype,"interaxialDistance",void 0),(0,w.Cg)([(0,D.lK)()],se.prototype,"isStereoscopicSideBySide",void 0),r(8852),r(9977);class re{get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,s=!1,r=G.g.TRILINEAR_SAMPLINGMODE,n=!1,a){this._shaderLanguage=0,this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._shadersLoaded=!1,this._scene=e,this._storeNonLinearDepth=s,this._storeCameraSpaceZ=n,this.isPacked=0===t,this.isPacked?this.clearColor=new M.ov(1,1,1,1):this.clearColor=new M.ov(n?1e8:1,0,0,1),this._initShaderSourceAsync(),re._SceneComponentInitialization(this._scene);const o=e.getEngine();this._camera=i,r!==G.g.NEAREST_SAMPLINGMODE&&(1!==t||o._caps.textureFloatLinearFiltering||(r=G.g.NEAREST_SAMPLINGMODE),2!==t||o._caps.textureHalfFloatLinearFiltering||(r=G.g.NEAREST_SAMPLINGMODE));const l=this.isPacked||!o._features.supportExtendedTextureFormats?5:6;this._depthMap=new H.$(a??"DepthRenderer",{width:o.getRenderWidth(),height:o.getRenderHeight()},this._scene,!1,!0,t,!1,r,void 0,void 0,void 0,l),this._depthMap.wrapU=G.g.CLAMP_ADDRESSMODE,this._depthMap.wrapV=G.g.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add((e=>{e.clear(this.clearColor,!0,!0,!0)})),this._depthMap.onBeforeBindObservable.add((()=>{o._debugPushGroup?.("depth renderer",1)})),this._depthMap.onAfterUnbindObservable.add((()=>{o._debugPopGroup?.(1)})),this._depthMap.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],s=i.getRenderingMesh(),r=s._getInstancesRenderList(i._id,!!i.getReplacementMesh()),n=o.getCaps().instancedArrays&&(null!==r.visibleInstances[i._id]&&void 0!==r.visibleInstances[i._id]||s.hasThinInstances);if(!this.isReady(i,n))return!1}return!0};const h=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),s=this._scene,r=s.getEngine(),n=e.getMaterial();if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!n||i.infiniteDistance||n.disableDepthWrite||0===e.verticesCount||e._renderId===s.getRenderId())return;const a=i._getWorldMatrixDeterminant()<0;let o=n._getEffectiveOrientation(t);a&&(o=0===o?1:0);const l=0===o;r.setState(n.backFaceCulling,0,!1,l,this.reverseCulling?!n.cullBackFaces:n.cullBackFaces);const h=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(h.mustReturn)return;const c=r.getCaps().instancedArrays&&(null!==h.visibleInstances[e._id]&&void 0!==h.visibleInstances[e._id]||t.hasThinInstances),u=this._camera||s.activeCamera;if(this.isReady(e,c)&&u){e._renderId=s.getRenderId();const a=i._internalAbstractMeshDataInfo._materialForRenderPass?.[r.currentRenderPassId];let o=e._getDrawWrapper();!o&&a&&(o=a._getDrawWrapper());const l=u.mode===se.ORTHOGRAPHIC_CAMERA;if(!o)return;const d=o.effect;let _,p;if(r.enableEffect(o),c||t._bind(e,d,n.fillMode),a?a.bindForSubMesh(i.getWorldMatrix(),i,e):(d.setMatrix("viewProjection",s.getTransformMatrix()),d.setMatrix("world",i.getWorldMatrix()),this._storeCameraSpaceZ&&d.setMatrix("view",s.getViewMatrix())),l?(_=!r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:1,p=r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:1):(_=r.useReverseDepthBuffer&&r.isNDCHalfZRange?u.minZ:r.isNDCHalfZRange?0:u.minZ,p=r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:u.maxZ),d.setFloat2("depthValues",_,_+p),!a){if(n.needAlphaTesting()){const e=n.getAlphaTestTexture();e&&(d.setTexture("diffuseSampler",e),d.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,$.f$)(t,d),(0,q.gS)(d,n,s),(0,$.nR)(t,d),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(d);const i=e.getMesh().bakedVertexAnimationManager;i&&i.isEnabled&&i.bind(d,c),n.pointsCloud&&d.setFloat("pointSize",n.pointSize)}t._processRendering(i,e,d,n.fillMode,h,c,((e,t)=>d.setMatrix("world",t)))}};this._depthMap.customRenderFunction=(e,t,i,s)=>{let r;if(s.length)for(r=0;r<s.length;r++)h(s.data[r]);for(r=0;r<e.length;r++)h(e.data[r]);for(r=0;r<t.length;r++)h(t.data[r]);if(this.forceDepthWriteTransparentMeshes)for(r=0;r<i.length;r++)h(i.data[r]);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||re.ForceGLSL?await Promise.all([Promise.resolve().then(r.bind(r,9977)),Promise.resolve().then(r.bind(r,8852))]):(this._shaderLanguage=1,await Promise.all([r.e(8453).then(r.bind(r,8453)),r.e(8939).then(r.bind(r,8939))])),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;const i=this._scene.getEngine(),s=e.getMesh(),r=s.getScene(),n=s._internalAbstractMeshDataInfo._materialForRenderPass?.[i.currentRenderPassId];if(n)return n.isReadyForSubMesh(s,e,t);const a=e.getMaterial();if(!a||a.disableDepthWrite)return!1;const o=[],l=[O.R.PositionKind];a.needAlphaTesting()&&a.getAlphaTestTexture()&&(o.push("#define ALPHATEST"),s.isVerticesDataPresent(O.R.UVKind)&&(l.push(O.R.UVKind),o.push("#define UV1")),s.isVerticesDataPresent(O.R.UV2Kind)&&(l.push(O.R.UV2Kind),o.push("#define UV2")));const h=new K;if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){l.push(O.R.MatricesIndicesKind),l.push(O.R.MatricesWeightsKind),s.numBoneInfluencers>4&&(l.push(O.R.MatricesIndicesExtraKind),l.push(O.R.MatricesWeightsExtraKind)),o.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),s.numBoneInfluencers>0&&h.addCPUSkinningFallback(0,s);const e=s.skeleton;e.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(e.bones.length+1))}else o.push("#define NUM_BONE_INFLUENCERS 0");const c=s.morphTargetManager;let u=0;c&&(u=c.numMaxInfluencers||c.numInfluencers,u>0&&(o.push("#define MORPHTARGETS"),o.push("#define NUM_MORPH_INFLUENCERS "+u),c.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),(0,$.MF)(l,s,u))),a.pointsCloud&&o.push("#define POINTSIZE"),t&&(o.push("#define INSTANCES"),(0,$.te)(l),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES"));const d=s.bakedVertexAnimationManager;d&&d.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&l.push("bakedVertexAnimationSettingsInstanced")),this._storeNonLinearDepth&&o.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&o.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&o.push("#define PACKED"),(0,q.tv)(a,r,o);const _=e._getDrawWrapper(void 0,!0),p=_.defines,f=o.join("\n");if(p!==f){const e=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];(0,q.TV)(e),_.setEffect(i.createEffect("depth",{attributes:l,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:f,fallbacks:h,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:u},shaderLanguage:this._shaderLanguage},i))}return _.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t]}}}re.ForceGLSL=!1,re._SceneComponentInitialization=e=>{throw(0,F.n)("DepthRendererSceneComponent")};var ne=r(6096),ae=r(9610);ae.l.ShadersStore.minmaxReduxPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform sampler2D sourceTexture;uniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(sourceTexture,coord,0).r;float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;float minz=min(min(min(f1,f2),f3),f4);\n#ifdef DEPTH_REDUX\nfloat maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#else\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(MAIN)\nuniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(f1.x,f2.x);float maxz=max(f1.y,f2.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(LAST)\nvoid main(void)\n{glFragColor=vec4(0.);if (true) { \ndiscard;}}\n#endif\n";class oe{constructor(e){this.onAfterReductionPerformed=new C.cP,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new ne.X(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{this._postProcessManager._rebuild()}))}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,s=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=s;const r=this._camera.getScene(),n=new W.w("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,r.getEngine(),!1,"#define INITIAL"+(t?"\n#define DEPTH_REDUX":""),i,void 0,void 0,void 0,7);n.autoClear=!1,n.forceFullscreenViewport=s;let a=this._sourceTexture.getRenderWidth(),o=this._sourceTexture.getRenderHeight();n.onApply=((e,t)=>i=>{i.setTexture("sourceTexture",this._sourceTexture),i.setFloat2("texSize",e,t)})(a,o),this._reductionSteps.push(n);let l=1;for(;a>1||o>1;){a=Math.max(Math.round(a/2),1),o=Math.max(Math.round(o/2),1);const e=new W.w("Reduction phase "+l,"minmaxRedux",["texSize"],null,{width:a,height:o},null,1,r.getEngine(),!1,"#define "+(1==a&&1==o?"LAST":1==a||1==o?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(e.autoClear=!1,e.forceFullscreenViewport=s,e.onApply=((e,t)=>i=>{1==e||1==t?i.setInt2("texSize",e,t):i.setFloat2("texSize",e,t)})(a,o),this._reductionSteps.push(e),l++,1==a&&1==o){const t=(e,t,i)=>{const s=new Float32Array(4*e*t),n={min:0,max:0};return()=>{r.getEngine()._readTexturePixels(i.inputTexture.texture,e,t,-1,0,s,!1),n.min=s[0],n.max=s[1],this.onAfterReductionPerformed.notifyObservers(n)}};e.onAfterRenderObservable.add(t(a,o,e))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){!this._onAfterUnbindObserver&&this._sourceTexture&&(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add((()=>{const e=this._camera.getScene().getEngine();e._debugPushGroup?.("min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),e.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),e._debugPopGroup?.(1)})),this._activated=!0)}deactivate(){this._onAfterUnbindObserver&&this._sourceTexture&&(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}class le extends oe{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){const s=this._camera.getScene();this._depthRenderer&&(delete s._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(s._depthRenderer||(s._depthRenderer={}),(e=this._depthRenderer=new re(s,t,this._camera,!1,1)).enabled=!1,this._depthRendererId="minmax"+this._camera.id,s._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,s=!0){super.setSourceTexture(e,t,i,s)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const e=this._depthRenderer.getDepthMap().getScene();e&&delete e._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const he=I.Pq.Up(),ce=I.Pq.Zero(),ue=new I.Pq,de=new I.Pq,_e=new I.uq;class pe extends j{_validateFilter(e){return e===j.FILTER_NONE||e===j.FILTER_PCF||e===j.FILTER_PCSS?e:(l.V.Error('Unsupported filter "'+e+'"!'),j.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,pe.MIN_CASCADES_COUNT),pe.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._freezeShadowCastersBoundingInfoObservable||e||(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add((()=>this._computeShadowCastersBoundingInfo()))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let t=0;t<e.length;t++){const i=e[t];if(!i)continue;const s=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(s.minimumWorld),this._scbiMax.maximizeInPlace(s.maximumWorld)}const t=this._scene.meshes;for(let e=0;e<t.length;e++){const i=t[e];if(!(i&&i.isVisible&&i.isEnabled&&i.receiveShadows))continue;const s=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(s.minimumWorld),this._scbiMax.maximizeInPlace(s.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return pe.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();t?this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&0!==t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0):this._shadowMaxZ=e}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e)return this._depthReducer&&this._depthReducer.deactivate(),void this.setMinMaxDistance(0,1);this._depthReducer||(this._depthReducer=new le(t),this._depthReducer.onAfterReductionPerformed.add((e=>{let t=e.min,i=e.max;t>=i&&(t=0,i=1),t==this._minDistance&&i==this._maxDistance||this.setMinMaxDistance(t,i)})),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){return this._depthReducer?.depthRenderer?.getDepthMap().refreshRate??-1}set autoCalcDepthBoundsRefreshRate(e){this._depthReducer?.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ||this._shadowMaxZ,s=i-t,r=this._minDistance,n=t+r*s,a=t+(this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance)*s,o=a-n,l=a/n;for(let e=0;e<this._cascades.length;++e){const i=(e+1)/this._numCascades,a=n*l**i,h=n+o*i,c=this._lambda*(a-h)+h;this._cascades[e].prevBreakDistance=0===e?r:this._cascades[e-1].breakDistance,this._cascades[e].breakDistance=(c-t)/s,this._viewSpaceFrustumsZ[e]=c,this._frustumLengths[e]=(this._cascades[e].breakDistance-this._cascades[e].prevBreakDistance)*s}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;I.Pq.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(I.Pq.Dot(this._lightDirection,I.Pq.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const t=e.getEngine().useReverseDepthBuffer;for(let i=0;i<this._numCascades;++i){this._computeFrustumInWorldSpace(i),this._computeCascadeFrustum(i),this._cascadeMaxExtents[i].subtractToRef(this._cascadeMinExtents[i],ue),this._frustumCenter[i].addToRef(this._lightDirection.scale(this._cascadeMinExtents[i].z),this._shadowCameraPos[i]),I.uq.LookAtLHToRef(this._shadowCameraPos[i],this._frustumCenter[i],he,this._viewMatrices[i]);let s=0,r=ue.z;const n=this._shadowCastersBoundingInfo;n.update(this._viewMatrices[i]),r=Math.min(r,n.boundingBox.maximumWorld.z),s=this._depthClamp&&this.filter!==j.FILTER_PCSS?Math.max(s,n.boundingBox.minimumWorld.z):Math.min(s,n.boundingBox.minimumWorld.z),I.uq.OrthoOffCenterLHToRef(this._cascadeMinExtents[i].x,this._cascadeMaxExtents[i].x,this._cascadeMinExtents[i].y,this._cascadeMaxExtents[i].y,t?r:s,t?s:r,this._projectionMatrices[i],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[i].z=s,this._cascadeMaxExtents[i].z=r,this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),I.Pq.TransformCoordinatesToRef(ce,this._transformMatrices[i],ue),ue.scaleInPlace(this._mapSize/2),de.copyFromFloats(Math.round(ue.x),Math.round(ue.y),Math.round(ue.z)),de.subtractInPlace(ue).scaleInPlace(2/this._mapSize),I.uq.TranslationToRef(de.x,de.y,0,_e),this._projectionMatrices[i].multiplyToRef(_e,this._projectionMatrices[i]),this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),this._transformMatrices[i].copyToArray(this._transformMatricesAsArray,16*i)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,s=this._cascades[e].breakDistance,r=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const n=0===t.maxZ,a=t.maxZ;n&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));const o=I.uq.Invert(t.getTransformationMatrix());n&&(t.maxZ=a,t.getProjectionMatrix(!0));const l=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let t=0;t<pe._FrustumCornersNDCSpace.length;++t)ue.copyFrom(pe._FrustumCornersNDCSpace[(t+l)%pe._FrustumCornersNDCSpace.length]),r&&-1===ue.z&&(ue.z=0),I.Pq.TransformCoordinatesToRef(ue,o,this._frustumCornersWorldSpace[e][t]);for(let t=0;t<pe._FrustumCornersNDCSpace.length/2;++t)ue.copyFrom(this._frustumCornersWorldSpace[e][t+4]).subtractInPlace(this._frustumCornersWorldSpace[e][t]),de.copyFrom(ue).scaleInPlace(i),ue.scaleInPlace(s),ue.addInPlace(this._frustumCornersWorldSpace[e][t]),this._frustumCornersWorldSpace[e][t+4].copyFrom(ue),this._frustumCornersWorldSpace[e][t].addInPlace(de)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),this._getCamera()){for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][t]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let t=0;for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i){const s=this._frustumCornersWorldSpace[e][i].subtractToRef(this._frustumCenter[e],ue).length();t=Math.max(t,s)}t=Math.ceil(16*t)/16,this._cascadeMaxExtents[e].copyFromFloats(t,t,t),this._cascadeMinExtents[e].copyFromFloats(-t,-t,-t)}else{const t=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,ue),I.uq.LookAtLHToRef(t,ue,he,_e);for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)I.Pq.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][t],_e,ue),this._cascadeMinExtents[e].minimizeInPlace(ue),this._cascadeMaxExtents[e].maximizeInPlace(ue)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=t.q.LastCreatedEngine;return!!e&&e._features.supportCSM}constructor(e,t,i,s,r=!0){pe.IsSupported?(super(e,t,i,s,r),this.usePercentageCloserFiltering=!0):l.V.Error("CascadedShadowMap is not supported by the current engine.")}_initializeGenerator(){this.penumbraDarkness=this.penumbraDarkness??1,this._numCascades=this._numCascades??pe.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=this.stabilizeCascades??!1,this._freezeShadowCastersBoundingInfoObservable=this._freezeShadowCastersBoundingInfoObservable??null,this.freezeShadowCastersBoundingInfo=this.freezeShadowCastersBoundingInfo??!1,this._scbiMin=this._scbiMin??new I.Pq(0,0,0),this._scbiMax=this._scbiMax??new I.Pq(0,0,0),this._shadowCastersBoundingInfo=this._shadowCastersBoundingInfo??new Z.j(new I.Pq(0,0,0),new I.Pq(0,0,0)),this._breaksAreDirty=this._breaksAreDirty??!0,this._minDistance=this._minDistance??0,this._maxDistance=this._maxDistance??1,this._currentLayer=this._currentLayer??0,this._shadowMaxZ=this._shadowMaxZ??this._getCamera()?.maxZ??1e4,this._debug=this._debug??!1,this._depthClamp=this._depthClamp??!0,this._cascadeBlendPercentage=this._cascadeBlendPercentage??.1,this._lambda=this._lambda??.5,this._autoCalcDepthBounds=this._autoCalcDepthBounds??!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new H.$(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForCSMShadowGenerator-${this._light.name}`),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(2*this._numCascades),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let e=0;e<this._numCascades;++e){this._cascades[e]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[e]=I.uq.Zero(),this._projectionMatrices[e]=I.uq.Zero(),this._transformMatrices[e]=I.uq.Zero(),this._cascadeMinExtents[e]=new I.Pq,this._cascadeMaxExtents[e]=new I.Pq,this._frustumCenter[e]=new I.Pq,this._shadowCameraPos[e]=new I.Pq,this._frustumCornersWorldSpace[e]=new Array(pe._FrustumCornersNDCSpace.length);for(let t=0;t<pe._FrustumCornersNDCSpace.length;++t)this._frustumCornersWorldSpace[e][t]=new I.Pq}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===j.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onBeforeBindObservable.add((()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()})),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==j.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene,s=this._light;if(!i.shadowsEnabled||!s.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const r=this._getCamera();r&&this._shadowMaxZ<=(r.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const r=this.getShadowMap();if(!r)return;const n=r.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===j.FILTER_PCF)t.setDepthStencilTexture("shadowTexture"+e,r),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n,1/n,this.frustumEdgeFalloff,e);else if(this._filter===j.FILTER_PCSS){for(let e=0;e<this._numCascades;++e)this._lightSizeUVCorrection[2*e+0]=0===e?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[e].x-this._cascadeMinExtents[e].x),this._lightSizeUVCorrection[2*e+1]=0===e?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[e].y-this._cascadeMinExtents[e].y),this._depthCorrection[e]=0===e?1:(this._cascadeMaxExtents[e].z-this._cascadeMinExtents[e].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowTexture"+e,r),t.setTexture("depthTexture"+e,r),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n,this._contactHardeningLightSizeUVRatio*n,this.frustumEdgeFalloff,e)}else t.setTexture("shadowTexture"+e,r),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n,1/n,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const s=t.renderList[i];e.renderList.push(s.id)}return e}static Parse(e,t){const i=j.Parse(e,t,((e,t,i)=>new pe(e,t,void 0,i)));return void 0!==e.numCascades&&(i.numCascades=e.numCascades),void 0!==e.debug&&(i.debug=e.debug),void 0!==e.stabilizeCascades&&(i.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(i.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(i.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(i.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(i.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}pe._FrustumCornersNDCSpace=[new I.Pq(-1,1,-1),new I.Pq(1,1,-1),new I.Pq(1,-1,-1),new I.Pq(-1,-1,-1),new I.Pq(-1,1,1),new I.Pq(1,1,1),new I.Pq(1,-1,1),new I.Pq(-1,-1,1)],pe.CLASSNAME="CascadedShadowGenerator",pe.DEFAULT_CASCADES_COUNT=4,pe.MIN_CASCADES_COUNT=2,pe.MAX_CASCADES_COUNT=4,pe._SceneComponentInitialization=e=>{throw(0,F.n)("ShadowGeneratorSceneComponent")};var fe=r(6945);const me={};function ge(e,t){me[e]=t}ge(fe.v.NAME_SHADOWGENERATOR,((e,t)=>{if(void 0!==e.shadowGenerators&&null!==e.shadowGenerators)for(let i=0,s=e.shadowGenerators.length;i<s;i++){const s=e.shadowGenerators[i];s.className===pe.CLASSNAME?pe.Parse(s,t):j.Parse(s,t)}}));class ve{constructor(e){this.name=fe.v.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(fe.v.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){const t=i.getShadowGenerators();if(t){const i=t.values();for(let t=i.next();!0!==t.done;t=i.next()){const i=t.value;e.shadowGenerators.push(i.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const s=t.lights[i],r=s.getShadowGenerators();if(s.isEnabled()&&s.shadowEnabled&&r){const i=r.values();for(let s=i.next();!0!==s.done;s=i.next()){const i=s.value.getShadowMap();-1!==t.textures.indexOf(i)&&e.push(i)}}}}}j._SceneComponentInitialization=e=>{let t=e._getComponent(fe.v.NAME_SHADOWGENERATOR);t||(t=new ve(e),e._addComponent(t))};var be=r(9794);class xe{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,s,r){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&(-1!==t.prePassRenderer.getIndex(2)||-1!==t.prePassRenderer.getIndex(11))){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=s.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const r=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=r.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==r.frameId&&(this._lastUpdateFrameId=r.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=s.clone()}}}var Se=r(1088),Te=r(8986),ye=r(9526);class Ce extends Te.i{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new I.uq,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return!!e&&(!this._storeEffectOnSubMeshes||!e.subMeshes||0===e.subMeshes.length||this.isReadyForSubMesh(e,e.subMeshes[0],t))}_isReadyForSubMesh(e){const t=e.materialDefines;return!(this.checkReadyOnEveryCall||!e.effect||!t||t._renderId!==this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null,i){super._afterBind(e,t,i),this.getScene()._cachedEffect=t,i?i._drawWrapper._forceRebindOnNextCall=!1:this._drawWrapper._forceRebindOnNextCall=!1}_mustRebind(e,t,i,s=1){return i._drawWrapper._forceRebindOnNextCall||e.isCachedMaterialInvalid(this,t,s)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}class Pe{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,g.$.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._TranslucencyIntensityTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get TranslucencyColorTextureEnabled(){return this._TranslucencyColorTextureEnabled}static set TranslucencyColorTextureEnabled(e){this._TranslucencyColorTextureEnabled!==e&&(this._TranslucencyColorTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,g.$.MarkAllMaterialsAsDirty(1))}}Pe._DiffuseTextureEnabled=!0,Pe._DetailTextureEnabled=!0,Pe._DecalMapEnabled=!0,Pe._AmbientTextureEnabled=!0,Pe._OpacityTextureEnabled=!0,Pe._ReflectionTextureEnabled=!0,Pe._EmissiveTextureEnabled=!0,Pe._SpecularTextureEnabled=!0,Pe._BumpTextureEnabled=!0,Pe._LightmapTextureEnabled=!0,Pe._RefractionTextureEnabled=!0,Pe._ColorGradingTextureEnabled=!0,Pe._FresnelEnabled=!0,Pe._ClearCoatTextureEnabled=!0,Pe._ClearCoatBumpTextureEnabled=!0,Pe._ClearCoatTintTextureEnabled=!0,Pe._SheenTextureEnabled=!0,Pe._AnisotropicTextureEnabled=!0,Pe._ThicknessTextureEnabled=!0,Pe._RefractionIntensityTextureEnabled=!0,Pe._TranslucencyIntensityTextureEnabled=!0,Pe._TranslucencyColorTextureEnabled=!0,Pe._IridescenceTextureEnabled=!0;var Ee=r(2277);class Ae extends ye.M{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class Re extends Ee.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"DetailMap",140,new Ae,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=Te.i.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&Pe.DetailTextureEnabled&&!this._texture.isReady())}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&Pe.DetailTextureEnabled&&this._isEnabled?((0,$.YT)(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||this._texture&&Pe.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),(0,$.mA)(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&Pe.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture?.dispose()}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}(0,w.Cg)([(0,D.uM)("detailTexture"),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"texture",void 0),(0,w.Cg)([(0,D.lK)()],Re.prototype,"diffuseBlendLevel",void 0),(0,w.Cg)([(0,D.lK)()],Re.prototype,"roughnessBlendLevel",void 0),(0,w.Cg)([(0,D.lK)()],Re.prototype,"bumpLevel",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"normalBlendMethod",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Re.prototype,"isEnabled",void 0);const Ie={effect:null,subMesh:null};class Me extends ye.M{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class Oe extends Ce{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t,i=!1){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new M.v9(0,0,0),this.diffuseColor=new M.v9(1,1,1),this.specularColor=new M.v9(1,1,1),this.emissiveColor=new M.v9(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._shadersLoaded=!1,this._renderTargets=new J.L(16),this._worldViewProjectionMatrix=I.uq.Zero(),this._globalAmbientColor=new M.v9(0,0,0),this._cacheHasRenderTargetTextures=!1;const s=this.getScene().getEngine();!s.isWebGPU||i||Oe.ForceGLSL||(this._uniformBuffer&&this._uniformBuffer.dispose(),this._uniformBuffer=new k.D(s,void 0,void 0,this.name,!0),this._shaderLanguage=1),this.detailMap=new Re(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new xe,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Oe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),Oe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return!!(Oe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||!!(Oe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled)}needAlphaTesting(){return!!this._forceAlphaTest||this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===Te.i.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==Te.i.MATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){this._uniformBufferLayoutBuilt||this.buildUniformLayout();const s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new Me(this._eventInfo.defineNames));const n=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=n.getEngine();a._needNormals=(0,$.az)(n,e,a,!0,this._maxSimultaneousLights,this._disableLighting),(0,$.VO)(n,a);const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if((0,$.N4)(n,a,this.canRenderToMRT&&!l),(0,$.Nc)(n,a,l),a._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a._needUVs=!1;for(let e=1;e<=6;++e)a["MAINUV"+e]=!1;if(n.texturesEnabled){if(a.DIFFUSEDIRECTUV=0,a.BUMPDIRECTUV=0,a.AMBIENTDIRECTUV=0,a.OPACITYDIRECTUV=0,a.EMISSIVEDIRECTUV=0,a.SPECULARDIRECTUV=0,a.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&Oe.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;(0,$.YT)(this._diffuseTexture,a,"DIFFUSE")}else a.DIFFUSE=!1;if(this._ambientTexture&&Oe.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return!1;(0,$.YT)(this._ambientTexture,a,"AMBIENT")}else a.AMBIENT=!1;if(this._opacityTexture&&Oe.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return!1;(0,$.YT)(this._opacityTexture,a,"OPACITY"),a.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else a.OPACITY=!1;if(this._reflectionTexture&&Oe.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking())return!1;switch(a._needNormals=!0,a.REFLECTION=!0,a.ROUGHNESS=this._roughness>0,a.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,a.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===G.g.INVCUBIC_MODE,a.REFLECTIONMAP_3D=this._reflectionTexture.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,a.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case G.g.EXPLICIT_MODE:a.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case G.g.PLANAR_MODE:a.setReflectionMode("REFLECTIONMAP_PLANAR");break;case G.g.PROJECTION_MODE:a.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case G.g.SKYBOX_MODE:a.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case G.g.SPHERICAL_MODE:a.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case G.g.EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case G.g.FIXED_EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case G.g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case G.g.CUBIC_MODE:case G.g.INVCUBIC_MODE:default:a.setReflectionMode("REFLECTIONMAP_CUBIC")}a.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else a.REFLECTION=!1,a.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&Oe.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;(0,$.YT)(this._emissiveTexture,a,"EMISSIVE")}else a.EMISSIVE=!1;if(this._lightmapTexture&&Oe.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;(0,$.YT)(this._lightmapTexture,a,"LIGHTMAP"),a.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,a.RGBDLIGHTMAP=this._lightmapTexture.isRGBD}else a.LIGHTMAP=!1;if(this._specularTexture&&Oe.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return!1;(0,$.YT)(this._specularTexture,a,"SPECULAR"),a.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}else a.SPECULAR=!1;if(n.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&Oe.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;(0,$.YT)(this._bumpTexture,a,"BUMP"),a.PARALLAX=this._useParallax,a.PARALLAX_RHS=n.useRightHandedSystem,a.PARALLAXOCCLUSION=this._useParallaxOcclusion,a.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else a.BUMP=!1,a.PARALLAX=!1,a.PARALLAX_RHS=!1,a.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&Oe.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return!1;a._needUVs=!0,a.REFRACTION=!0,a.REFRACTIONMAP_3D=this._refractionTexture.isCube,a.RGBDREFRACTION=this._refractionTexture.isRGBD,a.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize}else a.REFRACTION=!1;a.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else a.DIFFUSE=!1,a.AMBIENT=!1,a.OPACITY=!1,a.REFLECTION=!1,a.EMISSIVE=!1,a.LIGHTMAP=!1,a.BUMP=!1,a.REFRACTION=!1;a.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),a.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,a.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,a.SPECULAROVERALPHA=this._useSpecularOverAlpha,a.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,a.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,a.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=a,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a),a.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,a.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}a._areFresnelDirty&&(Oe.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(a.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,a.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,a.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,a.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,a.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,a.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,a._needNormals=!0,a.FRESNEL=!0):a.FRESNEL=!1),(0,$.fm)(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,a,this._applyDecalMapAfterDetailMap),(0,$.OR)(n,o,this,a,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=a,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),(0,$.qB)(e,a,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let h=!1;if(a.isDirty){const i=a._areLightsDisposed;a.markAsProcessed();const s=new K;a.REFLECTION&&s.addFallback(0,"REFLECTION"),a.SPECULAR&&s.addFallback(0,"SPECULAR"),a.BUMP&&s.addFallback(0,"BUMP"),a.PARALLAX&&s.addFallback(1,"PARALLAX"),a.PARALLAX_RHS&&s.addFallback(1,"PARALLAX_RHS"),a.PARALLAXOCCLUSION&&s.addFallback(0,"PARALLAXOCCLUSION"),a.SPECULAROVERALPHA&&s.addFallback(0,"SPECULAROVERALPHA"),a.FOG&&s.addFallback(1,"FOG"),a.POINTSIZE&&s.addFallback(0,"POINTSIZE"),a.LOGARITHMICDEPTH&&s.addFallback(0,"LOGARITHMICDEPTH"),(0,$.c4)(a,s,this._maxSimultaneousLights),a.SPECULARTERM&&s.addFallback(0,"SPECULARTERM"),a.DIFFUSEFRESNEL&&s.addFallback(1,"DIFFUSEFRESNEL"),a.OPACITYFRESNEL&&s.addFallback(2,"OPACITYFRESNEL"),a.REFLECTIONFRESNEL&&s.addFallback(3,"REFLECTIONFRESNEL"),a.EMISSIVEFRESNEL&&s.addFallback(4,"EMISSIVEFRESNEL"),a.FRESNEL&&s.addFallback(4,"FRESNEL"),a.MULTIVIEW&&s.addFallback(0,"MULTIVIEW");const l=[O.R.PositionKind];a.NORMAL&&l.push(O.R.NormalKind),a.TANGENT&&l.push(O.R.TangentKind);for(let e=1;e<=6;++e)a["UV"+e]&&l.push(`uv${1===e?"":e}`);a.VERTEXCOLOR&&l.push(O.R.ColorKind),(0,$.ni)(l,e,a,s),(0,$.ER)(l,a),(0,$.IF)(l,e,a),(0,$.J2)(l,e,a);let c="default";const u=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],d=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],_=["Material","Scene","Mesh"],p={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=s,this._eventInfo.fallbackRank=0,this._eventInfo.defines=a,this._eventInfo.uniforms=u,this._eventInfo.attributes=l,this._eventInfo.samplers=d,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=p,this._callbackPluginEventGeneric(128,this._eventInfo),xe.AddUniforms(u),xe.AddSamplers(d),Se.p&&(Se.p.PrepareUniforms(u,a),Se.p.PrepareSamplers(d,a)),(0,$.Bb)({uniformsNames:u,uniformBuffersNames:_,samplers:d,defines:a,maxSimultaneousLights:this._maxSimultaneousLights}),(0,q.TV)(u);const f={};this.customShaderNameResolve&&(c=this.customShaderNameResolve(c,u,_,d,a,l,f));const m=a.toString(),g=t.effect;let v=n.getEngine().createEffect(c,{attributes:l,uniformsNames:u,uniformBuffersNames:_,samplers:d,defines:m,fallbacks:s,onCompiled:this.onCompiled,onError:this.onError,indexParameters:p,processFinalCode:f.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:a.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this._shaderLanguage?await Promise.all([r.e(9235).then(r.bind(r,9235)),r.e(5659).then(r.bind(r,5659))]):await Promise.all([r.e(4268).then(r.bind(r,4268)),r.e(2319).then(r.bind(r,2319))]),this._shadersLoaded=!0}},o);if(this._eventInfo.customCode=void 0,v)if(this._onEffectCreatedObservable&&(Ie.effect=v,Ie.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Ie)),this.allowShaderHotSwapping&&g&&!v.isReady()){if(v=g,a.markAsUnprocessed(),h=this.isFrozen,i)return a._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(v,a,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(a._renderId=n.getRenderId(),s._wasPreviouslyReady=!h,s._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;if(!n)return;this._activeEffect=n,t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(n,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,s,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),r.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const a=this._mustRebind(s,n,i,t.visibility);(0,$.f$)(t,n);const o=this._uniformBuffer;if(a){if(this.bindViewProjection(n),!o.useUbo||!this.isFrozen||!o.isSync||i._drawWrapper._forceRebindOnNextCall){if(Oe.FresnelEnabled&&r.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(o.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),o.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&o.updateColor4("opacityParts",new M.v9(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(o.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),o.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(o.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),o.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(o.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),o.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),s.texturesEnabled){if(this._diffuseTexture&&Oe.DiffuseTextureEnabled&&(o.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),(0,$.mA)(this._diffuseTexture,o,"diffuse")),this._ambientTexture&&Oe.AmbientTextureEnabled&&(o.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),(0,$.mA)(this._ambientTexture,o,"ambient")),this._opacityTexture&&Oe.OpacityTextureEnabled&&(o.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),(0,$.mA)(this._opacityTexture,o,"opacity")),this._hasAlphaChannel()&&o.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&Oe.ReflectionTextureEnabled&&(o.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),o.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const e=this._reflectionTexture;o.updateVector3("vReflectionPosition",e.boundingBoxPosition),o.updateVector3("vReflectionSize",e.boundingBoxSize)}if(this._emissiveTexture&&Oe.EmissiveTextureEnabled&&(o.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),(0,$.mA)(this._emissiveTexture,o,"emissive")),this._lightmapTexture&&Oe.LightmapTextureEnabled&&(o.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),(0,$.mA)(this._lightmapTexture,o,"lightmap")),this._specularTexture&&Oe.SpecularTextureEnabled&&(o.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),(0,$.mA)(this._specularTexture,o,"specular")),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&Oe.BumpTextureEnabled&&(o.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),(0,$.mA)(this._bumpTexture,o,"bump"),s._mirroredCameraPosition?o.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):o.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&Oe.RefractionTextureEnabled){let e=1;if(this._refractionTexture.isCube||(o.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(e=this._refractionTexture.depth)),o.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,e,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const e=this._refractionTexture;o.updateVector3("vRefractionPosition",e.boundingBoxPosition),o.updateVector3("vRefractionSize",e.boundingBoxSize)}}}this.pointsCloud&&o.updateFloat("pointSize",this.pointSize),r.SPECULARTERM&&o.updateColor4("vSpecularColor",this.specularColor,this.specularPower),o.updateColor3("vEmissiveColor",Oe.EmissiveTextureEnabled?this.emissiveColor:M.v9.BlackReadOnly),o.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),s.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),o.updateColor3("vAmbientColor",this._globalAmbientColor)}s.texturesEnabled&&(this._diffuseTexture&&Oe.DiffuseTextureEnabled&&n.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&Oe.AmbientTextureEnabled&&n.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Oe.OpacityTextureEnabled&&n.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&Oe.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?n.setTexture("reflectionCubeSampler",this._reflectionTexture):n.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&Oe.EmissiveTextureEnabled&&n.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Oe.LightmapTextureEnabled&&n.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&Oe.SpecularTextureEnabled&&n.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&Oe.BumpTextureEnabled&&n.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&Oe.RefractionTextureEnabled&&(this._refractionTexture.isCube?n.setTexture("refractionCubeSampler",this._refractionTexture):n.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(n),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),(0,q.gS)(n,this,s),this.bindEyePosition(n)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);!a&&this.isFrozen||(s.lightsEnabled&&!this._disableLighting&&(0,$.RL)(s,t,n,r,this._maxSimultaneousLights),(s.fogEnabled&&t.applyFog&&s.fogMode!==be.Z.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||r.PREPASS)&&this.bindView(n),(0,$.Yy)(s,t,n),r.NUM_MORPH_INFLUENCERS&&(0,$.nR)(t,n),r.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(n,r.INSTANCES),this.useLogarithmicDepth&&(0,$.DL)(r,n,s),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),o.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e}dispose(e,t){t&&(this._diffuseTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._specularTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._refractionTexture?.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){const s=N.p.Clone((()=>new Oe(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return s.name=e,s.id=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}static Parse(e,t,i){const s=N.p.Parse((()=>new Oe(e.name,t)),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),Te.i._ParsePlugins(e,s,t,i),s}static get DiffuseTextureEnabled(){return Pe.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){Pe.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return Pe.DetailTextureEnabled}static set DetailTextureEnabled(e){Pe.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return Pe.AmbientTextureEnabled}static set AmbientTextureEnabled(e){Pe.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return Pe.OpacityTextureEnabled}static set OpacityTextureEnabled(e){Pe.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return Pe.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){Pe.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return Pe.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){Pe.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return Pe.SpecularTextureEnabled}static set SpecularTextureEnabled(e){Pe.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return Pe.BumpTextureEnabled}static set BumpTextureEnabled(e){Pe.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return Pe.LightmapTextureEnabled}static set LightmapTextureEnabled(e){Pe.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return Pe.RefractionTextureEnabled}static set RefractionTextureEnabled(e){Pe.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return Pe.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){Pe.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return Pe.FresnelEnabled}static set FresnelEnabled(e){Pe.FresnelEnabled=e}}Oe.ForceGLSL=!1,(0,w.Cg)([(0,D.uM)("diffuseTexture")],Oe.prototype,"_diffuseTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],Oe.prototype,"diffuseTexture",void 0),(0,w.Cg)([(0,D.uM)("ambientTexture")],Oe.prototype,"_ambientTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"ambientTexture",void 0),(0,w.Cg)([(0,D.uM)("opacityTexture")],Oe.prototype,"_opacityTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],Oe.prototype,"opacityTexture",void 0),(0,w.Cg)([(0,D.uM)("reflectionTexture")],Oe.prototype,"_reflectionTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"reflectionTexture",void 0),(0,w.Cg)([(0,D.uM)("emissiveTexture")],Oe.prototype,"_emissiveTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"emissiveTexture",void 0),(0,w.Cg)([(0,D.uM)("specularTexture")],Oe.prototype,"_specularTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"specularTexture",void 0),(0,w.Cg)([(0,D.uM)("bumpTexture")],Oe.prototype,"_bumpTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"bumpTexture",void 0),(0,w.Cg)([(0,D.uM)("lightmapTexture")],Oe.prototype,"_lightmapTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"lightmapTexture",void 0),(0,w.Cg)([(0,D.uM)("refractionTexture")],Oe.prototype,"_refractionTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"refractionTexture",void 0),(0,w.Cg)([(0,D.jT)("ambient")],Oe.prototype,"ambientColor",void 0),(0,w.Cg)([(0,D.jT)("diffuse")],Oe.prototype,"diffuseColor",void 0),(0,w.Cg)([(0,D.jT)("specular")],Oe.prototype,"specularColor",void 0),(0,w.Cg)([(0,D.jT)("emissive")],Oe.prototype,"emissiveColor",void 0),(0,w.Cg)([(0,D.lK)()],Oe.prototype,"specularPower",void 0),(0,w.Cg)([(0,D.lK)("useAlphaFromDiffuseTexture")],Oe.prototype,"_useAlphaFromDiffuseTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],Oe.prototype,"useAlphaFromDiffuseTexture",void 0),(0,w.Cg)([(0,D.lK)("useEmissiveAsIllumination")],Oe.prototype,"_useEmissiveAsIllumination",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"useEmissiveAsIllumination",void 0),(0,w.Cg)([(0,D.lK)("linkEmissiveWithDiffuse")],Oe.prototype,"_linkEmissiveWithDiffuse",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"linkEmissiveWithDiffuse",void 0),(0,w.Cg)([(0,D.lK)("useSpecularOverAlpha")],Oe.prototype,"_useSpecularOverAlpha",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"useSpecularOverAlpha",void 0),(0,w.Cg)([(0,D.lK)("useReflectionOverAlpha")],Oe.prototype,"_useReflectionOverAlpha",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"useReflectionOverAlpha",void 0),(0,w.Cg)([(0,D.lK)("disableLighting")],Oe.prototype,"_disableLighting",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsLightsDirty")],Oe.prototype,"disableLighting",void 0),(0,w.Cg)([(0,D.lK)("useObjectSpaceNormalMap")],Oe.prototype,"_useObjectSpaceNormalMap",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"useObjectSpaceNormalMap",void 0),(0,w.Cg)([(0,D.lK)("useParallax")],Oe.prototype,"_useParallax",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"useParallax",void 0),(0,w.Cg)([(0,D.lK)("useParallaxOcclusion")],Oe.prototype,"_useParallaxOcclusion",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"useParallaxOcclusion",void 0),(0,w.Cg)([(0,D.lK)()],Oe.prototype,"parallaxScaleBias",void 0),(0,w.Cg)([(0,D.lK)("roughness")],Oe.prototype,"_roughness",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"roughness",void 0),(0,w.Cg)([(0,D.lK)()],Oe.prototype,"indexOfRefraction",void 0),(0,w.Cg)([(0,D.lK)()],Oe.prototype,"invertRefractionY",void 0),(0,w.Cg)([(0,D.lK)()],Oe.prototype,"alphaCutOff",void 0),(0,w.Cg)([(0,D.lK)("useLightmapAsShadowmap")],Oe.prototype,"_useLightmapAsShadowmap",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"useLightmapAsShadowmap",void 0),(0,w.Cg)([(0,D.Y9)("diffuseFresnelParameters")],Oe.prototype,"_diffuseFresnelParameters",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsFresnelDirty")],Oe.prototype,"diffuseFresnelParameters",void 0),(0,w.Cg)([(0,D.Y9)("opacityFresnelParameters")],Oe.prototype,"_opacityFresnelParameters",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsFresnelAndMiscDirty")],Oe.prototype,"opacityFresnelParameters",void 0),(0,w.Cg)([(0,D.Y9)("reflectionFresnelParameters")],Oe.prototype,"_reflectionFresnelParameters",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsFresnelDirty")],Oe.prototype,"reflectionFresnelParameters",void 0),(0,w.Cg)([(0,D.Y9)("refractionFresnelParameters")],Oe.prototype,"_refractionFresnelParameters",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsFresnelDirty")],Oe.prototype,"refractionFresnelParameters",void 0),(0,w.Cg)([(0,D.Y9)("emissiveFresnelParameters")],Oe.prototype,"_emissiveFresnelParameters",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsFresnelDirty")],Oe.prototype,"emissiveFresnelParameters",void 0),(0,w.Cg)([(0,D.lK)("useReflectionFresnelFromSpecular")],Oe.prototype,"_useReflectionFresnelFromSpecular",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsFresnelDirty")],Oe.prototype,"useReflectionFresnelFromSpecular",void 0),(0,w.Cg)([(0,D.lK)("useGlossinessFromSpecularMapAlpha")],Oe.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"useGlossinessFromSpecularMapAlpha",void 0),(0,w.Cg)([(0,D.lK)("maxSimultaneousLights")],Oe.prototype,"_maxSimultaneousLights",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsLightsDirty")],Oe.prototype,"maxSimultaneousLights",void 0),(0,w.Cg)([(0,D.lK)("invertNormalMapX")],Oe.prototype,"_invertNormalMapX",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"invertNormalMapX",void 0),(0,w.Cg)([(0,D.lK)("invertNormalMapY")],Oe.prototype,"_invertNormalMapY",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"invertNormalMapY",void 0),(0,w.Cg)([(0,D.lK)("twoSidedLighting")],Oe.prototype,"_twoSidedLighting",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Oe.prototype,"twoSidedLighting",void 0),(0,w.Cg)([(0,D.lK)("applyDecalMapAfterDetailMap")],Oe.prototype,"_applyDecalMapAfterDetailMap",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsMiscDirty")],Oe.prototype,"applyDecalMapAfterDetailMap",void 0),(0,V.Y5)("BABYLON.StandardMaterial",Oe),be.Z.DefaultMaterialFactory=e=>new Oe("default material",e);var we=r(7126);let De=0;const Fe=e=>{if(!e.environmentBRDFTexture){const t=e.useDelayedTextureLoading;e.useDelayedTextureLoading=!1;const i=e._blockEntityCollection;e._blockEntityCollection=!1;const s=G.g.CreateFromBase64String("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==","EnvironmentBRDFTexture"+De++,e,!0,!1,G.g.BILINEAR_SAMPLINGMODE);e._blockEntityCollection=i;const r=e.getEngine().getLoadedTexturesCache(),n=r.indexOf(s.getInternalTexture());-1!==n&&r.splice(n,1),s.isRGBD=!0,s.wrapU=G.g.CLAMP_ADDRESSMODE,s.wrapV=G.g.CLAMP_ADDRESSMODE,e.environmentBRDFTexture=s,e.useDelayedTextureLoading=t,we.G.ExpandRGBDTexture(s);const a=e.getEngine().onContextRestoredObservable.add((()=>{s.isRGBD=!0;const t=e.onBeforeRenderObservable.add((()=>{s.isReady()&&(e.onBeforeRenderObservable.remove(t),we.G.ExpandRGBDTexture(s))}))}));e.onDisposeObservable.add((()=>{e.getEngine().onContextRestoredObservable.remove(a)}))}return e.environmentBRDFTexture};class Ne extends ye.M{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class Le extends Ee.y{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRBRDF",90,new Ne,t),this._useEnergyConservation=Le.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Le.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=Le.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Le.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=Le.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Le.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=Le.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Le.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}Le.DEFAULT_USE_ENERGY_CONSERVATION=!0,Le.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,Le.DEFAULT_USE_SPHERICAL_HARMONICS=!0,Le.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsMiscDirty")],Le.prototype,"useEnergyConservation",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsMiscDirty")],Le.prototype,"useSmithVisibilityHeightCorrelated",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsMiscDirty")],Le.prototype,"useSphericalHarmonics",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsMiscDirty")],Le.prototype,"useSpecularGlossinessInputEnergyConservation",void 0),r(9764);class Be extends ye.M{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class ke extends Ee.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRClearCoat",100,new Be,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=ke._DefaultIndexOfRefraction,this.indexOfRefraction=ke._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=M.v9.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const s=this._material._disableBumpMap;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Pe.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&Pe.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1;if(i.getCaps().standardDerivatives&&this._bumpTexture&&Pe.ClearCoatBumpTextureEnabled&&!s&&!this._bumpTexture.isReady())return!1;if(this._isTintEnabled&&this._tintTexture&&Pe.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Pe.ClearCoatTextureEnabled?(0,$.YT)(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&Pe.ClearCoatTextureEnabled?(0,$.YT)(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&Pe.ClearCoatBumpTextureEnabled?(0,$.YT)(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===ke._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&Pe.ClearCoatTintTextureEnabled?((0,$.YT)(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,s){if(!this._isEnabled)return;const r=s.materialDefines,n=this._material.isFrozen,a=this._material._disableBumpMap,o=this._material._invertNormalMapX,l=this._material._invertNormalMapY;if(!e.useUbo||!n||!e.isSync){(this._texture||this._textureRoughness)&&Pe.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&(0,$.mA)(this._texture,e,"clearCoat"),this._textureRoughness&&!r.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&(0,$.mA)(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&Pe.ClearCoatTextureEnabled&&!a&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),(0,$.mA)(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",o?1:-1,l?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",o?-1:1,l?-1:1)),this._tintTexture&&Pe.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),(0,$.mA)(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const s=1-this._indexOfRefraction,n=1+this._indexOfRefraction,h=Math.pow(-s/n,2),c=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",h,c,s,n),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&Pe.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!r.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Pe.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&Pe.ClearCoatBumpTextureEnabled&&!a&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&Pe.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose(),this._bumpTexture?.dispose(),this._tintTexture?.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}ke._DefaultIndexOfRefraction=1.5,(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"isEnabled",void 0),(0,w.Cg)([(0,D.lK)()],ke.prototype,"intensity",void 0),(0,w.Cg)([(0,D.lK)()],ke.prototype,"roughness",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"indexOfRefraction",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"texture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"useRoughnessFromMainTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"textureRoughness",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"remapF0OnInterfaceChange",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"bumpTexture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"isTintEnabled",void 0),(0,w.Cg)([(0,D.jT)()],ke.prototype,"tintColor",void 0),(0,w.Cg)([(0,D.lK)()],ke.prototype,"tintColorAtDistance",void 0),(0,w.Cg)([(0,D.lK)()],ke.prototype,"tintThickness",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"tintTexture",void 0);class Ve extends ye.M{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0}}class Ue extends Ee.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRIridescence",110,new Ve,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=Ue._DefaultMinimumThickness,this.maximumThickness=Ue._DefaultMaximumThickness,this.indexOfRefraction=Ue._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){if(!this._isEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Pe.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._thicknessTexture&&Pe.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.IRIDESCENCE=!0,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Pe.IridescenceTextureEnabled?(0,$.YT)(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,this._thicknessTexture&&Pe.IridescenceTextureEnabled?(0,$.YT)(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||((this._texture||this._thicknessTexture)&&Pe.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._thicknessTexture?.coordinatesIndex??0,this._thicknessTexture?.level??0),this._texture&&(0,$.mA)(this._texture,e,"iridescence"),this._thicknessTexture&&(0,$.mA)(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&Pe.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&Pe.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){e&&(this._texture?.dispose(),this._thicknessTexture?.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}Ue._DefaultMinimumThickness=100,Ue._DefaultMaximumThickness=400,Ue._DefaultIndexOfRefraction=1.3,(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"isEnabled",void 0),(0,w.Cg)([(0,D.lK)()],Ue.prototype,"intensity",void 0),(0,w.Cg)([(0,D.lK)()],Ue.prototype,"minimumThickness",void 0),(0,w.Cg)([(0,D.lK)()],Ue.prototype,"maximumThickness",void 0),(0,w.Cg)([(0,D.lK)()],Ue.prototype,"indexOfRefraction",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"texture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"thicknessTexture",void 0);class ze extends ye.M{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class Ge extends Ee.y{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new ze,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new I.I9(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&Pe.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(O.R.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Pe.AnisotropicTextureEnabled?(0,$.YT)(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||(this._texture&&Pe.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),(0,$.mA)(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&Pe.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),void 0===e.legacy&&(this.legacy=!0)}}(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ge.prototype,"isEnabled",void 0),(0,w.Cg)([(0,D.lK)()],Ge.prototype,"intensity",void 0),(0,w.Cg)([(0,D.WM)()],Ge.prototype,"direction",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ge.prototype,"texture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsMiscDirty")],Ge.prototype,"legacy",void 0);class He extends ye.M{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1}}class We extends Ee.y{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"Sheen",120,new He,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=M.v9.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){if(!this._isEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Pe.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&Pe.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=null!==this._roughness,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Pe.SheenTextureEnabled?((0,$.YT)(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&Pe.SheenTextureEnabled?(0,$.YT)(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,s){if(!this._isEnabled)return;const r=s.materialDefines,n=this._material.isFrozen;e.useUbo&&n&&e.isSync||((this._texture||this._textureRoughness)&&Pe.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&(0,$.mA)(this._texture,e,"sheen"),this._textureRoughness&&!r.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&(0,$.mA)(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this._roughness&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&Pe.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!r.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Pe.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"isEnabled",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"linkSheenWithAlbedo",void 0),(0,w.Cg)([(0,D.lK)()],We.prototype,"intensity",void 0),(0,w.Cg)([(0,D.jT)()],We.prototype,"color",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"texture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"useRoughnessFromMainTexture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"roughness",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"textureRoughness",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],We.prototype,"albedoScaling",void 0);class Xe extends ye.M{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,this.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_USE_GLTF_TEXTURES=!1}}class Ke extends Ee.y{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){this._volumeIndexOfRefraction=e>=1?e:-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRSubSurface",130,new Xe,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=M.v9.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=M.v9.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this.translucencyColor=null,this._translucencyColorTexture=null,this.translucencyColorTexture=null,this._useGltfStyleTextures=!0,this.useGltfStyleTextures=!0,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&Pe.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;if(this._translucencyColorTexture&&Pe.TranslucencyColorTextureEnabled&&!this._translucencyColorTexture.isReadyOrNotBlocking())return!1;if(this._translucencyIntensityTexture&&Pe.TranslucencyIntensityTextureEnabled&&!this._translucencyIntensityTexture.isReadyOrNotBlocking())return!1;const e=this._getRefractionTexture(t);if(e&&Pe.RefractionTextureEnabled&&!e.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,void(e.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0);if(e._areTexturesDirty){if(e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&Pe.ThicknessTextureEnabled&&(0,$.YT)(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&Pe.RefractionIntensityTextureEnabled&&(0,$.YT)(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&Pe.TranslucencyIntensityTextureEnabled&&(0,$.YT)(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE"),this._translucencyColorTexture&&Pe.TranslucencyColorTextureEnabled&&(0,$.YT)(this._translucencyColorTexture,e,"SS_TRANSLUCENCYCOLOR_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!=0,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._refractionIntensityTexture,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._translucencyIntensityTexture,this._isRefractionEnabled&&t.texturesEnabled){const i=this._getRefractionTexture(t);i&&Pe.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,s){if(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled)if(0===this.maximumThickness&&0===this.minimumThickness)e.updateFloat2("vThicknessParam",0,0);else{s.getRenderingMesh().getWorldMatrix().decompose(I.AA.Vector3[0]);const t=Math.max(Math.abs(I.AA.Vector3[0].x),Math.abs(I.AA.Vector3[0].y),Math.abs(I.AA.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*t,(this.maximumThickness-this.minimumThickness)*t)}}bindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const r=s.materialDefines,n=this._material.isFrozen,a=this._material.realTimeFiltering,o=r.LODBASEDMICROSFURACE,l=this._getRefractionTexture(t);if(!e.useUbo||!n||!e.isSync){if(this._thicknessTexture&&Pe.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),(0,$.mA)(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&Pe.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),(0,$.mA)(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyColorTexture&&Pe.TranslucencyColorTextureEnabled&&r.SS_TRANSLUCENCYCOLOR_TEXTURE&&(e.updateFloat2("vTranslucencyColorInfos",this._translucencyColorTexture.coordinatesIndex,this._translucencyColorTexture.level),(0,$.mA)(this._translucencyColorTexture,e,"translucencyColor")),this._translucencyIntensityTexture&&Pe.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),(0,$.mA)(this._translucencyIntensityTexture,e,"translucencyIntensity")),l&&Pe.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",l.getRefractionTextureMatrix());let t=1;l.isCube||l.depth&&(t=l.depth);const i=l.getSize().width,s=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",l.level,1/s,t,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",i,l.lodGenerationScale,l.lodGenerationOffset,1/this.indexOfRefraction),a&&e.updateFloat2("vRefractionFilteringInfo",i,Math.log2(i)),l.boundingBoxSize){const t=l;e.updateVector3("vRefractionPosition",t.boundingBoxPosition),e.updateVector3("vRefractionSize",t.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateColor4("vTranslucencyColor",this.translucencyColor??this.tintColor,0),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&Pe.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&Pe.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&Pe.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),this._translucencyColorTexture&&Pe.TranslucencyColorTextureEnabled&&r.SS_TRANSLUCENCYCOLOR_TEXTURE&&e.setTexture("translucencyColorSampler",this._translucencyColorTexture),l&&Pe.RefractionTextureEnabled&&(o?e.setTexture("refractionSampler",l):(e.setTexture("refractionSampler",l._lodTextureMid||l),e.setTexture("refractionSamplerLow",l._lodTextureLow||l),e.setTexture("refractionSamplerHigh",l._lodTextureHigh||l))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){Pe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e||this._refractionIntensityTexture===e||this._translucencyIntensityTexture===e||this._translucencyColorTexture===e}hasRenderTargetTextures(){return!!(Pe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture),this._translucencyColorTexture&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&e.push(this._translucencyIntensityTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),this._translucencyColorTexture&&this._translucencyColorTexture.animations&&this._translucencyColorTexture.animations.length>0&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.animations&&this._translucencyIntensityTexture.animations.length>0&&e.push(this._translucencyIntensityTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose(),this._translucencyColorTexture&&this._translucencyColorTexture.dispose(),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","translucencyColorSampler")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"},{name:"vTranslucencyColor",size:4,type:"vec4"},{name:"vTranslucencyColorInfos",size:2,type:"vec2"},{name:"translucencyColorMatrix",size:16,type:"mat4"}]}}}(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"isRefractionEnabled",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"isTranslucencyEnabled",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"isDispersionEnabled",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markScenePrePassDirty")],Ke.prototype,"isScatteringEnabled",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"_scatteringDiffusionProfileIndex",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"refractionIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"translucencyIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"useAlbedoToTintRefraction",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"useAlbedoToTintTranslucency",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"thicknessTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"refractionTexture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"indexOfRefraction",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"_volumeIndexOfRefraction",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"volumeIndexOfRefraction",null),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"invertRefractionY",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"linkRefractionWithTransparency",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"minimumThickness",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"maximumThickness",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"useThicknessAsDepth",void 0),(0,w.Cg)([(0,D.jT)()],Ke.prototype,"tintColor",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"tintColorAtDistance",void 0),(0,w.Cg)([(0,D.lK)()],Ke.prototype,"dispersion",void 0),(0,w.Cg)([(0,D.jT)()],Ke.prototype,"diffusionDistance",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"useMaskFromThicknessTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"refractionIntensityTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"translucencyIntensityTexture",void 0),(0,w.Cg)([(0,D.jT)()],Ke.prototype,"translucencyColor",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"translucencyColorTexture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Ke.prototype,"useGltfStyleTextures",void 0);const Qe={effect:null,subMesh:null};class Ye extends ye.M{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class qe extends Ce{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}constructor(e,t,i=!1){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new I.IU(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=qe.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=M.v9.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new M.v9(0,0,0),this._albedoColor=new M.v9(1,1,1),this._reflectivityColor=new M.v9(1,1,1),this._reflectionColor=new M.v9(1,1,1),this._emissiveColor=new M.v9(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=qe.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new J.L(16),this._globalAmbientColor=new M.v9(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this._shadersLoaded=!1,this._breakShaderLoadedCheck=!1,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1;const s=this.getScene().getEngine();!s.isWebGPU||i||qe.ForceGLSL||(this._uniformBuffer&&this._uniformBuffer.dispose(),this._uniformBuffer=new k.D(s,void 0,void 0,this.name,!0),this._shaderLanguage=1),this.brdf=new Le(this),this.clearCoat=new ke(this),this.iridescence=new Ue(this),this.anisotropy=new Ge(this),this.sheen=new We(this),this.subSurface=new Ke(this),this.detailMap=new Re(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Pe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=Fe(this.getScene()),this.prePassConfiguration=new xe}get hasRenderTargetTextures(){return!!(Pe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){return this._transparencyMode===qe.PBRMATERIAL_OPAQUE||this._transparencyMode===qe.PBRMATERIAL_ALPHATEST||this.subSurface?.disableAlphaBlending}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())}needAlphaTesting(){return!!this._forceAlphaTest||!this.subSurface?.disableAlphaBlending&&this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===qe.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==qe.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){this._uniformBufferLayoutBuilt||this.buildUniformLayout();const s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new Ye(this._eventInfo.defineNames));const r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=this.getScene(),a=n.getEngine();if(r._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n.texturesEnabled)){if(this._albedoTexture&&Pe.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking())return!1;if(this._ambientTexture&&Pe.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking())return!1;if(this._opacityTexture&&Pe.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const e=this._getReflectionTexture();if(e&&Pe.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;if(e.irradianceTexture){if(!e.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!e.sphericalPolynomial&&e.getInternalTexture()?._sphericalPolynomialPromise)return!1}if(this._lightmapTexture&&Pe.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking())return!1;if(this._emissiveTexture&&Pe.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(Pe.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking())return!1;if(this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking())return!1;if(this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(a.getCaps().standardDerivatives&&this._bumpTexture&&Pe.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady())return!1;if(this._environmentBRDFTexture&&Pe.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;a.getCaps().standardDerivatives||e.isVerticesDataPresent(O.R.NormalKind)||(e.createNormals(!0),l.V.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const o=t.effect,h=r._areLightsDisposed;let c=this._prepareEffect(e,r,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),u=!1;if(c)if(this._onEffectCreatedObservable&&(Qe.effect=c,Qe.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Qe)),this.allowShaderHotSwapping&&o&&!c.isReady()){if(c=o,r.markAsUnprocessed(),u=this.isFrozen,h)return r._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(c,r,this._materialContext);return!(!t.effect||!t.effect.isReady()||(r._renderId=n.getRenderId(),s._wasPreviouslyReady=!u,s._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),0))}isMetallicWorkflow(){return!(null==this._metallic&&null==this._roughness&&!this._metallicTexture)}_prepareEffect(e,t,i=null,s=null,n=null,a=null,o){if(this._prepareDefines(e,t,n,a,o),!t.isDirty)return null;t.markAsProcessed();const l=this.getScene().getEngine(),h=new K;let c=0;t.USESPHERICALINVERTEX&&h.addFallback(c++,"USESPHERICALINVERTEX"),t.FOG&&h.addFallback(c,"FOG"),t.SPECULARAA&&h.addFallback(c,"SPECULARAA"),t.POINTSIZE&&h.addFallback(c,"POINTSIZE"),t.LOGARITHMICDEPTH&&h.addFallback(c,"LOGARITHMICDEPTH"),t.PARALLAX&&h.addFallback(c,"PARALLAX"),t.PARALLAX_RHS&&h.addFallback(c,"PARALLAX_RHS"),t.PARALLAXOCCLUSION&&h.addFallback(c++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&h.addFallback(c++,"ENVIRONMENTBRDF"),t.TANGENT&&h.addFallback(c++,"TANGENT"),t.BUMP&&h.addFallback(c++,"BUMP"),c=(0,$.c4)(t,h,this._maxSimultaneousLights,c++),t.SPECULARTERM&&h.addFallback(c++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&h.addFallback(c++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&h.addFallback(c++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&h.addFallback(c++,"LIGHTMAP"),t.NORMAL&&h.addFallback(c++,"NORMAL"),t.AMBIENT&&h.addFallback(c++,"AMBIENT"),t.EMISSIVE&&h.addFallback(c++,"EMISSIVE"),t.VERTEXCOLOR&&h.addFallback(c++,"VERTEXCOLOR"),t.MORPHTARGETS&&h.addFallback(c++,"MORPHTARGETS"),t.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");const u=[O.R.PositionKind];t.NORMAL&&u.push(O.R.NormalKind),t.TANGENT&&u.push(O.R.TangentKind);for(let e=1;e<=6;++e)t["UV"+e]&&u.push(`uv${1===e?"":e}`);t.VERTEXCOLOR&&u.push(O.R.ColorKind),(0,$.ni)(u,e,t,h),(0,$.ER)(u,t),(0,$.IF)(u,e,t),(0,$.J2)(u,e,t);let d="pbr";const _=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],p=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],f=["Material","Scene","Mesh"],m={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=c,this._eventInfo.defines=t,this._eventInfo.uniforms=_,this._eventInfo.attributes=u,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=f,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=m,this._callbackPluginEventGeneric(128,this._eventInfo),xe.AddUniforms(_),xe.AddSamplers(p),(0,q.TV)(_),Se.p&&(Se.p.PrepareUniforms(_,t),Se.p.PrepareSamplers(p,t)),(0,$.Bb)({uniformsNames:_,uniformBuffersNames:f,samplers:p,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const g={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,_,f,p,t,u,g));const v=t.toString(),b=l.createEffect(d,{attributes:u,uniformsNames:_,uniformBuffersNames:f,samplers:p,defines:v,fallbacks:h,onCompiled:i,onError:s,indexParameters:m,processFinalCode:g.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([r.e(9174).then(r.bind(r,9174)),r.e(2622).then(r.bind(r,2622))]):await Promise.all([r.e(1448).then(r.bind(r,1448)),r.e(3457).then(r.bind(r,3457))]),this._shadersLoaded=!0}},l);return this._eventInfo.customCode=void 0,b}_prepareDefines(e,t,i=null,s=null,r=!1){const n=this.getScene(),a=n.getEngine();(0,$.az)(n,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,(0,$.VO)(n,t);const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if((0,$.N4)(n,t,this.canRenderToMRT&&!o),(0,$.Nc)(n,t,o),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let e=1;e<=6;++e)t["MAINUV"+e]=!1;if(n.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,a.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&Pe.DiffuseTextureEnabled?((0,$.YT)(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&Pe.AmbientTextureEnabled?((0,$.YT)(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&Pe.OpacityTextureEnabled?((0,$.YT)(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const e=this._getReflectionTexture();if(e&&Pe.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=e.gammaSpace,t.RGBDREFLECTION=e.isRGBD,t.LODINREFLECTIONALPHA=e.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=e.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,a._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=e.coordinatesMode===G.g.INVCUBIC_MODE,t.REFLECTIONMAP_3D=e.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.coordinatesMode){case G.g.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case G.g.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case G.g.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case G.g.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case G.g.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case G.g.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case G.g.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case G.g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case G.g.CUBIC_MODE:case G.g.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!e.boundingBoxSize}e.coordinatesMode!==G.g.SKYBOX_MODE&&(e.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):e.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||a.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&Pe.LightmapTextureEnabled?((0,$.YT)(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&Pe.EmissiveTextureEnabled?((0,$.YT)(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,Pe.SpecularTextureEnabled?(this._metallicTexture?((0,$.YT)(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?((0,$.YT)(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture?(t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture,this._metallicReflectanceTexture?((0,$.YT)(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?((0,$.YT)(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1):(t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1),this._microSurfaceTexture?(0,$.YT)(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1):(t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1),a.getCaps().standardDerivatives&&this._bumpTexture&&Pe.BumpTextureEnabled&&!this._disableBumpMap?((0,$.YT)(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&Pe.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAX_RHS=n.useRightHandedSystem,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAX_RHS=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&Pe.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===qe.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===qe.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=a.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1==0?".":""}`,t.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&((0,$.fm)(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(O.R.NormalKind),t.DEBUGMODE=this._debugMode),(0,$.OR)(n,a,this,t,!!i,s,r),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),(0,$.qB)(e,t,!0,!0,!0,this._transparencyMode!==qe.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const s={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo),(()=>{if(this._breakShaderLoadedCheck)return;const i=new Ye(this._eventInfo.defineNames),r=this._prepareEffect(e,i,void 0,void 0,s.useInstances,s.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Qe.effect=r,Qe.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Qe)),r.isReady()?t&&t(this):r.onCompileObservable.add((()=>{t&&t(this)}))})()}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;if(!n)return;this._activeEffect=n,t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),t.transferToEffect(e);const a=s.getEngine();this._uniformBuffer.bindToEffect(n,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,s,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),r.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const o=this._mustRebind(s,n,i,t.visibility);(0,$.f$)(t,this._activeEffect,this.prePassConfiguration);let l=null;const h=this._uniformBuffer;if(o){if(this.bindViewProjection(n),l=this._getReflectionTexture(),!h.useUbo||!this.isFrozen||!h.isSync||i._drawWrapper._forceRebindOnNextCall){if(s.texturesEnabled){if(this._albedoTexture&&Pe.DiffuseTextureEnabled&&(h.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),(0,$.mA)(this._albedoTexture,h,"albedo")),this._ambientTexture&&Pe.AmbientTextureEnabled&&(h.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),(0,$.mA)(this._ambientTexture,h,"ambient")),this._opacityTexture&&Pe.OpacityTextureEnabled&&(h.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),(0,$.mA)(this._opacityTexture,h,"opacity")),l&&Pe.ReflectionTextureEnabled){if(h.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),h.updateFloat2("vReflectionInfos",l.level,0),l.boundingBoxSize){const e=l;h.updateVector3("vReflectionPosition",e.boundingBoxPosition),h.updateVector3("vReflectionSize",e.boundingBoxSize)}if(this.realTimeFiltering){const e=l.getSize().width;h.updateFloat2("vReflectionFilteringInfo",e,Math.log2(e))}if(!r.USEIRRADIANCEMAP){const e=l.sphericalPolynomial;if(r.USESPHERICALFROMREFLECTIONMAP&&e)if(r.SPHERICAL_HARMONICS){const t=e.preScaledHarmonics;h.updateVector3("vSphericalL00",t.l00),h.updateVector3("vSphericalL1_1",t.l1_1),h.updateVector3("vSphericalL10",t.l10),h.updateVector3("vSphericalL11",t.l11),h.updateVector3("vSphericalL2_2",t.l2_2),h.updateVector3("vSphericalL2_1",t.l2_1),h.updateVector3("vSphericalL20",t.l20),h.updateVector3("vSphericalL21",t.l21),h.updateVector3("vSphericalL22",t.l22)}else h.updateFloat3("vSphericalX",e.x.x,e.x.y,e.x.z),h.updateFloat3("vSphericalY",e.y.x,e.y.y,e.y.z),h.updateFloat3("vSphericalZ",e.z.x,e.z.y,e.z.z),h.updateFloat3("vSphericalXX_ZZ",e.xx.x-e.zz.x,e.xx.y-e.zz.y,e.xx.z-e.zz.z),h.updateFloat3("vSphericalYY_ZZ",e.yy.x-e.zz.x,e.yy.y-e.zz.y,e.yy.z-e.zz.z),h.updateFloat3("vSphericalZZ",e.zz.x,e.zz.y,e.zz.z),h.updateFloat3("vSphericalXY",e.xy.x,e.xy.y,e.xy.z),h.updateFloat3("vSphericalYZ",e.yz.x,e.yz.y,e.yz.z),h.updateFloat3("vSphericalZX",e.zx.x,e.zx.y,e.zx.z)}h.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset)}this._emissiveTexture&&Pe.EmissiveTextureEnabled&&(h.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),(0,$.mA)(this._emissiveTexture,h,"emissive")),this._lightmapTexture&&Pe.LightmapTextureEnabled&&(h.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),(0,$.mA)(this._lightmapTexture,h,"lightmap")),Pe.SpecularTextureEnabled&&(this._metallicTexture?(h.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),(0,$.mA)(this._metallicTexture,h,"reflectivity")):this._reflectivityTexture&&(h.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),(0,$.mA)(this._reflectivityTexture,h,"reflectivity")),this._metallicReflectanceTexture&&(h.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),(0,$.mA)(this._metallicReflectanceTexture,h,"metallicReflectance")),this._reflectanceTexture&&r.REFLECTANCE&&(h.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),(0,$.mA)(this._reflectanceTexture,h,"reflectance")),this._microSurfaceTexture&&(h.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),(0,$.mA)(this._microSurfaceTexture,h,"microSurfaceSampler"))),this._bumpTexture&&a.getCaps().standardDerivatives&&Pe.BumpTextureEnabled&&!this._disableBumpMap&&(h.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),(0,$.mA)(this._bumpTexture,h,"bump"),s._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),r.METALLICWORKFLOW){M.IG.Color3[0].r=void 0===this._metallic||null===this._metallic?1:this._metallic,M.IG.Color3[0].g=void 0===this._roughness||null===this._roughness?1:this._roughness,h.updateColor4("vReflectivityColor",M.IG.Color3[0],1);const e=this.subSurface?._indexOfRefraction??1.5,t=1,i=Math.pow((e-t)/(e+t),2);this._metallicReflectanceColor.scaleToRef(i*this._metallicF0Factor,M.IG.Color3[0]);const s=this._metallicF0Factor;h.updateColor4("vMetallicReflectanceFactors",M.IG.Color3[0],s)}else h.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);h.updateColor3("vEmissiveColor",Pe.EmissiveTextureEnabled?this._emissiveColor:M.v9.BlackReadOnly),h.updateColor3("vReflectionColor",this._reflectionColor),!r.SS_REFRACTION&&this.subSurface?._linkRefractionWithTransparency?h.updateColor4("vAlbedoColor",this._albedoColor,1):h.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*s.environmentIntensity,this._lightingInfos.w=this._specularIntensity,h.updateVector4("vLightingIntensity",this._lightingInfos),s.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),h.updateColor3("vAmbientColor",this._globalAmbientColor),h.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}s.texturesEnabled&&(this._albedoTexture&&Pe.DiffuseTextureEnabled&&h.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&Pe.AmbientTextureEnabled&&h.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Pe.OpacityTextureEnabled&&h.setTexture("opacitySampler",this._opacityTexture),l&&Pe.ReflectionTextureEnabled&&(r.LODBASEDMICROSFURACE?h.setTexture("reflectionSampler",l):(h.setTexture("reflectionSampler",l._lodTextureMid||l),h.setTexture("reflectionSamplerLow",l._lodTextureLow||l),h.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)),r.USEIRRADIANCEMAP&&h.setTexture("irradianceSampler",l.irradianceTexture)),r.ENVIRONMENTBRDF&&h.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&Pe.EmissiveTextureEnabled&&h.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Pe.LightmapTextureEnabled&&h.setTexture("lightmapSampler",this._lightmapTexture),Pe.SpecularTextureEnabled&&(this._metallicTexture?h.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&h.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&h.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&r.REFLECTANCE&&h.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&h.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&a.getCaps().standardDerivatives&&Pe.BumpTextureEnabled&&!this._disableBumpMap&&h.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(n),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),(0,q.gS)(this._activeEffect,this,s),this.bindEyePosition(n)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);!o&&this.isFrozen||(s.lightsEnabled&&!this._disableLighting&&(0,$.RL)(s,t,this._activeEffect,r,this._maxSimultaneousLights),(s.fogEnabled&&t.applyFog&&s.fogMode!==be.Z.FOGMODE_NONE||l||this.subSurface.refractionTexture||t.receiveShadows||r.PREPASS)&&this.bindView(n),(0,$.Yy)(s,t,this._activeEffect,!0),r.NUM_MORPH_INFLUENCERS&&(0,$.nR)(t,this._activeEffect),r.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(n,r.INSTANCES),this._imageProcessingConfiguration.bind(this._activeEffect),(0,$.DL)(r,this._activeEffect,s)),this._afterBind(t,this._activeEffect,i),h.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e}setPrePassRenderer(){if(!this.subSurface?.isScatteringEnabled)return!1;const e=this.getScene().enableSubSurfaceForPrePass();return e&&(e.enabled=!0),!0}dispose(e,t){this._breakShaderLoadedCheck=!0,t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),this._albedoTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._metallicTexture?.dispose(),this._reflectivityTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._metallicReflectanceTexture?.dispose(),this._reflectanceTexture?.dispose(),this._microSurfaceTexture?.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}qe.PBRMATERIAL_OPAQUE=Te.i.MATERIAL_OPAQUE,qe.PBRMATERIAL_ALPHATEST=Te.i.MATERIAL_ALPHATEST,qe.PBRMATERIAL_ALPHABLEND=Te.i.MATERIAL_ALPHABLEND,qe.PBRMATERIAL_ALPHATESTANDBLEND=Te.i.MATERIAL_ALPHATESTANDBLEND,qe.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,qe.LIGHTFALLOFF_PHYSICAL=0,qe.LIGHTFALLOFF_GLTF=1,qe.LIGHTFALLOFF_STANDARD=2,qe.ForceGLSL=!1,(0,w.Cg)([(0,D.n1)()],qe.prototype,"_imageProcessingConfiguration",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsMiscDirty")],qe.prototype,"debugMode",void 0);class $e extends qe{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===qe.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?qe.LIGHTFALLOFF_PHYSICAL:qe.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===qe.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?qe.LIGHTFALLOFF_GLTF:qe.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=$e.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=M.v9.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new M.v9(0,0,0),this.albedoColor=new M.v9(1,1,1),this.reflectivityColor=new M.v9(1,1,1),this.reflectionColor=new M.v9(1,1,1),this.emissiveColor=new M.v9(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=Fe(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){const s=N.p.Clone((()=>new $e(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return s.id=e,s.name=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){const s=N.p.Parse((()=>new $e(e.name,t)),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),Te.i._ParsePlugins(e,s,t,i),e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}$e.PBRMATERIAL_OPAQUE=qe.PBRMATERIAL_OPAQUE,$e.PBRMATERIAL_ALPHATEST=qe.PBRMATERIAL_ALPHATEST,$e.PBRMATERIAL_ALPHABLEND=qe.PBRMATERIAL_ALPHABLEND,$e.PBRMATERIAL_ALPHATESTANDBLEND=qe.PBRMATERIAL_ALPHATESTANDBLEND,$e.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=qe.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"directIntensity",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"emissiveIntensity",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"environmentIntensity",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"specularIntensity",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"disableBumpMap",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"albedoTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"ambientTexture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"ambientTextureStrength",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],$e.prototype,"opacityTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"reflectionTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"emissiveTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"reflectivityTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"metallicTexture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"metallic",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"roughness",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"metallicF0Factor",void 0),(0,w.Cg)([(0,D.jT)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"metallicReflectanceColor",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"metallicReflectanceTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"reflectanceTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"microSurfaceTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"bumpTexture",void 0),(0,w.Cg)([(0,D.uM)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty",null)],$e.prototype,"lightmapTexture",void 0),(0,w.Cg)([(0,D.jT)("ambient"),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"ambientColor",void 0),(0,w.Cg)([(0,D.jT)("albedo"),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"albedoColor",void 0),(0,w.Cg)([(0,D.jT)("reflectivity"),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"reflectivityColor",void 0),(0,w.Cg)([(0,D.jT)("reflection"),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"reflectionColor",void 0),(0,w.Cg)([(0,D.jT)("emissive"),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"emissiveColor",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"microSurface",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useLightmapAsShadowmap",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],$e.prototype,"useAlphaFromAlbedoTexture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],$e.prototype,"forceAlphaTest",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],$e.prototype,"alphaCutOff",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useSpecularOverAlpha",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useRoughnessFromMetallicTextureGreen",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useMetallnessFromMetallicTextureBlue",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useAmbientInGrayScale",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),(0,w.Cg)([(0,D.lK)()],$e.prototype,"usePhysicalLightFalloff",null),(0,w.Cg)([(0,D.lK)()],$e.prototype,"useGLTFLightFalloff",null),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useRadianceOverAlpha",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useObjectSpaceNormalMap",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useParallax",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useParallaxOcclusion",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"parallaxScaleBias",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsLightsDirty")],$e.prototype,"disableLighting",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"forceIrradianceInFragment",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsLightsDirty")],$e.prototype,"maxSimultaneousLights",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"invertNormalMapX",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"invertNormalMapY",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"twoSidedLighting",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useAlphaFresnel",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useLinearAlphaFresnel",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"environmentBRDFTexture",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"forceNormalForward",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"enableSpecularAntiAliasing",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useHorizonOcclusion",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],$e.prototype,"useRadianceOcclusion",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsMiscDirty")],$e.prototype,"unlit",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsMiscDirty")],$e.prototype,"applyDecalMapAfterDetailMap",void 0),(0,V.Y5)("BABYLON.PBRMaterial",$e),B.AddNodeConstructor("Light_Type_3",((e,t)=>()=>new je(e,I.Pq.Zero(),t)));class je extends z{constructor(e,t,i){super(e,i),this.groundColor=new M.v9(0,0,0),this.direction=t||I.Pq.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=I.Pq.Normalize(e.subtract(I.Pq.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=I.Pq.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=I.Pq.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=I.uq.Identity()),this._worldMatrix}getTypeID(){return z.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}(0,w.Cg)([(0,D.jT)()],je.prototype,"groundColor",void 0),(0,w.Cg)([(0,D.P_)()],je.prototype,"direction",void 0),(0,V.Y5)("BABYLON.HemisphericLight",je);var Ze=r(4609),Je=r(7503);function et(e,t,i){try{const s=e.next();s.done?t(s):s.value?s.value.then((()=>{s.value=void 0,t(s)}),i):t(s)}catch(e){i(e)}}function tt(e,t,i,s,r){const n=()=>{let a;const o=e=>{e.done?i(e.value):void 0===a?a=!0:n()};do{a=void 0,r&&r.aborted?s(new Error("Aborted")):t(e,o,s),void 0===a&&(a=!1)}while(a)};n()}function it(e,t){let i;return tt(e,et,(e=>i=e),(e=>{throw e}),t),i}var st=r(8563),rt=r(5907);class nt{}class at{constructor(){var e;this.uniqueId=0,this.metadata={},this._applyTo=(e=this._applyToCoroutine.bind(this),(...t)=>it(e(...t),undefined)),this.uniqueId=at._UniqueIDGenerator,at._UniqueIDGenerator++}set(e,t){switch(e.length||l.V.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case O.R.PositionKind:this.positions=e;break;case O.R.NormalKind:this.normals=e;break;case O.R.TangentKind:this.tangents=e;break;case O.R.UVKind:this.uvs=e;break;case O.R.UV2Kind:this.uvs2=e;break;case O.R.UV3Kind:this.uvs3=e;break;case O.R.UV4Kind:this.uvs4=e;break;case O.R.UV5Kind:this.uvs5=e;break;case O.R.UV6Kind:this.uvs6=e;break;case O.R.ColorKind:this.colors=e;break;case O.R.MatricesIndicesKind:this.matricesIndices=e;break;case O.R.MatricesWeightsKind:this.matricesWeights=e;break;case O.R.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case O.R.MatricesWeightsExtraKind:this.matricesWeightsExtra=e}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){if(this.positions&&(e.setVerticesData(O.R.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(O.R.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(O.R.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(O.R.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(O.R.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(O.R.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(O.R.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(O.R.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(O.R.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(O.R.ColorKind,this.colors,t),this.hasVertexAlpha&&void 0!==e.hasVertexAlpha&&(e.hasVertexAlpha=!0),i&&(yield)),this.matricesIndices&&(e.setVerticesData(O.R.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(O.R.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(O.R.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(O.R.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){const t=e;t.subMeshes=[];for(const e of this.materialInfos)new rt.K(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,t)}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(O.R.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(O.R.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(O.R.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(O.R.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(O.R.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(O.R.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(O.R.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(O.R.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(O.R.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(O.R.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(O.R.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(O.R.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(O.R.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(O.R.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,s=e.length){const r=I.AA.Vector3[0],n=I.AA.Vector3[1];for(let a=i;a<i+s;a+=3)I.Pq.FromArrayToRef(e,a,r),I.Pq.TransformCoordinatesToRef(r,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z}static _TransformVector3Normals(e,t,i=0,s=e.length){const r=I.AA.Vector3[0],n=I.AA.Vector3[1];for(let a=i;a<i+s;a+=3)I.Pq.FromArrayToRef(e,a,r),I.Pq.TransformNormalToRef(r,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z}static _TransformVector4Normals(e,t,i=0,s=e.length){const r=I.AA.Vector4[0],n=I.AA.Vector4[1];for(let a=i;a<i+s;a+=4)I.IU.FromArrayToRef(e,a,r),I.IU.TransformNormalToRef(r,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z,e[a+3]=n.w}static _FlipFaces(e,t=0,i=e.length){for(let s=t;s<t+i;s+=3){const t=e[s+1];e[s+1]=e[s+2],e[s+2]=t}}transform(e){const t=e.determinant()<0;return this.positions&&at._TransformVector3Coordinates(this.positions,e),this.normals&&at._TransformVector3Normals(this.normals,e),this.tangents&&at._TransformVector4Normals(this.tangents,e),t&&this.indices&&at._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];const e=[];for(const t of this.materialInfos){const i=new at;if(this.positions&&(i.positions=this.positions.slice(3*t.verticesStart,3*(t.verticesCount+t.verticesStart))),this.normals&&(i.normals=this.normals.slice(3*t.verticesStart,3*(t.verticesCount+t.verticesStart))),this.tangents&&(i.tangents=this.tangents.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.colors&&(i.colors=this.colors.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.uvs&&(i.uvs=this.uvs.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs2&&(i.uvs2=this.uvs2.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs3&&(i.uvs3=this.uvs3.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs4&&(i.uvs4=this.uvs4.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs5&&(i.uvs5=this.uvs5.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs6&&(i.uvs6=this.uvs6.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.indices){i.indices=[];for(let e=t.indexStart;e<t.indexStart+t.indexCount;e++)i.indices.push(this.indices[e]-t.verticesStart)}const s=new nt;s.indexStart=0,s.indexCount=i.indices?i.indices.length:0,s.materialIndex=t.materialIndex,s.verticesStart=0,s.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[s],e.push(i)}return e}merge(e,t=!1,i=!1,s=!1,r=!1){const n=Array.isArray(e)?e.map((e=>({vertexData:e}))):[{vertexData:e}];return it(this._mergeCoroutine(void 0,n,t,!1,i,s,r))}*_mergeCoroutine(e,t,i=!1,s,r,n=!1,a=!1){this._validate();let o=t.map((e=>e.vertexData)),l=this;if(a)for(const e of o)e&&(e._validate(),!this.normals&&e.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&e.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&e.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&e.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&e.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&e.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&e.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&e.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&e.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&e.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&e.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&e.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&e.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(const e of o)if(e)if(a)this.normals&&!e.normals&&(e.normals=new Float32Array(e.positions.length)),this.tangents&&!e.tangents&&(e.tangents=new Float32Array(e.positions.length/3*4)),this.uvs&&!e.uvs&&(e.uvs=new Float32Array(e.positions.length/3*2)),this.uvs2&&!e.uvs2&&(e.uvs2=new Float32Array(e.positions.length/3*2)),this.uvs3&&!e.uvs3&&(e.uvs3=new Float32Array(e.positions.length/3*2)),this.uvs4&&!e.uvs4&&(e.uvs4=new Float32Array(e.positions.length/3*2)),this.uvs5&&!e.uvs5&&(e.uvs5=new Float32Array(e.positions.length/3*2)),this.uvs6&&!e.uvs6&&(e.uvs6=new Float32Array(e.positions.length/3*2)),this.colors&&!e.colors&&(e.colors=new Float32Array(e.positions.length/3*4),e.colors.fill(1)),this.matricesIndices&&!e.matricesIndices&&(e.matricesIndices=new Float32Array(e.positions.length/3*4)),this.matricesWeights&&!e.matricesWeights&&(e.matricesWeights=new Float32Array(e.positions.length/3*4)),this.matricesIndicesExtra&&!e.matricesIndicesExtra&&(e.matricesIndicesExtra=new Float32Array(e.positions.length/3*4)),this.matricesWeightsExtra&&!e.matricesWeightsExtra&&(e.matricesWeightsExtra=new Float32Array(e.positions.length/3*4));else if(e._validate(),!this.normals!=!e.normals||!this.tangents!=!e.tangents||!this.uvs!=!e.uvs||!this.uvs2!=!e.uvs2||!this.uvs3!=!e.uvs3||!this.uvs4!=!e.uvs4||!this.uvs5!=!e.uvs5||!this.uvs6!=!e.uvs6||!this.colors!=!e.colors||!this.matricesIndices!=!e.matricesIndices||!this.matricesWeights!=!e.matricesWeights||!this.matricesIndicesExtra!=!e.matricesIndicesExtra||!this.matricesWeightsExtra!=!e.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");if(n){let i=0,s=0,r=0;const n=[];let a=null;const h=[];for(const t of this.splitBasedOnMaterialID())h.push({vertexData:t,transform:e});for(const e of t)if(e.vertexData)for(const t of e.vertexData.splitBasedOnMaterialID())h.push({vertexData:t,transform:e.transform});h.sort(((e,t)=>{const i=e.vertexData.materialInfos?e.vertexData.materialInfos[0].materialIndex:0,s=t.vertexData.materialInfos?t.vertexData.materialInfos[0].materialIndex:0;return i>s?1:i===s?0:-1}));for(const e of h){const t=e.vertexData;if(i=t.materialInfos?t.materialInfos[0].materialIndex:0,a&&a.materialIndex===i)a.indexCount+=t.indices.length,a.verticesCount+=t.positions.length/3;else{const e=new nt;e.materialIndex=i,e.indexStart=s,e.indexCount=t.indices.length,e.verticesStart=r,e.verticesCount=t.positions.length/3,n.push(e),a=e}s+=t.indices.length,r+=t.positions.length/3}const c=h.splice(0,1)[0];l=c.vertexData,e=c.transform,o=h.map((e=>e.vertexData)),t=h,this.materialInfos=n}const h=o.reduce(((e,t)=>e+(t.indices?.length??0)),l.indices?.length??0);let c=r||o.some((e=>e.indices===l.indices))?l.indices?.slice():l.indices;if(h>0){let r=c?.length??0;if(c||(c=new Array(h)),c.length!==h){if(Array.isArray(c))c.length=h;else{const e=i||c instanceof Uint32Array?new Uint32Array(h):new Uint16Array(h);e.set(c),c=e}e&&e.determinant()<0&&at._FlipFaces(c,0,r)}let n=l.positions?l.positions.length/3:0;for(const{vertexData:e,transform:i}of t)if(e.indices){for(let t=0;t<e.indices.length;t++)c[r+t]=e.indices[t]+n;i&&i.determinant()<0&&at._FlipFaces(c,r,e.indices.length),n+=e.positions.length/3,r+=e.indices.length,s&&(yield)}}return this.indices=c,this.positions=at._MergeElement(O.R.PositionKind,l.positions,e,t.map((e=>[e.vertexData.positions,e.transform]))),s&&(yield),l.normals&&(this.normals=at._MergeElement(O.R.NormalKind,l.normals,e,t.map((e=>[e.vertexData.normals,e.transform]))),s&&(yield)),l.tangents&&(this.tangents=at._MergeElement(O.R.TangentKind,l.tangents,e,t.map((e=>[e.vertexData.tangents,e.transform]))),s&&(yield)),l.uvs&&(this.uvs=at._MergeElement(O.R.UVKind,l.uvs,e,t.map((e=>[e.vertexData.uvs,e.transform]))),s&&(yield)),l.uvs2&&(this.uvs2=at._MergeElement(O.R.UV2Kind,l.uvs2,e,t.map((e=>[e.vertexData.uvs2,e.transform]))),s&&(yield)),l.uvs3&&(this.uvs3=at._MergeElement(O.R.UV3Kind,l.uvs3,e,t.map((e=>[e.vertexData.uvs3,e.transform]))),s&&(yield)),l.uvs4&&(this.uvs4=at._MergeElement(O.R.UV4Kind,l.uvs4,e,t.map((e=>[e.vertexData.uvs4,e.transform]))),s&&(yield)),l.uvs5&&(this.uvs5=at._MergeElement(O.R.UV5Kind,l.uvs5,e,t.map((e=>[e.vertexData.uvs5,e.transform]))),s&&(yield)),l.uvs6&&(this.uvs6=at._MergeElement(O.R.UV6Kind,l.uvs6,e,t.map((e=>[e.vertexData.uvs6,e.transform]))),s&&(yield)),l.colors&&(this.colors=at._MergeElement(O.R.ColorKind,l.colors,e,t.map((e=>[e.vertexData.colors,e.transform]))),(void 0!==l.hasVertexAlpha||t.some((e=>void 0!==e.vertexData.hasVertexAlpha)))&&(this.hasVertexAlpha=l.hasVertexAlpha||t.some((e=>e.vertexData.hasVertexAlpha))),s&&(yield)),l.matricesIndices&&(this.matricesIndices=at._MergeElement(O.R.MatricesIndicesKind,l.matricesIndices,e,t.map((e=>[e.vertexData.matricesIndices,e.transform]))),s&&(yield)),l.matricesWeights&&(this.matricesWeights=at._MergeElement(O.R.MatricesWeightsKind,l.matricesWeights,e,t.map((e=>[e.vertexData.matricesWeights,e.transform]))),s&&(yield)),l.matricesIndicesExtra&&(this.matricesIndicesExtra=at._MergeElement(O.R.MatricesIndicesExtraKind,l.matricesIndicesExtra,e,t.map((e=>[e.vertexData.matricesIndicesExtra,e.transform]))),s&&(yield)),l.matricesWeightsExtra&&(this.matricesWeightsExtra=at._MergeElement(O.R.MatricesWeightsExtraKind,l.matricesWeightsExtra,e,t.map((e=>[e.vertexData.matricesWeightsExtra,e.transform])))),this}static _MergeElement(e,t,i,s){const r=s.filter((e=>null!==e[0]&&void 0!==e[0]));if(!t&&0==r.length)return t;if(!t)return this._MergeElement(e,r[0][0],r[0][1],r.slice(1));const n=r.reduce(((e,t)=>e+t[0].length),t.length),a=e===O.R.PositionKind?at._TransformVector3Coordinates:e===O.R.NormalKind?at._TransformVector3Normals:e===O.R.TangentKind?at._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const e=new Float32Array(n);e.set(t),i&&a(e,i,0,t.length);let s=t.length;for(const[t,i]of r)e.set(t,s),i&&a(e,i,s,t.length),s+=t.length;return e}{const e=new Array(n);for(let i=0;i<t.length;i++)e[i]=t[i];i&&a(e,i,0,t.length);let s=t.length;for(const[t,i]of r){for(let i=0;i<t.length;i++)e[s+i]=t[i];i&&a(e,i,s,t.length),s+=t.length}return e}}_validate(){if(!this.positions)throw new st.bu("Positions are required",st.tG.MeshInvalidPositionsError);const e=(e,t)=>{const i=O.R.DeduceStride(e);if(t.length%i!=0)throw new Error("The "+e+"s array count must be a multiple of "+i);return t.length/i},t=e(O.R.PositionKind,this.positions),i=(i,s)=>{const r=e(i,s);if(r!==t)throw new Error("The "+i+"s element count ("+r+") does not match the positions count ("+t+")")};this.normals&&i(O.R.NormalKind,this.normals),this.tangents&&i(O.R.TangentKind,this.tangents),this.uvs&&i(O.R.UVKind,this.uvs),this.uvs2&&i(O.R.UV2Kind,this.uvs2),this.uvs3&&i(O.R.UV3Kind,this.uvs3),this.uvs4&&i(O.R.UV4Kind,this.uvs4),this.uvs5&&i(O.R.UV5Kind,this.uvs5),this.uvs6&&i(O.R.UV6Kind,this.uvs6),this.colors&&i(O.R.ColorKind,this.colors),this.matricesIndices&&i(O.R.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(O.R.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(O.R.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(O.R.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){const e=this.serialize();return at.Parse(e)}serialize(){const e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors),e.hasVertexAlpha=this.hasVertexAlpha),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=Array.from(this.indices),this.materialInfos){e.materialInfos=[];for(const t of this.materialInfos){const i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i)}}return e}static ExtractFromMesh(e,t,i){return at._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return at._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const s=new at;if(e.isVerticesDataPresent(O.R.PositionKind)&&(s.positions=e.getVerticesData(O.R.PositionKind,t,i)),e.isVerticesDataPresent(O.R.NormalKind)&&(s.normals=e.getVerticesData(O.R.NormalKind,t,i)),e.isVerticesDataPresent(O.R.TangentKind)&&(s.tangents=e.getVerticesData(O.R.TangentKind,t,i)),e.isVerticesDataPresent(O.R.UVKind)&&(s.uvs=e.getVerticesData(O.R.UVKind,t,i)),e.isVerticesDataPresent(O.R.UV2Kind)&&(s.uvs2=e.getVerticesData(O.R.UV2Kind,t,i)),e.isVerticesDataPresent(O.R.UV3Kind)&&(s.uvs3=e.getVerticesData(O.R.UV3Kind,t,i)),e.isVerticesDataPresent(O.R.UV4Kind)&&(s.uvs4=e.getVerticesData(O.R.UV4Kind,t,i)),e.isVerticesDataPresent(O.R.UV5Kind)&&(s.uvs5=e.getVerticesData(O.R.UV5Kind,t,i)),e.isVerticesDataPresent(O.R.UV6Kind)&&(s.uvs6=e.getVerticesData(O.R.UV6Kind,t,i)),e.isVerticesDataPresent(O.R.ColorKind)){const r=e.geometry||e,n=r.getVertexBuffer(O.R.ColorKind),a=r.getVerticesData(O.R.ColorKind,t,i);if(3===n.getSize()){const e=new Float32Array(4*a.length/3);for(let t=0,i=0;t<a.length;t+=3,i+=4)e[i]=a[t],e[i+1]=a[t+1],e[i+2]=a[t+2],e[i+3]=1;s.colors=e}else{if(4!==n.getSize())throw new Error(`Unexpected number of color components: ${n.getSize()}`);s.colors=a}}return e.isVerticesDataPresent(O.R.MatricesIndicesKind)&&(s.matricesIndices=e.getVerticesData(O.R.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(O.R.MatricesWeightsKind)&&(s.matricesWeights=e.getVerticesData(O.R.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(O.R.MatricesIndicesExtraKind)&&(s.matricesIndicesExtra=e.getVerticesData(O.R.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(O.R.MatricesWeightsExtraKind)&&(s.matricesWeightsExtra=e.getVerticesData(O.R.MatricesWeightsExtraKind,t,i)),s.indices=e.getIndices(t,i),s}static CreateRibbon(e){throw(0,F.n)("ribbonBuilder")}static CreateBox(e){throw(0,F.n)("boxBuilder")}static CreateTiledBox(e){throw(0,F.n)("tiledBoxBuilder")}static CreateTiledPlane(e){throw(0,F.n)("tiledPlaneBuilder")}static CreateSphere(e){throw(0,F.n)("sphereBuilder")}static CreateCylinder(e){throw(0,F.n)("cylinderBuilder")}static CreateTorus(e){throw(0,F.n)("torusBuilder")}static CreateLineSystem(e){throw(0,F.n)("linesBuilder")}static CreateDashedLines(e){throw(0,F.n)("linesBuilder")}static CreateGround(e){throw(0,F.n)("groundBuilder")}static CreateTiledGround(e){throw(0,F.n)("groundBuilder")}static CreateGroundFromHeightMap(e){throw(0,F.n)("groundBuilder")}static CreatePlane(e){throw(0,F.n)("planeBuilder")}static CreateDisc(e){throw(0,F.n)("discBuilder")}static CreatePolygon(e,t,i,s,r,n,a){throw(0,F.n)("polygonBuilder")}static CreateIcoSphere(e){throw(0,F.n)("icoSphereBuilder")}static CreatePolyhedron(e){throw(0,F.n)("polyhedronBuilder")}static CreateCapsule(e={orientation:I.Pq.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw(0,F.n)("capsuleBuilder")}static CreateTorusKnot(e){throw(0,F.n)("torusKnotBuilder")}static ComputeNormals(e,t,i,s){let r=0,n=0,a=0,o=0,l=0,h=0,c=0,u=0,d=0,_=0,p=0,f=0,m=0,g=0,v=0,b=0,x=0,S=0,T=0,y=0,C=!1,P=!1,E=!1,A=!1,R=1,M=0,O=null;s&&(C=!!s.facetNormals,P=!!s.facetPositions,E=!!s.facetPartitioning,R=!0===s.useRightHandedSystem?-1:1,M=s.ratio||0,A=!!s.depthSort,O=s.distanceTo,A&&void 0===O&&(O=I.Pq.Zero()));let w=0,D=0,F=0,N=0;for(E&&s&&s.bbSize&&(w=s.subDiv.X*M/s.bbSize.x,D=s.subDiv.Y*M/s.bbSize.y,F=s.subDiv.Z*M/s.bbSize.z,N=s.subDiv.max*s.subDiv.max,s.facetPartitioning.length=0),r=0;r<e.length;r++)i[r]=0;const L=t.length/3|0;for(r=0;r<L;r++){if(f=3*t[3*r],m=f+1,g=f+2,v=3*t[3*r+1],b=v+1,x=v+2,S=3*t[3*r+2],T=S+1,y=S+2,n=e[f]-e[v],a=e[m]-e[b],o=e[g]-e[x],l=e[S]-e[v],h=e[T]-e[b],c=e[y]-e[x],u=R*(a*c-o*h),d=R*(o*l-n*c),_=R*(n*h-a*l),p=Math.sqrt(u*u+d*d+_*_),p=0===p?1:p,u/=p,d/=p,_/=p,C&&s&&(s.facetNormals[r].x=u,s.facetNormals[r].y=d,s.facetNormals[r].z=_),P&&s&&(s.facetPositions[r].x=(e[f]+e[v]+e[S])/3,s.facetPositions[r].y=(e[m]+e[b]+e[T])/3,s.facetPositions[r].z=(e[g]+e[x]+e[y])/3),E&&s){const t=Math.floor((s.facetPositions[r].x-s.bInfo.minimum.x*M)*w),i=Math.floor((s.facetPositions[r].y-s.bInfo.minimum.y*M)*D),n=Math.floor((s.facetPositions[r].z-s.bInfo.minimum.z*M)*F),a=Math.floor((e[f]-s.bInfo.minimum.x*M)*w),o=Math.floor((e[m]-s.bInfo.minimum.y*M)*D),l=Math.floor((e[g]-s.bInfo.minimum.z*M)*F),h=Math.floor((e[v]-s.bInfo.minimum.x*M)*w),c=Math.floor((e[b]-s.bInfo.minimum.y*M)*D),u=Math.floor((e[x]-s.bInfo.minimum.z*M)*F),d=Math.floor((e[S]-s.bInfo.minimum.x*M)*w),_=Math.floor((e[T]-s.bInfo.minimum.y*M)*D),p=Math.floor((e[y]-s.bInfo.minimum.z*M)*F),C=a+s.subDiv.max*o+N*l,P=h+s.subDiv.max*c+N*u,E=d+s.subDiv.max*_+N*p,A=t+s.subDiv.max*i+N*n;s.facetPartitioning[A]=s.facetPartitioning[A]?s.facetPartitioning[A]:new Array,s.facetPartitioning[C]=s.facetPartitioning[C]?s.facetPartitioning[C]:new Array,s.facetPartitioning[P]=s.facetPartitioning[P]?s.facetPartitioning[P]:new Array,s.facetPartitioning[E]=s.facetPartitioning[E]?s.facetPartitioning[E]:new Array,s.facetPartitioning[C].push(r),P!=C&&s.facetPartitioning[P].push(r),E!=P&&E!=C&&s.facetPartitioning[E].push(r),A!=C&&A!=P&&A!=E&&s.facetPartitioning[A].push(r)}if(A&&s&&s.facetPositions){const e=s.depthSortedFacets[r];e.ind=3*r,e.sqDistance=I.Pq.DistanceSquared(s.facetPositions[r],O)}i[f]+=u,i[m]+=d,i[g]+=_,i[v]+=u,i[b]+=d,i[x]+=_,i[S]+=u,i[T]+=d,i[y]+=_}for(r=0;r<i.length/3;r++)u=i[3*r],d=i[3*r+1],_=i[3*r+2],p=Math.sqrt(u*u+d*d+_*_),p=0===p?1:p,u/=p,d/=p,_/=p,i[3*r]=u,i[3*r+1]=d,i[3*r+2]=_}static _ComputeSides(e,t,i,s,r,n,a){const o=i.length,l=s.length;let h,c;switch(e=e||at.DEFAULTSIDE){case at.FRONTSIDE:break;case at.BACKSIDE:for(h=0;h<o;h+=3){const e=i[h];i[h]=i[h+2],i[h+2]=e}for(c=0;c<l;c++)s[c]=-s[c];break;case at.DOUBLESIDE:{const e=t.length,u=e/3;for(let i=0;i<e;i++)t[e+i]=t[i];for(h=0;h<o;h+=3)i[h+o]=i[h+2]+u,i[h+1+o]=i[h+1]+u,i[h+2+o]=i[h]+u;for(c=0;c<l;c++)s[l+c]=-s[c];const d=r.length;let _=0;for(_=0;_<d;_++)r[_+d]=r[_];for(n=n||new I.IU(0,0,1,1),a=a||new I.IU(0,0,1,1),_=0,h=0;h<d/2;h++)r[_]=n.x+(n.z-n.x)*r[_],r[_+1]=n.y+(n.w-n.y)*r[_+1],r[_+d]=a.x+(a.z-a.x)*r[_+d],r[_+d+1]=a.y+(a.w-a.y)*r[_+d+1],_+=2;break}}}static Parse(e){const t=new at,i=e.positions;i&&t.set(i,O.R.PositionKind);const s=e.normals;s&&t.set(s,O.R.NormalKind);const r=e.tangents;r&&t.set(r,O.R.TangentKind);const n=e.uvs;n&&t.set(n,O.R.UVKind);const a=e.uvs2;a&&t.set(a,O.R.UV2Kind);const o=e.uvs3;o&&t.set(o,O.R.UV3Kind);const l=e.uvs4;l&&t.set(l,O.R.UV4Kind);const h=e.uvs5;h&&t.set(h,O.R.UV5Kind);const c=e.uvs6;c&&t.set(c,O.R.UV6Kind);const u=e.colors;u&&(t.set(M.ov.CheckColors4(u,i.length/3),O.R.ColorKind),void 0!==e.hasVertexAlpha&&(t.hasVertexAlpha=e.hasVertexAlpha));const d=e.matricesIndices;d&&t.set(d,O.R.MatricesIndicesKind);const _=e.matricesWeights;_&&t.set(_,O.R.MatricesWeightsKind);const p=e.indices;p&&(t.indices=p);const f=e.materialInfos;if(f){t.materialInfos=[];for(const e of f){const i=new nt;i.indexCount=e.indexCount,i.indexStart=e.indexStart,i.verticesCount=e.verticesCount,i.verticesStart=e.verticesStart,i.materialIndex=e.materialIndex,t.materialInfos.push(i)}}return t}static ImportVertexData(e,t){const i=at.Parse(e);t.setAllVerticesData(i,e.updatable)}}at.FRONTSIDE=0,at.BACKSIDE=1,at.DOUBLESIDE=2,at.DEFAULTSIDE=0,at._UniqueIDGenerator=0,(0,w.Cg)([D.Cx.filter(((...[e])=>!Array.isArray(e)))],at,"_TransformVector3Coordinates",null),(0,w.Cg)([D.Cx.filter(((...[e])=>!Array.isArray(e)))],at,"_TransformVector3Normals",null),(0,w.Cg)([D.Cx.filter(((...[e])=>!Array.isArray(e)))],at,"_TransformVector4Normals",null),(0,w.Cg)([D.Cx.filter(((...[e])=>!Array.isArray(e)))],at,"_FlipFaces",null);class ot{static get ForceFullSceneLoadingForIncremental(){return ot._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){ot._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return ot._ShowLoadingScreen}static set ShowLoadingScreen(e){ot._ShowLoadingScreen=e}static get loggingLevel(){return ot._LoggingLevel}static set loggingLevel(e){ot._LoggingLevel=e}static get CleanBoneMatrixWeights(){return ot._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){ot._CleanBoneMatrixWeights=e}}ot._ForceFullSceneLoadingForIncremental=!1,ot._ShowLoadingScreen=!0,ot._CleanBoneMatrixWeights=!1,ot._LoggingLevel=0;var lt=r(1139),ht=r(1313);class ct{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new ct(ct.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,i,s,r=!1,n=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=i||t.q.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,s?this.setAllVerticesData(s,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),n&&(this.applyToMesh(n),n.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return 1===this.delayLoadState||0===this.delayLoadState}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer"));const e=new Set;for(const t in this._vertexBuffers)e.add(this._vertexBuffers[t].getWrapperBuffer());e.forEach((e=>{e._rebuild()}))}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,s){i&&Array.isArray(t)&&(t=new Float32Array(t));const r=new O.R(this._engine,t,e,{updatable:i,postponeInternalCreation:0===this._meshes.length,stride:s,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(r)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const s=e.getKind();this._vertexBuffers[s]&&i&&this._vertexBuffers[s].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[s]=e;const r=this._meshes,n=r.length;if(s===O.R.PositionKind){this._totalVertices=t??e._maxVerticesCount,this._updateExtend(e.getFloatData(this._totalVertices)),this._resetPointsArrayCache();const i=this._extend&&this._extend.minimum||new I.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),s=this._extend&&this._extend.maximum||new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let e=0;e<n;e++){const t=r[e];t.buildBoundingInfo(i,s),t._createGlobalSubMesh(t.isUnIndexed),t.computeWorldMatrix(!0),t.synchronizeInstances()}}this._notifyUpdate(s)}updateVerticesDataDirectly(e,t,i,s=!1){const r=this.getVertexBuffer(e);r&&(r.updateDirectly(t,i,s),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const s=this.getVertexBuffer(e);s&&(s.update(t),e===O.R.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const e=this._meshes;for(const t of e){t.hasBoundingInfo?t.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):t.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const e=t.subMeshes;for(const t of e)t.refreshBoundingInfo()}}}_bind(e,t,i,s){if(!e)return;void 0===t&&(t=this._indexBuffer);const r=this.getVertexBuffers();if(!r)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!s)return void this._engine.bindBuffers(r,t,e,i);const n=s||this._vertexArrayObjects,a=this._engine;n[e.key]||(n[e.key]=a.recordVertexArrayObject(r,t,e,i)),a.bindVertexArrayObject(n[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const s=this.getVertexBuffer(e);return s?s.getFloatData(this._totalVertices,i||t&&1!==this._meshes.length):null}copyVerticesData(e,t){const i=this.getVertexBuffer(e);if(!i)return;t[e]||(t[e]=new Float32Array(this._totalVertices*i.getSize()));const s=i.getData();s&&function(e,t,i,s,r,n,a,o){const h=t*O.R.GetTypeByteLength(i),c=a*t;if(o.length!==c)throw new Error("Output length is not valid");if(i===O.R.FLOAT&&r===h)if(e instanceof Array){const t=s/4;o.set(e,t)}else if(e instanceof ArrayBuffer){const t=new Float32Array(e,s,c);o.set(t)}else{const t=e.byteOffset+s;if(t%4)return l.V.Warn("CopyFloatData: copied misaligned data."),void o.set(new Float32Array(e.buffer.slice(t,t+4*c)));const i=new Float32Array(e.buffer,t,c);o.set(i)}else O.R.ForEach(e,s,r,t,i,c,n,((e,t)=>o[t]=e))}(s,i.getSize(),i.type,i.byteOffset,i.byteStride,i.normalized,this._totalVertices,t[e])}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return!!t&&t.isUpdatable()}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(this._indexBufferIsUpdatable){const s=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),s)for(const e of this._meshes)e._createGlobalSubMesh(!0)}else this.setIndices(e,null,!0)}setIndexBuffer(e,t,i){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=i,e.is32Bits||(e.is32Bits=this._totalIndices>65535);for(const e of this._meshes)e._createGlobalSubMesh(!0),e.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,i=!1,s=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i,"Geometry_"+this.id+"_IndexBuffer")),null!=t&&(this._totalVertices=t);for(const e of this._meshes)e._createGlobalSubMesh(!s),e.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?void 0!==this._totalIndices?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return t||e&&1!==this._meshes.length?i.slice():i}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){e&&this._vertexArrayObjects&&this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,s=i.indexOf(e);-1!==s&&(i.splice(s,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,0===i.length&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&!(e=this.getVerticesData(O.R.PositionKind)))return;this._extend=(0,lt.b)(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)1===t&&this._vertexBuffers[i].create(),i===O.R.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());1===t&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer")),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const e of this._meshes)e._markSubMeshesAsAttributesDirty()}load(e,t){2!==this.delayLoadState&&(this.isReady()?t&&t():(this.delayLoadState=2,this._queueLoad(e,t)))}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,(i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const s=this._meshes,r=s.length;for(let e=0;e<r;e++)this._applyToMesh(s[e]);t&&t()}),void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(null!=e&&e.length>0){for(let t=0;t<e.length;t+=3){const i=e[t+0];e[t+0]=e[t+2],e[t+2]=i}this.setIndices(e)}const t=this.getVerticesData(O.R.PositionKind,!1);if(null!=t&&t.length>0){for(let e=0;e<t.length;e+=3)t[e+2]=-t[e+2];this.setVerticesData(O.R.PositionKind,t,!1)}const i=this.getVerticesData(O.R.NormalKind,!1);if(null!=i&&i.length>0){for(let e=0;e<i.length;e+=3)i[e+2]=-i[e+2];this.setVerticesData(O.R.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(O.R.PositionKind);if(!e||0===e.length)return!1;for(let t=3*this._positionsCache.length,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=I.Pq.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const e in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const e in this._vertexBuffers)this._vertexBuffers[e].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const e=this._parentContainer.geometries.indexOf(this);e>-1&&this._parentContainer.geometries.splice(e,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new at;t.indices=[];const i=this.getIndices();if(i)for(let e=0;e<i.length;e++)t.indices.push(i[e]);let s,r=!1,n=!1;for(s in this._vertexBuffers){const e=this.getVerticesData(s);if(e&&(e instanceof Float32Array?t.set(new Float32Array(e),s):t.set(e.slice(0),s),!n)){const e=this.getVertexBuffer(s);e&&(r=e.isUpdatable(),n=!r)}}const a=new ct(e,this._scene,t,r);for(s in a.delayLoadState=this.delayLoadState,a.delayLoadingFile=this.delayLoadingFile,a._delayLoadingFunction=this._delayLoadingFunction,this._delayInfo)a._delayInfo=a._delayInfo||[],a._delayInfo.push(s);return a._boundingInfo=new Z.j(this._extend.minimum,this._extend.maximum),a}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Je.Y&&Je.Y.HasTags(this)&&(e.tags=Je.Y.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(O.R.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(O.R.PositionKind)),this.isVertexBufferUpdatable(O.R.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(O.R.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(O.R.NormalKind)),this.isVertexBufferUpdatable(O.R.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(O.R.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(O.R.TangentKind)),this.isVertexBufferUpdatable(O.R.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(O.R.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(O.R.UVKind)),this.isVertexBufferUpdatable(O.R.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(O.R.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(O.R.UV2Kind)),this.isVertexBufferUpdatable(O.R.UV2Kind)&&(e.uvs2._updatable=!0)),this.isVerticesDataPresent(O.R.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(O.R.UV3Kind)),this.isVertexBufferUpdatable(O.R.UV3Kind)&&(e.uvs3._updatable=!0)),this.isVerticesDataPresent(O.R.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(O.R.UV4Kind)),this.isVertexBufferUpdatable(O.R.UV4Kind)&&(e.uvs4._updatable=!0)),this.isVerticesDataPresent(O.R.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(O.R.UV5Kind)),this.isVertexBufferUpdatable(O.R.UV5Kind)&&(e.uvs5._updatable=!0)),this.isVerticesDataPresent(O.R.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(O.R.UV6Kind)),this.isVertexBufferUpdatable(O.R.UV6Kind)&&(e.uvs6._updatable=!0)),this.isVerticesDataPresent(O.R.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(O.R.ColorKind)),this.isVertexBufferUpdatable(O.R.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(O.R.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(O.R.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(O.R.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(O.R.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(O.R.MatricesWeightsKind)),this.isVertexBufferUpdatable(O.R.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return ee.S0.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),s=e.geometryUniqueId,r=e.geometryId;if(s||r){const e=s?this._GetGeometryByLoadedUniqueId(s,i):i.getGeometryById(r);e&&e.applyToMesh(t)}else if(e instanceof ArrayBuffer){const i=t._binaryInfo;if(i.positionsAttrDesc&&i.positionsAttrDesc.count>0){const s=new Float32Array(e,i.positionsAttrDesc.offset,i.positionsAttrDesc.count);t.setVerticesData(O.R.PositionKind,s,!1)}if(i.normalsAttrDesc&&i.normalsAttrDesc.count>0){const s=new Float32Array(e,i.normalsAttrDesc.offset,i.normalsAttrDesc.count);t.setVerticesData(O.R.NormalKind,s,!1)}if(i.tangetsAttrDesc&&i.tangetsAttrDesc.count>0){const s=new Float32Array(e,i.tangetsAttrDesc.offset,i.tangetsAttrDesc.count);t.setVerticesData(O.R.TangentKind,s,!1)}if(i.uvsAttrDesc&&i.uvsAttrDesc.count>0){const s=new Float32Array(e,i.uvsAttrDesc.offset,i.uvsAttrDesc.count);if(ht.rX)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(O.R.UVKind,s,!1)}if(i.uvs2AttrDesc&&i.uvs2AttrDesc.count>0){const s=new Float32Array(e,i.uvs2AttrDesc.offset,i.uvs2AttrDesc.count);if(ht.rX)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(O.R.UV2Kind,s,!1)}if(i.uvs3AttrDesc&&i.uvs3AttrDesc.count>0){const s=new Float32Array(e,i.uvs3AttrDesc.offset,i.uvs3AttrDesc.count);if(ht.rX)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(O.R.UV3Kind,s,!1)}if(i.uvs4AttrDesc&&i.uvs4AttrDesc.count>0){const s=new Float32Array(e,i.uvs4AttrDesc.offset,i.uvs4AttrDesc.count);if(ht.rX)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(O.R.UV4Kind,s,!1)}if(i.uvs5AttrDesc&&i.uvs5AttrDesc.count>0){const s=new Float32Array(e,i.uvs5AttrDesc.offset,i.uvs5AttrDesc.count);if(ht.rX)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(O.R.UV5Kind,s,!1)}if(i.uvs6AttrDesc&&i.uvs6AttrDesc.count>0){const s=new Float32Array(e,i.uvs6AttrDesc.offset,i.uvs6AttrDesc.count);if(ht.rX)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(O.R.UV6Kind,s,!1)}if(i.colorsAttrDesc&&i.colorsAttrDesc.count>0){const s=new Float32Array(e,i.colorsAttrDesc.offset,i.colorsAttrDesc.count);t.setVerticesData(O.R.ColorKind,s,!1,i.colorsAttrDesc.stride)}if(i.matricesIndicesAttrDesc&&i.matricesIndicesAttrDesc.count>0){const s=new Int32Array(e,i.matricesIndicesAttrDesc.offset,i.matricesIndicesAttrDesc.count),r=[];for(let e=0;e<s.length;e++){const t=s[e];r.push(255&t),r.push((65280&t)>>8),r.push((16711680&t)>>16),r.push(t>>24&255)}t.setVerticesData(O.R.MatricesIndicesKind,r,!1)}if(i.matricesIndicesExtraAttrDesc&&i.matricesIndicesExtraAttrDesc.count>0){const s=new Int32Array(e,i.matricesIndicesExtraAttrDesc.offset,i.matricesIndicesExtraAttrDesc.count),r=[];for(let e=0;e<s.length;e++){const t=s[e];r.push(255&t),r.push((65280&t)>>8),r.push((16711680&t)>>16),r.push(t>>24&255)}t.setVerticesData(O.R.MatricesIndicesExtraKind,r,!1)}if(i.matricesWeightsAttrDesc&&i.matricesWeightsAttrDesc.count>0){const s=new Float32Array(e,i.matricesWeightsAttrDesc.offset,i.matricesWeightsAttrDesc.count);t.setVerticesData(O.R.MatricesWeightsKind,s,!1)}if(i.indicesAttrDesc&&i.indicesAttrDesc.count>0){const s=new Int32Array(e,i.indicesAttrDesc.offset,i.indicesAttrDesc.count);t.setIndices(s,null)}if(i.subMeshesAttrDesc&&i.subMeshesAttrDesc.count>0){const s=new Int32Array(e,i.subMeshesAttrDesc.offset,5*i.subMeshesAttrDesc.count);t.subMeshes=[];for(let e=0;e<i.subMeshesAttrDesc.count;e++){const i=s[5*e+0],r=s[5*e+1],n=s[5*e+2],a=s[5*e+3],o=s[5*e+4];rt.K.AddToMesh(i,r,n,a,o,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(O.R.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(O.R.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(O.R.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(O.R.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(O.R.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(O.R.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(O.R.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(O.R.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(O.R.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(O.R.ColorKind,M.ov.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(O.R.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const i=[];for(let t=0;t<e.matricesIndices.length;t++){const s=e.matricesIndices[t];i.push(255&s),i.push((65280&s)>>8),i.push((16711680&s)>>16),i.push(s>>24&255)}t.setVerticesData(O.R.MatricesIndicesKind,i,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(O.R.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const i=[];for(let t=0;t<e.matricesIndicesExtra.length;t++){const s=e.matricesIndicesExtra[t];i.push(255&s),i.push((65280&s)>>8),i.push((16711680&s)>>16),i.push(s>>24&255)}t.setVerticesData(O.R.MatricesIndicesExtraKind,i,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(ct._CleanMatricesWeights(e,t),t.setVerticesData(O.R.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(O.R.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let i=0;i<e.subMeshes.length;i++){const s=e.subMeshes[i];rt.K.AddToMesh(s.materialIndex,s.verticesStart,s.verticesCount,s.indexStart,s.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){const i=.001;if(!ot.CleanBoneMatrixWeights)return;let s=0;if(!(e.skeletonId>-1))return;{const i=t.getScene().getLastSkeletonById(e.skeletonId);if(!i)return;s=i.bones.length}const r=t.getVerticesData(O.R.MatricesIndicesKind),n=t.getVerticesData(O.R.MatricesIndicesExtraKind),a=e.matricesWeights,o=e.matricesWeightsExtra,l=e.numBoneInfluencer,h=a.length;for(let e=0;e<h;e+=4){let t=0,h=-1;for(let s=0;s<4;s++){const r=a[e+s];t+=r,r<i&&h<0&&(h=s)}if(o)for(let s=0;s<4;s++){const r=o[e+s];t+=r,r<i&&h<0&&(h=s+4)}if((h<0||h>l-1)&&(h=l-1),t>i){const i=1/t;for(let t=0;t<4;t++)a[e+t]*=i;if(o)for(let t=0;t<4;t++)o[e+t]*=i}else h>=4?(o[e+h-4]=1-t,n[e+h-4]=s):(a[e+h]=1-t,r[e+h]=s)}t.setVerticesData(O.R.MatricesIndicesKind,r),e.matricesWeightsExtra&&t.setVerticesData(O.R.MatricesIndicesExtraKind,n)}static Parse(e,t,i){const s=new ct(e.id,t,void 0,e.updatable);return s._loadedUniqueId=e.uniqueId,Je.Y&&Je.Y.AddTagsTo(s,e.tags),e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s._boundingInfo=new Z.j(I.Pq.FromArray(e.boundingBoxMinimum),I.Pq.FromArray(e.boundingBoxMaximum)),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(O.R.UVKind),e.hasUVs2&&s._delayInfo.push(O.R.UV2Kind),e.hasUVs3&&s._delayInfo.push(O.R.UV3Kind),e.hasUVs4&&s._delayInfo.push(O.R.UV4Kind),e.hasUVs5&&s._delayInfo.push(O.R.UV5Kind),e.hasUVs6&&s._delayInfo.push(O.R.UV6Kind),e.hasColors&&s._delayInfo.push(O.R.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(O.R.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(O.R.MatricesWeightsKind),s._delayLoadingFunction=at.ImportVertexData):at.ImportVertexData(e,s),t.pushGeometry(s,!0),s}}const ut=I.uq.Compose(I.Pq.One(),I.PT.FromEulerAngles(0,Math.PI,0),I.Pq.Zero());class dt extends B{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=!!(this._billboardMode&dt.BILLBOARDMODE_USE_POSITION),this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==dt.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t,!1),this._forward=new I.Pq(0,0,1),this._up=new I.Pq(0,1,0),this._right=new I.Pq(1,0,0),this._position=I.Pq.Zero(),this._rotation=I.Pq.Zero(),this._rotationQuaternion=null,this._scaling=I.Pq.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=dt.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=I.uq.Zero(),this._usePivotMatrix=!1,this._absolutePosition=I.Pq.Zero(),this._absoluteScaling=I.Pq.Zero(),this._absoluteRotationQuaternion=I.PT.Identity(),this._pivotMatrix=I.uq.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new C.cP,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return I.Pq.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return I.Pq.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return I.Pq.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=I.uq.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==dt.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=I.uq.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);s&&i&&i(this,s);for(const e of this.getChildTransformNodes(!0))e.instantiateHierarchy(s,t,i);return s}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||I.PT.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,s;if(void 0===e.x){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],s=arguments[2]}else t=e.x,i=e.y,s=e.z;if(this.parent){const e=I.AA.Matrix[0];this.parent.getWorldMatrix().invertToRef(e),I.Pq.TransformCoordinatesFromFloatsToRef(t,i,s,e,this.position)}else this.position.x=t,this.position.y=i,this.position.z=s;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=I.Pq.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=I.AA.Matrix[0];return this._localMatrix.invertToRef(e),I.Pq.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=I.Pq.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,s=0,r=0){const n=dt._LookAtVectorCache,a=0===r?this.position:this.getAbsolutePosition();if(e.subtractToRef(a,n),this.setDirection(n,t,i,s),1===r&&this.parent)if(this.rotationQuaternion){const e=I.AA.Matrix[0];this.rotationQuaternion.toRotationMatrix(e);const t=I.AA.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(t),t.invert(),e.multiplyToRef(t,e),this.rotationQuaternion.fromRotationMatrix(e)}else{const e=I.AA.Quaternion[0];I.PT.FromEulerVectorToRef(this.rotation,e);const t=I.AA.Matrix[0];e.toRotationMatrix(t);const i=I.AA.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(i),i.invert(),t.multiplyToRef(i,t),e.fromRotationMatrix(t),e.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=I.Pq.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return I.Pq.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,s=0){const r=-Math.atan2(e.z,e.x)+Math.PI/2,n=Math.sqrt(e.x*e.x+e.z*e.z),a=-Math.atan2(e.y,n);return this.rotationQuaternion?I.PT.RotationYawPitchRollToRef(r+t,a+i,s,this.rotationQuaternion):(this.rotation.x=a+i,this.rotation.y=r+t,this.rotation.z=s),this}setPivotPoint(e,t=0){0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(1==t){const t=I.AA.Matrix[0];i.invertToRef(t),e=I.Pq.TransformCoordinates(e,t)}return this.setPivotMatrix(I.uq.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=I.Pq.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=I.Pq.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),I.Pq.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const s=I.AA.Quaternion[0],r=I.AA.Vector3[0],n=I.AA.Vector3[1],a=I.AA.Matrix[1];I.uq.IdentityToRef(a);const o=I.AA.Matrix[0];this.computeWorldMatrix(!0);let l=this.rotationQuaternion;return l||(l=dt._TmpRotation,I.PT.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),I.uq.ComposeToRef(this.scaling,l,this.position,o),this.parent&&o.multiplyToRef(this.parent.computeWorldMatrix(!0),o),e&&(e.computeWorldMatrix(!0).invertToRef(a),o.multiplyToRef(a,o)),o.decompose(n,s,r,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(n),this.position.copyFrom(r),this.parent=e,i&&this.setPivotMatrix(I.uq.Identity()),this}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling!==e&&(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,this.parent=e?this._currentParentWhenAttachingToBone:null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){let s;if(e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0)),i&&0!==i){if(this.parent){const i=this.parent.getWorldMatrix(),s=I.AA.Matrix[0];i.invertToRef(s),e=I.Pq.TransformNormal(e,s),i.determinant()<0&&(t*=-1)}s=I.PT.RotationAxisToRef(e,t,dt._RotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else s=I.PT.RotationAxisToRef(e,t,dt._RotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=I.PT.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const s=I.AA.Vector3[0],r=I.AA.Vector3[1],n=I.AA.Vector3[2],a=I.AA.Quaternion[0],o=I.AA.Matrix[0],l=I.AA.Matrix[1],h=I.AA.Matrix[2],c=I.AA.Matrix[3];return e.subtractToRef(this.position,s),I.uq.TranslationToRef(s.x,s.y,s.z,o),I.uq.TranslationToRef(-s.x,-s.y,-s.z,l),I.uq.RotationAxisToRef(t,i,h),l.multiplyToRef(h,c),c.multiplyToRef(o,c),c.decompose(r,a,n),this.position.addInPlace(n),a.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const s=e.scale(t);if(i&&0!==i)this.setAbsolutePosition(this.getAbsolutePosition().add(s));else{const e=this.getPositionExpressedInLocalSpace().add(s);this.setPositionWithLocalVector(e)}return this}addRotation(e,t,i){let s;this.rotationQuaternion?s=this.rotationQuaternion:(s=I.AA.Quaternion[1],I.PT.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,s));const r=I.AA.Quaternion[0];return I.PT.RotationYawPitchRollToRef(t,e,i,r),s.multiplyInPlace(r),this.rotationQuaternion||s.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==dt.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const s=this._cache;s.pivotMatrixUpdated=!1,s.billboardMode=this.billboardMode,s.infiniteDistance=this.infiniteDistance,s.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const r=this._getEffectiveParent(),n=dt._TmpScaling;let a,o=this._position;if(this._infiniteDistance&&!this.parent&&t){const e=t.getWorldMatrix(),i=new I.Pq(e.m[12],e.m[13],e.m[14]);o=dt._TmpTranslation,o.copyFromFloats(this._position.x+i.x,this._position.y+i.y,this._position.z+i.z)}if(n.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant),this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,a=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(I.PT.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(a=dt._TmpRotation,I.PT.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,a)),this._usePivotMatrix){const e=I.AA.Matrix[1];I.uq.ScalingToRef(n.x,n.y,n.z,e);const t=I.AA.Matrix[0];a.toRotationMatrix(t),this._pivotMatrix.multiplyToRef(e,I.AA.Matrix[4]),I.AA.Matrix[4].multiplyToRef(t,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(o.x,o.y,o.z)}else I.uq.ComposeToRef(n,a,o,this._localMatrix);if(r&&r.getWorldMatrix){if(e&&r.computeWorldMatrix(e),s.useBillboardPath){if(this._transformToBoneReferal){const e=this.parent;e.getSkeleton().prepare(),e.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),I.AA.Matrix[7])}else I.AA.Matrix[7].copyFrom(r.getWorldMatrix());const e=I.AA.Vector3[5],t=I.AA.Vector3[6],i=I.AA.Quaternion[0];I.AA.Matrix[7].decompose(t,i,e),I.uq.ScalingToRef(t.x,t.y,t.z,I.AA.Matrix[7]),I.AA.Matrix[7].setTranslation(e),dt.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(i,e),this._localMatrix.setTranslation(e)),this._localMatrix.multiplyToRef(I.AA.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){const e=this.parent;e.getSkeleton().prepare(),this._localMatrix.multiplyToRef(e.getFinalMatrix(),I.AA.Matrix[6]),I.AA.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(r.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(s.useBillboardPath&&t&&this.billboardMode&&!s.useBillboardPosition){const e=I.AA.Vector3[0];if(this._worldMatrix.getTranslationToRef(e),I.AA.Matrix[1].copyFrom(t.getViewMatrix()),this._scene.useRightHandedSystem&&I.AA.Matrix[1].multiplyToRef(ut,I.AA.Matrix[1]),I.AA.Matrix[1].setTranslationFromFloats(0,0,0),I.AA.Matrix[1].invertToRef(I.AA.Matrix[0]),(this.billboardMode&dt.BILLBOARDMODE_ALL)!==dt.BILLBOARDMODE_ALL){I.AA.Matrix[0].decompose(void 0,I.AA.Quaternion[0],void 0);const e=I.AA.Vector3[1];I.AA.Quaternion[0].toEulerAnglesToRef(e),(this.billboardMode&dt.BILLBOARDMODE_X)!==dt.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&dt.BILLBOARDMODE_Y)!==dt.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&dt.BILLBOARDMODE_Z)!==dt.BILLBOARDMODE_Z&&(e.z=0),I.uq.RotationYawPitchRollToRef(e.y,e.x,e.z,I.AA.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(I.AA.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(I.AA.Vector3[0])}else if(s.useBillboardPath&&t&&s.useBillboardPosition){const e=I.AA.Vector3[0];this._worldMatrix.getTranslationToRef(e);const i=t.globalPosition;this._worldMatrix.invertToRef(I.AA.Matrix[1]);const s=I.AA.Vector3[1];I.Pq.TransformCoordinatesToRef(i,I.AA.Matrix[1],s),s.normalize();const r=-Math.atan2(s.z,s.x)+Math.PI/2,n=Math.sqrt(s.x*s.x+s.z*s.z),a=-Math.atan2(s.y,n);if(I.PT.RotationYawPitchRollToRef(r,a,0,I.AA.Quaternion[0]),(this.billboardMode&dt.BILLBOARDMODE_ALL)!==dt.BILLBOARDMODE_ALL){const e=I.AA.Vector3[1];I.AA.Quaternion[0].toEulerAnglesToRef(e),(this.billboardMode&dt.BILLBOARDMODE_X)!==dt.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&dt.BILLBOARDMODE_Y)!==dt.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&dt.BILLBOARDMODE_Z)!==dt.BILLBOARDMODE_Z&&(e.z=0),I.uq.RotationYawPitchRollToRef(e.y,e.x,e.z,I.AA.Matrix[0])}else I.uq.FromQuaternionToRef(I.AA.Quaternion[0],I.AA.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(I.AA.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(I.AA.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):r&&r._nonUniformScaling?this._updateNonUniformScalingState(r._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=I.uq.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const e=this.getChildren();for(let t=0;t<e.length;++t){const i=e[t];if(i){i.computeWorldMatrix();const e=I.AA.Matrix[0];i._localMatrix.multiplyToRef(this._localMatrix,e);const t=I.AA.Quaternion[0];e.decompose(i.scaling,t,i.position),i.rotationQuaternion?i.rotationQuaternion.copyFrom(t):t.toEulerAnglesToRef(i.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=I.PT.Identity()),this._worldMatrix=I.uq.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),I.Pq.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const s=N.p.Clone((()=>new dt(e,this.getScene())),this);if(s.name=e,s.id=e,t&&(s.parent=t),!i){const t=this.getDescendants(!0);for(let i=0;i<t.length;i++){const r=t[i];r.clone&&r.clone(e+"."+r.name,s)}}return s}serialize(e){const t=N.p.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),N.p.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t}static Parse(e,t,i){const s=N.p.Parse((()=>new dt(e.name,t)),e,t,i);if(e.localMatrix?s.setPreTransformMatrix(I.uq.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(I.uq.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s._waitingParsedUniqueId=e.uniqueId,void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=(0,V.n9)("BABYLON.Animation");r&&s.animations.push(r.Parse(i))}B.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),s}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,(e=>(!t||t(e))&&e instanceof dt)),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const e=this._parentContainer.transformNodes.indexOf(this);e>-1&&this._parentContainer.transformNodes.splice(e,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const e=this.getChildTransformNodes(!0);for(const t of e)t.parent=null,t.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let s=null,r=null;t&&(this.rotationQuaternion?(r=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(s=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const n=this.getHierarchyBoundingVectors(e,i),a=n.max.subtract(n.min),o=Math.max(a.x,a.y,a.z);if(0===o)return this;const l=1/o;return this.scaling.scaleInPlace(l),t&&(this.rotationQuaternion&&r?this.rotationQuaternion.copyFrom(r):this.rotation&&s&&this.rotation.copyFrom(s)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}dt.BILLBOARDMODE_NONE=0,dt.BILLBOARDMODE_X=1,dt.BILLBOARDMODE_Y=2,dt.BILLBOARDMODE_Z=4,dt.BILLBOARDMODE_ALL=7,dt.BILLBOARDMODE_USE_POSITION=128,dt.BillboardUseParentOrientation=!1,dt._TmpRotation=I.PT.Zero(),dt._TmpScaling=I.Pq.Zero(),dt._TmpTranslation=I.Pq.Zero(),dt._LookAtVectorCache=new I.Pq(0,0,0),dt._RotationAxisCache=new I.PT,(0,w.Cg)([(0,D.P_)("position")],dt.prototype,"_position",void 0),(0,w.Cg)([(0,D.P_)("rotation")],dt.prototype,"_rotation",void 0),(0,w.Cg)([(0,D.bR)("rotationQuaternion")],dt.prototype,"_rotationQuaternion",void 0),(0,w.Cg)([(0,D.P_)("scaling")],dt.prototype,"_scaling",void 0),(0,w.Cg)([(0,D.lK)("billboardMode")],dt.prototype,"_billboardMode",void 0),(0,w.Cg)([(0,D.lK)()],dt.prototype,"scalingDeterminant",void 0),(0,w.Cg)([(0,D.lK)("infiniteDistance")],dt.prototype,"_infiniteDistance",void 0),(0,w.Cg)([(0,D.lK)()],dt.prototype,"ignoreNonUniformScaling",void 0),(0,w.Cg)([(0,D.lK)()],dt.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);var _t=r(311);class pt{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new I.Pq(0,0,0),this._diffPositionForCollisions=new I.Pq(0,0,0),this._collisionResponse=!0}}var ft=r(5559),mt=r(8733);class gt{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=I.Pq.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class vt{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new gt,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new pt,this._enableDistantPicking=!1,this._rawBoundingInfo=null,this._sideOrientationHint=!1,this._inheritVisibility=!1}}class bt extends dt{static get BILLBOARDMODE_NONE(){return dt.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return dt.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return dt.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return dt.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return dt.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return dt.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return!!super._updateNonUniformScalingState(e)&&(this._markSubMeshesAsMiscDirty(),!0)}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(1===t&&1!==e||1!==t&&1===e)&&this._markSubMeshesAsDirty((e=>{e.markAsMiscDirty(),e.markAsPrePassDirty()}))}get inheritVisibility(){return this._internalAbstractMeshDataInfo._inheritVisibility}set inheritVisibility(e){this._internalAbstractMeshDataInfo._inheritVisibility=e}get isVisible(){if(!this._isVisible||!this.inheritVisibility||!this._parentNode)return this._isVisible;if(this._isVisible){let e=this._parentNode;for(;e;){const t=e.isVisible;if(void 0!==t)return t;e=e.parent}}return this._isVisible}set isVisible(e){this._isVisible=e}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._setMaterial(e)}_setMaterial(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){return this._internalAbstractMeshDataInfo._materialForRenderPass?.[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new vt,this._waitingMaterialId=null,this.cullingStrategy=bt.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new C.cP,this.onCollisionPositionChangeObservable=new C.cP,this.onMaterialChangedObservable=new C.cP,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this._isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=M.v9.Red(),this.outlineWidth=.02,this.overlayColor=M.v9.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new I.Pq(.5,1,.5),this.ellipsoidOffset=new I.Pq(0,0,0),this.edgesWidth=1,this.edgesColor=new M.ov(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new C.cP,this._onCollisionPositionChange=(e,t,i=null)=>{t.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>g.$.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),i&&this.onCollideObservable.notifyObservers(i),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},(t=this.getScene()).addMesh(this),this._resyncLightSources(),this._uniformBuffer=new k.D(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case 2:this.doNotSyncBoundingInfo=!0;case 1:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+("InstancedMesh"!==this.getClassName()?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==dt.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive)){if(!e)return this.actionManager;if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),null!==this._occlusionQuery&&(this._occlusionQuery=null),this.subMeshes){for(const e of this.subMeshes)e._rebuild();this.resetDrawCache()}}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let s=!1;if(-1===i){if(!t)return;this._lightSources.push(e)}else{if(t)return;s=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(s)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);-1!==i&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const s=t._drawWrappers[i];s&&s.defines&&s.defines.markAllAsDirty&&e(s.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty((t=>t.markAsLightDirty(e)))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty((e=>e.markAsAttributesDirty()))}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty((e=>e.markAsMiscDirty()))}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(this.subMeshes)for(const t of this.subMeshes)t.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,s){return this}updateVerticesData(e,t,i,s){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){return this.rawBoundingInfo??this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return null!==this._boundingInfo}buildBoundingInfo(e,t,i){return this._boundingInfo=new Z.j(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(O.R.MatricesIndicesKind)&&this.isVerticesDataPresent(O.R.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===dt.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const s=new I.uq;(this.rotationQuaternion?this.rotationQuaternion:I.PT.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(s);const r=I.Pq.Zero(),n=this.definedFacingForward?-1:1;return I.Pq.TransformCoordinatesFromFloatsToRef(e*n,t,i*n,s,r),r}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const s=this.definedFacingForward?1:-1;return new I.Pq(e*s,t,i*s)}_refreshBoundingInfo(e,t){if(e){const i=(0,lt.b)(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Z.j(i.minimum,i.maximum)}if(this.subMeshes)for(let t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo(e);this._updateBoundingInfo()}_refreshBoundingInfoDirect(e){if(this._boundingInfo?this._boundingInfo.reConstruct(e.minimum,e.maximum):this._boundingInfo=new Z.j(e.minimum,e.maximum),this.subMeshes)for(let e=0;e<this.subMeshes.length;e++)this.subMeshes[e].refreshBoundingInfo(null);this._updateBoundingInfo()}static _ApplySkeleton(e,t,i,s,r,n,a){!function(e,t,i,s,r,n,a){const o=I.AA.Vector3[0],l=I.AA.Matrix[0],h=I.AA.Matrix[1],c=t===O.R.NormalKind?I.Pq.TransformNormalFromFloatsToRef:I.Pq.TransformCoordinatesFromFloatsToRef;for(let t=0,u=0;t<e.length;t+=3,u+=4){let d,_;for(l.reset(),d=0;d<4;d++)_=r[u+d],_>0&&(I.uq.FromFloat32ArrayToRefScaled(i,Math.floor(16*s[u+d]),_,h),l.addToSelf(h));if(n&&a)for(d=0;d<4;d++)_=a[u+d],_>0&&(I.uq.FromFloat32ArrayToRefScaled(i,Math.floor(16*n[u+d]),_,h),l.addToSelf(h));c(e[t],e[t+1],e[t+2],l,o),o.toArray(e,t)}}(e,t,i,s,r,n,a)}_getData(e,t,i=O.R.PositionKind){const s=e.cache,r=e=>{if(s){const t=s._vertexData||(s._vertexData={});return t[e]||this.copyVerticesData(e,t),t[e]}return this.getVerticesData(e)};if(t||(t=r(i)),!t)return null;if(s?(s._outputData?s._outputData.set(t):s._outputData=new Float32Array(t),t=s._outputData):(e.applyMorph&&this.morphTargetManager||e.applySkeleton&&this.skeleton)&&(t=t.slice()),e.applyMorph&&this.morphTargetManager&&function(e,t,i){let s=null;switch(t){case O.R.PositionKind:s=e=>e.getPositions();break;case O.R.NormalKind:s=e=>e.getNormals();break;case O.R.TangentKind:s=e=>e.getTangents();break;case O.R.UVKind:s=e=>e.getUVs();break;default:return}for(let t=0;t<e.length;t++){let r=e[t];for(let n=0;n<i.numTargets;n++){const a=i.getTarget(n),o=a.influence;if(0!==o){const i=s(a);i&&(r+=(i[t]-e[t])*o)}}e[t]=r}}(t,i,this.morphTargetManager),e.applySkeleton&&this.skeleton){const e=r(O.R.MatricesIndicesKind),s=r(O.R.MatricesWeightsKind);if(s&&e){const n=this.numBoneInfluencers>4,a=n?r(O.R.MatricesIndicesExtraKind):null,o=n?r(O.R.MatricesWeightsExtraKind):null,l=this.skeleton.getTransformMatrices(this);bt._ApplySkeleton(t,i,l,e,s,a,o)}}if(!1!==e.updatePositionsArray&&i===O.R.PositionKind){const e=this._internalAbstractMeshDataInfo._positions||[],i=e.length;if(e.length=t.length/3,i<e.length)for(let t=i;t<e.length;t++)e[t]=new I.Pq;for(let i=0,s=0;i<e.length;i++,s+=3)e[i].copyFromFloats(t[s],t[s+1],t[s+2]);this._internalAbstractMeshDataInfo._positions=e}return t}getNormalsData(e=!1,t=!1){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},null,O.R.NormalKind)}getPositionData(e=!1,t=!1,i=null){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},i,O.R.PositionKind)}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Z.j(I.Pq.Zero(),I.Pq.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const s=this.subMeshes[i];(t>1||!s.IsGlobal)&&s.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){const s=this.getBoundingInfo(),r=e.getBoundingInfo();if(s.intersects(r,t))return!0;if(i)for(const i of this.getChildMeshes())if(i.intersectsMesh(e,t,!0))return!0;return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const t=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=t.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,t.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,i){if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const i=e.verticesStart,s=e.verticesStart+e.verticesCount;for(let r=i;r<s;r++)e._lastColliderWorldVertices.push(I.Pq.TransformCoordinates(this._positions[r],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),7===e.getMaterial()?.fillMode),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),s=i.length;for(let r=0;r<s;r++){const n=i.data[r];s>1&&!n._checkCollision(e)||this._collideForSubMesh(n,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=I.AA.Matrix[0],i=I.AA.Matrix[1];return I.uq.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,s=!1,r,n=!1){const a=new _t.G,o=this.getClassName(),l="InstancedLinesMesh"===o||"LinesMesh"===o||"GreasedLineMesh"===o?this.intersectionThreshold:0,h=this.getBoundingInfo();if(!this.subMeshes)return a;if(!(n||e.intersectsSphere(h.boundingSphere,l)&&e.intersectsBox(h.boundingBox,l)))return a;if(s)return a.hit=!n,a.pickedMesh=n?null:this,a.distance=n?0:I.Pq.Distance(e.origin,h.boundingSphere.center),a.subMeshId=0,a;if(!this._generatePointsArray())return a;let c=null;const u=this._scene.getIntersectingSubMeshCandidates(this,e),d=u.length;let _=!1;for(let e=0;e<d;e++){const t=u.data[e].getMaterial();if(t&&(7==t.fillMode||0==t.fillMode||1==t.fillMode||2==t.fillMode||4==t.fillMode)){_=!0;break}}if(!_)return a.hit=!0,a.pickedMesh=this,a.distance=I.Pq.Distance(e.origin,h.boundingSphere.center),a.subMeshId=-1,a;for(let s=0;s<d;s++){const r=u.data[s];if(d>1&&!n&&!r.canIntersects(e))continue;const a=r.intersects(e,this._positions,this.getIndices(),t,i);if(a&&(t||!c||a.distance<c.distance)&&(c=a,c.subMeshId=s,t))break}if(c){const t=r??this.getWorldMatrix(),i=I.AA.Vector3[0],s=I.AA.Vector3[1];I.Pq.TransformCoordinatesToRef(e.origin,t,i),e.direction.scaleToRef(c.distance,s);const n=I.Pq.TransformNormal(s,t).addInPlace(i);return a.hit=!0,a.distance=I.Pq.Distance(i,n),a.pickedPoint=n,a.pickedMesh=this,a.bu=c.bu||0,a.bv=c.bv||0,a.subMeshFaceId=c.faceId,a.faceId=c.faceId+u.data[c.subMeshId].indexStart/(-1!==this.getClassName().indexOf("LinesMesh")?2:3),a.subMeshId=c.subMeshId,a}return a}clone(e,t,i){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=[];return this}dispose(e,t=!1){let i;const s=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),s.freeActiveMeshes(),s.freeRenderingGroups(),s.renderingManager.maintainStateBetweenFrames&&s.renderingManager.restoreDispachedFlags(),void 0!==this.actionManager&&null!==this.actionManager&&(this.actionManager.disposeWhenUnowned&&!this._scene.meshes.some((e=>e!==this&&e.actionManager===this.actionManager))&&this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const e=this._intersectionsInProgress[i],t=e._intersectionsInProgress.indexOf(this);e._intersectionsInProgress.splice(t,1)}this._intersectionsInProgress.length=0,s.lights.forEach((e=>{let t=e.includedOnlyMeshes.indexOf(this);-1!==t&&e.includedOnlyMeshes.splice(t,1),t=e.excludedMeshes.indexOf(this),-1!==t&&e.excludedMeshes.splice(t,1);const i=e.getShadowGenerators();if(i){const e=i.values();for(let i=e.next();!0!==i.done;i=e.next()){const e=i.value.getShadowMap();e&&e.renderList&&(t=e.renderList.indexOf(this),-1!==t&&e.renderList.splice(t,1))}}})),"InstancedMesh"===this.getClassName()&&"InstancedLinesMesh"===this.getClassName()||this.releaseSubMeshes();const r=s.getEngine();if(null!==this._occlusionQuery&&(this.isOcclusionQueryInProgress=!1,r.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),r.wipeCaches(),s.removeMesh(this),this._parentContainer){const e=this._parentContainer.meshes.indexOf(this);e>-1&&this._parentContainer.meshes.splice(e,1),this._parentContainer=null}if(t&&this.material&&("MultiMaterial"===this.material.getClassName()?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<s.particleSystems.length;i++)s.particleSystems[i].emitter===this&&(s.particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=[]),e.facetPositions||(e.facetPositions=[]),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=I.Pq.Zero(),e.facetPositions[t]=I.Pq.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(O.R.PositionKind),i=this.getIndices(),s=this.getVerticesData(O.R.NormalKind),r=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let t=!1;for(let e=0;e<i.length;e++)if(i[e]>65535){t=!0;break}e.depthSortedIndices=t?new Uint32Array(i):new Uint16Array(i)}if(e.facetDepthSortFunction=function(e,t){return t.sqDistance-e.sqDistance},!e.facetDepthSortFrom){const t=this.getScene().activeCamera;e.facetDepthSortFrom=t?t.position:I.Pq.Zero()}e.depthSortedFacets=[];for(let t=0;t<e.facetNb;t++){const i={ind:3*t,sqDistance:0};e.depthSortedFacets.push(i)}e.invertedMatrix=I.uq.Identity(),e.facetDepthSortOrigin=I.Pq.Zero()}e.bbSize.x=r.maximum.x-r.minimum.x>ft.bH?r.maximum.x-r.minimum.x:ft.bH,e.bbSize.y=r.maximum.y-r.minimum.y>ft.bH?r.maximum.y-r.minimum.y:ft.bH,e.bbSize.z=r.maximum.z-r.minimum.z>ft.bH?r.maximum.z-r.minimum.z:ft.bH;let n=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(n=n>e.bbSize.z?n:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/n),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/n),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/n),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=r,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),I.Pq.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,s&&at.ComputeNormals(t,i,s,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const t=e.depthSortedIndices.length/3|0;for(let s=0;s<t;s++){const t=e.depthSortedFacets[s].ind;e.depthSortedIndices[3*s]=i[t],e.depthSortedIndices[3*s+1]=i[t+1],e.depthSortedIndices[3*s+2]=i[t+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=I.Pq.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],s=this.getWorldMatrix();return I.Pq.TransformCoordinatesToRef(i,s,t),this}getFacetNormal(e){const t=I.Pq.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return I.Pq.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const s=this.getBoundingInfo(),r=this._internalAbstractMeshDataInfo._facetData,n=Math.floor((e-s.minimum.x*r.partitioningBBoxRatio)*r.subDiv.X*r.partitioningBBoxRatio/r.bbSize.x),a=Math.floor((t-s.minimum.y*r.partitioningBBoxRatio)*r.subDiv.Y*r.partitioningBBoxRatio/r.bbSize.y),o=Math.floor((i-s.minimum.z*r.partitioningBBoxRatio)*r.subDiv.Z*r.partitioningBBoxRatio/r.bbSize.z);return n<0||n>r.subDiv.max||a<0||a>r.subDiv.max||o<0||o>r.subDiv.max?null:r.facetPartitioning[n+r.subDiv.max*a+r.subDiv.max*r.subDiv.max*o]}getClosestFacetAtCoordinates(e,t,i,s,r=!1,n=!0){const a=this.getWorldMatrix(),o=I.AA.Matrix[5];a.invertToRef(o);const l=I.AA.Vector3[8];I.Pq.TransformCoordinatesFromFloatsToRef(e,t,i,o,l);const h=this.getClosestFacetAtLocalCoordinates(l.x,l.y,l.z,s,r,n);return s&&I.Pq.TransformCoordinatesFromFloatsToRef(s.x,s.y,s.z,a,s),h}getClosestFacetAtLocalCoordinates(e,t,i,s,r=!1,n=!0){let a=null,o=0,l=0,h=0,c=0,u=0,d=0,_=0,p=0;const f=this.getFacetLocalPositions(),m=this.getFacetLocalNormals(),g=this.getFacetsAtLocalCoordinates(e,t,i);if(!g)return null;let v,b,x,S=Number.MAX_VALUE,T=S;for(let y=0;y<g.length;y++)v=g[y],b=m[v],x=f[v],c=(e-x.x)*b.x+(t-x.y)*b.y+(i-x.z)*b.z,(!r||r&&n&&c>=0||r&&!n&&c<=0)&&(c=b.x*x.x+b.y*x.y+b.z*x.z,u=-(b.x*e+b.y*t+b.z*i-c)/(b.x*b.x+b.y*b.y+b.z*b.z),d=e+b.x*u,_=t+b.y*u,p=i+b.z*u,o=d-e,l=_-t,h=p-i,T=o*o+l*l+h*h,T<S&&(S=T,a=v,s&&(s.x=d,s.y=_,s.z=p)));return a}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){const t=this.getVerticesData(O.R.PositionKind),i=this.getIndices();let s;return s=this.isVerticesDataPresent(O.R.NormalKind)?this.getVerticesData(O.R.NormalKind):[],at.ComputeNormals(t,i,s,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(O.R.NormalKind,s,e),this}alignWithNormal(e,t){t||(t=mt._0.Y);const i=I.AA.Vector3[0],s=I.AA.Vector3[1];return I.Pq.CrossToRef(t,e,s),I.Pq.CrossToRef(e,s,i),this.rotationQuaternion?I.PT.RotationQuaternionFromAxisToRef(i,e,s,this.rotationQuaternion):I.Pq.RotationFromAxisToRef(i,e,s,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw(0,F.n)("EdgesRenderer")}enableEdgesRendering(e,t,i){throw(0,F.n)("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter((e=>e.emitter===this))}}bt.OCCLUSION_TYPE_NONE=0,bt.OCCLUSION_TYPE_OPTIMISTIC=1,bt.OCCLUSION_TYPE_STRICT=2,bt.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,bt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,bt.CULLINGSTRATEGY_STANDARD=0,bt.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,bt.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,bt.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,(0,w.Cg)([D.Cx.filter(((...[e,t,i,s,r])=>!(Array.isArray(e)||Array.isArray(t)||Array.isArray(i)||Array.isArray(s)||Array.isArray(r))))],bt,"_ApplySkeleton",null),(0,V.Y5)("BABYLON.AbstractMesh",bt);class xt extends Te.i{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);return this._markAllSubMeshesAsTexturesDirty(),s};const i=e.splice;e.splice=(t,s)=>{const r=i.apply(e,[t,s]);return this._markAllSubMeshesAsTexturesDirty(),r}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map((e=>e?e.getActiveTextures():[])))}hasTexture(e){if(super.hasTexture(e))return!0;for(let t=0;t<this.subMaterials.length;t++)if(this.subMaterials[t]?.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let s=0;s<this.subMaterials.length;s++){const r=this.subMaterials[s];if(r){if(r._storeEffectOnSubMeshes){if(!r.isReadyForSubMesh(e,t,i))return!1;continue}if(!r.isReady(e))return!1}}return!0}clone(e,t){const i=new xt(e,this.getScene());for(let s=0;s<this.subMaterials.length;s++){let r=null;const n=this.subMaterials[s];r=t&&n?n.clone(e+"-"+n.name):this.subMaterials[s],i.subMaterials.push(r)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,Je.Y&&(e.tags=Je.Y.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const s=this.getScene();if(!s)return;if(i)for(let i=0;i<this.subMaterials.length;i++){const s=this.subMaterials[i];s&&s.dispose(e,t)}const r=s.multiMaterials.indexOf(this);r>=0&&s.multiMaterials.splice(r,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new xt(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,Je.Y&&Je.Y.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach((e=>i.subMaterials.push(t.getLastMaterialById(e)))),i}}(0,V.Y5)("BABYLON.MultiMaterial",xt);class St{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class Tt{}class yt{constructor(){this.visibleInstances={},this.batchCache=new Ct,this.batchCacheReplacementModeInFrozenMode=new Ct,this.instancesBufferSize=2048}}class Ct{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}}class Pt{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class Et{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}class At extends bt{static _GetDefaultSideOrientation(e){return e||At.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(O.R.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(O.R.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new C.cP),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new C.cP),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new C.cP),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new C.cP),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new C.cP),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get sideOrientation(){return this._internalMeshDataInfo._sideOrientation}set sideOrientation(e){this._internalMeshDataInfo._sideOrientation=e,this._internalAbstractMeshDataInfo._sideOrientationHint=this._scene.useRightHandedSystem&&1===e||!this._scene.useRightHandedSystem&&0===e}get overrideMaterialSideOrientation(){return this.sideOrientation}set overrideMaterialSideOrientation(e){this.sideOrientation=e,this.material&&(this.material.sideOrientation=null)}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){e&&(this.material&&null===this.material.sideOrientation||this._internalAbstractMeshDataInfo._sideOrientationHint)&&(e.sideOrientation=null),this._setMaterial(e)}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}_copySource(e,t,i=!0){const s=this.getScene();if(e._geometry&&e._geometry.applyToMesh(this),Ze.r.DeepCopy(e,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=e,s.useClonedMeshMap&&(e._internalMeshDataInfo.meshMap||(e._internalMeshDataInfo.meshMap={}),e._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=e._originalBuilderSideOrientation,this._creationDataStorage=e._creationDataStorage,e._ranges){const t=e._ranges;for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&t[e]&&this.createAnimationRange(e,t[e].from,t[e].to)}if(e.metadata&&e.metadata.clone?this.metadata=e.metadata.clone():this.metadata=e.metadata,this._internalMetadata=e._internalMetadata,Je.Y&&Je.Y.HasTags(e)&&Je.Y.AddTagsTo(this,Je.Y.GetTags(e,!0)),this.setEnabled(e.isEnabled(!1)),this.parent=e.parent,this.setPivotMatrix(e.getPivotMatrix(),this._postMultiplyPivotMatrix),this.id=this.name+"."+e.id,this.material=e.material,!t){const t=e.getDescendants(!0);for(let e=0;e<t.length;e++){const i=t[e];i.clone&&i.clone(this.name+"."+i.name,this)}}if(e.morphTargetManager&&(this.morphTargetManager=e.morphTargetManager),s.getPhysicsEngine){const t=s.getPhysicsEngine();if(i&&t)if(1===t.getPluginVersion()){const i=t.getImpostorForPhysicsObject(e);i&&(this.physicsImpostor=i.clone(this))}else 2===t.getPluginVersion()&&e.physicsBody&&e.physicsBody.clone(this)}for(let t=0;t<s.particleSystems.length;t++){const i=s.particleSystems[t];i.emitter===e&&i.clone(i.name,this)}this.skeleton=e.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}constructor(e,t=null,i=null,s=null,r,n=!0){super(e,t),this._internalMeshDataInfo=new Et,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new yt,this._thinInstanceDataStorage=new Pt,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=At.DEFAULTSIDE,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._scene.useRightHandedSystem?this.sideOrientation=0:this.sideOrientation=1,this._onBeforeDraw=(e,t,i)=>{e&&i&&(this._uniformBuffer?this.transferToEffect(t):i.bindOnlyWorldMatrix(t))},s&&this._copySource(s,r,n),null!==i&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=e=>{e.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add((()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))})))},this.onMeshReadyObservable=new C.cP(this._internalMeshDataInfo._onMeshReadyObserverAdded),s&&s.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const s=0===this.getTotalVertices()||t&&t.doNotInstantiate&&(!0===t.doNotInstantiate||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));s.parent=e||this.parent,s.position=this.position.clone(),s.scaling=this.scaling.clone(),this.rotationQuaternion?s.rotationQuaternion=this.rotationQuaternion.clone():s.rotation=this.rotation.clone(),i&&i(this,s);for(const e of this.getChildTransformNodes(!0))"InstancedMesh"===e.getClassName()&&"Mesh"===s.getClassName()&&e.sourceMesh===this?e.instantiateHierarchy(s,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:s},i):e.instantiateHierarchy(s,t,i);return s}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const e=this.getIndices(),i=this.getVerticesData(O.R.PositionKind);i&&e&&(t+=", flat shading: "+(i.length/3===e.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort(((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0))}addLODLevel(e,t){if(t&&t._masterMesh)return l.V.Warn("You cannot use a mesh as LOD level twice"),this;const i=new St(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const s=t._LODLevels[i];if(s.distanceOrScreenCoverage===e)return s.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||0===i._LODLevels.length)return this;const s=t||this.getBoundingInfo().boundingSphere,r=e.mode===se.ORTHOGRAPHIC_CAMERA?e.minZ:s.centerWorld.subtract(e.globalPosition).length();let n=r,a=1;if(i._useLODScreenCoverage){const t=e.screenArea;let i=s.radiusWorld*e.minZ/r;i=i*i*Math.PI,n=i/t,a=-1}if(a*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>a*n)return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this;for(let e=0;e<i._LODLevels.length;e++){const t=i._LODLevels[e];if(a*t.distanceOrScreenCoverage<a*n){if(t.mesh){if(4===t.mesh.delayLoadState)return t.mesh._checkDelayState(),this;if(2===t.mesh.delayLoadState)return this;t.mesh._preActivate(),t.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,t.mesh),t.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return null===this._geometry||void 0===this._geometry?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,s){if(!this._geometry)return null;let r=s?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e]?.getFloatData(this.instances.length+1,i||t&&1!==this._geometry.meshes.length);return r||(r=this._geometry.getVerticesData(e,t,i)),r}copyVerticesData(e,t){this._geometry&&this._geometry.copyVerticesData(e,t)}getVertexBuffer(e,t){return this._geometry?(t?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e])??this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){return this._geometry?!t&&void 0!==this._userInstancedBuffersStorage?.vertexBuffers[e]||this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}isVertexBufferUpdatable(e,t){if(!this._geometry)return!!this._delayInfo&&-1!==this._delayInfo.indexOf(e);if(!t){const t=this._userInstancedBuffersStorage?.vertexBuffers[e];if(t)return t.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const e=[];return this._delayInfo&&this._delayInfo.forEach((function(t){e.push(t)})),e}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const e in this._userInstancedBuffersStorage.vertexBuffers)-1===t.indexOf(e)&&t.push(e);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return null!==this._masterMesh&&void 0!==this._masterMesh}isReady(e=!1,t=!1){if(2===this.delayLoadState)return!1;if(!super.isReady(e))return!1;if(!this.subMeshes||0===this.subMeshes.length)return!0;if(!e)return!0;const i=this.getEngine(),s=this.getScene(),r=t||i.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const n=this.material||s.defaultMaterial;if(n)if(n._storeEffectOnSubMeshes)for(const e of this.subMeshes){const t=e.getMaterial();if(t)if(t._storeEffectOnSubMeshes){if(!t.isReadyForSubMesh(this,e,r))return!1}else if(!t.isReady(this,r))return!1}else if(!n.isReady(this,r))return!1;const a=i.currentRenderPassId;for(const e of this.lightSources){const t=e.getShadowGenerators();if(!t)continue;const s=t.values();for(let e=s.next();!0!==e.done;e=s.next()){const t=e.value;if(t&&(!t.getShadowMap()?.renderList||t.getShadowMap()?.renderList&&-1!==t.getShadowMap()?.renderList?.indexOf(this))){const e=t.getShadowMap().renderPassIds??[i.currentRenderPassId];for(let s=0;s<e.length;++s){i.currentRenderPassId=e[s];for(const e of this.subMeshes)if(!t.isReady(e,r,e.getMaterial()?.needAlphaBlendingForMesh(this)??!1))return i.currentRenderPassId=a,!1}i.currentRenderPassId=a}}}for(const e of this._internalMeshDataInfo._LODLevels)if(e.mesh&&!e.mesh.isReady(r))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t||(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null),this}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(void 0!==this._instanceDataStorage.previousRenderId&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;i="object"==typeof e?e:{applySkeleton:e,applyMorph:t};const s=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getData(i,null,O.R.PositionKind),s),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const s=i.length;let r=!1;if(e)r=!0;else for(const e of this.subMeshes){if(e.indexStart+e.indexCount>s){r=!0;break}if(e.verticesStart+e.verticesCount>t){r=!0;break}}if(!r)return this.subMeshes[0]}return this.releaseSubMeshes(),new rt.K(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,s=0;for(;i%3!=0;)i++;this.releaseSubMeshes();for(let r=0;r<e&&!(s>=t);r++)rt.K.CreateFromIndices(0,s,r===e-1?t-s:i,this,void 0,!1),s+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,s){if(this._geometry)this._geometry.setVerticesData(e,t,i,s);else{const s=new at;s.set(t,e);const r=this.getScene();new ct(ct.RandomId(),r,s,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);i&&i.isUpdatable()!==t&&this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=ct.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,s){return this._geometry?(s?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(O.R.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(O.R.PositionKind,i,!1,!1),t){const e=this.getIndices(),t=this.getVerticesData(O.R.NormalKind);if(!t)return this;at.ComputeNormals(i,e,t),this.updateVerticesData(O.R.NormalKind,t,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(1===this._geometry.meshes.length)return this;const e=this._geometry,t=this._geometry.copy(ct.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,i){let s=this._geometry;s||(s=new ct(ct.RandomId(),this.getScene(),void 0,void 0,this)),s.setIndexBuffer(e,t,i)}setIndices(e,t=null,i=!1,s=!1){if(this._geometry)this._geometry.setIndices(e,t,i,s);else{const t=new at;t.indices=e;const s=this.getScene();new ct(ct.RandomId(),s,t,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,s=!0){if(!this._geometry)return this;const r=this.getScene().getEngine();let n;if(this._unIndexed)n=this._getRenderingFillMode(i)===Te.i.WireFrameFillMode?e._getLinesIndexBuffer(this.getIndices(),r):null;else switch(this._getRenderingFillMode(i)){case Te.i.PointFillMode:n=null;break;case Te.i.WireFrameFillMode:n=e._getLinesIndexBuffer(this.getIndices(),r);break;default:case Te.i.TriangleFillMode:n=this._geometry.getIndexBuffer()}return this._bindDirect(t,n,s)}_bindDirect(e,t,i=!0){return this._geometry?(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(e),i&&this._userInstancedBuffersStorage&&!this.hasThinInstances?this._geometry._bind(e,t,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(e,t),this):this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const s=this.getScene().getEngine();return this._unIndexed&&t!==Te.i.WireFrameFillMode||t==Te.i.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==Te.i.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),s=i._isInIntermediateRendering(),r=s?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,n=this._instanceDataStorage.batchCache;if(n.mustReturn=!1,n.renderSelf[e]=t||!r&&this.isEnabled()&&this.isVisible,n.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const t=this._instanceDataStorage.visibleInstances,r=i.getRenderId(),a=s?t.intermediateDefaultRenderId:t.defaultRenderId;n.visibleInstances[e]=t[r],!n.visibleInstances[e]&&a&&(n.visibleInstances[e]=t[a])}return n.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&null!==n.visibleInstances[e]&&void 0!==n.visibleInstances[e],this._instanceDataStorage.previousBatch=n,n}_renderWithInstances(e,t,i,s,r){const n=i.visibleInstances[e._id],a=n?n.length:0,o=this._instanceDataStorage,l=o.instancesBufferSize;let h=o.instancesBuffer,c=o.instancesPreviousBuffer;const u=16*(a+1)*4;for(;o.instancesBufferSize<u;)o.instancesBufferSize*=2;o.instancesData&&l==o.instancesBufferSize||(o.instancesData=new Float32Array(o.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!o.instancesPreviousData||l!=o.instancesBufferSize)&&(o.instancesPreviousData=new Float32Array(o.instancesBufferSize/4));let d=0,_=0;const p=i.renderSelf[e._id],f=!h||l!==o.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!o.instancesPreviousBuffer;if(this._instanceDataStorage.manualUpdate||o.isFrozen&&!f)_=(p?1:0)+a;else{const t=this.getWorldMatrix();if(p&&(this._scene.needsPreviousWorldMatrices&&(o.masterMeshPreviousWorldMatrix?(o.masterMeshPreviousWorldMatrix.copyToArray(o.instancesPreviousData,d),o.masterMeshPreviousWorldMatrix.copyFrom(t)):(o.masterMeshPreviousWorldMatrix=t.clone(),o.masterMeshPreviousWorldMatrix.copyToArray(o.instancesPreviousData,d))),t.copyToArray(o.instancesData,d),d+=16,_++),n){if(At.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&e.getMaterial()?.needAlphaBlendingForMesh(e.getRenderingMesh())){const e=this._scene.activeCamera.globalPosition;for(let t=0;t<n.length;t++){const i=n[t];i._distanceToCamera=I.Pq.Distance(i.getBoundingInfo().boundingSphere.centerWorld,e)}n.sort(((e,t)=>e._distanceToCamera>t._distanceToCamera?-1:e._distanceToCamera<t._distanceToCamera?1:0))}for(let e=0;e<n.length;e++){const t=n[e],i=t.getWorldMatrix();i.copyToArray(o.instancesData,d),this._scene.needsPreviousWorldMatrices&&(t._previousWorldMatrix?(t._previousWorldMatrix.copyToArray(o.instancesPreviousData,d),t._previousWorldMatrix.copyFrom(i)):(t._previousWorldMatrix=i.clone(),t._previousWorldMatrix.copyToArray(o.instancesPreviousData,d))),d+=16,_++}}}return f?(h&&h.dispose(),c&&c.dispose(),h=new O.h(r,o.instancesData,!0,16,!1,!0),o.instancesBuffer=h,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=h.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=h.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=h.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=h.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(c=new O.h(r,o.instancesPreviousData,!0,16,!1,!0),o.instancesPreviousBuffer=c,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=c.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=c.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=c.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=c.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||(h.updateDirectly(o.instancesData,0,_),!this._scene.needsPreviousWorldMatrices||this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.previousManualUpdate||c.updateDirectly(o.instancesPreviousData,0,_)),this._processInstancedBuffers(n,p),this.getScene()._activeIndices.addCount(e.indexCount*_,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,s,t),this._draw(e,t,_),!this._scene.needsPreviousWorldMatrices||f||!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||this._instanceDataStorage.previousManualUpdate||c.updateDirectly(o.instancesData,0,_),r.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,s){const r=this._thinInstanceDataStorage?.instancesCount??0;this.getScene()._activeIndices.addCount(e.indexCount*r,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,r),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,r):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),s.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,s,r,n,a,o){const l=this.getScene(),h=l.getEngine();if(s=this._getRenderingFillMode(s),n&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,s,i,h),this;if(n)this._renderWithInstances(t,s,r,i,h);else{h._currentDrawContext&&(h._currentDrawContext.useInstancing=!1);let i=0;r.renderSelf[t._id]&&(a&&a(!1,e.getWorldMatrix(),o),i++,this._draw(t,s,this._instanceDataStorage.overridenInstanceCount));const n=r.visibleInstances[t._id];if(n){const e=n.length;i+=e;for(let i=0;i<e;i++){const e=n[i].getWorldMatrix();a&&a(!0,e,o),this._draw(t,s)}}l._activeIndices.addCount(t.indexCount*i,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}renderWithRenderPassId(e,t,i,s,r=!0){const n=this._scene.getEngine(),a=n.currentRenderPassId;if(void 0!==e&&(n.currentRenderPassId=e),s)(!r||r&&s.isInFrustum(this._scene._frustumPlanes))&&this.render(s,!!t,i);else for(let e=0;e<this.subMeshes.length;e++){const s=this.subMeshes[e];(!r||r&&s.isInFrustum(this._scene._frustumPlanes))&&this.render(s,!!t,i)}return void 0!==e&&(n.currentRenderPassId=a),this}directRender(){if(!this.subMeshes)return this;for(const e of this.subMeshes)this.render(e,!1);return this}render(e,t,i){const s=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;const r=s.activeCameras?.length??0;if((r>1&&s.activeCamera===s.activeCameras[0]||r<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const n=this._getInstancesRenderList(e._id,!!i);if(n.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const a=s.getEngine();let o=0,l=null;this.ignoreCameraMaxZ&&s.activeCamera&&!s._isInIntermediateRendering()&&(o=s.activeCamera.maxZ,l=s.activeCamera,s.activeCamera.maxZ=0,s.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const h=e.getRenderingMesh(),c=n.hardwareInstancedRendering[e._id]||h.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,u=this._instanceDataStorage,d=e.getMaterial();if(!d)return l&&(l.maxZ=o,s.updateTransformMatrix(!0)),this;if(u.isFrozen&&this._internalMeshDataInfo._effectiveMaterial&&this._internalMeshDataInfo._effectiveMaterial===d){if(d._storeEffectOnSubMeshes&&!e._drawWrapper?._wasPreviouslyReady||!d._storeEffectOnSubMeshes&&!d._getDrawWrapper()._wasPreviouslyReady)return l&&(l.maxZ=o,s.updateTransformMatrix(!0)),this}else{if(d._storeEffectOnSubMeshes){if(!d.isReadyForSubMesh(this,e,c))return l&&(l.maxZ=o,s.updateTransformMatrix(!0)),this}else if(!d.isReady(this,c))return l&&(l.maxZ=o,s.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=d}let _;t&&a.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode),_=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const p=_?.effect??null;for(const t of s._beforeRenderingMeshStage)t.action(this,e,n,p);if(!_||!p)return l&&(l.maxZ=o,s.updateTransformMatrix(!0)),this;const f=i||this;let m;if(u.isFrozen||!this._internalMeshDataInfo._effectiveMaterial.backFaceCulling&&null===this._internalMeshDataInfo._effectiveMaterial.sideOrientation&&!this._internalMeshDataInfo._effectiveMaterial.twoSidedLighting)m=u.sideOrientation;else{const e=f._getWorldMatrixDeterminant();m=this._internalMeshDataInfo._effectiveMaterial._getEffectiveOrientation(this),e<0&&(m=m===Te.i.ClockWiseSideOrientation?Te.i.CounterClockWiseSideOrientation:Te.i.ClockWiseSideOrientation),u.sideOrientation=m}const g=this._internalMeshDataInfo._effectiveMaterial._preBind(_,m);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&a.setDepthWrite(!0);const v=this._internalMeshDataInfo._effectiveMaterial,b=v.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),c||this._bind(e,p,b,!1);const x=f.getWorldMatrix();v._storeEffectOnSubMeshes?v.bindForSubMesh(x,this,e):v.bind(x,this),!v.backFaceCulling&&v.separateCullingPass&&(a.setState(!0,v.zOffset,!1,!g,v.cullBackFaces,v.stencil,v.zOffsetUnits),this._processRendering(this,e,p,b,n,c,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),a.setState(!0,v.zOffset,!1,g,v.cullBackFaces,v.stencil,v.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,p,b,n,c,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const t of s._afterRenderingMeshStage)t.action(this,e,n,p);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),l&&(l.maxZ=o,s.updateTransformMatrix(!0)),2!==s.performancePriority||u.isFrozen||this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(O.R.MatricesWeightsKind)&&(this.isVerticesDataPresent(O.R.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(O.R.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const t=e[i]+e[i+1]+e[i+2]+e[i+3];if(0===t)e[i]=1;else{const s=1/t;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s}}this.setVerticesData(O.R.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(O.R.MatricesWeightsExtraKind),t=this.getVerticesData(O.R.MatricesWeightsKind),i=t.length;for(let s=0;s<i;s+=4){let i=t[s]+t[s+1]+t[s+2]+t[s+3];if(i+=e[s]+e[s+1]+e[s+2]+e[s+3],0===i)t[s]=1;else{const r=1/i;t[s]*=r,t[s+1]*=r,t[s+2]*=r,t[s+3]*=r,e[s]*=r,e[s+1]*=r,e[s+2]*=r,e[s+3]*=r}}this.setVerticesData(O.R.MatricesWeightsKind,t),this.setVerticesData(O.R.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(O.R.MatricesWeightsExtraKind),t=this.getVerticesData(O.R.MatricesWeightsKind);if(null===t||null==this.skeleton)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let s=0,r=0,n=0,a=0;const o=null===e?4:8,l=[];for(let e=0;e<=o;e++)l[e]=0;for(let h=0;h<i;h+=4){let i=t[h],c=i,u=0===c?0:1;for(let r=1;r<o;r++){const n=r<4?t[h+r]:e[h+r-4];n>i&&s++,0!==n&&u++,c+=n,i=n}if(l[u]++,u>n&&(n=u),0===c)r++;else{const i=1/c;let s=0;for(let r=0;r<o;r++)s+=r<4?Math.abs(t[h+r]-t[h+r]*i):Math.abs(e[h+r-4]-e[h+r-4]*i);s>.001&&a++}}const h=this.skeleton.bones.length,c=this.getVerticesData(O.R.MatricesIndicesKind),u=this.getVerticesData(O.R.MatricesIndicesExtraKind);let d=0;for(let e=0;e<i;e+=4)for(let t=0;t<o;t++){const i=t<4?c[e+t]:u[e+t-4];(i>=h||i<0)&&d++}return{skinned:!0,valid:0===r&&0===a&&0===d,report:"Number of Weights = "+i/4+"\nMaximum influences = "+n+"\nMissing Weights = "+r+"\nNot Sorted = "+s+"\nNot Normalized = "+a+"\nWeightCounts = ["+l+"]\nNumber of bones = "+h+"\nBad Bone Indices = "+d}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):4===this.delayLoadState&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return ee.S0.LoadFile(this.delayLoadingFile,(t=>{t instanceof ArrayBuffer?this._delayLoadingFunction(t,this):this._delayLoadingFunction(JSON.parse(t),this),this.instances.forEach((e=>{e.refreshBoundingInfo(),e._syncSubMeshes()})),this.delayLoadState=1,e.removePendingData(this)}),(()=>{}),e.offlineProvider,t),this}isInFrustum(e){return 2!==this.delayLoadState&&!!super.isInFrustum(e)&&(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const s=this.getScene().multiMaterials;for(i=s.length-1;i>-1;i--)if(s[i].id===e)return this.material=s[i],this;return this}getAnimatables(){const e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(O.R.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(O.R.PositionKind);const s=I.Pq.Zero();let r;for(r=0;r<i.length;r+=3)I.Pq.TransformCoordinatesFromFloatsToRef(i[r],i[r+1],i[r+2],e,s).toArray(i,r);if(this.setVerticesData(O.R.PositionKind,i,this.getVertexBuffer(O.R.PositionKind).isUpdatable()),this.isVerticesDataPresent(O.R.NormalKind)){for(i=this.getVerticesData(O.R.NormalKind),r=0;r<i.length;r+=3)I.Pq.TransformNormalFromFloatsToRef(i[r],i[r+1],i[r+2],e,s).normalize().toArray(i,r);this.setVerticesData(O.R.NormalKind,i,this.getVertexBuffer(O.R.NormalKind).isUpdatable())}if(this.isVerticesDataPresent(O.R.TangentKind)){for(i=this.getVerticesData(O.R.TangentKind),r=0;r<i.length;r+=4)I.Pq.TransformNormalFromFloatsToRef(i[r],i[r+1],i[r+2],e,s).normalize().toArray(i,r);this.setVerticesData(O.R.TangentKind,i,this.getVertexBuffer(O.R.TangentKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions||this._geometry&&this._geometry._positions||null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return!!this._geometry&&this._geometry._generatePointsArray()}clone(e="",t=null,i,s=!0){return new At(e,this.getScene(),t,this,i,s)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const e in i.meshMap){const t=i.meshMap[e];t&&(t._internalMeshDataInfo._source=null,i.meshMap[e]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const e=this.getScene().meshes;for(const t of e){const e=t;e._internalMeshDataInfo&&e._internalMeshDataInfo._source&&e._internalMeshDataInfo._source===this&&(e._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,s,r,n,a=!1,o){const l=this.getScene();return ee.S0.LoadImage(e,(e=>{const o=e.width,l=e.height,h=this.getEngine().createCanvas(o,l).getContext("2d");h.drawImage(e,0,0);const c=h.getImageData(0,0,o,l).data;this.applyDisplacementMapFromBuffer(c,o,l,t,i,r,n,a),s&&s(this)}),o||(()=>{}),l.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,s,r,n,a,o=!1){if(!this.isVerticesDataPresent(O.R.PositionKind)||!this.isVerticesDataPresent(O.R.NormalKind)||!this.isVerticesDataPresent(O.R.UVKind))return l.V.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const h=this.getVerticesData(O.R.PositionKind,!0,!0),c=this.getVerticesData(O.R.NormalKind),u=this.getVerticesData(O.R.UVKind);let d=I.Pq.Zero();const _=I.Pq.Zero(),p=I.I9.Zero();n=n||I.I9.Zero(),a=a||new I.I9(1,1);for(let o=0;o<h.length;o+=3){I.Pq.FromArrayToRef(h,o,d),I.Pq.FromArrayToRef(c,o,_),I.I9.FromArrayToRef(u,o/3*2,p);const l=4*((Math.abs(p.x*a.x+n.x%1)*(t-1)%t|0)+(Math.abs(p.y*a.y+n.y%1)*(i-1)%i|0)*t),f=e[l]/255*.3+e[l+1]/255*.59+e[l+2]/255*.11;_.normalize(),_.scaleInPlace(s+(r-s)*f),d=d.add(_),d.toArray(h,o)}return at.ComputeNormals(h,this.getIndices(),c),o?(this.setVerticesData(O.R.PositionKind,h),this.setVerticesData(O.R.NormalKind,c),this.setVerticesData(O.R.UVKind,u)):(this.updateVerticesData(O.R.PositionKind,h),this.updateVerticesData(O.R.NormalKind,c)),this}_getFlattenedNormals(e,t){const i=new Float32Array(3*e.length);let s=0;const r=this.sideOrientation===(this._scene.useRightHandedSystem?1:0);for(let n=0;n<e.length;n+=3){const a=I.Pq.FromArray(t,3*e[n]),o=I.Pq.FromArray(t,3*e[n+1]),l=I.Pq.FromArray(t,3*e[n+2]),h=a.subtract(o),c=l.subtract(o),u=I.Pq.Normalize(I.Pq.Cross(h,c));r&&u.scaleInPlace(-1);for(let e=0;e<3;e++)i[s++]=u.x,i[s++]=u.y,i[s++]=u.z}return i}_convertToUnIndexedMesh(e=!1){const t=this.getVerticesDataKinds().filter((e=>!this.getVertexBuffer(e)?.getIsInstanced())),i=this.getIndices(),s={},r=(e,t)=>{const s=new Float32Array(i.length*t);let r=0;for(let n=0;n<i.length;n++)for(let a=0;a<t;a++)s[r++]=e[i[n]*t+a];return s},n=this.getBoundingInfo(),a=this.geometry?this.subMeshes.slice(0):[];for(const e of t)s[e]=this.getVerticesData(e);for(const n of t){const t=this.getVertexBuffer(n),a=t.getSize();if(e&&n===O.R.NormalKind){const e=this._getFlattenedNormals(i,s[O.R.PositionKind]);this.setVerticesData(O.R.NormalKind,e,t.isUpdatable(),a)}else this.setVerticesData(n,r(s[n],a),t.isUpdatable(),a)}if(this.morphTargetManager){for(let t=0;t<this.morphTargetManager.numTargets;t++){const s=this.morphTargetManager.getTarget(t),n=s.getPositions();s.setPositions(r(n,3));const a=s.getNormals();a&&s.setNormals(e?this._getFlattenedNormals(i,n):r(a,3));const o=s.getTangents();o&&s.setTangents(r(o,3));const l=s.getUVs();l&&s.setUVs(r(l,2))}this.morphTargetManager.synchronize()}for(let e=0;e<i.length;e++)i[e]=e;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(const e of a){const t=e.getBoundingInfo();rt.K.AddToMesh(e.materialIndex,e.indexStart,e.indexCount,e.indexStart,e.indexCount,this).setBoundingInfo(t)}return this.setBoundingInfo(n),this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){const t=at.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(O.R.NormalKind)&&t.normals){for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;this.setVerticesData(O.R.NormalKind,t.normals,this.isVertexBufferUpdatable(O.R.NormalKind))}if(t.indices){let e;for(i=0;i<t.indices.length;i+=3)e=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=e;this.setIndices(t.indices,null,this.isVertexBufferUpdatable(O.R.PositionKind),!0)}return this}increaseVertices(e=1){const t=at.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,s=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,r=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,n=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(i&&s){t.indices=i,t.positions=s,r&&(t.uvs=r),n&&(t.normals=n);const a=e+1,o=new Array;for(let e=0;e<a+1;e++)o[e]=new Array;let l,h;const c=new I.Pq(0,0,0),u=new I.Pq(0,0,0),d=new I.I9(0,0),_=new Array,p=new Array,f=new Array;let m,g,v,b=s.length;r&&(g=r.length),n&&(v=n.length);for(let e=0;e<i.length;e+=3){p[0]=i[e],p[1]=i[e+1],p[2]=i[e+2];for(let e=0;e<3;e++)if(l=p[e],h=p[(e+1)%3],void 0===f[l]&&void 0===f[h]?(f[l]=new Array,f[h]=new Array):(void 0===f[l]&&(f[l]=new Array),void 0===f[h]&&(f[h]=new Array)),void 0===f[l][h]&&void 0===f[h][l]){f[l][h]=[],c.x=(s[3*h]-s[3*l])/a,c.y=(s[3*h+1]-s[3*l+1])/a,c.z=(s[3*h+2]-s[3*l+2])/a,n&&(u.x=(n[3*h]-n[3*l])/a,u.y=(n[3*h+1]-n[3*l+1])/a,u.z=(n[3*h+2]-n[3*l+2])/a),r&&(d.x=(r[2*h]-r[2*l])/a,d.y=(r[2*h+1]-r[2*l+1])/a),f[l][h].push(l);for(let e=1;e<a;e++)f[l][h].push(s.length/3),s[b++]=s[3*l]+e*c.x,s[b++]=s[3*l+1]+e*c.y,s[b++]=s[3*l+2]+e*c.z,n&&(n[v++]=n[3*l]+e*u.x,n[v++]=n[3*l+1]+e*u.y,n[v++]=n[3*l+2]+e*u.z),r&&(r[g++]=r[2*l]+e*d.x,r[g++]=r[2*l+1]+e*d.y);f[l][h].push(h),f[h][l]=new Array,m=f[l][h].length;for(let e=0;e<m;e++)f[h][l][e]=f[l][h][m-1-e]}o[0][0]=i[e],o[1][0]=f[i[e]][i[e+1]][1],o[1][1]=f[i[e]][i[e+2]][1];for(let t=2;t<a;t++){o[t][0]=f[i[e]][i[e+1]][t],o[t][t]=f[i[e]][i[e+2]][t],c.x=(s[3*o[t][t]]-s[3*o[t][0]])/t,c.y=(s[3*o[t][t]+1]-s[3*o[t][0]+1])/t,c.z=(s[3*o[t][t]+2]-s[3*o[t][0]+2])/t,n&&(u.x=(n[3*o[t][t]]-n[3*o[t][0]])/t,u.y=(n[3*o[t][t]+1]-n[3*o[t][0]+1])/t,u.z=(n[3*o[t][t]+2]-n[3*o[t][0]+2])/t),r&&(d.x=(r[2*o[t][t]]-r[2*o[t][0]])/t,d.y=(r[2*o[t][t]+1]-r[2*o[t][0]+1])/t);for(let e=1;e<t;e++)o[t][e]=s.length/3,s[b++]=s[3*o[t][0]]+e*c.x,s[b++]=s[3*o[t][0]+1]+e*c.y,s[b++]=s[3*o[t][0]+2]+e*c.z,n&&(n[v++]=n[3*o[t][0]]+e*u.x,n[v++]=n[3*o[t][0]+1]+e*u.y,n[v++]=n[3*o[t][0]+2]+e*u.z),r&&(r[g++]=r[2*o[t][0]]+e*d.x,r[g++]=r[2*o[t][0]+1]+e*d.y)}o[a]=f[i[e+1]][i[e+2]],_.push(o[0][0],o[1][0],o[1][1]);for(let e=1;e<a;e++){let t;for(t=0;t<e;t++)_.push(o[e][t],o[e+1][t],o[e+1][t+1]),_.push(o[e][t],o[e+1][t+1],o[e][t+1]);_.push(o[e][t],o[e+1][t],o[e+1][t+1])}}t.indices=_,t.applyToMesh(this,this.isVertexBufferUpdatable(O.R.PositionKind))}else l.V.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions")}forceSharedVertices(){const e=at.ExtractFromMesh(this),t=e.uvs,i=e.indices,s=e.positions,r=e.colors,n=e.matricesIndices,a=e.matricesWeights,o=e.matricesIndicesExtra,h=e.matricesWeightsExtra;if(void 0===i||void 0===s||null===i||null===s)l.V.Warn("VertexData contains empty entries");else{const l=new Array,c=new Array,u=new Array,d=new Array,_=new Array,p=new Array,f=new Array,m=new Array;let g=new Array,v=0;const b={};let x,S;for(let e=0;e<i.length;e+=3){S=[i[e],i[e+1],i[e+2]],g=[];for(let e=0;e<3;e++){g[e]="";for(let t=0;t<3;t++)Math.abs(s[3*S[e]+t])<1e-8&&(s[3*S[e]+t]=0),g[e]+=s[3*S[e]+t]+"|"}if(g[0]!=g[1]&&g[0]!=g[2]&&g[1]!=g[2])for(let e=0;e<3;e++){if(x=b[g[e]],void 0===x){b[g[e]]=v,x=v++;for(let t=0;t<3;t++)l.push(s[3*S[e]+t]);if(null!=r)for(let t=0;t<4;t++)d.push(r[4*S[e]+t]);if(null!=t)for(let i=0;i<2;i++)u.push(t[2*S[e]+i]);if(null!=n)for(let t=0;t<4;t++)_.push(n[4*S[e]+t]);if(null!=a)for(let t=0;t<4;t++)p.push(a[4*S[e]+t]);if(null!=o)for(let t=0;t<4;t++)f.push(o[4*S[e]+t]);if(null!=h)for(let t=0;t<4;t++)m.push(h[4*S[e]+t])}c.push(x)}}const T=new Array;at.ComputeNormals(l,c,T),e.positions=l,e.indices=c,e.normals=T,null!=t&&(e.uvs=u),null!=r&&(e.colors=d),null!=n&&(e.matricesIndices=_),null!=a&&(e.matricesWeights=p),null!=o&&(e.matricesIndicesExtra=f),null!=a&&(e.matricesWeightsExtra=m),e.applyToMesh(this,this.isVertexBufferUpdatable(O.R.PositionKind))}}static _instancedMeshFactory(e,t){throw(0,F.n)("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw(0,F.n)("PhysicsImpostor")}createInstance(e){return At._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(O.R.PositionKind);if(!i||!t)return this;const s=[];for(let e=0;e<i.length;e+=3)s.push(I.Pq.FromArray(i,e));const r=[];return ee.LV.SyncAsyncForLoop(s.length,40,(e=>{const t=s.length-1-e,i=s[t];for(let e=0;e<t;++e){const n=s[e];if(i.equals(n)){r[t]=e;break}}}),(()=>{for(let e=0;e<t.length;++e)t[e]=r[t[e]]||t[e];const i=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=i,e&&e(this)})),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),Je.Y&&Je.Y.HasTags(this)&&(e.tags=Je.Y.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.alwaysSelectAsActiveMesh=this.alwaysSelectAsActiveMesh,e.checkCollisions=this.checkCollisions,e.ellipsoid=this.ellipsoid.asArray(),e.ellipsoidOffset=this.ellipsoidOffset.asArray(),e.doNotSyncBoundingInfo=this.doNotSyncBoundingInfo,e.isBlocker=this.isBlocker,e.sideOrientation=this.sideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let t=0;t<this.subMeshes.length;t++){const i=this.subMeshes[t];e.subMeshes.push({materialIndex:i.materialIndex,verticesStart:i.verticesStart,verticesCount:i.verticesCount,indexStart:i.indexStart,indexCount:i.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(fe.v.NAME_PHYSICSENGINE)){const t=this.getPhysicsImpostor();t&&(e.physicsMass=t.getParam("mass"),e.physicsFriction=t.getParam("friction"),e.physicsRestitution=t.getParam("mass"),e.physicsImpostor=t.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let t=0;t<this.instances.length;t++){const i=this.instances[t];if(i.doNotSerialize)continue;const s={name:i.name,id:i.id,isEnabled:i.isEnabled(!1),isVisible:i.isVisible,isPickable:i.isPickable,checkCollisions:i.checkCollisions,position:i.position.asArray(),scaling:i.scaling.asArray()};if(i.parent&&i.parent._serializeAsParent(s),i.rotationQuaternion?s.rotationQuaternion=i.rotationQuaternion.asArray():i.rotation&&(s.rotation=i.rotation.asArray()),this.getScene()._getComponent(fe.v.NAME_PHYSICSENGINE)){const e=i.getPhysicsImpostor();e&&(s.physicsMass=e.getParam("mass"),s.physicsFriction=e.getParam("friction"),s.physicsRestitution=e.getParam("mass"),s.physicsImpostor=e.type)}i.metadata&&(s.metadata=i.metadata),i.actionManager&&(s.actions=i.actionManager.serialize(i.name)),e.instances.push(s),N.p.AppendSerializedAnimations(i,s),s.ranges=i.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const t={data:{},sizes:{},strides:{}};for(const e in this._userThinInstanceBuffersStorage.data)t.data[e]=Array.from(this._userThinInstanceBuffersStorage.data[e]),t.sizes[e]=this._userThinInstanceBuffersStorage.sizes[e],t.strides[e]=this._userThinInstanceBuffersStorage.strides[e];e.thinInstances.userThinInstance=t}return N.p.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return l.V.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),s=i.getPositions();if(!s)return void l.V.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(O.R.PositionKind+t,s,!1,3);const r=i.getNormals();r&&this.geometry.setVerticesData(O.R.NormalKind+t,r,!1,3);const n=i.getTangents();n&&this.geometry.setVerticesData(O.R.TangentKind+t,n,!1,3);const a=i.getUVs();a&&this.geometry.setVerticesData(O.R.UVKind+"_"+t,a,!1,2)}}else{let e=0;for(;this.geometry.isVerticesDataPresent(O.R.PositionKind+e);)this.geometry.removeVerticesData(O.R.PositionKind+e),this.geometry.isVerticesDataPresent(O.R.NormalKind+e)&&this.geometry.removeVerticesData(O.R.NormalKind+e),this.geometry.isVerticesDataPresent(O.R.TangentKind+e)&&this.geometry.removeVerticesData(O.R.TangentKind+e),this.geometry.isVerticesDataPresent(O.R.UVKind+e)&&this.geometry.removeVerticesData(O.R.UVKind+"_"+e),e++}}static Parse(e,t,i){let s;if(s=e.type&&"LinesMesh"===e.type?At._LinesMeshParser(e,t):e.type&&"GroundMesh"===e.type?At._GroundMeshParser(e,t):e.type&&"GoldbergMesh"===e.type?At._GoldbergMeshParser(e,t):e.type&&"GreasedLineMesh"===e.type?At._GreasedLineMeshParser(e,t):e.type&&"TrailMesh"===e.type?At._TrailMeshParser(e,t):new At(e.name,t),s.id=e.id,s._waitingParsedUniqueId=e.uniqueId,Je.Y&&Je.Y.AddTagsTo(s,e.tags),s.position=I.Pq.FromArray(e.position),void 0!==e.metadata&&(s.metadata=e.metadata),e.rotationQuaternion?s.rotationQuaternion=I.PT.FromArray(e.rotationQuaternion):e.rotation&&(s.rotation=I.Pq.FromArray(e.rotation)),s.scaling=I.Pq.FromArray(e.scaling),e.localMatrix?s.setPreTransformMatrix(I.uq.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(I.uq.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s.isVisible=e.isVisible,s.infiniteDistance=e.infiniteDistance,s.alwaysSelectAsActiveMesh=!!e.alwaysSelectAsActiveMesh,s.showBoundingBox=e.showBoundingBox,s.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(s.applyFog=e.applyFog),void 0!==e.pickable&&(s.isPickable=e.pickable),void 0!==e.alphaIndex&&(s.alphaIndex=e.alphaIndex),s.receiveShadows=e.receiveShadows,void 0!==e.billboardMode&&(s.billboardMode=e.billboardMode),void 0!==e.visibility&&(s.visibility=e.visibility),s.checkCollisions=e.checkCollisions,s.doNotSyncBoundingInfo=!!e.doNotSyncBoundingInfo,e.ellipsoid&&(s.ellipsoid=I.Pq.FromArray(e.ellipsoid)),e.ellipsoidOffset&&(s.ellipsoidOffset=I.Pq.FromArray(e.ellipsoidOffset)),null!=e.overrideMaterialSideOrientation&&(s.sideOrientation=e.overrideMaterialSideOrientation),void 0!==e.sideOrientation&&(s.sideOrientation=e.sideOrientation),void 0!==e.isBlocker&&(s.isBlocker=e.isBlocker),s._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(s._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.actions&&(s._waitingData.actions=e.actions),void 0!==e.overlayAlpha&&(s.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(s.overlayColor=M.v9.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(s.renderOverlay=e.renderOverlay),s.isUnIndexed=!!e.isUnIndexed,s.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s.buildBoundingInfo(I.Pq.FromArray(e.boundingBoxMinimum),I.Pq.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(s._binaryInfo=e._binaryInfo),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(O.R.UVKind),e.hasUVs2&&s._delayInfo.push(O.R.UV2Kind),e.hasUVs3&&s._delayInfo.push(O.R.UV3Kind),e.hasUVs4&&s._delayInfo.push(O.R.UV4Kind),e.hasUVs5&&s._delayInfo.push(O.R.UV5Kind),e.hasUVs6&&s._delayInfo.push(O.R.UV6Kind),e.hasColors&&s._delayInfo.push(O.R.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(O.R.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(O.R.MatricesWeightsKind),s._delayLoadingFunction=ct._ImportGeometry,ot.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):ct._ImportGeometry(e,s),e.materialUniqueId?s._waitingMaterialId=e.materialUniqueId:e.materialId&&(s._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(s.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),void 0!==e.skeletonId&&null!==e.skeletonId&&(s.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(s.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=(0,V.n9)("BABYLON.Animation");r&&s.animations.push(r.Parse(i))}B.ParseAnimationRanges(s,e,t)}if(e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?s.layerMask=Math.abs(parseInt(e.layerMask)):s.layerMask=268435455,e.physicsImpostor&&(s.physicsImpostor=At._PhysicsImpostorParser(t,s,e)),e.lodMeshIds&&(s._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let i=0;i<e.instances.length;i++){const r=e.instances[i],n=s.createInstance(r.name);if(r.id&&(n.id=r.id),Je.Y&&(r.tags?Je.Y.AddTagsTo(n,r.tags):Je.Y.AddTagsTo(n,e.tags)),n.position=I.Pq.FromArray(r.position),void 0!==r.metadata&&(n.metadata=r.metadata),void 0!==r.parentId&&(n._waitingParentId=r.parentId),void 0!==r.parentInstanceIndex&&(n._waitingParentInstanceIndex=r.parentInstanceIndex),void 0!==r.isEnabled&&null!==r.isEnabled&&n.setEnabled(r.isEnabled),void 0!==r.isVisible&&null!==r.isVisible&&(n.isVisible=r.isVisible),void 0!==r.isPickable&&null!==r.isPickable&&(n.isPickable=r.isPickable),r.rotationQuaternion?n.rotationQuaternion=I.PT.FromArray(r.rotationQuaternion):r.rotation&&(n.rotation=I.Pq.FromArray(r.rotation)),n.scaling=I.Pq.FromArray(r.scaling),null!=r.checkCollisions&&null!=r.checkCollisions&&(n.checkCollisions=r.checkCollisions),null!=r.pickable&&null!=r.pickable&&(n.isPickable=r.pickable),null!=r.showBoundingBox&&null!=r.showBoundingBox&&(n.showBoundingBox=r.showBoundingBox),null!=r.showSubMeshesBoundingBox&&null!=r.showSubMeshesBoundingBox&&(n.showSubMeshesBoundingBox=r.showSubMeshesBoundingBox),null!=r.alphaIndex&&null!=r.showSubMeshesBoundingBox&&(n.alphaIndex=r.alphaIndex),r.physicsImpostor&&(n.physicsImpostor=At._PhysicsImpostorParser(t,n,r)),void 0!==r.actions&&(n._waitingData.actions=r.actions),r.animations){for(let e=0;e<r.animations.length;e++){const t=r.animations[e],i=(0,V.n9)("BABYLON.Animation");i&&n.animations.push(i.Parse(t))}B.ParseAnimationRanges(n,r,t),r.autoAnimate&&t.beginAnimation(n,r.autoAnimateFrom,r.autoAnimateTo,r.autoAnimateLoop,r.autoAnimateSpeed||1)}}if(e.thinInstances){const t=e.thinInstances;if(s.thinInstanceEnablePicking=!!t.enablePicking,t.matrixData?(s.thinInstanceSetBuffer("matrix",new Float32Array(t.matrixData),16,!1),s._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,s._thinInstanceDataStorage.instancesCount=t.instancesCount):s._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,e.thinInstances.userThinInstance){const t=e.thinInstances.userThinInstance;for(const e in t.data)s.thinInstanceSetBuffer(e,new Float32Array(t.data[e]),t.strides[e],!1),s._userThinInstanceBuffersStorage.sizes[e]=t.sizes[e]}}return s}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(O.R.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(O.R.PositionKind)||this.setVerticesData(O.R.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(O.R.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(O.R.NormalKind)||this.setVerticesData(O.R.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(O.R.PositionKind))return this;if(!this.isVerticesDataPresent(O.R.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(O.R.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(O.R.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(O.R.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let r=this.getVerticesData(O.R.NormalKind);if(t){if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r))}const n=this.getVerticesData(O.R.MatricesIndicesKind),a=this.getVerticesData(O.R.MatricesWeightsKind);if(!a||!n)return this;const o=this.numBoneInfluencers>4,l=o?this.getVerticesData(O.R.MatricesIndicesExtraKind):null,h=o?this.getVerticesData(O.R.MatricesWeightsExtraKind):null,c=e.getTransformMatrices(this),u=I.Pq.Zero(),d=new I.uq,_=new I.uq;let p,f=0;for(let e=0;e<s.length;e+=3,f+=4){let m;for(p=0;p<4;p++)m=a[f+p],m>0&&(I.uq.FromFloat32ArrayToRefScaled(c,Math.floor(16*n[f+p]),m,_),d.addToSelf(_));if(o)for(p=0;p<4;p++)m=h[f+p],m>0&&(I.uq.FromFloat32ArrayToRefScaled(c,Math.floor(16*l[f+p]),m,_),d.addToSelf(_));I.Pq.TransformCoordinatesFromFloatsToRef(i._sourcePositions[e],i._sourcePositions[e+1],i._sourcePositions[e+2],d,u),u.toArray(s,e),t&&(I.Pq.TransformNormalFromFloatsToRef(i._sourceNormals[e],i._sourceNormals[e+1],i._sourceNormals[e+2],d,u),u.toArray(r,e)),d.reset()}return this.updateVerticesData(O.R.PositionKind,s),t&&this.updateVerticesData(O.R.NormalKind,r),this}static MinMax(e){let t=null,i=null;return e.forEach((function(e){const s=e.getBoundingInfo().boundingBox;t&&i?(t.minimizeInPlace(s.minimumWorld),i.maximizeInPlace(s.maximumWorld)):(t=s.minimumWorld,i=s.maximumWorld)})),t&&i?{min:t,max:i}:{min:I.Pq.Zero(),max:I.Pq.Zero()}}static Center(e){const t=e instanceof Array?At.MinMax(e):e;return I.Pq.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,s,r,n){return it(At._MergeMeshesCoroutine(e,t,i,s,r,n,!1))}static MergeMeshesAsync(e,t=!0,i,s,r,n){return a=At._MergeMeshesCoroutine(e,t,i,s,r,n,!0),o=function(e=25){let t;return(i,s,r)=>{const n=performance.now();void 0===t||n-t>e?(t=n,setTimeout((()=>{et(i,s,r)}),0)):et(i,s,r)}}(),new Promise(((e,t)=>{tt(a,o,e,t,l)}));var a,o,l}static*_MergeMeshesCoroutine(e,t=!0,i,s,r,n,a){if(0===(e=e.filter(Boolean)).length)return null;let o;if(!i){let t=0;for(o=0;o<e.length;o++)if(t+=e[o].getTotalVertices(),t>=65536)return l.V.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}n&&(r=!1);const h=new Array,c=new Array,u=new Array,d=e[0].sideOrientation;for(o=0;o<e.length;o++){const t=e[o];if(t.isAnInstance)return l.V.Warn("Cannot merge instance meshes."),null;if(d!==t.sideOrientation)return l.V.Warn("Cannot merge meshes with different sideOrientation values."),null;if(r&&u.push(t.getTotalIndices()),n)if(t.material){const e=t.material;if(e instanceof xt){for(let t=0;t<e.subMaterials.length;t++)h.indexOf(e.subMaterials[t])<0&&h.push(e.subMaterials[t]);for(let i=0;i<t.subMeshes.length;i++)c.push(h.indexOf(e.subMaterials[t.subMeshes[i].materialIndex])),u.push(t.subMeshes[i].indexCount)}else{h.indexOf(e)<0&&h.push(e);for(let i=0;i<t.subMeshes.length;i++)c.push(h.indexOf(e)),u.push(t.subMeshes[i].indexCount)}}else for(let e=0;e<t.subMeshes.length;e++)c.push(0),u.push(t.subMeshes[e].indexCount)}const _=e[0],p=e=>{const t=e.computeWorldMatrix(!0);return{vertexData:at.ExtractFromMesh(e,!1,!1),transform:t}},{vertexData:f,transform:m}=p(_);a&&(yield);const g=new Array(e.length-1);for(let t=1;t<e.length;t++)g[t-1]=p(e[t]),a&&(yield);const v=f._mergeCoroutine(m,g,i,a,!t);let b=v.next();for(;!b.done;)a&&(yield),b=v.next();const x=b.value;s||(s=new At(_.name+"_merged",_.getScene()));const S=x._applyToCoroutine(s,void 0,a);let T=S.next();for(;!T.done;)a&&(yield),T=S.next();if(s.checkCollisions=_.checkCollisions,s.sideOrientation=_.sideOrientation,t)for(o=0;o<e.length;o++)e[o].dispose();if(r||n){s.releaseSubMeshes(),o=0;let e=0;for(;o<u.length;)rt.K.CreateFromIndices(0,e,u[o],s,void 0,!1),e+=u[o],o++;for(const e of s.subMeshes)e.refreshBoundingInfo();s.computeWorldMatrix(!0)}if(n){const e=new xt(_.name+"_merged",_.getScene());e.subMaterials=h;for(let e=0;e<s.subMeshes.length;e++)s.subMeshes[e].materialIndex=c[e];s.material=e}else s.material=_.material;return s}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(-1!=t){if(t!==this.instances.length-1){const e=this.instances[this.instances.length-1];this.instances[t]=e,e._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this._scene.useRightHandedSystem&&this.sideOrientation===Te.i.CounterClockWiseSideOrientation}_getRenderingFillMode(e){const t=this.getScene();return t.forcePointsCloud?Te.i.PointFillMode:t.forceWireframe?Te.i.WireFrameFillMode:this.overrideRenderingFillMode??e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,s,r,n,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,s){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,s,r,n,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,s,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,s,r,n,a,o,l,h){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,s,r,n,a,o){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,s,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,s,r,n,a,o){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,s,r,n,a,o,l,h){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,s,r,n,a,o,l,h,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,s,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,s,r,n,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,s,r,n,a,o,l,h,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,s,r,n,a,o,l,h){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}}At.FRONTSIDE=at.FRONTSIDE,At.BACKSIDE=at.BACKSIDE,At.DOUBLESIDE=at.DOUBLESIDE,At.DEFAULTSIDE=at.DEFAULTSIDE,At.NO_CAP=0,At.CAP_START=1,At.CAP_END=2,At.CAP_ALL=3,At.NO_FLIP=0,At.FLIP_TILE=1,At.ROTATE_TILE=2,At.FLIP_ROW=3,At.ROTATE_ROW=4,At.FLIP_N_ROTATE_TILE=5,At.FLIP_N_ROTATE_ROW=6,At.CENTER=0,At.LEFT=1,At.RIGHT=2,At.TOP=3,At.BOTTOM=4,At.INSTANCEDMESH_SORT_TRANSPARENT=!1,At._GroundMeshParser=(e,t)=>{throw(0,F.n)("GroundMesh")},At._GoldbergMeshParser=(e,t)=>{throw(0,F.n)("GoldbergMesh")},At._LinesMeshParser=(e,t)=>{throw(0,F.n)("LinesMesh")},At._GreasedLineMeshParser=(e,t)=>{throw(0,F.n)("GreasedLineMesh")},At._GreasedLineRibbonMeshParser=(e,t)=>{throw(0,F.n)("GreasedLineRibbonMesh")},At._TrailMeshParser=(e,t)=>{throw(0,F.n)("TrailMesh")},(0,V.Y5)("BABYLON.Mesh",At);var Rt=r(6240);class It{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add((e=>{e.type!==Rt.Zp.POINTERDOWN?e.type===Rt.Zp.POINTERUP&&(this._isPointerDown=!1):this._isPointerDown=!0})),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{if(this._reachTargetAlpha())return;const e=s.j.Now;let t=0;null!=this._lastFrameTime&&(t=e-this._lastFrameTime),this._lastFrameTime=e,this._applyUserInteraction();const i=e-this._lastInteractionTime-this._idleRotationWaitTime,r=Math.max(Math.min(i/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*r,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(t/1e3))}))}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=e??s.j.Now}_reachTargetAlpha(){return!(!this._attachedCamera||!this.targetAlpha)&&Math.abs(this._attachedCamera.alpha-this.targetAlpha)<ft.bH}_userIsZooming(){return!!this._attachedCamera&&0!==this._attachedCamera.inertialRadiusOffset}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&0!==this._attachedCamera.inertialRadiusOffset&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=s.j.Now)}_userIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}var Mt=r(1903);class Ot{constructor(){this._easingMode=Ot.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case Ot.EASINGMODE_EASEIN:return this.easeInCore(e);case Ot.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?.5*(1-this.easeInCore(2*(1-e)))+.5:.5*this.easeInCore(2*e)}}Ot.EASINGMODE_EASEIN=0,Ot.EASINGMODE_EASEOUT=1,Ot.EASINGMODE_EASEINOUT=2;class wt extends Ot{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}}class Dt extends Ot{easeInCore(e){return e*e}}class Ft extends Ot{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}}var Nt=r(4867);class Lt{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new Lt(this.name,this.from,this.to)}}var Bt=r(521),kt=r(2366);const Vt=Object.freeze(new I.PT(0,0,0,0)),Ut=Object.freeze(I.Pq.Zero()),zt=Object.freeze(I.I9.Zero()),Gt=Object.freeze(Bt.o.Zero()),Ht=Object.freeze(M.v9.Black()),Wt=Object.freeze(new M.ov(0,0,0,0)),Xt={key:0,repeatCount:0,loopMode:2};class Kt{static _PrepareAnimation(e,t,i,s,r,n,a,o){let l;if(!isNaN(parseFloat(r))&&isFinite(r)?l=Kt.ANIMATIONTYPE_FLOAT:r instanceof I.PT?l=Kt.ANIMATIONTYPE_QUATERNION:r instanceof I.Pq?l=Kt.ANIMATIONTYPE_VECTOR3:r instanceof I.I9?l=Kt.ANIMATIONTYPE_VECTOR2:r instanceof M.v9?l=Kt.ANIMATIONTYPE_COLOR3:r instanceof M.ov?l=Kt.ANIMATIONTYPE_COLOR4:r instanceof Bt.o&&(l=Kt.ANIMATIONTYPE_SIZE),null==l)return null;const h=new Kt(e,t,i,l,a),c=[{frame:0,value:r},{frame:s,value:n}];return h.setKeys(c),void 0!==o&&h.setEasingFunction(o),h}static CreateAnimation(e,t,i,s){const r=new Kt(e+"Animation",e,i,t,Kt.ANIMATIONLOOPMODE_CONSTANT);return r.setEasingFunction(s),r}static CreateAndStartAnimation(e,t,i,s,r,n,a,o,l,h,c){const u=Kt._PrepareAnimation(e,i,s,r,n,a,o,l);return u?(t.getScene&&(c=t.getScene()),c?c.beginDirectAnimation(t,[u],0,r,1===u.loopMode,1,h):null):null}static CreateAndStartHierarchyAnimation(e,t,i,s,r,n,a,o,l,h,c){const u=Kt._PrepareAnimation(e,s,r,n,a,o,l,h);return u?t.getScene().beginDirectHierarchyAnimation(t,i,[u],0,n,1===u.loopMode,1,c):null}static CreateMergeAndStartAnimation(e,t,i,s,r,n,a,o,l,h){const c=Kt._PrepareAnimation(e,i,s,r,n,a,o,l);return c?(t.animations.push(c),t.getScene().beginAnimation(t,0,r,1===c.loopMode,1,h)):null}static MakeAnimationAdditive(e,t,i,s=!1,r){let n;n="object"==typeof t?t:{referenceFrame:t??0,range:i,cloneOriginalAnimation:s,clonedAnimationName:r};let a=e;if(n.cloneOriginalAnimation&&(a=e.clone(),a.name=n.clonedAnimationName||a.name),!a._keys.length)return a;const o=n.referenceFrame&&n.referenceFrame>=0?n.referenceFrame:0;let l=0;const h=a._keys[0];let c=a._keys.length-1;const u=a._keys[c],d={referenceValue:h.value,referencePosition:I.AA.Vector3[0],referenceQuaternion:I.AA.Quaternion[0],referenceScaling:I.AA.Vector3[1],keyPosition:I.AA.Vector3[2],keyQuaternion:I.AA.Quaternion[1],keyScaling:I.AA.Vector3[3]};let _=h.frame,p=u.frame;if(n.range){const e=a.getRange(n.range);e&&(_=e.from,p=e.to)}else _=n.fromFrame??_,p=n.toFrame??p;if(_!==h.frame&&(l=a.createKeyForFrame(_)),p!==u.frame&&(c=a.createKeyForFrame(p)),1===a._keys.length){const e=a._getKeyValue(a._keys[0]);d.referenceValue=e.clone?e.clone():e}else if(o<=h.frame){const e=a._getKeyValue(h.value);d.referenceValue=e.clone?e.clone():e}else if(o>=u.frame){const e=a._getKeyValue(u.value);d.referenceValue=e.clone?e.clone():e}else{Xt.key=0;const e=a._interpolate(o,Xt);d.referenceValue=e.clone?e.clone():e}a.dataType===Kt.ANIMATIONTYPE_QUATERNION?d.referenceValue.normalize().conjugateInPlace():a.dataType===Kt.ANIMATIONTYPE_MATRIX&&(d.referenceValue.decompose(d.referenceScaling,d.referenceQuaternion,d.referencePosition),d.referenceQuaternion.normalize().conjugateInPlace());let f=Number.MAX_VALUE;const m=n.clipKeys?[]:null;for(let e=l;e<=c;e++){let t=a._keys[e];if((m||n.cloneOriginalAnimation)&&(t={frame:t.frame,value:t.value.clone?t.value.clone():t.value,inTangent:t.inTangent,outTangent:t.outTangent,interpolation:t.interpolation,lockedTangent:t.lockedTangent},m&&(f===Number.MAX_VALUE&&(f=t.frame),t.frame-=f,m.push(t))),!e||a.dataType===Kt.ANIMATIONTYPE_FLOAT||t.value!==h.value)switch(a.dataType){case Kt.ANIMATIONTYPE_MATRIX:t.value.decompose(d.keyScaling,d.keyQuaternion,d.keyPosition),d.keyPosition.subtractInPlace(d.referencePosition),d.keyScaling.divideInPlace(d.referenceScaling),d.referenceQuaternion.multiplyToRef(d.keyQuaternion,d.keyQuaternion),I.uq.ComposeToRef(d.keyScaling,d.keyQuaternion,d.keyPosition,t.value);break;case Kt.ANIMATIONTYPE_QUATERNION:d.referenceValue.multiplyToRef(t.value,t.value);break;case Kt.ANIMATIONTYPE_VECTOR2:case Kt.ANIMATIONTYPE_VECTOR3:case Kt.ANIMATIONTYPE_COLOR3:case Kt.ANIMATIONTYPE_COLOR4:t.value.subtractToRef(d.referenceValue,t.value);break;case Kt.ANIMATIONTYPE_SIZE:t.value.width-=d.referenceValue.width,t.value.height-=d.referenceValue.height;break;default:t.value-=d.referenceValue}}return m&&a.setKeys(m,!0),a}static TransitionTo(e,t,i,s,r,n,a,o=null){if(a<=0)return i[e]=t,o&&o(),null;const l=r*(a/1e3);n.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:l,value:t}]),i.animations||(i.animations=[]),i.animations.push(n);const h=s.beginAnimation(i,0,l,!1);return h.onAnimationEnd=o,h}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,s,r,n){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=s,this.loopMode=r,this.enableBlending=n,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=s,this.loopMode=void 0===r?Kt.ANIMATIONLOOPMODE_CYCLE:r,this.uniqueId=Kt._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let e=!0;for(const i in this._ranges)e&&(t+=", ",e=!1),t+=i;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort(((e,t)=>e.frame-t.frame))}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new Lt(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const e=i.from,t=i.to;for(let i=this._keys.length-1;i>=0;i--)this._keys[i].frame>=e&&this._keys[i].frame<=t&&this._keys.splice(i,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return(0,Nt.Lerp)(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,s,r){return(0,Nt.Hermite)(e,t,i,s,r)}quaternionInterpolateFunction(e,t,i){return I.PT.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,s,r){return I.PT.Hermite(e,t,i,s,r).normalize()}vector3InterpolateFunction(e,t,i){return I.Pq.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,s,r){return I.Pq.Hermite(e,t,i,s,r)}vector2InterpolateFunction(e,t,i){return I.I9.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,s,r){return I.I9.Hermite(e,t,i,s,r)}sizeInterpolateFunction(e,t,i){return Bt.o.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return M.v9.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,s,r){return M.v9.Hermite(e,t,i,s,r)}color4InterpolateFunction(e,t,i){return M.ov.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,s,r){return M.ov.Hermite(e,t,i,s,r)}_getKeyValue(e){return"function"==typeof e?e():e}evaluate(e){return Xt.key=0,this._interpolate(e,Xt)}_interpolate(e,t,i=!1){if(t.loopMode===Kt.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const s=this._keys,r=s.length;let n=t.key;for(;n>=0&&e<s[n].frame;)--n;for(;n+1<=r-1&&e>=s[n+1].frame;)++n;if(t.key=n,n<0)return i?void 0:this._getKeyValue(s[0].value);if(n+1>r-1)return i?void 0:this._getKeyValue(s[r-1].value);const a=s[n],o=s[n+1];if(i&&(e===a.frame||e===o.frame))return;const l=this._getKeyValue(a.value),h=this._getKeyValue(o.value);if(1===a.interpolation)return o.frame>e?l:h;const c=void 0!==a.outTangent&&void 0!==o.inTangent,u=o.frame-a.frame;let d=(e-a.frame)/u;const _=a.easingFunction||this.getEasingFunction();switch(null!==_&&(d=_.ease(d)),this.dataType){case Kt.ANIMATIONTYPE_FLOAT:{const e=c?this.floatInterpolateFunctionWithTangents(l,a.outTangent*u,h,o.inTangent*u,d):this.floatInterpolateFunction(l,h,d);switch(t.loopMode){case Kt.ANIMATIONLOOPMODE_CYCLE:case Kt.ANIMATIONLOOPMODE_CONSTANT:case Kt.ANIMATIONLOOPMODE_YOYO:return e;case Kt.ANIMATIONLOOPMODE_RELATIVE:case Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+e}break}case Kt.ANIMATIONTYPE_QUATERNION:{const e=c?this.quaternionInterpolateFunctionWithTangents(l,a.outTangent.scale(u),h,o.inTangent.scale(u),d):this.quaternionInterpolateFunction(l,h,d);switch(t.loopMode){case Kt.ANIMATIONLOOPMODE_CYCLE:case Kt.ANIMATIONLOOPMODE_CONSTANT:case Kt.ANIMATIONLOOPMODE_YOYO:return e;case Kt.ANIMATIONLOOPMODE_RELATIVE:case Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||Vt).scale(t.repeatCount))}return e}case Kt.ANIMATIONTYPE_VECTOR3:{const e=c?this.vector3InterpolateFunctionWithTangents(l,a.outTangent.scale(u),h,o.inTangent.scale(u),d):this.vector3InterpolateFunction(l,h,d);switch(t.loopMode){case Kt.ANIMATIONLOOPMODE_CYCLE:case Kt.ANIMATIONLOOPMODE_CONSTANT:case Kt.ANIMATIONLOOPMODE_YOYO:return e;case Kt.ANIMATIONLOOPMODE_RELATIVE:case Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||Ut).scale(t.repeatCount))}break}case Kt.ANIMATIONTYPE_VECTOR2:{const e=c?this.vector2InterpolateFunctionWithTangents(l,a.outTangent.scale(u),h,o.inTangent.scale(u),d):this.vector2InterpolateFunction(l,h,d);switch(t.loopMode){case Kt.ANIMATIONLOOPMODE_CYCLE:case Kt.ANIMATIONLOOPMODE_CONSTANT:case Kt.ANIMATIONLOOPMODE_YOYO:return e;case Kt.ANIMATIONLOOPMODE_RELATIVE:case Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||zt).scale(t.repeatCount))}break}case Kt.ANIMATIONTYPE_SIZE:switch(t.loopMode){case Kt.ANIMATIONLOOPMODE_CYCLE:case Kt.ANIMATIONLOOPMODE_CONSTANT:case Kt.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(l,h,d);case Kt.ANIMATIONLOOPMODE_RELATIVE:case Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(l,h,d).add((t.offsetValue||Gt).scale(t.repeatCount))}break;case Kt.ANIMATIONTYPE_COLOR3:{const e=c?this.color3InterpolateFunctionWithTangents(l,a.outTangent.scale(u),h,o.inTangent.scale(u),d):this.color3InterpolateFunction(l,h,d);switch(t.loopMode){case Kt.ANIMATIONLOOPMODE_CYCLE:case Kt.ANIMATIONLOOPMODE_CONSTANT:case Kt.ANIMATIONLOOPMODE_YOYO:return e;case Kt.ANIMATIONLOOPMODE_RELATIVE:case Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||Ht).scale(t.repeatCount))}break}case Kt.ANIMATIONTYPE_COLOR4:{const e=c?this.color4InterpolateFunctionWithTangents(l,a.outTangent.scale(u),h,o.inTangent.scale(u),d):this.color4InterpolateFunction(l,h,d);switch(t.loopMode){case Kt.ANIMATIONLOOPMODE_CYCLE:case Kt.ANIMATIONLOOPMODE_CONSTANT:case Kt.ANIMATIONLOOPMODE_YOYO:return e;case Kt.ANIMATIONLOOPMODE_RELATIVE:case Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||Wt).scale(t.repeatCount))}break}case Kt.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case Kt.ANIMATIONLOOPMODE_CYCLE:case Kt.ANIMATIONLOOPMODE_CONSTANT:case Kt.ANIMATIONLOOPMODE_YOYO:return Kt.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,h,d,t.workValue):l;case Kt.ANIMATIONLOOPMODE_RELATIVE:case Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return l}}return 0}matrixInterpolateFunction(e,t,i,s){return Kt.AllowMatrixDecomposeForInterpolation?s?(I.uq.DecomposeLerpToRef(e,t,i,s),s):I.uq.DecomposeLerp(e,t,i):s?(I.uq.LerpToRef(e,t,i,s),s):I.uq.Lerp(e,t,i)}clone(){const e=new Kt(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){Xt.key=0;const t=this._interpolate(e,Xt,!0);if(!t)return this._keys[Xt.key].frame===e?Xt.key:Xt.key+1;const i={frame:e,value:t.clone?t.clone():t};return this._keys.splice(Xt.key+1,0,i),Xt.key+1}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let s=0;s<i.length;s++){const r=i[s],n={};switch(n.frame=r.frame,t){case Kt.ANIMATIONTYPE_FLOAT:n.values=[r.value],void 0!==r.inTangent&&n.values.push(r.inTangent),void 0!==r.outTangent&&(void 0===r.inTangent&&n.values.push(void 0),n.values.push(r.outTangent)),void 0!==r.interpolation&&(void 0===r.inTangent&&n.values.push(void 0),void 0===r.outTangent&&n.values.push(void 0),n.values.push(r.interpolation));break;case Kt.ANIMATIONTYPE_QUATERNION:case Kt.ANIMATIONTYPE_MATRIX:case Kt.ANIMATIONTYPE_VECTOR3:case Kt.ANIMATIONTYPE_COLOR3:case Kt.ANIMATIONTYPE_COLOR4:n.values=r.value.asArray(),null!=r.inTangent&&n.values.push(r.inTangent.asArray()),null!=r.outTangent&&(void 0===r.inTangent&&n.values.push(void 0),n.values.push(r.outTangent.asArray())),void 0!==r.interpolation&&(void 0===r.inTangent&&n.values.push(void 0),void 0===r.outTangent&&n.values.push(void 0),n.values.push(r.interpolation))}e.keys.push(n)}e.ranges=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.ranges.push(s)}return e}static _UniversalLerp(e,t,i){const s=e.constructor;return s.Lerp?s.Lerp(e,t,i):s.Slerp?s.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new Kt(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,s=[];let r,n;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),n=0;n<e.keys.length;n++){const t=e.keys[n];let a,o,l;switch(i){case Kt.ANIMATIONTYPE_FLOAT:r=t.values[0],t.values.length>=2&&(a=t.values[1]),t.values.length>=3&&(o=t.values[2]),t.values.length>=4&&(l=t.values[3]);break;case Kt.ANIMATIONTYPE_QUATERNION:if(r=I.PT.FromArray(t.values),t.values.length>=8){const e=I.PT.FromArray(t.values.slice(4,8));e.equals(I.PT.Zero())||(a=e)}if(t.values.length>=12){const e=I.PT.FromArray(t.values.slice(8,12));e.equals(I.PT.Zero())||(o=e)}t.values.length>=13&&(l=t.values[12]);break;case Kt.ANIMATIONTYPE_MATRIX:r=I.uq.FromArray(t.values),t.values.length>=17&&(l=t.values[16]);break;case Kt.ANIMATIONTYPE_COLOR3:r=M.v9.FromArray(t.values),t.values[3]&&(a=M.v9.FromArray(t.values[3])),t.values[4]&&(o=M.v9.FromArray(t.values[4])),t.values[5]&&(l=t.values[5]);break;case Kt.ANIMATIONTYPE_COLOR4:r=M.ov.FromArray(t.values),t.values[4]&&(a=M.ov.FromArray(t.values[4])),t.values[5]&&(o=M.ov.FromArray(t.values[5])),t.values[6]&&(l=M.ov.FromArray(t.values[6]));break;case Kt.ANIMATIONTYPE_VECTOR3:default:r=I.Pq.FromArray(t.values),t.values[3]&&(a=I.Pq.FromArray(t.values[3])),t.values[4]&&(o=I.Pq.FromArray(t.values[4])),t.values[5]&&(l=t.values[5])}const h={};h.frame=t.frame,h.value=r,null!=a&&(h.inTangent=a),null!=o&&(h.outTangent=o),null!=l&&(h.interpolation=l),s.push(h)}if(t.setKeys(s),e.ranges)for(n=0;n<e.ranges.length;n++)r=e.ranges[n],t.createRange(r.name,r.from,r.to);return t}static AppendSerializedAnimations(e,t){N.p.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise(((i,s)=>{const r=new kt.u;r.addEventListener("readystatechange",(()=>{if(4==r.readyState)if(200==r.status){let t=JSON.parse(r.responseText);if(t.animations&&(t=t.animations),t.length){const e=[];for(const i of t)e.push(this.Parse(i));i(e)}else{const s=this.Parse(t);e&&(s.name=e),i(s)}}else s("Unable to load the animation")})),r.open("GET",t),r.send()}))}static ParseFromSnippetAsync(e){return new Promise(((t,i)=>{const s=new kt.u;s.addEventListener("readystatechange",(()=>{if(4==s.readyState)if(200==s.status){const i=JSON.parse(JSON.parse(s.responseText).jsonPayload);if(i.animations){const s=JSON.parse(i.animations),r=[];for(const t of s.animations){const i=this.Parse(t);i.snippetId=e,r.push(i)}t(r)}else{const s=JSON.parse(i.animation),r=this.Parse(s);r.snippetId=e,t(r)}}else i("Unable to load the snippet "+e)})),s.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send()}))}}Kt._UniqueIdGenerator=0,Kt.AllowMatricesInterpolation=!1,Kt.AllowMatrixDecomposeForInterpolation=!0,Kt.SnippetUrl="https://snippet.babylonjs.com",Kt.ANIMATIONTYPE_FLOAT=0,Kt.ANIMATIONTYPE_VECTOR3=1,Kt.ANIMATIONTYPE_QUATERNION=2,Kt.ANIMATIONTYPE_MATRIX=3,Kt.ANIMATIONTYPE_COLOR3=4,Kt.ANIMATIONTYPE_COLOR4=7,Kt.ANIMATIONTYPE_VECTOR2=5,Kt.ANIMATIONTYPE_SIZE=6,Kt.ANIMATIONLOOPMODE_RELATIVE=0,Kt.ANIMATIONLOOPMODE_CYCLE=1,Kt.ANIMATIONLOOPMODE_CONSTANT=2,Kt.ANIMATIONLOOPMODE_YOYO=4,Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5,Kt.CreateFromSnippetAsync=Kt.ParseFromSnippetAsync,(0,V.Y5)("BABYLON.Animation",Kt),B._AnimationRangeFactory=(e,t,i)=>new Lt(e,t,i);class Qt{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add((e=>{if(e&&(e.computeWorldMatrix(!0),e.getBoundingInfo)){const t=e.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=.05*t,this.upperRadiusTransitionRange=.05*t}})):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))}))}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return!!this._attachedCamera&&this._attachedCamera.radius===e&&!this._radiusIsAnimating}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(Qt.EasingFunction.setEasingMode(Qt.EasingMode),this._radiusBounceTransition=Kt.CreateAnimation("radius",Kt.ANIMATIONTYPE_FLOAT,60,Qt.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=Kt.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,(()=>this._clearAnimationLocks()));t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}Qt.EasingFunction=new class extends Ot{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}(.3),Qt.EasingMode=Ot.EASINGMODE_EASEOUT;class Yt{constructor(){this.onTargetFramingAnimationEndObservable=new C.cP,this._mode=Yt.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();Yt.EasingFunction.setEasingMode(Yt.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add((e=>{e.type!==Rt.Zp.POINTERDOWN?e.type===Rt.Zp.POINTERUP&&(this._isPointerDown=!1):this._isPointerDown=!0})),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add((e=>{e&&e.getBoundingInfo&&this.zoomOnMesh(e,void 0,(()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()}))})),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()}))}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(s.minimumWorld,s.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(s.min,s.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const s=new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new I.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let t=0;t<e.length;t++){const i=e[t].getHierarchyBoundingVectors(!0);I.Pq.CheckExtends(i.min,s,r),I.Pq.CheckExtends(i.max,s,r)}this.zoomOnBoundingInfo(s,r,t,i)}zoomOnBoundingInfo(e,t,i=!1,s=null){let r;if(!this._attachedCamera)return!1;const n=e.y,a=n+(t.y-n)*this._positionScale,o=t.subtract(e).scale(.5);if(i)r=new I.Pq(0,a,0);else{const t=e.add(o);r=new I.Pq(t.x,a,t.z)}this._vectorTransition||(this._vectorTransition=Kt.CreateAnimation("target",Kt.ANIMATIONTYPE_VECTOR3,60,Yt.EasingFunction)),this._betaIsAnimating=!0;let l=Kt.TransitionTo("target",r,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);l&&this._animatables.push(l);let h=0;if(this._mode===Yt.FitFrustumSidesMode){const i=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=o.length()+this._attachedCamera.minZ),h=i}else this._mode===Yt.IgnoreBoundsSizeMode&&(h=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&null===this._attachedCamera.lowerRadiusLimit&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const i=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/i,this._attachedCamera.wheelPrecision=100/h}return this._radiusTransition||(this._radiusTransition=Kt.CreateAnimation("radius",Kt.ANIMATIONTYPE_FLOAT,60,Yt.EasingFunction)),l=Kt.TransitionTo("radius",h,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,(()=>{this.stopAllAnimations(),s&&s(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()})),l&&this._animatables.push(l),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){const i=this._attachedCamera;if(!i)return 0;let s=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===Yt.IgnoreBoundsSizeMode&&(s=s<i.lowerRadiusLimit?i.lowerRadiusLimit:s),i.upperRadiusLimit&&(s=s>i.upperRadiusLimit?i.upperRadiusLimit:s),s}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=s.j.Now-this._lastInteractionTime,t=.5*Math.PI-this._defaultElevation,i=.5*Math.PI;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=Kt.CreateAnimation("beta",Kt.ANIMATIONTYPE_FLOAT,60,Yt.EasingFunction));const e=Kt.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,(()=>{this._clearAnimationLocks(),this.stopAllAnimations()}));e&&this._animatables.push(e)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=s.j.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}Yt.EasingFunction=new class extends Ot{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}},Yt.EasingMode=Ot.EASINGMODE_EASEINOUT,Yt.IgnoreBoundsSizeMode=0,Yt.FitFrustumSidesMode=1,B.AddNodeConstructor("TargetCamera",((e,t)=>()=>new qt(e,I.Pq.Zero(),t)));class qt extends se{constructor(e,t,i,s=!0){super(e,t,i,s),this._tmpUpVector=I.Pq.Zero(),this._tmpTargetVector=I.Pq.Zero(),this.cameraDirection=new I.Pq(0,0,0),this.cameraRotation=new I.I9(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new I.PT,this.rotation=new I.Pq(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=I.Pq.Zero(),this._initialFocalDistance=1,this._viewMatrix=I.uq.Zero(),this._camMatrix=I.uq.Zero(),this._cameraTransformMatrix=I.uq.Zero(),this._cameraRotationMatrix=I.uq.Zero(),this._referencePoint=new I.Pq(0,0,1),this._transformedReferencePoint=I.Pq.Zero(),this._deferredPositionUpdate=new I.Pq,this._deferredRotationQuaternionUpdate=new I.PT,this._deferredRotationUpdate=new I.Pq,this._deferredUpdated=!1,this._deferOnly=!1,this._defaultUp=I.Pq.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)}_initCache(){super._initCache(),this._cache.lockedTarget=new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new I.PT(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(100*e.getFps()))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=ft.bH),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),I.uq.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&I.PT.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(I.AA.Matrix[0]),I.Pq.TransformNormalToRef(this.cameraDirection,I.AA.Matrix[0],I.AA.Vector3[0]),this._deferredPositionUpdate.addInPlace(I.AA.Vector3[0]),void(this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate));this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;if(this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i){if(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,!this.noRotationConstraint){const e=1.570796;this._deferredRotationUpdate.x>e&&(this._deferredRotationUpdate.x=e),this._deferredRotationUpdate.x<-e&&(this._deferredRotationUpdate.x=-e)}this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(I.PT.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))}t&&(Math.abs(this.cameraDirection.x)<this.speed*ft.bH&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*ft.bH&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*ft.bH&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*ft.bH&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*ft.bH&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):I.uq.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return I.Pq.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),I.Pq.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?mt._0.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(I.PT.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),mt._0.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const s=this.parent.getWorldMatrix();I.Pq.TransformCoordinatesToRef(e,s,this._globalPosition),I.Pq.TransformCoordinatesToRef(t,s,this._tmpTargetVector),I.Pq.TransformNormalToRef(i,s,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?I.uq.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):I.uq.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix)}else if(this.getScene().useRightHandedSystem?I.uq.LookAtRHToRef(e,t,i,this._viewMatrix):I.uq.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==se.RIG_MODE_NONE){const t=new qt(e,this.position.clone(),this.getScene());return t.isRigCamera=!0,t.rigParent=this,this.cameraRigMode===se.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new I.PT),t._cameraRigParams={},t.rotationQuaternion=new I.PT),t.mode=this.mode,t.orthoLeft=this.orthoLeft,t.orthoRight=this.orthoRight,t.orthoTop=this.orthoTop,t.orthoBottom=this.orthoBottom,t}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case se.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case se.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case se.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case se.RIG_MODE_STEREOSCOPIC_OVERUNDER:case se.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===se.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,s=this.cameraRigMode===se.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*s,t);break}case se.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position)}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,qt._TargetFocalPoint),qt._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const i=qt._TargetFocalPoint.addInPlace(this.position);I.uq.TranslationToRef(-i.x,-i.y,-i.z,qt._TargetTransformMatrix),qt._TargetTransformMatrix.multiplyToRef(I.uq.RotationAxis(t.upVector,e),qt._RigCamTransformMatrix),I.uq.TranslationToRef(i.x,i.y,i.z,qt._TargetTransformMatrix),qt._RigCamTransformMatrix.multiplyToRef(qt._TargetTransformMatrix,qt._RigCamTransformMatrix),I.Pq.TransformCoordinatesToRef(this.position,qt._RigCamTransformMatrix,t.position),t.setTarget(i)}getClassName(){return"TargetCamera"}}qt._RigCamTransformMatrix=new I.uq,qt._TargetTransformMatrix=new I.uq,qt._TargetFocalPoint=new I.Pq,(0,w.Cg)([(0,D.P_)()],qt.prototype,"rotation",void 0),(0,w.Cg)([(0,D.lK)()],qt.prototype,"speed",void 0),(0,w.Cg)([(0,D.xG)("lockedTargetId")],qt.prototype,"lockedTarget",void 0);var $t={};class jt{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();this.attached[t]?l.V.Warn("camera input of type "+t+" already exists on camera"):(this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault))}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e)return i.detachControl(),i.camera=null,delete this.attached[t],void this.rebuildInputCheck()}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=!se.ForceAttachControlToAlwaysPreventDefault&&e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const e in this.attached){const i=this.attached[e],s=N.p.Serialize(i);t[i.getClassName()]=s}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const e in t){const i=$t[e];if(i){const s=t[e],r=N.p.Parse((()=>new i),s,null);this.add(r)}}}else for(const t in this.attached){const i=$t[this.attached[t].getClassName()];if(i){const s=N.p.Parse((()=>new i),e,null);this.remove(this.attached[t]),this.add(s)}}}}class Zt{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=ee.S0.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let s=0,r=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=n=>{const a=n.event,o="touch"===a.pointerType;if(n.type!==Rt.Zp.POINTERMOVE&&-1===this.buttons.indexOf(a.button))return;const l=a.target;if(this._altKey=a.altKey,this._ctrlKey=a.ctrlKey,this._metaKey=a.metaKey,this._shiftKey=a.shiftKey,this._buttonsPressed=a.buttons,t.isPointerLock){const e=a.movementX,t=a.movementY;this.onTouch(null,e,t),this._pointA=null,this._pointB=null}else{if(n.type!==Rt.Zp.POINTERDOWN&&n.type!==Rt.Zp.POINTERDOUBLETAP&&o&&this._pointA?.pointerId!==a.pointerId&&this._pointB?.pointerId!==a.pointerId)return;if(n.type!==Rt.Zp.POINTERDOWN||-1!==this._currentActiveButton&&!o)if(n.type===Rt.Zp.POINTERDOUBLETAP)this.onDoubleTap(a.pointerType);else if(n.type!==Rt.Zp.POINTERUP||this._currentActiveButton!==a.button&&!o){if(n.type===Rt.Zp.POINTERMOVE)if(e||a.preventDefault(),this._pointA&&null===this._pointB){const e=a.clientX-this._pointA.x,t=a.clientY-this._pointA.y;this._pointA.x=a.clientX,this._pointA.y=a.clientY,this.onTouch(this._pointA,e,t)}else if(this._pointA&&this._pointB){const e=this._pointA.pointerId===a.pointerId?this._pointA:this._pointB;e.x=a.clientX,e.y=a.clientY;const t=this._pointA.x-this._pointB.x,i=this._pointA.y-this._pointB.y,o=t*t+i*i,l={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:a.pointerId,type:n.type};this.onMultiTouch(this._pointA,this._pointB,s,o,r,l),r=l,s=o}}else{try{l?.releasePointerCapture(a.pointerId)}catch(e){}o||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==a.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==a.pointerId?this._pointB=null:this._pointA=this._pointB=null,(0!==s||r)&&(this.onMultiTouch(this._pointA,this._pointB,s,0,r,null),s=0,r=null),this._currentActiveButton=-1,this.onButtonUp(a),e||a.preventDefault()}else{try{l?.setPointerCapture(a.pointerId)}catch(e){}if(null===this._pointA)this._pointA={x:a.clientX,y:a.clientY,pointerId:a.pointerId,type:a.pointerType};else{if(null!==this._pointB)return;this._pointB={x:a.clientX,y:a.clientY,pointerId:a.pointerId,type:a.pointerType}}-1!==this._currentActiveButton||o||(this._currentActiveButton=a.button),this.onButtonDown(a),e||(a.preventDefault(),i&&i.focus())}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Rt.Zp.POINTERDOWN|Rt.Zp.POINTERUP|Rt.Zp.POINTERMOVE|Rt.Zp.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,s=0,r=null,this.onLostFocus()},this._contextMenuBind=e=>this.onContextMenu(e),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const n=this.camera.getScene().getEngine().getHostWindow();n&&ee.S0.RegisterTopRootEvents(n,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&ee.S0.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,s,r,n){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}(0,w.Cg)([(0,D.lK)()],Zt.prototype,"buttons",void 0);class Jt extends Zt{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(0!==this.panningSensibility&&e&&t){const i=t.x-e.x,s=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=s/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||Jt.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=.001*(t-e)*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){0!==this.panningSensibility&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,s,r,n){0===i&&null===r||0===s&&null===n||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,s),this._computeMultiTouchPanning(r,n)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(s)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,s),this._isPinching=!0):this._computeMultiTouchPanning(r,n)):this.multiTouchPanning?this._computeMultiTouchPanning(r,n):this.pinchZoom&&this._computePinchZoom(i,s))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}Jt.MinimumRadiusForPinch=.001,(0,w.Cg)([(0,D.lK)()],Jt.prototype,"buttons",void 0),(0,w.Cg)([(0,D.lK)()],Jt.prototype,"angularSensibilityX",void 0),(0,w.Cg)([(0,D.lK)()],Jt.prototype,"angularSensibilityY",void 0),(0,w.Cg)([(0,D.lK)()],Jt.prototype,"pinchPrecision",void 0),(0,w.Cg)([(0,D.lK)()],Jt.prototype,"pinchDeltaPercentage",void 0),(0,w.Cg)([(0,D.lK)()],Jt.prototype,"useNaturalPinchZoom",void 0),(0,w.Cg)([(0,D.lK)()],Jt.prototype,"pinchZoom",void 0),(0,w.Cg)([(0,D.lK)()],Jt.prototype,"panningSensibility",void 0),(0,w.Cg)([(0,D.lK)()],Jt.prototype,"multiTouchPanning",void 0),(0,w.Cg)([(0,D.lK)()],Jt.prototype,"multiTouchPanAndZoom",void 0),$t.ArcRotateCameraPointersInput=Jt;var ei=r(4146);class ti{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=ee.S0.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===ei.TB.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),i.preventDefault&&(e||i.preventDefault())}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];-1!==this.keysLeft.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:-1!==this.keysUp.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:-1!==this.keysRight.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:-1!==this.keysDown.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:-1!==this.keysReset.indexOf(i)&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}(0,w.Cg)([(0,D.lK)()],ti.prototype,"keysUp",void 0),(0,w.Cg)([(0,D.lK)()],ti.prototype,"keysDown",void 0),(0,w.Cg)([(0,D.lK)()],ti.prototype,"keysLeft",void 0),(0,w.Cg)([(0,D.lK)()],ti.prototype,"keysRight",void 0),(0,w.Cg)([(0,D.lK)()],ti.prototype,"keysReset",void 0),(0,w.Cg)([(0,D.lK)()],ti.prototype,"panningSensibility",void 0),(0,w.Cg)([(0,D.lK)()],ti.prototype,"zoomingSensibility",void 0),(0,w.Cg)([(0,D.lK)()],ti.prototype,"useAltToZoom",void 0),(0,w.Cg)([(0,D.lK)()],ti.prototype,"angularSpeed",void 0),$t.ArcRotateCameraKeyboardMoveInput=ti;var ii,si=r(4100),ri=r(8123);class ni{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new I.Pq(0,0,0),this._globalOffset=new I.Pq(0,0,0),this._inertialPanning=I.Pq.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const s=.01*e*this.wheelDeltaPercentage*t;return i=e>0?s/(1+this.wheelDeltaPercentage):s*(1+this.wheelDeltaPercentage),i}attachControl(e){e=ee.S0.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Rt.Zp.POINTERWHEEL)return;const i=t.event;let s=0;const r=i.deltaMode===ri.s.DOM_DELTA_LINE?40:1,n=-i.deltaY*r;if(this.customComputeDeltaFromMouseWheel)s=this.customComputeDeltaFromMouseWheel(n,this,i);else if(this.wheelDeltaPercentage){if(s=this._computeDeltaFromMouseWheelLegacyEvent(n,this.camera.radius),s>0){let e=this.camera.radius,t=this.camera.inertialRadiusOffset+s;for(let i=0;i<20&&Math.abs(t)>.001;i++)e-=t,t*=this.camera.inertia;e=(0,Nt.Clamp)(e,0,Number.MAX_VALUE),s=this._computeDeltaFromMouseWheelLegacyEvent(n,e)}}else s=n/(40*this.wheelPrecision);s&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(s)):this.camera.inertialRadiusOffset+=s),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Rt.Zp.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=si.Z.FromPositionAndNormal(e.target,t)}_getPosition(){const e=this.camera,t=e.getScene(),i=t.createPickingRay(t.pointerX,t.pointerY,I.uq.Identity(),e,!1);0===e.targetScreenOffset.x&&0===e.targetScreenOffset.y||(this._viewOffset.set(e.targetScreenOffset.x,e.targetScreenOffset.y,0),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),this._globalOffset=I.Pq.TransformNormal(this._viewOffset,e._cameraTransformMatrix),i.origin.addInPlace(this._globalOffset));let s=0;return this._hitPlane&&(s=i.intersectsPlane(this._hitPlane)??0),i.origin.addInPlace(i.direction.scaleInPlace(s))}_zoomToMouse(e){const t=this.camera,i=1-t.inertia;if(t.lowerRadiusLimit){const s=t.lowerRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i<s&&(e=(t.radius-s)*i-t.inertialRadiusOffset)}if(t.upperRadiusLimit){const s=t.upperRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i>s&&(e=(t.radius-s)*i-t.inertialRadiusOffset)}const s=e/i/t.radius,r=this._getPosition(),n=I.AA.Vector3[6];r.subtractToRef(t.target,n),n.scaleInPlace(s),n.scaleInPlace(i),this._inertialPanning.addInPlace(n),t.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<ft.bH&&(e.x=0),Math.abs(e.y)<ft.bH&&(e.y=0),Math.abs(e.z)<ft.bH&&(e.z=0)}}(0,w.Cg)([(0,D.lK)()],ni.prototype,"wheelPrecision",void 0),(0,w.Cg)([(0,D.lK)()],ni.prototype,"zoomToMouseLocation",void 0),(0,w.Cg)([(0,D.lK)()],ni.prototype,"wheelDeltaPercentage",void 0),$t.ArcRotateCameraMouseWheelInput=ni;class ai extends jt{constructor(e){super(e)}addMouseWheel(){return this.add(new ni),this}addPointers(){return this.add(new Jt),this}addKeyboard(){return this.add(new ti),this}}B.AddNodeConstructor("ArcRotateCamera",((e,t)=>()=>new oi(e,0,0,1,I.Pq.Zero(),t)));class oi extends qt{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new I.uq,this._upToYMatrix=new I.uq,this._upVector=I.Pq.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){I.uq.RotationAlignToRef(I.Pq.UpReadOnly,this._upVector,this._yToUpMatrix),I.uq.RotationAlignToRef(this._upVector,I.Pq.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return!!e&&e.useNaturalPinchZoom}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return!!e&&e.zoomToMouseLocation}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return null!=this._bouncingBehavior}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new Qt,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return null!=this._framingBehavior}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new Yt,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return null!=this._autoRotationBehavior}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new It,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,s,r,n,a=!0){super(e,I.Pq.Zero(),n,a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=I.Pq.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=I.I9.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this.restoreStateInterpolationFactor=0,this._viewMatrix=new I.uq,this.panningAxis=new I.Pq(1,1,0),this._transformedDirection=new I.Pq,this.mapPanning=!1,this._progressiveRestore=!1,this.onMeshTargetChangedObservable=new C.cP,this.checkCollisions=!1,this.collisionRadius=new I.Pq(.5,.5,.5),this._previousPosition=I.Pq.Zero(),this._collisionVelocity=I.Pq.Zero(),this._newPosition=I.Pq.Zero(),this._computationVector=I.Pq.Zero(),this._onCollisionPositionChange=(e,t,i=null)=>{i?(this.setPosition(t),this.onCollide&&this.onCollide(i)):this._previousPosition.copyFrom(this._position);const s=Math.cos(this.alpha),r=Math.sin(this.alpha),n=Math.cos(this.beta);let a=Math.sin(this.beta);0===a&&(a=1e-4);const o=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*s*a,this.radius*n,this.radius*r*a),o.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let l=this.upVector;this.allowUpsideDown&&this.beta<0&&(l=l.clone(),l=l.negate()),this._computeViewMatrix(this._position,o,l),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=I.Pq.Zero(),r&&this.setTarget(r),this.alpha=t,this.beta=i,this.radius=s,this.getViewMatrix(),this.inputs=new ai(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=I.I9.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const e=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?e.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(e)}return this._getLockedTargetPosition()||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return this.hasStateStored()&&this.restoreStateInterpolationFactor>ft.bH&&this.restoreStateInterpolationFactor<1?(this._progressiveRestore=!0,this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!!super._restoreStateValues()&&(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0)}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset)}attachControl(e,t,i=!0,s=2){const r=arguments;t=ee.S0.BackCompatCameraNoPreventDefault(r),this._useCtrlForPanning=i,this._panningMouseButton=s,"boolean"==typeof r[0]&&(r.length>1&&(this._useCtrlForPanning=r[1]),r.length>2&&(this._panningMouseButton=r[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this._progressiveRestore){const e=this._scene.getEngine().getDeltaTime()/1e3,t=1-Math.pow(2,-e/this.restoreStateInterpolationFactor);this.setTarget(I.Pq.Lerp(this.getTarget(),this._storedTarget,t)),I.PT.RotationAlphaBetaGammaToRef(this._storedAlpha,this._storedBeta,0,I.AA.Quaternion[0]),I.PT.RotationAlphaBetaGammaToRef(this.alpha,this.beta,0,I.AA.Quaternion[1]),I.PT.SlerpToRef(I.AA.Quaternion[1],I.AA.Quaternion[0],t,I.AA.Quaternion[2]),I.AA.Quaternion[2].normalize(),I.AA.Quaternion[2].toAlphaBetaGammaToRef(I.AA.Vector3[0]),this.alpha=I.AA.Vector3[0].x,this.beta=I.AA.Vector3[0].y,this.radius+=(this._storedRadius-this.radius)*t,I.I9.LerpToRef(this.targetScreenOffset,this._storedTargetScreenOffset,t,this.targetScreenOffset),(I.Pq.DistanceSquared(this.getTarget(),this._storedTarget)<ft.bH&&I.AA.Quaternion[2].equalsWithEpsilon(I.AA.Quaternion[0])&&Math.pow(this._storedRadius-this.radius,2)<ft.bH&&I.I9.Distance(this.targetScreenOffset,this._storedTargetScreenOffset)<ft.bH||0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset||0!==this.inertialPanningX||0!==this.inertialPanningY)&&(this._progressiveRestore=!1)}if(0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset){const e=this.invertRotation?-1:1,t=this._calculateHandednessMultiplier();let i=this.inertialAlphaOffset*t;this.beta<0&&(i*=-1),this.alpha+=i*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<ft.bH&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<ft.bH&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*ft.bH&&(this.inertialRadiusOffset=0)}if(0!==this.inertialPanningX||0!==this.inertialPanningY){const e=new I.Pq(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),I.Pq.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){const e=this.upVector,t=I.Pq.CrossToRef(this._transformedDirection,e,this._transformedDirection);I.Pq.CrossToRef(e,t,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);if(!this._targetHost)if(this.panningDistanceLimit)this._transformedDirection.addInPlace(this._target),I.Pq.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection);else{if(this.parent){const e=I.AA.Matrix[0];this.parent.getWorldMatrix().getRotationMatrixToRef(e),e.transposeToRef(e),I.Pq.TransformCoordinatesToRef(this._transformedDirection,e,this._transformedDirection)}this._target.addInPlace(this._transformedDirection)}this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*ft.bH&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*ft.bH&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){null===this.lowerBetaLimit||void 0===this.lowerBetaLimit?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),null===this.upperBetaLimit||void 0===this.upperBetaLimit?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),null!==this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),null!==this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),0===this._upVector.x&&1===this._upVector.y&&0===this._upVector.z||I.Pq.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),0===this.radius&&(this.radius=1e-4);const e=this.alpha;0===this._computationVector.x&&0===this._computationVector.z?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=2*t*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,s=!1){if(s=this.overrideCloneAlphaBetaRadius??s,e.computeWorldMatrix)t&&e.getBoundingInfo?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const t=e,s=this._getTargetPosition();if(s&&!i&&s.equals(t))return;this._targetHost=null,this._target=t,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}s||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let s=Math.sin(this.beta);0===s&&(s=1e-4),0===this.radius&&(this.radius=1e-4);const r=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*s,this.radius*i,this.radius*t*s),0===this._upVector.x&&1===this._upVector.y&&0===this._upVector.z||I.Pq.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),r.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const e=this.getScene().collisionCoordinator;this._collider||(this._collider=e.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,e.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let e=this.upVector;this.allowUpsideDown&&s<0&&(e=e.negate()),this._computeViewMatrix(this._position,r,e),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=r,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=At.MinMax(e);let s=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);s=Math.max(Math.min(s,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=s*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:s},t)}focusOn(e,t=!1){let i,s;if(void 0===e.min){const t=e||this.getScene().meshes;i=At.MinMax(t),s=I.Pq.Distance(i.min,i.max)}else i=e,s=e.distance;this._target=At.Center(i),t||(this.maxZ=2*s)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case se.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case se.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case se.RIG_MODE_STEREOSCOPIC_OVERUNDER:case se.RIG_MODE_STEREOSCOPIC_INTERLACED:case se.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(0===t?1:-1);break;case se.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(0===t?-1:1)}const s=new oi(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return s._cameraRigParams={},s.isRigCamera=!0,s.rigParent=this,s.upVector=this.upVector,s.mode=this.mode,s.orthoLeft=this.orthoLeft,s.orthoRight=this.orthoRight,s.orthoBottom=this.orthoBottom,s.orthoTop=this.orthoTop,s}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case se.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case se.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case se.RIG_MODE_STEREOSCOPIC_OVERUNDER:case se.RIG_MODE_STEREOSCOPIC_INTERLACED:case se.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case se.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){const s=I.Pq.Distance(e,t),r=this.getScene().getEngine().getAspectRatio(this),n=Math.tan(this.fov/2),a=n*r,o=.5*s*i,l=o*Math.sqrt(1+1/(a*a)),h=o*Math.sqrt(1+1/(n*n));return Math.max(l,h)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}(0,w.Cg)([(0,D.lK)()],oi.prototype,"alpha",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"beta",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"radius",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"overrideCloneAlphaBetaRadius",void 0),(0,w.Cg)([(0,D.P_)("target")],oi.prototype,"_target",void 0),(0,w.Cg)([(0,D.xG)("targetHost")],oi.prototype,"_targetHost",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"inertialAlphaOffset",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"inertialBetaOffset",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"inertialRadiusOffset",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"lowerAlphaLimit",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"upperAlphaLimit",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"lowerBetaLimit",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"upperBetaLimit",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"lowerRadiusLimit",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"upperRadiusLimit",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"inertialPanningX",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"inertialPanningY",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"pinchToPanMaxDistance",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"panningDistanceLimit",void 0),(0,w.Cg)([(0,D.P_)()],oi.prototype,"panningOriginTarget",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"panningInertia",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"zoomToMouseLocation",null),(0,w.Cg)([(0,D.lK)()],oi.prototype,"zoomOnFactor",void 0),(0,w.Cg)([(0,D.WM)()],oi.prototype,"targetScreenOffset",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"allowUpsideDown",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"useInputToRestoreState",void 0),(0,w.Cg)([(0,D.lK)()],oi.prototype,"restoreStateInterpolationFactor",void 0),(0,V.Y5)("BABYLON.ArcRotateCamera",oi);class li extends H.${set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,s,r=0,n=G.g.BILINEAR_SAMPLINGMODE,a=!0){if(super(e,t,i,s,!0,r,!1,n,a),this.mirrorPlane=new si.Z(0,1,0,1),this._transformMatrix=I.uq.Zero(),this._mirrorMatrix=I.uq.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,!(i=this.getScene()))return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateGammaSpace()}));const o=i.getEngine();let l;o.supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeBindObservable.add((()=>{o._debugPushGroup?.(`mirror generation for ${e}`,1)})),this.onAfterUnbindObservable.add((()=>{o._debugPopGroup?.(1)})),this.onBeforeRenderObservable.add((()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),I.uq.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),l=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=I.Pq.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)})),this.onAfterRenderObservable.add((()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=l}))}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new X("horizontal blur",new I.I9(1,0),this._blurKernelX,this._blurRatio,null,G.g.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,1===this._blurRatio&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new X("vertical blur",new I.I9(0,1),this._blurKernelY,this._blurRatio,null,G.g.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=1!==this._blurRatio,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new li(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){super.dispose();const e=this.getScene();e&&e.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),this._sceneUBO?.dispose()}}G.g._CreateMirror=(e,t,i,s)=>new li(e,t,i,s),r(9195);class hi extends b.t{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(I.uq.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let s="";return e.forEach((e=>s+=e)),new hi(s,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,s=!0){const r=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const n=new hi(e,t,null,!1,null,null,null,void 0,!0,i,s);return t.useDelayedTextureLoading=r,n}constructor(e,t,i=null,s=!1,r=null,n=null,a=null,o=5,l=!1,h=null,c=!1,u=.8,d=0,_,p){super(t),this.onLoadObservable=new C.cP,this.boundingBoxPosition=I.Pq.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new I.uq,this._buffer=null,this.name=e,this.url=e,this._noMipmap=s,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=I.uq.Identity(),this.coordinatesMode=G.g.CUBIC_MODE;let f=null,m=null;null===i||Array.isArray(i)?(this._noMipmap=s,this._format=o,this._createPolynomials=c,f=i,this._loaderOptions=_,this._useSRGBBuffer=p,this._lodScale=u,this._lodOffset=d):(f=i.extensions??null,this._noMipmap=i.noMipmap??!1,r=i.files??null,m=i.buffer??null,this._format=i.format??5,l=i.prefiltered??!1,h=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??.8,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,n=i.onLoad??null,a=i.onError??null),(e||r)&&this.updateURL(e,h,n,l,a,f,this.getScene()?.useDelayedTextureLoading,r,m)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,s=!1,r=null,n=null,a=!1,o=null,l=null){this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,t&&(this._forcedExtension=t);const h=e.lastIndexOf("."),c=t||(h>-1?e.substring(h).toLowerCase():""),u=0===c.indexOf(".dds"),d=0===c.indexOf(".env"),_=0===c.indexOf(".basis");if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=s,s&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),o)this._files=o;else if(_||d||u||n||(n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,n){for(let t=0;t<n.length;t++)this._files.push(e+n[t]);this._extensions=n}this._buffer=l,a?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=r):this._loadTexture(i,r)}delayLoad(e){4===this.delayLoadState&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){if(e.updateFlag===this._textureMatrix.updateFlag)return;if(e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,(e=>-1!==e.getActiveTextures().indexOf(this))),this._textureMatrix=e,!this.getScene()?.useRightHandedSystem)return;const t=I.AA.Vector3[0],i=I.AA.Quaternion[0],s=I.AA.Vector3[1];this._textureMatrix.decompose(t,i,s),i.z*=-1,i.w*=-1,I.uq.ComposeToRef(t,i,s,this._textureMatrixRefraction)}getRefractionTextureMatrix(){return this.getScene()?.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){const i=this.getScene(),s=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const r=()=>{this.onLoadObservable.notifyObservers(this),s&&(s.dispose(),this.getScene()?.markAllMaterialsAsDirty(1)),e&&e()},n=(e,i)=>{this._loadingError=!0,this._errorObject={message:e,exception:i},t&&t(e,i),G.g.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?ee.S0.SetImmediate((()=>r())):this._texture.onLoadedObservable.add((()=>r())):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,n,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,n,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),this._texture?.onLoadedObservable.add((()=>this.onLoadObservable.notifyObservers(this))))}static Parse(e,t,i){const s=N.p.Parse((()=>{let s=!1;return e.prefiltered&&(s=e.prefiltered),new hi(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,s,e.forcedExtension)}),e,t);if(e.boundingBoxPosition&&(s.boundingBoxPosition=I.Pq.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(s.boundingBoxSize=I.Pq.FromArray(e.boundingBoxSize)),e.animations)for(let t=0;t<e.animations.length;t++){const i=e.animations[t],r=(0,V.n9)("BABYLON.Animation");r&&s.animations.push(r.Parse(i))}return s}clone(){let e=0;const t=N.p.Clone((()=>{const t=new hi(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=t.uniqueId,t}),this);return t.uniqueId=e,t}}(0,w.Cg)([(0,D.lK)()],hi.prototype,"url",void 0),(0,w.Cg)([(0,D.P_)()],hi.prototype,"boundingBoxPosition",void 0),(0,w.Cg)([(0,D.P_)()],hi.prototype,"boundingBoxSize",null),(0,w.Cg)([(0,D.lK)("rotationY")],hi.prototype,"rotationY",null),(0,w.Cg)([(0,D.lK)("files")],hi.prototype,"_files",void 0),(0,w.Cg)([(0,D.lK)("forcedExtension")],hi.prototype,"_forcedExtension",void 0),(0,w.Cg)([(0,D.lK)("extensions")],hi.prototype,"_extensions",void 0),(0,w.Cg)([(0,D.GG)("textureMatrix")],hi.prototype,"_textureMatrix",void 0),(0,w.Cg)([(0,D.GG)("textureMatrixRefraction")],hi.prototype,"_textureMatrixRefraction",void 0),G.g._CubeTextureParser=hi.Parse,(0,V.Y5)("BABYLON.CubeTexture",hi);class ci extends ye.M{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class ui extends Ce{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t*=2,this.reflectionReflectance0=ui.StandardReflectance0*t,this.reflectionReflectance90=ui.StandardReflectance90*t):(t=2*t-1,this.reflectionReflectance0=ui.StandardReflectance0+(1-ui.StandardReflectance0)*t,this.reflectionReflectance90=ui.StandardReflectance90+(1-ui.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()}))))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t),this.primaryColor=M.v9.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=I.Pq.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new J.L(16),this._reflectionControls=I.IU.Zero(),this._white=M.v9.White(),this._primaryShadowColor=M.v9.Black(),this._primaryHighlightColor=M.v9.Black(),this._shadersLoaded=!1;const s=this.getScene().getEngine();s.isWebGPU&&!i&&(this._uniformBuffer&&this._uniformBuffer.dispose(),this._uniformBuffer=new k.D(s,void 0,void 0,this.name,!0),this._shaderLanguage=1),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!(!this._diffuseTexture||!this._diffuseTexture.isRenderTarget)||!(!this._reflectionTexture||!this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){const s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new ci);const n=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const o=n.getEngine();if((0,$.az)(n,e,a,!1,this._maxSimultaneousLights),a._needNormals=!0,(0,$.VO)(n,a),a._areTexturesDirty){if(a._needUVs=!1,n.texturesEnabled){if(n.getEngine().getCaps().textureLOD&&(a.TEXTURELODSUPPORT=!0),this._diffuseTexture&&Pe.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;(0,$.YT)(this._diffuseTexture,a,"DIFFUSE"),a.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,a.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,a.OPACITYFRESNEL=this._opacityFresnel}else a.DIFFUSE=!1,a.DIFFUSEDIRECTUV=0,a.DIFFUSEHASALPHA=!1,a.GAMMADIFFUSE=!1,a.OPACITYFRESNEL=!1;const e=this._reflectionTexture;if(e&&Pe.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;switch(a.REFLECTION=!0,a.GAMMAREFLECTION=e.gammaSpace,a.RGBDREFLECTION=e.isRGBD,a.REFLECTIONBLUR=this._reflectionBlur>0,a.LODINREFLECTIONALPHA=e.lodLevelInAlpha,a.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,a.REFLECTIONBGR=this.switchToBGR,e.coordinatesMode===G.g.INVCUBIC_MODE&&(a.INVERTCUBICMAP=!0),a.REFLECTIONMAP_3D=e.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,e.coordinatesMode){case G.g.EXPLICIT_MODE:a.REFLECTIONMAP_EXPLICIT=!0;break;case G.g.PLANAR_MODE:a.REFLECTIONMAP_PLANAR=!0;break;case G.g.PROJECTION_MODE:a.REFLECTIONMAP_PROJECTION=!0;break;case G.g.SKYBOX_MODE:a.REFLECTIONMAP_SKYBOX=!0;break;case G.g.SPHERICAL_MODE:a.REFLECTIONMAP_SPHERICAL=!0;break;case G.g.EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case G.g.FIXED_EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case G.g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case G.g.CUBIC_MODE:case G.g.INVCUBIC_MODE:default:a.REFLECTIONMAP_CUBIC=!0}this.reflectionFresnel?(a.REFLECTIONFRESNEL=!0,a.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1)}else a.REFLECTION=!1,a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1,a.REFLECTIONBLUR=!1,a.REFLECTIONMAP_3D=!1,a.REFLECTIONMAP_SPHERICAL=!1,a.REFLECTIONMAP_PLANAR=!1,a.REFLECTIONMAP_CUBIC=!1,a.REFLECTIONMAP_PROJECTION=!1,a.REFLECTIONMAP_SKYBOX=!1,a.REFLECTIONMAP_EXPLICIT=!1,a.REFLECTIONMAP_EQUIRECTANGULAR=!1,a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,a.INVERTCUBICMAP=!1,a.REFLECTIONMAP_OPPOSITEZ=!1,a.LODINREFLECTIONALPHA=!1,a.GAMMAREFLECTION=!1,a.RGBDREFLECTION=!1}a.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,a.USERGBCOLOR=this._useRGBColor,a.NOISE=this._enableNoise}if(a._areLightsDirty&&(a.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel),a.BACKMAT_SHADOWONLY=this._shadowOnly),a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a)}if(a._areMiscDirty&&(a.REFLECTIONMAP_3D&&this._enableGroundProjection?(a.PROJECTED_GROUND=!0,a.REFLECTIONMAP_SKYBOX=!0):a.PROJECTED_GROUND=!1),(0,$.fm)(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),a),(0,$.OR)(n,o,this,a,i,null,t.getRenderingMesh().hasThinInstances),(0,$.qB)(e,a,!1,!0,!1)&&e&&(n.getEngine().getCaps().standardDerivatives||e.isVerticesDataPresent(O.R.NormalKind)||(e.createNormals(!0),l.V.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name))),a.isDirty){a.markAsProcessed(),n.resetCachedMaterial();const i=new K;a.FOG&&i.addFallback(0,"FOG"),a.POINTSIZE&&i.addFallback(1,"POINTSIZE"),a.MULTIVIEW&&i.addFallback(0,"MULTIVIEW"),(0,$.c4)(a,i,this._maxSimultaneousLights);const s=[O.R.PositionKind];a.NORMAL&&s.push(O.R.NormalKind),a.UV1&&s.push(O.R.UVKind),a.UV2&&s.push(O.R.UV2Kind),(0,$.ni)(s,e,a,i),(0,$.ER)(s,a);const l=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];(0,q.TV)(l);const h=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],c=["Material","Scene"];Se.p&&(Se.p.PrepareUniforms(l,a),Se.p.PrepareSamplers(h,a)),(0,$.Bb)({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:a,maxSimultaneousLights:this._maxSimultaneousLights});const u=a.toString(),d=n.getEngine().createEffect("background",{attributes:s,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:u,fallbacks:i,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([r.e(5616).then(r.bind(r,3235)),r.e(1018).then(r.bind(r,1018))]):await Promise.all([r.e(1114).then(r.bind(r,1114)),r.e(4476).then(r.bind(r,4476))]),this._shadersLoaded=!0}},o);t.setEffect(d,a,this._materialContext),this.buildUniformLayout()}return!(!t.effect||!t.effect.isReady()||(a._renderId=n.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){0===this._primaryColorShadowLevel&&0===this._primaryColorHighlightLevel||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e),(0,$.f$)(t,this._activeEffect);const a=this._mustRebind(s,n,i,t.visibility);if(a){this._uniformBuffer.bindToEffect(n,"Material"),this.bindViewProjection(n);const e=this._reflectionTexture;this._uniformBuffer.useUbo&&this.isFrozen&&this._uniformBuffer.isSync&&!i._drawWrapper._forceRebindOnNextCall||(s.texturesEnabled&&(this._diffuseTexture&&Pe.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),(0,$.mA)(this._diffuseTexture,this._uniformBuffer,"diffuse")),e&&Pe.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",e.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",e.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",e.getSize().width,e.lodGenerationScale,e.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),r.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),s.texturesEnabled&&(this._diffuseTexture&&Pe.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),e&&Pe.ReflectionTextureEnabled&&(r.REFLECTIONBLUR&&r.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",e):r.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",e._lodTextureMid||e),this._uniformBuffer.setTexture("reflectionSamplerLow",e._lodTextureLow||e),this._uniformBuffer.setTexture("reflectionSamplerHigh",e._lodTextureHigh||e)):this._uniformBuffer.setTexture("reflectionSampler",e),r.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),r.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),(0,q.gS)(this._activeEffect,this,s),s.bindEyePosition(n)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(n,"Material"),this._needToBindSceneUbo=!0);!a&&this.isFrozen||(s.lightsEnabled&&(0,$.RL)(s,t,this._activeEffect,r,this._maxSimultaneousLights),this.bindView(n),(0,$.Yy)(s,t,this._activeEffect,!0),this._useLogarithmicDepth&&(0,$.DL)(r,n,s),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update()}hasTexture(e){return!!super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return N.p.Clone((()=>new ui(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new ui(e.name,t)),e,t,i)}}function di(e){const t=[],i=[],s=[],r=[],n=e.width||e.size||1,a=e.height||e.size||1,o=0===e.sideOrientation?0:e.sideOrientation||at.DEFAULTSIDE,l=n/2,h=a/2;i.push(-l,-h,0),s.push(0,0,-1),r.push(0,ht.rX?1:0),i.push(l,-h,0),s.push(0,0,-1),r.push(1,ht.rX?1:0),i.push(l,h,0),s.push(0,0,-1),r.push(1,ht.rX?0:1),i.push(-l,h,0),s.push(0,0,-1),r.push(0,ht.rX?0:1),t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),at._ComputeSides(o,i,t,s,r,e.frontUVs,e.backUVs);const c=new at;return c.indices=t,c.positions=i,c.normals=s,c.uvs=r,c}function _i(e,t={},i=null){const s=new At(e,i);return t.sideOrientation=At._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,di(t).applyToMesh(s,t.updatable),t.sourcePlane&&(s.translate(t.sourcePlane.normal,-t.sourcePlane.d),s.setDirection(t.sourcePlane.normal.scale(-1))),s}ui.StandardReflectance0=.05,ui.StandardReflectance90=.5,(0,w.Cg)([(0,D.jT)()],ui.prototype,"_primaryColor",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsLightsDirty")],ui.prototype,"primaryColor",void 0),(0,w.Cg)([(0,D.jT)()],ui.prototype,"__perceptualColor",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_primaryColorShadowLevel",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_primaryColorHighlightLevel",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsLightsDirty")],ui.prototype,"primaryColorHighlightLevel",null),(0,w.Cg)([(0,D.uM)()],ui.prototype,"_reflectionTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"reflectionTexture",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_reflectionBlur",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"reflectionBlur",void 0),(0,w.Cg)([(0,D.uM)()],ui.prototype,"_diffuseTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"diffuseTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"shadowLights",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_shadowLevel",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"shadowLevel",void 0),(0,w.Cg)([(0,D.P_)()],ui.prototype,"_sceneCenter",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"sceneCenter",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_opacityFresnel",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"opacityFresnel",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_reflectionFresnel",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"reflectionFresnel",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_reflectionFalloffDistance",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"reflectionFalloffDistance",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_reflectionAmount",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"reflectionAmount",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_reflectionReflectance0",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"reflectionReflectance0",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_reflectionReflectance90",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"reflectionReflectance90",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_useRGBColor",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"useRGBColor",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_enableNoise",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"enableNoise",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_maxSimultaneousLights",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"maxSimultaneousLights",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"_shadowOnly",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsLightsDirty")],ui.prototype,"shadowOnly",void 0),(0,w.Cg)([(0,D.n1)()],ui.prototype,"_imageProcessingConfiguration",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsMiscDirty")],ui.prototype,"enableGroundProjection",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"projectedGroundRadius",void 0),(0,w.Cg)([(0,D.lK)()],ui.prototype,"projectedGroundHeight",void 0),(0,V.Y5)("BABYLON.BackgroundMaterial",ui),at.CreatePlane=di,At.CreatePlane=(e,t,i,s,r)=>_i(e,{size:t,width:t,height:t,sideOrientation:r,updatable:s},i),At._GroundMeshParser=(e,t)=>pi.Parse(e,t);class pi extends At{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);this.createOrUpdateSubmeshesOctree&&this.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),s=I.AA.Matrix[5];i.invertToRef(s);const r=I.AA.Vector3[8];if(I.Pq.TransformCoordinatesFromFloatsToRef(e,0,t,s,r),e=r.x,t=r.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());const n=this._getFacetAt(e,t),a=-(n.x*e+n.z*t+n.w)/n.y;return I.Pq.TransformCoordinatesFromFloatsToRef(0,a,0,i,r),r.y}getNormalAtCoordinates(e,t){const i=new I.Pq(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const s=this.getWorldMatrix(),r=I.AA.Matrix[5];s.invertToRef(r);const n=I.AA.Vector3[8];if(I.Pq.TransformCoordinatesFromFloatsToRef(e,0,t,r,n),e=n.x,t=n.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());const a=this._getFacetAt(e,t);return I.Pq.TransformNormalFromFloatsToRef(a.x,a.y,a.z,s,i),this}updateCoordinateHeights(){return this._heightQuads&&0!=this._heightQuads.length||this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),s=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),r=this._heightQuads[s*this._subdivisionsX+i];let n;return n=t<r.slope.x*e+r.slope.y?r.facet1:r.facet2,n}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s={slope:I.I9.Zero(),facet1:new I.IU(0,0,0,0),facet2:new I.IU(0,0,0,0)};this._heightQuads[i*e+t]=s}return this}_computeHeightQuads(){const e=this.getVerticesData(O.R.PositionKind);if(!e)return this;const t=I.AA.Vector3[3],i=I.AA.Vector3[2],s=I.AA.Vector3[1],r=I.AA.Vector3[0],n=I.AA.Vector3[4],a=I.AA.Vector3[5],o=I.AA.Vector3[6],l=I.AA.Vector3[7],h=I.AA.Vector3[8];let c=0,u=0,d=0,_=0,p=0,f=0,m=0;const g=this._subdivisionsX,v=this._subdivisionsY;for(let b=0;b<v;b++)for(let v=0;v<g;v++){c=3*v,u=b*(g+1)*3,d=(b+1)*(g+1)*3,t.x=e[u+c],t.y=e[u+c+1],t.z=e[u+c+2],i.x=e[u+c+3],i.y=e[u+c+4],i.z=e[u+c+5],s.x=e[d+c],s.y=e[d+c+1],s.z=e[d+c+2],r.x=e[d+c+3],r.y=e[d+c+4],r.z=e[d+c+5],_=(r.z-t.z)/(r.x-t.x),p=t.z-_*t.x,i.subtractToRef(t,n),s.subtractToRef(t,a),r.subtractToRef(t,o),I.Pq.CrossToRef(o,a,l),I.Pq.CrossToRef(n,o,h),l.normalize(),h.normalize(),f=-(l.x*t.x+l.y*t.y+l.z*t.z),m=-(h.x*i.x+h.y*i.y+h.z*i.z);const x=this._heightQuads[b*g+v];x.slope.copyFromFloats(_,p),x.facet1.copyFromFloats(l.x,l.y,l.z,f),x.facet2.copyFromFloats(h.x,h.y,h.z,m)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new pi(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function fi(e){const t=[],i=[],s=[],r=[];let n,a;const o=e.width||e.size||1,l=e.height||e.size||1,h=0|(e.subdivisionsX||e.subdivisions||1),c=0|(e.subdivisionsY||e.subdivisions||1);for(n=0;n<=c;n++)for(a=0;a<=h;a++){const e=new I.Pq(a*o/h-o/2,0,(c-n)*l/c-l/2),t=new I.Pq(0,1,0);i.push(e.x,e.y,e.z),s.push(t.x,t.y,t.z),r.push(a/h,ht.rX?n/c:1-n/c)}for(n=0;n<c;n++)for(a=0;a<h;a++)t.push(a+1+(n+1)*(h+1)),t.push(a+1+n*(h+1)),t.push(a+n*(h+1)),t.push(a+(n+1)*(h+1)),t.push(a+1+(n+1)*(h+1)),t.push(a+n*(h+1));const u=new at;return u.indices=t,u.positions=i,u.normals=s,u.uvs=r,u}function mi(e){const t=void 0!==e.xmin&&null!==e.xmin?e.xmin:-1,i=void 0!==e.zmin&&null!==e.zmin?e.zmin:-1,s=void 0!==e.xmax&&null!==e.xmax?e.xmax:1,r=void 0!==e.zmax&&null!==e.zmax?e.zmax:1,n=e.subdivisions||{w:1,h:1},a=e.precision||{w:1,h:1},o=[],l=[],h=[],c=[];let u,d,_,p;n.h=n.h<1?1:n.h,n.w=n.w<1?1:n.w,a.w=a.w<1?1:a.w,a.h=a.h<1?1:a.h;const f=(s-t)/n.w,m=(r-i)/n.h;function g(e,t,i,s){const r=l.length/3,n=a.w+1;for(u=0;u<a.h;u++)for(d=0;d<a.w;d++){const e=[r+d+u*n,r+(d+1)+u*n,r+(d+1)+(u+1)*n,r+d+(u+1)*n];o.push(e[1]),o.push(e[2]),o.push(e[3]),o.push(e[0]),o.push(e[1]),o.push(e[3])}const _=I.Pq.Zero(),p=new I.Pq(0,1,0);for(u=0;u<=a.h;u++)for(_.z=u*(s-t)/a.h+t,d=0;d<=a.w;d++)_.x=d*(i-e)/a.w+e,_.y=0,l.push(_.x,_.y,_.z),h.push(p.x,p.y,p.z),c.push(d/a.w,u/a.h)}for(_=0;_<n.h;_++)for(p=0;p<n.w;p++)g(t+p*f,i+_*m,t+(p+1)*f,i+(_+1)*m);const v=new at;return v.indices=o,v.positions=l,v.normals=h,v.uvs=c,v}function gi(e){const t=[],i=[],s=[],r=[];let n,a;const o=e.colorFilter||new M.v9(.3,.59,.11),l=e.alphaFilter||0;let h=!1;if(e.minHeight>e.maxHeight){h=!0;const t=e.maxHeight;e.maxHeight=e.minHeight,e.minHeight=t}for(n=0;n<=e.subdivisions;n++)for(a=0;a<=e.subdivisions;a++){const t=new I.Pq(a*e.width/e.subdivisions-e.width/2,0,(e.subdivisions-n)*e.height/e.subdivisions-e.height/2),c=4*(((t.x+e.width/2)/e.width*(e.bufferWidth-1)|0)+((1-(t.z+e.height/2)/e.height)*(e.bufferHeight-1)|0)*e.bufferWidth);let u=e.buffer[c]/255,d=e.buffer[c+1]/255,_=e.buffer[c+2]/255;const p=e.buffer[c+3]/255;h&&(u=1-u,d=1-d,_=1-_);const f=u*o.r+d*o.g+_*o.b;t.y=p>=l?e.minHeight+(e.maxHeight-e.minHeight)*f:e.minHeight-ft.bH,e.heightBuffer&&(e.heightBuffer[n*(e.subdivisions+1)+a]=t.y),i.push(t.x,t.y,t.z),s.push(0,0,0),r.push(a/e.subdivisions,1-n/e.subdivisions)}for(n=0;n<e.subdivisions;n++)for(a=0;a<e.subdivisions;a++){const s=a+1+(n+1)*(e.subdivisions+1),r=a+1+n*(e.subdivisions+1),o=a+n*(e.subdivisions+1),l=a+(n+1)*(e.subdivisions+1),h=i[3*s+1]>=e.minHeight,c=i[3*r+1]>=e.minHeight,u=i[3*o+1]>=e.minHeight;h&&c&&u&&(t.push(s),t.push(r),t.push(o)),i[3*l+1]>=e.minHeight&&h&&u&&(t.push(l),t.push(s),t.push(o))}at.ComputeNormals(i,t,s);const c=new at;return c.indices=t,c.positions=i,c.normals=s,c.uvs=r,c}function vi(e,t={},i){const s=new pi(e,i);return s._setReady(!1),s._subdivisionsX=t.subdivisionsX||t.subdivisions||1,s._subdivisionsY=t.subdivisionsY||t.subdivisions||1,s._width=t.width||1,s._height=t.height||1,s._maxX=s._width/2,s._maxZ=s._height/2,s._minX=-s._maxX,s._minZ=-s._maxZ,fi(t).applyToMesh(s,t.updatable),s._setReady(!0),s}function bi(e){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],s=[];let r=[];const n=e.width||e.size||1,a=e.height||e.size||1,o=e.depth||e.size||1,l=e.wrap||!1;let h=void 0===e.topBaseAt?1:e.topBaseAt,c=void 0===e.bottomBaseAt?0:e.bottomBaseAt;h=(h+4)%4,c=(c+4)%4;let u=[2,0,3,1][h],d=[2,0,1,3][c],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(l){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let e=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],i=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const s=[17,18,19,16],r=[22,23,20,21];for(;u>0;)e.unshift(e.pop()),s.unshift(s.pop()),u--;for(;d>0;)i.unshift(i.pop()),r.unshift(r.pop()),d--;e=e.flat(),i=i.flat(),_=_.concat(e).concat(i),t.push(s[0],s[2],s[3],s[0],s[1],s[2]),t.push(r[0],r[2],r[3],r[0],r[1],r[2])}const p=[n/2,a/2,o/2];r=_.reduce(((e,t,i)=>e.concat(t*p[i%3])),[]);const f=0===e.sideOrientation?0:e.sideOrientation||at.DEFAULTSIDE,m=e.faceUV||new Array(6),g=e.faceColors,v=[];for(let e=0;e<6;e++)void 0===m[e]&&(m[e]=new I.IU(0,0,1,1)),g&&void 0===g[e]&&(g[e]=new M.ov(1,1,1,1));for(let e=0;e<6;e++)if(s.push(m[e].z,ht.rX?1-m[e].w:m[e].w),s.push(m[e].x,ht.rX?1-m[e].w:m[e].w),s.push(m[e].x,ht.rX?1-m[e].y:m[e].y),s.push(m[e].z,ht.rX?1-m[e].y:m[e].y),g)for(let t=0;t<4;t++)v.push(g[e].r,g[e].g,g[e].b,g[e].a);at._ComputeSides(f,r,t,i,s,e.frontUVs,e.backUVs);const b=new at;if(b.indices=t,b.positions=r,b.normals=i,b.uvs=s,g){const e=f===at.DOUBLESIDE?v.concat(v):v;b.colors=e}return b}function xi(e,t={},i=null){const s=new At(e,i);return t.sideOrientation=At._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,bi(t).applyToMesh(s,t.updatable),s}at.CreateGround=fi,at.CreateTiledGround=mi,at.CreateGroundFromHeightMap=gi,At.CreateGround=(e,t,i,s,r,n)=>vi(e,{width:t,height:i,subdivisions:s,updatable:n},r),At.CreateTiledGround=(e,t,i,s,r,n,a,o,l)=>function(e,t,i=null){const s=new At(e,i);return mi(t).applyToMesh(s,t.updatable),s}(e,{xmin:t,zmin:i,xmax:s,zmax:r,subdivisions:n,precision:a,updatable:l},o),At.CreateGroundFromHeightMap=(e,i,s,r,n,a,o,l,h,c,u)=>function(e,i,s={},r=null){const n=s.width||10,a=s.height||10,o=s.subdivisions||1,l=s.minHeight||0,h=s.maxHeight||1,c=s.colorFilter||new M.v9(.3,.59,.11),u=s.alphaFilter||0,d=s.updatable,_=s.onReady;r=r||t.q.LastCreatedScene;const p=new pi(e,r);let f;p._subdivisionsX=o,p._subdivisionsY=o,p._width=n,p._height=a,p._maxX=p._width/2,p._maxZ=p._height/2,p._minX=-p._maxX,p._minZ=-p._maxZ,p._setReady(!1),s.passHeightBufferInCallback&&(f=new Float32Array((o+1)*(o+1)));const m=(e,t,i)=>{gi({width:n,height:a,subdivisions:o,minHeight:l,maxHeight:h,colorFilter:c,buffer:e,bufferWidth:t,bufferHeight:i,alphaFilter:u,heightBuffer:f}).applyToMesh(p,d),_&&_(p,f),p._setReady(!0)};if("string"==typeof i){const e=e=>{const t=e.width,i=e.height;if(r.isDisposed)return;const s=r?.getEngine().resizeImageBitmap(e,t,i);m(s,t,i)};ee.S0.LoadImage(i,e,s.onError?s.onError:()=>{},r.offlineProvider)}else m(i.data,i.width,i.height);return p}(e,i,{width:s,height:r,subdivisions:n,minHeight:a,maxHeight:o,updatable:h,onReady:c,alphaFilter:u},l),at.CreateBox=bi,At.CreateBox=(e,t,i=null,s,r)=>xi(e,{size:t,sideOrientation:r,updatable:s},i);class Si{static _GetDefaultOptions(e){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new M.v9(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new M.v9(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:I.Pq.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(e,t){this._errorHandler=(e,t)=>{this.onErrorObservable.notifyObservers({message:e,exception:t})},this._options={...Si._GetDefaultOptions(t),...e},this._scene=t,this.onErrorObservable=new C.cP,this._setupBackground(),this._setupImageProcessing()}updateOptions(e){const t={...this._options,...e};this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new M.ov(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof b.t)return void(this._scene.environmentTexture=this._options.environmentTexture);const e=hi.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new At("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,t=this._options.skyboxSize,i=this._options.rootPosition;if(!this._scene.meshes||1===this._scene.meshes.length)return{groundSize:e,skyboxSize:t,rootPosition:i};const s=this._scene.getWorldExtends((e=>e!==this._ground&&e!==this._rootMesh&&e!==this._skybox)),r=s.max.subtract(s.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof oi&&this._scene.activeCamera.upperRadiusLimit&&(e=2*this._scene.activeCamera.upperRadiusLimit,t=e);const n=r.length();n>e&&(e=2*n,t=e),e*=1.1,t*=1.5,i=s.min.add(r.scale(.5)),i.y=s.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:i}}_setupGround(e){this._ground&&!this._ground.isDisposed()||(this._ground=_i("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.isPickable=!1,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add((()=>{this._ground=null}))),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new ui("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){this._groundMaterial&&(this._groundTexture||(this._options.groundTexture instanceof b.t?this._groundMaterial.diffuseTexture=this._options.groundTexture:(this._groundTexture=new G.g(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture)))}_setupGroundMirrorTexture(e){const t=G.g.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new li("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,G.g.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new si.Z(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(let e=0;e<this._scene.meshes.length;e++){const t=this._scene.meshes[e];t!==this._ground&&t!==this._skybox&&t!==this._rootMesh&&this._groundMirror.renderList.push(t)}const i=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new M.ov(i.r,i.g,i.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){this._skybox&&!this._skybox.isDisposed()||(this._skybox=xi("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:At.BACKSIDE},this._scene),this._skybox.isPickable=!1,this._skybox.onDisposeObservable.add((()=>{this._skybox=null}))),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new ui("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){this._skyboxMaterial&&(this._skyboxTexture||(this._options.skyboxTexture instanceof b.t?this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture:(this._skyboxTexture=new hi(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=G.g.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture)))}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}Si._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",Si._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",Si._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env";class Ti{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=ee.S0.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===ei.TB.KEYDOWN)-1===this.keysUp.indexOf(i.keyCode)&&-1===this.keysDown.indexOf(i.keyCode)&&-1===this.keysLeft.indexOf(i.keyCode)&&-1===this.keysRight.indexOf(i.keyCode)&&-1===this.keysUpward.indexOf(i.keyCode)&&-1===this.keysDownward.indexOf(i.keyCode)&&-1===this.keysRotateLeft.indexOf(i.keyCode)&&-1===this.keysRotateRight.indexOf(i.keyCode)&&-1===this.keysRotateUp.indexOf(i.keyCode)&&-1===this.keysRotateDown.indexOf(i.keyCode)||(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysUpward.indexOf(i.keyCode)||-1!==this.keysDownward.indexOf(i.keyCode)||-1!==this.keysRotateLeft.indexOf(i.keyCode)||-1!==this.keysRotateRight.indexOf(i.keyCode)||-1!==this.keysRotateUp.indexOf(i.keyCode)||-1!==this.keysRotateDown.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),e||i.preventDefault()}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(i)?e._localDirection.copyFromFloats(-s,0,0):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,0,s):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(s,0,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,0,-s):-1!==this.keysUpward.indexOf(i)?e._localDirection.copyFromFloats(0,s,0):-1!==this.keysDownward.indexOf(i)?e._localDirection.copyFromFloats(0,-s,0):-1!==this.keysRotateLeft.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):-1!==this.keysRotateRight.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):-1!==this.keysRotateUp.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):-1!==this.keysRotateDown.indexOf(i)&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),I.Pq.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}}(0,w.Cg)([(0,D.lK)()],Ti.prototype,"keysUp",void 0),(0,w.Cg)([(0,D.lK)()],Ti.prototype,"keysUpward",void 0),(0,w.Cg)([(0,D.lK)()],Ti.prototype,"keysDown",void 0),(0,w.Cg)([(0,D.lK)()],Ti.prototype,"keysDownward",void 0),(0,w.Cg)([(0,D.lK)()],Ti.prototype,"keysLeft",void 0),(0,w.Cg)([(0,D.lK)()],Ti.prototype,"keysRight",void 0),(0,w.Cg)([(0,D.lK)()],Ti.prototype,"rotationSpeed",void 0),(0,w.Cg)([(0,D.lK)()],Ti.prototype,"keysRotateLeft",void 0),(0,w.Cg)([(0,D.lK)()],Ti.prototype,"keysRotateRight",void 0),(0,w.Cg)([(0,D.lK)()],Ti.prototype,"keysRotateUp",void 0),(0,w.Cg)([(0,D.lK)()],Ti.prototype,"keysRotateDown",void 0),$t.FreeCameraKeyboardMoveInput=Ti;class yi{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new C.cP,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=ee.S0.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=s=>{const r=s.event,n="touch"===r.pointerType;if(!this.touchEnabled&&n)return;if(s.type!==Rt.Zp.POINTERMOVE&&-1===this.buttons.indexOf(r.button))return;const a=r.target;if(s.type===Rt.Zp.POINTERDOWN){if(n&&-1!==this._activePointerId||!n&&-1!==this._currentActiveButton)return;this._activePointerId=r.pointerId;try{a?.setPointerCapture(r.pointerId)}catch(e){}-1===this._currentActiveButton&&(this._currentActiveButton=r.button),this._previousPosition={x:r.clientX,y:r.clientY},e||(r.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(s.event)}else if(s.type===Rt.Zp.POINTERUP){if(n&&this._activePointerId!==r.pointerId||!n&&this._currentActiveButton!==r.button)return;try{a?.releasePointerCapture(r.pointerId)}catch(e){}this._currentActiveButton=-1,this._previousPosition=null,e||r.preventDefault(),this._activePointerId=-1}else if(s.type===Rt.Zp.POINTERMOVE&&(this._activePointerId===r.pointerId||!n))if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(s.event);else if(this._previousPosition){const t=this.camera._calculateHandednessMultiplier(),i=(r.clientX-this._previousPosition.x)*t,s=r.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=i/this.angularSensibility,this.camera.cameraRotation.x+=s/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:i,offsetY:s}),this._previousPosition={x:r.clientX,y:r.clientY},e||r.preventDefault()}}),this._onMouseMove=i=>{if(!t.isPointerLock)return;const s=this.camera._calculateHandednessMultiplier(),r=i.movementX*s;this.camera.cameraRotation.y+=r/this.angularSensibility;const n=i.movementY;this.camera.cameraRotation.x+=n/this.angularSensibility,this._previousPosition=null,e||i.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Rt.Zp.POINTERDOWN|Rt.Zp.POINTERUP|Rt.Zp.POINTERMOVE),i&&(this._contextMenuBind=e=>this.onContextMenu(e),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}(0,w.Cg)([(0,D.lK)()],yi.prototype,"buttons",void 0),(0,w.Cg)([(0,D.lK)()],yi.prototype,"angularSensibility",void 0),$t.FreeCameraMouseInput=yi;class Ci{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new C.cP,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=ee.S0.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Rt.Zp.POINTERWHEEL)return;const i=t.event,s=i.deltaMode===ri.s.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*s*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*s*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*s*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Rt.Zp.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}(0,w.Cg)([(0,D.lK)()],Ci.prototype,"wheelPrecisionX",void 0),(0,w.Cg)([(0,D.lK)()],Ci.prototype,"wheelPrecisionY",void 0),(0,w.Cg)([(0,D.lK)()],Ci.prototype,"wheelPrecisionZ",void 0),function(e){e[e.MoveRelative=0]="MoveRelative",e[e.RotateRelative=1]="RotateRelative",e[e.MoveScene=2]="MoveScene"}(ii||(ii={}));class Pi extends Ci{constructor(){super(...arguments),this._moveRelative=I.Pq.Zero(),this._rotateRelative=I.Pq.Zero(),this._moveScene=I.Pq.Zero(),this._wheelXAction=ii.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=ii.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){null===e&&this._wheelXAction!==ii.MoveRelative||(this._wheelXAction=ii.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==ii.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){null===e&&this._wheelYAction!==ii.MoveRelative||(this._wheelYAction=ii.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==ii.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){null===e&&this._wheelZAction!==ii.MoveRelative||(this._wheelZAction=ii.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==ii.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){null===e&&this._wheelXAction!==ii.RotateRelative||(this._wheelXAction=ii.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==ii.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){null===e&&this._wheelYAction!==ii.RotateRelative||(this._wheelYAction=ii.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==ii.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){null===e&&this._wheelZAction!==ii.RotateRelative||(this._wheelZAction=ii.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==ii.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){null===e&&this._wheelXAction!==ii.MoveScene||(this._wheelXAction=ii.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==ii.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){null===e&&this._wheelYAction!==ii.MoveScene||(this._wheelYAction=ii.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==ii.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){null===e&&this._wheelZAction!==ii.MoveScene||(this._wheelZAction=ii.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==ii.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=I.uq.Zero();this.camera.getViewMatrix().invertToRef(e);const t=I.Pq.Zero();I.Pq.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(0===e)return;if(null===t||null===i)return;let s=null;switch(t){case ii.MoveRelative:s=this._moveRelative;break;case ii.RotateRelative:s=this._rotateRelative;break;case ii.MoveScene:s=this._moveScene}switch(i){case 0:s.set(e,0,0);break;case 1:s.set(0,e,0);break;case 2:s.set(0,0,e)}}}(0,w.Cg)([(0,D.lK)()],Pi.prototype,"wheelXMoveRelative",null),(0,w.Cg)([(0,D.lK)()],Pi.prototype,"wheelYMoveRelative",null),(0,w.Cg)([(0,D.lK)()],Pi.prototype,"wheelZMoveRelative",null),(0,w.Cg)([(0,D.lK)()],Pi.prototype,"wheelXRotateRelative",null),(0,w.Cg)([(0,D.lK)()],Pi.prototype,"wheelYRotateRelative",null),(0,w.Cg)([(0,D.lK)()],Pi.prototype,"wheelZRotateRelative",null),(0,w.Cg)([(0,D.lK)()],Pi.prototype,"wheelXMoveScene",null),(0,w.Cg)([(0,D.lK)()],Pi.prototype,"wheelYMoveScene",null),(0,w.Cg)([(0,D.lK)()],Pi.prototype,"wheelZMoveScene",null),$t.FreeCameraMouseWheelInput=Pi;class Ei{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=ee.S0.IsSafari()}attachControl(e){e=ee.S0.BackCompatCameraNoPreventDefault(arguments);let t=null;if(void 0===this._pointerInput&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const s=i.event,r="mouse"===s.pointerType||this._isSafari&&void 0===s.pointerType;if(this.allowMouse||!r)if(i.type===Rt.Zp.POINTERDOWN){if(e||s.preventDefault(),this._pointerPressed.push(s.pointerId),1!==this._pointerPressed.length)return;t={x:s.clientX,y:s.clientY}}else if(i.type===Rt.Zp.POINTERUP){e||s.preventDefault();const i=this._pointerPressed.indexOf(s.pointerId);if(-1===i)return;if(this._pointerPressed.splice(i,1),0!=i)return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===Rt.Zp.POINTERMOVE){if(e||s.preventDefault(),!t)return;if(0!=this._pointerPressed.indexOf(s.pointerId))return;this._offsetX=s.clientX-t.x,this._offsetY=-(s.clientY-t.y)}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Rt.Zp.POINTERDOWN|Rt.Zp.POINTERUP|Rt.Zp.POINTERMOVE),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(null===this._offsetX||null===this._offsetY)return;if(0===this._offsetX&&0===this._offsetY)return;const e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&1===this._pointerPressed.length||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const t=e._computeLocalCameraSpeed(),i=new I.Pq(0,0,0!==this.touchMoveSensibility?t*this._offsetY/this.touchMoveSensibility:0);I.uq.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(I.Pq.TransformCoordinates(i,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}(0,w.Cg)([(0,D.lK)()],Ei.prototype,"touchAngularSensibility",void 0),(0,w.Cg)([(0,D.lK)()],Ei.prototype,"touchMoveSensibility",void 0),$t.FreeCameraTouchInput=Ei;class Ai extends jt{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Ti),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new yi(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new Pi,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new Ei),this}clear(){super.clear(),this._mouseInput=null}}class Ri extends qt{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new I.Pq(.5,1,.5),this.ellipsoidOffset=new I.Pq(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=I.Pq.Zero(),this._diffPosition=I.Pq.Zero(),this._newPosition=I.Pq.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,i=null)=>{this._newPosition.copyFrom(t),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>g.$.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&i&&this.onCollide(i))},this.inputs=new Ai(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=ee.S0.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new I.Pq(0,0,0),this.cameraRotation=new I.I9(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?I.Pq.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=I.Pq.Zero(),this._transformedDirection=I.Pq.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}(0,w.Cg)([(0,D.P_)()],Ri.prototype,"ellipsoid",void 0),(0,w.Cg)([(0,D.P_)()],Ri.prototype,"ellipsoidOffset",void 0),(0,w.Cg)([(0,D.lK)()],Ri.prototype,"checkCollisions",void 0),(0,w.Cg)([(0,D.lK)()],Ri.prototype,"applyGravity",void 0),(0,V.Y5)("BABYLON.FreeCamera",Ri),Ai.prototype.addDeviceOrientation=function(e){return this._deviceOrientationInput||(this._deviceOrientationInput=new Ii,e&&(this._deviceOrientationInput.smoothFactor=e),this.add(this._deviceOrientationInput)),this};class Ii{static WaitForOrientationChangeAsync(e){return new Promise(((t,i)=>{let s=!1;const r=()=>{window.removeEventListener("deviceorientation",r),s=!0,t()};e&&setTimeout((()=>{s||(window.removeEventListener("deviceorientation",r),i("WaitForOrientationChangeAsync timed out"))}),e),"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"==e?window.addEventListener("deviceorientation",r):ee.S0.Warn("Permission not granted.")})).catch((e=>{ee.S0.Error(e)})):window.addEventListener("deviceorientation",r)}))}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new I.PT,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new C.cP,this._orientationChanged=()=>{this._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-ee.S0.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=null!==e.alpha?ee.S0.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=null!==e.beta?ee.S0.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=null!==e.gamma?ee.S0.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=null!==e.alpha?e.alpha:0,this._beta=null!==e.beta?e.beta:0,this._gamma=null!==e.gamma?e.gamma:0),null!==e.alpha&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTransform=new I.PT(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,null==this._camera||this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new I.PT),this._camera&&this._camera.onDisposeObservable.add((()=>{this._onDeviceOrientationChangedObservable.clear()}))}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e?t():ee.S0.Warn("Permission not granted.")})).catch((e=>{ee.S0.Error(e)})):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(I.PT.RotationYawPitchRollToRef(ee.S0.ToRadians(this._alpha),ee.S0.ToRadians(this._beta),-ee.S0.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTransform),this._camera.getScene().useRightHandedSystem?this._camera.rotationQuaternion.y*=-1:this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}$t.FreeCameraDeviceOrientationInput=Ii,B.AddNodeConstructor("DeviceOrientationCamera",((e,t)=>()=>new Mi(e,I.Pq.Zero(),t)));class Mi extends Ri{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new I.PT,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new I.PT,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce((()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add((e=>{0!=this._dragFactor&&(this._initialQuaternion||(this._initialQuaternion=new I.PT),I.PT.FromEulerAnglesToRef(0,e.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))})))}))}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=mt._0.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new I.PT),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach((t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0})),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class Oi{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return I.uq.Translation(e,0,0)}get rightHMatrix(){const e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return I.uq.Translation(-e,0,0)}get leftPreViewMatrix(){return I.uq.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return I.uq.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new Oi;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}class wi extends W.w{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,s){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,s.postProcessScaleFactor,t,G.g.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=s.distortionK,this._postProcessScaleFactor=s.postProcessScaleFactor,this._lensCenterOffset=s.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add((()=>{this._scaleIn=new I.I9(2,2/this.aspectRatio),this._scaleFactor=new I.I9(1/this._postProcessScaleFactor*.5,1/this._postProcessScaleFactor*.5*this.aspectRatio),this._lensCenter=new I.I9(this._isRightEye?.5-.5*this._lensCenterOffset:.5+.5*this._lensCenterOffset,.5)})),this.onApplyObservable.add((e=>{e.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),e.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),e.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),e.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(r.bind(r,7811)))):t.push(Promise.resolve().then(r.bind(r,1830))),super._gatherImports(e,t)}}ae.l.ShadersStore.vrMultiviewToSingleviewPixelShader="precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}";class Di extends H.${set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}function Fi(e,t){const i=new k.D(e,void 0,!0,t);return i.addUniform("viewProjection",16),i.addUniform("viewProjectionR",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}E.prototype.createMultiviewRenderTargetTexture=function(t,i,s,r){const n=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const a=this._createHardwareRenderTargetWrapper(!1,!1,{width:t,height:i});a._framebuffer=n.createFramebuffer();const o=new e.h(this,0,!0);return o.width=t,o.height=i,o.isMultiview=!0,s||(s=n.createTexture(),n.bindTexture(n.TEXTURE_2D_ARRAY,s),n.texStorage3D(n.TEXTURE_2D_ARRAY,1,n.RGBA8,t,i,2)),a._colorTextureArray=s,r||(r=n.createTexture(),n.bindTexture(n.TEXTURE_2D_ARRAY,r),n.texStorage3D(n.TEXTURE_2D_ARRAY,1,n.DEPTH24_STENCIL8,t,i,2)),a._depthStencilTextureArray=r,o.isReady=!0,a.setTextures(o),a._depthStencilTexture=o,a},E.prototype.bindMultiviewFramebuffer=function(e){const t=e,i=this._gl,s=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw"Invalid multiview frame buffer";this.getCaps().oculusMultiview?(s.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,t.samples,0,2),s.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,t.samples,0,2)):(s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,0,2))},E.prototype.bindSpaceWarpFramebuffer=function(e){const t=e,i=this._gl,s=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw new Error("Invalid Space Warp framebuffer");s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_ATTACHMENT,t._depthStencilTextureArray,0,0,2)},se.prototype._useMultiviewToSingleView=!1,se.prototype._multiviewTexture=null,se.prototype._resizeOrCreateMultiviewTexture=function(e,t){this._multiviewTexture?this._multiviewTexture.getRenderWidth()==e&&this._multiviewTexture.getRenderHeight()==t||(this._multiviewTexture.dispose(),this._multiviewTexture=new Di(this.getScene(),{width:e,height:t})):this._multiviewTexture=new Di(this.getScene(),{width:e,height:t})};const Ni=be.Z.prototype.createSceneUniformBuffer;be.Z.prototype._transformMatrixR=I.uq.Zero(),be.Z.prototype._multiviewSceneUbo=null,be.Z.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=Fi(this.getEngine(),"scene_multiview")},be.Z.prototype.createSceneUniformBuffer=function(e){return this._multiviewSceneUbo?Fi(this.getEngine(),e):Ni.bind(this)(e)},be.Z.prototype._updateMultiviewUbo=function(e,t){e&&t&&e.multiplyToRef(t,this._transformMatrixR),e&&t&&(e.multiplyToRef(t,I.AA.Matrix[0]),ie.P.GetRightPlaneToRef(I.AA.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},be.Z.prototype._renderMultiviewToSingleView=function(e){e._resizeOrCreateMultiviewTexture(e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.width>0?e._rigPostProcess.width:this.getEngine().getRenderWidth(!0),e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.height>0?e._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),e.outputRenderTarget=e._multiviewTexture,this._renderForCamera(e),e.outputRenderTarget=null;for(let t=0;t<e._rigCameras.length;t++){const i=this.getEngine();this._activeCamera=e._rigCameras[t],i.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class Li extends W.w{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,G.g.BILINEAR_SAMPLINGMODE);const s=t??this.getCamera();this.onSizeChangedObservable.add((()=>{})),this.onApplyObservable.add((e=>{s._scene.activeCamera&&s._scene.activeCamera.isLeftCamera?e.setInt("imageIndex",0):e.setInt("imageIndex",1),e.setTexture("multiviewSampler",s._multiviewTexture)}))}}B.AddNodeConstructor("VRDeviceOrientationFreeCamera",((e,t)=>()=>new Bi(e,I.Pq.Zero(),t)));class Bi extends Mi{constructor(e,t,i,s=!0,r=Oi.GetDefault()){super(e,t,i),this._setRigMode=e=>function(e,t){const i=t.vrCameraMetrics||Oi.GetDefault();e._rigCameras[0]._cameraRigParams.vrMetrics=i,e._rigCameras[0].viewport=new te.L(0,0,.5,1),e._rigCameras[0]._cameraRigParams.vrWorkMatrix=new I.uq,e._rigCameras[0]._cameraRigParams.vrHMatrix=i.leftHMatrix,e._rigCameras[0]._cameraRigParams.vrPreViewMatrix=i.leftPreViewMatrix,e._rigCameras[0].getProjectionMatrix=e._rigCameras[0]._getVRProjectionMatrix,e._rigCameras[1]._cameraRigParams.vrMetrics=i,e._rigCameras[1].viewport=new te.L(.5,0,.5,1),e._rigCameras[1]._cameraRigParams.vrWorkMatrix=new I.uq,e._rigCameras[1]._cameraRigParams.vrHMatrix=i.rightHMatrix,e._rigCameras[1]._cameraRigParams.vrPreViewMatrix=i.rightPreViewMatrix,e._rigCameras[1].getProjectionMatrix=e._rigCameras[1]._getVRProjectionMatrix,i.multiviewEnabled&&(e.getScene().getEngine().getCaps().multiview?(e._useMultiviewToSingleView=!0,e._rigPostProcess=new Li("VRMultiviewToSingleview",e,i.postProcessScaleFactor)):(l.V.Warn("Multiview is not supported, falling back to standard rendering"),i.multiviewEnabled=!1)),i.compensateDistortion&&(e._rigCameras[0]._rigPostProcess=new wi("VR_Distort_Compensation_Left",e._rigCameras[0],!1,i),e._rigCameras[1]._rigPostProcess=new wi("VR_Distort_Compensation_Right",e._rigCameras[1],!0,i))}(this,e),r.compensateDistortion=s,this.setCameraRigMode(se.RIG_MODE_VR,{vrCameraMetrics:r})}getClassName(){return"VRDeviceOrientationFreeCamera"}}class ki{get isConnected(){return this._isConnected}constructor(e,t,i,s=0,r=1,n=2,a=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=ki.GAMEPAD,this._leftStickAxisX=s,this._leftStickAxisY=r,this._rightStickAxisX=n,this._rightStickAxisY=a,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){!this._onleftstickchanged||this._leftStick.x===e.x&&this._leftStick.y===e.y||this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){!this._onrightstickchanged||this._rightStick.x===e.x&&this._rightStick.y===e.y||this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}ki.GAMEPAD=0,ki.GENERIC=1,ki.XBOX=2,ki.POSE_ENABLED=3,ki.DUALSHOCK=4;class Vi extends ki{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new C.cP,this.onButtonUpObservable=new C.cP,this.type=ki.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}var Ui,zi,Gi,Hi,Wi,Xi,Ki=r(7309),Qi=r(7103),Yi=r(5877);class qi{constructor(e,t,i=Number.MAX_VALUE,s=ft.bH){this.origin=e,this.direction=t,this.length=i,this.epsilon=s}clone(){return new qi(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const s=qi._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),r=qi._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let n,a,o,l,h=0,c=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<s.x||this.origin.x>r.x)return!1}else if(n=1/this.direction.x,a=(s.x-this.origin.x)*n,o=(r.x-this.origin.x)*n,o===-1/0&&(o=1/0),a>o&&(l=a,a=o,o=l),h=Math.max(a,h),c=Math.min(o,c),h>c)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<s.y||this.origin.y>r.y)return!1}else if(n=1/this.direction.y,a=(s.y-this.origin.y)*n,o=(r.y-this.origin.y)*n,o===-1/0&&(o=1/0),a>o&&(l=a,a=o,o=l),h=Math.max(a,h),c=Math.min(o,c),h>c)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<s.z||this.origin.z>r.z)return!1}else if(n=1/this.direction.z,a=(s.z-this.origin.z)*n,o=(r.z-this.origin.z)*n,o===-1/0&&(o=1/0),a>o&&(l=a,a=o,o=l),h=Math.max(a,h),c=Math.min(o,c),h>c)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,s=e.center.y-this.origin.y,r=e.center.z-this.origin.z,n=i*i+s*s+r*r,a=e.radius+t,o=a*a;if(n<=o)return!0;const l=i*this.direction.x+s*this.direction.y+r*this.direction.z;return!(l<0)&&n-l*l<=o}intersectsTriangle(e,t,i){const s=qi._TmpVector3[0],r=qi._TmpVector3[1],n=qi._TmpVector3[2],a=qi._TmpVector3[3],o=qi._TmpVector3[4];t.subtractToRef(e,s),i.subtractToRef(e,r),I.Pq.CrossToRef(this.direction,r,n);const l=I.Pq.Dot(s,n);if(0===l)return null;const h=1/l;this.origin.subtractToRef(e,a);const c=I.Pq.Dot(a,n)*h;if(c<-this.epsilon||c>1+this.epsilon)return null;I.Pq.CrossToRef(a,s,o);const u=I.Pq.Dot(this.direction,o)*h;if(u<-this.epsilon||c+u>1+this.epsilon)return null;const d=I.Pq.Dot(r,o)*h;return d>this.length?null:new Qi.w(1-c-u,c,d)}intersectsPlane(e){let t;const i=I.Pq.Dot(e.normal,this.direction);if(Math.abs(i)<9.99999997475243e-7)return null;{const s=I.Pq.Dot(e.normal,this.origin);return t=(-e.d-s)/i,t<0?t<-9.99999997475243e-7?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const e=(this.origin.y-t)/this.direction.y;return e>0?null:new I.Pq(this.origin.x+this.direction.x*-e,t,this.origin.z+this.direction.z*-e)}case"x":{const e=(this.origin.x-t)/this.direction.x;return e>0?null:new I.Pq(t,this.origin.y+this.direction.y*-e,this.origin.z+this.direction.z*-e)}case"z":{const e=(this.origin.z-t)/this.direction.z;return e>0?null:new I.Pq(this.origin.x+this.direction.x*-e,this.origin.y+this.direction.y*-e,t)}default:return null}}intersectsMesh(e,t,i,s=!1,r,n=!1){const a=I.AA.Matrix[0];return e.getWorldMatrix().invertToRef(a),this._tmpRay?qi.TransformToRef(this,a,this._tmpRay):this._tmpRay=qi.Transform(this,a),e.intersects(this._tmpRay,t,i,s,r,n)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let s=0;s<e.length;s++){const r=this.intersectsMesh(e[s],t);r.hit&&i.push(r)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const s=this.origin,r=I.AA.Vector3[0],n=I.AA.Vector3[1],a=I.AA.Vector3[2],o=I.AA.Vector3[3];t.subtractToRef(e,r),this.direction.scaleToRef(qi._Rayl,a),s.addToRef(a,n),e.subtractToRef(s,o);const l=I.Pq.Dot(r,r),h=I.Pq.Dot(r,a),c=I.Pq.Dot(a,a),u=I.Pq.Dot(r,o),d=I.Pq.Dot(a,o),_=l*c-h*h;let p,f,m=_,g=_;_<qi._Smallnum?(p=0,m=1,f=d,g=c):(p=h*d-c*u,f=l*d-h*u,p<0?(p=0,f=d,g=c):p>m&&(p=m,f=d+h,g=c)),f<0?(f=0,-u<0?p=0:-u>l?p=m:(p=-u,m=l)):f>g&&(f=g,-u+h<0?p=0:-u+h>l?p=m:(p=-u+h,m=l));const v=Math.abs(p)<qi._Smallnum?0:p/m,b=Math.abs(f)<qi._Smallnum?0:f/g,x=I.AA.Vector3[4];a.scaleToRef(b,x);const S=I.AA.Vector3[5];r.scaleToRef(v,S),S.addInPlace(o);const T=I.AA.Vector3[6];return S.subtractToRef(x,T),b>0&&b<=this.length&&T.lengthSquared()<i*i?S.length():-1}update(e,t,i,s,r,n,a,o=!1){if(o){qi._RayDistant||(qi._RayDistant=qi.Zero()),qi._RayDistant.unprojectRayToRef(e,t,i,s,I.uq.IdentityReadOnly,n,a);const o=I.AA.Matrix[0];r.invertToRef(o),qi.TransformToRef(qi._RayDistant,o,this)}else this.unprojectRayToRef(e,t,i,s,r,n,a);return this}static Zero(){return new qi(I.Pq.Zero(),I.Pq.Zero())}static CreateNew(e,t,i,s,r,n,a){return qi.Zero().update(e,t,i,s,r,n,a)}static CreateNewFromTo(e,t,i=I.uq.IdentityReadOnly){const s=new qi(new I.Pq(0,0,0),new I.Pq(0,0,0));return qi.CreateFromToToRef(e,t,s,i)}static CreateFromToToRef(e,t,i,s=I.uq.IdentityReadOnly){i.origin.copyFrom(e);const r=t.subtractToRef(e,i.direction),n=Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);return i.length=n,i.direction.normalize(),qi.TransformToRef(i,s,i)}static Transform(e,t){const i=new qi(new I.Pq(0,0,0),new I.Pq(0,0,0));return qi.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){I.Pq.TransformCoordinatesToRef(e.origin,t,i.origin),I.Pq.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length,i.epsilon=e.epsilon;const s=i.direction,r=s.length();if(0!==r&&1!==r){const e=1/r;s.x*=e,s.y*=e,s.z*=e,i.length*=r}return i}unprojectRayToRef(e,i,s,r,n,a,o){const l=I.AA.Matrix[0];n.multiplyToRef(a,l),l.multiplyToRef(o,l),l.invert();const h=t.q.LastCreatedEngine,c=I.AA.Vector3[0];c.x=e/s*2-1,c.y=-(i/r*2-1),c.z=h?.useReverseDepthBuffer?1:h?.isNDCHalfZRange?0:-1;const u=I.AA.Vector3[1].copyFromFloats(c.x,c.y,1-1e-8),d=I.AA.Vector3[2],_=I.AA.Vector3[3];I.Pq._UnprojectFromInvertedMatrixToRef(c,l,d),I.Pq._UnprojectFromInvertedMatrixToRef(u,l,_),this.origin.copyFrom(d),_.subtractToRef(d,this.direction),this.direction.normalize()}}function $i(e,t,i,s,r,n=!1){const a=qi.Zero();return ji(e,t,i,s,a,r,n),a}function ji(e,t,i,s,r,n,a=!1,o=!1){const l=e.getEngine();if(!n&&!(n=e.activeCamera))return e;const h=n.viewport,c=l.getRenderHeight(),{x:u,y:d,width:_,height:p}=h.toGlobal(l.getRenderWidth(),c),f=1/l.getHardwareScalingLevel();return t=t*f-u,i=i*f-(c-d-p),r.update(t,i,_,p,s||I.uq.IdentityReadOnly,a?I.uq.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),o),e}function Zi(e,t,i,s,r){if(!_t.G)return e;const n=e.getEngine();if(!r&&!(r=e.activeCamera))throw new Error("Active camera not set");const a=r.viewport,o=n.getRenderHeight(),{x:l,y:h,width:c,height:u}=a.toGlobal(n.getRenderWidth(),o),d=I.uq.Identity(),_=1/n.getHardwareScalingLevel();return t=t*_-l,i=i*_-(o-h-u),s.update(t,i,c,u,d,d,r.getProjectionMatrix()),e}function Ji(e,t,i,s,r,n,a,o){const l=t(s,i.enableDistantPicking),h=i.intersects(l,r,a,n,s,o);return h&&h.hit?!r&&null!=e&&h.distance>=e.distance?null:h:null}function es(e,t,i,s,r,n){let a=null;const o=!!(e.activeCameras&&e.activeCameras.length>1&&e.cameraToUseForPointers!==e.activeCamera),l=e.cameraToUseForPointers||e.activeCamera;for(let h=0;h<e.meshes.length;h++){const c=e.meshes[h];if(i){if(!i(c,-1))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;const u=o&&c.isWorldMatrixCameraDependent(),d=c.computeWorldMatrix(u,l);if(c.hasThinInstances&&c.thinInstanceEnablePicking){const e=Ji(a,t,c,d,!0,!0,n);if(e){if(r)return e;const o=I.AA.Matrix[1],l=c.thinInstanceGetWorldMatrices();for(let e=0;e<l.length;e++){if(i&&!i(c,e))continue;l[e].multiplyToRef(d,o);const h=Ji(a,t,c,o,s,r,n,!0);if(h&&(a=h,a.thinInstanceIndex=e,s))return a}}}else{const e=Ji(a,t,c,d,s,r,n);if(e&&(a=e,s))return a}}return a||new _t.G}function ts(e,t,i,s){if(!_t.G)return null;const r=[],n=!!(e.activeCameras&&e.activeCameras.length>1&&e.cameraToUseForPointers!==e.activeCamera),a=e.cameraToUseForPointers||e.activeCamera;for(let o=0;o<e.meshes.length;o++){const l=e.meshes[o];if(i){if(!i(l,-1))continue}else if(!l.isEnabled()||!l.isVisible||!l.isPickable)continue;const h=n&&l.isWorldMatrixCameraDependent(),c=l.computeWorldMatrix(h,a);if(l.hasThinInstances&&l.thinInstanceEnablePicking){if(Ji(null,t,l,c,!0,!0,s)){const e=I.AA.Matrix[1],n=l.thinInstanceGetWorldMatrices();for(let a=0;a<n.length;a++){if(i&&!i(l,a))continue;n[a].multiplyToRef(c,e);const o=Ji(null,t,l,e,!1,!1,s,!0);o&&(o.thinInstanceIndex=a,r.push(o))}}}else{const e=Ji(null,t,l,c,!1,!1,s);e&&r.push(e)}}return r}function is(e,t,i=100,s,r){s||(s=e.getWorldMatrix()),t.length=i,r?t.origin.copyFrom(r):t.origin.copyFrom(e.position);const n=I.AA.Vector3[2];n.set(0,0,e._scene.useRightHandedSystem?-1:1);const a=I.AA.Vector3[3];return I.Pq.TransformNormalToRef(n,s,a),I.Pq.NormalizeToRef(a,t.direction),t}qi._TmpVector3=(0,Ki.mI)(6,I.Pq.Zero),qi._RayDistant=qi.Zero(),qi._Smallnum=1e-8,qi._Rayl=1e9,Ui=be.Z,(zi=se)&&(zi.prototype.getForwardRay=function(e=100,t,i){return is(this,new qi(I.Pq.Zero(),I.Pq.Zero(),e),e,t,i)},zi.prototype.getForwardRayToRef=function(e,t=100,i,s){return is(this,e,t,i,s)}),Ui&&(Yi.h._IsPickingAvailable=!0,Ui.prototype.createPickingRay=function(e,t,i,s,r=!1){return $i(this,e,t,i,s,r)}),be.Z.prototype.createPickingRayToRef=function(e,t,i,s,r,n=!1,a=!1){return ji(this,e,t,i,s,r,n,a)},be.Z.prototype.createPickingRayInCameraSpace=function(e,t,i){return function(e,t,i,s){const r=qi.Zero();return Zi(e,t,i,r,s),r}(this,e,t,i)},be.Z.prototype.createPickingRayInCameraSpaceToRef=function(e,t,i,s){return Zi(this,e,t,i,s)},be.Z.prototype.pickWithBoundingInfo=function(e,t,i,s,r){return function(e,t,i,s,r,n){if(!_t.G)return null;const a=es(e,(s=>(e._tempPickingRay||(e._tempPickingRay=qi.Zero()),ji(e,t,i,s,e._tempPickingRay,n||null),e._tempPickingRay)),s,r,!0);return a&&(a.ray=$i(e,t,i,I.uq.Identity(),n||null)),a}(this,e,t,i,s,r)},be.Z.prototype.pick=function(e,t,i,s,r,n,a=!1){return function(e,t,i,s,r,n,a,o=!1){const l=es(e,((s,r)=>(e._tempPickingRay||(e._tempPickingRay=qi.Zero()),ji(e,t,i,s,e._tempPickingRay,n||null,!1,r),e._tempPickingRay)),s,r,!1,a);return l&&(l.ray=$i(e,t,i,I.uq.Identity(),n||null)),l}(this,e,t,i,s,r,n,a)},be.Z.prototype.pickWithRay=function(e,t,i,s){return function(e,t,i,s,r){const n=es(e,(i=>(e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=I.uq.Identity()),i.invertToRef(e._pickWithRayInverseMatrix),e._cachedRayForTransform||(e._cachedRayForTransform=qi.Zero()),qi.TransformToRef(t,e._pickWithRayInverseMatrix,e._cachedRayForTransform),e._cachedRayForTransform)),i,s,!1,r);return n&&(n.ray=t),n}(this,e,t,i,s)},be.Z.prototype.multiPick=function(e,t,i,s,r){return function(e,t,i,s,r,n){return ts(e,(s=>$i(e,t,i,s,r||null)),s,n)}(this,e,t,i,s,r)},be.Z.prototype.multiPickWithRay=function(e,t,i){return function(e,t,i,s){return ts(e,(i=>(e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=I.uq.Identity()),i.invertToRef(e._pickWithRayInverseMatrix),e._cachedRayForTransform||(e._cachedRayForTransform=qi.Zero()),qi.TransformToRef(t,e._pickWithRayInverseMatrix,e._cachedRayForTransform),e._cachedRayForTransform)),i,s)}(this,e,t,i)},i.ThinEngine.prototype.createDynamicTexture=function(t,i,s,r){const n=new e.h(this,4);return n.baseWidth=t,n.baseHeight=i,s&&(t=this.needPOTTextures?(0,c.R)(t,this._caps.maxTextureSize):t,i=this.needPOTTextures?(0,c.R)(i,this._caps.maxTextureSize):i),n.width=t,n.height=i,n.isReady=!1,n.generateMipMaps=s,n.samplingMode=r,this.updateTextureSamplingMode(r,n),this._internalTexturesCache.push(n),n},i.ThinEngine.prototype.updateDynamicTexture=function(e,t,i,s=!1,r,n=!1,a=!1){if(!e)return;const o=this._gl,l=o.TEXTURE_2D,h=this._bindTextureDirectly(l,e,!0,n);this._unpackFlipY(void 0===i?e.invertY:i),s&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const c=this._getWebGLTextureType(e.type),u=this._getInternalFormat(r||e.format),d=this._getRGBABufferInternalSizedFormat(e.type,u);o.texImage2D(l,0,d,u,c,t),e.generateMipMaps&&o.generateMipmap(l),h||this._bindTextureDirectly(l,null),s&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),r&&(e.format=r),e._dynamicTextureSource=t,e._premulAlpha=s,e.invertY=i||!1,e.isReady=!0};class ss extends G.g{constructor(e,t,i=null,s=!1,r=3,n=5,a){super(null,i,!s,a,r,void 0,void 0,void 0,void 0,n),this.name=e,this.wrapU=G.g.CLAMP_ADDRESSMODE,this.wrapV=G.g.CLAMP_ADDRESSMODE,this._generateMipMaps=s;const o=this._getEngine();if(!o)return;t.getContext?(this._canvas=t,this._ownCanvas=!1,this._texture=o.createDynamicTexture(t.width,t.height,s,r)):(this._canvas=o.createCanvas(1,1),this._ownCanvas=!0,t.width||0===t.width?this._texture=o.createDynamicTexture(t.width,t.height,s,r):this._texture=o.createDynamicTexture(t,t,s,r));const l=this.getSize();this._canvas.width!==l.width&&(this._canvas.width=l.width),this._canvas.height!==l.height&&(this._canvas.height=l.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){const i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(e){const t=this.getSize();e&&(this._context.fillStyle=e),this._context.clearRect(0,0,t.width,t.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===e||e,t,this._format||void 0,void 0,i)}drawText(e,t,i,s,r,n,a,o=!0){const l=this.getSize();if(n&&(this._context.fillStyle=n,this._context.fillRect(0,0,l.width,l.height)),this._context.font=s,null==t){const i=this._context.measureText(e);t=(l.width-i.width)/2}if(null==i){const e=parseInt(s.replace(/\D/g,""));i=l.height/2+e/3.65}this._context.fillStyle=r||"",this._context.fillText(e,t,i),o&&this.update(a)}dispose(){super.dispose(),this._ownCanvas&&this._canvas?.remove?.(),this._canvas=null,this._context=null}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new ss(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){const e=this.getScene();e&&!e.isReady()&&l.V.Warn("The scene must be ready before serializing the dynamic texture");const t=super.serialize();return ss._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return void 0!==e.toDataURL}_rebuild(){this.update()}}!function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(Gi||(Gi={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(Hi||(Hi={}));class rs extends ki{constructor(e,t,i,s=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new C.cP,this.onButtonUpObservable=new C.cP,this.onPadDownObservable=new C.cP,this.onPadUpObservable=new C.cP,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=ki.XBOX,this._isXboxOnePad=s}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,0)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,1)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,2)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,3)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,9)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,8)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,4)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,15)}update(){super.update(),this._isXboxOnePad,this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}!function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(Wi||(Wi={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(Xi||(Xi={}));class ns extends ki{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new C.cP,this.onButtonUpObservable=new C.cP,this.onPadDownObservable=new C.cP,this.onPadUpObservable=new C.cP,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=ki.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,0)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,1)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,2)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,3)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,9)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,8)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,4)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,15)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class as{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new C.cP,(0,S.BA)()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new C.cP((e=>{for(const t in this._babylonGamepads){const i=this._babylonGamepads[t];i&&i._isConnected&&this.onGamepadConnectedObservable.notifyObserver(e,i)}})),this._onGamepadConnectedEvent=e=>{const t=e.gamepad;if(t.index in this._babylonGamepads&&this._babylonGamepads[t.index].isConnected)return;let i;this._babylonGamepads[t.index]?(i=this._babylonGamepads[t.index],i.browserGamepad=t,i._isConnected=!0):i=this._addNewGamepad(t),this.onGamepadConnectedObservable.notifyObservers(i),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=e=>{const t=e.gamepad;for(const e in this._babylonGamepads)if(this._babylonGamepads[e].index===t.index){const t=this._babylonGamepads[e];t._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(t),t.dispose&&t.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const e=this._scene?this._scene.getEngine().getHostWindow():window;e&&(e.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),e.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=ki.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach((e=>{e.dispose()})),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){let t;this._oneGamepadConnected||(this._oneGamepadConnected=!0);const i=-1!==e.id.search("054c")&&-1===e.id.search("0ce6"),s=-1!==e.id.search("Xbox One");return t=s||-1!==e.id.search("Xbox 360")||-1!==e.id.search("xinput")||-1!==e.id.search("045e")&&-1===e.id.search("Surface Dock")?new rs(e.id,e.index,e,s):i?new ns(e.id,e.index,e):new Vi(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(t&&t.isConnected)try{t.update()}catch{-1===this._loggedErrors.indexOf(t.index)&&(ee.S0.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&g.$.QueueNewFrame((()=>{this._checkGamepadsStatus()}))}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const e=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(e)}}}}class os{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=I.uq.Identity(),this._deltaTransform=I.Pq.Zero(),this._vector3=I.Pq.Zero(),this._vector2=I.I9.Zero()}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add((e=>{e.type!==ki.POSE_ENABLED&&(this.gamepad&&e.type!==ki.XBOX||(this.gamepad=e))})),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add((e=>{this.gamepad===e&&(this.gamepad=null)})),this.gamepad=e.getGamepadByType(ki.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;0!==this.gamepadMoveSensibility&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&0!==this.gamepadAngularSensibility?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):I.uq.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const s=50*e._computeLocalCameraSpeed();this._vector3.copyFromFloats(t.x*s,0,-t.y*s),I.Pq.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}(0,w.Cg)([(0,D.lK)()],os.prototype,"gamepadAngularSensibility",void 0),(0,w.Cg)([(0,D.lK)()],os.prototype,"gamepadMoveSensibility",void 0),$t.FreeCameraGamepadInput=os;class ls{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add((e=>{e.type!==ki.POSE_ENABLED&&(this.gamepad&&e.type!==ki.XBOX||(this.gamepad=e))})),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add((e=>{this.gamepad===e&&(this.gamepad=null)})),this.gamepad=e.getGamepadByType(ki.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(0!=t.x){const i=t.x/this.gamepadRotationSensibility;0!=i&&Math.abs(i)>.005&&(e.inertialAlphaOffset+=i)}if(0!=t.y){const i=t.y/this.gamepadRotationSensibility*this._yAxisScale;0!=i&&Math.abs(i)>.005&&(e.inertialBetaOffset+=i)}}const i=this.gamepad.leftStick;if(i&&0!=i.y){const e=i.y/this.gamepadMoveSensibility;0!=e&&Math.abs(e)>.005&&(this.camera.inertialRadiusOffset-=e)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}(0,w.Cg)([(0,D.lK)()],ls.prototype,"gamepadRotationSensibility",void 0),(0,w.Cg)([(0,D.lK)()],ls.prototype,"gamepadMoveSensibility",void 0),$t.ArcRotateCameraGamepadInput=ls,Object.defineProperty(be.Z.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new as(this);let e=this._getComponent(fe.v.NAME_GAMEPAD);e||(e=new hs(this),this._addComponent(e))}return this._gamepadManager},enumerable:!0,configurable:!0}),Ai.prototype.addGamepad=function(){return this.add(new os),this},ai.prototype.addGamepad=function(){return this.add(new ls),this};class hs{constructor(e){this.name=fe.v.NAME_GAMEPAD,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(fe.v.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}_beforeCameraUpdate(){const e=this.scene._gamepadManager;e&&e._isMonitoring&&e._checkGamepadsStatus()}}class cs extends B{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){(e.updateFlag!==this._localMatrix.updateFlag||this._needToCompose)&&(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,s=null,r=null,n=null,a=null){super(e,t.getScene(),!1),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=s?.clone()??I.uq.Identity(),this._restMatrix=r??this._localMatrix.clone(),this._bindMatrix=n??this._localMatrix.clone(),this._index=a,this._absoluteMatrix=new I.uq,this._absoluteBindMatrix=new I.uq,this._absoluteInverseBindMatrix=new I.uq,this._finalMatrix=new I.uq,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const e=this.parent.children.indexOf(this);-1!==e&&this.parent.children.splice(e,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){const e=I.AA.Vector3[0],t=I.AA.Quaternion[0],i=I.AA.Vector3[1];this.getRestMatrix().decompose(e,t,i),this._linkedTransformNode.position.copyFrom(i),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??I.PT.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(t),this._linkedTransformNode.scaling.copyFrom(e)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=I.Pq.Zero(),this._localRotation=I.PT.Zero(),this._localPosition=I.Pq.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){this._needToCompose&&(this._localScaling?(this._needToCompose=!1,I.uq.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)):this._needToCompose=!1)}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let e=0;e<this.children.length;e++)this.children[e]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=0,i,s=!0){const r=this.getLocalMatrix();if(0==t)s?(r.addAtIndex(12,e.x),r.addAtIndex(13,e.y),r.addAtIndex(14,e.z)):r.setTranslationFromFloats(e.x,e.y,e.z);else{let t=null;i&&(t=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=cs._TmpMats[0],a=cs._TmpVecs[0];this.parent?i&&t?(n.copyFrom(this.parent.getAbsoluteMatrix()),n.multiplyToRef(t,n)):n.copyFrom(this.parent.getAbsoluteMatrix()):I.uq.IdentityToRef(n),s&&n.setTranslationFromFloats(0,0,0),n.invert(),I.Pq.TransformCoordinatesToRef(e,n,a),s?(r.addAtIndex(12,a.x),r.addAtIndex(13,a.y),r.addAtIndex(14,a.z)):r.setTranslationFromFloats(a.x,a.y,a.z)}this._markAsDirtyAndDecompose()}translate(e,t=0,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=0,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,1,t)}scale(e,t,i,s=!1){const r=this.getLocalMatrix(),n=cs._TmpMats[0];I.uq.ScalingToRef(e,t,i,n),n.multiplyToRef(r,r),n.invert();for(const s of this.children){const r=s.getLocalMatrix();r.multiplyToRef(n,r),r.multiplyAtIndex(12,e),r.multiplyAtIndex(13,t),r.multiplyAtIndex(14,i),s._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),s)for(const r of this.children)r.scale(e,t,i,s)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,s=0,r){if(0===s){const n=cs._TmpQuat;return I.PT.RotationYawPitchRollToRef(e,t,i,n),void this.setRotationQuaternion(n,s,r)}const n=cs._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,r))return;const a=cs._TmpMats[1];I.uq.RotationYawPitchRollToRef(e,t,i,a),n.multiplyToRef(a,a),this._rotateWithMatrix(a,s,r)}rotate(e,t,i=0,s){const r=cs._TmpMats[0];r.setTranslationFromFloats(0,0,0),I.uq.RotationAxisToRef(e,t,r),this._rotateWithMatrix(r,i,s)}setAxisAngle(e,t,i=0,s){if(0===i){const r=cs._TmpQuat;return I.PT.RotationAxisToRef(e,t,r),void this.setRotationQuaternion(r,i,s)}const r=cs._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,s))return;const n=cs._TmpMats[1];I.uq.RotationAxisToRef(e,t,n),r.multiplyToRef(n,n),this._rotateWithMatrix(n,i,s)}setRotation(e,t=0,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=0,i){if(0===t)return this._decompose(),this._localRotation.copyFrom(e),void this._markAsDirtyAndCompose();const s=cs._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const r=cs._TmpMats[1];I.uq.FromQuaternionToRef(e,r),s.multiplyToRef(r,r),this._rotateWithMatrix(r,t,i)}setRotationMatrix(e,t=0,i){if(0===t){const s=cs._TmpQuat;return I.PT.FromRotationMatrixToRef(e,s),void this.setRotationQuaternion(s,t,i)}const s=cs._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const r=cs._TmpMats[1];r.copyFrom(e),s.multiplyToRef(e,r),this._rotateWithMatrix(r,t,i)}_rotateWithMatrix(e,t=0,i){const s=this.getLocalMatrix(),r=s.m[12],n=s.m[13],a=s.m[14],o=this.getParent(),l=cs._TmpMats[3],h=cs._TmpMats[4];o&&1==t?(i?(l.copyFrom(i.getWorldMatrix()),o.getAbsoluteMatrix().multiplyToRef(l,l)):l.copyFrom(o.getAbsoluteMatrix()),h.copyFrom(l),h.invert(),s.multiplyToRef(l,s),s.multiplyToRef(e,s),s.multiplyToRef(h,s)):1==t&&i?(l.copyFrom(i.getWorldMatrix()),h.copyFrom(l),h.invert(),s.multiplyToRef(l,s),s.multiplyToRef(e,s),s.multiplyToRef(h,s)):s.multiplyToRef(e,s),s.setTranslationFromFloats(r,n,a),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const i=cs._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),I.uq.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):I.uq.IdentityToRef(i),e.invert(),!isNaN(e.m[0])&&(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=0,t=null){const i=I.Pq.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=0,t,i){if(0==e){const e=this.getLocalMatrix();i.x=e.m[12],i.y=e.m[13],i.z=e.m[14]}else{let e=null;t&&(e=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let s=cs._TmpMats[0];t&&e?(s.copyFrom(this.getAbsoluteMatrix()),s.multiplyToRef(e,s)):s=this.getAbsoluteMatrix(),i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}}getAbsolutePosition(e=null){const t=I.Pq.Zero();return this.getPositionToRef(1,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(1,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const e=this._skeleton.getPoseMatrix();e&&this._absoluteMatrix.multiplyToRef(e,this._absoluteMatrix)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const i=I.Pq.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=cs._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&s&&r.multiplyToRef(s,r),I.Pq.TransformNormalToRef(e,r,i),i.normalize()}getRotation(e=0,t=null){const i=I.Pq.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=0,t=null,i){const s=cs._TmpQuat;this.getRotationQuaternionToRef(e,t,s),s.toEulerAnglesToRef(i)}getRotationQuaternion(e=0,t=null){const i=I.PT.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=0,t=null,i){if(0==e)this._decompose(),i.copyFrom(this._localRotation);else{const e=cs._TmpMats[0],s=this.getAbsoluteMatrix();t?s.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(s),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.decompose(void 0,i,void 0)}}getRotationMatrix(e=0,t){const i=I.uq.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=0,t,i){if(0==e)this.getLocalMatrix().getRotationMatrixToRef(i);else{const e=cs._TmpMats[0],s=this.getAbsoluteMatrix();t?s.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(s),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=I.Pq.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=cs._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&s&&r.multiplyToRef(s,r),I.Pq.TransformCoordinatesToRef(e,r,i)}getLocalPositionFromAbsolute(e,t=null){const i=I.Pq.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=cs._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&s&&r.multiplyToRef(s,r),r.invert(),I.Pq.TransformCoordinatesToRef(e,r,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}}cs._TmpVecs=(0,Ki.mI)(2,I.Pq.Zero),cs._TmpQuat=I.PT.Identity(),cs._TmpMats=(0,Ki.mI)(5,I.uq.Identity);class us{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,s){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=s,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===Kt.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=I.uq.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,0!==this._minFrame){const e={frame:0,value:this._minValue};this._keys.splice(0,0,e)}if(this._target instanceof Array){let e=0;for(const t of this._target)this._preparePath(t,e),this._getOriginalValues(e),e++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const r=t.getEvents();r&&r.length>0&&r.forEach((e=>{this._events.push(e._clone())})),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let s=e;for(let e=0;e<i.length-1;e++){const t=i[e];if(s=s[t],void 0===s)throw new Error(`Invalid property (${t}) in property path (${i.join(".")})`)}this._targetPath=i[i.length-1],this._activeTargets[t]=s}else this._targetPath=i[0],this._activeTargets[t]=e;if(void 0===this._activeTargets[t][this._targetPath])throw new Error(`Invalid property (${this._targetPath}) in property path (${i.join(".")})`)}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let e=0;for(const t of this._target)void 0!==this._originalValue[e]&&this._setValue(t,this._activeTargets[e],this._originalValue[e],-1,e),e++}else void 0!==this._originalValue[0]&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let e=0;e<this._events.length;e++)this._events[e].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray)for(let i=0;i<this._target.length;i++){const s=this._target[i];this._setValue(s,this._activeTargets[i],e,t,i)}else this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];t=i.getLocalMatrix&&"_matrix"===this._targetPath?i.getLocalMatrix():i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_registerTargetForLateAnimationBinding(e,t){const i=e.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[e.targetPath]||(i._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(i._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),i._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(i._lateAnimationHolders[e.targetPath].animations.push(e),i._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)}_setValue(e,t,i,s,r){if(this._currentActiveTarget=t,this._weight=s,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const e=t[this._targetPath];e.clone?this._originalBlendValue=e.clone():this._originalBlendValue=e}this._originalBlendValue.m?Kt.AllowMatrixDecomposeForInterpolation?this._currentValue?I.uq.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=I.uq.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?I.uq.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=I.uq.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=Kt._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const s=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=s}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:this._currentValue=i?.clone?i.clone():i;-1!==s?this._registerTargetForLateAnimationBinding(this,this._originalValue[r]):this._animationState.loopMode===Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[r],t[this._targetPath]):t[this._targetPath]=this._originalValue[r]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e,t=-1){const i=this._animation.getKeys();e<i[0].frame?e=i[0].frame:e>i[i.length-1].frame&&(e=i[i.length-1].frame);const s=this._events;if(s.length)for(let t=0;t<s.length;t++)s[t].onlyOnce||(s[t].isDone=s[t].frame<e);this._currentFrame=e;const r=this._animation._interpolate(e,this._animationState);this.setValue(r,t)}_prepareForSpeedRatioChange(e){const t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,s,r,n=-1){const a=this._animation,o=a.targetPropertyPath;if(!o||o.length<1)return this._stopped=!0,!1;let l=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const h=i-t;let c,u=e*(a.framePerSecond*r)/1e3+this._absoluteFrameOffset,d=0,_=!1;const p=s&&this._animationState.loopMode===Kt.ANIMATIONLOOPMODE_YOYO;if(p){const e=(u-t)/h,i=Math.sin(e*Math.PI);u=Math.abs(i)*h+t;const s=i>=0?1:-1;this._yoyoDirection!==s&&(_=!0),this._yoyoDirection=s}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=u,!s&&i>=t&&(u>=h&&r>0||u<=0&&r<0))l=!1,d=a._getKeyValue(this._maxValue);else if(!s&&t>=i&&(u<=h&&r<0||u>=0&&r>0))l=!1,d=a._getKeyValue(this._minValue);else if(this._animationState.loopMode!==Kt.ANIMATIONLOOPMODE_CYCLE){const e=i.toString()+t.toString();if(!this._offsetsCache[e]){this._animationState.repeatCount=0,this._animationState.loopMode=Kt.ANIMATIONLOOPMODE_CYCLE;const s=a._interpolate(t,this._animationState),r=a._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),a.dataType){case Kt.ANIMATIONTYPE_FLOAT:this._offsetsCache[e]=r-s;break;case Kt.ANIMATIONTYPE_QUATERNION:case Kt.ANIMATIONTYPE_VECTOR3:case Kt.ANIMATIONTYPE_VECTOR2:case Kt.ANIMATIONTYPE_SIZE:case Kt.ANIMATIONTYPE_COLOR3:this._offsetsCache[e]=r.subtract(s)}this._highLimitsCache[e]=r}d=this._highLimitsCache[e],c=this._offsetsCache[e]}if(void 0===c)switch(a.dataType){case Kt.ANIMATIONTYPE_FLOAT:c=0;break;case Kt.ANIMATIONTYPE_QUATERNION:c=Vt;break;case Kt.ANIMATIONTYPE_VECTOR3:c=Ut;break;case Kt.ANIMATIONTYPE_VECTOR2:c=zt;break;case Kt.ANIMATIONTYPE_SIZE:c=Gt;break;case Kt.ANIMATIONTYPE_COLOR3:c=Ht;break;case Kt.ANIMATIONTYPE_COLOR4:c=Wt}let f;if(this._host&&this._host.syncRoot){const e=this._host.syncRoot;f=t+h*((e.masterFrame-e.fromFrame)/(e.toFrame-e.fromFrame))}else f=u>0&&t>i||u<0&&t<i?l&&0!==h?i+u%h:t:l&&0!==h?t+u%h:i;const m=this._events;if(!p&&(r>0&&this.currentFrame>f||r<0&&this.currentFrame<f)||p&&_){this._onLoop();for(let e=0;e<m.length;e++)m[e].onlyOnce||(m[e].isDone=!1);this._animationState.key=r>0?0:a.getKeys().length-1}this._currentFrame=f,this._animationState.repeatCount=0===h?0:u/h|0,this._animationState.highLimitValue=d,this._animationState.offsetValue=c;const g=a._interpolate(f,this._animationState);if(this.setValue(g,n),m.length)for(let e=0;e<m.length;e++)if(h>=0&&f>=m[e].frame&&m[e].frame>=t||h<0&&f<=m[e].frame&&m[e].frame<=t){const t=m[e];t.isDone||(t.onlyOnce&&(m.splice(e,1),e--),t.isDone=!0,t.action(f))}return l||(this._stopped=!0),l}}class ds{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){this._weight=-1!==e?Math.min(Math.max(e,0),1):-1}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,null!==this._goToFrame&&this.goToFrame(this._goToFrame)}get elapsedTime(){return null===this._localDelayOffset?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,s=100,r=!1,n=1,a,o,l,h=!1,c=0){this.target=t,this.fromFrame=i,this.toFrame=s,this.loopAnimation=r,this.onAnimationEnd=a,this.onAnimationLoop=l,this.isAdditive=h,this.playOrder=c,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new C.cP,this.onAnimationLoopObservable=new C.cP,this._scene=e,o&&this.appendAnimations(t,o),this._speedRatio=n,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const e=this._scene._activeAnimatables.indexOf(this);e>-1&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const s=t[i],r=new us(e,s,this._scene,this);r._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(r)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){const t=this._runtimeAnimations;if(t[0]){const i=t[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??t[0].currentFrame;const s=0===this.speedRatio?0:(e-this._frameToSyncFromJump)/i*1e3/this.speedRatio;this._manualJumpDelay=-s}for(let i=0;i<t.length;i++)t[i].goToFrame(e,this._weight);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1,s=!1){if(e||t){const r=this._scene._activeAnimatables.indexOf(this);if(r>-1){const n=this._runtimeAnimations;for(let i=n.length-1;i>=0;i--){const s=n[i];e&&s.animation.name!=e||t&&!t(s.target)||(s.dispose(),n.splice(i,1))}0==n.length&&(i||this._scene._activeAnimatables.splice(r,1),s||this._raiseOnAnimationEnd())}}else{const e=this._scene._activeAnimatables.indexOf(this);if(e>-1){i||this._scene._activeAnimatables.splice(e,1);const t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].dispose();this._runtimeAnimations.length=0,s||this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise((e=>{this.onAnimationEndObservable.add((()=>{e(this)}),void 0,void 0,this,!0)}))}_animate(e){if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,0===this._weight)return!0;let t=!1;const i=this._runtimeAnimations;let s;for(s=0;s<i.length;s++){const r=i[s].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||r}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(s=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(s,1),s=0;s<i.length;s++)i[s].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}function _s(e){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return e.originalValue;let t=1;const i=I.AA.Vector3[0],s=I.AA.Vector3[1],r=I.AA.Quaternion[0];let n=0;const a=e.animations[0],o=e.originalValue;let l=1,h=!1;if(e.totalWeight<1)l=1-e.totalWeight,o.decompose(s,r,i);else{if(n=1,t=e.totalWeight,l=a.weight/t,1==l){if(!e.totalAdditiveWeight)return a.currentValue;h=!0}a.currentValue.decompose(s,r,i)}if(!h){s.scaleInPlace(l),i.scaleInPlace(l),r.scaleInPlace(l);for(let a=n;a<e.animations.length;a++){const n=e.animations[a];if(0===n.weight)continue;l=n.weight/t;const o=I.AA.Vector3[2],h=I.AA.Vector3[3],c=I.AA.Quaternion[1];n.currentValue.decompose(h,c,o),h.scaleAndAddToRef(l,s),c.scaleAndAddToRef(I.PT.Dot(r,c)>0?l:-l,r),o.scaleAndAddToRef(l,i)}r.normalize()}for(let t=0;t<e.additiveAnimations.length;t++){const n=e.additiveAnimations[t];if(0===n.weight)continue;const a=I.AA.Vector3[2],o=I.AA.Vector3[3],l=I.AA.Quaternion[1];n.currentValue.decompose(o,l,a),o.multiplyToRef(s,o),I.Pq.LerpToRef(s,o,n.weight,s),r.multiplyToRef(l,l),I.PT.SlerpToRef(r,l,n.weight,r),a.scaleAndAddToRef(n.weight,i)}const c=a?a._animationState.workValue:I.AA.Matrix[0].clone();return I.uq.ComposeToRef(s,r,i,c),c}function ps(e,t){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return t;const i=e.animations[0],s=e.originalValue;let r=t;if(0===e.totalWeight&&e.totalAdditiveWeight>0)r.copyFrom(s);else if(1===e.animations.length){if(I.PT.SlerpToRef(s,i.currentValue,Math.min(1,e.totalWeight),r),0===e.totalAdditiveWeight)return r}else if(e.animations.length>1){let i,n,a=1;if(e.totalWeight<1){const t=1-e.totalWeight;i=[],n=[],i.push(s),n.push(t)}else{if(2===e.animations.length&&(I.PT.SlerpToRef(e.animations[0].currentValue,e.animations[1].currentValue,e.animations[1].weight/e.totalWeight,t),0===e.totalAdditiveWeight))return t;i=[],n=[],a=e.totalWeight}for(let t=0;t<e.animations.length;t++){const s=e.animations[t];i.push(s.currentValue),n.push(s.weight/a)}let o=0;for(let e=0;e<i.length;)e?(o+=n[e],I.PT.SlerpToRef(r,i[e],n[e]/o,r),e++):(I.PT.SlerpToRef(i[e],i[e+1],n[e+1]/(n[e]+n[e+1]),t),r=t,o=n[e]+n[e+1],e+=2)}for(let t=0;t<e.additiveAnimations.length;t++){const i=e.additiveAnimations[t];0!==i.weight&&(r.multiplyToRef(i.currentValue,I.AA.Quaternion[0]),I.PT.SlerpToRef(r,I.AA.Quaternion[0],i.weight,r))}return r}!function(e,t){t&&(t.prototype.copyAnimationRange=function(e,t,i,s=!1,r=null){0===this.animations.length&&(this.animations.push(new Kt(this.name,"_matrix",e.animations[0].framePerSecond,Kt.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const n=e.animations[0].getRange(t);if(!n)return!1;const a=n.from,o=n.to,l=e.animations[0].getKeys(),h=e.length,c=e.getParent(),u=this.getParent(),d=s&&c&&h&&this.length&&h!==this.length,_=d&&u&&c?u.length/c.length:1,p=s&&!u&&r&&(1!==r.x||1!==r.y||1!==r.z),f=this.animations[0].getKeys();let m,g,v;for(let e=0,t=l.length;e<t;e++)m=l[e],m.frame>=a&&m.frame<=o&&(s?(v=m.value.clone(),d?(g=v.getTranslation(),v.setTranslation(g.scaleInPlace(_))):p&&r?(g=v.getTranslation(),v.setTranslation(g.multiplyInPlace(r))):v=m.value):v=m.value,f.push({frame:m.frame+i,value:v}));return this.animations[0].createRange(t,a+i,o+i),!0}),e&&(e.prototype._animate=function(e){if(!this.animationsEnabled)return;const t=s.j.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=t}this.deltaTime=void 0!==e?e:this.useConstantAnimationDeltaTime?16:(t-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=t;const i=this._activeAnimatables;if(0===i.length)return;this._animationTime+=this.deltaTime;const r=this._animationTime;for(let e=0;e<i.length;e++){const t=i[e];!t._animate(r)&&t.disposeOnEnd&&e--}!function(e){if(e._registeredForLateAnimationBindings.length){for(let t=0;t<e._registeredForLateAnimationBindings.length;t++){const i=e._registeredForLateAnimationBindings.data[t];for(const e in i._lateAnimationHolders){const t=i._lateAnimationHolders[e],s=t.animations[0],r=t.originalValue;if(null==r)continue;const n=Kt.AllowMatrixDecomposeForInterpolation&&r.m;let a=i[e];if(n)a=_s(t);else if(void 0!==r.w)a=ps(t,a||I.PT.Identity());else{let e=0,i=1;const n=s&&s._animationState.loopMode===Kt.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(t.totalWeight<1)a=n?r.clone?r.clone():r:s&&r.scale?r.scale(1-t.totalWeight):s?r*(1-t.totalWeight):r.clone?r.clone():r;else if(s){i=t.totalWeight;const o=s.weight/i;a=1!==o?s.currentValue.scale?s.currentValue.scale(o):s.currentValue*o:s.currentValue,n&&(a.addToRef?a.addToRef(r,a):a+=r),e=1}for(let s=e;s<t.animations.length;s++){const e=t.animations[s],r=e.weight/i;r&&(e.currentValue.scaleAndAddToRef?e.currentValue.scaleAndAddToRef(r,a):a+=e.currentValue*r)}for(let e=0;e<t.additiveAnimations.length;e++){const i=t.additiveAnimations[e],s=i.weight;s&&(i.currentValue.scaleAndAddToRef?i.currentValue.scaleAndAddToRef(s,a):a+=i.currentValue*s)}}i[e]=a}i._lateAnimationHolders={}}e._registeredForLateAnimationBindings.reset()}}(this)},e.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort(((e,t)=>e.playOrder-t.playOrder))},e.prototype.beginWeightedAnimation=function(e,t,i,s=1,r,n=1,a,o,l,h,c=!1){const u=this.beginAnimation(e,t,i,r,n,a,o,!1,l,h,c);return u.weight=s,u},e.prototype.beginAnimation=function(e,t,i,s,r=1,n,a,o=!0,l,h,c=!1){if(r<0){const e=t;t=i,i=e,r=-r}t>i&&(r=-r),o&&this.stopAnimation(e,void 0,l),a||(a=new ds(this,e,t,i,s,r,n,void 0,h,c));const u=!l||l(e);if(e.animations&&u&&a.appendAnimations(e,e.animations),e.getAnimatables){const c=e.getAnimatables();for(let e=0;e<c.length;e++)this.beginAnimation(c[e],t,i,s,r,n,a,o,l,h)}return a.reset(),a},e.prototype.beginHierarchyAnimation=function(e,t,i,s,r,n=1,a,o,l=!0,h,c,u=!1){const d=e.getDescendants(t),_=[];_.push(this.beginAnimation(e,i,s,r,n,a,o,l,h,void 0,u));for(const e of d)_.push(this.beginAnimation(e,i,s,r,n,a,o,l,h,void 0,u));return _},e.prototype.beginDirectAnimation=function(e,t,i,s,r,n=1,a,o,l=!1){if(n<0){const e=i;i=s,s=e,n=-n}return i>s&&(n=-n),new ds(this,e,i,s,r,n,a,t,o,l)},e.prototype.beginDirectHierarchyAnimation=function(e,t,i,s,r,n,a,o,l,h=!1){const c=e.getDescendants(t),u=[];u.push(this.beginDirectAnimation(e,i,s,r,n,a,o,l,h));for(const e of c)u.push(this.beginDirectAnimation(e,i,s,r,n,a,o,l,h));return u},e.prototype.getAnimatableByTarget=function(e){for(let t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},e.prototype.getAllAnimatablesByTarget=function(e){const t=[];for(let i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i].target===e&&t.push(this._activeAnimatables[i]);return t},e.prototype.stopAnimation=function(e,t,i){const s=this.getAllAnimatablesByTarget(e);for(const e of s)e.stop(t,i)},e.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const e of this.animationGroups)e.stop()})}(be.Z,cs);class fs{get isFixedFoveationSupported(){return"XRWebGLLayer"==this.layerType&&"number"==typeof this.layer.fixedFoveation}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}createRenderTargetTextureProvider(e){return this._rttWrapper=this._createRenderTargetTextureProvider(e),this._rttWrapper}dispose(){this._rttWrapper&&(this._rttWrapper.dispose(),this._rttWrapper=null)}constructor(e,t,i,s,r){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=s,this._createRenderTargetTextureProvider=r,this._rttWrapper=null}}class ms{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(t,i){const s=new e.h(this._engine,0,!0);return s.width=t.width,s.height=t.height,s._hardwareTexture=new h.d(i,this._engine._gl),s.isReady=!0,s}_createRenderTargetTexture(e,t,i,s,r,n){if(!this._engine)throw new Error("Engine is disposed");const a={width:e,height:t},o=n?new Di(this._scene,a):new H.$("XR renderTargetTexture",a,this._scene),l=o.renderTarget;if(l._samples=o.samples,!i&&s||(l._framebuffer=i),s)if(n)l._colorTextureArray=s;else{const e=this._createInternalTexture(a,s);l.setTexture(e,0),o._texture=e}return r&&(n?l._depthStencilTextureArray=r:l._depthStencilTexture=this._createInternalTexture(a,r)),o.disableRescaling(),this._renderTargetTextures.push(o),o}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach((e=>e.dispose())),this._renderTargetTextures.length=0}}class gs extends fs{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new vs(e.scene,this))),this.layer=e}}class vs extends ms{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){const i=this._layer.getViewport(t);if(!i)return!1;const s=this._framebufferDimensions.framebufferWidth,r=this._framebufferDimensions.framebufferHeight;return e.x=i.x/s,e.y=i.y/r,e.width=i.width/s,e.height=i.height/r,!0}getRenderTargetTextureForEye(e){const t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,s=this._layer.framebuffer;return this._rtt&&t===this._framebufferDimensions.framebufferWidth&&i===this._framebufferDimensions.framebufferHeight&&s===this._framebuffer||(this._rtt=this._createRenderTargetTexture(t,i,s),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=s),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class bs{static GetDefaults(e){const t=new bs;return t.canvasOptions={antialias:!0,depth:!0,stencil:!e||e.isStencilEnable,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class xs{constructor(e,t=bs.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new C.cP,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce((()=>{this._engine=null})),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{const e=document.createElement("canvas");e.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(e)}e.onXRSessionInit.add((()=>{this._addCanvas()})),e.onXRSessionEnded.add((()=>{this._removeCanvas()})),this._makeCanvasCompatibleAsync()}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null)}_makeCanvasCompatibleAsync(){this._canvasCompatiblePromise=new Promise(((e,t)=>{try{this.canvasContext&&this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then((()=>{e()}),(()=>{ee.S0.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly."),e()})):e()}catch(e){t(e)}}))}async initializeXRLayerAsync(e){const t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new gs(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this._canvasCompatiblePromise.then((()=>{}),(()=>{})).then((()=>t()))}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce((()=>{this._setCanvasSize(!0)}))}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){this._canvas&&this._engine&&(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class Ss extends fs{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new Ts(e,this))),this.layer=e}}class Ts extends ms{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class ys{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class Cs{get worldScalingFactor(){return this._worldScalingFactor}set worldScalingFactor(e){const t=this._worldScalingFactor;this._worldScalingFactor=e,this.onWorldScaleFactorChangedObservable.notifyObservers({previousScaleFactor:t,newScaleFactor:e})}constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new C.cP,this.onXRReferenceSpaceChanged=new C.cP,this.onXRSessionEnded=new C.cP,this.onXRSessionInit=new C.cP,this.onXRReferenceSpaceInitialized=new C.cP,this.onXRReady=new C.cP,this.inXRFrameLoop=!1,this.inXRSession=!1,this._worldScalingFactor=1,this.onWorldScaleFactorChangedObservable=new C.cP(void 0,!0),this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce((()=>{this._engine=null})),e.onDisposeObservable.addOnce((()=>{this.dispose()}))}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),this.onWorldScaleFactorChangedObservable.clear(),this._engine?.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}async exitXRAsync(){if(this.session&&this.inXRSession){this.inXRSession=!1;try{return await this.session.end()}catch{l.V.Warn("Could not end XR session.")}}return Promise.resolve()}trySetViewportForView(e,t){return this._baseLayerRTTProvider?.trySetViewportForView(e,t)||!1}getRenderTargetTextureForEye(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForEye(e)||null}getRenderTargetTextureForView(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForView(e)||null}getWebXRRenderTarget(e){const t=this.scene.getEngine();return this._xrNavigator.xr.native?new ys(this):((e=e||bs.GetDefaults(t)).canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new xs(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then((t=>(this.session=t,this._sessionMode=e,this.inXRSession=!0,this.onXRSessionInit.notifyObservers(t),this.session.addEventListener("end",(()=>{this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null}),{once:!0}),this.session)))}isSessionSupportedAsync(e){return Cs.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){this.inXRSession&&this._engine&&(this._engine.customAnimationFrameRequester={requestAnimationFrame:e=>this.session.requestAnimationFrame(e),renderFunction:(e,t)=>{if(this.inXRSession&&this._engine&&(this.currentFrame=t,this.currentTimestamp=e,t)){this.inXRFrameLoop=!0;const e=this._baseLayerRTTProvider?.getFramebufferDimensions()||null;this._engine.framebufferDimensionsObject!==e&&(this._engine.framebufferDimensionsObject=e),this.onXRFrameObservable.notifyObservers(t),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1}}},this._engine.framebufferDimensionsObject=this._baseLayerRTTProvider?.getFramebufferDimensions()||null,this.onXRFrameObservable.addOnce((()=>{this.onXRReady.notifyObservers(this)})),"undefined"!=typeof window&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then((e=>e),(e=>(l.V.Error("XR.requestReferenceSpace failed for the following reason: "),l.V.Error(e),l.V.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then((e=>{const t=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return e.getOffsetReferenceSpace(t)}),(e=>{throw l.V.Error(e),'XR initialization failed: required "viewer" reference space type not supported.'}))))).then((e=>this.session.requestReferenceSpace("viewer").then((t=>(this.viewerReferenceSpace=t,e))))).then((e=>(this.referenceSpace=this.baseReferenceSpace=e,this.onXRReferenceSpaceInitialized.notifyObservers(e),this.referenceSpace)))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerWrapper=e,this._baseLayerRTTProvider=this._baseLayerWrapper?.createRenderTargetTextureProvider(this)||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new Ss(e.baseLayer):new gs(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);const t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then((e=>{const t=void 0===e||e;return Promise.resolve(t)})).catch((e=>(l.V.Warn(e),Promise.resolve(!1)))):Promise.resolve(!1)}get isNative(){return this._xrNavigator.xr.native??!1}get currentFrameRate(){return this.session?.frameRate}get supportedFrameRates(){return this.session?.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():!this.inXRSession&&t||this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){return this._baseLayerWrapper?.isFixedFoveationSupported||!1}get fixedFoveation(){return this._baseLayerWrapper?.fixedFoveation||null}set fixedFoveation(e){const t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}get enabledFeatures(){return this.session?.enabledFeatures??null}}function Ps(e){const t=[],i=[],s=[],r=[],n=e.diameter||1,a=e.thickness||.5,o=0|(e.tessellation||16),l=0===e.sideOrientation?0:e.sideOrientation||at.DEFAULTSIDE,h=o+1;for(let e=0;e<=o;e++){const l=e/o,c=e*Math.PI*2/o-Math.PI/2,u=I.uq.Translation(n/2,0,0).multiply(I.uq.RotationY(c));for(let n=0;n<=o;n++){const c=1-n/o,d=n*Math.PI*2/o+Math.PI,_=Math.cos(d),p=Math.sin(d);let f=new I.Pq(_,p,0),m=f.scale(a/2);const g=new I.I9(l,c);m=I.Pq.TransformCoordinates(m,u),f=I.Pq.TransformNormal(f,u),i.push(m.x,m.y,m.z),s.push(f.x,f.y,f.z),r.push(g.x,ht.rX?1-g.y:g.y);const v=(e+1)%h,b=(n+1)%h;t.push(e*h+n),t.push(e*h+b),t.push(v*h+n),t.push(e*h+b),t.push(v*h+b),t.push(v*h+n)}}at._ComputeSides(l,i,t,s,r,e.frontUVs,e.backUVs);const c=new at;return c.indices=t,c.positions=i,c.normals=s,c.uvs=r,c}function Es(e,t={},i){const s=new At(e,i);return t.sideOrientation=At._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Ps(t).applyToMesh(s,t.updatable),s}at.CreateTorus=Ps,At.CreateTorus=(e,t,i,s,r,n,a)=>Es(e,{diameter:t,thickness:i,tessellation:s,sideOrientation:a,updatable:n},r);class As{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=As._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=Es("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const t=new Oe("targetMat",e);t.specularColor=M.v9.Black(),t.emissiveColor=new M.v9(.7,.7,.7),t.backFaceCulling=!1,this._gazeTracker.material=t}}_getForwardRay(e){return new qi(I.Pq.Zero(),new I.Pq(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}As._IdCounter=0;class Rs extends As{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new qi(I.Pq.Zero(),I.Pq.Forward())}}class Is{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(e,t={}){if(this.webVROptions=t,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new C.cP,this.onAfterEnteringVRObservable=new C.cP,this.onExitingVRObservable=new C.cP,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=Is.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new I.Pq(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new I.Pq(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new M.v9(.2,.2,1),this._pickedGazeColor=new M.v9(0,0,1),this.onNewMeshSelected=new C.cP,this.onNewMeshPicked=new C.cP,this.onBeforeCameraTeleport=new C.cP,this.onAfterCameraTeleport=new C.cP,this.onSelectedMeshUnselected=new C.cP,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=e=>{e.type!==ki.POSE_ENABLED&&(e.leftStick&&e.onleftstickchanged((e=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(e,this._cameraGazer),this._checkTeleportBackwards(e,this._cameraGazer))})),e.rightStick&&e.onrightstickchanged((e=>{this._teleportationInitialized&&this._checkRotate(e,this._cameraGazer)})),e.type===ki.XBOX&&(e.onbuttondown((e=>{this._interactionsEnabled&&0===e&&this._cameraGazer._selectionPointerDown()})),e.onbuttonup((e=>{this._interactionsEnabled&&0===e&&this._cameraGazer._selectionPointerUp()}))))},this._workingVector=I.Pq.Zero(),this._workingQuaternion=I.PT.Identity(),this._workingMatrix=I.uq.Identity(),l.V.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),"getVRDisplays"in navigator||void 0!==t.useXR||(t.useXR=!0),void 0===t.createFallbackVRDeviceOrientationFreeCamera&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),void 0===t.createDeviceOrientationCamera&&(t.createDeviceOrientationCamera=!0),void 0===t.laserToggle&&(t.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new I.Pq(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new Mi("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof qt&&this._scene.activeCamera.rotation)){const e=this._scene.activeCamera;e.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(e.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(I.PT.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z)),this._deviceOrientationCamera.rotation=e.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?Cs.IsSessionSupportedAsync("immersive-vr").then((i=>{i?(l.V.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then((t=>{this.xr=t,this.xrTestDone=!0,this._cameraGazer=new Rs((()=>this.xr.baseExperience.camera),e),this.xr.baseExperience.onStateChangedObservable.add((e=>{switch(e){case 0:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case 1:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case 2:this._hasEnteredVR=!0;break;case 3:this._hasEnteredVR=!1}}))}))):this._completeVRInit(e,t)})):this._completeVRInit(e,t)}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new Bi("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new Rs((()=>this.currentVRCamera),e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let e=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";e+=".babylonVRicon.vrdisplaypresenting { display: none; }";const t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",(()=>{this.isInVRMode||this.enterVR()}));const i=this._scene.getEngine().getHostWindow();i&&(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=e=>{27===e.keyCode&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add((()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())}),Rt.Zp.POINTERDOUBLETAP,!1),e.onDisposeObservable.add((()=>{this.dispose()})),this._updateButtonVisibility(),this._circleEase=new wt,this._circleEase.setEasingMode(Ot.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add((t=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&"mouse"===t.event.pointerType&&(t.type===Rt.Zp.POINTERDOWN?this._cameraGazer._selectionPointerDown():t.type===Rt.Zp.POINTERUP&&this._cameraGazer._selectionPointerUp())})),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&2===this.xr.baseExperience.state||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){this._useCustomVRButton||this._btnVRDisplayed||!this._btnVR||(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){this._btnVR&&!this._useCustomVRButton&&(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr)this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);else{if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){l.V.Warn("Error in your custom logic onEnteringVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=I.PT.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce((()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})}))),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}}exitVR(){if(this.xr)this.xr.baseExperience.exitXRAsync();else if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){l.V.Warn("Error in your custom logic onExitingVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr)return void(2===this.xr.baseExperience.state&&this.xr.pointerSelection.attach());this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>!!(this._isTeleportationFloor(e)||-1===e.name.indexOf("gazeTracker")&&-1===e.name.indexOf("teleportationTarget")&&-1===e.name.indexOf("torusTeleportation"))&&this.raySelectionPredicate(e),this._interactionsEnabled=!0}}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!(!this._floorMeshName||e.name!==this._floorMeshName)}addFloorMesh(e){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e))}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const t=this._floorMeshesCollection.indexOf(e);-1!==t&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const t=e.floorMeshes||[];if(!t.length){const i=this._scene.getMeshByName(e.floorMeshName);i&&t.push(i)}if(this.xr)return t.forEach((e=>{this.xr.teleportation.addFloorMesh(e)})),void(this.xr.teleportation.attached||this.xr.teleportation.attach());if(!this.xrTestDone){const t=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(t),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};return void this._scene.registerBeforeRender(t)}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),void 0!==e.easingFunction&&(this._teleportationEasing=e.easingFunction);const t=new Se.p;t.vignetteColor=new M.ov(0,0,0,0),t.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(e,t){this._teleportationRequestInitiated&&!t._teleportationRequestInitiated||(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){t._teleportationRequestInitiated||(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;const e=I.PT.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),i=this.currentVRCamera.position;e.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,I.PT.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),I.Pq.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const s=new qi(i,this._workingVector),r=this._scene.pickWithRay(s,this._raySelectionPredicate);r&&r.pickedPoint&&r.pickedMesh&&this._isTeleportationFloor(r.pickedMesh)&&r.distance<5&&this.teleportCamera(r.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}_createTeleportationCircles(){this._teleportationTarget=vi("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=new ss("DynamicTexture",512,this._scene,!0);e.hasAlpha=!0;const t=e.getContext();t.beginPath(),t.arc(256,256,200,0,2*Math.PI,!1),t.fillStyle=this._teleportationFillColor,t.fill(),t.lineWidth=10,t.strokeStyle=this._teleportationBorderColor,t.stroke(),t.closePath(),e.update();const i=new Oe("TextPlaneMaterial",this._scene);i.diffuseTexture=e,this._teleportationTarget.material=i;const s=Es("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);s.isPickable=!1,s.parent=this._teleportationTarget;const r=new Kt("animationInnerCircle","position.y",30,Kt.ANIMATIONTYPE_FLOAT,Kt.ANIMATIONLOOPMODE_CYCLE),n=[];n.push({frame:0,value:0}),n.push({frame:30,value:.4}),n.push({frame:60,value:0}),r.setKeys(n);const a=new Ft;a.setEasingMode(Ot.EASINGMODE_EASEINOUT),r.setEasingFunction(a),s.animations=[],s.animations.push(r),this._scene.beginAnimation(s,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof Ri))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const t=I.PT.FromRotationMatrix(I.uq.RotationY(Math.PI/4*this._rotationAngle)),i=new Kt("animationRotation","rotationQuaternion",90,Kt.ANIMATIONTYPE_QUATERNION,Kt.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),s.push({frame:6,value:t}),i.setKeys(s),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];const r=new Kt("animationPP","vignetteWeight",90,Kt.ANIMATIONTYPE_FLOAT,Kt.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:0}),n.push({frame:3,value:4}),n.push({frame:6,value:0}),r.setKeys(n),r.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(r);const a=new Kt("animationPP2","vignetteStretch",90,Kt.ANIMATIONTYPE_FLOAT,Kt.ANIMATIONLOOPMODE_CONSTANT),o=[];o.push({frame:0,value:0}),o.push({frame:3,value:10}),o.push({frame:6,value:0}),a.setKeys(o),a.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(a),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(e){if(!(this.currentVRCamera instanceof Ri))return;let t,i;if(this._workingVector.copyFrom(e),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector),this._teleportationMode==Is.TELEPORTATIONMODE_CONSTANTSPEED){i=90;const e=I.Pq.Distance(this.currentVRCamera.position,this._workingVector);t=this._teleportationSpeed/e}else i=Math.round(90*this._teleportationTime/1e3),t=1;this.currentVRCamera.animations=[];const s=new Kt("animationCameraTeleportation","position",90,Kt.ANIMATIONTYPE_VECTOR3,Kt.ANIMATIONLOOPMODE_CONSTANT),r=[{frame:0,value:this.currentVRCamera.position},{frame:i,value:this._workingVector}];s.setKeys(r),s.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(s),this._postProcessMove.animations=[];const n=Math.round(i/2),a=new Kt("animationPP","vignetteWeight",90,Kt.ANIMATIONTYPE_FLOAT,Kt.ANIMATIONLOOPMODE_CONSTANT),o=[];o.push({frame:0,value:0}),o.push({frame:n,value:8}),o.push({frame:i,value:0}),a.setKeys(o),this._postProcessMove.animations.push(a);const l=new Kt("animationPP2","vignetteStretch",90,Kt.ANIMATIONTYPE_FLOAT,Kt.ANIMATIONLOOPMODE_CONSTANT),h=[];h.push({frame:0,value:0}),h.push({frame:n,value:10}),h.push({frame:i,value:0}),l.setKeys(h),this._postProcessMove.animations.push(l),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,i,!1,t,(()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)})),this._hideTeleportationTarget()}setLaserColor(e,t=this._pickedLaserColor){this._pickedLaserColor=t}setLaserLightingState(e=!0){}setGazeColor(e,t=this._pickedGazeColor){this._pickedGazeColor=t}changeLaserColor(e){this.updateControllerLaserColor}changeGazeColor(e){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=e)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}Is.TELEPORTATIONMODE_CONSTANTTIME=0,Is.TELEPORTATIONMODE_CONSTANTSPEED=1,r(994),r(504),r(788);class Ms extends Ri{constructor(e,t,i){super(e,I.Pq.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=I.PT.Identity(),this._referencedPosition=new I.Pq,this._trackingState=0,this.onXRCameraInitializedObservable=new C.cP,this.onBeforeCameraTeleport=new C.cP,this.onAfterCameraTeleport=new C.cP,this.onTrackingStateChanged=new C.cP,this.compensateOnFirstFrame=!0,this._rotate180=new I.PT(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new I.PT,this.cameraRigMode=se.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add((()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame,this._xrSessionManager.onWorldScaleFactorChangedObservable.add((()=>{this._xrSessionManager.currentFrame&&this._updateDepthNearFar()}))})),this._xrSessionManager.onXRFrameObservable.add((()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()}),void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y*this._xrSessionManager.worldScalingFactor:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new te.L(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new te.L(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){e&&e!==this&&(e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,I.PT.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace())}getClassName(){return"WebXRCamera"}setTarget(e){const t=I.AA.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();const i=Math.atan2(t.x,t.z);this.rotationQuaternion.toEulerAnglesToRef(t),I.PT.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0}_updateDepthNearFar(){const e=(this.maxZ||1e4)*this._xrSessionManager.worldScalingFactor,t={depthFar:e,depthNear:this.minZ};this._xrSessionManager.updateRenderState(t),this._cache.minZ=this.minZ,this._cache.maxZ=e}_updateFromXRSession(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e)return void this._setTrackingState(0);const t=e.emulatedPosition?1:2;if(this._setTrackingState(t),this.minZ===this._cache.minZ&&this.maxZ===this._cache.maxZ||this._updateDepthNearFar(),e.transform){const t=e.transform.orientation;if(void 0===e.transform.orientation.x)return;const i=e.transform.position;this._referencedPosition.set(i.x,i.y,i.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._referenceQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach(((e,t)=>{const i=this.rigCameras[t];i.isLeftCamera||i.isRightCamera||("right"===e.eye?i._isRightCamera=!0:"left"===e.eye&&(i._isLeftCamera=!0));const s=this.getScene().customRenderTargets;for(let e=0;e<s.length;e++){const t=s[e];-1===i.customRenderTargets.indexOf(t)&&i.customRenderTargets.push(t)}const r=e.transform.position,n=e.transform.orientation;i.parent=this.parent,i.position.set(r.x,r.y,r.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),i.rotationQuaternion.set(n.x,n.y,n.z,n.w),this._scene.useRightHandedSystem?i.rotationQuaternion.multiplyInPlace(this._rotate180):(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1),I.uq.FromFloat32ArrayToRefScaled(e.projectionMatrix,0,1,i._projectionMatrix),this._scene.useRightHandedSystem||i._projectionMatrix.toggleProjectionMatrixHandInPlace();const a=2*Math.atan2(1,e.projectionMatrix[5]);i.fov=a,0===t&&(this.fov=a,this._projectionMatrix.copyFrom(i._projectionMatrix));const o=this._xrSessionManager.getRenderTargetTextureForView(e);this._renderingMultiview=o?._texture?.isMultiview||!1,this._renderingMultiview?0==t&&(this._xrSessionManager.trySetViewportForView(this.viewport,e),this.outputRenderTarget=o):(this._xrSessionManager.trySetViewportForView(i.viewport,e),i.outputRenderTarget=o||this._xrSessionManager.getRenderTargetTextureForView(e)),i.layerMask=this.layerMask}))}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const e=new qt("XR-RigCamera: "+this.rigCameras.length,I.Pq.Zero(),this.getScene());e.minZ=.1,e.rotationQuaternion=new I.PT,e.updateUpVectorFromRotation=!0,e.isRigCamera=!0,e.rigParent=this,e.freezeProjectionMatrix(),this.rigCameras.push(e)}for(;this.rigCameras.length>e;){const e=this.rigCameras.pop();e&&e.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=I.AA.Matrix[0],t=I.AA.Matrix[1],i=I.AA.Matrix[2];I.uq.ComposeToRef(Ms._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),I.uq.ComposeToRef(Ms._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const s=new XRRigidTransform({x:this._referencedPosition.x/this._xrSessionManager.worldScalingFactor,y:this._referencedPosition.y/this._xrSessionManager.worldScalingFactor,z:this._referencedPosition.z/this._xrSessionManager.worldScalingFactor},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(s)}}}Ms._ScaleReadOnly=I.Pq.One();class Os{}Os.ANCHOR_SYSTEM="xr-anchor-system",Os.BACKGROUND_REMOVER="xr-background-remover",Os.HIT_TEST="xr-hit-test",Os.MESH_DETECTION="xr-mesh-detection",Os.PHYSICS_CONTROLLERS="xr-physics-controller",Os.PLANE_DETECTION="xr-plane-detection",Os.POINTER_SELECTION="xr-controller-pointer-selection",Os.TELEPORTATION="xr-controller-teleportation",Os.FEATURE_POINTS="xr-feature-points",Os.HAND_TRACKING="xr-hand-tracking",Os.IMAGE_TRACKING="xr-image-tracking",Os.NEAR_INTERACTION="xr-near-interaction",Os.DOM_OVERLAY="xr-dom-overlay",Os.MOVEMENT="xr-controller-movement",Os.LIGHT_ESTIMATION="xr-light-estimation",Os.EYE_TRACKING="xr-eye-tracking",Os.WALKING_LOCOMOTION="xr-walking-locomotion",Os.LAYERS="xr-layers",Os.DEPTH_SENSING="xr-depth-sensing",Os.SPACE_WARP="xr-space-warp",Os.RAW_CAMERA_ACCESS="xr-raw-camera-access";class ws{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add((()=>{this.getEnabledFeatures().forEach((e=>{const t=this._features[e];!t.enabled||t.featureImplementation.attached||t.featureImplementation.disableAutoAttach||this.attachFeature(e)}))})),this._xrSessionManager.onXRSessionEnded.add((()=>{this.getEnabledFeatures().forEach((e=>{const t=this._features[e];t.enabled&&t.featureImplementation.attached&&this.detachFeature(e)}))}))}static AddWebXRFeature(e,t,i=1,s=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),s&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,s){const r=this._AvailableFeatures[e][t];if(!r)throw new Error("feature not found");return r(i,s)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&(t.featureImplementation.attach()||ee.S0.Warn(`Feature ${e} failed to attach`))}detachFeature(e){const t=this._features[e];t&&t.featureImplementation.attached&&(t.featureImplementation.detach()||ee.S0.Warn(`Feature ${e} failed to detach`))}disableFeature(e){const t="string"==typeof e?e:e.Name,i=this._features[t];return!(!i||!i.enabled||(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],0))}dispose(){this.getEnabledFeatures().forEach((e=>{this.disableFeature(e)}))}enableFeature(e,t="latest",i={},s=!0,r=!0){const n="string"==typeof e?e:e.Name;let a=0;if("string"==typeof t){if(!t)throw new Error(`Error in provided version - ${n} (${t})`);if(a="stable"===t?ws.GetStableVersionOfFeature(n):"latest"===t?ws.GetLatestVersionOfFeature(n):+t,-1===a||isNaN(a))throw new Error(`feature not found - ${n} (${t})`)}else a=t;const o=ws._ConflictingFeatures[n];if(void 0!==o&&-1!==this.getEnabledFeatures().indexOf(o))throw new Error(`Feature ${n} cannot be enabled while ${o} is enabled.`);const l=this._features[n],h=ws.ConstructFeature(n,a,this._xrSessionManager,i);if(!h)throw new Error(`feature not found - ${n}`);l&&this.disableFeature(n);const c=h();if(c.dependsOn){const e=c.dependsOn.every((e=>!!this._features[e]));if(!e)throw new Error(`Dependant features missing. Make sure the following features are enabled - ${c.dependsOn.join(", ")}`)}if(c.isCompatible())return this._features[n]={featureImplementation:c,enabled:!0,version:a,required:r},s?this._xrSessionManager.session&&!this._features[n].featureImplementation.attached&&this.attachFeature(n):this._features[n].featureImplementation.disableAutoAttach=!0,this._features[n].featureImplementation;if(r)throw new Error("required feature not compatible");return ee.S0.Warn(`Feature ${n} not compatible with the current environment/browser and was not enabled.`),c}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const t=this.getEnabledFeatures();for(const i of t){const t=this._features[i],s=t.featureImplementation.xrNativeFeatureName;if(s&&(t.required?(e.requiredFeatures=e.requiredFeatures||[],-1===e.requiredFeatures.indexOf(s)&&e.requiredFeatures.push(s)):(e.optionalFeatures=e.optionalFeatures||[],-1===e.optionalFeatures.indexOf(s)&&e.optionalFeatures.push(s))),t.featureImplementation.getXRSessionInitExtension){const i=await t.featureImplementation.getXRSessionInitExtension();e={...e,...i}}}return e}}ws._AvailableFeatures={},ws._ConflictingFeatures={[Os.TELEPORTATION]:Os.MOVEMENT,[Os.MOVEMENT]:Os.TELEPORTATION},B.AddNodeConstructor("TouchCamera",((e,t)=>()=>new Ds(e,I.Pq.Zero(),t)));class Ds extends Ri{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!e:e.allowMouse=!t}}B.AddNodeConstructor("FreeCamera",((e,t)=>()=>new Fs(e,I.Pq.Zero(),t)));class Fs extends Ds{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}se._CreateDefaultParsedCamera=(e,t)=>new Fs(e,I.Pq.Zero(),t);class Ns{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new C.cP,this.onStateChangedObservable=new C.cP,this.state=3,this.sessionManager=new Cs(e),this.camera=new Ms("webxr",e,this.sessionManager),this.featuresManager=new ws(this.sessionManager),e.onDisposeObservable.addOnce((()=>{this.dispose()}))}static CreateAsync(e){const t=new Ns(e);return t.sessionManager.initializeAsync().then((()=>(t._supported=!0,t))).catch((e=>{throw t._setState(3),t.dispose(),e}))}dispose(){this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),this._spectatorCamera?.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),s={}){if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(0),"viewer"!==t&&"local"!==t&&(s.optionalFeatures=s.optionalFeatures||[],s.optionalFeatures.push(t)),s=await this.featuresManager._extendXRSessionInitObject(s),"immersive-ar"===e&&"unbounded"!==t&&l.V.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,s),await this.sessionManager.setReferenceSpaceTypeAsync(t);const r={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};if(!this.featuresManager.getEnabledFeature(Os.LAYERS)){const e=await i.initializeXRLayerAsync(this.sessionManager.session);r.baseLayer=e}return this.sessionManager.updateRenderState(r),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!this._nonVRCamera?.inputs?.attachedToElement,this._nonVRCamera?.detachControl(),this._scene.activeCamera=this.camera,"immersive-ar"!==e?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),g.$.audioEngine?._resumeAudioContextOnStateChange(),this.sessionManager.onXRSessionEnded.addOnce((()=>{1!==this.state&&this._setState(1),this.camera.rigCameras.forEach((e=>{e.outputRenderTarget=null})),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),"immersive-ar"!==e&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(3)})),this.sessionManager.onXRFrameObservable.addOnce((()=>{this._setState(2)})),this.sessionManager}catch(e){throw l.V.Log(e),l.V.Log(e.message),this._setState(3),e}}exitXRAsync(){return 2!==this.state?Promise.resolve():(this._setState(1),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const t=1/(e?.fps?e.fps:1e3)*1e3,i=e?.preferredCameraIndex?e?.preferredCameraIndex:0,s=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=t&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[i].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[i].absoluteRotation))};if(this._spectatorMode){if(i>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const e=()=>{2===this.state?(this._spectatorCamera=new Fs("webxr-spectator",I.Pq.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new I.PT,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(s),this._scene.onAfterRenderCameraObservable.add((e=>{e===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)}))):1===this.state&&(this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=null)};this.onStateChangedObservable.add(e),e()}else this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class Ls{constructor(e,t,i=-1,s=[]){this.id=e,this.type=t,this._buttonIndex=i,this._axesIndices=s,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new C.cP,this.onButtonStateChangedObservable=new C.cP}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return 0!==this._axesIndices.length}isButton(){return-1!==this._buttonIndex}update(e){let t=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const i=e.buttons[this._buttonIndex];if(!i)return;this._currentValue!==i.value&&(this.changes.value={current:i.value,previous:this._currentValue},t=!0,this._currentValue=i.value),this._touched!==i.touched&&(this.changes.touched={current:i.touched,previous:this._touched},t=!0,this._touched=i.touched),this._pressed!==i.pressed&&(this.changes.pressed={current:i.pressed,previous:this._pressed},t=!0,this._pressed=i.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],i=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],i=!0)),t&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}Ls.BUTTON_TYPE="button",Ls.SQUEEZE_TYPE="squeeze",Ls.THUMBSTICK_TYPE="thumbstick",Ls.TOUCHPAD_TYPE="touchpad",Ls.TRIGGER_TYPE="trigger";var Bs,ks=r(655),Vs=r(8688);!function(e){e[e.Clean=0]="Clean",e[e.Stop=1]="Stop",e[e.Sync=2]="Sync",e[e.NoSync=3]="NoSync"}(Bs||(Bs={}));const Us=new C.cP,zs={};let Gs=!1;function Hs(){return zs[".babylon"]}function Ws(e){return zs[e]||(l.V.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),Hs())}function Xs(e,t,i){let s="Unable to load from "+(e.rawData?"binary data":e.url);return t?s+=`: ${t}`:i&&(s+=`: ${i}`),s}function Ks(e,t,i,s,r,n,a,o,l){const h="data:"===(c=e.url).substring(0,5)?c.substring(5):null;var c;if(e.rawData&&!a)throw"When using ArrayBufferView to load data the file extension must be provided.";const u=a?Ws(a):h?function(e){for(const t in zs){const i=zs[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return zs[t]}return Hs()}(e.url):function(e){const t=e.indexOf("?");-1!==t&&(e=e.substring(0,t));const i=e.lastIndexOf(".");return Ws(e.substring(i,e.length).toLowerCase())}(e.url);if(!u)throw new Error(`No plugin or fallback for ${a??e.url}`);if(!1===l?.[u.plugin.name]?.enabled)throw new Error(`The '${u.plugin.name}' plugin is disabled via the loader options passed to the loading operation.`);if(e.rawData&&!u.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";return(e=>{if(u.plugin.createPlugin){const t=u.plugin.createPlugin(l??{});return t instanceof Promise?(t.then(e).catch((e=>{r("Error instantiating plugin.",e)})),null):(e(t),t)}return e(u.plugin),u.plugin})((l=>{if(!l)throw`The loader plugin corresponding to the '${a}' file type has not been found. If using es6, please import the plugin you wish to use before.`;if(Us.notifyObservers(l),h&&(l.canDirectLoad&&l.canDirectLoad(e.url)||!(0,ks.f2)(e.url))){if(l.directLoad){const e=l.directLoad(t,h);e instanceof Promise?e.then((e=>{i(l,e)})).catch((e=>{r("Error in directLoad of _loadData: "+e,e)})):i(l,e)}else i(l,h);return}const c=u.isBinary,d=(e,s)=>{t.isDisposed?r("Scene has been disposed"):i(l,e,s)};let _=null,p=!1;l.onDisposeObservable?.add((()=>{p=!0,_&&(_.abort(),_=null),n()}));const f=()=>{if(p)return;const i=(e,t)=>{r(e?.statusText,t)};if(!l.loadFile&&e.rawData)throw"Plugin does not support loading ArrayBufferView.";_=l.loadFile?l.loadFile(t,e.rawData||e.file||e.url,e.rootUrl,d,s,c,i,o):t._loadFile(e.file||e.url,d,s,!0,c,i)},m=t.getEngine();let v=m.enableOfflineSupport;if(v){let i=!1;for(const s of t.disableOfflineSupportExceptionRules)if(s.test(e.url)){i=!0;break}v=!i}v&&g.$.OfflineProviderFactory?t.offlineProvider=g.$.OfflineProviderFactory(e.url,f,m.disableManifestCheck):f()}))}function Qs(e,t){let i,s,r=null,n=null;if(t)if(t.name)i=`file:${t.name}`,s=t.name,r=t;else if(ArrayBuffer.isView(t))i="",s=(0,Vs.z)(),n=t;else if(t.startsWith("data:"))i=t,s="";else if(e){const r=t;if("/"===r.substring(0,1))return ee.S0.Error("Wrong sceneFilename parameter"),null;i=e+r,s=r}else i=t,s=ee.S0.GetFilename(t),e=ee.S0.GetFolderPath(t);else i=e,s=ee.S0.GetFilename(e),e=ee.S0.GetFolderPath(e);return{url:i,rootUrl:e,name:s,file:r,rawData:n}}function Ys(e){if("string"==typeof e.extensions){const t=e.extensions;zs[t.toLowerCase()]={plugin:e,isBinary:!1}}else{const t=e.extensions;Object.keys(t).forEach((i=>{zs[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}}))}}function qs(e,i,s="",r=t.q.LastCreatedScene,n=null,a=null,o=null,h=null,c="",u={}){if(!r)return l.V.Error("No scene available to import mesh to"),null;const d=Qs(i,s);if(!d)return null;const _={};r.addPendingData(_);const p=()=>{r.removePendingData(_)},f=(e,t)=>{const i=Xs(d,e,t);o?o(r,i,new st.bu(i,st.tG.SceneLoaderError,t)):l.V.Error(i),p()},m=a?e=>{try{a(e)}catch(e){f("Error in onProgress callback: "+e,e)}}:void 0,g=(e,t,i,s,a,o,l,h)=>{if(r.importedMeshesFiles.push(d.url),n)try{n(e,t,i,s,a,o,l,h)}catch(e){f("Error in onSuccess callback: "+e,e)}r.removePendingData(_)};return Ks(d,r,((t,i,s)=>{if(t.rewriteRootURL&&(d.rootUrl=t.rewriteRootURL(d.rootUrl,s)),t.importMesh){const s=[],n=[],a=[];if(!t.importMesh(e,r,i,d.rootUrl,s,n,a,f))return;r.loadingPluginName=t.name,g(s,n,a,[],[],[],[],[])}else t.importMeshAsync(e,r,i,d.rootUrl,m,d.name).then((e=>{r.loadingPluginName=t.name,g(e.meshes,e.particleSystems,e.skeletons,e.animationGroups,e.transformNodes,e.geometries,e.lights,e.spriteManagers)})).catch((e=>{f(e.message,e)}))}),m,f,p,h,c,u)}function $s(e,i="",s=t.q.LastCreatedEngine,r=null,n=null,a=null,o=null,l="",h={}){return s?js(e,i,new be.Z(s),r,n,a,o,l,h):(ee.S0.Error("No engine available"),null)}function js(e,i="",s=t.q.LastCreatedScene,r=null,n=null,a=null,o=null,h="",c={}){if(!s)return l.V.Error("No scene available to append to"),null;const u=Qs(e,i);if(!u)return null;const d={};s.addPendingData(d);const _=()=>{s.removePendingData(d)};ot.ShowLoadingScreen&&!Gs&&(Gs=!0,s.getEngine().displayLoadingUI(),s.executeWhenReady((()=>{s.getEngine().hideLoadingUI(),Gs=!1})));const p=(e,t)=>{const i=Xs(u,e,t);a?a(s,i,new st.bu(i,st.tG.SceneLoaderError,t)):l.V.Error(i),_()},f=n?e=>{try{n(e)}catch(e){p("Error in onProgress callback",e)}}:void 0,m=()=>{if(r)try{r(s)}catch(e){p("Error in onSuccess callback",e)}s.removePendingData(d)};return Ks(u,s,((e,t)=>{if(e.load){if(!e.load(s,t,u.rootUrl,p))return;s.loadingPluginName=e.name,m()}else e.loadAsync(s,t,u.rootUrl,f,u.name).then((()=>{s.loadingPluginName=e.name,m()})).catch((e=>{p(e.message,e)}))}),f,p,_,o,h,c)}function Zs(e,i="",s=t.q.LastCreatedScene,r=null,n=null,a=null,o=null,h="",c={}){if(!s)return l.V.Error("No scene available to load asset container to"),null;const u=Qs(e,i);if(!u)return null;const d={};s.addPendingData(d);const _=()=>{s.removePendingData(d)},p=(e,t)=>{const i=Xs(u,e,t);a?a(s,i,new st.bu(i,st.tG.SceneLoaderError,t)):l.V.Error(i),_()},f=n?e=>{try{n(e)}catch(e){p("Error in onProgress callback",e)}}:void 0,m=e=>{if(r)try{r(e)}catch(e){p("Error in onSuccess callback",e)}s.removePendingData(d)};return Ks(u,s,((e,t)=>{if(e.loadAssetContainer){const i=e.loadAssetContainer(s,t,u.rootUrl,p);if(!i)return;i.populateRootNodes(),s.loadingPluginName=e.name,m(i)}else e.loadAssetContainerAsync?e.loadAssetContainerAsync(s,t,u.rootUrl,f,u.name).then((t=>{t.populateRootNodes(),s.loadingPluginName=e.name,m(t)})).catch((e=>{p(e.message,e)})):p("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")}),f,p,_,o,h,c)}function Js(e,i="",s=t.q.LastCreatedScene,r=!0,n=0,a=null,o=null,h=null,c=null,u=null,d="",_={}){if(!s)return void l.V.Error("No scene available to load animations to");if(r){for(const e of s.animatables)e.reset();s.stopAllAnimations(),s.animationGroups.slice().forEach((e=>{e.dispose()})),s.getNodes().forEach((e=>{e.animations&&(e.animations=[])}))}else switch(n){case 0:s.animationGroups.slice().forEach((e=>{e.dispose()}));break;case 1:s.animationGroups.forEach((e=>{e.stop()}));break;case 2:s.animationGroups.forEach((e=>{e.reset(),e.restart()}));break;case 3:break;default:return void l.V.Error("Unknown animation group loading mode value '"+n+"'")}const p=s.animatables.length;Zs(e,i,s,(e=>{e.mergeAnimationsTo(s,s.animatables.slice(p),a),e.dispose(),s.onAnimationFileImportedObservable.notifyObservers(s),o&&o(s)}),h,c,u,d,_)}class er{static get ForceFullSceneLoadingForIncremental(){return ot.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){ot.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return ot.ShowLoadingScreen}static set ShowLoadingScreen(e){ot.ShowLoadingScreen=e}static get loggingLevel(){return ot.loggingLevel}static set loggingLevel(e){ot.loggingLevel=e}static get CleanBoneMatrixWeights(){return ot.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){ot.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return Hs()}static GetPluginForExtension(e){return Ws(e)?.plugin}static IsPluginForExtensionAvailable(e){return function(e){return!!zs[e]}(e)}static RegisterPlugin(e){Ys(e)}static ImportMesh(e,t,i,s,r,n,a,o,l){return qs(e,t,i,s,r,n,a,o,l)}static ImportMeshAsync(e,t,i,s,r,n,a){return function(e,t,i,s,r,n,a,o){return new Promise(((o,l)=>{qs(e,t,i,s,((e,t,i,s,r,n,a,l)=>{o({meshes:e,particleSystems:t,skeletons:i,animationGroups:s,transformNodes:r,geometries:n,lights:a,spriteManagers:l})}),r,((e,t,i)=>{l(i||new Error(t))}),n,a,undefined)}))}(e,t,i,s,r,n,a)}static Load(e,t,i,s,r,n,a,o){return $s(e,t,i,s,r,n,a,o)}static LoadAsync(e,t,i,s,r,n){return function(e,t,i,s,r,n,a){return new Promise(((o,l)=>{$s(e,t,i,(e=>{o(e)}),s,((e,t,i)=>{l(i||new Error(t))}),r,n,a)}))}(e,t,i,s,r,n)}static Append(e,t,i,s,r,n,a,o){return js(e,t,i,s,r,n,a,o)}static AppendAsync(e,t,i,s,r,n){return function(e,t,i,s,r,n,a){return new Promise(((o,l)=>{js(e,t,i,(e=>{o(e)}),s,((e,t,i)=>{l(i||new Error(t))}),r,n,a)}))}(e,t,i,s,r,n)}static LoadAssetContainer(e,t,i,s,r,n,a,o){return Zs(e,t,i,s,r,n,a,o)}static LoadAssetContainerAsync(e,t,i,s,r,n){return function(e,t,i,s,r,n,a){return new Promise(((o,l)=>{Zs(e,t,i,(e=>{o(e)}),s,((e,t,i)=>{l(i||new Error(t))}),r,n,a)}))}(e,t,i,s,r,n)}static ImportAnimations(e,t,i,s,r,n,a,o,l,h,c){Js(e,t,i,s,r,n,a,o,l,h,c)}static ImportAnimationsAsync(e,t,i,s,r,n,a,o,l,h,c){return function(e,t,i,s,r,n,a,o,l,h){return new Promise(((c,u)=>{Js(e,t,i,s,r,n,(e=>{c(e)}),a,((e,t,i)=>{u(i||new Error(t))}),o,l,h)}))}(e,t,i,s,r,n,o,h,c)}}er.NO_LOGGING=0,er.MINIMAL_LOGGING=1,er.SUMMARY_LOGGING=2,er.DETAILED_LOGGING=3,er.OnPluginActivatedObservable=Us;class tr{constructor(e,t,i,s,r=!1,n){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=s,this._doNotLoadControllerMesh=r,this._controllerCache=n,this._initComponent=e=>{if(!e)return;const t=this.layout.components[e],i=t.type,s=t.gamepadIndices.button,r=[];void 0!==t.gamepadIndices.xAxis&&void 0!==t.gamepadIndices.yAxis&&r.push(t.gamepadIndices.xAxis,t.gamepadIndices.yAxis),this.components[e]=new Ls(e,i,s,r)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new C.cP,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach((e=>this.getComponent(e).dispose())),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach((e=>{e.setEnabled(!1)})),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache))}getAllComponentsOfType(e){return this.getComponentIds().map((e=>this.components[e])).filter((t=>t.type===e))}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const e=!this._getModelLoadingConstraints();let t=this._getGenericFilenameAndPath();return e?l.V.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),new Promise(((i,s)=>{const r=t=>{e?this._getGenericParentMesh(t):this._setRootMesh(t),this._processLoadedModel(t),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){const e=this._controllerCache.filter((e=>e.filename===t.filename&&e.path===t.path));if(e[0])return e[0].meshes.forEach((e=>e.setEnabled(!0))),void r(e[0].meshes)}er.ImportMesh("",t.path,t.filename,this.scene,(e=>{this._controllerCache&&this._controllerCache.push({...t,meshes:e}),r(e)}),null,((e,i)=>{l.V.Log(i),l.V.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),s(i)}))}))}updateFromXRFrame(e){this.getComponentIds().forEach((e=>this.getComponent(e).update(this.gamepadObject))),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren((e=>e.name===t),!1)[0]}_getImmediateChildByName(e,t){return e.getChildren((e=>e.name==t),!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh)return;if(!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;const s=i?.5*t+.5:t;I.PT.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,s,e.valueMesh.rotationQuaternion),I.Pq.LerpToRef(e.minMesh.position,e.maxMesh.position,s,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new At(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.parent||(e.isPickable=!1,e.setParent(this.rootMesh))})),this.rootMesh.rotationQuaternion=I.PT.FromEulerAngles(0,Math.PI,0)}}class ir extends tr{constructor(e,t,i){super(e,sr[i],t,i),this.profileId=ir.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new At(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.isPickable=!1,e.parent||e.setParent(this.rootMesh)})),this.rootMesh.rotationQuaternion=I.PT.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}ir.ProfileId="generic-trigger";const sr={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};function rr(e){const t=0|(e.segments||32),i=e.diameterX||e.diameter||1,s=e.diameterY||e.diameter||1,r=e.diameterZ||e.diameter||1,n=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,a=e.slice&&e.slice<=0?1:e.slice||1,o=0===e.sideOrientation?0:e.sideOrientation||at.DEFAULTSIDE,l=!!e.dedupTopBottomIndices,h=new I.Pq(i/2,s/2,r/2),c=2+t,u=2*c,d=[],_=[],p=[],f=[];for(let e=0;e<=c;e++){const t=e/c,i=t*Math.PI*a;for(let e=0;e<=u;e++){const s=e/u,r=s*Math.PI*2*n,a=I.uq.RotationZ(-i),o=I.uq.RotationY(r),l=I.Pq.TransformCoordinates(I.Pq.Up(),a),c=I.Pq.TransformCoordinates(l,o),d=c.multiply(h),m=c.divide(h).normalize();_.push(d.x,d.y,d.z),p.push(m.x,m.y,m.z),f.push(s,ht.rX?1-t:t)}if(e>0){const t=_.length/3;for(let i=t-2*(u+1);i+u+2<t;i++)l?(e>1&&(d.push(i),d.push(i+1),d.push(i+u+1)),(e<c||a<1)&&(d.push(i+u+1),d.push(i+1),d.push(i+u+2))):(d.push(i),d.push(i+1),d.push(i+u+1),d.push(i+u+1),d.push(i+1),d.push(i+u+2))}}at._ComputeSides(o,_,d,p,f,e.frontUVs,e.backUVs);const m=new at;return m.indices=d,m.positions=_,m.normals=p,m.uvs=f,m}function nr(e,t={},i=null){const s=new At(e,i);return t.sideOrientation=At._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,rr(t).applyToMesh(s,t.updatable),s}at.CreateSphere=rr,At.CreateSphere=(e,t,i,s,r,n)=>nr(e,{segments:t,diameterX:i,diameterY:i,diameterZ:i,sideOrientation:n,updatable:r},s);class ar extends tr{constructor(e,t,i,s,r){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,r),this._repositoryUrl=s,this.controllerCache=r,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach((e=>{this._touchDots[e].dispose()}))}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=er.IsPluginForExtensionAvailable(".glb");return e||l.V.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach((e=>{const t=this.layout.components[e];this._buttonMeshMapping[e]={mainMesh:this._getChildByName(this.rootMesh,t.rootNodeName),states:{}},Object.keys(t.visualResponses).forEach((i=>{const s=t.visualResponses[i];if("transform"===s.valueNodeProperty)this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,s.valueNodeName),minMesh:this._getChildByName(this.rootMesh,s.minNodeName),maxMesh:this._getChildByName(this.rootMesh,s.maxNodeName)};else{const r=t.type===Ls.TOUCHPAD_TYPE&&t.touchPointNodeName?t.touchPointNodeName:s.valueNodeName;if(this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,r)},t.type===Ls.TOUCHPAD_TYPE&&!this._touchDots[i]){const t=nr(i+"dot",{diameter:.0015,segments:8},this.scene);t.material=new Oe(i+"mat",this.scene),t.material.diffuseColor=M.v9.Red(),t.parent=this._buttonMeshMapping[e].states[i].valueMesh||null,t.isVisible=!1,this._touchDots[i]=t}}}))}))}_setRootMesh(e){let t;this.rootMesh=new At(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){const s=e[i];s.isPickable=!1,s.parent||(t=s)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(mt._0.Y,Math.PI,1)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach((e=>{const t=this.getComponent(e);if(!t.hasChanges)return;const i=this._buttonMeshMapping[e],s=this.layout.components[e];Object.keys(s.visualResponses).forEach((e=>{const r=s.visualResponses[e];let n=t.value;if("xAxis"===r.componentProperty?n=t.axes.x:"yAxis"===r.componentProperty&&(n=t.axes.y),"transform"===r.valueNodeProperty)this._lerpTransform(i.states[e],n,"button"!==r.componentProperty);else{const s=i.states[e].valueMesh;s&&(s.isVisible=t.touched||t.pressed),this._touchDots[e]&&(this._touchDots[e].isVisible=t.touched||t.pressed)}}))}))}}const or=[];class lr{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(e){const t=this._Fallbacks[e]||[];return t.unshift(e),t}static GetMotionControllerWithXRInput(e,t,i){const s=[];i&&s.push(i),s.push(...e.profiles||[]),s.length&&!s[0]&&s.pop(),e.gamepad&&e.gamepad.id&&e.gamepad.id===(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0)&&s.push("oculus-touch-v2");const r=s.indexOf("windows-mixed-reality");if(-1!==r&&s.splice(r,0,"microsoft-mixed-reality"),s.length||s.push("generic-trigger"),this.UseOnlineRepository){const i=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,r=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return i.call(this,s,e,t).catch((()=>r.call(this,s,e,t)))}return this._LoadProfilesFromAvailableControllers(s,e,t)}static RegisterController(e,t){this._AvailableControllers[e]=t}static RegisterFallbacksForProfileId(e,t){this._Fallbacks[e]?this._Fallbacks[e].push(...t):this._Fallbacks[e]=t}static UpdateProfilesList(){return this._ProfilesList=ee.S0.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then((e=>JSON.parse(e))),this._ProfilesList}static ClearControllerCache(){or.forEach((e=>{e.meshes.forEach((e=>{e.dispose(!1,!0)}))})),or.length=0}static _LoadProfileFromRepository(e,t,i){return Promise.resolve().then((()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList())).then((t=>{for(let i=0;i<e.length;++i)if(e[i]&&t[e[i]])return e[i];throw new Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)})).then((e=>(this._ProfileLoadingPromises[e]||(this._ProfileLoadingPromises[e]=ee.S0.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${e}/profile.json`,!1).then((e=>JSON.parse(e)))),this._ProfileLoadingPromises[e]))).then((e=>new ar(i,t,e,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:or)))}static _LoadProfilesFromAvailableControllers(e,t,i){for(let s=0;s<e.length;++s){if(!e[s])continue;const r=this.FindFallbackWithProfileId(e[s]);for(let e=0;e<r.length;++e){const s=this._AvailableControllers[r[e]];if(s)return Promise.resolve(s(t,i))}}throw new Error("no controller requested was found in the available controllers list")}}lr._AvailableControllers={},lr._Fallbacks={},lr._ProfileLoadingPromises={},lr.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",lr.PrioritizeOnlineRepository=!0,lr.UseOnlineRepository=!0,lr.DisableControllerCache=!0,lr.RegisterController(ir.ProfileId,((e,t)=>new ir(t,e.gamepad,e.handedness))),lr.DefaultFallbacks();let hr=0;class cr{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new I.Pq,this._disposed=!1,this.onDisposeObservable=new C.cP,this.onMeshLoadedObservable=new C.cP,this.onMotionControllerInitObservable=new C.cP,this._uniqueId=`controller-${hr++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new At(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new I.PT,this.inputSource.gripSpace&&(this.grip=new At(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new I.PT),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&"tracked-pointer"===this.inputSource.targetRayMode&&lr.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then((e=>{this.motionController=e,this.onMotionControllerInitObservable.notifyObservers(e),this._options.doNotLoadControllerMesh||this.motionController._doNotLoadControllerMesh||this.motionController.loadModel().then((e=>{e&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach((e=>e.renderingGroupId=this._options.renderingGroupId))),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&this.motionController?.dispose()}))}),(()=>{ee.S0.Warn("Could not find a matching motion controller for the registered input source")}))}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){const i=t&&this.grip?this.grip:this.pointer;I.Pq.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i,s){const r=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=r,r){const e=r.transform.position;this.pointer.position.set(e.x,e.y,e.z).scaleInPlace(s.worldScalingFactor);const t=r.transform.orientation;this.pointer.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent,this.pointer.scaling.setAll(s.worldScalingFactor)}if(this.inputSource.gripSpace&&this.grip){const r=e.getPose(this.inputSource.gripSpace,t);if(r){const e=r.transform.position,t=r.transform.orientation;this.grip.position.set(e.x,e.y,e.z).scaleInPlace(s.worldScalingFactor),this.grip.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent,this.grip.scaling.setAll(s.worldScalingFactor)}this.motionController&&this.motionController.updateFromXRFrame(e)}}class ur{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new C.cP,this.onControllerRemovedObservable=new C.cP,this._onInputSourcesChange=e=>{this._addAndRemoveControllers(e.added,e.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add((()=>{this._addAndRemoveControllers([],this.controllers.map((e=>e.inputSource)))})),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add((e=>{e.addEventListener("inputsourceschange",this._onInputSourcesChange)})),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add((e=>{this.controllers.forEach((t=>{t.updateFromXRFrame(e,this.xrSessionManager.referenceSpace,this.xrCamera,this.xrSessionManager)}))})),this._options.customControllersRepositoryURL&&(lr.BaseRepositoryUrl=this._options.customControllersRepositoryURL),lr.UseOnlineRepository=!this._options.disableOnlineControllerRepository,lr.UseOnlineRepository)try{lr.UpdateProfilesList().catch((()=>{lr.UseOnlineRepository=!1}))}catch(e){lr.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){const i=this.controllers.map((e=>e.inputSource));for(const t of e)if(-1===i.indexOf(t)){const e=new cr(this.xrSessionManager.scene,t,{...this._options.controllerOptions||{},forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation});this.controllers.push(e),this.onControllerAddedObservable.notifyObservers(e)}const s=[],r=[];this.controllers.forEach((e=>{-1===t.indexOf(e.inputSource)?s.push(e):r.push(e)})),this.controllers=s,r.forEach((e=>{this.onControllerRemovedObservable.notifyObservers(e),e.dispose()}))}dispose(){this.controllers.forEach((e=>{e.dispose()})),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),lr.ClearControllerCache()}}function dr(e){const t=e.height||2;let i=0===e.diameterTop?0:e.diameterTop||e.diameter||1,s=0===e.diameterBottom?0:e.diameterBottom||e.diameter||1;i=i||1e-5,s=s||1e-5;const r=0|(e.tessellation||24),n=0|(e.subdivisions||1),a=!!e.hasRings,o=!!e.enclose,l=0===e.cap?0:e.cap||At.CAP_ALL,h=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,c=0===e.sideOrientation?0:e.sideOrientation||at.DEFAULTSIDE,u=e.faceUV||new Array(3),d=e.faceColors,_=2+(1+(1!==h&&o?2:0))*(a?n:1);let p;for(p=0;p<_;p++)d&&void 0===d[p]&&(d[p]=new M.ov(1,1,1,1));for(p=0;p<_;p++)u&&void 0===u[p]&&(u[p]=new I.IU(0,0,1,1));const f=[],m=[],g=[],v=[],b=[],x=2*Math.PI*h/r;let S,T,y;const C=(s-i)/2/t,P=I.Pq.Zero(),E=I.Pq.Zero(),A=I.Pq.Zero(),R=I.Pq.Zero(),O=I.Pq.Zero(),w=mt._0.Y;let D,F,N,L=1,B=1,k=0,V=0;for(D=0;D<=n;D++)for(T=D/n,y=(T*(i-s)+s)/2,L=a&&0!==D&&D!==n?2:1,N=0;N<L;N++){for(a&&(B+=N),o&&(B+=2*N),F=0;F<=r;F++)S=F*x,P.x=Math.cos(-S)*y,P.y=-t/2+T*t,P.z=Math.sin(-S)*y,0===i&&D===n?(E.x=g[g.length-3*(r+1)],E.y=g[g.length-3*(r+1)+1],E.z=g[g.length-3*(r+1)+2]):(E.x=P.x,E.z=P.z,E.y=Math.sqrt(E.x*E.x+E.z*E.z)*C,E.normalize()),0===F&&(A.copyFrom(P),R.copyFrom(E)),m.push(P.x,P.y,P.z),g.push(E.x,E.y,E.z),V=a?k!==B?u[B].y:u[B].w:u[B].y+(u[B].w-u[B].y)*T,v.push(u[B].x+(u[B].z-u[B].x)*F/r,ht.rX?1-V:V),d&&b.push(d[B].r,d[B].g,d[B].b,d[B].a);1!==h&&o&&(m.push(P.x,P.y,P.z),m.push(0,P.y,0),m.push(0,P.y,0),m.push(A.x,A.y,A.z),I.Pq.CrossToRef(w,E,O),O.normalize(),g.push(O.x,O.y,O.z,O.x,O.y,O.z),I.Pq.CrossToRef(R,w,O),O.normalize(),g.push(O.x,O.y,O.z,O.x,O.y,O.z),V=a?k!==B?u[B+1].y:u[B+1].w:u[B+1].y+(u[B+1].w-u[B+1].y)*T,v.push(u[B+1].x,ht.rX?1-V:V),v.push(u[B+1].z,ht.rX?1-V:V),V=a?k!==B?u[B+2].y:u[B+2].w:u[B+2].y+(u[B+2].w-u[B+2].y)*T,v.push(u[B+2].x,ht.rX?1-V:V),v.push(u[B+2].z,ht.rX?1-V:V),d&&(b.push(d[B+1].r,d[B+1].g,d[B+1].b,d[B+1].a),b.push(d[B+1].r,d[B+1].g,d[B+1].b,d[B+1].a),b.push(d[B+2].r,d[B+2].g,d[B+2].b,d[B+2].a),b.push(d[B+2].r,d[B+2].g,d[B+2].b,d[B+2].a))),k!==B&&(k=B)}const U=1!==h&&o?r+4:r;for(D=0,B=0;B<n;B++){let e=0,t=0,i=0,s=0;for(F=0;F<r;F++)e=D*(U+1)+F,t=(D+1)*(U+1)+F,i=D*(U+1)+(F+1),s=(D+1)*(U+1)+(F+1),f.push(e,t,i),f.push(s,i,t);1!==h&&o&&(f.push(e+2,t+2,i+2),f.push(s+2,i+2,t+2),f.push(e+4,t+4,i+4),f.push(s+4,i+4,t+4)),D=a?D+2:D+1}const z=e=>{const n=e?i/2:s/2;if(0===n)return;let a,o,l;const c=e?u[_-1]:u[0];let p=null;d&&(p=e?d[_-1]:d[0]);const x=m.length/3,S=e?t/2:-t/2,T=new I.Pq(0,S,0);m.push(T.x,T.y,T.z),g.push(0,e?1:-1,0);const y=c.y+.5*(c.w-c.y);v.push(c.x+.5*(c.z-c.x),ht.rX?1-y:y),p&&b.push(p.r,p.g,p.b,p.a);const C=new I.I9(.5,.5);for(l=0;l<=r;l++){a=2*Math.PI*l*h/r;const t=Math.cos(-a),i=Math.sin(-a);o=new I.Pq(t*n,S,i*n);const s=new I.I9(t*C.x+.5,i*C.y+.5);m.push(o.x,o.y,o.z),g.push(0,e?1:-1,0);const u=c.y+(c.w-c.y)*s.y;v.push(c.x+(c.z-c.x)*s.x,ht.rX?1-u:u),p&&b.push(p.r,p.g,p.b,p.a)}for(l=0;l<r;l++)e?(f.push(x),f.push(x+(l+2)),f.push(x+(l+1))):(f.push(x),f.push(x+(l+1)),f.push(x+(l+2)))};l!==At.CAP_START&&l!==At.CAP_ALL||z(!1),l!==At.CAP_END&&l!==At.CAP_ALL||z(!0),at._ComputeSides(c,m,f,g,v,e.frontUVs,e.backUVs);const G=new at;return G.indices=f,G.positions=m,G.normals=g,G.uvs=v,d&&(G.colors=b),G}function _r(e,t={},i){const s=new At(e,i);return t.sideOrientation=At._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,dr(t).applyToMesh(s,t.updatable),s}at.CreateCylinder=dr,At.CreateCylinder=(e,t,i,s,r,n,a,o,l)=>(void 0!==a&&a instanceof be.Z||(void 0!==a&&(l=o||At.DEFAULTSIDE,o=a),a=n,n=1),_r(e,{height:t,diameterTop:i,diameterBottom:s,tessellation:r,subdivisions:n,sideOrientation:l,updatable:o},a));class pr{get xrNativeFeatureName(){return this._xrNativeFeatureName}set xrNativeFeatureName(e){!this._xrSessionManager.isNative&&e&&this._xrSessionManager.inXRSession&&-1===this._xrSessionManager.enabledFeatures?.indexOf(e)&&l.V.Warn(`The feature ${e} needs to be enabled before starting the XR session. Note - It is still possible it is not supported.`),this._xrNativeFeatureName=e}constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this._xrNativeFeatureName="",this.onFeatureAttachObservable=new C.cP,this.onFeatureDetachObservable=new C.cP}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;if(this._xrSessionManager.enabledFeatures){if(!this._xrSessionManager.isNative&&this.xrNativeFeatureName&&-1===this._xrSessionManager.enabledFeatures.indexOf(this.xrNativeFeatureName))return!1}else l.V.Warn("session.enabledFeatures is not available on this device. It is possible that this feature is not supported.");return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,(e=>this._onXRFrame(e))),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach((e=>{e.observable.remove(e.observer)})),this.onFeatureDetachObservable.notifyObservers(this),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t,i){this._removeOnDetach.push({observable:e,observer:e.add(t,void 0,i)})}}class fr{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return t=this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new je("shared gizmo light",new I.Pq(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=M.v9.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return null==fr._DefaultUtilityLayer?fr._CreateDefaultUtilityLayerFromScene(t.q.LastCreatedScene):fr._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return fr._DefaultUtilityLayer=new fr(e),fr._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{fr._DefaultUtilityLayer=null})),fr._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return null==fr._DefaultKeepDepthUtilityLayer&&(fr._DefaultKeepDepthUtilityLayer=new fr(t.q.LastCreatedScene),fr._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,fr._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{fr._DefaultKeepDepthUtilityLayer=null}))),fr._DefaultKeepDepthUtilityLayer}constructor(e,t=!0){this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new C.cP,this.utilityLayerScene=new be.Z(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add((t=>{if(!this.utilityLayerScene.activeCamera)return;if(!this.pickingEnabled)return;if(!this.processAllEvents&&t.type!==Rt.Zp.POINTERMOVE&&t.type!==Rt.Zp.POINTERUP&&t.type!==Rt.Zp.POINTERDOWN&&t.type!==Rt.Zp.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const i=t.event;if(e.isPointerCaptured(i.pointerId))return void(this._pointerCaptures[i.pointerId]=!1);const s=i=>{let s=null;if(t.nearInteractionPickingInfo)s=t.nearInteractionPickingInfo.pickedMesh.getScene()==i?t.nearInteractionPickingInfo:new _t.G;else if(i!==this.utilityLayerScene&&t.originalPickingInfo)s=t.originalPickingInfo;else{let r=null;this._renderCamera&&(r=i._activeCamera,i._activeCamera=this._renderCamera,t.ray=null),s=t.ray?i.pickWithRay(t.ray):i.pick(e.pointerX,e.pointerY),r&&(i._activeCamera=r)}return s},r=s(this.utilityLayerScene);if(!t.ray&&r&&(t.ray=r.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(t),this.onlyCheckPointerDownEvents&&t.type!=Rt.Zp.POINTERDOWN)return t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Rt.mx(t.type,t.event,r),t.type),void(t.type===Rt.Zp.POINTERUP&&this._pointerCaptures[i.pointerId]&&(this._pointerCaptures[i.pointerId]=!1));if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)r&&r.hit&&(t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Rt.mx(t.type,t.event,r),t.type),t.skipOnPointerObservable=!0);else{const i=s(e),n=t.event;i&&r&&(0===r.distance&&i.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,n),t.skipOnPointerObservable=!0):t.type===Rt.Zp.POINTERDOWN?this._pointerCaptures[n.pointerId]=!0:t.type!==Rt.Zp.POINTERMOVE&&t.type!==Rt.Zp.POINTERUP||(this._lastPointerEvents[n.pointerId]&&(this.onPointerOutObservable.notifyObservers(n.pointerId),delete this._lastPointerEvents[n.pointerId]),this._notifyObservers(t,i,n)):!this._pointerCaptures[n.pointerId]&&(r.distance<i.distance||0===i.distance)?(this._notifyObservers(t,r,n),t.skipOnPointerObservable||(t.skipOnPointerObservable=r.distance>0)):!this._pointerCaptures[n.pointerId]&&r.distance>=i.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,n),t.skipOnPointerObservable=!0):(t.type!==Rt.Zp.POINTERMOVE&&t.type!==Rt.Zp.POINTERUP||this._lastPointerEvents[n.pointerId]&&(this.onPointerOutObservable.notifyObservers(n.pointerId),delete this._lastPointerEvents[n.pointerId]),this._notifyObservers(t,r,n))),t.type===Rt.Zp.POINTERUP&&this._pointerCaptures[n.pointerId]&&(this._pointerCaptures[n.pointerId]=!1))}})),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add((e=>{this.shouldRender&&e==this.getRenderCamera()&&this.render()})),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add((()=>{this.dispose()})),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new Rt.mx(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}fr._DefaultUtilityLayer=null,fr._DefaultKeepDepthUtilityLayer=null;class mr extends pr{constructor(e,t){super(e),this._options=t,this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(this._options.forceGripIfAvailable&&e.grip?e.grip:e.pointer);switch(this._controllers[e.uniqueId]={xrController:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new qi(new I.Pq,new I.Pq),disabledByNearInteraction:!1,id:mr._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(e);case"gaze":return this._attachGazeMode(e);case"screen":case"transient-pointer":return this._attachScreenRayMode(e)}},this._controllers={},this._tmpVectorForPickCompare=new I.Pq,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new M.v9(.9,.9,.9),this.laserPointerDefaultColor=new M.v9(.7,.7,.7),this.selectionMeshDefaultColor=new M.v9(.8,.8,.8),this.selectionMeshPickedColor=new M.v9(.3,.3,1),this._identityMatrix=I.uq.Identity(),this._screenCoordinatesRef=I.Pq.Zero(),this._viewportRef=new te.L(0,0,0,0),this._scene=this._xrSessionManager.scene,void 0===this._options.lookAndPickMode&&(this._scene.getEngine()._badDesktopOS||this._scene.getEngine()._badOS)&&(this._options.lookAndPickMode=!0),this._options.lookAndPickMode&&(this._options.enablePointerSelectionOnAllControllers=!0,this.displayLaserPointer=!1)}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController,!0),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)}),!0),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new qi(new I.Pq,new I.Pq),disabledByNearInteraction:!1,id:mr._IdCounter++},this._attachGazeMode()}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){const i=Object.keys(this._controllers);for(let s=0;s<i.length;++s)if(this._controllers[i[s]].id===e)return void(this._controllers[i[s]].disabledByNearInteraction=t)}_onXRFrame(e){Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e];if(this._options.lookAndPickMode&&"transient-pointer"!==t.xrController?.inputSource.targetRayMode)return;if(!this._options.enablePointerSelectionOnAllControllers&&e!==this._attachedController||t.disabledByNearInteraction)return t.selectionMesh.isVisible=!1,t.laserPointer.isVisible=!1,void(t.pick=null);let i;if(t.laserPointer.isVisible=this.displayLaserPointer,t.xrController)i=this._options.forceGripIfAvailable&&t.xrController.grip?t.xrController.grip.position:t.xrController.pointer.position,t.xrController.getWorldPointerRayToRef(t.tmpRay,this._options.forceGripIfAvailable);else{if(!t.webXRCamera)return;i=t.webXRCamera.position,t.webXRCamera.getForwardRayToRef(t.tmpRay)}if(this._options.maxPointerDistance&&(t.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&i){const e=this._xrSessionManager.scene,s=this._options.xrInput.xrCamera;s&&(s.viewport.toGlobalToRef(e.getEngine().getRenderWidth()/s.rigCameras.length,e.getEngine().getRenderHeight(),this._viewportRef),I.Pq.ProjectToRef(i,this._identityMatrix,s.getTransformationMatrix(),this._viewportRef,this._screenCoordinatesRef),"number"!=typeof this._screenCoordinatesRef.x||"number"!=typeof this._screenCoordinatesRef.y||isNaN(this._screenCoordinatesRef.x)||isNaN(this._screenCoordinatesRef.y)||this._screenCoordinatesRef.x===1/0||this._screenCoordinatesRef.y===1/0||(e.pointerX=this._screenCoordinatesRef.x,e.pointerY=this._screenCoordinatesRef.y,t.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let s=null;this._utilityLayerScene&&(s=this._utilityLayerScene.pickWithRay(t.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const r=this._scene.pickWithRay(t.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);s&&s.hit?r&&r.hit?s.distance<r.distance?t.pick=s:t.pick=r:t.pick=s:t.pick=r,t.pick&&t.xrController&&(t.pick.aimTransform=t.xrController.pointer,t.pick.gripTransform=t.xrController.grip||null,t.pick.originMesh=t.xrController.pointer);const n=t.pick;if(n&&n.pickedPoint&&n.hit){this._updatePointerDistance(t.laserPointer,n.distance),t.selectionMesh.position.copyFrom(n.pickedPoint),t.selectionMesh.scaling.x=Math.sqrt(n.distance),t.selectionMesh.scaling.y=Math.sqrt(n.distance),t.selectionMesh.scaling.z=Math.sqrt(n.distance);const e=this._convertNormalToDirectionOfRay(n.getNormal(!0),t.tmpRay),i=.001;if(t.selectionMesh.position.copyFrom(n.pickedPoint),e){const s=I.Pq.Cross(mt._0.Y,e),r=I.Pq.Cross(e,s);I.Pq.RotationFromAxisToRef(r,e,s,t.selectionMesh.rotation),t.selectionMesh.position.addInPlace(e.scale(i))}t.selectionMesh.isVisible=this.displaySelectionMesh,t.meshUnderPointer=n.pickedMesh}else t.selectionMesh.isVisible=!1,this._updatePointerDistance(t.laserPointer,1),t.meshUnderPointer=null}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||fr.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,s=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let r=new _t.G;const n=Es("selection",{diameter:.0525,thickness:.015,tessellation:20},s);n.isVisible=!1,n.isPickable=!1,n.parent=t.selectionMesh;let a=0,o=!1;const l={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{if(t.pick){if(this._augmentPointerInit(l,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,n.isVisible=!1,t.pick.hit)if(this._pickingMoved(r,t.pick))o&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,l)),o=!1,a=0;else if(a>i/10&&(n.isVisible=!0),a+=this._scene.getEngine().getDeltaTime(),a>=i)this._scene.simulatePointerDown(t.pick,l),o=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,l),n.isVisible=!1;else{const e=1-a/i;n.scaling.set(e,e,e)}else o=!1,a=0;this._scene.simulatePointerMove(t.pick,l),r=t.pick}})),void 0!==this._options.renderingGroupId&&(n.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce((()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&o&&(this._scene.simulatePointerUp(t.pick,l),t.finalPointerUpTriggered=!0),n.dispose()}))}_attachScreenRayMode(e){const t=this._controllers[e.uniqueId];let i=!1;const s={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{this._augmentPointerInit(s,t.id,t.screenCoordinates),!t.pick||this._options.disablePointerUpOnTouchOut&&i||(i?this._scene.simulatePointerMove(t.pick,s):(this._scene.simulatePointerDown(t.pick,s),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,s)))})),e.onDisposeObservable.addOnce((()=>{this._augmentPointerInit(s,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame((()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,s),t.finalPointerUpTriggered=!0)}))}))}_attachTrackedPointerRayMode(e){const t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))})),e.inputSource.gamepad){const s=s=>{this._options.overrideButtonId&&(t.selectionComponent=s.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=s.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((s=>{if(s.changes.pressed){const r=s.changes.pressed.current;if(t.pick)(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),r?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor));else if(r&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick){const t=this._controllers[this._attachedController];t&&t.pointerDownTriggered&&!t.finalPointerUpTriggered&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(new _t.G,{pointerId:t.id,pointerType:"xr"}),t.finalPointerUpTriggered=!0),this._attachedController=e.uniqueId}}}))};e.motionController?s(e.motionController):e.onMotionControllerInitObservable.add(s)}else{const e=e=>{this._xrSessionManager.onXRFrameObservable.addOnce((()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)}))},s=e=>{this._xrSessionManager.onXRFrameObservable.addOnce((()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)}))};t.eventListeners={selectend:s,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",s)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(I.Pq.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){const t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),!t.finalPointerUpTriggered&&t.pointerDownTriggered){const e={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame((()=>{this._augmentPointerInit(e,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new _t.G,e),t.finalPointerUpTriggered=!0}))}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce((()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}catch(e){ee.S0.Warn("controller already detached.")}}))}}_generateNewMeshPair(e){const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||fr.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():_r("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;const s=new Oe("laserPointerMat",t);s.emissiveColor=this.laserPointerDefaultColor,s.alpha=.7,i.material=s,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;const r=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():Es("gazeTracker",{diameter:.0105,thickness:.0075,tessellation:20},t);r.bakeCurrentTransformIntoVertices(),r.isPickable=!1,r.isVisible=!1;const n=new Oe("targetMat",t);return n.specularColor=M.v9.Black(),n.emissiveColor=this.selectionMeshDefaultColor,n.backFaceCulling=!1,r.material=n,void 0!==this._options.renderingGroupId&&(i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:r}}_pickingMoved(e,t){if(!e.hit||!t.hit)return!0;if(!(e.pickedMesh&&e.pickedPoint&&t.pickedMesh&&t.pickedPoint))return!0;if(e.pickedMesh!==t.pickedMesh)return!0;e.pickedPoint?.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const i=.01*(this._options.gazeModePointerMovedFactor||1)*t.distance;return this._tmpVectorForPickCompare.length()>i}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}mr._IdCounter=200,mr.Name=Os.POINTER_SELECTION,mr.Version=1,ws.AddWebXRFeature(mr.Name,((e,t)=>()=>new mr(e,t)),mr.Version,!0);var gr,vr,br=r(7906);!function(e){e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Vector2=4]="Vector2",e[e.Vector3=8]="Vector3",e[e.Vector4=16]="Vector4",e[e.Color3=32]="Color3",e[e.Color4=64]="Color4",e[e.Matrix=128]="Matrix",e[e.Object=256]="Object",e[e.AutoDetect=1024]="AutoDetect",e[e.BasedOnInput=2048]="BasedOnInput",e[e.All=4095]="All"}(gr||(gr={})),function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Neutral=4]="Neutral",e[e.VertexAndFragment=3]="VertexAndFragment"}(vr||(vr={}));class xr{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._terminalBlocks=new Set,this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return 1===this.shaderLanguage?"f":""}finalize(e){const t=e.sharedData.emitComments,i=this.target===vr.Fragment;1===this.shaderLanguage?this.compilationString=i?`\n${t?"//Entry point\n":""}@fragment\nfn main(input: FragmentInputs) -> FragmentOutputs {\n${this.compilationString}`:`\n${t?"//Entry point\n":""}@vertex\nfn main(input: VertexInputs) -> FragmentInputs{\n${this.compilationString}`:this.compilationString=`\n${t?"//Entry point\n":""}void main(void) {\n${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\n${t?"//Constants\n":""}${this._constantDeclaration}\n${this.compilationString}`);let s="";for(const e in this.functions)s+=this.functions[e]+"\n";if(this.compilationString=`\n${s}\n${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\n${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\n${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\n}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\n${t?"//Varyings\n":""}${this.sharedData.varyingDeclaration}\n${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\n${t?"//Samplers\n":""}${this._samplerDeclaration}\n${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\n${t?"//Uniforms\n":""}${this._uniformDeclaration}\n${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`\n${t?"//Attributes\n":""}${this._attributeDeclaration}\n${this.compilationString}`),1!==this.shaderLanguage){this.compilationString="precision highp float;\n"+this.compilationString,this.compilationString="#if defined(WEBGL2) || defined(WEBGPU)\nprecision highp sampler2DArray;\n#endif\n"+this.compilationString,i&&(this.compilationString="#if defined(PREPASS)\r\n#extension GL_EXT_draw_buffers : require\r\nlayout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r\nhighp vec4 gl_FragColor;\r\n#endif\r\n"+this.compilationString);for(const e in this.extensions){const t=this.extensions[e];this.compilationString=`\n${t}\n${this.compilationString}`}}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),void 0===this.sharedData.variableNames[e]?(this.sharedData.variableNames[e]=0,"output"===e||"texture"===e?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return void 0===this.sharedData.defineNames[e]?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}\n`),1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;\n`,this._samplerDeclaration+=`var ${e}: texture_2d<f32>;\n`):this._samplerDeclaration+=`uniform sampler2D ${e};\n`,t&&(this._samplerDeclaration+="#endif\n"),i||this.samplers.push(e))}_emitCubeSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}\n`),1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;\n`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;\n`):this._samplerDeclaration+=`uniform samplerCube ${e};\n`,t&&(this._samplerDeclaration+="#endif\n"),i||this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};\n`,this.samplers.push(e))}_getGLType(e){switch(e){case gr.Float:return"float";case gr.Int:return"int";case gr.Vector2:return"vec2";case gr.Color3:case gr.Vector3:return"vec3";case gr.Color4:case gr.Vector4:return"vec4";case gr.Matrix:return"mat4"}return""}_getShaderType(e){const t=1===this.shaderLanguage;switch(e){case gr.Float:return t?"f32":"float";case gr.Int:return t?"i32":"int";case gr.Vector2:return t?"vec2f":"vec2";case gr.Color3:case gr.Vector3:return t?"vec3f":"vec3";case gr.Color4:case gr.Vector4:return t?"vec4f":"vec4";case gr.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}\n${t}\n#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+"\n"+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){const s=ae.l.GetIncludesShadersStore(this.shaderLanguage);if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\n`;let r=s[e]+"\n";if(this.sharedData.emitComments&&(r=t+"\n"+r),!i)return r;if(i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){const t=i.replaceStrings[e];r=r.replace(t.search,t.replace)}return r}_emitFunctionFromInclude(e,t,i,s=""){const r=e+s;if(this.functions[r])return;const n=ae.l.GetIncludesShadersStore(this.shaderLanguage);if(!i||!(i.removeAttributes||i.removeUniforms||i.removeVaryings||i.removeIfDef||i.replaceStrings))return i&&i.repeatKey?this.functions[r]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\n`:this.functions[r]=`#include<${e}>${i?.substitutionVars?"("+i?.substitutionVars+")":""}\n`,void(this.sharedData.emitComments&&(this.functions[r]=t+"\n"+this.functions[r]));if(this.functions[r]=n[e],this.sharedData.emitComments&&(this.functions[r]=t+"\n"+this.functions[r]),i.removeIfDef&&(this.functions[r]=this.functions[r].replace(/^\s*?#ifdef.+$/gm,""),this.functions[r]=this.functions[r].replace(/^\s*?#endif.*$/gm,""),this.functions[r]=this.functions[r].replace(/^\s*?#else.*$/gm,""),this.functions[r]=this.functions[r].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[r]=this.functions[r].replace(/\s*?attribute .+?;/g,"\n")),i.removeUniforms&&(this.functions[r]=this.functions[r].replace(/\s*?uniform .*?;/g,"\n")),i.removeVaryings&&(this.functions[r]=this.functions[r].replace(/\s*?(varying|in) .+?;/g,"\n")),i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){const t=i.replaceStrings[e];this.functions[r]=this.functions[r].replace(t.search,t.replace)}}_registerTempVariable(e){return-1===this.sharedData.temps.indexOf(e)&&(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",s=!1){if(-1!==this.sharedData.varyings.indexOf(e))return!1;this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}\n`:this.sharedData.varyingDeclaration+=`${s?"#ifndef":"#ifdef"} ${i}\n`);const r=this._getShaderType(t);return 1===this.shaderLanguage?this.sharedData.varyingDeclaration+=`varying ${e}: ${r};\n`:this.sharedData.varyingDeclaration+=`varying ${r} ${e};\n`,i&&(this.sharedData.varyingDeclaration+="#endif\n"),!0}_getVaryingName(e){return 1===this.shaderLanguage?(this.target!==vr.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,i="",s=!1){if(-1!==this.uniforms.indexOf(e))return;this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}\n`:this._uniformDeclaration+=`${s?"#ifndef":"#ifdef"} ${i}\n`);const r=this._getShaderType(t);1===this.shaderLanguage?this._uniformDeclaration+=`uniform ${e}: ${r};\n`:this._uniformDeclaration+=`uniform ${r} ${e};\n`,i&&(this._uniformDeclaration+="#endif\n")}_generateTernary(e,t,i){return 1===this.shaderLanguage?`select(${t}, ${e}, ${i})`:`(${i}) ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,i){return 1===this.shaderLanguage?`${i?"const":"var"} ${e}: ${this._getShaderType(t)}`:`${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return 1===this.shaderLanguage?"textureSample":"textureCube"}_samplerFunc(){return 1===this.shaderLanguage?"textureSample":"texture2D"}_samplerLODFunc(){return 1===this.shaderLanguage?"textureSampleLevel":"texture2DLodEXT"}_toLinearSpace(e){return 1!==this.shaderLanguage||e.type!==gr.Color3&&e.type!==gr.Vector3?`toLinearSpace(${e.associatedVariableName})`:`toLinearSpaceVec3(${e.associatedVariableName})`}_generateTextureSample(e,t){return 1===this.shaderLanguage?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,i){return 1===this.shaderLanguage?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerLODFunc()}(${t}, ${e}, ${i})`}_generateTextureSampleCube(e,t){return 1===this.shaderLanguage?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,i){return 1===this.shaderLanguage?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${i})`}_convertVariableDeclarationToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(new RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(new RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),((e,t,i,s)=>`select(${s}, ${i}, ${t})`))}_convertModOperatorsToWGSL(e){return e.replace(new RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),((e,t,i)=>`((${t})%(${i}))`))}_convertConstToWGSL(e){return e.replace(new RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(new RegExp("inversesqrt","g"),"inverseSqrt")}_convertFunctionsToWGSL(e){const t=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g;let i;for(;null!==(i=t.exec(e));){const t=i[1],s=i[2],r=i[3].replace(/var\s/g,"");e=e.replace(i[0],`fn ${t}(${r}) -> ${s}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=(e=this._convertOutParametersToWGSL(e)).replace(/\[\*\]/g,"*"),(e=(e=(e=this._convertFunctionsToWGSL(e)).replace(/\s->\svoidnull/g,"")).replace(/dFdx/g,"dpdx")).replace(/dFdy/g,"dpdy")}_convertTernaryOperandsToGLSL(e){return e.replace(new RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),((e,t,i,s)=>`${t} ? ${i} : ${s}`))}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),this._convertTernaryOperandsToGLSL(e)}}var Sr,Tr,yr=r(4420);class Cr{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(e=null){let t="";this.checks.emitVertex||this.allowEmptyVertexProgram||(t+="NodeMaterial does not have a vertex output. You need to at least add a block that generates a position value.\n"),this.checks.emitFragment||(t+="NodeMaterial does not have a fragment output. You need to at least add a block that generates a color value.\n");for(const e of this.checks.notConnectedNonOptionalInputs)t+=`input ${e.name} from block ${e.ownerBlock.name}[${e.ownerBlock.getClassName()}] is not connected and is not optional.\n`;return!t||(e&&e.notifyObservers(t),l.V.Error("Build of NodeMaterial failed:\n"+t),!1)}}!function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.TargetIncompatible=2]="TargetIncompatible",e[e.HierarchyIssue=3]="HierarchyIssue"}(Sr||(Sr={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(Tr||(Tr={}));class Pr{static AreEquivalentTypes(e,t){switch(e){case gr.Vector3:if(t===gr.Color3)return!0;break;case gr.Vector4:if(t===gr.Color4)return!0;break;case gr.Color3:if(t===gr.Vector3)return!0;break;case gr.Color4:if(t===gr.Vector4)return!0}return!1}get _connectedPoint(){return this._connectedPointBackingField}set _connectedPoint(e){this._connectedPointBackingField!==e&&(this._connectedPointTypeChangedObserver?.remove(),this._updateTypeDependentState((()=>this._connectedPointBackingField=e)),this._connectedPointBackingField&&(this._connectedPointTypeChangedObserver=this._connectedPointBackingField.onTypeChangedObservable.add((()=>{this._notifyTypeChanged()}))))}get _typeConnectionSource(){return this._typeConnectionSourceBackingField}set _typeConnectionSource(e){this._typeConnectionSourceBackingField!==e&&(this._typeConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState((()=>this._typeConnectionSourceBackingField=e)),this._typeConnectionSourceBackingField&&(this._typeConnectionSourceTypeChangedObserver=this._typeConnectionSourceBackingField.onTypeChangedObservable.add((()=>{this._notifyTypeChanged()}))))}get _defaultConnectionPointType(){return this._defaultConnectionPointTypeBackingField}set _defaultConnectionPointType(e){this._updateTypeDependentState((()=>this._defaultConnectionPointTypeBackingField=e))}get _linkedConnectionSource(){return this._linkedConnectionSourceBackingField}set _linkedConnectionSource(e){this._linkedConnectionSourceBackingField!==e&&(this._linkedConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState((()=>this._linkedConnectionSourceBackingField=e)),this._linkedConnectionSourceBackingField&&(this._linkedConnectionSourceTypeChangedObserver=this._linkedConnectionSourceBackingField.onTypeChangedObservable.add((()=>{this._notifyTypeChanged()}))))}get direction(){return this._direction}get declarationVariableName(){return this._ownerBlock.isInput?this._ownerBlock.declarationVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.declarationVariableName}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===gr.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.connectedPoint._redirectedSource&&this._linkedConnectionSource.connectedPoint._redirectedSource.isConnected?this._linkedConnectionSource.connectedPoint._redirectedSource.type:this._linkedConnectionSource.type}if(this._type===gr.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._updateTypeDependentState((()=>this._type=e))}get target(){return this._prioritizeVertex&&this._ownerBlock?this._target!==vr.VertexAndFragment?this._target:this._ownerBlock.target===vr.Fragment?vr.Fragment:vr.Vertex:this._target}set target(e){this._target=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get isConnectedToInputBlock(){return null!==this.connectedPoint&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===vr.Vertex)return!0;if((e.ownerBlock.target===vr.Neutral||e.ownerBlock.target===vr.VertexAndFragment)&&e.ownerBlock.outputs.some((e=>e.isDirectlyConnectedToVertexOutput)))return!0}return!1}get isConnectedInVertexShader(){if(this.target===vr.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===vr.Vertex)return!0;if(e.target===vr.Vertex)return!0;if((e.ownerBlock.target===vr.Neutral||e.ownerBlock.target===vr.VertexAndFragment)&&e.ownerBlock.outputs.some((e=>e.isConnectedInVertexShader)))return!0}return!1}get isConnectedInFragmentShader(){if(this.target===vr.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===vr.Fragment)return!0;if((e.ownerBlock.target===vr.Neutral||e.ownerBlock.target===vr.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0}return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._preventBubbleUp=!1,this._connectedPointBackingField=null,this._endpoints=new Array,this._redirectedSource=null,this._typeConnectionSourceBackingField=null,this._defaultConnectionPointTypeBackingField=null,this._linkedConnectionSourceBackingField=null,this._acceptedConnectionPointType=null,this._type=gr.Float,this._enforceAssociatedVariableName=!1,this._forPostBuild=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new C.cP,this.onDisconnectionObservable=new C.cP,this.onTypeChangedObservable=new C.cP,this._isTypeChangeObservableNotifying=!1,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=vr.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return 0===this.checkCompatibilityState(e)}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===vr.Fragment){if(i.target===vr.Vertex)return 2;for(const e of i.outputs)if(e.ownerBlock.target!=vr.Neutral&&e.isConnectedInVertexShader)return 2}if(this.type!==e.type&&e.innerType!==gr.AutoDetect)return Pr.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)||e._acceptedConnectionPointType&&Pr.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?0:1;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return 1;let s=i,r=t;return 0===this.direction&&(s=t,r=i),s.isAnAncestorOf(r)?3:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this)),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<gr.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,this.displayName&&(t.displayName=this.displayName),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear(),this.onTypeChangedObservable.clear(),this._connectedPoint=null,this._typeConnectionSource=null,this._linkedConnectionSource=null}_updateTypeDependentState(e){const t=this.type;e(),this.type!==t&&this._notifyTypeChanged()}_notifyTypeChanged(){this._isTypeChangeObservableNotifying||(this._isTypeChangeObservableNotifying=!0,this.onTypeChangedObservable.notifyObservers(this.type),this._isTypeChangeObservableNotifying=!1)}}var Er,Ar,Rr=r(2678);class Ir{get name(){return this._name}get codeIsReady(){return this._codeIsReady}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isLoop(){return this._isLoop}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){this._target&e||(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter((t=>t.name===e));return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter((t=>t.name===e));return t.length?t[0]:null}constructor(e,t=vr.Vertex,i=!1){switch(this._isFinalMerger=!1,this._isInput=!1,this._isLoop=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this._codeIsReady=!0,this.onCodeIsReadyObservable=new C.cP,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===vr.Neutral,this._isFinalMerger=i,this.getClassName()){case"InputBlock":this._isInput=!0;break;case"NodeMaterialTeleportOutBlock":this._isTeleportOut=!0;break;case"NodeMaterialTeleportInBlock":this._isTeleportIn=!0;break;case"LoopBlock":this._isLoop=!0}this._name=e,this.uniqueId=Rr.K.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===vr.Neutral}initialize(e){}bind(e,t,i,s){}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return-1===t.indexOf(".")&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some((e=>e.isConnectedInFragmentShader))}registerInput(e,t,i=!1,s,r){return(r=r??new Pr(e,this,0)).type=t,r.isOptional=i,s&&(r.target=s),this._inputs.push(r),this}registerOutput(e,t,i,s){return(s=s??new Pr(e,this,1)).type=t,i&&(s.target=i),this._outputs.push(s),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!(t.connectedPoint||e&&e.type!==t.type&&t.type!==gr.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===vr.Neutral||e.target&t.target)return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return-1===t||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){if(i.ownerBlock===e)return!0;if(i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(0===this._outputs.length)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),s=!0;for(;s;){const r=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&r&&i.canConnectTo(r))i.connectTo(r),s=!1;else{if(!i)throw"Unable to find a compatible match";i=this.getSiblingOutput(i)}}return this}_buildBlock(e){}_postBuildBlock(e){}updateUniformsAndSamples(e,t,i,s){}provideFallbacks(e,t){}initializeDefines(e,t,i,s=!1){}prepareDefines(e,t,i,s=!1,r){}autoConfigure(e,t=(()=>!0)){}replaceRepeatableContent(e,t,i,s){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return!(this.isInput||this.isFinalMerger||this._outputs.some((e=>e.isDirectlyConnectedToVertexOutput))||this.target===vr.Vertex||this.target!==vr.VertexAndFragment&&this.target!==vr.Neutral||!this._outputs.some((e=>e.isConnectedInVertexShader)))}isReady(e,t,i,s=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,s){e.build(t,s);const r=null!=t._vertexState,n=e._buildTarget===vr.Vertex&&e.target!==vr.VertexAndFragment;if(r&&(!(e.target&e._buildTarget)||!(e.target&i.target)||this.target!==vr.VertexAndFragment&&n)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const e=i.connectedPoint;if(t._vertexState._emitVaryingFromString("v_"+e.declarationVariableName,e.type)){const i=1===t.shaderLanguage?"vertexOutputs.":"";t._vertexState.compilationString+=`${i}${"v_"+e.declarationVariableName} = ${e.associatedVariableName};\n`}const s=1===t.shaderLanguage?"fragmentInputs.":"";i.associatedVariableName=s+"v_"+e.declarationVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const t of this._outputs)t.associatedVariableName||(t.associatedVariableName=e._getFreeVariableName(t.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==vr.Neutral){if(!(i.target&this.target))continue;if(!(i.target&e.target))continue}const s=i.connectedPoint.ownerBlock;s&&s!==this&&this._processBuild(s,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&l.V.Log(`${e.target===vr.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case vr.Vertex:e.sharedData.checks.emitVertex=!0;break;case vr.Fragment:e.sharedData.checks.emitFragment=!0}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\n//${this.name}\n`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(!i._forPostBuild&&i.target&e.target)for(const s of i.endpoints){const i=s.ownerBlock;i&&(i.target&e.target&&-1!==t.indexOf(i)||e._terminalBlocks.has(i))&&this._processBuild(i,e,s,t)}this._postBuildBlock(e);for(const i of this._outputs)if(i._forPostBuild&&i.target&e.target)for(const s of i.endpoints){const i=s.ownerBlock;i&&i.target&e.target&&-1!==t.indexOf(i)&&this._processBuild(i,e,s,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\n${e}.visibleOnFrame = ${this.visibleOnFrame};\n${e}.target = ${this.target};\n`}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do{t++,this._codeVariableName=i+t}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let s=`\n// ${this.getClassName()}\n`;this.comments&&(s+=`// ${this.comments}\n`),s+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\n`,s+=this._dumpPropertiesCode();for(const i of this.inputs){if(!i.isConnected)continue;const r=i.connectedPoint.ownerBlock;-1===t.indexOf(r)&&(s+=r._dumpCode(e,t))}for(const i of this.outputs)if(i.hasEndpoints)for(const r of i.endpoints){const i=r.ownerBlock;i&&-1===t.indexOf(i)&&(s+=i._dumpCode(e,t))}return s}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const s=i.connectedPoint,r=s.ownerBlock;t+=r._dumpCodeForOutputConnections(e),t+=`${r._codeVariableName}.${r._outputRename(s.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\n`}return t}clone(e,t=""){const i=this.serialize(),s=(0,V.n9)(i.customType);if(s){const r=new s;return r._deserialize(i,e,t),r}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i,s){this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=e.target??this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach(((e,t)=>{e.displayName&&(this.inputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.inputs[t].isExposedOnFrame=e.isExposedOnFrame,this.inputs[t].exposedPortPosition=e.exposedPortPosition)})),i&&i.forEach(((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)}))}dispose(){this.onCodeIsReadyObservable.clear();for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class Mr extends Ir{constructor(e){super(e,vr.Neutral),this.complementW=1,this.complementZ=0,this.target=vr.Vertex,this.registerInput("vector",gr.AutoDetect),this.registerInput("transform",gr.Matrix),this.registerOutput("output",gr.Vector4),this.registerOutput("xyz",gr.Vector3),this._inputs[0].onConnectionObservable.add((e=>{if(e.ownerBlock.isInput){const t=e.ownerBlock;"normal"!==t.name&&"tangent"!==t.name||(this.complementW=0)}}))}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform,s=e._getShaderType(gr.Vector4),r=e._getShaderType(gr.Vector3);if(t.connectedPoint){if(0===this.complementW){const n=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",n),e.sharedData.blocksWithDefines.push(this);const a=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(1===e.shaderLanguage?e.compilationString+=`var ${a}: mat3x3f = mat3x3f(${i.associatedVariableName}[0].xyz, ${i.associatedVariableName}[1].xyz, ${i.associatedVariableName}[2].xyz);\n`:e.compilationString+=`mat3 ${a} = mat3(${i.associatedVariableName});\n`,e.compilationString+="#ifdef NONUNIFORMSCALING\n",e.compilationString+=`${a} = transposeMat3(inverseMat3(${a}));\n`,e.compilationString+="#endif\n",t.connectedPoint.type){case gr.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${s}(${a} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\n`;break;case gr.Vector3:case gr.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${s}(${a} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\n`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${s}(${a} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\n`}}else{const r=i.associatedVariableName;switch(t.connectedPoint.type){case gr.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${r} * ${s}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\n`;break;case gr.Vector3:case gr.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${r} * ${s}(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\n`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${r} * ${t.associatedVariableName};\n`}}this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;\n`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=void 0!==e.complementZ?e.complementZ:0,this.complementW=void 0!==e.complementW?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\n`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\n`,e}}(0,V.Y5)("BABYLON.TransformBlock",Mr);class Or extends Ir{constructor(e){super(e,vr.Vertex,!0),this.registerInput("vector",gr.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(const t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=1===e.shaderLanguage;if(1===e.shaderLanguage?e.compilationString+=`vertexOutputs.position = ${t.associatedVariableName};\n`:e.compilationString+=`gl_Position = ${t.associatedVariableName};\n`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)){e._emitUniformFromString("logarithmicDepthConstant",gr.Float),e._emitVaryingFromString("vFragmentDepth",gr.Float);const t=i?"vertexOutputs.vFragmentDepth":"vFragmentDepth",s=i?"uniforms.":"",r=i?"vertexOutputs.position":"gl_Position";e.compilationString+=`${t} = 1.0 + ${r}.w;\n`,e.compilationString+=`${r}.z = log2(max(0.000001, ${t})) * ${s}logarithmicDepthConstant;\n`}return this}}function wr(e,t=0,i="PROPERTIES",s){return(r,n)=>{let a=r._propStore;a||(a=[],r._propStore=a),a.push({propertyName:n,displayName:e,type:t,groupName:i,options:s??{}})}}(0,V.Y5)("BABYLON.VertexOutputBlock",Or),function(e){e[e.Boolean=0]="Boolean",e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Vector2=3]="Vector2",e[e.List=4]="List"}(Er||(Er={}));class Dr extends Ir{constructor(e){super(e,vr.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",gr.Color4,!0),this.registerInput("rgb",gr.AutoDetect,!0),this.registerInput("a",gr.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Vector3|gr.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&(0,$.DL)(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,s=this.a,r=1===e.shaderLanguage;e.sharedData.hints.needAlphaBlending=t.isConnected||s.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",gr.Float),e._emitVaryingFromString("vFragmentDepth",gr.Float),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const n=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",n);let a="gl_FragColor";1===e.shaderLanguage&&(e.compilationString+="var fragmentOutputsColor : vec4<f32>;\r\n",a="fragmentOutputsColor");const o=e._getShaderType(gr.Vector4);if(t.connectedPoint)s.isConnected?e.compilationString+=`${a} = ${o}(${t.associatedVariableName}.rgb, ${s.associatedVariableName});\n`:e.compilationString+=`${a}  = ${t.associatedVariableName};\n`;else if(i.connectedPoint){let t="1.0";s.connectedPoint&&(t=s.associatedVariableName),i.connectedPoint.type===gr.Float?e.compilationString+=`${a}  = ${o}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${t});\n`:e.compilationString+=`${a}  = ${o}(${i.associatedVariableName}, ${t});\n`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);if(e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${a}  = toLinearSpace(${a});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${a}  = toGammaSpace(${a});\n`,e.compilationString+="#endif\n",1===e.shaderLanguage&&(e.compilationString+="#if !defined(PREPASS)\r\n",e.compilationString+="fragmentOutputs.color = fragmentOutputsColor;\r\n",e.compilationString+="#endif\r\n"),this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth){const t=r?"input.vFragmentDepth":"vFragmentDepth",i=r?"uniforms.":"",s=r?"fragmentOutputs.fragDepth":"gl_FragDepthEXT";e.compilationString+=`${s} = log2(${t}) * ${i}logarithmicDepthConstant * 0.5;\n`}return e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+=`${r?"fragmentOutputs.fragData0":"gl_FragData[0]"} = ${a};\r\n`,e.compilationString+="#endif\r\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\n`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.useLogarithmicDepth=e.useLogarithmicDepth??!1}}(0,w.Cg)([wr("Convert to gamma space",0,"PROPERTIES",{notifiers:{update:!0}})],Dr.prototype,"convertToGammaSpace",void 0),(0,w.Cg)([wr("Convert to linear space",0,"PROPERTIES",{notifiers:{update:!0}})],Dr.prototype,"convertToLinearSpace",void 0),(0,w.Cg)([wr("Use logarithmic depth",0,"PROPERTIES")],Dr.prototype,"useLogarithmicDepth",void 0),(0,V.Y5)("BABYLON.FragmentOutputBlock",Dr),function(e){e[e.World=1]="World",e[e.View=2]="View",e[e.Projection=3]="Projection",e[e.ViewProjection=4]="ViewProjection",e[e.WorldView=5]="WorldView",e[e.WorldViewProjection=6]="WorldViewProjection",e[e.CameraPosition=7]="CameraPosition",e[e.FogColor=8]="FogColor",e[e.DeltaTime=9]="DeltaTime",e[e.CameraParameters=10]="CameraParameters",e[e.MaterialAlpha=11]="MaterialAlpha"}(Ar||(Ar={}));var Fr,Nr=r(2956);!function(e){e[e.None=0]="None",e[e.Time=1]="Time",e[e.RealTime=2]="RealTime",e[e.MouseInfo=3]="MouseInfo"}(Fr||(Fr={}));const Lr={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},Br={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},kr={particle_texturemask:!0};class Vr extends Ir{get type(){if(this._type===gr.AutoDetect){if(this.isUniform&&null!=this.value){if(!isNaN(this.value))return this._type=gr.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=gr.Vector2,this._type;case"Vector3":return this._type=gr.Vector3,this._type;case"Vector4":return this._type=gr.Vector4,this._type;case"Color3":return this._type=gr.Color3,this._type;case"Color4":return this._type=gr.Color4,this._type;case"Matrix":return this._type=gr.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=gr.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=gr.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=gr.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=gr.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case Ar.World:case Ar.WorldView:case Ar.WorldViewProjection:case Ar.View:case Ar.ViewProjection:case Ar.Projection:return this._type=gr.Matrix,this._type;case Ar.CameraPosition:return this._type=gr.Vector3,this._type;case Ar.FogColor:return this._type=gr.Color3,this._type;case Ar.DeltaTime:case Ar.MaterialAlpha:return this._type=gr.Float,this._type;case Ar.CameraParameters:return this._type=gr.Vector4,this._type}}return this._type}constructor(e,t=vr.Vertex,i=gr.AutoDetect){super(e,t,!1),this._mode=3,this._animationType=Fr.None,this._prefix="",this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new C.cP,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return!!this.isAttribute||super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=1,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===gr.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=0,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=0}get declarationVariableName(){return this._associatedVariableName}get associatedVariableName(){return this._prefix+this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return 3===this._mode}get isUniform(){return 0===this._mode}set isUniform(e){this._mode=e?0:3,this.associatedVariableName=""}get isAttribute(){return 1===this._mode}set isAttribute(e){this._mode=e?1:3,this.associatedVariableName=""}get isVarying(){return 2===this._mode}set isVarying(e){this._mode=e?2:3,this.associatedVariableName=""}get isSystemValue(){return null!=this._systemValue}get systemValue(){return this._systemValue}set systemValue(e){this._mode=0,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case Fr.Time:this.type===gr.Float&&(this.value+=.01*e.getAnimationRatio());break;case Fr.RealTime:this.type===gr.Float&&(this.value=(s.j.Now-e.getEngine().startTime)/1e3);break;case Fr.MouseInfo:if(this.type===gr.Vector4){const t=e._inputManager._originMouseEvent;if(t){const e=t.offsetX,i=t.offsetY,s=1&t.buttons?1:0,r=2&t.buttons?1:0;this.value=new I.IU(e,i,s,r)}else this.value=new I.IU(0,0,0,0)}}}_emitDefine(e){return"!"===e[0]?`#ifndef ${e.substring(1)}\n`:`#ifdef ${e}\n`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case gr.Float:this.value=0;break;case gr.Vector2:this.value=I.I9.Zero();break;case gr.Vector3:this.value=I.Pq.Zero();break;case gr.Vector4:this.value=I.IU.Zero();break;case gr.Color3:this.value=Nr.v9.White();break;case gr.Color4:this.value=new Nr.ov(1,1,1,1);break;case gr.Matrix:this.value=I.uq.Identity()}}_emitConstant(e){switch(this.type){case gr.Float:return`${e._emitFloat(this.value)}`;case gr.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case gr.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case gr.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case gr.Color3:return Nr.IG.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&Nr.IG.Color3[0].toGammaSpaceToRef(Nr.IG.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Nr.IG.Color3[0].toLinearSpaceToRef(Nr.IG.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${Nr.IG.Color3[0].r}, ${Nr.IG.Color3[0].g}, ${Nr.IG.Color3[0].b})`;case gr.Color4:return Nr.IG.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&Nr.IG.Color4[0].toGammaSpaceToRef(Nr.IG.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Nr.IG.Color4[0].toLinearSpaceToRef(Nr.IG.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${Nr.IG.Color4[0].r}, ${Nr.IG.Color4[0].g}, ${Nr.IG.Color4[0].b}, ${Nr.IG.Color4[0].a})`}return""}get _noContextSwitch(){return Br[this.name]}_emit(e,t){if(this.isUniform){if(this._associatedVariableName||(this._associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(-1!==e.constants.indexOf(this.associatedVariableName))return;return e.constants.push(this.associatedVariableName),void(e._constantDeclaration+=e._declareOutput(this.output,!0)+` = ${this._emitConstant(e)};\n`)}if(-1!==e.uniforms.indexOf(this.associatedVariableName))return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t));const i=e._getShaderType(this.type);1===e.shaderLanguage?(e._uniformDeclaration+=`uniform ${this._associatedVariableName}: ${i};\n`,this._prefix="uniforms."):e._uniformDeclaration+=`uniform ${i} ${this.associatedVariableName};\n`,t&&(e._uniformDeclaration+="#endif\n");const s=e.sharedData.hints;if(null!==this._systemValue&&void 0!==this._systemValue)switch(this._systemValue){case Ar.WorldView:s.needWorldViewMatrix=!0;break;case Ar.WorldViewProjection:s.needWorldViewProjectionMatrix=!0}else this._animationType!==Fr.None&&e.sharedData.animatedInputs.push(this)}else if(this.isAttribute){if(this.associatedVariableName=Lr[this.name]??this.name,this.target===vr.Vertex&&e._vertexState)return void(Br[this.name]?kr[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="vertexInputs.")):e._emitVaryingFromString(this.declarationVariableName,this.type,t):this._emit(e._vertexState,t));if(-1!==e.attributes.indexOf(this.declarationVariableName))return;e.attributes.push(this.declarationVariableName),Br[this.name]?kr[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="uniforms.")):(e._emitVaryingFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="fragmentInputs.")):(t&&(e._attributeDeclaration+=this._emitDefine(t)),1===e.shaderLanguage?(e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};\n`,this._prefix="vertexInputs."):e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};\n`,t&&(e._attributeDeclaration+="#endif\n"))}}_transmitWorld(e,t,i,s){if(!this._systemValue)return;const r=this._associatedVariableName;switch(this._systemValue){case Ar.World:e.setMatrix(r,t);break;case Ar.WorldView:e.setMatrix(r,i);break;case Ar.WorldViewProjection:e.setMatrix(r,s)}}_transmit(e,t,i){if(this.isAttribute)return;const s=this._associatedVariableName;if(this._systemValue){switch(this._systemValue){case Ar.World:case Ar.WorldView:case Ar.WorldViewProjection:return;case Ar.View:e.setMatrix(s,t.getViewMatrix());break;case Ar.Projection:e.setMatrix(s,t.getProjectionMatrix());break;case Ar.ViewProjection:e.setMatrix(s,t.getTransformMatrix());break;case Ar.CameraPosition:t.bindEyePosition(e,s,!0);break;case Ar.FogColor:e.setColor3(s,t.fogColor);break;case Ar.DeltaTime:e.setFloat(s,t.deltaTime/1e3);break;case Ar.CameraParameters:t.activeCamera&&e.setFloat4(s,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case Ar.MaterialAlpha:e.setFloat(s,i.alpha)}return}const r=this._valueCallback?this._valueCallback():this._storedValue;if(null!==r)switch(this.type){case gr.Float:e.setFloat(s,r);break;case gr.Int:e.setInt(s,r);break;case gr.Color3:Nr.IG.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&Nr.IG.Color3[0].toGammaSpaceToRef(Nr.IG.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Nr.IG.Color3[0].toLinearSpaceToRef(Nr.IG.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(s,Nr.IG.Color3[0]);break;case gr.Color4:Nr.IG.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&Nr.IG.Color4[0].toGammaSpaceToRef(Nr.IG.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Nr.IG.Color4[0].toLinearSpaceToRef(Nr.IG.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(s,Nr.IG.Color4[0]);break;case gr.Vector2:e.setVector2(s,r);break;case gr.Vector3:e.setVector3(s,r);break;case gr.Vector4:e.setVector4(s,r);break;case gr.Matrix:e.setMatrix(s,r)}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\n`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${Ar[this._systemValue]});\n`;if(this.isUniform){const t=[];let i="";switch(this.type){case gr.Float:i=`${this.value}`;break;case gr.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case gr.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case gr.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case gr.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case gr.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case gr.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`}return t.push(`${e}.value = ${i}`),this.type===gr.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${Fr[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(";\n")}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,null!=this._storedValue&&0===this._mode&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,"tangent"===e.name&&1===e.mode&&e.type===gr.Vector3&&(this._type=gr.Vector4),e.valueType)if("number"===e.valueType)this._storedValue=e.value;else{const t=(0,V.n9)(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}(0,V.Y5)("BABYLON.InputBlock",Vr);class Ur extends Ir{constructor(e){super(e,vr.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",gr.AutoDetect,!1,vr.VertexAndFragment),this.registerOutput("rgba",gr.Color4,vr.Neutral),this.registerOutput("rgb",gr.Color3,vr.Neutral),this.registerOutput("r",gr.Float,vr.Neutral),this.registerOutput("g",gr.Float,vr.Neutral),this.registerOutput("b",gr.Float,vr.Neutral),this.registerOutput("a",gr.Float,vr.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Vector2|gr.Vector3|gr.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName(this._samplerName)}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?vr.VertexAndFragment:vr.Fragment:vr.VertexAndFragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,gr.Vector2)),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,gr.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===vr.Fragment)return;const t=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,s=0===e.shaderLanguage?"":", 0";return void(e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = ${t} ${i.associatedVariableName}${s});\n`)}const s=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;this.uv.ownerBlock.target!==vr.Fragment?e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = ${s} ${this._mainUVName});\n`:e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = ${s} ${i.associatedVariableName});\n`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===vr.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target!==vr.Fragment?(e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n"):e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==vr.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=G.g.Parse(e.texture,t,i))}}(0,V.Y5)("BABYLON.CurrentScreenBlock",Ur);class zr extends Ir{constructor(e){super(e,vr.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",gr.AutoDetect,!1,vr.VertexAndFragment),this.registerOutput("rgba",gr.Color4,vr.Neutral),this.registerOutput("rgb",gr.Color3,vr.Neutral),this.registerOutput("r",gr.Float,vr.Neutral),this.registerOutput("g",gr.Float,vr.Neutral),this.registerOutput("b",gr.Float,vr.Neutral),this.registerOutput("a",gr.Float,vr.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Vector2|gr.Vector3|gr.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=(()=>!0)){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"particle_uv"===e.name&&t(e)));i||(i=new Vr("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n"}_buildBlock(e){if(super._buildBlock(e),e.target===vr.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = ${e._generateTextureSample(this.uv.associatedVariableName,this._samplerName)};\n`;for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=G.g.Parse(e.texture,t,i))}}(0,V.Y5)("BABYLON.ParticleTextureBlock",zr);class Gr extends Ir{constructor(e){super(e,vr.Fragment),this._isUnique=!0,this.registerInput("color",gr.Color4,!1,vr.Fragment),this.registerOutput("rampColor",gr.Color4,vr.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor")}_buildBlock(e){if(super._buildBlock(e),e.target!==vr.Vertex)return e._emit2DSampler("rampSampler","RAMPGRADIENT"),e._emitVaryingFromString("remapRanges",gr.Vector4,"RAMPGRADIENT"),e.compilationString+=`\n            #ifdef RAMPGRADIENT\n                ${e._declareLocalVar("baseColor",gr.Vector4)} = ${this.color.associatedVariableName};\n                ${e._declareLocalVar("alpha",gr.Float)} = ${this.color.associatedVariableName}.a;\n\n                ${e._declareLocalVar("remappedColorIndex",gr.Float)} = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);\n\n                ${e._declareLocalVar("rampColor",gr.Vector4)} = ${e._generateTextureSample("vec2(1.0 - remappedColorIndex, 0.)","rampSampler")};\n\n                // Remapped alpha\n                ${e._declareOutput(this.rampColor)} = vec4${e.fSuffix}(baseColor.rgb * rampColor.rgb, clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0));\n            #else\n                ${e._declareOutput(this.rampColor)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}(0,V.Y5)("BABYLON.ParticleRampGradientBlock",Gr);class Hr extends Ir{constructor(e){super(e,vr.Fragment),this._isUnique=!0,this.registerInput("color",gr.Color4,!1,vr.Fragment),this.registerInput("alphaTexture",gr.Float,!1,vr.Fragment),this.registerInput("alphaColor",gr.Float,!1,vr.Fragment),this.registerOutput("blendColor",gr.Color4,vr.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==vr.Vertex)return e.compilationString+=`\n            #ifdef BLENDMULTIPLYMODE\n                ${e._declareOutput(this.blendColor)};\n                ${e._declareLocalVar("sourceAlpha",gr.Float)}  = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};\n                ${this.blendColor.associatedVariableName} = vec4${e.fSuffix}(${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha), ${this.color.associatedVariableName}.a);\n            #else\n                ${e._declareOutput(this.blendColor)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}(0,V.Y5)("BABYLON.ParticleBlendMultiplyBlock",Hr);class Wr extends Ir{constructor(e){super(e,vr.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",gr.Vector4,!0),this.registerInput("xyz ",gr.Vector3,!0),this.registerInput("xy ",gr.Vector2,!0),this.registerInput("zw ",gr.Vector2,!0),this.registerInput("x",gr.Float,!0),this.registerInput("y",gr.Float,!0),this.registerInput("z",gr.Float,!0),this.registerInput("w",gr.Float,!0),this.registerOutput("xyzw",gr.Vector4),this.registerOutput("xyz",gr.Vector3),this.registerOutput("xy",gr.Vector2),this.registerOutput("zw",gr.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,s=this.z,r=this.w,n=this.xyIn,a=this.zwIn,o=this.xyzIn,l=this.xyzwIn,h=this._outputs[0],c=this._outputs[1],u=this._outputs[2],d=this._outputs[3],_=e._getShaderType(gr.Vector4),p=e._getShaderType(gr.Vector3),f=e._getShaderType(gr.Vector2);return l.isConnected?(h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${l.associatedVariableName}${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};\n`)):o.isConnected?(h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${_}(${o.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${o.associatedVariableName}${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\n`)):n.isConnected?(h.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(h)+` = ${_}(${n.associatedVariableName}, ${a.associatedVariableName})${this._buildSwizzle(4)};\n`:e.compilationString+=e._declareOutput(h)+` = ${_}(${n.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${p}(${n.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${n.associatedVariableName}${this._buildSwizzle(2)};\n`),d.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(d)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\n`:e.compilationString+=e._declareOutput(d)+` = ${f}(${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(2)};\n`)):(h.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(h)+` = ${_}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${a.associatedVariableName})${this._buildSwizzle(4)};\n`:e.compilationString+=e._declareOutput(h)+` = ${_}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\n`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${f}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};\n`),d.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(d)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\n`:e.compilationString+=e._declareOutput(d)+` = ${f}(${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(2)};\n`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.xSwizzle=e.xSwizzle??"x",this.ySwizzle=e.ySwizzle??"y",this.zSwizzle=e.zSwizzle??"z",this.wSwizzle=e.wSwizzle??"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\n`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\n`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\n`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\n`,e}}(0,V.Y5)("BABYLON.VectorMergerBlock",Wr);class Xr extends Ir{constructor(e){super(e,vr.Neutral),this.sourceRange=new I.I9(-1,1),this.targetRange=new I.I9(0,1),this.registerInput("input",gr.AutoDetect),this.registerInput("sourceMin",gr.Float,!0),this.registerInput("sourceMax",gr.Float,!0),this.registerInput("targetMin",gr.Float,!0),this.registerInput("targetMax",gr.Float,!0),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),s=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),r=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),n=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${r} + (${this._inputs[0].associatedVariableName} - ${i}) * (${n} - ${r}) / (${s} - ${i});\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\n`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\n`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=I.I9.FromArray(e.sourceRange),this.targetRange=I.I9.FromArray(e.targetRange)}}(0,w.Cg)([wr("From",3)],Xr.prototype,"sourceRange",void 0),(0,w.Cg)([wr("To",3)],Xr.prototype,"targetRange",void 0),(0,V.Y5)("BABYLON.RemapBlock",Xr);class Kr extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("left",gr.AutoDetect),this.registerInput("right",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(gr.Float),this.right.acceptedConnectionPointTypes.push(gr.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add((()=>this._updateInputOutputTypes())),this.right.onTypeChangedObservable.add((()=>this._updateInputOutputTypes()))]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===gr.Int||this.left.type===gr.Float&&this.right.type!==gr.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(const[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[gr.Int,gr.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),t.type!==gr.Int&&t.type!==gr.Float||e.acceptedConnectionPointTypes.push(gr.Vector2,gr.Vector3,gr.Vector4,gr.Color3,gr.Color4,gr.Matrix))}dispose(){super.dispose(),this._connectionObservers.forEach((e=>e.remove())),this._connectionObservers.length=0}}class Qr extends Kr{constructor(e){super(e)}getClassName(){return"MultiplyBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\n`,this}}var Yr;(0,V.Y5)("BABYLON.MultiplyBlock",Qr),function(e){e[e.Material=0]="Material",e[e.PostProcess=1]="PostProcess",e[e.Particle=2]="Particle",e[e.ProceduralTexture=3]="ProceduralTexture"}(Yr||(Yr={}));class qr extends ye.M{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class $r{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:I.Pq.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:I.Pq.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:I.Pq.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:I.Pq.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let s=0;for(const i of t){if(i.gradient===e){t.splice(s,1);break}s++}return i&&i.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=I.Pq.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.applyFog=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new I.Pq(10,10,10),this.onAnimationEnd=null,this.blendMode=$r.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new I.I9(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new I.Pq(0,0,0),this._useLogarithmicDepth=!1,this.gravity=I.Pq.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new M.ov(1,1,1,1),this.color2=new M.ov(1,1,1,1),this.colorDead=new M.ov(0,0,0,1),this.textureMask=new M.ov(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new qr,this.id=e,this.name=e}createPointEmitter(e,t){throw new Error("Method not implemented.")}createHemisphericEmitter(e=1,t=1){throw new Error("Method not implemented.")}createSphereEmitter(e=1,t=1){throw new Error("Method not implemented.")}createDirectedSphereEmitter(e=1,t=new I.Pq(0,1,0),i=new I.Pq(0,1,0)){throw new Error("Method not implemented.")}createCylinderEmitter(e=1,t=1,i=1,s=0){throw new Error("Method not implemented.")}createDirectedCylinderEmitter(e=1,t=1,i=1,s=new I.Pq(0,1,0),r=new I.Pq(0,1,0)){throw new Error("Method not implemented.")}createConeEmitter(e=1,t=Math.PI/4){throw new Error("Method not implemented.")}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new I.Pq(0,1,0),s=new I.Pq(0,1,0)){throw new Error("Method not implemented.")}createBoxEmitter(e,t,i,s){throw new Error("Method not implemented.")}}$r.BLENDMODE_ONEONE=0,$r.BLENDMODE_STANDARD=1,$r.BLENDMODE_ADD=2,$r.BLENDMODE_MULTIPLY=3,$r.BLENDMODE_MULTIPLYADD=4,(0,V.Y5)("BABYLON.BaseParticleSystem",$r);class jr extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("rgba",gr.Color4,!0),this.registerInput("rgb ",gr.Color3,!0),this.registerOutput("rgb",gr.Color3),this.registerOutput("r",gr.Float),this.registerOutput("g",gr.Float),this.registerOutput("b",gr.Float),this.registerOutput("a",gr.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return"rgb "===e?"rgbIn":e}_outputRename(e){return"rgb"===e?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],s=this._outputs[1],r=this._outputs[2],n=this._outputs[3],a=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.rgb;\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName}.r;\n`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.g;\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.b;\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.a;\n`),this}}(0,V.Y5)("BABYLON.ColorSplitterBlock",jr);var Zr,Jr=r(2940);class en{constructor(e){this.name=fe.v.NAME_PROCEDURALTEXTURE,this.scene=e}register(){this.scene._beforeClearStage.registerStep(fe.v.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){ee.S0.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}ee.S0.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}class tn extends G.g{get shaderLanguage(){return this._shaderLanguage}constructor(e,i,s,r,n=null,a=!0,o=!1,l=0){super(null,r,!a),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new C.cP,this.onBeforeGenerationObservable=new C.cP,this.nodeMaterialSource=null,this.defines="",this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,null===n||n instanceof G.g?(this._options={},this._fallbackTexture=n):(this._options=n,this._fallbackTexture=n.fallbackTexture??null),this._shaderLanguage=this._options.shaderLanguage??0;let h=(r=this.getScene()||t.q.LastCreatedScene)._getComponent(fe.v.NAME_PROCEDURALTEXTURE);h||(h=new en(r),r._addComponent(h)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=i,this._textureType=l,this._generateMipMaps=a,this._drawWrapper=new Y.E(this._fullEngine),this.setFragment(s);const c=this._createRtWrapper(o,i,a,l);this._texture=c.texture;const u=[];u.push(1,1),u.push(-1,1),u.push(-1,-1),u.push(1,-1),this._vertexBuffers[O.R.PositionKind]=new O.R(this._fullEngine,u,O.R.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,s){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s,...this._options}),this.setFloat("face",0)):(this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s,...this._options}),this._rtWrapper.is3D&&(this.setFloat("layer",0),this.setInt("layerNum",0))),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId||(this._contentData?this._contentData.then((e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId})):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId)),this._contentData}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[O.R.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===H.$.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=H.$.REFRESHRATE_RENDER_ONCE)}reset(){this._drawWrapper.effect?.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return this.defines}executeWhenReady(e){if(this.isReady())return void e(this);const t=this.getEffect();t&&t.executeWhenCompiled((()=>{e(this)}))}isReady(){const e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;const i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:"string"==typeof this._fragment?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(i,[O.R.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,(()=>{this._rtWrapper?.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0}),void 0,this._shaderLanguage,(async()=>{this._options.extraInitializationsAsync?1===this.shaderLanguage?await Promise.all([r.e(4005).then(r.bind(r,4005)),this._options.extraInitializationsAsync()]):await Promise.all([r.e(7156).then(r.bind(r,7156)),this._options.extraInitializationsAsync()]):1===this.shaderLanguage?await r.e(4005).then(r.bind(r,4005)):await r.e(7156).then(r.bind(r,7156))}))),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return this.isEnabled&&this.isReady()&&this._texture?!this._fallbackTextureUsed&&(-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)):(this._texture&&(this._texture.isReady=!1),!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const s=this._createRtWrapper(i,e,t,this._textureType);this._texture=s.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){-1===this._uniforms.indexOf(e)&&this._uniforms.push(e)}setTexture(e,t){return-1===this._samplers.indexOf(e)&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){const t=this.getScene();if(!t)return;const i=this._fullEngine;if(i.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),i.setState(!1),!this.nodeMaterialSource){for(const e in this._textures)this._drawWrapper.effect.setTexture(e,this._textures[e]);for(const e in this._ints)this._drawWrapper.effect.setInt(e,this._ints[e]);for(const e in this._floats)this._drawWrapper.effect.setFloat(e,this._floats[e]);for(const e in this._floatsArrays)this._drawWrapper.effect.setArray(e,this._floatsArrays[e]);for(const e in this._colors3)this._drawWrapper.effect.setColor3(e,this._colors3[e]);for(const e in this._colors4){const t=this._colors4[e];this._drawWrapper.effect.setFloat4(e,t.r,t.g,t.b,t.a)}for(const e in this._vectors2)this._drawWrapper.effect.setVector2(e,this._vectors2[e]);for(const e in this._vectors3)this._drawWrapper.effect.setVector3(e,this._vectors3[e]);for(const e in this._vectors4)this._drawWrapper.effect.setVector4(e,this._vectors4[e]);for(const e in this._matrices)this._drawWrapper.effect.setMatrix(e,this._matrices[e])}if(!this._texture||!this._rtWrapper)return;i._debugPushGroup?.(`procedural texture generation for ${this.name}`,1);const s=i.currentViewport;if(this.isCube)for(let e=0;e<6;e++)i.bindFramebuffer(this._rtWrapper,e,void 0,void 0,!0),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",e),this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(Te.i.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!0);else{let e=1;this._rtWrapper.is3D?e=this._rtWrapper.depth:this._rtWrapper.is2DArray&&(e=this._rtWrapper.layers);for(let s=0;s<e;s++){if(i.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0,0,s),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._rtWrapper.is3D||this._rtWrapper.is2DArray){this._drawWrapper.effect?.setFloat("layer",1!==e?s/(e-1):0),this._drawWrapper.effect?.setInt("layerNum",s);for(const e in this._textures)this._drawWrapper.effect.setTexture(e,this._textures[e])}this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(Te.i.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!this._generateMipMaps)}}s&&i.setViewport(s),this.isCube&&i.generateMipMapsForCubemap(this._texture,!0),i._debugPopGroup?.(1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new tn(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[O.R.PositionKind];i&&(i.dispose(),this._vertexBuffers[O.R.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}(0,w.Cg)([(0,D.lK)()],tn.prototype,"isEnabled",void 0),(0,w.Cg)([(0,D.lK)()],tn.prototype,"autoClear",void 0),(0,w.Cg)([(0,D.lK)()],tn.prototype,"_generateMipMaps",void 0),(0,w.Cg)([(0,D.lK)()],tn.prototype,"_size",void 0),(0,w.Cg)([(0,D.lK)()],tn.prototype,"refreshRate",null),(0,V.Y5)("BABYLON.ProceduralTexture",tn),function(e){e[e.Cos=0]="Cos",e[e.Sin=1]="Sin",e[e.Abs=2]="Abs",e[e.Exp=3]="Exp",e[e.Exp2=4]="Exp2",e[e.Round=5]="Round",e[e.Floor=6]="Floor",e[e.Ceiling=7]="Ceiling",e[e.Sqrt=8]="Sqrt",e[e.Log=9]="Log",e[e.Tan=10]="Tan",e[e.ArcTan=11]="ArcTan",e[e.ArcCos=12]="ArcCos",e[e.ArcSin=13]="ArcSin",e[e.Fract=14]="Fract",e[e.Sign=15]="Sign",e[e.Radians=16]="Radians",e[e.Degrees=17]="Degrees",e[e.Set=18]="Set"}(Zr||(Zr={}));class sn extends Ir{constructor(e){super(e,vr.Neutral),this.operation=Zr.Cos,this.registerInput("input",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case Zr.Cos:i="cos";break;case Zr.Sin:i="sin";break;case Zr.Abs:i="abs";break;case Zr.Exp:i="exp";break;case Zr.Exp2:i="exp2";break;case Zr.Round:i="round";break;case Zr.Floor:i="floor";break;case Zr.Ceiling:i="ceil";break;case Zr.Sqrt:i="sqrt";break;case Zr.Log:i="log";break;case Zr.Tan:i="tan";break;case Zr.ArcTan:i="atan";break;case Zr.ArcCos:i="acos";break;case Zr.ArcSin:i="asin";break;case Zr.Fract:i="fract";break;case Zr.Sign:i="sign";break;case Zr.Radians:i="radians";break;case Zr.Degrees:i="degrees";break;case Zr.Set:i=""}return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${Zr[this.operation]};\n`}}(0,V.Y5)("BABYLON.TrigonometryBlock",sn);const rn={effect:null,subMesh:null};class nn extends ye.M{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){void 0===this[e]&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class an extends Ce{static _BlockIsTextureBlock(e){return"TextureBlock"===e.getClassName()||"ReflectionTextureBaseBlock"===e.getClassName()||"ReflectionTextureBlock"===e.getClassName()||"ReflectionBlock"===e.getClassName()||"RefractionBlock"===e.getClassName()||"CurrentScreenBlock"===e.getClassName()||"ParticleTextureBlock"===e.getClassName()||"ImageSourceBlock"===e.getClassName()||"TriPlanarBlock"===e.getClassName()||"BiPlanarBlock"===e.getClassName()||"PrePassTextureBlock"===e.getClassName()}_getGlobalNodeMaterialEditor(){return"undefined"!=typeof NODEEDITOR?NODEEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeEditor?BABYLON:void 0}get shaderLanguage(){return this._options.shaderLanguage}set shaderLanguage(e){this._options.shaderLanguage=e}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,i,s={}){if(super(e,i||t.q.LastCreatedScene),this._buildId=an._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new I.uq,this._cachedWorldViewProjectionMatrix=new I.uq,this._optimizers=new Array,this._animationFrame=-1,this._buildIsInProgress=!1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new C.cP,this.onBuildErrorObservable=new C.cP,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=Yr.Material,this.forceAlphaBlending=!1,s&&1===s.shaderLanguage&&!this.getScene().getEngine().isWebGPU)throw new Error("WebGPU shader language is only supported with WebGPU engine");this._options={emitComments:!1,shaderLanguage:an.DefaultShaderLanguage,...s},this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return ee.S0.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(-1!==t)return this._optimizers.splice(t,1),this}addOutputNode(e){if(null===e.target)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return e.target&vr.Vertex&&this._addVertexOutputNode(e),e.target&vr.Fragment&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return null===e.target||(e.target&vr.Vertex&&this._removeVertexOutputNode(e),e.target&vr.Fragment&&this._removeFragmentOutputNode(e)),this}_addVertexOutputNode(e){if(-1===this._vertexOutputNodes.indexOf(e))return e.target=vr.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(-1!==t)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(-1===this._fragmentOutputNodes.indexOf(e))return e.target=vr.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(-1!==t)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return!this.ignoreAlpha&&(this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending)}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,s=!0){(e.target===vr.VertexAndFragment||t.target===vr.Fragment&&e.target===vr.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,s)}_attachBlock(e){if(-1===this.attachedBlocks.indexOf(e)){if(e.isUnique){const t=e.getClassName();for(const e of this.attachedBlocks)if(e.getClassName()===t)throw`Cannot have multiple blocks of type ${t} in the same NodeMaterial`}this.attachedBlocks.push(e)}}_initializeBlock(e,t,i,s=!0){e.initialize(t),s&&e.autoConfigure(this),e._preparationId=this._buildId,this._attachBlock(e);for(const r of e.inputs){r.associatedVariableName="";const n=r.connectedPoint;if(n&&!n._preventBubbleUp){const r=n.ownerBlock;r!==e&&this._processInitializeOnLink(r,t,i,s)}}if(e.isLoop){const r=e;if(r.loopID.hasEndpoints)for(const e of r.loopID.endpoints){const r=e.ownerBlock;0===r.outputs.length&&(t._terminalBlocks.add(r),this._processInitializeOnLink(r,t,i,s))}}else if(e.isTeleportOut){const r=e;r.entryPoint&&this._processInitializeOnLink(r.entryPoint,t,i,s)}for(const t of e.outputs)t.associatedVariableName=""}_resetDualBlocks(e,t){e.target===vr.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const s=i.connectedPoint;if(s&&!s._preventBubbleUp){const i=s.ownerBlock;i!==e&&this._resetDualBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}else if(e.isLoop){const i=e;if(i.loopID.hasEndpoints)for(const e of i.loopID.endpoints){const i=e.ownerBlock;0===i.outputs.length&&this._resetDualBlocks(i,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){if(this._buildIsInProgress)return void l.V.Warn("Build is already in progress, You can use NodeMaterial.onBuildObservable to determine when the build is completed.");this._buildIsInProgress=!0,this._vertexCompilationState||i||(i=!0),this._buildWasSuccessful=!1;const s=this.getScene().getEngine(),r=this._mode===Yr.Particle;if(0===this._vertexOutputNodes.length&&!r)throw"You must define at least one vertexOutputNode";if(0===this._fragmentOutputNodes.length)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new xr,this._vertexCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._vertexCompilationState.target=vr.Vertex,this._fragmentCompilationState=new xr,this._fragmentCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._fragmentCompilationState.target=vr.Fragment,this._sharedData=new Cr,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=r;const n=[],a=[];for(const e of this._vertexOutputNodes)n.push(e),this._initializeBlock(e,this._vertexCompilationState,a,i);for(const e of this._fragmentOutputNodes)a.push(e),this._initializeBlock(e,this._fragmentCompilationState,n,i);let o=0;for(const i of this.attachedBlocks)i.codeIsReady||(o++,i.onCodeIsReadyObservable.addOnce((()=>{o--,0===o&&this._finishBuildProcess(e,t,n,a)})));0===o&&this._finishBuildProcess(e,t,n,a)}_finishBuildProcess(e=!1,t=!0,i,s){this.optimize();for(const e of i)e.build(this._vertexCompilationState,i);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const e of s)this._resetDualBlocks(e,this._buildId-1);for(const e of s)e.build(this._fragmentCompilationState,s);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=an._BuildIdGenerator++);const r=this._sharedData.emitErrors(this.onBuildErrorObservable);e&&(l.V.Log("Vertex shader:"),l.V.Log(this._vertexCompilationState.compilationString),l.V.Log("Fragment shader:"),l.V.Log(this._fragmentCompilationState.compilationString)),this._buildIsInProgress=!1,this._buildWasSuccessful=!0,r&&this.onBuildObservable.notifyObservers(this);const n=this.getScene().meshes;for(const e of n)if(e.subMeshes)for(const t of e.subMeshes){if(t.getMaterial()!==this)continue;if(!t.materialDefines)continue;const e=t.materialDefines;e.markAllAsDirty(),e.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();const a=this.getScene().prePassRenderer;a&&a.markAsDirty()}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,s=t.TANGENT,r=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(O.R.NormalKind),t.TANGENT=e.isVerticesDataPresent(O.R.TangentKind);const n=e.useVertexColors&&e.isVerticesDataPresent(O.R.ColorKind);t.VERTEXCOLOR_NME=n;let a=!1;for(let i=1;i<=6;++i){const s=t["UV"+i];t["UV"+i]=e.isVerticesDataPresent(`uv${1===i?"":i}`),a=a||t["UV"+i]!==s}const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;(0,$.N4)(this.getScene(),t,!o),(i!==t.NORMAL||s!==t.TANGENT||r!==t.VERTEXCOLOR_NME||a)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){const e=this.getBlockByPredicate((e=>"PrePassOutputBlock"===e.getClassName())),t=[4];return e?(this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.screenDepth.isConnected&&t.push(10),e.viewNormal.isConnected&&t.push(6),e.worldNormal.isConnected&&t.push(8),e.worldPosition.isConnected&&t.push(1)),t):t}get prePassTextureInputs(){const e=this.getAllTextureBlocks().filter((e=>"PrePassTextureBlock"===e.getClassName())),t=[];for(const i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.localPosition.isConnected&&!t.includes(9)&&t.push(9),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.screenDepth.isConnected&&!t.includes(10)&&t.push(10),i.normal.isConnected&&!t.includes(6)&&t.push(6),i.worldNormal.isConnected&&!t.includes(8)&&t.push(8);return t}setPrePassRenderer(e){const t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(const e of t)i.texturesRequired.includes(e)||i.texturesRequired.push(e);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,s,r,n=0,a=5){return this.mode!==Yr.PostProcess?(l.V.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,s,r,n,a)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,s=1,r,n,a=0,o=5){let l=this.name+this._buildId;const h=new nn,c=new At(l+"PostProcess",this.getScene());let u=this._buildId;return this._processDefines(c,h),yr.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),e?e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l):e=new W.w(this.name+"PostProcess",l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,s,r,n,h.toString(),a,l,{maxSimultaneousLights:this.maxSimultaneousLights},!1,o,this.shaderLanguage),e.nodeMaterialSource=this,e.onApplyObservable.add((t=>{u!==this._buildId&&(delete yr.M.ShadersStore[l+"VertexShader"],delete yr.M.ShadersStore[l+"PixelShader"],l=this.name+this._buildId,h.markAllAsDirty(),u=this._buildId),this._processDefines(c,h)&&(yr.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),Jr._.SetImmediate((()=>e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l)))),this._checkInternals(t)})),e}createProceduralTexture(e,t){if(this.mode!==Yr.ProceduralTexture)return l.V.Log("Incompatible material mode"),null;let i=this.name+this._buildId;const s=new tn(i,e,null,t),r=new At(i+"Procedural",this.getScene());r.reservedDataStore={hidden:!0};const n=new nn,a=this._processDefines(r,n);yr.M.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage);let o=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[O.R.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),a?.fallbacks,void 0,void 0,void 0,this.shaderLanguage);s.nodeMaterialSource=this,s._setEffect(o);let h=this._buildId;const c=()=>{h!==this._buildId&&(delete yr.M.ShadersStore[i+"VertexShader"],delete yr.M.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,n.markAllAsDirty(),h=this._buildId);const e=this._processDefines(r,n);e&&(yr.M.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),Jr._.SetImmediate((()=>{o=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[O.R.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),e?.fallbacks,void 0),s._setEffect(o)}))),this._checkInternals(o)};return s.onBeforeGenerationObservable.add((()=>{c()})),this.onBuildObservable.add((()=>{c()})),s}_createEffectForParticles(e,t,i,s,r,n,a,o=""){let l=this.name+this._buildId+"_"+t;n||(n=new nn),a||(a=this.getScene().getMeshByName(this.name+"Particle"))||((a=new At(this.name+"Particle",this.getScene())).reservedDataStore={hidden:!0});let h=this._buildId;const c=[];let u=o;if(!r){const o=this._processDefines(a,n);yr.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),e.fillDefines(c,t,!1),u=c.join("\n"),r=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+"\n"+u,o?.fallbacks,i,s,e,this.shaderLanguage),e.setCustomEffect(r,t)}r.onBindObservable.add((r=>{h!==this._buildId&&(delete yr.M.ShadersStore[l+"PixelShader"],l=this.name+this._buildId+"_"+t,n.markAllAsDirty(),h=this._buildId),c.length=0,e.fillDefines(c,t,!1);const d=c.join("\n");d!==u&&(n.markAllAsDirty(),u=d);const _=this._processDefines(a,n);if(_)return yr.M.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),r=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+"\n"+u,_?.fallbacks,i,s,e),e.setCustomEffect(r,t),void this._createEffectForParticles(e,t,i,s,r,n,a,o);this._checkInternals(r)}))}_checkInternals(e){if(this._sharedData.animatedInputs){const e=this.getScene(),t=e.getFrameId();if(this._animationFrame!==t){for(const t of this._sharedData.animatedInputs)t.animate(e);this._animationFrame=t}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){this.mode===Yr.Particle?(this._createEffectForParticles(e,$r.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,$r.BLENDMODE_MULTIPLY,t,i)):l.V.Log("Incompatible material mode")}createAsShadowDepthWrapper(e){this.mode===Yr.Material?e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene()):l.V.Log("Incompatible material mode")}_processDefines(e,t,i=!1,s){let r=null;const n=this.getScene();if((0,$.Y7)(n,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach((s=>{s.initializeDefines(e,this,t,i)})),this._sharedData.blocksWithDefines.forEach((r=>{r.prepareDefines(e,this,t,i,s)})),t.isDirty){const i=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach((i=>{i.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)}));const s=[];this._sharedData.dynamicUniformBlocks.forEach((e=>{e.updateUniformsAndSamples(this._vertexCompilationState,this,t,s)}));const n=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach((e=>{-1===n.indexOf(e)&&n.push(e)}));const a=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach((e=>{-1===a.indexOf(e)&&a.push(e)}));const o=new K;this._sharedData.blocksWithFallbacks.forEach((t=>{t.provideFallbacks(e,o)})),r={lightDisposed:i,uniformBuffers:s,mergedUniforms:n,mergedSamplers:a,fallbacks:o}}return r}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const s=this.getScene();if(this._sharedData.animatedInputs){const e=s.getFrameId();if(this._animationFrame!==e){for(const e of this._sharedData.animatedInputs)e.animate(s);this._animationFrame=e}}const r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new nn);const n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const a=s.getEngine();if(this._prepareDefinesForAttributes(e,n),this._sharedData.blockingBlocks.some((t=>!t.isReady(e,this,n,i))))return!1;const o=this._processDefines(e,n,i,t);if(o){const e=t.effect,i=n.toString();let r=a.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:o.mergedUniforms,uniformBuffersNames:o.uniformBuffers,samplers:o.mergedSamplers,defines:i,fallbacks:o.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:n.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS},shaderLanguage:this.shaderLanguage},a);if(r)if(this._onEffectCreatedObservable&&(rn.effect=r,rn.subMesh=t,this._onEffectCreatedObservable.notifyObservers(rn)),this.allowShaderHotSwapping&&e&&!r.isReady()){if(r=e,n.markAsUnprocessed(),o.lightDisposed)return n._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(r,n,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(n._renderId=s.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}get compiledShaders(){return`// Vertex shader\n${this._vertexCompilationState.compilationString}\n\n// Fragment shader\n${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const t of this._sharedData.inputBlocks)t._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.effect;if(!r)return;this._activeEffect=r,this.bindOnlyWorldMatrix(e);const n=this._mustRebind(s,r,i,t.visibility),a=this._sharedData;if(n){for(const e of a.bindableBlocks)e.bind(r,this,t,i);for(const e of a.forcedBindableBlocks)e.bind(r,this,t,i);for(const e of a.inputBlocks)e._transmit(r,s,this)}else if(!this.isFrozen)for(const e of a.forcedBindableBlocks)e.bind(r,this,t,i);this._afterBind(t,this._activeEffect,i)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter((e=>e.texture)).map((e=>e.texture))),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)an._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const e of this.getTextureBlocks().filter((e=>e.texture)).map((e=>e.texture)))e.dispose();for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){const t={nodeMaterial:this,...e};this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise((t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),void 0===this.BJSNODEMATERIALEDITOR){const i=e&&e.editorURL?e.editorURL:an.EditorURL;ee.S0.LoadBabylonScript(i,(()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e?.nodeEditorConfig),t()}))}else this._createNodeEditor(e?.nodeEditorConfig),t()}))}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0,this._buildIsInProgress=!1}setToDefault(){this.clear(),this.editorData=null;const e=new Vr("Position");e.setAsAttribute("position");const t=new Vr("World");t.setAsSystemValue(Ar.World);const i=new Mr("WorldPos");e.connectTo(i),t.connectTo(i);const s=new Vr("ViewProjection");s.setAsSystemValue(Ar.ViewProjection);const r=new Mr("WorldPos * ViewProjectionTransform");i.connectTo(r),s.connectTo(r);const n=new Or("VertexOutput");r.connectTo(n);const a=new Vr("color");a.value=new M.ov(.8,.8,.8,1);const o=new Dr("FragmentOutput");a.connectTo(o),this.addOutputNode(n),this.addOutputNode(o),this._mode=Yr.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new Vr("Position");e.setAsAttribute("position2d");const t=new Vr("Constant1");t.isConstant=!0,t.value=1;const i=new Wr("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new Or("VertexOutput");i.connectTo(s);const r=new Vr("Scale");r.visibleInInspector=!0,r.value=new I.I9(1,1);const n=new Xr("uv0");e.connectTo(n);const a=new Qr("UV scale");n.connectTo(a),r.connectTo(a);const o=new Ur("CurrentScreen");a.connectTo(o),o.texture=new G.g("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const l=new Dr("FragmentOutput");o.connectTo(l,{output:"rgba"}),this.addOutputNode(s),this.addOutputNode(l),this._mode=Yr.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new Vr("Position");e.setAsAttribute("position2d");const t=new Vr("Constant1");t.isConstant=!0,t.value=1;const i=new Wr("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new Or("VertexOutput");i.connectTo(s);const r=new Vr("Time");r.value=0,r.min=0,r.max=0,r.isBoolean=!1,r.matrixMode=0,r.animationType=Fr.Time,r.isConstant=!1;const n=new Vr("Color3");n.value=new M.v9(1,1,1),n.isConstant=!1;const a=new Dr("FragmentOutput"),o=new Wr("VectorMerger");o.visibleInInspector=!1;const l=new sn("Cos");l.operation=Zr.Cos,e.connectTo(o),r.output.connectTo(l.input),l.output.connectTo(o.z),o.xyzOut.connectTo(a.rgb),this.addOutputNode(s),this.addOutputNode(a),this._mode=Yr.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new Vr("uv");e.setAsAttribute("particle_uv");const t=new zr("ParticleTexture");e.connectTo(t);const i=new Vr("Color");i.setAsAttribute("particle_color");const s=new Qr("Texture * Color");t.connectTo(s),i.connectTo(s);const r=new Gr("ParticleRampGradient");s.connectTo(r);const n=new jr("ColorSplitter");i.connectTo(n);const a=new Hr("ParticleBlendMultiply");r.connectTo(a),t.connectTo(a,{output:"a"}),n.connectTo(a,{output:"a"});const o=new Dr("FragmentOutput");a.connectTo(o),this.addOutputNode(o),this._mode=Yr.Particle}async loadAsync(e,t=""){return an.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,t);const s=[];for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,s);let r=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\n`;r+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${Yr[this.mode]};\n`;for(const s of t)s.isInput&&-1===e.indexOf(s)&&(r+=s._dumpCode(i,e));for(const t of s)t.isInput&&-1===e.indexOf(t)&&(r+=t._dumpCode(i,e));e=[],r+="\n// Connections\n";for(const t of this._vertexOutputNodes)r+=t._dumpCodeForOutputConnections(e);for(const t of this._fragmentOutputNodes)r+=t._dumpCodeForOutputConnections(e);r+="\n// Output nodes\n";for(const e of this._vertexOutputNodes)r+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;for(const e of this._fragmentOutputNodes)r+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;return r+="nodeMaterial.build();\n",r}serialize(e){const t=e?{}:N.p.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,i),t.outputNodes.push(e.uniqueId);for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,i),-1===t.outputNodes.indexOf(e.uniqueId)&&t.outputNodes.push(e.uniqueId)}t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t.uniqueId=this.uniqueId,t}_restoreConnections(e,t,i){for(const s of e.outputs)for(const r of t.blocks){const n=i[r.id];if(n)for(const a of r.inputs)if(i[a.targetBlockId]!==e||a.targetConnectionName!==s.name);else{const e=n.getInputByName(a.inputName);if(!e||e.isConnected)continue;s.connectTo(e,!0),this._restoreConnections(n,t,i)}}}parseSerializedObject(e,t="",i=!1,s){i||this.clear();const r={};for(const i of e.blocks){const e=(0,V.n9)(i.customType);if(e){const n=new e;n._deserialize(i,this.getScene(),t,s),r[i.id]=n,this.attachedBlocks.push(n)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,i=t._tempEntryPointUniqueId;i&&r[i].attachToEndpoint(t)}for(let t=0;t<e.blocks.length;t++){const s=r[e.blocks[t].id];s&&(s.inputs.length&&!i||this._restoreConnections(s,e,r))}if(e.outputNodes)for(const t of e.outputNodes)this.addOutputNode(r[t]);if(e.locations||e.editorData&&e.editorData.locations){const t=e.locations||e.editorData.locations;for(const e of t)r[e.blockId]&&(e.blockId=r[e.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&t.concat(this.editorData.locations),e.locations?this.editorData={locations:t}:(this.editorData=e.editorData,this.editorData.locations=t);const s=[];for(const e in r)s[e]=r[e].uniqueId;this.editorData.map=s}this.comment=e.comment,void 0!==e.forceAlphaBlending&&(this.forceAlphaBlending=e.forceAlphaBlending),void 0!==e.alphaMode&&(this.alphaMode=e.alphaMode),i||(this._mode=e.mode??Yr.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),s=N.p.Clone((()=>new an(e,this.getScene(),this.options)),this);return s.id=e,s.name=e,s.parseSerializedObject(i),s._buildId=this._buildId,s.build(!1,!t),s}whenTexturesReadyAsync(){const e=[];return this.getActiveTextures().forEach((t=>{const i=t.getInternalTexture();i&&!i.isReady&&e.push(new Promise(((e,t)=>{i.onLoadedObservable.addOnce((()=>{e()})),i.onErrorObservable.addOnce((e=>{t(e)}))})))})),Promise.all(e)}static Parse(e,t,i="",s=0){const r=N.p.Parse((()=>new an(e.name,t,{shaderLanguage:s})),e,t,i);return r.parseSerializedObject(e,i),r.build(),r}static async ParseFromFileAsync(e,t,i,s="",r=!1,n,a){const o=n??new an(e,i),l=await i._loadFileAsync(t),h=JSON.parse(l);return o.parseSerializedObject(h,s,void 0,a),r||o.build(),o}static ParseFromSnippetAsync(e,i=t.q.LastCreatedScene,s="",r,n=!1,a=!1,o){return"_BLANK"===e?Promise.resolve(an.CreateDefault("blank",i)):new Promise(((t,l)=>{const h=new kt.u;h.addEventListener("readystatechange",(()=>{if(4==h.readyState)if(200==h.status){const c=JSON.parse(JSON.parse(h.responseText).jsonPayload),u=JSON.parse(c.nodeMaterial);r||((r=N.p.Parse((()=>new an(e,i)),u,i,s)).uniqueId=i.getUniqueId()),r.parseSerializedObject(u,void 0,void 0,o),r.snippetId=e,r.sideOrientation=null;try{n||r.build()}catch(e){l(e)}a?r.whenTexturesReadyAsync().then((()=>{t(r)})).catch((e=>{l(e)})):t(r)}else l("Unable to load the snippet "+e)})),h.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),h.send()}))}static CreateDefault(e,t){const i=new an(e,t);return i.setToDefault(),i.build(),i}}var on,ln,hn,cn;an._BuildIdGenerator=0,an.EditorURL=`${ee.S0._DefaultCdnUrl}/v${g.$.Version}/nodeEditor/babylon.nodeEditor.js`,an.SnippetUrl="https://snippet.babylonjs.com",an.IgnoreTexturesAtLoadTime=!1,an.DefaultShaderLanguage=0,(0,w.Cg)([(0,D.lK)()],an.prototype,"ignoreAlpha",void 0),(0,w.Cg)([(0,D.lK)()],an.prototype,"maxSimultaneousLights",void 0),(0,w.Cg)([(0,D.lK)("mode")],an.prototype,"_mode",void 0),(0,w.Cg)([(0,D.lK)("comment")],an.prototype,"comment",void 0),(0,w.Cg)([(0,D.lK)()],an.prototype,"forceAlphaBlending",void 0),(0,V.Y5)("BABYLON.NodeMaterial",an),rt.K.prototype._projectOnTrianglesToRef=function(e,t,i,s,r,n){const a=I.AA.Vector3[0],o=I.AA.Vector3[1];let l=1/0;for(let n=this.indexStart;n<this.indexStart+this.indexCount-(3-s);n+=s){const s=i[n],h=i[n+1],c=i[n+2];if(r&&4294967295===c){n+=2;continue}const u=t[s],d=t[h],_=t[c];if(!u||!d||!_)continue;const p=I.Pq.ProjectOnTriangleToRef(e,u,d,_,o);p<l&&(a.copyFrom(o),l=p)}return n.copyFrom(a),l},rt.K.prototype._projectOnUnIndexedTrianglesToRef=function(e,t,i,s){const r=I.AA.Vector3[0],n=I.AA.Vector3[1];let a=1/0;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){const s=t[i],o=t[i+1],l=t[i+2],h=I.Pq.ProjectOnTriangleToRef(e,s,o,l,n);h<a&&(r.copyFrom(n),a=h)}return s.copyFrom(r),a},rt.K.prototype.projectToRef=function(e,t,i,s){const r=this.getMaterial();if(!r)return-1;let n=3,a=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:n=1,a=!0}return 4===r.fillMode?-1:!i.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(e,t,i,s):this._projectOnTrianglesToRef(e,t,i,n,a,s)},function(e){e[e.DEHYDRATED=0]="DEHYDRATED",e[e.HOVER=1]="HOVER",e[e.TOUCH=2]="TOUCH"}(on||(on={})),function(e){e[e.DISABLED=0]="DISABLED",e[e.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",e[e.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"}(ln||(ln={}));class un extends pr{constructor(e,t){super(e),this._options=t,this._tmpRay=new qi(new I.Pq,new I.Pq),this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:s}=this._generateNewTouchPointMesh(),r=this._generateVisualCue();switch(this._controllers[e.uniqueId]={xrController:e,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:s,currentAnimationState:on.DEHYDRATED,grabRay:new qi(new I.Pq,new I.Pq),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,downTriggered:!1,id:un._IdCounter++,pickedPointVisualCue:r},this._controllers[e.uniqueId]._worldScaleObserver=this._controllers[e.uniqueId]._worldScaleObserver||this._xrSessionManager.onWorldScaleFactorChangedObservable.add((t=>{if(t.newScaleFactor!==t.previousScaleFactor){this._controllers[e.uniqueId].touchCollisionMesh.dispose(),this._controllers[e.uniqueId].pickedPointVisualCue.dispose();const{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:s}=this._generateNewTouchPointMesh();this._controllers[e.uniqueId].touchCollisionMesh=t,this._controllers[e.uniqueId].touchCollisionMeshFunction=i,this._controllers[e.uniqueId].hydrateCollisionMeshFunction=s,this._controllers[e.uniqueId].pickedPointVisualCue=this._generateVisualCue()}})),this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(e);case"gaze":case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new M.v9(.8,.8,.8),this.selectionMeshPickedColor=new M.v9(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,void 0===this._options.nearInteractionControllerMode&&(this._options.nearInteractionControllerMode=2),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return!!super.attach()&&(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._scene.constantlyUpdateMeshUnderPointer=!0,!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){if(e.currentAnimationState!==t&&2===this._options.nearInteractionControllerMode&&!e.xrController?.inputSource.hand){if(t>e.currentAnimationState)switch(e.currentAnimationState){case on.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===on.HOVER)break;case on.HOVER:if(e.touchCollisionMeshFunction(!0),t===on.TOUCH)break}else switch(e.currentAnimationState){case on.TOUCH:if(e.touchCollisionMeshFunction(!1),t===on.HOVER)break;case on.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===on.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){const s=this._controllers[e];s.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(I.AA.Vector3[0]),s.grabRay.direction.copyFrom(I.AA.Vector3[0]),2!==this._options.nearInteractionControllerMode||s.xrController?.inputSource.hand||(s.xrController.getWorldPointerRayToRef(this._tmpRay),s.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),s.grabRay.length=this._nearGrabLengthScale*this._hoverRadius*this._xrSessionManager.worldScalingFactor,s.touchCollisionMesh.position.copyFrom(s.grabRay.origin).scaleInPlace(this._xrSessionManager.worldScalingFactor)}_onXRFrame(e){Object.keys(this._controllers).forEach((t=>{const i=this._controllers[t],s=i.xrController?.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!i.xrController||!s&&(!this._options.nearInteractionControllerMode||!i.xrController.inputSource.gamepad))return void(i.pick=null);if(i.hoverInteraction=!1,i.nearInteraction=!1,!i.xrController)return;if(s){const i=s.get("index-finger-tip");if(i){const s=e.getJointPose(i,this._xrSessionManager.referenceSpace);if(s&&s.transform){const e=this._scene.useRightHandedSystem?1:-1;I.AA.Vector3[0].set(s.transform.position.x,s.transform.position.y,s.transform.position.z*e),I.AA.Quaternion[0].set(s.transform.orientation.x,s.transform.orientation.y,s.transform.orientation.z*e,s.transform.orientation.w*e),this._processTouchPoint(t,I.AA.Vector3[0],I.AA.Quaternion[0])}}}else if(i.xrController.inputSource.gamepad&&0!==this._options.nearInteractionControllerMode){let e=i.xrController.pointer;i.xrController.grip&&1===this._options.nearInteractionControllerMode&&(e=i.xrController.grip),this._processTouchPoint(t,e.position,e.rotationQuaternion)}const r=(e,t)=>{let i=null;return i=t&&t.hit?e&&e.hit?t.distance<e.distance?t:e:t:e,i},n=e=>{let t=new _t.G,i=!1;const s=e&&e.pickedPoint&&e.hit;return e?.pickedPoint&&(i=0===e.pickedPoint.x&&0===e.pickedPoint.y&&0===e.pickedPoint.z),s&&!i&&(t=e),t};if(!i.grabInteraction){let e=null,t=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._utilityLayerScene,(e=>this._nearInteractionPredicate(e))));const a=r(this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._scene,(e=>this._nearInteractionPredicate(e))),t);if(a&&a.hit&&(e=n(a),e.hit&&(i.hoverInteraction=!0)),i.hoverInteraction){let t=null;const a=(s?this._pickRadius:this._controllerPickRadius)*this._xrSessionManager.worldScalingFactor;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(i,a,this._utilityLayerScene,(e=>this._nearPickPredicate(e))));const o=n(r(this._pickWithSphere(i,a,this._scene,(e=>this._nearPickPredicate(e))),t));o.hit&&(e=o,i.nearInteraction=!0)}i.stalePick=i.pick,i.pick=e,i.pick&&i.pick.pickedPoint&&i.pick.hit?(i.meshUnderPointer=i.pick.pickedMesh,i.pickedPointVisualCue.position.copyFrom(i.pick.pickedPoint),i.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!0)):(i.meshUnderPointer=null,i.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!1))}let a=on.DEHYDRATED;i.grabInteraction||i.nearInteraction?a=on.TOUCH:i.hoverInteraction&&(a=on.HOVER),this._handleTransitionAnimation(i,a)}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||fr.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||fr.DefaultUtilityLayer.utilityLayerScene:this._scene,t=nr("nearInteraction",{diameter:.0105*this._xrSessionManager.worldScalingFactor},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=I.PT.Identity();const i=new Oe("targetMat",e);return i.specularColor=M.v9.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return!this._farInteractionFeature||this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e)}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{(this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController)&&t.xrController&&(t.xrController.inputSource.hand||this._options.nearInteractionControllerMode&&t.xrController.inputSource.gamepad)&&(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer,t.downTriggered=!0):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.downTriggered=!1,t.nearInteractionTargetMesh=null))}));const s=s=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),s&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0):!s&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.downTriggered=!1,t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)):!s||this._options.enableNearInteractionOnAllControllers||this._options.disableSwitchOnClick||(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const i=e=>{t.squeezeComponent=e.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;s(t)}})):(t.selectionComponent=e.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;s(t)}})))};e.motionController?i(e.motionController):e.onMotionControllerInitObservable.add(i)}else{const e=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0)},s=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0,t.downTriggered=!1)};t.eventListeners={selectend:s,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",s)}}_detachController(e){const t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame((()=>{if(!t.downTriggered)return;const e={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new _t.G,e)})),t._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(t._worldScaleObserver),delete this._controllers[e],this._attachedController===e)){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}_generateNewTouchPointMesh(){const e=this._xrSessionManager.worldScalingFactor,t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||fr.DefaultUtilityLayer.utilityLayerScene:this._scene,i=nr("PickSphere",{diameter:1*e},t);if(i.isVisible=!1,this._options.motionControllerOrbMaterial)i.material=this._options.motionControllerOrbMaterial;else{let e;e=this._options.motionControllerTouchMaterialSnippetUrl?an.ParseFromFileAsync("motionControllerTouchMaterial",this._options.motionControllerTouchMaterialSnippetUrl,t):an.ParseFromSnippetAsync("8RUNKL#3",t),e.then((e=>{i.material=e})).catch((e=>{l.V.Warn(`Error creating touch material in WebXRNearInteraction: ${e}`)}))}const s=new Dt;s.setEasingMode(Ot.EASINGMODE_EASEINOUT);const r=new I.Pq(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius).scaleInPlace(e),n=this._controllerPickRadius*(4/3),a=new I.Pq(n,n,n).scaleInPlace(e),o=this._controllerPickRadius*(7/6),h=new I.Pq(o,o,o).scaleInPlace(e),c=.8*this._controllerPickRadius,u=new I.Pq(c,c,c).scaleInPlace(e),d=1.5*this._controllerPickRadius,_=[{frame:0,value:r},{frame:10,value:new I.Pq(d,d,d).scaleInPlace(e)},{frame:18,value:a}],p=[{frame:0,value:a},{frame:10,value:u},{frame:18,value:r}],f=[{frame:0,value:I.Pq.ZeroReadOnly},{frame:12,value:h},{frame:15,value:r}],m=[{frame:0,value:r},{frame:10,value:I.Pq.ZeroReadOnly},{frame:15,value:I.Pq.ZeroReadOnly}],g=new Kt("touch","scaling",60,Kt.ANIMATIONTYPE_VECTOR3,Kt.ANIMATIONLOOPMODE_CONSTANT),v=new Kt("release","scaling",60,Kt.ANIMATIONTYPE_VECTOR3,Kt.ANIMATIONLOOPMODE_CONSTANT),b=new Kt("hydrate","scaling",60,Kt.ANIMATIONTYPE_VECTOR3,Kt.ANIMATIONLOOPMODE_CONSTANT),x=new Kt("dehydrate","scaling",60,Kt.ANIMATIONTYPE_VECTOR3,Kt.ANIMATIONLOOPMODE_CONSTANT);return g.setEasingFunction(s),v.setEasingFunction(s),b.setEasingFunction(s),x.setEasingFunction(s),g.setKeys(_),v.setKeys(p),b.setKeys(f),x.setKeys(m),{touchCollisionMesh:i,touchCollisionMeshFunction:e=>{const s=e?g:v;t.beginDirectAnimation(i,[s],0,18,!1,1)},hydrateCollisionMeshFunction:e=>{const s=e?b:x;e&&(i.isVisible=!0),t.beginDirectAnimation(i,[s],0,15,!1,1,(()=>{e||(i.isVisible=!1)}))}}}_pickWithSphere(e,t,i,s){const r=new _t.G;if(r.distance=1/0,e.touchCollisionMesh&&e.xrController){const n=e.touchCollisionMesh.position,a=br.i.CreateFromCenterAndRadius(n,t);for(let t=0;t<i.meshes.length;t++){const n=i.meshes[t];if(!s(n)||!this._controllerAvailablePredicate(n,e.xrController.uniqueId))continue;const o=un.PickMeshWithSphere(n,a);o&&o.hit&&o.distance<r.distance&&(r.hit=o.hit,r.pickedMesh=n,r.pickedPoint=o.pickedPoint,r.aimTransform=e.xrController.pointer,r.gripTransform=e.xrController.grip||null,r.originMesh=e.touchCollisionMesh,r.distance=o.distance,r.bu=o.bu,r.bv=o.bv,r.faceId=o.faceId,r.subMeshId=o.subMeshId)}}return r}static PickMeshWithSphere(e,t,i=!1){const s=e.subMeshes,r=new _t.G,n=e.getBoundingInfo();if(!e._generatePointsArray())return r;if(!e.subMeshes||!n)return r;if(!i&&!br.i.Intersects(n.boundingSphere,t))return r;const a=I.AA.Vector3[0],o=I.AA.Vector3[1],l=new qi(I.Pq.Zero(),I.Pq.Zero(),1);let h,c,u,d,_=1/0;const p=I.AA.Vector3[2],f=I.AA.Matrix[0];f.copyFrom(e.getWorldMatrix()),f.invert(),I.Pq.TransformCoordinatesToRef(t.center,f,p);for(let i=0;i<s.length;i++)s[i].projectToRef(p,e._positions,e.getIndices(),o),I.Pq.TransformCoordinatesToRef(o,e.getWorldMatrix(),o),h=I.Pq.Distance(o,t.center),u=I.Pq.Distance(o,e.getAbsolutePosition()),c=I.Pq.Distance(t.center,e.getAbsolutePosition()),-1!==c&&-1!==u&&u>c&&(h=0,o.copyFrom(t.center)),-1!==h&&h<_&&(_=h,qi.CreateFromToToRef(t.center,o,l),l.length=2*_,d=l.intersectsMesh(e),a.copyFrom(o));return _<t.radius&&(r.hit=!0,r.distance=_,r.pickedMesh=e,r.pickedPoint=a.clone(),d&&null!==d.bu&&null!==d.bv&&(r.faceId=d.faceId,r.subMeshId=d.subMeshId,r.bu=d.bu,r.bv=d.bv)),r}}un._IdCounter=200,un.Name=Os.NEAR_INTERACTION,un.Version=1,ws.AddWebXRFeature(un.Name,((e,t)=>()=>new un(e,t)),un.Version,!0);class dn{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class _n{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new C.cP,this._onSessionGranted=e=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),"undefined"!=typeof window&&window.location&&"http:"===window.location.protocol&&"localhost"!==window.location.hostname)throw ee.S0.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const e=t.sessionMode||"immersive-vr",i=t.referenceSpaceType||"local-floor";let s=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+("undefined"==typeof SVGSVGElement?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";s+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const r=document.createElement("style");r.appendChild(document.createTextNode(s)),document.getElementsByTagName("head")[0].appendChild(r);const n=document.createElement("button");n.className="babylonVRicon",n.title=`${e} - ${i}`,this._buttons.push(new dn(n,e,i)),this._buttons[this._buttons.length-1].update=function(e){this.element.style.display=null===e||e===this?"":"none",n.className="babylonVRicon"+(e===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce((()=>{this.dispose()})))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;const i=this._buttons.map((t=>e.sessionManager.isSessionSupportedAsync(t.sessionMode)));e.onStateChangedObservable.add((e=>{3==e&&this._updateButtons(null)})),(await Promise.all(i)).forEach(((e,t)=>{e?(this.overlay.appendChild(this._buttons[t].element),this._buttons[t].element.onclick=this._enterXRWithButtonIndex.bind(this,t)):ee.S0.Warn(`Session mode "${this._buttons[t].sessionMode}" not supported in browser`)}))}static async CreateAsync(e,t,i){const s=new _n(e,i);return await s.setHelperAsync(t,i.renderTarget||void 0),s}async _enterXRWithButtonIndex(e=0){if(2==this._helper.state)await this._helper.exitXRAsync(),this._updateButtons(null);else if(3==this._helper.state)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);const i=this._buttons[e].element,s=i.title;i.title="Error entering XR session : "+s,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach((e=>{e.update(this._activeButton)})),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}class pn{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}pn.DistanceJoint=0,pn.HingeJoint=1,pn.BallAndSocketJoint=2,pn.WheelJoint=3,pn.SliderJoint=4,pn.PrismaticJoint=5,pn.UniversalJoint=6,pn.Hinge2Joint=pn.WheelJoint,pn.PointToPointJoint=8,pn.SpringJoint=9,pn.LockJoint=10,At._PhysicsImpostorParser=function(e,t,i){return new fn(t,i.physicsImpostor,{mass:i.physicsMass,friction:i.physicsFriction,restitution:i.physicsRestitution},e)};class fn{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},s){this.object=e,this.type=t,this._options=i,this._scene=s,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=I.Pq.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new I.PT,this._tmpQuat2=new I.PT,this.beforeStep=()=>{this._physicsEngine&&(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new I.PT),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach((e=>{e(this)})))},this.afterStep=()=>{this._physicsEngine&&(this._onAfterPhysicsStepCallbacks.forEach((e=>{e(this)})),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,fn._TmpVecs[0]),this.object.translate(fn._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=e=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent)return;if(!this._physicsEngine)return;const t=this._physicsEngine.getImpostorWithPhysicsBody(e.body);t&&(this.onCollideEvent&&this.onCollideEvent(this,t),this._onPhysicsCollideCallbacks.filter((e=>-1!==e.otherImpostors.indexOf(t))).forEach((i=>{i.callback(this,t,e.point,e.distance,e.impulse,e.normal)})))},this.object?(this.object.parent&&0!==i.mass&&l.V.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=I.PT.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new I.PT),this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=void 0===i.pressure?200:i.pressure,this._options.stiffness=void 0===i.stiffness?1:i.stiffness,this._options.velocityIterations=void 0===i.velocityIterations?20:i.velocityIterations,this._options.positionIterations=void 0===i.positionIterations?20:i.positionIterations,this._options.fixedPoints=void 0===i.fixedPoints?0:i.fixedPoints,this._options.margin=void 0===i.margin?0:i.margin,this._options.damping=void 0===i.damping?0:i.damping,this._options.path=void 0===i.path?null:i.path,this._options.shape=void 0===i.shape?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&l.V.Warn("You must affect impostors to children before affecting impostor to parent.")):l.V.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))):l.V.Error("No object was provided. A physics object is obligatory")}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),this._isDisposed||this.parent&&!this._options.ignoreParent||this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof bt?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=fn.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const s=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return s.x=Math.abs(s.x),s.y=Math.abs(s.y),s.z=Math.abs(s.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),s}return fn.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):I.Pq.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):I.Pq.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):l.V.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):l.V.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let s=-1;this._onPhysicsCollideCallbacks.some(((e,r)=>{if(e.callback===t&&e.otherImpostors.length===i.length){const t=e.otherImpostors.every((e=>i.indexOf(e)>-1));return t&&(s=r),t}return!1}))?this._onPhysicsCollideCallbacks.splice(s,1):l.V.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):I.PT.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const s=new pn(t,i);return this.addJoint(e,s),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,s,r){if(!this._physicsEngine)return this;const n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor?(this._physicsEngine&&n.appendAnchor(this,e,t,i,s,r),this):this}addHook(e,t,i,s){if(!this._physicsEngine)return this;const r=this._physicsEngine.getPhysicsPlugin();return r.appendAnchor?(this._physicsEngine&&r.appendHook(this,e,t,i,s),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new fn(e,this.type,this._options,this._scene):null}dispose(){this._physicsEngine&&(this._joints.forEach((e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)})),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new I.PT),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,s,r){const n=fn._TmpVecs[0],a=this.object;if(a.rotationQuaternion)if(r){const i=fn._TmpQuat;a.rotationQuaternion.multiplyToRef(r,i),e.setRotationQuaternion(i,1,t)}else e.setRotationQuaternion(a.rotationQuaternion,1,t);n.x=0,n.y=0,n.z=0,i&&(n.x=i.x,n.y=i.y,n.z=i.z,e.getDirectionToRef(n,t,n),null==s&&(s=i.length()),n.x*=s,n.y*=s,n.z*=s),e.getParent()?(n.addInPlace(a.getAbsolutePosition()),e.setAbsolutePosition(n,t)):(t.setAbsolutePosition(a.getAbsolutePosition()),t.position.x-=n.x,t.position.y-=n.y,t.position.z-=n.z)}syncImpostorWithBone(e,t,i,s,r,n){const a=this.object;if(a.rotationQuaternion)if(r){const i=fn._TmpQuat;e.getRotationQuaternionToRef(1,t,i),i.multiplyToRef(r,a.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,a.rotationQuaternion);const o=fn._TmpVecs[0],l=fn._TmpVecs[1];n||((n=fn._TmpVecs[2]).x=0,n.y=1,n.z=0),e.getDirectionToRef(n,t,l),e.getAbsolutePositionToRef(t,o),null==s&&i&&(s=i.length()),null!=s&&(o.x+=l.x*s,o.y+=l.y*s,o.z+=l.z*s),a.setAbsolutePosition(o)}}function mn(e){const t=e.sideOrientation||at.DEFAULTSIDE,i=e.radius||1,s=void 0===e.flat||e.flat,r=0|(e.subdivisions||4),n=e.radiusX||i,a=e.radiusY||i,o=e.radiusZ||i,l=(1+Math.sqrt(5))/2,h=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],c=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],u=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],d=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],_=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],p=[],f=[],m=[],g=[];let v=0;const b=new Array(3),x=new Array(3);let S;for(S=0;S<3;S++)b[S]=I.Pq.Zero(),x[S]=I.I9.Zero();for(let e=0;e<20;e++){for(S=0;S<3;S++){const t=c[3*e+S];b[S].copyFromFloats(h[3*u[t]],h[3*u[t]+1],h[3*u[t]+2]),b[S].normalize(),x[S].copyFromFloats(.134765625*d[2*t]+.05859375+-.0390625*_[e],.2333984375*d[2*t+1]+.025390625+.01953125*_[e])}const t=(e,t,i,l)=>{const h=I.Pq.Lerp(b[0],b[2],t/r),c=I.Pq.Lerp(b[1],b[2],t/r),u=r===t?b[2]:I.Pq.Lerp(h,c,e/(r-t));let d;if(u.normalize(),s){const e=I.Pq.Lerp(b[0],b[2],l/r),t=I.Pq.Lerp(b[1],b[2],l/r);d=I.Pq.Lerp(e,t,i/(r-l))}else d=new I.Pq(u.x,u.y,u.z);d.x/=n,d.y/=a,d.z/=o,d.normalize();const _=I.I9.Lerp(x[0],x[2],t/r),S=I.I9.Lerp(x[1],x[2],t/r),T=r===t?x[2]:I.I9.Lerp(_,S,e/(r-t));f.push(u.x*n,u.y*a,u.z*o),m.push(d.x,d.y,d.z),g.push(T.x,ht.rX?1-T.y:T.y),p.push(v),v++};for(let e=0;e<r;e++)for(let i=0;i+e<r;i++)t(i,e,i+1/3,e+1/3),t(i+1,e,i+1/3,e+1/3),t(i,e+1,i+1/3,e+1/3),i+e+1<r&&(t(i+1,e,i+2/3,e+2/3),t(i+1,e+1,i+2/3,e+2/3),t(i,e+1,i+2/3,e+2/3))}at._ComputeSides(t,f,p,m,g,e.frontUVs,e.backUVs);const T=new at;return T.indices=p,T.positions=f,T.normals=m,T.uvs=g,T}function gn(e,t={},i=null){const s=new At(e,i);return t.sideOrientation=At._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,mn(t).applyToMesh(s,t.updatable),s}fn.DEFAULT_OBJECT_SIZE=new I.Pq(1,1,1),fn.IDENTITY_QUATERNION=I.PT.Identity(),fn._TmpVecs=(0,Ki.mI)(3,I.Pq.Zero),fn._TmpQuat=I.PT.Identity(),fn.NoImpostor=0,fn.SphereImpostor=1,fn.BoxImpostor=2,fn.PlaneImpostor=3,fn.MeshImpostor=4,fn.CapsuleImpostor=6,fn.CylinderImpostor=7,fn.ParticleImpostor=8,fn.HeightmapImpostor=9,fn.ConvexHullImpostor=10,fn.CustomImpostor=100,fn.RopeImpostor=101,fn.ClothImpostor=102,fn.SoftbodyImpostor=103,at.CreateIcoSphere=mn,At.CreateIcoSphere=(e,t,i)=>gn(e,t,i),function(e){e.WRIST="wrist",e.THUMB="thumb",e.INDEX="index",e.MIDDLE="middle",e.RING="ring",e.LITTLE="little"}(hn||(hn={})),function(e){e.WRIST="wrist",e.THUMB_METACARPAL="thumb-metacarpal",e.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",e.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",e.THUMB_TIP="thumb-tip",e.INDEX_FINGER_METACARPAL="index-finger-metacarpal",e.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",e.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",e.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",e.INDEX_FINGER_TIP="index-finger-tip",e.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",e.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",e.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",e.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",e.MIDDLE_FINGER_TIP="middle-finger-tip",e.RING_FINGER_METACARPAL="ring-finger-metacarpal",e.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",e.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",e.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",e.RING_FINGER_TIP="ring-finger-tip",e.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",e.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",e.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",e.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",e.PINKY_FINGER_TIP="pinky-finger-tip"}(cn||(cn={}));const vn=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"],bn={wrist:["wrist"],thumb:["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],index:["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],middle:["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],ring:["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],little:["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]};class xn{get handMesh(){return this._handMesh}getHandPartMeshes(e){return bn[e].map((e=>this._jointMeshes[vn.indexOf(e)]))}getJointMesh(e){return this._jointMeshes[vn.indexOf(e)]}constructor(e,t,i,s,r=!1,n=!1,a=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=s,this._leftHandedMeshes=r,this._jointsInvisible=n,this._jointScaleFactor=a,this.onHandMeshSetObservable=new C.cP,this._jointTransforms=new Array(vn.length),this._jointTransformMatrices=new Float32Array(16*vn.length),this._tempJointMatrix=new I.uq,this._jointRadii=new Float32Array(vn.length),this._scene=t[0].getScene();for(let e=0;e<this._jointTransforms.length;e++)this._jointTransforms[e]=new dt(vn[e],this._scene),this._jointTransforms[e].rotationQuaternion=new I.PT,t[e].rotationQuaternion?t[e].rotationQuaternion=new I.PT:t[e].rotationQuaternion?.set(0,0,0,1);i&&this.setHandMesh(i,s),this.xrController.motionController&&this.xrController.motionController.rootMesh&&this.xrController.motionController.rootMesh.dispose(!1,!0),this.xrController.onMotionControllerInitObservable.add((e=>{e._doNotLoadControllerMesh=!0}))}setHandMesh(e,t,i){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach((e=>{e.alwaysSelectAsActiveMesh=!0})),this._handMesh.skeleton){const e=this._handMesh.skeleton;vn.forEach(((i,s)=>{const r=e.getBoneIndexByName(t?t[i]:i);-1!==r&&e.bones[r].linkTransformNode(this._jointTransforms[s])}))}this.onHandMeshSetObservable.notifyObservers(this)}updateFromXRFrame(e,t){const i=this.xrController.inputSource.hand;if(!i)return;const s=i,r=vn.map((e=>s[e]||i.get(e)));let n=!1;if(e.fillPoses&&e.fillJointRadii)n=e.fillPoses(r,t,this._jointTransformMatrices)&&e.fillJointRadii(r,this._jointRadii);else if(e.getJointPose){n=!0;for(let i=0;i<r.length;i++){const s=e.getJointPose(r[i],t);if(!s){n=!1;break}this._jointTransformMatrices.set(s.transform.matrix,16*i),this._jointRadii[i]=s.radius||.008}}n&&(vn.forEach(((e,t)=>{const i=this._jointTransforms[t];I.uq.FromArrayToRef(this._jointTransformMatrices,16*t,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,i.rotationQuaternion,i.position);const s=this._jointRadii[t]*this._jointScaleFactor,r=this._jointMeshes[t];r.isVisible=!this._handMesh&&!this._jointsInvisible,r.position.copyFrom(i.position),r.rotationQuaternion.copyFrom(i.rotationQuaternion),r.scaling.setAll(s),this._scene.useRightHandedSystem||(r.position.z*=-1,r.rotationQuaternion.z*=-1,r.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1))})),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(e=!1){this._handMesh&&(e?(this._handMesh.skeleton?.dispose(),this._handMesh.dispose(!1,!0)):this._handMesh.isVisible=!1),this._jointTransforms.forEach((e=>e.dispose())),this._jointTransforms.length=0}}class Sn extends pr{static _GenerateTrackedJointMeshes(e,t=gn("jointParent",Sn._ICOSPHERE_PARAMS)){const i={};return["left","right"].map((s=>{const r=[];t.isVisible=!!e.jointMeshes?.keepOriginalVisible;for(let i=0;i<vn.length;++i){let n=t.createInstance(`${s}-handJoint-${i}`);if(e.jointMeshes?.onHandJointMeshGenerated){const t=e.jointMeshes.onHandJointMeshGenerated(n,i,s);t&&t!==n&&(n.dispose(),n=t)}if(n.isPickable=!1,e.jointMeshes?.enablePhysics){const t=e.jointMeshes?.physicsProps||{};n.scaling.setAll(.02);const i=void 0!==t.impostorType?t.impostorType:fn.SphereImpostor;n.physicsImpostor=new fn(n,i,{mass:0,...t})}n.rotationQuaternion=new I.PT,n.isVisible=!1,r.push(n)}i[s]=r})),{left:i.left,right:i.right}}static _GenerateDefaultHandMeshesAsync(e,t,i){return new Promise((async s=>{const r={};Sn._RightHandGLB?.meshes[1]?.isDisposed()&&(Sn._RightHandGLB=null),Sn._LeftHandGLB?.meshes[1]?.isDisposed()&&(Sn._LeftHandGLB=null);const n=!(!Sn._RightHandGLB||!Sn._LeftHandGLB),a=await Promise.all([Sn._RightHandGLB||er.ImportMeshAsync("",Sn.DEFAULT_HAND_MODEL_BASE_URL,Sn.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),Sn._LeftHandGLB||er.ImportMeshAsync("",Sn.DEFAULT_HAND_MODEL_BASE_URL,Sn.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);Sn._RightHandGLB=a[0],Sn._LeftHandGLB=a[1];const o=await an.ParseFromFileAsync("handShader",Sn.DEFAULT_HAND_MODEL_SHADER_URL,e,void 0,!0);o.needDepthPrePass=!0,o.transparencyMode=Te.i.MATERIAL_ALPHABLEND,o.alphaMode=2,o.build(!1);const l={base:M.v9.FromInts(116,63,203),fresnel:M.v9.FromInts(149,102,229),fingerColor:M.v9.FromInts(177,130,255),tipFresnel:M.v9.FromInts(220,200,255),...i?.handMeshes?.customColors},h={base:o.getBlockByName("baseColor"),fresnel:o.getBlockByName("fresnelColor"),fingerColor:o.getBlockByName("fingerColor"),tipFresnel:o.getBlockByName("tipFresnelColor")};h.base.value=l.base,h.fresnel.value=l.fresnel,h.fingerColor.value=l.fingerColor,h.tipFresnel.value=l.tipFresnel;const c=t._getBaseLayerWrapper()?.isMultiview;["left","right"].forEach((t=>{const s="left"==t?Sn._LeftHandGLB:Sn._RightHandGLB;if(!s)throw new Error("Could not load hand model");const a=s.meshes[1];a._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,c||i?.handMeshes?.disableHandShader||(a.material=o.clone(`${t}HandShaderClone`,!0)),a.isVisible=!1,r[t]=a,n||e.useRightHandedSystem||s.meshes[1].rotate(mt._0.Y,Math.PI)})),o.dispose(),s({left:r.left,right:r.right})}))}static _GenerateDefaultHandMeshRigMapping(e){const t="right"==e?"R":"L";return{wrist:`wrist_${t}`,"thumb-metacarpal":`thumb_metacarpal_${t}`,"thumb-phalanx-proximal":`thumb_proxPhalanx_${t}`,"thumb-phalanx-distal":`thumb_distPhalanx_${t}`,"thumb-tip":`thumb_tip_${t}`,"index-finger-metacarpal":`index_metacarpal_${t}`,"index-finger-phalanx-proximal":`index_proxPhalanx_${t}`,"index-finger-phalanx-intermediate":`index_intPhalanx_${t}`,"index-finger-phalanx-distal":`index_distPhalanx_${t}`,"index-finger-tip":`index_tip_${t}`,"middle-finger-metacarpal":`middle_metacarpal_${t}`,"middle-finger-phalanx-proximal":`middle_proxPhalanx_${t}`,"middle-finger-phalanx-intermediate":`middle_intPhalanx_${t}`,"middle-finger-phalanx-distal":`middle_distPhalanx_${t}`,"middle-finger-tip":`middle_tip_${t}`,"ring-finger-metacarpal":`ring_metacarpal_${t}`,"ring-finger-phalanx-proximal":`ring_proxPhalanx_${t}`,"ring-finger-phalanx-intermediate":`ring_intPhalanx_${t}`,"ring-finger-phalanx-distal":`ring_distPhalanx_${t}`,"ring-finger-tip":`ring_tip_${t}`,"pinky-finger-metacarpal":`little_metacarpal_${t}`,"pinky-finger-phalanx-proximal":`little_proxPhalanx_${t}`,"pinky-finger-phalanx-intermediate":`little_intPhalanx_${t}`,"pinky-finger-phalanx-distal":`little_distPhalanx_${t}`,"pinky-finger-tip":`little_tip_${t}`}}isCompatible(){return"undefined"!=typeof XRHand}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return"none"==e?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this._worldScaleObserver=null,this.onHandAddedObservable=new C.cP,this.onHandRemovedObservable=new C.cP,this._attachHand=e=>{if(!e.inputSource.hand||"none"==e.inputSource.handedness||!this._handResources.jointMeshes)return;const t=e.inputSource.handedness,i=new xn(e,this._handResources.jointMeshes[t],this._handResources.handMeshes&&this._handResources.handMeshes[t],this._handResources.rigMappings&&this._handResources.rigMappings[t],this.options.handMeshes?.meshesUseLeftHandedCoordinates,this.options.jointMeshes?.invisible,this.options.jointMeshes?.scaleFactor);this._attachedHands[e.uniqueId]=i,this._trackingHands[t]=i,this.onHandAddedObservable.notifyObservers(i)},this._detachHand=e=>{this._detachHandById(e.uniqueId)},this.xrNativeFeatureName="hand-tracking";const i=t.jointMeshes;if(i&&(void 0!==i.disableDefaultHandMesh&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=i.disableDefaultHandMesh),void 0!==i.handMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=i.handMeshes),void 0!==i.leftHandedSystemMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=i.leftHandedSystemMeshes),void 0!==i.rigMapping)){t.handMeshes=t.handMeshes||{};const e={},s={};[[i.rigMapping.left,e],[i.rigMapping.right,s]].forEach((e=>{const t=e[0],i=e[1];t.forEach(((e,t)=>{i[vn[t]]=e}))})),t.handMeshes.customRigMappings={left:e,right:s}}}attach(){return!!super.attach()&&(this._handResources.jointMeshes||(this._originalMesh=this._originalMesh||this.options.jointMeshes?.sourceMesh||gn("jointParent",Sn._ICOSPHERE_PARAMS),this._originalMesh.isVisible=!1,this._handResources.jointMeshes=Sn._GenerateTrackedJointMeshes(this.options,this._originalMesh)),this._handResources.handMeshes=this.options.handMeshes?.customMeshes||null,this._handResources.rigMappings=this.options.handMeshes?.customRigMappings||null,this.options.handMeshes?.customMeshes||this.options.handMeshes?.disableDefaultMeshes||(Sn._GenerateDefaultHandMeshesAsync(t.q.LastCreatedScene,this._xrSessionManager,this.options).then((e=>{this._handResources.handMeshes=e,this._handResources.rigMappings={left:Sn._GenerateDefaultHandMeshRigMapping("left"),right:Sn._GenerateDefaultHandMeshRigMapping("right")},this._trackingHands.left?.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left,this._xrSessionManager),this._trackingHands.right?.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right,this._xrSessionManager),this._handResources.handMeshes.left.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._handResources.handMeshes.right.scaling.setAll(this._xrSessionManager.worldScalingFactor)})),this._worldScaleObserver=this._xrSessionManager.onWorldScaleFactorChangedObservable.add((e=>{this._handResources.handMeshes&&(this._handResources.handMeshes.left.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor),this._handResources.handMeshes.right.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor))}))),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0)}_onXRFrame(e){this._trackingHands.left?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),this._trackingHands.right?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e,t){const i=this.getHandByControllerId(e);if(i){const s="left"==i.xrController.inputSource.handedness?"left":"right";this._trackingHands[s]?.xrController.uniqueId===e&&(this._trackingHands[s]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(t),delete this._attachedHands[e]}}detach(){return!!super.detach()&&(Object.keys(this._attachedHands).forEach((e=>this._detachHandById(e,this.options.handMeshes?.disposeOnSessionEnd))),this.options.handMeshes?.disposeOnSessionEnd&&(this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach((e=>e.dispose())),this._handResources.jointMeshes.right.forEach((e=>e.dispose())),this._handResources.jointMeshes=null),this._handResources.handMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),this._handResources.handMeshes=null),Sn._RightHandGLB?.meshes.forEach((e=>e.dispose())),Sn._LeftHandGLB?.meshes.forEach((e=>e.dispose())),Sn._RightHandGLB=null,Sn._LeftHandGLB=null,this._originalMesh?.dispose(),this._originalMesh=void 0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),!0)}dispose(){super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!this.options.handMeshes?.customMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),Sn._RightHandGLB?.meshes.forEach((e=>e.dispose())),Sn._LeftHandGLB?.meshes.forEach((e=>e.dispose())),Sn._RightHandGLB=null,Sn._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach((e=>e.dispose())),this._handResources.jointMeshes.right.forEach((e=>e.dispose())))}}Sn.Name=Os.HAND_TRACKING,Sn.Version=1,Sn.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/",Sn.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb",Sn.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb",Sn.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json",Sn._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2},Sn._RightHandGLB=null,Sn._LeftHandGLB=null,ws.AddWebXRFeature(Sn.Name,((e,t)=>()=>new Sn(e,t)),Sn.Version,!1),At._instancedMeshFactory=(e,t)=>{const i=new Tn(e,t);if(t.instancedBuffers){i.instancedBuffers={};for(const e in t.instancedBuffers)i.instancedBuffers[e]=t.instancedBuffers[e]}return i};class Tn extends bt{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const e of t.getAnimationRanges())null!=e&&this.createAnimationRange(e.name,e.from,e.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){this._sourceMesh?.receiveShadows!==e&&ee.S0.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){this._sourceMesh?.material!==e&&ee.S0.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){this._sourceMesh?.visibility!==e&&ee.S0.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){this._sourceMesh?.skeleton!==e&&ee.S0.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){this._sourceMesh&&e!==this._sourceMesh.renderingGroupId&&l.V.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}copyVerticesData(e,t){this._sourceMesh.copyVerticesData(e,t)}setVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,s),this.sourceMesh}updateVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,s),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;i="object"==typeof e?e:{applySkeleton:e,applyMorph:t};const s=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getData(i,null,O.R.PositionKind),s),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||l.V.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==dt.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new I.uq);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,I.AA.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(I.AA.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(t&&0!==t.length){const t=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,t.boundingSphere)}else this._currentLOD=this.sourceMesh;return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,s){const r=(s||this._sourceMesh).createInstance(e);if(Ze.r.DeepCopy(this,r,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(r.parent=t),!i)for(let e=0;e<this.getScene().meshes.length;e++){const t=this.getScene().meshes[e];t.parent===this&&t.clone(t.name,r)}return r.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(r),r}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);s&&i&&i(this,s);for(const e of this.getChildTransformNodes(!0))e.instantiateHierarchy(s,t,i);return s}}At.prototype.registerInstancedBuffer=function(e,t){if(this._userInstancedBuffersStorage?.vertexBuffers[e]?.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const e of this.instances)e.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[e]=null,this._userInstancedBuffersStorage.strides[e]=t,this._userInstancedBuffersStorage.sizes[e]=32*t,this._userInstancedBuffersStorage.data[e]=new Float32Array(this._userInstancedBuffersStorage.sizes[e]),this._userInstancedBuffersStorage.vertexBuffers[e]=new O.R(this.getEngine(),this._userInstancedBuffersStorage.data[e],e,!0,!1,t,!0);for(const t of this.instances)t.instancedBuffers[e]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()},At.prototype._processInstancedBuffers=function(e,t){const i=e?e.length:0;for(const s in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[s];const n=this._userInstancedBuffersStorage.strides[s],a=(i+1)*n;for(;r<a;)r*=2;this._userInstancedBuffersStorage.data[s].length!=r&&(this._userInstancedBuffersStorage.data[s]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[s]=r,this._userInstancedBuffersStorage.vertexBuffers[s]&&(this._userInstancedBuffersStorage.vertexBuffers[s].dispose(),this._userInstancedBuffersStorage.vertexBuffers[s]=null));const o=this._userInstancedBuffersStorage.data[s];let l=0;if(t){const e=this.instancedBuffers[s];e.toArray?e.toArray(o,l):e.copyToArray?e.copyToArray(o,l):o[l]=e,l+=n}for(let t=0;t<i;t++){const i=e[t].instancedBuffers[s];i.toArray?i.toArray(o,l):i.copyToArray?i.copyToArray(o,l):o[l]=i,l+=n}this._userInstancedBuffersStorage.vertexBuffers[s]?this._userInstancedBuffersStorage.vertexBuffers[s].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[s]=new O.R(this.getEngine(),this._userInstancedBuffersStorage.data[s],s,!0,!1,n,!0),this._invalidateInstanceVertexArrayObject())}},At.prototype._invalidateInstanceVertexArrayObject=function(){if(this._userInstancedBuffersStorage&&void 0!==this._userInstancedBuffersStorage.vertexArrayObjects){for(const e in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[e]);this._userInstancedBuffersStorage.vertexArrayObjects={}}},At.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const e in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[e]&&this._userInstancedBuffersStorage.vertexBuffers[e].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}},(0,V.Y5)("BABYLON.InstancedMesh",Tn);const yn={effect:null,subMesh:null};class Cn extends Ce{constructor(e,t,i,s={},r=!0){super(e,t,r),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new I.uq,this._cachedWorldViewProjectionMatrix=new I.uq,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...s}}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)}setTexture(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._textures[e]=t,this}removeTexture(e){delete this._textures[e]}setTextureArray(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return-1===this._options.externalTextures.indexOf(e)&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(16*t.length);for(let e=0;e<t.length;e++)t[e].copyToArray(i,16*e);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return-1===this._options.uniformBuffers.indexOf(e)&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return-1===this._options.samplerObjects.indexOf(e)&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return-1===this._options.storageBuffers.indexOf(e)&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){const i=e.trimEnd()+" ",s=this.options.defines.findIndex((t=>t===e||t.startsWith(i)));return s>=0&&this.options.defines.splice(s,1),("boolean"!=typeof t||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){const s=i&&this._storeEffectOnSubMeshes;if(this.isFrozen){const e=s?i._drawWrapper:this._drawWrapper;if(e.effect&&e._wasPreviouslyReady&&e._wasPreviouslyUsingInstances===t)return!0}const r=this.getScene(),n=r.getEngine(),a=[],o=[],l=new K;let h=this._shaderPath,c=this._options.uniforms,u=this._options.uniformBuffers,d=this._options.samplers;n.getCaps().multiview&&r.activeCamera&&r.activeCamera.outputRenderTarget&&r.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,a.push("#define MULTIVIEW"),-1!==c.indexOf("viewProjection")&&-1===c.indexOf("viewProjectionR")&&c.push("viewProjectionR"));for(let e=0;e<this._options.defines.length;e++){const t=0===this._options.defines[e].indexOf("#define")?this._options.defines[e]:`#define ${this._options.defines[e]}`;a.push(t)}for(let e=0;e<this._options.attributes.length;e++)o.push(this._options.attributes[e]);if(e&&e.isVerticesDataPresent(O.R.ColorKind)&&(-1===o.indexOf(O.R.ColorKind)&&o.push(O.R.ColorKind),a.push("#define VERTEXCOLOR")),t&&(a.push("#define INSTANCES"),(0,$.te)(o,this._materialHelperNeedsPreviousMatrices),e?.hasThinInstances&&(a.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(O.R.ColorInstanceKind)&&(o.push(O.R.ColorInstanceKind),a.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){o.push(O.R.MatricesIndicesKind),o.push(O.R.MatricesWeightsKind),e.numBoneInfluencers>4&&(o.push(O.R.MatricesIndicesExtraKind),o.push(O.R.MatricesWeightsExtraKind));const t=e.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),l.addCPUSkinningFallback(0,e),t.isUsingTextureForMatrices?(a.push("#define BONETEXTURE"),-1===c.indexOf("boneTextureWidth")&&c.push("boneTextureWidth"),-1===this._options.samplers.indexOf("boneSampler")&&this._options.samplers.push("boneSampler")):(a.push("#define BonesPerMesh "+(t.bones.length+1)),-1===c.indexOf("mBones")&&c.push("mBones"))}else a.push("#define NUM_BONE_INFLUENCERS 0");let _=0;const p=e?e.morphTargetManager:null;if(p){const e=p.supportsUVs&&-1!==a.indexOf("#define UV1"),t=p.supportsTangents&&-1!==a.indexOf("#define TANGENT"),i=p.supportsNormals&&-1!==a.indexOf("#define NORMAL");_=p.numMaxInfluencers||p.numInfluencers,e&&a.push("#define MORPHTARGETS_UV"),t&&a.push("#define MORPHTARGETS_TANGENT"),i&&a.push("#define MORPHTARGETS_NORMAL"),_>0&&a.push("#define MORPHTARGETS"),p.isUsingTextureForTargets&&(a.push("#define MORPHTARGETS_TEXTURE"),-1===c.indexOf("morphTargetTextureIndices")&&c.push("morphTargetTextureIndices"),-1===this._options.samplers.indexOf("morphTargets")&&this._options.samplers.push("morphTargets")),a.push("#define NUM_MORPH_INFLUENCERS "+_);for(let s=0;s<_;s++)o.push(O.R.PositionKind+s),i&&o.push(O.R.NormalKind+s),t&&o.push(O.R.TangentKind+s),e&&o.push(O.R.UVKind+"_"+s);_>0&&(c=c.slice(),c.push("morphTargetInfluences"),c.push("morphTargetCount"),c.push("morphTargetTextureInfo"),c.push("morphTargetTextureIndices"))}else a.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const t=e.bakedVertexAnimationManager;t&&t.isEnabled&&(a.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===c.indexOf("bakedVertexAnimationSettings")&&c.push("bakedVertexAnimationSettings"),-1===c.indexOf("bakedVertexAnimationTextureSizeInverted")&&c.push("bakedVertexAnimationTextureSizeInverted"),-1===c.indexOf("bakedVertexAnimationTime")&&c.push("bakedVertexAnimationTime"),-1===this._options.samplers.indexOf("bakedVertexAnimationTexture")&&this._options.samplers.push("bakedVertexAnimationTexture")),(0,$.J2)(o,e,a)}for(const e in this._textures)if(!this._textures[e].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&a.push("#define ALPHATEST"),!1!==this._options.useClipPlane&&((0,q.TV)(c),(0,q.tv)(this,r,a)),r.fogEnabled&&e?.applyFog&&r.fogMode!==be.Z.FOGMODE_NONE&&(a.push("#define FOG"),-1===c.indexOf("view")&&c.push("view"),-1===c.indexOf("vFogInfos")&&c.push("vFogInfos"),-1===c.indexOf("vFogColor")&&c.push("vFogColor")),this._useLogarithmicDepth&&(a.push("#define LOGARITHMICDEPTH"),-1===c.indexOf("logarithmicDepthConstant")&&c.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(c=c.slice(),u=u.slice(),d=d.slice(),h=this.customShaderNameResolve(this.name,c,u,d,a,o));const f=s?i._getDrawWrapper(void 0,!0):this._drawWrapper,m=f?.effect??null,g=f?.defines??null,v=a.join("\n");let b=m;return g!==v&&(b=n.createEffect(h,{attributes:o,uniformsNames:c,uniformBuffersNames:u,samplers:d,defines:v,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:_},shaderLanguage:this._options.shaderLanguage,extraInitializationsAsync:this._options.extraInitializationsAsync},n),s?i.setEffect(b,v,this._materialContext):f&&f.setEffect(b,v),this._onEffectCreatedObservable&&(yn.effect=b,yn.subMesh=i??e?.subMeshes[0]??null,this._onEffectCreatedObservable.notifyObservers(yn))),f._wasPreviouslyUsingInstances=!!t,!(!b?.isReady()??1)&&(m!==b&&r.resetCachedMaterial(),f._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,t){const i=this.getScene(),s=t??this.getEffect();s&&(-1!==this._options.uniforms.indexOf("world")&&s.setMatrix("world",e),-1!==this._options.uniforms.indexOf("worldView")&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),s.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==this._options.uniforms.indexOf("worldViewProjection")&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),s.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)),-1!==this._options.uniforms.indexOf("view")&&s.setMatrix("view",i.getViewMatrix()))}bindForSubMesh(e,t,i){this.bind(e,t,i._drawWrapperOverride?.effect,i)}bind(e,t,i,s){const r=s&&this._storeEffectOnSubMeshes,n=i??(r?s.effect:this.getEffect());if(!n)return;const a=this.getScene();this._activeEffect=n,this.bindOnlyWorldMatrix(e,i);const o=this._options.uniformBuffers;let l=!1;if(n&&o&&o.length>0&&a.getEngine().supportsUniformBuffers)for(let i=0;i<o.length;++i)switch(o[i]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),t.transferToEffect(e));break;case"Scene":(0,$._8)(n,a.getSceneUniformBuffer()),a.finalizeSceneUbo(),l=!0}const h=t&&r?this._mustRebind(a,n,s,t.visibility):a.getCachedMaterial()!==this;if(n&&h){let e;for(e in l||-1===this._options.uniforms.indexOf("view")||n.setMatrix("view",a.getViewMatrix()),l||-1===this._options.uniforms.indexOf("projection")||n.setMatrix("projection",a.getProjectionMatrix()),l||-1===this._options.uniforms.indexOf("viewProjection")||(n.setMatrix("viewProjection",a.getTransformMatrix()),this._multiview&&n.setMatrix("viewProjectionR",a._transformMatrixR)),a.activeCamera&&-1!==this._options.uniforms.indexOf("cameraPosition")&&n.setVector3("cameraPosition",a.activeCamera.globalPosition),(0,$.f$)(t,n),(0,q.gS)(n,this,a),this._useLogarithmicDepth&&(0,$.DL)(r?s.materialDefines:n.defines,n,a),t&&(0,$.Yy)(a,t,n),this._textures)n.setTexture(e,this._textures[e]);for(e in this._textureArrays)n.setTextureArray(e,this._textureArrays[e]);for(e in this._ints)n.setInt(e,this._ints[e]);for(e in this._uints)n.setUInt(e,this._uints[e]);for(e in this._floats)n.setFloat(e,this._floats[e]);for(e in this._floatsArrays)n.setArray(e,this._floatsArrays[e]);for(e in this._colors3)n.setColor3(e,this._colors3[e]);for(e in this._colors3Arrays)n.setArray3(e,this._colors3Arrays[e]);for(e in this._colors4){const t=this._colors4[e];n.setFloat4(e,t.r,t.g,t.b,t.a)}for(e in this._colors4Arrays)n.setArray4(e,this._colors4Arrays[e]);for(e in this._vectors2)n.setVector2(e,this._vectors2[e]);for(e in this._vectors3)n.setVector3(e,this._vectors3[e]);for(e in this._vectors4)n.setVector4(e,this._vectors4[e]);for(e in this._quaternions)n.setQuaternion(e,this._quaternions[e]);for(e in this._matrices)n.setMatrix(e,this._matrices[e]);for(e in this._matrixArrays)n.setMatrices(e,this._matrixArrays[e]);for(e in this._matrices3x3)n.setMatrix3x3(e,this._matrices3x3[e]);for(e in this._matrices2x2)n.setMatrix2x2(e,this._matrices2x2[e]);for(e in this._vectors2Arrays)n.setArray2(e,this._vectors2Arrays[e]);for(e in this._vectors3Arrays)n.setArray3(e,this._vectors3Arrays[e]);for(e in this._vectors4Arrays)n.setArray4(e,this._vectors4Arrays[e]);for(e in this._quaternionsArrays)n.setArray4(e,this._quaternionsArrays[e]);for(e in this._uniformBuffers){const t=this._uniformBuffers[e].getBuffer();t&&n.bindUniformBuffer(t,e)}const i=a.getEngine(),o=i.setExternalTexture;if(o)for(e in this._externalTextures)o.call(i,e,this._externalTextures[e]);const h=i.setTextureSampler;if(h)for(e in this._textureSamplers)h.call(i,e,this._textureSamplers[e]);const c=i.setStorageBuffer;if(c)for(e in this._storageBuffers)c.call(i,e,this._storageBuffers[e])}if(n&&t&&(h||!this.isFrozen)){const e=t.morphTargetManager;e&&e.numInfluencers>0&&(0,$.nR)(t,n);const i=t.bakedVertexAnimationManager;if(i&&i.isEnabled){const e=r?s._drawWrapper:this._drawWrapper;t.bakedVertexAnimationManager?.bind(n,!!e._wasPreviouslyUsingInstances)}}this._afterBind(t,n,s)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let t=0;t<i.length;t++)e.push(i[t])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let t=0;t<i.length;t++)if(i[t]===e)return!0}return!1}clone(e){const t=N.p.Clone((()=>new Cn(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes)),this);t.name=e,t.id=e,"object"==typeof t._shaderPath&&(t._shaderPath={...t._shaderPath}),this._options={...this._options},Object.keys(this._options).forEach((e=>{const t=this._options[e];Array.isArray(t)&&(this._options[e]=t.slice(0))})),this.stencil.copyTo(t.stencil);for(const e in this._textures)t.setTexture(e,this._textures[e]);for(const e in this._textureArrays)t.setTextureArray(e,this._textureArrays[e]);for(const e in this._externalTextures)t.setExternalTexture(e,this._externalTextures[e]);for(const e in this._ints)t.setInt(e,this._ints[e]);for(const e in this._uints)t.setUInt(e,this._uints[e]);for(const e in this._floats)t.setFloat(e,this._floats[e]);for(const e in this._floatsArrays)t.setFloats(e,this._floatsArrays[e]);for(const e in this._colors3)t.setColor3(e,this._colors3[e]);for(const e in this._colors3Arrays)t._colors3Arrays[e]=this._colors3Arrays[e];for(const e in this._colors4)t.setColor4(e,this._colors4[e]);for(const e in this._colors4Arrays)t._colors4Arrays[e]=this._colors4Arrays[e];for(const e in this._vectors2)t.setVector2(e,this._vectors2[e]);for(const e in this._vectors3)t.setVector3(e,this._vectors3[e]);for(const e in this._vectors4)t.setVector4(e,this._vectors4[e]);for(const e in this._quaternions)t.setQuaternion(e,this._quaternions[e]);for(const e in this._quaternionsArrays)t._quaternionsArrays[e]=this._quaternionsArrays[e];for(const e in this._matrices)t.setMatrix(e,this._matrices[e]);for(const e in this._matrixArrays)t._matrixArrays[e]=this._matrixArrays[e].slice();for(const e in this._matrices3x3)t.setMatrix3x3(e,this._matrices3x3[e]);for(const e in this._matrices2x2)t.setMatrix2x2(e,this._matrices2x2[e]);for(const e in this._vectors2Arrays)t.setArray2(e,this._vectors2Arrays[e]);for(const e in this._vectors3Arrays)t.setArray3(e,this._vectors3Arrays[e]);for(const e in this._vectors4Arrays)t.setArray4(e,this._vectors4Arrays[e]);for(const e in this._uniformBuffers)t.setUniformBuffer(e,this._uniformBuffers[e]);for(const e in this._textureSamplers)t.setTextureSampler(e,this._textureSamplers[e]);for(const e in this._storageBuffers)t.setStorageBuffer(e,this._storageBuffers[e]);return t}dispose(e,t,i){if(t){let e;for(e in this._textures)this._textures[e].dispose();for(e in this._textureArrays){const t=this._textureArrays[e];for(let e=0;e<t.length;e++)t[e].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=N.p.Serialize(this);let t;for(t in e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes,e.stencil=this.stencil.serialize(),e.textures={},this._textures)e.textures[t]=this._textures[t].serialize();for(t in e.textureArrays={},this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let s=0;s<i.length;s++)e.textureArrays[t].push(i[s].serialize())}for(t in e.ints={},this._ints)e.ints[t]=this._ints[t];for(t in e.uints={},this._uints)e.uints[t]=this._uints[t];for(t in e.floats={},this._floats)e.floats[t]=this._floats[t];for(t in e.floatsArrays={},this._floatsArrays)e.floatsArrays[t]=this._floatsArrays[t];for(t in e.colors3={},this._colors3)e.colors3[t]=this._colors3[t].asArray();for(t in e.colors3Arrays={},this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];for(t in e.colors4={},this._colors4)e.colors4[t]=this._colors4[t].asArray();for(t in e.colors4Arrays={},this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];for(t in e.vectors2={},this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();for(t in e.vectors3={},this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();for(t in e.vectors4={},this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();for(t in e.quaternions={},this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();for(t in e.matrices={},this._matrices)e.matrices[t]=this._matrices[t].asArray();for(t in e.matrixArray={},this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];for(t in e.matrices3x3={},this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];for(t in e.matrices2x2={},this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];for(t in e.vectors2Arrays={},this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];for(t in e.vectors3Arrays={},this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];for(t in e.vectors4Arrays={},this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];for(t in e.quaternionsArrays={},this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const s=N.p.Parse((()=>new Cn(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes)),e,t,i);let r;for(r in e.stencil&&s.stencil.parse(e.stencil,t,i),e.textures)s.setTexture(r,G.g.Parse(e.textures[r],t,i));for(r in e.textureArrays){const n=e.textureArrays[r],a=[];for(let e=0;e<n.length;e++)a.push(G.g.Parse(n[e],t,i));s.setTextureArray(r,a)}for(r in e.ints)s.setInt(r,e.ints[r]);for(r in e.uints)s.setUInt(r,e.uints[r]);for(r in e.floats)s.setFloat(r,e.floats[r]);for(r in e.floatsArrays)s.setFloats(r,e.floatsArrays[r]);for(r in e.colors3)s.setColor3(r,M.v9.FromArray(e.colors3[r]));for(r in e.colors3Arrays){const t=e.colors3Arrays[r].reduce(((e,t,i)=>(i%3==0?e.push([t]):e[e.length-1].push(t),e)),[]).map((e=>M.v9.FromArray(e)));s.setColor3Array(r,t)}for(r in e.colors4)s.setColor4(r,M.ov.FromArray(e.colors4[r]));for(r in e.colors4Arrays){const t=e.colors4Arrays[r].reduce(((e,t,i)=>(i%4==0?e.push([t]):e[e.length-1].push(t),e)),[]).map((e=>M.ov.FromArray(e)));s.setColor4Array(r,t)}for(r in e.vectors2)s.setVector2(r,I.I9.FromArray(e.vectors2[r]));for(r in e.vectors3)s.setVector3(r,I.Pq.FromArray(e.vectors3[r]));for(r in e.vectors4)s.setVector4(r,I.IU.FromArray(e.vectors4[r]));for(r in e.quaternions)s.setQuaternion(r,I.PT.FromArray(e.quaternions[r]));for(r in e.matrices)s.setMatrix(r,I.uq.FromArray(e.matrices[r]));for(r in e.matrixArray)s._matrixArrays[r]=new Float32Array(e.matrixArray[r]);for(r in e.matrices3x3)s.setMatrix3x3(r,e.matrices3x3[r]);for(r in e.matrices2x2)s.setMatrix2x2(r,e.matrices2x2[r]);for(r in e.vectors2Arrays)s.setArray2(r,e.vectors2Arrays[r]);for(r in e.vectors3Arrays)s.setArray3(r,e.vectors3Arrays[r]);for(r in e.vectors4Arrays)s.setArray4(r,e.vectors4Arrays[r]);for(r in e.quaternionsArrays)s.setArray4(r,e.quaternionsArrays[r]);return s}static ParseFromFileAsync(e,i,s,r=""){return new Promise(((n,a)=>{const o=new kt.u;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const i=JSON.parse(o.responseText),a=this.Parse(i,s||t.q.LastCreatedScene,r);e&&(a.name=e),n(a)}else a("Unable to load the ShaderMaterial")})),o.open("GET",i),o.send()}))}static ParseFromSnippetAsync(e,i,s=""){return new Promise(((r,n)=>{const a=new kt.u;a.addEventListener("readystatechange",(()=>{if(4==a.readyState)if(200==a.status){const n=JSON.parse(JSON.parse(a.responseText).jsonPayload),o=JSON.parse(n.shaderMaterial),l=this.Parse(o,i||t.q.LastCreatedScene,s);l.snippetId=e,r(l)}else n("Unable to load the snippet "+e)})),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()}))}}Cn.SnippetUrl="https://snippet.babylonjs.com",Cn.CreateFromSnippetAsync=Cn.ParseFromSnippetAsync,(0,V.Y5)("BABYLON.ShaderMaterial",Cn),At._LinesMeshParser=(e,t)=>Pn.Parse(e,t);class Pn extends At{_isShaderMaterial(e){return"ShaderMaterial"===e.getClassName()}constructor(e,t=null,i=null,s=null,n,a,o,l){super(e,t,i,s,n),this.useVertexColor=a,this.useVertexAlpha=o,this.color=new M.v9(1,1,1),this.alpha=1,this._shaderLanguage=0,s&&(this.color=s.color.clone(),this.alpha=s.alpha,this.useVertexColor=s.useVertexColor,this.useVertexAlpha=s.useVertexAlpha),this.intersectionThreshold=.1;const h={attributes:[O.R.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:[],useClipPlane:null,shaderLanguage:0};!1===o?h.needAlphaBlending=!1:h.defines.push("#define VERTEXALPHA"),a?(h.defines.push("#define VERTEXCOLOR"),h.attributes.push(O.R.ColorKind)):(h.uniforms.push("color"),this._color4=new M.ov),l?this.material=l:(this.getScene().getEngine().isWebGPU&&!Pn.ForceGLSL&&(this._shaderLanguage=1),h.shaderLanguage=this._shaderLanguage,h.extraInitializationsAsync=async()=>{1===this._shaderLanguage?await Promise.all([r.e(4935).then(r.bind(r,4935)),r.e(861).then(r.bind(r,861))]):await Promise.all([r.e(5216).then(r.bind(r,5216)),r.e(5450).then(r.bind(r,5450))])},this.material=new Cn("colorShader",this.getScene(),"color",h,!1),this.material.doNotSerialize=!0)}isReady(){return!!this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage||this.hasThinInstances)&&super.isReady()}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=Te.i.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,i):this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r:e,g:t,b:i}=this.color;this._color4.set(e,t,i,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const s=this.getScene().getEngine();return this._unIndexed?s.drawArraysType(Te.i.LineListDrawMode,e.verticesStart,e.verticesCount,i):s.drawElementsType(Te.i.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new Pn(e,this.getScene(),t,this,i)}createInstance(e){const t=new En(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const e in this.instancedBuffers)t.instancedBuffers[e]=this.instancedBuffers[e]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new Pn(e.name,t);return i.color=M.v9.FromArray(e.color),i.alpha=e.alpha,i}}Pn.ForceGLSL=!1;class En extends Tn{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function An(e){const t=[],i=[],s=e.lines,r=e.colors,n=[];let a=0;for(let e=0;e<s.length;e++){const o=s[e];for(let s=0;s<o.length;s++){const{x:l,y:h,z:c}=o[s];if(i.push(l,h,c),r){const t=r[e],{r:i,g:a,b:o,a:l}=t[s];n.push(i,a,o,l)}s>0&&(t.push(a-1),t.push(a)),a++}}const o=new at;return o.indices=t,o.positions=i,r&&(o.colors=n),o}function Rn(e){const t=e.dashSize||3,i=e.gapSize||1,s=e.dashNb||200,r=e.points,n=[],a=[],o=I.Pq.Zero();let l=0,h=0,c=0,u=0,d=0,_=0,p=0;for(p=0;p<r.length-1;p++)r[p+1].subtractToRef(r[p],o),l+=o.length();for(c=l/s,u=t*c/(t+i),p=0;p<r.length-1;p++){r[p+1].subtractToRef(r[p],o),h=Math.floor(o.length()/c),o.normalize();for(let e=0;e<h;e++)d=c*e,n.push(r[p].x+d*o.x,r[p].y+d*o.y,r[p].z+d*o.z),n.push(r[p].x+(d+u)*o.x,r[p].y+(d+u)*o.y,r[p].z+(d+u)*o.z),a.push(_,_+1),_+=2}const f=new at;return f.positions=n,f.indices=a,f}function In(e,t,i=null){const s=t.colors?[t.colors]:null;return function(e,t,i=null){const s=t.instance,r=t.lines,n=t.colors;if(s){const e=s.getVerticesData(O.R.PositionKind);let t,i;n&&(t=s.getVerticesData(O.R.ColorKind));let a=0,o=0;for(let s=0;s<r.length;s++){const l=r[s];for(let r=0;r<l.length;r++)e[a]=l[r].x,e[a+1]=l[r].y,e[a+2]=l[r].z,n&&t&&(i=n[s],t[o]=i[r].r,t[o+1]=i[r].g,t[o+2]=i[r].b,t[o+3]=i[r].a,o+=4),a+=3}return s.updateVerticesData(O.R.PositionKind,e,!1,!1),n&&t&&s.updateVerticesData(O.R.ColorKind,t,!1,!1),s.refreshBoundingInfo(),s}const a=new Pn(e,i,null,void 0,void 0,!!n,t.useVertexAlpha,t.material);return An(t).applyToMesh(a,t.updatable),a}(e,{lines:[t.points],updatable:t.updatable,instance:t.instance,colors:s,useVertexAlpha:t.useVertexAlpha,material:t.material},i)}var Mn,On;function wn(e){let t=0;const i=Date.now();e.observableParameters=e.observableParameters??{};const s=e.contextObservable.add((r=>{const n=Date.now();t=n-i;const a={startTime:i,currentTime:n,deltaTime:t,completeRate:t/e.timeout,payload:r};e.onTick&&e.onTick(a),e.breakCondition&&e.breakCondition()&&(e.contextObservable.remove(s),e.onAborted&&e.onAborted(a)),t>=e.timeout&&(e.contextObservable.remove(s),e.onEnded&&e.onEnded(a))}),e.observableParameters.mask,e.observableParameters.insertFirst,e.observableParameters.scope);return s}at.CreateLineSystem=An,at.CreateDashedLines=Rn,At.CreateLines=(e,t,i=null,s=!1,r=null)=>In(e,{points:t,updatable:s,instance:r},i),At.CreateDashedLines=(e,t,i,s,r,n=null,a,o)=>function(e,t,i=null){const s=t.points,r=t.instance,n=t.gapSize||1,a=t.dashSize||3;if(r){const e=e=>{const t=I.Pq.Zero(),i=e.length/6;let n=0,a=0,o=0,l=0,h=0,c=0,u=0,d=0;for(u=0;u<s.length-1;u++)s[u+1].subtractToRef(s[u],t),n+=t.length();o=n/i;const _=r._creationDataStorage.dashSize;for(l=_*o/(_+r._creationDataStorage.gapSize),u=0;u<s.length-1;u++)for(s[u+1].subtractToRef(s[u],t),a=Math.floor(t.length()/o),t.normalize(),d=0;d<a&&c<e.length;)h=o*d,e[c]=s[u].x+h*t.x,e[c+1]=s[u].y+h*t.y,e[c+2]=s[u].z+h*t.z,e[c+3]=s[u].x+(h+l)*t.x,e[c+4]=s[u].y+(h+l)*t.y,e[c+5]=s[u].z+(h+l)*t.z,c+=6,d++;for(;c<e.length;)e[c]=s[u].x,e[c+1]=s[u].y,e[c+2]=s[u].z,c+=3};return(t.dashNb||t.dashSize||t.gapSize||t.useVertexAlpha||t.material)&&l.V.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),r.updateMeshPositions(e,!1),r}const o=new Pn(e,i,null,void 0,void 0,void 0,t.useVertexAlpha,t.material);return Rn(t).applyToMesh(o,t.updatable),o._creationDataStorage=new Tt,o._creationDataStorage.dashSize=a,o._creationDataStorage.gapSize=n,o}(e,{points:t,dashSize:i,gapSize:s,dashNb:r,updatable:a,instance:o},n),function(e){e[e.INIT=0]="INIT",e[e.STARTED=1]="STARTED",e[e.ENDED=2]="ENDED"}(Mn||(Mn={}));class Dn extends pr{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const t=this._options.teleportationTargetMesh.getChildMeshes(!1,(e=>"rotationCone"===e.name));t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new M.ov(1,1,1,1),this._tmpRay=new qi(new I.Pq,new I.Pq),this._tmpVector=new I.Pq,this._tmpQuaternion=new I.PT,this._worldScaleObserver=null,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new C.cP,this.teleportationEnabled=!0,this._rotationEnabled=!0,this.onBeforeCameraTeleportRotation=new C.cP,this.onAfterCameraTeleportRotation=new C.cP,this._attachController=e=>{if(this._controllers[e.uniqueId]||this._options.forceHandedness&&e.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[e.uniqueId]={xrController:e,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1,initialHit:!1,mainComponentUsed:!1}};const t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){const i=()=>{if(e.motionController){const i=e.motionController.getComponentOfType(Ls.THUMBSTICK_TYPE)||e.motionController.getComponentOfType(Ls.TOUCHPAD_TYPE);if(!i||this._options.useMainComponentOnly){const i=e.motionController.getMainComponent();if(!i)return;t.teleportationState.mainComponentUsed=!0,t.teleportationComponent=i,t.onButtonChangedObserver=i.onButtonStateChangedObservable.add((()=>{if(!this.teleportationEnabled)return;const s=()=>{t.teleportationState.forward=!0,t.teleportationState.initialHit=!1,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0,wn({timeout:this._options.timeToTeleport||3e3,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!i.pressed,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})};i.changes.pressed&&(i.changes.pressed.current?this._options.timeToTeleportStart?wn({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{i.pressed&&s()}}):s():(t.teleportationState.forward=!1,this._currentTeleportationControllerId=""))}))}else t.teleportationComponent=i,t.onAxisChangedObserver=i.onAxisValueChangedObservable.add((i=>{if(i.y<=.7&&t.teleportationState.backwards&&(t.teleportationState.backwards=!1),i.y>.7&&!t.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!t.teleportationState.backwards){t.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,I.PT.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const e=this._xrSessionManager.scene.pickWithRay(this._tmpRay,(e=>-1!==this._floorMeshes.indexOf(e)));e&&e.pickedPoint&&(this._options.xrInput.xrCamera.position.x=e.pickedPoint.x,this._options.xrInput.xrCamera.position.z=e.pickedPoint.z)}if(i.y<-.7&&!this._currentTeleportationControllerId&&!t.teleportationState.rotating&&this.teleportationEnabled&&(t.teleportationState.forward=!0,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),i.x){if(t.teleportationState.forward)this._currentTeleportationControllerId===t.xrController.uniqueId&&(this.rotationEnabled?setTimeout((()=>{t.teleportationState.currentRotation=Math.atan2(i.x,i.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))})):t.teleportationState.currentRotation=0);else if(!t.teleportationState.rotating&&Math.abs(i.x)>.7){t.teleportationState.rotating=!0;const e=this.rotationAngle*(i.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this.onBeforeCameraTeleportRotation.notifyObservers(e),I.PT.FromEulerAngles(0,e,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleportRotation.notifyObservers(this._options.xrInput.xrCamera.rotationQuaternion)}}else t.teleportationState.rotating=!1;0===i.x&&0===i.y&&(t.teleportationState.blocked&&(t.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),t.teleportationState.forward&&this._teleportForward(e.uniqueId))}))}};e.motionController?i():e.onMotionControllerInitObservable.addOnce((()=>{i()}))}else{t.teleportationState.mainComponentUsed=!0;let i=!1;const s=()=>{this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.forward=!0,t.teleportationState.initialHit=!1,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0,wn({timeout:this._options.timeToTeleport||3e3,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})};this._xrSessionManager.scene.onPointerObservable.add((e=>{e.type===Rt.Zp.POINTERDOWN?(i=!1,this._options.timeToTeleportStart?wn({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&s()},breakCondition:()=>!!i&&(i=!1,!0)}):s()):e.type===Rt.Zp.POINTERUP&&(i=!0,t.teleportationState.forward=!1,this._currentTeleportationControllerId="")}))}},this._colorArray=Array(24).fill(this._cachedColor4White),this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new M.ov(1,0,0,.75),this._setTargetMeshVisibility(!1),this.onBeforeCameraTeleport=t.xrInput.xrCamera.onBeforeCameraTeleport,this.onAfterCameraTeleport=t.xrInput.xrCamera.onAfterCameraTeleport,this.parabolicCheckRadius*=this._xrSessionManager.worldScalingFactor,this._worldScaleObserver=e.onWorldScaleFactorChangedObservable.add((e=>{this.parabolicCheckRadius=this.parabolicCheckRadius/e.previousScaleFactor*e.newScaleFactor,this._options.teleportationTargetMesh?.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor)}))}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return!!super.attach()&&(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0)}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver)}removeFloorMesh(e){const t=this._floorMeshes.indexOf(e);-1!==t&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const t=this._options.pickBlockerMeshes.indexOf(e);-1!==t&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){const t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(-1===t)for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}return-1!==t&&(this._snapToPositions.splice(t,1),!0)}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;const s=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!s)return;s.rotationQuaternion=s.rotationQuaternion||new I.PT;const e=this._controllers[this._currentTeleportationControllerId];if(e&&e.teleportationState.forward){I.PT.RotationYawPitchRollToRef(e.teleportationState.currentRotation+e.teleportationState.baseRotation,0,0,s.rotationQuaternion);let t=!1;const r="transient-pointer"!==e.xrController.inputSource.targetRayMode;if(e.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const s=i.pickWithRay(this._tmpRay,(e=>{if(this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(e))return!0;if(this._options.blockAllPickableMeshes&&e.isPickable)return!0;if(this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(e))return!0;const t=this._floorMeshes.indexOf(e);return-1!==t&&this._floorMeshes[t].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y})),n=s&&s.pickedMesh&&-1!==this._floorMeshes.indexOf(s.pickedMesh);if(s&&s.pickedMesh&&!n)return e.teleportationState.mainComponentUsed&&!e.teleportationState.initialHit?void(e.teleportationState.forward=!1):(e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,r),void this._showParabolicPath(s));s&&s.pickedPoint&&(e.teleportationState.initialHit=!0,e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(s),this._setTargetMeshVisibility(!0,!1,r),this._showParabolicPath(s))}if(this.parabolicRayEnabled&&!t){const s=e.xrController.pointer.rotationQuaternion.toEulerAngles().x,n=Math.PI/2-Math.abs(s)+1,a=this.parabolicCheckRadius*n;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(2*a),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(a)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const o=i.pickWithRay(this._tmpRay,(e=>!(!this._options.blockerMeshesPredicate||!this._options.blockerMeshesPredicate(e))||!(!this._options.blockAllPickableMeshes||!e.isPickable)||!(!this._options.pickBlockerMeshes||-1===this._options.pickBlockerMeshes.indexOf(e))||-1!==this._floorMeshes.indexOf(e))),l=o&&o.pickedMesh&&-1!==this._floorMeshes.indexOf(o.pickedMesh);if(o&&o.pickedMesh&&!l)return e.teleportationState.mainComponentUsed&&!e.teleportationState.initialHit?void(e.teleportationState.forward=!1):(e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,r),void this._showParabolicPath(o));o&&o.pickedPoint&&(e.teleportationState.initialHit=!0,e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(o),this._setTargetMeshVisibility(!0,!1,r),this._showParabolicPath(o))}this._setTargetMeshVisibility(t,!1,r)}else this._setTargetMeshVisibility(!1,!1,!0)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1,!1,!0)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||fr.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=vi("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const i=512,s=new ss("teleportationPlaneDynamicTexture",i,e,!0);s.hasAlpha=!0;const r=s.getContext(),n=i/2,a=i/2,o=200;r.beginPath(),r.arc(n,a,o,0,2*Math.PI,!1),r.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",r.fill(),r.lineWidth=10,r.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",r.stroke(),r.closePath(),s.update();const l=new Oe("teleportationPlaneMaterial",e);l.diffuseTexture=s,t.material=l}const i=Es("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){const t=new Kt("animationInnerCircle","position.y",30,Kt.ANIMATIONTYPE_FLOAT,Kt.ANIMATIONLOOPMODE_CYCLE),s=[];s.push({frame:0,value:0}),s.push({frame:30,value:.4}),s.push({frame:60,value:0}),t.setKeys(s);const r=new Ft;r.setEasingMode(Ot.EASINGMODE_EASEINOUT),t.setEasingFunction(r),i.animations=[],i.animations.push(t),e.beginAnimation(i,0,60,!0)}const s=_r("rotationCone",{diameterTop:0,tessellation:4},e);if(s.isPickable=!1,s.scaling.set(.5,.12,.2),s.rotate(mt._0.X,Math.PI/2),s.position.z=.6,s.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,s.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const t=new Oe("torusConsMat",e);t.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,t.disableLighting?t.emissiveColor=new M.v9(.3,.3,1):t.diffuseColor=new M.v9(.3,.3,1),t.alpha=.9,i.material=t,s.material=t,this._teleportationRingMaterial=t}void 0!==this._options.renderingGroupId&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._options.teleportationTargetMesh.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._setTargetMeshVisibility(!1)}_detachController(e){const t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,s=Number.MAX_VALUE;if(this._snapToPositions.length){const r=t*t;this._snapToPositions.forEach((t=>{const n=I.Pq.DistanceSquared(t,e);n<=r&&n<s&&(s=n,i=t)}))}return i}_setTargetMeshPosition(e){const t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;const i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t,i){this._options.teleportationTargetMesh&&(this._options.teleportationTargetMesh.isVisible!==e||t)&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach((t=>{t.isVisible=e})),e?this._selectionFeature&&i&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&i&&this._selectionFeature.attach()))}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||fr.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],s=Mt.jj.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),r=i.teleportationState.blocked?this._blockedRayColor:void 0,n=this._colorArray.fill(r||this._cachedColor4White),a=s.getPoints();a.shift(),a.shift(),this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(s.getPoints(),e):this._quadraticBezierCurve=In("teleportation path line",{points:a,instance:this._quadraticBezierCurve,updatable:!0,colors:n},t),this._quadraticBezierCurve.isPickable=!1,void 0!==this._options.renderingGroupId&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const t=this._controllers[e];if(t&&t.teleportationState.forward&&this.teleportationEnabled&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!this.snapPointsOnly||this._snappedToPoint))if(this.skipNextTeleportation)this.skipNextTeleportation=!1;else if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const e=this._options.xrInput.xrCamera.realWorldHeight;this.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=e,I.PT.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}Dn.Name=Os.TELEPORTATION,Dn.Version=1,ws.AddWebXRFeature(Dn.Name,((e,t)=>()=>new Dn(e,t)),Dn.Version,!0);class Fn{constructor(){}static CreateAsync(e,t={}){const i=new Fn;if(e.onDisposeObservable.addOnce((()=>{i.dispose()})),!t.disableDefaultUI){const s={renderTarget:i.renderTarget,...t.uiOptions||{}};t.optionalFeatures&&("boolean"==typeof t.optionalFeatures?s.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:s.optionalFeatures=t.optionalFeatures),i.enterExitUI=new _n(e,s)}return Ns.CreateAsync(e).then((e=>{if(i.baseExperience=e,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new ur(e.sessionManager,e.camera,{controllerOptions:{renderingGroupId:t.renderingGroupId},...t.inputOptions||{}}),!t.disablePointerSelection){const e={...t.pointerSelectionOptions,xrInput:i.input,renderingGroupId:t.renderingGroupId};i.pointerSelection=i.baseExperience.featuresManager.enableFeature(mr.Name,t.useStablePlugins?"stable":"latest",e),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(Dn.Name,t.useStablePlugins?"stable":"latest",{floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId,...t.teleportationOptions}),i.teleportation.setSelectionFeature(i.pointerSelection))}return t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(un.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...t.nearInteractionOptions})),t.disableHandTracking||i.baseExperience.featuresManager.enableFeature(Sn.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,...t.handSupportOptions},void 0,!1),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),t.disableDefaultUI?void 0:i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)})).then((()=>i)).catch((e=>(l.V.Error("Error initializing XR"),l.V.Error(e),i)))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}be.Z.prototype.createDefaultLight=function(e=!1){if(e&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();0===this.lights.length&&new je("default light",I.Pq.Up(),this)},be.Z.prototype.createDefaultCamera=function(e=!1,t=!1,i=!1){if(t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const t=this.getWorldExtends((e=>e.isVisible&&e.isEnabled())),s=t.max.subtract(t.min),r=t.min.add(s.scale(.5));let n,a=1.5*s.length();if(isFinite(a)||(a=1,r.copyFromFloats(0,0,0)),e){const e=new oi("default camera",-Math.PI/2,Math.PI/2,a,r,this);e.lowerRadiusLimit=.01*a,e.wheelPrecision=100/a,n=e}else{const e=new Ri("default camera",new I.Pq(r.x,r.y,-a),this);e.setTarget(r),n=e}n.minZ=.01*a,n.maxZ=1e3*a,n.speed=.2*a,this.activeCamera=n,i&&n.attachControl()}},be.Z.prototype.createDefaultCameraOrLight=function(e=!1,t=!1,i=!1){this.createDefaultLight(t),this.createDefaultCamera(e,t,i)},be.Z.prototype.createDefaultSkybox=function(e,t=!1,i=1e3,s=0,r=!0){if(!e)return l.V.Warn("Can not create default skybox without environment texture."),null;r&&e&&(this.environmentTexture=e);const n=xi("hdrSkyBox",{size:i},this);if(t){const t=new $e("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=G.g.SKYBOX_MODE),t.microSurface=1-s,t.disableLighting=!0,t.twoSidedLighting=!0,n.material=t}else{const t=new Oe("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=G.g.SKYBOX_MODE),t.disableLighting=!0,n.material=t}return n.isPickable=!1,n.infiniteDistance=!0,n.ignoreCameraMaxZ=!0,n},be.Z.prototype.createDefaultEnvironment=function(e){return Si?new Si(e,this):null},be.Z.prototype.createDefaultVRExperience=function(e={}){return new Is(this,e)},be.Z.prototype.createDefaultXRExperienceAsync=function(e={}){return Fn.CreateAsync(this,e).then((e=>e))},(0,V.Y5)("BABYLON.BonesBlock",class extends Ir{constructor(e){super(e,vr.Vertex),this.registerInput("matricesIndices",gr.Vector4),this.registerInput("matricesWeights",gr.Vector4),this.registerInput("matricesIndicesExtra",gr.Vector4,!0),this.registerInput("matricesWeightsExtra",gr.Vector4,!0),this.registerInput("world",gr.Matrix),this.registerOutput("output",gr.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(r.bind(r,2806)),Promise.resolve().then(r.bind(r,5470))]):await Promise.all([Promise.resolve().then(r.bind(r,9707)),Promise.resolve().then(r.bind(r,3361))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e,t=(()=>!0)){if(!this.matricesIndices.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesIndices"===e.name&&t(e)));i||(i=new Vr("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesWeights"===e.name&&t(e)));i||(i=new Vr("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.World&&t(e)));i||(i=new Vr("world"),i.setAsSystemValue(Ar.World)),i.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){(0,$.f$)(i,e)}prepareDefines(e,t,i){i._areAttributesDirty&&(0,$.IC)(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const s=this._outputs[0],r=this.world;return e.compilationString+="#if NUM_BONE_INFLUENCERS>0\n",e.compilationString+=e._declareOutput(s)+` = ${r.associatedVariableName} * ${i};\n`,e.compilationString+="#else\n",e.compilationString+=e._declareOutput(s)+` = ${r.associatedVariableName};\n`,e.compilationString+="#endif\n",this}}),(0,V.Y5)("BABYLON.InstancesBlock",class extends Ir{constructor(e){super(e,vr.Vertex),this.registerInput("world0",gr.Vector4),this.registerInput("world1",gr.Vector4),this.registerInput("world2",gr.Vector4),this.registerInput("world3",gr.Vector4),this.registerInput("world",gr.Matrix,!0),this.registerOutput("output",gr.Matrix),this.registerOutput("instanceID",gr.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e,t=(()=>!0)){if(!this.world0.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world0"===e.name&&t(e)));i||(i=new Vr("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world1"===e.name&&t(e)));i||(i=new Vr("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world2"===e.name&&t(e)));i||(i=new Vr("world2"),i.setAsAttribute("world2")),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world3"===e.name&&t(e)));i||(i=new Vr("world3"),i.setAsAttribute("world3")),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world"===e.name&&t(e)));i||(i=new Vr("world"),i.setAsSystemValue(Ar.World)),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,s=!1,r){let n=!1;i.INSTANCES!==s&&(i.setValue("INSTANCES",s),n=!0),r&&i.THIN_INSTANCES!==!!r?.getRenderingMesh().hasThinInstances&&(i.setValue("THIN_INSTANCES",!!r?.getRenderingMesh().hasThinInstances),n=!0),n&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],s=this._outputs[1],r=this.world0,n=this.world1,a=this.world2,o=this.world3;let l="mat4",h="gl_InstanceID",c="float";return 1===e.shaderLanguage&&(l="mat4x4f",h="vertexInputs.instanceIndex",c="f32"),e.compilationString+="#ifdef INSTANCES\n",e.compilationString+=e._declareOutput(i)+` = ${l}(${r.associatedVariableName}, ${n.associatedVariableName}, ${a.associatedVariableName}, ${o.associatedVariableName});\n`,e.compilationString+="#ifdef THIN_INSTANCES\n",e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};\n`,e.compilationString+="#endif\n",t._caps.canUseGLInstanceID?e.compilationString+=e._declareOutput(s)+` = ${c}(${h});\n`:e.compilationString+=e._declareOutput(s)+" = 0.0;\n",e.compilationString+="#else\n",e.compilationString+=e._declareOutput(i)+` = ${this.world.associatedVariableName};\n`,e.compilationString+=e._declareOutput(s)+" = 0.0;\n",e.compilationString+="#endif\n",this}});class Nn extends Ir{constructor(e){super(e,vr.Vertex),this.registerInput("position",gr.Vector3),this.registerInput("normal",gr.Vector3),this.registerInput("tangent",gr.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(gr.Color4|gr.Vector4|gr.Vector3),this.registerInput("uv",gr.Vector2),this.registerOutput("positionOutput",gr.Vector3),this.registerOutput("normalOutput",gr.Vector3),this.registerOutput("tangentOutput",gr.Vector4),this.registerOutput("uvOutput",gr.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(r.bind(r,9129)),Promise.resolve().then(r.bind(r,8217)),Promise.resolve().then(r.bind(r,8258)),Promise.resolve().then(r.bind(r,6340))]):await Promise.all([Promise.resolve().then(r.bind(r,5060)),Promise.resolve().then(r.bind(r,738)),Promise.resolve().then(r.bind(r,8451)),Promise.resolve().then(r.bind(r,7999))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=(()=>!0)){if(!this.position.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"position"===e.name&&t(e)));i||(i=new Vr("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"normal"===e.name&&t(e)));i||(i=new Vr("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"tangent"===e.name&&t(e)));i||(i=new Vr("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new Vr("uv"),i.setAsAttribute("uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){const t=e.morphTargetManager;t?.isUsingTextureForTargets&&(t.numMaxInfluencers||t.numInfluencers)!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}i._areAttributesDirty&&(0,$.Jz)(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&((0,$.nR)(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,s){const r=this.position,n=this.normal,a=this.tangent,o=this.uv,l=this.positionOutput,h=this.normalOutput,c=this.tangentOutput,u=this.uvOutput,d=e,_=s.NUM_MORPH_INFLUENCERS,p=i.morphTargetManager,f=p&&p.supportsNormals&&s.NORMAL,m=p&&p.supportsTangents&&s.TANGENT,g=p&&p.supportsUVs&&s.UV1;let v="";p?.isUsingTextureForTargets&&_>0&&(v+=`${d._declareLocalVar("vertexID",gr.Float)};\n`),v+="#ifdef MORPHTARGETS\n";const b=1===d.shaderLanguage,x=b?"uniforms.":"";if(p?.isUsingTextureForTargets)v+=`for (${b?"var":"int"} i = 0; i < NUM_MORPH_INFLUENCERS; i++) {\n`,v+=`if (i >= ${x}morphTargetCount) { break; }\n`,v+=`vertexID = ${b?"f32(vertexInputs.vertexIndex":"float(gl_VertexID"}) * ${x}morphTargetTextureInfo.x;\n`,v+=`${l.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${r.associatedVariableName}) * ${x}morphTargetInfluences[i];\n`,v+="vertexID += 1.0;\n",f&&(v+="#ifdef MORPHTARGETS_NORMAL\n",v+=`${h.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${n.associatedVariableName}) * ${x}morphTargetInfluences[i];\n`,v+="vertexID += 1.0;\n",v+="#endif\n"),g&&(v+="#ifdef MORPHTARGETS_UV\n",v+=`${u.associatedVariableName} += (readVector3FromRawSampler(i, vertexID).xy - ${o.associatedVariableName}) * ${x}morphTargetInfluences[i];\n`,v+="vertexID += 1.0;\n",v+="#endif\n"),m&&(v+="#ifdef MORPHTARGETS_TANGENT\n",v+=`${c.associatedVariableName}.xyz += (readVector3FromRawSampler(i, vertexID) - ${a.associatedVariableName}.xyz) * ${x}morphTargetInfluences[i];\n`,a.type===gr.Vector4?v+=`${c.associatedVariableName}.w = ${a.associatedVariableName}.w;\n`:v+=`${c.associatedVariableName}.w = 1.;\n`,v+="#endif\n"),v+="}\n";else for(let e=0;e<_;e++)v+=`${l.associatedVariableName} += (position${e} - ${r.associatedVariableName}) * ${x}morphTargetInfluences[${e}];\n`,f&&(v+="#ifdef MORPHTARGETS_NORMAL\n",v+=`${h.associatedVariableName} += (normal${e} - ${n.associatedVariableName}) * ${x}morphTargetInfluences[${e}];\n`,v+="#endif\n"),g&&(v+="#ifdef MORPHTARGETS_UV\n",v+=`${u.associatedVariableName}.xy += (uv_${e} - ${o.associatedVariableName}.xy) * ${x}morphTargetInfluences[${e}];\n`,v+="#endif\n"),m&&(v+="#ifdef MORPHTARGETS_TANGENT\n",v+=`${c.associatedVariableName}.xyz += (tangent${e} - ${a.associatedVariableName}.xyz) * ${x}morphTargetInfluences[${e}];\n`,a.type===gr.Vector4?v+=`${c.associatedVariableName}.w = ${a.associatedVariableName}.w;\n`:v+=`${c.associatedVariableName}.w = 1.;\n`,v+="#endif\n");if(v+="#endif\n",d.compilationString=d.compilationString.replace(this._repeatableContentAnchor,v),_>0)for(let e=0;e<_;e++)d.attributes.push(O.R.PositionKind+e),f&&d.attributes.push(O.R.NormalKind+e),m&&d.attributes.push(O.R.TangentKind+e),g&&d.attributes.push(O.R.UVKind+"_"+e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,s=this.tangent,r=this.uv,n=this.positionOutput,a=this.normalOutput,o=this.tangentOutput,l=this.uvOutput,h=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetCount"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",h),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",h,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${e._declareOutput(n)} = ${t.associatedVariableName};\n`,e.compilationString+="#ifdef NORMAL\n",e.compilationString+=`${e._declareOutput(a)} = ${i.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(a)} = vec3(0., 0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef TANGENT\n",e.compilationString+=`${e._declareOutput(o)} = ${s.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(o)} = vec4(0., 0., 0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef UV1\n",e.compilationString+=`${e._declareOutput(l)} = ${r.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(l)} = vec2(0., 0.);\n`,e.compilationString+="#endif\n",this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}(0,V.Y5)("BABYLON.MorphTargetsBlock",Nn);class Ln extends z{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=I.uq.Identity(),this._projectionMatrix=I.uq.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return!(!this.parent||!this.parent.getWorldMatrix||(this.transformedPosition||(this.transformedPosition=I.Pq.Zero()),I.Pq.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=I.Pq.Zero()),I.Pq.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),0))}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=I.Pq.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=I.Pq.Cross(this.direction,mt._0.Y),t=I.Pq.Cross(e,this.direction);return I.Pq.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=I.Pq.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=I.uq.Identity()),I.uq.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),this.parent&&this.parent.getWorldMatrix||(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){const t=I.AA.Vector3[0];let i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),I.Pq.NormalizeToRef(this.getShadowDirection(e),t),1===Math.abs(I.Pq.Dot(t,I.Pq.Up()))&&(t.z=1e-13);const s=I.AA.Vector3[1];return i.addToRef(t,s),I.uq.LookAtLHToRef(i,s,I.Pq.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}}(0,w.Cg)([(0,D.P_)()],Ln.prototype,"position",null),(0,w.Cg)([(0,D.P_)()],Ln.prototype,"direction",null),(0,w.Cg)([(0,D.lK)()],Ln.prototype,"shadowMinZ",null),(0,w.Cg)([(0,D.lK)()],Ln.prototype,"shadowMaxZ",null),B.AddNodeConstructor("Light_Type_0",((e,t)=>()=>new Bn(e,I.Pq.Zero(),t)));class Bn extends Ln{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return z.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new I.Pq(1,0,0);case 1:return new I.Pq(-1,0,0);case 2:return new I.Pq(0,-1,0);case 3:return new I.Pq(0,1,0);case 4:return new I.Pq(0,0,1);case 5:return new I.Pq(0,0,-1)}return I.Pq.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;const r=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,n=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;I.uq.PerspectiveFovLHToRef(this.shadowAngle,1,a?n:r,a?r:n,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}(0,w.Cg)([(0,D.lK)()],Bn.prototype,"shadowAngle",null),(0,V.Y5)("BABYLON.PointLight",Bn),(0,V.Y5)("BABYLON.LightInformationBlock",class extends Ir{constructor(e){super(e,vr.Vertex),this.registerInput("worldPosition",gr.Vector4,!1,vr.Vertex),this.registerOutput("direction",gr.Vector3),this.registerOutput("color",gr.Color3),this.registerOutput("intensity",gr.Float),this.registerOutput("shadowBias",gr.Float),this.registerOutput("shadowNormalBias",gr.Float),this.registerOutput("shadowDepthScale",gr.Float),this.registerOutput("shadowDepthRange",gr.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let s=this.light;const r=t.getScene();if(!s&&r.lights.length&&(s=this.light=r.lights[0],this._forcePrepareDefines=!0),!s||!s.isEnabled)return e.setFloat3(this._lightDataUniformName,0,0,0),void e.setFloat4(this._lightColorUniformName,0,0,0,0);s.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,s.diffuse,s.intensity);const n=s.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(n?e.setFloat3(this._lightShadowUniformName,n.bias,n.normalBias,n.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(n&&r.activeCamera){const t=s;e.setFloat2(this._lightShadowExtraUniformName,t.getDepthMinZ(r.activeCamera),t.getDepthMinZ(r.activeCamera)+t.getDepthMaxZ(r.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const s=this.light;i.setValue(this._lightTypeDefineName,!!(s&&s instanceof Bn),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,s=this.intensity,r=this.shadowBias,n=this.shadowNormalBias,a=this.shadowDepthScale,o=this.shadowDepthRange;this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE");const l=1===e.shaderLanguage?"uniforms.":"";return e._emitUniformFromString(this._lightDataUniformName,gr.Vector3),e._emitUniformFromString(this._lightColorUniformName,gr.Vector4),e.compilationString+=`#ifdef ${this._lightTypeDefineName}\n`,e.compilationString+=e._declareOutput(t)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${l}${this._lightDataUniformName});\n`,e.compilationString+="#else\n",e.compilationString+=e._declareOutput(t)+` = ${l}${this._lightDataUniformName};\n`,e.compilationString+="#endif\n",e.compilationString+=e._declareOutput(i)+` = ${l}${this._lightColorUniformName}.rgb;\n`,e.compilationString+=e._declareOutput(s)+` = ${l}${this._lightColorUniformName}.a;\n`,(r.hasEndpoints||n.hasEndpoints||a.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,gr.Vector3),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${l}${this._lightShadowUniformName}.x;\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${l}${this._lightShadowUniformName}.y;\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${l}${this._lightShadowUniformName}.z;\n`)),o.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,gr.Vector2),e.compilationString+=e._declareOutput(o)+` = ${this._lightShadowUniformName};\n`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}}),r(2806),r(5470),r(9707),r(3361),r(9129),r(8217),r(8258),r(6340),r(5060),r(738),r(8451),r(7999);class kn extends Ir{constructor(e){super(e,vr.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",gr.AutoDetect),this.registerOutput("output",gr.Color4),this.registerOutput("rgb",gr.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Color4|gr.Vector3|gr.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(r.bind(r,9702)),Promise.resolve().then(r.bind(r,6205)),Promise.resolve().then(r.bind(r,8996))]):await Promise.all([Promise.resolve().then(r.bind(r,3325)),Promise.resolve().then(r.bind(r,9392)),Promise.resolve().then(r.bind(r,4017))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const t=this.color,i=this._outputs[0],s=`//${this.name}`,r=1===e.shaderLanguage?"Vec3":"";return e._emitFunctionFromInclude("helperFunctions",s),e._emitFunctionFromInclude("imageProcessingDeclaration",s),e._emitFunctionFromInclude("imageProcessingFunctions",s),t.connectedPoint?.isConnected&&(t.connectedPoint.type===gr.Color4||t.connectedPoint.type===gr.Vector4?e.compilationString+=`${e._declareOutput(i)} = ${t.associatedVariableName};\n`:e.compilationString+=`${e._declareOutput(i)} = vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);\n`,e.compilationString+="#ifdef IMAGEPROCESSINGPOSTPROCESS\n",this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${r}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);\n`),e.compilationString+="#else\n",e.compilationString+="#ifdef IMAGEPROCESSING\n",this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${r}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);\n`),e.compilationString+=`${i.associatedVariableName} = applyImageProcessing(${i.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+="#endif\n",this.rgb.hasEndpoints&&(e.compilationString+=e._declareOutput(this.rgb)+` = ${this.output.associatedVariableName}.xyz;\n`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\n`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertInputToLinearSpace=e.convertInputToLinearSpace??!0}}(0,w.Cg)([wr("Convert input to linear space",0,"ADVANCED")],kn.prototype,"convertInputToLinearSpace",void 0),(0,V.Y5)("BABYLON.ImageProcessingBlock",kn);class Vn extends Pr{constructor(e,t,i,s,r){super(e,t,i),this._blockType=s,this._blockName=r,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof Vn&&e._blockName===this._blockName?0:1}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class Un extends Ir{constructor(e){super(e,vr.Fragment,!0),this.registerInput("normal",gr.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(gr.Color4|gr.Vector4|gr.Vector3),this.registerInput("tangent",gr.Vector4,!1),this.registerInput("world",gr.Matrix,!1),this.registerOutput("TBN",gr.Object,vr.Fragment,new Vn("TBN",this,1,Un,"TBNBlock")),this.registerOutput("row0",gr.Vector3,vr.Fragment),this.registerOutput("row1",gr.Vector3,vr.Fragment),this.registerOutput("row2",gr.Vector3,vr.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return vr.Fragment}set target(e){}autoConfigure(e,t=(()=>!0)){if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.isSystemValue&&e.systemValue===Ar.World&&t(e)));i||(i=new Vr("world"),i.setAsSystemValue(Ar.World)),i.output.connectTo(this.world)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"normal"===e.name&&t(e)));i||(i=new Vr("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"tangent"===e.name&&e.type===gr.Vector4&&t(e)));i||(i=new Vr("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}}prepareDefines(e,t,i){const s=this.normal,r=this.tangent;let n=s.isConnected;s.connectInputBlock?.isAttribute&&!e.isVerticesDataPresent(s.connectInputBlock?.name)&&(n=!1);let a=r.isConnected;r.connectInputBlock?.isAttribute&&!e.isVerticesDataPresent(r.connectInputBlock?.name)&&(a=!1);const o=n&&a;i.setValue("TBNBLOCK",o,!0)}_buildBlock(e){super._buildBlock(e);const t=this.normal,i=this.tangent,s=this.world,r=this.TBN,n=this.row0,a=this.row1,o=this.row2,l=1===e.shaderLanguage,h=l?"mat3x3f":"mat3",c=l?"f":"";return e.target===vr.Fragment&&(e.compilationString+=`\n                // ${this.name}\n                ${e._declareLocalVar("tbnNormal",gr.Vector3)} = normalize(${t.associatedVariableName}).xyz;\n                ${e._declareLocalVar("tbnTangent",gr.Vector3)} = normalize(${i.associatedVariableName}.xyz);\n                ${e._declareLocalVar("tbnBitangent",gr.Vector3)} = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;\n                ${l?"var":"mat3"} ${r.associatedVariableName} = ${h}(${s.associatedVariableName}[0].xyz, ${s.associatedVariableName}[1].xyz, ${s.associatedVariableName}[2].xyz) * ${h}(tbnTangent, tbnBitangent, tbnNormal);\n            `,n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = vec3${c}(${r.associatedVariableName}[0][0], ${r.associatedVariableName}[0][1], ${r.associatedVariableName}[0][2]);\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = vec3${c}(${r.associatedVariableName}[1[0], ${r.associatedVariableName}[1][1], ${r.associatedVariableName}[1][2]);\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = vec3${c}(${r.associatedVariableName}[2][0], ${r.associatedVariableName}[2][1], ${r.associatedVariableName}[2][2]);\n`),e.sharedData.blocksWithDefines.push(this)),this}}(0,V.Y5)("BABYLON.TBNBlock",Un);class zn extends Ir{constructor(e){super(e,vr.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",gr.Vector4,!1),this.registerInput("worldNormal",gr.Vector4,!1),this.registerInput("worldTangent",gr.Vector4,!0),this.registerInput("uv",gr.Vector2,!1),this.registerInput("normalMapColor",gr.Color3,!1),this.registerInput("strength",gr.Float,!1),this.registerInput("viewDirection",gr.Vector3,!0),this.registerInput("parallaxScale",gr.Float,!0),this.registerInput("parallaxHeight",gr.Float,!0),this.registerInput("TBN",gr.Object,!0,vr.VertexAndFragment,new Vn("TBN",this,0,Un,"TBNBlock")),this.registerInput("world",gr.Matrix,!0),this.registerOutput("output",gr.Vector4),this.registerOutput("uvOffset",gr.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(r.bind(r,727)),Promise.resolve().then(r.bind(r,5697)),Promise.resolve().then(r.bind(r,1258))]):await Promise.all([Promise.resolve().then(r.bind(r,7018)),Promise.resolve().then(r.bind(r,7494)),Promise.resolve().then(r.bind(r,8269))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}prepareDefines(e,t,i){const s=this.normalMapColor.connectedPoint._ownerBlock.samplerName,r=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&s||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",r,!0),i.setValue("PARALLAX_RHS",t.getScene().useRightHandedSystem,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e,t=(()=>!0)){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new Vr("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){const e=new Vr("strength");e.value=1,e.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,s=this.worldPosition,r=this.worldNormal,n=this.worldTangent,a=1===e.shaderLanguage,o=a?"mat3x3f":"mat3",l=a?"f":"",h=a?"uniforms.":"";e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,gr.Vector2),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,gr.Float),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,gr.Matrix);let c=null;this.normalMapColor.connectedPoint&&(c=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const u=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&c||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),d=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",_=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${e._emitFloat(this.strength.connectInputBlock.value)}`:`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${this.strength.associatedVariableName}`;a||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const p={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},f=this.TBN;f.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            ${a?"var":"mat3"} vTBN = ${f.associatedVariableName};\n            #endif\n            `:n.isConnected&&(e.compilationString+=`${e._declareLocalVar("tbnNormal",gr.Vector3)} = normalize(${r.associatedVariableName}.xyz);\n`,e.compilationString+=`${e._declareLocalVar("tbnTangent",gr.Vector3)} = normalize(${n.associatedVariableName}.xyz);\n`,e.compilationString+=`${e._declareLocalVar("tbnBitangent",gr.Vector3)} = cross(tbnNormal, tbnTangent) * ${a?"uniforms.":""}${this._tangentCorrectionFactorName};\n`,e.compilationString+=`${a?"var":"mat3"} vTBN = ${o}(tbnTangent, tbnBitangent, tbnNormal);\n`);let m=[p,{search:/varying mat3 vTBN;/g,replace:""},{search:/uniform mat4 normalMatrix;/g,replace:""}];a&&(m.push({search:/varying vTBN0: vec3f;/g,replace:""}),m.push({search:/varying vTBN1: vec3f;/g,replace:""}),m.push({search:/varying vTBN2: vec3f;/g,replace:""})),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:m});const g=a?"fn parallaxOcclusion(vViewDirCoT: vec3f, vNormalCoT: vec3f, texCoord: vec2f, parallaxScale:f32, bump: texture_2d<f32>, bumpSampler: sampler)":"#define inline\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)",v=a?/fn parallaxOcclusion\(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32\)/g:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,b=a?"fn parallaxOffset(viewDir: vec3f, heightScale: f32, height_: f32)":"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)",x=a?/fn parallaxOffset\(viewDir: vec3f,heightScale: f32\)/g:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g;e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:v,replace:g},{search:x,replace:b},{search:/texture.+?bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const S=u&&c?`${a?`textureSample(${c}, ${c+"Sampler"}`:`texture2D(${c}`}, ${i.associatedVariableName} + uvOffset).xyz`:this.normalMapColor.associatedVariableName,T=e._getFreeVariableName("tempOutput");return e.compilationString+=e._declareLocalVar(T,gr.Vector3)+` = vec3${l}(0.);\n`,m=[{search:new RegExp(`texture.+?bumpSampler${a?"Sampler,fragmentInputs.":","}vBumpUV\\)`,"g"),replace:`${S}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`${e._declareLocalVar("normalMatrix",gr.Matrix)} = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:new RegExp(`perturbNormal\\(TBN,texture.+?bumpSampler${a?"Sampler,fragmentInputs.":","}vBumpUV\\+uvOffset\\).xyz,${a?"uniforms.":""}vBumpInfos.y\\)`,"g"),replace:`perturbNormal(TBN, ${S}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${a?u&&this.useParallaxOcclusion?`${c}, ${c+"Sampler"}`:"bump, bumpSampler":u&&this.useParallaxOcclusion?c:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${u?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vBumpInfos.y/g,replace:_},{search:/vBumpInfos.z/g,replace:d},{search:/normalW=/g,replace:T+" = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:`${o}(normalMatrix) * `+T},{search:/normalW/g,replace:r.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:u?this.viewDirection.associatedVariableName:`vec3${l}(0.)`},p],a?(m.push({search:/fragmentInputs.vBumpUV/g,replace:i.associatedVariableName}),m.push({search:/input.vPositionW/g,replace:s.associatedVariableName+".xyz"}),m.push({search:/uniforms.vTangentSpaceParams/g,replace:h+this._tangentSpaceParameterName}),m.push({search:/var TBN: mat3x3f=mat3x3<f32>\(input.vTBN0,input.vTBN1,input.vTBN2\);/g,replace:"var TBN = vTBN;"})):(m.push({search:/vBumpUV/g,replace:i.associatedVariableName}),m.push({search:/vPositionW/g,replace:s.associatedVariableName+".xyz"}),m.push({search:/vTangentSpaceParams/g,replace:h+this._tangentSpaceParameterName})),e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:m}),e.compilationString+=e._declareOutput(this.output)+` = vec4${l}(${T}, 0.);\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};\n`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};\n`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\n`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};\n`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}(0,w.Cg)([wr("Invert X axis",0,"PROPERTIES",{notifiers:{update:!1}})],zn.prototype,"invertX",void 0),(0,w.Cg)([wr("Invert Y axis",0,"PROPERTIES",{notifiers:{update:!1}})],zn.prototype,"invertY",void 0),(0,w.Cg)([wr("Use parallax occlusion",0)],zn.prototype,"useParallaxOcclusion",void 0),(0,w.Cg)([wr("Object Space Mode",0,"PROPERTIES",{notifiers:{update:!1}})],zn.prototype,"useObjectSpaceNormalMap",void 0),(0,V.Y5)("BABYLON.PerturbNormalBlock",zn),(0,V.Y5)("BABYLON.DiscardBlock",class extends Ir{constructor(e){super(e,vr.Fragment,!0),this.registerInput("value",gr.Float,!0),this.registerInput("cutoff",gr.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,this.cutoff.isConnected&&this.value.isConnected)return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) { discard; }\n`,this}}),(0,V.Y5)("BABYLON.FrontFacingBlock",class extends Ir{constructor(e){super(e,vr.Fragment),this.registerOutput("output",gr.Float,vr.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===vr.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary("1.0","0.0",0===e.shaderLanguage?"gl_FrontFacing":"fragmentInputs.frontFacing")};\n`,this}}),(0,V.Y5)("BABYLON.DerivativeBlock",class extends Ir{constructor(e){super(e,vr.Fragment),this.registerInput("input",gr.AutoDetect,!1),this.registerOutput("dx",gr.BasedOnInput),this.registerOutput("dy",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let s="dFdx",r="dFdy";return 1===e.shaderLanguage&&(s="dpdx",r="dpdy"),t.hasEndpoints&&(e.compilationString+=e._declareOutput(t)+` = ${s}(${this.input.associatedVariableName});\n`),i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${r}(${this.input.associatedVariableName});\n`),this}}),(0,V.Y5)("BABYLON.FragCoordBlock",class extends Ir{constructor(e){super(e,vr.Fragment),this.registerOutput("xy",gr.Vector2,vr.Fragment),this.registerOutput("xyz",gr.Vector3,vr.Fragment),this.registerOutput("xyzw",gr.Vector4,vr.Fragment),this.registerOutput("x",gr.Float,vr.Fragment),this.registerOutput("y",gr.Float,vr.Fragment),this.registerOutput("z",gr.Float,vr.Fragment),this.registerOutput("w",gr.Float,vr.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";const i=1===e.shaderLanguage?"fragmentInputs.position":"gl_FragCoord";for(const s of this._outputs)s.hasEndpoints&&(t+=`${e._declareOutput(s)} = ${i}.${s.name};\n`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===vr.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}),(0,V.Y5)("BABYLON.ScreenSizeBlock",class extends Ir{constructor(e){super(e,vr.Fragment),this.registerOutput("xy",gr.Vector2,vr.Fragment),this.registerOutput("x",gr.Float,vr.Fragment),this.registerOutput("y",gr.Float,vr.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const s of this._outputs)s.hasEndpoints&&(i+=`${e._declareOutput(s)} = ${t}.${s.name};\n`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===vr.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,gr.Vector2);const t=1===e.shaderLanguage?"uniforms.":"";return e.compilationString+=this.writeOutputs(e,t+this._varName),this}}),(0,V.Y5)("BABYLON.ScreenSpaceBlock",class extends Ir{constructor(e){super(e,vr.Fragment),this.registerInput("vector",gr.AutoDetect),this.registerInput("worldViewProjection",gr.Matrix),this.registerOutput("output",gr.Vector2),this.registerOutput("x",gr.Float),this.registerOutput("y",gr.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Vector3|gr.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e,t=(()=>!0)){if(!this.worldViewProjection.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.WorldViewProjection&&t(e)));i||(i=new Vr("worldViewProjection"),i.setAsSystemValue(Ar.WorldViewProjection)),i.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;const s=i.associatedVariableName,r=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case gr.Vector3:e.compilationString+=`${e._declareLocalVar(r,gr.Vector4)} = ${s} * vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);\n`;break;case gr.Vector4:e.compilationString+=`${e._declareLocalVar(r,gr.Vector4)} = ${s} * ${t.associatedVariableName};\n`}return e.compilationString+=`${r} = vec4${e.fSuffix}(${r}.xy / ${r}.w, ${r}.zw);`,e.compilationString+=`${r} = vec4${e.fSuffix}(${r}.xy * 0.5 + vec2${e.fSuffix}(0.5, 0.5), ${r}.zw);`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${r}.xy;\n`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${r}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${r}.y;\n`),this}}),(0,V.Y5)("BABYLON.TwirlBlock",class extends Ir{constructor(e){super(e,vr.Fragment),this.registerInput("input",gr.Vector2),this.registerInput("strength",gr.Float),this.registerInput("center",gr.Vector2),this.registerInput("offset",gr.Vector2),this.registerOutput("output",gr.Vector2),this.registerOutput("x",gr.Float),this.registerOutput("y",gr.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new Vr("center");e.value=new I.I9(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new Vr("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new Vr("offset");e.value=new I.I9(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),s=e._getFreeVariableName("x"),r=e._getFreeVariableName("y"),n=e._getFreeVariableName("result");return e.compilationString+=`        \n            ${e._declareLocalVar(t,gr.Vector2)} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};\n            ${e._declareLocalVar(i,gr.Float)} = ${this.strength.associatedVariableName} * length(${t});\n            ${e._declareLocalVar(s,gr.Float)} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;\n            ${e._declareLocalVar(r,gr.Float)} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;\n            ${e._declareLocalVar(n,gr.Vector2)} = vec2(${s} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${r} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);\n        `,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${n};\n`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${n}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${n}.y;\n`),this}});class Gn extends Ir{constructor(e){super(e,vr.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",gr.Float),this.registerInput("worldPosition",gr.Vector3),this.registerInput("worldNormal",gr.Vector3),this.registerInput("worldTangent",gr.AutoDetect,!0),this.registerOutput("output",gr.Vector4),this.registerOutput("xyz",gr.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Vector3|gr.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=1===e.shaderLanguage,s=e.fSuffix;this.generateInWorldSpace||this.worldTangent.isConnected||l.V.Error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const r=this.generateInWorldSpace?"":"\n            vec3 biTangent = cross(norm, tgt);\n            mat3 TBN = mat3(tgt, biTangent, norm);\n            ",n=this.generateInWorldSpace?"":"\n            result = TBN * result;\n            result = result * vec3(0.5) + vec3(0.5);\n            ";let a=`\n            vec4 heightToNormal(float height, vec3 position, vec3 tangent, vec3 normal) {\n                vec3 tgt = ${this.automaticNormalizationTangent?"normalize(tangent);":"tangent;"}\n                vec3 norm = ${this.automaticNormalizationNormal?"normalize(normal);":"normal;"}\n                ${r}\n                vec3 worlddX = dFdx(position);\n                vec3 worlddY = dFdy(position);\n                vec3 crossX = cross(norm, worlddX);\n                vec3 crossY = cross(worlddY, norm);\n                float d = abs(dot(crossY, worlddX));\n                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));\n                inToNormal.y *= -1.0;\n                vec3 result = normalize((d * norm) - inToNormal);\n                ${n}\n                return vec4(result, 0.);\n            }`;return i?a=e._babylonSLtoWGSL(a):e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",a,"// heightToNormal"),e.compilationString+=e._declareOutput(t)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:`vec3${s}(0.)`}.xyz, ${this.worldNormal.associatedVariableName});\n`,this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;\n`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};\n`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};\n`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};\n`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}(0,w.Cg)([wr("Generate in world space instead of tangent space",0,"PROPERTIES",{notifiers:{update:!0}})],Gn.prototype,"generateInWorldSpace",void 0),(0,w.Cg)([wr("Force normalization for the worldNormal input",0,"PROPERTIES",{notifiers:{update:!0}})],Gn.prototype,"automaticNormalizationNormal",void 0),(0,w.Cg)([wr("Force normalization for the worldTangent input",0,"PROPERTIES",{notifiers:{update:!0}})],Gn.prototype,"automaticNormalizationTangent",void 0),(0,V.Y5)("BABYLON.HeightToNormalBlock",Gn),(0,V.Y5)("BABYLON.FragDepthBlock",class extends Ir{constructor(e){super(e,vr.Fragment,!0),this.registerInput("depth",gr.Float,!0),this.registerInput("worldPos",gr.Vector4,!0),this.registerInput("viewProjection",gr.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){super._buildBlock(e);const t=0===e.shaderLanguage?"gl_FragDepth":"fragmentOutputs.fragDepth";return this.depth.isConnected?e.compilationString+=`${t} = ${this.depth.associatedVariableName};\n`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`\n                ${e._declareLocalVar("p",gr.Vector4)} = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};\n                ${e._declareLocalVar("v",gr.Float)} = p.z / p.w;\n                #ifndef IS_NDC_HALF_ZRANGE\n                    v = v * 0.5 + 0.5;\n                #endif\n                ${t} = v;\n    \n            `:l.V.Warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}),(0,V.Y5)("BABYLON.ShadowMapBlock",class extends Ir{constructor(e){super(e,vr.Fragment),this.registerInput("worldPosition",gr.Vector4,!1),this.registerInput("viewProjection",gr.Matrix,!1),this.registerInput("worldNormal",gr.AutoDetect,!0),this.registerOutput("depth",gr.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Vector3|gr.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(r.bind(r,1311)),Promise.resolve().then(r.bind(r,5543)),Promise.resolve().then(r.bind(r,9273))]):await Promise.all([Promise.resolve().then(r.bind(r,9796)),Promise.resolve().then(r.bind(r,8334)),Promise.resolve().then(r.bind(r,8322))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=1===e.shaderLanguage;e._emitUniformFromString("biasAndScaleSM",gr.Vector3),e._emitUniformFromString("lightDataSM",gr.Vector3),e._emitUniformFromString("depthValuesSM",gr.Vector2),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`${e._declareLocalVar("worldPos",gr.Vector4)} = ${this.worldPosition.associatedVariableName};\n`,e.compilationString+=`${e._declareLocalVar("vPositionWSM",gr.Vector3)};\n`,e.compilationString+=`${e._declareLocalVar("vDepthMetricSM",gr.Float)} = 0.0;\n`,e.compilationString+=`${e._declareLocalVar("zSM",gr.Float)};\n`,this.worldNormal.isConnected&&(e.compilationString+=`${e._declareLocalVar("vNormalW",gr.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`${e._declareLocalVar("clipPos",gr.Vector4)} = ${this.viewProjection.associatedVariableName} * worldPos;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"},{search:/vertexOutputs.position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]});const s=i?"fragmentOutputs.fragDepth":"gl_FragDepth";return e.compilationString+=`\n            #if SM_DEPTHTEXTURE == 1\n                #ifdef IS_NDC_HALF_ZRANGE\n                    ${s} = (clipPos.z / clipPos.w);\n                #else\n                    ${s} = (clipPos.z / clipPos.w) * 0.5 + 0.5;\n                #endif\n            #endif\n        `,e.compilationString+=`${e._declareOutput(this.depth)} = vec3${e.fSuffix}(depthSM, 1., 1.);\n`,this}}),(0,V.Y5)("BABYLON.PrePassOutputBlock",class extends Ir{constructor(e){super(e,vr.Fragment,!0),this.registerInput("viewDepth",gr.Float,!0),this.registerInput("screenDepth",gr.Float,!0),this.registerInput("worldPosition",gr.AutoDetect,!0),this.registerInput("localPosition",gr.AutoDetect,!0),this.registerInput("viewNormal",gr.AutoDetect,!0),this.registerInput("worldNormal",gr.AutoDetect,!0),this.registerInput("reflectivity",gr.AutoDetect,!0),this.inputs[2].addExcludedConnectionPointFromAllowedTypes(gr.Vector3|gr.Vector4),this.inputs[3].addExcludedConnectionPointFromAllowedTypes(gr.Vector3|gr.Vector4),this.inputs[4].addExcludedConnectionPointFromAllowedTypes(gr.Vector3|gr.Vector4),this.inputs[5].addExcludedConnectionPointFromAllowedTypes(gr.Vector3|gr.Vector4),this.inputs[6].addExcludedConnectionPointFromAllowedTypes(gr.Vector3|gr.Vector4|gr.Color3|gr.Color4)}getClassName(){return"PrePassOutputBlock"}get viewDepth(){return this._inputs[0]}get screenDepth(){return this._inputs[1]}get worldPosition(){return this._inputs[2]}get localPosition(){return this._inputs[3]}get viewNormal(){return this._inputs[4]}get worldNormal(){return this._inputs[5]}get reflectivity(){return this._inputs[6]}_getFragData(e,t){return e?`fragmentOutputs.fragData${t}`:`gl_FragData[${t}]`}_buildBlock(e){super._buildBlock(e);const t=this.worldPosition,i=this.localPosition,s=this.viewNormal,r=this.worldNormal,n=this.viewDepth,a=this.reflectivity,o=this.screenDepth;e.sharedData.blocksWithDefines.push(this);const l=`//${this.name}`,h=e._getShaderType(gr.Vector4),c=1===e.shaderLanguage;return e._emitFunctionFromInclude("helperFunctions",l),e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+=c?"var fragData: array<vec4<f32>, SCENE_MRT_COUNT>;\r\n":"vec4 fragData[SCENE_MRT_COUNT];\r\n",e.compilationString+="#ifdef PREPASS_DEPTH\r\n",n.connectedPoint?e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${h}(${n.associatedVariableName}, 0.0, 0.0, 1.0);\r\n`:e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${h}(0.0, 0.0, 0.0, 0.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_SCREENSPACE_DEPTH\r\n",o.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(${o.associatedVariableName}, 0.0, 0.0, 1.0);\r\n`:e.compilationString+=" gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_POSITION\r\n",t.connectedPoint?e.compilationString+=`fragData[PREPASS_POSITION_INDEX] = ${h}(${t.associatedVariableName}.rgb, ${t.connectedPoint.type===gr.Vector4?t.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_POSITION_INDEX] = ${h}(0.0, 0.0, 0.0, 0.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_LOCAL_POSITION\r\n",i.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(${i.associatedVariableName}.rgb, ${i.connectedPoint.type===gr.Vector4?i.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_NORMAL\r\n",s.connectedPoint?e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${h}(${s.associatedVariableName}.rgb, ${s.connectedPoint.type===gr.Vector4?s.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${h}(0.0, 0.0, 0.0, 0.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_WORLD_NORMAL\r\n",r.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(${r.associatedVariableName}.rgb, ${r.connectedPoint.type===gr.Vector4?r.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_REFLECTIVITY\r\n",a.connectedPoint?e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${h}(${a.associatedVariableName}.rgb, ${a.connectedPoint.type===gr.Vector4?a.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${h}(0.0, 0.0, 0.0, 1.0);\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 1\r\n",e.compilationString+=`${this._getFragData(c,1)} = fragData[1];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 2\r\n",e.compilationString+=`${this._getFragData(c,2)} = fragData[2];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 3\r\n",e.compilationString+=`${this._getFragData(c,3)} = fragData[3];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 4\r\n",e.compilationString+=`${this._getFragData(c,4)} = fragData[4];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 5\r\n",e.compilationString+=`${this._getFragData(c,5)} = fragData[5];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 6\r\n",e.compilationString+=`${this._getFragData(c,6)} = fragData[6];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#if SCENE_MRT_COUNT > 7\r\n",e.compilationString+=`${this._getFragData(c,7)} = fragData[7];\r\n`,e.compilationString+="#endif\r\n",e.compilationString+="#endif\r\n",this}}),r(9702),r(6205),r(8996),r(3325),r(9392),r(4017),r(727),r(5697),r(1258),r(7018),r(7494),r(8269),r(1311),r(5543),r(9273),r(9796),r(8334),r(8322),(0,V.Y5)("BABYLON.FogBlock",class extends Ir{constructor(e){super(e,vr.VertexAndFragment,!1),this.registerInput("worldPosition",gr.Vector4,!1,vr.Vertex),this.registerInput("view",gr.Matrix,!1,vr.Vertex),this.registerInput("input",gr.AutoDetect,!1,vr.Fragment),this.registerInput("fogColor",gr.AutoDetect,!1,vr.Fragment),this.registerOutput("output",gr.Color3,vr.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Vector3|gr.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Vector3|gr.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.resolve().then(r.bind(r,6407)):await Promise.resolve().then(r.bind(r,7806)),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=(()=>!0)){if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.View&&t(e)));i||(i=new Vr("view"),i.setAsSystemValue(Ar.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.FogColor&&t(e)));i||(i=new Vr("fogColor",void 0,gr.Color3),i.setAsSystemValue(Ar.FogColor)),i.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const s=e.getScene();i.setValue("FOG",t.fogEnabled&&(0,$.qL)(e,s))}bind(e,t,i){if(!i)return;const s=i.getScene();e.setFloat4(this._fogParameters,s.fogMode,s.fogStart,s.fogEnd,s.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===vr.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=[],i="",s="";1===e.shaderLanguage?(t=[{search:/fn CalcFogFactor\(\)/,replace:"fn CalcFogFactor(vFogDistance: vec3f, vFogInfos: vec4f)"},{search:/uniforms.vFogInfos/g,replace:"vFogInfos"},{search:/fragmentInputs.vFogDistance/g,replace:"vFogDistance"}],i="fragmentInputs.",s="uniforms."):t=[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}],e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:t});const r=e._getFreeVariableName("fog"),n=this.input,a=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const o=this._outputs[0];e._emitUniformFromString(this._fogParameters,gr.Vector4),e.compilationString+="#ifdef FOG\n",e.compilationString+=`${e._declareLocalVar(r,gr.Float)} = CalcFogFactor(${i}${this._fogDistanceName}, ${s}${this._fogParameters});\n`,e.compilationString+=e._declareOutput(o)+` = ${r} * ${n.associatedVariableName}.rgb + (1.0 - ${r}) * ${a.associatedVariableName}.rgb;\n`,e.compilationString+=`#else\n${e._declareOutput(o)} =  ${n.associatedVariableName}.rgb;\n`,e.compilationString+="#endif\n"}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,gr.Vector3);const s=1===e.shaderLanguage?"vertexOutputs.":"";e.compilationString+=`${s}${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;\n`}return this}});class Hn extends Ir{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,l.V.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?vr.Fragment:vr.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?vr.Fragment:vr.Vertex}constructor(e){super(e,vr.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",gr.Vector4,!1,vr.Vertex),this.registerInput("worldNormal",gr.Vector4,!1,vr.Fragment),this.registerInput("cameraPosition",gr.Vector3,!1,vr.Fragment),this.registerInput("glossiness",gr.Float,!0,vr.Fragment),this.registerInput("glossPower",gr.Float,!0,vr.Fragment),this.registerInput("diffuseColor",gr.Color3,!0,vr.Fragment),this.registerInput("specularColor",gr.Color3,!0,vr.Fragment),this.registerInput("view",gr.Matrix,!0),this.registerOutput("diffuseOutput",gr.Color3,vr.Fragment),this.registerOutput("specularOutput",gr.Color3,vr.Fragment),this.registerOutput("shadow",gr.Float,vr.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(r.bind(r,5271)),Promise.resolve().then(r.bind(r,379)),Promise.resolve().then(r.bind(r,3925)),Promise.resolve().then(r.bind(r,9702)),Promise.resolve().then(r.bind(r,6493)),Promise.resolve().then(r.bind(r,8589)),Promise.resolve().then(r.bind(r,9456))]):await Promise.all([Promise.resolve().then(r.bind(r,2270)),Promise.resolve().then(r.bind(r,7256)),Promise.resolve().then(r.bind(r,2448)),Promise.resolve().then(r.bind(r,4662)),Promise.resolve().then(r.bind(r,9440)),Promise.resolve().then(r.bind(r,3325)),Promise.resolve().then(r.bind(r,1962)),Promise.resolve().then(r.bind(r,6812)),Promise.resolve().then(r.bind(r,5687))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=(()=>!0)){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.CameraPosition&&t(e)));i||(i=new Vr("cameraPosition"),i.setAsSystemValue(Ar.CameraPosition)),i.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const s=e.getScene();if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};(0,$.lo)(s,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else(0,$.az)(s,e,i,!0,t.maxSimultaneousLights)}updateUniformsAndSamples(e,t,i,s){for(let r=0;r<t.maxSimultaneousLights&&i["LIGHT"+r];r++){const t=e.uniforms.indexOf("vLightData"+r)>=0;(0,$.GD)(r,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+r],s,t)}}bind(e,t,i){if(!i)return;const s=i.getScene();this.light?(0,$.Kd)(this.light,this._lightId,s,e,!0):(0,$.RL)(s,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const s="v_"+t.associatedVariableName;e._emitVaryingFromString(s,gr.Vector4)&&(e.compilationString+=(1===e.shaderLanguage?"vertexOutputs.":"")+`${s} = ${t.associatedVariableName};\n`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",gr.Vector4)} = ${t.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",gr.Matrix)} = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_injectUBODeclaration(e){const t=`//${this.name}`;this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0})}_buildBlock(e){super._buildBlock(e);const t=1===e.shaderLanguage,i=t?"f":"",s=`//${this.name}`;if(e.target!==vr.Fragment)return void this._injectVertexCode(e);this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const r=t?"fragmentInputs.":"";e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const n=this.worldPosition;let a=n.associatedVariableName;this.generateOnlyFragmentCode?(a=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`${e._declareLocalVar(a,gr.Vector3)};\n`,s),e.compilationString+=`${a} = ${n.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",s,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${n.associatedVariableName}`:void 0})):a=r+"v_"+a+".xyz",e._emitFunctionFromInclude("helperFunctions",s);let o={search:/vPositionW/g,replace:a};if(t&&(o={search:/fragmentInputs\.vPositionW/g,replace:a}),e._emitFunctionFromInclude("lightsFragmentFunctions",s,{replaceStrings:[o]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",s,{replaceStrings:[o]}),this._injectUBODeclaration(e),0===this._lightId&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",gr.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${a});\n`),e.compilationString+=t?"var info: lightingInfo;\n":"lightingInfo info;\n",e.compilationString+=`${e._declareLocalVar("shadow",gr.Float)} = 1.;\n`,e.compilationString+=`${e._declareLocalVar("aggShadow",gr.Float)} = 0.;\n`,e.compilationString+=`${e._declareLocalVar("numLights",gr.Float)} = 0.;\n`,e.compilationString+=`${e._declareLocalVar("glossiness",gr.Float)} = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\n`,e.compilationString+=`${e._declareLocalVar("diffuseBase",gr.Vector3)} = vec3${i}(0., 0., 0.);\n`,e.compilationString+=`${e._declareLocalVar("specularBase",gr.Vector3)}  = vec3${i}(0., 0., 0.);\n`,e.compilationString+=`${e._declareLocalVar("normalW",gr.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;\n`),this.light){let i={search:/vPositionW/g,replace:a+".xyz"};t&&(i={search:/fragmentInputs\.vPositionW/g,replace:a+".xyz"}),e.compilationString+=e._emitCodeFromInclude("lightFragment",s,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},i]})}else{let i=`vPositionW,${a}.xyz`;t&&(i=`fragmentInputs.vPositionW,${a}.xyz`),e.compilationString+=e._emitCodeFromInclude("lightFragment",s,{repeatKey:"maxSimultaneousLights",substitutionVars:i})}0===this._lightId&&(e.compilationString+="aggShadow = aggShadow / numLights;\n");const l=this.diffuseOutput,h=this.specularOutput;return e.compilationString+=e._declareOutput(l)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\n`,h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\n`),this.shadow.hasEndpoints&&(e.compilationString+=e._declareOutput(this.shadow)+" = aggShadow;\n"),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}(0,w.Cg)([wr("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Hn._OnGenerateOnlyFragmentCodeChanged}})],Hn.prototype,"generateOnlyFragmentCode",void 0),(0,V.Y5)("BABYLON.LightBlock",Hn);class Wn extends Ir{get texture(){return this._texture}set texture(e){if(this._texture===e)return;const i=e?.getScene()??t.q.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}get samplerName(){return this._samplerName}constructor(e){super(e,vr.VertexAndFragment),this.registerOutput("source",gr.Object,vr.VertexAndFragment,new Vn("source",this,1,Wn,"ImageSourceBlock")),this.registerOutput("dimensions",gr.Vector2)}bind(e){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}get dimensions(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),e.target===vr.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),this.dimensions.isConnected){let t="";t=1===e.shaderLanguage?`vec2f(textureDimensions(${this._samplerName}, 0).xy)`:`vec2(textureSize(${this._samplerName}, 0).xy)`,e.compilationString+=`${e._declareOutput(this.dimensions)} = ${t};\n`}return e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,s){super._deserialize(e,t,i,s),e.texture&&!an.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(0===e.texture.url.indexOf("data:")?i="":s&&(e.texture.url=s(e.texture.url),e.texture.name=e.texture.url),this.texture=G.g.Parse(e.texture,t,i))}}(0,V.Y5)("BABYLON.ImageSourceBlock",Wn);class Xn extends Ir{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;const i=e?.getScene()??t.q.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _IsPrePassTextureBlock(e){return"PrePassTextureBlock"===e?.getClassName()}get _isSourcePrePass(){return Xn._IsPrePassTextureBlock(this._imageSource)}get samplerName(){if(this._imageSource){if(!Xn._IsPrePassTextureBlock(this._imageSource))return this._imageSource.samplerName;if(this.source.connectedPoint)return this._imageSource.getSamplerName(this.source.connectedPoint)}return this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=this.texture.getScene()??t.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=this.texture.getScene()??t.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?vr.Fragment:vr.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",gr.AutoDetect,!1,vr.VertexAndFragment),this.registerInput("source",gr.Object,!0,vr.VertexAndFragment,new Vn("source",this,0,Wn,"ImageSourceBlock")),this.registerInput("layer",gr.Float,!0),this.registerInput("lod",gr.Float,!0),this.registerOutput("rgba",gr.Color4,vr.Neutral),this.registerOutput("rgb",gr.Color3,vr.Neutral),this.registerOutput("r",gr.Float,vr.Neutral),this.registerOutput("g",gr.Float,vr.Neutral),this.registerOutput("b",gr.Float,vr.Neutral),this.registerOutput("a",gr.Float,vr.Neutral),this.registerOutput("level",gr.Float,vr.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Vector2|gr.Vector3|gr.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get lod(){return this._inputs[3]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}_isTiedToFragment(e){if(e.target===vr.Fragment)return!0;if(e.target===vr.Vertex)return!1;if(e.target===vr.Neutral||e.target===vr.VertexAndFragment){const t=e.ownerBlock;if(t.target===vr.Fragment)return!0;for(const e of t.inputs)if(e.isConnected&&this._isTiedToFragment(e.connectedPoint))return!0}return!1}_getEffectiveTarget(){return this._fragmentOnly?vr.Fragment:this.uv.isConnected?this.uv.sourceBlock.isInput?vr.VertexAndFragment:this._isTiedToFragment(this.uv.connectedPoint)?vr.Fragment:vr.VertexAndFragment:vr.VertexAndFragment}get target(){return this._getEffectiveTarget()}set target(e){}autoConfigure(e,t=(()=>!0)){if(!this.uv.isConnected)if(e.mode===Yr.PostProcess){const i=e.getBlockByPredicate((e=>"uv"===e.name&&t(e)));i&&i.connectTo(this)}else if(e.mode!==Yr.ProceduralTexture){const i=e.mode===Yr.Particle?"particle_uv":"uv";let s=e.getInputBlockByPredicate((e=>e.isAttribute&&e.name===i&&t(e)));s||(s=new Vr("uv"),s.setAsAttribute(i)),s.output.connectTo(this.uv)}}initializeDefines(e,t,i){i._areTexturesDirty&&void 0!==this._mainUVDefineName&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix)return void(this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)));const s=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,r=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,s,!0),i.setValue(this._gammaDefineName,r,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),null==i[this._mainUVDefineName]&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!!this._isSourcePrePass||!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this._isSourcePrePass&&e.setFloat(this._textureInfoName,1),this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==vr.Fragment}_injectVertexCode(e){const t=this.uv;this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.declarationVariableName.toUpperCase(),this._mainUVName="vMain"+t.declarationVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,gr.Vector2,this._defineName),e._emitVaryingFromString(this._mainUVName,gr.Vector2,this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,gr.Matrix,this._defineName);const i=e._getShaderType(gr.Vector4),s=e._getShaderType(gr.Vector2);e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`${e._getVaryingName(this._transformedUVName)} = ${s}(${this._textureTransformName} * ${i}(${t.associatedVariableName}.xy, 1.0, 0.0));\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`;let r="";if(1===e.shaderLanguage&&t.isConnectedToInputBlock&&-1===t.associatedVariableName.indexOf("vertexInputs.")&&(r="vertexInputs."),e.compilationString+=`${e._getVaryingName(this._mainUVName)} = ${r}${t.associatedVariableName}.xy;\n`,e.compilationString+="#endif\n",this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name,!0)}}_getUVW(e){let t=e;const i=this._texture?._texture?.is2DArray??!1,s=this._texture?._texture?.is3D??!1;return(i||s)&&(t=`vec3(${e}, ${this.layer.isConnected?this.layer.associatedVariableName:"0"})`),t}_samplerFunc(e){return 1===e.shaderLanguage?e.target===vr.Vertex?"textureSampleLevel":"textureSample":this.lod.isConnected?"texture2DLodEXT":"texture2D"}get _samplerLodSuffix(){return this.lod.isConnected?`, ${this.lod.associatedVariableName}`:""}_generateTextureSample(e,t){if(1===t.shaderLanguage){const i=t.target===vr.Vertex;return`${this._samplerFunc(t)}(${this.samplerName},${this.samplerName+"Sampler"}, ${this._getUVW(e)}${this._samplerLodSuffix}${i?", 0":""})`}return`${this._samplerFunc(t)}(${this.samplerName}, ${this._getUVW(e)}${this._samplerLodSuffix})`}_generateTextureLookup(e){e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = ${this._generateTextureSample(e._getVaryingName(this._transformedUVName),e)};\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = ${this._generateTextureSample(this._mainUVName?e._getVaryingName(this._mainUVName):this.uv.associatedVariableName,e)}${this._samplerLodSuffix};\n`,e.compilationString+="#endif\n"}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===vr.Fragment)return;this._generateTextureLookup(e)}else this.uv.ownerBlock.target!==vr.Fragment?this._generateTextureLookup(e):e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = ${this._generateTextureSample(i.associatedVariableName,e)}${this._samplerLodSuffix};\n`}_generateConversionCode(e,t,i){"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = ${e._toLinearSpace(t)};\n                #endif\n            `)}_writeOutput(e,t,i,s=!1){if(s){if(e.target===vr.Fragment)return;return e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i)}if(this.uv.ownerBlock.target===vr.Fragment)return e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i);let r="";this.disableLevelMultiplication||(r=" * "+(1===e.shaderLanguage?"uniforms.":"")+this._textureInfoName),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${r};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===vr.Vertex||this._fragmentOnly||e.target===vr.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),!this._isMixed&&e.target===vr.Fragment||this._isMixed&&e.target===vr.Vertex){if(!this._imageSource){const t=e._getFreeVariableName(this.name);this._samplerName=t+"Texture",this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)}e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)}if(e.target!==vr.Fragment)return void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;this._isMixed&&!this._imageSource&&(this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName));const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,gr.Float),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,s){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!an.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(0===e.texture.url.indexOf("data:")?i="":s&&(e.texture.url=s(e.texture.url),e.texture.name=e.texture.url),this.texture=G.g.Parse(e.texture,t,i))}}(0,V.Y5)("BABYLON.TextureBlock",Xn);class Kn extends Ir{get texture(){return this._texture}set texture(e){if(this._texture===e)return;const i=e?.getScene()??t.q.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?vr.Fragment:vr.VertexAndFragment)}constructor(e){super(e,vr.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.resolve().then(r.bind(r,2230)):await Promise.resolve().then(r.bind(r,8223)),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=(()=>!0)){if(!this.position.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"position"===e.name&&t(e)));i||(i=new Vr("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.World&&t(e)));i||(i=new Vr("world"),i.setAsSystemValue(Ar.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.View&&t(e)));i||(i=new Vr("view"),i.setAsSystemValue(Ar.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const s=this._getTexture();s&&s.getTextureMatrix&&(i.setValue(this._define3DName,s.isCube,!0),i.setValue(this._defineLocalCubicName,!!s.boundingBoxSize,!0),i.setValue(this._defineExplicitName,0===s.coordinatesMode,!0),i.setValue(this._defineSkyboxName,5===s.coordinatesMode,!0),i.setValue(this._defineCubicName,3===s.coordinatesMode||6===s.coordinatesMode,!0),i.setValue("INVERTCUBICMAP",6===s.coordinatesMode,!0),i.setValue(this._defineSphericalName,1===s.coordinatesMode,!0),i.setValue(this._definePlanarName,2===s.coordinatesMode,!0),i.setValue(this._defineProjectionName,4===s.coordinatesMode,!0),i.setValue(this._defineEquirectangularName,7===s.coordinatesMode,!0),i.setValue(this._defineEquirectangularFixedName,8===s.coordinatesMode,!0),i.setValue(this._defineMirroredEquirectangularFixedName,9===s.coordinatesMode,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i,s){const r=this._getTexture();if(i&&r&&(e.setMatrix(this._reflectionMatrixName,r.getReflectionTextureMatrix()),r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r),r.boundingBoxSize)){const t=r;e.setVector3(this._reflectionPositionName,t.boundingBoxPosition),e.setVector3(this._reflectionSizeName,t.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===vr.Vertex)return"";const t=1===e.shaderLanguage;this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,gr.Matrix);let i="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");const s=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(s,gr.Vector4))&&(this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(s,gr.Vector4)} = ${this.worldPosition.associatedVariableName};\n`:i+=`${t?"vertexOutputs.":""}${s} = ${this.worldPosition.associatedVariableName};\n`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,gr.Vector3,this._defineSkyboxName))&&(i+=`#ifdef ${this._defineSkyboxName}\n`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._positionUVWName,gr.Vector3)} = ${this.position.associatedVariableName}.xyz;\n`:i+=`${t?"vertexOutputs.":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;\n`,i+="#endif\n"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,gr.Vector3,`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(i+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})\n`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._directionWName,gr.Vector3)} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));\n`:i+=`${t?"vertexOutputs.":""}${this._directionWName} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));\n`,i+="#endif\n"),i}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}\n`,e._emitCubeSampler(this._cubeSamplerName,"",!0),e._samplerDeclaration+="#else\n",e._emit2DSampler(this._2DSamplerName,"",!0),e._samplerDeclaration+="#endif\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"},{search:/fn computeReflectionCoords\(worldPos: vec4f,worldNormal: vec3f\)->vec3f/g,replace:"fn DUMMYFUNC()"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,gr.Vector3),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,gr.Vector3)}handleFragmentSideCodeReflectionCoords(e,t,i,s=!1,r=!1){i||(i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);const n=(1===e.shaderLanguage?"uniforms.":"")+this._reflectionMatrixName,a=`normalize(${this._directionWName})`,o=`${this._positionUVWName}`,l=`${this.cameraPosition.associatedVariableName}`,h=`${this.view.associatedVariableName}`;t+=".xyz";let c=`\n            #ifdef ${this._defineMirroredEquirectangularFixedName}\n               ${e._declareLocalVar(this._reflectionVectorName,gr.Vector3)} = computeMirroredFixedEquirectangularCoords(${i}, ${t}, ${a});\n            #endif\n\n            #ifdef ${this._defineEquirectangularFixedName}\n                ${e._declareLocalVar(this._reflectionVectorName,gr.Vector3)} = computeFixedEquirectangularCoords(${i}, ${t}, ${a});\n            #endif\n\n            #ifdef ${this._defineEquirectangularName}\n                ${e._declareLocalVar(this._reflectionVectorName,gr.Vector3)} = computeEquirectangularCoords(${i}, ${t}, ${l}.xyz, ${n});\n            #endif\n\n            #ifdef ${this._defineSphericalName}\n                ${e._declareLocalVar(this._reflectionVectorName,gr.Vector3)} = computeSphericalCoords(${i}, ${t}, ${h}, ${n});\n            #endif\n\n            #ifdef ${this._definePlanarName}\n                ${e._declareLocalVar(this._reflectionVectorName,gr.Vector3)} = computePlanarCoords(${i}, ${t}, ${l}.xyz, ${n});\n            #endif\n\n            #ifdef ${this._defineCubicName}\n                #ifdef ${this._defineLocalCubicName}\n                    ${e._declareLocalVar(this._reflectionVectorName,gr.Vector3)} = computeCubicLocalCoords(${i}, ${t}, ${l}.xyz, ${n}, ${this._reflectionSizeName}, ${this._reflectionPositionName});\n                #else\n                ${e._declareLocalVar(this._reflectionVectorName,gr.Vector3)} = computeCubicCoords(${i}, ${t}, ${l}.xyz, ${n});\n                #endif\n            #endif\n\n            #ifdef ${this._defineProjectionName}\n                ${e._declareLocalVar(this._reflectionVectorName,gr.Vector3)} = computeProjectionCoords(${i}, ${h}, ${n});\n            #endif\n\n            #ifdef ${this._defineSkyboxName}\n                ${e._declareLocalVar(this._reflectionVectorName,gr.Vector3)} = computeSkyBoxCoords(${o}, ${n});\n            #endif\n\n            #ifdef ${this._defineExplicitName}\n                ${e._declareLocalVar(this._reflectionVectorName,gr.Vector3)} = vec3(0, 0, 0);\n            #endif\n`;return r||(c+=`#ifdef ${this._defineOppositeZ}\n                ${this._reflectionVectorName}.z *= -1.0;\n            #endif\n`),s||(c+=`\n                #ifdef ${this._define3DName}\n                    ${e._declareLocalVar(this._reflectionCoordsName,gr.Vector3)} = ${this._reflectionVectorName};\n                #else\n                    ${e._declareLocalVar(this._reflectionCoordsName,gr.Vector2)} = ${this._reflectionVectorName}.xy;\n                    #ifdef ${this._defineProjectionName}\n                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;\n                    #endif\n                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;\n                #endif\n`),c}handleFragmentSideCodeReflectionColor(e,t,i=".rgb"){let s=gr.Vector4;3===i.length&&(s=gr.Vector3);let r=`${e._declareLocalVar(this._reflectionColorName,s)};\n            #ifdef ${this._define3DName}\n`;return r+=t?`${this._reflectionColorName} = ${e._generateTextureSampleCubeLOD(this._reflectionVectorName,this._cubeSamplerName,t)}${i};\n`:`${this._reflectionColorName} = ${e._generateTextureSampleCube(this._reflectionVectorName,this._cubeSamplerName)}${i};\n`,r+="\n            #else\n",r+=t?`${this._reflectionColorName} =${e._generateTextureSampleLOD(this._reflectionCoordsName,this._2DSamplerName,t)}${i};\n`:`${this._reflectionColorName} = ${e._generateTextureSample(this._reflectionCoordsName,this._2DSamplerName)}${i};\n`,r+="#endif\n",r}writeOutputs(e,t){let i="";if(e.target===vr.Fragment)for(const s of this._outputs)s.hasEndpoints&&(i+=`${e._declareOutput(s)} = ${t}.${s.name};\n`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});\n`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);\n`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!an.IgnoreTexturesAtLoadTime&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=hi.Parse(e.texture,t,i):this.texture=G.g.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}(0,w.Cg)([wr("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Kn._OnGenerateOnlyFragmentCodeChanged}})],Kn.prototype,"generateOnlyFragmentCode",void 0),(0,V.Y5)("BABYLON.ReflectionTextureBaseBlock",Kn),(0,V.Y5)("BABYLON.ReflectionTextureBlock",class extends Kn{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,l.V.Error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,l.V.Error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?vr.Fragment:vr.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?vr.Fragment:vr.Vertex}constructor(e){super(e),this.registerInput("position",gr.AutoDetect,!1,vr.Vertex),this.registerInput("worldPosition",gr.Vector4,!1,vr.Vertex),this.registerInput("worldNormal",gr.Vector4,!1,vr.Fragment),this.registerInput("world",gr.Matrix,!1,vr.Vertex),this.registerInput("cameraPosition",gr.Vector3,!1,vr.Fragment),this.registerInput("view",gr.Matrix,!1,vr.Fragment),this.registerOutput("rgb",gr.Color3,vr.Fragment),this.registerOutput("rgba",gr.Color4,vr.Fragment),this.registerOutput("r",gr.Float,vr.Fragment),this.registerOutput("g",gr.Float,vr.Fragment),this.registerOutput("b",gr.Float,vr.Fragment),this.registerOutput("a",gr.Float,vr.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Vector3|gr.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e,t=(()=>!0)){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.CameraPosition&&t(e)));i||(i=new Vr("cameraPosition"),i.setAsSystemValue(Ar.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,`vec4${e.fSuffix}(0.)`),this;if(e.target!==vr.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`${e._declareLocalVar(t,gr.Vector4)} = normalize(${this.worldNormal.associatedVariableName});\n`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(e,t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(e,void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}});class Qn extends Ir{constructor(e){super(e,vr.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",gr.AutoDetect,!1,vr.VertexAndFragment),this.registerOutput("depth",gr.Float,vr.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Vector2|gr.Vector3|gr.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?vr.VertexAndFragment:vr.Fragment:vr.VertexAndFragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,t.type===gr.Vector3?gr.Vector3:t.type===gr.Vector4?gr.Vector4:gr.Vector2)),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,gr.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===vr.Fragment)return;const t=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,s=0===e.shaderLanguage?"":", 0";return void(e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,gr.Vector4)}=  ${t} ${i.associatedVariableName}.xy${s});\n`)}const s=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;this.uv.ownerBlock.target!==vr.Fragment?e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = ${s} ${this._mainUVName});\n`:e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = ${s} ${i.associatedVariableName}.xy);\n`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===vr.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target,vr.Fragment,e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==vr.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(this._outputs.some((e=>e.isConnectedInFragmentShader))){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}(0,w.Cg)([wr("Use non linear depth",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let s=!1;return i.useNonLinearDepth&&(i.storeCameraSpaceZ=!1,s=!0),e&&e.disableDepthRenderer(),s}}})],Qn.prototype,"useNonLinearDepth",void 0),(0,w.Cg)([wr("Store Camera space Z",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let s=!1;return i.storeCameraSpaceZ&&(i.useNonLinearDepth=!1,s=!0),e&&e.disableDepthRenderer(),s}}})],Qn.prototype,"storeCameraSpaceZ",void 0),(0,w.Cg)([wr("Force 32 bits float",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:e=>e?.disableDepthRenderer()}})],Qn.prototype,"force32itsFloat",void 0),(0,V.Y5)("BABYLON.SceneDepthBlock",Qn),(0,V.Y5)("BABYLON.ClipPlanesBlock",class extends Ir{constructor(e){super(e,vr.VertexAndFragment,!0),this.registerInput("worldPosition",gr.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(r.bind(r,7715)),Promise.resolve().then(r.bind(r,9759)),Promise.resolve().then(r.bind(r,5197)),Promise.resolve().then(r.bind(r,7029))]):await Promise.all([Promise.resolve().then(r.bind(r,7412)),Promise.resolve().then(r.bind(r,6194)),Promise.resolve().then(r.bind(r,7314)),Promise.resolve().then(r.bind(r,1636))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get target(){return vr.VertexAndFragment}set target(e){}prepareDefines(e,t,i){const s=e.getScene(),r=!!(t.clipPlane??s.clipPlane),n=!!(t.clipPlane2??s.clipPlane2),a=!!(t.clipPlane3??s.clipPlane3),o=!!(t.clipPlane4??s.clipPlane4),l=!!(t.clipPlane5??s.clipPlane5),h=!!(t.clipPlane6??s.clipPlane6);i.setValue("CLIPPLANE",r,!0),i.setValue("CLIPPLANE2",n,!0),i.setValue("CLIPPLANE3",a,!0),i.setValue("CLIPPLANE4",o,!0),i.setValue("CLIPPLANE5",l,!0),i.setValue("CLIPPLANE6",h,!0)}bind(e,t,i){if(!i)return;const s=i.getScene();(0,q.gS)(e,t,s)}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==vr.Fragment){const i=this.worldPosition;return e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane",gr.Vector4),e._emitUniformFromString("vClipPlane2",gr.Vector4),e._emitUniformFromString("vClipPlane3",gr.Vector4),e._emitUniformFromString("vClipPlane4",gr.Vector4),e._emitUniformFromString("vClipPlane5",gr.Vector4),void e._emitUniformFromString("vClipPlane6",gr.Vector4)}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}),r(7715),r(9759),r(5197),r(7029),r(7412),r(6194),r(7314),r(1636),r(6407),r(7806),r(5271),r(379),r(3925),r(6493),r(8589),r(9456),r(2270),r(7256),r(2448),r(4662),r(9440),r(1962),r(6812),r(5687),r(2230),r(8223),(0,V.Y5)("BABYLON.PrePassTextureBlock",class extends Ir{get texture(){return null}set texture(e){}constructor(e,t=vr.VertexAndFragment){super(e,t,!1),this.registerOutput("position",gr.Object,vr.VertexAndFragment,new Vn("position",this,1,Wn,"ImageSourceBlock")),this.registerOutput("localPosition",gr.Object,vr.VertexAndFragment,new Vn("localPosition",this,1,Wn,"ImageSourceBlock")),this.registerOutput("depth",gr.Object,vr.VertexAndFragment,new Vn("depth",this,1,Wn,"ImageSourceBlock")),this.registerOutput("screenDepth",gr.Object,vr.VertexAndFragment,new Vn("screenDepth",this,1,Wn,"ImageSourceBlock")),this.registerOutput("normal",gr.Object,vr.VertexAndFragment,new Vn("normal",this,1,Wn,"ImageSourceBlock")),this.registerOutput("worldNormal",gr.Object,vr.VertexAndFragment,new Vn("worldNormal",this,1,Wn,"ImageSourceBlock"))}getSamplerName(e){return e===this._outputs[0]?this._positionSamplerName:e===this._outputs[1]?this._localPositionSamplerName:e===this._outputs[2]?this._depthSamplerName:e===this._outputs[3]?this._screenSpaceDepthSamplerName:e===this._outputs[4]?this._normalSamplerName:e===this._outputs[5]?this._worldNormalSamplerName:""}get position(){return this._outputs[0]}get localPosition(){return this._outputs[1]}get depth(){return this._outputs[2]}get screenDepth(){return this._outputs[3]}get normal(){return this._outputs[4]}get worldNormal(){return this._outputs[5]}get positionSamplerName(){return this._positionSamplerName}get localPositionSamplerName(){return this._localPositionSamplerName}get normalSamplerName(){return this._normalSamplerName}get worldNormalSamplerName(){return this._worldNormalSamplerName}get depthSamplerName(){return this._depthSamplerName}get linearDepthSamplerName(){return this._screenSpaceDepthSamplerName}getClassName(){return"PrePassTextureBlock"}_buildBlock(e){if(super._buildBlock(e),e.target!==vr.Vertex)return this._positionSamplerName="prepassPositionSampler",this._depthSamplerName="prepassDepthSampler",this._normalSamplerName="prepassNormalSampler",this._worldNormalSamplerName="prepassWorldNormalSampler",this._localPositionSamplerName="prepassLocalPositionSampler",this._screenSpaceDepthSamplerName="prepassScreenSpaceDepthSampler",e.sharedData.variableNames.prepassPositionSampler=0,e.sharedData.variableNames.prepassDepthSampler=0,e.sharedData.variableNames.prepassNormalSampler=0,e.sharedData.variableNames.prepassWorldNormalSampler=0,e.sharedData.variableNames.prepassLocalPositionSampler=0,e.sharedData.variableNames.prepassScreenSpaceDepthSampler=0,e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this),this.position.isConnected&&e._emit2DSampler(this._positionSamplerName),this.depth.isConnected&&e._emit2DSampler(this._depthSamplerName),this.normal.isConnected&&e._emit2DSampler(this._normalSamplerName),this.worldNormal.isConnected&&e._emit2DSampler(this._worldNormalSamplerName),this.localPosition.isConnected&&e._emit2DSampler(this._localPositionSamplerName),this.screenDepth.isConnected&&e._emit2DSampler(this._screenSpaceDepthSamplerName),this}bind(e,t){const i=t.getScene().enablePrePassRenderer();if(!i)return;const s=i.defaultRT;s.textures&&(this.position.isConnected&&e.setTexture(this._positionSamplerName,s.textures[i.getIndex(1)]),this.localPosition.isConnected&&e.setTexture(this._localPositionSamplerName,s.textures[i.getIndex(9)]),this.depth.isConnected&&e.setTexture(this._depthSamplerName,s.textures[i.getIndex(5)]),this.screenDepth.isConnected&&e.setTexture(this._screenSpaceDepthSamplerName,s.textures[i.getIndex(10)]),this.normal.isConnected&&e.setTexture(this._normalSamplerName,s.textures[i.getIndex(6)]),this.worldNormal.isConnected&&e.setTexture(this._worldNormalSamplerName,s.textures[i.getIndex(8)]))}}),(0,V.Y5)("BABYLON.NodeMaterialTeleportInBlock",class extends Ir{get endpoints(){return this._endpoints}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==vr.VertexAndFragment)return t.target;if(e.connectedPoint.target!==vr.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}constructor(e){super(e,vr.Neutral),this._endpoints=[],this.registerInput("input",gr.AutoDetect)}getClassName(){return"NodeMaterialTeleportInBlock"}get input(){return this._inputs[0]}isConnectedInFragmentShader(){return this.endpoints.some((e=>e.output.isConnectedInFragmentShader))}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const s of this.endpoints)-1===t.indexOf(s)&&(i+=s._dumpCode(e,t));return i}isAnAncestorOf(e){for(const t of this.endpoints){if(t===e)return!0;if(t.isAnAncestorOf(e))return!0}return!1}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name,this._outputs=this._endpoints.map((e=>e.output))}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null,this._outputs=this._endpoints.map((e=>e.output)))}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}),(0,V.Y5)("BABYLON.NodeMaterialTeleportOutBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",gr.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeMaterialTeleportOutBlock"}get output(){return this._outputs[0]}get target(){return this._entryPoint?this._entryPoint.target:this._target}set target(e){this._target&e||(this._target=e)}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(e){super._buildBlock(e),this.entryPoint&&(e.compilationString+=e._declareOutput(this.output)+` = ${this.entryPoint.input.associatedVariableName};\n`)}clone(e,t=""){const i=super.clone(e,t);return this.entryPoint&&this.entryPoint.attachToEndpoint(i),i}_customBuildStep(e,t){this.entryPoint&&this.entryPoint.build(e,t)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){const e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e,t,i){super._deserialize(e,t,i),this._tempEntryPointUniqueId=e.entryPoint}}),(0,V.Y5)("BABYLON.AddBlock",class extends Kr{constructor(e){super(e)}getClassName(){return"AddBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\n`,this}}),(0,V.Y5)("BABYLON.ScaleBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("input",gr.AutoDetect),this.registerInput("factor",gr.Float),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\n`,this}});class Yn extends Ir{constructor(e){super(e,vr.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=1===e.shaderLanguage?e._getShaderType(this.value.type):"";return e.compilationString+=e._declareOutput(t)+` = clamp(${this.value.associatedVariableName}, ${i}(${this._writeFloat(this.minimum)}), ${i}(${this._writeFloat(this.maximum)}));\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};\n`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};\n`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}(0,w.Cg)([wr("Minimum",1)],Yn.prototype,"minimum",void 0),(0,w.Cg)([wr("Maximum",1)],Yn.prototype,"maximum",void 0),(0,V.Y5)("BABYLON.ClampBlock",Yn),(0,V.Y5)("BABYLON.CrossBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("left",gr.AutoDetect),this.registerInput("right",gr.AutoDetect),this.registerOutput("output",gr.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(gr.Float),this._inputs[0].excludedConnectionPointTypes.push(gr.Matrix),this._inputs[0].excludedConnectionPointTypes.push(gr.Vector2),this._inputs[1].excludedConnectionPointTypes.push(gr.Float),this._inputs[1].excludedConnectionPointTypes.push(gr.Matrix),this._inputs[1].excludedConnectionPointTypes.push(gr.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\n`,this}}),(0,V.Y5)("BABYLON.CustomBlock",class extends Ir{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach((s=>{const r=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),n=e._getGLType(s.type);t=t.replace(r,n),i=i.replace(r,n)})),this._outputs.forEach((s=>{const r=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),n=e._getGLType(s.type);t=t.replace(r,n),i=i.replace(r,n)})),e._emitFunction(i,t,""),this._outputs.forEach((t=>{e.compilationString+=e._declareOutput(t)+";\n"})),e.compilationString+=i+"(";let s=!1;return this._inputs.forEach(((t,i)=>{i>0&&(e.compilationString+=", "),this._inputSamplers&&-1!==this._inputSamplers.indexOf(t.name)?e.compilationString+=t.connectedPoint?.ownerBlock?.samplerName??t.associatedVariableName:e.compilationString+=t.associatedVariableName,s=!0})),this._outputs.forEach(((t,i)=>{(i>0||s)&&(e.compilationString+=", "),e.compilationString+=t.associatedVariableName})),e.compilationString+=");\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};\n`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){this._options=e,this._code=e.code.join("\n")+"\n",this.name=this.name||e.name,this.target=vr[e.target],e.inParameters?.forEach(((e,t)=>{const i=gr[e.type];"sampler2D"===e.type||"samplerCube"===e.type?(this._inputSamplers=this._inputSamplers||[],this._inputSamplers.push(e.name),this.registerInput(e.name,gr.Object,!0,vr.VertexAndFragment,new Vn(e.name,this,0,Wn,"ImageSourceBlock"))):this.registerInput(e.name,i),Object.defineProperty(this,e.name,{get:function(){return this._inputs[t]},enumerable:!0,configurable:!0})})),e.outParameters?.forEach(((e,t)=>{this.registerOutput(e.name,gr[e.type]),Object.defineProperty(this,e.name,{get:function(){return this._outputs[t]},enumerable:!0,configurable:!0}),"BasedOnInput"===e.type&&(this._outputs[t]._typeConnectionSource=this._findInputByName(e.typeFromInput)[0])})),e.inLinkedConnectionTypes?.forEach((e=>{this._linkConnectionTypes(this._findInputByName(e.input1)[1],this._findInputByName(e.input2)[1])}))}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}),(0,V.Y5)("BABYLON.DotBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("left",gr.AutoDetect),this.registerInput("right",gr.AutoDetect),this.registerOutput("output",gr.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(gr.Float),this._inputs[0].excludedConnectionPointTypes.push(gr.Matrix),this._inputs[1].excludedConnectionPointTypes.push(gr.Float),this._inputs[1].excludedConnectionPointTypes.push(gr.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.NormalizeBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("input",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(gr.Float),this._inputs[0].excludedConnectionPointTypes.push(gr.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${i.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.ColorMergerBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",gr.Color3,!0),this.registerInput("r",gr.Float,!0),this.registerInput("g",gr.Float,!0),this.registerInput("b",gr.Float,!0),this.registerInput("a",gr.Float,!0),this.registerOutput("rgba",gr.Color4),this.registerOutput("rgb",gr.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return"rgb "===e?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,s=this.b,r=this.a,n=this.rgbIn,a=this._outputs[0],o=this._outputs[1],l=e._getShaderType(gr.Vector4),h=e._getShaderType(gr.Vector3);return n.isConnected?(a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${l}(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${n.associatedVariableName}${this._buildSwizzle(3)};\n`)):(a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${l}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${h}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\n`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.rSwizzle=e.rSwizzle??"r",this.gSwizzle=e.gSwizzle??"g",this.bSwizzle=e.bSwizzle??"b",this.aSwizzle=e.aSwizzle??"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";\n`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";\n`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";\n`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";\n`,e}}),(0,V.Y5)("BABYLON.VectorSplitterBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("xyzw",gr.Vector4,!0),this.registerInput("xyz ",gr.Vector3,!0),this.registerInput("xy ",gr.Vector2,!0),this.registerOutput("xyz",gr.Vector3),this.registerOutput("xy",gr.Vector2),this.registerOutput("zw",gr.Vector2),this.registerOutput("x",gr.Float),this.registerOutput("y",gr.Float),this.registerOutput("z",gr.Float),this.registerOutput("w",gr.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],s=this._outputs[1],r=this._outputs[2],n=this._outputs[3],a=this._outputs[4],o=this._outputs[5],l=this._outputs[6],h=e._getShaderType(gr.Vector3);return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=e._declareOutput(i)+` = ${h}(${t.associatedVariableName}, 0.0);\n`:e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.xyz;\n`),r.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=e._declareOutput(r)+` = ${this.xyzw.associatedVariableName}.zw;\n`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName}.xy;\n`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.x;\n`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.y;\n`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.z;\n`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${t.associatedVariableName}.w;\n`),this}}),(0,V.Y5)("BABYLON.LerpBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("left",gr.AutoDetect),this.registerInput("right",gr.AutoDetect),this.registerInput("gradient",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(gr.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.DivideBlock",class extends Kr{constructor(e){super(e)}getClassName(){return"DivideBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\n`,this}}),(0,V.Y5)("BABYLON.SubtractBlock",class extends Kr{constructor(e){super(e)}getClassName(){return"SubtractBlock"}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\n`,this}}),(0,V.Y5)("BABYLON.StepBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("value",gr.Float),this.registerInput("edge",gr.Float),this.registerOutput("output",gr.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\n`,this}});class qn extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("input",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(gr.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = 1. - ${this.input.associatedVariableName};\n`,this}}(0,V.Y5)("BABYLON.OneMinusBlock",qn),(0,V.Y5)("BABYLON.OppositeBlock",qn);class $n extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("worldPosition",gr.Vector4),this.registerInput("cameraPosition",gr.Vector3),this.registerOutput("output",gr.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e,t=(()=>!0)){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.CameraPosition&&t(e)));i||(i=new Vr("cameraPosition"),i.setAsSystemValue(Ar.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);\n`,this}}(0,V.Y5)("BABYLON.ViewDirectionBlock",$n),r(1339),(0,V.Y5)("BABYLON.FresnelBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("worldNormal",gr.Vector4),this.registerInput("viewDirection",gr.Vector3),this.registerInput("bias",gr.Float),this.registerInput("power",gr.Float),this.registerOutput("fresnel",gr.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new $n("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const e=new Vr("bias");e.value=0,e.output.connectTo(this.bias)}if(!this.power.isConnected){const e=new Vr("power");e.value=1,e.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=e._declareOutput(this.fresnel)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.MaxBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("left",gr.AutoDetect),this.registerInput("right",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.MinBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("left",gr.AutoDetect),this.registerInput("right",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.DistanceBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("left",gr.AutoDetect),this.registerInput("right",gr.AutoDetect),this.registerOutput("output",gr.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(gr.Float),this._inputs[0].excludedConnectionPointTypes.push(gr.Matrix),this._inputs[1].excludedConnectionPointTypes.push(gr.Float),this._inputs[1].excludedConnectionPointTypes.push(gr.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.LengthBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("value",gr.AutoDetect),this.registerOutput("output",gr.Float),this._inputs[0].excludedConnectionPointTypes.push(gr.Float),this._inputs[0].excludedConnectionPointTypes.push(gr.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.value.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.NegateBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("value",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = -1.0 * ${this.value.associatedVariableName};\n`,this}}),(0,V.Y5)("BABYLON.PowBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("value",gr.AutoDetect),this.registerInput("power",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = pow(max(${this.value.associatedVariableName}, 0.), ${this.power.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.RandomNumberBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("seed",gr.AutoDetect),this.registerOutput("output",gr.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Vector2|gr.Vector3|gr.Vector4|gr.Color3|gr.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=e._declareOutput(t)+` = getRand(${this.seed.associatedVariableName}.xy);\n`,this}}),(0,V.Y5)("BABYLON.ArcTan2Block",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("x",gr.Float),this.registerInput("y",gr.Float),this.registerOutput("output",gr.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=1===e.shaderLanguage?"atan2":"atan";return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.SmoothStepBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("value",gr.AutoDetect),this.registerInput("edge0",gr.Float),this.registerInput("edge1",gr.Float),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e._getShaderType(this.value.type);return e.compilationString+=e._declareOutput(t)+` = smoothstep(${i}(${this.edge0.associatedVariableName}), ${i}(${this.edge1.associatedVariableName}), ${this.value.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.ReciprocalBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("input",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return this.input.type===gr.Matrix?e.compilationString+=e._declareOutput(t)+` = inverse(${this.input.associatedVariableName});\n`:e.compilationString+=e._declareOutput(t)+` = 1. / ${this.input.associatedVariableName};\n`,this}}),(0,V.Y5)("BABYLON.ReplaceColorBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("value",gr.AutoDetect),this.registerInput("reference",gr.AutoDetect),this.registerInput("distance",gr.Float),this.registerInput("replacement",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(gr.Float),this._inputs[0].excludedConnectionPointTypes.push(gr.Matrix),this._inputs[1].excludedConnectionPointTypes.push(gr.Float),this._inputs[1].excludedConnectionPointTypes.push(gr.Matrix),this._inputs[3].excludedConnectionPointTypes.push(gr.Float),this._inputs[3].excludedConnectionPointTypes.push(gr.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+";\n",e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\n`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};\n`,e.compilationString+="} else {\n",e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};\n`,e.compilationString+="}\n",this}}),(0,V.Y5)("BABYLON.PosterizeBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("value",gr.AutoDetect),this.registerInput("steps",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(gr.Matrix),this._inputs[1].excludedConnectionPointTypes.push(gr.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(gr.Float)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\n`,this}}),function(e){e[e.SawTooth=0]="SawTooth",e[e.Square=1]="Square",e[e.Triangle=2]="Triangle"}(On||(On={})),(0,V.Y5)("BABYLON.WaveBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.kind=0,this.registerInput("input",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(gr.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case 0:e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\n`;break;case 1:e.compilationString+=e._declareOutput(t)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\n`;break;case 2:e.compilationString+=e._declareOutput(t)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\n`}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}});class jn{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}(0,V.Y5)("BABYLON.GradientBlock",class extends Ir{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,vr.Neutral),this.colorSteps=[new jn(0,M.v9.Black()),new jn(1,M.v9.White())],this.onValueChangedObservable=new C.cP,this.registerInput("gradient",gr.AutoDetect),this.registerOutput("output",gr.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Float|gr.Vector2|gr.Vector3|gr.Vector4|gr.Color3|gr.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e,t){const i=this.colorSteps[e];return`${t}(${i.color.r}, ${i.color.g}, ${i.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=e._getShaderType(gr.Vector3);if(!this.colorSteps.length||!this.gradient.connectedPoint)return void(e.compilationString+=e._declareOutput(t)+` = ${i}(0., 0., 0.);\n`);const s=e._getFreeVariableName("gradientTempColor"),r=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`${e._declareLocalVar(s,gr.Vector3)} = ${this._writeColorConstant(0,i)};\n`,e.compilationString+=`${e._declareLocalVar(r,gr.Float)};\n`;let n=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==gr.Float&&(n+=".x");for(let t=1;t<this.colorSteps.length;t++){const a=this.colorSteps[t],o=this.colorSteps[t-1];e.compilationString+=`${r} = clamp((${n} - ${e._emitFloat(o.step)}) / (${e._emitFloat(a.step)} -  ${e._emitFloat(o.step)}), 0.0, 1.0) * step(${e._emitFloat(t)}, ${e._emitFloat(this.colorSteps.length-1)});\n`,e.compilationString+=`${s} = mix(${s}, ${this._writeColorConstant(t,i)}, ${r});\n`}return e.compilationString+=e._declareOutput(t)+` = ${s};\n`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const t of e.colorSteps)this.colorSteps.push(new jn(t.step,new M.v9(t.color.r,t.color.g,t.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];\n`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));\n`;return e}}),(0,V.Y5)("BABYLON.NLerpBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("left",gr.AutoDetect),this.registerInput("right",gr.AutoDetect),this.registerInput("gradient",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(gr.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\n`,this}});class Zn extends Ir{constructor(e){super(e,vr.Neutral),this.manhattanDistance=!1,this.registerInput("seed",gr.Vector3),this.registerInput("jitter",gr.Float),this.registerOutput("output",gr.Vector2),this.registerOutput("x",gr.Float),this.registerOutput("y",gr.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t="vec3 permute(vec3 x){\n";t+="    return mod((34.0 * x + 1.0) * x, 289.0);\n",t+="}\n\n",t+="vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\n",t+="    return [manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z)];\n",t+="}\n\n",t+="vec2 worley(vec3 P, float jitter, bool manhattanDistance){\n",t+="    float K = 0.142857142857; // 1/7\n",t+="    float Ko = 0.428571428571; // 1/2-K/2\n",t+="    float  K2 = 0.020408163265306; // 1/(7*7)\n",t+="    float Kz = 0.166666666667; // 1/6\n",t+="    float Kzo = 0.416666666667; // 1/2-1/6*2\n",t+="\n",t+="    vec3 Pi = mod(floor(P), 289.0);\n",t+="    vec3 Pf = fract(P) - 0.5;\n",t+="\n",t+="    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\n",t+="\n",t+="    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\n",t+="    vec3 p1 = permute(p + Pi.y - 1.0);\n",t+="    vec3 p2 = permute(p + Pi.y);\n",t+="    vec3 p3 = permute(p + Pi.y + 1.0);\n",t+="\n",t+="    vec3 p11 = permute(p1 + Pi.z - 1.0);\n",t+="    vec3 p12 = permute(p1 + Pi.z);\n",t+="    vec3 p13 = permute(p1 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p21 = permute(p2 + Pi.z - 1.0);\n",t+="    vec3 p22 = permute(p2 + Pi.z);\n",t+="    vec3 p23 = permute(p2 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p31 = permute(p3 + Pi.z - 1.0);\n",t+="    vec3 p32 = permute(p3 + Pi.z);\n",t+="    vec3 p33 = permute(p3 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 ox11 = fract(p11*K) - Ko;\n",t+="    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\n",t+="    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\n",t+="\n",t+="    vec3 ox12 = fract(p12*K) - Ko;\n",t+="    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\n",t+="    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox13 = fract(p13*K) - Ko;\n",t+="    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\n",t+="    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox21 = fract(p21*K) - Ko;\n",t+="    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\n",t+="    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox22 = fract(p22*K) - Ko;\n",t+="    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\n",t+="    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox23 = fract(p23*K) - Ko;\n",t+="    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\n",t+="    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox31 = fract(p31*K) - Ko;\n",t+="    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\n",t+="    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox32 = fract(p32*K) - Ko;\n",t+="    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\n",t+="    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox33 = fract(p33*K) - Ko;\n",t+="    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\n",t+="    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 dx11 = Pfx + jitter*ox11;\n",t+="    vec3 dy11 = Pfy.x + jitter*oy11;\n",t+="    vec3 dz11 = Pfz.x + jitter*oz11;\n",t+="\n",t+="    vec3 dx12 = Pfx + jitter*ox12;\n",t+="    vec3 dy12 = Pfy.x + jitter*oy12;\n",t+="    vec3 dz12 = Pfz.y + jitter*oz12;\n",t+="\n",t+="    vec3 dx13 = Pfx + jitter*ox13;\n",t+="    vec3 dy13 = Pfy.x + jitter*oy13;\n",t+="    vec3 dz13 = Pfz.z + jitter*oz13;\n",t+="\n",t+="    vec3 dx21 = Pfx + jitter*ox21;\n",t+="    vec3 dy21 = Pfy.y + jitter*oy21;\n",t+="    vec3 dz21 = Pfz.x + jitter*oz21;\n",t+="\n",t+="    vec3 dx22 = Pfx + jitter*ox22;\n",t+="    vec3 dy22 = Pfy.y + jitter*oy22;\n",t+="    vec3 dz22 = Pfz.y + jitter*oz22;\n",t+="\n",t+="    vec3 dx23 = Pfx + jitter*ox23;\n",t+="    vec3 dy23 = Pfy.y + jitter*oy23;\n",t+="    vec3 dz23 = Pfz.z + jitter*oz23;\n",t+="\n",t+="    vec3 dx31 = Pfx + jitter*ox31;\n",t+="    vec3 dy31 = Pfy.z + jitter*oy31;\n",t+="    vec3 dz31 = Pfz.x + jitter*oz31;\n",t+="\n",t+="    vec3 dx32 = Pfx + jitter*ox32;\n",t+="    vec3 dy32 = Pfy.z + jitter*oy32;\n",t+="    vec3 dz32 = Pfz.y + jitter*oz32;\n",t+="\n",t+="    vec3 dx33 = Pfx + jitter*ox33;\n",t+="    vec3 dy33 = Pfy.z + jitter*oy33;\n",t+="    vec3 dz33 = Pfz.z + jitter*oz33;\n",t+="\n",t+="    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\n",t+="    vec3 d12 = dist(dx12, dy12, dz12, manhattanDistance);\n",t+="    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\n",t+="    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\n",t+="    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\n",t+="    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\n",t+="    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\n",t+="    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\n",t+="    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\n",t+="\n",t+="    vec3 d1a = min(d11, d12);\n",t+="    d12 = max(d11, d12);\n",t+="    d11 = min(d1a, d13); // Smallest now not in d12 or d13\n",t+="    d13 = max(d1a, d13);\n",t+="    d12 = min(d12, d13); // 2nd smallest now not in d13\n",t+="    vec3 d2a = min(d21, d22);\n",t+="    d22 = max(d21, d22);\n",t+="    d21 = min(d2a, d23); // Smallest now not in d22 or d23\n",t+="    d23 = max(d2a, d23);\n",t+="    d22 = min(d22, d23); // 2nd smallest now not in d23\n",t+="    vec3 d3a = min(d31, d32);\n",t+="    d32 = max(d31, d32);\n",t+="    d31 = min(d3a, d33); // Smallest now not in d32 or d33\n",t+="    d33 = max(d3a, d33);\n",t+="    d32 = min(d32, d33); // 2nd smallest now not in d33\n",t+="    vec3 da = min(d11, d21);\n",t+="    d21 = max(d11, d21);\n",t+="    d11 = min(da, d31); // Smallest now in d11\n",t+="    d31 = max(da, d31); // 2nd smallest now not in d31\n",t+="    if (d11.x >= d11.y) { vec2 temp = d11.yx; d11.x = temp.x; d11.y = temp.y; }\n",t+="    if (d11.x >= d11.z) { vec2 temp = d11.zx; d11.x = temp.x; d11.z = temp.y; }\n",t+="    d12 = min(d12, d21); // 2nd smallest now not in d21\n",t+="    d12 = min(d12, d22); // nor in d22\n",t+="    d12 = min(d12, d31); // nor in d31\n",t+="    d12 = min(d12, d32); // nor in d32\n",t+="    vec2 temp2 = min(d11.yz, d12.xy); // nor in d12.yz\n",t+="    d11.y = temp2.x;\n",t+="    d11.z = temp2.y;\n",t+="    d11.y = min(d11.y, d12.z); // Only two more to go\n",t+="    d11.y = min(d11.y, d11.z); // Done! (Phew!)\n",t+="    return sqrt(d11.xy); // F1, F2\n",t+="}\n\n",t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("worley3D",t,"// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`${e._declareLocalVar(i,gr.Vector2)} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\n`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};\n`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${i}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${i}.y;\n`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};\n`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}(0,w.Cg)([wr("Use Manhattan Distance",0,"PROPERTIES",{notifiers:{update:!1}})],Zn.prototype,"manhattanDistance",void 0),(0,V.Y5)("BABYLON.WorleyNoise3DBlock",Zn),(0,V.Y5)("BABYLON.SimplexPerlin3DBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("seed",gr.Vector3),this.registerOutput("output",gr.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;let t="const float SKEWFACTOR = 1.0/3.0;\n";return t+="const float UNSKEWFACTOR = 1.0/6.0;\n",t+="const float SIMPLEX_CORNER_POS = 0.5;\n",t+="const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\n",t+="float SimplexPerlin3D( vec3 source ){\n",t+="    vec3 P = source;\n",t+="    P.x = [P.x == 0. && P.y == 0. && P.z == 0. ? 0.00001 : P.x];\n",t+="    P *= SIMPLEX_TETRAHADRON_HEIGHT;\n",t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+="    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\n",t+="    vec3 g = step(x0.yzx, x0.xyz);\n",t+="    vec3 l = 1.0 - g;\n",t+="    vec3 Pi_1 = min( g.xyz, l.zxy );\n",t+="    vec3 Pi_2 = max( g.xyz, l.zxy );\n",t+="    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\n",t+="    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\n",t+="    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\n",t+="    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\n",t+="    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\n",t+="    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\n",t+="    Pi = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\n",t+="    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\n",t+="    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\n",t+="    Pt *= Pt;\n",t+="    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\n",t+="    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\n",t+="    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\n",t+="    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\n",t+="    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\n",t+="    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\n",t+="    Pi_1 = [( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods];\n",t+="    Pi_2 = [( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods];\n",t+="    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\n",t+="    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\n",t+="    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\n",t+="    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\n",t+="    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\n",t+="    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\n",t+="    kernel_weights = max(0.5 - kernel_weights, vec4(0.));\n",t+="    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\n",t+="    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\n",t+="}\n",t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=e._declareOutput(this._outputs[0])+` = SimplexPerlin3D(${this.seed.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.NormalBlendBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("normalMap0",gr.AutoDetect),this.registerInput("normalMap1",gr.AutoDetect),this.registerOutput("output",gr.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Color4|gr.Vector3|gr.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Color4|gr.Vector3|gr.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],s=this._inputs[1],r=e._getFreeVariableName("stepR"),n=e._getFreeVariableName("stepG");return e.compilationString+=`${e._declareLocalVar(r,gr.Float)} = step(0.5, ${i.associatedVariableName}.r);\n`,e.compilationString+=`${e._declareLocalVar(n,gr.Float)} = step(0.5, ${i.associatedVariableName}.g);\n`,e.compilationString+=e._declareOutput(t)+";\n",e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${r}) * ${i.associatedVariableName}.r * ${s.associatedVariableName}.r * 2.0 + ${r} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${s.associatedVariableName}.r) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${n}) * ${i.associatedVariableName}.g * ${s.associatedVariableName}.g * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${s.associatedVariableName}.g) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${s.associatedVariableName}.b;\n`,this}}),(0,V.Y5)("BABYLON.Rotate2dBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("input",gr.Vector2),this.registerInput("angle",gr.Float),this.registerOutput("output",gr.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new Vr("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.angle,s=this.input;return e.compilationString+=e._declareOutput(t)+` = vec2(cos(${i.associatedVariableName}) * ${s.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${s.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${s.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${s.associatedVariableName}.y);\n`,this}}),(0,V.Y5)("BABYLON.ReflectBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("incident",gr.AutoDetect),this.registerInput("normal",gr.AutoDetect),this.registerOutput("output",gr.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Vector3|gr.Vector4|gr.Color3|gr.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(gr.Vector3|gr.Vector4|gr.Color3|gr.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\n`,this}}),(0,V.Y5)("BABYLON.RefractBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("incident",gr.AutoDetect),this.registerInput("normal",gr.AutoDetect),this.registerInput("ior",gr.Float),this.registerOutput("output",gr.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Vector3|gr.Vector4|gr.Color3|gr.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(gr.Vector3|gr.Vector4|gr.Color3|gr.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.DesaturateBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("color",gr.Color3),this.registerInput("level",gr.Float),this.registerOutput("output",gr.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.color.associatedVariableName,s=e._getFreeVariableName("colorMin"),r=e._getFreeVariableName("colorMax"),n=e._getFreeVariableName("colorMerge");return e.compilationString+=`${e._declareLocalVar(s,gr.Float)} = min(min(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`${e._declareLocalVar(r,gr.Float)} = max(max(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`${e._declareLocalVar(n,gr.Float)} = 0.5 * (${s} + ${r});\n`,e.compilationString+=e._declareOutput(t)+` = mix(${i}, ${e._getShaderType(gr.Vector3)}(${n}, ${n}, ${n}), ${this.level.associatedVariableName});\n`,this}});class Jn extends Ir{constructor(e){super(e,vr.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",gr.Float,!0,vr.Fragment),this.registerInput("color",gr.Color3,!0,vr.Fragment),this.registerInput("roughness",gr.Float,!0,vr.Fragment),this.registerOutput("sheen",gr.Object,vr.Fragment,new Vn("sheen",this,1,Jn,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e,t){let i="";const s=this.color.isConnected?this.color.associatedVariableName:`vec3${t.fSuffix}(1.)`,r=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",n=this.roughness.isConnected?this.roughness.associatedVariableName:"0.",a=`vec4${t.fSuffix}(0.)`,o=1===t.shaderLanguage;return i=`#ifdef SHEEN\n            ${o?"var sheenOut: sheenOutParams":"sheenOutParams sheenOut"};\n\n            ${t._declareLocalVar("vSheenColor",gr.Vector4)} = vec4${t.fSuffix}(${s}, ${r});\n\n            sheenOut = sheenBlock(\n                vSheenColor\n            #ifdef SHEEN_ROUGHNESS\n                , ${n}\n            #endif\n                , roughness\n            #ifdef SHEEN_TEXTURE\n                , ${a}\n                ${o?`, ${a}Sampler`:""}\n                , 1.0\n            #endif\n                , reflectance\n            #ifdef SHEEN_LINKWITHALBEDO\n                , baseColor\n                , surfaceAlbedo\n            #endif\n            #ifdef ENVIRONMENTBRDF\n                , NdotV\n                , environmentBrdf\n            #endif\n            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n                , AARoughnessFactors\n                , ${o?"uniforms.":""}${e?._vReflectionMicrosurfaceInfosName}\n                , ${e?._vReflectionInfosName}\n                , ${e?.reflectionColor}\n                , ${o?"uniforms.":""}vLightingIntensity\n                #ifdef ${e?._define3DName}\n                    , ${e?._cubeSamplerName}                                      \n                    ${o?`, ${e?._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${e?._2DSamplerName}\n                    ${o?`, ${e?._2DSamplerName}Sampler`:""}\n                #endif\n                , reflectionOut.reflectionCoords\n                , NdotVUnclamped\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${e?._define3DName}\n                        , ${e?._cubeSamplerName}                        \n                        ${o?`, ${e?._cubeSamplerName}Sampler`:""}\n                        , ${e?._cubeSamplerName}\n                        ${o?`, ${e?._cubeSamplerName}Sampler`:""}\n                    #else\n                        , ${e?._2DSamplerName}\n                        ${o?`, ${e?._2DSamplerName}Sampler`:""}\n                        , ${e?._2DSamplerName}\n                        ${o?`, ${e?._2DSamplerName}Sampler`:""}\n                    #endif\n                #endif\n                #if !defined(${e?._defineSkyboxName}) && defined(RADIANCEOCCLUSION)\n                    , seo\n                #endif\n                #if !defined(${e?._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${e?._define3DName})\n                    , eho\n                #endif\n            #endif\n            );\n\n            #ifdef SHEEN_LINKWITHALBEDO\n                surfaceAlbedo = sheenOut.surfaceAlbedo;\n            #endif\n        #endif\n`,i}_buildBlock(e){return e.target===vr.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};\n`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};\n`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}(0,w.Cg)([wr("Albedo scaling",0,"PROPERTIES",{notifiers:{update:!0}})],Jn.prototype,"albedoScaling",void 0),(0,w.Cg)([wr("Link sheen with albedo",0,"PROPERTIES",{notifiers:{update:!0}})],Jn.prototype,"linkSheenWithAlbedo",void 0),(0,V.Y5)("BABYLON.SheenBlock",Jn);class ea extends Ir{constructor(e){super(e,vr.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",gr.Float,!0,vr.Fragment),this.registerInput("direction",gr.Vector2,!0,vr.Fragment),this.registerInput("uv",gr.Vector2,!0),this.registerInput("worldTangent",gr.Vector4,!0),this.registerInput("TBN",gr.Object,!0,vr.VertexAndFragment,new Vn("TBN",this,0,Un,"TBNBlock")),this.registerInput("roughness",gr.Float,!0,vr.Fragment),this.registerOutput("anisotropy",gr.Object,vr.Fragment,new Vn("anisotropy",this,1,ea,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get roughness(){return this._inputs[5]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,s=this.uv,r=this.worldPositionConnectionPoint,n=this.worldNormalConnectionPoint,a=this.worldTangent,o=1===e.shaderLanguage;s.isConnected||l.V.Error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const h={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},c=this.TBN;return c.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            ${o?"var TBN":"mat3 TBN"} = ${c.associatedVariableName};\n            #endif\n            `:a.isConnected&&(t+=`${e._declareLocalVar("tbnNormal",gr.Vector3)} = normalize(${n.associatedVariableName}.xyz);\n`,t+=`${e._declareLocalVar("tbnTangent",gr.Vector3)} = normalize(${a.associatedVariableName}.xyz);\n`,t+=`${e._declareLocalVar("tbnBitangent",gr.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,t+=`${o?"var vTBN":"mat3 vTBN"} = ${o?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);\n`),t+=`\n            #if defined(${a.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                ${o?"var TBN":"mat3 TBN"} = vTBN;\n            #else\n                ${o?"var TBN":"mat3 TBN"} = cotangent_frame(${n.associatedVariableName+".xyz"}, ${"v_"+r.associatedVariableName+".xyz"}, ${s.isConnected?s.associatedVariableName:"vec2(0.)"}, vec2${e.fSuffix}(1., 1.));\n            #endif\n`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[h]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));const s=1===e.shaderLanguage,r=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0";return i+=`${s?"var anisotropicOut: anisotropicOutParams":"anisotropicOutParams anisotropicOut"};\n            anisotropicOut = anisotropicBlock(\n                vec3(${this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)"}, ${r}),\n                ${this.roughness.isConnected?this.roughness.associatedVariableName:"0."},\n            #ifdef ANISOTROPIC_TEXTURE\n                vec3(0.),\n            #endif\n                TBN,\n                normalW,\n                viewDirectionW\n            );\n`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0),i.setValue("ANISOTROPIC_LEGACY",!this.roughness.isConnected)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===vr.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,gr.Float)),this}}(0,V.Y5)("BABYLON.AnisotropyBlock",ea);class ta extends Kn{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,l.V.Error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?vr.Fragment:vr.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",gr.AutoDetect,!1,vr.Vertex),this.registerInput("world",gr.Matrix,!1,vr.Vertex),this.registerInput("color",gr.Color3,!0,vr.Fragment),this.registerOutput("reflection",gr.Object,vr.Fragment,new Vn("reflection",this,1,ta,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Vector3|gr.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this._getTexture(),r=s&&s.getTextureMatrix;i.setValue("REFLECTION",r,!0),r&&(i.setValue(this._defineLODReflectionAlpha,s.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,s.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!s.invertZ:s.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",s.gammaSpace,!0),i.setValue("RGBDREFLECTION",s.isRGBD,!0),s&&s.coordinatesMode!==G.g.SKYBOX_MODE&&s.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,s){super.bind(e,t,i);const r=this._getTexture();if(!r||!s)return;r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r);const n=r.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,n,r.lodGenerationScale,r.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,n,Math.log2(n));const a=s.materialDefines,o=r.sphericalPolynomial;if(a.USESPHERICALFROMREFLECTIONMAP&&o)if(a.SPHERICAL_HARMONICS){const t=o.preScaledHarmonics;e.setVector3("vSphericalL00",t.l00),e.setVector3("vSphericalL1_1",t.l1_1),e.setVector3("vSphericalL10",t.l10),e.setVector3("vSphericalL11",t.l11),e.setVector3("vSphericalL2_2",t.l2_2),e.setVector3("vSphericalL2_1",t.l2_1),e.setVector3("vSphericalL20",t.l20),e.setVector3("vSphericalL21",t.l21),e.setVector3("vSphericalL22",t.l22)}else e.setFloat3("vSphericalX",o.x.x,o.x.y,o.x.z),e.setFloat3("vSphericalY",o.y.x,o.y.y,o.y.z),e.setFloat3("vSphericalZ",o.z.x,o.z.y,o.z.z),e.setFloat3("vSphericalXX_ZZ",o.xx.x-o.zz.x,o.xx.y-o.zz.y,o.xx.z-o.zz.z),e.setFloat3("vSphericalYY_ZZ",o.yy.x-o.zz.x,o.yy.y-o.zz.y,o.yy.z-o.zz.z),e.setFloat3("vSphericalZZ",o.zz.x,o.zz.y,o.zz.z),e.setFloat3("vSphericalXY",o.xy.x,o.xy.y,o.xy.z),e.setFloat3("vSphericalYZ",o.yz.x,o.yz.y,o.yz.z),e.setFloat3("vSphericalZX",o.zx.x,o.zx.y,o.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);const i=1===e.shaderLanguage;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const s=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,gr.Vector3,"defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00",gr.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1",gr.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10",gr.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11",gr.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2",gr.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1",gr.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20",gr.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21",gr.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22",gr.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX",gr.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY",gr.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ",gr.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ",gr.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ",gr.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ",gr.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY",gr.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ",gr.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX",gr.Vector3,"SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n                ${e._declareLocalVar(s,gr.Vector3)} = (${(i?"uniforms.":"")+this._reflectionMatrixName} * vec4${e.fSuffix}(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;\n                #ifdef ${this._defineOppositeZ}\n                    ${s}.z *= -1.0;\n                #endif\n                ${i?"vertexOutputs.":""}${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${s});\n            #endif\n`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e);const s=1===e.shaderLanguage;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),s||(e._emitFunction("sampleReflection",`\n                #ifdef ${this._define3DName}\n                    #define sampleReflection(s, c) textureCube(s, c)\n                #else\n                    #define sampleReflection(s, c) texture2D(s, c)\n                #endif\n`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`\n                #ifdef ${this._define3DName}\n                    #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)\n                #else\n                    #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)\n                #endif\n`,`//${this.name}`));const r=s?`\n            fn computeReflectionCoordsPBR(worldPos: vec4f, worldNormal: vec3f) -> vec3f {\n                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}\n                return ${this._reflectionVectorName};\n            }\n`:`\n            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {\n                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}\n                return ${this._reflectionVectorName};\n            }\n`;return e._emitFunction("computeReflectionCoordsPBR",r,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,gr.Vector3),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,gr.Vector2),i+=`#ifdef REFLECTION\n            ${e._declareLocalVar(this._vReflectionInfosName,gr.Vector2)} = vec2${e.fSuffix}(1., 0.);\n\n            ${s?"var reflectionOut: reflectionOutParams":"reflectionOutParams reflectionOut"};\n\n            reflectionOut = reflectionBlock(\n                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:(s?"input.":"")+"v_"+this.worldPosition.associatedVariableName}.xyz\n                , ${t}\n                , alphaG\n                , ${(s?"uniforms.":"")+this._vReflectionMicrosurfaceInfosName}\n                , ${this._vReflectionInfosName}\n                , ${this.reflectionColor}\n            #ifdef ANISOTROPIC\n                ,anisotropicOut\n            #endif\n            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})\n                ,NdotVUnclamped\n            #endif\n            #ifdef ${this._defineLinearSpecularReflection}\n                , roughness\n            #endif\n            #ifdef ${this._define3DName}\n                , ${this._cubeSamplerName}\n                ${s?`, ${this._cubeSamplerName}Sampler`:""}\n            #else\n                , ${this._2DSamplerName}\n                ${s?`, ${this._2DSamplerName}Sampler`:""}\n            #endif\n            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n                , ${s?"input.":""}${this._vEnvironmentIrradianceName}\n            #endif\n            #ifdef USESPHERICALFROMREFLECTIONMAP\n                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                    , ${this._reflectionMatrixName}\n                #endif\n            #endif\n            #ifdef USEIRRADIANCEMAP\n                , irradianceSampler         // ** not handled **\n                ${s?", irradianceSamplerSampler":""}\n            #endif\n            #ifndef LODBASEDMICROSFURACE\n                #ifdef ${this._define3DName}\n                    , ${this._cubeSamplerName}\n                    ${s?`, ${this._cubeSamplerName}Sampler`:""}\n                    , ${this._cubeSamplerName}\n                    ${s?`, ${this._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${this._2DSamplerName}\n                    ${s?`, ${this._2DSamplerName}Sampler`:""}\n                    , ${this._2DSamplerName}                    \n                    ${s?`, ${this._2DSamplerName}Sampler`:""}\n                #endif\n            #endif\n            #ifdef REALTIME_FILTERING\n                , ${this._vReflectionFilteringInfoName}\n            #endif\n            );\n        #endif\n`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==vr.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};\n`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};\n`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};\n`,e}serialize(){const e=super.serialize();return e.useSphericalHarmonics=this.useSphericalHarmonics,e.forceIrradianceInFragment=this.forceIrradianceInFragment,e.gammaSpace=this.texture?.gammaSpace??!0,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}(0,w.Cg)([wr("Spherical Harmonics",0,"ADVANCED",{notifiers:{update:!0}})],ta.prototype,"useSphericalHarmonics",void 0),(0,w.Cg)([wr("Force irradiance in fragment",0,"ADVANCED",{notifiers:{update:!0}})],ta.prototype,"forceIrradianceInFragment",void 0),(0,V.Y5)("BABYLON.ReflectionBlock",ta);class ia extends Ir{constructor(e){super(e,vr.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",gr.Float,!1,vr.Fragment),this.registerInput("roughness",gr.Float,!0,vr.Fragment),this.registerInput("indexOfRefraction",gr.Float,!0,vr.Fragment),this.registerInput("normalMapColor",gr.Color3,!0,vr.Fragment),this.registerInput("uv",gr.Vector2,!0,vr.Fragment),this.registerInput("tintColor",gr.Color3,!0,vr.Fragment),this.registerInput("tintAtDistance",gr.Float,!0,vr.Fragment),this.registerInput("tintThickness",gr.Float,!0,vr.Fragment),this.registerInput("worldTangent",gr.Vector4,!0),this.registerInput("worldNormal",gr.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(gr.Color4|gr.Vector4|gr.Vector3),this.registerInput("TBN",gr.Object,!0,vr.VertexAndFragment,new Vn("TBN",this,0,Un,"TBNBlock")),this.registerOutput("clearcoat",gr.Object,vr.Fragment,new Vn("clearcoat",this,1,ia,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new Vr("ClearCoat intensity",vr.Fragment,gr.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",!this.indexOfRefraction.isConnected||this.indexOfRefraction.connectInputBlock.value===ke._DefaultIndexOfRefraction,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){super.bind(e,t,i);const s=this.indexOfRefraction.connectInputBlock?.value??ke._DefaultIndexOfRefraction,r=1-s,n=1+s,a=Math.pow(-r/n,2),o=1/s;e.setFloat4("vClearCoatRefractionParams",a,o,r,n);const l=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,h=l?.perturbedNormal.isConnected?l.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",h?.invertX?1:-1,h?.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",h?.invertX?-1:1,h?.invertY?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let s="";const r=`//${this.name}`,n=this.worldTangent,a=1===e.shaderLanguage;a||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const o={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n                ${a?"var TBN":"mat3 TBN"} = ${l.associatedVariableName};\n            #endif\n            `:n.isConnected&&(s+=`${e._declareLocalVar("tbnNormal",gr.Vector3)} = normalize(${i}.xyz);\n`,s+=`${e._declareLocalVar("tbnTangent",gr.Vector3)} = normalize(${n.associatedVariableName}.xyz);\n`,s+=`${e._declareLocalVar("tbnBitangent",gr.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,s+=`${a?"var vTBN":"mat3 vTBN"} = ${a?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);\n`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",r,{replaceStrings:[o]}),s}static GetCode(e,t,i,s,r,n,a){let o="";const l=t?.intensity.isConnected?t.intensity.associatedVariableName:"1.",h=t?.roughness.isConnected?t.roughness.associatedVariableName:"0.",c=t?.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:`vec3${e.fSuffix}(0.)`,u=t?.uv.isConnected?t.uv.associatedVariableName:`vec2${e.fSuffix}(0.)`,d=t?.tintColor.isConnected?t.tintColor.associatedVariableName:`vec3${e.fSuffix}(1.)`,_=t?.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",p=t?.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",f=`vec4${e.fSuffix}(0.)`;if(t){e._emitUniformFromString("vClearCoatRefractionParams",gr.Vector4),e._emitUniformFromString("vClearCoatTangentSpaceParams",gr.Vector2);const i=t.worldNormal;o+=`${e._declareLocalVar("vGeometricNormaClearCoatW",gr.Vector3)} = ${i.isConnected?"normalize("+i.associatedVariableName+".xyz)":"geometricNormalW"};\n`}else o+=`${e._declareLocalVar("vGeometricNormaClearCoatW",gr.Vector3)} = geometricNormalW;\n`;r&&t&&(o+=t._generateTBNSpace(e,s,a),n=t.worldTangent.isConnected);const m=1===e.shaderLanguage;return o+=`${m?"var clearcoatOut: clearcoatOutParams":"clearcoatOutParams clearcoatOut"};\n\n        #ifdef CLEARCOAT\n            ${e._declareLocalVar("vClearCoatParams",gr.Vector2)} = vec2${e.fSuffix}(${l}, ${h});\n            ${e._declareLocalVar("vClearCoatTintParams",gr.Vector4)} = vec4${e.fSuffix}(${d}, ${_});\n\n            clearcoatOut = clearcoatBlock(\n                ${s}.xyz\n                , vGeometricNormaClearCoatW\n                , viewDirectionW\n                , vClearCoatParams\n                , specularEnvironmentR0\n            #ifdef CLEARCOAT_TEXTURE\n                , vec2${e.fSuffix}(0.)\n            #endif\n            #ifdef CLEARCOAT_TINT\n                , vClearCoatTintParams\n                , ${p}\n                , ${m?"uniforms.":""}vClearCoatRefractionParams\n                #ifdef CLEARCOAT_TINT_TEXTURE\n                    , ${f}\n                #endif\n            #endif\n            #ifdef CLEARCOAT_BUMP\n                , vec2${e.fSuffix}(0., 1.)\n                , vec4${e.fSuffix}(${c}, 0.)\n                , ${u}\n                #if defined(${n?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                    , vTBN\n                #else\n                    , ${m?"uniforms.":""}vClearCoatTangentSpaceParams\n                #endif\n                #ifdef OBJECTSPACE_NORMALMAP\n                    , normalMatrix\n                #endif\n            #endif\n            #if defined(FORCENORMALFORWARD) && defined(NORMAL)\n                , faceNormal\n            #endif\n            #ifdef REFLECTION\n                , ${m?"uniforms.":""}${i?._vReflectionMicrosurfaceInfosName}\n                , ${i?._vReflectionInfosName}\n                , ${i?.reflectionColor}\n                , ${m?"uniforms.":""}vLightingIntensity\n                #ifdef ${i?._define3DName}\n                    , ${i?._cubeSamplerName}       \n                    ${m?`, ${i?._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${i?._2DSamplerName}       \n                    ${m?`, ${i?._2DSamplerName}Sampler`:""}\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${i?._define3DName}\n                        , ${i?._cubeSamplerName}       \n                        ${m?`, ${i?._cubeSamplerName}Sampler`:""}\n                        , ${i?._cubeSamplerName}\n                        ${m?`, ${i?._cubeSamplerName}Sampler`:""}\n                    #else\n                        , ${i?._2DSamplerName}\n                        ${m?`, ${i?._2DSamplerName}Sampler`:""}\n                        , ${i?._2DSamplerName}\n                        ${m?`, ${i?._2DSamplerName}Sampler`:""}                        \n                    #endif\n                #endif\n            #endif\n            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n                , (${e._generateTernary("1.","-1.",m?"fragmentInputs.frontFacing":"gl_FrontFacing")})\n            #endif\n            );\n        #else\n            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;\n        #endif\n`,o}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===vr.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,gr.Float)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};\n`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.remapF0OnInterfaceChange=e.remapF0OnInterfaceChange??!0}}(0,w.Cg)([wr("Remap F0 on interface change",0,"ADVANCED")],ia.prototype,"remapF0OnInterfaceChange",void 0),(0,V.Y5)("BABYLON.ClearCoatBlock",ia);class sa extends Ir{constructor(e){super(e,vr.Fragment),this._isUnique=!0,this.registerInput("intensity",gr.Float,!0,vr.Fragment),this.registerInput("indexOfRefraction",gr.Float,!0,vr.Fragment),this.registerInput("thickness",gr.Float,!0,vr.Fragment),this.registerOutput("iridescence",gr.Object,vr.Fragment,new Vn("iridescence",this,1,sa,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new Vr("Iridescence intensity",vr.Fragment,gr.Float);e.value=1,e.output.connectTo(this.intensity);const t=new Vr("Iridescence ior",vr.Fragment,gr.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new Vr("Iridescence thickness",vr.Fragment,gr.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e,t){let i="";const s=e?.intensity.isConnected?e.intensity.associatedVariableName:"1.",r=e?.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:Ue._DefaultIndexOfRefraction,n=e?.thickness.isConnected?e.thickness.associatedVariableName:Ue._DefaultMaximumThickness;return i+=`${1===t.shaderLanguage?"var iridescenceOut: iridescenceOutParams":"iridescenceOutParams iridescenceOut"};\n\n        #ifdef IRIDESCENCE\n            iridescenceOut = iridescenceBlock(\n                vec4(${s}, ${r}, 1., ${n})\n                , NdotV\n                , specularEnvironmentR0\n                #ifdef CLEARCOAT\n                    , NdotVUnclamped\n                #endif                \n            );\n\n            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;\n            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;\n        #endif\n`,i}_buildBlock(e){return e.target===vr.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}(0,V.Y5)("BABYLON.IridescenceBlock",sa);class ra extends Ir{constructor(e){super(e,vr.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",gr.Float,!1,vr.Fragment),this.registerInput("tintAtDistance",gr.Float,!0,vr.Fragment),this.registerInput("volumeIndexOfRefraction",gr.Float,!0,vr.Fragment),this.registerOutput("refraction",gr.Object,vr.Fragment,new Vn("refraction",this,1,ra,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e,t=(()=>!0)){if(!this.intensity.isConnected){const e=new Vr("Refraction intensity",vr.Fragment,gr.Float);e.value=1,e.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.View&&t(e)));i||(i=new Vr("view"),i.setAsSystemValue(Ar.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this._getTexture(),r=s&&s.getTextureMatrix;i.setValue("SS_REFRACTION",r,!0),r&&(i.setValue(this._define3DName,s.isCube,!0),i.setValue(this._defineLODRefractionAlpha,s.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,s.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem&&s.isCube?!s.invertZ:s.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",s.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",s.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!s.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){super.bind(e,t,i);const s=this._getTexture();if(!s)return;s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s),e.setMatrix(this._refractionMatrixName,s.getRefractionTextureMatrix());let r=1;s.isCube||s.depth&&(r=s.depth);const n=this.volumeIndexOfRefraction.connectInputBlock?.value??this.indexOfRefractionConnectionPoint.connectInputBlock?.value??1.5;e.setFloat4(this._vRefractionInfosName,s.level,1/n,r,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,s.getSize().width,s.lodGenerationScale,s.lodGenerationOffset,1/n);const a=s.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,a,Math.log2(a)),s.boundingBoxSize){const t=s;e.setVector3("vRefractionPosition",t.boundingBoxPosition),e.setVector3("vRefractionSize",t.boundingBoxSize)}}getCode(e){return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),this._getTexture()&&(e._samplerDeclaration+=`#ifdef ${this._define3DName}\n`,e._emitCubeSampler(this._cubeSamplerName,void 0,!0),e._samplerDeclaration+="#else\n",e._emit2DSampler(this._2DSamplerName,void 0,!0),e._samplerDeclaration+="#endif\n"),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,gr.Matrix),1!==e.shaderLanguage&&(e._emitFunction("sampleRefraction",`\n                #ifdef ${this._define3DName}\n                    #define sampleRefraction(s, c) textureCube(s, c)\n                #else\n                    #define sampleRefraction(s, c) texture2D(s, c)\n                #endif\n`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`\n                #ifdef ${this._define3DName}\n                    #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)\n                #else\n                    #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)\n                #endif\n`,`//${this.name}`)),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,gr.Vector4),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,gr.Vector4),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,gr.Vector2),e._emitUniformFromString("vRefractionPosition",gr.Vector3),e._emitUniformFromString("vRefractionSize",gr.Vector3),""}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e=this.texture.isCube?`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");\n`:`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};\n`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};\n`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=hi.Parse(e.texture,t,i):this.texture=G.g.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}(0,w.Cg)([wr("Link refraction to transparency",0,"ADVANCED",{notifiers:{update:!0}})],ra.prototype,"linkRefractionWithTransparency",void 0),(0,w.Cg)([wr("Invert refraction Y",0,"ADVANCED",{notifiers:{update:!0}})],ra.prototype,"invertRefractionY",void 0),(0,w.Cg)([wr("Use thickness as depth",0,"ADVANCED",{notifiers:{update:!0}})],ra.prototype,"useThicknessAsDepth",void 0),(0,V.Y5)("BABYLON.RefractionBlock",ra);class na extends Ir{constructor(e){super(e,vr.Fragment),this._isUnique=!0,this.registerInput("thickness",gr.Float,!1,vr.Fragment),this.registerInput("tintColor",gr.Color3,!0,vr.Fragment),this.registerInput("translucencyIntensity",gr.Float,!0,vr.Fragment),this.registerInput("translucencyDiffusionDist",gr.Color3,!0,vr.Fragment),this.registerInput("refraction",gr.Object,!0,vr.Fragment,new Vn("refraction",this,0,ra,"RefractionBlock")),this.registerInput("dispersion",gr.Float,!0,vr.Fragment),this.registerOutput("subsurface",gr.Object,vr.Fragment,new Vn("subsurface",this,1,na,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vTranslucencyColor"),e._excludeVariableName("vSubSurfaceIntensity"),e._excludeVariableName("dispersion")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get dispersion(){return this._inputs[5]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new Vr("SubSurface thickness",vr.Fragment,gr.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",s||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",s,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0),i.setValue("SS_DISPERSION",this.dispersion.isConnected,!0)}static GetCode(e,t,i,s){let r="";const n=t?.thickness.isConnected?t.thickness.associatedVariableName:"0.",a=t?.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",o=t?.translucencyIntensity.isConnected?t?.translucencyIntensity.associatedVariableName:"1.",l=t?.translucencyDiffusionDist.isConnected?t?.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",h=t?.refraction.isConnected?t?.refraction.connectedPoint?.ownerBlock:null,c=h?.tintAtDistance.isConnected?h.tintAtDistance.associatedVariableName:"1.",u=h?.intensity.isConnected?h.intensity.associatedVariableName:"1.",d=h?.view.isConnected?h.view.associatedVariableName:"",_=t?.dispersion.isConnected?t?.dispersion.associatedVariableName:"0.0",p=1===e.shaderLanguage;return r+=h?.getCode(e)??"",r+=`${p?"var subSurfaceOut: subSurfaceOutParams":"subSurfaceOutParams subSurfaceOut"};\n\n        #ifdef SUBSURFACE\n            ${e._declareLocalVar("vThicknessParam",gr.Vector2)} = vec2${e.fSuffix}(0., ${n});\n            ${e._declareLocalVar("vTintColor",gr.Vector4)} = vec4${e.fSuffix}(${a}, ${c});\n            ${e._declareLocalVar("vSubSurfaceIntensity",gr.Vector3)} = vec3(${u}, ${o}, 0.);\n            ${e._declareLocalVar("dispersion",gr.Float)} = ${_};\n            subSurfaceOut = subSurfaceBlock(\n                vSubSurfaceIntensity\n                , vThicknessParam\n                , vTintColor\n                , normalW\n                , specularEnvironmentReflectance\n            #ifdef SS_THICKNESSANDMASK_TEXTURE\n                , vec4${e.fSuffix}(0.)\n            #endif\n            #ifdef REFLECTION\n                #ifdef SS_TRANSLUCENCY\n                    , ${(p?"uniforms.":"")+i?._reflectionMatrixName}\n                    #ifdef USESPHERICALFROMREFLECTIONMAP\n                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                            , reflectionOut.irradianceVector\n                        #endif\n                        #if defined(REALTIME_FILTERING)\n                            , ${i?._cubeSamplerName}\n                            ${p?`, ${i?._cubeSamplerName}Sampler`:""}\n                            , ${i?._vReflectionFilteringInfoName}\n                        #endif\n                        #endif\n                    #ifdef USEIRRADIANCEMAP\n                        , irradianceSampler\n                        ${p?", irradianceSamplerSampler":""}\n                    #endif\n                #endif\n            #endif\n            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n                , surfaceAlbedo\n            #endif\n            #ifdef SS_REFRACTION\n                , ${s}.xyz\n                , viewDirectionW\n                , ${d}\n                , ${(p?"uniforms.":"")+h?._vRefractionInfosName??""}\n                , ${(p?"uniforms.":"")+h?._refractionMatrixName??""}\n                , ${(p?"uniforms.":"")+h?._vRefractionMicrosurfaceInfosName??""}\n                , ${p?"uniforms.":""}vLightingIntensity\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    , alpha\n                #endif\n                #ifdef ${h?._defineLODRefractionAlpha??"IGNORE"}\n                    , NdotVUnclamped\n                #endif\n                #ifdef ${h?._defineLinearSpecularRefraction??"IGNORE"}\n                    , roughness\n                #endif\n                , alphaG\n                #ifdef ${h?._define3DName??"IGNORE"}\n                    , ${h?._cubeSamplerName??""}\n                    ${p?`, ${h?._cubeSamplerName}Sampler`:""}\n                #else\n                    , ${h?._2DSamplerName??""}\n                    ${p?`, ${h?._2DSamplerName}Sampler`:""}\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${h?._define3DName??"IGNORE"}\n                        , ${h?._cubeSamplerName??""}                        \n                        ${p?`, ${h?._cubeSamplerName}Sampler`:""}\n                        , ${h?._cubeSamplerName??""}                        \n                        ${p?`, ${h?._cubeSamplerName}Sampler`:""}\n                    #else\n                        , ${h?._2DSamplerName??""}\n                        ${p?`, ${h?._2DSamplerName}Sampler`:""}\n                        , ${h?._2DSamplerName??""}\n                        ${p?`, ${h?._2DSamplerName}Sampler`:""}\n                    #endif\n                #endif\n                #ifdef ANISOTROPIC\n                    , anisotropicOut\n                #endif\n                #ifdef REALTIME_FILTERING\n                    , ${h?._vRefractionFilteringInfoName??""}\n                #endif\n                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n                    , vRefractionPosition\n                    , vRefractionSize\n                #endif\n                #ifdef SS_DISPERSION\n                    , dispersion\n                #endif\n            #endif\n            #ifdef SS_TRANSLUCENCY\n                , ${l}\n                , vTintColor\n                #ifdef SS_TRANSLUCENCYCOLOR_TEXTURE\n                    , vec4${e.fSuffix}(0.)\n                #endif\n            #endif                \n            );\n\n            #ifdef SS_REFRACTION\n                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha = subSurfaceOut.alpha;\n                #endif\n            #endif\n        #else\n            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;\n        #endif\n`,r}_buildBlock(e){return e.target===vr.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}(0,V.Y5)("BABYLON.SubSurfaceBlock",na);const aa={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["aggShadow",""],alpha:["alpha",""]};class oa extends Ir{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,l.V.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?vr.Fragment:vr.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?vr.Fragment:vr.Vertex}constructor(e){super(e,vr.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=M.v9.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",gr.Vector4,!1,vr.Vertex),this.registerInput("worldNormal",gr.Vector4,!1,vr.Vertex),this.registerInput("view",gr.Matrix,!1),this.registerInput("cameraPosition",gr.Vector3,!1,vr.Fragment),this.registerInput("perturbedNormal",gr.Vector4,!0,vr.Fragment),this.registerInput("baseColor",gr.Color3,!0,vr.Fragment),this.registerInput("metallic",gr.Float,!1,vr.Fragment),this.registerInput("roughness",gr.Float,!1,vr.Fragment),this.registerInput("ambientOcc",gr.Float,!0,vr.Fragment),this.registerInput("opacity",gr.Float,!0,vr.Fragment),this.registerInput("indexOfRefraction",gr.Float,!0,vr.Fragment),this.registerInput("ambientColor",gr.Color3,!0,vr.Fragment),this.registerInput("reflection",gr.Object,!0,vr.Fragment,new Vn("reflection",this,0,ta,"ReflectionBlock")),this.registerInput("clearcoat",gr.Object,!0,vr.Fragment,new Vn("clearcoat",this,0,ia,"ClearCoatBlock")),this.registerInput("sheen",gr.Object,!0,vr.Fragment,new Vn("sheen",this,0,Jn,"SheenBlock")),this.registerInput("subsurface",gr.Object,!0,vr.Fragment,new Vn("subsurface",this,0,na,"SubSurfaceBlock")),this.registerInput("anisotropy",gr.Object,!0,vr.Fragment,new Vn("anisotropy",this,0,ea,"AnisotropyBlock")),this.registerInput("iridescence",gr.Object,!0,vr.Fragment,new Vn("iridescence",this,0,sa,"IridescenceBlock")),this.registerOutput("ambientClr",gr.Color3,vr.Fragment),this.registerOutput("diffuseDir",gr.Color3,vr.Fragment),this.registerOutput("specularDir",gr.Color3,vr.Fragment),this.registerOutput("clearcoatDir",gr.Color3,vr.Fragment),this.registerOutput("sheenDir",gr.Color3,vr.Fragment),this.registerOutput("diffuseInd",gr.Color3,vr.Fragment),this.registerOutput("specularInd",gr.Color3,vr.Fragment),this.registerOutput("clearcoatInd",gr.Color3,vr.Fragment),this.registerOutput("sheenInd",gr.Color3,vr.Fragment),this.registerOutput("refraction",gr.Color3,vr.Fragment),this.registerOutput("lighting",gr.Color3,vr.Fragment),this.registerOutput("shadow",gr.Float,vr.Fragment),this.registerOutput("alpha",gr.Float,vr.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([r.e(9174).then(r.bind(r,9174)),r.e(2622).then(r.bind(r,2622))]):await Promise.all([r.e(1448).then(r.bind(r,1448)),r.e(3457).then(r.bind(r,3457))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e,t=(()=>!0)){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.CameraPosition&&t(e)));i||(i=new Vr("cameraPosition"),i.setAsSystemValue(Ar.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Ar.View&&t(e)));i||(i=new Vr("view"),i.setAsSystemValue(Ar.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("DEBUGMODE_FORCERETURN",!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===qe.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===qe.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const s=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",s.indexOf(".")<0?s+".":s,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const r=e.getScene();if(r.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&Pe.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),i._areLightsDirty)if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};(0,$.lo)(r,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else(0,$.az)(r,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,(0,$.VO)(r,i)}updateUniformsAndSamples(e,t,i,s){for(let r=0;r<t.maxSimultaneousLights&&i["LIGHT"+r];r++){const t=e.uniforms.indexOf("vLightData"+r)>=0;(0,$.GD)(r,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+r],s,t)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){if(!i)return;const s=i.getScene();this.light?(0,$.Kd)(this.light,this._lightId,s,e,!0):(0,$.RL)(s,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const r=this._scene.ambientColor;r&&e.setColor3("ambientFromScene",r);const n=s.useRightHandedSystem===(null!=s._mirroredCameraPosition);e.setFloat(this._invertNormalName,n?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const a=this.indexOfRefraction.connectInputBlock?.value??1.5,o=Math.pow((a-1)/(a+1),2);this._metallicReflectanceColor.scaleToRef(o*this._metallicF0Factor,M.IG.Color3[0]);const l=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,M.IG.Color3[0],l),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){const t=this.worldPosition,i=this.worldNormal,s=`//${this.name}`,r=1===e.shaderLanguage;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",s,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",s,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const n="v_"+t.associatedVariableName;e._emitVaryingFromString(n,gr.Vector4)&&(e.compilationString+=(r?"vertexOutputs.":"")+`${n} = ${t.associatedVariableName};\n`);const a="v_"+i.associatedVariableName;e._emitVaryingFromString(a,gr.Vector4)&&(e.compilationString+=(r?"vertexOutputs.":"")+`${a} = ${i.associatedVariableName};\n`);const o=this.reflection.isConnected?this.reflection.connectedPoint?.ownerBlock:null;o&&(o.viewConnectionPoint=this.view),e.compilationString+=o?.handleVertexSide(e)??"",e._emitVaryingFromString("vClipSpacePosition",gr.Vector4,"defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+="#if DEBUGMODE > 0\n",e._injectAtEnd+=(r?"vertexOutputs.":"")+`vClipSpacePosition = ${r?"vertexOutputs.position":"gl_Position"};\n`,e._injectAtEnd+="#endif\n"),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",s,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",gr.Vector4)} = ${t.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",gr.Matrix)} = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",s,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(e){let t=1===e.shaderLanguage?"var albedoOpacityOut: albedoOpacityOutParams;\n":"albedoOpacityOutParams albedoOpacityOut;\n";const i=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",s=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return t+=`albedoOpacityOut = albedoOpacityBlock(\n                vec4${e.fSuffix}(${i}, 1.)\n            #ifdef ALBEDO\n                ,vec4${e.fSuffix}(1.)\n                ,vec2${e.fSuffix}(1., 1.)\n            #endif\n            #ifdef OPACITY\n                ,vec4${e.fSuffix}(${s})\n                ,vec2${e.fSuffix}(1., 1.)\n            #endif                \n            );\n\n            ${e._declareLocalVar("surfaceAlbedo",gr.Vector3)} = albedoOpacityOut.surfaceAlbedo;\n            ${e._declareLocalVar("alpha",gr.Float)} = albedoOpacityOut.alpha;\n`,t}_getAmbientOcclusionCode(e){let t=1===e.shaderLanguage?"var aoOut: ambientOcclusionOutParams;\n":"ambientOcclusionOutParams aoOut;\n";const i=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return t+=`aoOut = ambientOcclusionBlock(\n            #ifdef AMBIENT\n                vec3${e.fSuffix}(${i}),\n                vec4${e.fSuffix}(0., 1.0, 1.0, 0.)\n            #endif\n            );\n`,t}_getReflectivityCode(e){const t=1===e.shaderLanguage;let i=t?"var reflectivityOut: reflectivityOutParams;\n":"reflectivityOutParams reflectivityOut;\n";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,gr.Vector4),i+=`${e._declareLocalVar("baseColor",gr.Vector3)} = surfaceAlbedo;\n\n            reflectivityOut = reflectivityBlock(\n                vec4${e.fSuffix}(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.)\n            #ifdef METALLICWORKFLOW\n                , surfaceAlbedo\n                , ${(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}\n            #endif\n            #ifdef REFLECTIVITY\n                , vec3${e.fSuffix}(0., 0., 1.)\n                , vec4${e.fSuffix}(1.)\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)\n                , aoOut.ambientOcclusionColor\n            #endif\n            #ifdef MICROSURFACEMAP\n                , microSurfaceTexel <== not handled!\n            #endif\n            );\n\n            ${e._declareLocalVar("microSurface",gr.Float)} = reflectivityOut.microSurface;\n            ${e._declareLocalVar("roughness",gr.Float)} = reflectivityOut.roughness;\n\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo = reflectivityOut.surfaceAlbedo;\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;\n            #endif\n`,i}_buildBlock(e){super._buildBlock(e),this._scene=e.sharedData.scene;const t=1===e.shaderLanguage;this._environmentBRDFTexture||(this._environmentBRDFTexture=Fe(this._scene));const i=this.reflection.isConnected?this.reflection.connectedPoint?.ownerBlock:null;if(i&&(i.worldPositionConnectionPoint=this.worldPosition,i.cameraPositionConnectionPoint=this.cameraPosition,i.worldNormalConnectionPoint=this.worldNormal,i.viewConnectionPoint=this.view),e.target!==vr.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const s=`//${this.name}`,r=this.perturbedNormal;let n=this.worldPosition.associatedVariableName,a=this.worldNormal.associatedVariableName;this.generateOnlyFragmentCode?(n=e._getFreeVariableName("globalWorldPos"),e.compilationString+=`${n} = ${this.worldPosition.associatedVariableName}.xyz;\n`,a=e._getFreeVariableName("globalWorldNormal"),e.compilationString+=`${a} = ${this.worldNormal.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",s,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+="#if DEBUGMODE > 0\n",e.compilationString+=`${e._declareLocalVar("vClipSpacePosition",gr.Vector4)} = vec4${e.fSuffix}((vec2${e.fSuffix}(${t?"fragmentInputs.position":"gl_FragCoord.xy"}) / vec2${e.fSuffix}(1.0)) * 2.0 - 1.0, 0.0, 1.0);\n`,e.compilationString+="#endif\n"):(n=(t?"input.":"")+"v_"+n,a=(t?"input.":"")+"v_"+a),this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode",gr.Vector2,"defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene",gr.Vector3),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",s,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",s,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",s),e._emitFunctionFromInclude("importanceSampling",s),e._emitFunctionFromInclude("pbrHelperFunctions",s),e._emitFunctionFromInclude("imageProcessingDeclaration",s),e._emitFunctionFromInclude("imageProcessingFunctions",s),e._emitFunctionFromInclude("shadowsFragmentFunctions",s),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",s),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",s),e._emitFunctionFromInclude("pbrBRDFFunctions",s,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",s),e._emitFunctionFromInclude("pbrDirectLightingFunctions",s),e._emitFunctionFromInclude("pbrIBLFunctions",s),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",s),e._emitFunctionFromInclude("pbrBlockReflectivity",s),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",s),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",s),e._emitFunctionFromInclude("pbrBlockAnisotropic",s),e._emitUniformFromString("vLightingIntensity",gr.Vector4),i?.generateOnlyFragmentCode&&(e.compilationString+=i.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`${e._declareLocalVar(this._vNormalWName,gr.Vector4)} = normalize(${a});\n`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",gr.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${n}.xyz);\n`),e.compilationString+=`${e._declareLocalVar("geometricNormalW",gr.Vector3)} = ${this._vNormalWName}.xyz;\n`,e.compilationString+=`${e._declareLocalVar("normalW",gr.Vector3)} = ${r.isConnected?"normalize("+r.associatedVariableName+".xyz)":"geometricNormalW"};\n`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,gr.Float),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",s,{replaceStrings:[{search:/vPositionW/g,replace:n+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(e),e.compilationString+=e._emitCodeFromInclude("depthPrePass",s),e.compilationString+=this._getAmbientOcclusionCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",s),e.compilationString+=`#ifdef UNLIT\n                ${e._declareLocalVar("diffuseBase",gr.Vector3)} = vec3${e.fSuffix}(1., 1., 1.);\n            #else\n`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",s,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"}]});const o=this.anisotropy.isConnected?this.anisotropy.connectedPoint?.ownerBlock:null;o&&(o.worldPositionConnectionPoint=this.worldPosition,o.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=o.getCode(e,!this.perturbedNormal.isConnected)),i&&i.hasTexture&&(e.compilationString+=i.getCode(e,o?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",s,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:i?._vReflectionFilteringInfoName??"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",s,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}]});const h=this.sheen.isConnected?this.sheen.connectedPoint?.ownerBlock:null;h&&(e.compilationString+=h.getCode(i,e)),e._emitFunctionFromInclude("pbrBlockSheen",s,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"}]});const c=this.iridescence.isConnected?this.iridescence.connectedPoint?.ownerBlock:null;e.compilationString+=sa.GetCode(c,e),e._emitFunctionFromInclude("pbrBlockIridescence",s,{replaceStrings:[]});const u=this.clearcoat.isConnected?this.clearcoat.connectedPoint?.ownerBlock:null,d=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,_=this.perturbedNormal.isConnected&&(this.perturbedNormal.connectedPoint?.ownerBlock).worldTangent?.isConnected,p=this.anisotropy.isConnected&&(this.anisotropy.connectedPoint?.ownerBlock).worldTangent.isConnected;let f=_||!this.perturbedNormal.isConnected&&p;e.compilationString+=ia.GetCode(e,u,i,n,d,f,a),d&&(f=u?.worldTangent.isConnected??!1),e._emitFunctionFromInclude("pbrBlockClearcoat",s,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:f?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",s,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"}]});const m=this.subsurface.isConnected?this.subsurface.connectedPoint?.ownerBlock:null,g=this.subsurface.isConnected?(this.subsurface.connectedPoint?.ownerBlock).refraction.connectedPoint?.ownerBlock:null;g&&(g.viewConnectionPoint=this.view,g.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=na.GetCode(e,m,i,n),e._emitFunctionFromInclude("pbrBlockSubSurface",s,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:g?._define3DName??"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:g?._defineLODRefractionAlpha??"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:g?._defineLinearSpecularRefraction??"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:g?._defineOppositeZ??"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",s),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",s,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:new RegExp((t?"fragmentInputs.":"")+"vPositionW","g"),replace:n+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",s,{repeatKey:"maxSimultaneousLights",substitutionVars:`${t?"fragmentInputs.":""}vPositionW,${n}.xyz`}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",s),e.compilationString+="#endif\n";const v=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:`vec3${e.fSuffix}(0., 0., 0.)`;let b=qe.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();-1===b.indexOf(".")&&(b+=".");let x=[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:new RegExp((t?"uniforms.":"")+"vAmbientColor","g"),replace:v+` * ${t?"uniforms.":""}ambientFromScene`},{search:new RegExp((t?"uniforms.":"")+"vAmbientInfos.w","g"),replace:b}];t&&(x[0]={search:/var finalEmissive[\s\S]*?finalEmissive\*=uniforms.vLightingIntensity\.y;/g,replace:""}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",s,{replaceStrings:x}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",s,{replaceStrings:[{search:/finalEmissive/g,replace:`vec3${e.fSuffix}(0.)`}]}),x=t?[{search:/mesh.visibility/g,replace:"1."}]:[{search:/visibility/g,replace:"1."}],e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",s,{replaceStrings:x});const S=t?"fragmentOutputs.color":"gl_FragColor";x=[{search:new RegExp((t?"fragmentInputs.":"")+"vNormalW","g"),replace:this._vNormalWName},{search:new RegExp((t?"fragmentInputs.":"")+"vPositionW","g"),replace:n},{search:/albedoTexture\.rgb;/g,replace:`vec3${e.fSuffix}(1.);\n${S}.rgb = toGammaSpace(${S}.rgb);\n`}],e.compilationString+=e._emitCodeFromInclude("pbrDebug",s,{replaceStrings:x});for(const t of this._outputs)if(t.hasEndpoints){const i=aa[t.name];if(i){const[s,r]=i;r&&(e.compilationString+=`#if ${r}\n`),e.compilationString+=`${e._declareOutput(t)} = ${s};\n`,r&&(e.compilationString+="#else\n",e.compilationString+=`${e._declareOutput(t)} = vec3${e.fSuffix}(0.);\n`,e.compilationString+="#endif\n")}else l.V.Error(`There's no remapping for the ${t.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};\n`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};\n`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};\n`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};\n`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\n`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\n`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\n`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};\n`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\n`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};\n`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};\n`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};\n`,e+=`${this._codeVariableName}.unlit = ${this.unlit};\n`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};\n`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};\n`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};\n`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};\n`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=e.lightFalloff??0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=e.realTimeFilteringQuality??8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}var la,ha,ca;(0,w.Cg)([wr("Direct lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],oa.prototype,"directIntensity",void 0),(0,w.Cg)([wr("Environment lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],oa.prototype,"environmentIntensity",void 0),(0,w.Cg)([wr("Specular highlights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],oa.prototype,"specularIntensity",void 0),(0,w.Cg)([wr("Light falloff",4,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:qe.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:qe.LIGHTFALLOFF_GLTF},{label:"Standard",value:qe.LIGHTFALLOFF_STANDARD}]})],oa.prototype,"lightFalloff",void 0),(0,w.Cg)([wr("Alpha Testing",0,"OPACITY")],oa.prototype,"useAlphaTest",void 0),(0,w.Cg)([wr("Alpha CutOff",1,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],oa.prototype,"alphaTestCutoff",void 0),(0,w.Cg)([wr("Alpha blending",0,"OPACITY")],oa.prototype,"useAlphaBlending",void 0),(0,w.Cg)([wr("Radiance over alpha",0,"RENDERING",{notifiers:{update:!0}})],oa.prototype,"useRadianceOverAlpha",void 0),(0,w.Cg)([wr("Specular over alpha",0,"RENDERING",{notifiers:{update:!0}})],oa.prototype,"useSpecularOverAlpha",void 0),(0,w.Cg)([wr("Specular anti-aliasing",0,"RENDERING",{notifiers:{update:!0}})],oa.prototype,"enableSpecularAntiAliasing",void 0),(0,w.Cg)([wr("Realtime filtering",0,"RENDERING",{notifiers:{update:!0}})],oa.prototype,"realTimeFiltering",void 0),(0,w.Cg)([wr("Realtime filtering quality",4,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],oa.prototype,"realTimeFilteringQuality",void 0),(0,w.Cg)([wr("Energy Conservation",0,"ADVANCED",{notifiers:{update:!0}})],oa.prototype,"useEnergyConservation",void 0),(0,w.Cg)([wr("Radiance occlusion",0,"ADVANCED",{notifiers:{update:!0}})],oa.prototype,"useRadianceOcclusion",void 0),(0,w.Cg)([wr("Horizon occlusion",0,"ADVANCED",{notifiers:{update:!0}})],oa.prototype,"useHorizonOcclusion",void 0),(0,w.Cg)([wr("Unlit",0,"ADVANCED",{notifiers:{update:!0}})],oa.prototype,"unlit",void 0),(0,w.Cg)([wr("Force normal forward",0,"ADVANCED",{notifiers:{update:!0}})],oa.prototype,"forceNormalForward",void 0),(0,w.Cg)([wr("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:oa._OnGenerateOnlyFragmentCodeChanged}})],oa.prototype,"generateOnlyFragmentCode",void 0),(0,w.Cg)([wr("Debug mode",4,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87},{label:"Albedo color",value:88},{label:"Ambient occlusion color",value:89}]})],oa.prototype,"debugMode",void 0),(0,w.Cg)([wr("Split position",1,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],oa.prototype,"debugLimit",void 0),(0,w.Cg)([wr("Output factor",1,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],oa.prototype,"debugFactor",void 0),(0,V.Y5)("BABYLON.PBRMetallicRoughnessBlock",oa),(0,V.Y5)("BABYLON.ModBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("left",gr.AutoDetect),this.registerInput("right",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[1].acceptedConnectionPointTypes.push(gr.Float)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return 0===e.shaderLanguage?e.compilationString+=e._declareOutput(t)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`:e.compilationString+=e._declareOutput(t)+` = (${this.left.associatedVariableName} % ${this.right.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.MatrixBuilder",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("row0",gr.Vector4),this.registerInput("row1",gr.Vector4),this.registerInput("row2",gr.Vector4),this.registerInput("row3",gr.Vector4),this.registerOutput("output",gr.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new Vr("row0");e.value=new I.IU(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new Vr("row1");e.value=new I.IU(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new Vr("row2");e.value=new I.IU(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new Vr("row3");e.value=new I.IU(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.row0,s=this.row1,r=this.row2,n=this.row3,a=1===e.shaderLanguage?"mat4x4f":"mat4";return e.compilationString+=e._declareOutput(t)+` = ${a}(${i.associatedVariableName}, ${s.associatedVariableName}, ${r.associatedVariableName}, ${n.associatedVariableName});\n`,this}}),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=1]="NotEqual",e[e.LessThan=2]="LessThan",e[e.GreaterThan=3]="GreaterThan",e[e.LessOrEqual=4]="LessOrEqual",e[e.GreaterOrEqual=5]="GreaterOrEqual",e[e.Xor=6]="Xor",e[e.Or=7]="Or",e[e.And=8]="And"}(la||(la={})),(0,V.Y5)("BABYLON.ConditionalBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.condition=la.LessThan,this.registerInput("a",gr.Float),this.registerInput("b",gr.Float),this.registerInput("true",gr.AutoDetect,!0),this.registerInput("false",gr.AutoDetect,!0),this.registerOutput("output",gr.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=gr.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",s=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case la.Equal:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,s,`${this.a.associatedVariableName} == ${this.b.associatedVariableName}`)};\n`;break;case la.NotEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,s,`${this.a.associatedVariableName} != ${this.b.associatedVariableName}`)};\n`;break;case la.LessThan:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,s,`${this.a.associatedVariableName} < ${this.b.associatedVariableName}`)};\n`;break;case la.LessOrEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,s,`${this.a.associatedVariableName} <= ${this.b.associatedVariableName}`)};\n`;break;case la.GreaterThan:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,s,`${this.a.associatedVariableName} > ${this.b.associatedVariableName}`)};\n`;break;case la.GreaterOrEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,s,`${this.a.associatedVariableName} >= ${this.b.associatedVariableName}`)};\n`;break;case la.Xor:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,s,`(((${this.a.associatedVariableName} + ${this.b.associatedVariableName}) % 2.0) > 0.0)`)};\n`;break;case la.Or:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,s,`(min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0)`)};\n`;break;case la.And:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,s,`(${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)`)};\n`}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${la[this.condition]};\n`}});class ua extends Ir{constructor(e){super(e,vr.Neutral),this.octaves=6,this.registerInput("seed",gr.AutoDetect),this.registerInput("chaos",gr.AutoDetect,!0),this.registerInput("offsetX",gr.Float,!0),this.registerInput("offsetY",gr.Float,!0),this.registerInput("offsetZ",gr.Float,!0),this.registerOutput("output",gr.Float),this._inputs[0].acceptedConnectionPointTypes.push(gr.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(gr.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;let t="\n\n        float cloudRandom(float p) { \n            float temp = fract(p * 0.011); \n            temp *= temp + 7.5; \n            temp *= temp + temp; \n            return fract(temp); \n        }\n\n        // Based on Morgan McGuire @morgan3d\n        // https://www.shadertoy.com/view/4dS3Wd\n        float cloudNoise2(vec2 x, vec2 chaos) {\n            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);\n\n            vec2 i = floor(x);\n            vec2 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec2 u = f * f * (3.0 - 2.0 * f);\n            return mix(\n                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),\n                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),\n                    u.y\n                );\n        }\n\n        float cloudNoise3(vec3 x, vec3 chaos) {\n            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);\n\n            vec3 i = floor(x);\n            vec3 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec3 u = f * f * (3.0 - 2.0 * f);\n            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),\n                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);\n        }",i="\n        float fbm2(vec2 st, vec2 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = .5;\n            float frequency = 0.;\n\n            // Loop of octaves\n            vec2 tempST = st;\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise2(tempST, chaos);\n                tempST *= 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }\n\n        float fbm3(vec3 x, vec3 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = 0.5;\n            vec3 tempX = x;\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise3(tempX, chaos);\n                tempX = tempX * 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }";1===e.shaderLanguage&&(t=e._babylonSLtoWGSL(t),i=e._babylonSLtoWGSL(i));const s=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode",t,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,i.replace(/fbm/gi,s).replace(/OCTAVES/gi,(0|this.octaves).toString()),"// CloudBlockCode FBM");const r=e._getFreeVariableName("st"),n=this.seed.connectedPoint?.type||gr.Vector3;e.compilationString+=`${e._declareLocalVar(r,n)} = ${this.seed.associatedVariableName};\n`,this.offsetX.isConnected&&(e.compilationString+=`${r}.x += 0.1 * ${this.offsetX.associatedVariableName};\n`),this.offsetY.isConnected&&(e.compilationString+=`${r}.y += 0.1 * ${this.offsetY.associatedVariableName};\n`),this.offsetZ.isConnected&&n===gr.Vector3&&(e.compilationString+=`${r}.z += 0.1 * ${this.offsetZ.associatedVariableName};\n`);let a="";if(this.chaos.isConnected)a=this.chaos.associatedVariableName;else{const t=e.fSuffix;a=this.seed.connectedPoint?.type===gr.Vector2?`vec2${t}(0., 0.)`:`vec3${t}(0., 0., 0.)`}return e.compilationString+=e._declareOutput(this._outputs[0])+` = ${s}${this.seed.connectedPoint?.type===gr.Vector2?"2":"3"}(${r}, ${a});\n`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};\n`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}(0,w.Cg)([wr("Octaves",2)],ua.prototype,"octaves",void 0),(0,V.Y5)("BABYLON.CloudBlock",ua),(0,V.Y5)("BABYLON.VoronoiNoiseBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("seed",gr.Vector2),this.registerInput("offset",gr.Float),this.registerInput("density",gr.Float),this.registerOutput("output",gr.Float),this.registerOutput("cells",gr.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t="vec2 voronoiRandom(vec2 p){\n            p = vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3)));\n            return fract(sin(p)*18.5453);\n        }\n        ";1===e.shaderLanguage&&(t=e._babylonSLtoWGSL(t)),e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t="void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){\n            vec2 n = floor(seed * density);\n            vec2 f = fract(seed * density);\n            vec3 m = vec3( 8.0 );\n            for( int j=-1; j<=1; j++ ){\n                for( int i=-1; i<=1; i++ ){\n                    vec2  g = vec2( float(i), float(j) );\n                    vec2  o = voronoiRandom( n + g);\n                    vec2  r = g - f + (0.5+0.5*sin(offset+6.2831*o));\n                    float d = dot( r, r );\n                    if( d<m.x ){\n                        m = vec3( d, o );\n                        outValue = m.x;\n                        cells = m.y;\n                    }\n                }\n\t\t\t}\n        }\n        ",t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),s=e._getFreeVariableName("tempCells"),r=1===e.shaderLanguage?"&":"";return e.compilationString+=`${e._declareLocalVar(i,gr.Float)} = 0.0;\n`,e.compilationString+=`${e._declareLocalVar(s,gr.Float)} = 0.0;\n`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${r}${i}, ${r}${s});\n`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};\n`),this.cells.hasEndpoints&&(e.compilationString+=e._declareOutput(this.cells)+` = ${s};\n`),this}}),(0,V.Y5)("BABYLON.ElbowBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("input",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==vr.VertexAndFragment)return t.target;if(e.connectedPoint.target!==vr.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = ${i.associatedVariableName};\n`,this}});class da extends Ir{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;const i=e?.getScene()??t.q.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}get textureY(){return this.sourceY.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}get textureZ(){return this.sourceZ?.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}_getImageSourceBlock(e){return e?.isConnected?e.connectedPoint.ownerBlock:null}get samplerName(){const e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){return this._getImageSourceBlock(this.sourceY)?.samplerName??null}get samplerZName(){return this._getImageSourceBlock(this.sourceZ)?.samplerName??null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=this.texture.getScene()??t.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=this.texture.getScene()??t.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,vr.Neutral),this.projectAsCube=!1,this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",gr.AutoDetect,!1),this.registerInput("normal",gr.AutoDetect,!1),this.registerInput("sharpness",gr.Float,!0),this.registerInput("source",gr.Object,!0,vr.VertexAndFragment,new Vn("source",this,0,Wn,"ImageSourceBlock")),this.registerInput("sourceY",gr.Object,!0,vr.VertexAndFragment,new Vn("sourceY",this,0,Wn,"ImageSourceBlock")),t||this.registerInput("sourceZ",gr.Object,!0,vr.VertexAndFragment,new Vn("sourceZ",this,0,Wn,"ImageSourceBlock")),this.registerOutput("rgba",gr.Color4,vr.Neutral),this.registerOutput("rgb",gr.Color3,vr.Neutral),this.registerOutput("r",gr.Float,vr.Neutral),this.registerOutput("g",gr.Float,vr.Neutral),this.registerOutput("b",gr.Float,vr.Neutral),this.registerOutput("a",gr.Float,vr.Neutral),this.registerOutput("level",gr.Float,vr.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Vector3|gr.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(gr.Color3|gr.Vector3|gr.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const s=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,r=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,s,!0),i.setValue(this._gammaDefineName,r,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_samplerFunc(e){return 1===e.shaderLanguage?"textureSample":"texture2D"}_generateTextureSample(e,t,i){return 1===i.shaderLanguage?`${this._samplerFunc(i)}(${e},${e+"Sampler"}, ${t})`:`${this._samplerFunc(i)}(${e}, ${t})`}_generateTextureLookup(e){const t=this.samplerName,i=this.samplerYName??t,s=this.samplerZName??t,r=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",n=e._getFreeVariableName("x"),a=e._getFreeVariableName("y"),o=e._getFreeVariableName("z"),l=e._getFreeVariableName("w"),h=e._getFreeVariableName("n"),c=e._getFreeVariableName("uvx"),u=e._getFreeVariableName("uvy"),d=e._getFreeVariableName("uvz");e.compilationString+=`\n            ${e._declareLocalVar(h,gr.Vector3)} = ${this.normal.associatedVariableName}.xyz;\n\n            ${e._declareLocalVar(c,gr.Vector2)} = ${this.position.associatedVariableName}.yz;\n            ${e._declareLocalVar(u,gr.Vector2)} = ${this.position.associatedVariableName}.zx;\n            ${e._declareLocalVar(d,gr.Vector2)} = ${this.position.associatedVariableName}.xy;\n        `,this.projectAsCube&&(e.compilationString+=`\n                ${c}.xy = ${c}.yx;\n\n                if (${h}.x >= 0.0) {\n                    ${c}.x = -${c}.x;\n                }\n                if (${h}.y < 0.0) {\n                    ${u}.y = -${u}.y;\n                }\n                if (${h}.z < 0.0) {\n                    ${d}.x = -${d}.x;\n                }\n            `);const _=e.fSuffix;e.compilationString+=`\n            ${e._declareLocalVar(n,gr.Vector4)} = ${this._generateTextureSample(t,c,e)};\n            ${e._declareLocalVar(a,gr.Vector4)} = ${this._generateTextureSample(i,u,e)};\n            ${e._declareLocalVar(o,gr.Vector4)} = ${this._generateTextureSample(s,d,e)};\n           \n            // blend weights\n            ${e._declareLocalVar(l,gr.Vector3)} = pow(abs(${h}), vec3${_}(${r}));\n\n            // blend and return\n            ${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = (${n}*${l}.x + ${a}*${l}.y + ${o}*${l}.z) / (${l}.x + ${l}.y + ${l}.z);        \n        `}_generateConversionCode(e,t,i){let s="";1!==e.shaderLanguage||t.type!==gr.Vector3&&t.type!==gr.Color3||(s="Vec3"),"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace${s}(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace${s}(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i){let s="";this.disableLevelMultiplication||(s=` * ${1===e.shaderLanguage?"uniforms.":""}${this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${s};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=(1===e.shaderLanguage?"uniforms.":"")+this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,gr.Float),this._generateTextureLookup(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,e+=`${this._codeVariableName}.projectAsCube = ${this.projectAsCube};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,e.projectAsCube=this.projectAsCube,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,this.projectAsCube=!!e.projectAsCube,e.texture&&!an.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=G.g.Parse(e.texture,t,i))}}(0,w.Cg)([wr("Project as cube",0,"ADVANCED",{notifiers:{update:!0}})],da.prototype,"projectAsCube",void 0),(0,V.Y5)("BABYLON.TriPlanarBlock",da),(0,V.Y5)("BABYLON.BiPlanarBlock",class extends da{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_declareLocalVarAsVec3I(e,t){return 1===t.shaderLanguage?`var ${e}: vec3<i32>`:`ivec3 ${e}`}_getTextureGrad(e,t){return 1===e.shaderLanguage?`textureSampleGrad(${t},${t+"Sampler"}`:`textureGrad(${t}`}_generateTextureLookup(e){const t=this.samplerName,i=this.samplerYName??this.samplerName,s=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",r=e._getFreeVariableName("dxValue"),n=e._getFreeVariableName("dyValue"),a=e._getFreeVariableName("n"),o=e._getFreeVariableName("ma"),l=e._getFreeVariableName("mi"),h=e._getFreeVariableName("me"),c=e._getFreeVariableName("x"),u=e._getFreeVariableName("y"),d=e._getFreeVariableName("w");let _="ivec3",p="dFdx",f="dFdy";const m=e.fSuffix;1===e.shaderLanguage&&(_="vec3<i32>",p="dpdx",f="dpdy"),e.compilationString+=`\n            // grab coord derivatives for texturing\n            ${e._declareLocalVar(r,gr.Vector3)} = ${p}(${this.position.associatedVariableName}.xyz);\n            ${e._declareLocalVar(n,gr.Vector3)} = ${f}(${this.position.associatedVariableName}.xyz);\n            ${e._declareLocalVar(a,gr.Vector3)} = abs(${this.normal.associatedVariableName}.xyz);\n        \n            // determine major axis (in x; yz are following axis)\n            ${this._declareLocalVarAsVec3I(o,e)} = ${e._generateTernary(`${_}(0,1,2)`,`${e._generateTernary(`${_}(1,2,0)`,`${_}(2,0,1)`,`(${a}.y>${a}.z)`)}`,`(${a}.x>${a}.y && ${a}.x>${a}.z)`)};                    \n\n            // determine minor axis (in x; yz are following axis)\n            ${this._declareLocalVarAsVec3I(l,e)} =  ${e._generateTernary(`${_}(0,1,2)`,`${e._generateTernary(`${_}(1,2,0)`,`${_}(2,0,1)`,`(${a}.y<${a}.z)`)}`,`(${a}.x<${a}.y && ${a}.x<${a}.z)`)};  \n                              \n            // determine median axis (in x;  yz are following axis)\n            ${this._declareLocalVarAsVec3I(h,e)} = ${_}(3) - ${l} - ${o};\n            \n            // project+fetch\n            ${e._declareLocalVar(c,gr.Vector4)} = ${this._getTextureGrad(e,t)}, vec2${m}(${this.position.associatedVariableName}[${o}.y], ${this.position.associatedVariableName}[${o}.z]), \n                                    vec2${m}(${r}[${o}.y],${r}[${o}.z]), \n                                    vec2${m}(${n}[${o}.y],${n}[${o}.z]));\n            ${e._declareLocalVar(u,gr.Vector4)} = ${this._getTextureGrad(e,i)}, vec2${m}(${this.position.associatedVariableName}[${h}.y], ${this.position.associatedVariableName}[${h}.z]), \n                                    vec2${m}(${r}[${h}.y],${r}[${h}.z]),\n                                    vec2${m}(${n}[${h}.y],${n}[${h}.z]));\n            \n            // blend factors\n            ${e._declareLocalVar(d,gr.Vector2)} = vec2${m}(${a}[${o}.x],${a}[${h}.x]);\n            // make local support\n            ${d} = clamp( (${d}-0.5773)/(1.0-0.5773), vec2${m}(0.0), vec2${m}(1.0) );\n            // shape transition\n            ${d} = pow( ${d}, vec2${m}(${s}/8.0) );\n            // blend and return\n            ${e._declareLocalVar(this._tempTextureRead,gr.Vector4)} = (${c}*${d}.x + ${u}*${d}.y) / (${d}.x + ${d}.y);\n        `}}),(0,V.Y5)("BABYLON.MatrixDeterminantBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("input",gr.Matrix),this.registerOutput("output",gr.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = determinant(${i.associatedVariableName});\n`,this}}),(0,V.Y5)("BABYLON.MatrixTransposeBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("input",gr.Matrix),this.registerOutput("output",gr.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = transpose(${i.associatedVariableName});\n`,this}}),function(e){e[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Tangent=2]="Tangent",e[e.VertexColor=3]="VertexColor",e[e.UV1=4]="UV1",e[e.UV2=5]="UV2",e[e.UV3=6]="UV3",e[e.UV4=7]="UV4",e[e.UV5=8]="UV5",e[e.UV6=9]="UV6"}(ha||(ha={}));class _a extends Ir{constructor(e){super(e,vr.Neutral),this.attributeType=0,this.registerInput("input",gr.AutoDetect),this.registerInput("fallback",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].onConnectionObservable.add((e=>{if(this.attributeType)return;const t=e.ownerBlock;if(t instanceof Vr&&t.isAttribute)switch(t.name){case"color":this.attributeType=3;break;case"normal":this.attributeType=1;break;case"tangent":this.attributeType=2;break;case"uv":this.attributeType=4;break;case"uv2":this.attributeType=5;break;case"uv3":this.attributeType=6;break;case"uv4":this.attributeType=7;break;case"uv5":this.attributeType=8;break;case"uv6":this.attributeType=9}else if(t instanceof Nn)switch(this.input.connectedPoint?.name){case"normalOutput":this.attributeType=1;break;case"tangentOutput":this.attributeType=2;break;case"uvOutput":this.attributeType=4}}))}getClassName(){return"MeshAttributeExistsBlock"}get input(){return this._inputs[0]}get fallback(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.attributeType){case 3:t="VERTEXCOLOR_NME";break;case 1:t="NORMAL";break;case 2:t="TANGENT";break;case 4:t="UV1";break;case 5:t="UV2";break;case 6:t="UV3";break;case 7:t="UV4";break;case 8:t="UV5";break;case 9:t="UV6"}const i=e._declareOutput(this.output);return t&&(e.compilationString+=`#ifdef ${t}\n`),e.compilationString+=`${i} = ${this.input.associatedVariableName};\n`,t&&(e.compilationString+="#else\n",e.compilationString+=`${i} = ${this.fallback.associatedVariableName};\n`,e.compilationString+="#endif\n"),this}serialize(){const e=super.serialize();return e.attributeType=this.attributeType,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.attributeType=e.attributeType??0}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.attributeType = ${this.attributeType};\n`,e}}(0,w.Cg)([wr("Attribute lookup",4,void 0,{notifiers:{update:!0},options:[{label:"(None)",value:0},{label:"Normal",value:1},{label:"Tangent",value:2},{label:"Vertex Color",value:3},{label:"UV1",value:4},{label:"UV2",value:5},{label:"UV3",value:6},{label:"UV4",value:7},{label:"UV5",value:8},{label:"UV6",value:9}]})],_a.prototype,"attributeType",void 0),(0,V.Y5)("BABYLON.MeshAttributeExistsBlock",_a),function(e){e[e.EaseInSine=0]="EaseInSine",e[e.EaseOutSine=1]="EaseOutSine",e[e.EaseInOutSine=2]="EaseInOutSine",e[e.EaseInQuad=3]="EaseInQuad",e[e.EaseOutQuad=4]="EaseOutQuad",e[e.EaseInOutQuad=5]="EaseInOutQuad",e[e.EaseInCubic=6]="EaseInCubic",e[e.EaseOutCubic=7]="EaseOutCubic",e[e.EaseInOutCubic=8]="EaseInOutCubic",e[e.EaseInQuart=9]="EaseInQuart",e[e.EaseOutQuart=10]="EaseOutQuart",e[e.EaseInOutQuart=11]="EaseInOutQuart",e[e.EaseInQuint=12]="EaseInQuint",e[e.EaseOutQuint=13]="EaseOutQuint",e[e.EaseInOutQuint=14]="EaseInOutQuint",e[e.EaseInExpo=15]="EaseInExpo",e[e.EaseOutExpo=16]="EaseOutExpo",e[e.EaseInOutExpo=17]="EaseInOutExpo",e[e.EaseInCirc=18]="EaseInCirc",e[e.EaseOutCirc=19]="EaseOutCirc",e[e.EaseInOutCirc=20]="EaseInOutCirc",e[e.EaseInBack=21]="EaseInBack",e[e.EaseOutBack=22]="EaseOutBack",e[e.EaseInOutBack=23]="EaseInOutBack",e[e.EaseInElastic=24]="EaseInElastic",e[e.EaseOutElastic=25]="EaseOutElastic",e[e.EaseInOutElastic=26]="EaseInOutElastic"}(ca||(ca={})),(0,V.Y5)("BABYLON.CurveBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.type=ca.EaseInOutSine,this.registerInput("input",gr.AutoDetect),this.registerOutput("output",gr.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(gr.Matrix),this._inputs[0].excludedConnectionPointTypes.push(gr.Object),this._inputs[0].excludedConnectionPointTypes.push(gr.Int)}getClassName(){return"CurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_duplicateEntry(e,t){return`ret.${t} = ${e.replace(/VAL/g,"v."+t)}`}_duplicateEntryDirect(e){return`return ${e.replace(/VAL/g,"v")}`}_duplicateVector(e,t,i){if("float"===t||"f32"===t)return this._duplicateEntryDirect(e);const s=parseInt(t.replace("vec",""));let r=i?`\n            var ret: vec${s}f = vec${s}f(0.0);\n        `:`\n            vec${s} ret = vec${s}(0.0);\n        `;for(let t=1;t<=s;t++)r+=this._duplicateEntry(e,1===t?"x":2===t?"y":3===t?"z":"w")+";\n";return r+="return ret;\n",r}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="",s="";const r=e._getShaderType(this.input.type),n=1===e.shaderLanguage;switch(s=ca[this.type]+"_"+r.replace("<","").replace(">",""),this.type){case ca.EaseInSine:i="return 1.0 - cos((v * 3.1415) / 2.0)";break;case ca.EaseOutSine:i="return sin((v * 3.1415) / 2.0)";break;case ca.EaseInOutSine:i="return -(cos(v * 3.1415) - 1.0) / 2.0";break;case ca.EaseInQuad:i="return v * v";break;case ca.EaseOutQuad:i="return (1.0 - v) * (1.0 - v)";break;case ca.EaseInOutQuad:{const t=e._generateTernary("2.0 * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,r,n);break}case ca.EaseInCubic:i="return v * v * v";break;case ca.EaseOutCubic:{const e="1.0 - pow(1.0 - VAL, 3.0)";i=this._duplicateVector(e,r,n);break}case ca.EaseInOutCubic:{const t=e._generateTernary("4.0 * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 3.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,r,n);break}case ca.EaseInQuart:i="return v * v * v * v";break;case ca.EaseOutQuart:{const e="1.0 - pow(1.0 - VAL, 4.0)";i=this._duplicateVector(e,r,n);break}case ca.EaseInOutQuart:{const t=e._generateTernary("8.0 * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 4.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,r,n);break}case ca.EaseInQuint:i="return v * v * v * v * v";break;case ca.EaseOutQuint:{const e="1.0 - pow(1.0 - VAL, 5.0)";i=this._duplicateVector(e,r,n);break}case ca.EaseInOutQuint:{const t=e._generateTernary("16.0 * VAL * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 5.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,r,n);break}case ca.EaseInExpo:{const t=e._generateTernary("0.0","pow(2.0, 10.0 * VAL - 10.0)","VAL == 0.0");i=this._duplicateVector(t,r,n);break}case ca.EaseOutExpo:{const t=e._generateTernary("1.0","1.0 - pow(2.0, -10.0 * VAL)","VAL == 1.0");i=this._duplicateVector(t,r,n);break}case ca.EaseInOutExpo:{const t=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("pow(2.0, 20.0 * VAL - 10.0) / 2.0","(2.0 - pow(2.0, -20.0 * VAL + 10.0)) / 2.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,r,n);break}case ca.EaseInCirc:{const e="1.0 - sqrt(1.0 - pow(VAL, 2.0))";i=this._duplicateVector(e,r,n);break}case ca.EaseOutCirc:{const e="sqrt(1.0 - pow(VAL - 1.0, 2.0))";i=this._duplicateVector(e,r,n);break}case ca.EaseInOutCirc:{const t=e._generateTernary("(1.0 - sqrt(1.0 - pow(2.0 * VAL, 2.0))) / 2.0","(sqrt(1.0 - pow(-2.0 * VAL + 2.0, 2.0)) + 1.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,r,n);break}case ca.EaseInBack:i="return 2.70158 * v * v * v - 1.70158 * v * v";break;case ca.EaseOutBack:{const e="2.70158 * pow(VAL - 1.0, 3.0) + 1.70158 * pow(VAL - 1.0, 2.0)";i=this._duplicateVector(e,r,n);break}case ca.EaseInOutBack:{const t=e._generateTernary("(pow(2.0 * VAL, 2.0) * ((3.5949095) * 2.0 * VAL - 2.5949095)) / 2.0","(pow(2.0 * VAL - 2.0, 2.0) * (3.5949095 * (VAL * 2.0 - 2.0) + 3.5949095) + 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,r,n);break}case ca.EaseInElastic:{const t=e._generateTernary("0.0",e._generateTernary("1.0","-pow(2.0, 10.0 * VAL - 10.0) * sin((VAL * 10.0 - 10.75) * ((2.0 * 3.1415) / 3.0))","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,r,n);break}case ca.EaseOutElastic:{const t=e._generateTernary("0.0",e._generateTernary("1.0","pow(2.0, -10.0 * VAL) * sin((VAL * 10.0 - 0.75) * ((2.0 * 3.1415) / 3.0)) + 1.0","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,r,n);break}case ca.EaseInOutElastic:{const t=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("-(pow(2.0, 20.0 * VAL - 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0","(pow(2.0, -20.0 * VAL + 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 + 1.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,r,n);break}}return n?e._emitFunction(s,`fn ${s}(v: ${r}) -> ${r}  {${i};}\n`,""):e._emitFunction(s,`${r} ${s}(${r} v) {${i};}\n`,""),e.compilationString+=e._declareOutput(t)+` = ${s}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.CurveBlockTypes.${ca[this.type]};\n`}}),(0,V.Y5)("BABYLON.ColorConverterBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("rgb ",gr.Color3,!0),this.registerInput("hsl ",gr.Color3,!0),this.registerOutput("rgb",gr.Color3),this.registerOutput("hsl",gr.Color3)}getClassName(){return"ColorConverterBlock"}get rgbIn(){return this._inputs[0]}get hslIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get hslOut(){return this._outputs[1]}_inputRename(e){return"rgb "===e?"rgbIn":"hsl "===e?"hslIn":e}_buildBlock(e){super._buildBlock(e);const t=this.rgbIn,i=this.hslIn,s=this._outputs[0],r=this._outputs[1],n=e._getShaderType(gr.Vector3);let a="\n            vec3 rgb2hsl(vec3 color) {\n                float r = color.r;\n                float g = color.g;\n                float b = color.b;\n\n                float maxc = max(r, max(g, b));\n                float minc = min(r, min(g, b));\n                float h = 0.0;\n                float s = 0.0;\n                float l = (maxc + minc) / 2.0;\n\n                if (maxc != minc) {\n                    float d = maxc - minc;\n                    if (l > 0.5) {\n                        s = d / (2.0 - maxc - minc);\n                    } else {\n                        s = d / (maxc + minc);\n                    }\n\n                    if (maxc == r) {\n                        float add = 0.0;\n                        if (g < b) {\n                            add = 6.0;\n                        }\n                        h = (g - b) / d + add;\n                    } else if (maxc == g) {\n                        h = (b - r) / d + 2.0;\n                    } else if (maxc == b) {\n                        h = (r - g) / d + 4.0;\n                    }\n                    h /= 6.0;\n                }\n\n                return vec3(h, s, l);\n            }",o="\n            float hue2rgb(float p, float q, float tt) {\n                float t = tt;\n                if (t < 0.0) {\n                    t += 1.0;\n                }\n                if (t > 1.0) {\n                    t -= 1.0;\n                }\n                if (t < 1.0/6.0) {\n                    return p + (q - p) * 6.0 * t;\n                }\n                if (t < 1.0/2.0) {\n                    return q;\n                }\n                if (t < 2.0/3.0) {\n                    return p + (q - p) * (2.0/3.0 - t) * 6.0;\n                }\n                return p;\n            }",l="\n            vec3 hsl2rgb(vec3 hsl) {\n                float h = hsl.x;\n                float s = hsl.y;\n                float l = hsl.z;\n\n                float r;\n                float g;\n                float b;\n\n                if (s == 0.0) {\n                    // Achromatic (grey)\n                    r = l;\n                    g = l;\n                    b = l; \n                } else {\n                    float q;\n                \n                    if (l < 0.5) {\n                        q = l * (1.0 + s);\n                    } else {\n                        q = (l + s - l * s);\n                    }\n\n                    float p = 2.0 * l - q;\n\n                    r = hue2rgb(p, q, h + 1.0/3.0);\n                    g = hue2rgb(p, q, h);\n                    b = hue2rgb(p, q, h - 1.0/3.0);\n                }\n\n                return vec3(r, g, b);\n            }";return 1===e.shaderLanguage&&(a=e._babylonSLtoWGSL(a),o=e._babylonSLtoWGSL(o),l=e._babylonSLtoWGSL(l)),e._emitFunction("rgb2hsl",a,""),e._emitFunction("hue2rgb",o,""),e._emitFunction("hsl2rgb",l,""),t.isConnected?(s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName};\n`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = rgb2hsl(${t.associatedVariableName});\n`)):i.isConnected?(s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = hsl2rgb(${i.associatedVariableName});\n`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${i.associatedVariableName};\n`)):(s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` =  ${n}(0.);\n`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` =  ${n}(0.);\n`)),this}});class pa extends Ir{constructor(e){super(e,vr.Neutral),this.iterations=4,this.registerInput("input",gr.AutoDetect),this.registerInput("iterations",gr.Float,!0),this.registerOutput("output",gr.BasedOnInput),this.registerOutput("index",gr.Float,vr.Fragment),this.registerOutput("loopID",gr.Object,void 0,new Vn("loopID",this,1,pa,"LoopBlock")),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0]._forPostBuild=!0,this._outputs[2]._redirectedSource=this._inputs[0],this._outputs[1]._preventBubbleUp=!0,this._outputs[2]._preventBubbleUp=!0}getClassName(){return"LoopBlock"}get input(){return this._inputs[0]}get iterationsInput(){return this._inputs[1]}get output(){return this._outputs[0]}get index(){return this._outputs[1]}get loopID(){return this._outputs[2]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1],s=e._getFreeVariableName("index"),r=1===e.shaderLanguage?"var":"int",n=1===e.shaderLanguage?"f32":"float",a=1===e.shaderLanguage?"i32":"int";e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName};\n`;const o=this.iterationsInput.isConnected?`${a}(${this.iterationsInput.associatedVariableName})`:this.iterations;return e.compilationString+=`for (${r} ${s} = 0; ${s} < ${o}; ${s}++){\n`,e.compilationString+=`${e._declareOutput(i)} = ${n}(${s});\n`,this}_postBuildBlock(e){return super._postBuildBlock(e),e.compilationString+="}\n",this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.iterations = ${this.iterations};\n`}serialize(){const e=super.serialize();return e.iterations=this.iterations,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.iterations=e.iterations}}(0,w.Cg)([wr("Iterations",2)],pa.prototype,"iterations",void 0),(0,V.Y5)("BABYLON.LoopBlock",pa),(0,V.Y5)("BABYLON.StorageReadBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("loopID",gr.Object,!1,void 0,new Vn("loopID",this,0,pa,"LoopBlock")),this.registerOutput("value",gr.AutoDetect),this._outputs[0]._linkedConnectionSource=this._inputs[0]}getClassName(){return"StorageReadBlock"}get loopID(){return this._inputs[0]}get value(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.value;if(!this.loopID.isConnected)return this;const i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=e._declareOutput(t)+` = ${i.output.associatedVariableName};\n`,this}}),(0,V.Y5)("BABYLON.StorageWriteBlock",class extends Ir{constructor(e){super(e,vr.Neutral),this.registerInput("loopID",gr.Object,!1,void 0,new Vn("loopID",this,0,pa,"LoopBlock")),this.registerInput("value",gr.AutoDetect),this._linkConnectionTypes(0,1)}getClassName(){return"StorageWriteBlock"}get loopID(){return this._inputs[0]}get value(){return this._inputs[1]}isConnectedInFragmentShader(){return!!this.loopID.isConnected&&this.loopID.connectedPoint.ownerBlock.output.isConnectedInFragmentShader}_buildBlock(e){super._buildBlock(e);const t=this.value;if(!this.loopID.isConnected)return this;const i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=`${i.output.associatedVariableName} = ${t.associatedVariableName};\n`,this}}),r(1318);class fa{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===t||0===e)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,i=0,s=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new C.cP,this._onDataLayoutChanged=new C.cP,this._animationPropertiesOverride=null,this._scene=s||t.q.LastCreatedScene,this.influence=i,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=N.p.Clone((()=>new fa(this.name,this.influence,this._scene)),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),N.p.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new fa(e.name,e.influence);if(i.setPositions(e.positions),null!=e.id&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let t=0;t<e.animations.length;t++){const s=e.animations[t],r=(0,V.n9)("BABYLON.Animation");r&&i.animations.push(r.Parse(s))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const s=new fa(t,i,e.getScene());return s.setPositions(e.getVerticesData(O.R.PositionKind)),e.isVerticesDataPresent(O.R.NormalKind)&&s.setNormals(e.getVerticesData(O.R.NormalKind)),e.isVerticesDataPresent(O.R.TangentKind)&&s.setTangents(e.getVerticesData(O.R.TangentKind)),e.isVerticesDataPresent(O.R.UVKind)&&s.setUVs(e.getVerticesData(O.R.UVKind)),s}}(0,w.Cg)([(0,D.lK)()],fa.prototype,"id",void 0);class ma extends G.g{get depth(){return this._depth}constructor(e,t,i,s,r,n,a=!0,o=!1,l=G.g.TRILINEAR_SAMPLINGMODE,h=0,c){super(null,n,!a,o),this.format=r,this._texture=n.getEngine().createRawTexture2DArray(e,t,i,s,r,a,o,l,null,h,c),this._depth=s,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,s,r,n=!0,a=!1,o=3,l=0){return new ma(e,t,i,s,5,r,n,a,o,l)}}class ga{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new J.L(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,e||(e=t.q.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const e=this._scene.getEngine().getCaps();this._canUseTextureForTargets=e.canUseGLVertexID&&e.textureFloat&&e.maxVertexTextureImageUnits>0&&e.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return this._numMaxInfluencers}set numMaxInfluencers(e){this._numMaxInfluencers!==e&&(this._numMaxInfluencers=e,this._syncActiveTargets(!0))}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){return ga.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!this._scene?.getEngine().getCaps().disableMorphTargetTexture}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}getTargetByName(e){for(const t of this._targets)if(t.name===e)return t;return null}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add((e=>{this._syncActiveTargets(e)}))),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add((()=>{this._syncActiveTargets(!0)}))),this._syncActiveTargets(!0)}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture),e.setInt("morphTargetCount",this.numInfluencers)}clone(){const e=new ga(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),this._morphTargetTextureIndices&&this._morphTargetTextureIndices.length===this._targets.length||(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const e of this._targets){if(i++,0===e.influence&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=ga.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(e),this._morphTargetTextureIndices[t]=i,this._tempInfluences[t++]=e.influence,this._supportsNormals=this._supportsNormals&&e.hasNormals,this._supportsTangents=this._supportsTangents&&e.hasTangents,this._supportsUVs=this._supportsUVs&&e.hasUVs;const s=e.getPositions();if(s){const e=s.length/3;if(0===this._vertexCount)this._vertexCount=e;else if(this._vertexCount!==e)return void l.V.Error("Incompatible target. Targets must all have the same vertices count.")}}this._morphTargetTextureIndices.length!==t&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,t)),this._influences&&this._influences.length===t||(this._influences=new Float32Array(t));for(let e=0;e<t;e++)this._influences[e]=this._tempInfluences[e];e&&this.synchronize()}synchronize(){if(this._scene&&!this.areUpdatesFrozen){if(this.isUsingTextureForTargets&&(this._vertexCount||this.numMaxInfluencers>0)){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){const e=this._targetStoreTexture.getSize();e.width===this._textureWidth&&e.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();const e=this._targets.length,t=new Float32Array(e*this._textureWidth*this._textureHeight*4);let i=0;for(let s=0;s<e;s++){const e=this._targets[s],r=e.getPositions(),n=e.getNormals(),a=e.getUVs(),o=e.getTangents();if(!r)return void(0===s&&l.V.Error("Invalid morph target. Target must have positions."));i=s*this._textureWidth*this._textureHeight*4;for(let e=0;e<this._vertexCount;e++)t[i]=r[3*e],t[i+1]=r[3*e+1],t[i+2]=r[3*e+2],i+=4,this._supportsNormals&&n&&(t[i]=n[3*e],t[i+1]=n[3*e+1],t[i+2]=n[3*e+2],i+=4),this._supportsUVs&&a&&(t[i]=a[2*e],t[i+1]=a[2*e+1],i+=4),this._supportsTangents&&o&&(t[i]=o[3*e],t[i+1]=o[3*e+1],t[i+2]=o[3*e+2],i+=4)}this._targetStoreTexture=ma.CreateRGBATexture(t,this._textureWidth,this._textureHeight,e,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const i=new ga(t);i._uniqueId=e.id;for(const s of e.targets)i.addTarget(fa.Parse(s,t));return i}}ga.EnableTextureStorage=!0,ga.MaxActiveMorphTargetsInVertexAttributeMode=8;var va=r(471);class ba{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach((t=>e=e.concat(t.bones))),e}}class xa extends ba{}class Sa{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach((e=>{e.dispose()})),this.rootNodes.length=0,this.skeletons.slice(0).forEach((e=>{e.dispose()})),this.skeletons.length=0,this.animationGroups.slice(0).forEach((e=>{e.dispose()})),this.animationGroups.length=0}}class Ta extends ba{constructor(e){super(),this._wasAddedToScene=!1,(e=e||t.q.LastCreatedScene)&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add((()=>{this._wasAddedToScene||this.dispose()})),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();for(const e of this.particleSystems)e.rebuild();for(const e of this.textures)e._rebuild()})))}_topologicalSort(e){const t=new Map;for(const i of e)t.set(i.uniqueId,i);const i={dependsOn:new Map,dependedBy:new Map};for(const t of e){const e=t.uniqueId;i.dependsOn.set(e,new Set),i.dependedBy.set(e,new Set)}for(const s of e){const e=s.uniqueId,r=i.dependsOn.get(e);if(s instanceof Tn){const n=s.sourceMesh;t.has(n.uniqueId)&&(r.add(n.uniqueId),i.dependedBy.get(n.uniqueId).add(e))}const n=i.dependedBy.get(e);for(const r of s.getDescendants()){const s=r.uniqueId;t.has(s)&&(n.add(s),i.dependsOn.get(s).add(e))}}const s=[],r=[];for(const s of e){const e=s.uniqueId;0===i.dependsOn.get(e).size&&(r.push(s),t.delete(e))}const n=r;for(;n.length>0;){const e=n.shift();s.push(e);const r=i.dependedBy.get(e.uniqueId);for(const s of Array.from(r.values())){const r=i.dependsOn.get(s);r.delete(e.uniqueId),0===r.size&&t.get(s)&&(n.push(t.get(s)),t.delete(s))}}return t.size>0&&(l.V.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach((e=>l.V.Error(e.name)))),s}_addNodeAndDescendantsToList(e,t,i,s){if(i&&(!s||s(i))&&!t.has(i.uniqueId)){e.push(i),t.add(i.uniqueId);for(const r of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,r,s)}}_isNodeInContainer(e){return e instanceof bt&&-1!==this.meshes.indexOf(e)||e instanceof dt&&-1!==this.transformNodes.indexOf(e)||e instanceof z&&-1!==this.lights.indexOf(e)||e instanceof se&&-1!==this.cameras.indexOf(e)}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return l.V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return l.V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return l.V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return l.V.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||ee.S0.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const s={},r={},n=new Sa,a=[],o=[],l={doNotInstantiate:!0,...i},h=[],c=new Set;for(const e of this.transformNodes)null===e.parent&&this._addNodeAndDescendantsToList(h,c,e,l.predicate);for(const e of this.meshes)null===e.parent&&this._addNodeAndDescendantsToList(h,c,e,l.predicate);const u=this._topologicalSort(h),d=(i,a)=>{if(((t,i)=>{if(s[t.uniqueId]=i.uniqueId,r[i.uniqueId]=i,e&&(i.name=e(t.name)),i instanceof At){const e=i;if(e.morphTargetManager){const i=t.morphTargetManager;e.morphTargetManager=i.clone();for(let t=0;t<i.numTargets;t++){const n=i.getTarget(t),a=e.morphTargetManager.getTarget(t);s[n.uniqueId]=a.uniqueId,r[a.uniqueId]=a}}}})(i,a),i.parent){const e=s[i.parent.uniqueId],t=r[e];a.parent=t||i.parent}if(a.position&&i.position&&a.position.copyFrom(i.position),a.rotationQuaternion&&i.rotationQuaternion&&a.rotationQuaternion.copyFrom(i.rotationQuaternion),a.rotation&&i.rotation&&a.rotation.copyFrom(i.rotation),a.scaling&&i.scaling&&a.scaling.copyFrom(i.scaling),a.material){const n=a;if(n.material)if(t){const t=i.material;if(-1===o.indexOf(t)){let i=t.clone(e?e(t.name):"Clone of "+t.name);if(o.push(t),s[t.uniqueId]=i.uniqueId,r[i.uniqueId]=i,"MultiMaterial"===t.getClassName()){const n=t;for(const t of n.subMaterials)t&&(i=t.clone(e?e(t.name):"Clone of "+t.name),o.push(t),s[t.uniqueId]=i.uniqueId,r[i.uniqueId]=i);n.subMaterials=n.subMaterials.map((e=>e&&r[s[e.uniqueId]]))}}"InstancedMesh"!==n.getClassName()&&(n.material=r[s[t.uniqueId]])}else"MultiMaterial"===n.material.getClassName()?-1===this.scene.multiMaterials.indexOf(n.material)&&this.scene.addMultiMaterial(n.material):-1===this.scene.materials.indexOf(n.material)&&this.scene.addMaterial(n.material)}null===a.parent&&n.rootNodes.push(a)};return u.forEach((e=>{if("InstancedMesh"===e.getClassName()){const t=e,i=t.sourceMesh,n=s[i.uniqueId],a=("number"==typeof n?r[n]:i).createInstance(t.name);d(t,a)}else{let t=!0;"TransformNode"===e.getClassName()||"Node"===e.getClassName()||e.skeleton||!e.getTotalVertices||0===e.getTotalVertices()?t=!1:l.doNotInstantiate&&(t="function"==typeof l.doNotInstantiate?!l.doNotInstantiate(e):!l.doNotInstantiate);const i=t?e.createInstance(`instance of ${e.name}`):e.clone(`Clone of ${e.name}`,null,!0);if(!i)throw new Error(`Could not clone or instantiate node on Asset Container ${e.name}`);d(e,i)}})),this.skeletons.forEach((t=>{if(l.predicate&&!l.predicate(t))return;const i=t.clone(e?e(t.name):"Clone of "+t.name);for(const e of this.meshes)if(e.skeleton===t&&!e.isAnInstance){const t=r[s[e.uniqueId]];if(!t||t.isAnInstance)continue;if(t.skeleton=i,-1!==a.indexOf(i))continue;a.push(i);for(const e of i.bones)e._linkedTransformNode&&(e._linkedTransformNode=r[s[e._linkedTransformNode.uniqueId]])}n.skeletons.push(i)})),this.animationGroups.forEach((t=>{if(l.predicate&&!l.predicate(t))return;const i=t.clone(e?e(t.name):"Clone of "+t.name,(e=>r[s[e.uniqueId]]||e));n.animationGroups.push(i)})),n}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||ee.S0.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];this.cameras.forEach((i=>{e&&!e(i)||(this.scene.addCamera(i),t.push(i))})),this.lights.forEach((i=>{e&&!e(i)||(this.scene.addLight(i),t.push(i))})),this.meshes.forEach((i=>{e&&!e(i)||(this.scene.addMesh(i),t.push(i))})),this.skeletons.forEach((t=>{e&&!e(t)||this.scene.addSkeleton(t)})),this.animations.forEach((t=>{e&&!e(t)||this.scene.addAnimation(t)})),this.animationGroups.forEach((t=>{e&&!e(t)||this.scene.addAnimationGroup(t)})),this.multiMaterials.forEach((t=>{e&&!e(t)||this.scene.addMultiMaterial(t)})),this.materials.forEach((t=>{e&&!e(t)||this.scene.addMaterial(t)})),this.morphTargetManagers.forEach((t=>{e&&!e(t)||this.scene.addMorphTargetManager(t)})),this.geometries.forEach((t=>{e&&!e(t)||this.scene.addGeometry(t)})),this.transformNodes.forEach((i=>{e&&!e(i)||(this.scene.addTransformNode(i),t.push(i))})),this.actionManagers.forEach((t=>{e&&!e(t)||this.scene.addActionManager(t)})),this.textures.forEach((t=>{e&&!e(t)||this.scene.addTexture(t)})),this.reflectionProbes.forEach((t=>{e&&!e(t)||this.scene.addReflectionProbe(t)}));for(const e of t)e.parent&&-1===this.scene.getNodes().indexOf(e.parent)&&(e.setParent?e.setParent(null):e.parent=null)}removeAllFromScene(){this._isValidHierarchy()||ee.S0.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach((t=>{e&&!e(t)||this.scene.removeCamera(t)})),this.lights.forEach((t=>{e&&!e(t)||this.scene.removeLight(t)})),this.meshes.forEach((t=>{e&&!e(t)||this.scene.removeMesh(t,!0)})),this.skeletons.forEach((t=>{e&&!e(t)||this.scene.removeSkeleton(t)})),this.animations.forEach((t=>{e&&!e(t)||this.scene.removeAnimation(t)})),this.animationGroups.forEach((t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)})),this.multiMaterials.forEach((t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)})),this.materials.forEach((t=>{e&&!e(t)||this.scene.removeMaterial(t)})),this.morphTargetManagers.forEach((t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)})),this.geometries.forEach((t=>{e&&!e(t)||this.scene.removeGeometry(t)})),this.transformNodes.forEach((t=>{e&&!e(t)||this.scene.removeTransformNode(t)})),this.actionManagers.forEach((t=>{e&&!e(t)||this.scene.removeActionManager(t)})),this.textures.forEach((t=>{e&&!e(t)||this.scene.removeTexture(t)})),this.reflectionProbes.forEach((t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)}))}dispose(){this.cameras.slice(0).forEach((e=>{e.dispose()})),this.cameras.length=0,this.lights.slice(0).forEach((e=>{e.dispose()})),this.lights.length=0,this.meshes.slice(0).forEach((e=>{e.dispose()})),this.meshes.length=0,this.skeletons.slice(0).forEach((e=>{e.dispose()})),this.skeletons.length=0,this.animationGroups.slice(0).forEach((e=>{e.dispose()})),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach((e=>{e.dispose()})),this.multiMaterials.length=0,this.materials.slice(0).forEach((e=>{e.dispose()})),this.materials.length=0,this.geometries.slice(0).forEach((e=>{e.dispose()})),this.geometries.length=0,this.transformNodes.slice(0).forEach((e=>{e.dispose()})),this.transformNodes.length=0,this.actionManagers.slice(0).forEach((e=>{e.dispose()})),this.actionManagers.length=0,this.textures.slice(0).forEach((e=>{e.dispose()})),this.textures.length=0,this.reflectionProbes.slice(0).forEach((e=>{e.dispose()})),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach((e=>{e.dispose()})),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(e&&t)for(const s of e){let e=!0;if(i)for(const t of i)if(s===t){e=!1;break}e&&(t.push(s),s._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,void 0===e&&(e=new xa);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||("_environmentTexture"===t?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new At("assetContainerRootMesh",this.scene);return this.meshes.forEach((t=>{t.parent||e.addChild(t)})),this.meshes.unshift(e),e}mergeAnimationsTo(e=t.q.LastCreatedScene,i,s=null){if(!e)return l.V.Error("No scene available to merge animations to"),[];const r=s||(t=>{let i=null;const s=t.animations.length?t.animations[0].targetProperty:"",r=t.name.split(".").join("").split("_primitive")[0];switch(s){case"position":case"rotationQuaternion":i=e.getTransformNodeByName(t.name)||e.getTransformNodeByName(r);break;case"influence":i=e.getMorphTargetByName(t.name)||e.getMorphTargetByName(r);break;default:i=e.getNodeByName(t.name)||e.getNodeByName(r)}return i});this.getNodes().forEach((e=>{const t=r(e);if(null!==t){for(const i of e.animations){const e=t.animations.filter((e=>e.targetProperty===i.targetProperty));for(const i of e){const e=t.animations.indexOf(i,0);e>-1&&t.animations.splice(e,1)}}t.animations=t.animations.concat(e.animations)}}));const n=[];return this.animationGroups.slice().forEach((e=>{n.push(e.clone(e.name,r)),e.animatables.forEach((e=>{e.stop()}))})),i.forEach((t=>{const i=r(t.target);i&&(e.beginAnimation(i,t.fromFrame,t.toFrame,t.loopAnimation,t.speedRatio,t.onAnimationEnd?t.onAnimationEnd:void 0,void 0,!0,void 0,t.onAnimationLoop?t.onAnimationLoop:void 0),e.stopAnimation(t.target))})),n}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.transformNodes.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.lights.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.cameras.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}))}addAllAssetsToContainer(e){if(!e)return;const t=[],i=new Set;for(t.push(e);t.length>0;){const e=t.pop();if(e instanceof At?(e.geometry&&-1===this.geometries.indexOf(e.geometry)&&this.geometries.push(e.geometry),this.meshes.push(e)):e instanceof dt?this.transformNodes.push(e):e instanceof z?this.lights.push(e):e instanceof se&&this.cameras.push(e),e instanceof bt){if(e.material&&-1===this.materials.indexOf(e.material)){this.materials.push(e.material);for(const t of e.material.getActiveTextures())-1===this.textures.indexOf(t)&&this.textures.push(t)}e.skeleton&&-1===this.skeletons.indexOf(e.skeleton)&&this.skeletons.push(e.skeleton),e.morphTargetManager&&-1===this.morphTargetManagers.indexOf(e.morphTargetManager)&&this.morphTargetManagers.push(e.morphTargetManager)}for(const s of e.getChildren())i.has(s)||t.push(s);i.add(e)}this.populateRootNodes()}}class ya extends G.g{constructor(e,t,i,s,r,n=!0,a=!1,o=3,l=0,h,c){super(null,r,!n,a,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,h),this.format=s,this._engine&&(this._engine._caps.textureFloatLinearFiltering||1!==l||(o=1),this._engine._caps.textureHalfFloatLinearFiltering||2!==l||(o=1),this._texture=this._engine.createRawTexture(e,t,i,s,n,a,o,null,l,h??0,c??!1),this.wrapU=G.g.CLAMP_ADDRESSMODE,this.wrapV=G.g.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}clone(){if(!this._texture)return super.clone();const e=new ya(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return e._texture=this._texture,this._texture.incrementReferences(),e}static CreateLuminanceTexture(e,t,i,s,r=!0,n=!1,a=3){return new ya(e,t,i,1,s,r,n,a)}static CreateLuminanceAlphaTexture(e,t,i,s,r=!0,n=!1,a=3){return new ya(e,t,i,2,s,r,n,a)}static CreateAlphaTexture(e,t,i,s,r=!0,n=!1,a=3){return new ya(e,t,i,0,s,r,n,a)}static CreateRGBTexture(e,t,i,s,r=!0,n=!1,a=3,o=0,l=0,h=!1){return new ya(e,t,i,4,s,r,n,a,o,l,h)}static CreateRGBATexture(e,t,i,s,r=!0,n=!1,a=3,o=0,l=0,h=!1){return new ya(e,t,i,5,s,r,n,a,o,l,h)}static CreateRGBAStorageTexture(e,t,i,s,r=!0,n=!1,a=3,o=0,l=!1){return new ya(e,t,i,5,s,r,n,a,o,1,l)}static CreateRTexture(e,t,i,s,r=!0,n=!1,a=G.g.TRILINEAR_SAMPLINGMODE,o=1){return new ya(e,t,i,6,s,r,n,a,o)}static CreateRStorageTexture(e,t,i,s,r=!0,n=!1,a=G.g.TRILINEAR_SAMPLINGMODE,o=1){return new ya(e,t,i,6,s,r,n,a,o,1)}}class Ca{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,i,s){this.name=e,this.id=i,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=I.uq.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new C.cP,this.bones=[],this._scene=s||t.q.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter((e=>!e.getParent()))}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return this._transformMatrices&&!this._isDirty||this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let e=!0;for(const i in this._ranges)e&&(t+=", ",e=!1),t+=i;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new Lt(e,t,i);for(let s=0,r=this.bones.length;s<r;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.bones.length;i<s;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let s=!0;const r=this._getHighestAnimationFrame()+1,n={},a=e.bones;let o,h;for(h=0,o=a.length;h<o;h++)n[a[h].name]=a[h];this.bones.length!==a.length&&(l.V.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),s=!1);const c=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(h=0,o=this.bones.length;h<o;h++){const e=this.bones[h].name,a=n[e];a?s=s&&this.bones[h].copyAnimationRange(a,t,r,i,c):(l.V.Warn("copyAnimationRange: not same rig, missing source bone "+e),s=!1)}const u=e.getAnimationRange(t);return u&&(this._ranges[t]=new Lt(t,u.from+r,u.to+r)),s}returnToRest(){for(const e of this.bones)-1!==e._index&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const i=this.bones[t].animations[0].getHighestFrame();e<i&&(e=i)}return e}beginAnimation(e,t,i,s){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,s):null}static MakeAnimationAdditive(e,t=0,i){const s=e.getAnimationRange(i);if(!s)return null;const r=e._scene.getAllAnimatablesByTarget(e);let n=null;for(let e=0;e<r.length;e++){const t=r[e];if(t.fromFrame===s?.from&&t.toFrame===s?.to){n=t;break}}const a=e.getAnimatables();for(let e=0;e<a.length;e++){const s=a[e].animations;if(s)for(let e=0;e<s.length;e++)Kt.MakeAnimationAdditive(s[e],t,i)}return n&&(n.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const s=this.bones[i];s._childUpdateId++;const r=s.getParent();if(r?s.getLocalMatrix().multiplyToRef(r.getFinalMatrix(),s.getFinalMatrix()):t?s.getLocalMatrix().multiplyToRef(t,s.getFinalMatrix()):s.getFinalMatrix().copyFrom(s.getLocalMatrix()),-1!==s._index){const t=null===s._index?i:s._index;s.getAbsoluteInverseBindMatrix().multiplyToArray(s.getFinalMatrix(),e,16*t)}}this._identity.copyToArray(e,16*this.bones.length)}prepare(e=!1){if(!e){const e=this.getScene().getRenderId();if(this._currentRenderId===e)return;this._currentRenderId=e}if(this._numBonesWithLinkedTransformNode>0)for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let i=this._isDirty;if(e._bonesTransformMatrices&&e._bonesTransformMatrices.length===16*(this.bones.length+1)||(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),i=!0),i){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const e of this.bones)e.getParent()||(e.getBindMatrix().multiplyToRef(t,I.AA.Matrix[1]),e._updateAbsoluteBindMatrices(I.AA.Matrix[1]));if(this.isUsingTextureForMatrices){const t=4*(this.bones.length+1);e._transformMatrixTexture&&e._transformMatrixTexture.getSize().width===t||(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=ya.CreateRGBATexture(e._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=ya.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new Ca(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let e=0;e<this.bones.length;e++){const t=this.bones[e];let s=null;const r=t.getParent();if(r){const e=this.bones.indexOf(r);s=i.bones[e]}const n=new cs(t.name,i,s,t.getBindMatrix().clone(),t.getRestMatrix().clone());n._index=t._index,t._linkedTransformNode&&n.linkTransformNode(t._linkedTransformNode),Ze.r.DeepCopy(t.animations,n.animations)}if(this._ranges){i._ranges={};for(const e in this._ranges){const t=this._ranges[e];t&&(i._ranges[e]=t.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){this.bones.forEach((t=>{t.animations.forEach((t=>{t.enableBlending=!0,t.blendingSpeed=e}))}))}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){const e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let t=0;t<this.bones.length;t++){const i=this.bones[t],s=i.getParent(),r={parentBoneIndex:s?this.bones.indexOf(s):-1,index:i.getIndex(),name:i.name,id:i.id,matrix:i.getBindMatrix().asArray(),rest:i.getRestMatrix().asArray(),linkedTransformNodeId:i.getTransformNode()?.id};e.bones.push(r),i.length&&(r.length=i.length),i.metadata&&(r.metadata=i.metadata),i.animations&&i.animations.length>0&&(r.animation=i.animations[0].serialize()),e.ranges=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.ranges.push(s)}}return e}static Parse(e,t){const i=new Ca(e.name,e.id,t);let s;for(e.dimensionsAtRest&&(i.dimensionsAtRest=I.Pq.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix,s=0;s<e.bones.length;s++){const t=e.bones[s],r=e.bones[s].index;let n=null;t.parentBoneIndex>-1&&(n=i.bones[t.parentBoneIndex]);const a=t.rest?I.uq.FromArray(t.rest):null,o=new cs(t.name,i,n,I.uq.FromArray(t.matrix),a,null,r);void 0!==t.id&&null!==t.id&&(o.id=t.id),t.length&&(o.length=t.length),t.metadata&&(o.metadata=t.metadata),t.animation&&o.animations.push(Kt.Parse(t.animation)),void 0!==t.linkedTransformNodeId&&null!==t.linkedTransformNodeId&&(i._hasWaitingData=!0,o._waitingTransformNodeId=t.linkedTransformNodeId)}if(e.ranges)for(s=0;s<e.ranges.length;s++){const t=e.ranges[s];i.createAnimationRange(t.name,t.from,t.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const s=this.bones[e];if(!s)return;void 0===s._index&&(s._index=e);const r=s.getParent();r&&this._sortBones(this.bones.indexOf(r),t,i),t.push(s)}setCurrentPoseAsRest(){this.bones.forEach((e=>{e.setCurrentPoseAsRest()}))}}var Pa=r(6125);class Ea{static Data=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="]}function Aa(e){const t=(e=e.replace(/\\/g,"/")).split("/"),i=[];for(let e=0;e<t.length;++e){const s=t[e];"."!==s&&(".."===s?i.pop():i.push(s))}return i.join("/")}class Ra{uniqueId;leftLoadCount;isRequesting;errorTextureDatas;constructor(e){this.uniqueId=e,this.leftLoadCount=0,this.isRequesting=!0,this.errorTextureDatas=[]}}class Ia{observable;hasLoadError;constructor(){this.observable=new C.cP,this.hasLoadError=!1}}class Ma{cacheKey;_scene;_assetContainer;_textureName;_options;_onLoad;_onError;_texture;constructor(e,t,i,s,r,n,a,o,l){this.cacheKey=e,this._scene=t,this._assetContainer=i,this._textureName=r,this._options=a,this._onLoad=o,this._onError=l,this._texture=null,n||t._loadFile(s,(e=>{this._createTexture(t,i,r,e,a,o,((e,t)=>{l?.(e,t)}))}),void 0,!0,!0,((e,t)=>{l?.(e?e.status+" "+e.statusText:"",t)}))}loadFromArrayBuffer(e){this._createTexture(this._scene,this._assetContainer,this._textureName,e,this._options,this._onLoad,((e,t)=>{this._onError?.(e,t)}))}_onDisposeCallback=null;registerOnDisposeCallback(e){this._onDisposeCallback=e,this._texture.onDisposeObservable.addOnce(e)}unregisterOnDisposeCallback(){const e=this._onDisposeCallback;return null===e?null:(this._onDisposeCallback=null,this._texture.onDisposeObservable.removeCallback(e),e)}_createTexture(e,t,i,s,r,n,a){e._blockEntityCollection=!!t;const o={noMipmap:r.noMipmap,invertY:r.invertY,samplingMode:r.samplingMode,onLoad:()=>{null===this._texture?null!==n&&Jr._.SetImmediate(n):n?.()},onError:a,buffer:s,deleteBuffer:r.deleteBuffer,format:r.format,mimeType:r.mimeType},l=this._texture=new G.g("data:"+i,e,o);l._parentContainer=t,e._blockEntityCollection=!1,t?.textures.push(l),l.name=i}get texture(){return this._texture}}class Oa{onModelTextureLoadedObservable=new Map;textureCache=new Map;_textureLoadInfoMap=new Map;_loadingModels=new Map;_errorTexturesReferenceCount=new Map;_incrementLeftLoadCount(e){let t=this._loadingModels.get(e);void 0===t&&(t=new Ra(e),this._loadingModels.set(e,t)),t.leftLoadCount+=1;let i=this.onModelTextureLoadedObservable.get(e);return void 0===i&&(i=new C.cP,this.onModelTextureLoadedObservable.set(e,i)),t}_decrementLeftLoadCount(e){if(e.leftLoadCount-=1,!e.isRequesting&&0===e.leftLoadCount){this._removeErrorTexturesReferenceCount(e.uniqueId),this._loadingModels.delete(e.uniqueId);const t=this.onModelTextureLoadedObservable.get(e.uniqueId);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e.uniqueId)}}loadModelTexturesEnd(e){const t=this._loadingModels.get(e);if(void 0!==t&&(t.isRequesting=!1,0===t.leftLoadCount)){this._removeErrorTexturesReferenceCount(e),this._loadingModels.delete(e);const t=this.onModelTextureLoadedObservable.get(e);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e)}}_addErrorTextureReferenceCount(e,t){this._loadingModels.get(e).errorTextureDatas.push(t),this._errorTexturesReferenceCount.set(t,(this._errorTexturesReferenceCount.get(t)??0)+1)}_removeErrorTexturesReferenceCount(e){const t=this._loadingModels.get(e);for(let e=0;e<t.errorTextureDatas.length;++e){const i=t.errorTextureDatas[e],s=this._errorTexturesReferenceCount.get(i)-1;0===s?null!==i.texture?i.texture.dispose():(this._textureLoadInfoMap.delete(i.cacheKey),this.textureCache.delete(i.cacheKey),this._errorTexturesReferenceCount.delete(i)):this._errorTexturesReferenceCount.set(i,s)}}_handleTextureOnDispose(e){e.registerOnDisposeCallback((()=>{this._textureLoadInfoMap.delete(e.cacheKey),this.textureCache.delete(e.cacheKey),this._errorTexturesReferenceCount.delete(e)}))}_createTextureCacheKey(e,t){const i=e.lastIndexOf(".");let s="";return-1!==i&&(s=e.substring(i),e=e.substring(0,i)),e+ +(t.noMipmap??!1)+ +(t.invertY??!0)+(t.samplingMode??G.g.TRILINEAR_SAMPLINGMODE)+(t.format??Pa.Y.TEXTUREFORMAT_RGBA)+s}async _loadTextureAsyncInternal(e,t,i,s,r,n,a){const o=this._incrementLeftLoadCount(e),l=this._createTextureCacheKey(t,a);let h=this._textureLoadInfoMap.get(l);void 0===h&&(h=new Ia,this._textureLoadInfoMap.set(l,h));let c=this.textureCache.get(l);if(void 0===c&&!h.hasLoadError){const o=null!==s?Ea.Data[s]:t;c=new Ma(l,r,n,o,t,null!==i,a,(()=>{this._handleTextureOnDispose(c),h.hasLoadError=!1,h.observable.notifyObservers(!1),h.observable.clear()}),((t,i)=>{null!==c.texture&&this._handleTextureOnDispose(c),this._addErrorTextureReferenceCount(e,c),h.hasLoadError=!0,h.observable.notifyObservers(!0),h.observable.clear()})),this.textureCache.set(l,c);const u=i instanceof Blob?await i.arrayBuffer():i;null!==u&&c.loadFromArrayBuffer(u)}return null!==c.texture&&c.texture.isReady()?(this._decrementLeftLoadCount(o),h.hasLoadError?null:c.texture):new Promise((e=>{h.observable.addOnce((t=>{this._decrementLeftLoadCount(o),e(t?null:c.texture)}))}))}async loadTextureAsync(e,t,i,s,r,n){let a;"number"==typeof i?((i<-1||9<i)&&(i=-1),i+=1,a=!0):a=!1;const o=a?a?"file:shared_toon_texture_"+i:i:Aa(t+i);return await this._loadTextureAsyncInternal(e,o,null,a?i:null,s,r,n)}async loadTextureFromBufferAsync(e,t,i,s,r,n,a=!0){return a&&(t=Aa(t)),await this._loadTextureAsyncInternal(e,t,i,null,s,r,n)}}var wa,Da,Fa,Na=r(5662),La=r(6561),Ba=function(e,t,i,s){var r,n=arguments.length,a=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(n<3?r(a):n>3?r(t,i,a):r(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a};class ka{isMock=!0;sphereTexture=null;sphereTextureBlendMode=La.rw.Add;toonTexture=null;ignoreDiffuseWhenToonTextureIsNull=!1;applyAmbientColorToDiffuse=!0;clampAlpha=!0;textureMultiplicativeColor=new M.ov(1,1,1,1);textureAdditiveColor=new M.ov(0,0,0,0);sphereTextureMultiplicativeColor=new M.ov(1,1,1,1);sphereTextureAdditiveColor=new M.ov(0,0,0,0);toonTextureMultiplicativeColor=new M.ov(1,1,1,1);toonTextureAdditiveColor=new M.ov(0,0,0,0);useTextureColor=!1;useSphereTextureColor=!1;useToonTextureColor=!1}class Va extends Oe{_pluginMaterial;_renderOutline=!1;outlineWidth=.01;outlineColor=new M.v9(0,0,0);outlineAlpha=1;_disposed=!1;constructor(e,t,i=!1){super(e,t,i),this.specularColor=new M.v9(0,0,0),(this._pluginMaterial=new ka).ignoreDiffuseWhenToonTextureIsNull=!0,this._initPluginShaderSourceAsync(this._shaderLanguage)}async _initPluginShaderSourceAsync(e){const t=e===Na.w.GLSL?(await r.e(2851).then(r.bind(r,2851))).MmdPluginMaterial:(await r.e(9762).then(r.bind(r,9762))).MmdPluginMaterial;if(this._disposed)return;const i=this._pluginMaterial,s=this._pluginMaterial=new t(this);s.isEnabled=!0,s.sphereTexture=i.sphereTexture,s.sphereTextureBlendMode=i.sphereTextureBlendMode,s.toonTexture=i.toonTexture,s.ignoreDiffuseWhenToonTextureIsNull=i.ignoreDiffuseWhenToonTextureIsNull,s.applyAmbientColorToDiffuse=i.applyAmbientColorToDiffuse,s.clampAlpha=i.clampAlpha,s.textureMultiplicativeColor=i.textureMultiplicativeColor,s.textureAdditiveColor=i.textureAdditiveColor,s.sphereTextureMultiplicativeColor=i.sphereTextureMultiplicativeColor,s.sphereTextureAdditiveColor=i.sphereTextureAdditiveColor,s.toonTextureMultiplicativeColor=i.toonTextureMultiplicativeColor,s.toonTextureAdditiveColor=i.toonTextureAdditiveColor,s.useTextureColor=i.useTextureColor,s.useSphereTextureColor=i.useSphereTextureColor,s.useToonTextureColor=i.useToonTextureColor}dispose(e,t){super.dispose(e,t),this._disposed=!0}isReadyForSubMesh(e,t,i){return!this._pluginMaterial.isMock&&super.isReadyForSubMesh(e,t,i)}get sphereTexture(){return this._pluginMaterial.sphereTexture}set sphereTexture(e){this._pluginMaterial.sphereTexture=e}get sphereTextureBlendMode(){return this._pluginMaterial.sphereTextureBlendMode}set sphereTextureBlendMode(e){this._pluginMaterial.sphereTextureBlendMode=e}get toonTexture(){return this._pluginMaterial.toonTexture}set toonTexture(e){this._pluginMaterial.toonTexture=e}get ignoreDiffuseWhenToonTextureIsNull(){return this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull=e}get applyAmbientColorToDiffuse(){return this._pluginMaterial.applyAmbientColorToDiffuse}set applyAmbientColorToDiffuse(e){this._pluginMaterial.applyAmbientColorToDiffuse=e}get clampAlpha(){return this._pluginMaterial.clampAlpha}set clampAlpha(e){this._pluginMaterial.clampAlpha=e}get textureMultiplicativeColor(){return this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureMultiplicativeColor}set textureMultiplicativeColor(e){this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureMultiplicativeColor=e}get textureAdditiveColor(){return this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureAdditiveColor}set textureAdditiveColor(e){this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureAdditiveColor=e}get sphereTextureMultiplicativeColor(){return this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureMultiplicativeColor}set sphereTextureMultiplicativeColor(e){this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureMultiplicativeColor=e}get sphereTextureAdditiveColor(){return this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureAdditiveColor}set sphereTextureAdditiveColor(e){this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureAdditiveColor=e}get toonTextureMultiplicativeColor(){return this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureMultiplicativeColor}set toonTextureMultiplicativeColor(e){this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureMultiplicativeColor=e}get toonTextureAdditiveColor(){return this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureAdditiveColor}set toonTextureAdditiveColor(e){this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureAdditiveColor=e}get renderOutline(){return this._renderOutline}set renderOutline(e){e&&this.getScene().getMmdOutlineRenderer?.(),this._renderOutline=e}needAlphaBlending(){return!this._disableAlphaBlending&&(super.needAlphaBlending()||null!==this._pluginMaterial.sphereTexture&&this._pluginMaterial.sphereTextureBlendMode===La.rw.Multiply)}clone(e,t=!0,i=""){const s=N.p.Clone((()=>new Va(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return s.name=e,s.id=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}static Parse(e,t,i){const s=N.p.Parse((()=>new Va(e.name,t)),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),Te.i._ParsePlugins(e,s,t,i),s}}Ba([(0,D.lK)("renderOutline")],Va.prototype,"_renderOutline",void 0),Ba([(0,D.lK)()],Va.prototype,"outlineWidth",void 0),Ba([(0,D.jT)()],Va.prototype,"outlineColor",void 0),Ba([(0,D.lK)()],Va.prototype,"outlineAlpha",void 0),(0,V.Y5)("BABYLON.MmdStandardMaterial",Va),function(e){let t,i,s,r,n,a,o,l,h;!function(e){let t;!function(e){e[e.Utf16le=0]="Utf16le",e[e.Utf8=1]="Utf8",e[e.ShiftJis=2]="ShiftJis"}(t=e.Encoding||(e.Encoding={}))}(t=e.Header||(e.Header={})),function(e){let t;!function(e){e[e.Bdef1=0]="Bdef1",e[e.Bdef2=1]="Bdef2",e[e.Bdef4=2]="Bdef4",e[e.Sdef=3]="Sdef",e[e.Qdef=4]="Qdef"}(t=e.BoneWeightType||(e.BoneWeightType={}))}(i=e.Vertex||(e.Vertex={})),function(e){let t,i;!function(e){e[e.IsDoubleSided=1]="IsDoubleSided",e[e.EnabledGroundShadow=2]="EnabledGroundShadow",e[e.EnabledDrawShadow=4]="EnabledDrawShadow",e[e.EnabledReceiveShadow=8]="EnabledReceiveShadow",e[e.EnabledToonEdge=16]="EnabledToonEdge",e[e.EnabledVertexColor=32]="EnabledVertexColor",e[e.EnabledPointDraw=64]="EnabledPointDraw",e[e.EnabledLineDraw=128]="EnabledLineDraw"}(t=e.Flag||(e.Flag={})),function(e){e[e.Off=0]="Off",e[e.Multiply=1]="Multiply",e[e.Add=2]="Add",e[e.SubTexture=3]="SubTexture"}(i=e.SphereTextureMode||(e.SphereTextureMode={}))}(s=e.Material||(e.Material={})),function(e){let t;!function(e){e[e.UseBoneIndexAsTailPosition=1]="UseBoneIndexAsTailPosition",e[e.IsRotatable=2]="IsRotatable",e[e.IsMovable=4]="IsMovable",e[e.IsVisible=8]="IsVisible",e[e.IsControllable=16]="IsControllable",e[e.IsIkEnabled=32]="IsIkEnabled",e[e.LocalAppendTransform=128]="LocalAppendTransform",e[e.HasAppendRotate=256]="HasAppendRotate",e[e.HasAppendMove=512]="HasAppendMove",e[e.HasAxisLimit=1024]="HasAxisLimit",e[e.HasLocalVector=2048]="HasLocalVector",e[e.TransformAfterPhysics=4096]="TransformAfterPhysics",e[e.IsExternalParentTransformed=8192]="IsExternalParentTransformed"}(t=e.Flag||(e.Flag={}))}(r=e.Bone||(e.Bone={})),function(e){let t,i,s;!function(e){e[e.System=0]="System",e[e.Eyebrow=1]="Eyebrow",e[e.Eye=2]="Eye",e[e.Lip=3]="Lip",e[e.Other=4]="Other"}(t=e.Category||(e.Category={})),function(e){e[e.GroupMorph=0]="GroupMorph",e[e.VertexMorph=1]="VertexMorph",e[e.BoneMorph=2]="BoneMorph",e[e.UvMorph=3]="UvMorph",e[e.AdditionalUvMorph1=4]="AdditionalUvMorph1",e[e.AdditionalUvMorph2=5]="AdditionalUvMorph2",e[e.AdditionalUvMorph3=6]="AdditionalUvMorph3",e[e.AdditionalUvMorph4=7]="AdditionalUvMorph4",e[e.MaterialMorph=8]="MaterialMorph",e[e.FlipMorph=9]="FlipMorph",e[e.ImpulseMorph=10]="ImpulseMorph"}(i=e.Type||(e.Type={})),function(e){let t;!function(e){e[e.Multiply=0]="Multiply",e[e.Add=1]="Add"}(t=e.Type||(e.Type={}))}(s=e.MaterialMorph||(e.MaterialMorph={}))}(n=e.Morph||(e.Morph={})),function(e){let t;!function(e){let t;!function(e){e[e.Bone=0]="Bone",e[e.Morph=1]="Morph"}(t=e.FrameType||(e.FrameType={}))}(t=e.FrameData||(e.FrameData={}))}(a=e.DisplayFrame||(e.DisplayFrame={})),function(e){let t,i;!function(e){e[e.Sphere=0]="Sphere",e[e.Box=1]="Box",e[e.Capsule=2]="Capsule"}(t=e.ShapeType||(e.ShapeType={})),function(e){e[e.FollowBone=0]="FollowBone",e[e.Physics=1]="Physics",e[e.PhysicsWithBone=2]="PhysicsWithBone"}(i=e.PhysicsMode||(e.PhysicsMode={}))}(o=e.RigidBody||(e.RigidBody={})),function(e){let t;!function(e){e[e.Spring6dof=0]="Spring6dof",e[e.Sixdof=1]="Sixdof",e[e.P2p=2]="P2p",e[e.ConeTwist=3]="ConeTwist",e[e.Slider=4]="Slider",e[e.Hinge=5]="Hinge"}(t=e.Type||(e.Type={}))}(l=e.Joint||(e.Joint={})),function(e){let t,i,s;!function(e){e[e.TriMesh=0]="TriMesh",e[e.Rope=1]="Rope"}(t=e.Type||(e.Type={})),function(e){e[e.Blink=1]="Blink",e[e.ClusterCreation=2]="ClusterCreation",e[e.LinkCrossing=4]="LinkCrossing"}(i=e.Flag||(e.Flag={})),function(e){e[e.VertexPoint=0]="VertexPoint",e[e.VertexTwoSided=1]="VertexTwoSided",e[e.VertexOneSided=2]="VertexOneSided",e[e.FaceTwoSided=3]="FaceTwoSided",e[e.FaceOneSided=4]="FaceOneSided"}(s=e.AeroDynamicModel||(e.AeroDynamicModel={}))}(h=e.SoftBody||(e.SoftBody={}))}(wa||(wa={}));class Ua{files;_fileRootId;_fileMap=new Map;constructor(e,t,i){if(t=Aa(t),this.files=e,this._fileRootId=i,0!==e.length)if(e[0]instanceof File)for(const s of e){const e=Aa(s.webkitRelativePath);if(!e.startsWith(t))continue;const r=i+Aa(e.slice(t.length));this._fileMap.set(Aa(r).toUpperCase(),s)}else for(const t of e){const e=i+Aa(t.relativePath);this._fileMap.set(Aa(e).toUpperCase(),t)}}createFullPath(e){return this._fileRootId+Aa(e)}resolve(e){const t=Aa(e);return this._fileMap.get(t.toUpperCase())}}!function(e){e[e.Opaque=Te.i.MATERIAL_OPAQUE]="Opaque",e[e.AlphaTest=Te.i.MATERIAL_ALPHATEST]="AlphaTest",e[e.AlphaBlend=Te.i.MATERIAL_ALPHABLEND]="AlphaBlend"}(Da||(Da={}));class za{_scene;_renderTargetTexture;_resultPixelsBuffer;constructor(e,t=512){this._scene=e;const i=e.getEngine(),s=this._renderTargetTexture=new H.$("texture_alpha_checker",t,e,{generateDepthBuffer:!1,generateStencilBuffer:!1,generateMipMaps:!1,type:Pa.Y.TEXTURETYPE_UNSIGNED_BYTE,format:i.isWebGPU||i.version>1?Pa.Y.TEXTUREFORMAT_RED:Pa.Y.TEXTUREFORMAT_RGBA,doNotChangeAspectRatio:!0});s.noPrePassRenderer=!0,s.anisotropicFilteringLevel=1,s.renderParticles=!1,s.optimizeUVAllocation=!0,s.ignoreCameraViewport=!0,s.clearColor=new M.ov(0,0,0,1),this._resultPixelsBuffer=new Uint8Array(t*t*4)}async _renderTexture(e,t,i){const s=za._GetShader(this._scene);s.setTexture("textureSampler",e);let r=null;null!==i&&(r=t.subMeshes,t.subMeshes=[t.subMeshes[i]]);const n=this._renderTargetTexture;n.renderList=[t],n.setMaterialForRendering(t,s);const a=t._internalAbstractMeshDataInfo._currentLODIsUpToDate,o=t._internalAbstractMeshDataInfo._currentLOD;t._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,t._internalAbstractMeshDataInfo._currentLOD=t;const l=t._nodeDataStorage._isEnabled,h=t._nodeDataStorage._isParentEnabled;t._nodeDataStorage._isEnabled=!0,t._nodeDataStorage._isParentEnabled=!0,n.render(!1,!1),t._nodeDataStorage._isParentEnabled=h,t._nodeDataStorage._isEnabled=l,t._internalAbstractMeshDataInfo._currentLOD=o,t._internalAbstractMeshDataInfo._currentLODIsUpToDate=a;const c=s.getEffect();t.geometry._releaseVertexArrayObject(c);const u=t.subMeshes;for(let e=0,t=u.length;e<t;++e)u[e]._removeDrawWrapper(n.renderPassId,!0);null!==r&&(t.subMeshes=r);const d=this._resultPixelsBuffer;return await n.readPixels(void 0,void 0,d),d}_blockRendering=!1;_taskQueue=[];async hasTranslucentFragmentsOnGeometry(e,t,i,s,r){if(!e.isReady())throw new Error("Texture is not ready");this._blockRendering&&await new Promise((e=>{this._taskQueue.push(e)})),this._blockRendering=!0;const n=await this._renderTexture(e,t,i);let a=0,o=0,l=0;for(let e=0;e<n.length;e+=4){const t=n[e];a=Math.max(a,t),0<t&&t<255&&(o+=t,l+=1)}0!==l&&(o/=l),this._blockRendering=!1;const h=this._taskQueue.shift();return void 0!==h&&h(),a<s?Da.Opaque:o+r<a?Da.AlphaTest:Da.AlphaBlend}async hasFragmentsOnlyOpaqueOnGeometry(e,t,i){if(!e.isReady())throw new Error("Texture is not ready");this._blockRendering&&await new Promise((e=>{this._taskQueue.push(e)})),this._blockRendering=!0;const s=await this._renderTexture(e,t,i);for(let e=0;e<s.length;e+=4)if(0!==s[e]){this._blockRendering=!1;const e=this._taskQueue.shift();return void 0!==e&&e(),!1}this._blockRendering=!1;const r=this._taskQueue.shift();return void 0!==r&&r(),!0}dispose(){this._renderTargetTexture.dispose()}static _GetShader(e){if(!e._textureAlphaCheckerShader){const t=e.getEngine().isWebGPU?Na.w.WGSL:Na.w.GLSL,i=new Cn("textureAlphaChecker",e,{vertex:"textureAlphaChecker",fragment:"textureAlphaChecker"},{needAlphaBlending:!1,needAlphaTesting:!1,attributes:["uv"],uniforms:[],samplers:["textureSampler"],shaderLanguage:t,extraInitializationsAsync:async()=>{t===Na.w.WGSL?await Promise.all([r.e(4399).then(r.bind(r,4399)),r.e(1721).then(r.bind(r,1721))]):await Promise.all([r.e(7696).then(r.bind(r,7696)),r.e(7118).then(r.bind(r,7118))])}});i.backFaceCulling=!1,i.alphaMode=Pa.Y.ALPHA_DISABLE,e.onDisposeObservable.add((()=>{e._textureAlphaCheckerShader?.dispose(),e._textureAlphaCheckerShader=null})),e._textureAlphaCheckerShader=i}return e._textureAlphaCheckerShader}static DisposeShader(e){e._textureAlphaCheckerShader?.dispose(),e._textureAlphaCheckerShader=null}}!function(e){e[e.DepthWriteAlphaBlendingWithEvaluation=0]="DepthWriteAlphaBlendingWithEvaluation",e[e.DepthWriteAlphaBlending=1]="DepthWriteAlphaBlending",e[e.AlphaEvaluation=2]="AlphaEvaluation"}(Fa||(Fa={}));class Ga{renderMethod=Fa.DepthWriteAlphaBlendingWithEvaluation;forceDisableAlphaEvaluation=!1;alphaThreshold=195;alphaBlendThreshold=100;alphaEvaluationResolution=512;deleteTextureBufferAfterLoad=!0;_textureLoader=new Oa;nextStartingAlphaIndex=65536;alphaIndexIncrementsPerModel=1024;_setMeshesAlphaIndex(e){let t=this.nextStartingAlphaIndex;for(let i=0;i<e.length;++i)e[i].alphaIndex=t,t+=1;this.nextStartingAlphaIndex+=this.alphaIndexIncrementsPerModel}buildMaterials(e,t,i,s,r,n,a,o,l,h,c,u,d,_,p){this.renderMethod!==Fa.DepthWriteAlphaBlendingWithEvaluation&&this.renderMethod!==Fa.DepthWriteAlphaBlending||this._setMeshesAlphaIndex(l);const f=h.blockMaterialDirtyMechanism;h._forceBlockMaterialDirtyMechanism(!0);let m=null;const g=()=>null!==m?m:this.forceDisableAlphaEvaluation?null:m=new za(h,this.alphaEvaluationResolution),v=new Ua(a,r,n),b=[],x={lengthComputable:!0,loaded:0,total:3*t.length},S=()=>{x.loaded+=1,_?.(x)},T=[];for(let n=0;n<t.length;++n){const a=t[n];h._blockEntityCollection=!!c;const l=new Va(a.name,h);l._parentContainer=c,h._blockEntityCollection=!1,c?.materials.push(l);{const t=[],u=this.loadGeneralScalarProperties(l,a,o[n]);void 0!==u&&t.push(u);const _=this.loadDiffuseTexture(e,l,a,s,i[a.textureIndex]??null,h,c,r,v,d,S),p=()=>this.setAlphaBlendMode(l,a,o[n],d,g);if(void 0!==_){const e=_.then(p);t.push(e)}else{const e=p();void 0!==e&&t.push(e)}const f=this.loadSphereTexture(e,l,a,s,i[a.sphereTextureIndex]??null,h,c,r,v,d,S);void 0!==f&&t.push(f);const m=this.loadToonTexture(e,l,a,s,i[a.toonTextureIndex]??null,h,c,r,v,d,S);void 0!==m&&t.push(m);const x=this.loadOutlineRenderingProperties(l,a,d);void 0!==x&&t.push(x),b.push(...t),Promise.all(t).then((()=>{this.afterBuildSingleMaterial(l,n,a,s,i,h,r)}))}T.push(l)}this._textureLoader.loadModelTexturesEnd(e);const y=this._textureLoader.onModelTextureLoadedObservable.get(e);return void 0!==y?y.addOnce((()=>{Promise.all(b).then((()=>{m?.dispose(),h._forceBlockMaterialDirtyMechanism(f),null!==u&&this._buildTextureNameMap(t,T,s,i,u),p?.()}))})):Promise.all(b).then((()=>{m?.dispose(),h._forceBlockMaterialDirtyMechanism(f),null!==u&&this._buildTextureNameMap(t,T,s,i,u),p?.()})),T}_buildTextureNameMap(e,t,i,s,r){for(let n=0;n<e.length;++n){const a=e[n],o=t[n],l=i[s[a.textureIndex]?.imagePathIndex];if(void 0!==l){const e=o.diffuseTexture;null!==e&&r.set(e,l)}const h=i[s[a.sphereTextureIndex]?.imagePathIndex];if(void 0!==h){const e=o.sphereTexture;null!==e&&r.set(e,h)}const c=i[s[a.toonTextureIndex]?.imagePathIndex];if(void 0!==c){const e=o.toonTexture;null!==e&&r.set(e,c)}}}loadGeneralScalarProperties=(e,t,i)=>{const s=t.diffuse;e.diffuseColor=new M.v9(s[0],s[1],s[2]);const r=t.specular;e.specularColor=new M.v9(r[0],r[1],r[2]);const n=t.ambient;e.ambientColor=new M.v9(n[0],n[1],n[2]);const a=t.diffuse[3];if(e.alpha=a,0===a)for(let e=0;e<i.length;++e){const t=i[e];void 0!==t.isVisible&&(t.isVisible=!1)}e.specularPower=t.shininess};loadDiffuseTexture=async(e,t,i,s,r,n,a,o,l,h,c)=>{t.backFaceCulling=!(i.flag&wa.Material.Flag.IsDoubleSided);const u=s[r?.imagePathIndex??-1];if(void 0!==u){const i=l.createFullPath(u);let s;const d=l.resolve(i);s=void 0!==d?await this._textureLoader.loadTextureFromBufferAsync(e,i,d instanceof File?d:d.data,n,a,{...r,deleteBuffer:this.deleteTextureBufferAfterLoad,format:Pa.Y.TEXTUREFORMAT_RGBA,mimeType:d instanceof File?d.type:d.mimeType}):await this._textureLoader.loadTextureAsync(e,o,u,n,a,{...r,deleteBuffer:this.deleteTextureBufferAfterLoad,format:Pa.Y.TEXTUREFORMAT_RGBA});const _=s;null!==_?t.diffuseTexture=_:h.error(`Failed to load diffuse texture: ${i}`),c?.()}else c?.()};async _evaluateDiffuseTextureTransparencyMode(e,t,i,s,r){let n=Number.MIN_SAFE_INTEGER;if(this.renderMethod===Fa.DepthWriteAlphaBlendingWithEvaluation){let s=t>>4&3;if(3^s||(s=-1),-1===s){n=Te.i.MATERIAL_OPAQUE;const t=r();if(null!==t)for(let s=0;s<i.length;++s){const r=i[s];if(!await t.hasFragmentsOnlyOpaqueOnGeometry(e,r?.mesh??r,void 0!==r?.subMeshIndex?r.subMeshIndex:null)){n=Te.i.MATERIAL_ALPHABLEND;break}}}else n=0===s?Te.i.MATERIAL_OPAQUE:Te.i.MATERIAL_ALPHABLEND}else if(this.renderMethod===Fa.AlphaEvaluation){let s=15&t;if(15^s||(s=-1),-1!==s)n=s;else{const t=r();if(null!==t)for(let s=0;s<i.length;++s){const r=i[s],a=await t.hasTranslucentFragmentsOnGeometry(e,r?.mesh??r,void 0!==r?.subMeshIndex?r.subMeshIndex:null,this.alphaThreshold,this.alphaBlendThreshold);n<a&&(n=a)}}}else s.warn(`Unknown shading method for evaluating transparency mode: ${this.renderMethod}`);return n!==Number.MIN_SAFE_INTEGER?n:null}setAlphaBlendMode=async(e,t,i,s,r)=>{if(this.renderMethod===Fa.DepthWriteAlphaBlending)return e.diffuseTexture&&(e.diffuseTexture.hasAlpha=!0,e.useAlphaFromDiffuseTexture=!0),e.transparencyMode=Te.i.MATERIAL_ALPHABLEND,void(e.forceDepthWrite=!0);if(this.renderMethod===Fa.DepthWriteAlphaBlendingWithEvaluation&&e.alpha<1)return e.diffuseTexture&&(e.diffuseTexture.hasAlpha=!0,e.useAlphaFromDiffuseTexture=!0),e.transparencyMode=Te.i.MATERIAL_ALPHABLEND,void(e.forceDepthWrite=!0);const n=e.diffuseTexture,a=t.evaluatedTransparency??-1;if(null!==n){const t=await this._evaluateDiffuseTextureTransparencyMode(n,a,i,s,r);if(null!==t){const i=t!==Te.i.MATERIAL_OPAQUE;i&&(n.hasAlpha=!0),e.useAlphaFromDiffuseTexture=i,e.transparencyMode=t,this.renderMethod===Fa.DepthWriteAlphaBlendingWithEvaluation&&(e.forceDepthWrite=i)}}else if(this.renderMethod===Fa.DepthWriteAlphaBlendingWithEvaluation){let t=a>>4&3;3^t||(t=0),e.transparencyMode=0===t?Te.i.MATERIAL_OPAQUE:Te.i.MATERIAL_ALPHABLEND}else{let t=15&a;15^t||(t=0),e.transparencyMode=Te.i.MATERIAL_OPAQUE}};loadSphereTexture=async(e,t,i,s,r,n,a,o,l,h,c)=>{if(i.sphereTextureMode!==wa.Material.SphereTextureMode.Off){const u=s[r?.imagePathIndex??-1];if(void 0!==u){const s=n.getEngine().isWebGPU||i.sphereTextureMode===wa.Material.SphereTextureMode.Multiply?Pa.Y.TEXTUREFORMAT_RGBA:Pa.Y.TEXTUREFORMAT_RGB,d=l.createFullPath(u);let _;const p=l.resolve(d);_=void 0!==p?await this._textureLoader.loadTextureFromBufferAsync(e,d,p instanceof File?p:p.data,n,a,{...r,deleteBuffer:this.deleteTextureBufferAfterLoad,format:s,mimeType:p instanceof File?p.type:p.mimeType}):await this._textureLoader.loadTextureAsync(e,o,u,n,a,{...r,deleteBuffer:this.deleteTextureBufferAfterLoad,format:s}),null!==_?(t.sphereTexture=_,t.sphereTextureBlendMode=i.sphereTextureMode):h.error(`Failed to load sphere texture: ${d}`),c?.()}else c?.()}else c?.()};loadToonTexture=async(e,t,i,s,r,n,a,o,l,h,c)=>{let u;if(u=i.isSharedToonTexture?i.toonTextureIndex:s[r?.imagePathIndex??-1],void 0!==u){const i=l.createFullPath(u.toString());let s;const d="string"==typeof u?l.resolve(i):void 0;s=void 0!==d?await this._textureLoader.loadTextureFromBufferAsync(e,i,d instanceof File?d:d.data,n,a,{...r,deleteBuffer:this.deleteTextureBufferAfterLoad,format:n.getEngine().isWebGPU?Pa.Y.TEXTUREFORMAT_RGBA:Pa.Y.TEXTUREFORMAT_RGB,mimeType:d instanceof File?d.type:d.mimeType}):await this._textureLoader.loadTextureAsync(e,o,u,n,a,{...r,deleteBuffer:this.deleteTextureBufferAfterLoad,format:n.getEngine().isWebGPU?Pa.Y.TEXTUREFORMAT_RGBA:Pa.Y.TEXTUREFORMAT_RGB}),null!==s?t.toonTexture=s:h.error(`Failed to load toon texture: ${i}`),c?.()}else c?.()};loadOutlineRenderingProperties=(e,t,i)=>{if(t.flag&wa.Material.Flag.EnabledToonEdge){void 0===be.Z.prototype.getMmdOutlineRenderer&&i.warn('MMD Outline Renderer is not available. Please import "babylon-mmd/esm/Loader/mmdOutlineRenderer".'),e.renderOutline=!0,e.outlineWidth=t.edgeSize;const s=t.edgeColor;e.outlineColor=new M.v9(s[0],s[1],s[2]),e.outlineAlpha=s[3]}};afterBuildSingleMaterial=()=>{}}class Ha{lengthComputable;total;_onProgress;_unprocessedTasks;_processingTasks;_endedTaskNames;_endedTasksTotal;constructor(e,t,i){this.lengthComputable=e;let s=0;for(let e=0;e<t.length;++e)s+=t[e].cost;this.total=s,this._onProgress=i;const r=this._unprocessedTasks=new Map;for(let e=0;e<t.length;++e){if(r.has(t[e].name))throw new Error(`Duplicated task name: ${t[e].name}`);r.set(t[e].name,t[e])}this._processingTasks=new Map,this._endedTaskNames=new Set,this._endedTasksTotal=0}_getTaskState(e){let t=this._processingTasks.get(e);if(void 0===t){const i=this._unprocessedTasks.get(e);if(void 0===i){if(this._endedTaskNames.has(e))return null;throw new Error(`Task not found: ${e}`)}t={name:i.name,cost:i.cost,progress:0},this._processingTasks.set(e,t),this._unprocessedTasks.delete(e)}return t}processTask(e,t){const i=this._getTaskState(e);null!==i&&(i.progress+=t,i.progress>=i.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=i.cost))}setTaskProgress(e,t){const i=this._getTaskState(e);return null!==i&&(i.progress=t,i.progress>=i.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=i.cost),!0)}setTaskProgressRatio(e,t,i){const s=this._getTaskState(e);return null!==s&&(s.progress=i?Math.floor(s.cost*t):s.cost*t,s.progress>=s.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=s.cost),!0)}endTask(e){const t=this._getTaskState(e);null!==t&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=t.cost)}invokeProgressEvent(){null!==this._onProgress&&this._onProgress({lengthComputable:this.lengthComputable,loaded:this.loaded,total:this.total})}get loaded(){let e=this._endedTasksTotal;for(const[t,i]of this._processingTasks)e+=i.progress;return e}}class Wa{name;extensions;materialBuilder;useSdef;buildSkeleton;buildMorph;boundingBoxMargin;preserveSerializationData;_loggingEnabled;log;warn;error;static _SharedStandardMaterialBuilder=new Ga;constructor(e,t,i={},s){this.name=e,this.extensions=t,s=s??{materialBuilder:Wa._SharedStandardMaterialBuilder,useSdef:!0,buildSkeleton:!0,buildMorph:!0,boundingBoxMargin:10,preserveSerializationData:!1,loggingEnabled:!1},this.materialBuilder=i.materialBuilder??s.materialBuilder,this.useSdef=i.useSdef??s.useSdef,this.buildSkeleton=i.buildSkeleton??s.buildSkeleton,this.buildMorph=i.buildMorph??s.buildMorph,this.boundingBoxMargin=i.boundingBoxMargin??s.boundingBoxMargin,this.preserveSerializationData=i.preserveSerializationData??s.preserveSerializationData,this._loggingEnabled=i.loggingEnabled??s.loggingEnabled,this._loggingEnabled?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}importMeshAsync(e,t,i,s,r,n){return this._loadAsyncInternal(t,null,i,s,r)}loadAsync(e,t,i,s,r){return this._loadAsyncInternal(e,null,t,i,s).then((()=>{}))}loadAssetContainerAsync(e,t,i,s,r){const n=new Ta(e);return this._loadAsyncInternal(e,n,t,i,s).then((()=>n))}async _loadAsyncInternal(e,t,i,s,r){const n=await this._parseFileAsync(i.arrayBuffer),a=new Ha(!0,this._getProgressTaskCosts(i,n),r??null);a.endTask("Parse"),a.invokeProgressEvent(),e._blockEntityCollection=!!t;const o=new At(n.header.modelName,e);o._parentContainer=t,e._blockEntityCollection=!1,o.setEnabled(!1);const l=await this._buildGeometryAsync(i,n,o,e,t,a),h=i.preserveSerializationData?new Map:null,{materials:c,multiMaterials:u,textureLoadPromise:d}=await this._buildMaterialAsync(i,n,o,l.meshes,h,e,t,s,a),_=[];let p=null;i.buildSkeleton?p=await this._buildSkeletonAsync(i,n,l.meshes,e,t,_,a):a.endTask("Build Skeleton");const f=[];let m=null;if(i.buildMorph&&(m=await this._buildMorphAsync(i,n,l,e,t,f,a)),0!==i.boundingBoxMargin&&this._applyBoundingBoxMargin(l.meshes,i.boundingBoxMargin),o.metadata={isMmdModel:!0,header:{modelName:n.header.modelName,englishModelName:n.header.englishModelName,comment:n.header.comment,englishComment:n.header.englishComment},bones:_,morphs:f,rigidBodies:n.rigidBodies,joints:n.joints,meshes:l.meshes,materials:c,skeleton:p},i.preserveSerializationData){const e=[],t=n.materials;for(let i=0;i<t.length;++i){const s=t[i];e.push({englishName:s.englishName,comment:s.comment})}o.metadata={...o.metadata,containsSerializationData:!0,textureNameMap:h,materialsMetadata:e,displayFrames:n.displayFrames}}return a.invokeProgressEvent(),await d,a.endTask("Texture Load"),a.invokeProgressEvent(),o.setEnabled(!0),null!==t&&(t.rootNodes.push(o),t.meshes.push(o,...l.meshes),t.geometries.push(...l.geometries),t.materials.push(...c),t.multiMaterials.push(...u),null!==p&&t.skeletons.push(p),null!==m&&t.morphTargetManagers.push(...m)),{meshes:[o,...l.meshes],particleSystems:[],skeletons:null!==p?[p]:[],animationGroups:[],transformNodes:[],geometries:l.geometries,lights:[],spriteManagers:[]}}_getProgressTaskCosts(e,t){return[{name:"Parse",cost:Math.floor(e.arrayBuffer.byteLength/100)},{name:"Build Material",cost:100*t.materials.length},{name:"Build Skeleton",cost:e.buildSkeleton?100*t.bones.length:0},{name:"Texture Load",cost:3e4*t.textures.length}]}async _buildSkeletonAsync(e,t,i,s,r,n,a){const o=e.preserveSerializationData;s._blockEntityCollection=!!r;const l=new Ca(t.header.modelName,t.header.modelName+"_skeleton",s);l._parentContainer=r,s._blockEntityCollection=!1;{const e=t.bones,i=[],s=[];for(let t=0;t<e.length;++t){const r=e[t];let a=!1;if(0<=r.parentBoneIndex&&r.parentBoneIndex<e.length){let i=r.parentBoneIndex;for(let s=0;s<e.length&&-1!==i;++s){if(i===t){a=!0,this.warn(`Bone loop detected. Ignore Parenting. Bone index: ${t}`);break}i=e[i].parentBoneIndex}t<=r.parentBoneIndex&&this.warn(`Parent bone index is greater equal than child bone index. Bone index: ${t} Parent bone index: ${r.parentBoneIndex}`)}else-1!==r.parentBoneIndex&&this.error(`Parent bone index is out of range. Bone index: ${t} Parent bone index: ${r.parentBoneIndex}`);const h=r.position,c=new I.Pq(h[0],h[1],h[2]);if(0<=r.parentBoneIndex&&r.parentBoneIndex<e.length&&!a){const t=e[r.parentBoneIndex];c.x-=t.position[0],c.y-=t.position[1],c.z-=t.position[2]}const u=I.uq.Identity().setTranslation(c),d=new cs(r.name,l,void 0,u,void 0,void 0,t);i.push(d),s.push(a);const _={name:r.name,englishName:r.englishName,parentBoneIndex:r.parentBoneIndex,transformOrder:r.transformOrder,flag:r.flag,appendTransform:r.appendTransform,axisLimit:r.axisLimit,ik:r.ik,...o?{tailPosition:r.tailPosition,localVector:r.localVector,externalParentTransform:r.externalParentTransform}:void 0};n.push(_)}for(let t=0;t<i.length;++t){const r=e[t],n=i[t];0<=r.parentBoneIndex&&r.parentBoneIndex<i.length&&!s[t]&&n.setParent(i[r.parentBoneIndex],!1)}for(let e=0;e<i.length;++e){const t=i[e];null===t.getParent()&&t._updateAbsoluteBindMatrices()}}a.endTask("Build Skeleton"),a.invokeProgressEvent();for(let e=0;e<i.length;++e)i[e].skeleton=l;return l}_applyBoundingBoxMargin(e,t){for(let i=0;i<e.length;++i){const s=e[i];if(void 0===s.subMeshes)continue;const r=s.subMeshes;for(let e=0;e<r.length;++e){const i=r[e],s=i.getBoundingInfo();i.setBoundingInfo(new Z.j((new I.Pq).setAll(-t).addInPlace(s.minimum),(new I.Pq).setAll(t).addInPlace(s.maximum)))}const n=s.getBoundingInfo();s.setBoundingInfo(new Z.j((new I.Pq).setAll(-t).addInPlace(n.minimum),(new I.Pq).setAll(t).addInPlace(n.maximum))),s._updateBoundingInfo()}}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){l.V.Log(e)}_logDisabled(){}_warnEnabled(e){l.V.Warn(e)}_warnDisabled(){}_errorEnabled(e){l.V.Error(e)}_errorDisabled(){}}class Xa{static _IdMap=new WeakMap;static _NextId=0;constructor(){}static GetId(e){let t=this._IdMap.get(e);return void 0===t&&(t=this._NextId,this._NextId+=1,this._IdMap.set(e,t)),t}}class Ka extends At{applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId===this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(O.R.PositionKind))return this;if(!this.isVerticesDataPresent(O.R.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(O.R.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(O.R.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(O.R.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let r=this.getVerticesData(O.R.NormalKind);if(t){if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r))}const n=this.isVerticesDataPresent(va.V.MatricesSdefCKind);let a=null,o=null,l=null;n&&(a=this.getVerticesData(va.V.MatricesSdefCKind),o=this.getVerticesData(va.V.MatricesSdefRW0Kind),l=this.getVerticesData(va.V.MatricesSdefRW1Kind));const h=this.getVerticesData(O.R.MatricesIndicesKind),c=this.getVerticesData(O.R.MatricesWeightsKind);if(!c||!h)return this;const u=this.numBoneInfluencers>4,d=u?this.getVerticesData(O.R.MatricesIndicesExtraKind):null,_=u?this.getVerticesData(O.R.MatricesWeightsExtraKind):null,p=e.getTransformMatrices(this),f=I.Pq.Zero(),m=new I.uq,g=new I.uq,v=new I.uq,b=new I.uq,x=new I.PT,S=new I.PT,T=new I.Pq,y=i._sourcePositions,C=i._sourceNormals;let P,E=0;for(let e=0;e<s.length;e+=3,E+=4){let i=0;if(n&&(i=o[e]),0===i){let i;for(P=0;P<4;P++)i=c[E+P],i>0&&(I.uq.FromFloat32ArrayToRefScaled(p,Math.floor(16*h[E+P]),i,g),m.addToSelf(g));if(u)for(P=0;P<4;P++)i=_[E+P],i>0&&(I.uq.FromFloat32ArrayToRefScaled(p,Math.floor(16*d[E+P]),i,g),m.addToSelf(g));I.Pq.TransformCoordinatesFromFloatsToRef(y[e],y[e+1],y[e+2],m,f),f.toArray(s,e),t&&(I.Pq.TransformNormalFromFloatsToRef(C[e],C[e+1],C[e+2],m,f),f.toArray(r,e)),m.reset()}else{const i=c[E+0],n=c[E+1];I.uq.FromArrayToRef(p,Math.floor(16*h[E+0]),v),I.uq.FromArrayToRef(p,Math.floor(16*h[E+1]),b),I.PT.FromRotationMatrixToRef(v,x),I.PT.FromRotationMatrixToRef(b,S),I.uq.FromQuaternionToRef(I.PT.SlerpToRef(x,S,n,x),g),I.Pq.TransformCoordinatesFromFloatsToRef(y[e]-a[e],y[e+1]-a[e+1],y[e+2]-a[e+2],g,T),I.Pq.TransformCoordinatesFromFloatsToRef(o[e],o[e+1],o[e+2],v,f).scaleAndAddToRef(i,T),I.Pq.TransformCoordinatesFromFloatsToRef(l[e],l[e+1],l[e+2],b,f).scaleAndAddToRef(n,T),T.toArray(s,e),t&&(I.Pq.TransformNormalFromFloatsToRef(C[e],C[e+1],C[e+2],g,T),T.toArray(r,e))}}return this.updateVerticesData(O.R.PositionKind,s),t&&this.updateVerticesData(O.R.NormalKind,r),this}getClassName(){return"SdefMesh"}clone(e="",t=null,i,s=!0){return new Ka(e,this.getScene(),t,this,i,s)}}(0,V.Y5)("BABYLON.SdefMesh",Ka);const Qa={".bpmx":{isBinary:!0}};var Ya;!function(e){let t,i,s;!function(e){let t,i,s;!function(e){e[e.IsSkinnedMesh=1]="IsSkinnedMesh"}(t=e.MeshType||(e.MeshType={})),function(e){e[e.HasSdef=1]="HasSdef",e[e.IsIndexed=2]="IsIndexed",e[e.HasEdgeScale=4]="HasEdgeScale"}(i=e.GeometryType||(e.GeometryType={})),function(e){e[e.Int32=0]="Int32",e[e.Uint32=1]="Uint32",e[e.Uint16=2]="Uint16"}(s=e.IndexElementType||(e.IndexElementType={}))}(t=e.Geometry||(e.Geometry={})),function(e){let t;!function(e){e[e.HasMimeType=1]="HasMimeType"}(t=e.Flag||(e.Flag={}))}(i=e.Image||(e.Image={})),function(e){let t;!function(e){e[e.NoMipmap=1]="NoMipmap",e[e.InvertY=2]="InvertY"}(t=e.Flag||(e.Flag={}))}(s=e.Texture||(e.Texture={}))}(Ya||(Ya={}));class qa{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class $a{isDeviceLittleEndian;_dataView;_decoder;_offset;constructor(e){this.isDeviceLittleEndian=this._getIsDeviceLittleEndian(),this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}_getIsDeviceLittleEndian(){const e=new Int16Array([256]);return 1===new Int8Array(e.buffer)[1]}swap16Array(e){for(let t=0;t<e.length;++t){const i=e[t];e[t]=(255&i)<<8|i>>8&255}}swap32Array(e){for(let t=0;t<e.length;++t){const i=e[t];e[t]=(255&i)<<24|(65280&i)<<8|i>>8&65280|i>>24&255}}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);e.set(t),this._offset+=e.byteLength}getUint16(){const e=this._dataView.getUint16(this._offset,!0);return this._offset+=2,e}getUint16Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap16Array(e)}getInt16(){const e=this._dataView.getInt16(this._offset,!0);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,!0);return this._offset+=4,e}getUint32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getInt32(){const e=this._dataView.getInt32(this._offset,!0);return this._offset+=4,e}getInt32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getFloat32(){const e=this._dataView.getFloat32(this._offset,!0);return this._offset+=4,e}getFloat32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getFloat32Tuple(e){const t=new Array(e);for(let i=0;i<e;++i)t[i]=this._dataView.getFloat32(this._offset,!0),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let i=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<i.length;++e)if(0===i[e]){i=i.subarray(0,e);break}return this._decoder.decode(i)}getSignatureString(e){const t=new TextDecoder("utf-8"),i=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(i)}getPaddedArrayOffset(e,t){this._offset+=this._offset%e==0?0:e-this._offset%e;const i=this._offset;return this._offset+=e*t,i}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class ja{constructor(){}static async ParseAsync(e,t=new qa){const i=new $a(e);i.initializeTextDecoder("utf-8");const s=this._ParseHeader(i),r=1===i.getUint8(),n=await this._ParseGeometriesAsync(i,r);if((s.version[0]<<16|s.version[1]<<8|s.version[2])<this._V221Int){let e=!1;for(let t=0;t<n.length;++t)if(n[t].skinning?.sdef){e=!0;break}e&&t.warn("Sdef parameters in this file are incorrect. sdef deformation may have some problems.")}const a=await this._ParseImagesAsync(i),o=this._ParseTexturesAsync(i),l=this._ParseMaterials(i,s.version),h=r?this._ParseBones(i):[],c=this._ParseMorphs(i),u=this._ParseDisplayFrames(i),d=this._ParseRigidBodies(i),_=this._ParseJoints(i);return i.bytesAvailable>0&&t.warn(`There are ${i.bytesAvailable} bytes left after parsing`),{header:s,geometries:n,images:a,textures:o,materials:l,bones:h,morphs:c,displayFrames:u,rigidBodies:d,joints:_}}static _V200Int=2<<16;static _V221Int=131585;static _ParseHeader(e){if(e.bytesAvailable<7)throw new RangeError("is not bpmx file");const t=e.getDecoderString(4,!1);if("BPMX"!==t)throw new RangeError("is not bpmx file");const i=[e.getInt8(),e.getInt8(),e.getInt8()],s=i[0]<<16|i[1]<<8|i[2];if(s<this._V200Int||this._V221Int<s)throw new ks.hX(`BPMX version ${i[0]}.${i[1]}.${i[2]} is not supported.`);return{signature:t,version:i,modelName:e.getDecoderString(e.getUint32(),!1),englishModelName:e.getDecoderString(e.getUint32(),!1),comment:e.getDecoderString(e.getUint32(),!1),englishComment:e.getDecoderString(e.getUint32(),!1)}}static async _ParseGeometriesAsync(e,t){let i=performance.now();const s=[],r=e.getUint32();for(let n=0;n<r;++n){const r=e.getDecoderString(e.getUint32(),!1);let n=e.getInt32();if(-2===n){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t=e.getInt32(),s=e.getUint32(),r=e.getUint32(),n=e.getUint32(),a=e.getUint32();i.push({materialIndex:t,verticesStart:s,verticesCount:r,indexStart:n,indexCount:a})}n=i}const a=e.getUint32(),o=new Float32Array(3*a);e.getFloat32Array(o),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now());const l=new Float32Array(3*a);e.getFloat32Array(l),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now());const h=new Float32Array(2*a);e.getFloat32Array(h);const c=[],u=e.getUint8();for(let t=0;t<u;++t){const t=new Float32Array(4*a);e.getFloat32Array(t),c.push(t)}100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now());const d=e.getUint8();let _,p,f;if(d&Ya.Geometry.GeometryType.IsIndexed){const t=e.getUint8(),s=e.getUint32();t===Ya.Geometry.IndexElementType.Int32?(_=new Int32Array(s),e.getInt32Array(_)):t===Ya.Geometry.IndexElementType.Uint32?(_=new Uint32Array(s),e.getUint32Array(_)):(_=new Uint16Array(s),e.getUint16Array(_)),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now())}if(t){const t=new Float32Array(4*a);e.getFloat32Array(t);const s=new Float32Array(4*a);let r;if(e.getFloat32Array(s),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now()),d&Ya.Geometry.GeometryType.HasSdef){const t=new Float32Array(3*a),s=new Float32Array(3*a),n=new Float32Array(3*a);e.getFloat32Array(t),e.getFloat32Array(s),e.getFloat32Array(n),r={c:t,r0:s,r1:n},100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now())}p={matricesIndices:t,matricesWeights:s,sdef:r}}d&Ya.Geometry.GeometryType.HasEdgeScale&&(f=new Float32Array(a),e.getFloat32Array(f));const m={name:r,materialIndex:n,positions:o,normals:l,uvs:h,additionalUvs:c,indices:_,skinning:p,edgeScale:f};s.push(m)}return s}static async _ParseImagesAsync(e){const t=e.getUint32();let i=performance.now();const s=[];for(let r=0;r<t;++r){const t=e.getDecoderString(e.getUint32(),!1),r=e.getUint8()&Ya.Image.Flag.HasMimeType?e.getDecoderString(e.getUint32(),!1):void 0,n=e.getUint32(),a=new ArrayBuffer(n);e.getUint8Array(new Uint8Array(a)),s.push({relativePath:t,mimeType:r,data:a}),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now())}return s}static _ParseTexturesAsync(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t=e.getUint8(),s=e.getUint8(),r=e.getInt32();i.push({flag:t,samplingMode:s,imageIndex:r})}return i}static _ParseMaterials(e,t){const i=e.getUint32(),s=[];for(let r=0;r<i;++r){const i={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),evaluatedTransparency:2===t[0]&&0===t[1]?240|e.getUint8():e.getUint8(),flag:e.getUint8(),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureIndex:e.getInt32(),sphereTextureIndex:e.getInt32(),sphereTextureMode:e.getUint8(),isSharedToonTexture:1===e.getUint8(),toonTextureIndex:e.getInt32(),comment:e.getDecoderString(e.getUint32(),!1)};s.push(i)}return s}static _ParseBones(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t=e.getDecoderString(e.getUint32(),!1),s=e.getDecoderString(e.getUint32(),!1),r=e.getFloat32Tuple(3),n=e.getInt32(),a=e.getInt32(),o=e.getUint16();let l,h,c,u,d,_;if(l=o&wa.Bone.Flag.UseBoneIndexAsTailPosition?e.getInt32():e.getFloat32Tuple(3),(o&wa.Bone.Flag.HasAppendMove||o&wa.Bone.Flag.HasAppendRotate)&&(h={parentIndex:e.getInt32(),ratio:e.getFloat32()}),o&wa.Bone.Flag.HasAxisLimit&&(c=e.getFloat32Tuple(3)),o&wa.Bone.Flag.HasLocalVector&&(u={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)}),o&wa.Bone.Flag.IsExternalParentTransformed&&(d=e.getInt32()),o&wa.Bone.Flag.IsIkEnabled){const t=e.getInt32(),i=e.getInt32(),s=e.getFloat32(),r=[],n=e.getInt32();for(let t=0;t<n;++t){const t={target:e.getInt32(),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};r.push(t)}_={target:t,iteration:i,rotationConstraint:s,links:r}}const p={name:t,englishName:s,position:r,parentBoneIndex:n,transformOrder:a,flag:o,tailPosition:l,appendTransform:h,axisLimit:c,localVector:u,externalParentTransform:d,ik:_};i.push(p)}return i}static _ParseMorphs(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t=e.getDecoderString(e.getUint32(),!1),s=e.getDecoderString(e.getUint32(),!1),r=e.getUint8(),n=e.getUint8();let a={name:t,englishName:s,category:r,type:n};switch(n){case wa.Morph.Type.GroupMorph:{const t=e.getUint32(),i=new Int32Array(t);e.getInt32Array(i);const s=new Float32Array(t);e.getFloat32Array(s),a={...a,indices:i,ratios:s}}break;case wa.Morph.Type.VertexMorph:{const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t=e.getUint32(),s=e.getUint32(),r=new Int32Array(s);e.getInt32Array(r);const n=new Float32Array(3*s);e.getFloat32Array(n);const a={meshIndex:t,indices:r,offsets:n};i.push(a)}a={...a,elements:i}}break;case wa.Morph.Type.BoneMorph:{const t=e.getUint32(),i=new Int32Array(t);e.getInt32Array(i);const s=new Float32Array(3*t);e.getFloat32Array(s);const r=new Float32Array(4*t);e.getFloat32Array(r),a={...a,indices:i,positions:s,rotations:r}}break;case wa.Morph.Type.UvMorph:case wa.Morph.Type.AdditionalUvMorph1:case wa.Morph.Type.AdditionalUvMorph2:case wa.Morph.Type.AdditionalUvMorph3:case wa.Morph.Type.AdditionalUvMorph4:{const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t=e.getUint32(),s=e.getUint32(),r=new Int32Array(s);e.getInt32Array(r);const n=new Float32Array(4*s);e.getFloat32Array(n);const a={meshIndex:t,indices:r,offsets:n};i.push(a)}a={...a,elements:i}}break;case wa.Morph.Type.MaterialMorph:{const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t={index:e.getInt32(),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};i.push(t)}a={...a,elements:i}}break;default:throw new Error(`Unknown morph type: ${n}`)}i.push(a)}return i}static _ParseDisplayFrames(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t=e.getDecoderString(e.getUint32(),!1),s=e.getDecoderString(e.getUint32(),!1),r=1===e.getUint8(),n=e.getUint32(),a=[];for(let t=0;t<n;++t){const t={type:e.getUint8(),index:e.getInt32()};a.push(t)}const o={name:t,englishName:s,isSpecialFrame:r,frames:a};i.push(o)}return i}static _ParseRigidBodies(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),boneIndex:e.getInt32(),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};i.push(t)}return i}static _ParseJoints(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),type:e.getUint8(),rigidbodyIndexA:e.getInt32(),rigidbodyIndexB:e.getInt32(),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};i.push(t)}return i}}class Za extends Wa{constructor(e,t){super("bpmx",Qa,e,t)}loadFile(e,t,i,s,r,n,a){const o=this.materialBuilder,l=this.useSdef,h=this.buildSkeleton,c=this.buildMorph,u=this.boundingBoxMargin,d=this.preserveSerializationData;return e._loadFile(t,((e,i)=>{const r={arrayBuffer:e,pmFileId:t instanceof File?Xa.GetId(t).toString():t,materialBuilder:o,useSdef:l,buildSkeleton:h,buildMorph:c,boundingBoxMargin:u,preserveSerializationData:d};s(r,i)}),r,!0,n,a)}createPlugin(e){return new Za(e.mmdmodel,this)}async _parseFileAsync(e){return await ja.ParseAsync(e,this).catch((e=>Promise.reject(e)))}_getProgressTaskCosts(e,t){const i=super._getProgressTaskCosts(e,t);let s=0;for(let e=0;e<t.geometries.length;++e)s+=t.geometries[e].positions.length;if(i.push({name:"Build Geometry",cost:s}),e.buildMorph){let e=0;const s=t.morphs;for(let t=0;t<s.length;++t){const i=s[t];if(i.type!==wa.Morph.Type.VertexMorph&&i.type!==wa.Morph.Type.UvMorph)continue;const r=i.elements;for(let t=0;t<r.length;++t)e+=r[t].indices.length}i.push({name:"Build Morph",cost:e})}return i}async _buildGeometryAsync(e,t,i,s,r,n){const a=[],o=[];let l=performance.now(),h=0;const c=t.geometries;for(let u=0;u<c.length;++u){const d=c[u],_=d.skinning,p=new at;p.positions=d.positions,p.normals=d.normals,p.uvs=d.uvs,void 0!==d.indices&&(p.indices=d.indices),e.buildSkeleton&&void 0!==_&&(p.matricesIndices=_.matricesIndices,p.matricesWeights=_.matricesWeights);let f=null,m=null,g=null,v=null,b=null;if(e.buildSkeleton&&e.useSdef&&void 0!==_?.sdef){const e=d.positions.length/3,t=_.matricesWeights;f=_.sdef.c,m=_.sdef.r0,g=_.sdef.r1,v=new Float32Array(m.length),b=new Float32Array(g.length);for(let i=0;i<e;++i){const e=t[4*i+0],s=t[4*i+1],r=f[3*i+0],n=f[3*i+1],a=f[3*i+2];let o=m[3*i+0],l=m[3*i+1],h=m[3*i+2],c=g[3*i+0],u=g[3*i+1],d=g[3*i+2];const _=o*e+c*s,p=l*e+u*s,x=h*e+d*s;o=r+o-_,l=n+l-p,h=a+h-x,c=r+c-_,u=n+u-p,d=a+d-x;const S=.5*(r+o),T=.5*(n+l),y=.5*(a+h),C=.5*(r+c),P=.5*(n+u),E=.5*(a+d);v[3*i+0]=S,v[3*i+1]=T,v[3*i+2]=y,b[3*i+0]=C,b[3*i+1]=P,b[3*i+2]=E}}s._blockEntityCollection=!!r;const x=new(null!==f?Ka:At)(d.name,s);x._parentContainer=r,s._blockEntityCollection=!1,void 0===d.indices&&(x.isUnIndexed=!0),x.setParent(i),a.push(x),s._blockEntityCollection=!!r;const S=new ct(t.header.modelName,s,p,!1);if(S._parentContainer=r,s._blockEntityCollection=!1,e.preserveSerializationData&&void 0!==d.additionalUvs){const e=[va.V.AdditionalUV1Kind,va.V.AdditionalUV2Kind,va.V.AdditionalUV3Kind,va.V.AdditionalUV4Kind];for(let t=0;t<d.additionalUvs.length;++t)S.setVerticesData(e[t],d.additionalUvs[t],!1,4)}null!==f&&(S.setVerticesData(va.V.MatricesSdefCKind,f,!1,3),S.setVerticesData(va.V.MatricesSdefR0Kind,m,!1,3),S.setVerticesData(va.V.MatricesSdefR1Kind,g,!1,3),S.setVerticesData(va.V.MatricesSdefRW0Kind,v,!1,3),S.setVerticesData(va.V.MatricesSdefRW1Kind,b,!1,3)),e.preserveSerializationData&&void 0!==d.edgeScale&&S.setVerticesData(va.V.EdgeScaleKind,d.edgeScale,!1,1),S.applyToMesh(x),o.push(S),h+=d.positions.length,h%1e4==0&&100<performance.now()-l&&(n.setTaskProgress("Build Geometry",h),n.invokeProgressEvent(),await ee.S0.DelayAsync(0),l=performance.now())}return n.endTask("Build Geometry"),n.invokeProgressEvent(),{meshes:a,geometries:o}}async _buildMaterialAsync(e,t,i,s,r,n,a,o,l){let h;const c=new Array(t.images.length);for(let e=0;e<t.images.length;++e)c[e]=t.images[e].relativePath;const u=new Array(t.textures.length);for(let e=0;e<t.textures.length;++e){const i=t.textures[e];u[e]={noMipmap:!!(i.flag&Ya.Texture.Flag.NoMipmap),invertY:!!(i.flag&Ya.Texture.Flag.InvertY),samplingMode:i.samplingMode,imagePathIndex:i.imageIndex}}const d=new Array(t.materials.length);for(let e=0;e<d.length;++e)d[e]=[];const _=t.geometries;for(let e=0;e<s.length;++e){const t=_[e].materialIndex;if(-1!==t)if("object"==typeof t){const i=t;for(let t=0;t<i.length;++t)d[i[t].materialIndex].push({mesh:s[e],subMeshIndex:t})}else d[t].push(s[e])}const p=new Promise((_=>{h=e.materialBuilder.buildMaterials(i.uniqueId,t.materials,u,c,o,"file:"+e.pmFileId+"_",t.images,d,s,n,a,r,this,(e=>{e.lengthComputable&&(l.setTaskProgressRatio("Texture Load",e.loaded/e.total,!0),l.invokeProgressEvent())}),(()=>_()))})),f=Array.isArray(h)?h:await h,m=[];for(let e=0;e<s.length;++e){const t=s[e],i=_[e].materialIndex;if(-1!==i)if("object"==typeof i){const e=i;if(t.subMeshes.length=0,0===e.length)t.material=null;else if(1===e.length){const i=e[0];new rt.K(0,i.verticesStart,i.verticesCount,i.indexStart,i.indexCount,t),t.material=f[e[0].materialIndex]}else{n._blockEntityCollection=!!a;const i=new xt(t.name,n);i._parentContainer=a,n._blockEntityCollection=!1;const s=i.subMaterials;m.push(i);for(let i=0;i<e.length;++i){const r=e[i];new rt.K(i,r.verticesStart,r.verticesCount,r.indexStart,r.indexCount,t),s.push(f[r.materialIndex])}t.material=i}}else{const e=f[i];t.material=e}}return l.endTask("Build Material"),l.invokeProgressEvent(),{materials:f,multiMaterials:m,textureLoadPromise:p}}_buildSkeletonAsync(e,t,i,s,r,n,a){return 0===t.bones.length?(a.endTask("Build Skeleton"),Promise.resolve(null)):super._buildSkeletonAsync(e,t,i,s,r,n,a)}async _buildMorphAsync(e,t,i,s,r,n,a){const o=e.preserveSerializationData,l=t.morphs,h=new Array(t.geometries.length);for(let e=0;e<h.length;++e)h[e]=[];let c=0,u=performance.now();for(let e=0;e<l.length;++e){const i=l[e],r=[];switch(i.type){case wa.Morph.Type.GroupMorph:case wa.Morph.Type.BoneMorph:case wa.Morph.Type.MaterialMorph:n.push(i);break;case wa.Morph.Type.VertexMorph:case wa.Morph.Type.UvMorph:case wa.Morph.Type.AdditionalUvMorph1:case wa.Morph.Type.AdditionalUvMorph2:case wa.Morph.Type.AdditionalUvMorph3:case wa.Morph.Type.AdditionalUvMorph4:n.push({name:i.name,englishName:i.englishName,category:i.category,type:i.type,morphTargets:r,...o?{elements:i.elements}:void 0})}if(i.type===wa.Morph.Type.VertexMorph||i.type===wa.Morph.Type.UvMorph||i.type===wa.Morph.Type.AdditionalUvMorph1||i.type===wa.Morph.Type.AdditionalUvMorph2||i.type===wa.Morph.Type.AdditionalUvMorph3||i.type===wa.Morph.Type.AdditionalUvMorph4){if(i.type!==wa.Morph.Type.AdditionalUvMorph1&&i.type!==wa.Morph.Type.AdditionalUvMorph2&&i.type!==wa.Morph.Type.AdditionalUvMorph3&&i.type!==wa.Morph.Type.AdditionalUvMorph4){const e=i.elements;for(let t=0;t<e.length;++t){const n=new fa(i.name,0,s);r.push(n),h[e[t].meshIndex].push(n),c+=e[t].indices.length}const n=t.geometries;if(i.type===wa.Morph.Type.VertexMorph)for(let t=0;t<e.length;++t){const i=e[t],s=n[i.meshIndex],a=new Float32Array(s.positions.length);a.set(s.positions);const o=i.indices,l=i.offsets;for(let e=0;e<o.length;++e){const t=o[e];a[3*t+0]+=l[3*e+0],a[3*t+1]+=l[3*e+1],a[3*t+2]+=l[3*e+2]}r[t].setPositions(a)}else for(let t=0;t<e.length;++t){const i=e[t],s=n[i.meshIndex],a=new Float32Array(s.uvs.length);a.set(s.uvs);const o=i.indices,l=i.offsets;for(let e=0;e<o.length;++e){const t=o[e];a[2*t+0]+=l[4*e+0],a[2*t+1]+=l[4*e+1]}const h=r[t];h.setPositions(s.positions),h.setUVs(a)}}100<performance.now()-u&&(a.setTaskProgress("Build Morph",c),a.invokeProgressEvent(),await ee.S0.DelayAsync(0),u=performance.now())}}a.endTask("Build Morph");const d=[],_=i.meshes;for(let e=0;e<h.length;++e){const t=h[e];if(0===t.length)continue;s._blockEntityCollection=!!r;const n=new ga(s);n._parentContainer=r,s._blockEntityCollection=!1,n.enableNormalMorphing=!1,n.enableTangentMorphing=!1,n.enableUVMorphing=!1,n.areUpdatesFrozen=!0;for(let e=0;e<t.length;++e){const i=t[e];n.addTarget(i),i.hasUVs&&(n.enableUVMorphing=!0)}if(n.enableUVMorphing){const s=i.geometries[e].getVerticesData(O.R.UVKind);for(let e=0;e<t.length;++e){const i=t[e];i.hasUVs||i.setUVs(s)}}n.areUpdatesFrozen=!1,d.push(n),_[e].morphTargetManager=n}return d}}Ys(new Za);class Ja{_vertexIndexSize;_textureIndexSize;_materialIndexSize;_boneIndexSize;_morphIndexSize;_rigidBodyIndexSize;constructor(e,t,i,s,r,n){this._vertexIndexSize=e,this._textureIndexSize=t,this._materialIndexSize=i,this._boneIndexSize=s,this._morphIndexSize=r,this._rigidBodyIndexSize=n}getVertexIndex(e){switch(this._vertexIndexSize){case 1:return e.getUint8();case 2:return e.getUint16();case 4:return e.getInt32();default:throw new Error(`Invalid vertexIndexSize: ${this._vertexIndexSize}`)}}_getNonVertexIndex(e,t){switch(t){case 1:return e.getInt8();case 2:return e.getInt16();case 4:return e.getInt32();default:throw new Error(`Invalid indexSize: ${t}`)}}getTextureIndex(e){return this._getNonVertexIndex(e,this._textureIndexSize)}getMaterialIndex(e){return this._getNonVertexIndex(e,this._materialIndexSize)}getBoneIndex(e){return this._getNonVertexIndex(e,this._boneIndexSize)}getMorphIndex(e){return this._getNonVertexIndex(e,this._morphIndexSize)}getRigidBodyIndex(e){return this._getNonVertexIndex(e,this._rigidBodyIndexSize)}}class eo{constructor(){}static async ParseAsync(e,t=new qa){const i=new $a(e),s=this._ParseHeader(i,t),r=new Ja(s.vertexIndexSize,s.textureIndexSize,s.materialIndexSize,s.boneIndexSize,s.morphIndexSize,s.rigidBodyIndexSize),n=await this._ParseVerticesAsync(i,r,s),a=this._ParseIndices(i,r,s),o=this._ParseTextures(i),l=this._ParseMaterials(i,r),h=this._ParseBones(i,r),c=this._ParseMorphs(i,r),u=this._ParseDisplayFrames(i,r),d=this._ParseRigidBodies(i,r),_=this._ParseJoints(i,r),p=s.version<=2?[]:this._ParseSoftBodies(i,r,s);return i.bytesAvailable>0&&t.warn(`There are ${i.bytesAvailable} bytes left after parsing`),{header:s,vertices:n,indices:a,textures:o,materials:l,bones:h,morphs:c,displayFrames:u,rigidBodies:d,joints:_,softBodies:p}}static _ParseHeader(e,t){if(e.bytesAvailable<17)throw new RangeError("is not pmx file");const i=e.getSignatureString(3);if("PMX"!==i)throw new RangeError("is not pmx file");e.getInt8();const s=e.getFloat32(),r=e.getUint8(),n=e.getUint8();e.initializeTextDecoder(n===wa.Header.Encoding.Utf8?"utf-8":"utf-16le");const a=e.getUint8(),o=e.getUint8(),l=e.getUint8(),h=e.getUint8(),c=e.getUint8(),u=e.getUint8(),d=e.getUint8();if(r<8)throw new Error(`Invalid globalsCount: ${r}`);if(8<r){t.warn(`globalsCount is greater than 8: ${r} files may be corrupted or higher version`);for(let t=8;t<r;++t)e.getUint8()}return{signature:i,version:s,encoding:n,additionalVec4Count:a,vertexIndexSize:o,textureIndexSize:l,materialIndexSize:h,boneIndexSize:c,morphIndexSize:u,rigidBodyIndexSize:d,modelName:e.getDecoderString(e.getInt32(),!1),englishModelName:e.getDecoderString(e.getInt32(),!1),comment:e.getDecoderString(e.getInt32(),!1),englishComment:e.getDecoderString(e.getInt32(),!1)}}static async _ParseVerticesAsync(e,t,i){const s=e.getInt32(),r=[];let n=performance.now();for(let a=0;a<s;++a){const s=e.getFloat32Tuple(3),o=e.getFloat32Tuple(3),l=e.getFloat32Tuple(2),h=[];for(let t=0;t<i.additionalVec4Count;++t)h.push(e.getFloat32Tuple(4));const c=e.getUint8();let u;switch(c){case wa.Vertex.BoneWeightType.Bdef1:u={boneIndices:t.getBoneIndex(e),boneWeights:null};break;case wa.Vertex.BoneWeightType.Bdef2:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:e.getFloat32()};break;case wa.Vertex.BoneWeightType.Bdef4:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;case wa.Vertex.BoneWeightType.Sdef:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:{boneWeight0:e.getFloat32(),c:e.getFloat32Tuple(3),r0:e.getFloat32Tuple(3),r1:e.getFloat32Tuple(3)}};break;case wa.Vertex.BoneWeightType.Qdef:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;default:throw new Error(`Invalid weightType: ${c}`)}const d=e.getFloat32();r.push({position:s,normal:o,uv:l,additionalVec4:h,weightType:c,boneWeight:u,edgeScale:d}),a%1e4==0&&100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now())}return r}static _ParseIndices(e,t,i){const s=e.getInt32(),r=new ArrayBuffer(s*i.vertexIndexSize);let n;switch(i.vertexIndexSize){case 1:n=new Uint8Array(r);break;case 2:n=new Uint16Array(r);break;case 4:n=new Int32Array(r);break;default:throw new Error(`Invalid vertexIndexSize: ${i.vertexIndexSize}`)}for(let i=0;i<s;++i)n[i]=t.getVertexIndex(e);return n}static _ParseTextures(e){const t=e.getInt32(),i=[];for(let s=0;s<t;++s){const t=e.getDecoderString(e.getInt32(),!1);i.push(t)}return i}static _ParseMaterials(e,t){const i=e.getInt32(),s=[];for(let r=0;r<i;++r){const i=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),n=e.getFloat32Tuple(4),a=e.getFloat32Tuple(3),o=e.getFloat32(),l=e.getFloat32Tuple(3),h=e.getUint8(),c=e.getFloat32Tuple(4),u=e.getFloat32(),d=t.getTextureIndex(e),_=t.getTextureIndex(e),p=e.getUint8(),f=1===e.getUint8(),m={name:i,englishName:r,diffuse:n,specular:a,shininess:o,ambient:l,flag:h,edgeColor:c,edgeSize:u,textureIndex:d,sphereTextureIndex:_,sphereTextureMode:p,isSharedToonTexture:f,toonTextureIndex:f?e.getUint8():t.getTextureIndex(e),comment:e.getDecoderString(e.getInt32(),!1),indexCount:e.getInt32()};s.push(m)}return s}static _ParseBones(e,t){const i=e.getInt32(),s=[];for(let r=0;r<i;++r){const i=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),n=e.getFloat32Tuple(3),a=t.getBoneIndex(e),o=e.getInt32(),l=e.getUint16();let h,c,u,d,_,p;if(h=l&wa.Bone.Flag.UseBoneIndexAsTailPosition?t.getBoneIndex(e):e.getFloat32Tuple(3),(l&wa.Bone.Flag.HasAppendMove||l&wa.Bone.Flag.HasAppendRotate)&&(c={parentIndex:t.getBoneIndex(e),ratio:e.getFloat32()}),l&wa.Bone.Flag.HasAxisLimit&&(u=e.getFloat32Tuple(3)),l&wa.Bone.Flag.HasLocalVector&&(d={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)}),l&wa.Bone.Flag.IsExternalParentTransformed&&(_=e.getInt32()),l&wa.Bone.Flag.IsIkEnabled){const i=t.getBoneIndex(e),s=e.getInt32(),r=e.getFloat32(),n=[],a=e.getInt32();for(let i=0;i<a;++i){const i={target:t.getBoneIndex(e),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};n.push(i)}p={target:i,iteration:s,rotationConstraint:r,links:n}}const f={name:i,englishName:r,position:n,parentBoneIndex:a,transformOrder:o,flag:l,tailPosition:h,appendTransform:c,axisLimit:u,localVector:d,externalParentTransform:_,ik:p};s.push(f)}return s}static _ParseMorphs(e,t){const i=e.getInt32(),s=[];for(let r=0;r<i;++r){const i=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),n=e.getInt8(),a=e.getInt8();let o={name:i,englishName:r,category:n,type:a};const l=e.getInt32();switch(a){case wa.Morph.Type.GroupMorph:{const i=new Int32Array(l),s=new Float32Array(l);for(let r=0;r<l;++r)i[r]=t.getMorphIndex(e),s[r]=e.getFloat32();o={...o,indices:i,ratios:s}}break;case wa.Morph.Type.VertexMorph:{const i=new Int32Array(l),s=new Float32Array(3*l);for(let r=0;r<l;++r)i[r]=t.getVertexIndex(e),s[3*r+0]=e.getFloat32(),s[3*r+1]=e.getFloat32(),s[3*r+2]=e.getFloat32();o={...o,indices:i,positions:s}}break;case wa.Morph.Type.BoneMorph:{const i=new Int32Array(l),s=new Float32Array(3*l),r=new Float32Array(4*l);for(let n=0;n<l;++n)i[n]=t.getBoneIndex(e),s[3*n+0]=e.getFloat32(),s[3*n+1]=e.getFloat32(),s[3*n+2]=e.getFloat32(),r[4*n+0]=e.getFloat32(),r[4*n+1]=e.getFloat32(),r[4*n+2]=e.getFloat32(),r[4*n+3]=e.getFloat32();o={...o,indices:i,positions:s,rotations:r}}break;case wa.Morph.Type.UvMorph:case wa.Morph.Type.AdditionalUvMorph1:case wa.Morph.Type.AdditionalUvMorph2:case wa.Morph.Type.AdditionalUvMorph3:case wa.Morph.Type.AdditionalUvMorph4:{const i=new Int32Array(l),s=new Float32Array(4*l);for(let r=0;r<l;++r)i[r]=t.getVertexIndex(e),s[4*r+0]=e.getFloat32(),s[4*r+1]=e.getFloat32(),s[4*r+2]=e.getFloat32(),s[4*r+3]=e.getFloat32();o={...o,indices:i,offsets:s}}break;case wa.Morph.Type.MaterialMorph:{const i=[];for(let s=0;s<l;++s){const s={index:t.getMaterialIndex(e),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};i.push(s)}o={...o,elements:i}}break;case wa.Morph.Type.FlipMorph:{const i=new Int32Array(l),s=new Float32Array(l);for(let r=0;r<l;++r)i[r]=t.getMorphIndex(e),s[r]=e.getFloat32();o={...o,indices:i,ratios:s}}break;case wa.Morph.Type.ImpulseMorph:{const i=new Int32Array(l),s=new Array(l),r=new Float32Array(3*l),n=new Float32Array(3*l);for(let a=0;a<l;++a)i[a]=t.getRigidBodyIndex(e),s[a]=1===e.getUint8(),r[3*a+0]=e.getFloat32(),r[3*a+1]=e.getFloat32(),r[3*a+2]=e.getFloat32(),n[3*a+0]=e.getFloat32(),n[3*a+1]=e.getFloat32(),n[3*a+2]=e.getFloat32();o={...o,indices:i,isLocals:s,velocities:r,torques:n}}break;default:throw new Error(`Unknown morph type: ${a}`)}s.push(o)}return s}static _ParseDisplayFrames(e,t){const i=e.getInt32(),s=[];for(let r=0;r<i;++r){const i=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),n=1===e.getUint8(),a=e.getInt32(),o=[];for(let i=0;i<a;++i){const i=e.getUint8(),s={type:i,index:i===wa.DisplayFrame.FrameData.FrameType.Bone?t.getBoneIndex(e):t.getMorphIndex(e)};o.push(s)}const l={name:i,englishName:r,isSpecialFrame:n,frames:o};s.push(l)}return s}static _ParseRigidBodies(e,t){const i=e.getInt32(),s=[];for(let r=0;r<i;++r){const i={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),boneIndex:t.getBoneIndex(e),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};s.push(i)}return s}static _ParseJoints(e,t){const i=e.getInt32(),s=[];for(let r=0;r<i;++r){const i={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),type:e.getUint8(),rigidbodyIndexA:t.getRigidBodyIndex(e),rigidbodyIndexB:t.getRigidBodyIndex(e),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};s.push(i)}return s}static _ParseSoftBodies(e,t,i){const s=e.getInt32(),r=[];for(let n=0;n<s;++n){const s=e.getDecoderString(e.getInt32(),!1),n=e.getDecoderString(e.getInt32(),!1),a=e.getUint8(),o=t.getMaterialIndex(e),l=e.getUint8(),h=e.getUint16(),c=e.getUint8(),u=e.getInt32(),d=e.getInt32(),_=e.getFloat32(),p=e.getFloat32(),f=e.getInt32(),m={vcf:e.getFloat32(),dp:e.getFloat32(),dg:e.getFloat32(),lf:e.getFloat32(),pr:e.getFloat32(),vc:e.getFloat32(),df:e.getFloat32(),mt:e.getFloat32(),chr:e.getFloat32(),khr:e.getFloat32(),shr:e.getFloat32(),ahr:e.getFloat32()},g={srhrCl:e.getFloat32(),skhrCl:e.getFloat32(),sshrCl:e.getFloat32(),srSpltCl:e.getFloat32(),skSpltCl:e.getFloat32(),ssSpltCl:e.getFloat32()},v={vIt:e.getInt32(),pIt:e.getInt32(),dIt:e.getInt32(),cIt:e.getInt32()},b={lst:e.getInt32(),ast:e.getInt32(),vst:e.getInt32()},x=e.getInt32(),S=[];for(let i=0;i<x;++i){const i={rigidbodyIndex:t.getRigidBodyIndex(e),vertexIndex:t.getVertexIndex(e),isNearMode:0!==e.getUint8()};S.push(i)}const T=e.getInt32(),y=new ArrayBuffer(T*i.vertexIndexSize);let C;switch(i.vertexIndexSize){case 1:C=new Uint8Array(y);break;case 2:C=new Uint16Array(y);break;case 4:C=new Int32Array(y);break;default:throw new Error(`Invalid vertexIndexSize: ${i.vertexIndexSize}`)}for(let i=0;i<T;++i)C[i]=t.getVertexIndex(e);const P={name:s,englishName:n,type:a,materialIndex:o,collisionGroup:l,collisionMask:h,flags:c,bLinkDistance:u,clusterCount:d,totalMass:_,collisionMargin:p,aeroModel:f,config:m,cluster:g,iteration:v,material:b,anchors:S,vertexPins:C};r.push(P)}return r}}class to extends Wa{referenceFiles;constructor(e,t,i={},s){super(e,t,i,s),this.referenceFiles=i.referenceFiles??s?.referenceFiles??[]}loadFile(e,t,i,s,r,n,a){const o=this.materialBuilder,l=this.useSdef,h=this.buildSkeleton,c=this.buildMorph,u=this.boundingBoxMargin,d=this.referenceFiles,_=this.preserveSerializationData;return e._loadFile(t,((e,i)=>{const r={arrayBuffer:e,pmFileId:t instanceof File?Xa.GetId(t).toString():t,materialBuilder:o,useSdef:l,buildSkeleton:h,buildMorph:c,boundingBoxMargin:u,referenceFiles:d,preserveSerializationData:_};s(r,i)}),r,!0,n,a)}_getProgressTaskCosts(e,t){const i=super._getProgressTaskCosts(e,t);if(i.push({name:"Build Geometry",cost:t.indices.length}),e.buildMorph){let e=0;const s=t.morphs;for(let t=0;t<s.length;++t){const i=s[t];i.type!==wa.Morph.Type.VertexMorph&&i.type!==wa.Morph.Type.UvMorph&&i.type!==wa.Morph.Type.AdditionalUvMorph1&&i.type!==wa.Morph.Type.AdditionalUvMorph2&&i.type!==wa.Morph.Type.AdditionalUvMorph3&&i.type!==wa.Morph.Type.AdditionalUvMorph4||(e+=i.indices.length)}i.push({name:"Build Morph",cost:e})}return i}async _buildGeometryAsync(e,t,i,s,r,n){const a=[],o=[];let l;const h=[];{l=t.indices instanceof Uint8Array||t.indices instanceof Uint16Array?new Uint16Array(t.indices.length):new Uint32Array(t.indices.length);{const e=t.indices;for(let t=0;t<l.length;t+=3)l[t+0]=e[t+0],l[t+1]=e[t+2],l[t+2]=e[t+1]}const c=t.materials;let u=0;for(let d=0;d<c.length;++d){const _=c[d],p=new Uint8Array(t.vertices.length);let f=0;{const e=_.indexCount;for(let t=0;t<e;++t){const e=l[u+t];0===p[e]&&(p[e]=1,f+=1)}p.fill(0)}const m=new at,g=[];if(e.preserveSerializationData)for(let e=0;e<t.header.additionalVec4Count;++e)g.push(new Float32Array(4*f));let v=null,b=null,x=null,S=null,T=null;e.buildSkeleton&&e.useSdef&&(v=new Float32Array(3*f),b=new Float32Array(3*f),x=new Float32Array(3*f),S=new Float32Array(3*f),T=new Float32Array(3*f));let y=!1,C=null;e.preserveSerializationData&&(C=new Float32Array(f));const P=new t.indices.constructor(t.vertices.length);{const i=new Float32Array(3*f),s=new Float32Array(3*f),r=new Float32Array(2*f),a=new l.constructor(_.indexCount);let o=null,h=null;e.buildSkeleton&&(o=new Float32Array(4*f),h=new Float32Array(4*f));let c=performance.now(),d=0,E=0;const A=_.indexCount;for(let _=0;_<A;++_){const f=l[u+_];if(0===p[f]){p[f]=1;const n=t.vertices[f];i[3*d+0]=n.position[0],i[3*d+1]=n.position[1],i[3*d+2]=n.position[2],s[3*d+0]=n.normal[0],s[3*d+1]=n.normal[1],s[3*d+2]=n.normal[2],r[2*d+0]=n.uv[0],r[2*d+1]=1-n.uv[1];const l=n.additionalVec4;for(let e=0;e<g.length;++e)g[e][4*d+0]=l[e][0],g[e][4*d+1]=l[e][1],g[e][4*d+2]=l[e][2],g[e][4*d+3]=l[e][3];if(e.buildSkeleton)switch(n.weightType){case wa.Vertex.BoneWeightType.Bdef1:{const e=n.boneWeight;o[4*d+0]=e.boneIndices,o[4*d+1]=0,o[4*d+2]=0,o[4*d+3]=0,h[4*d+0]=1,h[4*d+1]=0,h[4*d+2]=0,h[4*d+3]=0}break;case wa.Vertex.BoneWeightType.Bdef2:{const e=n.boneWeight;o[4*d+0]=e.boneIndices[0],o[4*d+1]=e.boneIndices[1],o[4*d+2]=0,o[4*d+3]=0,h[4*d+0]=e.boneWeights,h[4*d+1]=1-e.boneWeights,h[4*d+2]=0,h[4*d+3]=0}break;case wa.Vertex.BoneWeightType.Bdef4:case wa.Vertex.BoneWeightType.Qdef:{const e=n.boneWeight;o[4*d+0]=e.boneIndices[0],o[4*d+1]=e.boneIndices[1],o[4*d+2]=e.boneIndices[2],o[4*d+3]=e.boneIndices[3],h[4*d+0]=e.boneWeights[0],h[4*d+1]=e.boneWeights[1],h[4*d+2]=e.boneWeights[2],h[4*d+3]=e.boneWeights[3]}break;case wa.Vertex.BoneWeightType.Sdef:{const t=n.boneWeight;o[4*d+0]=t.boneIndices[0],o[4*d+1]=t.boneIndices[1],o[4*d+2]=0,o[4*d+3]=0;const i=t.boneWeights,s=i.boneWeight0,r=1-s;if(h[4*d+0]=s,h[4*d+1]=r,h[4*d+2]=0,h[4*d+3]=0,e.useSdef){const e=i.c[0],t=i.c[1],n=i.c[2];let a=i.r0[0],o=i.r0[1],l=i.r0[2],h=i.r1[0],c=i.r1[1],u=i.r1[2];b[3*d+0]=a,b[3*d+1]=o,b[3*d+2]=l,x[3*d+0]=h,x[3*d+1]=c,x[3*d+2]=u;const _=a*s+h*r,p=o*s+c*r,f=l*s+u*r;a=e+a-_,o=t+o-p,l=n+l-f,h=e+h-_,c=t+c-p,u=n+u-f;const m=.5*(e+a),g=.5*(t+o),C=.5*(n+l),P=.5*(e+h),E=.5*(t+c),A=.5*(n+u);v[3*d+0]=e,v[3*d+1]=t,v[3*d+2]=n,S[3*d+0]=m,S[3*d+1]=g,S[3*d+2]=C,T[3*d+0]=P,T[3*d+1]=E,T[3*d+2]=A,y=!0}}}e.preserveSerializationData&&(C[d]=n.edgeScale),a[E]=d,P[f]=d,E+=1,d+=1}else a[E]=P[f],E+=1;(u+_)%1e4==0&&100<performance.now()-c&&(n.setTaskProgress("Build Geometry",u+_),n.invokeProgressEvent(),await ee.S0.DelayAsync(0),c=performance.now())}m.positions=i,m.normals=s,m.uvs=r,m.indices=a,m.matricesIndices=o,m.matricesWeights=h}s._blockEntityCollection=!!r;const E=new(e.useSdef&&y?Ka:At)(_.name,s);E._parentContainer=r,s._blockEntityCollection=!1,E.setParent(i),a.push(E),s._blockEntityCollection=!!r;const A=new ct(t.header.modelName,s,m,!1);A._parentContainer=r,s._blockEntityCollection=!1,e.preserveSerializationData&&(1<=g.length&&A.setVerticesData(va.V.AdditionalUV1Kind,g[0],!1,4),2<=g.length&&A.setVerticesData(va.V.AdditionalUV2Kind,g[1],!1,4),3<=g.length&&A.setVerticesData(va.V.AdditionalUV3Kind,g[2],!1,4),4<=g.length&&A.setVerticesData(va.V.AdditionalUV4Kind,g[3],!1,4)),e.useSdef&&y&&(A.setVerticesData(va.V.MatricesSdefCKind,v,!1,3),A.setVerticesData(va.V.MatricesSdefR0Kind,b,!1,3),A.setVerticesData(va.V.MatricesSdefR1Kind,x,!1,3),A.setVerticesData(va.V.MatricesSdefRW0Kind,S,!1,3),A.setVerticesData(va.V.MatricesSdefRW1Kind,T,!1,3)),e.preserveSerializationData&&A.setVerticesData(va.V.EdgeScaleKind,C,!1,1),A.applyToMesh(E),o.push(A),h.push({map:P,isReferencedVertex:p}),u+=_.indexCount}}return n.endTask("Build Geometry"),n.invokeProgressEvent(),{meshes:a,geometries:o,indices:l,indexToSubmehIndexMaps:h}}async _buildMaterialAsync(e,t,i,s,r,n,a,o,l){let h;const c=new Array(t.textures.length);for(let e=0;e<c.length;++e)c[e]={noMipmap:!1,invertY:!0,samplingMode:void 0,imagePathIndex:e};const u=[];for(let e=0;e<s.length;++e)u.push([s[e]]);const d=new Promise((d=>{h=e.materialBuilder.buildMaterials(i.uniqueId,t.materials,c,t.textures,o,"file:"+e.pmFileId+"_",e.referenceFiles,u,s,n,a,r,this,(e=>{e.lengthComputable&&(l.setTaskProgressRatio("Texture Load",e.loaded/e.total,!0),l.invokeProgressEvent())}),(()=>d()))})),_=Array.isArray(h)?h:await h;for(let e=0;e<_.length;++e)s[e].material=_[e];return l.endTask("Build Material"),l.invokeProgressEvent(),{materials:_,multiMaterials:[],textureLoadPromise:d}}async _buildMorphAsync(e,t,i,s,r,n,a){const o=e.preserveSerializationData,l=new Int32Array(t.vertices.length).fill(-1),h=new Map,c=i.indices;{const e=t.materials;let i=0;for(let t=0;t<e.length;++t){const s=e[t].indexCount;for(let e=0;e<s;++e){const s=c[i+e];if(-1===l[s])l[s]=t;else if(-2===l[s]){const e=h.get(s);e.includes(t)||e.push(t)}else l[s]!==t&&(h.set(s,[l[s],t]),l[s]=-2)}i+=s}}const u=i.indexToSubmehIndexMaps,d=t.morphs,_=i.geometries,p=new Array(_.length);for(let e=0;e<p.length;++e)p[e]=[];let f=0,m=performance.now();for(let e=0;e<d.length;++e){const t=d[e],i=[],r=[];switch(t.type){case wa.Morph.Type.GroupMorph:case wa.Morph.Type.BoneMorph:case wa.Morph.Type.MaterialMorph:n.push(t);break;case wa.Morph.Type.VertexMorph:case wa.Morph.Type.UvMorph:case wa.Morph.Type.AdditionalUvMorph1:case wa.Morph.Type.AdditionalUvMorph2:case wa.Morph.Type.AdditionalUvMorph3:case wa.Morph.Type.AdditionalUvMorph4:n.push({name:t.name,englishName:t.englishName,category:t.category,type:t.type,morphTargets:i,...o?{elements:r}:void 0});break;default:this.warn(`Unsupported morph type: ${t.type}`)}if(t.type!==wa.Morph.Type.VertexMorph&&t.type!==wa.Morph.Type.UvMorph&&t.type!==wa.Morph.Type.AdditionalUvMorph1&&t.type!==wa.Morph.Type.AdditionalUvMorph2&&t.type!==wa.Morph.Type.AdditionalUvMorph3&&t.type!==wa.Morph.Type.AdditionalUvMorph4)continue;const c=[];{const e=t.indices;for(let t=0;t<e.length;++t){const i=e[t],s=l[i];if(-1!==s)if(-2===s){const e=h.get(i);for(let t=0;t<e.length;++t){const i=e[t];c.includes(i)||c.push(i)}}else c.includes(s)||c.push(s)}if(t.type!==wa.Morph.Type.AdditionalUvMorph1&&t.type!==wa.Morph.Type.AdditionalUvMorph2&&t.type!==wa.Morph.Type.AdditionalUvMorph3&&t.type!==wa.Morph.Type.AdditionalUvMorph4)for(let e=0;e<c.length;++e){const r=new fa(t.name,0,s);i.push(r),p[c[e]].push(r)}}if(t.type===wa.Morph.Type.VertexMorph)for(let e=0;e<c.length;++e){const s=c[e],n=_[s],a=new Float32Array(n.getVerticesData(O.R.PositionKind)),l=t.indices,h=t.positions,d=u[s].map,p=u[s].isReferencedVertex;if(o){let e=0;for(let t=0;t<l.length;++t){if(0===p[l[t]])continue;const i=d[l[t]];a[3*i+0]+=h[3*t+0],a[3*i+1]+=h[3*t+1],a[3*i+2]+=h[3*t+2],e+=1}const t=new Int32Array(e),i=new Float32Array(3*e);for(let e=0,s=0;e<l.length;++e){if(0===p[l[e]])continue;const r=d[l[e]];t[s]=r,i[3*s+0]=h[3*e+0],i[3*s+1]=h[3*e+1],i[3*s+2]=h[3*e+2],s+=1}r.push({meshIndex:s,indices:t,offsets:i})}else for(let e=0;e<l.length;++e){if(0===p[l[e]])continue;const t=d[l[e]];a[3*t+0]+=h[3*e+0],a[3*t+1]+=h[3*e+1],a[3*t+2]+=h[3*e+2]}i[e].setPositions(a)}else if(t.type===wa.Morph.Type.UvMorph)for(let e=0;e<c.length;++e){const s=c[e],n=_[s],a=new Float32Array(n.getVerticesData(O.R.UVKind)),l=t.indices,h=t.offsets,d=u[s].map,p=u[s].isReferencedVertex;if(o){let e=0;for(let t=0;t<l.length;++t){if(0===p[l[t]])continue;const i=d[l[t]];a[2*i+0]+=h[4*t+0],a[2*i+1]-=h[4*t+1],e+=1}const t=new Int32Array(e),i=new Float32Array(4*e);for(let e=0,s=0;e<l.length;++e){if(0===p[l[e]])continue;const r=d[l[e]];t[s]=r,i[4*s+0]=h[4*e+0],i[4*s+1]=-h[4*e+1],i[4*s+2]=h[4*e+2],i[4*s+3]=h[4*e+3],s+=1}r.push({meshIndex:s,indices:t,offsets:i})}else for(let e=0;e<l.length;++e){if(0===p[l[e]])continue;const t=d[l[e]];a[2*t+0]+=h[4*e+0],a[2*t+1]-=h[4*e+1]}const f=i[e];f.setPositions(n.getVerticesData(O.R.PositionKind)),f.setUVs(a)}else if(o)for(let e=0;e<c.length;++e){const i=c[e],s=u[i].map,n=u[i].isReferencedVertex,a=t.indices,o=t.offsets;let l=0;for(let e=0;e<a.length;++e)0!==n[a[e]]&&(l+=1);const h=new Int32Array(l),d=new Float32Array(4*l);for(let e=0,t=0;e<a.length;++e){if(0===n[a[e]])continue;const i=s[a[e]];h[t]=i,d[4*t+0]=o[4*e+0],d[4*t+1]=o[4*e+1],d[4*t+2]=o[4*e+2],d[4*t+3]=o[4*e+3],t+=1}r.push({meshIndex:i,indices:h,offsets:d})}f+=t.indices.length,100<performance.now()-m&&(a.setTaskProgress("Build Morph",f),a.invokeProgressEvent(),await ee.S0.DelayAsync(0),m=performance.now())}a.endTask("Build Morph");const g=[],v=i.meshes;for(let e=0;e<p.length;++e){const t=p[e];if(0===t.length)continue;s._blockEntityCollection=!!r;const i=new ga(s);i._parentContainer=r,s._blockEntityCollection=!1,i.enableNormalMorphing=!1,i.enableTangentMorphing=!1,i.enableUVMorphing=!1,i.areUpdatesFrozen=!0;for(let e=0;e<t.length;++e){const s=t[e];i.addTarget(s),s.hasUVs&&(i.enableUVMorphing=!0)}if(i.enableUVMorphing){const i=_[e].getVerticesData(O.R.UVKind);for(let e=0;e<t.length;++e){const s=t[e];s.hasUVs||s.setUVs(i)}}i.areUpdatesFrozen=!1,g.push(i),v[e].morphTargetManager=i}return g}}const io={".pmx":{isBinary:!0}};class so extends to{constructor(e,t){super("pmx",io,e,t)}createPlugin(e){return new so(e.mmdmodel,this)}async _parseFileAsync(e){return await eo.ParseAsync(e,this).catch((e=>Promise.reject(e)))}}Ys(new so);var ro=r(4852),no=r(3376),ao=r(2461),oo=r(9711);class lo{static OverrideEngineCreateEffect(e){const t=e.createEffect.bind(e);e.createEffect=function(e,i,s,r,n,a,o,l,h,c=Na.w.GLSL,u){let d;if(d=i.attributes?i:{attributes:i,uniformsNames:s,uniformBuffersNames:[],samplers:r??[],defines:n??"",fallbacks:a??null,onCompiled:o??null,onError:l??null,indexParameters:h??null,shaderLanguage:c,extraInitializationsAsync:u},(d.uniformsNames.includes("mBones")||d.samplers.includes("boneSampler"))&&-1===d.defines.indexOf("#define SDEF")){d.attributes.push(va.V.MatricesSdefCKind),d.attributes.push(va.V.MatricesSdefRW0Kind),d.attributes.push(va.V.MatricesSdefRW1Kind),d.defines+="\n#define SDEF";const e=d.processCodeAfterIncludes;d.processCodeAfterIncludes=e?function(t,i){return i=e(t,i),lo.ProcessSdefCode(t,i)}:lo.ProcessSdefCode}return t(e,d,this)}}static ProcessSdefCode(e,t){if("vertex"!==e)return t;if(t.includes("finalWorld=finalWorld*influence;")){const e=t.includes("fn main"),i="#define CUSTOM_VERTEX_DEFINITIONS";if(t.includes(i))t=t.replace(i,`${i}\n${e?ao.B:ro.B}`);else{const i="void main() {";t=t.replace(i,`${e?ao.B:ro.B}\nvoid main() {`)}const s=new RegExp("finalWorld=finalWorld\\*influence;","g");t=t.replace(s,`${e?oo.Z:no.Z}\nfinalWorld=finalWorld*influence;`)}return t}}be.Z.prototype.getMmdOutlineRenderer=function(){return this._mmdOutlineRenderer||(this._mmdOutlineRenderer=new ho(this)),this._mmdOutlineRenderer};class ho{name="MmdOutline";scene;zOffset=4;zOffsetUnits=0;_engine;_passIdForDrawWrapper;constructor(e){this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=this._engine.createRenderPassId("Mmd Outline Renderer")}register(){this.scene._afterRenderingMeshStage.registerStep(fe.v.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){this._engine.releaseRenderPassId(this._passIdForDrawWrapper)}static _ViewMatrix=new Float32Array(9);static _InverseViewProjectionMatrix=new I.uq;render(e,t,i){i=i??this._passIdForDrawWrapper;const s=this.scene,r=s.getEngine(),n=r.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,n,i))return;const a=e.getMesh(),o=a._internalAbstractMeshDataInfo._actAsRegularMesh?a:null,l=e.getRenderingMesh(),h=o||l,c=e.getMaterial();if(!c||!s.activeCamera)return;const u=e._getDrawWrapper(i),d=Y.E.GetEffect(u);r.enableEffect(u),c.useLogarithmicDepth&&d.setFloat("logarithmicDepthConstant",2/(Math.log(s.activeCamera.maxZ+1)/Math.LN2)),d.setFloat("offset",c.outlineWidth),d.setColor4("color",c.outlineColor,c.outlineAlpha);const _=r.getRenderHeight(),p=r.getRenderWidth();d.setFloat2("viewport",p,_);const f=ho._ViewMatrix;{const e=s.getViewMatrix().m;f[0]=e[0],f[1]=e[1],f[2]=e[2],f[3]=e[4],f[4]=e[5],f[5]=e[6],f[6]=e[8],f[7]=e[9],f[8]=e[10]}d.setMatrix3x3("view",f),d.setMatrix("viewProjection",s.getTransformMatrix()),d.setMatrix("world",h.getWorldMatrix()),(0,$.f$)(l,d),(0,$.nR)(l,d),l.morphTargetManager&&l.morphTargetManager.isUsingTextureForTargets&&l.morphTargetManager._bind(d),n||l._bind(e,d,c.fillMode);const m=e.getMesh().bakedVertexAnimationManager;if(m&&m.isEnabled&&m.bind(d,n),c&&c.needAlphaTesting()){const e=c.getAlphaTestTexture();e&&(d.setTexture("diffuseSampler",e),d.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,q.gS)(d,c,s),d.defines.includes("WORLDPOS_REQUIRED")&&d.setMatrix("inverseViewProjection",s.getTransformMatrix().invertToRef(ho._InverseViewProjectionMatrix)),r.setZOffset(this.zOffset),r.setZOffsetUnits(this.zOffsetUnits),l._processRendering(h,e,d,c.fillMode,t,n,((e,t)=>{d.setMatrix("world",t)})),r.setZOffset(0),r.setZOffsetUnits(0)}isReady(e,t,i){i=i??this._passIdForDrawWrapper;const s=[],n=[O.R.PositionKind,O.R.NormalKind],a=e.getMesh(),o=e.getMaterial();if(!o)return!1;const l=a.getScene();o.needAlphaTesting()&&(s.push("#define ALPHATEST"),a.isVerticesDataPresent(O.R.UVKind)&&(n.push(O.R.UVKind),s.push("#define UV1")),a.isVerticesDataPresent(O.R.UV2Kind)&&(n.push(O.R.UV2Kind),s.push("#define UV2"))),o.useLogarithmicDepth&&s.push("#define LOGARITHMICDEPTH"),(0,q.tv)(o,l,s);let h=!1;for(let e=0;e<s.length;++e)if(s[e].includes("CLIPPLANE")){h=!0;break}h&&s.push("#define WORLDPOS_REQUIRED");const c=new K;if(a.useBones&&a.computeBonesUsingShaders&&a.skeleton){n.push(O.R.MatricesIndicesKind),n.push(O.R.MatricesWeightsKind),a.numBoneInfluencers>4&&(n.push(O.R.MatricesIndicesExtraKind),n.push(O.R.MatricesWeightsExtraKind)),a.isVerticesDataPresent(va.V.MatricesSdefCKind)&&(n.push(va.V.MatricesSdefCKind),n.push(va.V.MatricesSdefRW0Kind),n.push(va.V.MatricesSdefRW1Kind),s.push("#define SDEF"));const e=a.skeleton;s.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),a.numBoneInfluencers>0&&c.addCPUSkinningFallback(0,a),e.isUsingTextureForMatrices?s.push("#define BONETEXTURE"):s.push("#define BonesPerMesh "+(e.bones.length+1))}else s.push("#define NUM_BONE_INFLUENCERS 0");const u=a.morphTargetManager;let d=0;u&&(d=u.numMaxInfluencers||u.numInfluencers,d>0&&(s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+d),u.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),(0,$.MF)(n,a,d))),t&&(s.push("#define INSTANCES"),(0,$.te)(n),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES"));const _=a.bakedVertexAnimationManager;_&&_.isEnabled&&(s.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&n.push("bakedVertexAnimationSettingsInstanced"));const p=e._getDrawWrapper(i,!0),f=p.defines,m=s.join("\n");if(f!==m){const e=["world","mBones","viewport","view","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","boneTextureWidth","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"];(0,q.TV)(e),h&&e.push("inverseViewProjection");const i=l.getEngine().isWebGPU?Na.w.WGSL:Na.w.GLSL;p.setEffect(this.scene.getEngine().createEffect("mmdOutline",{attributes:n,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:m,fallbacks:c,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:d},processCodeAfterIncludes:lo.ProcessSdefCode,shaderLanguage:i,extraInitializationsAsync:async()=>{i===Na.w.WGSL?await Promise.all([r.e(4371).then(r.bind(r,4371)),r.e(5485).then(r.bind(r,5485))]):await Promise.all([r.e(6134).then(r.bind(r,6134)),r.e(8428).then(r.bind(r,8428))])}},this.scene.getEngine()),m)}return p.effect.isReady()}_afterRenderingMesh(e,t,i){const s=t.getMaterial();if(null!==s&&s.renderOutline){const e=this._engine,s=e.getDepthWrite(),r=e.getAlphaMode(),n=e.alphaState.alphaBlend;e.setDepthWrite(!0),e.setAlphaMode(Pa.Y.ALPHA_COMBINE,!0),e.setState(!0,void 0,void 0,void 0,!!this.scene._mirroredCameraPosition),this.render(t,i,this._passIdForDrawWrapper),e.setAlphaMode(r,!0),e.setDepthWrite(s),e.alphaState.alphaBlend=n}}}class co{name;boneTracks;movableBoneTracks;morphTracks;propertyTrack;cameraTrack;startFrame;endFrame;constructor(e,t,i,s,r,n){this.name=e,this.boneTracks=t,this.movableBoneTracks=i,this.morphTracks=s,this.propertyTrack=r,this.cameraTrack=n;let a=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;for(let e=0;e<t.length;++e){const i=t[e];a=Math.min(a,i.startFrame),o=Math.max(o,i.endFrame)}for(let e=0;e<i.length;++e){const t=i[e];a=Math.min(a,t.startFrame),o=Math.max(o,t.endFrame)}for(let e=0;e<s.length;++e){const t=s[e];a=Math.min(a,t.startFrame),o=Math.max(o,t.endFrame)}a=Math.min(a,r.startFrame),o=Math.max(o,r.endFrame),a=Math.min(a,n.startFrame),o=Math.max(o,n.endFrame),this.startFrame=a,this.endFrame=o}}function uo(e,t,i,s,r){let n=.5,a=n,o=1-a;const l=Math;let h,c,u;for(let i=0;i<15;++i){h=3*o*o*a,c=3*o*a*a,u=a*a*a;const i=h*e+c*t+u-r;if(l.abs(i)<1e-5)break;n*=.5,a+=i<0?n:-n,o=1-a}return h*i+c*s+u}class _o{_lastResults=new Map;_upperBoundFrameIndex(e,t){const i=t.frameNumbers;if(0===i.length)return 0;let s=this._lastResults.get(t);void 0===s&&(s=[Number.NEGATIVE_INFINITY,0],this._lastResults.set(t,s));const r=e-s[0];if(Math.abs(r)<6){let t=s[1];for(;0<t&&e<i[t-1];)t-=1;for(;t<i.length&&i[t]<=e;)t+=1;return s[0]=e,s[1]=t,t}{let t=0,r=i.length;for(;t<r;){const s=t+(r-t>>1);e<i[s]?r=s:t=s+1}return s[0]=e,s[1]=t,t}}}class po extends _o{animation;_camera;constructor(e,t){super(),this.animation=e.cameraTrack,this._camera=t}static _CameraPositionA=new I.Pq;static _CameraPositionB=new I.Pq;static _CameraRotationA=new I.Pq;static _CameraRotationB=new I.Pq;static _DegToRad=Math.PI/180;animate(e){const t=this.animation,i=this._camera;if(0===t.frameNumbers.length)return i.position.set(0,10,0),i.rotation.set(0,0,0),i.distance=-45,void(i.fov=Math.PI/180*30);const s=Math.max(t.startFrame,Math.min(t.endFrame,e)),r=this._upperBoundFrameIndex(s,t),n=r-1,a=t.frameNumbers[n],o=t.frameNumbers[r];if(void 0===o||a+1===o){const e=t.positions;i.position.set(e[3*n],e[3*n+1],e[3*n+2]);const s=t.rotations;i.rotation.set(s[3*n],s[3*n+1],s[3*n+2]),i.distance=t.distances[n],i.fov=t.fovs[n]*po._DegToRad}else{const e=(s-a)/(o-a),l=t.positions,h=t.positionInterpolations,c=po._CameraPositionA.set(l[3*n],l[3*n+1],l[3*n+2]),u=po._CameraPositionB.set(l[3*r],l[3*r+1],l[3*r+2]),d=uo(h[12*r]/127,h[12*r+1]/127,h[12*r+2]/127,h[12*r+3]/127,e),_=uo(h[12*r+4]/127,h[12*r+5]/127,h[12*r+6]/127,h[12*r+7]/127,e),p=uo(h[12*r+8]/127,h[12*r+9]/127,h[12*r+10]/127,h[12*r+11]/127,e);i.position.set(c.x+(u.x-c.x)*d,c.y+(u.y-c.y)*_,c.z+(u.z-c.z)*p);const f=t.rotations,m=t.rotationInterpolations,g=po._CameraRotationA.set(f[3*n],f[3*n+1],f[3*n+2]),v=po._CameraRotationB.set(f[3*r],f[3*r+1],f[3*r+2]),b=uo(m[4*r]/127,m[4*r+1]/127,m[4*r+2]/127,m[4*r+3]/127,e),x=1-b;i.rotation.set(g.x*x+v.x*b,g.y*x+v.y*b,g.z*x+v.z*b);const S=t.distances[n],T=t.distances[r],y=uo(t.distanceInterpolations[4*r]/127,t.distanceInterpolations[4*r+1]/127,t.distanceInterpolations[4*r+2]/127,t.distanceInterpolations[4*r+3]/127,e);i.distance=S+(T-S)*y;const C=t.fovs[n],P=t.fovs[r],E=uo(t.fovInterpolations[4*r]/127,t.fovInterpolations[4*r+1]/127,t.fovInterpolations[4*r+2]/127,t.fovInterpolations[4*r+3]/127,e);i.fov=(C+(P-C)*E)*po._DegToRad}}static Create(e,t){return new po(e,t)}}function fo(e,t,i,s){let r=!1,n=!1,a=!1;const o=new Set,l=t=>{const i=t.materialElements;for(let t=0;t<i.length;++t){const s=i[t];if(null!==s.textureColor&&!r){const t=s.index;if(-1===s.index){for(let t=0;t<e.length;++t)e[t].textureMultiplicativeColor;r=!0}else{const i=e[t];i.textureMultiplicativeColor,o.add(i.name)}}if(null!==s.sphereTextureColor&&!n){const t=s.index;if(-1===s.index){for(let t=0;t<e.length;++t)e[t].sphereTextureMultiplicativeColor;n=!0}else{const i=e[t];i.sphereTextureMultiplicativeColor,o.add(i.name)}}if(null!==s.toonTextureColor&&!a){const t=s.index;if(-1===s.index){for(let t=0;t<e.length;++t)e[t].toonTextureMultiplicativeColor;a=!0}else{const i=e[t];i.toonTextureMultiplicativeColor,o.add(i.name)}}}},h=new Uint8Array(t.morphs.length);for(let e=0;e<i.length;++e){const s=i[e];if(null!==s){for(let e=0;e<s.length;++e){const i=s[e];if(1===h[i])continue;h[i]=1;const r=t.morphs[i];switch(r.type){case wa.Morph.Type.GroupMorph:{const e=r.elements;for(let i=0;i<e.length;++i){const s=e[i];if(1===h[s])continue;h[s]=1;const r=t.morphs[s];void 0!==r&&r.type===wa.Morph.Type.MaterialMorph&&l(r)}}break;case wa.Morph.Type.MaterialMorph:l(r)}}if(r&&n&&a)break}}r||n||a?s?.log("All materials could be recompiled for morph animation"):0<o.size&&s?.log(`Materials ${Array.from(o).join(", ")} could be recompiled for morph animation`)}co.prototype.createRuntimeCameraAnimation=function(e){return po.Create(this,e)};class mo extends _o{animation;boneBindIndexMap;movableBoneBindIndexMap;_morphController;morphBindIndexMap;_meshes;ikSolverBindIndexMap;_ikSolverStates;_materialRecompileInduceInfo;constructor(e,t,i,s,r,n,a,o,l){super(),this.animation=e,this.boneBindIndexMap=t,this.movableBoneBindIndexMap=i,this._morphController=s,this.morphBindIndexMap=r,this._meshes=n,this.ikSolverBindIndexMap=a,this._ikSolverStates=o,this._materialRecompileInduceInfo=l}static _BonePositionA=new I.Pq;static _BonePositionB=new I.Pq;static _BonePosition=new I.Pq;static _BoneRotationA=new I.PT;static _BoneRotationB=new I.PT;animate(e){const t=this.animation,i=t.boneTracks;if(0<i.length){const t=this.boneBindIndexMap;for(let s=0;s<i.length;++s){const r=t[s];if(null===r)continue;const n=i[s];if(0===n.frameNumbers.length){r.setRotationQuaternion(mo._BoneRotationB.set(0,0,0,1),mt.$x.LOCAL);continue}const a=Math.max(n.startFrame,Math.min(n.endFrame,e)),o=this._upperBoundFrameIndex(a,n),l=o-1,h=n.frameNumbers[o];if(void 0===h){const e=n.rotations;r.setRotationQuaternion(mo._BoneRotationB.set(e[4*l],e[4*l+1],e[4*l+2],e[4*l+3]),mt.$x.LOCAL)}else{const e=n.frameNumbers[l],t=(a-e)/(h-e),i=n.rotations,s=n.rotationInterpolations,c=mo._BoneRotationA.set(i[4*l],i[4*l+1],i[4*l+2],i[4*l+3]),u=mo._BoneRotationB.set(i[4*o],i[4*o+1],i[4*o+2],i[4*o+3]),d=uo(s[4*o]/127,s[4*o+1]/127,s[4*o+2]/127,s[4*o+3]/127,t);I.PT.SlerpToRef(c,u,d,c),r.setRotationQuaternion(c,mt.$x.LOCAL)}}}const s=t.movableBoneTracks;if(0<s.length){const t=this.movableBoneBindIndexMap;for(let i=0;i<s.length;++i){const r=t[i];if(null===r)continue;const n=s[i];if(0===n.frameNumbers.length){r.getRestMatrix().getTranslationToRef(mo._BonePosition),r.position=mo._BonePosition,r.setRotationQuaternion(mo._BoneRotationB.set(0,0,0,1),mt.$x.LOCAL);continue}const a=Math.max(n.startFrame,Math.min(n.endFrame,e)),o=this._upperBoundFrameIndex(a,n),l=o-1,h=n.frameNumbers[o];if(void 0===h){const e=n.positions;r.getRestMatrix().getTranslationToRef(mo._BonePosition),r.position=mo._BonePosition.addInPlaceFromFloats(e[3*l],e[3*l+1],e[3*l+2]);const t=n.rotations;r.setRotationQuaternion(mo._BoneRotationB.set(t[4*l],t[4*l+1],t[4*l+2],t[4*l+3]),mt.$x.LOCAL)}else{const e=n.frameNumbers[l],t=(a-e)/(h-e),i=n.positions,s=n.positionInterpolations,c=mo._BonePositionA.set(i[3*l],i[3*l+1],i[3*l+2]),u=mo._BonePositionB.set(i[3*o],i[3*o+1],i[3*o+2]),d=uo(s[12*o]/127,s[12*o+1]/127,s[12*o+2]/127,s[12*o+3]/127,t),_=uo(s[12*o+4]/127,s[12*o+5]/127,s[12*o+6]/127,s[12*o+7]/127,t),p=uo(s[12*o+8]/127,s[12*o+9]/127,s[12*o+10]/127,s[12*o+11]/127,t);c.x+=(u.x-c.x)*d,c.y+=(u.y-c.y)*_,c.z+=(u.z-c.z)*p,r.getRestMatrix().getTranslationToRef(mo._BonePosition),r.position=mo._BonePosition.addInPlace(c);const f=n.rotations,m=n.rotationInterpolations,g=mo._BoneRotationA.set(f[4*l],f[4*l+1],f[4*l+2],f[4*l+3]),v=mo._BoneRotationB.set(f[4*o],f[4*o+1],f[4*o+2],f[4*o+3]),b=uo(m[4*o]/127,m[4*o+1]/127,m[4*o+2]/127,m[4*o+3]/127,t);I.PT.SlerpToRef(g,v,b,g),r.setRotationQuaternion(g,mt.$x.LOCAL)}}}const r=t.morphTracks;if(0<r.length){const t=this._morphController,i=this.morphBindIndexMap;for(let s=0;s<r.length;++s){const n=i[s];if(null===n)continue;const a=r[s];if(0===a.frameNumbers.length){for(let e=0;e<n.length;++e)t.setMorphWeightFromIndex(n[e],0);continue}const o=Math.max(a.startFrame,Math.min(a.endFrame,e)),l=this._upperBoundFrameIndex(o,a),h=l-1,c=a.frameNumbers[l];if(void 0===c){const e=a.weights[h];for(let i=0;i<n.length;++i)t.setMorphWeightFromIndex(n[i],e)}else{const e=a.frameNumbers[h],i=(o-e)/(c-e),s=a.weights[h],r=s+(a.weights[l]-s)*i;for(let e=0;e<n.length;++e)t.setMorphWeightFromIndex(n[e],r)}}}if(0<t.propertyTrack.frameNumbers.length){const i=t.propertyTrack,s=Math.max(i.startFrame,Math.min(i.endFrame,e)),r=this._upperBoundFrameIndex(s,i)-1,n=i.visibles[r],a=this._meshes;for(let e=0;e<a.length;++e)a[e].visibility=n;const o=this._ikSolverStates.ikSolverStates,l=this.ikSolverBindIndexMap;for(let e=0;e<l.length;++e){const t=l[e];if(-1===t)continue;const s=i.getIkState(e);o[t]=s[r]}}}induceMaterialRecompile(e,t){null!==this._materialRecompileInduceInfo&&(mo.InduceMaterialRecompile(this._materialRecompileInduceInfo,this._morphController,this.morphBindIndexMap,t),e&&function(e,t){const i=e.morphTargetManagers,s=new Array(i.length),r=new Array(i.length);for(let e=0;e<i.length;++e){const t=s[e]=new Set,n=r[e]=new Set,a=i[e],o=a.numTargets;for(let e=0;e<o;++e){const i=a.getTarget(e);t.add(i),0!==i.influence&&n.add(i)}}{const t=e.morphs;for(let e=0;e<t.length;++e){const i=t[e];switch(i.type){case wa.Morph.Type.VertexMorph:case wa.Morph.Type.UvMorph:{const e=i.elements;for(let t=0;t<e.length;++t){const i=e[t];for(let e=0;e<r.length;++e)r[e].delete(i)}}}}}const n=e=>{const t=e.elements;for(let e=0;e<t.length;++e){const n=t[e];for(let e=0;e<i.length;++e)s[e].has(n)&&r[e].add(n)}},a=new Uint8Array(e.morphs.length);for(let i=0;i<t.length;++i){const s=t[i];if(null!==s)for(let t=0;t<s.length;++t){const i=s[t];if(1===a[i])continue;a[i]=1;const r=e.morphs[i];switch(r.type){case wa.Morph.Type.GroupMorph:{const t=r.elements;for(let i=0;i<t.length;++i){const s=t[i];if(1===a[s])continue;a[s]=1;const r=e.morphs[s];if(void 0!==r)switch(r.type){case wa.Morph.Type.VertexMorph:case wa.Morph.Type.UvMorph:n(r)}}}break;case wa.Morph.Type.VertexMorph:case wa.Morph.Type.UvMorph:n(r)}}}for(let e=0;e<i.length;++e)i[e].numMaxInfluencers=r[e].size}(this._morphController,this.morphBindIndexMap),this._materialRecompileInduceInfo=null)}static Create(e,t,i,s){const r=t.skeleton.bones,n=new Map;if(void 0===i)for(let e=0;e<r.length;++e)n.set(r[e].name,e);else for(let e=0;e<r.length;++e)n.set(i[r[e].name]??r[e].name,e);const a=new Array(e.boneTracks.length),o=e.boneTracks;for(let e=0;e<o.length;++e){const t=o[e],i=n.get(t.name);void 0===i?(s?.warn(`Binding failed: bone ${t.name} not found`),a[e]=null):a[e]=r[i]}const l=new Array(e.movableBoneTracks.length),h=e.movableBoneTracks;for(let e=0;e<h.length;++e){const t=h[e],i=n.get(t.name);void 0===i?(s?.warn(`Binding failed: bone ${t.name} not found`),l[e]=null):l[e]=r[i]}const c=t.morph,u=new Array(e.morphTracks.length),d=e.morphTracks;for(let e=0;e<d.length;++e){const t=d[e],r=i?.[t.name]??t.name,n=c.getMorphIndices(r);void 0===n?(s?.warn(`Binding failed: morph ${r} not found`),u[e]=null):u[e]=n}const _=t.runtimeBones,p=new Int32Array(e.propertyTrack.ikBoneNames.length),f=e.propertyTrack.ikBoneNames;for(let e=0;e<f.length;++e){const t=f[e],i=n.get(t);if(void 0===i)s?.warn(`Binding failed: IK bone ${t} not found`),p[e]=-1;else{const r=_[i].ikSolverIndex;-1===r?(s?.warn(`Binding failed: IK solver for bone ${t} not found`),p[e]=-1):p[e]=r}}return new mo(e,a,l,c,u,t.mesh.metadata.meshes,p,t,t.mesh.metadata.materials)}static InduceMaterialRecompile=fo}co.prototype.createRuntimeModelAnimation=function(e,t,i){return mo.Create(this,e,t,i)},be.Z.prototype.enableDepthRenderer=function(e,t=!1,i=!1,s=3,r=!1){if(!(e=e||this.activeCamera))throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[e.id]){const n=!!this.getEngine().getCaps().textureFloatRender;let a=0;a=!this.getEngine().getCaps().textureHalfFloatRender||i&&n?n?1:0:2,this._depthRenderer[e.id]=new re(this,a,e,t,s,r)}return this._depthRenderer[e.id]},be.Z.prototype.disableDepthRenderer=function(e){(e=e||this.activeCamera)&&this._depthRenderer&&this._depthRenderer[e.id]&&this._depthRenderer[e.id].dispose()};class go{constructor(e){this.name=fe.v.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(fe.v.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(fe.v.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}re._SceneComponentInitialization=e=>{let t=e._getComponent(fe.v.NAME_DEPTHRENDERER);t||(t=new go(e),e._addComponent(t))};class vo{get camera(){return this._effectLayerOptions.camera}get renderingGroupId(){return this._effectLayerOptions.renderingGroupId}set renderingGroupId(e){this._effectLayerOptions.renderingGroupId=e}get mainTexture(){return this._mainTexture}get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){if(this._mainTexture.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){const s=e[i];t?this._materialForRendering[s.uniqueId]=[s,t]:delete this._materialForRendering[s.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}getEffectIntensity(e){return this._effectIntensity[e.uniqueId]??1}setEffectIntensity(e,t){this._effectIntensity[e.uniqueId]=t}constructor(e,i,s=!1){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new M.ov},this._effectIntensity={},this.neutralColor=new M.ov,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new C.cP,this.onBeforeRenderMainTextureObservable=new C.cP,this.onBeforeComposeObservable=new C.cP,this.onBeforeRenderMeshToEffect=new C.cP,this.onAfterRenderMeshToEffect=new C.cP,this.onAfterComposeObservable=new C.cP,this.onSizeChangedObservable=new C.cP,this._shaderLanguage=0,this._materialForRendering={},this._shadersLoaded=!1,this.name=e,this._scene=i||t.q.LastCreatedScene,vo._SceneComponentInitialization(this._scene),!this._scene.getEngine().isWebGPU||s||vo.ForceGLSL||(this._shaderLanguage=1),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}_numInternalDraws(){return 1}_init(e){this._effectLayerOptions={mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,generateStencilBuffer:!1,...e},this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses()}_generateIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);const t=new O.R(this._engine,e,O.R.PositionKind,!1,!1,2);this._vertexBuffers[O.R.PositionKind]=t}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?(0,c.R)(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?(0,c.R)(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new H.$("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,this._effectLayerOptions.mainTextureType,!1,G.g.TRILINEAR_SAMPLINGMODE,!0,this._effectLayerOptions.generateStencilBuffer),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=G.g.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=G.g.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(G.g.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0;for(const e in this._materialForRendering){const[t,i]=this._materialForRendering[e];this._mainTexture.setMaterialForRendering(t,i)}if(this._mainTexture.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],s=i.getMaterial(),r=i.getRenderingMesh();if(!s)continue;const n=r._getInstancesRenderList(i._id,!!i.getReplacementMesh()).hardwareInstancedRendering[i._id]||r.hasThinInstances;if(this._setEmissiveTextureAndColor(r,i,s),!this._isReady(i,n,this._emissiveTextureAndColor.texture))return!1}return!0},this._mainTexture.customRenderFunction=(e,t,i,s)=>{let r;this.onBeforeRenderMainTextureObservable.notifyObservers(this);const n=this._scene.getEngine();if(s.length){for(n.setColorWrite(!1),r=0;r<s.length;r++)this._renderSubMesh(s.data[r]);n.setColorWrite(!0)}for(r=0;r<e.length;r++)this._renderSubMesh(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMesh(t.data[r]);const a=n.getAlphaMode();for(r=0;r<i.length;r++){const e=i.data[r],t=e.getMaterial();if(t&&t.needDepthPrePass){const i=t.getScene().getEngine();i.setColorWrite(!1),this._renderSubMesh(e),i.setColorWrite(!0)}this._renderSubMesh(e,!0)}n.setAlphaMode(a)},this._mainTexture.onClearObservable.add((e=>{e.clear(this.neutralColor,!0,!0,!0)})),this._scene.getBoundingBoxRenderer){const e=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add((()=>{this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&e})),this._mainTexture.onAfterUnbindObservable.add((()=>{this._scene.getBoundingBoxRenderer().enabled=e}))}}_addCustomEffectDefines(e){}_isReady(e,t,i){const s=this._scene.getEngine(),r=e.getMesh(),n=r._internalAbstractMeshDataInfo._materialForRenderPass?.[s.currentRenderPassId];if(n)return n.isReadyForSubMesh(r,e,t);const a=e.getMaterial();if(!a)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return a.isReadyForSubMesh(e.getMesh(),e,t);const o=[],l=[O.R.PositionKind];let h=!1,c=!1;if(a){const e=a.needAlphaTesting(),t=a.getAlphaTestTexture(),i=t&&t.hasAlpha&&(a.useAlphaFromDiffuseTexture||a._useAlphaFromAlbedoTexture);t&&(e||i)&&(o.push("#define DIFFUSE"),r.isVerticesDataPresent(O.R.UV2Kind)&&1===t.coordinatesIndex?(o.push("#define DIFFUSEUV2"),c=!0):r.isVerticesDataPresent(O.R.UVKind)&&(o.push("#define DIFFUSEUV1"),h=!0),e&&(o.push("#define ALPHATEST"),o.push("#define ALPHATESTVALUE 0.4")),t.gammaSpace||o.push("#define DIFFUSE_ISLINEAR"));const s=a.opacityTexture;s&&(o.push("#define OPACITY"),r.isVerticesDataPresent(O.R.UV2Kind)&&1===s.coordinatesIndex?(o.push("#define OPACITYUV2"),c=!0):r.isVerticesDataPresent(O.R.UVKind)&&(o.push("#define OPACITYUV1"),h=!0))}i&&(o.push("#define EMISSIVE"),r.isVerticesDataPresent(O.R.UV2Kind)&&1===i.coordinatesIndex?(o.push("#define EMISSIVEUV2"),c=!0):r.isVerticesDataPresent(O.R.UVKind)&&(o.push("#define EMISSIVEUV1"),h=!0),i.gammaSpace||o.push("#define EMISSIVE_ISLINEAR")),r.useVertexColors&&r.isVerticesDataPresent(O.R.ColorKind)&&r.hasVertexAlpha&&a.transparencyMode!==Te.i.MATERIAL_OPAQUE&&(l.push(O.R.ColorKind),o.push("#define VERTEXALPHA")),h&&(l.push(O.R.UVKind),o.push("#define UV1")),c&&(l.push(O.R.UV2Kind),o.push("#define UV2"));const u=new K;if(r.useBones&&r.computeBonesUsingShaders){l.push(O.R.MatricesIndicesKind),l.push(O.R.MatricesWeightsKind),r.numBoneInfluencers>4&&(l.push(O.R.MatricesIndicesExtraKind),l.push(O.R.MatricesWeightsExtraKind)),o.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers);const e=r.skeleton;e&&e.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(e?e.bones.length+1:0)),r.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,r)}else o.push("#define NUM_BONE_INFLUENCERS 0");const d=r.morphTargetManager;let _=0;d&&(_=d.numMaxInfluencers||d.numInfluencers,_>0&&(o.push("#define MORPHTARGETS"),o.push("#define NUM_MORPH_INFLUENCERS "+_),d.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),(0,$.MF)(l,r,_))),t&&(o.push("#define INSTANCES"),(0,$.te)(l),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES")),(0,q.tv)(a,this._scene,o),this._addCustomEffectDefines(o);const p=e._getDrawWrapper(void 0,!0),f=p.defines,m=o.join("\n");if(f!==m){const e=["world","mBones","viewProjection","glowColor","morphTargetInfluences","morphTargetCount","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","glowIntensity"];(0,q.TV)(e),p.setEffect(this._engine.createEffect("glowMapGeneration",l,e,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],m,u,void 0,void 0,{maxSimultaneousMorphTargets:_},this._shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0}),m)}return p.effect.isReady()}async _importShadersAsync(){1===this._shaderLanguage?await Promise.all([Promise.resolve().then(r.bind(r,8267)),Promise.resolve().then(r.bind(r,9073))]):await Promise.all([Promise.resolve().then(r.bind(r,136)),Promise.resolve().then(r.bind(r,3234))])}render(){for(let e=0;e<this._postProcesses.length;e++)if(!this._postProcesses[e].isReady())return;const e=this._scene.getEngine(),t=this._numInternalDraws();let i=!0;for(let e=0;e<t;++e){let t=this._mergeDrawWrapper[e];t||(t=this._mergeDrawWrapper[e]=new Y.E(this._engine),t.setEffect(this._createMergeEffect())),i=i&&t.effect.isReady()}if(!i)return;this.onBeforeComposeObservable.notifyObservers(this);const s=e.getAlphaMode();for(let i=0;i<t;++i){const t=this._mergeDrawWrapper[i];e.enableEffect(t),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t.effect),e.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(t.effect,i)}e.setAlphaMode(s),this.onAfterComposeObservable.notifyObservers(this);const r=this._mainTexture.getSize();this._setMainTextureSize(),r.width===this._mainTextureDesiredSize.width&&r.height===this._mainTextureDesiredSize.height||0===this._mainTextureDesiredSize.width||0===this._mainTextureDesiredSize.height||(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}hasMesh(e){return-1===this.renderingGroupId||e.renderingGroupId===this.renderingGroupId}shouldRender(){return this.isEnabled&&this._shouldRender}_shouldRenderMesh(e){return!0}_canRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_shouldRenderEmissiveTextureForMesh(){return!0}_renderSubMesh(e,t=!1){if(!this.shouldRender())return;const i=e.getMaterial(),s=e.getMesh(),r=e.getReplacementMesh(),n=e.getRenderingMesh(),a=e.getEffectiveMesh(),o=this._scene,l=o.getEngine();if(a._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!i)return;if(!this._canRenderMesh(n,i))return;let h=i._getEffectiveOrientation(n);a._getWorldMatrixDeterminant()<0&&(h=h===Te.i.ClockWiseSideOrientation?Te.i.CounterClockWiseSideOrientation:Te.i.ClockWiseSideOrientation);const c=h===Te.i.ClockWiseSideOrientation;l.setState(i.backFaceCulling,i.zOffset,void 0,c,i.cullBackFaces,void 0,i.zOffsetUnits);const u=n._getInstancesRenderList(e._id,!!r);if(u.mustReturn)return;if(!this._shouldRenderMesh(n))return;const d=u.hardwareInstancedRendering[e._id]||n.hasThinInstances;if(this._setEmissiveTextureAndColor(n,e,i),this.onBeforeRenderMeshToEffect.notifyObservers(s),this._useMeshMaterial(n))n.render(e,t,r||void 0);else if(this._isReady(e,d,this._emissiveTextureAndColor.texture)){const s=a._internalAbstractMeshDataInfo._materialForRenderPass?.[l.currentRenderPassId];let r=e._getDrawWrapper();if(!r&&s&&(r=s._getDrawWrapper()),!r)return;const h=r.effect;if(l.enableEffect(r),d||n._bind(e,h,i.fillMode),s?s.bindForSubMesh(a.getWorldMatrix(),a,e):(h.setMatrix("viewProjection",o.getTransformMatrix()),h.setMatrix("world",a.getWorldMatrix()),h.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!s){const e=i.needAlphaTesting(),s=i.getAlphaTestTexture(),r=s&&s.hasAlpha&&(i.useAlphaFromDiffuseTexture||i._useAlphaFromAlbedoTexture);if(s&&(e||r)){h.setTexture("diffuseSampler",s);const e=s.getTextureMatrix();e&&h.setMatrix("diffuseMatrix",e)}const a=i.opacityTexture;if(a){h.setTexture("opacitySampler",a),h.setFloat("opacityIntensity",a.level);const e=a.getTextureMatrix();e&&h.setMatrix("opacityMatrix",e)}if(this._emissiveTextureAndColor.texture&&(h.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),h.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),n.useBones&&n.computeBonesUsingShaders&&n.skeleton){const e=n.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(n);if(!t)return;h.setTexture("boneSampler",t),h.setFloat("boneTextureWidth",4*(e.bones.length+1))}else h.setMatrices("mBones",e.getTransformMatrices(n))}(0,$.nR)(n,h),n.morphTargetManager&&n.morphTargetManager.isUsingTextureForTargets&&n.morphTargetManager._bind(h),t&&l.setAlphaMode(i.alphaMode),h.setFloat("glowIntensity",this.getEffectIntensity(n)),(0,q.gS)(h,i,o)}n._processRendering(a,e,h,i.fillMode,u,d,((e,t)=>h.setMatrix("world",t)))}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(s)}_useMeshMaterial(e){return!1}_rebuild(){const e=this._vertexBuffers[O.R.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){const e=this._vertexBuffers[O.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[O.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(const e of this._mergeDrawWrapper)e.dispose();this._mergeDrawWrapper=[],this._disposeTextureAndPostProcesses();const t=this._scene.effectLayers.indexOf(this,0);t>-1&&this._scene.effectLayers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return ee.S0.Instantiate(e.customType).Parse(e,t,i)}}vo.ForceGLSL=!1,vo._SceneComponentInitialization=e=>{throw(0,F.n)("EffectLayerSceneComponent")},(0,w.Cg)([(0,D.lK)()],vo.prototype,"name",void 0),(0,w.Cg)([(0,D.qK)()],vo.prototype,"neutralColor",void 0),(0,w.Cg)([(0,D.lK)()],vo.prototype,"isEnabled",void 0),(0,w.Cg)([(0,D.fW)()],vo.prototype,"camera",null),(0,w.Cg)([(0,D.lK)()],vo.prototype,"renderingGroupId",null),(0,w.Cg)([(0,D.lK)()],vo.prototype,"disableBoundingBoxesFromEffectLayer",void 0),ge(fe.v.NAME_EFFECTLAYER,((e,t,i,s)=>{if(e.effectLayers){i.effectLayers||(i.effectLayers=[]);for(let r=0;r<e.effectLayers.length;r++){const n=vo.Parse(e.effectLayers[r],t,s);i.effectLayers.push(n)}}})),be.Z.prototype.removeEffectLayer=function(e){const t=this.effectLayers.indexOf(e);return-1!==t&&this.effectLayers.splice(t,1),t},be.Z.prototype.addEffectLayer=function(e){this.effectLayers.push(e)};class bo{constructor(e){this.name=fe.v.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||t.q.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine())}register(){this.scene._isReadyForMeshStage.registerStep(fe.v.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(fe.v.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(fe.v.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(fe.v.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(fe.v.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(fe.v.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.addEffectLayer(e)}))}removeFromContainer(e,t){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.removeEffectLayer(e),t&&e.dispose()}))}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,s=this.scene.effectLayers;for(const r of s){if(!r.hasMesh(e))continue;const s=r._mainTexture;this._engine.currentRenderPassId=s.renderPassId;for(const s of e.subMeshes)if(!r.isReady(s,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const s of i)if(s.shouldRender()&&(!s.camera||s.camera.cameraRigMode===se.RIG_MODE_NONE&&e===s.camera||s.camera.cameraRigMode!==se.RIG_MODE_NONE&&s.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||s.needStencil();const e=s._mainTexture;e._shouldRender()&&(this.scene.incrementRenderId(),e.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const s=t[i];s.renderingGroupId===e&&s.shouldRender()&&s.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}vo._SceneComponentInitialization=e=>{let t=e._getComponent(fe.v.NAME_EFFECTLAYER);t||(t=new bo(e),e._addComponent(t))},be.Z.prototype.getGlowLayerByName=function(e){for(let t=0;t<this.effectLayers?.length;t++)if(this.effectLayers[t].name===e&&this.effectLayers[t].getEffectName()===xo.EffectName)return this.effectLayers[t];return null};class xo extends vo{set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;const t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}constructor(e,t,i){super(e,t),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this.neutralColor=new M.ov(0,0,0,1),this._options={mainTextureRatio:xo.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,generateStencilBuffer:!1,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType,generateStencilBuffer:this._options.generateStencilBuffer})}async _importShadersAsync(){1===this._shaderLanguage?await Promise.all([Promise.resolve().then(r.bind(r,2147)),Promise.resolve().then(r.bind(r,7101)),Promise.resolve().then(r.bind(r,2937))]):await Promise.all([Promise.resolve().then(r.bind(r,9858)),Promise.resolve().then(r.bind(r,1288)),Promise.resolve().then(r.bind(r,7094))]),await super._importShadersAsync()}getEffectName(){return xo.EffectName}_createMergeEffect(){let e="#define EMISSIVE \n";return this._options.ldrMerge&&(e+="#define LDR \n"),this._engine.createEffect("glowMapMerge",[O.R.PositionKind],["offset"],["textureSampler","textureSampler2"],e,void 0,void 0,void 0,void 0,this.shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0})}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?(0,c.R)(e,this._maxSize):e,t=this._engine.needPOTTextures?(0,c.R)(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture1=new H.$("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=G.g.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=G.g.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(G.g.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;const s=Math.floor(e/2),r=Math.floor(t/2);this._blurTexture2=new H.$("GlowLayerBlurRTT2",{width:s,height:r},this._scene,!1,!0,i),this._blurTexture2.wrapU=G.g.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=G.g.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(G.g.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2];const n=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new X("GlowLayerHBP1",new I.I9(1,0),n,{width:e,height:t},null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._verticalBlurPostprocess1=new X("GlowLayerVBP1",new I.I9(0,1),n,{width:e,height:t},null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2=new X("GlowLayerHBP2",new I.I9(1,0),n,{width:s,height:r},null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2.width=s,this._horizontalBlurPostprocess2.height=r,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._blurTexture1)})),this._verticalBlurPostprocess2=new X("GlowLayerVBP2",new I.I9(0,1),n,{width:s,height:r},null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add((()=>{const e=this._blurTexture1.renderTarget;if(e){this._scene.postProcessManager.directRender(this._postProcesses1,e,!0);const t=this._blurTexture2.renderTarget;t&&this._scene.postProcessManager.directRender(this._postProcesses2,t,!0),this._engine.unBindFramebuffer(t??e,!0)}})),this._postProcesses.map((e=>{e.autoClear=!1}))}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();if(!i||!s)return!1;const r=i.emissiveTexture;return super._isReady(e,t,r)}needStencil(){return!1}_canRenderMesh(e,t){return!0}_internalRender(e){e.setTexture("textureSampler",this._blurTexture1),e.setTexture("textureSampler2",this._blurTexture2),e.setFloat("offset",this._intensity);const t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(Te.i.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){let s=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(s=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector?this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color):i.emissiveColor?(s*=i.emissiveIntensity??1,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*s,i.emissiveColor.g*s,i.emissiveColor.b*s,i.alpha)):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){-1===this._includedOnlyMeshes.indexOf(e.uniqueId)&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){const t=this._includedOnlyMeshes.indexOf(e.uniqueId);-1!==t&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return!!super.hasMesh(e)&&(this._includedOnlyMeshes.length?-1!==this._includedOnlyMeshes.indexOf(e.uniqueId):!this._excludedMeshes.length||-1===this._excludedMeshes.indexOf(e.uniqueId))}_useMeshMaterial(e){return 0!=this._meshesUsingTheirOwnMaterials.length&&this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._mainTexture.renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))}unReferenceMeshFromUsingItsOwnMaterial(e){let t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;t>=0;)this._meshesUsingTheirOwnMaterials.splice(t,1),t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(this._mainTexture.renderPassId)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}getClassName(){return"GlowLayer"}serialize(){const e=N.p.Serialize(this);let t;if(e.customType="BABYLON.GlowLayer",e.includedMeshes=[],this._includedOnlyMeshes.length)for(t=0;t<this._includedOnlyMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._includedOnlyMeshes[t]);i&&e.includedMeshes.push(i.id)}if(e.excludedMeshes=[],this._excludedMeshes.length)for(t=0;t<this._excludedMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._excludedMeshes[t]);i&&e.excludedMeshes.push(i.id)}return e}static Parse(e,t,i){const s=N.p.Parse((()=>new xo(e.name,t,e.options)),e,t,i);let r;for(r=0;r<e.excludedMeshes.length;r++){const i=t.getMeshById(e.excludedMeshes[r]);i&&s.addExcludedMesh(i)}for(r=0;r<e.includedMeshes.length;r++){const i=t.getMeshById(e.includedMeshes[r]);i&&s.addIncludedOnlyMesh(i)}return s}}xo.EffectName="GlowLayer",xo.DefaultBlurKernelSize=32,xo.DefaultTextureRatio=.5,(0,w.Cg)([(0,D.lK)()],xo.prototype,"blurKernelSize",null),(0,w.Cg)([(0,D.lK)()],xo.prototype,"intensity",null),(0,w.Cg)([(0,D.lK)("options")],xo.prototype,"_options",void 0),(0,V.Y5)("BABYLON.GlowLayer",xo);var So,To,yo,Co,Po,Eo,Ao,Ro,Io,Mo=r(580);be.Z.prototype.getHighlightLayerByName=function(e){for(let t=0;t<this.effectLayers?.length;t++)if(this.effectLayers[t].name===e&&this.effectLayers[t].getEffectName()===wo.EffectName)return this.effectLayers[t];return null};class Oo extends W.w{constructor(e,t,i,s,r,n=G.g.BILINEAR_SAMPLINGMODE,a,o){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,s,r,n,a,o),this.direction=t,this.kernel=i,this.onApplyObservable.add((e=>{e.setFloat2("screenSize",this.width,this.height),e.setVector2("direction",this.direction),e.setFloat("blurWidth",this.kernel)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(r.bind(r,2937)))):t.push(Promise.resolve().then(r.bind(r,7094))),super._gatherImports(e,t)}}class wo extends vo{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i){super(e,t,void 0!==i&&!!i.forceGLSL),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new C.cP,this.onAfterBlurObservable=new C.cP,this._instanceGlowingMeshStencilReference=wo.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=wo.NeutralColor,this._engine.isStencilEnable||l.V.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options={mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,forceGLSL:!1,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType}),this._shouldRender=!1}async _importShadersAsync(){1===this._shaderLanguage?await Promise.all([Promise.resolve().then(r.bind(r,2147)),Promise.resolve().then(r.bind(r,7101)),Promise.resolve().then(r.bind(r,2937))]):await Promise.all([Promise.resolve().then(r.bind(r,9858)),Promise.resolve().then(r.bind(r,1288)),Promise.resolve().then(r.bind(r,7094))]),await super._importShadersAsync()}getEffectName(){return wo.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[O.R.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":void 0,void 0,void 0,void 0,void 0,this._shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0})}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?(0,c.R)(e,this._maxSize):e,t=this._engine.needPOTTextures?(0,c.R)(t,this._maxSize):t;let i=0;if(i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture=new H.$("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=G.g.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=G.g.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(G.g.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],2===this._options.alphaBlendingMode)this._downSamplePostprocess=new Mo.v("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._horizontalBlurPostprocess=new Oo("HighlightLayerHBP",new I.I9(1,0),this._options.blurHorizontalSize,1,null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._verticalBlurPostprocess=new Oo("HighlightLayerVBP",new I.I9(0,1),this._options.blurVerticalSize,1,null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess];else{this._horizontalBlurPostprocess=new X("HighlightLayerHBP",new I.I9(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i);const s=this._horizontalBlurPostprocess;s.width=e,s.height=t,s.externalTextureSamplerBinding=!0,s.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._verticalBlurPostprocess=new X("HighlightLayerVBP",new I.I9(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]}this._mainTexture.onAfterUnbindObservable.add((()=>{this.onBeforeBlurObservable.notifyObservers(this);const e=this._blurTexture.renderTarget;e&&(this._scene.postProcessManager.directRender(this._postProcesses,e,!0),this._engine.unBindFramebuffer(e,!0)),this.onAfterBlurObservable.notifyObservers(this)})),this._postProcesses.map((e=>{e.autoClear=!1}))}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();if(!i||!s||!this._meshes)return!1;let r=null;const n=this._meshes[s.uniqueId];return n&&n.glowEmissiveOnly&&i&&(r=i.emissiveTexture),super._isReady(e,t,r)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&0===t&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(Te.i.TriangleFillMode,0,6)),this.innerGlow&&1===t&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(Te.i.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return!!super.shouldRender()&&!!this._meshes}_shouldRenderMesh(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!super.hasMesh(e))}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){const s=this._meshes[e.uniqueId];s?this._emissiveTextureAndColor.color.set(s.color.r,s.color.g,s.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),s&&s.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){if(this._excludedMeshes&&!this._excludedMeshes[e.uniqueId]){const t={mesh:e,beforeBind:null,afterRender:null,stencilState:!1};t.beforeBind=e.onBeforeBindObservable.add((e=>{t.stencilState=e.getEngine().getStencilBuffer(),e.getEngine().setStencilBuffer(!1)})),t.afterRender=e.onAfterRenderObservable.add((e=>{e.getEngine().setStencilBuffer(t.stencilState)})),this._excludedMeshes[e.uniqueId]=t}}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!!this._meshes&&!!super.hasMesh(e)&&void 0!==this._meshes[e.uniqueId]&&null!==this._meshes[e.uniqueId]}addMesh(e,t,i=!1){if(!this._meshes)return;const s=this._meshes[e.uniqueId];s?s.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add((e=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]?this._defaultStencilReference(e):e.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))})),observerDefault:e.onAfterRenderObservable.add((e=>{this.isEnabled&&this._defaultStencilReference(e)})),glowEmissiveOnly:i},e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const e in this._meshes)if(this._meshes[e]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes)for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(wo.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){const e=N.p.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(const t in this._meshes){const i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(const t in this._excludedMeshes){const i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){const s=N.p.Parse((()=>new wo(e.name,t,e.options)),e,t,i);let r;for(r=0;r<e.excludedMeshes.length;r++){const i=t.getMeshById(e.excludedMeshes[r]);i&&s.addExcludedMesh(i)}for(r=0;r<e.meshes.length;r++){const i=e.meshes[r],n=t.getMeshById(i.meshId);n&&s.addMesh(n,M.v9.FromArray(i.color),i.glowEmissiveOnly)}return s}}wo.EffectName="HighlightLayer",wo.NeutralColor=new M.ov(0,0,0,0),wo.GlowingMeshStencilReference=2,wo.NormalMeshStencilReference=1,(0,w.Cg)([(0,D.lK)()],wo.prototype,"innerGlow",void 0),(0,w.Cg)([(0,D.lK)()],wo.prototype,"outerGlow",void 0),(0,w.Cg)([(0,D.lK)()],wo.prototype,"blurHorizontalSize",null),(0,w.Cg)([(0,D.lK)()],wo.prototype,"blurVerticalSize",null),(0,w.Cg)([(0,D.lK)("options")],wo.prototype,"_options",void 0),(0,V.Y5)("BABYLON.HighlightLayer",wo);class Do{constructor(e){this.name=fe.v.NAME_LAYER,this.scene=e||t.q.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine())}register(){this.scene._beforeCameraDrawStage.registerStep(fe.v.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(fe.v.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForegroundWithPostProcessing),this.scene._afterCameraPostProcessStage.registerStep(fe.v.STEP_AFTERCAMERAPOSTPROCESS_LAYER,this,this._drawCameraForegroundWithoutPostProcessing),this.scene._beforeRenderTargetDrawStage.registerStep(fe.v.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(fe.v.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForegroundWithPostProcessing),this.scene._afterRenderTargetPostProcessStage.registerStep(fe.v.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER,this,this._drawRenderTargetForegroundWithoutPostProcessing)}rebuild(){const e=this.scene.layers;for(const t of e)t._rebuild()}dispose(){const e=this.scene.layers;for(;e.length;)e[0].dispose()}_draw(e){const t=this.scene.layers;if(t.length){this._engine.setDepthBuffer(!1);for(const i of t)e(i)&&i.render();this._engine.setDepthBuffer(!0)}}_drawCameraPredicate(e,t,i,s){return!e.renderOnlyInRenderTargetTextures&&e.isBackground===t&&e.applyPostProcess===i&&!!(e.layerMask&s)}_drawCameraBackground(e){this._draw((t=>this._drawCameraPredicate(t,!0,!0,e.layerMask)))}_drawCameraForegroundWithPostProcessing(e){this._draw((t=>this._drawCameraPredicate(t,!1,!0,e.layerMask)))}_drawCameraForegroundWithoutPostProcessing(e){this._draw((t=>this._drawCameraPredicate(t,!1,!1,e.layerMask)))}_drawRenderTargetPredicate(e,t,i,s,r){return e.renderTargetTextures.length>0&&e.isBackground===t&&e.applyPostProcess===i&&e.renderTargetTextures.indexOf(r)>-1&&!!(e.layerMask&s)}_drawRenderTargetBackground(e){this._draw((t=>this._drawRenderTargetPredicate(t,!0,!0,this.scene.activeCamera.layerMask,e)))}_drawRenderTargetForegroundWithPostProcessing(e){this._draw((t=>this._drawRenderTargetPredicate(t,!1,!0,this.scene.activeCamera.layerMask,e)))}_drawRenderTargetForegroundWithoutPostProcessing(e){this._draw((t=>this._drawRenderTargetPredicate(t,!1,!1,this.scene.activeCamera.layerMask,e)))}addFromContainer(e){e.layers&&e.layers.forEach((e=>{this.scene.layers.push(e)}))}removeFromContainer(e,t=!1){e.layers&&e.layers.forEach((e=>{const i=this.scene.layers.indexOf(e);-1!==i&&this.scene.layers.splice(i,1),t&&e.dispose()}))}}class Fo{set applyPostProcess(e){this._applyPostProcess=e}get applyPostProcess(){return this.isBackground||this._applyPostProcess}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get shaderLanguage(){return this._shaderLanguage}constructor(e,i,s,r,n,a=!1){this.name=e,this._applyPostProcess=!0,this.scale=new I.I9(1,1),this.offset=new I.I9(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this.isEnabled=!0,this._vertexBuffers={},this.onDisposeObservable=new C.cP,this.onBeforeRenderObservable=new C.cP,this.onAfterRenderObservable=new C.cP,this._shaderLanguage=0,this._shadersLoaded=!1,this.texture=i?new G.g(i,s,!0):null,this.isBackground=void 0===r||r,this.color=void 0===n?new M.ov(1,1,1,1):n,this._scene=s||t.q.LastCreatedScene;const o=this._scene.getEngine();!o.isWebGPU||a||Fo.ForceGLSL||(this._shaderLanguage=1);let l=this._scene._getComponent(fe.v.NAME_LAYER);l||(l=new Do(this._scene),this._scene._addComponent(l)),this._scene.layers.push(this),this._drawWrapper=new Y.E(o);const h=[];h.push(1,1),h.push(-1,1),h.push(-1,-1),h.push(1,-1);const c=new O.R(o,h,O.R.PositionKind,!1,!1,2);this._vertexBuffers[O.R.PositionKind]=c,this._createIndexBuffer()}_createIndexBuffer(){const e=this._scene.getEngine(),t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[O.R.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}isReady(){const e=this._scene.getEngine();let t="";this.alphaTest&&(t="#define ALPHATEST"),this.texture&&!this.texture.gammaSpace&&(t+="\n#define LINEAR"),this._previousDefines!==t&&(this._previousDefines=t,this._drawWrapper.effect=e.createEffect("layer",[O.R.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],t,void 0,void 0,void 0,void 0,this._shaderLanguage,this._shadersLoaded?void 0:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(r.bind(r,6913)),Promise.resolve().then(r.bind(r,711))]):await Promise.all([Promise.resolve().then(r.bind(r,2614)),Promise.resolve().then(r.bind(r,5256))]),this._shadersLoaded=!0}));const i=this._drawWrapper.effect;return i?.isReady()&&(!this.texture||this.texture.isReady())}render(){if(!this.isEnabled)return;const e=this._scene.getEngine();if(!this.isReady())return;const t=this._drawWrapper.effect;this.onBeforeRenderObservable.notifyObservers(this),e.enableEffect(this._drawWrapper),e.setState(!1),this.texture&&(t.setTexture("textureSampler",this.texture),t.setMatrix("textureMatrix",this.texture.getTextureMatrix())),t.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),t.setVector2("offset",this.offset),t.setVector2("scale",this.scale),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t),this.alphaTest?e.drawElementsType(Te.i.TriangleFillMode,0,6):(e.setAlphaMode(this.alphaBlendingMode),e.drawElementsType(Te.i.TriangleFillMode,0,6),e.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this)}dispose(){const e=this._vertexBuffers[O.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[O.R.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];const t=this._scene.layers.indexOf(this);this._scene.layers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()}}Fo.ForceGLSL=!1,r(3234),r(136),r(9073),r(8267),r(9858),r(1288),r(7094),r(2147),r(7101),r(2937),r(5256),r(2614),r(711),r(6913),B.AddNodeConstructor("Light_Type_1",((e,t)=>()=>new No(e,I.Pq.Zero(),t)));class No extends Ln{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return z.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&I.uq.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const e=I.Pq.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let s=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let n=0;n<i.length;n++){const a=i[n];if(!a)continue;const o=a.getBoundingInfo().boundingBox;for(let i=0;i<o.vectorsWorld.length;i++)I.Pq.TransformCoordinatesToRef(o.vectorsWorld[i],t,e),e.x<this._orthoLeft&&(this._orthoLeft=e.x),e.y<this._orthoBottom&&(this._orthoBottom=e.y),e.x>this._orthoRight&&(this._orthoRight=e.x),e.y>this._orthoTop&&(this._orthoTop=e.y),this.autoCalcShadowZBounds&&(e.z<s&&(s=e.z),e.z>r&&(r=e.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=s,this._shadowMaxZ=r)}const r=this._orthoRight-this._orthoLeft,n=this._orthoTop-this._orthoBottom,a=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,o=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;I.uq.OrthoOffCenterLHToRef(this._orthoLeft-r*this.shadowOrthoScale,this._orthoRight+r*this.shadowOrthoScale,this._orthoBottom-n*this.shadowOrthoScale,this._orthoTop+n*this.shadowOrthoScale,l?o:a,l?a:o,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}(0,w.Cg)([(0,D.lK)()],No.prototype,"shadowFrustumSize",null),(0,w.Cg)([(0,D.lK)()],No.prototype,"shadowOrthoScale",null),(0,w.Cg)([(0,D.lK)()],No.prototype,"autoUpdateExtends",void 0),(0,w.Cg)([(0,D.lK)()],No.prototype,"autoCalcShadowZBounds",void 0),(0,w.Cg)([(0,D.lK)("orthoLeft")],No.prototype,"_orthoLeft",void 0),(0,w.Cg)([(0,D.lK)("orthoRight")],No.prototype,"_orthoRight",void 0),(0,w.Cg)([(0,D.lK)("orthoTop")],No.prototype,"_orthoTop",void 0),(0,w.Cg)([(0,D.lK)("orthoBottom")],No.prototype,"_orthoBottom",void 0),(0,V.Y5)("BABYLON.DirectionalLight",No),function(e){e[e.FREE=0]="FREE",e[e.LIMITED=1]="LIMITED",e[e.LOCKED=2]="LOCKED"}(So||(So={})),function(e){e[e.LINEAR_X=0]="LINEAR_X",e[e.LINEAR_Y=1]="LINEAR_Y",e[e.LINEAR_Z=2]="LINEAR_Z",e[e.ANGULAR_X=3]="ANGULAR_X",e[e.ANGULAR_Y=4]="ANGULAR_Y",e[e.ANGULAR_Z=5]="ANGULAR_Z",e[e.LINEAR_DISTANCE=6]="LINEAR_DISTANCE"}(To||(To={})),function(e){e[e.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",e[e.DISTANCE=2]="DISTANCE",e[e.HINGE=3]="HINGE",e[e.SLIDER=4]="SLIDER",e[e.LOCK=5]="LOCK",e[e.PRISMATIC=6]="PRISMATIC",e[e.SIX_DOF=7]="SIX_DOF"}(yo||(yo={})),function(e){e[e.SPHERE=0]="SPHERE",e[e.CAPSULE=1]="CAPSULE",e[e.CYLINDER=2]="CYLINDER",e[e.BOX=3]="BOX",e[e.CONVEX_HULL=4]="CONVEX_HULL",e[e.CONTAINER=5]="CONTAINER",e[e.MESH=6]="MESH",e[e.HEIGHTFIELD=7]="HEIGHTFIELD"}(Co||(Co={})),function(e){e[e.NONE=0]="NONE",e[e.VELOCITY=1]="VELOCITY",e[e.POSITION=2]="POSITION"}(Po||(Po={})),function(e){e.COLLISION_STARTED="COLLISION_STARTED",e.COLLISION_CONTINUED="COLLISION_CONTINUED",e.COLLISION_FINISHED="COLLISION_FINISHED",e.TRIGGER_ENTERED="TRIGGER_ENTERED",e.TRIGGER_EXITED="TRIGGER_EXITED"}(Eo||(Eo={})),function(e){e[e.STATIC=0]="STATIC",e[e.ANIMATED=1]="ANIMATED",e[e.DYNAMIC=2]="DYNAMIC"}(Ao||(Ao={})),function(e){e[e.DISABLED=0]="DISABLED",e[e.TELEPORT=1]="TELEPORT",e[e.ACTION=2]="ACTION"}(Ro||(Ro={})),function(e){e[e.SIMULATION_CONTROLLED=0]="SIMULATION_CONTROLLED",e[e.ALWAYS_ACTIVE=1]="ALWAYS_ACTIVE",e[e.ALWAYS_INACTIVE=2]="ALWAYS_INACTIVE"}(Io||(Io={}));class Lo{constructor(e,t){if(this._pluginData=void 0,this._isTrigger=!1,this._isDisposed=!1,!t)return;const i=t.getPhysicsEngine();if(!i)throw new Error("No Physics Engine available.");if(2!=i.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const s=i.getPhysicsPlugin();if(!s)throw new Error("No Physics Plugin available.");if(this._physicsPlugin=s,void 0!==e.pluginData&&null!==e.pluginData)this._pluginData=e.pluginData,this._type=this._physicsPlugin.getShapeType(this);else if(void 0!==e.type&&null!==e.type){this._type=e.type;const t=e.parameters??{};this._physicsPlugin.initShape(this,e.type,t)}}getClassName(){return"PhysicsShape"}get type(){return this._type}set filterMembershipMask(e){this._physicsPlugin.setShapeFilterMembershipMask(this,e)}get filterMembershipMask(){return this._physicsPlugin.getShapeFilterMembershipMask(this)}set filterCollideMask(e){this._physicsPlugin.setShapeFilterCollideMask(this,e)}get filterCollideMask(){return this._physicsPlugin.getShapeFilterCollideMask(this)}set material(e){this._physicsPlugin.setMaterial(this,e),this._material=e}get material(){return this._material||(this._material=this._physicsPlugin.getMaterial(this)),this._material}set density(e){this._physicsPlugin.setDensity(this,e)}get density(){return this._physicsPlugin.getDensity(this)}addChildFromParent(e,t,i){const s=i.computeWorldMatrix(!0),r=e.computeWorldMatrix(!0),n=I.AA.Matrix[0];s.multiplyToRef(I.uq.Invert(r),n);const a=I.AA.Vector3[0],o=I.AA.Quaternion[0],l=I.AA.Vector3[1];n.decompose(l,o,a),this._physicsPlugin.addChild(this,t,a,o,l)}addChild(e,t,i,s){this._physicsPlugin.addChild(this,e,t,i,s)}removeChild(e){this._physicsPlugin.removeChild(this,e)}getNumChildren(){return this._physicsPlugin.getNumChildren(this)}getBoundingBox(){return this._physicsPlugin.getBoundingBox(this)}set isTrigger(e){this._isTrigger!==e&&(this._isTrigger=e,this._physicsPlugin.setTrigger(this,e))}get isTrigger(){return this._isTrigger}dispose(){this._isDisposed||(this._physicsPlugin.disposeShape(this),this._isDisposed=!0)}}var Bo,ko=r(4766);class Vo{constructor(e,t,i){this._vertices=[],this._indices=[],this._isRightHanded=i.useRightHandedSystem,this._collectIndices=t}addNodeMeshes(e,t){e.computeWorldMatrix(!0);const i=I.AA.Matrix[0];if(I.uq.ScalingToRef(e.absoluteScaling.x,e.absoluteScaling.y,e.absoluteScaling.z,i),e instanceof At?this._addMesh(e,i):e instanceof Tn&&this._addMesh(e.sourceMesh,i),t){const t=I.AA.Matrix[1];e.computeWorldMatrix().invertToRef(t);const s=I.AA.Matrix[2];t.multiplyToRef(i,s),e.getChildMeshes(!1).filter((e=>!e.physicsBody)).forEach((e=>{const t=e.computeWorldMatrix(),i=I.AA.Matrix[3];t.multiplyToRef(s,i),e instanceof At?this._addMesh(e,i):e instanceof Tn&&this._addMesh(e.sourceMesh,i)}))}}_addMesh(e,t){const i=e.getVerticesData(O.R.PositionKind)||[],s=i.length/3,r=this._vertices.length;for(let e=0;e<s;e++){const s=new I.Pq(i[3*e+0],i[3*e+1],i[3*e+2]);this._vertices.push(I.Pq.TransformCoordinates(s,t))}if(this._collectIndices){const t=e.getIndices();if(t)for(let e=0;e<t.length;e+=3)this._isRightHanded?(this._indices.push(t[e+0]+r),this._indices.push(t[e+1]+r),this._indices.push(t[e+2]+r)):(this._indices.push(t[e+2]+r),this._indices.push(t[e+1]+r),this._indices.push(t[e+0]+r))}}getVertices(e){const t=3*this._vertices.length,i=4*t,s=e._malloc(i),r=new Float32Array(e.HEAPU8.buffer,s,t);for(let e=0;e<this._vertices.length;e++)r[3*e+0]=this._vertices[e].x,r[3*e+1]=this._vertices[e].y,r[3*e+2]=this._vertices[e].z;return{offset:s,numObjects:t}}freeBuffer(e,t){e._free(t.offset)}getTriangles(e){const t=4*this._indices.length,i=e._malloc(t),s=new Int32Array(e.HEAPU8.buffer,i,this._indices.length);for(let e=0;e<this._indices.length;e++)s[e]=this._indices[e];return{offset:i,numObjects:this._indices.length}}}class Uo{constructor(e){this.hpBodyId=e,this.userMassProps={centerOfMass:void 0,mass:void 0,inertia:void 0,inertiaOrientation:void 0}}}class zo{constructor(){this.bodyId=BigInt(0),this.position=new I.Pq,this.normal=new I.Pq}}class Go{constructor(){this.contactOnA=new zo,this.contactOnB=new zo,this.impulseApplied=0,this.type=0}static readToRef(e,t,i){const s=new Int32Array(e,t),r=new Float32Array(e,t);i.contactOnA.bodyId=BigInt(s[2]),i.contactOnA.position.set(r[10],r[11],r[12]),i.contactOnA.normal.set(r[13],r[14],r[15]),i.contactOnB.bodyId=BigInt(s[18]),i.contactOnB.position.set(r[26],r[27],r[28]),i.contactOnB.normal.set(r[29],r[30],r[31]),i.impulseApplied=r[34],i.type=s[0]}}class Ho{constructor(){this.bodyIdA=BigInt(0),this.bodyIdB=BigInt(0),this.type=0}static readToRef(e,t,i){const s=new Int32Array(e,t);i.type=s[0],i.bodyIdA=BigInt(s[2]),i.bodyIdB=BigInt(s[6])}}class Wo{constructor(e=!0,t=HK){this._useDeltaForWorldStep=e,this._hknp={},this.name="HavokPlugin",this._fixedTimeStep=1/60,this._tmpVec3=(0,Ki.mI)(3,I.Pq.Zero),this._bodies=new Map,this._shapes=new Map,this._bodyCollisionObservable=new Map,this._constraintToBodyIdPair=new Map,this._bodyCollisionEndedObservable=new Map,this.onCollisionObservable=new C.cP,this.onCollisionEndedObservable=new C.cP,this.onTriggerCollisionObservable=new C.cP,"function"!=typeof t?(this._hknp=t,this.isSupported()?(this.world=this._hknp.HP_World_Create()[1],this._queryCollector=this._hknp.HP_QueryCollector_Create(1)[1]):l.V.Error("Havok is not available. Please make sure you included the js file.")):l.V.Error("Havok is not ready. Please make sure you await HK() before using the plugin.")}isSupported(){return void 0!==this._hknp}setGravity(e){this._hknp.HP_World_SetGravity(this.world,this._bVecToV3(e))}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){for(const e of t)e.disablePreStep||this.setPhysicsBodyTransformation(e,e.transformNode);const i=this._useDeltaForWorldStep?e:this._fixedTimeStep;this._hknp.HP_World_SetIdealStepTime(this.world,i),this._hknp.HP_World_Step(this.world,i),this._bodyBuffer=this._hknp.HP_World_GetBodyBuffer(this.world)[1];for(const e of t)e.disableSync||this.sync(e);this._notifyCollisions(),this._notifyTriggers()}getPluginVersion(){return 2}setVelocityLimits(e,t){this._hknp.HP_World_SetSpeedLimit(this.world,e,t)}getMaxLinearVelocity(){return this._hknp.HP_World_GetSpeedLimit(this.world)[1]}getMaxAngularVelocity(){return this._hknp.HP_World_GetSpeedLimit(this.world)[2]}initBody(e,t,i,s){e._pluginData=new Uo(this._hknp.HP_Body_Create()[1]),this._internalSetMotionType(e._pluginData,t);const r=[this._bVecToV3(i),this._bQuatToV4(s)];this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,r),this._hknp.HP_World_AddBody(this.world,e._pluginData.hpBodyId,e.startAsleep),this._bodies.set(e._pluginData.hpBodyId[0],{body:e,index:0})}removeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(const t of e._pluginDataInstances)this._bodyCollisionObservable.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._bodies.delete(t.hpBodyId[0]);e._pluginData&&(this._bodyCollisionObservable.delete(e._pluginData.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,e._pluginData.hpBodyId),this._bodies.delete(e._pluginData.hpBodyId[0]))}initBodyInstances(e,t,i){const s=i._thinInstanceDataStorage?.instancesCount??0,r=i._thinInstanceDataStorage.matrixData;r&&(this._createOrUpdateBodyInstances(e,t,r,0,s,!1),e._pluginDataInstances.forEach(((t,i)=>{this._bodies.set(t.hpBodyId[0],{body:e,index:i})})))}_createOrUpdateBodyInstances(e,t,i,s,r,n){const a=I.AA.Quaternion[0],o=I.uq.Identity();for(let l=s;l<r;l++){const s=[i[16*l+12],i[16*l+13],i[16*l+14]];let r;r=n?e._pluginDataInstances[l].hpBodyId:this._hknp.HP_Body_Create()[1],o.setRowFromFloats(0,i[16*l+0],i[16*l+1],i[16*l+2],0),o.setRowFromFloats(1,i[16*l+4],i[16*l+5],i[16*l+6],0),o.setRowFromFloats(2,i[16*l+8],i[16*l+9],i[16*l+10],0),I.PT.FromRotationMatrixToRef(o,a);const h=[s,[a.x,a.y,a.z,a.w]];if(this._hknp.HP_Body_SetQTransform(r,h),!n){const i=new Uo(r);e._pluginDataInstances.length&&(i.userMassProps=e._pluginDataInstances[0].userMassProps),this._internalSetMotionType(i,t),this._internalUpdateMassProperties(i),e._pluginDataInstances.push(i),this._hknp.HP_World_AddBody(this.world,r,e.startAsleep),i.worldTransformOffset=this._hknp.HP_Body_GetWorldTransformOffset(r)[1]}}}updateBodyInstances(e,t){const i=t._thinInstanceDataStorage?.instancesCount??0,s=t._thinInstanceDataStorage.matrixData;if(!s)return;const r=e._pluginDataInstances.length,n=this.getMotionType(e);if(i>r){this._createOrUpdateBodyInstances(e,n,s,r,i,!1);const t=this._hknp.HP_Body_GetShape(e._pluginDataInstances[0].hpBodyId)[1];t[0]||(t[0]=e.shape?._pluginData[0]);for(let s=r;s<i;s++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[s].hpBodyId,t),this._internalUpdateMassProperties(e._pluginDataInstances[s]),this._bodies.set(e._pluginDataInstances[s].hpBodyId[0],{body:e,index:s})}else if(i<r){const t=r-i;for(let i=0;i<t;i++){const t=e._pluginDataInstances.pop();this._bodies.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._hknp.HP_Body_Release(t.hpBodyId)}this._createOrUpdateBodyInstances(e,n,s,0,i,!0)}}sync(e){this.syncTransform(e,e.transformNode)}syncTransform(e,t){if(e._pluginDataInstances.length){const i=t,s=i._thinInstanceDataStorage.matrixData;if(!s)return;const r=e._pluginDataInstances.length;for(let t=0;t<r;t++){const i=e._pluginDataInstances[t].worldTransformOffset,r=new Float32Array(this._hknp.HEAPU8.buffer,this._bodyBuffer+i,16),n=16*t;for(let e=0;e<15;e++)3&~e&&(s[n+e]=r[e]);s[n+15]=1}i.thinInstanceBufferUpdated("matrix")}else try{const i=this._hknp.HP_Body_GetQTransform(e._pluginData.hpBodyId)[1],s=i[0],r=i[1],n=I.AA.Quaternion[0];n.set(r[0],r[1],r[2],r[3]);const a=t.parent;if(a&&!a.getWorldMatrix().isIdentity()){a.computeWorldMatrix(!0),I.AA.Vector3[1].copyFrom(t.scaling),n.normalize();const e=I.AA.Matrix[0],i=I.AA.Vector3[0];i.copyFromFloats(s[0],s[1],s[2]),I.uq.ComposeToRef(t.absoluteScaling,n,i,e);const r=I.AA.Matrix[1];a.getWorldMatrix().invertToRef(r);const o=I.AA.Matrix[2];e.multiplyToRef(r,o),o.decomposeToTransformNode(t),t.rotationQuaternion?.normalize(),t.scaling.copyFrom(I.AA.Vector3[1])}else t.position.set(s[0],s[1],s[2]),t.rotationQuaternion?t.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(t.rotation)}catch(e){l.V.Error(`Syncing transform failed for node ${t.name}: ${e.message}...`)}}setShape(e,t){const i=t&&t._pluginData?t._pluginData:BigInt(0);if(!(e.transformNode instanceof At&&e.transformNode._thinInstanceDataStorage?.matrixData))return this._hknp.HP_Body_SetShape(e._pluginData.hpBodyId,i),void this._internalUpdateMassProperties(e._pluginData);const s=e.transformNode,r=s._thinInstanceDataStorage?.instancesCount??0;for(let t=0;t<r;t++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[t].hpBodyId,i),this._internalUpdateMassProperties(e._pluginDataInstances[t])}_getPluginReference(e,t){return e._pluginDataInstances?.length?e._pluginDataInstances[t??0]:e._pluginData}getShape(e){const t=this._getPluginReference(e),i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1];if(0!=i){const t=e.transformNode.getScene();return new Lo({pluginData:i},t)}return null}getShapeType(e){return e.type?e.type:this._hknp.HP_Shape_GetType(e._pluginData)}setEventMask(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,t)}),i)}getEventMask(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1]}_fromMassPropertiesTuple(e){return{centerOfMass:I.Pq.FromArray(e[0]),mass:e[1],inertia:I.Pq.FromArray(e[2]),inertiaOrientation:I.PT.FromArray(e[3])}}_internalUpdateMassProperties(e){const t=this._internalComputeMassProperties(e),i=e.userMassProps;i.centerOfMass&&(t[0]=i.centerOfMass.asArray()),null!=i.mass&&(t[1]=i.mass),i.inertia&&(t[2]=i.inertia.asArray()),i.inertiaOrientation&&(t[3]=i.inertiaOrientation.asArray()),this._hknp.HP_Body_SetMassProperties(e.hpBodyId,t)}_internalSetMotionType(e,t){switch(t){case 0:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.STATIC);break;case 1:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.KINEMATIC);break;case 2:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.DYNAMIC)}}setMotionType(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._internalSetMotionType(e,t)}),i)}getMotionType(e,t){const i=this._getPluginReference(e,t),s=this._hknp.HP_Body_GetMotionType(i.hpBodyId)[1];switch(s){case this._hknp.MotionType.STATIC:return 0;case this._hknp.MotionType.KINEMATIC:return 1;case this._hknp.MotionType.DYNAMIC:return 2}throw new Error("Unknown motion type: "+s)}setActivationControl(e,t){switch(t){case 1:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.ALWAYS_ACTIVE);break;case 2:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.ALWAYS_INACTIVE);break;case 0:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.SIMULATION_CONTROLLED)}}_internalComputeMassProperties(e){const t=this._hknp.HP_Body_GetShape(e.hpBodyId);if(t[0]==this._hknp.Result.RESULT_OK){const e=this._hknp.HP_Shape_BuildMassProperties(t[1]);if(e[0]==this._hknp.Result.RESULT_OK)return e[1]}return[[0,0,0],1,[1,1,1],[0,0,0,1]]}computeMassProperties(e,t){const i=this._getPluginReference(e,t),s=this._internalComputeMassProperties(i);return this._fromMassPropertiesTuple(s)}setMassProperties(e,t,i){this._applyToBodyOrInstances(e,(e=>{e.userMassProps=t,this._internalUpdateMassProperties(e)}),i)}getMassProperties(e,t){const i=this._getPluginReference(e,t),s=this._hknp.HP_Body_GetMassProperties(i.hpBodyId)[1];return this._fromMassPropertiesTuple(s)}setLinearDamping(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetLinearDamping(e.hpBodyId,t)}),i)}getLinearDamping(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetLinearDamping(i.hpBodyId)[1]}setAngularDamping(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetAngularDamping(e.hpBodyId,t)}),i)}getAngularDamping(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetAngularDamping(i.hpBodyId)[1]}setLinearVelocity(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetLinearVelocity(e.hpBodyId,this._bVecToV3(t))}),i)}getLinearVelocityToRef(e,t,i){const s=this._getPluginReference(e,i),r=this._hknp.HP_Body_GetLinearVelocity(s.hpBodyId)[1];this._v3ToBvecRef(r,t)}_applyToBodyOrInstances(e,t,i){if(e._pluginDataInstances?.length>0&&void 0===i)for(let i=0;i<e._pluginDataInstances.length;i++)t(e._pluginDataInstances[i]);else t(this._getPluginReference(e,i))}applyImpulse(e,t,i,s){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_ApplyImpulse(e.hpBodyId,this._bVecToV3(i),this._bVecToV3(t))}),s)}applyAngularImpulse(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_ApplyAngularImpulse(e.hpBodyId,this._bVecToV3(t))}),i)}applyForce(e,t,i,s){t.scaleToRef(this.getTimeStep(),this._tmpVec3[0]),this.applyImpulse(e,this._tmpVec3[0],i,s)}setAngularVelocity(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetAngularVelocity(e.hpBodyId,this._bVecToV3(t))}),i)}getAngularVelocityToRef(e,t,i){const s=this._getPluginReference(e,i),r=this._hknp.HP_Body_GetAngularVelocity(s.hpBodyId)[1];this._v3ToBvecRef(r,t)}setPhysicsBodyTransformation(e,t){if(e.getPrestepType()==Ro.TELEPORT){const i=e.transformNode;if(e.numInstances>0){const t=i._thinInstanceDataStorage.matrixData;if(!t)return;const s=e.numInstances;this._createOrUpdateBodyInstances(e,e.getMotionType(),t,0,s,!0)}else this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,this._getTransformInfos(t))}else e.getPrestepType()==Ro.ACTION?this.setTargetTransform(e,t.absolutePosition,t.absoluteRotationQuaternion):e.getPrestepType()==Ro.DISABLED?l.V.Warn("Prestep type is set to DISABLED. Unable to set physics body transformation."):l.V.Warn("Invalid prestep type set to physics body.")}setTargetTransform(e,t,i,s){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetTargetQTransform(e.hpBodyId,[this._bVecToV3(t),this._bQuatToV4(i)])}),s)}setGravityFactor(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetGravityFactor(e.hpBodyId,t)}),i)}getGravityFactor(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetGravityFactor(i.hpBodyId)[1]}disposeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(const t of e._pluginDataInstances)this._hknp.HP_Body_Release(t.hpBodyId),t.hpBodyId=void 0;e._pluginData&&(this._hknp.HP_Body_Release(e._pluginData.hpBodyId),e._pluginData.hpBodyId=void 0)}_createOptionsFromGroundMesh(e){const t=e.groundMesh;if(!t)return;let i=t.getVerticesData(O.R.PositionKind);const s=t.computeWorldMatrix(!0),r=[];let n;for(n=0;n<i.length;n+=3)I.Pq.FromArrayToRef(i,n,I.AA.Vector3[0]),I.Pq.TransformCoordinatesToRef(I.AA.Vector3[0],s,I.AA.Vector3[1]),I.AA.Vector3[1].toArray(r,n);i=r;const a=~~(Math.sqrt(i.length/3)-1),o=t.getBoundingInfo(),l=Math.min(o.boundingBox.extendSizeWorld.x,o.boundingBox.extendSizeWorld.z),h=o.boundingBox.minimumWorld.x,c=o.boundingBox.minimumWorld.y,u=o.boundingBox.minimumWorld.z,d=new Float32Array((a+1)*(a+1)),_=2*l/a;for(let e=0;e<d.length;e++)d[e]=c;for(let e=0;e<i.length;e+=3){const t=Math.round((i[e+0]-h)/_),s=a-Math.round((i[e+2]-u)/_),r=i[e+1]-c;d[s*(a+1)+t]=r}e.numHeightFieldSamplesX=a+1,e.numHeightFieldSamplesZ=a+1,e.heightFieldSizeX=2*o.boundingBox.extendSizeWorld.x,e.heightFieldSizeZ=2*o.boundingBox.extendSizeWorld.z,e.heightFieldData=d}initShape(e,t,i){switch(t){case 0:{const t=i.radius||1,s=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateSphere(s,t)[1]}break;case 3:{const t=i.rotation?this._bQuatToV4(i.rotation):[0,0,0,1],s=i.extents?this._bVecToV3(i.extents):[1,1,1],r=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateBox(r,t,s)[1]}break;case 1:{const t=i.pointA?this._bVecToV3(i.pointA):[0,0,0],s=i.pointB?this._bVecToV3(i.pointB):[0,1,0],r=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCapsule(t,s,r)[1]}break;case 5:e._pluginData=this._hknp.HP_Shape_CreateContainer()[1];break;case 2:{const t=i.pointA?this._bVecToV3(i.pointA):[0,0,0],s=i.pointB?this._bVecToV3(i.pointB):[0,1,0],r=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCylinder(t,s,r)[1]}break;case 4:case 6:{const s=i.mesh;if(!s)throw new Error("No mesh provided to create physics shape.");{const r=!!i.includeChildMeshes,n=new Vo(s,4!=t,s?.getScene());n.addNodeMeshes(s,r);const a=n.getVertices(this._hknp),o=a.numObjects/3;if(4==t)e._pluginData=this._hknp.HP_Shape_CreateConvexHull(a.offset,o)[1];else{const t=n.getTriangles(this._hknp),i=t.numObjects/3;e._pluginData=this._hknp.HP_Shape_CreateMesh(a.offset,o,t.offset,i)[1],n.freeBuffer(this._hknp,t)}n.freeBuffer(this._hknp,a)}}break;case 7:if(i.groundMesh&&this._createOptionsFromGroundMesh(i),!(i.numHeightFieldSamplesX&&i.numHeightFieldSamplesZ&&i.heightFieldSizeX&&i.heightFieldSizeZ&&i.heightFieldData))throw new Error("Missing required heightfield parameters");{const t=i.numHeightFieldSamplesX*i.numHeightFieldSamplesZ,s=4*t,r=this._hknp._malloc(s),n=new Float32Array(this._hknp.HEAPU8.buffer,r,t);for(let e=0;e<i.numHeightFieldSamplesX;e++)for(let t=0;t<i.numHeightFieldSamplesZ;t++){const s=t*i.numHeightFieldSamplesX+e,r=(i.numHeightFieldSamplesX-1-e)*i.numHeightFieldSamplesZ+t;n[s]=i.heightFieldData[r]}const a=i.heightFieldSizeX/(i.numHeightFieldSamplesX-1),o=i.heightFieldSizeZ/(i.numHeightFieldSamplesZ-1);e._pluginData=this._hknp.HP_Shape_CreateHeightField(i.numHeightFieldSamplesX,i.numHeightFieldSamplesZ,[a,1,o],r)[1],this._hknp._free(r)}break;default:throw new Error("Unsupported Shape Type.")}this._shapes.set(e._pluginData[0],e)}setShapeFilterMembershipMask(e,t){const i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[t,i])}getShapeFilterMembershipMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0]}setShapeFilterCollideMask(e,t){const i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[i,t])}getShapeFilterCollideMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1]}setMaterial(e,t){const i=t.friction??.5,s=t.staticFriction??i,r=t.restitution??0,n=t.frictionCombine??1,a=t.restitutionCombine??2,o=[s,i,r,this._materialCombineToNative(n),this._materialCombineToNative(a)];this._hknp.HP_Shape_SetMaterial(e._pluginData,o)}getMaterial(e){const t=this._hknp.HP_Shape_GetMaterial(e._pluginData)[1];return{staticFriction:t[0],friction:t[1],restitution:t[2],frictionCombine:this._nativeToMaterialCombine(t[3]),restitutionCombine:this._nativeToMaterialCombine(t[4])}}setDensity(e,t){this._hknp.HP_Shape_SetDensity(e._pluginData,t)}getDensity(e){return this._hknp.HP_Shape_GetDensity(e._pluginData)[1]}_getTransformInfos(e){if(e.parent)return e.computeWorldMatrix(!0),[this._bVecToV3(e.absolutePosition),this._bQuatToV4(e.absoluteRotationQuaternion)];let t=I.AA.Quaternion[0];if(e.rotationQuaternion)t=e.rotationQuaternion;else{const i=e.rotation;I.PT.FromEulerAnglesToRef(i.x,i.y,i.z,t)}return[this._bVecToV3(e.position),this._bQuatToV4(t)]}addChild(e,t,i,s,r){const n=[i?this._bVecToV3(i):[0,0,0],s?this._bQuatToV4(s):[0,0,0,1],r?this._bVecToV3(r):[1,1,1]];this._hknp.HP_Shape_AddChild(e._pluginData,t._pluginData,n)}removeChild(e,t){this._hknp.HP_Shape_RemoveChild(e._pluginData,t)}getNumChildren(e){return this._hknp.HP_Shape_GetNumChildren(e._pluginData)[1]}setTrigger(e,t){this._hknp.HP_Shape_SetTrigger(e._pluginData,t)}getBoundingBox(e){const t=this._hknp.HP_Shape_GetBoundingBox(e._pluginData,[[0,0,0],[0,0,0,1]])[1];return I.AA.Vector3[0].set(t[0][0],t[0][1],t[0][2]),I.AA.Vector3[1].set(t[1][0],t[1][1],t[1][2]),new ko.I(I.AA.Vector3[0],I.AA.Vector3[1],I.uq.IdentityReadOnly)}getBodyBoundingBox(e){const t=this.getBoundingBox(e.shape);return new ko.I(t.minimum,t.maximum,e.transformNode.getWorldMatrix())}getBodyGeometry(e){const t=e._pluginDataInstances?.length>0?e._pluginDataInstances[0]:e._pluginData,i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1],s=this._hknp.HP_Shape_CreateDebugDisplayGeometry(i);if(s[0]!=this._hknp.Result.RESULT_OK)return{positions:[],indices:[]};const r=this._hknp.HP_DebugGeometry_GetInfo(s[1])[1],n=new Float32Array(this._hknp.HEAPU8.buffer,r[0],3*r[1]),a=new Uint32Array(this._hknp.HEAPU8.buffer,r[2],3*r[3]),o=n.slice(0),l=a.slice(0);return this._hknp.HP_DebugGeometry_Release(s[1]),{positions:o,indices:l}}disposeShape(e){this._hknp.HP_Shape_Release(e._pluginData),e._pluginData=void 0}initConstraint(e,t,i,s,r){const n=e.type,a=e.options;if(!n||!a)return void l.V.Warn("No constraint type or options. Constraint is invalid.");if(t._pluginDataInstances.length>0&&void 0===s||i._pluginDataInstances.length>0&&void 0===r)return void l.V.Warn("Body is instanced but no instance index was specified. Constraint will not be applied.");e._pluginData=e._pluginData??[];const o=this._hknp.HP_Constraint_Create()[1];e._pluginData.push(o);const h=this._getPluginReference(t,s).hpBodyId,c=this._getPluginReference(i,r).hpBodyId;this._hknp.HP_Constraint_SetParentBody(o,h),this._hknp.HP_Constraint_SetChildBody(o,c),this._constraintToBodyIdPair.set(o[0],[h[0],c[0]]);const u=a.pivotA?this._bVecToV3(a.pivotA):this._bVecToV3(I.Pq.Zero()),d=a.axisA??new I.Pq(1,0,0),_=this._tmpVec3[0];a.perpAxisA?_.copyFrom(a.perpAxisA):d.getNormalToRef(_),this._hknp.HP_Constraint_SetAnchorInParent(o,u,this._bVecToV3(d),this._bVecToV3(_));const p=a.pivotB?this._bVecToV3(a.pivotB):this._bVecToV3(I.Pq.Zero()),f=a.axisB??new I.Pq(1,0,0),m=this._tmpVec3[0];if(a.perpAxisB?m.copyFrom(a.perpAxisB):f.getNormalToRef(m),this._hknp.HP_Constraint_SetAnchorInChild(o,p,this._bVecToV3(f),this._bVecToV3(m)),e._initOptions||(e._initOptions={axisA:d.clone(),axisB:f.clone(),perpAxisA:_.clone(),perpAxisB:m.clone(),pivotA:new I.Pq(u[0],u[1],u[2]),pivotB:new I.Pq(p[0],p[1],p[2])}),5==n)this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(2==n){const e=a.maxDistance||0,t=this._hknp.ConstraintAxis.LINEAR_DISTANCE;this._hknp.HP_Constraint_SetAxisMode(o,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(o,t,e),this._hknp.HP_Constraint_SetAxisMaxLimit(o,t,e)}else if(3==n)this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(6==n)this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(4==n)this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(1==n)this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(o,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else{if(7!=n)throw new Error("Unsupported Constraint Type.");{const t=e;for(const e of t.limits){const t=this._constraintAxisToNative(e.axis);0==(e.minLimit??-1)&&0==(e.maxLimit??-1)?this._hknp.HP_Constraint_SetAxisMode(o,t,this._hknp.ConstraintAxisLimitMode.LOCKED):(null!=e.minLimit&&(this._hknp.HP_Constraint_SetAxisMode(o,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(o,t,e.minLimit)),null!=e.maxLimit&&(this._hknp.HP_Constraint_SetAxisMode(o,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMaxLimit(o,t,e.maxLimit))),e.stiffness&&this._hknp.HP_Constraint_SetAxisStiffness(o,t,e.stiffness),e.damping&&this._hknp.HP_Constraint_SetAxisDamping(o,t,e.damping)}}}const g=!!a.collision;this._hknp.HP_Constraint_SetCollisionsEnabled(o,g),this._hknp.HP_Constraint_SetEnabled(o,!0)}getBodiesUsingConstraint(e){const t=[];for(const i of e._pluginData){const e=this._constraintToBodyIdPair.get(i[0]);if(e){const i=this._bodies.get(e[0]),s=this._bodies.get(e[1]);i&&s&&t.push({parentBody:i.body,parentBodyIndex:i.index,childBody:s.body,childBodyIndex:s.index})}}return t}addConstraint(e,t,i,s,r){this.initConstraint(i,e,t,s,r)}setEnabled(e,t){for(const i of e._pluginData)this._hknp.HP_Constraint_SetEnabled(i,t)}getEnabled(e){const t=e._pluginData&&e._pluginData[0];return!!t&&this._hknp.HP_Constraint_GetEnabled(t)[1]}setCollisionsEnabled(e,t){for(const i of e._pluginData)this._hknp.HP_Constraint_SetCollisionsEnabled(i,t)}getCollisionsEnabled(e){const t=e._pluginData&&e._pluginData[0];return!!t&&this._hknp.HP_Constraint_GetCollisionsEnabled(t)[1]}setAxisFriction(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisFriction(s,this._constraintAxisToNative(t),i)}getAxisFriction(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisFriction(i,this._constraintAxisToNative(t))[1]:null}setAxisMode(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMode(s,this._constraintAxisToNative(t),this._limitModeToNative(i))}getAxisMode(e,t){const i=e._pluginData&&e._pluginData[0];if(i){const e=this._hknp.HP_Constraint_GetAxisMode(i,this._constraintAxisToNative(t))[1];return this._nativeToLimitMode(e)}return null}setAxisMinLimit(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMinLimit(s,this._constraintAxisToNative(t),i)}getAxisMinLimit(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMinLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMaxLimit(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMaxLimit(s,this._constraintAxisToNative(t),i)}getAxisMaxLimit(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMaxLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMotorType(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorType(s,this._constraintAxisToNative(t),this._constraintMotorTypeToNative(i))}getAxisMotorType(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._nativeToMotorType(this._hknp.HP_Constraint_GetAxisMotorType(i,this._constraintAxisToNative(t))[1]):null}setAxisMotorTarget(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorTarget(s,this._constraintAxisToNative(t),i)}getAxisMotorTarget(e,t){return e._pluginData&&e._pluginData[0]?this._hknp.HP_Constraint_GetAxisMotorTarget(e._pluginData,this._constraintAxisToNative(t))[1]:null}setAxisMotorMaxForce(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorMaxForce(s,this._constraintAxisToNative(t),i)}getAxisMotorMaxForce(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMotorMaxForce(i,this._constraintAxisToNative(t))[1]:null}disposeConstraint(e){for(const t of e._pluginData)this._hknp.HP_Constraint_SetEnabled(t,!1),this._hknp.HP_Constraint_Release(t);e._pluginData.length=0}_populateHitData(e,t){const i=this._bodies.get(e[0][0]);t.body=i?.body,t.bodyIndex=i?.index;const s=this._shapes.get(e[1][0]);t.shape=s;const r=e[3],n=e[4],a=e[5];t.setHitData({x:n[0],y:n[1],z:n[2]},{x:r[0],y:r[1],z:r[2]},a)}raycast(e,t,i,s){const r=s?.membership??-1,n=s?.collideWith??-1,a=s?.shouldHitTriggers??!1;i.reset(e,t);const o=[BigInt(0)],l=[this._bVecToV3(e),this._bVecToV3(t),[r,n],a,o];if(this._hknp.HP_World_CastRayWithCollector(this.world,this._queryCollector,l),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[,e]=this._hknp.HP_QueryCollector_GetCastRayResult(this._queryCollector,0)[1];this._populateHitData(e,i),i.calculateHitDistance()}}pointProximity(e,t){const i=e?.collisionFilter?.membership??-1,s=e?.collisionFilter?.collideWith??-1;t.reset();const r=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],n=[this._bVecToV3(e.position),e.maxDistance,[i,s],e.shouldHitTriggers,r];if(this._hknp.HP_World_PointProximityWithCollector(this.world,this._queryCollector,n),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[e,i]=this._hknp.HP_QueryCollector_GetPointProximityResult(this._queryCollector,0)[1];this._populateHitData(i,t),t.setHitDistance(e)}}shapeProximity(e,t,i){t.reset(),i.reset();const s=e.shape._pluginData,r=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],n=[s,this._bVecToV3(e.position),this._bQuatToV4(e.rotation),e.maxDistance,e.shouldHitTriggers,r];if(this._hknp.HP_World_ShapeProximityWithCollector(this.world,this._queryCollector,n),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[e,s,r]=this._hknp.HP_QueryCollector_GetShapeProximityResult(this._queryCollector,0)[1];this._populateHitData(s,t),this._populateHitData(r,i),t.setHitDistance(e),i.setHitDistance(e)}}shapeCast(e,t,i){t.reset(),i.reset();const s=e.shape._pluginData,r=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],n=[s,this._bQuatToV4(e.rotation),this._bVecToV3(e.startPosition),this._bVecToV3(e.endPosition),e.shouldHitTriggers,r];if(this._hknp.HP_World_ShapeCastWithCollector(this.world,this._queryCollector,n),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const[e,s,r]=this._hknp.HP_QueryCollector_GetShapeCastResult(this._queryCollector,0)[1];this._populateHitData(s,t),this._populateHitData(r,i),t.setHitFraction(e),i.setHitFraction(e)}}getCollisionObservable(e){const t=e._pluginData.hpBodyId[0];let i=this._bodyCollisionObservable.get(t);return i||(i=new C.cP,this._bodyCollisionObservable.set(t,i)),i}getCollisionEndedObservable(e){const t=e._pluginData.hpBodyId[0];let i=this._bodyCollisionEndedObservable.get(t);return i||(i=new C.cP,this._bodyCollisionEndedObservable.set(t,i)),i}setCollisionCallbackEnabled(e,t){const i=this._hknp.EventType.COLLISION_STARTED.value|this._hknp.EventType.COLLISION_CONTINUED.value|this._hknp.EventType.COLLISION_FINISHED.value;e._pluginDataInstances&&e._pluginDataInstances.length?e._pluginDataInstances.forEach((e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,t?i:0)})):e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,t?i:0)}setCollisionEndedCallbackEnabled(e,t){const i=this._getPluginReference(e);let s=this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1];s=t?s|this._hknp.EventType.COLLISION_FINISHED.value:s&~this._hknp.EventType.COLLISION_FINISHED.value,e._pluginDataInstances&&e._pluginDataInstances.length?e._pluginDataInstances.forEach((e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,s)})):e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,s)}_notifyTriggers(){let e=this._hknp.HP_World_GetTriggerEvents(this.world)[1];const t=new Ho;for(;e;){Ho.readToRef(this._hknp.HEAPU8.buffer,e,t);const i=this._bodies.get(t.bodyIdA),s=this._bodies.get(t.bodyIdB);if(i&&s){const e={collider:i.body,colliderIndex:i.index,collidedAgainst:s.body,collidedAgainstIndex:s.index,type:this._nativeTriggerCollisionValueToCollisionType(t.type)};this.onTriggerCollisionObservable.notifyObservers(e)}e=this._hknp.HP_World_GetNextTriggerEvent(this.world,e)}}_notifyCollisions(){let e=this._hknp.HP_World_GetCollisionEvents(this.world)[1];const t=new Go,i=Number(this.world);for(;e;){Go.readToRef(this._hknp.HEAPU8.buffer,e,t);const s=this._bodies.get(t.contactOnA.bodyId),r=this._bodies.get(t.contactOnB.bodyId);if(s&&r){const e={collider:s.body,colliderIndex:s.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,type:this._nativeCollisionValueToCollisionType(t.type)};if("COLLISION_FINISHED"===e.type)this.onCollisionEndedObservable.notifyObservers(e);else{t.contactOnB.position.subtractToRef(t.contactOnA.position,this._tmpVec3[0]);const i=I.Pq.Dot(this._tmpVec3[0],t.contactOnA.normal);e.point=t.contactOnA.position,e.distance=i,e.impulse=t.impulseApplied,e.normal=t.contactOnA.normal,this.onCollisionObservable.notifyObservers(e)}if(this._bodyCollisionObservable.size&&"COLLISION_FINISHED"!==e.type){const i=this._bodyCollisionObservable.get(t.contactOnA.bodyId),n=this._bodyCollisionObservable.get(t.contactOnB.bodyId);t.contactOnA.position.subtractToRef(t.contactOnB.position,this._tmpVec3[0]);const a=I.Pq.Dot(this._tmpVec3[0],t.contactOnB.normal);if(i&&i.notifyObservers(e),n){const e={collider:r.body,colliderIndex:r.index,collidedAgainst:s.body,collidedAgainstIndex:s.index,point:t.contactOnB.position,distance:a,impulse:t.impulseApplied,normal:t.contactOnB.normal,type:this._nativeCollisionValueToCollisionType(t.type)};n.notifyObservers(e)}}else if(this._bodyCollisionEndedObservable.size){const i=this._bodyCollisionEndedObservable.get(t.contactOnA.bodyId),n=this._bodyCollisionEndedObservable.get(t.contactOnB.bodyId);t.contactOnA.position.subtractToRef(t.contactOnB.position,this._tmpVec3[0]);const a=I.Pq.Dot(this._tmpVec3[0],t.contactOnB.normal);if(i&&i.notifyObservers(e),n){const e={collider:r.body,colliderIndex:r.index,collidedAgainst:s.body,collidedAgainstIndex:s.index,point:t.contactOnB.position,distance:a,impulse:t.impulseApplied,normal:t.contactOnB.normal,type:this._nativeCollisionValueToCollisionType(t.type)};n.notifyObservers(e)}}}e=this._hknp.HP_World_GetNextCollisionEvent(i,e)}}get numBodies(){return this._hknp.HP_World_GetNumBodies(this.world)[1]}dispose(){this._queryCollector&&(this._hknp.HP_QueryCollector_Release(this._queryCollector),this._queryCollector=void 0),this.world&&(this._hknp.HP_World_Release(this.world),this.world=void 0)}_v3ToBvecRef(e,t){t.set(e[0],e[1],e[2])}_bVecToV3(e){return[e._x,e._y,e._z]}_bQuatToV4(e){return[e._x,e._y,e._z,e._w]}_constraintMotorTypeToNative(e){switch(e){case 2:return this._hknp.ConstraintMotorType.POSITION;case 1:return this._hknp.ConstraintMotorType.VELOCITY}return this._hknp.ConstraintMotorType.NONE}_nativeToMotorType(e){switch(e){case this._hknp.ConstraintMotorType.POSITION:return 2;case this._hknp.ConstraintMotorType.VELOCITY:return 1}return 0}_materialCombineToNative(e){switch(e){case 0:return this._hknp.MaterialCombine.GEOMETRIC_MEAN;case 1:return this._hknp.MaterialCombine.MINIMUM;case 2:return this._hknp.MaterialCombine.MAXIMUM;case 3:return this._hknp.MaterialCombine.ARITHMETIC_MEAN;case 4:return this._hknp.MaterialCombine.MULTIPLY}}_nativeToMaterialCombine(e){switch(e){case this._hknp.MaterialCombine.GEOMETRIC_MEAN:return 0;case this._hknp.MaterialCombine.MINIMUM:return 1;case this._hknp.MaterialCombine.MAXIMUM:return 2;case this._hknp.MaterialCombine.ARITHMETIC_MEAN:return 3;case this._hknp.MaterialCombine.MULTIPLY:return 4;default:return}}_constraintAxisToNative(e){switch(e){case 0:return this._hknp.ConstraintAxis.LINEAR_X;case 1:return this._hknp.ConstraintAxis.LINEAR_Y;case 2:return this._hknp.ConstraintAxis.LINEAR_Z;case 3:return this._hknp.ConstraintAxis.ANGULAR_X;case 4:return this._hknp.ConstraintAxis.ANGULAR_Y;case 5:return this._hknp.ConstraintAxis.ANGULAR_Z;case 6:return this._hknp.ConstraintAxis.LINEAR_DISTANCE}}_nativeToLimitMode(e){switch(e){case this._hknp.ConstraintAxisLimitMode.FREE:return 0;case this._hknp.ConstraintAxisLimitMode.LIMITED:return 1;case this._hknp.ConstraintAxisLimitMode.LOCKED:return 2}return 0}_limitModeToNative(e){switch(e){case 0:return this._hknp.ConstraintAxisLimitMode.FREE;case 1:return this._hknp.ConstraintAxisLimitMode.LIMITED;case 2:return this._hknp.ConstraintAxisLimitMode.LOCKED}}_nativeCollisionValueToCollisionType(e){switch(e){case this._hknp.EventType.COLLISION_STARTED.value:return"COLLISION_STARTED";case this._hknp.EventType.COLLISION_FINISHED.value:return"COLLISION_FINISHED";case this._hknp.EventType.COLLISION_CONTINUED.value:return"COLLISION_CONTINUED"}return"COLLISION_STARTED"}_nativeTriggerCollisionValueToCollisionType(e){switch(e){case 8:return"TRIGGER_ENTERED";case 16:return"TRIGGER_EXITED"}return"TRIGGER_ENTERED"}}class Xo extends W.w{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,s,r,n){super(e,"anaglyph",null,["leftSampler"],t,i[1],s,r,n),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("leftSampler",this._passedProcess)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(r.bind(r,1506)))):t.push(Promise.resolve().then(r.bind(r,9723))),super._gatherImports(e,t)}}(0,V.Y5)("BABYLON.AnaglyphPostProcess",Xo);class Ko extends W.w{getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i,s,r,n){super(e,"blackAndWhite",["degree"],null,t,i,s,r,n),this.degree=1,this.onApplyObservable.add((e=>{e.setFloat("degree",this.degree)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(r.bind(r,5783)))):t.push(Promise.resolve().then(r.bind(r,3996))),super._gatherImports(e,t)}static _Parse(e,t,i,s){return N.p.Parse((()=>new Ko(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,w.Cg)([(0,D.lK)()],Ko.prototype,"degree",void 0),(0,V.Y5)("BABYLON.BlackAndWhitePostProcess",Ko);class Qo{constructor(e,t,i,s){this._name=t,this._singleInstance=s||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let e=0;e<t.length;e++)if(!t[e].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const i=ee.S0.MakeArray(e||this._cameras);if(i)for(let e=0;e<i.length;e++){const s=i[e];if(!s)continue;const r=s.name;if(t=this._singleInstance?0:r,!this._postProcesses[t]){const e=this._getPostProcesses();e&&(this._postProcesses[t]=Array.isArray(e)?e:[e])}this._indicesForCamera[r]||(this._indicesForCamera[r]=[]),this._postProcesses[t].forEach((e=>{const t=s.attachPostProcess(e);this._indicesForCamera[r].push(t)})),this._cameras[r]||(this._cameras[r]=s)}}_detachCameras(e){const t=ee.S0.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],s=i.name,r=this._postProcesses[this._singleInstance?0:s];r&&r.forEach((e=>{i.detachPostProcess(e)})),this._cameras[s]&&(this._cameras[s]=null),delete this._indicesForCamera[s]}}_enable(e){const t=ee.S0.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],s=i.name,r=this._singleInstance?0:s;for(let n=0;n<this._indicesForCamera[s].length;n++){const a=this._indicesForCamera[s][n];null==i._postProcesses[a]&&t[e].attachPostProcess(this._postProcesses[r][n],a)}}}_disable(e){const t=ee.S0.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],s=i.name;this._postProcesses[this._singleInstance?0:s].forEach((e=>{i.detachPostProcess(e)}))}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}class Yo extends W.w{getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,i,s,r,n,a=0,o=!1){super(e,"extractHighlights",["threshold","exposure"],null,t,i,s,r,n,null,a,void 0,null,o),this.threshold=.9,this._exposure=1,this._inputPostProcess=null,this.onApplyObservable.add((e=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&e.setTextureFromPostProcess("textureSampler",this._inputPostProcess),e.setFloat("threshold",Math.pow(this.threshold,ft.rv)),e.setFloat("exposure",this._exposure)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(r.bind(r,5516)))):t.push(Promise.resolve().then(r.bind(r,5491))),super._gatherImports(e,t)}}(0,w.Cg)([(0,D.lK)()],Yo.prototype,"threshold",void 0),(0,V.Y5)("BABYLON.ExtractHighlightsPostProcess",Yo);class qo extends W.w{getClassName(){return"BloomMergePostProcess"}constructor(e,t,i,s,r,n,a,o,l,h=0,c=!1){super(e,"bloomMerge",["bloomWeight"],["bloomBlur"],r,n,a,o,l,null,h,void 0,null,!0),this.weight=1,this.weight=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("bloomBlur",i),e.setFloat("bloomWeight",this.weight)})),c||this.updateEffect()}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(r.bind(r,6645)))):t.push(Promise.resolve().then(r.bind(r,9336))),super._gatherImports(e,t)}}(0,w.Cg)([(0,D.lK)()],qo.prototype,"weight",void 0),(0,V.Y5)("BABYLON.BloomMergePostProcess",qo);class $o extends Qo{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this._bloomScale}set kernel(e){this._blurX.kernel=e*this._bloomScale,this._blurY.kernel=e*this._bloomScale}constructor(e,t,i,s,r=0,n=!1){super(e.getEngine(),"bloom",(()=>this._effects),!0),this._bloomScale=t,this._effects=[],this._downscale=new Yo("highlights",1,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,n),this._blurX=new X("horizontal blur",new I.I9(1,0),10,t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,void 0,n),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new X("vertical blur",new I.I9(0,1),10,t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,void 0,n),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=s,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new qo("bloomMerge",this._downscale,this._blurY,i,t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,n),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}class jo extends W.w{getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,i,s,r,n,a,o,l=0,h=!1){super(e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],s,r,n,a,o,null,l,void 0,null,h),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new I.I9(.707,.707),this.centerPosition=new I.I9(.5,.5),this.screenWidth=t,this.screenHeight=i,this.onApplyObservable.add((e=>{e.setFloat("chromatic_aberration",this.aberrationAmount),e.setFloat("screen_width",t),e.setFloat("screen_height",i),e.setFloat("radialIntensity",this.radialIntensity),e.setFloat2("direction",this.direction.x,this.direction.y),e.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(r.bind(r,9619))]))):t.push(Promise.all([Promise.resolve().then(r.bind(r,2048))])),super._gatherImports(e,t)}static _Parse(e,t,i,s){return N.p.Parse((()=>new jo(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1)),e,i,s)}}(0,w.Cg)([(0,D.lK)()],jo.prototype,"aberrationAmount",void 0),(0,w.Cg)([(0,D.lK)()],jo.prototype,"radialIntensity",void 0),(0,w.Cg)([(0,D.lK)()],jo.prototype,"direction",void 0),(0,w.Cg)([(0,D.lK)()],jo.prototype,"centerPosition",void 0),(0,w.Cg)([(0,D.lK)()],jo.prototype,"screenWidth",void 0),(0,w.Cg)([(0,D.lK)()],jo.prototype,"screenHeight",void 0),(0,V.Y5)("BABYLON.ChromaticAberrationPostProcess",jo);class Zo extends W.w{getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,i,s,r,n,a,o=0,h=!1){super(e,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],i,s,r,n,a,null,o,void 0,null,h),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50,this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add((e=>{if(!this._depthTexture)return void l.V.Warn("No depth texture set on CircleOfConfusionPostProcess");e.setTexture("depthSampler",this._depthTexture);const t=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);e.setFloat("focusDistance",this.focusDistance),e.setFloat("cocPrecalculation",t);const i=this._depthTexture.activeCamera;e.setFloat2("cameraMinMaxZ",i.minZ,i.maxZ-i.minZ)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(r.bind(r,2217)))):t.push(Promise.resolve().then(r.bind(r,7694))),super._gatherImports(e,t)}set depthTexture(e){this._depthTexture=e}}(0,w.Cg)([(0,D.lK)()],Zo.prototype,"lensSize",void 0),(0,w.Cg)([(0,D.lK)()],Zo.prototype,"fStop",void 0),(0,w.Cg)([(0,D.lK)()],Zo.prototype,"focusDistance",void 0),(0,w.Cg)([(0,D.lK)()],Zo.prototype,"focalLength",void 0),(0,V.Y5)("BABYLON.CircleOfConfusionPostProcess",Zo);class Jo extends W.w{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,s,r,n,a){super(e,"colorCorrection",null,["colorTable"],i,s,r,n,a);const o=s?.getScene()||null;this._colorTableTexture=new G.g(t,o,!0,!1,G.g.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=G.g.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=G.g.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=e=>{e.setTexture("colorTable",this._colorTableTexture)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(r.bind(r,3813))]))):t.push(Promise.all([Promise.resolve().then(r.bind(r,7670))])),super._gatherImports(e,t)}static _Parse(e,t,i,s){return N.p.Parse((()=>new Jo(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,w.Cg)([(0,D.lK)()],Jo.prototype,"colorTableUrl",void 0),(0,V.Y5)("BABYLON.ColorCorrectionPostProcess",Jo);class el extends W.w{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,s,r,n,a,o=0){super(e,"convolution",["kernel","screenSize"],null,i,s,r,n,a,null,o),this.kernel=t,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setArray("kernel",this.kernel)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(r.bind(r,2906))]))):t.push(Promise.all([Promise.resolve().then(r.bind(r,1537))])),super._gatherImports(e,t)}static _Parse(e,t,i,s){return N.p.Parse((()=>new el(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType)),e,i,s)}}el.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],el.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],el.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],el.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],el.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],el.GaussianKernel=[0,1,0,1,1,1,0,1,0],(0,w.Cg)([(0,D.lK)()],el.prototype,"kernel",void 0),(0,V.Y5)("BABYLON.ConvolutionPostProcess",el);class tl extends X{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,i,s,r,n,a,o=null,l=G.g.BILINEAR_SAMPLINGMODE,h,c,u=0,d=!1,_=5){super(e,i,s,r,n,2,h,c,u,"#define DOF 1\n",d,_),this.direction=i,this.externalTextureSamplerBinding=!!o,this.onApplyObservable.add((e=>{null!=o&&e.setTextureFromPostProcess("textureSampler",o),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",a)}))}}(0,w.Cg)([(0,D.lK)()],tl.prototype,"direction",void 0),(0,V.Y5)("BABYLON.DepthOfFieldBlurPostProcess",tl);class il extends W.w{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,i,s,r,n,a,o,l,h=0,c=!1){super(e,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],r,n,a,o,l,null,h,void 0,null,!0),this._blurSteps=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",i),s.forEach(((t,i)=>{e.setTextureFromPostProcessOutput("blurStep"+(s.length-i-1),t)}))})),c||this.updateEffect()}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(r.bind(r,9480)))):t.push(Promise.resolve().then(r.bind(r,9411))),super._gatherImports(e,t)}updateEffect(e=null,t=null,i=null,s,r,n){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+"\n"),super.updateEffect(e,t,i,s,r,n)}}!function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(Bo||(Bo={}));class sl extends Qo{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,i=0,s=0,r=!1){super(e.getEngine(),"depth of field",(()=>this._effects),!0),this._effects=[];const n=e.getEngine(),a=n.isWebGPU||n.version>1?6:5;this._circleOfConfusion=new Zo("circleOfConfusion",t,1,null,G.g.BILINEAR_SAMPLINGMODE,n,!1,s,r),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];let o=1,l=15;switch(i){case 2:o=3,l=51;break;case 1:o=2,l=31;break;default:l=15,o=1}const h=l/Math.pow(2,o-1);let c=1;for(let t=0;t<o;t++){const i=new tl("vertical blur",e,new I.I9(0,1),h,c,null,this._circleOfConfusion,0==t?this._circleOfConfusion:null,G.g.BILINEAR_SAMPLINGMODE,n,!1,s,r,0==t?a:5);i.autoClear=!1,c=.75/Math.pow(2,t);const o=new tl("horizontal blur",e,new I.I9(1,0),h,c,null,this._circleOfConfusion,null,G.g.BILINEAR_SAMPLINGMODE,n,!1,s,r);o.autoClear=!1,this._depthOfFieldBlurY.push(i),this._depthOfFieldBlurX.push(o)}this._effects=[this._circleOfConfusion];for(let e=0;e<this._depthOfFieldBlurX.length;e++)this._effects.push(this._depthOfFieldBlurY[e]),this._effects.push(this._depthOfFieldBlurX[e]);this._dofMerge=new il("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,c,null,G.g.BILINEAR_SAMPLINGMODE,n,!1,s,r),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}class rl extends W.w{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,s,r,n){super(e,"displayPass",["passSampler"],["passSampler"],t,i,s,r,n)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(r.bind(r,4069))]))):t.push(Promise.all([Promise.resolve().then(r.bind(r,3718))])),super._gatherImports(e,t)}static _Parse(e,t,i,s){return N.p.Parse((()=>new rl(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,V.Y5)("BABYLON.DisplayPassPostProcess",rl);class nl extends W.w{getClassName(){return"FilterPostProcess"}constructor(e,t,i,s,r,n,a){super(e,"filter",["kernelMatrix"],null,i,s,r,n,a),this.kernelMatrix=t,this.onApply=e=>{e.setMatrix("kernelMatrix",this.kernelMatrix)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(r.bind(r,7912))]))):t.push(Promise.all([Promise.resolve().then(r.bind(r,7961))])),super._gatherImports(e,t)}static _Parse(e,t,i,s){return N.p.Parse((()=>new nl(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,w.Cg)([(0,D.GG)()],nl.prototype,"kernelMatrix",void 0),(0,V.Y5)("BABYLON.FilterPostProcess",nl);class al extends W.w{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,s,r,n,a=0){super(e,"fxaa",["texelSize"],null,t,i,s||G.g.BILINEAR_SAMPLINGMODE,r,n,null,a,"fxaa",void 0,!0);const o=this._getDefines();this.updateEffect(o),this.onApplyObservable.add((e=>{const t=this.texelSize;e.setFloat2("texelSize",t.x,t.y)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(r.bind(r,2578)),Promise.resolve().then(r.bind(r,3208))]))):t.push(Promise.all([Promise.resolve().then(r.bind(r,5499)),Promise.resolve().then(r.bind(r,9669))])),super._gatherImports(e,t)}_getDefines(){const e=this.getEngine();return e&&e.extractDriverInfo().toLowerCase().indexOf("mali")>-1?"#define MALI 1\n":null}static _Parse(e,t,i,s){return N.p.Parse((()=>new al(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,V.Y5)("BABYLON.FxaaPostProcess",al);class ol extends W.w{getClassName(){return"GrainPostProcess"}constructor(e,t,i,s,r,n,a=0,o=!1){super(e,"grain",["intensity","animatedSeed"],[],t,i,s,r,n,null,a,void 0,null,o),this.intensity=30,this.animated=!1,this.onApplyObservable.add((e=>{e.setFloat("intensity",this.intensity),e.setFloat("animatedSeed",this.animated?Math.random()+1:1)}))}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(r.bind(r,8625))]))):t.push(Promise.all([Promise.resolve().then(r.bind(r,890))])),super._gatherImports(e,t)}static _Parse(e,t,i,s){return N.p.Parse((()=>new ol(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,w.Cg)([(0,D.lK)()],ol.prototype,"intensity",void 0),(0,w.Cg)([(0,D.lK)()],ol.prototype,"animated",void 0),(0,V.Y5)("BABYLON.GrainPostProcess",ol),W.w;class ll extends W.w{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,i=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let e=null;const i=this.getEngine(),s=this.getCamera();if(s)e=s.getScene();else if(i&&i.scenes){const t=i.scenes;e=t[t.length-1]}else e=t.q.LastCreatedScene;this._imageProcessingConfiguration=e?e.imageProcessingConfiguration:new Se.p}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateParameters()}))),i||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,i=null,s,r,n,a=0,o){super(e,"imageProcessing",[],[],t,i,s,r,n,null,a,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:0,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},o?(o.applyByPostProcess=!0,this._attachImageProcessingConfiguration(o,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=e=>{this.imageProcessingConfiguration.bind(e,this.aspectRatio)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(r.bind(r,7614)))):t.push(Promise.resolve().then(r.bind(r,3153))),super._gatherImports(e,t)}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const t in this._defines){const i=this._defines[t];switch(typeof i){case"number":case"string":e+=`#define ${t} ${i};\n`;break;default:i&&(e+=`#define ${t};\n`)}}const t=["textureSampler"],i=["scale"];Se.p&&(Se.p.PrepareSamplers(t,this._defines),Se.p.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}(0,w.Cg)([(0,D.lK)()],ll.prototype,"_fromLinearSpace",void 0),i.ThinEngine.prototype.restoreSingleAttachment=function(){const e=this._gl;this.bindAttachments([e.BACK])},i.ThinEngine.prototype.restoreSingleAttachmentForRenderTarget=function(){const e=this._gl;this.bindAttachments([e.COLOR_ATTACHMENT0])},i.ThinEngine.prototype.buildTextureLayout=function(e){const t=this._gl,i=[];for(let s=0;s<e.length;s++)e[s]?i.push(t["COLOR_ATTACHMENT"+s]):i.push(t.NONE);return i},i.ThinEngine.prototype.bindAttachments=function(e){this._gl.drawBuffers(e)},i.ThinEngine.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){this._currentRenderTarget=null;const s=this._gl,r=e._attachments,n=r.length;if(e._MSAAFramebuffer){s.bindFramebuffer(s.READ_FRAMEBUFFER,e._MSAAFramebuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,e._framebuffer);for(let t=0;t<n;t++){const i=e.textures[t];for(let e=0;e<n;e++)r[e]=s.NONE;r[t]=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"],s.readBuffer(r[t]),s.drawBuffers(r),s.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,s.COLOR_BUFFER_BIT,s.NEAREST)}for(let e=0;e<n;e++)r[e]=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];s.drawBuffers(r)}for(let i=0;i<n;i++){const r=e.textures[i];!r?.generateMipMaps||t||r?.isCube||r?.is3D||(this._bindTextureDirectly(s.TEXTURE_2D,r,!0),s.generateMipmap(s.TEXTURE_2D),this._bindTextureDirectly(s.TEXTURE_2D,null))}i&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),i()),this._bindUnboundFramebuffer(null)},i.ThinEngine.prototype.createMultipleRenderTarget=function(t,i,s=!0){let r=!1,n=!0,a=!1,o=!1,h=15,c=1,u=[],d=[],_=[],p=[],f=[],m=[],g=[],v=[];const b=this._createHardwareRenderTargetWrapper(!0,!1,t);void 0!==i&&(r=void 0!==i.generateMipMaps&&i.generateMipMaps,n=void 0===i.generateDepthBuffer||i.generateDepthBuffer,a=void 0!==i.generateStencilBuffer&&i.generateStencilBuffer,o=void 0!==i.generateDepthTexture&&i.generateDepthTexture,c=i.textureCount||1,i.types&&(u=i.types),i.samplingModes&&(d=i.samplingModes),i.useSRGBBuffers&&(_=i.useSRGBBuffers),i.formats&&(p=i.formats),i.targetTypes&&(f=i.targetTypes),i.faceIndex&&(m=i.faceIndex),i.layerIndex&&(g=i.layerIndex),i.layerCounts&&(v=i.layerCounts),this.webGLVersion>1&&(13===i.depthTextureFormat||17===i.depthTextureFormat||16===i.depthTextureFormat||14===i.depthTextureFormat||18===i.depthTextureFormat)&&(h=i.depthTextureFormat)),b.label=i?.label??"MultiRenderTargetWrapper";const x=this._gl,S=x.createFramebuffer();this._bindUnboundFramebuffer(S);const T=t.width||t,y=t.height||t,C=[],P=[],E=this.webGLVersion>1&&o&&(13===i.depthTextureFormat||17===i.depthTextureFormat||18===i.depthTextureFormat),A=this._setupFramebufferDepthAttachments(!E&&a,!o&&n,T,y);b._framebuffer=S,b._depthStencilBuffer=A,b._generateDepthBuffer=!o&&n,b._generateStencilBuffer=!E&&a,b._attachments=P;for(let t=0;t<c;t++){let i=d[t]||3,s=u[t]||0,n=_[t]||!1;const a=p[t]||5,o=f[t]||3553,h=v[t]??1;(1!==s||this._caps.textureFloatLinearFiltering)&&(2!==s||this._caps.textureHalfFloatLinearFiltering)||(i=1);const c=this._getSamplingParameters(i,r);1!==s||this._caps.textureFloat||(s=0,l.V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),n=n&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const m=this.webGLVersion>1,g=x[m?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"];if(P.push(g),-1===o)continue;const b=new e.h(this,6);C[t]=b,x.activeTexture(x["TEXTURE"+t]),x.bindTexture(o,b._hardwareTexture.underlyingResource),x.texParameteri(o,x.TEXTURE_MAG_FILTER,c.mag),x.texParameteri(o,x.TEXTURE_MIN_FILTER,c.min),x.texParameteri(o,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(o,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE);const S=this._getRGBABufferInternalSizedFormat(s,a,n),E=this._getInternalFormat(a),A=this._getWebGLTextureType(s);if(!m||35866!==o&&32879!==o)if(34067===o){for(let e=0;e<6;e++)x.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,S,T,y,0,E,A,null);b.isCube=!0}else x.texImage2D(x.TEXTURE_2D,0,S,T,y,0,E,A,null);else 35866===o?b.is2DArray=!0:b.is3D=!0,b.baseDepth=b.depth=h,x.texImage3D(o,0,S,T,y,h,0,E,A,null);r&&x.generateMipmap(o),this._bindTextureDirectly(o,null),b.baseWidth=T,b.baseHeight=y,b.width=T,b.height=y,b.isReady=!0,b.samples=1,b.generateMipMaps=r,b.samplingMode=i,b.type=s,b._useSRGBBuffer=n,b.format=a,this._internalTexturesCache.push(b)}if(o&&this._caps.depthTextureExtension){const t=new e.h(this,14);let i=5,s=x.DEPTH_COMPONENT16,n=x.DEPTH_COMPONENT,a=x.UNSIGNED_SHORT,o=x.DEPTH_ATTACHMENT;this.webGLVersion<2?s=x.DEPTH_COMPONENT:14===h?(i=1,a=x.FLOAT,s=x.DEPTH_COMPONENT32F):18===h?(i=0,a=x.FLOAT_32_UNSIGNED_INT_24_8_REV,s=x.DEPTH32F_STENCIL8,n=x.DEPTH_STENCIL,o=x.DEPTH_STENCIL_ATTACHMENT):16===h?(i=0,a=x.UNSIGNED_INT,s=x.DEPTH_COMPONENT24,o=x.DEPTH_ATTACHMENT):13!==h&&17!==h||(i=12,a=x.UNSIGNED_INT_24_8,s=x.DEPTH24_STENCIL8,n=x.DEPTH_STENCIL,o=x.DEPTH_STENCIL_ATTACHMENT),x.activeTexture(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,t._hardwareTexture.underlyingResource),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texImage2D(x.TEXTURE_2D,0,s,T,y,0,n,a,null),x.framebufferTexture2D(x.FRAMEBUFFER,o,x.TEXTURE_2D,t._hardwareTexture.underlyingResource,0),t.baseWidth=T,t.baseHeight=y,t.width=T,t.height=y,t.isReady=!0,t.samples=1,t.generateMipMaps=r,t.samplingMode=1,t.format=h,t.type=i,C[c]=t,this._internalTexturesCache.push(t)}return b.setTextures(C),s&&x.drawBuffers(P),this._bindUnboundFramebuffer(null),b.setLayerAndFaceIndices(g,m),this.resetTextureCache(),b},i.ThinEngine.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t,i=!0){if(this.webGLVersion<2||!e||!e.texture)return 1;if(e.samples===t)return t;const s=e._attachments.length;if(0===s)return 1;const r=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples);const n=!!e._depthStencilBuffer;if(n&&(r.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(r.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null),t>1&&"function"==typeof r.renderbufferStorageMultisample){const n=r.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=n,this._bindUnboundFramebuffer(n);const a=[];for(let t=0;t<s;t++)e.textures[t]._hardwareTexture.releaseMSAARenderBuffers();for(let i=0;i<s;i++){const s=e.textures[i],n=s._hardwareTexture,o=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],l=this._createRenderBuffer(s.width,s.height,t,-1,this._getRGBABufferInternalSizedFormat(s.type,s.format,s._useSRGBBuffer),o);if(!l)throw new Error("Unable to create multi sampled framebuffer");n.addMSAARenderBuffer(l),s.samples=t,a.push(o)}i&&r.drawBuffers(a)}else this._bindUnboundFramebuffer(e._framebuffer);return n&&(e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.texture.width,e.texture.height,t)),this._bindUnboundFramebuffer(null),t};class hl extends H.${get isSupported(){return this._engine?.getCaps().drawBuffersExtension??!1}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,s,r,n){const a=!(!r||!r.generateMipMaps)&&r.generateMipMaps,o=!(!r||!r.generateDepthTexture)&&r.generateDepthTexture,l=r&&r.depthTextureFormat?r.depthTextureFormat:15,h=!r||void 0===r.doNotChangeAspectRatio||r.doNotChangeAspectRatio,c=!(!r||!r.drawOnlyOnFirstAttachmentByDefault)&&r.drawOnlyOnFirstAttachmentByDefault;if(super(e,t,s,a,h,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported)return void this.dispose();this._textureNames=n;const u=[],d=[],_=[],p=[],f=[],m=[],g=[],v=[];this._initTypes(i,u,d,_,p,f,m,g,v,r);const b=!r||void 0===r.generateDepthBuffer||r.generateDepthBuffer,x=!(!r||void 0===r.generateStencilBuffer)&&r.generateStencilBuffer;this._multiRenderTargetOptions={samplingModes:d,generateMipMaps:a,generateDepthBuffer:b,generateStencilBuffer:x,generateDepthTexture:o,depthTextureFormat:l,types:u,textureCount:i,useSRGBBuffers:_,formats:p,targetTypes:f,faceIndex:m,layerIndex:g,layerCounts:v,labels:n,label:e},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=c,i>0&&(this._createInternalTextures(),this._createTextures(n))}_initTypes(e,t,i,s,r,n,a,o,l,h){for(let c=0;c<e;c++)h&&h.types&&void 0!==h.types[c]?t.push(h.types[c]):t.push(h&&h.defaultType?h.defaultType:0),h&&h.samplingModes&&void 0!==h.samplingModes[c]?i.push(h.samplingModes[c]):i.push(G.g.BILINEAR_SAMPLINGMODE),h&&h.useSRGBBuffers&&void 0!==h.useSRGBBuffers[c]?s.push(h.useSRGBBuffers[c]):s.push(!1),h&&h.formats&&void 0!==h.formats[c]?r.push(h.formats[c]):r.push(5),h&&h.targetTypes&&void 0!==h.targetTypes[c]?n.push(h.targetTypes[c]):n.push(3553),h&&h.faceIndex&&void 0!==h.faceIndex[c]?a.push(h.faceIndex[c]):a.push(0),h&&h.layerIndex&&void 0!==h.layerIndex[c]?o.push(h.layerIndex[c]):o.push(0),h&&h.layerCounts&&void 0!==h.layerCounts[c]?l.push(h.layerCounts[c]):l.push(1)}_createInternaTextureIndexMapping(){const e={},t=[];if(!this._renderTarget)return t;const i=this._renderTarget.textures;for(let s=0;s<i.length;s++){const r=i[s];if(!r)continue;const n=e[r.uniqueId];void 0!==n?t[s]=n:e[r.uniqueId]=s}return t}_rebuild(e=!1,t=!1,i){if(this._count<1||e)return;const s=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),t&&(this._releaseTextures(),this._createTextures(i));const r=this._renderTarget.textures;for(let e=0;e<r.length;e++){const t=this._textures[e];void 0!==s[e]&&this._renderTarget.setTexture(r[s[e]],e),t._texture=r[e],t._texture&&(t._noMipmap=!t._texture.useMipMaps,t._useSRGBBuffer=t._texture._useSRGBBuffer)}1!==this.samples&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){const s=new G.g(null,this.getScene());e?.[i]&&(s.name=e[i]),s._texture=t[i],s._texture&&(s._noMipmap=!s._texture.useMipMaps,s._useSRGBBuffer=s._texture._useSRGBBuffer),this._textures.push(s)}}setInternalTexture(e,t,i=!0){if(this.renderTarget&&(0===t&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new G.g(null,this.getScene()),this.textures[t].name=this._textureNames?.[t]??this.textures[t].name),this.textures[t]._texture=e,this.textures[t]._noMipmap=!e.useMipMaps,this.textures[t]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&-1!==this._multiRenderTargetOptions.targetTypes[t])){let i=0;i=e.is2DArray?35866:e.isCube?34067:e.is3D?32879:3553,this._multiRenderTargetOptions.targetTypes[t]=i}}setLayerAndFaceIndex(e,t=-1,i=-1){this.textures[e]&&this.renderTarget&&(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i))}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._processSizeParameter(e,!1),this._rebuild(!1,void 0,this._textureNames)}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const s=[],r=[],n=[],a=[],o=[],l=[],h=[],c=[];this._textureNames=i,this._initTypes(e,s,r,n,a,o,l,h,c,t),this._multiRenderTargetOptions.types=s,this._multiRenderTargetOptions.samplingModes=r,this._multiRenderTargetOptions.useSRGBBuffers=n,this._multiRenderTargetOptions.formats=a,this._multiRenderTargetOptions.targetTypes=o,this._multiRenderTargetOptions.faceIndex=l,this._multiRenderTargetOptions.layerIndex=h,this._multiRenderTargetOptions.layerCounts=c,this._multiRenderTargetOptions.labels=i,this._rebuild(!1,!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t)}))}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){const e=this._renderTarget?.textures;if(e){for(let t=e.length-1;t>=0;t--)this._textures[t]._texture=null;this._renderTarget?.dispose(),this._renderTarget=null}}}r(5007),r(6739);const cl=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];(0,q.TV)(cl);class ul{get normalsAreUnsigned(){return this._normalsAreUnsigned}_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add((()=>{})))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._enableScreenspaceDepth=!1,this._attachmentsFromPrePass=[]}_forceTextureType(e,t){e===ul.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===ul.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===ul.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===ul.DEPTH_TEXTURE_TYPE?(this._depthIndex=t,this._enableDepth=!0):e===ul.NORMAL_TEXTURE_TYPE?(this._normalIndex=t,this._enableNormal=!0):e===ul.SCREENSPACE_DEPTH_TEXTURE_TYPE&&(this._screenspaceDepthIndex=t,this._enableScreenspaceDepth=!0)}_setAttachments(e){this._attachmentsFromPrePass=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case ul.POSITION_TEXTURE_TYPE:return this._positionIndex;case ul.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case ul.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case ul.DEPTH_TEXTURE_TYPE:return this._depthIndex;case ul.NORMAL_TEXTURE_TYPE:return this._normalIndex;case ul.SCREENSPACE_DEPTH_TEXTURE_TYPE:return this._screenspaceDepthIndex;default:return-1}}get enableDepth(){return this._enableDepth}set enableDepth(e){this._enableDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableNormal(){return this._enableNormal}set enableNormal(e){this._enableNormal=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableScreenspaceDepth(){return this._enableScreenspaceDepth}set enableScreenspaceDepth(e){this._enableScreenspaceDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return"object"==typeof this._ratioOrDimensions?1:this._ratioOrDimensions}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=1,i=15,s){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._normalsAreUnsigned=!1,this._resizeObserver=null,this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._enableScreenspaceDepth=!1,this._clearColor=new M.ov(0,0,0,0),this._clearDepthColor=new M.ov(1e8,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._screenspaceDepthIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._shaderLanguage=0,this._shadersLoaded=!1,this._scene=e,this._ratioOrDimensions=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,this._textureTypesAndFormats=s||{},this._initShaderSourceAsync(),ul._SceneComponentInitialization(this._scene),this._createRenderTargets()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!ul.ForceGLSL?(this._shaderLanguage=1,await Promise.all([r.e(2564).then(r.bind(r,2564)),r.e(8574).then(r.bind(r,8574))])):await Promise.all([Promise.resolve().then(r.bind(r,6739)),Promise.resolve().then(r.bind(r,5007))]),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;const i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;const s=[],r=[O.R.PositionKind,O.R.NormalKind],n=e.getMesh();if(i){let e=!1;if(i.needAlphaTesting()&&i.getAlphaTestTexture()&&(s.push("#define ALPHATEST"),s.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),e=!0),i.bumpTexture&&Pe.BumpTextureEnabled&&(s.push("#define BUMP"),s.push(`#define BUMP_UV${i.bumpTexture.coordinatesIndex+1}`),e=!0),this._enableReflectivity){let t=!1;"PBRMetallicRoughnessMaterial"===i.getClassName()?(i.metallicRoughnessTexture&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!=i.metallic&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),t=!0),null!=i.roughness&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),t=!0),t&&(i.baseTexture&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),e=!0),i.baseColor&&s.push("#define ALBEDOCOLOR"))):"PBRSpecularGlossinessMaterial"===i.getClassName()?(i.specularGlossinessTexture?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),e=!0,i.specularGlossinessTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor&&s.push("#define REFLECTIVITYCOLOR"),null!=i.glossiness&&s.push("#define GLOSSINESS")):"PBRMaterial"===i.getClassName()?(i.metallicTexture&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!=i.metallic&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),t=!0),null!=i.roughness&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),t=!0),t?(i.albedoTexture&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),e=!0),i.albedoColor&&s.push("#define ALBEDOCOLOR")):(i.reflectivityTexture?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0):i.reflectivityColor&&s.push("#define REFLECTIVITYCOLOR"),null!=i.microSurface&&s.push("#define GLOSSINESS"))):"StandardMaterial"===i.getClassName()&&(i.specularTexture&&(s.push("#define REFLECTIVITYTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0),i.specularColor&&s.push("#define REFLECTIVITYCOLOR"))}e&&(s.push("#define NEED_UV"),n.isVerticesDataPresent(O.R.UVKind)&&(r.push(O.R.UVKind),s.push("#define UV1")),n.isVerticesDataPresent(O.R.UV2Kind)&&(r.push(O.R.UV2Kind),s.push("#define UV2")))}this._enableDepth&&(s.push("#define DEPTH"),s.push("#define DEPTH_INDEX "+this._depthIndex)),this._enableNormal&&(s.push("#define NORMAL"),s.push("#define NORMAL_INDEX "+this._normalIndex)),this._enablePosition&&(s.push("#define POSITION"),s.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(s.push("#define VELOCITY"),s.push("#define VELOCITY_INDEX "+this._velocityIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(n)&&s.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(s.push("#define REFLECTIVITY"),s.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this._enableScreenspaceDepth&&-1!==this._screenspaceDepthIndex&&(s.push("#define SCREENSPACE_DEPTH_INDEX "+this._screenspaceDepthIndex),s.push("#define SCREENSPACE_DEPTH")),this.generateNormalsInWorldSpace&&s.push("#define NORMAL_WORLDSPACE"),this._normalsAreUnsigned&&s.push("#define ENCODE_NORMAL"),n.useBones&&n.computeBonesUsingShaders&&n.skeleton?(r.push(O.R.MatricesIndicesKind),r.push(O.R.MatricesWeightsKind),n.numBoneInfluencers>4&&(r.push(O.R.MatricesIndicesExtraKind),r.push(O.R.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),s.push("#define BONETEXTURE "+n.skeleton.isUsingTextureForMatrices),s.push("#define BonesPerMesh "+(n.skeleton.bones.length+1))):(s.push("#define NUM_BONE_INFLUENCERS 0"),s.push("#define BONETEXTURE false"),s.push("#define BonesPerMesh 0"));const a=n.morphTargetManager;let o=0;a&&(o=a.numMaxInfluencers||a.numInfluencers,o>0&&(s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+o),a.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),(0,$.MF)(r,n,o))),t&&(s.push("#define INSTANCES"),(0,$.te)(r,this._enableVelocity),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),this._linkedWithPrePass?s.push("#define SCENE_MRT_COUNT "+this._attachmentsFromPrePass.length):s.push("#define SCENE_MRT_COUNT "+this._multiRenderTarget.textures.length),(0,q.tv)(i,this._scene,s);const l=this._scene.getEngine(),h=e._getDrawWrapper(void 0,!0),c=h.defines,u=s.join("\n");return c!==u&&h.setEffect(l.createEffect("geometry",{attributes:r,uniformsNames:cl,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:u,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:o},shaderLanguage:this.shaderLanguage},l),u),h.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){const e=[],t=[];let i=0;return this._enableDepth&&(this._depthIndex=i,i++,e.push("gBuffer_Depth"),t.push(this._textureTypesAndFormats[ul.DEPTH_TEXTURE_TYPE])),this._enableNormal&&(this._normalIndex=i,i++,e.push("gBuffer_Normal"),t.push(this._textureTypesAndFormats[ul.NORMAL_TEXTURE_TYPE])),this._enablePosition&&(this._positionIndex=i,i++,e.push("gBuffer_Position"),t.push(this._textureTypesAndFormats[ul.POSITION_TEXTURE_TYPE])),this._enableVelocity&&(this._velocityIndex=i,i++,e.push("gBuffer_Velocity"),t.push(this._textureTypesAndFormats[ul.VELOCITY_TEXTURE_TYPE])),this._enableReflectivity&&(this._reflectivityIndex=i,i++,e.push("gBuffer_Reflectivity"),t.push(this._textureTypesAndFormats[ul.REFLECTIVITY_TEXTURE_TYPE])),this._enableScreenspaceDepth&&(this._screenspaceDepthIndex=i,i++,e.push("gBuffer_ScreenspaceDepth"),t.push(this._textureTypesAndFormats[ul.SCREENSPACE_DEPTH_TEXTURE_TYPE])),[i,e,t]}_createRenderTargets(){const e=this._scene.getEngine(),[t,i,s]=this._assignRenderTargetIndices();let r=0;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?r=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(r=2);const n=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions},a=[],o=[];for(const e of s)e?(a.push(e.textureType),o.push(e.textureFormat)):(a.push(r),o.push(5));if(this._normalsAreUnsigned=11===a[ul.NORMAL_TEXTURE_TYPE]||13===a[ul.NORMAL_TEXTURE_TYPE],this._multiRenderTarget=new hl("gBuffer",n,t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,types:a,formats:o,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=G.g.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=G.g.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;const l=[!0],h=[!1],c=[!0];for(let e=1;e<t;++e)l.push(!0),c.push(!1),h.push(!0);const u=e.buildTextureLayout(l),d=e.buildTextureLayout(h),_=e.buildTextureLayout(c);this._multiRenderTarget.onClearObservable.add((e=>{e.bindAttachments(this.useSpecificClearForDepthTexture?d:u),e.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(e.bindAttachments(_),e.clear(this._clearDepthColor,!0,!0,!0)),e.bindAttachments(u)})),this._resizeObserver=e.onResizeObservable.add((()=>{if(this._multiRenderTarget){const t=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(t)}}));const p=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),s=this._scene,r=s.getEngine(),n=e.getMaterial();if(!n)return;if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,this._enableVelocity&&!this._previousTransformationMatrices[i.uniqueId]&&(this._previousTransformationMatrices[i.uniqueId]={world:I.uq.Identity(),viewProjection:s.getTransformMatrix()},t.skeleton)){const e=t.skeleton.getTransformMatrices(t);this._previousBonesTransformationMatrices[t.uniqueId]=this._copyBonesTransformationMatrices(e,new Float32Array(e.length))}const a=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(a.mustReturn)return;const o=r.getCaps().instancedArrays&&(null!==a.visibleInstances[e._id]||t.hasThinInstances),l=i.getWorldMatrix();if(this.isReady(e,o)){const h=e._getDrawWrapper();if(!h)return;const c=h.effect;let u;r.enableEffect(h),o||t._bind(e,c,n.fillMode),this._useUbo?((0,$._8)(c,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(c.setMatrix("viewProjection",s.getTransformMatrix()),c.setMatrix("view",s.getViewMatrix()));const d=t._instanceDataStorage;if(d.isFrozen||!n.backFaceCulling&&null===n.sideOrientation)u=d.sideOrientation;else{const e=i._getWorldMatrixDeterminant();u=n._getEffectiveOrientation(t),e<0&&(u=u===Te.i.ClockWiseSideOrientation?Te.i.CounterClockWiseSideOrientation:Te.i.ClockWiseSideOrientation)}if(n._preBind(h,u),n.needAlphaTesting()){const e=n.getAlphaTestTexture();e&&(c.setTexture("diffuseSampler",e),c.setMatrix("diffuseMatrix",e.getTextureMatrix()))}if(n.bumpTexture&&s.getEngine().getCaps().standardDerivatives&&Pe.BumpTextureEnabled&&(c.setFloat3("vBumpInfos",n.bumpTexture.coordinatesIndex,1/n.bumpTexture.level,n.parallaxScaleBias),c.setMatrix("bumpMatrix",n.bumpTexture.getTextureMatrix()),c.setTexture("bumpSampler",n.bumpTexture),c.setFloat2("vTangentSpaceParams",n.invertNormalMapX?-1:1,n.invertNormalMapY?-1:1)),this._enableReflectivity&&("PBRMetallicRoughnessMaterial"===n.getClassName()?(null!==n.metallicRoughnessTexture&&(c.setTexture("reflectivitySampler",n.metallicRoughnessTexture),c.setMatrix("reflectivityMatrix",n.metallicRoughnessTexture.getTextureMatrix())),null!==n.metallic&&c.setFloat("metallic",n.metallic),null!==n.roughness&&c.setFloat("glossiness",1-n.roughness),null!==n.baseTexture&&(c.setTexture("albedoSampler",n.baseTexture),c.setMatrix("albedoMatrix",n.baseTexture.getTextureMatrix())),null!==n.baseColor&&c.setColor3("albedoColor",n.baseColor)):"PBRSpecularGlossinessMaterial"===n.getClassName()?(null!==n.specularGlossinessTexture?(c.setTexture("reflectivitySampler",n.specularGlossinessTexture),c.setMatrix("reflectivityMatrix",n.specularGlossinessTexture.getTextureMatrix())):null!==n.specularColor&&c.setColor3("reflectivityColor",n.specularColor),null!==n.glossiness&&c.setFloat("glossiness",n.glossiness)):"PBRMaterial"===n.getClassName()?(null!==n.metallicTexture&&(c.setTexture("reflectivitySampler",n.metallicTexture),c.setMatrix("reflectivityMatrix",n.metallicTexture.getTextureMatrix())),null!==n.metallic&&c.setFloat("metallic",n.metallic),null!==n.roughness&&c.setFloat("glossiness",1-n.roughness),null!==n.roughness||null!==n.metallic||null!==n.metallicTexture?(null!==n.albedoTexture&&(c.setTexture("albedoSampler",n.albedoTexture),c.setMatrix("albedoMatrix",n.albedoTexture.getTextureMatrix())),null!==n.albedoColor&&c.setColor3("albedoColor",n.albedoColor)):(null!==n.reflectivityTexture?(c.setTexture("reflectivitySampler",n.reflectivityTexture),c.setMatrix("reflectivityMatrix",n.reflectivityTexture.getTextureMatrix())):null!==n.reflectivityColor&&c.setColor3("reflectivityColor",n.reflectivityColor),null!==n.microSurface&&c.setFloat("glossiness",n.microSurface))):"StandardMaterial"===n.getClassName()&&(null!==n.specularTexture&&(c.setTexture("reflectivitySampler",n.specularTexture),c.setMatrix("reflectivityMatrix",n.specularTexture.getTextureMatrix())),null!==n.specularColor&&c.setColor3("reflectivityColor",n.specularColor))),(0,q.gS)(c,n,this._scene),t.useBones&&t.computeBonesUsingShaders&&t.skeleton){const e=t.skeleton;if(e.isUsingTextureForMatrices&&c.getUniformIndex("boneTextureWidth")>-1){const i=e.getTransformMatrixTexture(t);c.setTexture("boneSampler",i),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",t.skeleton.getTransformMatrices(t));this._enableVelocity&&c.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[t.uniqueId])}(0,$.nR)(t,c),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(c),this._enableVelocity&&(c.setMatrix("previousWorld",this._previousTransformationMatrices[i.uniqueId].world),c.setMatrix("previousViewProjection",this._previousTransformationMatrices[i.uniqueId].viewProjection)),o&&t.hasThinInstances&&c.setMatrix("world",l),t._processRendering(i,e,c,n.fillMode,a,o,((e,t)=>{e||c.setMatrix("world",t)}))}this._enableVelocity&&(this._previousTransformationMatrices[i.uniqueId].world=l.clone(),this._previousTransformationMatrices[i.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),t.skeleton&&this._copyBonesTransformationMatrices(t.skeleton.getTransformMatrices(t),this._previousBonesTransformationMatrices[i.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(t,i,s)=>{if((s||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){const s=t.subMeshes[i],r=s.getMaterial(),n=s.getRenderingMesh();if(!r)continue;const a=n._getInstancesRenderList(s._id,!!s.getReplacementMesh()),o=e.getCaps().instancedArrays&&(null!==a.visibleInstances[s._id]||n.hasThinInstances);if(!this.isReady(s,o))return!1}return!0},this._multiRenderTarget.customRenderFunction=(t,i,s,r)=>{let n;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(r.length){for(e.setColorWrite(!1),n=0;n<r.length;n++)p(r.data[n]);e.setColorWrite(!0)}for(n=0;n<t.length;n++)p(t.data[n]);for(e.setDepthWrite(!1),n=0;n<i.length;n++)p(i.data[n]);if(this.renderTransparentMeshes)for(n=0;n<s.length;n++)p(s.data[n]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}ul.ForceGLSL=!1,ul.DEPTH_TEXTURE_TYPE=0,ul.NORMAL_TEXTURE_TYPE=1,ul.POSITION_TEXTURE_TYPE=2,ul.VELOCITY_TEXTURE_TYPE=3,ul.REFLECTIVITY_TEXTURE_TYPE=4,ul.SCREENSPACE_DEPTH_TEXTURE_TYPE=5,ul._SceneComponentInitialization=e=>{throw(0,F.n)("GeometryBufferRendererSceneComponent")};class dl{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(be.Z.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){e&&e.isSupported&&(this._geometryBufferRenderer=e)},enumerable:!0,configurable:!0}),be.Z.prototype.enableGeometryBufferRenderer=function(e=1,t=15,i){return this._geometryBufferRenderer||(this._geometryBufferRenderer=new ul(this,e,t,i),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null)),this._geometryBufferRenderer},be.Z.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class _l{constructor(e){this.name=fe.v.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(fe.v.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}ul._SceneComponentInitialization=e=>{let t=e._getComponent(fe.v.NAME_GEOMETRYBUFFERRENDERER);t||(t=new _l(e),e._addComponent(t))};class pl extends W.w{get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,i,s,r,n,a,o=0,l=!1,h=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],i,s,r,n,a,"#define GEOMETRY_SUPPORTED\n#define SAMPLES 64.0\n#define OBJECT_BASED",o,void 0,null,l),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=h,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new dl)),this._applyMode()}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(r.bind(r,8075))]))):t.push(Promise.all([Promise.resolve().then(r.bind(r,5830))])),super._gatherImports(e,t)}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}const i=t.indexOf(e);-1!==i&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return l.V.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased),this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=I.uq.Identity(),this._previousViewProjection=this._scene.getTransformMatrix().clone(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new I.I9(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(ul.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){const t=I.AA.Matrix[0];if(t.copyFrom(this._scene.getTransformMatrix()),t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(t),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setVector2("screenSize",new I.I9(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(ul.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[t])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){const e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join("\n"))}}static _Parse(e,t,i,s){return N.p.Parse((()=>new pl(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1)),e,i,s)}}(0,w.Cg)([(0,D.lK)()],pl.prototype,"motionStrength",void 0),(0,w.Cg)([(0,D.lK)()],pl.prototype,"motionBlurSamples",null),(0,w.Cg)([(0,D.lK)()],pl.prototype,"isObjectBased",null),(0,V.Y5)("BABYLON.MotionBlurPostProcess",pl);ae.l.ShadersStore.refractionPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D refractionSampler;uniform vec3 baseColor;uniform float depth;uniform float colorLevel;void main() {float ref=1.0-texture2D(refractionSampler,vUV).r;vec2 uv=vUV-vec2(0.5);vec2 offset=uv*depth*ref;vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);}";class fl extends W.w{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,s,r,n,a,o,l,h){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],n,a,o,l,h),this._ownRefractionTexture=!0,this.color=i,this.depth=s,this.colorLevel=r,this.refractionTextureUrl=t,this.onActivateObservable.add((e=>{this._refTexture=this._refTexture||new G.g(t,e.getScene())})),this.onApplyObservable.add((e=>{e.setColor3("baseColor",this.color),e.setFloat("depth",this.depth),e.setFloat("colorLevel",this.colorLevel),e.setTexture("refractionSampler",this._refTexture)}))}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,s){return N.p.Parse((()=>new fl(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}(0,w.Cg)([(0,D.lK)()],fl.prototype,"color",void 0),(0,w.Cg)([(0,D.lK)()],fl.prototype,"depth",void 0),(0,w.Cg)([(0,D.lK)()],fl.prototype,"colorLevel",void 0),(0,w.Cg)([(0,D.lK)()],fl.prototype,"refractionTextureUrl",void 0),(0,V.Y5)("BABYLON.RefractionPostProcess",fl),r(8438);class ml extends W.w{getClassName(){return"SharpenPostProcess"}constructor(e,t,i,s,r,n,a=0,o=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,i,s,r,n,null,a,void 0,null,o),this.colorAmount=1,this.edgeAmount=.3,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(r.bind(r,5381))]))):t.push(Promise.all([Promise.resolve().then(r.bind(r,8438))])),super._gatherImports(e,t)}static _Parse(e,t,i,s){return N.p.Parse((()=>new ml(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,s)}}(0,w.Cg)([(0,D.lK)()],ml.prototype,"colorAmount",void 0),(0,w.Cg)([(0,D.lK)()],ml.prototype,"edgeAmount",void 0),(0,V.Y5)("BABYLON.SharpenPostProcess",ml);class gl{get name(){return this._name}get cameras(){return this._cameras}get engine(){return this._engine}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const i=this._renderEffects[e];i&&i._enable(ee.S0.MakeArray(t||this._cameras))}_disableEffect(e,t){const i=this._renderEffects[e];i&&i._disable(ee.S0.MakeArray(t||this._cameras))}_attachCameras(e,t){const i=ee.S0.MakeArray(e||this._cameras);if(!i)return;const s=[];let r;for(r=0;r<i.length;r++){const e=i[r];e&&(-1===this._cameras.indexOf(e)?this._cameras.push(e):t&&s.push(r))}for(r=0;r<s.length;r++)i.splice(s[r],1);for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._attachCameras(i)}_detachCameras(e){const t=ee.S0.MakeArray(e||this._cameras);if(t){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._detachCameras(t);for(let e=0;e<t.length;e++)this._cameras.splice(this._cameras.indexOf(t[e]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}_adaptPostProcessesToViewPort(){const e=Object.keys(this._renderEffects);for(const t of e){const e=this._renderEffects[t].getPostProcesses();if(e)for(const t of e)t.adaptScaleToCurrentViewport=!0}}setPrePassRenderer(e){return!1}dispose(){}}(0,w.Cg)([(0,D.lK)()],gl.prototype,"_name",void 0);class vl{constructor(){this._renderPipelines={}}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}removePipeline(e){delete this._renderPipelines[e]}attachCamerasToRenderPipeline(e,t,i=!1){const s=this._renderPipelines[e];s&&s._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){const i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];s&&s._enableEffect(t,i)}disableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];s&&s._disableEffect(t,i)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}Object.defineProperty(be.Z.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let e=this._getComponent(fe.v.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new bl(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new vl}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class bl{constructor(e){this.name=fe.v.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(fe.v.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class xl extends gl{get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new $o(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new sl(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let e=0;e<this._cameras.length;e++)t.disposeEffects(this._cameras[e]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new xo("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return null!=this._glowLayer}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",i=!0,s=t.q.LastCreatedScene,r,n=!0){super(s.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=0,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new C.cP,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=r||s.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=n,this._scene=s;const a=this._scene.getEngine().getCaps();this._hdr=i&&(a.textureHalfFloatRender||a.textureFloatRender),this._hdr?a.textureHalfFloatRender?this._defaultPipelineTextureType=2:a.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,s.postProcessRenderPipelineManager.addPipeline(this);const o=this._scene.getEngine();this.sharpen=new ml("sharpen",1,null,G.g.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new Qo(o,this.SharpenPostProcessId,(()=>this.sharpen),!0),this.depthOfField=new sl(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=o.getHardwareScalingLevel(),this._resizeObserver=o.onResizeObservable.add((()=>{this._hardwareScaleLevel=o.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel})),this.bloom=new $o(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new jo("ChromaticAberration",o.getRenderWidth(),o.getRenderHeight(),1,null,G.g.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new Qo(o,this.ChromaticAberrationPostProcessId,(()=>this.chromaticAberration),!0),this.grain=new ol("Grain",1,null,G.g.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new Qo(o,this.GrainPostProcessId,(()=>this.grain),!0);let l=!0;this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add((()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,l?ee.S0.SetImmediate((()=>{this._buildPipeline()})):this._buildPipeline())})),this._buildPipeline(),l=!1}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const e of this._cameras)this._scene.enableDepthRenderer(e).useOnlyInActiveCamera=!0;this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add((e=>{this._cameras.indexOf(e.activeCamera)>-1&&(this.depthOfField.depthTexture=e.enableDepthRenderer(e.activeCamera).getDepthMap())}))}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const e=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=e.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new ll("imageProcessing",1,null,G.g.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new Qo(e,this.ImageProcessingPostProcessId,(()=>this.imageProcessing),!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._cameras&&0!==this._cameras.length||(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new al("fxaa",1,null,G.g.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new Qo(e,this.FxaaPostProcessId,(()=>this.fxaa),!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera))&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add((()=>{this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera)&&(this._scene.autoClear=!0)}))),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add((()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)}))),this._adaptPostProcessesToViewPort(),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&l.V.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene._postProcessRenderPipelineManager.removePipeline(this.name),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=N.p.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return N.p.Parse((()=>new xl(e._name,e._name._hdr,t)),e,t,i)}}(0,w.Cg)([(0,D.lK)()],xl.prototype,"sharpenEnabled",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"bloomKernel",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"_bloomWeight",void 0),(0,w.Cg)([(0,D.lK)()],xl.prototype,"_bloomThreshold",void 0),(0,w.Cg)([(0,D.lK)()],xl.prototype,"_hdr",void 0),(0,w.Cg)([(0,D.lK)()],xl.prototype,"bloomWeight",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"bloomThreshold",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"bloomScale",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"bloomEnabled",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"depthOfFieldEnabled",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"depthOfFieldBlurLevel",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"fxaaEnabled",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"samples",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"imageProcessingEnabled",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"glowLayerEnabled",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"chromaticAberrationEnabled",null),(0,w.Cg)([(0,D.lK)()],xl.prototype,"grainEnabled",null),(0,V.Y5)("BABYLON.DefaultRenderingPipeline",xl),r(2048);ae.l.ShadersStore.lensHighlightsPixelShader="uniform sampler2D textureSampler; \nuniform float gain;uniform float threshold;uniform float screen_width;uniform float screen_height;varying vec2 vUV;vec4 highlightColor(vec4 color) {vec4 highlight=color;float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));float lum_threshold;if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);highlight*=luminance*gain;highlight.a=1.0;return highlight;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 original=texture2D(textureSampler,vUV);if (gain==-1.0) {gl_FragColor=vec4(0.0,0.0,0.0,1.0);return;}\nfloat w=2.0/screen_width;float h=2.0/screen_height;float weight=1.0;vec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;gl_FragColor=blurred;}";ae.l.ShadersStore.depthOfFieldPixelShader="uniform sampler2D textureSampler;uniform sampler2D highlightsSampler;uniform sampler2D depthSampler;uniform sampler2D grainSampler;uniform float grain_amount;uniform bool blur_noise;uniform float screen_width;uniform float screen_height;uniform float distortion;uniform bool dof_enabled;uniform float screen_distance; \nuniform float aperture;uniform float darken;uniform float edge_blur;uniform bool highlights;uniform float near;uniform float far;varying vec2 vUV;\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \nvec2 centered_screen_pos;vec2 distorted_coords;float radius2;float radius;vec2 rand(vec2 co)\n{float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));return clamp(vec2(noise1,noise2),0.0,1.0);}\nvec2 getDistortedCoords(vec2 coords) {if (distortion==0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);vec2 dist_coords=vec2(0.5,0.5);dist_coords.x=0.5+direction.x*radius2*1.0;dist_coords.y=0.5+direction.y*radius2*1.0;float dist_amount=clamp(distortion*0.23,0.0,1.0);dist_coords=mix(coords,dist_coords,dist_amount);return dist_coords;}\nfloat sampleScreen(inout vec4 color,in vec2 offset,in float weight) {vec2 coords=distorted_coords;float angle=rand(coords*100.0).x*TWOPI;coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));color+=texture2D(textureSampler,coords)*weight;return weight;}\nfloat getBlurLevel(float size) {return min(3.0,ceil(size/1.0));}\nvec4 getBlurColor(float size) {vec4 col=texture2D(textureSampler,distorted_coords);float blur_level=getBlurLevel(size);float w=(size/screen_width);float h=(size/screen_height);float total_weight=1.0;vec2 sample_coords;total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);if (blur_level>1.0) {total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);}\nif (blur_level>2.0) {total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);}\ncol/=total_weight; \nif (darken>0.0) {col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);}\nreturn col;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;radius=sqrt(radius2);distorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));if (dof_enabled==false || coc<0.07) { coc=0.0; }\nfloat edge_blur_amount=0.0;if (edge_blur>0.0) {edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;}\nfloat blur_amount=max(edge_blur_amount,coc);if (blur_amount==0.0) {gl_FragColor=texture2D(textureSampler,distorted_coords);}\nelse {gl_FragColor=getBlurColor(blur_amount*1.7);if (highlights) {gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;}\nif (blur_noise) {vec2 noise=rand(distorted_coords)*0.01*blur_amount;vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;}}\nif (grain_amount>0.0) {vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;}}\n";class Sl{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}class Tl extends gl{set epsilon(e){this._epsilon=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set bypassBlur(e){const t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this._blurHPostProcess.updateEffect(t.h,null,i),this._blurVPostProcess.updateEffect(t.v,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){const t=this._getDefinesForBlur(e,this._bypassBlur);this._blurHPostProcess.updateEffect(t.h),this._blurVPostProcess.updateEffect(t.v),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=t.q.LastCreatedEngine;return!!e&&e._features.supportSSAO2}get scene(){return this._scene}constructor(e,t,i,s,r=!1,n=0){if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._epsilon=.02,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this.radius=2,this.base=0,this._bypassBlur=!1,this._expensiveBlur=!0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._textureType=n,this._forceGeometryBuffer=r,!this.isSupported)return void l.V.Error("The current engine does not support SSAO 2.");const a=this._ratio.ssaoRatio||i,o=this._ratio.blurRatio||i;this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),t.geometryBufferRenderer?.generateNormalsInWorldSpace&&l.V.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!")):(t.enablePrePassRenderer(),t.prePassRenderer?.generateNormalsInWorldSpace&&l.V.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!")),this._createRandomTexture(),this._originalColorPostProcess=new Mo.v("SSAOOriginalSceneColor",1,null,G.g.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,n),this._createBlurPostProcess(a,o,this._textureType),this._createSSAOCombinePostProcess(o,this._textureType),this.addEffect(new Qo(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new Qo(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new Qo(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new Qo(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new Qo(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_rebuild(){super._rebuild()}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i="#define BLUR\n";return t&&(i+="#define BLUR_BYPASS\n"),e||(i+="#define BLUR_LEGACY\n"),{h:i+"#define BLUR_H\n",v:i}}_createBlurPostProcess(e,t,i){const s=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),r=this._getSamplersForBlur(this.bypassBlur);this._blurHPostProcess=this._createBlurFilter("BlurH",r,e,s.h,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",r,t,s.v,i,!1)}_createBlurFilter(e,t,i,s,n,a){const o=new W.w(e,"ssao2",["outSize","samples","soften","tolerance"],t,i,null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s,n,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(r.bind(r,5076))):t.push(Promise.resolve().then(r.bind(r,5363)))}));return o.onApply=e=>{if(!this._scene.activeCamera)return;const t=a?this._ssaoCombinePostProcess.width:this._ssaoCombinePostProcess.height,i=a?this._originalColorPostProcess.width:this._originalColorPostProcess.height;e.setFloat("outSize",t>0?t:i),e.setInt("samples",this.bilateralSamples),e.setFloat("soften",this.bilateralSoften),e.setFloat("tolerance",this.bilateralTolerance),this._geometryBufferRenderer?e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},o.samples=this.textureSamples,o.autoClear=!1,o}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,2.3283064365386963e-10*this._bits[0]}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const i=2*t*Math.PI,s=1-.85*e,r=Math.sqrt(1-s*s);return new I.Pq(Math.cos(i)*r,Math.sin(i)*r,s)}_generateHemisphere(){const e=this.samples,t=[];let i,s=0;for(;s<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{const t=this._hammersley(s,e);i=this._hemisphereSample_uniform(t[0],t[1])}t.push(i.x,i.y,i.z),s++}return t}_getDefinesForSSAO(){return`#define SSAO\n#define SAMPLES ${this.samples}\n#define EPSILON ${this.epsilon.toFixed(4)}`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const i=this._getDefinesForSSAO();this._ssaoPostProcess=new W.w("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],["randomSampler","depthSampler","normalSampler"],e,null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i,t,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(r.bind(r,5076))):t.push(Promise.resolve().then(r.bind(r,5363)))})),this._ssaoPostProcess.autoClear=!1,this._ssaoPostProcess.onApply=e=>{if(this._scene.activeCamera){if(e.setArray3("sampleSphere",this._sampleSphere),e.setFloat("randTextureTiles",32),e.setFloat("samplesFactor",1/this.samples),e.setFloat("totalStrength",this.totalStrength),e.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),e.setFloat("radius",this.radius),e.setFloat("maxZ",this.maxZ),e.setFloat("minZAspect",this.minZAspect),e.setFloat("base",this.base),e.setFloat("near",this._scene.activeCamera.minZ),this._scene.activeCamera.mode===se.PERSPECTIVE_CAMERA)e.setMatrix3x3("depthProjection",Tl.PERSPECTIVE_DEPTH_PROJECTION),e.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),e.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const t=this._scene.getEngine().getRenderWidth()/2,i=this._scene.getEngine().getRenderHeight()/2,s=this._scene.activeCamera.orthoLeft??-t,r=this._scene.activeCamera.orthoRight??t,n=this._scene.activeCamera.orthoBottom??-i,a=this._scene.activeCamera.orthoTop??i;e.setMatrix3x3("depthProjection",Tl.ORTHO_DEPTH_PROJECTION),e.setFloat("xViewport",.5*(r-s)),e.setFloat("yViewport",.5*(a-n))}e.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),e.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),e.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new Sl)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new W.w("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(r.bind(r,598))):t.push(Promise.resolve().then(r.bind(r,4154)))})),this._ssaoCombinePostProcess.onApply=e=>{const t=this._scene.activeCamera.viewport;e.setVector4("viewport",I.AA.Vector4[0].copyFromFloats(t.x,t.y,t.width,t.height)),e.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.autoClear=!1,this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){const e=new Uint8Array(65536),t=I.I9.Zero();for(let i=0;i<e.length;)t.set((0,Nt.RandomRange)(0,1),(0,Nt.RandomRange)(0,1)).normalize().scaleInPlace(255),e[i++]=Math.floor(t.x),e[i++]=Math.floor(t.y),e[i++]=0,e[i++]=255;const i=ya.CreateRGBATexture(e,128,128,this._scene,!1,!1,2);i.name="SSAORandomTexture",i.wrapU=G.g.WRAP_ADDRESSMODE,i.wrapV=G.g.WRAP_ADDRESSMODE,this._randomTexture=i}serialize(){const e=N.p.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return N.p.Parse((()=>new Tl(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType)),e,t,i)}}Tl.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],Tl.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],(0,w.Cg)([(0,D.lK)()],Tl.prototype,"totalStrength",void 0),(0,w.Cg)([(0,D.lK)()],Tl.prototype,"maxZ",void 0),(0,w.Cg)([(0,D.lK)()],Tl.prototype,"minZAspect",void 0),(0,w.Cg)([(0,D.lK)("epsilon")],Tl.prototype,"_epsilon",void 0),(0,w.Cg)([(0,D.lK)("samples")],Tl.prototype,"_samples",void 0),(0,w.Cg)([(0,D.lK)("textureSamples")],Tl.prototype,"_textureSamples",void 0),(0,w.Cg)([(0,D.lK)()],Tl.prototype,"_forceGeometryBuffer",void 0),(0,w.Cg)([(0,D.lK)()],Tl.prototype,"_ratio",void 0),(0,w.Cg)([(0,D.lK)()],Tl.prototype,"_textureType",void 0),(0,w.Cg)([(0,D.lK)()],Tl.prototype,"radius",void 0),(0,w.Cg)([(0,D.lK)()],Tl.prototype,"base",void 0),(0,w.Cg)([(0,D.lK)("bypassBlur")],Tl.prototype,"_bypassBlur",void 0),(0,w.Cg)([(0,D.lK)("expensiveBlur")],Tl.prototype,"_expensiveBlur",void 0),(0,w.Cg)([(0,D.lK)()],Tl.prototype,"bilateralSamples",void 0),(0,w.Cg)([(0,D.lK)()],Tl.prototype,"bilateralSoften",void 0),(0,w.Cg)([(0,D.lK)()],Tl.prototype,"bilateralTolerance",void 0),(0,V.Y5)("BABYLON.SSAO2RenderingPipeline",Tl);ae.l.ShadersStore.ssaoPixelShader="uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float radius;uniform float area;uniform float fallOff;uniform float base;vec3 normalFromDepth(float depth,vec2 coords)\n{vec2 offset1=vec2(0.0,radius);vec2 offset2=vec2(radius,0.0);float depth1=texture2D(textureSampler,coords+offset1).r;float depth2=texture2D(textureSampler,coords+offset2).r;vec3 p1=vec3(offset1,depth1-depth);vec3 p2=vec3(offset2,depth2-depth);vec3 normal=cross(p1,p2);normal.z=-normal.z;return normalize(normal);}\nvoid main()\n{vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);float depth=texture2D(textureSampler,vUV).r;vec3 position=vec3(vUV,depth);vec3 normal=normalFromDepth(depth,vUV);float radiusDepth=radius/depth;float occlusion=0.0;vec3 ray;vec3 hemiRay;float occlusionDepth;float difference;for (int i=0; i<SAMPLES; i++)\n{ray=radiusDepth*reflect(sampleSphere[i],random);hemiRay=position+sign(dot(ray,normal))*ray;occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;difference=depth-occlusionDepth;occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor.r=result;gl_FragColor.g=result;gl_FragColor.b=result;gl_FragColor.a=1.0;}\n#endif\n",r(4154);class yl extends gl{get scene(){return this._scene}constructor(e,t,i,s){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const r=i.ssaoRatio||i,n=i.combineRatio||i;this._originalColorPostProcess=new Mo.v("SSAOOriginalSceneColor",n,null,G.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(r),this._createBlurPostProcess(r),this._createSSAOCombinePostProcess(n),this.addEffect(new Qo(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new Qo(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new Qo(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new Qo(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new Qo(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}_attachCameras(e,t){super._attachCameras(e,t);for(const e of this._cameras)this._scene.enableDepthRenderer(e).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new X("BlurH",new I.I9(1,0),16,e,null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new X("BlurV",new I.I9(0,1),16,e,null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add((()=>{const e=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*e})),this._blurVPostProcess.onActivateObservable.add((()=>{const e=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*e}))}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const t=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new W.w("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=e=>{this._firstUpdate&&(e.setArray3("sampleSphere",t),e.setFloat("samplesFactor",.0625),e.setFloat("randTextureTiles",4)),e.setFloat("totalStrength",this.totalStrength),e.setFloat("radius",this.radius),e.setFloat("area",this.area),e.setFloat("fallOff",this.fallOff),e.setFloat("base",this.base),e.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),e.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new W.w("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,G.g.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=e=>{e.setVector4("viewport",I.AA.Vector4[0].copyFromFloats(0,0,1,1)),e.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){const e=new Uint8Array(1048576);for(let t=0;t<e.length;)e[t++]=Math.floor(255*Math.max(0,(0,Nt.RandomRange)(-1,1))),e[t++]=Math.floor(255*Math.max(0,(0,Nt.RandomRange)(-1,1))),e[t++]=Math.floor(255*Math.max(0,(0,Nt.RandomRange)(-1,1))),e[t++]=255;const t=ya.CreateRGBATexture(e,512,512,this._scene,!1,!1,2);t.name="SSAORandomTexture",t.wrapU=G.g.WRAP_ADDRESSMODE,t.wrapV=G.g.WRAP_ADDRESSMODE,this._randomTexture=t}}(0,w.Cg)([(0,D.lK)()],yl.prototype,"totalStrength",void 0),(0,w.Cg)([(0,D.lK)()],yl.prototype,"radius",void 0),(0,w.Cg)([(0,D.lK)()],yl.prototype,"area",void 0),(0,w.Cg)([(0,D.lK)()],yl.prototype,"fallOff",void 0),(0,w.Cg)([(0,D.lK)()],yl.prototype,"base",void 0);class Cl{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}ae.l.ShadersStore.screenSpaceReflectionPixelShader="uniform sampler2D textureSampler;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform float stepSize;uniform float strength;uniform float threshold;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;varying vec2 vUV;\n#ifdef SSR_SUPPORTED\nstruct ReflectionInfo {vec3 color;vec4 coords;};/**\n* According to specular,see https:\n*/\nvec3 fresnelSchlick(float cosTheta,vec3 F0)\n{return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);}\n/**\n* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit\n* by sampling multiple reflection pixels.\n*/\nReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)\n{ReflectionInfo info;info.color=vec3(0.0);vec4 projectedCoord;float sampledDepth;for(int i=0; i<SMOOTH_STEPS; i++)\n{projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;dir*=0.5;if(depth>0.0)\nhitCoord-=dir;else\nhitCoord+=dir;info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;}\nprojectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;info.color/=float(SMOOTH_STEPS+1);return info;}\n/**\n* Tests the given world position (hitCoord) according to the given reflection vector (dir)\n* until it finds a collision (means that depth is enough close to say \"it's the pixel to sample!\").\n*/\nReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)\n{ReflectionInfo info;vec4 projectedCoord;float sampledDepth;dir*=stepSize;for(int i=0; i<REFLECTION_SAMPLES; i++)\n{hitCoord+=dir;projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;\n#ifdef RIGHT_HANDED_SCENE\ndepth*=-1.0;\n#endif\nif(((depth-dir.z)<threshold) && depth<=0.0)\n{\n#ifdef ENABLE_SMOOTH_REFLECTIONS\nreturn smoothReflectionInfo(dir,hitCoord);\n#else\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;\n#endif\n}}\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;}\nvec3 hash(vec3 a)\n{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 albedoFull=texture2D(textureSampler,vUV);vec3 albedo=albedoFull.rgb;float spec=texture2D(reflectivitySampler,vUV).r;if (spec==0.0) {gl_FragColor=albedoFull;return;}\nvec3 normal=(texture2D(normalSampler,vUV)).xyz;vec3 position=(view*texture2D(positionSampler,vUV)).xyz;vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));float roughness=1.0-texture2D(reflectivitySampler,vUV).a;vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;ReflectionInfo info=getReflectionInfo(jitt+reflected,position);vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);vec3 F0=vec3(0.04);F0 =mix(F0,albedo,spec);vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);\n#ifdef RIGHT_HANDED_SCENE\nreflected.z*=-1.0;\n#endif\nfloat reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);float albedoMultiplier=1.0-reflectionMultiplier;vec3 SSR=info.color*fresnel;gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";class Pl extends W.w{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,i,s,r,n,a,o=0,h=!1,c=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,s,r,n,a,"#define SSR_SUPPORTED\n#define REFLECTION_SAMPLES 64\n#define SMOOTH_STEPS 5\n",o,void 0,null,h),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=c,this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&e.isSupported&&(e.enablePosition=!0,e.enableReflectivity=!0,e.generateNormalsInWorldSpace&&l.V.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"))}else{const e=t.enablePrePassRenderer();e?.markAsDirty(),e?.generateNormalsInWorldSpace&&l.V.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the prepass renderer!"),this._prePassEffectConfiguration=new Cl}this._updateEffectDefines(),this.onApply=e=>{const i=this._geometryBufferRenderer,s=this._prePassRenderer;if(!s&&!i)return;if(i){const t=i.getTextureIndex(ul.POSITION_TEXTURE_TYPE),s=i.getTextureIndex(ul.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",i.getGBuffer().textures[1]),e.setTexture("positionSampler",i.getGBuffer().textures[t]),e.setTexture("reflectivitySampler",i.getGBuffer().textures[s])}else if(s){const t=s.getIndex(1),i=s.getIndex(3),r=s.getIndex(6);e.setTexture("normalSampler",s.getRenderTarget().textures[r]),e.setTexture("positionSampler",s.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",s.getRenderTarget().textures[i])}const r=t.activeCamera;if(!r)return;const n=r.getViewMatrix(!0),a=r.getProjectionMatrix(!0);e.setMatrix("projection",a),e.setMatrix("view",n),e.setFloat("threshold",this.threshold),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(0|this._reflectionSamples)),e.push("#define SMOOTH_STEPS "+(0|this._smoothSteps)),this.updateEffect(e.join("\n"))}static _Parse(e,t,i,s){return N.p.Parse((()=>new Pl(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,s)}}(0,w.Cg)([(0,D.lK)()],Pl.prototype,"threshold",void 0),(0,w.Cg)([(0,D.lK)()],Pl.prototype,"strength",void 0),(0,w.Cg)([(0,D.lK)()],Pl.prototype,"reflectionSpecularFalloffExponent",void 0),(0,w.Cg)([(0,D.lK)()],Pl.prototype,"step",void 0),(0,w.Cg)([(0,D.lK)()],Pl.prototype,"roughnessFactor",void 0),(0,w.Cg)([(0,D.lK)()],Pl.prototype,"enableSmoothReflections",null),(0,w.Cg)([(0,D.lK)()],Pl.prototype,"reflectionSamples",null),(0,w.Cg)([(0,D.lK)()],Pl.prototype,"smoothSteps",null),(0,V.Y5)("BABYLON.ScreenSpaceReflectionPostProcess",Pl);ae.l.ShadersStore.standardPixelShader="uniform sampler2D textureSampler;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{vec4 color=texture2D(textureSampler,vUV);gl_FragColor=color;}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];void main(void)\n{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+dsOffsets[0]);average+=texture2D(textureSampler,vUV+dsOffsets[1]);average+=texture2D(textureSampler,vUV+dsOffsets[2]);average+=texture2D(textureSampler,vUV+dsOffsets[3]);average+=texture2D(textureSampler,vUV+dsOffsets[4]);average+=texture2D(textureSampler,vUV+dsOffsets[5]);average+=texture2D(textureSampler,vUV+dsOffsets[6]);average+=texture2D(textureSampler,vUV+dsOffsets[7]);average+=texture2D(textureSampler,vUV+dsOffsets[8]);average+=texture2D(textureSampler,vUV+dsOffsets[9]);average+=texture2D(textureSampler,vUV+dsOffsets[10]);average+=texture2D(textureSampler,vUV+dsOffsets[11]);average+=texture2D(textureSampler,vUV+dsOffsets[12]);average+=texture2D(textureSampler,vUV+dsOffsets[13]);average+=texture2D(textureSampler,vUV+dsOffsets[14]);average+=texture2D(textureSampler,vUV+dsOffsets[15]);average/=16.0;gl_FragColor=average;}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];uniform float brightThreshold;void main(void)\n{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));average*=0.25;float luminance=length(average.rgb);if (luminance<brightThreshold) {average=vec4(0.0,0.0,0.0,1.0);}\ngl_FragColor=average;}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;uniform sampler2D lensSampler;uniform float exposure;void main(void)\n{vec3 colour=texture2D(textureSampler,vUV).rgb;colour*=exposure;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;colour+=colour*texture2D(lensSampler,vUV).rgb;vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);gl_FragColor=finalColor;}\n#endif\n#if defined(VLS)\n#define PI 3.1415926535897932384626433832795\nuniform mat4 shadowViewProjection;uniform mat4 lightWorld;uniform vec3 cameraPosition;uniform vec3 sunDirection;uniform vec3 sunColor;uniform vec2 depthValues;uniform float scatteringCoefficient;uniform float scatteringPower;uniform sampler2D shadowMapSampler;uniform sampler2D positionSampler;float computeScattering(float lightDotView)\n{float result=1.0-scatteringCoefficient*scatteringCoefficient;result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));return result;}\nvoid main(void)\n{vec3 worldPos=texture2D(positionSampler,vUV).rgb;vec3 startPosition=cameraPosition;vec3 rayVector=worldPos-startPosition;float rayLength=length(rayVector);vec3 rayDirection=rayVector/rayLength;float stepLength=rayLength/NB_STEPS;vec3 stepL=rayDirection*stepLength;vec3 currentPosition=startPosition;vec3 accumFog=vec3(0.0);for (int i=0; i<int(NB_STEPS); i++)\n{vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depthMetric,0.0,1.0);worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;if (shadowMapValue>shadowPixelDepth)\naccumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));currentPosition+=stepL;}\naccumFog/=NB_STEPS;vec3 color=accumFog*scatteringPower;gl_FragColor=vec4(color*exp(color) ,1.0);}\n#endif\n#if defined(VLSMERGE)\nuniform sampler2D originalSampler;void main(void)\n{gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);}\n#endif\n#if defined(LUMINANCE)\nuniform vec2 lumOffsets[4];void main()\n{float average=0.0;vec4 color=vec4(0.0);float maximum=-1e20;vec3 weight=vec3(0.299,0.587,0.114);for (int i=0; i<4; i++)\n{color=texture2D(textureSampler,vUV+ lumOffsets[i]);float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));\n#ifdef WEIGHTED_AVERAGE\nfloat GreyValue=dot(color.rgb,weight);\n#endif\n#ifdef BRIGHTNESS\nfloat GreyValue=max(color.r,max(color.g,color.b));\n#endif\n#ifdef HSL_COMPONENT\nfloat GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));\n#endif\n#ifdef MAGNITUDE\nfloat GreyValue=length(color.rgb);\n#endif\nmaximum=max(maximum,GreyValue);average+=(0.25*log(1e-5+GreyValue));}\naverage=exp(average);gl_FragColor=vec4(average,maximum,0.0,1.0);}\n#endif\n#if defined(LUMINANCE_DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];uniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLER\n#include<packingFunctions>\n#endif\nvoid main()\n{vec4 color=vec4(0.0);float average=0.0;for (int i=0; i<9; i++)\n{color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);average+=color.r;}\naverage/=9.0;\n#ifdef FINAL_DOWN_SAMPLER\ngl_FragColor=pack(average);\n#else\ngl_FragColor=vec4(average,average,0.0,1.0);\n#endif\n}\n#endif\n#if defined(HDR)\nuniform sampler2D textureAdderSampler;uniform float averageLuminance;void main()\n{vec4 color=texture2D(textureAdderSampler,vUV);\n#ifndef AUTO_EXPOSURE\nvec4 adjustedColor=color/averageLuminance;color=adjustedColor;color.a=1.0;\n#endif\ngl_FragColor=color;}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;uniform float strength;uniform float ghostDispersal;uniform float haloWidth;uniform vec2 resolution;uniform float distortionStrength;float hash(vec2 p)\n{float h=dot(p,vec2(127.1,311.7));return -1.0+2.0*fract(sin(h)*43758.5453123);}\nfloat noise(in vec2 p)\n{vec2 i=floor(p);vec2 f=fract(p);vec2 u=f*f*(3.0-2.0*f);return mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);}\nfloat fbm(vec2 p)\n{float f=0.0;f+=0.5000*noise(p); p*=2.02;f+=0.2500*noise(p); p*=2.03;f+=0.1250*noise(p); p*=2.01;f+=0.0625*noise(p); p*=2.04;f/=0.9375;return f;}\nvec3 pattern(vec2 uv)\n{vec2 p=-1.0+2.0*uv;float p2=dot(p,p);float f=fbm(vec2(15.0*p2))/2.0;float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));return (1.0-f)*vec3(r,g,b);}\nfloat luminance(vec3 color)\n{return dot(color.rgb,vec3(0.2126,0.7152,0.0722));}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{return vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);}\nvoid main(void)\n{vec2 uv=-vUV+vec2(1.0);vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;vec2 texelSize=1.0/resolution;vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);vec4 result=vec4(0.0);float ghostIndice=1.0;for (int i=0; i<GHOSTS; ++i)\n{vec2 offset=fract(uv+ghostDir*ghostIndice);float weight=length(vec2(0.5)-offset)/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;ghostIndice+=1.0;}\nvec2 haloVec=normalize(ghostDir)*haloWidth;float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));gl_FragColor=result;}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;uniform sampler2D lensDirtSampler;uniform sampler2D lensStarSampler;uniform mat4 lensStarMatrix;void main(void)\n{vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;vec4 lensMod=texture2D(lensDirtSampler,vUV);lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);vec4 result=texture2D(textureSampler,vUV)*lensMod;gl_FragColor=texture2D(otherSampler,vUV)+result;}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;uniform sampler2D depthSampler;uniform float distance;void main(void)\n{vec4 sharp=texture2D(otherSampler,vUV);vec4 blur=texture2D(textureSampler,vUV);float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);float factor=0.0;if (dist<0.05)\nfactor=1.0;else if (dist<0.1)\nfactor=20.0*(0.1-dist);else if (dist<0.5)\nfactor=0.0;else\nfactor=2.0*(dist-0.5);factor=clamp(factor,0.0,0.90);gl_FragColor=mix(sharp,blur,factor);}\n#endif\n#if defined(MOTION_BLUR)\nuniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform vec2 screenSize;uniform float motionScale;uniform float motionStrength;uniform sampler2D depthSampler;void main(void)\n{vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=cpos*inverseViewProjection;vec4 ppos=cpos*prevViewProjection;ppos.xyz/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {if (i>=nSamples)\nbreak;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);result+=texture2D(textureSampler,offset1);}\ngl_FragColor=result/float(nSamples);}\n#endif\n";class El extends gl{get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join("\n"))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer())return void l.V.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,s=null,r){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=r||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=s,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new Pl("HDRPass",t,e,null,G.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess})),this.addEffect(new Qo(t.getEngine(),"HDRScreenSpaceReflections",(()=>this.screenSpaceReflectionPostProcess),!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new W.w("HDRPass","standard",[],[],e,null,G.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.originalPostProcess})),this.addEffect(new Qo(t.getEngine(),"HDRPassPostProcess",(()=>this.originalPostProcess),!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new W.w("HDRDepthOfFieldSource","standard",[],[],e,null,G.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Qo(t.getEngine(),"HDRBaseDepthOfFieldSource",(()=>this.textureAdderFinalPostProcess),!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new W.w("HDRVLSFinal","standard",[],[],e,null,G.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Qo(t.getEngine(),"HDRVLSFinal",(()=>this.volumetricLightFinalPostProcess),!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new W.w("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,G.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Qo(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",(()=>this.lensFlareFinalPostProcess),!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new W.w("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,G.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new Qo(t.getEngine(),"HDRPostHDReDepthOfFieldSource",(()=>this.hdrFinalPostProcess),!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new al("fxaa",1,null,G.g.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new Qo(t.getEngine(),"HDRFxaa",(()=>this.fxaaPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&l.V.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const i=new Array(32);this.downSampleX4PostProcess=new W.w("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=e=>{let t=0;const s=this.downSampleX4PostProcess.width,r=this.downSampleX4PostProcess.height;for(let e=-2;e<2;e++)for(let n=-2;n<2;n++)i[t]=(e+.5)*(1/s),i[t+1]=(n+.5)*(1/r),t+=2;e.setArray2("dsOffsets",i)},this.addEffect(new Qo(e.getEngine(),"HDRDownSampleX4",(()=>this.downSampleX4PostProcess),!0))}_createBrightPassPostProcess(e,t){const i=new Array(8);this.brightPassPostProcess=new W.w("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=e=>{const t=1/this.brightPassPostProcess.width,s=1/this.brightPassPostProcess.height;i[0]=-.5*t,i[1]=.5*s,i[2]=.5*t,i[3]=.5*s,i[4]=-.5*t,i[5]=-.5*s,i[6]=.5*t,i[7]=-.5*s,e.setArray2("dsOffsets",i),e.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new Qo(e.getEngine(),"HDRBrightPass",(()=>this.brightPassPostProcess),!0))}_createBlurPostProcesses(e,t,i,s="blurWidth"){const r=e.getEngine(),n=new X("HDRBlurH_"+i,new I.I9(1,0),this[s],t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),a=new X("HDRBlurV_"+i,new I.I9(0,1),this[s],t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);n.onActivateObservable.add((()=>{const e=n.width/r.getRenderWidth();n.kernel=this[s]*e})),a.onActivateObservable.add((()=>{const e=a.height/r.getRenderHeight();a.kernel=this.horizontalBlur?64*e:this[s]*e})),this.addEffect(new Qo(e.getEngine(),"HDRBlurH"+i,(()=>n),!0)),this.addEffect(new Qo(e.getEngine(),"HDRBlurV"+i,(()=>a),!0)),this.blurHPostProcesses.push(n),this.blurVPostProcesses.push(a)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new W.w("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),e.setTexture("lensSampler",this.lensTexture),e.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new Qo(e.getEngine(),"HDRTextureAdder",(()=>this.textureAdderPostProcess),!0))}_createVolumetricLightPostProcess(e,t){const i=e.enableGeometryBufferRenderer();i.enablePosition=!0;const s=i.getGBuffer();this.volumetricLightPostProcess=new W.w("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));const r=I.I9.Zero();this.volumetricLightPostProcess.onApply=e=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const t=this.sourceLight.getShadowGenerator();e.setTexture("shadowMapSampler",t.getShadowMap()),e.setTexture("positionSampler",s.textures[2]),e.setColor3("sunColor",this.sourceLight.diffuse),e.setVector3("sunDirection",this.sourceLight.getShadowDirection()),e.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),e.setMatrix("shadowViewProjection",t.getTransformMatrix()),e.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),e.setFloat("scatteringPower",this.volumetricLightPower),r.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),r.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),e.setVector2("depthValues",r)}},this.addEffect(new Qo(e.getEngine(),"HDRVLS",(()=>this.volumetricLightPostProcess),!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new W.w("HDRVLSMerge","standard",[],["originalSampler"],t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=e=>{e.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new Qo(e.getEngine(),"HDRVLSMerge",(()=>this.volumetricLightMergePostProces),!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,El.LuminanceSteps);this.luminancePostProcess=new W.w("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const s=[];this.luminancePostProcess.onApply=e=>{const t=1/this.luminancePostProcess.width,i=1/this.luminancePostProcess.height;s[0]=-.5*t,s[1]=.5*i,s[2]=.5*t,s[3]=.5*i,s[4]=-.5*t,s[5]=-.5*i,s[6]=.5*t,s[7]=-.5*i,e.setArray2("lumOffsets",s)},this.addEffect(new Qo(e.getEngine(),"HDRLuminance",(()=>this.luminancePostProcess),!0));for(let s=El.LuminanceSteps-1;s>=0;s--){i=Math.pow(3,s);let r="#define LUMINANCE_DOWN_SAMPLE\n";0===s&&(r+="#define FINAL_DOWN_SAMPLER");const n=new W.w("HDRLuminanceDownSample"+s,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,t);this.luminanceDownSamplePostProcesses.push(n)}let r=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(((t,i)=>{const s=new Array(18);t.onApply=e=>{if(!r)return;let n=0;for(let e=-1;e<2;e++)for(let t=-1;t<2;t++)s[n]=e/r.width,s[n+1]=t/r.height,n+=2;e.setArray2("dsOffsets",s),e.setFloat("halfDestPixelSize",.5/r.width),r=i===this.luminanceDownSamplePostProcesses.length-1?this.luminancePostProcess:t},i===this.luminanceDownSamplePostProcesses.length-1&&(t.onAfterRender=()=>{const t=e.getEngine().readPixels(0,0,1,1),i=new I.IU(1/16581375,1/65025,1/255,1);t.then((e=>{const t=new Uint8Array(e.buffer);this._hdrCurrentLuminance=(t[0]*i.x+t[1]*i.y+t[2]*i.z+t[3]*i.w)/100}))}),this.addEffect(new Qo(e.getEngine(),"HDRLuminanceDownSample"+i,(()=>t),!0))}))}_createHdrPostProcess(e,t){const i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new W.w("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join("\n"),0);let s=1,r=0,n=0;this.hdrPostProcess.onApply=t=>{if(t.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),r+=e.getEngine().getDeltaTime(),s<0)s=this._hdrCurrentLuminance;else{const e=(n-r)/1e3;this._hdrCurrentLuminance<s+this.hdrDecreaseRate*e?s+=this.hdrDecreaseRate*e:this._hdrCurrentLuminance>s-this.hdrIncreaseRate*e?s-=this.hdrIncreaseRate*e:s=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/s:(s=(0,Nt.Clamp)(s,this.hdrMinimumLuminance,1e20),t.setFloat("averageLuminance",s)),n=r,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new Qo(e.getEngine(),"HDR",(()=>this.hdrPostProcess),!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new W.w("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new Qo(e.getEngine(),"HDRLensFlare",(()=>this.lensFlarePostProcess),!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new W.w("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new Qo(e.getEngine(),"HDRLensFlareCompose",(()=>this.lensFlareComposePostProcess),!0));const i=new I.I9(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=e=>{e.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),e.setTexture("lensColorSampler",this.lensColorTexture),e.setFloat("strength",this.lensFlareStrength),e.setFloat("ghostDispersal",this.lensFlareGhostDispersal),e.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,e.setVector2("resolution",i),e.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const s=I.uq.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),r=I.uq.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=e=>{if(!this._scene.activeCamera)return;e.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),e.setTexture("lensDirtSampler",this.lensFlareDirtTexture),e.setTexture("lensStarSampler",this.lensStarTexture);const t=this._scene.activeCamera.getViewMatrix().getRow(0),i=this._scene.activeCamera.getViewMatrix().getRow(2);let n=I.Pq.Dot(t.toVector3(),new I.Pq(1,0,0))+I.Pq.Dot(i.toVector3(),new I.Pq(0,0,1));n*=4;const a=I.uq.FromValues(.5*Math.cos(n),-Math.sin(n),0,0,Math.sin(n),.5*Math.cos(n),0,0,0,0,1,0,0,0,0,1),o=r.multiply(a).multiply(s);e.setMatrix("lensStarMatrix",o),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new W.w("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),e.setTexture("depthSampler",this._getDepthTexture()),e.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new Qo(e.getEngine(),"HDRDepthOfField",(()=>this.depthOfFieldPostProcess),!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const i=new pl("HDRMotionBlur",e,t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new W.w("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,G.g.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),0);let i=0,s=I.uq.Identity();const r=I.uq.Identity();let n=I.uq.Identity();const a=I.I9.Zero();this.motionBlurPostProcess.onApply=t=>{n=e.getProjectionMatrix().multiply(e.getViewMatrix()),n.invertToRef(r),t.setMatrix("inverseViewProjection",r),t.setMatrix("prevViewProjection",s),s=n,a.x=this.motionBlurPostProcess.width,a.y=this.motionBlurPostProcess.height,t.setVector2("screenSize",a),i=e.getEngine().getFps()/60,t.setFloat("motionScale",i),t.setFloat("motionStrength",this.motionStrength),t.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new Qo(e.getEngine(),"HDRMotionBlur",(()=>this.motionBlurPostProcess),!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let e=0;e<this.luminanceDownSamplePostProcesses.length;e++)this.luminanceDownSamplePostProcesses[e].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let e=0;e<this.blurHPostProcesses.length;e++)this.blurHPostProcesses[e].dispose(t);for(let e=0;e<this.blurVPostProcesses.length;e++)this.blurVPostProcesses[e].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){const e=N.p.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=N.p.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){const s=N.p.Parse((()=>new El(e._name,t,e._ratio)),e,t,i);return e.sourceLightId&&(s.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&N.p.Parse((()=>s.screenSpaceReflectionPostProcess),e.screenSpaceReflectionPostProcess,t,i),s}}El.LuminanceSteps=6,(0,w.Cg)([(0,D.lK)()],El.prototype,"brightThreshold",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"blurWidth",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"horizontalBlur",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"exposure",null),(0,w.Cg)([(0,D.uM)("lensTexture")],El.prototype,"lensTexture",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"volumetricLightCoefficient",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"volumetricLightPower",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"volumetricLightBlurScale",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"hdrMinimumLuminance",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"hdrDecreaseRate",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"hdrIncreaseRate",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"hdrAutoExposure",null),(0,w.Cg)([(0,D.uM)("lensColorTexture")],El.prototype,"lensColorTexture",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"lensFlareStrength",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"lensFlareGhostDispersal",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"lensFlareHaloWidth",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"lensFlareDistortionStrength",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"lensFlareBlurWidth",void 0),(0,w.Cg)([(0,D.uM)("lensStarTexture")],El.prototype,"lensStarTexture",void 0),(0,w.Cg)([(0,D.uM)("lensFlareDirtTexture")],El.prototype,"lensFlareDirtTexture",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"depthOfFieldDistance",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"depthOfFieldBlurWidth",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"motionStrength",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"objectBasedMotionBlur",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"_ratio",void 0),(0,w.Cg)([(0,D.lK)()],El.prototype,"BloomEnabled",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"DepthOfFieldEnabled",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"LensFlareEnabled",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"HDREnabled",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"VLSEnabled",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"MotionBlurEnabled",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"fxaaEnabled",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"screenSpaceReflectionsEnabled",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"volumetricLightStepsCount",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"motionBlurSamples",null),(0,w.Cg)([(0,D.lK)()],El.prototype,"samples",null),(0,V.Y5)("BABYLON.StandardRenderingPipeline",El);class Al{constructor(e=!1){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3],this.texturesRequired.push(e?10:5)}}const Rl=I.uq.Compose(new I.Pq(.5,.5,.5),I.PT.Identity(),new I.Pq(.5,.5,.5)),Il=I.uq.Compose(new I.Pq(.5,.5,1),I.PT.Identity(),new I.Pq(.5,.5,0));class Ml extends gl{set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(0===e&&0!==this._reflectivityThreshold||0!==e&&0===this._reflectivityThreshold?(this._reflectivityThreshold=e,this._buildPipeline()):this._reflectivityThreshold=e)}get ssrDownsample(){return this._ssrDownsample}set ssrDownsample(e){e!==this._ssrDownsample&&(this._ssrDownsample=e,this._buildPipeline())}get blurDispersionStrength(){return this._blurDispersionStrength}set blurDispersionStrength(e){if(e===this._blurDispersionStrength)return;const t=0===e&&0!==this._blurDispersionStrength||0!==e&&0===this._blurDispersionStrength;this._blurDispersionStrength=e,t&&this._buildPipeline()}_useBlur(){return this._blurDispersionStrength>0}get blurDownsample(){return this._blurDownsample}set blurDownsample(e){e!==this._blurDownsample&&(this._blurDownsample=e,this._buildPipeline())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._buildPipeline())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._buildPipeline())}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureDownsample(){return this._backfaceDepthTextureDownsample}set backfaceDepthTextureDownsample(e){this._backfaceDepthTextureDownsample!==e&&(this._backfaceDepthTextureDownsample=e,this._resizeDepthRenderer())}get backfaceForceDepthWriteTransparentMeshes(){return this._backfaceForceDepthWriteTransparentMeshes}set backfaceForceDepthWriteTransparentMeshes(e){this._backfaceForceDepthWriteTransparentMeshes!==e&&(this._backfaceForceDepthWriteTransparentMeshes=e,this._depthRenderer&&(this._depthRenderer.forceDepthWriteTransparentMeshes=e))}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._buildPipeline())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._buildPipeline())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._buildPipeline())}getScene(){return this._scene}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}get isSupported(){const e=this._scene.getEngine().getCaps();return e.drawBuffersExtension&&e.texelFetch}constructor(e,t,i,s=!1,r=0,n=!1){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._reflectivityThreshold=.04,this._ssrDownsample=0,this._blurDispersionStrength=.03,this._blurDownsample=0,this._enableSmoothReflections=!1,this._useScreenspaceDepth=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._useFresnel=!1,this._enableAutomaticThicknessComputation=!1,this._backfaceDepthTextureDownsample=0,this._backfaceForceDepthWriteTransparentMeshes=!0,this._isEnabled=!0,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=r,this._forceGeometryBuffer=s,this._useScreenspaceDepth=n,this.isSupported){if(t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&(e.enableReflectivity=!0,e.useSpecificClearForDepthTexture=!0,e.enableScreenspaceDepth=this._useScreenspaceDepth,e.enableDepth=!this._useScreenspaceDepth)}else{const e=t.enablePrePassRenderer();e&&(e.useSpecificClearForDepthTexture=!0,e.markAsDirty())}this._buildPipeline()}}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposePostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}_getTextureSize(){const e=this._scene.getEngine(),t=this._prePassRenderer;let i={width:e.getRenderWidth(),height:e.getRenderHeight()};if(t&&this._scene.activeCamera?._getFirstPostProcess()===this._ssrPostProcess){const e=t.getRenderTarget();e&&e.textures&&(i=e.textures[t.getIndex(4)].getSize())}else this._ssrPostProcess?.inputTexture&&(i.width=this._ssrPostProcess.inputTexture.width,i.height=this._ssrPostProcess.inputTexture.height);return i}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&e.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._useScreenspaceDepth&&e.push("#define SSRAYTRACE_SCREENSPACE_DEPTH"),this._environmentTexture&&(e.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&e.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&e.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&e.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&e.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&e.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&e.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&e.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&e.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&e.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&e.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this._useBlur()&&e.push("#define SSR_USE_BLUR"),this._debug&&e.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&e.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&e.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),this._useFresnel&&e.push("#define SSR_BLEND_WITH_FRESNEL"),0===this._reflectivityThreshold&&e.push("#define SSR_DISABLE_REFLECTIVITY_TEST"),(this._geometryBufferRenderer?.generateNormalsInWorldSpace??this._prePassRenderer?.generateNormalsInWorldSpace)&&e.push("#define SSR_NORMAL_IS_IN_WORLDSPACE"),this._geometryBufferRenderer?.normalsAreUnsigned&&e.push("#define SSR_DECODE_NORMAL");const t=this._cameras?.[0];t&&1===t.mode&&e.push("#define ORTHOGRAPHIC_CAMERA"),this._ssrPostProcess?.updateEffect(e.join("\n"))}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const e=this._scene.getEngine();if(this._disposeDepthRenderer(),this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._enableAutomaticThicknessComputation){const e=this._cameras?.[0];e&&(this._depthRendererCamera=e,this._depthRenderer=new re(this._scene,void 0,void 0,this._useScreenspaceDepth,1,!this._useScreenspaceDepth,"SSRBackDepth"),this._useScreenspaceDepth||(this._depthRenderer.clearColor.r=1e8),this._depthRenderer.reverseCulling=!0,this._depthRenderer.forceDepthWriteTransparentMeshes=this._backfaceForceDepthWriteTransparentMeshes,this._resizeDepthRenderer(),e.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this._createSSRPostProcess(),this.addEffect(new Qo(e,this.SSRRenderEffect,(()=>this._ssrPostProcess),!0)),this._useBlur()&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new Qo(e,this.SSRBlurRenderEffect,(()=>[this._blurPostProcessX,this._blurPostProcessY]),!0)),this.addEffect(new Qo(e,this.SSRCombineRenderEffect,(()=>this._blurCombinerPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;const e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/(this._backfaceDepthTextureDownsample+1)),s=Math.floor(e.height/(this._backfaceDepthTextureDownsample+1));t.width===i&&t.height===s||this._depthRenderer.getDepthMap().resize({width:i,height:s})}_disposeDepthRenderer(){if(this._depthRenderer){if(this._depthRendererCamera){const e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap())??-1;-1!==e&&this._depthRendererCamera.customRenderTargets.splice(e,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this._ssrPostProcess?.dispose(t),this._blurPostProcessX?.dispose(t),this._blurPostProcessY?.dispose(t),this._blurCombinerPostProcess?.dispose(t)}this._ssrPostProcess=null,this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new W.w("ssr","screenSpaceReflection2",["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","farPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"],["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"],1,null,this._textureType,this._scene.getEngine(),!1,"",this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(r.bind(r,5423))):t.push(Promise.resolve().then(r.bind(r,4354)))})),this._updateEffectDefines(),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){const i=t.getTextureIndex(ul.REFLECTIVITY_TEXTURE_TYPE),s=t.getTextureIndex(ul.NORMAL_TEXTURE_TYPE);if(e.setTexture("normalSampler",t.getGBuffer().textures[s]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),this._useScreenspaceDepth){const i=t.getTextureIndex(ul.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}else{const i=t.getTextureIndex(ul.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}}else if(i){const t=i.getIndex(this._useScreenspaceDepth?10:5),s=i.getIndex(3),r=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[r]),e.setTexture("depthSampler",i.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[s])}this._enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this._backfaceDepthTextureDownsample+1));const s=this._scene.activeCamera;if(!s)return;const r=s.getViewMatrix(),n=s.getProjectionMatrix();n.invertToRef(I.AA.Matrix[0]),r.invertToRef(I.AA.Matrix[1]),e.setMatrix("projection",n),e.setMatrix("view",r),e.setMatrix("invView",I.AA.Matrix[1]),e.setMatrix("invProjectionMatrix",I.AA.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",s.minZ),e.setFloat("farPlaneZ",s.maxZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),e.setFloat("reflectivityThreshold",this._reflectivityThreshold);const a=this._getTextureSize();I.uq.ScalingToRef(a.width,a.height,1,I.AA.Matrix[2]),n.multiplyToRef(this._scene.getEngine().isWebGPU?Il:Rl,I.AA.Matrix[3]),I.AA.Matrix[3].multiplyToRef(I.AA.Matrix[2],I.AA.Matrix[4]),e.setMatrix("projectionPixel",I.AA.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new Al(this._useScreenspaceDepth))}_createBlurAndCombinerPostProcesses(){const e=this._scene.getEngine();this._blurPostProcessX=new W.w("SSRblurX","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._ssrDownsample+1):1,null,2,e,!1,"",this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(r.bind(r,6584))):t.push(Promise.resolve().then(r.bind(r,8133)))})),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add((e=>{const t=this._blurPostProcessX?.inputTexture.width??this._scene.getEngine().getRenderWidth();e.setFloat2("texelOffsetScale",this._blurDispersionStrength/t,0)})),this._blurPostProcessY=new W.w("SSRblurY","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._blurDownsample+1):1,null,2,e,!1,"",this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(r.bind(r,6584))):t.push(Promise.resolve().then(r.bind(r,8133)))})),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add((e=>{const t=this._blurPostProcessY?.inputTexture.height??this._scene.getEngine().getRenderHeight();e.setFloat2("texelOffsetScale",0,this._blurDispersionStrength/t)}));const t=["strength","reflectionSpecularFalloffExponent","reflectivityThreshold"],i=["textureSampler","mainSampler","reflectivitySampler"];let s="";this._debug&&(s+="#define SSRAYTRACE_DEBUG\n"),this._inputTextureColorIsInGammaSpace&&(s+="#define SSR_INPUT_IS_GAMMA_SPACE\n"),this._generateOutputInGammaSpace&&(s+="#define SSR_OUTPUT_IS_GAMMA_SPACE\n"),this.useFresnel&&(s+="#define SSR_BLEND_WITH_FRESNEL\n",t.push("projection","invProjectionMatrix","nearPlaneZ","farPlaneZ"),i.push("depthSampler","normalSampler")),this._useScreenspaceDepth&&(s+="#define SSRAYTRACE_SCREENSPACE_DEPTH"),0===this._reflectivityThreshold&&(s+="#define SSR_DISABLE_REFLECTIVITY_TEST"),this._blurCombinerPostProcess=new W.w("SSRblurCombiner","screenSpaceReflection2BlurCombiner",t,i,this._useBlur()?1/(this._blurDownsample+1):1,null,1,e,!1,s,this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,((e,t)=>{e?t.push(Promise.resolve().then(r.bind(r,4143))):t.push(Promise.resolve().then(r.bind(r,7406)))})),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add((e=>{const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(i||t){if(i&&this._scene.activeCamera?._getFirstPostProcess()===this._ssrPostProcess){const t=i.getRenderTarget();t&&t.textures&&e.setTexture("mainSampler",t.textures[i.getIndex(4)])}else e.setTextureFromPostProcess("mainSampler",this._ssrPostProcess);if(t){const i=t.getTextureIndex(ul.REFLECTIVITY_TEXTURE_TYPE);if(e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),this.useFresnel){const i=this._scene.activeCamera;if(i&&this._useScreenspaceDepth&&(e.setFloat("nearPlaneZ",i.minZ),e.setFloat("farPlaneZ",i.maxZ)),e.setTexture("normalSampler",t.getGBuffer().textures[1]),this._useScreenspaceDepth){const i=t.getTextureIndex(ul.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}else e.setTexture("depthSampler",t.getGBuffer().textures[0])}}else if(i){const t=i.getIndex(3);if(e.setTexture("reflectivitySampler",i.getRenderTarget().textures[t]),this.useFresnel){const t=this._scene.activeCamera;t&&this._useScreenspaceDepth&&(e.setFloat("nearPlaneZ",t.minZ),e.setFloat("farPlaneZ",t.maxZ));const s=i.getIndex(this._useScreenspaceDepth?10:5),r=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[r]),e.setTexture("depthSampler",i.getRenderTarget().textures[s])}}if(e.setFloat("strength",this.strength),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("reflectivityThreshold",this._reflectivityThreshold),this.useFresnel){const t=this._scene.activeCamera;if(t){const i=t.getProjectionMatrix();i.invertToRef(I.AA.Matrix[0]),e.setMatrix("projection",i),e.setMatrix("invProjectionMatrix",I.AA.Matrix[0])}}}}))}serialize(){const e=N.p.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return N.p.Parse((()=>new Ml(e._name,t,e._ratio)),e,t,i)}}(0,w.Cg)([(0,D.lK)()],Ml.prototype,"samples",null),(0,w.Cg)([(0,D.lK)()],Ml.prototype,"maxDistance",void 0),(0,w.Cg)([(0,D.lK)()],Ml.prototype,"step",void 0),(0,w.Cg)([(0,D.lK)()],Ml.prototype,"thickness",void 0),(0,w.Cg)([(0,D.lK)()],Ml.prototype,"strength",void 0),(0,w.Cg)([(0,D.lK)()],Ml.prototype,"reflectionSpecularFalloffExponent",void 0),(0,w.Cg)([(0,D.lK)()],Ml.prototype,"maxSteps",void 0),(0,w.Cg)([(0,D.lK)()],Ml.prototype,"roughnessFactor",void 0),(0,w.Cg)([(0,D.lK)()],Ml.prototype,"selfCollisionNumSkip",void 0),(0,w.Cg)([(0,D.lK)()],Ml.prototype,"_reflectivityThreshold",void 0),(0,w.Cg)([(0,D.lK)("_ssrDownsample")],Ml.prototype,"_ssrDownsample",void 0),(0,w.Cg)([(0,D.lK)()],Ml.prototype,"ssrDownsample",null),(0,w.Cg)([(0,D.lK)("blurDispersionStrength")],Ml.prototype,"_blurDispersionStrength",void 0),(0,w.Cg)([(0,D.lK)("blurDownsample")],Ml.prototype,"_blurDownsample",void 0),(0,w.Cg)([(0,D.lK)("enableSmoothReflections")],Ml.prototype,"_enableSmoothReflections",void 0),(0,w.Cg)([(0,D.lK)("environmentTexture")],Ml.prototype,"_environmentTexture",void 0),(0,w.Cg)([(0,D.lK)("environmentTextureIsProbe")],Ml.prototype,"_environmentTextureIsProbe",void 0),(0,w.Cg)([(0,D.lK)("attenuateScreenBorders")],Ml.prototype,"_attenuateScreenBorders",void 0),(0,w.Cg)([(0,D.lK)("attenuateIntersectionDistance")],Ml.prototype,"_attenuateIntersectionDistance",void 0),(0,w.Cg)([(0,D.lK)("attenuateIntersectionIterations")],Ml.prototype,"_attenuateIntersectionIterations",void 0),(0,w.Cg)([(0,D.lK)("attenuateFacingCamera")],Ml.prototype,"_attenuateFacingCamera",void 0),(0,w.Cg)([(0,D.lK)("attenuateBackfaceReflection")],Ml.prototype,"_attenuateBackfaceReflection",void 0),(0,w.Cg)([(0,D.lK)("clipToFrustum")],Ml.prototype,"_clipToFrustum",void 0),(0,w.Cg)([(0,D.lK)("useFresnel")],Ml.prototype,"_useFresnel",void 0),(0,w.Cg)([(0,D.lK)("enableAutomaticThicknessComputation")],Ml.prototype,"_enableAutomaticThicknessComputation",void 0),(0,w.Cg)([(0,D.lK)("backfaceDepthTextureDownsample")],Ml.prototype,"_backfaceDepthTextureDownsample",void 0),(0,w.Cg)([(0,D.lK)("backfaceForceDepthWriteTransparentMeshes")],Ml.prototype,"_backfaceForceDepthWriteTransparentMeshes",void 0),(0,w.Cg)([(0,D.lK)("isEnabled")],Ml.prototype,"_isEnabled",void 0),(0,w.Cg)([(0,D.lK)("inputTextureColorIsInGammaSpace")],Ml.prototype,"_inputTextureColorIsInGammaSpace",void 0),(0,w.Cg)([(0,D.lK)("generateOutputInGammaSpace")],Ml.prototype,"_generateOutputInGammaSpace",void 0),(0,w.Cg)([(0,D.lK)("debug")],Ml.prototype,"_debug",void 0),(0,V.Y5)("BABYLON.SSRRenderingPipeline",Ml);class Ol{constructor(e,t=2,i=3,s=1,r=1){this._curIndex=0,this._sequence=[],this._numSamples=0,this.x=0,this.y=0,this._width=s,this._height=r,this._baseX=t,this._baseY=i,this._generateSequence(e),this.next()}regenerate(e){this._generateSequence(e),this.next()}setDimensions(e,t){this._width=e,this._height=t}next(){this.x=this._sequence[this._curIndex]/this._width,this.y=this._sequence[this._curIndex+1]/this._height,this._curIndex+=2,this._curIndex>=2*this._numSamples&&(this._curIndex=0)}_generateSequence(e){this._sequence=[],this._curIndex=0,this._numSamples=e;for(let t=1;t<=e;++t)this._sequence.push(this._halton(t,this._baseX)-.5,this._halton(t,this._baseY)-.5)}_halton(e,t){let i=1,s=0;for(;e>0;)i/=t,s+=i*(e%t),e=~~(e/t);return s}}ae.l.ShadersStore.taaPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D historySampler;uniform float factor;void main() {vec4 c=texelFetch(textureSampler,ivec2(gl_FragCoord.xy),0);vec4 h=texelFetch(historySampler,ivec2(gl_FragCoord.xy),0);gl_FragColor=mix(h,c,factor);}\n";class wl extends gl{set samples(e){this._samples!==e&&(this._samples=e,this._hs.regenerate(e))}get samples(){return this._samples}set msaaSamples(e){this._msaaSamples!==e&&(this._msaaSamples=e,this._taaPostProcess&&(this._taaPostProcess.samples=e))}get msaaSamples(){return this._msaaSamples}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&(this._firstUpdate=!0,this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras))):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get scene(){return this._scene}get isSupported(){return this._scene.getEngine().getCaps().texelFetch}constructor(e,t,i,s=0){const r=t.getEngine();super(r,e),this.TAARenderEffect="TAARenderEffect",this.TAAPassEffect="TAAPassEffect",this._samples=8,this._msaaSamples=1,this.factor=.05,this.disableOnCameraMove=!0,this._isEnabled=!0,this._isDirty=!1,this._camerasToBeAttached=[],this._pingpong=0,this._firstUpdate=!0,this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=s,this._hs=new Ol(this.samples),this.isSupported&&(this._createPingPongTextures(r.getRenderWidth(),r.getRenderHeight()),t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline())}getClassName(){return"TAARenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._ping.dispose(),this._pong.dispose(),super.dispose()}_createPingPongTextures(e,t){const i=this._scene.getEngine();this._ping?.dispose(),this._pong?.dispose(),this._ping=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:1}),this._pong=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:1}),this._hs.setDimensions(e/2,t/2),this._hs.next(),this._firstUpdate=!0}_updateEffectDefines(){this._taaPostProcess?.updateEffect([].join("\n"))}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const e=this._scene.getEngine();this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._createTAAPostProcess(),this.addEffect(new Qo(e,this.TAARenderEffect,(()=>this._taaPostProcess),!0)),this._createPassPostProcess(),this.addEffect(new Qo(e,this.TAAPassEffect,(()=>this._passPostProcess),!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this._taaPostProcess?.dispose(t),this._passPostProcess?.dispose(t),t.getProjectionMatrix(!0)}this._taaPostProcess=null,this._passPostProcess=null}_createTAAPostProcess(){this._taaPostProcess=new W.w("TAA","taa",{uniforms:["factor"],samplers:["historySampler"],size:1,engine:this._scene.getEngine(),textureType:this._textureType}),this._taaPostProcess.samples=this._msaaSamples,this._updateEffectDefines(),this._taaPostProcess.onActivateObservable.add((()=>{const e=this._scene.activeCamera;if(this._taaPostProcess?.width!==this._ping.width||this._taaPostProcess?.height!==this._ping.height){const e=this._scene.getEngine();this._createPingPongTextures(e.getRenderWidth(),e.getRenderHeight())}if(e&&!e.hasMoved)if(e.mode===se.PERSPECTIVE_CAMERA){const t=e.getProjectionMatrix();t.setRowFromFloats(2,this._hs.x,this._hs.y,t.m[10],t.m[11])}else{const t=e.getProjectionMatrix(!0);t.setRowFromFloats(3,this._hs.x+t.m[12],this._hs.y+t.m[13],t.m[14],t.m[15])}this._passPostProcess&&(this._passPostProcess.inputTexture=this._pingpong?this._ping:this._pong),this._pingpong=1^this._pingpong,this._hs.next()})),this._taaPostProcess.onApplyObservable.add((e=>{const t=this._scene.activeCamera;e._bindTexture("historySampler",this._pingpong?this._ping.texture:this._pong.texture),e.setFloat("factor",t?.hasMoved&&this.disableOnCameraMove||this._firstUpdate?1:this.factor),this._firstUpdate=!1}))}_createPassPostProcess(){const e=this._scene.getEngine();this._passPostProcess=new Mo.v("TAAPass",1,null,1,e),this._passPostProcess.inputTexture=this._ping,this._passPostProcess.autoClear=!1}serialize(){const e=N.p.Serialize(this);return e.customType="TAARenderingPipeline",e}static Parse(e,t,i){return N.p.Parse((()=>new wl(e._name,t,e._ratio)),e,t,i)}}(0,w.Cg)([(0,D.lK)("samples")],wl.prototype,"_samples",void 0),(0,w.Cg)([(0,D.lK)("msaaSamples")],wl.prototype,"_msaaSamples",void 0),(0,w.Cg)([(0,D.lK)()],wl.prototype,"factor",void 0),(0,w.Cg)([(0,D.lK)()],wl.prototype,"disableOnCameraMove",void 0),(0,w.Cg)([(0,D.lK)("isEnabled")],wl.prototype,"_isEnabled",void 0),(0,V.Y5)("BABYLON.TAARenderingPipeline",wl),r(5363),r(5076),r(598),r(4354),r(8133),r(7406),r(5423),r(6584),r(4143);var Dl;ae.l.ShadersStore.stereoscopicInterlacePixelShader="const vec3 TWO=vec3(2.0,2.0,2.0);varying vec2 vUV;uniform sampler2D camASampler;uniform sampler2D textureSampler;uniform vec2 stepSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{bool useCamA;bool useCamB;vec2 texCoord1;vec2 texCoord2;vec3 frag1;vec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;useCamA=!useCamB;texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\n#ifdef IS_STEREOSCOPIC_INTERLACED\nfloat rowNum=floor(vUV.y/stepSize.y);useCamA=mod(rowNum,2.0)==1.0;useCamB=mod(rowNum,2.0)==0.0;texCoord1=vec2(vUV.x,vUV.y);texCoord2=vec2(vUV.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;useCamA=!useCamB;texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n#endif\nif (useCamB){frag1=texture2D(textureSampler,texCoord1).rgb;frag2=texture2D(textureSampler,texCoord2).rgb;}else if (useCamA){frag1=texture2D(camASampler ,texCoord1).rgb;frag2=texture2D(camASampler ,texCoord2).rgb;}else {discard;}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);}\n",W.w,W.w,function(e){e[e.Hable=0]="Hable",e[e.Reinhard=1]="Reinhard",e[e.HejiDawson=2]="HejiDawson",e[e.Photographic=3]="Photographic"}(Dl||(Dl={})),W.w;ae.l.ShadersStore.volumetricLightScatteringPixelShader="uniform sampler2D textureSampler;uniform sampler2D lightScatteringSampler;uniform float decay;uniform float exposure;uniform float weight;uniform float density;uniform vec2 meshPositionOnScreen;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec2 tc=vUV;vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;float illuminationDecay=1.0;vec4 color=texture2D(lightScatteringSampler,tc)*0.4;for(int i=0; i<NUM_SAMPLES; i++) {tc-=deltaTexCoord;vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;dataSample*=illuminationDecay*weight;color+=dataSample;illuminationDecay*=decay;}\nvec4 realColor=texture2D(textureSampler,vUV);gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n",r(8959),r(1218),r(3298),r(5523);ae.l.ShadersStore.volumetricLightScatteringPassVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n";ae.l.ShadersStore.volumetricLightScatteringPassPixelShader="#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);if (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);}\n";class Fl extends W.w{get useDiffuseColor(){return l.V.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){l.V.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,s,r=100,n=G.g.BILINEAR_SAMPLINGMODE,a,o,l){super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,n,a,o,"#define NUM_SAMPLES "+r),this._screenCoordinates=I.I9.Zero(),this.customMeshPosition=I.Pq.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=[],this.includedMeshes=[],this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,a=(l=i?.getScene()??l??this._scene).getEngine(),this._viewPort=new te.L(0,0,1,1).toGlobal(a.getRenderWidth(),a.getRenderHeight()),this.mesh=s??Fl.CreateDefaultMesh("VolumetricLightScatteringMesh",l),this._createPass(l,t.passRatio||t),this.onActivate=e=>{this.isSupported||this.dispose(e),this.onActivate=null},this.onApplyObservable.add((e=>{this._updateMeshScreenCoordinates(l),e.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),e.setFloat("exposure",this.exposure),e.setFloat("decay",this.decay),e.setFloat("weight",this.weight),e.setFloat("density",this.density),e.setVector2("meshPositionOnScreen",this._screenCoordinates)}))}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){const i=e.getMesh();if(i===this.mesh&&i.material)return i.material.isReady(i);const s=i._internalAbstractMeshDataInfo._materialForRenderPass?.[this._scene.getEngine().currentRenderPassId];if(s)return s.isReadyForSubMesh(i,e,t);const r=[],n=[O.R.PositionKind],a=e.getMaterial();a&&(a.needAlphaTesting()&&r.push("#define ALPHATEST"),i.isVerticesDataPresent(O.R.UVKind)&&(n.push(O.R.UVKind),r.push("#define UV1")),i.isVerticesDataPresent(O.R.UV2Kind)&&(n.push(O.R.UV2Kind),r.push("#define UV2")));const o=new K;if(i.useBones&&i.computeBonesUsingShaders&&i.skeleton){n.push(O.R.MatricesIndicesKind),n.push(O.R.MatricesWeightsKind),i.numBoneInfluencers>4&&(n.push(O.R.MatricesIndicesExtraKind),n.push(O.R.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),i.numBoneInfluencers>0&&o.addCPUSkinningFallback(0,i);const e=i.skeleton;e.isUsingTextureForMatrices?r.push("#define BONETEXTURE"):r.push("#define BonesPerMesh "+(e.bones.length+1))}else r.push("#define NUM_BONE_INFLUENCERS 0");const l=i.morphTargetManager;let h=0;l&&(h=l.numMaxInfluencers||l.numInfluencers,h>0&&(r.push("#define MORPHTARGETS"),r.push("#define NUM_MORPH_INFLUENCERS "+h),l.isUsingTextureForTargets&&r.push("#define MORPHTARGETS_TEXTURE"),(0,$.MF)(n,i,h))),t&&(r.push("#define INSTANCES"),(0,$.te)(n),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES"));const c=i.bakedVertexAnimationManager;c&&c.isEnabled&&(r.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&n.push("bakedVertexAnimationSettingsInstanced"));const u=e._getDrawWrapper(void 0,!0),d=u.defines,_=r.join("\n");if(d!==_){const e=["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];u.setEffect(i.getScene().getEngine().createEffect("volumetricLightScatteringPass",{attributes:n,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:_,fallbacks:o,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:h}},i.getScene().getEngine()),_)}return u.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==t&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&-1===this.includedMeshes.indexOf(e)||this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new H.$("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=G.g.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=G.g.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const s=this.getCamera();s?s.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const r=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh();if(this._meshExcluded(t))return;i._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const s=e.getMaterial();if(!s)return;const r=t.getScene(),n=r.getEngine();n.setState(s.backFaceCulling,void 0,void 0,void 0,s.cullBackFaces);const a=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(a.mustReturn)return;const o=n.getCaps().instancedArrays&&(null!==a.visibleInstances[e._id]||t.hasThinInstances);if(this._isReady(e,o)){const l=i._internalAbstractMeshDataInfo._materialForRenderPass?.[n.currentRenderPassId];let h=e._getDrawWrapper();if(t!==this.mesh||h||(h=s._getDrawWrapper()),!h)return;const c=h.effect;if(n.enableEffect(h),o||t._bind(e,c,s.fillMode),t===this.mesh)s.bind(i.getWorldMatrix(),t);else if(l)l.bindForSubMesh(i.getWorldMatrix(),i,e);else{if(c.setMatrix("viewProjection",r.getTransformMatrix()),s.needAlphaTesting()){const e=s.getAlphaTestTexture();e&&(c.setTexture("diffuseSampler",e),c.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,$.f$)(t,c),(0,$.nR)(t,c),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(c);const i=e.getMesh().bakedVertexAnimationManager;i&&i.isEnabled&&i.bind(c,o)}o&&t.hasThinInstances&&c.setMatrix("world",i.getWorldMatrix()),t._processRendering(i,e,c,Te.i.TriangleFillMode,a,o,((e,t)=>{e||c.setMatrix("world",t)}))}};let n;const a=new M.ov(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add((()=>{n=e.clearColor,e.clearColor=a})),this._volumetricLightScatteringRTT.onAfterRenderObservable.add((()=>{e.clearColor=n})),this._volumetricLightScatteringRTT.customIsReadyFunction=(e,t,s)=>{if((s||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const s=e.subMeshes[t],r=s.getMaterial(),n=s.getRenderingMesh();if(!r)continue;const a=n._getInstancesRenderList(s._id,!!s.getReplacementMesh()),o=i.getCaps().instancedArrays&&(null!==a.visibleInstances[s._id]||n.hasThinInstances);if(!this._isReady(s,o))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(t,i,s,n)=>{const a=e.getEngine();let o;if(n.length){for(a.setColorWrite(!1),o=0;o<n.length;o++)r(n.data[o]);a.setColorWrite(!0)}for(o=0;o<t.length;o++)r(t.data[o]);for(o=0;o<i.length;o++)r(i.data[o]);if(s.length){for(o=0;o<s.length;o++){const t=s.data[o],i=t.getBoundingInfo();i&&e.activeCamera&&(t._alphaIndex=t.getMesh().alphaIndex,t._distanceToCamera=i.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const t=s.data.slice(0,s.length);for(t.sort(((e,t)=>e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0)),a.setAlphaMode(2),o=0;o<t.length;o++)r(t[o]);a.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;i=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const s=I.Pq.Project(i,I.uq.Identity(),t,this._viewPort);this._screenCoordinates.x=s.x/this._viewPort.width,this._screenCoordinates.y=s.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=_i(e,{size:1},t);i.billboardMode=bt.BILLBOARDMODE_ALL;const s=new Oe(e+"Material",t);return s.emissiveColor=new M.v9(1,1,1),i.material=s,i}}(0,w.Cg)([(0,D.P_)()],Fl.prototype,"customMeshPosition",void 0),(0,w.Cg)([(0,D.lK)()],Fl.prototype,"useCustomMeshPosition",void 0),(0,w.Cg)([(0,D.lK)()],Fl.prototype,"invert",void 0),(0,w.Cg)([(0,D.xG)()],Fl.prototype,"mesh",void 0),(0,w.Cg)([(0,D.lK)()],Fl.prototype,"excludedMeshes",void 0),(0,w.Cg)([(0,D.lK)()],Fl.prototype,"includedMeshes",void 0),(0,w.Cg)([(0,D.lK)()],Fl.prototype,"exposure",void 0),(0,w.Cg)([(0,D.lK)()],Fl.prototype,"decay",void 0),(0,w.Cg)([(0,D.lK)()],Fl.prototype,"weight",void 0),(0,w.Cg)([(0,D.lK)()],Fl.prototype,"density",void 0),(0,V.Y5)("BABYLON.VolumetricLightScatteringPostProcess",Fl);ae.l.ShadersStore.screenSpaceCurvaturePixelShader="precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform float curvature_ridge;uniform float curvature_valley;\n#ifndef CURVATURE_OFFSET\n#define CURVATURE_OFFSET 1\n#endif\nfloat curvature_soft_clamp(float curvature,float control)\n{if (curvature<0.5/control)\nreturn curvature*(1.0-curvature*control);return 0.25/control;}\nfloat calculate_curvature(ivec2 texel,float ridge,float valley)\n{vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));if (normal_diff<0.0)\nreturn -2.0*curvature_soft_clamp(-normal_diff,valley);return 2.0*curvature_soft_clamp(normal_diff,ridge);}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{ivec2 texel=ivec2(gl_FragCoord.xy);vec4 baseColor=texture2D(textureSampler,vUV);float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);baseColor.rgb*=curvature+1.0;gl_FragColor=baseColor;}";class Nl extends W.w{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,s,r,n,a,o=0,h=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,s,r,n,a,void 0,o,void 0,null,h),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?(this._geometryBufferRenderer.generateNormalsInWorldSpace&&l.V.Error("ScreenSpaceCurvaturePostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"),this.onApply=e=>{e.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),e.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const t=this._geometryBufferRenderer.getGBuffer().textures[1];e.setTexture("normalSampler",t)}):l.V.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){const e=t.q.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension}static _Parse(e,t,i,s){return N.p.Parse((()=>new Nl(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,s)}}(0,w.Cg)([(0,D.lK)()],Nl.prototype,"ridge",void 0),(0,w.Cg)([(0,D.lK)()],Nl.prototype,"valley",void 0),(0,V.Y5)("BABYLON.ScreenSpaceCurvaturePostProcess",Nl),r(6612),r(2083),r(4509),r(3802),r(2850),r(5417),r(9820),r(4511),r(9965),r(7682),r(1830),r(7811),r(7614),r(3153),r(5381),r(890),r(8625),r(9619),r(9411),r(9480),r(7694),r(2217),r(9336),r(6645),r(5491),r(5516),r(5499),r(9669),r(2578),r(3208),r(3996),r(5783),r(9723),r(1506),r(1537),r(2906),r(7670),r(3813),r(5830),r(8075),r(7961),r(7912),r(6920),r(265),r(3718),r(4069),r(7985),r(18);class Ll{constructor(e,t=Ll.UNITMODE_PIXEL,i=!0){this.negativeValueAllowed=i,this._value=1,this._unit=Ll.UNITMODE_PIXEL,this.ignoreAdaptiveScaling=!1,this.onChangedObservable=new C.cP,this._value=e,this._unit=t,this._originalUnit=t}get isPercentage(){return this._unit===Ll.UNITMODE_PERCENTAGE}get isPixel(){return this._unit===Ll.UNITMODE_PIXEL}get internalValue(){return this._value}get value(){return this._value}set value(e){e!==this._value&&(this._value=e,this.onChangedObservable.notifyObservers())}get unit(){return this._unit}set unit(e){e!==this._unit&&(this._unit=e,this.onChangedObservable.notifyObservers())}getValueInPixel(e,t){return this.isPixel?this.getValue(e):this.getValue(e)*t}updateInPlace(e,t=Ll.UNITMODE_PIXEL){return this.value===e&&this.unit===t||(this._value=e,this._unit=t,this.onChangedObservable.notifyObservers()),this}getValue(e){if(e&&!this.ignoreAdaptiveScaling&&this.unit!==Ll.UNITMODE_PERCENTAGE){let t=0,i=0;if(e.idealWidth&&(t=Math.ceil(this._value*e.getSize().width/e.idealWidth)),e.idealHeight&&(i=Math.ceil(this._value*e.getSize().height/e.idealHeight)),e.useSmallestIdeal&&e.idealWidth&&e.idealHeight)return window.innerWidth<window.innerHeight?t:i;if(e.idealWidth)return t;if(e.idealHeight)return i}return this._value}toString(e,t){switch(this._unit){case Ll.UNITMODE_PERCENTAGE:{const i=100*this.getValue(e);return(t?i.toFixed(t):i)+"%"}case Ll.UNITMODE_PIXEL:{const i=this.getValue(e);return(t?i.toFixed(t):i)+"px"}}return this._unit.toString()}fromString(e){const t=Ll._Regex.exec(e.toString());if(!t||0===t.length)return!1;let i=parseFloat(t[1]),s=this._originalUnit;if(this.negativeValueAllowed||i<0&&(i=0),4===t.length)switch(t[3]){case"px":s=Ll.UNITMODE_PIXEL;break;case"%":s=Ll.UNITMODE_PERCENTAGE,i/=100}return(i!==this._value||s!==this._unit)&&(this._value=i,this._unit=s,this.onChangedObservable.notifyObservers(),!0)}static get UNITMODE_PERCENTAGE(){return Ll._UNITMODE_PERCENTAGE}static get UNITMODE_PIXEL(){return Ll._UNITMODE_PIXEL}}Ll._Regex=/(^-?\d*(\.\d+)?)(%|px)?/,Ll._UNITMODE_PERCENTAGE=0,Ll._UNITMODE_PIXEL=1;const Bl=[new I.I9(0,0),new I.I9(0,0),new I.I9(0,0),new I.I9(0,0)],kl=[new I.I9(0,0),new I.I9(0,0),new I.I9(0,0),new I.I9(0,0)],Vl=new I.I9(0,0),Ul=new I.I9(0,0);class zl{constructor(e,t,i,s){this.left=e,this.top=t,this.width=i,this.height=s}copyFrom(e){this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height}copyFromFloats(e,t,i,s){this.left=e,this.top=t,this.width=i,this.height=s}static CombineToRef(e,t,i){const s=Math.min(e.left,t.left),r=Math.min(e.top,t.top),n=Math.max(e.left+e.width,t.left+t.width),a=Math.max(e.top+e.height,t.top+t.height);i.left=s,i.top=r,i.width=n-s,i.height=a-r}addAndTransformToRef(e,t,i,s,r,n){const a=this.left+t,o=this.top+i,l=this.width+s,h=this.height+r;Bl[0].copyFromFloats(a,o),Bl[1].copyFromFloats(a+l,o),Bl[2].copyFromFloats(a+l,o+h),Bl[3].copyFromFloats(a,o+h),Vl.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE),Ul.copyFromFloats(0,0);for(let t=0;t<4;t++)e.transformCoordinates(Bl[t].x,Bl[t].y,kl[t]),Vl.x=Math.floor(Math.min(Vl.x,kl[t].x)),Vl.y=Math.floor(Math.min(Vl.y,kl[t].y)),Ul.x=Math.ceil(Math.max(Ul.x,kl[t].x)),Ul.y=Math.ceil(Math.max(Ul.y,kl[t].y));n.left=Vl.x,n.top=Vl.y,n.width=Ul.x-Vl.x,n.height=Ul.y-Vl.y}transformToRef(e,t){this.addAndTransformToRef(e,0,0,0,0,t)}isEqualsTo(e){return this.left===e.left&&this.top===e.top&&this.width===e.width&&this.height===e.height}static Empty(){return new zl(0,0,0,0)}}class Gl extends I.I9{constructor(e,t=0){super(e.x,e.y),this.buttonIndex=t}}class Hl{constructor(e,t,i,s,r,n){this.m=new Float32Array(6),this.fromValues(e,t,i,s,r,n)}fromValues(e,t,i,s,r,n){return this.m[0]=e,this.m[1]=t,this.m[2]=i,this.m[3]=s,this.m[4]=r,this.m[5]=n,this}determinant(){return this.m[0]*this.m[3]-this.m[1]*this.m[2]}invertToRef(e){const t=this.m[0],i=this.m[1],s=this.m[2],r=this.m[3],n=this.m[4],a=this.m[5],o=this.determinant();if(o<ft.bH*ft.bH)return e.m[0]=0,e.m[1]=0,e.m[2]=0,e.m[3]=0,e.m[4]=0,e.m[5]=0,this;const l=1/o,h=s*a-r*n,c=i*n-t*a;return e.m[0]=r*l,e.m[1]=-i*l,e.m[2]=-s*l,e.m[3]=t*l,e.m[4]=h*l,e.m[5]=c*l,this}multiplyToRef(e,t){const i=this.m[0],s=this.m[1],r=this.m[2],n=this.m[3],a=this.m[4],o=this.m[5],l=e.m[0],h=e.m[1],c=e.m[2],u=e.m[3],d=e.m[4],_=e.m[5];return t.m[0]=i*l+s*c,t.m[1]=i*h+s*u,t.m[2]=r*l+n*c,t.m[3]=r*h+n*u,t.m[4]=a*l+o*c+d,t.m[5]=a*h+o*u+_,this}transformCoordinates(e,t,i){return i.x=e*this.m[0]+t*this.m[2]+this.m[4],i.y=e*this.m[1]+t*this.m[3]+this.m[5],this}static Identity(){return new Hl(1,0,0,1,0,0)}static IdentityToRef(e){e.m[0]=1,e.m[1]=0,e.m[2]=0,e.m[3]=1,e.m[4]=0,e.m[5]=0}static TranslationToRef(e,t,i){i.fromValues(1,0,0,1,e,t)}static ScalingToRef(e,t,i){i.fromValues(e,0,0,t,0,0)}static RotationToRef(e,t){const i=Math.sin(e),s=Math.cos(e);t.fromValues(s,i,-i,s,0,0)}static ComposeToRef(e,t,i,s,r,n,a){Hl.TranslationToRef(e,t,Hl._TempPreTranslationMatrix),Hl.ScalingToRef(s,r,Hl._TempScalingMatrix),Hl.RotationToRef(i,Hl._TempRotationMatrix),Hl.TranslationToRef(-e,-t,Hl._TempPostTranslationMatrix),Hl._TempPreTranslationMatrix.multiplyToRef(Hl._TempScalingMatrix,Hl._TempCompose0),Hl._TempCompose0.multiplyToRef(Hl._TempRotationMatrix,Hl._TempCompose1),n?(Hl._TempCompose1.multiplyToRef(Hl._TempPostTranslationMatrix,Hl._TempCompose2),Hl._TempCompose2.multiplyToRef(n,a)):Hl._TempCompose1.multiplyToRef(Hl._TempPostTranslationMatrix,a)}}Hl._TempPreTranslationMatrix=Hl.Identity(),Hl._TempPostTranslationMatrix=Hl.Identity(),Hl._TempRotationMatrix=Hl.Identity(),Hl._TempScalingMatrix=Hl.Identity(),Hl._TempCompose0=Hl.Identity(),Hl._TempCompose1=Hl.Identity(),Hl._TempCompose2=Hl.Identity();class Wl{static Round(e,t=Wl.DefaultRoundingPrecision){return Math.round(e*t)/t}}Wl.DefaultRoundingPrecision=100;class Xl{get isReadOnly(){return this._isReadOnly}set isReadOnly(e){this._isReadOnly=e}get transformedMeasure(){return this._evaluatedMeasure}set clipChildren(e){this._clipChildren=e}get clipChildren(){return this._clipChildren}set clipContent(e){this._clipContent=e}get clipContent(){return this._clipContent}get shadowOffsetX(){return this._shadowOffsetX}set shadowOffsetX(e){this._shadowOffsetX!==e&&(this._shadowOffsetX=e,this._markAsDirty())}get shadowOffsetY(){return this._shadowOffsetY}set shadowOffsetY(e){this._shadowOffsetY!==e&&(this._shadowOffsetY=e,this._markAsDirty())}get shadowBlur(){return this._shadowBlur}set shadowBlur(e){this._shadowBlur!==e&&(this._previousShadowBlur=this._shadowBlur,this._shadowBlur=e,this._markAsDirty())}get shadowColor(){return this._shadowColor}set shadowColor(e){this._shadowColor!==e&&(this._shadowColor=e,this._markAsDirty())}get typeName(){return this._getTypeName()}getClassName(){return this._getTypeName()}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get host(){return this._host}get fontOffset(){return this._fontOffset}set fontOffset(e){this._fontOffset=e}get alpha(){return this._alpha}set alpha(e){this._alpha!==e&&(this._alphaSet=!0,this._alpha=e,this._markAsDirty())}get highlightLineWidth(){return this._highlightLineWidth}set highlightLineWidth(e){this._highlightLineWidth!==e&&(this._highlightLineWidth=e,this._markAsDirty())}get isHighlighted(){return this._isHighlighted}set isHighlighted(e){this._isHighlighted!==e&&(this._isHighlighted=e,this._markAsDirty())}get highlightColor(){return this._highlightColor}set highlightColor(e){this._highlightColor!==e&&(this._highlightColor=e,this._markAsDirty())}get scaleX(){return this._scaleX}set scaleX(e){this._scaleX!==e&&(this._scaleX=e,this._markAsDirty(),this._markMatrixAsDirty())}get scaleY(){return this._scaleY}set scaleY(e){this._scaleY!==e&&(this._scaleY=e,this._markAsDirty(),this._markMatrixAsDirty())}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._markAsDirty(),this._markMatrixAsDirty())}get transformCenterY(){return this._transformCenterY}set transformCenterY(e){this._transformCenterY!==e&&(this._transformCenterY=e,this._markAsDirty(),this._markMatrixAsDirty())}get transformCenterX(){return this._transformCenterX}set transformCenterX(e){this._transformCenterX!==e&&(this._transformCenterX=e,this._markAsDirty(),this._markMatrixAsDirty())}get horizontalAlignment(){return this._horizontalAlignment}set horizontalAlignment(e){this._horizontalAlignment!==e&&(this._horizontalAlignment=e,this._markAsDirty())}get verticalAlignment(){return this._verticalAlignment}set verticalAlignment(e){this._verticalAlignment!==e&&(this._verticalAlignment=e,this._markAsDirty())}set fixedRatio(e){this._fixedRatio!==e&&(this._fixedRatio=e,this._markAsDirty())}get fixedRatio(){return this._fixedRatio}set fixedRatioMasterIsWidth(e){this._fixedRatioMasterIsWidth!==e&&(this._fixedRatioMasterIsWidth=e,this._markAsDirty())}get fixedRatioMasterIsWidth(){return this._fixedRatioMasterIsWidth}get width(){return this._width.toString(this._host)}set width(e){this._fixedRatioMasterIsWidth=!0,this._width.toString(this._host)!==e&&this._width.fromString(e)&&this._markAsDirty()}get widthInPixels(){return this._width.getValueInPixel(this._host,this._cachedParentMeasure.width)}set widthInPixels(e){isNaN(e)||(this._fixedRatioMasterIsWidth=!0,this.width=e+"px")}get height(){return this._height.toString(this._host)}set height(e){this._fixedRatioMasterIsWidth=!1,this._height.toString(this._host)!==e&&this._height.fromString(e)&&this._markAsDirty()}get heightInPixels(){return this._height.getValueInPixel(this._host,this._cachedParentMeasure.height)}set heightInPixels(e){isNaN(e)||(this._fixedRatioMasterIsWidth=!1,this.height=e+"px")}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this._resetFontCache())}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle!==e&&(this._fontStyle=e,this._resetFontCache())}get fontWeight(){return this._fontWeight}set fontWeight(e){this._fontWeight!==e&&(this._fontWeight=e,this._resetFontCache())}get style(){return this._style}set style(e){this._style&&(this._style.onChangedObservable.remove(this._styleObserver),this._styleObserver=null),this._style=e,this._style&&(this._styleObserver=this._style.onChangedObservable.add((()=>{this._markAsDirty(),this._resetFontCache()}))),this._markAsDirty(),this._resetFontCache()}get _isFontSizeInPercentage(){return this._fontSize.isPercentage}get fontSizeInPixels(){const e=this._style?this._style._fontSize:this._fontSize;return e.isPixel?e.getValue(this._host):e.getValueInPixel(this._host,this._tempParentMeasure.height||this._cachedParentMeasure.height)}set fontSizeInPixels(e){isNaN(e)||(this.fontSize=e+"px")}get fontSize(){return this._fontSize.toString(this._host)}set fontSize(e){this._fontSize.toString(this._host)!==e&&this._fontSize.fromString(e)&&(this._markAsDirty(),this._resetFontCache())}get color(){return this._color}set color(e){this._color!==e&&(this._color=e,this._markAsDirty())}get gradient(){return this._gradient}set gradient(e){this._gradient!==e&&(this._gradient=e,this._markAsDirty())}get zIndex(){return this._zIndex}set zIndex(e){this.zIndex!==e&&(this._zIndex=e,this.parent&&this.parent._reOrderControl(this))}get notRenderable(){return this._doNotRender}set notRenderable(e){this._doNotRender!==e&&(this._doNotRender=e,this._markAsDirty())}get isVisible(){return this._isVisible}set isVisible(e){this._isVisible!==e&&(this._isVisible=e,this._markAsDirty(!0),this.onIsVisibleChangedObservable.notifyObservers(e))}get isDirty(){return this._isDirty}get linkedMesh(){return this._linkedMesh}get descendantsOnlyPadding(){return this._descendantsOnlyPadding}set descendantsOnlyPadding(e){this._descendantsOnlyPadding!==e&&(this._descendantsOnlyPadding=e,this._markAsDirty())}get paddingLeft(){return this._paddingLeft.toString(this._host)}set paddingLeft(e){this._paddingLeft.fromString(e)&&this._markAsDirty()}get paddingLeftInPixels(){return this._paddingLeft.getValueInPixel(this._host,this._cachedParentMeasure.width)}set paddingLeftInPixels(e){isNaN(e)||(this.paddingLeft=e+"px")}get _paddingLeftInPixels(){return this._descendantsOnlyPadding?0:this.paddingLeftInPixels}get paddingRight(){return this._paddingRight.toString(this._host)}set paddingRight(e){this._paddingRight.fromString(e)&&this._markAsDirty()}get paddingRightInPixels(){return this._paddingRight.getValueInPixel(this._host,this._cachedParentMeasure.width)}set paddingRightInPixels(e){isNaN(e)||(this.paddingRight=e+"px")}get _paddingRightInPixels(){return this._descendantsOnlyPadding?0:this.paddingRightInPixels}get paddingTop(){return this._paddingTop.toString(this._host)}set paddingTop(e){this._paddingTop.fromString(e)&&this._markAsDirty()}get paddingTopInPixels(){return this._paddingTop.getValueInPixel(this._host,this._cachedParentMeasure.height)}set paddingTopInPixels(e){isNaN(e)||(this.paddingTop=e+"px")}get _paddingTopInPixels(){return this._descendantsOnlyPadding?0:this.paddingTopInPixels}get paddingBottom(){return this._paddingBottom.toString(this._host)}set paddingBottom(e){this._paddingBottom.fromString(e)&&this._markAsDirty()}get paddingBottomInPixels(){return this._paddingBottom.getValueInPixel(this._host,this._cachedParentMeasure.height)}set paddingBottomInPixels(e){isNaN(e)||(this.paddingBottom=e+"px")}get _paddingBottomInPixels(){return this._descendantsOnlyPadding?0:this.paddingBottomInPixels}get left(){return this._left.toString(this._host)}set left(e){this._left.fromString(e)&&this._markAsDirty()}get leftInPixels(){return this._left.getValueInPixel(this._host,this._cachedParentMeasure.width)}set leftInPixels(e){isNaN(e)||(this.left=e+"px")}get top(){return this._top.toString(this._host)}set top(e){this._top.fromString(e)&&this._markAsDirty()}get topInPixels(){return this._top.getValueInPixel(this._host,this._cachedParentMeasure.height)}set topInPixels(e){isNaN(e)||(this.top=e+"px")}get linkOffsetX(){return this._linkOffsetX.toString(this._host)}set linkOffsetX(e){this._linkOffsetX.fromString(e)&&this._markAsDirty()}get linkOffsetXInPixels(){return this._linkOffsetX.getValueInPixel(this._host,this._cachedParentMeasure.width)}set linkOffsetXInPixels(e){isNaN(e)||(this.linkOffsetX=e+"px")}get linkOffsetY(){return this._linkOffsetY.toString(this._host)}set linkOffsetY(e){this._linkOffsetY.fromString(e)&&this._markAsDirty()}get linkOffsetYInPixels(){return this._linkOffsetY.getValueInPixel(this._host,this._cachedParentMeasure.height)}set linkOffsetYInPixels(e){isNaN(e)||(this.linkOffsetY=e+"px")}get centerX(){return this._currentMeasure.left+this._currentMeasure.width/2}get centerY(){return this._currentMeasure.top+this._currentMeasure.height/2}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled===e)return;this._isEnabled=e,this._markAsDirty();const t=e=>{if(e.host){for(const t in e.host._lastControlOver)e===this.host._lastControlOver[t]&&(e._onPointerOut(e,null,!0),delete e.host._lastControlOver[t]);void 0!==e.children&&e.children.forEach(t)}};t(this),this.onEnabledStateChangedObservable.notifyObservers(e)}get disabledColor(){return this._disabledColor}set disabledColor(e){this._disabledColor!==e&&(this._disabledColor=e,this._markAsDirty())}get disabledColorItem(){return this._disabledColorItem}set disabledColorItem(e){this._disabledColorItem!==e&&(this._disabledColorItem=e,this._markAsDirty())}constructor(e){this.name=e,this._alpha=1,this._alphaSet=!1,this._zIndex=0,this._currentMeasure=zl.Empty(),this._tempPaddingMeasure=zl.Empty(),this._fontFamily="",this._fontStyle="",this._fontWeight="",this._fontSize=new Ll(18,Ll.UNITMODE_PIXEL,!1),this._width=new Ll(1,Ll.UNITMODE_PERCENTAGE,!1),this._height=new Ll(1,Ll.UNITMODE_PERCENTAGE,!1),this._color="",this._style=null,this._horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_CENTER,this._verticalAlignment=Xl.VERTICAL_ALIGNMENT_CENTER,this._isDirty=!0,this._wasDirty=!1,this._tempParentMeasure=zl.Empty(),this._prevCurrentMeasureTransformedIntoGlobalSpace=zl.Empty(),this._cachedParentMeasure=zl.Empty(),this._descendantsOnlyPadding=!1,this._paddingLeft=new Ll(0),this._paddingRight=new Ll(0),this._paddingTop=new Ll(0),this._paddingBottom=new Ll(0),this._left=new Ll(0),this._top=new Ll(0),this._scaleX=1,this._scaleY=1,this._rotation=0,this._transformCenterX=.5,this._transformCenterY=.5,this._transformMatrix=Hl.Identity(),this._invertTransformMatrix=Hl.Identity(),this._transformedPosition=I.I9.Zero(),this._isMatrixDirty=!0,this._isVisible=!0,this._isHighlighted=!1,this._highlightColor="#4affff",this._highlightLineWidth=2,this._fontSet=!1,this._dummyVector2=I.I9.Zero(),this._downCount=0,this._enterCount=-1,this._doNotRender=!1,this._downPointerIds={},this._evaluatedMeasure=new zl(0,0,0,0),this._evaluatedParentMeasure=new zl(0,0,0,0),this._isEnabled=!0,this._disabledColor="#9a9a9a",this._disabledColorItem="#6a6a6a",this._isReadOnly=!1,this._gradient=null,this._rebuildLayout=!1,this.onEnabledStateChangedObservable=new C.cP,this._customData={},this._isClipped=!1,this._automaticSize=!1,this.metadata=null,this.isHitTestVisible=!0,this.isPointerBlocker=!1,this.isFocusInvisible=!1,this._clipChildren=!0,this._clipContent=!0,this.useBitmapCache=!1,this._shadowOffsetX=0,this._shadowOffsetY=0,this._shadowBlur=0,this._previousShadowBlur=0,this._shadowColor="black",this.hoverCursor="",this._linkOffsetX=new Ll(0),this._linkOffsetY=new Ll(0),this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new C.cP,this.onWheelObservable=new C.cP,this.onPointerMoveObservable=new C.cP,this.onPointerOutObservable=new C.cP,this.onPointerDownObservable=new C.cP,this.onPointerUpObservable=new C.cP,this.onPointerClickObservable=new C.cP,this.onPointerEnterObservable=new C.cP,this.onDirtyObservable=new C.cP,this.onBeforeDrawObservable=new C.cP,this.onAfterDrawObservable=new C.cP,this.onDisposeObservable=new C.cP,this.onIsVisibleChangedObservable=new C.cP,this.isSerializable=!0,this._fixedRatio=0,this._fixedRatioMasterIsWidth=!0,this.animations=null,this._tmpMeasureA=new zl(0,0,0,0)}_getTypeName(){return"Control"}getAscendantOfClass(e){return this.parent?this.parent.getClassName()===e?this.parent:this.parent.getAscendantOfClass(e):null}markAsDirty(e=!1){this._markAsDirty(e)}markAllAsDirty(){this._markAllAsDirty()}_resetFontCache(){this._fontSet=!0,this._markAsDirty()}isAscendant(e){return!!this.parent&&(this.parent===e||this.parent.isAscendant(e))}getLocalCoordinates(e){const t=I.I9.Zero();return this.getLocalCoordinatesToRef(e,t),t}getLocalCoordinatesToRef(e,t){return t.x=e.x-this._currentMeasure.left,t.y=e.y-this._currentMeasure.top,this}getParentLocalCoordinates(e){const t=I.I9.Zero();return t.x=e.x-this._cachedParentMeasure.left,t.y=e.y-this._cachedParentMeasure.top,t}moveToVector3(e,t){if(!this._host||this.parent!==this._host._rootContainer)return void ee.S0.Error("Cannot move a control to a vector3 if the control is not at root level");this.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,this.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP;const i=this._host._getGlobalViewport(),s=I.Pq.Project(e,I.uq.IdentityReadOnly,t.getTransformMatrix(),i);this._moveToProjectedPosition(s),s.z<0||s.z>1?this.notRenderable=!0:this.notRenderable=!1}getDescendantsToRef(e,t=!1,i){}getDescendants(e,t){const i=[];return this.getDescendantsToRef(i,e,t),i}linkWithMesh(e){if(!this._host||this.parent&&this.parent!==this._host._rootContainer)return void(e&&ee.S0.Error("Cannot link a control to a mesh if the control is not at root level"));const t=this._host._linkedControls.indexOf(this);if(-1!==t)return this._linkedMesh=e,void(e||this._host._linkedControls.splice(t,1));e&&(this.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,this.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,this._linkedMesh=e,this._host._linkedControls.push(this))}setPadding(e,t,i,s){const r=e,n=t??r,a=i??r,o=s??n;this.paddingTop=r,this.paddingRight=n,this.paddingBottom=a,this.paddingLeft=o}setPaddingInPixels(e,t,i,s){const r=e,n=t??r,a=i??r,o=s??n;this.paddingTopInPixels=r,this.paddingRightInPixels=n,this.paddingBottomInPixels=a,this.paddingLeftInPixels=o}_moveToProjectedPosition(e){const t=this._left.getValue(this._host),i=this._top.getValue(this._host),s=this.parent?._currentMeasure;s&&this._processMeasures(s,this._host.getContext());let r=e.x+this._linkOffsetX.getValue(this._host)-this._currentMeasure.width/2,n=e.y+this._linkOffsetY.getValue(this._host)-this._currentMeasure.height/2;const a=this._left.ignoreAdaptiveScaling&&this._top.ignoreAdaptiveScaling;a&&(Math.abs(r-t)<.5&&(r=t),Math.abs(n-i)<.5&&(n=i)),(a||t!==r||i!==n)&&(this.left=r+"px",this.top=n+"px",this._left.ignoreAdaptiveScaling=!0,this._top.ignoreAdaptiveScaling=!0,this._markAsDirty())}_offsetLeft(e){this._isDirty=!0,this._currentMeasure.left+=e}_offsetTop(e){this._isDirty=!0,this._currentMeasure.top+=e}_markMatrixAsDirty(){this._isMatrixDirty=!0,this._flagDescendantsAsMatrixDirty()}_flagDescendantsAsMatrixDirty(){}_intersectsRect(e,t){return this._transform(t),!(this._evaluatedMeasure.left>=e.left+e.width||this._evaluatedMeasure.top>=e.top+e.height||this._evaluatedMeasure.left+this._evaluatedMeasure.width<=e.left||this._evaluatedMeasure.top+this._evaluatedMeasure.height<=e.top)}_computeAdditionalOffsetX(){return 0}_computeAdditionalOffsetY(){return 0}invalidateRect(){if(this._transform(),this.host&&this.host.useInvalidateRectOptimization){this._currentMeasure.transformToRef(this._transformMatrix,this._tmpMeasureA),zl.CombineToRef(this._tmpMeasureA,this._prevCurrentMeasureTransformedIntoGlobalSpace,this._tmpMeasureA);const e=this.shadowOffsetX,t=this.shadowOffsetY,i=Math.max(this._previousShadowBlur,this.shadowBlur),s=Math.min(Math.min(e,0)-2*i,0),r=Math.max(Math.max(e,0)+2*i,0),n=Math.min(Math.min(t,0)-2*i,0),a=Math.max(Math.max(t,0)+2*i,0),o=this._computeAdditionalOffsetX(),l=this._computeAdditionalOffsetY();this.host.invalidateRect(Math.floor(this._tmpMeasureA.left+s-o),Math.floor(this._tmpMeasureA.top+n-l),Math.ceil(this._tmpMeasureA.left+this._tmpMeasureA.width+r+o),Math.ceil(this._tmpMeasureA.top+this._tmpMeasureA.height+a+l))}}_markAsDirty(e=!1){(this._isVisible||e)&&(this._isDirty=!0,this._markMatrixAsDirty(),this._host&&this._host.markAsDirty())}_markAllAsDirty(){this._markAsDirty(),this._font&&this._prepareFont()}_link(e){this._host=e,this._host&&(this.uniqueId=this._host.getScene().getUniqueId())}_transform(e){if(!this._isMatrixDirty&&1===this._scaleX&&1===this._scaleY&&0===this._rotation)return;const t=this._currentMeasure.width*this._transformCenterX+this._currentMeasure.left,i=this._currentMeasure.height*this._transformCenterY+this._currentMeasure.top;e&&(e.translate(t,i),e.rotate(this._rotation),e.scale(this._scaleX,this._scaleY),e.translate(-t,-i)),(this._isMatrixDirty||this._cachedOffsetX!==t||this._cachedOffsetY!==i)&&(this._cachedOffsetX=t,this._cachedOffsetY=i,this._isMatrixDirty=!1,this._flagDescendantsAsMatrixDirty(),Hl.ComposeToRef(-t,-i,this._rotation,this._scaleX,this._scaleY,this.parent?this.parent._transformMatrix:null,this._transformMatrix),this._transformMatrix.invertToRef(this._invertTransformMatrix),this._currentMeasure.transformToRef(this._transformMatrix,this._evaluatedMeasure))}_renderHighlight(e){this.isHighlighted&&(e.save(),e.strokeStyle=this._highlightColor,e.lineWidth=this._highlightLineWidth,this._renderHighlightSpecific(e),e.restore())}_renderHighlightSpecific(e){e.strokeRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)}_getColor(e){return this.gradient?this.gradient.getCanvasGradient(e):this.color}_applyStates(e){this._isFontSizeInPercentage&&(this._fontSet=!0),this._host&&this._host.useSmallestIdeal&&!this._font&&(this._fontSet=!0),this._fontSet&&(this._prepareFont(),this._fontSet=!1),this._font&&(e.font=this._font),(this._color||this.gradient)&&(e.fillStyle=this._getColor(e)),Xl.AllowAlphaInheritance?e.globalAlpha*=this._alpha:this._alphaSet&&(e.globalAlpha=this.parent&&!this.parent.renderToIntermediateTexture?this.parent.alpha*this._alpha:this._alpha)}_layout(e,t){if(!this.isDirty&&(!this.isVisible||this.notRenderable))return!1;if(this._isDirty||!this._cachedParentMeasure.isEqualsTo(e)){this.host._numLayoutCalls++,this._currentMeasure.addAndTransformToRef(this._transformMatrix,0|-this._paddingLeftInPixels,0|-this._paddingTopInPixels,0|this._paddingRightInPixels,0|this._paddingBottomInPixels,this._prevCurrentMeasureTransformedIntoGlobalSpace),t.save(),this._applyStates(t);let i=0;do{this._rebuildLayout=!1,this._processMeasures(e,t),i++}while(this._rebuildLayout&&i<3);i>=3&&l.V.Error(`Layout cycle detected in GUI (Control name=${this.name}, uniqueId=${this.uniqueId})`),t.restore(),this.invalidateRect(),this._evaluateClippingState(e)}return this._wasDirty=this._isDirty,this._isDirty=!1,!0}_processMeasures(e,t){this._tempPaddingMeasure.copyFrom(e),this.parent&&this.parent.descendantsOnlyPadding&&(this._tempPaddingMeasure.left+=this.parent.paddingLeftInPixels,this._tempPaddingMeasure.top+=this.parent.paddingTopInPixels,this._tempPaddingMeasure.width-=this.parent.paddingLeftInPixels+this.parent.paddingRightInPixels,this._tempPaddingMeasure.height-=this.parent.paddingTopInPixels+this.parent.paddingBottomInPixels),this._currentMeasure.copyFrom(this._tempPaddingMeasure),this._preMeasure(this._tempPaddingMeasure,t),this._measure(),this._postMeasure(this._tempPaddingMeasure,t),this._computeAlignment(this._tempPaddingMeasure,t),this._currentMeasure.left=0|this._currentMeasure.left,this._currentMeasure.top=0|this._currentMeasure.top,this._currentMeasure.width=0|this._currentMeasure.width,this._currentMeasure.height=0|this._currentMeasure.height,this._additionalProcessing(this._tempPaddingMeasure,t),this._cachedParentMeasure.copyFrom(this._tempPaddingMeasure),this._currentMeasure.transformToRef(this._transformMatrix,this._evaluatedMeasure),this.onDirtyObservable.hasObservers()&&this.onDirtyObservable.notifyObservers(this)}_evaluateClippingState(e){if(this._transform(),this._currentMeasure.transformToRef(this._transformMatrix,this._evaluatedMeasure),this.parent&&this.parent.clipChildren){if(e.transformToRef(this.parent._transformMatrix,this._evaluatedParentMeasure),this._evaluatedMeasure.left>this._evaluatedParentMeasure.left+this._evaluatedParentMeasure.width)return void(this._isClipped=!0);if(this._evaluatedMeasure.left+this._evaluatedMeasure.width<this._evaluatedParentMeasure.left)return void(this._isClipped=!0);if(this._evaluatedMeasure.top>this._evaluatedParentMeasure.top+this._evaluatedParentMeasure.height)return void(this._isClipped=!0);if(this._evaluatedMeasure.top+this._evaluatedMeasure.height<this._evaluatedParentMeasure.top)return void(this._isClipped=!0)}this._isClipped=!1}_measure(){this._width.isPixel?this._currentMeasure.width=this._width.getValue(this._host):this._currentMeasure.width*=this._width.getValue(this._host),this._height.isPixel?this._currentMeasure.height=this._height.getValue(this._host):this._currentMeasure.height*=this._height.getValue(this._host),0!==this._fixedRatio&&(this._fixedRatioMasterIsWidth?this._currentMeasure.height=this._currentMeasure.width*this._fixedRatio:this._currentMeasure.width=this._currentMeasure.height*this._fixedRatio)}_computeAlignment(e,t){const i=this._currentMeasure.width,s=this._currentMeasure.height,r=e.width,n=e.height;let a=0,o=0;switch(this.horizontalAlignment){case Xl.HORIZONTAL_ALIGNMENT_LEFT:a=0;break;case Xl.HORIZONTAL_ALIGNMENT_RIGHT:a=r-i;break;case Xl.HORIZONTAL_ALIGNMENT_CENTER:a=(r-i)/2}switch(this.verticalAlignment){case Xl.VERTICAL_ALIGNMENT_TOP:o=0;break;case Xl.VERTICAL_ALIGNMENT_BOTTOM:o=n-s;break;case Xl.VERTICAL_ALIGNMENT_CENTER:o=(n-s)/2}this.descendantsOnlyPadding||(this._paddingLeft.isPixel?(this._currentMeasure.left+=this._paddingLeft.getValue(this._host),this._currentMeasure.width-=this._paddingLeft.getValue(this._host)):(this._currentMeasure.left+=r*this._paddingLeft.getValue(this._host),this._currentMeasure.width-=r*this._paddingLeft.getValue(this._host)),this._paddingRight.isPixel?this._currentMeasure.width-=this._paddingRight.getValue(this._host):this._currentMeasure.width-=r*this._paddingRight.getValue(this._host),this._paddingTop.isPixel?(this._currentMeasure.top+=this._paddingTop.getValue(this._host),this._currentMeasure.height-=this._paddingTop.getValue(this._host)):(this._currentMeasure.top+=n*this._paddingTop.getValue(this._host),this._currentMeasure.height-=n*this._paddingTop.getValue(this._host)),this._paddingBottom.isPixel?this._currentMeasure.height-=this._paddingBottom.getValue(this._host):this._currentMeasure.height-=n*this._paddingBottom.getValue(this._host)),this._left.isPixel?this._currentMeasure.left+=this._left.getValue(this._host):this._currentMeasure.left+=r*this._left.getValue(this._host),this._top.isPixel?this._currentMeasure.top+=this._top.getValue(this._host):this._currentMeasure.top+=n*this._top.getValue(this._host),this._currentMeasure.left+=a,this._currentMeasure.top+=o}_preMeasure(e,t){}_postMeasure(e,t){}_additionalProcessing(e,t){}_clipForChildren(e){}_clip(e,t){if(e.beginPath(),Xl._ClipMeasure.copyFrom(this._currentMeasure),t){t.transformToRef(this._invertTransformMatrix,this._tmpMeasureA);const e=new zl(0,0,0,0);e.left=Math.max(this._tmpMeasureA.left,this._currentMeasure.left),e.top=Math.max(this._tmpMeasureA.top,this._currentMeasure.top),e.width=Math.min(this._tmpMeasureA.left+this._tmpMeasureA.width,this._currentMeasure.left+this._currentMeasure.width)-e.left,e.height=Math.min(this._tmpMeasureA.top+this._tmpMeasureA.height,this._currentMeasure.top+this._currentMeasure.height)-e.top,Xl._ClipMeasure.copyFrom(e)}if(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY){const t=this.shadowOffsetX,i=this.shadowOffsetY,s=this.shadowBlur,r=Math.min(Math.min(t,0)-2*s,0),n=Math.max(Math.max(t,0)+2*s,0),a=Math.min(Math.min(i,0)-2*s,0),o=Math.max(Math.max(i,0)+2*s,0);e.rect(Xl._ClipMeasure.left+r,Xl._ClipMeasure.top+a,Xl._ClipMeasure.width+n-r,Xl._ClipMeasure.height+o-a)}else e.rect(Xl._ClipMeasure.left,Xl._ClipMeasure.top,Xl._ClipMeasure.width,Xl._ClipMeasure.height);e.clip()}_render(e,t){return!this.isVisible||this.notRenderable||this._isClipped?(this._isDirty=!1,!1):(this.host._numRenderCalls++,e.save(),this._applyStates(e),this._transform(e),this.clipContent&&this._clip(e,t),this.onBeforeDrawObservable.hasObservers()&&this.onBeforeDrawObservable.notifyObservers(this),this.useBitmapCache&&!this._wasDirty&&this._cacheData?e.putImageData(this._cacheData,this._currentMeasure.left,this._currentMeasure.top):this._draw(e,t),this.useBitmapCache&&this._wasDirty&&(this._cacheData=e.getImageData(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),this._renderHighlight(e),this.onAfterDrawObservable.hasObservers()&&this.onAfterDrawObservable.notifyObservers(this),e.restore(),!0)}_draw(e,t){}contains(e,t){return this._invertTransformMatrix.transformCoordinates(e,t,this._transformedPosition),e=this._transformedPosition.x,t=this._transformedPosition.y,!(e<this._currentMeasure.left||e>this._currentMeasure.left+this._currentMeasure.width||t<this._currentMeasure.top||t>this._currentMeasure.top+this._currentMeasure.height||(this.isPointerBlocker&&(this._host._shouldBlockPointer=!0),0))}_processPicking(e,t,i,s,r,n,a,o){return!(!this._isEnabled||!this.isHitTestVisible||!this.isVisible||this._doNotRender||!this.contains(e,t)||(this._processObservables(s,e,t,i,r,n,a,o),0))}_onPointerMove(e,t,i,s){this.onPointerMoveObservable.notifyObservers(t,-1,e,this,s)&&null!=this.parent&&!this.isPointerBlocker&&this.parent._onPointerMove(e,t,i,s)}_onPointerEnter(e,t){return!!this._isEnabled&&(!(this._enterCount>0)&&(-1===this._enterCount&&(this._enterCount=0),this._enterCount++,this.onPointerEnterObservable.notifyObservers(this,-1,e,this,t)&&null!=this.parent&&!this.isPointerBlocker&&this.parent._onPointerEnter(e,t),!0))}_onPointerOut(e,t,i=!1){if(!(i||this._isEnabled&&e!==this))return;this._enterCount=0;let s=!0;e.isAscendant(this)||(s=this.onPointerOutObservable.notifyObservers(this,-1,e,this,t)),s&&null!=this.parent&&!this.isPointerBlocker&&this.parent._onPointerOut(e,t,i)}_onPointerDown(e,t,i,s,r){return this._onPointerEnter(this,r),0===this._downCount&&(this._downCount++,this._downPointerIds[i]=!0,this.onPointerDownObservable.notifyObservers(new Gl(t,s),-1,e,this,r)&&null!=this.parent&&!this.isPointerBlocker&&this.parent._onPointerDown(e,t,i,s,r),r&&this.uniqueId!==this._host.rootContainer.uniqueId&&this._host._capturedPointerIds.add(r.event.pointerId),!0)}_onPointerUp(e,t,i,s,r,n){if(!this._isEnabled)return;this._downCount=0,delete this._downPointerIds[i];let a=r;r&&(this._enterCount>0||-1===this._enterCount)&&(a=this.onPointerClickObservable.notifyObservers(new Gl(t,s),-1,e,this,n)),this.onPointerUpObservable.notifyObservers(new Gl(t,s),-1,e,this,n)&&null!=this.parent&&!this.isPointerBlocker&&this.parent._onPointerUp(e,t,i,s,a,n),n&&this.uniqueId!==this._host.rootContainer.uniqueId&&this._host._capturedPointerIds.delete(n.event.pointerId)}_forcePointerUp(e=null){if(null!==e)this._onPointerUp(this,I.I9.Zero(),e,0,!0);else for(const e in this._downPointerIds)this._onPointerUp(this,I.I9.Zero(),+e,0,!0)}_onWheelScroll(e,t){this._isEnabled&&this.onWheelObservable.notifyObservers(new I.I9(e,t))&&null!=this.parent&&this.parent._onWheelScroll(e,t)}_onCanvasBlur(){}_processObservables(e,t,i,s,r,n,a,o){if(!this._isEnabled)return!1;if(this._dummyVector2.copyFromFloats(t,i),e===Rt.Zp.POINTERMOVE){this._onPointerMove(this,this._dummyVector2,r,s);const e=this._host._lastControlOver[r];return e&&e!==this&&e._onPointerOut(this,s),e!==this&&this._onPointerEnter(this,s),this._host._lastControlOver[r]=this,!0}return e===Rt.Zp.POINTERDOWN?(this._onPointerDown(this,this._dummyVector2,r,n,s),this._host._registerLastControlDown(this,r),this._host._lastPickedControl=this,!0):e===Rt.Zp.POINTERUP?(this._host._lastControlDown[r]&&this._host._lastControlDown[r]._onPointerUp(this,this._dummyVector2,r,n,!0,s),delete this._host._lastControlDown[r],!0):!(e!==Rt.Zp.POINTERWHEEL||!this._host._lastControlOver[r]||(this._host._lastControlOver[r]._onWheelScroll(a,o),0))}_getStyleProperty(e,t){const i=(this._style&&this._style[e])??this[e];return!i&&this.parent?this.parent._getStyleProperty(e,t):this.parent?i:t}_prepareFont(){(this._font||this._fontSet)&&(this._font=this._getStyleProperty("fontStyle","")+" "+this._getStyleProperty("fontWeight","")+" "+this.fontSizeInPixels+"px "+this._getStyleProperty("fontFamily","Arial"),this._fontOffset=Xl._GetFontOffset(this._font,this._host?.getScene()?.getEngine()),this.getDescendants().forEach((e=>e._markAllAsDirty())))}isDimensionFullyDefined(e){return this.getDimension(e).isPixel}getDimension(e){return"width"===e?this._width:this._height}clone(e){const t={};this.serialize(t,!0);const i=new(ee.S0.Instantiate("BABYLON.GUI."+t.className));return i.parse(t,e),i}parse(e,t,i){return this._urlRewriter=i,N.p.Parse((()=>this),e,null),this.name=e.name,this._parseFromContent(e,t??this._host),this}serialize(e,t=!1,i=!0){(this.isSerializable||t)&&(N.p.Serialize(this,e),e.name=this.name,e.className=this.getClassName(),i&&this._prepareFont(),this._fontFamily&&(e.fontFamily=this._fontFamily),this.fontSize&&(e.fontSize=this.fontSize),this.fontWeight&&(e.fontWeight=this.fontWeight),this.fontStyle&&(e.fontStyle=this.fontStyle),this._gradient&&(e.gradient={},this._gradient.serialize(e.gradient)),N.p.AppendSerializedAnimations(this,e))}_parseFromContent(e,t,i){if(e.fontFamily&&(this.fontFamily=e.fontFamily),e.fontSize&&(this.fontSize=e.fontSize),e.fontWeight&&(this.fontWeight=e.fontWeight),e.fontStyle&&(this.fontStyle=e.fontStyle),e.gradient){const t=ee.S0.Instantiate("BABYLON.GUI."+e.gradient.className);this._gradient=new t,this._gradient?.parse(e.gradient)}if(e.animations){this.animations=[];for(let t=0;t<e.animations.length;t++){const i=e.animations[t],s=(0,V.n9)("BABYLON.Animation");s&&this.animations.push(s.Parse(i))}e.autoAnimate&&this._host&&this._host.getScene()&&this._host.getScene().beginAnimation(this,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}this.fixedRatioMasterIsWidth=e.fixedRatioMasterIsWidth??this.fixedRatioMasterIsWidth}dispose(){this.onDirtyObservable.clear(),this.onBeforeDrawObservable.clear(),this.onAfterDrawObservable.clear(),this.onPointerDownObservable.clear(),this.onPointerEnterObservable.clear(),this.onPointerMoveObservable.clear(),this.onPointerOutObservable.clear(),this.onPointerUpObservable.clear(),this.onPointerClickObservable.clear(),this.onWheelObservable.clear(),this._styleObserver&&this._style&&(this._style.onChangedObservable.remove(this._styleObserver),this._styleObserver=null),this.parent&&(this.parent.removeControl(this),this.parent=null),this._host&&this._host._linkedControls.indexOf(this)>-1&&this.linkWithMesh(null),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}static get HORIZONTAL_ALIGNMENT_LEFT(){return Xl._HORIZONTAL_ALIGNMENT_LEFT}static get HORIZONTAL_ALIGNMENT_RIGHT(){return Xl._HORIZONTAL_ALIGNMENT_RIGHT}static get HORIZONTAL_ALIGNMENT_CENTER(){return Xl._HORIZONTAL_ALIGNMENT_CENTER}static get VERTICAL_ALIGNMENT_TOP(){return Xl._VERTICAL_ALIGNMENT_TOP}static get VERTICAL_ALIGNMENT_BOTTOM(){return Xl._VERTICAL_ALIGNMENT_BOTTOM}static get VERTICAL_ALIGNMENT_CENTER(){return Xl._VERTICAL_ALIGNMENT_CENTER}static _GetFontOffset(e,i){if(Xl._FontHeightSizes[e])return Xl._FontHeightSizes[e];const s=i||t.q.LastCreatedEngine;if(!s)throw new Error("Invalid engine. Unable to create a canvas.");const r=s.getFontOffset(e);return Xl._FontHeightSizes[e]=r,r}static Parse(e,t,i){const s=ee.S0.Instantiate("BABYLON.GUI."+e.className),r=N.p.Parse((()=>{const e=new s;return e._urlRewriter=i,e}),e,null);return r.name=e.name,r._parseFromContent(e,t,i),r}static drawEllipse(e,t,i,s,r,n){n.translate(e,t),n.scale(i,s),n.beginPath(),n.arc(0,0,1,0,2*Math.PI*r,r<0),r>=1&&n.closePath(),n.scale(1/i,1/s),n.translate(-e,-t)}isReady(){return!0}}Xl.AllowAlphaInheritance=!1,Xl._ClipMeasure=new zl(0,0,0,0),Xl._HORIZONTAL_ALIGNMENT_LEFT=0,Xl._HORIZONTAL_ALIGNMENT_RIGHT=1,Xl._HORIZONTAL_ALIGNMENT_CENTER=2,Xl._VERTICAL_ALIGNMENT_TOP=0,Xl._VERTICAL_ALIGNMENT_BOTTOM=1,Xl._VERTICAL_ALIGNMENT_CENTER=2,Xl._FontHeightSizes={},Xl.AddHeader=()=>{},(0,w.Cg)([(0,D.lK)()],Xl.prototype,"metadata",void 0),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"isHitTestVisible",void 0),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"isPointerBlocker",void 0),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"isFocusInvisible",void 0),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"clipChildren",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"clipContent",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"useBitmapCache",void 0),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"shadowOffsetX",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"shadowOffsetY",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"shadowBlur",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"shadowColor",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"hoverCursor",void 0),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"fontOffset",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"alpha",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"isSerializable",void 0),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"scaleX",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"scaleY",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"rotation",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"transformCenterY",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"transformCenterX",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"horizontalAlignment",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"verticalAlignment",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"fixedRatio",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"fixedRatioMasterIsWidth",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"width",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"height",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"style",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"color",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"gradient",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"zIndex",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"notRenderable",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"isVisible",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"descendantsOnlyPadding",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"paddingLeft",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"paddingRight",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"paddingTop",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"paddingBottom",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"left",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"top",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"linkOffsetX",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"linkOffsetY",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"isEnabled",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"disabledColor",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"disabledColorItem",null),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"overlapGroup",void 0),(0,w.Cg)([(0,D.lK)()],Xl.prototype,"overlapDeltaMultiplier",void 0),(0,V.Y5)("BABYLON.GUI.Control",Xl);class Kl extends Xl{get renderToIntermediateTexture(){return this._renderToIntermediateTexture}set renderToIntermediateTexture(e){this._renderToIntermediateTexture!==e&&(this._renderToIntermediateTexture=e,this._markAsDirty())}get adaptHeightToChildren(){return this._adaptHeightToChildren}set adaptHeightToChildren(e){this._adaptHeightToChildren!==e&&(this._adaptHeightToChildren=e,e&&(this.height="100%"),this._markAsDirty())}get adaptWidthToChildren(){return this._adaptWidthToChildren}set adaptWidthToChildren(e){this._adaptWidthToChildren!==e&&(this._adaptWidthToChildren=e,e&&(this.width="100%"),this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get backgroundGradient(){return this._backgroundGradient}set backgroundGradient(e){this._backgroundGradient!==e&&(this._backgroundGradient=e,this._markAsDirty())}get children(){return this._children}get isReadOnly(){return this._isReadOnly}set isReadOnly(e){this._isReadOnly=e;for(const t of this._children)t.isReadOnly=e}constructor(e){super(e),this.name=e,this._children=new Array,this._measureForChildren=zl.Empty(),this._background="",this._backgroundGradient=null,this._adaptWidthToChildren=!1,this._adaptHeightToChildren=!1,this._renderToIntermediateTexture=!1,this._intermediateTexture=null,this.delegatePickingToChildren=!1,this.logLayoutCycleErrors=!1,this.maxLayoutCycle=3,this.onControlAddedObservable=new C.cP,this.onControlRemovedObservable=new C.cP,this._inverseTransformMatrix=Hl.Identity(),this._inverseMeasure=new zl(0,0,0,0)}_getTypeName(){return"Container"}_flagDescendantsAsMatrixDirty(){for(const e of this.children)e._isClipped=!1,e._markMatrixAsDirty()}getChildByName(e){for(const t of this.children)if(t.name===e)return t;return null}getChildByType(e,t){for(const e of this.children)if(e.typeName===t)return e;return null}containsControl(e){return-1!==this.children.indexOf(e)}addControl(e){return e?(-1!==this._children.indexOf(e)||(e._link(this._host),e._markAllAsDirty(),this._reOrderControl(e),this._markAsDirty(),this.onControlAddedObservable.notifyObservers(e)),this):this}clearControls(){const e=this.children.slice();for(const t of e)this.removeControl(t);return this}removeControl(e){const t=this._children.indexOf(e);return-1!==t&&(this._children.splice(t,1),e.parent=null),e.linkWithMesh(null),this._host&&this._host._cleanControlAfterRemoval(e),this._markAsDirty(),this.onControlRemovedObservable.notifyObservers(e),this}_reOrderControl(e){const t=e.linkedMesh;this.removeControl(e);let i=!1;for(let t=0;t<this._children.length;t++)if(this._children[t].zIndex>e.zIndex){this._children.splice(t,0,e),i=!0;break}i||this._children.push(e),e.parent=this,t&&e.linkWithMesh(t),this._markAsDirty()}_offsetLeft(e){super._offsetLeft(e);for(const t of this._children)t._offsetLeft(e)}_offsetTop(e){super._offsetTop(e);for(const t of this._children)t._offsetTop(e)}_markAllAsDirty(){super._markAllAsDirty();for(let e=0;e<this._children.length;e++)this._children[e]._markAllAsDirty()}_getBackgroundColor(e){return this._backgroundGradient?this._backgroundGradient.getCanvasGradient(e):this._background}_localDraw(e){(this._background||this._backgroundGradient)&&(e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),e.fillStyle=this._getBackgroundColor(e),e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height),e.restore())}_link(e){super._link(e);for(const t of this._children)t._link(e)}_beforeLayout(){}_processMeasures(e,t){!this._isDirty&&this._cachedParentMeasure.isEqualsTo(e)||(super._processMeasures(e,t),this._evaluateClippingState(e),this._renderToIntermediateTexture&&(this._intermediateTexture&&this._host.getScene()!=this._intermediateTexture.getScene()&&(this._intermediateTexture.dispose(),this._intermediateTexture=null),this._intermediateTexture?this._intermediateTexture.scaleTo(this._currentMeasure.width,this._currentMeasure.height):(this._intermediateTexture=new ss("",{width:this._currentMeasure.width,height:this._currentMeasure.height},this._host.getScene(),!1,G.g.NEAREST_SAMPLINGMODE,Pa.Y.TEXTUREFORMAT_RGBA,!1),this._intermediateTexture.hasAlpha=!0)))}_layout(e,t){if(!this.isDirty&&(!this.isVisible||this.notRenderable))return!1;this.host._numLayoutCalls++,this._isDirty&&this._currentMeasure.transformToRef(this._transformMatrix,this._prevCurrentMeasureTransformedIntoGlobalSpace);let i=0;t.save(),this._applyStates(t),this._beforeLayout();do{let s=-1,r=-1;if(this._rebuildLayout=!1,this._processMeasures(e,t),!this._isClipped){for(const e of this._children)e._tempParentMeasure.copyFrom(this._measureForChildren),e._layout(this._measureForChildren,t)&&e.isVisible&&!e.notRenderable&&(this.adaptWidthToChildren&&e._width.isPixel&&(s=Math.max(s,e._currentMeasure.width+e._paddingLeftInPixels+e._paddingRightInPixels)),this.adaptHeightToChildren&&e._height.isPixel&&(r=Math.max(r,e._currentMeasure.height+e._paddingTopInPixels+e._paddingBottomInPixels)));this.adaptWidthToChildren&&s>=0&&(s+=this.paddingLeftInPixels+this.paddingRightInPixels,this.width!==s+"px"&&(this.parent?._markAsDirty(),this.width=s+"px",this._width.ignoreAdaptiveScaling=!0,this._rebuildLayout=!0)),this.adaptHeightToChildren&&r>=0&&(r+=this.paddingTopInPixels+this.paddingBottomInPixels,this.height!==r+"px"&&(this.parent?._markAsDirty(),this.height=r+"px",this._height.ignoreAdaptiveScaling=!0,this._rebuildLayout=!0)),this._postMeasure()}i++}while(this._rebuildLayout&&i<this.maxLayoutCycle);return i>=3&&this.logLayoutCycleErrors&&l.V.Error(`Layout cycle detected in GUI (Container name=${this.name}, uniqueId=${this.uniqueId})`),t.restore(),this._isDirty&&(this.invalidateRect(),this._isDirty=!1),!0}_postMeasure(){}_draw(e,t){const i=this._renderToIntermediateTexture&&this._intermediateTexture,s=i?this._intermediateTexture.getContext():e;i&&(s.save(),s.translate(-this._currentMeasure.left,-this._currentMeasure.top),t?(this._transformMatrix.invertToRef(this._inverseTransformMatrix),t.transformToRef(this._inverseTransformMatrix,this._inverseMeasure),s.clearRect(this._inverseMeasure.left,this._inverseMeasure.top,this._inverseMeasure.width,this._inverseMeasure.height)):s.clearRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),this._localDraw(s),e.save(),this.clipChildren&&this._clipForChildren(s);for(const e of this._children)t&&!e._intersectsRect(t)||e._render(s,t);i&&(s.restore(),e.save(),e.globalAlpha=this.alpha,e.drawImage(s.canvas,this._currentMeasure.left,this._currentMeasure.top),e.restore()),e.restore()}getDescendantsToRef(e,t=!1,i){if(this.children)for(let s=0;s<this.children.length;s++){const r=this.children[s];i&&!i(r)||e.push(r),t||r.getDescendantsToRef(e,!1,i)}}_processPicking(e,t,i,s,r,n,a,o){if(!this._isEnabled||!this.isVisible||this.notRenderable)return!1;const l=super.contains(e,t);if(!l&&this.clipChildren)return!1;if(this.delegatePickingToChildren){let i=!1;for(let s=this._children.length-1;s>=0;s--){const r=this._children[s];if(r.isEnabled&&r.isHitTestVisible&&r.isVisible&&!r.notRenderable&&r.contains(e,t)){i=!0;break}}if(!i)return!1}for(let l=this._children.length-1;l>=0;l--){const h=this._children[l];if(h._processPicking(e,t,i,s,r,n,a,o))return h.hoverCursor&&this._host._changeCursor(h.hoverCursor),!0}return!!l&&!!this.isHitTestVisible&&this._processObservables(s,e,t,i,r,n,a,o)}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.copyFrom(this._currentMeasure)}_getAdaptDimTo(e){return"width"===e?this.adaptWidthToChildren:this.adaptHeightToChildren}isDimensionFullyDefined(e){if(this._getAdaptDimTo(e)){for(const t of this.children)if(!t.isDimensionFullyDefined(e))return!1;return!0}return super.isDimensionFullyDefined(e)}serialize(e,t=!1,i=!0){if(super.serialize(e,t,i),(this.isSerializable||t)&&(this.backgroundGradient&&(e.backgroundGradient={},this.backgroundGradient.serialize(e.backgroundGradient)),this.children.length)){e.children=[];for(const s of this.children)if(s.isSerializable||t){const r={};s.serialize(r,t,i),e.children.push(r)}}}dispose(){super.dispose();for(let e=this.children.length-1;e>=0;e--)this.children[e].dispose();this._intermediateTexture?.dispose()}_parseFromContent(e,t,i){if(super._parseFromContent(e,t,i),this._link(t),e.backgroundGradient){const t=ee.S0.Instantiate("BABYLON.GUI."+e.backgroundGradient.className);this._backgroundGradient=new t,this._backgroundGradient?.parse(e.backgroundGradient)}if(e.children)for(const s of e.children)this.addControl(Xl.Parse(s,t,i))}isReady(){for(const e of this.children)if(!e.isReady())return!1;return!0}}(0,w.Cg)([(0,D.lK)()],Kl.prototype,"delegatePickingToChildren",void 0),(0,w.Cg)([(0,D.lK)()],Kl.prototype,"renderToIntermediateTexture",null),(0,w.Cg)([(0,D.lK)()],Kl.prototype,"maxLayoutCycle",void 0),(0,w.Cg)([(0,D.lK)()],Kl.prototype,"adaptHeightToChildren",null),(0,w.Cg)([(0,D.lK)()],Kl.prototype,"adaptWidthToChildren",null),(0,w.Cg)([(0,D.lK)()],Kl.prototype,"background",null),(0,w.Cg)([(0,D.lK)()],Kl.prototype,"backgroundGradient",null),(0,V.Y5)("BABYLON.GUI.Container",Kl);class Ql extends Kl{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get cornerRadius(){return this._cornerRadius[0]}set cornerRadius(e){e<0&&(e=0),this._cornerRadius[0]===e&&this._cornerRadius[1]===e&&this._cornerRadius[2]===e&&this._cornerRadius[3]===e||(this._cornerRadius[0]=this._cornerRadius[1]=this._cornerRadius[2]=this._cornerRadius[3]=e,this._markAsDirty())}get cornerRadiusX(){return this._cornerRadius[0]}set cornerRadiusX(e){this._cornerRadius[0]!==e&&(this._cornerRadius[0]=e)}get cornerRadiusY(){return this._cornerRadius[1]}set cornerRadiusY(e){this._cornerRadius[1]!==e&&(this._cornerRadius[1]=e)}get cornerRadiusZ(){return this._cornerRadius[2]}set cornerRadiusZ(e){this._cornerRadius[2]!==e&&(this._cornerRadius[2]=e)}get cornerRadiusW(){return this._cornerRadius[3]}set cornerRadiusW(e){this._cornerRadius[3]!==e&&(this._cornerRadius[3]=e)}constructor(e){super(e),this.name=e,this._thickness=1,this._cornerRadius=[0,0,0,0],this._cachedRadius=[0,0,0,0]}_getTypeName(){return"Rectangle"}_computeAdditionalOffsetX(){let e=0;return 0===this._cornerRadius[0]&&0===this._cornerRadius[1]&&0===this._cornerRadius[2]&&0===this._cornerRadius[3]||(e+=1),this.thickness&&(e+=this.thickness/2),e}_computeAdditionalOffsetY(){let e=0;return 0===this._cornerRadius[0]&&0===this._cornerRadius[1]&&0===this._cornerRadius[2]&&0===this._cornerRadius[3]||(e+=1),this.thickness&&(e+=this.thickness/2),e}_getRectangleFill(e){return this._getBackgroundColor(e)}_localDraw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),(this._background||this._backgroundGradient)&&(e.fillStyle=this._getRectangleFill(e),0!==this._cornerRadius[0]||0!==this._cornerRadius[1]||0!==this._cornerRadius[2]||0!==this._cornerRadius[3]?(this._drawRoundedRect(e,this._thickness/2),e.fill()):e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),this._thickness&&((this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),(this.color||this.gradient)&&(e.strokeStyle=this.gradient?this.gradient.getCanvasGradient(e):this.color),e.lineWidth=this._thickness,0!==this._cornerRadius[0]||0!==this._cornerRadius[1]||0!==this._cornerRadius[2]||0!==this._cornerRadius[3]?(this._drawRoundedRect(e,this._thickness/2),e.stroke()):e.strokeRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,this._currentMeasure.width-this._thickness,this._currentMeasure.height-this._thickness)),e.restore()}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.width-=2*this._thickness,this._measureForChildren.height-=2*this._thickness,this._measureForChildren.left+=this._thickness,this._measureForChildren.top+=this._thickness}_drawRoundedRect(e,t=0){const i=this._currentMeasure.left+t,s=this._currentMeasure.top+t,r=this._currentMeasure.width-2*t,n=this._currentMeasure.height-2*t;for(let e=0;e<this._cornerRadius.length;e++)this._cachedRadius[e]=Math.abs(Math.min(n/2,Math.min(r/2,this._cornerRadius[e])));e.beginPath(),e.moveTo(i+this._cachedRadius[0],s),e.lineTo(i+r-this._cachedRadius[1],s),e.arc(i+r-this._cachedRadius[1],s+this._cachedRadius[1],this._cachedRadius[1],3*Math.PI/2,2*Math.PI),e.lineTo(i+r,s+n-this._cachedRadius[2]),e.arc(i+r-this._cachedRadius[2],s+n-this._cachedRadius[2],this._cachedRadius[2],0,Math.PI/2),e.lineTo(i+this._cachedRadius[3],s+n),e.arc(i+this._cachedRadius[3],s+n-this._cachedRadius[3],this._cachedRadius[3],Math.PI/2,Math.PI),e.lineTo(i,s+this._cachedRadius[0]),e.arc(i+this._cachedRadius[0],s+this._cachedRadius[0],this._cachedRadius[0],Math.PI,3*Math.PI/2),e.closePath()}_clipForChildren(e){0===this._cornerRadius[0]&&0===this._cornerRadius[1]&&0===this._cornerRadius[2]&&0===this._cornerRadius[3]||(this._drawRoundedRect(e,this._thickness),e.clip())}}var Yl;(0,w.Cg)([(0,D.lK)()],Ql.prototype,"thickness",null),(0,w.Cg)([(0,D.lK)()],Ql.prototype,"cornerRadius",null),(0,w.Cg)([(0,D.lK)()],Ql.prototype,"cornerRadiusX",null),(0,w.Cg)([(0,D.lK)()],Ql.prototype,"cornerRadiusY",null),(0,w.Cg)([(0,D.lK)()],Ql.prototype,"cornerRadiusZ",null),(0,w.Cg)([(0,D.lK)()],Ql.prototype,"cornerRadiusW",null),(0,V.Y5)("BABYLON.GUI.Rectangle",Ql),function(e){e[e.Clip=0]="Clip",e[e.WordWrap=1]="WordWrap",e[e.Ellipsis=2]="Ellipsis",e[e.WordWrapEllipsis=3]="WordWrapEllipsis"}(Yl||(Yl={}));class ql extends Xl{get lines(){return this._lines}get resizeToFit(){return this._resizeToFit}set resizeToFit(e){this._resizeToFit!==e&&(this._resizeToFit=e,this._resizeToFit&&(this._width.ignoreAdaptiveScaling=!0,this._height.ignoreAdaptiveScaling=!0),this._markAsDirty())}get textWrapping(){return this._textWrapping}set textWrapping(e){this._textWrapping!==e&&(this._textWrapping=+e,this._markAsDirty())}get text(){return this._text}set text(e){this._text!==e&&(this._text=e+"",this._markAsDirty(),this.onTextChangedObservable.notifyObservers(this))}get textHorizontalAlignment(){return this._textHorizontalAlignment}set textHorizontalAlignment(e){this._textHorizontalAlignment!==e&&(this._textHorizontalAlignment=e,this._markAsDirty())}get textVerticalAlignment(){return this._textVerticalAlignment}set textVerticalAlignment(e){this._textVerticalAlignment!==e&&(this._textVerticalAlignment=e,this._markAsDirty())}set lineSpacing(e){this._lineSpacing.fromString(e)&&this._markAsDirty()}get lineSpacing(){return this._lineSpacing.toString(this._host)}get outlineWidth(){return this._outlineWidth}set outlineWidth(e){this._outlineWidth!==e&&(this._outlineWidth=e,this._markAsDirty())}get underline(){return this._underline}set underline(e){this._underline!==e&&(this._underline=e,this._markAsDirty())}get lineThrough(){return this._lineThrough}set lineThrough(e){this._lineThrough!==e&&(this._lineThrough=e,this._markAsDirty())}get applyOutlineToUnderline(){return this._applyOutlineToUnderline}set applyOutlineToUnderline(e){this._applyOutlineToUnderline!==e&&(this._applyOutlineToUnderline=e,this._markAsDirty())}get outlineColor(){return this._outlineColor}set outlineColor(e){this._outlineColor!==e&&(this._outlineColor=e,this._markAsDirty())}get wordDivider(){return this._wordDivider}set wordDivider(e){this._wordDivider!==e&&(this._wordDivider=e,this._markAsDirty())}get forceResizeWidth(){return this._forceResizeWidth}set forceResizeWidth(e){this._forceResizeWidth!==e&&(this._forceResizeWidth=e,this._markAsDirty())}constructor(e,t=""){super(e),this.name=e,this._text="",this._textWrapping=Yl.Clip,this._textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_CENTER,this._textVerticalAlignment=Xl.VERTICAL_ALIGNMENT_CENTER,this._resizeToFit=!1,this._lineSpacing=new Ll(0),this._outlineWidth=0,this._outlineColor="white",this._underline=!1,this._lineThrough=!1,this._wordDivider=" ",this._forceResizeWidth=!1,this._applyOutlineToUnderline=!1,this.onTextChangedObservable=new C.cP,this.onLinesReadyObservable=new C.cP,this._linesTemp=[],this.text=t}_getTypeName(){return"TextBlock"}_processMeasures(e,t){this._fontOffset&&!this.isDirty||(this._fontOffset=Xl._GetFontOffset(t.font,this._host.getScene()?.getEngine())),super._processMeasures(e,t),this._lines=this._breakLines(this._currentMeasure.width,this._currentMeasure.height,t),this.onLinesReadyObservable.notifyObservers(this);let i=0;for(let e=0;e<this._lines.length;e++){const t=this._lines[e];t.width>i&&(i=t.width)}if(this._resizeToFit){if(this._textWrapping===Yl.Clip||this._forceResizeWidth){const e=Math.ceil(this._paddingLeftInPixels)+Math.ceil(this._paddingRightInPixels)+Math.ceil(i);e!==this._width.getValueInPixel(this._host,this._tempParentMeasure.width)&&(this._width.updateInPlace(e,Ll.UNITMODE_PIXEL),this._rebuildLayout=!0)}let e=this._paddingTopInPixels+this._paddingBottomInPixels+this._fontOffset.height*this._lines.length|0;if(this._lines.length>0&&0!==this._lineSpacing.internalValue){let t=0;t=this._lineSpacing.isPixel?this._lineSpacing.getValue(this._host):this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height),e+=(this._lines.length-1)*t}e!==this._height.internalValue&&(this._height.updateInPlace(e,Ll.UNITMODE_PIXEL),this._rebuildLayout=!0)}}_drawText(e,t,i,s){const r=this._currentMeasure.width;let n=0;switch(this._textHorizontalAlignment){case Xl.HORIZONTAL_ALIGNMENT_LEFT:n=0;break;case Xl.HORIZONTAL_ALIGNMENT_RIGHT:n=r-t;break;case Xl.HORIZONTAL_ALIGNMENT_CENTER:n=(r-t)/2}(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(s.shadowColor=this.shadowColor,s.shadowBlur=this.shadowBlur,s.shadowOffsetX=this.shadowOffsetX,s.shadowOffsetY=this.shadowOffsetY),this.outlineWidth&&s.strokeText(e,this._currentMeasure.left+n,i),s.fillText(e,this._currentMeasure.left+n,i),this._underline&&this._drawLine(this._currentMeasure.left+n,i+3,this._currentMeasure.left+n+t,i+3,s),this._lineThrough&&this._drawLine(this._currentMeasure.left+n,i-this.fontSizeInPixels/3,this._currentMeasure.left+n+t,i-this.fontSizeInPixels/3,s)}_drawLine(e,t,i,s,r){if(r.beginPath(),r.lineWidth=Math.round(.05*this.fontSizeInPixels),r.moveTo(e,t),r.lineTo(i,s),this.outlineWidth&&this.applyOutlineToUnderline)r.stroke(),r.fill();else{const e=r.strokeStyle;r.strokeStyle=r.fillStyle,r.stroke(),r.strokeStyle=e}r.closePath()}_draw(e){e.save(),this._applyStates(e),this._renderLines(e),e.restore()}_applyStates(e){super._applyStates(e),this.outlineWidth&&(e.lineWidth=this.outlineWidth,e.strokeStyle=this.outlineColor,e.lineJoin="miter",e.miterLimit=2)}_breakLines(e,t,i){this._linesTemp.length=0;const s=this.text.split("\n");if(this._textWrapping===Yl.Ellipsis)for(const t of s)this._linesTemp.push(this._parseLineEllipsis(t,e,i));else if(this._textWrapping===Yl.WordWrap)for(const t of s)this._linesTemp.push(...this._parseLineWordWrap(t,e,i));else if(this._textWrapping===Yl.WordWrapEllipsis)for(const r of s)this._linesTemp.push(...this._parseLineWordWrapEllipsis(r,e,t,i));else for(const e of s)this._linesTemp.push(this._parseLine(e,i));return this._linesTemp}_parseLine(e="",t){return{text:e,width:this._getTextMetricsWidth(t.measureText(e))}}_getCharsToRemove(e,t,i){const s=e>t?e-t:0,r=e/i;return Math.max(Math.floor(s/r),1)}_parseLineEllipsis(e="",t,i){let s=this._getTextMetricsWidth(i.measureText(e)),r=this._getCharsToRemove(s,t,e.length);const n=Array.from&&Array.from(e);if(n)for(;n.length&&s>t;)n.splice(n.length-r,r),e=`${n.join("")}…`,s=this._getTextMetricsWidth(i.measureText(e)),r=this._getCharsToRemove(s,t,e.length);else{for(;e.length>2&&s>t;)e=e.slice(0,-r),s=this._getTextMetricsWidth(i.measureText(e+"…")),r=this._getCharsToRemove(s,t,e.length);e+="…"}return{text:e,width:s}}_getTextMetricsWidth(e){return void 0!==e.actualBoundingBoxLeft?Math.abs(e.actualBoundingBoxLeft)+Math.abs(e.actualBoundingBoxRight):e.width}_parseLineWordWrap(e="",t,i){const s=[],r=this.wordSplittingFunction?this.wordSplittingFunction(e):e.split(this._wordDivider);let n=this._getTextMetricsWidth(i.measureText(e));for(let a=0;a<r.length;a++){const o=a>0?e+this._wordDivider+r[a]:r[0],l=this._getTextMetricsWidth(i.measureText(o));l>t&&a>0?(s.push({text:e,width:n}),e=r[a],n=this._getTextMetricsWidth(i.measureText(e))):(n=l,e=o)}return s.push({text:e,width:n}),s}_parseLineWordWrapEllipsis(e="",t,i,s){const r=this._parseLineWordWrap(e,t,s);for(let e=1;e<=r.length;e++)if(this._computeHeightForLinesOf(e)>i&&e>1){const i=r[e-2],n=r[e-1];r[e-2]=this._parseLineEllipsis(i.text+this._wordDivider+n.text,t,s);const a=r.length-e+1;for(let e=0;e<a;e++)r.pop();return r}return r}_renderLines(e){if(!this._fontOffset||!this._lines)return;const t=this._currentMeasure.height;let i=0;switch(this._textVerticalAlignment){case Xl.VERTICAL_ALIGNMENT_TOP:i=this._fontOffset.ascent;break;case Xl.VERTICAL_ALIGNMENT_BOTTOM:i=t-this._fontOffset.height*(this._lines.length-1)-this._fontOffset.descent;break;case Xl.VERTICAL_ALIGNMENT_CENTER:i=this._fontOffset.ascent+(t-this._fontOffset.height*this._lines.length)/2}i+=this._currentMeasure.top;for(let t=0;t<this._lines.length;t++){const s=this._lines[t];0!==t&&0!==this._lineSpacing.internalValue&&(this._lineSpacing.isPixel?i+=this._lineSpacing.getValue(this._host):i+=this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height)),this._drawText(s.text,s.width,i,e),i+=this._fontOffset.height}}_computeHeightForLinesOf(e){let t=this._paddingTopInPixels+this._paddingBottomInPixels+this._fontOffset.height*e;if(e>0&&0!==this._lineSpacing.internalValue){let i=0;i=this._lineSpacing.isPixel?this._lineSpacing.getValue(this._host):this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height),t+=(e-1)*i}return t}isDimensionFullyDefined(e){return!!this.resizeToFit||super.isDimensionFullyDefined(e)}computeExpectedHeight(){if(this.text&&this.widthInPixels){const e=t.q.LastCreatedEngine?.createCanvas(0,0).getContext("2d");if(e){this._applyStates(e),this._fontOffset||(this._fontOffset=Xl._GetFontOffset(e.font,this._host.getScene()?.getEngine()));const t=this._lines?this._lines:this._breakLines(this.widthInPixels-this._paddingLeftInPixels-this._paddingRightInPixels,this.heightInPixels-this._paddingTopInPixels-this._paddingBottomInPixels,e);return this._computeHeightForLinesOf(t.length)}}return 0}dispose(){super.dispose(),this.onTextChangedObservable.clear()}}(0,w.Cg)([(0,D.lK)()],ql.prototype,"resizeToFit",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"textWrapping",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"text",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"textHorizontalAlignment",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"textVerticalAlignment",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"lineSpacing",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"outlineWidth",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"underline",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"lineThrough",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"applyOutlineToUnderline",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"outlineColor",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"wordDivider",null),(0,w.Cg)([(0,D.lK)()],ql.prototype,"forceResizeWidth",null),(0,V.Y5)("BABYLON.GUI.TextBlock",ql);class $l extends Xl{get isLoaded(){return this._loaded}isReady(){return this.isLoaded}get detectPointerOnOpaqueOnly(){return this._detectPointerOnOpaqueOnly}set detectPointerOnOpaqueOnly(e){this._detectPointerOnOpaqueOnly!==e&&(this._detectPointerOnOpaqueOnly=e)}get sliceLeft(){return this._sliceLeft}set sliceLeft(e){this._sliceLeft!==e&&(this._sliceLeft=e,this._markAsDirty())}get sliceRight(){return this._sliceRight}set sliceRight(e){this._sliceRight!==e&&(this._sliceRight=e,this._markAsDirty())}get sliceTop(){return this._sliceTop}set sliceTop(e){this._sliceTop!==e&&(this._sliceTop=e,this._markAsDirty())}get sliceBottom(){return this._sliceBottom}set sliceBottom(e){this._sliceBottom!==e&&(this._sliceBottom=e,this._markAsDirty())}get sourceLeft(){return this._sourceLeft}set sourceLeft(e){this._sourceLeft!==e&&(this._sourceLeft=e,this._markAsDirty())}get sourceTop(){return this._sourceTop}set sourceTop(e){this._sourceTop!==e&&(this._sourceTop=e,this._markAsDirty())}get sourceWidth(){return this._sourceWidth}set sourceWidth(e){this._sourceWidth!==e&&(this._sourceWidth=e,this._markAsDirty())}get sourceHeight(){return this._sourceHeight}set sourceHeight(e){this._sourceHeight!==e&&(this._sourceHeight=e,this._markAsDirty())}get imageWidth(){return this._imageWidth}get imageHeight(){return this._imageHeight}get populateNinePatchSlicesFromImage(){return this._populateNinePatchSlicesFromImage}set populateNinePatchSlicesFromImage(e){this._populateNinePatchSlicesFromImage!==e&&(this._populateNinePatchSlicesFromImage=e,this._populateNinePatchSlicesFromImage&&this._loaded&&this._extractNinePatchSliceDataFromImage())}get isSVG(){return this._isSVG}get svgAttributesComputationCompleted(){return this._svgAttributesComputationCompleted}get autoScale(){return this._autoScale}set autoScale(e){this._autoScale!==e&&(this._autoScale=e,e&&this._loaded&&this.synchronizeSizeWithContent())}get stretch(){return this._stretch}set stretch(e){this._stretch!==e&&(this._stretch=e,this._markAsDirty())}_rotate90(e,i=!1){const s=this._domImage.width,r=this._domImage.height,n=this._host?.getScene()?.getEngine()||t.q.LastCreatedEngine;if(!n)throw new Error("Invalid engine. Unable to create a canvas.");const a=n.createCanvas(r,s),o=a.getContext("2d");o.translate(a.width/2,a.height/2),o.rotate(e*Math.PI/2),o.drawImage(this._domImage,0,0,s,r,-s/2,-r/2,s,r);const l=a.toDataURL("image/jpg"),h=new $l(this.name+"rotated",l);return i&&(h._stretch=this._stretch,h._autoScale=this._autoScale,h._cellId=this._cellId,h._cellWidth=e%1?this._cellHeight:this._cellWidth,h._cellHeight=e%1?this._cellWidth:this._cellHeight),this._handleRotationForSVGImage(this,h,e),this._imageDataCache.data=null,h}_handleRotationForSVGImage(e,t,i){e._isSVG&&(e._svgAttributesComputationCompleted?(this._rotate90SourceProperties(e,t,i),this._markAsDirty()):e.onSVGAttributesComputedObservable.addOnce((()=>{this._rotate90SourceProperties(e,t,i),this._markAsDirty()})))}_rotate90SourceProperties(e,t,i){let s=e.sourceLeft,r=e.sourceTop,n=e.domImage.width,a=e.domImage.height,o=s,l=r,h=e.sourceWidth,c=e.sourceHeight;if(0!=i){const e=i<0?-1:1;i%=4;for(let t=0;t<Math.abs(i);++t)o=-(r-a/2)*e+a/2,l=(s-n/2)*e+n/2,[h,c]=[c,h],i<0?l-=c:o-=h,s=o,r=l,[n,a]=[a,n]}t.sourceLeft=o,t.sourceTop=l,t.sourceWidth=h,t.sourceHeight=c}_extractNinePatchSliceDataFromImage(){const e=this._domImage.width,i=this._domImage.height;if(!this._workingCanvas){const s=this._host?.getScene()?.getEngine()||t.q.LastCreatedEngine;if(!s)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=s.createCanvas(e,i)}const s=this._workingCanvas.getContext("2d");s.drawImage(this._domImage,0,0,e,i);const r=s.getImageData(0,0,e,i);this._sliceLeft=-1,this._sliceRight=-1;for(let t=0;t<e;t++){const e=r.data[4*t+3];if(e>127&&-1===this._sliceLeft)this._sliceLeft=t;else if(e<127&&this._sliceLeft>-1){this._sliceRight=t;break}}this._sliceTop=-1,this._sliceBottom=-1;for(let t=0;t<i;t++){const i=r.data[t*e*4+3];if(i>127&&-1===this._sliceTop)this._sliceTop=t;else if(i<127&&this._sliceTop>-1){this._sliceBottom=t;break}}}set domImage(e){this._domImage=e,this._loaded=!1,this._imageDataCache.data=null,this._domImage.width?this._onImageLoaded():this._domImage.onload=()=>{this._onImageLoaded()}}get domImage(){return this._domImage}_onImageLoaded(){this._imageDataCache.data=null,this._imageWidth=this._domImage.width,this._imageHeight=this._domImage.height,this._loaded=!0,this._populateNinePatchSlicesFromImage&&this._extractNinePatchSliceDataFromImage(),this._autoScale&&this.synchronizeSizeWithContent(),this.onImageLoadedObservable.notifyObservers(this),this._markAsDirty()}get source(){return this._source}static ResetImageCache(){$l.SourceImgCache.clear()}_removeCacheUsage(e){const t=e&&$l.SourceImgCache.get(e);if(t){t.timesUsed-=1;const i=t.img;i.parentNode&&i.parentNode.removeChild(i),0===t.timesUsed&&$l.SourceImgCache.delete(e)}}set source(e){if(this._urlRewriter&&e&&(e=this._urlRewriter(e)),this._source===e)return;this._removeCacheUsage(this._source),this._loaded=!1,this._source=e,this._imageDataCache.data=null,e&&(e=this._svgCheck(e));const i=this._host?.getScene()?.getEngine()||t.q.LastCreatedEngine;if(!i)throw new Error("Invalid engine. Unable to create a canvas.");if(e&&$l.SourceImgCache.has(e)){const t=$l.SourceImgCache.get(e);return this._domImage=t.img,t.timesUsed+=1,void(t.loaded?this._onImageLoaded():t.waitingForLoadCallback.push(this._onImageLoaded.bind(this)))}this._domImage=i.createCanvasImage();const s=this._domImage;s.style&&(s.style.visibility="hidden",s.style.position="absolute",i.getRenderingCanvas()?.parentNode?.appendChild(s)),e&&$l.SourceImgCache.set(e,{img:this._domImage,timesUsed:1,loaded:!1,waitingForLoadCallback:[this._onImageLoaded.bind(this)]}),this._domImage.onload=()=>{if(e){const t=$l.SourceImgCache.get(e);if(t){t.loaded=!0;for(const e of t.waitingForLoadCallback)e();return void(t.waitingForLoadCallback.length=0)}}this._onImageLoaded()},e&&(ee.S0.SetCorsBehavior(e,this._domImage),ee.S0.SetReferrerPolicyBehavior(this.referrerPolicy,this._domImage),this._domImage.src=e)}_svgCheck(e){if(window.SVGSVGElement&&-1!==e.search(/.svg#/gi)&&e.indexOf("#")===e.lastIndexOf("#")){this._isSVG=!0;const t=e.split("#")[0],i=e.split("#")[1],s=document.body.querySelector('object[data="'+t+'"]');if(s){const t=s.contentDocument;if(t&&t.documentElement){const r=t.documentElement.getAttribute("viewBox"),n=Number(t.documentElement.getAttribute("width")),a=Number(t.documentElement.getAttribute("height"));if(t.getElementById(i)&&r&&n&&a)return this._getSVGAttribs(s,i),e}s.addEventListener("load",(()=>{this._getSVGAttribs(s,i)}))}else{const e=document.createElement("object");e.data=t,e.type="image/svg+xml",e.width="0%",e.height="0%",document.body.appendChild(e),e.onload=()=>{const e=document.body.querySelector('object[data="'+t+'"]');e&&this._getSVGAttribs(e,i)}}return t}return e}_getSVGAttribs(e,t){const i=e.contentDocument;if(i&&i.documentElement){const e=i.documentElement.getAttribute("viewBox"),s=Number(i.documentElement.getAttribute("width")),r=Number(i.documentElement.getAttribute("height")),n=i.getElementById(t);if(e&&s&&r&&n){const t=Number(e.split(" ")[2]),i=Number(e.split(" ")[3]),a=n.getBBox();let o=1,l=1,h=0,c=0;const u=n.transform.baseVal.consolidate().matrix;n.transform&&n.transform.baseVal.consolidate()&&(o=u.a,l=u.d,h=u.e,c=u.f),this.sourceLeft=(o*a.x+h)*s/t,this.sourceTop=(l*a.y+c)*r/i,this.sourceWidth=a.width*o*(s/t),this.sourceHeight=a.height*l*(r/i),this._svgAttributesComputationCompleted=!0,this.onSVGAttributesComputedObservable.notifyObservers(this)}}}get cellWidth(){return this._cellWidth}set cellWidth(e){this._cellWidth!==e&&(this._cellWidth=e,this._markAsDirty())}get cellHeight(){return this._cellHeight}set cellHeight(e){this._cellHeight!==e&&(this._cellHeight=e,this._markAsDirty())}get cellId(){return this._cellId}set cellId(e){this._cellId!==e&&(this._cellId=e,this._markAsDirty())}constructor(e,t=null){super(e),this.name=e,this._workingCanvas=null,this._loaded=!1,this._stretch=$l.STRETCH_FILL,this._autoScale=!1,this._sourceLeft=0,this._sourceTop=0,this._sourceWidth=0,this._sourceHeight=0,this._svgAttributesComputationCompleted=!1,this._isSVG=!1,this._cellWidth=0,this._cellHeight=0,this._cellId=-1,this._populateNinePatchSlicesFromImage=!1,this._imageDataCache={data:null,key:""},this.onImageLoadedObservable=new C.cP,this.onSVGAttributesComputedObservable=new C.cP,this.source=t}contains(e,t){if(!super.contains(e,t))return!1;if(!this._detectPointerOnOpaqueOnly||!this._workingCanvas)return!0;const i=0|this._currentMeasure.width,s=0|this._currentMeasure.height,r=i+"_"+s;let n=this._imageDataCache.data;if(!n||this._imageDataCache.key!==r){const e=this._workingCanvas.getContext("2d");this._imageDataCache.data=n=e.getImageData(0,0,i,s).data,this._imageDataCache.key=r}return n[4*((e=e-this._currentMeasure.left|0)+(t=t-this._currentMeasure.top|0)*i)+3]>0}_getTypeName(){return"Image"}synchronizeSizeWithContent(){this._loaded&&(this.width=this._domImage.width+"px",this.height=this._domImage.height+"px")}_processMeasures(e,t){if(this._loaded)switch(this._stretch){case $l.STRETCH_NONE:case $l.STRETCH_FILL:case $l.STRETCH_UNIFORM:case $l.STRETCH_NINE_PATCH:break;case $l.STRETCH_EXTEND:this._autoScale&&this.synchronizeSizeWithContent(),this.parent&&this.parent.parent&&(this.parent.adaptWidthToChildren=!0,this.parent.adaptHeightToChildren=!0)}super._processMeasures(e,t)}_prepareWorkingCanvasForOpaqueDetection(){if(!this._detectPointerOnOpaqueOnly)return;const e=this._currentMeasure.width,i=this._currentMeasure.height;if(!this._workingCanvas){const s=this._host?.getScene()?.getEngine()||t.q.LastCreatedEngine;if(!s)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=s.createCanvas(e,i)}this._workingCanvas.getContext("2d").clearRect(0,0,e,i)}_drawImage(e,t,i,s,r,n,a,o,l){if(e.drawImage(this._domImage,t,i,s,r,n,a,o,l),!this._detectPointerOnOpaqueOnly)return;const h=e.getTransform(),c=this._workingCanvas.getContext("2d");c.save();const u=n-this._currentMeasure.left,d=a-this._currentMeasure.top;c.setTransform(h.a,h.b,h.c,h.d,(u+o)/2,(d+l)/2),c.translate(-(u+o)/2,-(d+l)/2),c.drawImage(this._domImage,t,i,s,r,u,d,o,l),c.restore()}_draw(e){let t,i,s,r;if(e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),-1==this.cellId)t=this._sourceLeft,i=this._sourceTop,s=this._sourceWidth?this._sourceWidth:this._imageWidth,r=this._sourceHeight?this._sourceHeight:this._imageHeight;else{const e=this._domImage.naturalWidth/this.cellWidth,n=this.cellId/e|0,a=this.cellId%e;t=this.cellWidth*a,i=this.cellHeight*n,s=this.cellWidth,r=this.cellHeight}if(this._prepareWorkingCanvasForOpaqueDetection(),this._applyStates(e),this._loaded)switch(this._stretch){case $l.STRETCH_NONE:case $l.STRETCH_FILL:this._drawImage(e,t,i,s,r,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height);break;case $l.STRETCH_UNIFORM:{const n=this._currentMeasure.width/s,a=this._currentMeasure.height/r,o=Math.min(n,a),l=(this._currentMeasure.width-s*o)/2,h=(this._currentMeasure.height-r*o)/2;this._drawImage(e,t,i,s,r,this._currentMeasure.left+l,this._currentMeasure.top+h,s*o,r*o);break}case $l.STRETCH_EXTEND:this._drawImage(e,t,i,s,r,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height);break;case $l.STRETCH_NINE_PATCH:this._renderNinePatch(e,t,i,s,r)}e.restore()}_renderNinePatch(e,t,i,s,r){const n=this.host.idealWidth?this._width.getValue(this.host)/this.host.idealWidth:this.host.idealHeight?this._height.getValue(this.host)/this.host.idealHeight:1,a=this._sliceLeft,o=this._sliceTop,l=r-this._sliceBottom,h=s-this._sliceRight,c=this._sliceRight-this._sliceLeft,u=this._sliceBottom-this._sliceTop,d=Math.round(a*n),_=Math.round(o*n),p=Math.round(l*n),f=Math.round(h*n),m=Math.round(this._currentMeasure.width)-f-d+2,g=Math.round(this._currentMeasure.height)-p-_+2,v=Math.round(this._currentMeasure.left)+d-1,b=Math.round(this._currentMeasure.top)+_-1,x=Math.round(this._currentMeasure.left+this._currentMeasure.width)-f,S=Math.round(this._currentMeasure.top+this._currentMeasure.height)-p;this._drawImage(e,t,i,a,o,this._currentMeasure.left,this._currentMeasure.top,d,_),this._drawImage(e,t+this._sliceLeft,i,c,o,v+1,this._currentMeasure.top,m-2,_),this._drawImage(e,t+this._sliceRight,i,h,o,x,this._currentMeasure.top,f,_),this._drawImage(e,t,i+this._sliceTop,a,u,this._currentMeasure.left,b+1,d,g-2),this._drawImage(e,t+this._sliceLeft,i+this._sliceTop,c,u,v+1,b+1,m-2,g-2),this._drawImage(e,t+this._sliceRight,i+this._sliceTop,h,u,x,b+1,f,g-2),this._drawImage(e,t,i+this._sliceBottom,a,l,this._currentMeasure.left,S,d,p),this._drawImage(e,t+this.sliceLeft,i+this._sliceBottom,c,l,v+1,S,m-2,p),this._drawImage(e,t+this._sliceRight,i+this._sliceBottom,h,l,x,S,f,p)}dispose(){super.dispose(),this.onImageLoadedObservable.clear(),this.onSVGAttributesComputedObservable.clear(),this._removeCacheUsage(this._source)}}$l.SourceImgCache=new Map,$l.STRETCH_NONE=0,$l.STRETCH_FILL=1,$l.STRETCH_UNIFORM=2,$l.STRETCH_EXTEND=3,$l.STRETCH_NINE_PATCH=4,(0,w.Cg)([(0,D.lK)()],$l.prototype,"detectPointerOnOpaqueOnly",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"sliceLeft",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"sliceRight",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"sliceTop",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"sliceBottom",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"sourceLeft",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"sourceTop",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"sourceWidth",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"sourceHeight",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"populateNinePatchSlicesFromImage",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"autoScale",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"stretch",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"source",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"cellWidth",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"cellHeight",null),(0,w.Cg)([(0,D.lK)()],$l.prototype,"cellId",null),(0,V.Y5)("BABYLON.GUI.Image",$l);class jl extends Ql{get image(){return this._image}get textBlock(){return this._textBlock}constructor(e){super(e),this.name=e,this.thickness=1,this.isPointerBlocker=!0;let t=null;this.pointerEnterAnimation=()=>{t=this.alpha,this.alpha-=.1},this.pointerOutAnimation=()=>{null!==t&&(this.alpha=t)},this.pointerDownAnimation=()=>{this.scaleX-=.05,this.scaleY-=.05},this.pointerUpAnimation=()=>{this.scaleX+=.05,this.scaleY+=.05}}_getTypeName(){return"Button"}_processPicking(e,t,i,s,r,n,a,o){if(!this._isEnabled||!this.isHitTestVisible||!this.isVisible||this.notRenderable)return!1;if(!super.contains(e,t))return!1;if(this.delegatePickingToChildren){let i=!1;for(let s=this._children.length-1;s>=0;s--){const r=this._children[s];if(r.isEnabled&&r.isHitTestVisible&&r.isVisible&&!r.notRenderable&&r.contains(e,t)){i=!0;break}}if(!i)return!1}return this._processObservables(s,e,t,i,r,n,a,o),!0}_onPointerEnter(e,t){return!!super._onPointerEnter(e,t)&&(!this.isReadOnly&&this.pointerEnterAnimation&&this.pointerEnterAnimation(),!0)}_onPointerOut(e,t,i=!1){!this.isReadOnly&&this.pointerOutAnimation&&this.pointerOutAnimation(),super._onPointerOut(e,t,i)}_onPointerDown(e,t,i,s,r){return!!super._onPointerDown(e,t,i,s,r)&&(!this.isReadOnly&&this.pointerDownAnimation&&this.pointerDownAnimation(),!0)}_getRectangleFill(e){return this.isEnabled?this._getBackgroundColor(e):this._disabledColor}_onPointerUp(e,t,i,s,r,n){!this.isReadOnly&&this.pointerUpAnimation&&this.pointerUpAnimation(),super._onPointerUp(e,t,i,s,r,n)}serialize(e,t){super.serialize(e,t),(this.isSerializable||t)&&(this._textBlock&&(e.textBlockName=this._textBlock.name),this._image&&(e.imageName=this._image.name))}_parseFromContent(e,t){super._parseFromContent(e,t),e.textBlockName&&(this._textBlock=this.getChildByName(e.textBlockName)),e.imageName&&(this._image=this.getChildByName(e.imageName))}static CreateImageButton(e,t,i){const s=new this(e),r=new ql(e+"_button",t);r.textWrapping=!0,r.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_CENTER,r.paddingLeft="20%",s.addControl(r);const n=new $l(e+"_icon",i);return n.width="20%",n.stretch=$l.STRETCH_UNIFORM,n.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,s.addControl(n),s._image=n,s._textBlock=r,s}static CreateImageOnlyButton(e,t){const i=new this(e),s=new $l(e+"_icon",t);return s.stretch=$l.STRETCH_FILL,s.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,i.addControl(s),i._image=s,i}static CreateSimpleButton(e,t){const i=new this(e),s=new ql(e+"_button",t);return s.textWrapping=!0,s.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_CENTER,i.addControl(s),i._textBlock=s,i}static CreateImageWithCenterTextButton(e,t,i){const s=new this(e),r=new $l(e+"_icon",i);r.stretch=$l.STRETCH_FILL,s.addControl(r);const n=new ql(e+"_button",t);return n.textWrapping=!0,n.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_CENTER,s.addControl(n),s._image=r,s._textBlock=n,s}}(0,V.Y5)("BABYLON.GUI.Button",jl);class Zl extends Kl{get isVertical(){return this._isVertical}set isVertical(e){this._isVertical!==e&&(this._isVertical=e,this._markAsDirty())}get spacing(){return this._spacing}set spacing(e){this._spacing!==e&&(this._spacing=e,this._markAsDirty())}set width(e){this._doNotTrackManualChanges||(this._manualWidth=!0),this._width.toString(this._host)!==e&&this._width.fromString(e)&&this._markAsDirty()}get width(){return this._width.toString(this._host)}set height(e){this._doNotTrackManualChanges||(this._manualHeight=!0),this._height.toString(this._host)!==e&&this._height.fromString(e)&&this._markAsDirty()}get height(){return this._height.toString(this._host)}constructor(e){super(e),this.name=e,this._isVertical=!0,this._manualWidth=!1,this._manualHeight=!1,this._doNotTrackManualChanges=!1,this._spacing=0,this.ignoreLayoutWarnings=!1}_getTypeName(){return"StackPanel"}_preMeasure(e,t){for(const e of this._children)this._isVertical?e.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP:e.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT;super._preMeasure(e,t)}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.copyFrom(e),this._measureForChildren.left=this._currentMeasure.left,this._measureForChildren.top=this._currentMeasure.top,this.isVertical&&!this._manualWidth||(this._measureForChildren.width=this._currentMeasure.width),(this.isVertical||this._manualHeight)&&(this._measureForChildren.height=this._currentMeasure.height)}_postMeasure(){let e=0,t=0;const i=this._children.length;for(let s=0;s<i;s++){const r=this._children[s];r.isVisible&&!r.notRenderable&&(this._isVertical?(r.top!==t+"px"&&(r.top=t+"px",this._rebuildLayout=!0,r._top.ignoreAdaptiveScaling=!0),this.ignoreLayoutWarnings||r.isDimensionFullyDefined("height")?t+=r._currentMeasure.height+r._paddingTopInPixels+r._paddingBottomInPixels+(s<i-1?this._spacing:0):l.V.Warn(`Control (Name:${r.name}, UniqueId:${r.uniqueId}) is using height in percentage mode inside a vertical StackPanel`,1)):(r.left!==e+"px"&&(r.left=e+"px",this._rebuildLayout=!0,r._left.ignoreAdaptiveScaling=!0),this.ignoreLayoutWarnings||r.isDimensionFullyDefined("width")?e+=r._currentMeasure.width+r._paddingLeftInPixels+r._paddingRightInPixels+(s<i-1?this._spacing:0):l.V.Warn(`Control (Name:${r.name}, UniqueId:${r.uniqueId}) is using width in percentage mode inside a horizontal StackPanel`,1)))}e+=this._paddingLeftInPixels+this._paddingRightInPixels,t+=this._paddingTopInPixels+this._paddingBottomInPixels,this._doNotTrackManualChanges=!0;let s=!1,r=!1;if((!this._manualHeight||this.adaptHeightToChildren)&&this._isVertical){const e=this.height;this.height=t+"px",r=e!==this.height||!this._height.ignoreAdaptiveScaling}if((!this._manualWidth||this.adaptWidthToChildren)&&!this._isVertical){const t=this.width;this.width=e+"px",s=t!==this.width||!this._width.ignoreAdaptiveScaling}r&&(this._height.ignoreAdaptiveScaling=!0),s&&(this._width.ignoreAdaptiveScaling=!0),this._doNotTrackManualChanges=!1,(s||r)&&(this._rebuildLayout=!0),super._postMeasure()}_getManualDim(e){return"width"===e?this._manualWidth:this._manualHeight}isDimensionFullyDefined(e){if("height"===e?this.isVertical:!this.isVertical&&!this._getManualDim(e)){for(const t of this._children)if(!t.isDimensionFullyDefined(e))return!1;return!0}return this.getDimension(e).isPixel||this._getAdaptDimTo(e)}serialize(e,t){super.serialize(e,t),(this.isSerializable||t)&&(e.manualWidth=this._manualWidth,e.manualHeight=this._manualHeight)}_parseFromContent(e,t){this._manualWidth=e.manualWidth,this._manualHeight=e.manualHeight,super._parseFromContent(e,t)}}(0,w.Cg)([(0,D.lK)()],Zl.prototype,"ignoreLayoutWarnings",void 0),(0,w.Cg)([(0,D.lK)()],Zl.prototype,"isVertical",null),(0,w.Cg)([(0,D.lK)()],Zl.prototype,"spacing",null),(0,w.Cg)([(0,D.lK)()],Zl.prototype,"width",null),(0,w.Cg)([(0,D.lK)()],Zl.prototype,"height",null),(0,V.Y5)("BABYLON.GUI.StackPanel",Zl);class Jl extends Xl{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get checkSizeRatio(){return this._checkSizeRatio}set checkSizeRatio(e){e=Math.max(Math.min(1,e),0),this._checkSizeRatio!==e&&(this._checkSizeRatio=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get isChecked(){return this._isChecked}set isChecked(e){this._isChecked!==e&&(this._isChecked=e,this._markAsDirty(),this.onIsCheckedChangedObservable.notifyObservers(e))}constructor(e){super(e),this.name=e,this._isChecked=!1,this._background="black",this._checkSizeRatio=.8,this._thickness=1,this.onIsCheckedChangedObservable=new C.cP,this.isPointerBlocker=!0}_getTypeName(){return"Checkbox"}_draw(e){e.save(),this._applyStates(e);const t=this._currentMeasure.width-this._thickness,i=this._currentMeasure.height-this._thickness;if((this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),e.fillStyle=this._isEnabled?this._background:this._disabledColor,e.fillRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,t,i),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this._isChecked){e.fillStyle=this._isEnabled?this.color?this.color:"#ffffff":this._disabledColorItem;const s=t*this._checkSizeRatio,r=i*this._checkSizeRatio;e.fillRect(this._currentMeasure.left+this._thickness/2+(t-s)/2,this._currentMeasure.top+this._thickness/2+(i-r)/2,s,r)}e.strokeStyle=this.color,e.lineWidth=this._thickness,e.strokeRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,t,i),e.restore()}_onPointerDown(e,t,i,s,r){return!!super._onPointerDown(e,t,i,s,r)&&(this.isReadOnly||(this.isChecked=!this.isChecked),!0)}static AddCheckBoxWithHeader(e,t){const i=new Zl;i.isVertical=!1,i.height="30px";const s=new Jl;s.width="20px",s.height="20px",s.isChecked=!0,s.color="green",s.onIsCheckedChangedObservable.add(t),i.addControl(s);const r=new ql;return r.text=e,r.width="180px",r.paddingLeft="5px",r.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,r.color="white",i.addControl(r),i}}(0,w.Cg)([(0,D.lK)()],Jl.prototype,"thickness",null),(0,w.Cg)([(0,D.lK)()],Jl.prototype,"checkSizeRatio",null),(0,w.Cg)([(0,D.lK)()],Jl.prototype,"background",null),(0,w.Cg)([(0,D.lK)()],Jl.prototype,"isChecked",null),(0,V.Y5)("BABYLON.GUI.Checkbox",Jl);class eh{}eh.COPY=1,eh.CUT=2,eh.PASTE=3;class th{constructor(e,t){this.type=e,this.event=t}static GetTypeFromCharacter(e){switch(e){case 67:return eh.COPY;case 86:return eh.PASTE;case 88:return eh.CUT;default:return-1}}}class ih{get text(){return this._characters?this._characters.join(""):this._text}set text(e){this._text=e,this._characters=Array.from&&Array.from(e)}get length(){return this._characters?this._characters.length:this._text.length}removePart(e,t,i){if(this._text=this._text.slice(0,e)+(i||"")+this._text.slice(t),this._characters){const s=i?Array.from(i):[];this._characters.splice(e,t-e,...s)}}charAt(e){return this._characters?this._characters[e]:this._text.charAt(e)}substr(e,t){if(this._characters){e=isNaN(e)?0:e>=0?Math.min(e,this._characters.length):this._characters.length+Math.max(e,-this._characters.length),void 0===t?t=this._characters.length-e:(isNaN(t)||t<0)&&(t=0);const i=[];for(;--t>=0;)i[t]=this._characters[e+t];return i.join("")}return this._text.substr(e,t)}substring(e,t){if(this._characters){isNaN(e)?e=0:e>this._characters.length?e=this._characters.length:e<0&&(e=0),void 0===t?t=this._characters.length:isNaN(t)?t=0:t>this._characters.length?t=this._characters.length:t<0&&(t=0);const i=[];let s=0;for(;e<t;)i[s++]=this._characters[e++];return i.join("")}return this._text.substring(e,t)}isWord(e){const t=/\w/g;return this._characters?-1!==this._characters[e].search(t):-1!==this._text.search(t)}}class sh extends Xl{get outlineWidth(){return this._outlineWidth}set outlineWidth(e){this._outlineWidth!==e&&(this._outlineWidth=e,this._markAsDirty())}get outlineColor(){return this._outlineColor}set outlineColor(e){this._outlineColor!==e&&(this._outlineColor=e,this._markAsDirty())}get maxWidth(){return this._maxWidth.toString(this._host)}get maxWidthInPixels(){return this._maxWidth.getValueInPixel(this._host,this._cachedParentMeasure.width)}set maxWidth(e){this._maxWidth.toString(this._host)!==e&&this._maxWidth.fromString(e)&&this._markAsDirty()}get highligherOpacity(){return this._highligherOpacity}set highligherOpacity(e){this._highligherOpacity!==e&&(this._highligherOpacity=e,this._markAsDirty())}get onFocusSelectAll(){return this._onFocusSelectAll}set onFocusSelectAll(e){this._onFocusSelectAll!==e&&(this._onFocusSelectAll=e,this._markAsDirty())}get textHighlightColor(){return this._textHighlightColor}set textHighlightColor(e){this._textHighlightColor!==e&&(this._textHighlightColor=e,this._markAsDirty())}get margin(){return this._margin.toString(this._host)}get marginInPixels(){return this._margin.getValueInPixel(this._host,this._cachedParentMeasure.width)}set margin(e){this._margin.toString(this._host)!==e&&this._margin.fromString(e)&&this._markAsDirty()}get autoStretchWidth(){return this._autoStretchWidth}set autoStretchWidth(e){this._autoStretchWidth!==e&&(this._autoStretchWidth=e,this._markAsDirty())}get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get focusedBackground(){return this._focusedBackground}set focusedBackground(e){this._focusedBackground!==e&&(this._focusedBackground=e,this._markAsDirty())}get focusedColor(){return this._focusedColor}set focusedColor(e){this._focusedColor!==e&&(this._focusedColor=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get placeholderColor(){return this._placeholderColor}set placeholderColor(e){this._placeholderColor!==e&&(this._placeholderColor=e,this._markAsDirty())}get placeholderText(){return this._placeholderText}set placeholderText(e){this._placeholderText!==e&&(this._placeholderText=e,this._markAsDirty())}get deadKey(){return this._deadKey}set deadKey(e){this._deadKey=e}get highlightedText(){return this._highlightedText}set highlightedText(e){this._highlightedText!==e&&(this._highlightedText=e,this._markAsDirty())}get addKey(){return this._addKey}set addKey(e){this._addKey=e}get currentKey(){return this._currentKey}set currentKey(e){this._currentKey=e}get text(){return this._textWrapper.text}set text(e){const t=e.toString();this._textWrapper||(this._textWrapper=new ih),this._textWrapper.text!==t&&(this._textWrapper.text=t,this._textHasChanged())}_textHasChanged(){this._markAsDirty(),this.onTextChangedObservable.notifyObservers(this)}_applyStates(e){super._applyStates(e),this.outlineWidth&&(e.lineWidth=this.outlineWidth,e.strokeStyle=this.outlineColor)}get width(){return this._width.toString(this._host)}set width(e){(this._width.toString(this._host)!==e||this._autoStretchWidth)&&(this._width.fromString(e)&&this._markAsDirty(),this.autoStretchWidth=!1)}constructor(e,t=""){super(e),this.name=e,this._placeholderText="",this._background="#222222",this._focusedBackground="#000000",this._focusedColor="white",this._placeholderColor="gray",this._thickness=1,this._margin=new Ll(10,Ll.UNITMODE_PIXEL),this._autoStretchWidth=!0,this._maxWidth=new Ll(1,Ll.UNITMODE_PERCENTAGE,!1),this._isFocused=!1,this._blinkIsEven=!1,this._cursorOffset=0,this._deadKey=!1,this._addKey=!0,this._currentKey="",this._isTextHighlightOn=!1,this._textHighlightColor="#d5e0ff",this._highligherOpacity=.4,this._highlightedText="",this._startHighlightIndex=0,this._endHighlightIndex=0,this._cursorIndex=-1,this._outlineWidth=0,this._outlineColor="white",this._onFocusSelectAll=!1,this._isPointerDown=!1,this.promptMessage="Please enter text:",this.disableMobilePrompt=!1,this.onTextChangedObservable=new C.cP,this.onBeforeKeyAddObservable=new C.cP,this.onFocusObservable=new C.cP,this.onBlurObservable=new C.cP,this.onTextHighlightObservable=new C.cP,this.onTextCopyObservable=new C.cP,this.onTextCutObservable=new C.cP,this.onTextPasteObservable=new C.cP,this.onKeyboardEventProcessedObservable=new C.cP,this.text=t,this.isPointerBlocker=!0}onBlur(){this._isFocused=!1,this._scrollLeft=null,this._cursorOffset=0,clearTimeout(this._blinkTimeout),this._markAsDirty(),this.onBlurObservable.notifyObservers(this),this._host.unRegisterClipboardEvents(),this._onClipboardObserver&&this._host.onClipboardObservable.remove(this._onClipboardObserver);const e=this._host.getScene();this._onPointerDblTapObserver&&e&&e.onPointerObservable.remove(this._onPointerDblTapObserver)}onFocus(){if(!this._isEnabled)return;if(this._scrollLeft=null,this._isFocused=!0,this._blinkIsEven=!1,this._cursorOffset=0,this._markAsDirty(),this.onFocusObservable.notifyObservers(this),"touch"===this._focusedBy&&!this.disableMobilePrompt){const e=prompt(this.promptMessage);return null!==e&&(this.text=e),void(this._host.focusedControl=null)}this._host.registerClipboardEvents(),this._onClipboardObserver=this._host.onClipboardObservable.add((e=>{switch(e.type){case eh.COPY:this._onCopyText(e.event),this.onTextCopyObservable.notifyObservers(this);break;case eh.CUT:this._onCutText(e.event),this.onTextCutObservable.notifyObservers(this);break;case eh.PASTE:this._onPasteText(e.event),this.onTextPasteObservable.notifyObservers(this);break;default:return}}));const e=this._host.getScene();e&&(this._onPointerDblTapObserver=e.onPointerObservable.add((e=>{this._isFocused&&e.type===Rt.Zp.POINTERDOUBLETAP&&this._processDblClick(e)}))),this._onFocusSelectAll&&this._selectAllText()}focus(){this._host.moveFocusToControl(this)}blur(){this._host.focusedControl=null}_getTypeName(){return"InputText"}keepsFocusWith(){return this._connectedVirtualKeyboard?[this._connectedVirtualKeyboard]:null}processKey(e,t,i){if(!this.isReadOnly&&(!i||!i.ctrlKey&&!i.metaKey||67!==e&&86!==e&&88!==e)){if(i&&(i.ctrlKey||i.metaKey)&&65===e)return this._selectAllText(),void i.preventDefault();switch(e){case 32:t=" ";break;case 191:i&&i.preventDefault();break;case 8:if(this._textWrapper.text&&this._textWrapper.length>0){if(this.isTextHighlightOn)return this._textWrapper.removePart(this._startHighlightIndex,this._endHighlightIndex),this._textHasChanged(),this.isTextHighlightOn=!1,this._cursorOffset=this._textWrapper.length-this._startHighlightIndex,this._blinkIsEven=!1,void(i&&i.preventDefault());if(0===this._cursorOffset)this.text=this._textWrapper.substr(0,this._textWrapper.length-1);else{const e=this._textWrapper.length-this._cursorOffset;e>0&&(this._textWrapper.removePart(e-1,e),this._textHasChanged())}}return void(i&&i.preventDefault());case 46:if(this.isTextHighlightOn)return this._textWrapper.removePart(this._startHighlightIndex,this._endHighlightIndex),this._textHasChanged(),this.isTextHighlightOn=!1,this._cursorOffset=this._textWrapper.length-this._startHighlightIndex,void(i&&i.preventDefault());if(this._textWrapper.text&&this._textWrapper.length>0&&this._cursorOffset>0){const e=this._textWrapper.length-this._cursorOffset;this._textWrapper.removePart(e,e+1),this._textHasChanged(),this._cursorOffset--}return void(i&&i.preventDefault());case 13:return this._host.focusedControl=null,void(this.isTextHighlightOn=!1);case 35:return this._cursorOffset=0,this._blinkIsEven=!1,this.isTextHighlightOn=!1,void this._markAsDirty();case 36:return this._cursorOffset=this._textWrapper.length,this._blinkIsEven=!1,this.isTextHighlightOn=!1,void this._markAsDirty();case 37:if(this._cursorOffset++,this._cursorOffset>this._textWrapper.length&&(this._cursorOffset=this._textWrapper.length),i&&i.shiftKey){if(this._blinkIsEven=!1,i.ctrlKey||i.metaKey){if(!this.isTextHighlightOn){if(this._textWrapper.length===this._cursorOffset)return;this._endHighlightIndex=this._textWrapper.length-this._cursorOffset+1}return this._startHighlightIndex=0,this._cursorIndex=this._textWrapper.length-this._endHighlightIndex,this._cursorOffset=this._textWrapper.length,this.isTextHighlightOn=!0,void this._markAsDirty()}return this.isTextHighlightOn?-1===this._cursorIndex&&(this._cursorIndex=this._textWrapper.length-this._endHighlightIndex,this._cursorOffset=0===this._startHighlightIndex?this._textWrapper.length:this._textWrapper.length-this._startHighlightIndex+1):(this.isTextHighlightOn=!0,this._cursorIndex=this._cursorOffset>=this._textWrapper.length?this._textWrapper.length:this._cursorOffset-1),this._cursorIndex<this._cursorOffset?(this._endHighlightIndex=this._textWrapper.length-this._cursorIndex,this._startHighlightIndex=this._textWrapper.length-this._cursorOffset):this._cursorIndex>this._cursorOffset?(this._endHighlightIndex=this._textWrapper.length-this._cursorOffset,this._startHighlightIndex=this._textWrapper.length-this._cursorIndex):this.isTextHighlightOn=!1,void this._markAsDirty()}return this.isTextHighlightOn&&(this._cursorOffset=this._textWrapper.length-this._startHighlightIndex,this.isTextHighlightOn=!1),i&&(i.ctrlKey||i.metaKey)&&(this._cursorOffset=this._textWrapper.length,i.preventDefault()),this._blinkIsEven=!1,this.isTextHighlightOn=!1,this._cursorIndex=-1,void this._markAsDirty();case 39:if(this._cursorOffset--,this._cursorOffset<0&&(this._cursorOffset=0),i&&i.shiftKey){if(this._blinkIsEven=!1,i.ctrlKey||i.metaKey){if(!this.isTextHighlightOn){if(0===this._cursorOffset)return;this._startHighlightIndex=this._textWrapper.length-this._cursorOffset-1}return this._endHighlightIndex=this._textWrapper.length,this.isTextHighlightOn=!0,this._cursorIndex=this._textWrapper.length-this._startHighlightIndex,this._cursorOffset=0,void this._markAsDirty()}return this.isTextHighlightOn?-1===this._cursorIndex&&(this._cursorIndex=this._textWrapper.length-this._startHighlightIndex,this._cursorOffset=this._textWrapper.length===this._endHighlightIndex?0:this._textWrapper.length-this._endHighlightIndex-1):(this.isTextHighlightOn=!0,this._cursorIndex=this._cursorOffset<=0?0:this._cursorOffset+1),this._cursorIndex<this._cursorOffset?(this._endHighlightIndex=this._textWrapper.length-this._cursorIndex,this._startHighlightIndex=this._textWrapper.length-this._cursorOffset):this._cursorIndex>this._cursorOffset?(this._endHighlightIndex=this._textWrapper.length-this._cursorOffset,this._startHighlightIndex=this._textWrapper.length-this._cursorIndex):this.isTextHighlightOn=!1,void this._markAsDirty()}return this.isTextHighlightOn&&(this._cursorOffset=this._textWrapper.length-this._endHighlightIndex,this.isTextHighlightOn=!1),i&&(i.ctrlKey||i.metaKey)&&(this._cursorOffset=0,i.preventDefault()),this._blinkIsEven=!1,this.isTextHighlightOn=!1,this._cursorIndex=-1,void this._markAsDirty()}if(32===e&&(t=i?.key??" "),this._deadKey="Dead"===t,t&&(-1===e||32===e||34===e||39===e||e>47&&e<64||e>64&&e<91||e>159&&e<193||e>218&&e<223||e>95&&e<112)&&(this._currentKey=t,this.onBeforeKeyAddObservable.notifyObservers(this),t=this._currentKey,this._addKey&&!this._deadKey))if(this.isTextHighlightOn)this._textWrapper.removePart(this._startHighlightIndex,this._endHighlightIndex,t),this._textHasChanged(),this._cursorOffset=this._textWrapper.length-(this._startHighlightIndex+1),this.isTextHighlightOn=!1,this._blinkIsEven=!1,this._markAsDirty();else if(0===this._cursorOffset)this.text+=this._deadKey&&i?.key?i.key:t;else{const e=this._textWrapper.length-this._cursorOffset;this._textWrapper.removePart(e,e,t),this._textHasChanged()}}}_updateValueFromCursorIndex(e){if(this._blinkIsEven=!1,-1===this._cursorIndex)this._cursorIndex=e;else if(this._cursorIndex<this._cursorOffset)this._endHighlightIndex=this._textWrapper.length-this._cursorIndex,this._startHighlightIndex=this._textWrapper.length-this._cursorOffset;else{if(!(this._cursorIndex>this._cursorOffset))return this.isTextHighlightOn=!1,void this._markAsDirty();this._endHighlightIndex=this._textWrapper.length-this._cursorOffset,this._startHighlightIndex=this._textWrapper.length-this._cursorIndex}this.isTextHighlightOn=!0,this._markAsDirty()}_processDblClick(e){let t,i;this._startHighlightIndex=this._textWrapper.length-this._cursorOffset,this._endHighlightIndex=this._startHighlightIndex;do{i=this._endHighlightIndex<this._textWrapper.length&&this._textWrapper.isWord(this._endHighlightIndex)?++this._endHighlightIndex:0,t=this._startHighlightIndex>0&&this._textWrapper.isWord(this._startHighlightIndex-1)?--this._startHighlightIndex:0}while(t||i);this._cursorOffset=this._textWrapper.length-this._startHighlightIndex,this.isTextHighlightOn=!0,this._clickedCoordinate=null,this._blinkIsEven=!0,this._cursorIndex=-1,this._markAsDirty()}_selectAllText(){this._blinkIsEven=!0,this.isTextHighlightOn=!0,this._startHighlightIndex=0,this._endHighlightIndex=this._textWrapper.length,this._cursorOffset=this._textWrapper.length,this._cursorIndex=-1,this._markAsDirty()}processKeyboard(e){this.processKey(e.keyCode,e.key,e),this.onKeyboardEventProcessedObservable.notifyObservers(e)}_onCopyText(e){this.isTextHighlightOn=!1;try{e.clipboardData&&e.clipboardData.setData("text/plain",this._highlightedText)}catch{}this._host.clipboardData=this._highlightedText}_onCutText(e){if(this._highlightedText){this._textWrapper.removePart(this._startHighlightIndex,this._endHighlightIndex),this._textHasChanged(),this.isTextHighlightOn=!1,this._cursorOffset=this._textWrapper.length-this._startHighlightIndex;try{e.clipboardData&&e.clipboardData.setData("text/plain",this._highlightedText)}catch{}this._host.clipboardData=this._highlightedText,this._highlightedText=""}}_onPasteText(e){let t="";t=e.clipboardData&&-1!==e.clipboardData.types.indexOf("text/plain")?e.clipboardData.getData("text/plain"):this._host.clipboardData;const i=this._textWrapper.length-this._cursorOffset;this._textWrapper.removePart(i,i,t),this._textHasChanged()}_draw(e){e.save(),this._applyStates(e),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._isFocused?this._focusedBackground&&(e.fillStyle=this._isEnabled?this._focusedBackground:this._disabledColor,e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)):this._background&&(e.fillStyle=this._isEnabled?this._background:this._disabledColor,e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this._fontOffset&&!this._wasDirty||(this._fontOffset=Xl._GetFontOffset(e.font,this._host.getScene()?.getEngine()));const t=this._currentMeasure.left+this._margin.getValueInPixel(this._host,this._tempParentMeasure.width);this.color&&(e.fillStyle=this.color);let i=this._beforeRenderText(this._textWrapper);this._isFocused||this._textWrapper.text||!this._placeholderText||(i=new ih,i.text=this._placeholderText,this._placeholderColor&&(e.fillStyle=this._placeholderColor)),this._textWidth=e.measureText(i.text).width;const s=2*this._margin.getValueInPixel(this._host,this._tempParentMeasure.width);this._autoStretchWidth&&(this.width=Math.min(this._maxWidth.getValueInPixel(this._host,this._tempParentMeasure.width),this._textWidth+s)+"px",this._autoStretchWidth=!0);const r=this._fontOffset.ascent+(this._currentMeasure.height-this._fontOffset.height)/2,n=this._width.getValueInPixel(this._host,this._tempParentMeasure.width)-s;if(e.save(),e.beginPath(),e.rect(t,this._currentMeasure.top+(this._currentMeasure.height-this._fontOffset.height)/2,n+2,this._currentMeasure.height),e.clip(),this._isFocused&&this._textWidth>n){const e=t-this._textWidth+n;this._scrollLeft||(this._scrollLeft=e)}else this._scrollLeft=t;if(this.outlineWidth&&e.strokeText(i.text,this._scrollLeft,this._currentMeasure.top+r),e.fillText(i.text,this._scrollLeft,this._currentMeasure.top+r),this._isFocused){if(this._clickedCoordinate){const t=this._scrollLeft+this._textWidth-this._clickedCoordinate;let s=0;this._cursorOffset=0;let r=0;do{this._cursorOffset&&(r=Math.abs(t-s)),this._cursorOffset++,s=e.measureText(i.substr(i.length-this._cursorOffset,this._cursorOffset)).width}while(s<t&&i.length>=this._cursorOffset);Math.abs(t-s)>r&&this._cursorOffset--,this._blinkIsEven=!1,this._clickedCoordinate=null}if(!this._blinkIsEven){const s=i.substr(i.length-this._cursorOffset),r=e.measureText(s).width;let a=this._scrollLeft+this._textWidth-r;a<t?(this._scrollLeft+=t-a,a=t,this._markAsDirty()):a>t+n&&(this._scrollLeft+=t+n-a,a=t+n,this._markAsDirty()),this.isTextHighlightOn||e.fillRect(a,this._currentMeasure.top+(this._currentMeasure.height-this._fontOffset.height)/2,2,this._fontOffset.height)}if(clearTimeout(this._blinkTimeout),this._blinkTimeout=setTimeout((()=>{this._blinkIsEven=!this._blinkIsEven,this._markAsDirty()}),500),this.isTextHighlightOn){clearTimeout(this._blinkTimeout);const s=e.measureText(i.substring(this._startHighlightIndex)).width;let r=this._scrollLeft+this._textWidth-s;this._highlightedText=i.substring(this._startHighlightIndex,this._endHighlightIndex);let n=e.measureText(i.substring(this._startHighlightIndex,this._endHighlightIndex)).width;r<t&&(n-=t-r,n||(n=e.measureText(i.charAt(i.length-this._cursorOffset)).width),r=t),e.globalAlpha=this._highligherOpacity,e.fillStyle=this._textHighlightColor,e.fillRect(r,this._currentMeasure.top+(this._currentMeasure.height-this._fontOffset.height)/2,n,this._fontOffset.height),e.globalAlpha=1}}e.restore(),this._thickness&&(this._isFocused?this.focusedColor&&(e.strokeStyle=this.focusedColor):this.color&&(e.strokeStyle=this.color),e.lineWidth=this._thickness,e.strokeRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,this._currentMeasure.width-this._thickness,this._currentMeasure.height-this._thickness)),e.restore()}_onPointerDown(e,t,i,s,r){return!(!super._onPointerDown(e,t,i,s,r)||!this.isReadOnly&&(this._clickedCoordinate=t.x,this.isTextHighlightOn=!1,this._highlightedText="",this._cursorIndex=-1,this._isPointerDown=!0,this._host._capturingControl[i]=this,this._focusedBy=r.event.pointerType,this._host.focusedControl===this?(clearTimeout(this._blinkTimeout),this._markAsDirty(),0):!this._isEnabled||(this._host.focusedControl=this,0)))}_onPointerMove(e,t,i,s){this._host.focusedControl===this&&this._isPointerDown&&!this.isReadOnly&&(this._clickedCoordinate=t.x,this._markAsDirty(),this._updateValueFromCursorIndex(this._cursorOffset)),super._onPointerMove(e,t,i,s)}_onPointerUp(e,t,i,s,r){this._isPointerDown=!1,delete this._host._capturingControl[i],super._onPointerUp(e,t,i,s,r)}_beforeRenderText(e){return e}set isTextHighlightOn(e){this._isTextHighlightOn!==e&&(e&&this.onTextHighlightObservable.notifyObservers(this),this._isTextHighlightOn=e)}get isTextHighlightOn(){return this._isTextHighlightOn}dispose(){super.dispose(),this.onBlurObservable.clear(),this.onFocusObservable.clear(),this.onTextChangedObservable.clear(),this.onTextCopyObservable.clear(),this.onTextCutObservable.clear(),this.onTextPasteObservable.clear(),this.onTextHighlightObservable.clear(),this.onKeyboardEventProcessedObservable.clear()}}(0,w.Cg)([(0,D.lK)()],sh.prototype,"promptMessage",void 0),(0,w.Cg)([(0,D.lK)()],sh.prototype,"disableMobilePrompt",void 0),(0,w.Cg)([(0,D.lK)()],sh.prototype,"maxWidth",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"highligherOpacity",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"onFocusSelectAll",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"textHighlightColor",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"margin",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"autoStretchWidth",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"thickness",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"focusedBackground",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"focusedColor",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"background",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"placeholderColor",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"placeholderText",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"deadKey",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"text",null),(0,w.Cg)([(0,D.lK)()],sh.prototype,"width",null),(0,V.Y5)("BABYLON.GUI.InputText",sh);class rh extends Kl{set clipContent(e){this._clipContent=e;for(const t in this._cells)this._cells[t].clipContent=e}get clipContent(){return this._clipContent}set clipChildren(e){this._clipChildren=e;for(const t in this._cells)this._cells[t].clipChildren=e}get clipChildren(){return this._clipChildren}get columnCount(){return this._columnDefinitions.length}get rowCount(){return this._rowDefinitions.length}get children(){return this._childControls}get cells(){return this._cells}getRowDefinition(e){return e<0||e>=this._rowDefinitions.length?null:this._rowDefinitions[e]}getColumnDefinition(e){return e<0||e>=this._columnDefinitions.length?null:this._columnDefinitions[e]}addRowDefinition(e,t=!1){return this._rowDefinitions.push(new Ll(e,t?Ll.UNITMODE_PIXEL:Ll.UNITMODE_PERCENTAGE)),this._rowDefinitionObservers.push(this._rowDefinitions[this.rowCount-1].onChangedObservable.add((()=>this._markAsDirty()))),this._markAsDirty(),this}addColumnDefinition(e,t=!1){return this._columnDefinitions.push(new Ll(e,t?Ll.UNITMODE_PIXEL:Ll.UNITMODE_PERCENTAGE)),this._columnDefinitionObservers.push(this._columnDefinitions[this.columnCount-1].onChangedObservable.add((()=>this._markAsDirty()))),this._markAsDirty(),this}setRowDefinition(e,t,i=!1){if(e<0||e>=this._rowDefinitions.length)return this;const s=this._rowDefinitions[e];return s&&s.isPixel===i&&s.value===t||(this._rowDefinitions[e].onChangedObservable.remove(this._rowDefinitionObservers[e]),this._rowDefinitions[e]=new Ll(t,i?Ll.UNITMODE_PIXEL:Ll.UNITMODE_PERCENTAGE),this._rowDefinitionObservers[e]=this._rowDefinitions[e].onChangedObservable.add((()=>this._markAsDirty())),this._markAsDirty()),this}setColumnDefinition(e,t,i=!1){if(e<0||e>=this._columnDefinitions.length)return this;const s=this._columnDefinitions[e];return s&&s.isPixel===i&&s.value===t||(this._columnDefinitions[e].onChangedObservable.remove(this._columnDefinitionObservers[e]),this._columnDefinitions[e]=new Ll(t,i?Ll.UNITMODE_PIXEL:Ll.UNITMODE_PERCENTAGE),this._columnDefinitionObservers[e]=this._columnDefinitions[e].onChangedObservable.add((()=>this._markAsDirty())),this._markAsDirty()),this}getChildrenAt(e,t){const i=this._cells[`${e}:${t}`];return i?i.children:null}getChildCellInfo(e){return e._tag}_removeCell(e,t){if(e){super.removeControl(e);for(const t of e.children){const e=this._childControls.indexOf(t);-1!==e&&this._childControls.splice(e,1)}delete this._cells[t]}}_offsetCell(e,t){if(this._cells[t]){this._cells[e]=this._cells[t];for(const t of this._cells[e].children)t._tag=e;delete this._cells[t]}}removeColumnDefinition(e){if(e<0||e>=this._columnDefinitions.length)return this;for(let t=0;t<this._rowDefinitions.length;t++){const i=`${t}:${e}`,s=this._cells[i];this._removeCell(s,i)}for(let t=0;t<this._rowDefinitions.length;t++)for(let i=e+1;i<this._columnDefinitions.length;i++){const e=`${t}:${i-1}`,s=`${t}:${i}`;this._offsetCell(e,s)}return this._columnDefinitions[e].onChangedObservable.remove(this._columnDefinitionObservers[e]),this._columnDefinitions.splice(e,1),this._columnDefinitionObservers.splice(e,1),this._markAsDirty(),this}removeRowDefinition(e){if(e<0||e>=this._rowDefinitions.length)return this;for(let t=0;t<this._columnDefinitions.length;t++){const i=`${e}:${t}`,s=this._cells[i];this._removeCell(s,i)}for(let t=0;t<this._columnDefinitions.length;t++)for(let i=e+1;i<this._rowDefinitions.length;i++){const e=`${i-1}:${t}`,s=`${i}:${t}`;this._offsetCell(e,s)}return this._rowDefinitions[e].onChangedObservable.remove(this._rowDefinitionObservers[e]),this._rowDefinitions.splice(e,1),this._rowDefinitionObservers.splice(e,1),this._markAsDirty(),this}addControl(e,t=0,i=0){if(0===this._rowDefinitions.length&&this.addRowDefinition(1,!1),0===this._columnDefinitions.length&&this.addColumnDefinition(1,!1),-1!==this._childControls.indexOf(e))return ee.S0.Warn(`Control (Name:${e.name}, UniqueId:${e.uniqueId}) is already associated with this grid. You must remove it before reattaching it`),this;const s=`${Math.min(t,this._rowDefinitions.length-1)}:${Math.min(i,this._columnDefinitions.length-1)}`;let r=this._cells[s];return r||(r=new Kl(s),this._cells[s]=r,r.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,r.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,r.clipContent=this.clipContent,r.clipChildren=this.clipChildren,super.addControl(r)),r.addControl(e),this._childControls.push(e),e._tag=s,e.parent=this,this._markAsDirty(),this}removeControl(e){const t=this._childControls.indexOf(e);-1!==t&&this._childControls.splice(t,1);const i=this._cells[e._tag];return i&&(i.removeControl(e),e._tag=null),this._markAsDirty(),this}constructor(e){super(e),this.name=e,this._rowDefinitions=new Array,this._rowDefinitionObservers=[],this._columnDefinitions=new Array,this._columnDefinitionObservers=[],this._cells={},this._childControls=new Array}_getTypeName(){return"Grid"}_getGridDefinitions(e){const t=[],i=[],s=[],r=[];let n=this._currentMeasure.width,a=0,o=this._currentMeasure.height,l=0,h=0;for(const e of this._rowDefinitions){if(e.isPixel){const t=e.getValue(this._host);o-=t,i[h]=t}else l+=e.value;h++}let c=0;h=0;for(const e of this._rowDefinitions){if(r.push(c),e.isPixel)c+=e.getValue(this._host);else{const t=Math.round(e.value/l*o);c+=t,i[h]=t}h++}h=0;for(const e of this._columnDefinitions){if(e.isPixel){const i=e.getValue(this._host);n-=i,t[h]=i}else a+=e.value;h++}let u=0;h=0;for(const e of this._columnDefinitions){if(s.push(u),e.isPixel)u+=e.getValue(this._host);else{const i=Math.round(e.value/a*n);u+=i,t[h]=i}h++}e(s,r,t,i)}_additionalProcessing(e,t){this._getGridDefinitions(((e,t,i,s)=>{for(const r in this._cells){if(!Object.prototype.hasOwnProperty.call(this._cells,r))continue;const n=r.split(":"),a=parseInt(n[0]),o=parseInt(n[1]),l=this._cells[r];l.leftInPixels=e[o],l.topInPixels=t[a],l.widthInPixels=i[o],l.heightInPixels=s[a],l._left.ignoreAdaptiveScaling=!0,l._top.ignoreAdaptiveScaling=!0,l._width.ignoreAdaptiveScaling=!0,l._height.ignoreAdaptiveScaling=!0}})),super._additionalProcessing(e,t)}_flagDescendantsAsMatrixDirty(){for(const e in this._cells)Object.prototype.hasOwnProperty.call(this._cells,e)&&this._cells[e]._markMatrixAsDirty()}_renderHighlightSpecific(e){super._renderHighlightSpecific(e),this._getGridDefinitions(((t,i,s,r)=>{for(let i=0;i<t.length;i++){const r=this._currentMeasure.left+t[i]+s[i];e.beginPath(),e.moveTo(r,this._currentMeasure.top),e.lineTo(r,this._currentMeasure.top+this._currentMeasure.height),e.stroke()}for(let t=0;t<i.length;t++){const s=this._currentMeasure.top+i[t]+r[t];e.beginPath(),e.moveTo(this._currentMeasure.left,s),e.lineTo(this._currentMeasure.left+this._currentMeasure.width,s),e.stroke()}})),e.restore()}dispose(){super.dispose();for(const e of this._childControls)e.dispose();for(let e=0;e<this._rowDefinitions.length;e++)this._rowDefinitions[e].onChangedObservable.remove(this._rowDefinitionObservers[e]);for(let e=0;e<this._columnDefinitions.length;e++)this._columnDefinitions[e].onChangedObservable.remove(this._columnDefinitionObservers[e]);this._rowDefinitionObservers.length=0,this._rowDefinitions.length=0,this._columnDefinitionObservers.length=0,this._columnDefinitions.length=0,this._cells={},this._childControls.length=0}serialize(e,t){if(super.serialize(e,t),this.isSerializable||t){e.columnCount=this.columnCount,e.rowCount=this.rowCount,e.columns=[],e.rows=[],e.tags=[];for(let t=0;t<this.columnCount;++t){const i=this.getColumnDefinition(t),s={value:i?.getValue(this.host),unit:i?.unit};e.columns.push(s)}for(let t=0;t<this.rowCount;++t){const i=this.getRowDefinition(t),s={value:i?.getValue(this.host),unit:i?.unit};e.rows.push(s)}this.children.forEach((t=>{e.tags.push(t._tag)}))}}_parseFromContent(e,t){super._parseFromContent(e,t);const i=[];this.children.forEach((e=>{i.push(e)})),this.removeRowDefinition(0),this.removeColumnDefinition(0);for(let t=0;t<e.columnCount;++t){const i=e.columns[t].value,s=e.columns[t].unit;this.addColumnDefinition(i,1===s)}for(let t=0;t<e.rowCount;++t){const i=e.rows[t].value,s=e.rows[t].unit;this.addRowDefinition(i,1===s)}for(let t=0;t<i.length;++t){const s=e.tags[t];let r=parseInt(s.substring(0,s.search(":")));isNaN(r)&&(r=0);let n=parseInt(s.substring(s.search(":")+1));isNaN(n)&&(n=0),this.addControl(i[t],r,n)}}}(0,w.Cg)([(0,D.lK)()],rh.prototype,"clipContent",null),(0,V.Y5)("BABYLON.GUI.Grid",rh);class nh extends Xl{get value(){return this._value}set value(e){this._value.equals(e)||(this._value.copyFrom(e),this._value.toHSVToRef(this._tmpColor),this._h=this._tmpColor.r,this._s=Math.max(this._tmpColor.g,1e-5),this._v=Math.max(this._tmpColor.b,1e-5),this._markAsDirty(),this._value.r<=nh._Epsilon&&(this._value.r=0),this._value.g<=nh._Epsilon&&(this._value.g=0),this._value.b<=nh._Epsilon&&(this._value.b=0),this._value.r>=1-nh._Epsilon&&(this._value.r=1),this._value.g>=1-nh._Epsilon&&(this._value.g=1),this._value.b>=1-nh._Epsilon&&(this._value.b=1),this.onValueChangedObservable.notifyObservers(this._value))}get width(){return this._width.toString(this._host)}set width(e){this._width.toString(this._host)!==e&&this._width.fromString(e)&&(0===this._width.getValue(this._host)&&(e="1px",this._width.fromString(e)),this._height.fromString(e),this._markAsDirty())}get height(){return this._height.toString(this._host)}set height(e){this._height.toString(this._host)!==e&&this._height.fromString(e)&&(0===this._height.getValue(this._host)&&(e="1px",this._height.fromString(e)),this._width.fromString(e),this._markAsDirty())}get size(){return this.width}set size(e){this.width=e}constructor(e){super(e),this.name=e,this._value=M.v9.Red(),this._tmpColor=new M.v9,this._pointerStartedOnSquare=!1,this._pointerStartedOnWheel=!1,this._squareLeft=0,this._squareTop=0,this._squareSize=0,this._h=360,this._s=1,this._v=1,this._lastPointerDownId=-1,this.onValueChangedObservable=new C.cP,this._pointerIsDown=!1,this.value=new M.v9(.88,.1,.1),this.size="200px",this.isPointerBlocker=!0}_getTypeName(){return"ColorPicker"}_preMeasure(e){e.width<e.height?this._currentMeasure.height=e.width:this._currentMeasure.width=e.height}_updateSquareProps(){const e=.5*Math.min(this._currentMeasure.width,this._currentMeasure.height),t=2*(e-.2*e)/Math.sqrt(2),i=e-.5*t;this._squareLeft=this._currentMeasure.left+i,this._squareTop=this._currentMeasure.top+i,this._squareSize=t}_drawGradientSquare(e,t,i,s,r,n){const a=n.createLinearGradient(t,i,s+t,i);a.addColorStop(0,"#fff"),a.addColorStop(1,"hsl("+e+", 100%, 50%)"),n.fillStyle=a,n.fillRect(t,i,s,r);const o=n.createLinearGradient(t,i,t,r+i);o.addColorStop(0,"rgba(0,0,0,0)"),o.addColorStop(1,"#000"),n.fillStyle=o,n.fillRect(t,i,s,r)}_drawCircle(e,t,i,s){s.beginPath(),s.arc(e,t,i+1,0,2*Math.PI,!1),s.lineWidth=3,s.strokeStyle="#333333",s.stroke(),s.beginPath(),s.arc(e,t,i,0,2*Math.PI,!1),s.lineWidth=3,s.strokeStyle="#ffffff",s.stroke()}_createColorWheelCanvas(e,i){const s=t.q.LastCreatedEngine;if(!s)throw new Error("Invalid engine. Unable to create a canvas.");const r=s.createCanvas(2*e,2*e),n=r.getContext("2d"),a=n.getImageData(0,0,2*e,2*e),o=a.data,l=this._tmpColor,h=e*e,c=e-i,u=c*c;for(let t=-e;t<e;t++)for(let i=-e;i<e;i++){const s=t*t+i*i;if(s>h||s<u)continue;const r=Math.sqrt(s),n=Math.atan2(i,t);M.v9.HSVtoRGBToRef(180*n/Math.PI+180,r/e,1,l);const a=4*(t+e+2*(i+e)*e);o[a]=255*l.r,o[a+1]=255*l.g,o[a+2]=255*l.b;let d=(r-c)/(e-c),_=.2;const p=.2,f=.04,m=50,g=150;_=e<m?p:e>g?f:(f-p)*(e-m)/(g-m)+p,d=(r-c)/(e-c),o[a+3]=d<_?d/_*255:d>1-_?255*(1-(d-(1-_))/_):255}return n.putImageData(a,0,0),r}_draw(e){e.save(),this._applyStates(e);const t=.5*Math.min(this._currentMeasure.width,this._currentMeasure.height),i=.2*t,s=this._currentMeasure.left,r=this._currentMeasure.top;this._colorWheelCanvas&&this._colorWheelCanvas.width==2*t||(this._colorWheelCanvas=this._createColorWheelCanvas(t,i)),this._updateSquareProps(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY,e.fillRect(this._squareLeft,this._squareTop,this._squareSize,this._squareSize)),e.drawImage(this._colorWheelCanvas,s,r),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this._drawGradientSquare(this._h,this._squareLeft,this._squareTop,this._squareSize,this._squareSize,e);let n=this._squareLeft+this._squareSize*this._s,a=this._squareTop+this._squareSize*(1-this._v);this._drawCircle(n,a,.04*t,e);const o=t-.5*i;n=s+t+Math.cos((this._h-180)*Math.PI/180)*o,a=r+t+Math.sin((this._h-180)*Math.PI/180)*o,this._drawCircle(n,a,.35*i,e),e.restore()}_updateValueFromPointer(e,t){if(this._pointerStartedOnWheel){const i=.5*Math.min(this._currentMeasure.width,this._currentMeasure.height),s=i+this._currentMeasure.left,r=i+this._currentMeasure.top;this._h=180*Math.atan2(t-r,e-s)/Math.PI+180}else this._pointerStartedOnSquare&&(this._updateSquareProps(),this._s=(e-this._squareLeft)/this._squareSize,this._v=1-(t-this._squareTop)/this._squareSize,this._s=Math.min(this._s,1),this._s=Math.max(this._s,nh._Epsilon),this._v=Math.min(this._v,1),this._v=Math.max(this._v,nh._Epsilon));M.v9.HSVtoRGBToRef(this._h,this._s,this._v,this._tmpColor),this.value=this._tmpColor}_isPointOnSquare(e,t){this._updateSquareProps();const i=this._squareLeft,s=this._squareTop,r=this._squareSize;return e>=i&&e<=i+r&&t>=s&&t<=s+r}_isPointOnWheel(e,t){const i=.5*Math.min(this._currentMeasure.width,this._currentMeasure.height),s=i-.2*i,r=e-(i+this._currentMeasure.left),n=t-(i+this._currentMeasure.top),a=r*r+n*n;return a<=i*i&&a>=s*s}_onPointerDown(e,t,i,s,r){if(!super._onPointerDown(e,t,i,s,r))return!1;if(this.isReadOnly)return!0;this._pointerIsDown=!0,this._pointerStartedOnSquare=!1,this._pointerStartedOnWheel=!1,this._invertTransformMatrix.transformCoordinates(t.x,t.y,this._transformedPosition);const n=this._transformedPosition.x,a=this._transformedPosition.y;return this._isPointOnSquare(n,a)?this._pointerStartedOnSquare=!0:this._isPointOnWheel(n,a)&&(this._pointerStartedOnWheel=!0),this._updateValueFromPointer(n,a),this._host._capturingControl[i]=this,this._lastPointerDownId=i,!0}_onPointerMove(e,t,i,s){if(i==this._lastPointerDownId){if(!this.isReadOnly){this._invertTransformMatrix.transformCoordinates(t.x,t.y,this._transformedPosition);const e=this._transformedPosition.x,i=this._transformedPosition.y;this._pointerIsDown&&this._updateValueFromPointer(e,i)}super._onPointerMove(e,t,i,s)}}_onPointerUp(e,t,i,s,r,n){this._pointerIsDown=!1,delete this._host._capturingControl[i],super._onPointerUp(e,t,i,s,r,n)}_onCanvasBlur(){this._forcePointerUp(),super._onCanvasBlur()}static ShowPickerDialogAsync(e,t){return new Promise((i=>{t.pickerWidth=t.pickerWidth||"640px",t.pickerHeight=t.pickerHeight||"400px",t.headerHeight=t.headerHeight||"35px",t.lastColor=t.lastColor||"#000000",t.swatchLimit=t.swatchLimit||20,t.numSwatchesPerLine=t.numSwatchesPerLine||10;const s=t.swatchLimit/t.numSwatchesPerLine,r=parseFloat(t.pickerWidth)/t.numSwatchesPerLine,n=Math.floor(.25*r),a=n*(t.numSwatchesPerLine+1),o=Math.floor((parseFloat(t.pickerWidth)-a)/t.numSwatchesPerLine),l=o*s+n*(s+1),h=(parseInt(t.pickerHeight)+l+Math.floor(.25*o)).toString()+"px",c="#c0c0c0",u="#535353",d="#414141",_="515151",p="#555555",f="#454545",m=M.v9.FromHexString("#dddddd"),g=m.r+m.g+m.b,v="#aaaaaa",b="#ffffff";let x,S;const T=["R","G","B"],y="#454545",C="#f0f0f0";let P,E,A,R,I,O=!1;const w=new rh;if(w.name="Dialog Container",w.width=t.pickerWidth,t.savedColors){w.height=h;const e=parseInt(t.pickerHeight)/parseInt(h);w.addRowDefinition(e,!1),w.addRowDefinition(1-e,!1)}else w.height=t.pickerHeight,w.addRowDefinition(1,!1);if(e.addControl(w),t.savedColors){E=new rh,E.name="Swatch Drawer",E.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,E.background=u,E.width=t.pickerWidth;const e=t.savedColors.length/t.numSwatchesPerLine;let i;i=0==e?0:e+1,E.height=(o*e+i*n).toString()+"px",E.top=Math.floor(.25*o).toString()+"px";for(let e=0;e<2*Math.ceil(t.savedColors.length/t.numSwatchesPerLine)+1;e++)e%2!=0?E.addRowDefinition(o,!0):E.addRowDefinition(n,!0);for(let e=0;e<2*t.numSwatchesPerLine+1;e++)e%2!=0?E.addColumnDefinition(o,!0):E.addColumnDefinition(n,!0);w.addControl(E,1,0)}const D=new rh;D.name="Picker Panel",D.height=t.pickerHeight;const F=parseInt(t.headerHeight)/parseInt(t.pickerHeight),N=[F,1-F];D.addRowDefinition(N[0],!1),D.addRowDefinition(N[1],!1),w.addControl(D,0,0);const L=new Ql;L.name="Dialogue Header Bar",L.background="#cccccc",L.thickness=0,D.addControl(L,0,0);const B=jl.CreateSimpleButton("closeButton","a");B.fontFamily="coreglyphs";const k=M.v9.FromHexString(L.background),V=new M.v9(1-k.r,1-k.g,1-k.b);B.color=V.toHexString(),B.fontSize=Math.floor(.6*parseInt(t.headerHeight)),B.textBlock.textVerticalAlignment=Xl.VERTICAL_ALIGNMENT_CENTER,B.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_RIGHT,B.height=B.width=t.headerHeight,B.background=L.background,B.thickness=0,B.pointerDownAnimation=()=>{},B.pointerUpAnimation=()=>{B.background=L.background},B.pointerEnterAnimation=()=>{B.color=L.background,B.background="red"},B.pointerOutAnimation=()=>{B.color=V.toHexString(),B.background=L.background},B.onPointerClickObservable.add((()=>{we(ie.background)})),D.addControl(B,0,0);const U=new rh;U.name="Dialogue Body",U.background=u;const z=[.4375,.5625];U.addRowDefinition(1,!1),U.addColumnDefinition(z[0],!1),U.addColumnDefinition(z[1],!1),D.addControl(U,1,0);const G=new rh;G.name="Picker Grid",G.addRowDefinition(.85,!1),G.addRowDefinition(.15,!1),U.addControl(G,0,0);const H=new nh;H.name="GUI Color Picker",t.pickerHeight<t.pickerWidth?H.width=.89:H.height=.89,H.value=M.v9.FromHexString(t.lastColor),H.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_CENTER,H.verticalAlignment=Xl.VERTICAL_ALIGNMENT_CENTER,H.onPointerDownObservable.add((()=>{I=H.name,R="",Re(!1)})),H.onValueChangedObservable.add((function(e){I==H.name&&Ce(e,H.name)})),G.addControl(H,0,0);const W=new rh;W.name="Dialogue Right Half",W.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT;const X=[.514,.486];W.addRowDefinition(X[0],!1),W.addRowDefinition(X[1],!1),U.addControl(W,1,1);const K=new rh;K.name="Swatches and Buttons";const Q=[.417,.583];K.addRowDefinition(1,!1),K.addColumnDefinition(Q[0],!1),K.addColumnDefinition(Q[1],!1),W.addControl(K,0,0);const Y=new rh;Y.name="New and Current Swatches";const q=[.04,.16,.64,.16];Y.addRowDefinition(q[0],!1),Y.addRowDefinition(q[1],!1),Y.addRowDefinition(q[2],!1),Y.addRowDefinition(q[3],!1),K.addControl(Y,0,0);const $=new rh;$.name="Active Swatches",$.width=.67,$.addRowDefinition(.5,!1),$.addRowDefinition(.5,!1),Y.addControl($,2,0);const j=Math.floor(parseInt(t.pickerWidth)*z[1]*Q[0]*.11),Z=Math.floor(parseInt(t.pickerHeight)*N[1]*X[0]*q[1]*.5);let J;J=t.pickerWidth>t.pickerHeight?Z:j;const ee=new ql;ee.text="new",ee.name="New Color Label",ee.color=c,ee.fontSize=J,Y.addControl(ee,1,0);const te=new Ql;te.name="New Color Swatch",te.background=t.lastColor,te.thickness=0,$.addControl(te,0,0);const ie=jl.CreateSimpleButton("currentSwatch","");ie.background=t.lastColor,ie.thickness=0,ie.onPointerClickObservable.add((()=>{Ce(M.v9.FromHexString(ie.background),ie.name),Re(!1)})),ie.pointerDownAnimation=()=>{},ie.pointerUpAnimation=()=>{},ie.pointerEnterAnimation=()=>{},ie.pointerOutAnimation=()=>{},$.addControl(ie,1,0);const se=new Ql;se.name="Swatch Outline",se.width=.67,se.thickness=2,se.color="#404040",se.isHitTestVisible=!1,Y.addControl(se,2,0);const re=new ql;re.name="Current Color Label",re.text="current",re.color=c,re.fontSize=J,Y.addControl(re,3,0);const ne=new rh;ne.name="Button Grid",ne.height=.8;const ae=1/3;ne.addRowDefinition(ae,!1),ne.addRowDefinition(ae,!1),ne.addRowDefinition(ae,!1),K.addControl(ne,0,1);const oe=Math.floor(parseInt(t.pickerWidth)*z[1]*Q[1]*.67).toString()+"px",le=Math.floor(parseInt(t.pickerHeight)*N[1]*X[0]*(parseFloat(ne.height.toString())/100)*ae*.7).toString()+"px";x=parseFloat(oe)>parseFloat(le)?Math.floor(.45*parseFloat(le)):Math.floor(.11*parseFloat(oe));const he=jl.CreateSimpleButton("butOK","OK");he.width=oe,he.height=le,he.verticalAlignment=Xl.VERTICAL_ALIGNMENT_CENTER,he.thickness=2,he.color=c,he.fontSize=x,he.background=u,he.onPointerEnterObservable.add((()=>{he.background=d})),he.onPointerOutObservable.add((()=>{he.background=u})),he.pointerDownAnimation=()=>{he.background=_},he.pointerUpAnimation=()=>{he.background=d},he.onPointerClickObservable.add((()=>{Re(!1),we(te.background)})),ne.addControl(he,0,0);const ce=jl.CreateSimpleButton("butCancel","Cancel");ce.width=oe,ce.height=le,ce.verticalAlignment=Xl.VERTICAL_ALIGNMENT_CENTER,ce.thickness=2,ce.color=c,ce.fontSize=x,ce.background=u,ce.onPointerEnterObservable.add((()=>{ce.background=d})),ce.onPointerOutObservable.add((()=>{ce.background=u})),ce.pointerDownAnimation=()=>{ce.background=_},ce.pointerUpAnimation=()=>{ce.background=d},ce.onPointerClickObservable.add((()=>{Re(!1),we(ie.background)})),ne.addControl(ce,1,0),t.savedColors&&(A=jl.CreateSimpleButton("butSave","Save"),A.width=oe,A.height=le,A.verticalAlignment=Xl.VERTICAL_ALIGNMENT_CENTER,A.thickness=2,A.fontSize=x,t.savedColors.length<t.swatchLimit?(A.color=c,A.background=u):Oe(A,!0),A.onPointerEnterObservable.add((()=>{t.savedColors&&t.savedColors.length<t.swatchLimit&&(A.background=d)})),A.onPointerOutObservable.add((()=>{t.savedColors&&t.savedColors.length<t.swatchLimit&&(A.background=u)})),A.pointerDownAnimation=()=>{t.savedColors&&t.savedColors.length<t.swatchLimit&&(A.background=_)},A.pointerUpAnimation=()=>{t.savedColors&&t.savedColors.length<t.swatchLimit&&(A.background=d)},A.onPointerClickObservable.add((()=>{t.savedColors&&(0==t.savedColors.length&&Me(!0),t.savedColors.length<t.swatchLimit&&Ie(te.background,A),Re(!1))})),t.savedColors.length>0&&Me(!0),ne.addControl(A,2,0));const ue=new rh;ue.name="Dialog Lower Right",ue.addRowDefinition(.02,!1),ue.addRowDefinition(.63,!1),ue.addRowDefinition(.21,!1),ue.addRowDefinition(.14,!1),W.addControl(ue,1,0);const de=M.v9.FromHexString(t.lastColor),_e=new rh;_e.name="RGB Values",_e.width=.82,_e.verticalAlignment=Xl.VERTICAL_ALIGNMENT_CENTER,_e.addRowDefinition(1/3,!1),_e.addRowDefinition(1/3,!1),_e.addRowDefinition(1/3,!1),_e.addColumnDefinition(.1,!1),_e.addColumnDefinition(.2,!1),_e.addColumnDefinition(.7,!1),ue.addControl(_e,1,0);for(let e=0;e<T.length;e++){const t=new ql;t.text=T[e],t.color=c,t.fontSize=x,_e.addControl(t,e,0)}const pe=new sh;pe.width=.83,pe.height=.72,pe.name="rIntField",pe.fontSize=x,pe.text=(255*de.r).toString(),pe.color=C,pe.background=y,pe.onFocusObservable.add((()=>{I=pe.name,R=pe.text,Re(!1)})),pe.onBlurObservable.add((()=>{""==pe.text&&(pe.text="0"),Pe(pe,"r"),I==pe.name&&(I="")})),pe.onTextChangedObservable.add((()=>{I==pe.name&&Pe(pe,"r")})),_e.addControl(pe,0,1);const fe=new sh;fe.width=.83,fe.height=.72,fe.name="gIntField",fe.fontSize=x,fe.text=(255*de.g).toString(),fe.color=C,fe.background=y,fe.onFocusObservable.add((()=>{I=fe.name,R=fe.text,Re(!1)})),fe.onBlurObservable.add((()=>{""==fe.text&&(fe.text="0"),Pe(fe,"g"),I==fe.name&&(I="")})),fe.onTextChangedObservable.add((()=>{I==fe.name&&Pe(fe,"g")})),_e.addControl(fe,1,1);const me=new sh;me.width=.83,me.height=.72,me.name="bIntField",me.fontSize=x,me.text=(255*de.b).toString(),me.color=C,me.background=y,me.onFocusObservable.add((()=>{I=me.name,R=me.text,Re(!1)})),me.onBlurObservable.add((()=>{""==me.text&&(me.text="0"),Pe(me,"b"),I==me.name&&(I="")})),me.onTextChangedObservable.add((()=>{I==me.name&&Pe(me,"b")})),_e.addControl(me,2,1);const ge=new sh;ge.width=.95,ge.height=.72,ge.name="rDecField",ge.fontSize=x,ge.text=de.r.toString(),ge.color=C,ge.background=y,ge.onFocusObservable.add((()=>{I=ge.name,R=ge.text,Re(!1)})),ge.onBlurObservable.add((()=>{0!=parseFloat(ge.text)&&""!=ge.text||(ge.text="0",Ee(ge,"r")),I==ge.name&&(I="")})),ge.onTextChangedObservable.add((()=>{I==ge.name&&Ee(ge,"r")})),_e.addControl(ge,0,2);const ve=new sh;ve.width=.95,ve.height=.72,ve.name="gDecField",ve.fontSize=x,ve.text=de.g.toString(),ve.color=C,ve.background=y,ve.onFocusObservable.add((()=>{I=ve.name,R=ve.text,Re(!1)})),ve.onBlurObservable.add((()=>{0!=parseFloat(ve.text)&&""!=ve.text||(ve.text="0",Ee(ve,"g")),I==ve.name&&(I="")})),ve.onTextChangedObservable.add((()=>{I==ve.name&&Ee(ve,"g")})),_e.addControl(ve,1,2);const be=new sh;be.width=.95,be.height=.72,be.name="bDecField",be.fontSize=x,be.text=de.b.toString(),be.color=C,be.background=y,be.onFocusObservable.add((()=>{I=be.name,R=be.text,Re(!1)})),be.onBlurObservable.add((()=>{0!=parseFloat(be.text)&&""!=be.text||(be.text="0",Ee(be,"b")),I==be.name&&(I="")})),be.onTextChangedObservable.add((()=>{I==be.name&&Ee(be,"b")})),_e.addControl(be,2,2);const xe=new rh;xe.name="Hex Value",xe.width=.82,xe.addRowDefinition(1,!1),xe.addColumnDefinition(.1,!1),xe.addColumnDefinition(.9,!1),ue.addControl(xe,2,0);const Se=new ql;Se.text="#",Se.color=c,Se.fontSize=x,xe.addControl(Se,0,0);const Te=new sh;Te.width=.96,Te.height=.72,Te.name="hexField",Te.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_CENTER,Te.fontSize=x;const ye=t.lastColor.split("#");function Ce(e,t){I=t;const i=e.toHexString();if(te.background=i,pe.name!=I&&(pe.text=Math.floor(255*e.r).toString()),fe.name!=I&&(fe.text=Math.floor(255*e.g).toString()),me.name!=I&&(me.text=Math.floor(255*e.b).toString()),ge.name!=I&&(ge.text=e.r.toString()),ve.name!=I&&(ve.text=e.g.toString()),be.name!=I&&(be.text=e.b.toString()),Te.name!=I){const e=i.split("#");Te.text=e[1]}H.name!=I&&(H.value=e)}function Pe(e,t){let i=e.text;if(/[^0-9]/g.test(i))e.text=R;else if(""!=i&&(Math.floor(parseInt(i))<0?i="0":Math.floor(parseInt(i))>255?i="255":isNaN(parseInt(i))&&(i="0")),I==e.name&&(R=i),""!=i){i=parseInt(i).toString(),e.text=i;const s=M.v9.FromHexString(te.background);I==e.name&&Ce("r"==t?new M.v9(parseInt(i)/255,s.g,s.b):"g"==t?new M.v9(s.r,parseInt(i)/255,s.b):new M.v9(s.r,s.g,parseInt(i)/255),e.name)}}function Ee(e,t){let i=e.text;if(/[^0-9.]/g.test(i))return void(e.text=R);""!=i&&"."!=i&&0!=parseFloat(i)&&(parseFloat(i)<0?i="0.0":parseFloat(i)>1?i="1.0":isNaN(parseFloat(i))&&(i="0.0")),I==e.name&&(R=i),""!=i&&"."!=i&&0!=parseFloat(i)?(i=parseFloat(i).toString(),e.text=i):i="0.0";const s=M.v9.FromHexString(te.background);I==e.name&&Ce("r"==t?new M.v9(parseFloat(i),s.g,s.b):"g"==t?new M.v9(s.r,parseFloat(i),s.b):new M.v9(s.r,s.g,parseFloat(i)),e.name)}function Ae(){if(t.savedColors&&t.savedColors[P]){let e;e=O?"b":"";const i=jl.CreateSimpleButton("Swatch_"+P,e);i.fontFamily="coreglyphs";const s=M.v9.FromHexString(t.savedColors[P]),r=s.r+s.g+s.b;i.color=r>g?v:b,i.fontSize=Math.floor(.7*o),i.textBlock.verticalAlignment=Xl.VERTICAL_ALIGNMENT_CENTER,i.height=i.width=o.toString()+"px",i.background=t.savedColors[P],i.thickness=2;const n=P;return i.pointerDownAnimation=()=>{i.thickness=4},i.pointerUpAnimation=()=>{i.thickness=3},i.pointerEnterAnimation=()=>{i.thickness=3},i.pointerOutAnimation=()=>{i.thickness=2},i.onPointerClickObservable.add((()=>{var e;O?(e=n,t.savedColors&&t.savedColors.splice(e,1),t.savedColors&&0==t.savedColors.length&&(Me(!1),O=!1),Ie("",A)):t.savedColors&&Ce(M.v9.FromHexString(t.savedColors[n]),i.name)})),i}return null}function Re(e){let t;if(void 0!==e&&(O=e),O){for(let e=0;e<E.children.length;e++)t=E.children[e],t.textBlock.text="b";void 0!==S&&(S.textBlock.text="Done")}else{for(let e=0;e<E.children.length;e++)t=E.children[e],t.textBlock.text="";void 0!==S&&(S.textBlock.text="Edit")}}function Ie(e,i){if(t.savedColors){""!=e&&t.savedColors.push(e),P=0,E.clearControls();const s=Math.ceil(t.savedColors.length/t.numSwatchesPerLine);let r;if(r=0==s?0:s+1,E.rowCount!=s+r){const e=E.rowCount;for(let t=0;t<e;t++)E.removeRowDefinition(0);for(let e=0;e<s+r;e++)e%2?E.addRowDefinition(o,!0):E.addRowDefinition(n,!0)}E.height=(o*s+r*n).toString()+"px";for(let e=1,i=1;e<s+r;e+=2,i++){let s;s=t.savedColors.length>i*t.numSwatchesPerLine?t.numSwatchesPerLine:t.savedColors.length-(i-1)*t.numSwatchesPerLine;const r=Math.min(Math.max(s,0),t.numSwatchesPerLine);for(let i=0,s=1;i<r;i++){if(i>t.numSwatchesPerLine)continue;const r=Ae();null!=r&&(E.addControl(r,e,s),s+=2,P++)}}t.savedColors.length>=t.swatchLimit?Oe(i,!0):Oe(i,!1)}}function Me(e){e?(S=jl.CreateSimpleButton("butEdit","Edit"),S.width=oe,S.height=le,S.left=Math.floor(.1*parseInt(oe)).toString()+"px",S.top=(-1*parseFloat(S.left)).toString()+"px",S.verticalAlignment=Xl.VERTICAL_ALIGNMENT_BOTTOM,S.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,S.thickness=2,S.color=c,S.fontSize=x,S.background=u,S.onPointerEnterObservable.add((()=>{S.background=d})),S.onPointerOutObservable.add((()=>{S.background=u})),S.pointerDownAnimation=()=>{S.background=_},S.pointerUpAnimation=()=>{S.background=d},S.onPointerClickObservable.add((()=>{O=!O,Re()})),G.addControl(S,1,0)):G.removeControl(S)}function Oe(e,t){t?(e.color=p,e.background=f):(e.color=c,e.background=u)}function we(s){t.savedColors&&t.savedColors.length>0?i({savedColors:t.savedColors,pickedColor:s}):i({pickedColor:s}),e.removeControl(w)}Te.text=ye[1],Te.color=C,Te.background=y,Te.onFocusObservable.add((()=>{I=Te.name,R=Te.text,Re(!1)})),Te.onBlurObservable.add((()=>{if(3==Te.text.length){const e=Te.text.split("");Te.text=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]}""==Te.text&&(Te.text="000000",Ce(M.v9.FromHexString(Te.text),"b")),I==Te.name&&(I="")})),Te.onTextChangedObservable.add((()=>{let e=Te.text;const t=/[^0-9A-F]/i.test(e);if((Te.text.length>6||t)&&I==Te.name)Te.text=R;else{if(Te.text.length<6){const t=6-Te.text.length;for(let i=0;i<t;i++)e="0"+e}if(3==Te.text.length){const t=Te.text.split("");e=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]}e="#"+e,I==Te.name&&(R=Te.text,Ce(M.v9.FromHexString(e),Te.name))}})),xe.addControl(Te,0,1),t.savedColors&&t.savedColors.length>0&&Ie("",A)}))}}nh._Epsilon=1e-6,(0,w.Cg)([(0,D.lK)()],nh.prototype,"value",null),(0,w.Cg)([(0,D.lK)()],nh.prototype,"width",null),(0,w.Cg)([(0,D.lK)()],nh.prototype,"height",null),(0,w.Cg)([(0,D.lK)()],nh.prototype,"size",null),(0,V.Y5)("BABYLON.GUI.ColorPicker",nh);class ah extends Kl{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get arc(){return this._arc}set arc(e){this._arc!==e&&(this._arc=e,this._markAsDirty())}constructor(e){super(e),this.name=e,this._thickness=1,this._arc=1}_getTypeName(){return"Ellipse"}_localDraw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),Xl.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2-this._thickness/2,this._currentMeasure.height/2-this._thickness/2,this._arc,e),(this._backgroundGradient||this._background)&&(e.fillStyle=this._getBackgroundColor(e),e.fill()),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this._thickness&&(this.color&&(e.strokeStyle=this.color),e.lineWidth=this._thickness,e.stroke()),e.restore()}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.width-=2*this._thickness,this._measureForChildren.height-=2*this._thickness,this._measureForChildren.left+=this._thickness,this._measureForChildren.top+=this._thickness}_clipForChildren(e){Xl.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2,this._currentMeasure.height/2,this._arc,e),e.clip()}_renderHighlightSpecific(e){Xl.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2-this._highlightLineWidth/2,this._currentMeasure.height/2-this._highlightLineWidth/2,this._arc,e),e.stroke()}}(0,w.Cg)([(0,D.lK)()],ah.prototype,"thickness",null),(0,w.Cg)([(0,D.lK)()],ah.prototype,"arc",null),(0,V.Y5)("BABYLON.GUI.Ellipse",ah),(0,V.Y5)("BABYLON.GUI.FocusableButton",class extends jl{constructor(e){super(e),this.name=e,this.focusedColor=null,this._isFocused=!1,this._unfocusedColor=null,this.onFocusObservable=new C.cP,this.onBlurObservable=new C.cP,this.onKeyboardEventProcessedObservable=new C.cP,this._unfocusedColor=this.color}onBlur(){this._isFocused&&(this._isFocused=!1,this.focusedColor&&null!=this._unfocusedColor&&(this.color=this._unfocusedColor),this.onBlurObservable.notifyObservers(this))}onFocus(){this._isFocused=!0,this.focusedColor&&(this._unfocusedColor=this.color,this.color=this.focusedColor),this.onFocusObservable.notifyObservers(this)}keepsFocusWith(){return null}focus(){this._host.moveFocusToControl(this)}blur(){this._host.focusedControl=null}processKeyboard(e){this.onKeyboardEventProcessedObservable.notifyObservers(e,-1,this)}_onPointerDown(e,t,i,s,r){return this.isReadOnly||this.focus(),super._onPointerDown(e,t,i,s,r)}dispose(){super.dispose(),this.onBlurObservable.clear(),this.onFocusObservable.clear(),this.onKeyboardEventProcessedObservable.clear()}});class oh extends sh{get autoStretchHeight(){return this._autoStretchHeight}set autoStretchHeight(e){this._autoStretchHeight!==e&&(this._autoStretchHeight=e,this._markAsDirty())}set height(e){this.fixedRatioMasterIsWidth=!1,this._height.toString(this._host)!==e&&(this._height.fromString(e)&&this._markAsDirty(),this._autoStretchHeight=!1)}get maxHeight(){return this._maxHeight.toString(this._host)}get maxHeightInPixels(){return this._maxHeight.getValueInPixel(this._host,this._cachedParentMeasure.height)}set maxHeight(e){this._maxHeight.toString(this._host)!==e&&this._maxHeight.fromString(e)&&this._markAsDirty()}constructor(e,t=""){super(e),this.name=e,this._textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,this._textVerticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,this._prevText=this.text,this._lineSpacing=new Ll(0),this._maxHeight=new Ll(1,Ll.UNITMODE_PERCENTAGE,!1),this.onLinesReadyObservable=new C.cP,this.text=t,this.isPointerBlocker=!0,this.onLinesReadyObservable.add((()=>this._updateCursorPosition())),this._highlightCursorInfo={initialStartIndex:-1,initialRelativeStartIndex:-1,initialLineIndex:-1},this._cursorInfo={globalStartIndex:0,globalEndIndex:0,relativeEndIndex:0,relativeStartIndex:0,currentLineIndex:0}}_getTypeName(){return"InputTextArea"}processKeyboard(e){this.isReadOnly||(this.alternativeProcessKey(e.code,e.key,e),this.onKeyboardEventProcessedObservable.notifyObservers(e))}alternativeProcessKey(e,t,i){if(!i||!i.ctrlKey&&!i.metaKey||"KeyC"!==e&&"KeyV"!==e&&"KeyX"!==e){switch(e){case"KeyA":if(i&&(i.ctrlKey||i.metaKey))return this._selectAllText(),void i.preventDefault();break;case"Period":i&&i.shiftKey&&i.preventDefault();break;case"Backspace":!this._isTextHighlightOn&&this._cursorInfo.globalStartIndex>0&&(this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._cursorInfo.globalStartIndex--),this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex),this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,i&&i.preventDefault(),this._blinkIsEven=!1,this._isTextHighlightOn=!1,this._textHasChanged();break;case"Delete":!this._isTextHighlightOn&&this._cursorInfo.globalEndIndex<this.text.length&&(this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex+1),this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex),this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,i&&i.preventDefault(),this._blinkIsEven=!1,this._isTextHighlightOn=!1,this._textHasChanged();break;case"NumpadEnter":case"Enter":return this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex,"\n"),this._cursorInfo.globalStartIndex++,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._blinkIsEven=!1,this._isTextHighlightOn=!1,void this._textHasChanged();case"End":return this._cursorInfo.globalStartIndex=this.text.length,this._blinkIsEven=!1,this._isTextHighlightOn=!1,void this._markAsDirty();case"Home":return this._cursorInfo.globalStartIndex=0,this._blinkIsEven=!1,this._isTextHighlightOn=!1,void this._markAsDirty();case"ArrowLeft":return this._markAsDirty(),i&&i.shiftKey?((i.ctrlKey||i.metaKey)&&(this._cursorInfo.globalStartIndex-=this._cursorInfo.relativeStartIndex,this._cursorInfo.globalEndIndex=this._highlightCursorInfo.initialStartIndex),this._isTextHighlightOn?this._cursorInfo.globalEndIndex>this._highlightCursorInfo.initialStartIndex?this._cursorInfo.globalEndIndex--:this._cursorInfo.globalStartIndex--:(this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this._highlightCursorInfo.initialRelativeStartIndex=this._cursorInfo.relativeStartIndex,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._cursorInfo.globalStartIndex--,this._isTextHighlightOn=!0),this._blinkIsEven=!0,void i.preventDefault()):(this._isTextHighlightOn?this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex:i&&(i.ctrlKey||i.metaKey)?(this._cursorInfo.globalStartIndex-=this._cursorInfo.relativeStartIndex,i.preventDefault()):this._cursorInfo.globalStartIndex>0&&this._cursorInfo.globalStartIndex--,this._blinkIsEven=!1,void(this._isTextHighlightOn=!1));case"ArrowRight":if(this._markAsDirty(),i&&i.shiftKey){if(i.ctrlKey||i.metaKey){const e=this._lines[this._cursorInfo.currentLineIndex].text.length-this._cursorInfo.relativeEndIndex-1;this._cursorInfo.globalEndIndex+=e,this._cursorInfo.globalStartIndex=this._highlightCursorInfo.initialStartIndex}return this._isTextHighlightOn?this._cursorInfo.globalStartIndex<this._highlightCursorInfo.initialStartIndex?this._cursorInfo.globalStartIndex++:this._cursorInfo.globalEndIndex++:(this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this._highlightCursorInfo.initialRelativeStartIndex=this._cursorInfo.relativeStartIndex,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex++,this._isTextHighlightOn=!0),this._blinkIsEven=!0,void i.preventDefault()}if(this._isTextHighlightOn)this._cursorInfo.globalStartIndex=this._cursorInfo.globalEndIndex;else if(i&&(i.ctrlKey||i.metaKey)){const e=this._lines[this._cursorInfo.currentLineIndex].text.length-this._cursorInfo.relativeEndIndex;this._cursorInfo.globalStartIndex+=e}else this._cursorInfo.globalStartIndex<this.text.length&&this._cursorInfo.globalStartIndex++;return this._blinkIsEven=!1,void(this._isTextHighlightOn=!1);case"ArrowUp":if(this._blinkIsEven=!1,i&&(i.shiftKey?(this._isTextHighlightOn||(this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this._highlightCursorInfo.initialRelativeStartIndex=this._cursorInfo.relativeStartIndex),this._isTextHighlightOn=!0,this._blinkIsEven=!0):this._isTextHighlightOn=!1,i.preventDefault()),0===this._cursorInfo.currentLineIndex)this._cursorInfo.globalStartIndex=0;else{const e=this._lines[this._cursorInfo.currentLineIndex],t=this._lines[this._cursorInfo.currentLineIndex-1];let i=0,s=0;!this._isTextHighlightOn||this._cursorInfo.currentLineIndex<this._highlightCursorInfo.initialLineIndex?(i=this._cursorInfo.globalStartIndex,s=this._cursorInfo.relativeStartIndex):(i=this._cursorInfo.globalEndIndex,s=this._cursorInfo.relativeEndIndex);const r=e.text.substr(0,s),n=this._contextForBreakLines.measureText(r).width;let a=0,o=0;i-=s,i-=t.text.length+t.lineEnding.length;let l=0;for(;a<n&&l<t.text.length;)i++,l++,o=Math.abs(n-a),a=this._contextForBreakLines.measureText(t.text.substr(0,l)).width;Math.abs(n-a)>o&&l>0&&i--,this._isTextHighlightOn?this._cursorInfo.currentLineIndex<=this._highlightCursorInfo.initialLineIndex?(this._cursorInfo.globalStartIndex=i,this._cursorInfo.globalEndIndex=this._highlightCursorInfo.initialStartIndex,this._cursorInfo.relativeEndIndex=this._highlightCursorInfo.initialRelativeStartIndex):this._cursorInfo.globalEndIndex=i:this._cursorInfo.globalStartIndex=i}return void this._markAsDirty();case"ArrowDown":if(this._blinkIsEven=!1,i&&(i.shiftKey?(this._isTextHighlightOn||(this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this._highlightCursorInfo.initialRelativeStartIndex=this._cursorInfo.relativeStartIndex),this._isTextHighlightOn=!0,this._blinkIsEven=!0):this._isTextHighlightOn=!1,i.preventDefault()),this._cursorInfo.currentLineIndex===this._lines.length-1)this._cursorInfo.globalStartIndex=this.text.length;else{const e=this._lines[this._cursorInfo.currentLineIndex],t=this._lines[this._cursorInfo.currentLineIndex+1];let i=0,s=0;!this._isTextHighlightOn||this._cursorInfo.currentLineIndex<this._highlightCursorInfo.initialLineIndex?(i=this._cursorInfo.globalStartIndex,s=this._cursorInfo.relativeStartIndex):(i=this._cursorInfo.globalEndIndex,s=this._cursorInfo.relativeEndIndex);const r=e.text.substr(0,s),n=this._contextForBreakLines.measureText(r).width;let a=0,o=0;i+=e.text.length-s+e.lineEnding.length;let l=0;for(;a<n&&l<t.text.length;)i++,l++,o=Math.abs(n-a),a=this._contextForBreakLines.measureText(t.text.substr(0,l)).width;Math.abs(n-a)>o&&l>0&&i--,this._isTextHighlightOn?this._cursorInfo.currentLineIndex<this._highlightCursorInfo.initialLineIndex?(this._cursorInfo.globalStartIndex=i,this._cursorInfo.globalStartIndex>this._cursorInfo.globalEndIndex&&(this._cursorInfo.globalEndIndex+=this._cursorInfo.globalStartIndex,this._cursorInfo.globalStartIndex=this._cursorInfo.globalEndIndex-this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex-=this._cursorInfo.globalStartIndex)):(this._cursorInfo.globalEndIndex=i,this._cursorInfo.globalStartIndex=this._highlightCursorInfo.initialStartIndex):this._cursorInfo.globalStartIndex=i}return void this._markAsDirty()}1===t?.length&&(i?.preventDefault(),this._currentKey=t,this.onBeforeKeyAddObservable.notifyObservers(this),t=this._currentKey,this._addKey&&(this._isTextHighlightOn=!1,this._blinkIsEven=!1,this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex,t),this._cursorInfo.globalStartIndex+=t.length,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._textHasChanged()))}}_parseLineWordWrap(e="",t,i){const s=[],r=e.split(" ");let n=0;for(let a=0;a<r.length;a++){const o=a>0?e+" "+r[a]:r[0],l=i.measureText(o).width;if(l>t){a>0&&(n=i.measureText(e).width,s.push({text:e,width:n,lineEnding:" "})),e=r[a];let o="";e.split("").map((e=>{i.measureText(o+e).width>t&&(s.push({text:o,width:i.measureText(o).width,lineEnding:""}),o=""),o+=e})),e=o,n=i.measureText(e).width}else n=l,e=o}return s.push({text:e,width:n,lineEnding:" "}),s}_breakLines(e,t){const i=[],s=(this.text||this.placeholderText).split("\n");if(this.clipContent)for(const r of s)i.push(...this._parseLineWordWrap(r,e,t));else for(const e of s)i.push(this._parseLine(e,t));return i[i.length-1].lineEnding="\n",i}_parseLine(e="",t){return{text:e,width:t.measureText(e).width,lineEnding:" "}}_preMeasure(e,t){this._fontOffset&&!this._wasDirty||(this._fontOffset=Xl._GetFontOffset(t.font,this._host.getScene()?.getEngine()));let i=this._beforeRenderText(this._textWrapper).text;!this.text&&this._placeholderText&&(i=this._placeholderText),this._textWidth=t.measureText(i).width;const s=2*this._margin.getValueInPixel(this._host,e.width);if(this._autoStretchWidth){const r=i.split("\n").reduce(((e,i)=>t.measureText(i).width>t.measureText(e).width?i:e),""),n=t.measureText(r).width;this.width=Math.min(this._maxWidth.getValueInPixel(this._host,e.width),n+s)+"px",this.autoStretchWidth=!0}if(this._availableWidth=this._width.getValueInPixel(this._host,e.width)-s,this._lines=this._breakLines(this._availableWidth,t),this._contextForBreakLines=t,this._autoStretchHeight){const t=this._lines.length*this._fontOffset.height+2*this._margin.getValueInPixel(this._host,e.height);this.height=Math.min(this._maxHeight.getValueInPixel(this._host,e.height),t)+"px",this._autoStretchHeight=!0}if(this._availableHeight=this._height.getValueInPixel(this._host,e.height)-s,this._isFocused){this._cursorInfo.currentLineIndex=0;let e=this._lines[this._cursorInfo.currentLineIndex].text.length+this._lines[this._cursorInfo.currentLineIndex].lineEnding.length,t=0;for(;t+e<=this._cursorInfo.globalStartIndex;)t+=e,this._cursorInfo.currentLineIndex<this._lines.length-1&&(this._cursorInfo.currentLineIndex++,e=this._lines[this._cursorInfo.currentLineIndex].text.length+this._lines[this._cursorInfo.currentLineIndex].lineEnding.length)}}_textHasChanged(){!this._prevText&&this._textWrapper.text&&this.placeholderText&&(this._cursorInfo.currentLineIndex=0,this._cursorInfo.globalStartIndex=1,this._cursorInfo.globalEndIndex=1,this._cursorInfo.relativeStartIndex=1,this._cursorInfo.relativeEndIndex=1),super._textHasChanged()}_computeScroll(){if(this._clipTextLeft=this._currentMeasure.left+this._margin.getValueInPixel(this._host,this._cachedParentMeasure.width),this._clipTextTop=this._currentMeasure.top+this._margin.getValueInPixel(this._host,this._cachedParentMeasure.height),this._isFocused&&this._lines[this._cursorInfo.currentLineIndex].width>this._availableWidth){const e=this._clipTextLeft-this._lines[this._cursorInfo.currentLineIndex].width+this._availableWidth;this._scrollLeft||(this._scrollLeft=e)}else this._scrollLeft=this._clipTextLeft;if(this._isFocused){const e=(this._cursorInfo.currentLineIndex+1)*this._fontOffset.height,t=this._clipTextTop-e;this._scrollTop||(this._scrollTop=t)}else this._scrollTop=this._clipTextTop}_additionalProcessing(){this.highlightedText="",this.onLinesReadyObservable.notifyObservers(this)}_drawText(e,t,i,s){const r=this._currentMeasure.width;let n=this._scrollLeft;switch(this._textHorizontalAlignment){case Xl.HORIZONTAL_ALIGNMENT_LEFT:n+=0;break;case Xl.HORIZONTAL_ALIGNMENT_RIGHT:n+=r-t;break;case Xl.HORIZONTAL_ALIGNMENT_CENTER:n+=(r-t)/2}(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(s.shadowColor=this.shadowColor,s.shadowBlur=this.shadowBlur,s.shadowOffsetX=this.shadowOffsetX,s.shadowOffsetY=this.shadowOffsetY),this.outlineWidth&&s.strokeText(e,this._currentMeasure.left+n,i),s.fillText(e,n,i)}_onCopyText(e){this._isTextHighlightOn=!1;try{e.clipboardData&&e.clipboardData.setData("text/plain",this._highlightedText)}catch{}this._host.clipboardData=this._highlightedText}_onCutText(e){if(this._highlightedText){try{e.clipboardData&&e.clipboardData.setData("text/plain",this._highlightedText)}catch{}this._host.clipboardData=this._highlightedText,this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex),this._textHasChanged()}}_onPasteText(e){let t="";t=e.clipboardData&&-1!==e.clipboardData.types.indexOf("text/plain")?e.clipboardData.getData("text/plain"):this._host.clipboardData,this._isTextHighlightOn=!1,this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex,t);const i=t.length-(this._cursorInfo.globalEndIndex-this._cursorInfo.globalStartIndex);this._cursorInfo.globalStartIndex+=i,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._textHasChanged()}_draw(e){this._computeScroll(),this._scrollLeft=this._scrollLeft??0,this._scrollTop=this._scrollTop??0,e.save(),this._applyStates(e),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._isFocused?this._focusedBackground&&(e.fillStyle=this._isEnabled?this._focusedBackground:this._disabledColor,e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)):this._background&&(e.fillStyle=this._isEnabled?this._background:this._disabledColor,e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this.color&&(e.fillStyle=this.color);const t=this._currentMeasure.height,i=this._currentMeasure.width;let s=0;switch(this._textVerticalAlignment){case Xl.VERTICAL_ALIGNMENT_TOP:s=this._fontOffset.ascent;break;case Xl.VERTICAL_ALIGNMENT_BOTTOM:s=t-this._fontOffset.height*(this._lines.length-1)-this._fontOffset.descent;break;case Xl.VERTICAL_ALIGNMENT_CENTER:s=this._fontOffset.ascent+(t-this._fontOffset.height*this._lines.length)/2}e.save(),e.beginPath(),e.fillStyle=this.fontStyle,!this._textWrapper.text&&this.placeholderText&&(e.fillStyle=this._placeholderColor),e.rect(this._clipTextLeft,this._clipTextTop,this._availableWidth+2,this._availableHeight+2),e.clip(),s+=this._scrollTop;for(let t=0;t<this._lines.length;t++){const i=this._lines[t];0!==t&&0!==this._lineSpacing.internalValue&&(this._lineSpacing.isPixel?s+=this._lineSpacing.getValue(this._host):s+=this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height)),this._drawText(i.text,i.width,s,e),s+=this._fontOffset.height}if(e.restore(),this._isFocused){if(!this._blinkIsEven||this._isTextHighlightOn){let t=this._scrollLeft+e.measureText(this._lines[this._cursorInfo.currentLineIndex].text.substr(0,this._cursorInfo.relativeStartIndex)).width;t<this._clipTextLeft?(this._scrollLeft+=this._clipTextLeft-t,t=this._clipTextLeft,this._markAsDirty()):t>this._clipTextLeft+this._availableWidth&&(this._scrollLeft+=this._clipTextLeft+this._availableWidth-t,t=this._clipTextLeft+this._availableWidth,this._markAsDirty());let i=this._scrollTop+this._cursorInfo.currentLineIndex*this._fontOffset.height;i<this._clipTextTop?(this._scrollTop+=this._clipTextTop-i,i=this._clipTextTop,this._markAsDirty()):i+this._fontOffset.height>this._clipTextTop+this._availableHeight&&(this._scrollTop+=this._clipTextTop+this._availableHeight-i-this._fontOffset.height,i=this._clipTextTop+this._availableHeight-this._fontOffset.height,this._markAsDirty()),this._isTextHighlightOn||e.fillRect(t,i,2,this._fontOffset.height)}if(this._resetBlinking(),this._isTextHighlightOn){clearTimeout(this._blinkTimeout),this._highlightedText=this.text.substring(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex),e.globalAlpha=this._highligherOpacity,e.fillStyle=this._textHighlightColor;const t=Math.min(this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialLineIndex),s=Math.max(this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialLineIndex);let r=this._scrollTop+t*this._fontOffset.height;for(let n=t;n<=s;n++){const a=this._lines[n];let o=this._scrollLeft;switch(this._textHorizontalAlignment){case Xl.HORIZONTAL_ALIGNMENT_LEFT:o+=0;break;case Xl.HORIZONTAL_ALIGNMENT_RIGHT:o+=i-a.width;break;case Xl.HORIZONTAL_ALIGNMENT_CENTER:o+=(i-a.width)/2}const l=n===t?this._cursorInfo.relativeStartIndex:0,h=n===s?this._cursorInfo.relativeEndIndex:a.text.length,c=e.measureText(a.text.substr(0,l)).width,u=a.text.substring(l,h),d=e.measureText(u).width;e.fillRect(o+c,r,d,this._fontOffset.height),r+=this._fontOffset.height}this._cursorInfo.globalEndIndex===this._cursorInfo.globalStartIndex&&this._resetBlinking()}}e.restore(),this._thickness&&(this._isFocused?this.focusedColor&&(e.strokeStyle=this.focusedColor):this.color&&(e.strokeStyle=this.color),e.lineWidth=this._thickness,e.strokeRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,this._currentMeasure.width-this._thickness,this._currentMeasure.height-this._thickness))}_resetBlinking(){clearTimeout(this._blinkTimeout),this._blinkTimeout=setTimeout((()=>{this._blinkIsEven=!this._blinkIsEven,this._markAsDirty()}),500)}_onPointerDown(e,t,i,s,r){return!(!super._onPointerDown(e,t,i,s,r)||!this.isReadOnly&&(this._clickedCoordinateX=t.x,this._clickedCoordinateY=t.y,this._isTextHighlightOn=!1,this._highlightedText="",this._isPointerDown=!0,this._host._capturingControl[i]=this,this._host.focusedControl===this?(clearTimeout(this._blinkTimeout),this._markAsDirty(),0):!this._isEnabled||(this._host.focusedControl=this,0)))}_onPointerMove(e,t,i,s){0===s.event.movementX&&0===s.event.movementY||(this._host.focusedControl===this&&this._isPointerDown&&!this.isReadOnly&&(this._clickedCoordinateX=t.x,this._clickedCoordinateY=t.y,this._isTextHighlightOn||(this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this._highlightCursorInfo.initialRelativeStartIndex=this._cursorInfo.relativeStartIndex,this._isTextHighlightOn=!0),this._markAsDirty()),super._onPointerMove(e,t,i,s))}_updateCursorPosition(){if(this._isFocused)if(!this._textWrapper.text&&this.placeholderText)this._cursorInfo.currentLineIndex=0,this._cursorInfo.globalStartIndex=0,this._cursorInfo.globalEndIndex=0,this._cursorInfo.relativeStartIndex=0,this._cursorInfo.relativeEndIndex=0;else if(this._clickedCoordinateX&&this._clickedCoordinateY){this._isTextHighlightOn||(this._cursorInfo={globalStartIndex:0,globalEndIndex:0,relativeStartIndex:0,relativeEndIndex:0,currentLineIndex:0});let e=0,t=0;const i=this._clickedCoordinateY-this._scrollTop,s=Math.floor(i/this._fontOffset.height);this._cursorInfo.currentLineIndex=Math.min(Math.max(s,0),this._lines.length-1);let r=0;const n=this._clickedCoordinateX-(this._scrollLeft??0);let a=0;for(let t=0;t<this._cursorInfo.currentLineIndex;t++){const i=this._lines[t];e+=i.text.length+i.lineEnding.length}for(;r<n&&this._lines[this._cursorInfo.currentLineIndex].text.length>t;)t++,a=Math.abs(n-r),r=this._contextForBreakLines.measureText(this._lines[this._cursorInfo.currentLineIndex].text.substr(0,t)).width;Math.abs(n-r)>a&&t>0&&t--,e+=t,this._isTextHighlightOn?e<this._highlightCursorInfo.initialStartIndex?(this._cursorInfo.globalStartIndex=e,this._cursorInfo.relativeStartIndex=t,this._cursorInfo.globalEndIndex=this._highlightCursorInfo.initialStartIndex,this._cursorInfo.relativeEndIndex=this._highlightCursorInfo.initialRelativeStartIndex):(this._cursorInfo.globalStartIndex=this._highlightCursorInfo.initialStartIndex,this._cursorInfo.relativeStartIndex=this._highlightCursorInfo.initialRelativeStartIndex,this._cursorInfo.globalEndIndex=e,this._cursorInfo.relativeEndIndex=t):(this._cursorInfo.globalStartIndex=e,this._cursorInfo.relativeStartIndex=t,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._cursorInfo.relativeEndIndex=this._cursorInfo.relativeStartIndex),this._blinkIsEven=this._isTextHighlightOn,this._clickedCoordinateX=null,this._clickedCoordinateY=null}else{this._cursorInfo.relativeStartIndex=0,this._cursorInfo.currentLineIndex=0;let e=this._lines[this._cursorInfo.currentLineIndex].text.length+this._lines[this._cursorInfo.currentLineIndex].lineEnding.length,t=0;for(;t+e<=this._cursorInfo.globalStartIndex;)t+=e,this._cursorInfo.currentLineIndex<this._lines.length-1&&(this._cursorInfo.currentLineIndex++,e=this._lines[this._cursorInfo.currentLineIndex].text.length+this._lines[this._cursorInfo.currentLineIndex].lineEnding.length);if(this._cursorInfo.relativeStartIndex=this._cursorInfo.globalStartIndex-t,-1!==this._highlightCursorInfo.initialStartIndex&&this._cursorInfo.globalStartIndex>=this._highlightCursorInfo.initialStartIndex){for(;t+e<=this._cursorInfo.globalEndIndex;)t+=e,this._cursorInfo.currentLineIndex<this._lines.length-1&&(this._cursorInfo.currentLineIndex++,e=this._lines[this._cursorInfo.currentLineIndex].text.length+this._lines[this._cursorInfo.currentLineIndex].lineEnding.length);this._cursorInfo.relativeEndIndex=this._cursorInfo.globalEndIndex-t}else this._isTextHighlightOn||(this._cursorInfo.relativeEndIndex=this._cursorInfo.relativeStartIndex,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex)}}_updateValueFromCursorIndex(e){}_processDblClick(e){let t,i;do{t=this._cursorInfo.globalStartIndex>0&&this._textWrapper.isWord(this._cursorInfo.globalStartIndex-1)?--this._cursorInfo.globalStartIndex:0,i=this._cursorInfo.globalEndIndex<this._textWrapper.length&&this._textWrapper.isWord(this._cursorInfo.globalEndIndex)?++this._cursorInfo.globalEndIndex:0}while(t||i);this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this.onTextHighlightObservable.notifyObservers(this),this._isTextHighlightOn=!0,this._blinkIsEven=!0,this._markAsDirty()}_selectAllText(){this._isTextHighlightOn=!0,this._blinkIsEven=!0,this._highlightCursorInfo={initialStartIndex:0,initialRelativeStartIndex:0,initialLineIndex:0},this._cursorInfo={globalStartIndex:0,globalEndIndex:this._textWrapper.length,relativeEndIndex:this._lines[this._lines.length-1].text.length,relativeStartIndex:0,currentLineIndex:this._lines.length-1},this._markAsDirty()}dispose(){super.dispose(),this.onLinesReadyObservable.clear()}}(0,w.Cg)([(0,D.lK)()],oh.prototype,"autoStretchHeight",null),(0,w.Cg)([(0,D.lK)()],oh.prototype,"maxHeight",null),(0,V.Y5)("BABYLON.GUI.InputTextArea",oh),(0,V.Y5)("BABYLON.GUI.InputPassword",class extends sh{_getTypeName(){return"InputPassword"}_beforeRenderText(e){const t=new ih;let i="";for(let t=0;t<e.length;t++)i+="•";return t.text=i,t}});class lh extends Xl{get dash(){return this._dash}set dash(e){this._dash!==e&&(this._dash=e,this._markAsDirty())}get connectedControl(){return this._connectedControl}set connectedControl(e){this._connectedControl!==e&&(this._connectedControlDirtyObserver&&this._connectedControl&&(this._connectedControl.onDirtyObservable.remove(this._connectedControlDirtyObserver),this._connectedControlDirtyObserver=null),e&&(this._connectedControlDirtyObserver=e.onDirtyObservable.add((()=>this._markAsDirty()))),this._connectedControl=e,this._markAsDirty())}get x1(){return this._x1.toString(this._host)}set x1(e){this._x1.toString(this._host)!==e&&this._x1.fromString(e)&&this._markAsDirty()}get y1(){return this._y1.toString(this._host)}set y1(e){this._y1.toString(this._host)!==e&&this._y1.fromString(e)&&this._markAsDirty()}get x2(){return this._x2.toString(this._host)}set x2(e){this._x2.toString(this._host)!==e&&this._x2.fromString(e)&&this._markAsDirty()}get y2(){return this._y2.toString(this._host)}set y2(e){this._y2.toString(this._host)!==e&&this._y2.fromString(e)&&this._markAsDirty()}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth!==e&&(this._lineWidth=e,this._markAsDirty())}set horizontalAlignment(e){}set verticalAlignment(e){}get _effectiveX2(){return(this._connectedControl?this._connectedControl.centerX:0)+this._x2.getValue(this._host)}get _effectiveY2(){return(this._connectedControl?this._connectedControl.centerY:0)+this._y2.getValue(this._host)}constructor(e){super(e),this.name=e,this._lineWidth=1,this._x1=new Ll(0),this._y1=new Ll(0),this._x2=new Ll(0),this._y2=new Ll(0),this._dash=new Array,this._automaticSize=!0,this.isHitTestVisible=!1,this._horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,this._verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP}_getTypeName(){return"Line"}_draw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._applyStates(e),e.strokeStyle=this._getColor(e),e.lineWidth=this._lineWidth,e.setLineDash(this._dash),e.beginPath(),e.moveTo(this._cachedParentMeasure.left+this._x1.getValue(this._host),this._cachedParentMeasure.top+this._y1.getValue(this._host)),e.lineTo(this._cachedParentMeasure.left+this._effectiveX2,this._cachedParentMeasure.top+this._effectiveY2),e.stroke(),e.restore()}_measure(){this._currentMeasure.width=Math.abs(this._x1.getValue(this._host)-this._effectiveX2)+this._lineWidth,this._currentMeasure.height=Math.abs(this._y1.getValue(this._host)-this._effectiveY2)+this._lineWidth}_computeAlignment(e){this._currentMeasure.left=e.left+Math.min(this._x1.getValue(this._host),this._effectiveX2)-this._lineWidth/2,this._currentMeasure.top=e.top+Math.min(this._y1.getValue(this._host),this._effectiveY2)-this._lineWidth/2}moveToVector3(e,t,i=!1){if(!this._host||this.parent!==this._host._rootContainer)return void ee.S0.Error("Cannot move a control to a vector3 if the control is not at root level");const s=this._host._getGlobalViewport(),r=I.Pq.Project(e,I.uq.IdentityReadOnly,t.getTransformMatrix(),s);this._moveToProjectedPosition(r,i),r.z<0||r.z>1?this.notRenderable=!0:this.notRenderable=!1}_moveToProjectedPosition(e,t=!1){const i=e.x+this._linkOffsetX.getValue(this._host)+"px",s=e.y+this._linkOffsetY.getValue(this._host)+"px";t?(this.x2=i,this.y2=s,this._x2.ignoreAdaptiveScaling=!0,this._y2.ignoreAdaptiveScaling=!0):(this.x1=i,this.y1=s,this._x1.ignoreAdaptiveScaling=!0,this._y1.ignoreAdaptiveScaling=!0)}}(0,w.Cg)([(0,D.lK)()],lh.prototype,"dash",null),(0,w.Cg)([(0,D.lK)()],lh.prototype,"x1",null),(0,w.Cg)([(0,D.lK)()],lh.prototype,"y1",null),(0,w.Cg)([(0,D.lK)()],lh.prototype,"x2",null),(0,w.Cg)([(0,D.lK)()],lh.prototype,"y2",null),(0,w.Cg)([(0,D.lK)()],lh.prototype,"lineWidth",null),(0,V.Y5)("BABYLON.GUI.Line",lh);class hh{constructor(e){this._multiLine=e,this._x=new Ll(0),this._y=new Ll(0),this._point=new I.Pq(0,0,0)}get x(){return this._x.toString(this._multiLine._host)}set x(e){this._x.toString(this._multiLine._host)!==e&&this._x.fromString(e)&&this._multiLine._markAsDirty()}get y(){return this._y.toString(this._multiLine._host)}set y(e){this._y.toString(this._multiLine._host)!==e&&this._y.fromString(e)&&this._multiLine._markAsDirty()}get control(){return this._control}set control(e){this._control!==e&&(this._control&&this._controlObserver&&(this._control.onDirtyObservable.remove(this._controlObserver),this._controlObserver=null),this._control=e,this._control&&(this._controlObserver=this._control.onDirtyObservable.add(this._multiLine.onPointUpdate)),this._multiLine._markAsDirty())}get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh&&this._meshObserver&&this._mesh.getScene().onAfterCameraRenderObservable.remove(this._meshObserver),this._mesh=e,this._mesh&&(this._meshObserver=this._mesh.getScene().onAfterCameraRenderObservable.add(this._multiLine.onPointUpdate)),this._multiLine._markAsDirty())}resetLinks(){this.control=null,this.mesh=null}translate(){return this._point=this._translatePoint(),this._point}_translatePoint(){if(null!=this._mesh)return this._multiLine._host.getProjectedPositionWithZ(this._mesh.getBoundingInfo().boundingSphere.center,this._mesh.getWorldMatrix());if(null!=this._control)return new I.Pq(this._control.centerX,this._control.centerY,1-ft.bH);{const e=this._multiLine._host,t=this._x.getValueInPixel(e,Number(e._canvas.width)),i=this._y.getValueInPixel(e,Number(e._canvas.height));return new I.Pq(t,i,1-ft.bH)}}dispose(){this.resetLinks()}}class ch extends Xl{constructor(e){super(e),this.name=e,this._lineWidth=1,this.onPointUpdate=()=>{this._markAsDirty()},this._automaticSize=!0,this.isHitTestVisible=!1,this._horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,this._verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,this._dash=[],this._points=[]}get dash(){return this._dash}set dash(e){this._dash!==e&&(this._dash=e,this._markAsDirty())}getAt(e){return this._points[e]||(this._points[e]=new hh(this)),this._points[e]}add(...e){return e.map((e=>this.push(e)))}push(e){const t=this.getAt(this._points.length);return null==e||(e instanceof bt?t.mesh=e:e instanceof Xl?t.control=e:null!=e.x&&null!=e.y&&(t.x=e.x,t.y=e.y)),t}remove(e){let t;if(e instanceof hh){if(t=this._points.indexOf(e),-1===t)return}else t=e;const i=this._points[t];i&&(i.dispose(),this._points.splice(t,1))}reset(){for(;this._points.length>0;)this.remove(this._points.length-1)}resetLinks(){this._points.forEach((e=>{null!=e&&e.resetLinks()}))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth!==e&&(this._lineWidth=e,this._markAsDirty())}set horizontalAlignment(e){}set verticalAlignment(e){}_getTypeName(){return"MultiLine"}_draw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._applyStates(e),e.strokeStyle=this.color,e.lineWidth=this._lineWidth,e.setLineDash(this._dash),e.beginPath();let t,i=!0;this._points.forEach((s=>{s&&(i?(e.moveTo(s._point.x,s._point.y),i=!1):s._point.z<1&&t.z<1?e.lineTo(s._point.x,s._point.y):e.moveTo(s._point.x,s._point.y),t=s._point)})),e.stroke(),e.restore()}_additionalProcessing(){this._minX=null,this._minY=null,this._maxX=null,this._maxY=null,this._points.forEach((e=>{e&&(e.translate(),(null==this._minX||e._point.x<this._minX)&&(this._minX=e._point.x),(null==this._minY||e._point.y<this._minY)&&(this._minY=e._point.y),(null==this._maxX||e._point.x>this._maxX)&&(this._maxX=e._point.x),(null==this._maxY||e._point.y>this._maxY)&&(this._maxY=e._point.y))})),null==this._minX&&(this._minX=0),null==this._minY&&(this._minY=0),null==this._maxX&&(this._maxX=0),null==this._maxY&&(this._maxY=0)}_measure(){null!=this._minX&&null!=this._maxX&&null!=this._minY&&null!=this._maxY&&(this._currentMeasure.width=Math.abs(this._maxX-this._minX)+this._lineWidth,this._currentMeasure.height=Math.abs(this._maxY-this._minY)+this._lineWidth)}_computeAlignment(){null!=this._minX&&null!=this._minY&&(this._currentMeasure.left=this._minX-this._lineWidth/2,this._currentMeasure.top=this._minY-this._lineWidth/2)}dispose(){this.reset(),super.dispose()}}(0,w.Cg)([(0,D.lK)()],ch.prototype,"dash",null),(0,V.Y5)("BABYLON.GUI.MultiLine",ch);class uh extends Xl{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get checkSizeRatio(){return this._checkSizeRatio}set checkSizeRatio(e){e=Math.max(Math.min(1,e),0),this._checkSizeRatio!==e&&(this._checkSizeRatio=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get isChecked(){return this._isChecked}set isChecked(e){this._isChecked!==e&&(this._isChecked=e,this._markAsDirty(),this.onIsCheckedChangedObservable.notifyObservers(e),this._isChecked&&this._host&&this._host.executeOnAllControls((e=>{if(e===this)return;if(void 0===e.group)return;const t=e;t.group===this.group&&(t.isChecked=!1)})))}constructor(e){super(e),this.name=e,this._isChecked=!1,this._background="black",this._checkSizeRatio=.8,this._thickness=1,this.group="",this.onIsCheckedChangedObservable=new C.cP,this.isPointerBlocker=!0}_getTypeName(){return"RadioButton"}_draw(e){e.save(),this._applyStates(e);const t=this._currentMeasure.width-this._thickness,i=this._currentMeasure.height-this._thickness;if((this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),Xl.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2-this._thickness/2,this._currentMeasure.height/2-this._thickness/2,1,e),e.fillStyle=this._isEnabled?this._background:this._disabledColor,e.fill(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),e.strokeStyle=this.color,e.lineWidth=this._thickness,e.stroke(),this._isChecked){e.fillStyle=this._isEnabled?this.color:this._disabledColor;const s=t*this._checkSizeRatio,r=i*this._checkSizeRatio;Xl.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,s/2-this._thickness/2,r/2-this._thickness/2,1,e),e.fill()}e.restore()}_onPointerDown(e,t,i,s,r){return!!super._onPointerDown(e,t,i,s,r)&&(this.isReadOnly||this.isChecked||(this.isChecked=!0),!0)}static AddRadioButtonWithHeader(e,t,i,s){const r=new Zl;r.isVertical=!1,r.height="30px";const n=new uh;n.width="20px",n.height="20px",n.isChecked=i,n.color="green",n.group=t,n.onIsCheckedChangedObservable.add((e=>s(n,e))),r.addControl(n);const a=new ql;return a.text=e,a.width="180px",a.paddingLeft="5px",a.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,a.color="white",r.addControl(a),r}}(0,w.Cg)([(0,D.lK)()],uh.prototype,"thickness",null),(0,w.Cg)([(0,D.lK)()],uh.prototype,"group",void 0),(0,w.Cg)([(0,D.lK)()],uh.prototype,"checkSizeRatio",null),(0,w.Cg)([(0,D.lK)()],uh.prototype,"background",null),(0,w.Cg)([(0,D.lK)()],uh.prototype,"isChecked",null),(0,V.Y5)("BABYLON.GUI.RadioButton",uh);class dh extends Xl{get displayThumb(){return this._displayThumb}set displayThumb(e){this._displayThumb!==e&&(this._displayThumb=e,this._markAsDirty())}get step(){return this._step}set step(e){this._step!==e&&(this._step=e,this._markAsDirty())}get barOffset(){return this._barOffset.toString(this._host)}get barOffsetInPixels(){return this._barOffset.getValueInPixel(this._host,this._cachedParentMeasure.width)}set barOffset(e){this._barOffset.toString(this._host)!==e&&this._barOffset.fromString(e)&&this._markAsDirty()}get thumbWidth(){return this._thumbWidth.toString(this._host)}get thumbWidthInPixels(){return this._thumbWidth.getValueInPixel(this._host,this._cachedParentMeasure.width)}set thumbWidth(e){this._thumbWidth.toString(this._host)!==e&&this._thumbWidth.fromString(e)&&this._markAsDirty()}get minimum(){return this._minimum}set minimum(e){this._minimum!==e&&(this._minimum=e,this._markAsDirty(),this.value=Math.max(Math.min(this.value,this._maximum),this._minimum))}get maximum(){return this._maximum}set maximum(e){this._maximum!==e&&(this._maximum=e,this._markAsDirty(),this.value=Math.max(Math.min(this.value,this._maximum),this._minimum))}get value(){return this._value}set value(e){e=Math.max(Math.min(e,this._maximum),this._minimum),this._value!==e&&(this._value=e,this._markAsDirty(),this.onValueChangedObservable.notifyObservers(this._value))}get isVertical(){return this._isVertical}set isVertical(e){this._isVertical!==e&&(this._isVertical=e,this._markAsDirty())}get isThumbClamped(){return this._isThumbClamped}set isThumbClamped(e){this._isThumbClamped!==e&&(this._isThumbClamped=e,this._markAsDirty())}constructor(e){super(e),this.name=e,this._thumbWidth=new Ll(20,Ll.UNITMODE_PIXEL,!1),this._minimum=0,this._maximum=100,this._value=50,this._isVertical=!1,this._barOffset=new Ll(5,Ll.UNITMODE_PIXEL,!1),this._isThumbClamped=!1,this._displayThumb=!0,this._step=0,this._lastPointerDownId=-1,this._effectiveBarOffset=0,this.onValueChangedObservable=new C.cP,this._pointerIsDown=!1,this.isPointerBlocker=!0}_getTypeName(){return"BaseSlider"}_getThumbPosition(){return this.isVertical?(this.maximum-this.value)/(this.maximum-this.minimum)*this._backgroundBoxLength:(this.value-this.minimum)/(this.maximum-this.minimum)*this._backgroundBoxLength}_getThumbThickness(e){let t=0;switch(e){case"circle":t=this._thumbWidth.isPixel?Math.max(this._thumbWidth.getValue(this._host),this._backgroundBoxThickness):this._backgroundBoxThickness*this._thumbWidth.getValue(this._host);break;case"rectangle":t=this._thumbWidth.isPixel?Math.min(this._thumbWidth.getValue(this._host),this._backgroundBoxThickness):this._backgroundBoxThickness*this._thumbWidth.getValue(this._host)}return t}_prepareRenderingData(e){this._effectiveBarOffset=0,this._renderLeft=this._currentMeasure.left,this._renderTop=this._currentMeasure.top,this._renderWidth=this._currentMeasure.width,this._renderHeight=this._currentMeasure.height,this._backgroundBoxLength=Math.max(this._currentMeasure.width,this._currentMeasure.height),this._backgroundBoxThickness=Math.min(this._currentMeasure.width,this._currentMeasure.height),this._effectiveThumbThickness=this._getThumbThickness(e),this.displayThumb&&(this._backgroundBoxLength-=this._effectiveThumbThickness),this.isVertical&&this._currentMeasure.height<this._currentMeasure.width?l.V.Error("Height should be greater than width"):(this._barOffset.isPixel?this._effectiveBarOffset=Math.min(this._barOffset.getValue(this._host),this._backgroundBoxThickness):this._effectiveBarOffset=this._backgroundBoxThickness*this._barOffset.getValue(this._host),this._backgroundBoxThickness-=2*this._effectiveBarOffset,this.isVertical?(this._renderLeft+=this._effectiveBarOffset,!this.isThumbClamped&&this.displayThumb&&(this._renderTop+=this._effectiveThumbThickness/2),this._renderHeight=this._backgroundBoxLength,this._renderWidth=this._backgroundBoxThickness):(this._renderTop+=this._effectiveBarOffset,!this.isThumbClamped&&this.displayThumb&&(this._renderLeft+=this._effectiveThumbThickness/2),this._renderHeight=this._backgroundBoxThickness,this._renderWidth=this._backgroundBoxLength))}_updateValueFromPointer(e,t){let i;0!=this.rotation&&(this._invertTransformMatrix.transformCoordinates(e,t,this._transformedPosition),e=this._transformedPosition.x,t=this._transformedPosition.y),i=this._isVertical?this._minimum+(1-(t-this._currentMeasure.top)/this._currentMeasure.height)*(this._maximum-this._minimum):this._minimum+(e-this._currentMeasure.left)/this._currentMeasure.width*(this._maximum-this._minimum),this.value=this._step?Math.round(i/this._step)*this._step:i}_onPointerDown(e,t,i,s,r){return!!super._onPointerDown(e,t,i,s,r)&&(this.isReadOnly||(this._pointerIsDown=!0,this._updateValueFromPointer(t.x,t.y),this._host._capturingControl[i]=this,this._lastPointerDownId=i),!0)}_onPointerMove(e,t,i,s){i==this._lastPointerDownId&&(this._pointerIsDown&&!this.isReadOnly&&this._updateValueFromPointer(t.x,t.y),super._onPointerMove(e,t,i,s))}_onPointerUp(e,t,i,s,r){this._pointerIsDown=!1,delete this._host._capturingControl[i],super._onPointerUp(e,t,i,s,r)}_onCanvasBlur(){this._forcePointerUp(),super._onCanvasBlur()}}(0,w.Cg)([(0,D.lK)()],dh.prototype,"displayThumb",null),(0,w.Cg)([(0,D.lK)()],dh.prototype,"step",null),(0,w.Cg)([(0,D.lK)()],dh.prototype,"barOffset",null),(0,w.Cg)([(0,D.lK)()],dh.prototype,"thumbWidth",null),(0,w.Cg)([(0,D.lK)()],dh.prototype,"minimum",null),(0,w.Cg)([(0,D.lK)()],dh.prototype,"maximum",null),(0,w.Cg)([(0,D.lK)()],dh.prototype,"value",null),(0,w.Cg)([(0,D.lK)()],dh.prototype,"isVertical",null),(0,w.Cg)([(0,D.lK)()],dh.prototype,"isThumbClamped",null);class _h extends dh{get displayValueBar(){return this._displayValueBar}set displayValueBar(e){this._displayValueBar!==e&&(this._displayValueBar=e,this._markAsDirty())}get borderColor(){return this._borderColor}set borderColor(e){this._borderColor!==e&&(this._borderColor=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get backgroundGradient(){return this._backgroundGradient}set backgroundGradient(e){this._backgroundGradient!==e&&(this._backgroundGradient=e,this._markAsDirty())}get thumbColor(){return this._thumbColor}set thumbColor(e){this._thumbColor!==e&&(this._thumbColor=e,this._markAsDirty())}get isThumbCircle(){return this._isThumbCircle}set isThumbCircle(e){this._isThumbCircle!==e&&(this._isThumbCircle=e,this._markAsDirty())}constructor(e){super(e),this.name=e,this._background="black",this._borderColor="white",this._thumbColor="",this._isThumbCircle=!1,this._displayValueBar=!0,this._backgroundGradient=null}_getTypeName(){return"Slider"}_getBackgroundColor(e){return this._backgroundGradient?this._backgroundGradient.getCanvasGradient(e):this._background}_draw(e){e.save(),this._applyStates(e),this._prepareRenderingData(this.isThumbCircle?"circle":"rectangle");let t=this._renderLeft,i=this._renderTop;const s=this._renderWidth,r=this._renderHeight;let n=0;this.isThumbClamped&&this.isThumbCircle?(this.isVertical?i+=this._effectiveThumbThickness/2:t+=this._effectiveThumbThickness/2,n=this._backgroundBoxThickness/2):n=(this._effectiveThumbThickness-this._effectiveBarOffset)/2,(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY);const a=this._getThumbPosition();e.fillStyle=this._getBackgroundColor(e),this.isVertical?this.isThumbClamped?this.isThumbCircle?(e.beginPath(),e.arc(t+this._backgroundBoxThickness/2,i,n,Math.PI,2*Math.PI),e.fill(),e.fillRect(t,i,s,r)):e.fillRect(t,i,s,r+this._effectiveThumbThickness):e.fillRect(t,i,s,r):this.isThumbClamped?this.isThumbCircle?(e.beginPath(),e.arc(t+this._backgroundBoxLength,i+this._backgroundBoxThickness/2,n,0,2*Math.PI),e.fill(),e.fillRect(t,i,s,r)):e.fillRect(t,i,s+this._effectiveThumbThickness,r):e.fillRect(t,i,s,r),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),e.fillStyle=this._getColor(e),this._displayValueBar&&(this.isVertical?this.isThumbClamped?this.isThumbCircle?(e.beginPath(),e.arc(t+this._backgroundBoxThickness/2,i+this._backgroundBoxLength,n,0,2*Math.PI),e.fill(),e.fillRect(t,i+a,s,r-a)):e.fillRect(t,i+a,s,r-a+this._effectiveThumbThickness):e.fillRect(t,i+a,s,r-a):this.isThumbClamped&&this.isThumbCircle?(e.beginPath(),e.arc(t,i+this._backgroundBoxThickness/2,n,0,2*Math.PI),e.fill(),e.fillRect(t,i,a,r)):e.fillRect(t,i,a,r)),e.fillStyle=this._thumbColor||this._getColor(e),this.displayThumb&&((this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._isThumbCircle?(e.beginPath(),this.isVertical?e.arc(t+this._backgroundBoxThickness/2,i+a,n,0,2*Math.PI):e.arc(t+a,i+this._backgroundBoxThickness/2,n,0,2*Math.PI),e.fill(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),e.strokeStyle=this._borderColor,e.stroke()):(this.isVertical?e.fillRect(t-this._effectiveBarOffset,this._currentMeasure.top+a,this._currentMeasure.width,this._effectiveThumbThickness):e.fillRect(this._currentMeasure.left+a,this._currentMeasure.top,this._effectiveThumbThickness,this._currentMeasure.height),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),e.strokeStyle=this._borderColor,this.isVertical?e.strokeRect(t-this._effectiveBarOffset,this._currentMeasure.top+a,this._currentMeasure.width,this._effectiveThumbThickness):e.strokeRect(this._currentMeasure.left+a,this._currentMeasure.top,this._effectiveThumbThickness,this._currentMeasure.height))),e.restore()}serialize(e){super.serialize(e),this.backgroundGradient&&(e.backgroundGradient={},this.backgroundGradient.serialize(e.backgroundGradient))}_parseFromContent(e,t){if(super._parseFromContent(e,t),e.backgroundGradient){const t=ee.S0.Instantiate("BABYLON.GUI."+e.backgroundGradient.className);this.backgroundGradient=new t,this.backgroundGradient.parse(e.backgroundGradient)}}}(0,w.Cg)([(0,D.lK)()],_h.prototype,"displayValueBar",null),(0,w.Cg)([(0,D.lK)()],_h.prototype,"borderColor",null),(0,w.Cg)([(0,D.lK)()],_h.prototype,"background",null),(0,w.Cg)([(0,D.lK)()],_h.prototype,"thumbColor",null),(0,w.Cg)([(0,D.lK)()],_h.prototype,"isThumbCircle",null),(0,V.Y5)("BABYLON.GUI.Slider",_h);class ph extends Kl{get freezeControls(){return this._freezeControls}set freezeControls(e){if(this._freezeControls===e)return;e||this._restoreMeasures(),this._freezeControls=!1;const t=this.host.getSize(),i=t.width,s=t.height,r=this.host.getContext(),n=new zl(0,0,i,s);this.host._numLayoutCalls=0,this.host._rootContainer._layout(n,r),e&&(this._updateMeasures(),this._useBuckets()&&this._makeBuckets()),this._freezeControls=e,this.host.markAsDirty()}get bucketWidth(){return this._bucketWidth}get bucketHeight(){return this._bucketHeight}setBucketSizes(e,t){this._bucketWidth=e,this._bucketHeight=t,this._useBuckets()?this._freezeControls&&this._makeBuckets():this._buckets={}}_useBuckets(){return this._bucketWidth>0&&this._bucketHeight>0}_makeBuckets(){this._buckets={},this._bucketLen=Math.ceil(this.widthInPixels/this._bucketWidth),this._dispatchInBuckets(this._children),this._oldLeft=null,this._oldTop=null}_dispatchInBuckets(e){for(let t=0;t<e.length;++t){const i=e[t],s=Math.max(0,Math.floor((i._customData._origLeft-this._customData.origLeft)/this._bucketWidth)),r=Math.floor((i._customData._origLeft-this._customData.origLeft+i._currentMeasure.width-1)/this._bucketWidth),n=Math.floor((i._customData._origTop-this._customData.origTop+i._currentMeasure.height-1)/this._bucketHeight);let a=Math.max(0,Math.floor((i._customData._origTop-this._customData.origTop)/this._bucketHeight));for(;a<=n;){for(let e=s;e<=r;++e){const t=a*this._bucketLen+e;let s=this._buckets[t];s||(s=[],this._buckets[t]=s),s.push(i)}a++}i instanceof Kl&&i._children.length>0&&this._dispatchInBuckets(i._children)}}_updateMeasures(){const e=0|this.leftInPixels,t=0|this.topInPixels;this._measureForChildren.left-=e,this._measureForChildren.top-=t,this._currentMeasure.left-=e,this._currentMeasure.top-=t,this._customData.origLeftForChildren=this._measureForChildren.left,this._customData.origTopForChildren=this._measureForChildren.top,this._customData.origLeft=this._currentMeasure.left,this._customData.origTop=this._currentMeasure.top,this._updateChildrenMeasures(this._children,e,t)}_updateChildrenMeasures(e,t,i){for(let s=0;s<e.length;++s){const r=e[s];r._currentMeasure.left-=t,r._currentMeasure.top-=i,r._customData._origLeft=r._currentMeasure.left,r._customData._origTop=r._currentMeasure.top,r instanceof Kl&&r._children.length>0&&this._updateChildrenMeasures(r._children,t,i)}}_restoreMeasures(){const e=0|this.leftInPixels,t=0|this.topInPixels;this._measureForChildren.left=this._customData.origLeftForChildren+e,this._measureForChildren.top=this._customData.origTopForChildren+t,this._currentMeasure.left=this._customData.origLeft+e,this._currentMeasure.top=this._customData.origTop+t}constructor(e){super(e),this._freezeControls=!1,this._bucketWidth=0,this._bucketHeight=0,this._buckets={}}_getTypeName(){return"ScrollViewerWindow"}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._parentMeasure=e,this._measureForChildren.left=this._currentMeasure.left,this._measureForChildren.top=this._currentMeasure.top,this._measureForChildren.width=e.width,this._measureForChildren.height=e.height}_layout(e,t){return this._freezeControls?(this.invalidateRect(),!1):super._layout(e,t)}_scrollChildren(e,t,i){for(let s=0;s<e.length;++s){const r=e[s];r._currentMeasure.left=r._customData._origLeft+t,r._currentMeasure.top=r._customData._origTop+i,r._isClipped=!1,r instanceof Kl&&r._children.length>0&&this._scrollChildren(r._children,t,i)}}_scrollChildrenWithBuckets(e,t,i,s){const r=Math.max(0,Math.floor(-e/this._bucketWidth)),n=Math.floor((-e+this._parentMeasure.width-1)/this._bucketWidth),a=Math.floor((-t+this._parentMeasure.height-1)/this._bucketHeight);let o=Math.max(0,Math.floor(-t/this._bucketHeight));for(;o<=a;){for(let e=r;e<=n;++e){const t=o*this._bucketLen+e,r=this._buckets[t];if(r)for(let e=0;e<r.length;++e){const t=r[e];t._currentMeasure.left=t._customData._origLeft+i,t._currentMeasure.top=t._customData._origTop+s,t._isClipped=!1}}o++}}_draw(e,t){if(!this._freezeControls)return void super._draw(e,t);this._localDraw(e),this.clipChildren&&this._clipForChildren(e);const i=0|this.leftInPixels,s=0|this.topInPixels;this._useBuckets()&&null!==this._oldLeft&&null!==this._oldTop?(this._scrollChildrenWithBuckets(this._oldLeft,this._oldTop,i,s),this._scrollChildrenWithBuckets(i,s,i,s)):this._scrollChildren(this._children,i,s),this._oldLeft=i,this._oldTop=s;for(const t of this._children)t._intersectsRect(this._parentMeasure)&&t._render(e,this._parentMeasure)}_postMeasure(){if(this._freezeControls)return void super._postMeasure();let e=this.parentClientWidth,t=this.parentClientHeight;for(const i of this.children)i.isVisible&&!i.notRenderable&&(i.horizontalAlignment===Xl.HORIZONTAL_ALIGNMENT_CENTER&&i._offsetLeft(this._currentMeasure.left-i._currentMeasure.left),i.verticalAlignment===Xl.VERTICAL_ALIGNMENT_CENTER&&i._offsetTop(this._currentMeasure.top-i._currentMeasure.top),e=Math.max(e,i._currentMeasure.left-this._currentMeasure.left+i._currentMeasure.width+i.paddingRightInPixels),t=Math.max(t,i._currentMeasure.top-this._currentMeasure.top+i._currentMeasure.height+i.paddingBottomInPixels));this._currentMeasure.width!==e&&(this._width.updateInPlace(e,Ll.UNITMODE_PIXEL),this._currentMeasure.width=e,this._rebuildLayout=!0,this._isDirty=!0),this._currentMeasure.height!==t&&(this._height.updateInPlace(t,Ll.UNITMODE_PIXEL),this._currentMeasure.height=t,this._rebuildLayout=!0,this._isDirty=!0),super._postMeasure()}}class fh extends dh{get borderColor(){return this._borderColor}set borderColor(e){this._borderColor!==e&&(this._borderColor=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get backgroundGradient(){return this._backgroundGradient}set backgroundGradient(e){this._backgroundGradient!==e&&(this._backgroundGradient=e,this._markAsDirty())}get invertScrollDirection(){return this._invertScrollDirection}set invertScrollDirection(e){this._invertScrollDirection=e}constructor(e){super(e),this.name=e,this._background="black",this._borderColor="white",this._tempMeasure=new zl(0,0,0,0),this._invertScrollDirection=!1,this._backgroundGradient=null}_getTypeName(){return"Scrollbar"}_getThumbThickness(){let e=0;return e=this._thumbWidth.isPixel?this._thumbWidth.getValue(this._host):this._backgroundBoxThickness*this._thumbWidth.getValue(this._host),e}_getBackgroundColor(e){return this._backgroundGradient?this._backgroundGradient.getCanvasGradient(e):this._background}_draw(e){e.save(),this._applyStates(e),this._prepareRenderingData("rectangle");const t=this._renderLeft,i=this._getThumbPosition();e.fillStyle=this._getBackgroundColor(e),e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height),e.fillStyle=this._getColor(e),this.isVertical?(this._tempMeasure.left=t-this._effectiveBarOffset,this._tempMeasure.top=this._currentMeasure.top+i,this._tempMeasure.width=this._currentMeasure.width,this._tempMeasure.height=this._effectiveThumbThickness):(this._tempMeasure.left=this._currentMeasure.left+i,this._tempMeasure.top=this._currentMeasure.top,this._tempMeasure.width=this._effectiveThumbThickness,this._tempMeasure.height=this._currentMeasure.height),e.fillRect(this._tempMeasure.left,this._tempMeasure.top,this._tempMeasure.width,this._tempMeasure.height),e.restore()}_updateValueFromPointer(e,t){0!=this.rotation&&(this._invertTransformMatrix.transformCoordinates(e,t,this._transformedPosition),e=this._transformedPosition.x,t=this._transformedPosition.y);const i=this._invertScrollDirection?-1:1;this._first&&(this._first=!1,this._originX=e,this._originY=t,(e<this._tempMeasure.left||e>this._tempMeasure.left+this._tempMeasure.width||t<this._tempMeasure.top||t>this._tempMeasure.top+this._tempMeasure.height)&&(this.isVertical?this.value=this.minimum+(1-(t-this._currentMeasure.top)/this._currentMeasure.height)*(this.maximum-this.minimum):this.value=this.minimum+(e-this._currentMeasure.left)/this._currentMeasure.width*(this.maximum-this.minimum)));let s=0;s=this.isVertical?-(t-this._originY)/(this._currentMeasure.height-this._effectiveThumbThickness):(e-this._originX)/(this._currentMeasure.width-this._effectiveThumbThickness),this.value+=i*s*(this.maximum-this.minimum),this._originX=e,this._originY=t}_onPointerDown(e,t,i,s,r){return this._first=!0,super._onPointerDown(e,t,i,s,r)}serialize(e){super.serialize(e),this.backgroundGradient&&(e.backgroundGradient={},this.backgroundGradient.serialize(e.backgroundGradient))}_parseFromContent(e,t){if(super._parseFromContent(e,t),e.backgroundGradient){const t=ee.S0.Instantiate("BABYLON.GUI."+e.backgroundGradient.className);this.backgroundGradient=new t,this.backgroundGradient.parse(e.backgroundGradient)}}}(0,w.Cg)([(0,D.lK)()],fh.prototype,"borderColor",null),(0,w.Cg)([(0,D.lK)()],fh.prototype,"background",null),(0,w.Cg)([(0,D.lK)()],fh.prototype,"invertScrollDirection",null),(0,V.Y5)("BABYLON.GUI.Scrollbar",fh);class mh extends dh{get invertScrollDirection(){return this._invertScrollDirection}set invertScrollDirection(e){this._invertScrollDirection=e}get backgroundImage(){return this._backgroundBaseImage}set backgroundImage(e){this._backgroundBaseImage!==e&&(this._backgroundBaseImage=e,this.isVertical&&0!==this.num90RotationInVerticalMode?e.isLoaded?(this._backgroundImage=e._rotate90(this.num90RotationInVerticalMode,!0),this._markAsDirty()):e.onImageLoadedObservable.addOnce((()=>{const t=e._rotate90(this.num90RotationInVerticalMode,!0);this._backgroundImage=t,t.isLoaded||t.onImageLoadedObservable.addOnce((()=>{this._markAsDirty()})),this._markAsDirty()})):(this._backgroundImage=e,e&&!e.isLoaded&&e.onImageLoadedObservable.addOnce((()=>{this._markAsDirty()})),this._markAsDirty()))}get thumbImage(){return this._thumbBaseImage}set thumbImage(e){this._thumbBaseImage!==e&&(this._thumbBaseImage=e,this.isVertical&&0!==this.num90RotationInVerticalMode?e.isLoaded?(this._thumbImage=e._rotate90(-this.num90RotationInVerticalMode,!0),this._markAsDirty()):e.onImageLoadedObservable.addOnce((()=>{const t=e._rotate90(-this.num90RotationInVerticalMode,!0);this._thumbImage=t,t.isLoaded||t.onImageLoadedObservable.addOnce((()=>{this._markAsDirty()})),this._markAsDirty()})):(this._thumbImage=e,e&&!e.isLoaded&&e.onImageLoadedObservable.addOnce((()=>{this._markAsDirty()})),this._markAsDirty()))}get thumbLength(){return this._thumbLength}set thumbLength(e){this._thumbLength!==e&&(this._thumbLength=e,this._markAsDirty())}get thumbHeight(){return this._thumbHeight}set thumbHeight(e){this._thumbLength!==e&&(this._thumbHeight=e,this._markAsDirty())}get barImageHeight(){return this._barImageHeight}set barImageHeight(e){this._barImageHeight!==e&&(this._barImageHeight=e,this._markAsDirty())}constructor(e){super(e),this.name=e,this._thumbLength=.5,this._thumbHeight=1,this._barImageHeight=1,this._tempMeasure=new zl(0,0,0,0),this._invertScrollDirection=!1,this.num90RotationInVerticalMode=1}_getTypeName(){return"ImageScrollBar"}_getThumbThickness(){let e=0;return e=this._thumbWidth.isPixel?this._thumbWidth.getValue(this._host):this._backgroundBoxThickness*this._thumbWidth.getValue(this._host),e}_draw(e){e.save(),this._applyStates(e),this._prepareRenderingData("rectangle");const t=this._getThumbPosition(),i=this._renderLeft,s=this._renderTop,r=this._renderWidth,n=this._renderHeight;this._backgroundImage&&(this._tempMeasure.copyFromFloats(i,s,r,n),this.isVertical?(this._tempMeasure.copyFromFloats(i+r*(1-this._barImageHeight)*.5,this._currentMeasure.top,r*this._barImageHeight,n),this._tempMeasure.height+=this._effectiveThumbThickness,this._backgroundImage._currentMeasure.copyFrom(this._tempMeasure)):(this._tempMeasure.copyFromFloats(this._currentMeasure.left,s+n*(1-this._barImageHeight)*.5,r,n*this._barImageHeight),this._tempMeasure.width+=this._effectiveThumbThickness,this._backgroundImage._currentMeasure.copyFrom(this._tempMeasure)),this._backgroundImage._draw(e)),this.isVertical?this._tempMeasure.copyFromFloats(i-this._effectiveBarOffset+this._currentMeasure.width*(1-this._thumbHeight)*.5,this._currentMeasure.top+t,this._currentMeasure.width*this._thumbHeight,this._effectiveThumbThickness):this._tempMeasure.copyFromFloats(this._currentMeasure.left+t,this._currentMeasure.top+this._currentMeasure.height*(1-this._thumbHeight)*.5,this._effectiveThumbThickness,this._currentMeasure.height*this._thumbHeight),this._thumbImage&&(this._thumbImage._currentMeasure.copyFrom(this._tempMeasure),this._thumbImage._draw(e)),e.restore()}_updateValueFromPointer(e,t){0!=this.rotation&&(this._invertTransformMatrix.transformCoordinates(e,t,this._transformedPosition),e=this._transformedPosition.x,t=this._transformedPosition.y);const i=this._invertScrollDirection?-1:1;this._first&&(this._first=!1,this._originX=e,this._originY=t,(e<this._tempMeasure.left||e>this._tempMeasure.left+this._tempMeasure.width||t<this._tempMeasure.top||t>this._tempMeasure.top+this._tempMeasure.height)&&(this.isVertical?this.value=this.minimum+(1-(t-this._currentMeasure.top)/this._currentMeasure.height)*(this.maximum-this.minimum):this.value=this.minimum+(e-this._currentMeasure.left)/this._currentMeasure.width*(this.maximum-this.minimum)));let s=0;s=this.isVertical?-(t-this._originY)/(this._currentMeasure.height-this._effectiveThumbThickness):(e-this._originX)/(this._currentMeasure.width-this._effectiveThumbThickness),this.value+=i*s*(this.maximum-this.minimum),this._originX=e,this._originY=t}_onPointerDown(e,t,i,s,r){return this._first=!0,super._onPointerDown(e,t,i,s,r)}}(0,w.Cg)([(0,D.lK)()],mh.prototype,"num90RotationInVerticalMode",void 0),(0,w.Cg)([(0,D.lK)()],mh.prototype,"invertScrollDirection",null);class gh extends Ql{get horizontalBar(){return this._horizontalBar}get verticalBar(){return this._verticalBar}addControl(e){return e?(this._window.addControl(e),this):this}removeControl(e){return this._window.removeControl(e),this}get children(){return this._window.children}_flagDescendantsAsMatrixDirty(){for(const e of this._children)e._markMatrixAsDirty()}get freezeControls(){return this._window.freezeControls}set freezeControls(e){this._window.freezeControls=e}get bucketWidth(){return this._window.bucketWidth}get bucketHeight(){return this._window.bucketHeight}setBucketSizes(e,t){this._window.setBucketSizes(e,t)}get forceHorizontalBar(){return this._forceHorizontalBar}set forceHorizontalBar(e){this._grid.setRowDefinition(1,e?this._barSize:0,!0),this._horizontalBar.isVisible=e,this._forceHorizontalBar=e}get forceVerticalBar(){return this._forceVerticalBar}set forceVerticalBar(e){this._grid.setColumnDefinition(1,e?this._barSize:0,!0),this._verticalBar.isVisible=e,this._forceVerticalBar=e}constructor(e,t){super(e),this._barSize=20,this._pointerIsOver=!1,this._wheelPrecision=.05,this._thumbLength=.5,this._thumbHeight=1,this._barImageHeight=1,this._horizontalBarImageHeight=1,this._verticalBarImageHeight=1,this._oldWindowContentsWidth=0,this._oldWindowContentsHeight=0,this._forceHorizontalBar=!1,this._forceVerticalBar=!1,this._useImageBar=t||!1,this.onDirtyObservable.add((()=>{this._horizontalBarSpace.color=this.color,this._verticalBarSpace.color=this.color,this._dragSpace.color=this.color})),this.onPointerEnterObservable.add((()=>{this._pointerIsOver=!0})),this.onPointerOutObservable.add((()=>{this._pointerIsOver=!1})),this._grid=new rh,this._useImageBar?(this._horizontalBar=new mh,this._verticalBar=new mh):(this._horizontalBar=new fh,this._verticalBar=new fh),this._window=new ph("scrollViewer_window"),this._window.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,this._window.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,this._grid.addColumnDefinition(1),this._grid.addColumnDefinition(0,!0),this._grid.addRowDefinition(1),this._grid.addRowDefinition(0,!0),super.addControl(this._grid),this._grid.addControl(this._window,0,0),this._verticalBarSpace=new Ql,this._verticalBarSpace.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,this._verticalBarSpace.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,this._verticalBarSpace.thickness=1,this._grid.addControl(this._verticalBarSpace,0,1),this._addBar(this._verticalBar,this._verticalBarSpace,!0,Math.PI),this._horizontalBarSpace=new Ql,this._horizontalBarSpace.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,this._horizontalBarSpace.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,this._horizontalBarSpace.thickness=1,this._grid.addControl(this._horizontalBarSpace,1,0),this._addBar(this._horizontalBar,this._horizontalBarSpace,!1,0),this._dragSpace=new Ql,this._dragSpace.thickness=1,this._grid.addControl(this._dragSpace,1,1),this._grid.clipChildren=!1,this._useImageBar||(this.barColor="grey",this.barBackground="transparent")}resetWindow(){this._window.width="100%",this._window.height="100%"}_getTypeName(){return"ScrollViewer"}_buildClientSizes(){const e=this.host.idealRatio;this._window.parentClientWidth=this._currentMeasure.width-(this._verticalBar.isVisible||this.forceVerticalBar?this._barSize*e:0)-2*this.thickness,this._window.parentClientHeight=this._currentMeasure.height-(this._horizontalBar.isVisible||this.forceHorizontalBar?this._barSize*e:0)-2*this.thickness,this._clientWidth=this._window.parentClientWidth,this._clientHeight=this._window.parentClientHeight}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._buildClientSizes()}_postMeasure(){super._postMeasure(),this._updateScroller(),this._setWindowPosition(!1)}get wheelPrecision(){return this._wheelPrecision}set wheelPrecision(e){this._wheelPrecision!==e&&(e<0&&(e=0),e>1&&(e=1),this._wheelPrecision=e)}get scrollBackground(){return this._horizontalBarSpace.background}set scrollBackground(e){this._horizontalBarSpace.background!==e&&(this._horizontalBarSpace.background=e,this._verticalBarSpace.background=e)}get barColor(){return this._barColor}set barColor(e){this._barColor!==e&&(this._barColor=e,this._horizontalBar.color=e,this._verticalBar.color=e)}get thumbImage(){return this._barImage}set thumbImage(e){if(this._barImage===e)return;this._barImage=e;const t=this._horizontalBar,i=this._verticalBar;t.thumbImage=e,i.thumbImage=e}get horizontalThumbImage(){return this._horizontalBarImage}set horizontalThumbImage(e){this._horizontalBarImage!==e&&(this._horizontalBarImage=e,this._horizontalBar.thumbImage=e)}get verticalThumbImage(){return this._verticalBarImage}set verticalThumbImage(e){this._verticalBarImage!==e&&(this._verticalBarImage=e,this._verticalBar.thumbImage=e)}get barSize(){return this._barSize}set barSize(e){this._barSize!==e&&(this._barSize=e,this._markAsDirty(),this._horizontalBar.isVisible&&this._grid.setRowDefinition(1,this._barSize,!0),this._verticalBar.isVisible&&this._grid.setColumnDefinition(1,this._barSize,!0))}get thumbLength(){return this._thumbLength}set thumbLength(e){if(this._thumbLength===e)return;e<=0&&(e=.1),e>1&&(e=1),this._thumbLength=e;const t=this._horizontalBar,i=this._verticalBar;t.thumbLength=e,i.thumbLength=e,this._markAsDirty()}get thumbHeight(){return this._thumbHeight}set thumbHeight(e){if(this._thumbHeight===e)return;e<=0&&(e=.1),e>1&&(e=1),this._thumbHeight=e;const t=this._horizontalBar,i=this._verticalBar;t.thumbHeight=e,i.thumbHeight=e,this._markAsDirty()}get barImageHeight(){return this._barImageHeight}set barImageHeight(e){if(this._barImageHeight===e)return;e<=0&&(e=.1),e>1&&(e=1),this._barImageHeight=e;const t=this._horizontalBar,i=this._verticalBar;t.barImageHeight=e,i.barImageHeight=e,this._markAsDirty()}get horizontalBarImageHeight(){return this._horizontalBarImageHeight}set horizontalBarImageHeight(e){this._horizontalBarImageHeight!==e&&(e<=0&&(e=.1),e>1&&(e=1),this._horizontalBarImageHeight=e,this._horizontalBar.barImageHeight=e,this._markAsDirty())}get verticalBarImageHeight(){return this._verticalBarImageHeight}set verticalBarImageHeight(e){this._verticalBarImageHeight!==e&&(e<=0&&(e=.1),e>1&&(e=1),this._verticalBarImageHeight=e,this._verticalBar.barImageHeight=e,this._markAsDirty())}get barBackground(){return this._barBackground}set barBackground(e){if(this._barBackground===e)return;this._barBackground=e;const t=this._horizontalBar,i=this._verticalBar;t.background=e,i.background=e,this._dragSpace.background=e}get barImage(){return this._barBackgroundImage}set barImage(e){this._barBackgroundImage=e;const t=this._horizontalBar,i=this._verticalBar;t.backgroundImage=e,i.backgroundImage=e}get horizontalBarImage(){return this._horizontalBarBackgroundImage}set horizontalBarImage(e){this._horizontalBarBackgroundImage=e,this._horizontalBar.backgroundImage=e}get verticalBarImage(){return this._verticalBarBackgroundImage}set verticalBarImage(e){this._verticalBarBackgroundImage=e,this._verticalBar.backgroundImage=e}_setWindowPosition(e=!0){const t=this.host.idealRatio,i=this._window._currentMeasure.width,s=this._window._currentMeasure.height;if(!e&&this._oldWindowContentsWidth===i&&this._oldWindowContentsHeight===s)return;this._oldWindowContentsWidth=i,this._oldWindowContentsHeight=s;const r=this._clientWidth-i,n=this._clientHeight-s,a=this._horizontalBar.value/t*r+"px",o=this._verticalBar.value/t*n+"px";a!==this._window.left&&(this._window.left=a,this.freezeControls||(this._rebuildLayout=!0)),o!==this._window.top&&(this._window.top=o,this.freezeControls||(this._rebuildLayout=!0))}_updateScroller(){const e=this._window._currentMeasure.width,t=this._window._currentMeasure.height;this._horizontalBar.isVisible&&e<=this._clientWidth&&!this.forceHorizontalBar?(this._grid.setRowDefinition(1,0,!0),this._horizontalBar.isVisible=!1,this._horizontalBar.value=0,this._rebuildLayout=!0):!this._horizontalBar.isVisible&&(e>this._clientWidth||this.forceHorizontalBar)&&(this._grid.setRowDefinition(1,this._barSize,!0),this._horizontalBar.isVisible=!0,this._rebuildLayout=!0),this._verticalBar.isVisible&&t<=this._clientHeight&&!this.forceVerticalBar?(this._grid.setColumnDefinition(1,0,!0),this._verticalBar.isVisible=!1,this._verticalBar.value=0,this._rebuildLayout=!0):!this._verticalBar.isVisible&&(t>this._clientHeight||this.forceVerticalBar)&&(this._grid.setColumnDefinition(1,this._barSize,!0),this._verticalBar.isVisible=!0,this._rebuildLayout=!0),this._buildClientSizes();const i=this.host.idealRatio;this._horizontalBar.thumbWidth=.9*this._thumbLength*(this._clientWidth/i)+"px",this._verticalBar.thumbWidth=.9*this._thumbLength*(this._clientHeight/i)+"px"}_link(e){super._link(e),this._attachWheel()}_addBar(e,t,i,s){e.paddingLeft=0,e.width="100%",e.height="100%",e.barOffset=0,e.value=0,e.maximum=1,e.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_CENTER,e.verticalAlignment=Xl.VERTICAL_ALIGNMENT_CENTER,e.isVertical=i,e.rotation=s,e.isVisible=!1,t.addControl(e),e.onValueChangedObservable.add((()=>{this._setWindowPosition()}))}_attachWheel(){this._host&&!this._onWheelObserver&&(this._onWheelObserver=this.onWheelObservable.add((e=>{this._pointerIsOver&&!this.isReadOnly&&(1==this._verticalBar.isVisible&&(e.y<0&&this._verticalBar.value>0?this._verticalBar.value-=this._wheelPrecision:e.y>0&&this._verticalBar.value<this._verticalBar.maximum&&(this._verticalBar.value+=this._wheelPrecision)),1==this._horizontalBar.isVisible&&(e.x<0&&this._horizontalBar.value<this._horizontalBar.maximum?this._horizontalBar.value+=this._wheelPrecision:e.x>0&&this._horizontalBar.value>0&&(this._horizontalBar.value-=this._wheelPrecision)))})))}_renderHighlightSpecific(e){this.isHighlighted&&(super._renderHighlightSpecific(e),this._grid._renderHighlightSpecific(e),e.restore())}dispose(){this.onWheelObservable.remove(this._onWheelObserver),this._onWheelObserver=null,super.dispose()}}(0,w.Cg)([(0,D.lK)()],gh.prototype,"wheelPrecision",null),(0,w.Cg)([(0,D.lK)()],gh.prototype,"scrollBackground",null),(0,w.Cg)([(0,D.lK)()],gh.prototype,"barColor",null),(0,w.Cg)([(0,D.lK)()],gh.prototype,"barSize",null),(0,w.Cg)([(0,D.lK)()],gh.prototype,"barBackground",null),(0,V.Y5)("BABYLON.GUI.ScrollViewer",gh),(0,V.Y5)("BABYLON.GUI.ToggleButton",class extends Ql{get group(){return this._group}set group(e){this._group!==e&&(this._group=e)}get isActive(){return this._isActive}set isActive(e){this._isActive!==e&&(this._isActive=e,this._isActive?this.toActiveAnimation?.():this.toInactiveAnimation?.(),this._markAsDirty(),this.onIsActiveChangedObservable.notifyObservers(e),this._isActive&&this._host&&this._group&&this._host.executeOnAllControls((e=>{if("ToggleButton"===e.typeName){if(e===this)return;const t=e;t.group===this.group&&(t.isActive=!1)}})))}constructor(e,t){super(e),this.name=e,this.onIsActiveChangedObservable=new C.cP,this.delegatePickingToChildren=!1,this._isActive=!1,this.group=t??"",this.thickness=0,this.isPointerBlocker=!0;let i=null;this.toActiveAnimation=()=>{this.thickness=1},this.toInactiveAnimation=()=>{this.thickness=0},this.pointerEnterActiveAnimation=()=>{i=this.alpha,this.alpha-=.1},this.pointerOutActiveAnimation=()=>{null!==i&&(this.alpha=i)},this.pointerDownActiveAnimation=()=>{this.scaleX-=.05,this.scaleY-=.05},this.pointerUpActiveAnimation=()=>{this.scaleX+=.05,this.scaleY+=.05},this.pointerEnterInactiveAnimation=()=>{i=this.alpha,this.alpha-=.1},this.pointerOutInactiveAnimation=()=>{null!==i&&(this.alpha=i)},this.pointerDownInactiveAnimation=()=>{this.scaleX-=.05,this.scaleY-=.05},this.pointerUpInactiveAnimation=()=>{this.scaleX+=.05,this.scaleY+=.05}}_getTypeName(){return"ToggleButton"}_processPicking(e,t,i,s,r,n,a,o){if(!this._isEnabled||!this.isHitTestVisible||!this.isVisible||this.notRenderable)return!1;if(!super.contains(e,t))return!1;if(this.delegatePickingToChildren){let i=!1;for(let s=this._children.length-1;s>=0;s--){const r=this._children[s];if(r.isEnabled&&r.isHitTestVisible&&r.isVisible&&!r.notRenderable&&r.contains(e,t)){i=!0;break}}if(!i)return!1}return this._processObservables(s,e,t,i,r,n,a,o),!0}_onPointerEnter(e,t){return!!super._onPointerEnter(e,t)&&(this.isReadOnly||(this._isActive?this.pointerEnterActiveAnimation&&this.pointerEnterActiveAnimation():this.pointerEnterInactiveAnimation&&this.pointerEnterInactiveAnimation()),!0)}_onPointerOut(e,t,i=!1){this.isReadOnly||(this._isActive?this.pointerOutActiveAnimation&&this.pointerOutActiveAnimation():this.pointerOutInactiveAnimation&&this.pointerOutInactiveAnimation()),super._onPointerOut(e,t,i)}_onPointerDown(e,t,i,s,r){return!!super._onPointerDown(e,t,i,s,r)&&(this.isReadOnly||(this._isActive?this.pointerDownActiveAnimation&&this.pointerDownActiveAnimation():this.pointerDownInactiveAnimation&&this.pointerDownInactiveAnimation()),!0)}_onPointerUp(e,t,i,s,r,n){this.isReadOnly||(this._isActive?this.pointerUpActiveAnimation&&this.pointerUpActiveAnimation():this.pointerUpInactiveAnimation&&this.pointerUpInactiveAnimation()),super._onPointerUp(e,t,i,s,r,n)}});class vh extends Zl{constructor(){super(...arguments),this.onKeyPressObservable=new C.cP,this.defaultButtonWidth="40px",this.defaultButtonHeight="40px",this.defaultButtonPaddingLeft="2px",this.defaultButtonPaddingRight="2px",this.defaultButtonPaddingTop="2px",this.defaultButtonPaddingBottom="2px",this.defaultButtonColor="#DDD",this.defaultButtonBackground="#070707",this.shiftButtonColor="#7799FF",this.selectedShiftThickness=1,this.shiftState=0,this._currentlyConnectedInputText=null,this._connectedInputTexts=[],this._onKeyPressObserver=null}_getTypeName(){return"VirtualKeyboard"}_createKey(e,t){const i=jl.CreateSimpleButton(e,e);return i.width=t&&t.width?t.width:this.defaultButtonWidth,i.height=t&&t.height?t.height:this.defaultButtonHeight,i.color=t&&t.color?t.color:this.defaultButtonColor,i.background=t&&t.background?t.background:this.defaultButtonBackground,i.paddingLeft=t&&t.paddingLeft?t.paddingLeft:this.defaultButtonPaddingLeft,i.paddingRight=t&&t.paddingRight?t.paddingRight:this.defaultButtonPaddingRight,i.paddingTop=t&&t.paddingTop?t.paddingTop:this.defaultButtonPaddingTop,i.paddingBottom=t&&t.paddingBottom?t.paddingBottom:this.defaultButtonPaddingBottom,i.thickness=0,i.isFocusInvisible=!0,i.shadowColor=this.shadowColor,i.shadowBlur=this.shadowBlur,i.shadowOffsetX=this.shadowOffsetX,i.shadowOffsetY=this.shadowOffsetY,i.onPointerUpObservable.add((()=>{this.onKeyPressObservable.notifyObservers(e)})),i}addKeysRow(e,t){const i=new Zl;i.isVertical=!1,i.isFocusInvisible=!0;let s=null;for(let r=0;r<e.length;r++){let n=null;t&&t.length===e.length&&(n=t[r]);const a=this._createKey(e[r],n);(!s||a.heightInPixels>s.heightInPixels)&&(s=a),i.addControl(a)}i.height=s?s.height:this.defaultButtonHeight,this.addControl(i)}applyShiftState(e){if(this.children)for(let t=0;t<this.children.length;t++){const i=this.children[t];if(!i||!i.children)continue;const s=i;for(let t=0;t<s.children.length;t++){const i=s.children[t];if(!i||!i.children[0])continue;const r=i.children[0];"⇧"===r.text&&(i.color=e?this.shiftButtonColor:this.defaultButtonColor,i.thickness=e>1?this.selectedShiftThickness:0),r.text=e>0?r.text.toUpperCase():r.text.toLowerCase()}}}get connectedInputText(){return this._currentlyConnectedInputText}connect(e){if(this._connectedInputTexts.some((t=>t.input===e)))return;null===this._onKeyPressObserver&&(this._onKeyPressObserver=this.onKeyPressObservable.add((e=>{if(this._currentlyConnectedInputText){switch(this._currentlyConnectedInputText._host.focusedControl=this._currentlyConnectedInputText,e){case"⇧":return this.shiftState++,this.shiftState>2&&(this.shiftState=0),void this.applyShiftState(this.shiftState);case"←":return void(this._currentlyConnectedInputText instanceof oh?this._currentlyConnectedInputText.alternativeProcessKey("Backspace"):this._currentlyConnectedInputText.processKey(8));case"↵":return void(this._currentlyConnectedInputText instanceof oh?this._currentlyConnectedInputText.alternativeProcessKey("Enter"):this._currentlyConnectedInputText.processKey(13))}this._currentlyConnectedInputText instanceof oh?this._currentlyConnectedInputText.alternativeProcessKey("",this.shiftState?e.toUpperCase():e):this._currentlyConnectedInputText.processKey(-1,this.shiftState?e.toUpperCase():e),1===this.shiftState&&(this.shiftState=0,this.applyShiftState(this.shiftState))}}))),this.isVisible=!1,this._currentlyConnectedInputText=e,e._connectedVirtualKeyboard=this;const t=e.onFocusObservable.add((()=>{this._currentlyConnectedInputText=e,e._connectedVirtualKeyboard=this,this.isVisible=!0})),i=e.onBlurObservable.add((()=>{e._connectedVirtualKeyboard=null,this._currentlyConnectedInputText=null,this.isVisible=!1}));this._connectedInputTexts.push({input:e,onBlurObserver:i,onFocusObserver:t})}disconnect(e){if(e){const t=this._connectedInputTexts.filter((t=>t.input===e));1===t.length&&(this._removeConnectedInputObservables(t[0]),this._connectedInputTexts=this._connectedInputTexts.filter((t=>t.input!==e)),this._currentlyConnectedInputText===e&&(this._currentlyConnectedInputText=null))}else this._connectedInputTexts.forEach((e=>{this._removeConnectedInputObservables(e)})),this._connectedInputTexts.length=0;0===this._connectedInputTexts.length&&(this._currentlyConnectedInputText=null,this.onKeyPressObservable.remove(this._onKeyPressObserver),this._onKeyPressObserver=null)}_removeConnectedInputObservables(e){e.input._connectedVirtualKeyboard=null,e.input.onFocusObservable.remove(e.onFocusObserver),e.input.onBlurObservable.remove(e.onBlurObserver)}dispose(){super.dispose(),this.disconnect()}static CreateDefaultLayout(e){const t=new vh(e);return t.addKeysRow(["1","2","3","4","5","6","7","8","9","0","←"]),t.addKeysRow(["q","w","e","r","t","y","u","i","o","p"]),t.addKeysRow(["a","s","d","f","g","h","j","k","l",";","'","↵"]),t.addKeysRow(["⇧","z","x","c","v","b","n","m",",",".","/"]),t.addKeysRow([" "],[{width:"200px"}]),t}_parseFromContent(e,t){super._parseFromContent(e,t);for(const e of this.children)if("StackPanel"===e.getClassName()){const t=e;for(const e of t.children)"Button"===e.getClassName()&&e.name&&e.onPointerUpObservable.add((()=>{this.onKeyPressObservable.notifyObservers(e.name)}))}}}(0,V.Y5)("BABYLON.GUI.VirtualKeyboard",vh);class bh extends Xl{get displayMinorLines(){return this._displayMinorLines}set displayMinorLines(e){this._displayMinorLines!==e&&(this._displayMinorLines=e,this._markAsDirty())}get displayMajorLines(){return this._displayMajorLines}set displayMajorLines(e){this._displayMajorLines!==e&&(this._displayMajorLines=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get cellWidth(){return this._cellWidth}set cellWidth(e){this._cellWidth=e,this._markAsDirty()}get cellHeight(){return this._cellHeight}set cellHeight(e){this._cellHeight=e,this._markAsDirty()}get minorLineTickness(){return this._minorLineTickness}set minorLineTickness(e){this._minorLineTickness=e,this._markAsDirty()}get minorLineColor(){return this._minorLineColor}set minorLineColor(e){this._minorLineColor=e,this._markAsDirty()}get majorLineTickness(){return this._majorLineTickness}set majorLineTickness(e){this._majorLineTickness=e,this._markAsDirty()}get majorLineColor(){return this._majorLineColor}set majorLineColor(e){this._majorLineColor=e,this._markAsDirty()}get majorLineFrequency(){return this._majorLineFrequency}set majorLineFrequency(e){this._majorLineFrequency=e,this._markAsDirty()}constructor(e){super(e),this.name=e,this._cellWidth=20,this._cellHeight=20,this._minorLineTickness=1,this._minorLineColor="DarkGray",this._majorLineTickness=2,this._majorLineColor="White",this._majorLineFrequency=5,this._background="Black",this._displayMajorLines=!0,this._displayMinorLines=!0}_draw(e){if(e.save(),this._applyStates(e),this._isEnabled){this._background&&(e.fillStyle=this._background,e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height));const t=this._currentMeasure.width/this._cellWidth,i=this._currentMeasure.height/this._cellHeight,s=this._currentMeasure.left+this._currentMeasure.width/2,r=this._currentMeasure.top+this._currentMeasure.height/2;if(this._displayMinorLines){e.strokeStyle=this._minorLineColor,e.lineWidth=this._minorLineTickness;for(let i=-t/2+1;i<t/2;i++){const t=s+i*this.cellWidth;e.beginPath(),e.moveTo(t,this._currentMeasure.top),e.lineTo(t,this._currentMeasure.top+this._currentMeasure.height),e.stroke()}for(let t=-i/2+1;t<i/2;t++){const i=r+t*this.cellHeight;e.beginPath(),e.moveTo(this._currentMeasure.left,i),e.lineTo(this._currentMeasure.left+this._currentMeasure.width,i),e.stroke()}}if(this._displayMajorLines){e.strokeStyle=this._majorLineColor,e.lineWidth=this._majorLineTickness;for(let i=-t/2+this._majorLineFrequency;i<t/2;i+=this._majorLineFrequency){const t=s+i*this.cellWidth;e.beginPath(),e.moveTo(t,this._currentMeasure.top),e.lineTo(t,this._currentMeasure.top+this._currentMeasure.height),e.stroke()}for(let t=-i/2+this._majorLineFrequency;t<i/2;t+=this._majorLineFrequency){const i=r+t*this.cellHeight;e.moveTo(this._currentMeasure.left,i),e.lineTo(this._currentMeasure.left+this._currentMeasure.width,i),e.closePath(),e.stroke()}}}e.restore()}_getTypeName(){return"DisplayGrid"}}(0,w.Cg)([(0,D.lK)()],bh.prototype,"displayMinorLines",null),(0,w.Cg)([(0,D.lK)()],bh.prototype,"displayMajorLines",null),(0,w.Cg)([(0,D.lK)()],bh.prototype,"background",null),(0,w.Cg)([(0,D.lK)()],bh.prototype,"cellWidth",null),(0,w.Cg)([(0,D.lK)()],bh.prototype,"cellHeight",null),(0,w.Cg)([(0,D.lK)()],bh.prototype,"minorLineTickness",null),(0,w.Cg)([(0,D.lK)()],bh.prototype,"minorLineColor",null),(0,w.Cg)([(0,D.lK)()],bh.prototype,"majorLineTickness",null),(0,w.Cg)([(0,D.lK)()],bh.prototype,"majorLineColor",null),(0,w.Cg)([(0,D.lK)()],bh.prototype,"majorLineFrequency",null),(0,V.Y5)("BABYLON.GUI.DisplayGrid",bh);class xh extends dh{get displayThumb(){return this._displayThumb&&null!=this.thumbImage}set displayThumb(e){this._displayThumb!==e&&(this._displayThumb=e,this._markAsDirty())}get backgroundImage(){return this._backgroundImage}set backgroundImage(e){this._backgroundImage!==e&&(this._backgroundImage=e,e&&!e.isLoaded&&e.onImageLoadedObservable.addOnce((()=>this._markAsDirty())),this._markAsDirty())}get valueBarImage(){return this._valueBarImage}set valueBarImage(e){this._valueBarImage!==e&&(this._valueBarImage=e,e&&!e.isLoaded&&e.onImageLoadedObservable.addOnce((()=>this._markAsDirty())),this._markAsDirty())}get thumbImage(){return this._thumbImage}set thumbImage(e){this._thumbImage!==e&&(this._thumbImage=e,e&&!e.isLoaded&&e.onImageLoadedObservable.addOnce((()=>this._markAsDirty())),this._markAsDirty())}constructor(e){super(e),this.name=e,this._tempMeasure=new zl(0,0,0,0)}_getTypeName(){return"ImageBasedSlider"}_draw(e){e.save(),this._applyStates(e),this._prepareRenderingData("rectangle");const t=this._getThumbPosition(),i=this._renderLeft,s=this._renderTop,r=this._renderWidth,n=this._renderHeight;this._backgroundImage&&(this._tempMeasure.copyFromFloats(i,s,r,n),this.isThumbClamped&&this.displayThumb&&(this.isVertical?this._tempMeasure.height+=this._effectiveThumbThickness:this._tempMeasure.width+=this._effectiveThumbThickness),this._backgroundImage._currentMeasure.copyFrom(this._tempMeasure),this._backgroundImage._draw(e)),this._valueBarImage&&(this.isVertical?this.isThumbClamped&&this.displayThumb?this._tempMeasure.copyFromFloats(i,s+t,r,n-t+this._effectiveThumbThickness):this._tempMeasure.copyFromFloats(i,s+t,r,n-t):this.isThumbClamped&&this.displayThumb?this._tempMeasure.copyFromFloats(i,s,t+this._effectiveThumbThickness/2,n):this._tempMeasure.copyFromFloats(i,s,t,n),this._valueBarImage._currentMeasure.copyFrom(this._tempMeasure),this._valueBarImage._draw(e)),this.displayThumb&&(this.isVertical?this._tempMeasure.copyFromFloats(i-this._effectiveBarOffset,this._currentMeasure.top+t,this._currentMeasure.width,this._effectiveThumbThickness):this._tempMeasure.copyFromFloats(this._currentMeasure.left+t,this._currentMeasure.top,this._effectiveThumbThickness,this._currentMeasure.height),this._thumbImage._currentMeasure.copyFrom(this._tempMeasure),this._thumbImage._draw(e)),e.restore()}serialize(e){super.serialize(e);const t={},i={},s={};this.backgroundImage.serialize(t),this.thumbImage.serialize(i),this.valueBarImage.serialize(s),e.backgroundImage=t,e.thumbImage=i,e.valueBarImage=s}_parseFromContent(e,t){super._parseFromContent(e,t),this.backgroundImage=$l.Parse(e.backgroundImage,t),this.thumbImage=$l.Parse(e.thumbImage,t),this.valueBarImage=$l.Parse(e.valueBarImage,t)}}(0,w.Cg)([(0,D.lK)()],xh.prototype,"displayThumb",null),(0,V.Y5)("BABYLON.GUI.ImageBasedSlider",xh),Xl.AddHeader=function(e,t,i,s){const r=new Zl("panel"),n=!s||s.isHorizontal,a=!s||s.controlFirst;r.isVertical=!n;const o=new ql("header");return o.text=t,o.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,n?o.width=i:o.height=i,a?(r.addControl(e),r.addControl(o),o.paddingLeft="5px"):(r.addControl(o),r.addControl(e),o.paddingRight="5px"),o.shadowBlur=e.shadowBlur,o.shadowColor=e.shadowColor,o.shadowOffsetX=e.shadowOffsetX,o.shadowOffsetY=e.shadowOffsetY,r};class Sh{constructor(){this._colorStops=[],this._gradientDirty=!0}_addColorStopsToCanvasGradient(){for(const e of this._colorStops)this._canvasGradient.addColorStop(e.offset,e.color)}getCanvasGradient(e){return(this._gradientDirty||this._context!==e)&&(this._context=e,this._canvasGradient=this._createCanvasGradient(e),this._addColorStopsToCanvasGradient(),this._gradientDirty=!1),this._canvasGradient}addColorStop(e,t){this._colorStops.push({offset:e,color:t}),this._gradientDirty=!0}removeColorStop(e){this._colorStops=this._colorStops.filter((t=>t.offset!==e)),this._gradientDirty=!0}clearColorStops(){this._colorStops=[],this._gradientDirty=!0}get colorStops(){return this._colorStops}getClassName(){return"BaseGradient"}serialize(e){e.colorStops=this._colorStops,e.className=this.getClassName()}parse(e){this._colorStops=e.colorStops}}(0,V.Y5)("BABYLON.GUI.LinearGradient",class extends Sh{constructor(e,t,i,s){super(),this._x0=e??0,this._y0=t??0,this._x1=i??0,this._y1=s??0}_createCanvasGradient(e){return e.createLinearGradient(this._x0,this._y0,this._x1,this._y1)}get x0(){return this._x0}get x1(){return this._x1}get y0(){return this._y0}get y1(){return this._y1}getClassName(){return"LinearGradient"}serialize(e){super.serialize(e),e.x0=this._x0,e.y0=this._y0,e.x1=this._x1,e.y1=this._y1}parse(e){super.parse(e),this._x0=e.x0,this._y0=e.y0,this._x1=e.x1,this._y1=e.y1}}),(0,V.Y5)("BABYLON.GUI.RadialGradient",class extends Sh{constructor(e,t,i,s,r,n){super(),this._x0=e??0,this._y0=t??0,this._r0=i??0,this._x1=s??0,this._y1=r??0,this._r1=n??0}_createCanvasGradient(e){return e.createRadialGradient(this._x0,this._y0,this._r0,this._x1,this._y1,this._r1)}get x0(){return this._x0}get x1(){return this._x1}get y0(){return this._y0}get y1(){return this._y1}get r0(){return this._r0}get r1(){return this._r1}getClassName(){return"RadialGradient"}serialize(e){super.serialize(e),e.x0=this._x0,e.y0=this._y0,e.r0=this._r0,e.x1=this._x1,e.y1=this._y1,e.r1=this._r1}parse(e){super.parse(e),this._x0=e.x0,this._y0=e.y0,this._r0=e.r0,this._x1=e.x1,this._y1=e.y1,this._r1=e.r1}});class Th{constructor(e){this._fontFamily="Arial",this._fontStyle="",this._fontWeight="",this._fontSize=new Ll(18,Ll.UNITMODE_PIXEL,!1),this.onChangedObservable=new C.cP,this._host=e}get fontSize(){return this._fontSize.toString(this._host)}set fontSize(e){this._fontSize.toString(this._host)!==e&&this._fontSize.fromString(e)&&this.onChangedObservable.notifyObservers(this)}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this.onChangedObservable.notifyObservers(this))}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle!==e&&(this._fontStyle=e,this.onChangedObservable.notifyObservers(this))}get fontWeight(){return this._fontWeight}set fontWeight(e){this._fontWeight!==e&&(this._fontWeight=e,this.onChangedObservable.notifyObservers(this))}dispose(){this.onChangedObservable.clear()}}var yh=r(6181);class Ch extends ss{get numLayoutCalls(){return this._numLayoutCalls}get numRenderCalls(){return this._numRenderCalls}get renderScale(){return this._renderScale}set renderScale(e){e!==this._renderScale&&(this._renderScale=e,this._onResize())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this.markAsDirty())}get idealWidth(){return this._idealWidth}set idealWidth(e){this._idealWidth!==e&&(this._idealWidth=e,this.markAsDirty(),this._rootContainer._markAllAsDirty())}get idealHeight(){return this._idealHeight}set idealHeight(e){this._idealHeight!==e&&(this._idealHeight=e,this.markAsDirty(),this._rootContainer._markAllAsDirty())}get useSmallestIdeal(){return this._useSmallestIdeal}set useSmallestIdeal(e){this._useSmallestIdeal!==e&&(this._useSmallestIdeal=e,this.markAsDirty(),this._rootContainer._markAllAsDirty())}get renderAtIdealSize(){return this._renderAtIdealSize}set renderAtIdealSize(e){this._renderAtIdealSize!==e&&(this._renderAtIdealSize=e,this._onResize())}get idealRatio(){let e=0,t=0;return this._idealWidth&&(e=this.getSize().width/this._idealWidth),this._idealHeight&&(t=this.getSize().height/this._idealHeight),this._useSmallestIdeal&&this._idealWidth&&this._idealHeight?window.innerWidth<window.innerHeight?e:t:this._idealWidth?e:this._idealHeight?t:1}get layer(){return this._layerToDispose}get rootContainer(){return this._rootContainer}getChildren(){return[this._rootContainer]}getDescendants(e,t){return this._rootContainer.getDescendants(e,t)}getControlsByType(e){return this._rootContainer.getDescendants(!1,(t=>t.typeName===e))}getControlByName(e){return this._getControlByKey("name",e)}_getControlByKey(e,t){return this._rootContainer.getDescendants().find((i=>i[e]===t))||null}get focusedControl(){return this._focusedControl}set focusedControl(e){this._focusedControl!=e&&(this._focusedControl&&this._focusedControl.onBlur(),e&&e.onFocus(),this._focusedControl=e)}get isForeground(){return!this.layer||!this.layer.isBackground}set isForeground(e){this.layer&&this.layer.isBackground!==!e&&(this.layer.isBackground=!e)}get clipboardData(){return this._clipboardData}set clipboardData(e){this._clipboardData=e}constructor(e,t=0,i=0,s,r=!1,n=G.g.NEAREST_SAMPLINGMODE,a=!0){super(e,{width:t,height:i},s,r,n,Pa.Y.TEXTUREFORMAT_RGBA,a),this.onGuiReadyObservable=new C.cP,this._isDirty=!1,this._rootContainer=new Kl("root"),this._lastControlOver={},this._lastControlDown={},this._capturingControl={},this._linkedControls=new Array,this._isFullscreen=!1,this._fullscreenViewport=new te.L(0,0,1,1),this._idealWidth=0,this._idealHeight=0,this._useSmallestIdeal=!1,this._renderAtIdealSize=!1,this._blockNextFocusCheck=!1,this._renderScale=1,this._cursorChanged=!1,this._defaultMousePointerId=0,this._rootChildrenHaveChanged=!1,this._capturedPointerIds=new Set,this._numLayoutCalls=0,this._numRenderCalls=0,this._clipboardData="",this.onClipboardObservable=new C.cP,this.onControlPickedObservable=new C.cP,this.onBeginLayoutObservable=new C.cP,this.onEndLayoutObservable=new C.cP,this.onBeginRenderObservable=new C.cP,this.onEndRenderObservable=new C.cP,this.premulAlpha=!1,this.applyYInversionOnUpdate=!0,this.skipBlockEvents=0,this.checkPointerEveryFrame=!1,this._useInvalidateRectOptimization=!0,this._invalidatedRectangle=null,this._clearMeasure=new zl(0,0,0,0),this._onClipboardCopy=e=>{const t=e,i=new th(eh.COPY,t);this.onClipboardObservable.notifyObservers(i),t.preventDefault()},this._onClipboardCut=e=>{const t=e,i=new th(eh.CUT,t);this.onClipboardObservable.notifyObservers(i),t.preventDefault()},this._onClipboardPaste=e=>{const t=e,i=new th(eh.PASTE,t);this.onClipboardObservable.notifyObservers(i),t.preventDefault()},this.parseContent=this.parseSerializedObject,(s=this.getScene())&&this._texture&&(this.applyYInversionOnUpdate=a,this._rootElement=s.getEngine().getInputElement(),this._renderObserver=s.onBeforeCameraRenderObservable.add((e=>this._checkUpdate(e))),this._controlAddedObserver=this._rootContainer.onControlAddedObservable.add((e=>{e&&(this._rootChildrenHaveChanged=!0)})),this._controlRemovedObserver=this._rootContainer.onControlRemovedObservable.add((e=>{e&&(this._rootChildrenHaveChanged=!0)})),this._preKeyboardObserver=s.onPreKeyboardObservable.add((e=>{this._focusedControl&&(e.type===ei.TB.KEYDOWN&&this._focusedControl.processKeyboard(e.event),e.skipOnPointerObservable=!0)})),this._rootContainer._link(this),this.hasAlpha=!0,t&&i||(this._resizeObserver=s.getEngine().onResizeObservable.add((()=>this._onResize())),this._onResize()),this._texture.isReady=!0)}getClassName(){return"AdvancedDynamicTexture"}executeOnAllControls(e,t){t||(t=this._rootContainer),e(t);for(const i of t.children)i.children?this.executeOnAllControls(e,i):e(i)}get useInvalidateRectOptimization(){return this._useInvalidateRectOptimization}set useInvalidateRectOptimization(e){this._useInvalidateRectOptimization=e}invalidateRect(e,t,i,s){if(this._useInvalidateRectOptimization)if(this._invalidatedRectangle){const r=Math.ceil(Math.max(this._invalidatedRectangle.left+this._invalidatedRectangle.width-1,i)),n=Math.ceil(Math.max(this._invalidatedRectangle.top+this._invalidatedRectangle.height-1,s));this._invalidatedRectangle.left=Math.floor(Math.min(this._invalidatedRectangle.left,e)),this._invalidatedRectangle.top=Math.floor(Math.min(this._invalidatedRectangle.top,t)),this._invalidatedRectangle.width=r-this._invalidatedRectangle.left+1,this._invalidatedRectangle.height=n-this._invalidatedRectangle.top+1}else this._invalidatedRectangle=new zl(e,t,i-e+1,s-t+1)}markAsDirty(){this._isDirty=!0}createStyle(){return new Th(this)}addControl(e){return this._rootContainer.addControl(e),this}removeControl(e){return this._rootContainer.removeControl(e),this}moveToNonOverlappedPosition(e,t=1,i=1){let s;if(Array.isArray(e))s=e;else{const t=this.getDescendants(!0);s=void 0===e?t.filter((e=>void 0!==e.overlapGroup)):t.filter((t=>t.overlapGroup===e))}s.forEach((e=>{let r=I.I9.Zero();const n=new I.I9(e.centerX,e.centerY);s.forEach((t=>{if(e!==t&&Ch._Overlaps(e,t)){const e=n.subtract(new I.I9(t.centerX,t.centerY)),s=e.length();s>0&&(r=r.add(e.normalize().scale(i/s)))}})),r.length()>0&&(r=r.normalize().scale(t*(e.overlapDeltaMultiplier??1)),e.linkOffsetXInPixels+=r.x,e.linkOffsetYInPixels+=r.y)}))}dispose(){const e=this.getScene();e&&(this._rootElement=null,e.onBeforeCameraRenderObservable.remove(this._renderObserver),this._resizeObserver&&e.getEngine().onResizeObservable.remove(this._resizeObserver),this._prePointerObserver&&e.onPrePointerObservable.remove(this._prePointerObserver),this._sceneRenderObserver&&e.onBeforeRenderObservable.remove(this._sceneRenderObserver),this._pointerObserver&&e.onPointerObservable.remove(this._pointerObserver),this._preKeyboardObserver&&e.onPreKeyboardObservable.remove(this._preKeyboardObserver),this._canvasPointerOutObserver&&e.getEngine().onCanvasPointerOutObservable.remove(this._canvasPointerOutObserver),this._canvasBlurObserver&&e.getEngine().onCanvasBlurObservable.remove(this._canvasBlurObserver),this._controlAddedObserver&&this._rootContainer.onControlAddedObservable.remove(this._controlAddedObserver),this._controlRemovedObserver&&this._rootContainer.onControlRemovedObservable.remove(this._controlRemovedObserver),this._layerToDispose&&(this._layerToDispose.texture=null,this._layerToDispose.dispose(),this._layerToDispose=null),this._rootContainer.dispose(),this.onClipboardObservable.clear(),this.onControlPickedObservable.clear(),this.onBeginRenderObservable.clear(),this.onEndRenderObservable.clear(),this.onBeginLayoutObservable.clear(),this.onEndLayoutObservable.clear(),this.onGuiReadyObservable.clear(),super.dispose())}_onResize(){const e=this.getScene();if(!e)return;const t=e.getEngine(),i=this.getSize();let s=t.getRenderWidth()*this._renderScale,r=t.getRenderHeight()*this._renderScale;this._renderAtIdealSize&&(this._idealWidth?(r=r*this._idealWidth/s,s=this._idealWidth):this._idealHeight&&(s=s*this._idealHeight/r,r=this._idealHeight)),i.width===s&&i.height===r||(this.scaleTo(s,r),this.markAsDirty(),(this._idealWidth||this._idealHeight)&&this._rootContainer._markAllAsDirty()),this.invalidateRect(0,0,i.width-1,i.height-1)}_getGlobalViewport(){const e=this.getSize(),t=this._fullscreenViewport.toGlobal(e.width,e.height),i=Math.round(t.width*(1/this.rootContainer.scaleX)),s=Math.round(t.height*(1/this.rootContainer.scaleY));return t.x+=(t.width-i)/2,t.y+=(t.height-s)/2,t.width=i,t.height=s,t}getProjectedPosition(e,t){const i=this.getProjectedPositionWithZ(e,t);return new I.I9(i.x,i.y)}getProjectedPositionWithZ(e,t){const i=this.getScene();if(!i)return I.Pq.Zero();const s=this._getGlobalViewport(),r=I.Pq.Project(e,t,i.getTransformMatrix(),s);return new I.Pq(r.x,r.y,r.z)}_checkUpdate(e,t){if(!this._layerToDispose||e.layerMask&this._layerToDispose.layerMask){if(this._isFullscreen&&this._linkedControls.length){const e=this.getScene();if(!e)return;const t=this._getGlobalViewport();for(const i of this._linkedControls){if(!i.isVisible)continue;const s=i._linkedMesh;if(!s||s.isDisposed()){ee.S0.SetImmediate((()=>{i.linkWithMesh(null)}));continue}const r=s.getBoundingInfo?s.getBoundingInfo().boundingSphere.center:I.Pq.ZeroReadOnly,n=I.Pq.Project(r,s.getWorldMatrix(),e.getTransformMatrix(),t);n.z<0||n.z>1?i.notRenderable=!0:(i.notRenderable=!1,this.useInvalidateRectOptimization&&i.invalidateRect(),i._moveToProjectedPosition(n))}}(this._isDirty||this._rootContainer.isDirty)&&(this._isDirty=!1,this._render(t),t||this.update(this.applyYInversionOnUpdate,this.premulAlpha,Ch.AllowGPUOptimizations))}}_render(e){const t=this.getSize(),i=t.width,s=t.height,r=this.getContext();if(r.font="18px Arial",r.strokeStyle="white",this.onGuiReadyObservable.hasObservers()&&this._checkGuiIsReady(),this._rootChildrenHaveChanged){const e=this.getScene()?.activeCamera;e&&(this._rootChildrenHaveChanged=!1,this._checkUpdate(e,!0))}this.onBeginLayoutObservable.notifyObservers(this);const n=new zl(0,0,i,s);this._numLayoutCalls=0,this._rootContainer._layout(n,r),this.onEndLayoutObservable.notifyObservers(this),this._isDirty=!1,e||(this._invalidatedRectangle?this._clearMeasure.copyFrom(this._invalidatedRectangle):this._clearMeasure.copyFromFloats(0,0,i,s),r.clearRect(this._clearMeasure.left,this._clearMeasure.top,this._clearMeasure.width,this._clearMeasure.height),this._background&&(r.save(),r.fillStyle=this._background,r.fillRect(this._clearMeasure.left,this._clearMeasure.top,this._clearMeasure.width,this._clearMeasure.height),r.restore()),this.onBeginRenderObservable.notifyObservers(this),this._numRenderCalls=0,this._rootContainer._render(r,this._invalidatedRectangle),this.onEndRenderObservable.notifyObservers(this),this._invalidatedRectangle=null)}_changeCursor(e){this._rootElement&&(this._rootElement.style.cursor=e,this._cursorChanged=!0)}_registerLastControlDown(e,t){this._lastControlDown[t]=e,this.onControlPickedObservable.notifyObservers(e)}_doPicking(e,t,i,s,r,n,a,o){const l=this.getScene();if(!l)return;const h=l.getEngine(),c=this.getSize();if(this._isFullscreen){const i=l.cameraToUseForPointers||l.activeCamera;if(!i)return;const s=i.viewport;e*=c.width/(h.getRenderWidth()*s.width),t*=c.height/(h.getRenderHeight()*s.height)}if(this._capturingControl[r])return this._capturingControl[r].isPointerBlocker&&(this._shouldBlockPointer=!0),void this._capturingControl[r]._processObservables(s,e,t,i,r,n);this._cursorChanged=!1,this._rootContainer._processPicking(e,t,i,s,r,n,a,o)||(l.doNotHandleCursors||this._changeCursor(""),s===Rt.Zp.POINTERMOVE&&this._lastControlOver[r]&&(this._lastControlOver[r]._onPointerOut(this._lastControlOver[r],i),delete this._lastControlOver[r])),this._cursorChanged||l.doNotHandleCursors||this._changeCursor(""),this._manageFocus()}_cleanControlAfterRemovalFromList(e,t){for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&e[i]===t&&delete e[i]}_cleanControlAfterRemoval(e){this._cleanControlAfterRemovalFromList(this._lastControlDown,e),this._cleanControlAfterRemovalFromList(this._lastControlOver,e)}pick(e,t,i=null){this._isFullscreen&&this._scene&&this._translateToPicking(this._scene,new te.L(0,0,0,0),i,e,t)}_translateToPicking(e,t,i,s=e.pointerX,r=e.pointerY){const n=e.cameraToUseForPointers||e.activeCamera,a=e.getEngine(),o=e.cameraToUseForPointers;if(n)if(n.rigCameras.length){const i=new te.L(0,0,1,1);n.rigCameras.forEach((n=>{n.viewport.toGlobalToRef(a.getRenderWidth(),a.getRenderHeight(),i);const o=s/a.getHardwareScalingLevel()-i.x,l=r/a.getHardwareScalingLevel()-(a.getRenderHeight()-i.y-i.height);o<0||l<0||s>i.width||r>i.height||(e.cameraToUseForPointers=n,t.x=i.x,t.y=i.y,t.width=i.width,t.height=i.height)}))}else n.viewport.toGlobalToRef(a.getRenderWidth(),a.getRenderHeight(),t);else t.x=0,t.y=0,t.width=a.getRenderWidth(),t.height=a.getRenderHeight();const l=s/a.getHardwareScalingLevel()-t.x,h=r/a.getHardwareScalingLevel()-(a.getRenderHeight()-t.y-t.height);if(this._shouldBlockPointer=!1,i){const e=i.event.pointerId||this._defaultMousePointerId;this._doPicking(l,h,i,i.type,e,i.event.button,i.event.deltaX,i.event.deltaY),(this._shouldBlockPointer&&!(i.type&this.skipBlockEvents)||this._capturingControl[e])&&(i.skipOnPointerObservable=!0)}else this._doPicking(l,h,null,Rt.Zp.POINTERMOVE,this._defaultMousePointerId,0);e.cameraToUseForPointers=o}attach(){const e=this.getScene();if(!e)return;const t=new te.L(0,0,0,0);this._prePointerObserver=e.onPrePointerObservable.add((i=>{if((!e.isPointerCaptured(i.event.pointerId)||i.type!==Rt.Zp.POINTERUP||this._capturedPointerIds.has(i.event.pointerId))&&(i.type===Rt.Zp.POINTERMOVE||i.type===Rt.Zp.POINTERUP||i.type===Rt.Zp.POINTERDOWN||i.type===Rt.Zp.POINTERWHEEL)){if(i.type===Rt.Zp.POINTERMOVE){if(e.isPointerCaptured(i.event.pointerId))return;i.event.pointerId&&(this._defaultMousePointerId=i.event.pointerId)}this._translateToPicking(e,t,i)}})),this._attachPickingToSceneRender(e,(()=>this._translateToPicking(e,t,null)),!1),this._attachToOnPointerOut(e),this._attachToOnBlur(e)}registerClipboardEvents(){self.addEventListener("copy",this._onClipboardCopy,!1),self.addEventListener("cut",this._onClipboardCut,!1),self.addEventListener("paste",this._onClipboardPaste,!1)}unRegisterClipboardEvents(){self.removeEventListener("copy",this._onClipboardCopy),self.removeEventListener("cut",this._onClipboardCut),self.removeEventListener("paste",this._onClipboardPaste)}_transformUvs(e){const t=this.getTextureMatrix();let i;if(t.isIdentityAs3x2())i=e;else{const s=I.AA.Matrix[0];t.getRowToRef(0,I.AA.Vector4[0]),t.getRowToRef(1,I.AA.Vector4[1]),t.getRowToRef(2,I.AA.Vector4[2]);const r=I.AA.Vector4[0],n=I.AA.Vector4[1],a=I.AA.Vector4[2];s.setRowFromFloats(0,r.x,r.y,0,0),s.setRowFromFloats(1,n.x,n.y,0,0),s.setRowFromFloats(2,0,0,1,0),s.setRowFromFloats(3,a.x,a.y,0,1),i=I.AA.Vector2[0],I.I9.TransformToRef(e,s,i)}if((this.wrapU===G.g.WRAP_ADDRESSMODE||this.wrapU===G.g.MIRROR_ADDRESSMODE)&&i.x>1){let e=i.x-Math.trunc(i.x);this.wrapU===G.g.MIRROR_ADDRESSMODE&&Math.trunc(i.x)%2==1&&(e=1-e),i.x=e}if((this.wrapV===G.g.WRAP_ADDRESSMODE||this.wrapV===G.g.MIRROR_ADDRESSMODE)&&i.y>1){let e=i.y-Math.trunc(i.y);this.wrapV===G.g.MIRROR_ADDRESSMODE&&Math.trunc(i.x)%2==1&&(e=1-e),i.y=e}return i}attachToMesh(e,t=!0){const i=this.getScene();i&&(this._pointerObserver&&i.onPointerObservable.remove(this._pointerObserver),this._pointerObserver=i.onPointerObservable.add((t=>{if(t.type!==Rt.Zp.POINTERMOVE&&t.type!==Rt.Zp.POINTERUP&&t.type!==Rt.Zp.POINTERDOWN&&t.type!==Rt.Zp.POINTERWHEEL)return;t.type===Rt.Zp.POINTERMOVE&&t.event.pointerId&&(this._defaultMousePointerId=t.event.pointerId);const i=t.event.pointerId||this._defaultMousePointerId;if(t.pickInfo&&t.pickInfo.hit&&t.pickInfo.pickedMesh===e){let e=t.pickInfo.getTextureCoordinates();if(e){e=this._transformUvs(e);const s=this.getSize();this._doPicking(e.x*s.width,(this.applyYInversionOnUpdate?1-e.y:e.y)*s.height,t,t.type,i,t.event.button,t.event.deltaX,t.event.deltaY)}}else if(t.type===Rt.Zp.POINTERUP){if(this._lastControlDown[i]&&this._lastControlDown[i]._forcePointerUp(i),delete this._lastControlDown[i],this.focusedControl){const e=this.focusedControl.keepsFocusWith();let t=!0;if(e)for(const s of e){if(this===s._host)continue;const e=s._host;if(e._lastControlOver[i]&&e._lastControlOver[i].isAscendant(s)){t=!1;break}}t&&(this.focusedControl=null)}}else t.type===Rt.Zp.POINTERMOVE&&(this._lastControlOver[i]&&this._lastControlOver[i]._onPointerOut(this._lastControlOver[i],t,!0),delete this._lastControlOver[i])})),e.enablePointerMoveEvents=t,this._attachPickingToSceneRender(i,(()=>{const t=this._defaultMousePointerId,s=i?.pick(i.pointerX,i.pointerY);if(s&&s.hit&&s.pickedMesh===e){let e=s.getTextureCoordinates();if(e){e=this._transformUvs(e);const i=this.getSize();this._doPicking(e.x*i.width,(this.applyYInversionOnUpdate?1-e.y:e.y)*i.height,null,Rt.Zp.POINTERMOVE,t,0)}}else this._lastControlOver[t]&&this._lastControlOver[t]._onPointerOut(this._lastControlOver[t],null,!0),delete this._lastControlOver[t]}),!0),this._attachToOnPointerOut(i),this._attachToOnBlur(i))}moveFocusToControl(e){this.focusedControl=e,this._lastPickedControl=e,this._blockNextFocusCheck=!0}_manageFocus(){if(this._blockNextFocusCheck)return this._blockNextFocusCheck=!1,void(this._lastPickedControl=this._focusedControl);if(this._focusedControl&&this._focusedControl!==this._lastPickedControl){if(this._lastPickedControl.isFocusInvisible)return;this.focusedControl=null}}_attachPickingToSceneRender(e,t,i){this._sceneRenderObserver=e.onBeforeRenderObservable.add((()=>{this.checkPointerEveryFrame&&(this._linkedControls.length>0||i)&&t()}))}_attachToOnPointerOut(e){this._canvasPointerOutObserver=e.getEngine().onCanvasPointerOutObservable.add((e=>{this._lastControlOver[e.pointerId]&&this._lastControlOver[e.pointerId]._onPointerOut(this._lastControlOver[e.pointerId],null),delete this._lastControlOver[e.pointerId],this._lastControlDown[e.pointerId]&&this._lastControlDown[e.pointerId]!==this._capturingControl[e.pointerId]&&(this._lastControlDown[e.pointerId]._forcePointerUp(e.pointerId),delete this._lastControlDown[e.pointerId])}))}_attachToOnBlur(e){this._canvasBlurObserver=e.getEngine().onCanvasBlurObservable.add((()=>{Object.entries(this._lastControlDown).forEach((([,e])=>{e._onCanvasBlur()})),this.focusedControl=null,this._lastControlDown={}}))}serializeContent(){const e=this.getSize(),t={root:{},width:e.width,height:e.height};return this._rootContainer.serialize(t.root),t}parseSerializedObject(e,t,i){if(this._rootContainer=Xl.Parse(e.root,this,i),t){const t=e.width,i=e.height;"number"==typeof t&&"number"==typeof i&&t>=0&&i>=0?this.scaleTo(t,i):this.scaleTo(1920,1080)}}clone(e,t){const i=this.getScene();if(!i)return this;const s=this.getSize(),r=this.serializeContent();let n;return n=this._isFullscreen?Ch.CreateFullscreenUI(e??"Clone of "+this.name):t?Ch.CreateForMesh(t,s.width,s.height):new Ch(e??"Clone of "+this.name,s.width,s.height,i,!this.noMipmap,this.samplingMode),n.parseSerializedObject(r),n}static async ParseFromSnippetAsync(e,t,i,s){const r=i??Ch.CreateFullscreenUI("ADT from snippet");if("_BLANK"===e)return r;const n=await Ch._LoadURLContentAsync(Ch.SnippetUrl+"/"+e.replace(/#/g,"/"),!0);return r.parseSerializedObject(n,t,s),r}parseFromSnippetAsync(e,t,i){return Ch.ParseFromSnippetAsync(e,t,this,i)}static async ParseFromFileAsync(e,t,i,s){const r=i??Ch.CreateFullscreenUI("ADT from URL"),n=await Ch._LoadURLContentAsync(e);return r.parseSerializedObject(n,t,s),r}parseFromURLAsync(e,t,i){return Ch.ParseFromFileAsync(e,t,this,i)}static _LoadURLContentAsync(e,t=!1){return""===e?Promise.reject("No URL provided"):new Promise(((i,s)=>{const r=new kt.u;r.addEventListener("readystatechange",(()=>{if(4==r.readyState)if(200==r.status){let e;if(t){const t=JSON.parse(JSON.parse(r.responseText).jsonPayload);e=t.encodedGui?new TextDecoder("utf-8").decode((0,yh.yS)(t.encodedGui)):t.gui}else e=r.responseText;const s=JSON.parse(e);i(s)}else s("Unable to load")})),r.open("GET",e),r.send()}))}static _Overlaps(e,t){return!(e.centerX>t.centerX+t.widthInPixels||e.centerX+e.widthInPixels<t.centerX||e.centerY+e.heightInPixels<t.centerY||e.centerY>t.centerY+t.heightInPixels)}static CreateForMesh(e,t=1024,i=1024,s=!0,r=!1,n,a=this._CreateMaterial,o=G.g.TRILINEAR_SAMPLINGMODE){const l=(0,Vs.z)(),h=new Ch(`AdvancedDynamicTexture for ${e.name} [${l}]`,t,i,e.getScene(),!0,o,n);return a(e,l,h,r),h.attachToMesh(e,s),h}static _CreateMaterial(e,t,i,s){const r=(0,V.n9)("BABYLON.StandardMaterial");if(!r)throw"StandardMaterial needs to be imported before as it contains a side-effect required by your code.";const n=new r(`AdvancedDynamicTextureMaterial for ${e.name} [${t}]`,e.getScene());n.backFaceCulling=!1,n.diffuseColor=M.v9.Black(),n.specularColor=M.v9.Black(),s?(n.diffuseTexture=i,n.emissiveTexture=i,i.hasAlpha=!0):(n.emissiveTexture=i,n.opacityTexture=i),e.material=n}static CreateForMeshTexture(e,t=1024,i=1024,s=!0,r,n=G.g.TRILINEAR_SAMPLINGMODE){const a=new Ch(e.name+" AdvancedDynamicTexture",t,i,e.getScene(),!0,n,r);return a.attachToMesh(e,s),a}static CreateFullscreenUI(e,t=!0,i=null,s=G.g.BILINEAR_SAMPLINGMODE,r=!1){const n=new Ch(e,0,0,i,!1,s),a=n.getScene(),o=new Fo(e+"_layer",null,a,!t);if(o.texture=n,n._layerToDispose=o,n._isFullscreen=!0,r&&a){const e=1/a.getEngine().getHardwareScalingLevel();n._rootContainer.scaleX=e,n._rootContainer.scaleY=e}return n.attach(),n}scale(e){super.scale(e),this.markAsDirty()}scaleTo(e,t){super.scaleTo(e,t),this.markAsDirty()}_checkGuiIsReady(){this.guiIsReady()&&(this.onGuiReadyObservable.notifyObservers(this),this.onGuiReadyObservable.clear())}guiIsReady(){return this._rootContainer.isReady()}}Ch.SnippetUrl=Pa.Y.SnippetUrl,Ch.AllowGPUOptimizations=!0;class Ph extends I.Pq{constructor(e,t=0){super(e.x,e.y,e.z),this.buttonIndex=t}}class Eh{get position(){return this._node?this._node.position:I.Pq.Zero()}set position(e){this._node&&(this._node.position=e)}get scaling(){return this._node?this._node.scaling:new I.Pq(1,1,1)}set scaling(e){this._node&&(this._isScaledByManager=!1,this._node.scaling=e)}get behaviors(){return this._behaviors}addBehavior(e){if(-1!==this._behaviors.indexOf(e))return this;e.init();const t=this._host.scene;return t.isLoading?t.onDataLoadedObservable.addOnce((()=>{e.attach(this)})):e.attach(this),this._behaviors.push(e),this}removeBehavior(e){const t=this._behaviors.indexOf(e);return-1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}get isVisible(){return this._isVisible}set isVisible(e){if(this._isVisible===e)return;this._isVisible=e;const t=this.mesh;t&&t.setEnabled(e)}constructor(e){this.name=e,this._downCount=0,this._enterCount=-1,this._downPointerIds={},this._isVisible=!0,this._isScaledByManager=!1,this.onPointerMoveObservable=new C.cP,this.onPointerOutObservable=new C.cP,this.onPointerDownObservable=new C.cP,this.onPointerUpObservable=new C.cP,this.onPointerClickObservable=new C.cP,this.onPointerEnterObservable=new C.cP,this._behaviors=new Array}get typeName(){return this._getTypeName()}getClassName(){return this._getTypeName()}_getTypeName(){return"Control3D"}get node(){return this._node}get mesh(){return this._node instanceof bt?this._node:null}linkToTransformNode(e){return this._node&&(this._node.parent=e),this}_prepareNode(e){if(!this._node){if(this._node=this._createNode(e),!this.node)return;this._injectGUI3DReservedDataStore(this.node).control=this;const t=this.mesh;t&&(t.isPickable=!0,this._affectMaterial(t))}}_injectGUI3DReservedDataStore(e){return e.reservedDataStore=e.reservedDataStore??{},e.reservedDataStore.GUI3D=e.reservedDataStore.GUI3D??{},e.reservedDataStore.GUI3D}_createNode(e){return null}_affectMaterial(e){e.material=null}_isTouchButton3D(e){return void 0!==e._generatePointerEventType}_onPointerMove(e,t){this.onPointerMoveObservable.notifyObservers(t,-1,e,this)}_onPointerEnter(e){return-1===this._enterCount&&(this._enterCount=0),this._enterCount++,!(this._enterCount>1||(this.onPointerEnterObservable.notifyObservers(this,-1,e,this),this.pointerEnterAnimation&&this.pointerEnterAnimation(),0))}_onPointerOut(e){this._enterCount--,this._enterCount>0||(this._enterCount=0,this.onPointerOutObservable.notifyObservers(this,-1,e,this),this.pointerOutAnimation&&this.pointerOutAnimation())}_onPointerDown(e,t,i,s){return this._downCount++,this._downPointerIds[i]=this._downPointerIds[i]+1||1,1===this._downCount&&(this.onPointerDownObservable.notifyObservers(new Ph(t,s),-1,e,this),this.pointerDownAnimation&&this.pointerDownAnimation(),!0)}_onPointerUp(e,t,i,s,r){this._downCount--,this._downPointerIds[i]--,this._downPointerIds[i]<=0&&delete this._downPointerIds[i],this._downCount<0?this._downCount=0:0==this._downCount&&(r&&(this._enterCount>0||-1===this._enterCount)&&this.onPointerClickObservable.notifyObservers(new Ph(t,s),-1,e,this),this.onPointerUpObservable.notifyObservers(new Ph(t,s),-1,e,this),this.pointerUpAnimation&&this.pointerUpAnimation())}forcePointerUp(e=null){if(null!==e)this._onPointerUp(this,I.Pq.Zero(),e,0,!0);else{for(const e in this._downPointerIds)this._onPointerUp(this,I.Pq.Zero(),+e,0,!0);this._downCount>0&&(this._downCount=1,this._onPointerUp(this,I.Pq.Zero(),0,0,!0))}}_processObservables(e,t,i,s,r){if(this._isTouchButton3D(this)&&i&&(e=this._generatePointerEventType(e,i,this._downCount)),e===Rt.Zp.POINTERMOVE){this._onPointerMove(this,t);const e=this._host._lastControlOver[s];return e&&e!==this&&e._onPointerOut(this),e!==this&&this._onPointerEnter(this),this._host._lastControlOver[s]=this,!0}return e===Rt.Zp.POINTERDOWN?(this._onPointerDown(this,t,s,r),this._host._lastControlDown[s]=this,this._host._lastPickedControl=this,!0):(e===Rt.Zp.POINTERUP||e===Rt.Zp.POINTERDOUBLETAP)&&(this._host._lastControlDown[s]&&this._host._lastControlDown[s]._onPointerUp(this,t,s,r,!0),delete this._host._lastControlDown[s],!0)}_disposeNode(){this._node&&(this._node.dispose(),this._node=null)}dispose(){this.onPointerDownObservable.clear(),this.onPointerEnterObservable.clear(),this.onPointerMoveObservable.clear(),this.onPointerOutObservable.clear(),this.onPointerUpObservable.clear(),this.onPointerClickObservable.clear(),this._disposeNode();for(const e of this._behaviors)e.detach()}}class Ah extends Eh{constructor(){super(...arguments),this._contentResolution=512,this._contentScaleRatio=2}get content(){return this._content}set content(e){this._content=e,e&&this._host&&this._host.utilityLayer&&(this._facadeTexture?this._facadeTexture.rootContainer.clearControls():(this._facadeTexture=new Ch("Facade",this._contentResolution,this._contentResolution,this._host.utilityLayer.utilityLayerScene,!0,G.g.TRILINEAR_SAMPLINGMODE),this._setFacadeTextureScaling(),this._facadeTexture.premulAlpha=!0),this._facadeTexture.addControl(e),this._applyFacade(this._facadeTexture))}_setFacadeTextureScaling(){this._facadeTexture&&(this._facadeTexture.rootContainer.scaleX=this._contentScaleRatio,this._facadeTexture.rootContainer.scaleY=this._contentScaleRatioY??this._contentScaleRatio)}get contentResolution(){return this._contentResolution}set contentResolution(e){this._contentResolution!==e&&(this._contentResolution=e,this._resetContent())}_disposeFacadeTexture(){this._facadeTexture&&(this._facadeTexture.dispose(),this._facadeTexture=null)}_resetContent(){this._disposeFacadeTexture(),this.content=this._content}_applyFacade(e){}}class Rh extends Ah{constructor(e){super(e)}_getTypeName(){return"AbstractButton3D"}_createNode(e){return new dt("button"+this.name,e)}}class Ih extends Rh{constructor(e,t){super(e),this._options={width:1,height:1,depth:.08,...t},this.pointerEnterAnimation=()=>{this.mesh&&(this._currentMaterial.emissiveColor=M.v9.Red())},this.pointerOutAnimation=()=>{this._currentMaterial.emissiveColor=M.v9.Black()},this.pointerDownAnimation=()=>{this.mesh&&this.mesh.scaling.scaleInPlace(.95)},this.pointerUpAnimation=()=>{this.mesh&&this.mesh.scaling.scaleInPlace(1/.95)}}_applyFacade(e){this._currentMaterial.emissiveTexture=e}_getTypeName(){return"Button3D"}_createNode(e){const t=new Array(6);for(let e=0;e<6;e++)t[e]=new I.IU(0,0,0,0);e.useRightHandedSystem?t[0].copyFromFloats(1,0,0,1):t[1].copyFromFloats(0,0,1,1);const i=xi(this.name+"_rootMesh",{width:this._options.width,height:this._options.height,depth:this._options.depth,faceUV:t,wrap:!0},e);return this._contentScaleRatioY=this._contentScaleRatio*this._options.width/this._options.height,this._setFacadeTextureScaling(),i}_affectMaterial(e){const t=new Oe(this.name+"Material",e.getScene());t.specularColor=M.v9.Black(),e.material=t,this._currentMaterial=t,this._resetContent()}dispose(){super.dispose(),this._disposeFacadeTexture(),this._currentMaterial&&this._currentMaterial.dispose()}}class Mh extends Eh{get children(){return this._children}get blockLayout(){return this._blockLayout}set blockLayout(e){this._blockLayout!==e&&(this._blockLayout=e,this._blockLayout||this._arrangeChildren())}constructor(e){super(e),this._blockLayout=!1,this._children=new Array}updateLayout(){return this._arrangeChildren(),this}containsControl(e){return-1!==this._children.indexOf(e)}addControl(e){return-1!==this._children.indexOf(e)||(e.parent=this,e._host=this._host,this._children.push(e),this._host.utilityLayer&&(e._prepareNode(this._host.utilityLayer.utilityLayerScene),e.node&&(e.node.parent=this.node),this.blockLayout||this._arrangeChildren())),this}_arrangeChildren(){}_createNode(e){return new dt("ContainerNode",e)}removeControl(e){const t=this._children.indexOf(e);return-1!==t&&(this._children.splice(t,1),e.parent=null,e._disposeNode()),this}_getTypeName(){return"Container3D"}dispose(){for(const e of this._children)e.dispose();this._children.length=0,super.dispose()}}Mh.UNSET_ORIENTATION=0,Mh.FACEORIGIN_ORIENTATION=1,Mh.FACEORIGINREVERSED_ORIENTATION=2,Mh.FACEFORWARD_ORIENTATION=3,Mh.FACEFORWARDREVERSED_ORIENTATION=4;class Oh extends Mh{get orientation(){return this._orientation}set orientation(e){this._orientation!==e&&(this._orientation=e,ee.S0.SetImmediate((()=>{this._arrangeChildren()})))}get columns(){return this._columns}set columns(e){this._columns!==e&&(this._columns=e,this._rowThenColum=!0,ee.S0.SetImmediate((()=>{this._arrangeChildren()})))}get rows(){return this._rows}set rows(e){this._rows!==e&&(this._rows=e,this._rowThenColum=!1,ee.S0.SetImmediate((()=>{this._arrangeChildren()})))}constructor(e){super(e),this._columns=10,this._rows=0,this._rowThenColum=!0,this._orientation=Mh.FACEORIGIN_ORIENTATION,this.margin=0}_arrangeChildren(){this._cellWidth=0,this._cellHeight=0;let e=0,t=0,i=0;const s=I.uq.Invert(this.node.computeWorldMatrix(!0));for(const e of this._children){if(!e.mesh)continue;i++,e.mesh.computeWorldMatrix(!0);const t=e.mesh.getHierarchyBoundingVectors(),r=I.AA.Vector3[0],n=I.AA.Vector3[1];t.max.subtractToRef(t.min,n),n.scaleInPlace(.5),I.Pq.TransformNormalToRef(n,s,r),this._cellWidth=Math.max(this._cellWidth,2*r.x),this._cellHeight=Math.max(this._cellHeight,2*r.y)}this._cellWidth+=2*this.margin,this._cellHeight+=2*this.margin,this._rowThenColum?(t=this._columns,e=Math.ceil(i/this._columns)):(e=this._rows,t=Math.ceil(i/this._rows));const r=.5*t*this._cellWidth,n=.5*e*this._cellHeight,a=[];let o=0;if(this._rowThenColum)for(let s=0;s<e;s++)for(let e=0;e<t&&(a.push(new I.Pq(e*this._cellWidth-r+this._cellWidth/2,s*this._cellHeight-n+this._cellHeight/2,0)),o++,!(o>i));e++);else for(let s=0;s<t;s++)for(let t=0;t<e&&(a.push(new I.Pq(s*this._cellWidth-r+this._cellWidth/2,t*this._cellHeight-n+this._cellHeight/2,0)),o++,!(o>i));t++);o=0;for(const e of this._children)e.mesh&&(this._mapGridNode(e,a[o]),o++);this._finalProcessing()}_finalProcessing(){}}ae.l.ShadersStore.fluentVertexShader="precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;uniform mat4 world;uniform mat4 viewProjection;varying vec2 vUV;\n#ifdef BORDER\nvarying vec2 scaleInfo;uniform float borderWidth;uniform vec3 scaleFactor;\n#endif\n#ifdef HOVERLIGHT\nvarying vec3 worldPosition;\n#endif\nvoid main(void) {vUV=uv;\n#ifdef BORDER\nvec3 scale=scaleFactor;float minScale=min(min(scale.x,scale.y),scale.z);float maxScale=max(max(scale.x,scale.y),scale.z);float minOverMiddleScale=minScale/(scale.x+scale.y+scale.z-minScale-maxScale);float areaYZ=scale.y*scale.z;float areaXZ=scale.x*scale.z;float areaXY=scale.x*scale.y;float scaledBorderWidth=borderWidth; \nif (abs(normal.x)==1.0) \n{scale.x=scale.y;scale.y=scale.z;if (areaYZ>areaXZ && areaYZ>areaXY)\n{scaledBorderWidth*=minOverMiddleScale;}}\nelse if (abs(normal.y)==1.0) \n{scale.x=scale.z;if (areaXZ>areaXY && areaXZ>areaYZ)\n{scaledBorderWidth*=minOverMiddleScale;}}\nelse \n{if (areaXY>areaYZ && areaXY>areaXZ)\n{scaledBorderWidth*=minOverMiddleScale;}}\nfloat scaleRatio=min(scale.x,scale.y)/max(scale.x,scale.y);if (scale.x>scale.y)\n{scaleInfo.x=1.0-(scaledBorderWidth*scaleRatio);scaleInfo.y=1.0-scaledBorderWidth;}\nelse\n{scaleInfo.x=1.0-scaledBorderWidth;scaleInfo.y=1.0-(scaledBorderWidth*scaleRatio);} \n#endif \nvec4 worldPos=world*vec4(position,1.0);\n#ifdef HOVERLIGHT\nworldPosition=worldPos.xyz;\n#endif\ngl_Position=viewProjection*worldPos;}\n";ae.l.ShadersStore.fluentPixelShader="precision highp float;varying vec2 vUV;uniform vec4 albedoColor;\n#ifdef INNERGLOW\nuniform vec4 innerGlowColor;\n#endif\n#ifdef BORDER\nvarying vec2 scaleInfo;uniform float edgeSmoothingValue;uniform float borderMinValue;\n#endif\n#ifdef HOVERLIGHT\nvarying vec3 worldPosition;uniform vec3 hoverPosition;uniform vec4 hoverColor;uniform float hoverRadius;\n#endif\n#ifdef TEXTURE\nuniform sampler2D albedoSampler;uniform mat4 textureMatrix;vec2 finalUV;\n#endif\nvoid main(void) {vec3 albedo=albedoColor.rgb;float alpha=albedoColor.a;\n#ifdef TEXTURE\nfinalUV=vec2(textureMatrix*vec4(vUV,1.0,0.0));albedo=texture2D(albedoSampler,finalUV).rgb;\n#endif\n#ifdef HOVERLIGHT\nfloat pointToHover=(1.0-clamp(length(hoverPosition-worldPosition)/hoverRadius,0.,1.))*hoverColor.a;albedo=clamp(albedo+hoverColor.rgb*pointToHover,0.,1.);\n#else\nfloat pointToHover=1.0;\n#endif\n#ifdef BORDER \nfloat borderPower=10.0;float inverseBorderPower=1.0/borderPower;vec3 borderColor=albedo*borderPower;vec2 distanceToEdge;distanceToEdge.x=abs(vUV.x-0.5)*2.0;distanceToEdge.y=abs(vUV.y-0.5)*2.0;float borderValue=max(smoothstep(scaleInfo.x-edgeSmoothingValue,scaleInfo.x+edgeSmoothingValue,distanceToEdge.x),\nsmoothstep(scaleInfo.y-edgeSmoothingValue,scaleInfo.y+edgeSmoothingValue,distanceToEdge.y));borderColor=borderColor*borderValue*max(borderMinValue*inverseBorderPower,pointToHover); \nalbedo+=borderColor;alpha=max(alpha,borderValue);\n#endif\n#ifdef INNERGLOW\nvec2 uvGlow=(vUV-vec2(0.5,0.5))*(innerGlowColor.a*2.0);uvGlow=uvGlow*uvGlow;uvGlow=uvGlow*uvGlow;albedo+=mix(vec3(0.0,0.0,0.0),innerGlowColor.rgb,uvGlow.x+uvGlow.y); \n#endif\ngl_FragColor=vec4(albedo,alpha);}";class wh extends ye.M{constructor(){super(),this.INNERGLOW=!1,this.BORDER=!1,this.HOVERLIGHT=!1,this.TEXTURE=!1,this.rebuild()}}class Dh extends Ce{constructor(e,t){super(e,t),this.innerGlowColorIntensity=.5,this.innerGlowColor=new M.v9(1,1,1),this.albedoColor=new M.v9(.3,.35,.4),this.renderBorders=!1,this.borderWidth=.5,this.edgeSmoothingValue=.02,this.borderMinValue=.1,this.renderHoverLight=!1,this.hoverRadius=.01,this.hoverColor=new M.ov(.3,.3,.3,1),this.hoverPosition=I.Pq.Zero()}needAlphaBlending(){return 1!==this.alpha}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){const i=t._drawWrapper;if(this.isFrozen&&i.effect&&i._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new wh);const s=this.getScene(),r=t.materialDefines;if(!this.checkReadyOnEveryCall&&t.effect&&r._renderId===s.getRenderId())return!0;if(r._areTexturesDirty)if(r.INNERGLOW=this.innerGlowColorIntensity>0,r.BORDER=this.renderBorders,r.HOVERLIGHT=this.renderHoverLight,this._albedoTexture){if(!this._albedoTexture.isReadyOrNotBlocking())return!1;r.TEXTURE=!0}else r.TEXTURE=!1;const n=s.getEngine();if(r.isDirty){r.markAsProcessed(),s.resetCachedMaterial();const e=[O.R.PositionKind];e.push(O.R.NormalKind),e.push(O.R.UVKind);const i="fluent",a=["world","viewProjection","innerGlowColor","albedoColor","borderWidth","edgeSmoothingValue","scaleFactor","borderMinValue","hoverColor","hoverPosition","hoverRadius","textureMatrix"],o=["albedoSampler"],l=[];(0,$.Bb)({uniformsNames:a,uniformBuffersNames:l,samplers:o,defines:r,maxSimultaneousLights:4});const h=r.toString();t.setEffect(s.getEngine().createEffect(i,{attributes:e,uniformsNames:a,uniformBuffersNames:l,samplers:o,defines:h,fallbacks:null,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),r,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(r._renderId=s.getRenderId(),i._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;if(n){if(this._activeEffect=n,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),this._mustRebind(s,n,i)&&(this._activeEffect.setColor4("albedoColor",this.albedoColor,this.alpha),r.INNERGLOW&&this._activeEffect.setColor4("innerGlowColor",this.innerGlowColor,this.innerGlowColorIntensity),r.BORDER&&(this._activeEffect.setFloat("borderWidth",this.borderWidth),this._activeEffect.setFloat("edgeSmoothingValue",this.edgeSmoothingValue),this._activeEffect.setFloat("borderMinValue",this.borderMinValue),t.getBoundingInfo().boundingBox.extendSize.multiplyToRef(t.scaling,I.AA.Vector3[0]),this._activeEffect.setVector3("scaleFactor",I.AA.Vector3[0])),r.HOVERLIGHT&&(this._activeEffect.setDirectColor4("hoverColor",this.hoverColor),this._activeEffect.setFloat("hoverRadius",this.hoverRadius),this._activeEffect.setVector3("hoverPosition",this.hoverPosition)),r.TEXTURE&&this._albedoTexture)){this._activeEffect.setTexture("albedoSampler",this._albedoTexture);const e=this._albedoTexture.getTextureMatrix();this._activeEffect.setMatrix("textureMatrix",e)}this._afterBind(t,this._activeEffect,i)}}getActiveTextures(){return super.getActiveTextures()}hasTexture(e){return!!super.hasTexture(e)}dispose(e){super.dispose(e)}clone(e){return N.p.Clone((()=>new Dh(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.GUI.FluentMaterial",e}getClassName(){return"FluentMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new Dh(e.name,t)),e,t,i)}}(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Dh.prototype,"innerGlowColorIntensity",void 0),(0,w.Cg)([(0,D.jT)()],Dh.prototype,"innerGlowColor",void 0),(0,w.Cg)([(0,D.jT)()],Dh.prototype,"albedoColor",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Dh.prototype,"renderBorders",void 0),(0,w.Cg)([(0,D.lK)()],Dh.prototype,"borderWidth",void 0),(0,w.Cg)([(0,D.lK)()],Dh.prototype,"edgeSmoothingValue",void 0),(0,w.Cg)([(0,D.lK)()],Dh.prototype,"borderMinValue",void 0),(0,w.Cg)([(0,D.lK)(),(0,D.$z)("_markAllSubMeshesAsTexturesDirty")],Dh.prototype,"renderHoverLight",void 0),(0,w.Cg)([(0,D.lK)()],Dh.prototype,"hoverRadius",void 0),(0,w.Cg)([(0,D.qK)()],Dh.prototype,"hoverColor",void 0),(0,w.Cg)([(0,D.P_)()],Dh.prototype,"hoverPosition",void 0),(0,w.Cg)([(0,D.uM)("albedoTexture")],Dh.prototype,"_albedoTexture",void 0),(0,w.Cg)([(0,D.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],Dh.prototype,"albedoTexture",void 0),(0,V.Y5)("BABYLON.GUI.FluentMaterial",Dh);class Fh extends Oh{get backPlateMargin(){return this._backPlateMargin}set backPlateMargin(e){this._backPlateMargin=e,this._children.length>=1&&(this.children.forEach((e=>{this._updateCurrentMinMax(e.position)})),this._updateMargins())}_createNode(e){const t=new At(`menu_${this.name}`,e);return this._backPlate=xi("backPlate"+this.name,{size:1},e),this._backPlate.parent=t,t}_affectMaterial(e){this._backPlateMaterial=new Dh(this.name+"backPlateMaterial",e.getScene()),this._backPlateMaterial.albedoColor=new M.v9(.08,.15,.55),this._backPlateMaterial.renderBorders=!0,this._backPlateMaterial.renderHoverLight=!0,this._pickedPointObserver=this._host.onPickedPointChangedObservable.add((e=>{e?(this._backPlateMaterial.hoverPosition=e,this._backPlateMaterial.hoverColor.a=1):this._backPlateMaterial.hoverColor.a=0})),this._backPlate.material=this._backPlateMaterial}_mapGridNode(e,t){e.mesh&&(e.position=t.clone(),this._updateCurrentMinMax(t))}_finalProcessing(){this._updateMargins()}_updateCurrentMinMax(e){this._currentMin||(this._currentMin=e.clone(),this._currentMax=e.clone()),this._currentMin.minimizeInPlace(e),this._currentMax.maximizeInPlace(e)}_updateMargins(){if(this._children.length>0){this._currentMin.addInPlaceFromFloats(-this._cellWidth/2,-this._cellHeight/2,0),this._currentMax.addInPlaceFromFloats(this._cellWidth/2,this._cellHeight/2,0);const e=this._currentMax.subtract(this._currentMin);this._backPlate.scaling.x=e.x+this._cellWidth*this.backPlateMargin,this._backPlate.scaling.y=e.y+this._cellHeight*this.backPlateMargin,this._backPlate.scaling.z=.001;for(let t=0;t<this._children.length;t++)this._children[t].position.subtractInPlace(this._currentMin).subtractInPlace(e.scale(.5)),this._children[t].position.z-=.01}this._currentMin=null,this._currentMax=null}constructor(e){super(e),this._backPlateMargin=1.25}addButton(e){const t=this.blockLayout;return t||(this.blockLayout=!0),super.addControl(e),e.isBackplateVisible=!1,e.scaling.scaleInPlace(Fh.MENU_BUTTON_SCALE),t||(this.blockLayout=!1),this}addControl(e){return l.V.Warn("TouchHolographicMenu can only contain buttons. Please use the method `addButton` instead."),this}dispose(){super.dispose(),this._host.onPickedPointChangedObservable.remove(this._pickedPointObserver)}}var Nh,Lh,Bh;Fh.MENU_BUTTON_SCALE=1,function(e){e[e.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",e[e.RADIAL_SIDE=1]="RADIAL_SIDE",e[e.ULNAR_SIDE=2]="ULNAR_SIDE",e[e.BELOW_WRIST=3]="BELOW_WRIST"}(Nh||(Nh={})),function(e){e[e.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",e[e.HAND_ROTATION=1]="HAND_ROTATION"}(Lh||(Lh={})),function(e){e[e.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",e[e.PALM_UP=1]="PALM_UP",e[e.GAZE_FOCUS=2]="GAZE_FOCUS",e[e.PALM_AND_GAZE=3]="PALM_AND_GAZE"}(Bh||(Bh={}));ae.l.ShadersStore.fluentBackplatePixelShader="uniform vec3 cameraPosition;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;uniform float _Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Filter_Width_;uniform vec4 _Base_Color_;uniform vec4 _Line_Color_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform float _Rate_;uniform vec4 _Highlight_Color_;uniform float _Highlight_Width_;uniform vec4 _Highlight_Transform_;uniform float _Highlight_;uniform float _Iridescence_Intensity_;uniform float _Iridescence_Edge_Intensity_;uniform float _Angle_;uniform float _Fade_Out_;uniform bool _Reflected_;uniform float _Frequency_;uniform float _Vertical_Offset_;uniform sampler2D _Iridescent_Map_;uniform bool _Use_Global_Left_Index_;uniform bool _Use_Global_Right_Index_;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;void Round_Rect_Fragment_B31(\nfloat Radius,\nfloat Line_Width,\nvec4 Line_Color,\nfloat Filter_Width,\nvec2 UV,\nfloat Line_Visibility,\nvec4 Rect_Parms,\nvec4 Fill_Color,\nout vec4 Color)\n{float d=length(max(abs(UV)-Rect_Parms.xy,0.0));float dx=max(fwidth(d)*Filter_Width,0.00001);float g=min(Rect_Parms.z,Rect_Parms.w);float dgrad=max(fwidth(g)*Filter_Width,0.00001);float Inside_Rect=clamp(g/dgrad,0.0,1.0);float inner=clamp((d+dx*0.5-max(Radius-Line_Width,d-dx*0.5))/dx,0.0,1.0);Color=clamp(mix(Fill_Color,Line_Color,inner),0.0,1.0)*Inside_Rect;}\nvoid Blob_Fragment_B71(\nsampler2D Blob_Texture,\nvec4 Blob_Info1,\nvec4 Blob_Info2,\nout vec4 Blob_Color)\n{float k1=dot(Blob_Info1.xy,Blob_Info1.xy);float k2=dot(Blob_Info2.xy,Blob_Info2.xy);vec3 closer=k1<k2 ? vec3(k1,Blob_Info1.z,Blob_Info1.w) : vec3(k2,Blob_Info2.z,Blob_Info2.w);Blob_Color=closer.z*texture(Blob_Texture,vec2(vec2(sqrt(closer.x),closer.y).x,1.0-vec2(sqrt(closer.x),closer.y).y))*clamp(1.0-closer.x,0.0,1.0);}\nvoid Line_Fragment_B48(\nvec4 Base_Color,\nvec4 Highlight_Color,\nfloat Highlight_Width,\nvec3 Line_Vertex,\nfloat Highlight,\nout vec4 Line_Color)\n{float k2=1.0-clamp(abs(Line_Vertex.y/Highlight_Width),0.0,1.0);Line_Color=mix(Base_Color,Highlight_Color,Highlight*k2);}\nvoid Scale_RGB_B54(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Conditional_Float_B38(\nbool Which,\nfloat If_True,\nfloat If_False,\nout float Result)\n{Result=Which ? If_True : If_False;}\nvoid main()\n{float R_Q72;float G_Q72;float B_Q72;float A_Q72;R_Q72=vColor.r; G_Q72=vColor.g; B_Q72=vColor.b; A_Q72=vColor.a;vec4 Blob_Color_Q71;\n#if BLOB_ENABLE\nfloat k1=dot(vExtra2.xy,vExtra2.xy);float k2=dot(vExtra3.xy,vExtra3.xy);vec3 closer=k1<k2 ? vec3(k1,vExtra2.z,vExtra2.w) : vec3(k2,vExtra3.z,vExtra3.w);Blob_Color_Q71=closer.z*texture(_Blob_Texture_,vec2(vec2(sqrt(closer.x),closer.y).x,1.0-vec2(sqrt(closer.x),closer.y).y))*clamp(1.0-closer.x,0.0,1.0);\n#else\nBlob_Color_Q71=vec4(0,0,0,0);\n#endif\nvec4 Line_Color_Q48;Line_Fragment_B48(_Line_Color_,_Highlight_Color_,_Highlight_Width_,vTangent,_Highlight_,Line_Color_Q48);float X_Q67;float Y_Q67;X_Q67=vUV.x;Y_Q67=vUV.y;vec3 Incident_Q66=normalize(vPosition-cameraPosition);vec3 Reflected_Q60=reflect(Incident_Q66,vBinormal);float Product_Q63=Y_Q67*_Vertical_Offset_;float Dot_Q68=dot(Incident_Q66, Reflected_Q60);float Dot_Q57=dot(vNormal, Incident_Q66);float Result_Q38;Conditional_Float_B38(_Reflected_,Dot_Q68,Dot_Q57,Result_Q38);float Product_Q64=Result_Q38*_Frequency_;float Sum_Q69=Product_Q64+1.0;float Product_Q70=Sum_Q69*0.5;float Sum_Q62=Product_Q63+Product_Q70;float FractF_Q59=fract(Sum_Q62);vec2 Vec2_Q65=vec2(FractF_Q59,0.5);vec4 Color_Q58;\n#if IRIDESCENT_MAP_ENABLE\nColor_Q58=texture(_Iridescent_Map_,Vec2_Q65);\n#else\nColor_Q58=vec4(0,0,0,0);\n#endif\nvec4 Result_Q54;Scale_RGB_B54(Color_Q58,_Iridescence_Edge_Intensity_,Result_Q54);vec4 Result_Q55;Scale_RGB_B54(Color_Q58,_Iridescence_Intensity_,Result_Q55);vec4 Base_And_Iridescent_Q53;Base_And_Iridescent_Q53=Line_Color_Q48+vec4(Result_Q54.rgb,0.0);vec4 Base_And_Iridescent_Q56;Base_And_Iridescent_Q56=_Base_Color_+vec4(Result_Q55.rgb,0.0);vec4 Result_Q52=Base_And_Iridescent_Q53; Result_Q52.a=1.0;vec4 Result_Q35=Blob_Color_Q71+(1.0-Blob_Color_Q71.a)*Base_And_Iridescent_Q56;vec4 Color_Q31;Round_Rect_Fragment_B31(R_Q72,G_Q72,Result_Q52,_Filter_Width_,vUV,1.0,vExtra1,Result_Q35,Color_Q31);vec4 Result_Q47=_Fade_Out_*Color_Q31;vec4 Out_Color=Result_Q47;float Clip_Threshold=0.001;bool To_sRGB=false;gl_FragColor=Out_Color;}";ae.l.ShadersStore.fluentBackplateVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;\n#ifdef TANGENT\nattribute vec3 tangent;\n#else\nconst vec3 tangent=vec3(0.);\n#endif\nuniform float _Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Filter_Width_;uniform vec4 _Base_Color_;uniform vec4 _Line_Color_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform float _Rate_;uniform vec4 _Highlight_Color_;uniform float _Highlight_Width_;uniform vec4 _Highlight_Transform_;uniform float _Highlight_;uniform float _Iridescence_Intensity_;uniform float _Iridescence_Edge_Intensity_;uniform float _Angle_;uniform float _Fade_Out_;uniform bool _Reflected_;uniform float _Frequency_;uniform float _Vertical_Offset_;uniform sampler2D _Iridescent_Map_;uniform bool _Use_Global_Left_Index_;uniform bool _Use_Global_Right_Index_;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;void Object_To_World_Pos_B115(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid PickDir_B140(\nfloat Degrees,\nvec3 DirX,\nvec3 DirY,\nout vec3 Dir)\n{float a=Degrees*3.14159/180.0;Dir=cos(a)*DirX+sin(a)*DirY;}\nvoid Round_Rect_Vertex_B139(\nvec2 UV,\nfloat Radius,\nfloat Margin,\nfloat Anisotropy,\nfloat Gradient1,\nfloat Gradient2,\nout vec2 Rect_UV,\nout vec4 Rect_Parms,\nout vec2 Scale_XY,\nout vec2 Line_UV)\n{Scale_XY=vec2(Anisotropy,1.0);Line_UV=(UV-vec2(0.5,0.5));Rect_UV=Line_UV*Scale_XY;Rect_Parms.xy=Scale_XY*0.5-vec2(Radius,Radius)-vec2(Margin,Margin);Rect_Parms.z=Gradient1; \nRect_Parms.w=Gradient2;}\nvoid Line_Vertex_B135(\nvec2 Scale_XY,\nvec2 UV,\nfloat Time,\nfloat Rate,\nvec4 Highlight_Transform,\nout vec3 Line_Vertex)\n{float angle2=(Rate*Time)*2.0*3.1416;float sinAngle2=sin(angle2);float cosAngle2=cos(angle2);vec2 xformUV=UV*Highlight_Transform.xy+Highlight_Transform.zw;Line_Vertex.x=0.0;Line_Vertex.y=cosAngle2*xformUV.x-sinAngle2*xformUV.y;Line_Vertex.z=0.0; }\nvoid Blob_Vertex_B180(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nfloat Blob_Fade_Length,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nout vec4 Blob_Info)\n{vec3 blob=Blob_Position;vec3 delta=blob-Position;float dist=dot(Normal,delta);float lerpValue=clamp((abs(dist)-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);float fadeValue=1.0-clamp((abs(dist)-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float size=Blob_Near_Size+(Blob_Far_Size-Blob_Near_Size)*lerpValue;vec2 blobXY=vec2(dot(delta,Tangent),dot(delta,Bitangent))/(0.0001+size);float Fade=fadeValue*Intensity*Blob_Fade;float Distance=(lerpValue*0.5+0.5)*(1.0-Blob_Pulse);Blob_Info=vec4(blobXY.x,blobXY.y,Distance,Fade);}\nvoid Move_Verts_B129(\nfloat Anisotropy,\nvec3 P,\nfloat Radius,\nout vec3 New_P,\nout vec2 New_UV,\nout float Radial_Gradient,\nout vec3 Radial_Dir)\n{vec2 UV=P.xy*2.0+0.5;vec2 center=clamp(UV,0.0,1.0);vec2 delta=UV-center;vec2 r2=2.0*vec2(Radius/Anisotropy,Radius);New_UV=center+r2*(UV-2.0*center+0.5);New_P=vec3(New_UV-0.5,P.z);Radial_Gradient=1.0-length(delta)*2.0;Radial_Dir=vec3(delta*r2,0.0);}\nvoid Object_To_World_Dir_B132(\nvec3 Dir_Object,\nout vec3 Binormal_World,\nout vec3 Binormal_World_N,\nout float Binormal_Length)\n{Binormal_World=(world*vec4(Dir_Object,0.0)).xyz;Binormal_Length=length(Binormal_World);Binormal_World_N=Binormal_World/Binormal_Length;}\nvoid RelativeOrAbsoluteDetail_B147(\nfloat Nominal_Radius,\nfloat Nominal_LineWidth,\nbool Absolute_Measurements,\nfloat Height,\nout float Radius,\nout float Line_Width)\n{float scale=Absolute_Measurements ? 1.0/Height : 1.0;Radius=Nominal_Radius*scale;Line_Width=Nominal_LineWidth*scale;}\nvoid Edge_AA_Vertex_B130(\nvec3 Position_World,\nvec3 Position_Object,\nvec3 Normal_Object,\nvec3 Eye,\nfloat Radial_Gradient,\nvec3 Radial_Dir,\nvec3 Tangent,\nout float Gradient1,\nout float Gradient2)\n{vec3 I=(Eye-Position_World);vec3 T=(world* vec4(Tangent,0.0)).xyz;float g=(dot(T,I)<0.0) ? 0.0 : 1.0;if (Normal_Object.z==0.0) { \nGradient1=Position_Object.z>0.0 ? g : 1.0;Gradient2=Position_Object.z>0.0 ? 1.0 : g;} else {Gradient1=g+(1.0-g)*(Radial_Gradient);Gradient2=1.0;}}\nvoid Pick_Radius_B144(\nfloat Radius,\nfloat Radius_Top_Left,\nfloat Radius_Top_Right,\nfloat Radius_Bottom_Left,\nfloat Radius_Bottom_Right,\nvec3 Position,\nout float Result)\n{bool whichY=Position.y>0.0;Result=Position.x<0.0 ? (whichY ? Radius_Top_Left : Radius_Bottom_Left) : (whichY ? Radius_Top_Right : Radius_Bottom_Right);Result*=Radius;}\nvoid main()\n{vec3 Nrm_World_Q128;Nrm_World_Q128=normalize((world*vec4(normal,0.0)).xyz);vec3 Tangent_World_Q131;vec3 Tangent_World_N_Q131;float Tangent_Length_Q131;Tangent_World_Q131=(world*vec4(vec3(1,0,0),0.0)).xyz;Tangent_Length_Q131=length(Tangent_World_Q131);Tangent_World_N_Q131=Tangent_World_Q131/Tangent_Length_Q131;vec3 Binormal_World_Q132;vec3 Binormal_World_N_Q132;float Binormal_Length_Q132;Object_To_World_Dir_B132(vec3(0,1,0),Binormal_World_Q132,Binormal_World_N_Q132,Binormal_Length_Q132);float Anisotropy_Q133=Tangent_Length_Q131/Binormal_Length_Q132;vec3 Result_Q177;Result_Q177=mix(_Blob_Position_,Global_Left_Index_Tip_Position.xyz,float(_Use_Global_Left_Index_));vec3 Result_Q178;Result_Q178=mix(_Blob_Position_2_,Global_Right_Index_Tip_Position.xyz,float(_Use_Global_Right_Index_));float Result_Q144;Pick_Radius_B144(_Radius_,_Radius_Top_Left_,_Radius_Top_Right_,_Radius_Bottom_Left_,_Radius_Bottom_Right_,position,Result_Q144);vec3 Dir_Q140;PickDir_B140(_Angle_,Tangent_World_N_Q131,Binormal_World_N_Q132,Dir_Q140);float Radius_Q147;float Line_Width_Q147;RelativeOrAbsoluteDetail_B147(Result_Q144,_Line_Width_,_Absolute_Sizes_,Binormal_Length_Q132,Radius_Q147,Line_Width_Q147);vec4 Out_Color_Q145=vec4(Radius_Q147,Line_Width_Q147,0,1);vec3 New_P_Q129;vec2 New_UV_Q129;float Radial_Gradient_Q129;vec3 Radial_Dir_Q129;Move_Verts_B129(Anisotropy_Q133,position,Radius_Q147,New_P_Q129,New_UV_Q129,Radial_Gradient_Q129,Radial_Dir_Q129);vec3 Pos_World_Q115;Object_To_World_Pos_B115(New_P_Q129,Pos_World_Q115);vec4 Blob_Info_Q180;\n#if BLOB_ENABLE\nBlob_Vertex_B180(Pos_World_Q115,Nrm_World_Q128,Tangent_World_N_Q131,Binormal_World_N_Q132,Result_Q177,_Blob_Intensity_,_Blob_Near_Size_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_,_Blob_Fade_,Blob_Info_Q180);\n#else\nBlob_Info_Q180=vec4(0,0,0,0);\n#endif\nvec4 Blob_Info_Q181;\n#if BLOB_ENABLE_2\nBlob_Vertex_B180(Pos_World_Q115,Nrm_World_Q128,Tangent_World_N_Q131,Binormal_World_N_Q132,Result_Q178,_Blob_Intensity_,_Blob_Near_Size_2_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_2_,_Blob_Fade_2_,Blob_Info_Q181);\n#else\nBlob_Info_Q181=vec4(0,0,0,0);\n#endif\nfloat Gradient1_Q130;float Gradient2_Q130;\n#if SMOOTH_EDGES\nEdge_AA_Vertex_B130(Pos_World_Q115,position,normal,cameraPosition,Radial_Gradient_Q129,Radial_Dir_Q129,tangent,Gradient1_Q130,Gradient2_Q130);\n#else\nGradient1_Q130=1.0;Gradient2_Q130=1.0;\n#endif\nvec2 Rect_UV_Q139;vec4 Rect_Parms_Q139;vec2 Scale_XY_Q139;vec2 Line_UV_Q139;Round_Rect_Vertex_B139(New_UV_Q129,Radius_Q147,0.0,Anisotropy_Q133,Gradient1_Q130,Gradient2_Q130,Rect_UV_Q139,Rect_Parms_Q139,Scale_XY_Q139,Line_UV_Q139);vec3 Line_Vertex_Q135;Line_Vertex_B135(Scale_XY_Q139,Line_UV_Q139,0.0,_Rate_,_Highlight_Transform_,Line_Vertex_Q135);vec3 Position=Pos_World_Q115;vec3 Normal=Dir_Q140;vec2 UV=Rect_UV_Q139;vec3 Tangent=Line_Vertex_Q135;vec3 Binormal=Nrm_World_Q128;vec4 Color=Out_Color_Q145;vec4 Extra1=Rect_Parms_Q139;vec4 Extra2=Blob_Info_Q180;vec4 Extra3=Blob_Info_Q181;gl_Position=viewProjection*vec4(Position,1);vPosition=Position;vNormal=Normal;vUV=UV;vTangent=Tangent;vBinormal=Binormal;vColor=Color;vExtra1=Extra1;vExtra2=Extra2;vExtra3=Extra3;}";class kh extends ye.M{constructor(){super(),this.BLOB_ENABLE=!0,this.BLOB_ENABLE_2=!0,this.SMOOTH_EDGES=!0,this.IRIDESCENT_MAP_ENABLE=!0,this._needNormals=!0,this.rebuild()}}class Vh extends Ce{constructor(e,t){super(e,t),this.radius=.03,this.lineWidth=.01,this.absoluteSizes=!1,this._filterWidth=1,this.baseColor=new M.ov(.0392157,.0666667,.207843,1),this.lineColor=new M.ov(.14902,.133333,.384314,1),this.blobIntensity=.98,this.blobFarSize=.04,this.blobNearDistance=0,this.blobFarDistance=.08,this.blobFadeLength=.08,this.blobNearSize=.22,this.blobPulse=0,this.blobFade=0,this.blobNearSize2=.22,this.blobPulse2=0,this.blobFade2=0,this._rate=.135,this.highlightColor=new M.ov(.98,.98,.98,1),this.highlightWidth=.25,this._highlightTransform=new I.IU(1,1,0,0),this._highlight=1,this.iridescenceIntensity=0,this.iridescenceEdgeIntensity=1,this._angle=-45,this.fadeOut=1,this._reflected=!0,this._frequency=1,this._verticalOffset=0,this.globalLeftIndexTipPosition=I.Pq.Zero(),this._globalLeftIndexTipPosition4=I.IU.Zero(),this.globalRightIndexTipPosition=I.Pq.Zero(),this._globalRightIndexTipPosition4=I.IU.Zero(),this.alphaMode=Pa.Y.ALPHA_DISABLE,this.backFaceCulling=!1,this._blobTexture=new G.g(Vh.BLOB_TEXTURE_URL,this.getScene(),!0,!1,G.g.NEAREST_SAMPLINGMODE),this._iridescentMap=new G.g(Vh.IM_TEXTURE_URL,this.getScene(),!0,!1,G.g.NEAREST_SAMPLINGMODE)}needAlphaBlending(){return!1}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){const i=t._drawWrapper;if(this.isFrozen&&i.effect&&i._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new kh);const s=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if((0,$.qB)(e,s,!1,!1),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial();const e=new K;s.FOG&&e.addFallback(1,"FOG"),(0,$.c4)(s,e),s.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess;const i=[O.R.PositionKind];s.NORMAL&&i.push(O.R.NormalKind),s.UV1&&i.push(O.R.UVKind),s.UV2&&i.push(O.R.UV2Kind),s.VERTEXCOLOR&&i.push(O.R.ColorKind),s.TANGENT&&i.push(O.R.TangentKind),(0,$.ER)(i,s);const a="fluentBackplate",o=s.toString(),l=["world","viewProjection","cameraPosition","_Radius_","_Line_Width_","_Absolute_Sizes_","_Filter_Width_","_Base_Color_","_Line_Color_","_Radius_Top_Left_","_Radius_Top_Right_","_Radius_Bottom_Left_","_Radius_Bottom_Right_","_Blob_Position_","_Blob_Intensity_","_Blob_Near_Size_","_Blob_Far_Size_","_Blob_Near_Distance_","_Blob_Far_Distance_","_Blob_Fade_Length_","_Blob_Pulse_","_Blob_Fade_","_Blob_Texture_","_Blob_Position_2_","_Blob_Near_Size_2_","_Blob_Pulse_2_","_Blob_Fade_2_","_Rate_","_Highlight_Color_","_Highlight_Width_","_Highlight_Transform_","_Highlight_","_Iridescence_Intensity_","_Iridescence_Edge_Intensity_","_Angle_","_Fade_Out_","_Reflected_","_Frequency_","_Vertical_Offset_","_Iridescent_Map_","_Use_Global_Left_Index_","_Use_Global_Right_Index_","Global_Left_Index_Tip_Position","Global_Right_Index_Tip_Position"],h=["_Blob_Texture_","_Iridescent_Map_"],c=[];(0,$.Bb)({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:s,maxSimultaneousLights:4}),t.setEffect(r.getEngine().createEffect(a,{attributes:i,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:o,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),s,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(s._renderId=r.getRenderId(),i._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){if(!i.materialDefines)return;const s=i.effect;s&&(this._activeEffect=s,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",this.getScene().activeCamera?.position??I.Pq.ZeroReadOnly),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Line_Width_",this.lineWidth),this._activeEffect.setFloat("_Absolute_Sizes_",this.absoluteSizes?1:0),this._activeEffect.setFloat("_Filter_Width_",this._filterWidth),this._activeEffect.setDirectColor4("_Base_Color_",this.baseColor),this._activeEffect.setDirectColor4("_Line_Color_",this.lineColor),this._activeEffect.setFloat("_Radius_Top_Left_",1),this._activeEffect.setFloat("_Radius_Top_Right_",1),this._activeEffect.setFloat("_Radius_Bottom_Left_",1),this._activeEffect.setFloat("_Radius_Bottom_Right_",1),this._activeEffect.setFloat("_Blob_Intensity_",this.blobIntensity),this._activeEffect.setFloat("_Blob_Near_Size_",this.blobNearSize),this._activeEffect.setFloat("_Blob_Far_Size_",this.blobFarSize),this._activeEffect.setFloat("_Blob_Near_Distance_",this.blobNearDistance),this._activeEffect.setFloat("_Blob_Far_Distance_",this.blobFarDistance),this._activeEffect.setFloat("_Blob_Fade_Length_",this.blobFadeLength),this._activeEffect.setFloat("_Blob_Pulse_",this.blobPulse),this._activeEffect.setFloat("_Blob_Fade_",this.blobFade),this._activeEffect.setTexture("_Blob_Texture_",this._blobTexture),this._activeEffect.setFloat("_Blob_Near_Size_2_",this.blobNearSize2),this._activeEffect.setFloat("_Blob_Pulse_2_",this.blobPulse2),this._activeEffect.setFloat("_Blob_Fade_2_",this.blobFade2),this._activeEffect.setFloat("_Rate_",this._rate),this._activeEffect.setDirectColor4("_Highlight_Color_",this.highlightColor),this._activeEffect.setFloat("_Highlight_Width_",this.highlightWidth),this._activeEffect.setVector4("_Highlight_Transform_",this._highlightTransform),this._activeEffect.setFloat("_Highlight_",this._highlight),this._activeEffect.setFloat("_Iridescence_Intensity_",this.iridescenceIntensity),this._activeEffect.setFloat("_Iridescence_Edge_Intensity_",this.iridescenceEdgeIntensity),this._activeEffect.setFloat("_Angle_",this._angle),this._activeEffect.setFloat("_Fade_Out_",this.fadeOut),this._activeEffect.setFloat("_Reflected_",this._reflected?1:0),this._activeEffect.setFloat("_Frequency_",this._frequency),this._activeEffect.setFloat("_Vertical_Offset_",this._verticalOffset),this._activeEffect.setTexture("_Iridescent_Map_",this._iridescentMap),this._activeEffect.setFloat("_Use_Global_Left_Index_",1),this._activeEffect.setFloat("_Use_Global_Right_Index_",1),this._globalLeftIndexTipPosition4.set(this.globalLeftIndexTipPosition.x,this.globalLeftIndexTipPosition.y,this.globalLeftIndexTipPosition.z,1),this._activeEffect.setVector4("Global_Left_Index_Tip_Position",this._globalLeftIndexTipPosition4),this._globalRightIndexTipPosition4.set(this.globalRightIndexTipPosition.x,this.globalRightIndexTipPosition.y,this.globalRightIndexTipPosition.z,1),this._activeEffect.setVector4("Global_Right_Index_Tip_Position",this._globalRightIndexTipPosition4),this._afterBind(t,this._activeEffect,i))}getAnimatables(){return[]}dispose(e){super.dispose(e),this._blobTexture.dispose(),this._iridescentMap.dispose()}clone(e){return N.p.Clone((()=>new Vh(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.FluentBackplateMaterial",e}getClassName(){return"FluentBackplateMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new Vh(e.name,t)),e,t,i)}}Vh.BLOB_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/mrtk-fluent-backplate-blob.png",Vh.IM_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/mrtk-fluent-backplate-iridescence.png",(0,w.Cg)([(0,D.lK)()],Vh.prototype,"radius",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"lineWidth",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"absoluteSizes",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"baseColor",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"lineColor",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobFarSize",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobNearDistance",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobFarDistance",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobFadeLength",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobNearSize",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobPulse",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobFade",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobNearSize2",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobPulse2",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"blobFade2",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"highlightColor",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"highlightWidth",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"iridescenceIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"iridescenceEdgeIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Vh.prototype,"fadeOut",void 0),(0,w.Cg)([(0,D.P_)()],Vh.prototype,"globalLeftIndexTipPosition",void 0),(0,w.Cg)([(0,D.P_)()],Vh.prototype,"globalRightIndexTipPosition",void 0),(0,V.Y5)("BABYLON.GUI.FluentBackplateMaterial",Vh);class Uh extends Eh{set renderingGroupId(e){this._model.renderingGroupId=e}get renderingGroupId(){return this._model.renderingGroupId}get material(){return this._material}get shareMaterials(){return this._shareMaterials}constructor(e,t=!0){super(e),this._shareMaterials=t}_getTypeName(){return"HolographicBackplate"}_createNode(e){const t=xi((this.name??"HolographicBackplate")+"_CollisionMesh",{width:1,height:1,depth:1},e);return t.isPickable=!0,t.visibility=0,er.ImportMeshAsync(void 0,Uh.MODEL_BASE_URL,Uh.MODEL_FILENAME,e).then((e=>{const i=e.meshes[1];i.name=`${this.name}_frontPlate`,i.isPickable=!1,i.parent=t,this._material&&(i.material=this._material),this._model=i})),t}_createMaterial(e){this._material=new Vh(this.name+" Material",e.getScene())}_affectMaterial(e){this._shareMaterials?this._host._touchSharedMaterials.fluentBackplateMaterial?this._material=this._host._touchSharedMaterials.fluentBackplateMaterial:(this._createMaterial(e),this._host._touchSharedMaterials.fluentBackplateMaterial=this._material):this._createMaterial(e)}dispose(){super.dispose(),this.shareMaterials||this._material.dispose(),this._model.dispose()}}Uh.MODEL_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",Uh.MODEL_FILENAME="mrtk-fluent-backplate.glb";class zh{get delay(){return this.fadeInDelay}set delay(e){this.fadeInDelay=e,this.fadeOutDelay=e}constructor(){this.fadeInDelay=0,this.fadeOutDelay=0,this.fadeInTime=300,this.fadeOutTime=300,this._millisecondsPerFrame=1e3/60,this._hovered=!1,this._hoverValue=0,this._ownerNode=null,this._delay=0,this._time=300,this._update=()=>{if(this._ownerNode){if(this._hoverValue+=this._hovered?this._millisecondsPerFrame:-this._millisecondsPerFrame,this._setAllVisibility(this._ownerNode,(this._hoverValue-this._delay)/this._time),this._ownerNode.visibility>1){if(this._setAllVisibility(this._ownerNode,1),this._hoverValue>this._time)return this._hoverValue=this._time,void this._detachObserver()}else if(this._ownerNode.visibility<0&&(this._setAllVisibility(this._ownerNode,0),this._hoverValue<0))return this._hoverValue=0,void this._detachObserver();this._attachObserver()}}}get name(){return"FadeInOut"}init(){}attach(e){this._ownerNode=e,this._setAllVisibility(this._ownerNode,0)}detach(){this._ownerNode=null}fadeIn(e=!0){this._delay=e?this.fadeInDelay:this.fadeOutDelay,this._time=e?this.fadeInTime:this.fadeOutTime,this._detachObserver(),this._ownerNode&&(e&&this._ownerNode.visibility>=1||!e&&this._ownerNode.visibility<=0)||(this._hovered=e,this._hovered||(this._delay*=-1),this._ownerNode.visibility>=1?this._hoverValue=this._time:this._ownerNode.visibility<=0&&(this._hoverValue=0),this._update())}fadeOut(){this.fadeIn(!1)}_setAllVisibility(e,t){e.visibility=t,e.getChildMeshes().forEach((e=>{this._setAllVisibility(e,t)}))}_attachObserver(){this._onBeforeRenderObserver||(this._onBeforeRenderObserver=this._ownerNode?.getScene().onBeforeRenderObservable.add(this._update))}_detachObserver(){this._onBeforeRenderObserver&&(this._ownerNode?.getScene().onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=null)}}ae.l.ShadersStore.fluentButtonPixelShader="uniform vec3 cameraPosition;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;uniform float _Edge_Width_;uniform vec4 _Edge_Color_;uniform bool _Relative_Width_;uniform float _Proximity_Max_Intensity_;uniform float _Proximity_Far_Distance_;uniform float _Proximity_Near_Radius_;uniform float _Proximity_Anisotropy_;uniform float _Selection_Fuzz_;uniform float _Selected_;uniform float _Selection_Fade_;uniform float _Selection_Fade_Size_;uniform float _Selected_Distance_;uniform float _Selected_Fade_Length_;uniform bool _Blob_Enable_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Inner_Fade_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform bool _Blob_Enable_2_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Inner_Fade_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Active_Face_Dir_;uniform vec3 _Active_Face_Up_;uniform bool Enable_Fade;uniform float _Fade_Width_;uniform bool _Smooth_Active_Face_;uniform bool _Show_Frame_;uniform bool _Use_Blob_Texture_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;void Holo_Edge_Fragment_B35(\nvec4 Edges,\nfloat Edge_Width,\nout float NotEdge)\n{vec2 c=vec2(min(Edges.r,Edges.g),min(Edges.b,Edges.a));vec2 df=fwidth(c)*Edge_Width;vec2 g=clamp(c/df,0.0,1.0);NotEdge=g.x*g.y;}\nvoid Blob_Fragment_B39(\nvec2 UV,\nvec3 Blob_Info,\nsampler2D Blob_Texture,\nout vec4 Blob_Color)\n{float k=dot(UV,UV);Blob_Color=Blob_Info.y*texture(Blob_Texture,vec2(vec2(sqrt(k),Blob_Info.x).x,1.0-vec2(sqrt(k),Blob_Info.x).y))*(1.0-clamp(k,0.0,1.0));}\nvec2 FilterStep(vec2 Edge,vec2 X)\n{vec2 dX=max(fwidth(X),vec2(0.00001,0.00001));return clamp( (X+dX-max(Edge,X-dX))/(dX*2.0),0.0,1.0);}\nvoid Wireframe_Fragment_B59(\nvec3 Widths,\nvec2 UV,\nfloat Proximity,\nvec4 Edge_Color,\nout vec4 Wireframe)\n{vec2 c=min(UV,vec2(1.0,1.0)-UV);vec2 g=FilterStep(Widths.xy*0.5,c); \nWireframe=(1.0-min(g.x,g.y))*Proximity*Edge_Color;}\nvoid Proximity_B53(\nvec3 Proximity_Center,\nvec3 Proximity_Center_2,\nfloat Proximity_Max_Intensity,\nfloat Proximity_Near_Radius,\nvec3 Position,\nvec3 Show_Selection,\nvec4 Extra1,\nfloat Dist_To_Face,\nfloat Intensity,\nout float Proximity)\n{vec2 delta1=Extra1.xy;vec2 delta2=Extra1.zw;float d2=sqrt(min(dot(delta1,delta1),dot(delta2,delta2))+Dist_To_Face*Dist_To_Face);Proximity=Intensity*Proximity_Max_Intensity*(1.0-clamp(d2/Proximity_Near_Radius,0.0,1.0))*(1.0-Show_Selection.x)+Show_Selection.x;}\nvoid To_XYZ_B46(\nvec3 Vec3,\nout float X,\nout float Y,\nout float Z)\n{X=Vec3.x;Y=Vec3.y;Z=Vec3.z;}\nvoid main()\n{float NotEdge_Q35;\n#if ENABLE_FADE\nHolo_Edge_Fragment_B35(vColor,_Fade_Width_,NotEdge_Q35);\n#else\nNotEdge_Q35=1.0;\n#endif\nvec4 Blob_Color_Q39;float k=dot(vUV,vUV);vec2 blobTextureCoord=vec2(vec2(sqrt(k),vTangent.x).x,1.0-vec2(sqrt(k),vTangent.x).y);vec4 blobColor=mix(vec4(1.0,1.0,1.0,1.0)*step(1.0-vTangent.x,clamp(sqrt(k)+0.1,0.0,1.0)),texture(_Blob_Texture_,blobTextureCoord),float(_Use_Blob_Texture_));Blob_Color_Q39=vTangent.y*blobColor*(1.0-clamp(k,0.0,1.0));float Is_Quad_Q24;Is_Quad_Q24=vNormal.z;vec3 Blob_Position_Q41= mix(_Blob_Position_,Global_Left_Index_Tip_Position.xyz,float(Use_Global_Left_Index));vec3 Blob_Position_Q42= mix(_Blob_Position_2_,Global_Right_Index_Tip_Position.xyz,float(Use_Global_Right_Index));float X_Q46;float Y_Q46;float Z_Q46;To_XYZ_B46(vBinormal,X_Q46,Y_Q46,Z_Q46);float Proximity_Q53;Proximity_B53(Blob_Position_Q41,Blob_Position_Q42,_Proximity_Max_Intensity_,_Proximity_Near_Radius_,vPosition,vBinormal,vExtra1,Y_Q46,Z_Q46,Proximity_Q53);vec4 Wireframe_Q59;Wireframe_Fragment_B59(vNormal,vUV,Proximity_Q53,_Edge_Color_,Wireframe_Q59);vec4 Wire_Or_Blob_Q23=mix(Wireframe_Q59,Blob_Color_Q39,Is_Quad_Q24);vec4 Result_Q22;Result_Q22=mix(Wire_Or_Blob_Q23,vec4(0.3,0.3,0.3,0.3),float(_Show_Frame_));vec4 Final_Color_Q37=NotEdge_Q35*Result_Q22;vec4 Out_Color=Final_Color_Q37;float Clip_Threshold=0.0;bool To_sRGB=false;gl_FragColor=Out_Color;}";ae.l.ShadersStore.fluentButtonVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute vec3 tangent;attribute vec4 color;uniform float _Edge_Width_;uniform vec4 _Edge_Color_;uniform float _Proximity_Max_Intensity_;uniform float _Proximity_Far_Distance_;uniform float _Proximity_Near_Radius_;uniform float _Proximity_Anisotropy_;uniform float _Selection_Fuzz_;uniform float _Selected_;uniform float _Selection_Fade_;uniform float _Selection_Fade_Size_;uniform float _Selected_Distance_;uniform float _Selected_Fade_Length_;uniform bool _Blob_Enable_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Inner_Fade_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform bool _Blob_Enable_2_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Inner_Fade_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Active_Face_Dir_;uniform vec3 _Active_Face_Up_;uniform bool _Enable_Fade_;uniform float _Fade_Width_;uniform bool _Smooth_Active_Face_;uniform bool _Show_Frame_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;void Blob_Vertex_B47(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nvec4 Vx_Color,\nvec2 UV,\nvec3 Face_Center,\nvec2 Face_Size,\nvec2 In_UV,\nfloat Blob_Fade_Length,\nfloat Selection_Fade,\nfloat Selection_Fade_Size,\nfloat Inner_Fade,\nvec3 Active_Face_Center,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nfloat Blob_Enabled,\nout vec3 Out_Position,\nout vec2 Out_UV,\nout vec3 Blob_Info)\n{float blobSize,fadeIn;vec3 Hit_Position;Blob_Info=vec3(0.0,0.0,0.0);float Hit_Distance=dot(Blob_Position-Face_Center,Normal);Hit_Position=Blob_Position-Hit_Distance*Normal;float absD=abs(Hit_Distance);float lerpVal=clamp((absD-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);fadeIn=1.0-clamp((absD-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float innerFade=1.0-clamp(-Hit_Distance/Inner_Fade,0.0,1.0);float farClip=clamp(1.0-step(Blob_Far_Distance+Blob_Fade_Length,absD),0.0,1.0);float size=mix(Blob_Near_Size,Blob_Far_Size,lerpVal)*farClip;blobSize=mix(size,Selection_Fade_Size,Selection_Fade)*innerFade*Blob_Enabled;Blob_Info.x=lerpVal*0.5+0.5;Blob_Info.y=fadeIn*Intensity*(1.0-Selection_Fade)*Blob_Fade;Blob_Info.x*=(1.0-Blob_Pulse);vec3 delta=Hit_Position-Face_Center;vec2 blobCenterXY=vec2(dot(delta,Tangent),dot(delta,Bitangent));vec2 quadUVin=2.0*UV-1.0; \nvec2 blobXY=blobCenterXY+quadUVin*blobSize;vec2 blobClipped=clamp(blobXY,-Face_Size*0.5,Face_Size*0.5);vec2 blobUV=(blobClipped-blobCenterXY)/max(blobSize,0.0001)*2.0;vec3 blobCorner=Face_Center+blobClipped.x*Tangent+blobClipped.y*Bitangent;Out_Position=mix(Position,blobCorner,Vx_Color.rrr);Out_UV=mix(In_UV,blobUV,Vx_Color.rr);}\nvec2 ProjectProximity(\nvec3 blobPosition,\nvec3 position,\nvec3 center,\nvec3 dir,\nvec3 xdir,\nvec3 ydir,\nout float vdistance\n)\n{vec3 delta=blobPosition-position;vec2 xy=vec2(dot(delta,xdir),dot(delta,ydir));vdistance=abs(dot(delta,dir));return xy;}\nvoid Proximity_Vertex_B66(\nvec3 Blob_Position,\nvec3 Blob_Position_2,\nvec3 Active_Face_Center,\nvec3 Active_Face_Dir,\nvec3 Position,\nfloat Proximity_Far_Distance,\nfloat Relative_Scale,\nfloat Proximity_Anisotropy,\nvec3 Up,\nout vec4 Extra1,\nout float Distance_To_Face,\nout float Intensity)\n{vec3 Active_Face_Dir_X=normalize(cross(Active_Face_Dir,Up));vec3 Active_Face_Dir_Y=cross(Active_Face_Dir,Active_Face_Dir_X);float distz1,distz2;Extra1.xy=ProjectProximity(Blob_Position,Position,Active_Face_Center,Active_Face_Dir,Active_Face_Dir_X*Proximity_Anisotropy,Active_Face_Dir_Y,distz1)/Relative_Scale;Extra1.zw=ProjectProximity(Blob_Position_2,Position,Active_Face_Center,Active_Face_Dir,Active_Face_Dir_X*Proximity_Anisotropy,Active_Face_Dir_Y,distz2)/Relative_Scale;Distance_To_Face=dot(Active_Face_Dir,Position-Active_Face_Center);Intensity=1.0-clamp(min(distz1,distz2)/Proximity_Far_Distance,0.0,1.0);}\nvoid Holo_Edge_Vertex_B44(\nvec3 Incident,\nvec3 Normal,\nvec2 UV,\nvec3 Tangent,\nvec3 Bitangent,\nbool Smooth_Active_Face,\nfloat Active,\nout vec4 Holo_Edges)\n{float NdotI=dot(Incident,Normal);vec2 flip=(UV-vec2(0.5,0.5));float udot=dot(Incident,Tangent)*flip.x*NdotI;float uval=1.0-float(udot>0.0);float vdot=-dot(Incident,Bitangent)*flip.y*NdotI;float vval=1.0-float(vdot>0.0);float Smooth_And_Active=step(1.0,float(Smooth_Active_Face && Active>0.0));uval=mix(uval,max(1.0,uval),Smooth_And_Active); \nvval=mix(vval,max(1.0,vval),Smooth_And_Active);Holo_Edges=vec4(1.0,1.0,1.0,1.0)-vec4(uval*UV.x,uval*(1.0-UV.x),vval*UV.y,vval*(1.0-UV.y));}\nvoid Object_To_World_Pos_B13(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid Choose_Blob_B38(\nvec4 Vx_Color,\nvec3 Position1,\nvec3 Position2,\nbool Blob_Enable_1,\nbool Blob_Enable_2,\nfloat Near_Size_1,\nfloat Near_Size_2,\nfloat Blob_Inner_Fade_1,\nfloat Blob_Inner_Fade_2,\nfloat Blob_Pulse_1,\nfloat Blob_Pulse_2,\nfloat Blob_Fade_1,\nfloat Blob_Fade_2,\nout vec3 Position,\nout float Near_Size,\nout float Inner_Fade,\nout float Blob_Enable,\nout float Fade,\nout float Pulse)\n{Position=Position1*(1.0-Vx_Color.g)+Vx_Color.g*Position2;float b1=float(Blob_Enable_1);float b2=float(Blob_Enable_2);Blob_Enable=b1+(b2-b1)*Vx_Color.g;Pulse=Blob_Pulse_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Pulse_2;Fade=Blob_Fade_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Fade_2;Near_Size=Near_Size_1*(1.0-Vx_Color.g)+Vx_Color.g*Near_Size_2;Inner_Fade=Blob_Inner_Fade_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Inner_Fade_2;}\nvoid Wireframe_Vertex_B51(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nfloat Edge_Width,\nvec2 Face_Size,\nout vec3 Wire_Vx_Pos,\nout vec2 UV,\nout vec2 Widths)\n{Widths.xy=Edge_Width/Face_Size;float x=dot(Position,Tangent);float y=dot(Position,Bitangent);float dx=0.5-abs(x);float newx=(0.5-dx*Widths.x*2.0)*sign(x);float dy=0.5-abs(y);float newy=(0.5-dy*Widths.y*2.0)*sign(y);Wire_Vx_Pos=Normal*0.5+newx*Tangent+newy*Bitangent;UV.x=dot(Wire_Vx_Pos,Tangent)+0.5;UV.y=dot(Wire_Vx_Pos,Bitangent)+0.5;}\nvec2 ramp2(vec2 start,vec2 end,vec2 x)\n{return clamp((x-start)/(end-start),vec2(0.0,0.0),vec2(1.0,1.0));}\nfloat computeSelection(\nvec3 blobPosition,\nvec3 normal,\nvec3 tangent,\nvec3 bitangent,\nvec3 faceCenter,\nvec2 faceSize,\nfloat selectionFuzz,\nfloat farDistance,\nfloat fadeLength\n)\n{vec3 delta=blobPosition-faceCenter;float absD=abs(dot(delta,normal));float fadeIn=1.0-clamp((absD-farDistance)/fadeLength,0.0,1.0);vec2 blobCenterXY=vec2(dot(delta,tangent),dot(delta,bitangent));vec2 innerFace=faceSize*(1.0-selectionFuzz)*0.5;vec2 selectPulse=ramp2(-faceSize*0.5,-innerFace,blobCenterXY)-ramp2(innerFace,faceSize*0.5,blobCenterXY);return selectPulse.x*selectPulse.y*fadeIn;}\nvoid Selection_Vertex_B48(\nvec3 Blob_Position,\nvec3 Blob_Position_2,\nvec3 Face_Center,\nvec2 Face_Size,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nfloat Selection_Fuzz,\nfloat Selected,\nfloat Far_Distance,\nfloat Fade_Length,\nvec3 Active_Face_Dir,\nout float Show_Selection)\n{float select1=computeSelection(Blob_Position,Normal,Tangent,Bitangent,Face_Center,Face_Size,Selection_Fuzz,Far_Distance,Fade_Length);float select2=computeSelection(Blob_Position_2,Normal,Tangent,Bitangent,Face_Center,Face_Size,Selection_Fuzz,Far_Distance,Fade_Length);float Active=max(0.0,dot(Active_Face_Dir,Normal));Show_Selection=mix(max(select1,select2),1.0,Selected)*Active;}\nvoid Proximity_Visibility_B54(\nfloat Selection,\nvec3 Proximity_Center,\nvec3 Proximity_Center_2,\nfloat Input_Width,\nfloat Proximity_Far_Distance,\nfloat Proximity_Radius,\nvec3 Active_Face_Center,\nvec3 Active_Face_Dir,\nout float Width)\n{vec3 boxEdges=(world*vec4(vec3(0.5,0.5,0.5),0.0)).xyz;float boxMaxSize=length(boxEdges);float d1=dot(Proximity_Center-Active_Face_Center,Active_Face_Dir);vec3 blob1=Proximity_Center-d1*Active_Face_Dir;float d2=dot(Proximity_Center_2-Active_Face_Center,Active_Face_Dir);vec3 blob2=Proximity_Center_2-d2*Active_Face_Dir;vec3 delta1=blob1-Active_Face_Center;vec3 delta2=blob2-Active_Face_Center;float dist1=dot(delta1,delta1);float dist2=dot(delta2,delta2);float nearestProxDist=sqrt(min(dist1,dist2));Width=Input_Width*(1.0-step(boxMaxSize+Proximity_Radius,nearestProxDist))*(1.0-step(Proximity_Far_Distance,min(d1,d2))*(1.0-step(0.0001,Selection)));}\nvoid Object_To_World_Dir_B67(\nvec3 Dir_Object,\nout vec3 Dir_World)\n{Dir_World=(world*vec4(Dir_Object,0.0)).xyz;}\nvoid main()\n{vec3 Active_Face_Center_Q49;Active_Face_Center_Q49=(world*vec4(_Active_Face_Dir_*0.5,1.0)).xyz;vec3 Blob_Position_Q41= mix(_Blob_Position_,Global_Left_Index_Tip_Position.xyz,float(Use_Global_Left_Index));vec3 Blob_Position_Q42= mix(_Blob_Position_2_,Global_Right_Index_Tip_Position.xyz,float(Use_Global_Right_Index));vec3 Active_Face_Dir_Q64=normalize((world*vec4(_Active_Face_Dir_,0.0)).xyz);float Relative_Scale_Q57;\n#if RELATIVE_WIDTH\nRelative_Scale_Q57=length((world*vec4(vec3(0,1,0),0.0)).xyz);\n#else\nRelative_Scale_Q57=1.0;\n#endif\nvec3 Tangent_World_Q30;Tangent_World_Q30=(world*vec4(tangent,0.0)).xyz;vec3 Binormal_World_Q31;Binormal_World_Q31=(world*vec4((cross(normal,tangent)),0.0)).xyz;vec3 Normal_World_Q60;Normal_World_Q60=(world*vec4(normal,0.0)).xyz;vec3 Result_Q18=0.5*normal;vec3 Dir_World_Q67;Object_To_World_Dir_B67(_Active_Face_Up_,Dir_World_Q67);float Product_Q56=_Edge_Width_*Relative_Scale_Q57;vec3 Normal_World_N_Q29=normalize(Normal_World_Q60);vec3 Tangent_World_N_Q28=normalize(Tangent_World_Q30);vec3 Binormal_World_N_Q32=normalize(Binormal_World_Q31);vec3 Position_Q38;float Near_Size_Q38;float Inner_Fade_Q38;float Blob_Enable_Q38;float Fade_Q38;float Pulse_Q38;Choose_Blob_B38(color,Blob_Position_Q41,Blob_Position_Q42,_Blob_Enable_,_Blob_Enable_2_,_Blob_Near_Size_,_Blob_Near_Size_2_,_Blob_Inner_Fade_,_Blob_Inner_Fade_2_,_Blob_Pulse_,_Blob_Pulse_2_,_Blob_Fade_,_Blob_Fade_2_,Position_Q38,Near_Size_Q38,Inner_Fade_Q38,Blob_Enable_Q38,Fade_Q38,Pulse_Q38);vec3 Face_Center_Q33;Face_Center_Q33=(world*vec4(Result_Q18,1.0)).xyz;vec2 Face_Size_Q50=vec2(length(Tangent_World_Q30),length(Binormal_World_Q31));float Show_Selection_Q48;Selection_Vertex_B48(Blob_Position_Q41,Blob_Position_Q42,Face_Center_Q33,Face_Size_Q50,Normal_World_N_Q29,Tangent_World_N_Q28,Binormal_World_N_Q32,_Selection_Fuzz_,_Selected_,_Selected_Distance_,_Selected_Fade_Length_,Active_Face_Dir_Q64,Show_Selection_Q48);vec3 Normalized_Q72=normalize(Dir_World_Q67);float Active_Q34=max(0.0,dot(Active_Face_Dir_Q64,Normal_World_N_Q29));float Width_Q54;Proximity_Visibility_B54(Show_Selection_Q48,Blob_Position_Q41,Blob_Position_Q42,Product_Q56,_Proximity_Far_Distance_,_Proximity_Near_Radius_,Active_Face_Center_Q49,Active_Face_Dir_Q64,Width_Q54);vec3 Wire_Vx_Pos_Q51;vec2 UV_Q51;vec2 Widths_Q51;Wireframe_Vertex_B51(position,normal,tangent,(cross(normal,tangent)),Width_Q54,Face_Size_Q50,Wire_Vx_Pos_Q51,UV_Q51,Widths_Q51);vec3 Vec3_Q27=vec3(Widths_Q51.x,Widths_Q51.y,color.r);vec3 Pos_World_Q13;Object_To_World_Pos_B13(Wire_Vx_Pos_Q51,Pos_World_Q13);vec3 Incident_Q36=normalize(Pos_World_Q13-cameraPosition);vec3 Out_Position_Q47;vec2 Out_UV_Q47;vec3 Blob_Info_Q47;Blob_Vertex_B47(Pos_World_Q13,Normal_World_N_Q29,Tangent_World_N_Q28,Binormal_World_N_Q32,Position_Q38,_Blob_Intensity_,Near_Size_Q38,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,color,uv,Face_Center_Q33,Face_Size_Q50,UV_Q51,_Blob_Fade_Length_,_Selection_Fade_,_Selection_Fade_Size_,Inner_Fade_Q38,Active_Face_Center_Q49,Pulse_Q38,Fade_Q38,Blob_Enable_Q38,Out_Position_Q47,Out_UV_Q47,Blob_Info_Q47);vec4 Extra1_Q66;float Distance_To_Face_Q66;float Intensity_Q66;Proximity_Vertex_B66(Blob_Position_Q41,Blob_Position_Q42,Active_Face_Center_Q49,Active_Face_Dir_Q64,Pos_World_Q13,_Proximity_Far_Distance_,Relative_Scale_Q57,_Proximity_Anisotropy_,Normalized_Q72,Extra1_Q66,Distance_To_Face_Q66,Intensity_Q66);vec4 Holo_Edges_Q44;Holo_Edge_Vertex_B44(Incident_Q36,Normal_World_N_Q29,uv,Tangent_World_Q30,Binormal_World_Q31,_Smooth_Active_Face_,Active_Q34,Holo_Edges_Q44);vec3 Vec3_Q19=vec3(Show_Selection_Q48,Distance_To_Face_Q66,Intensity_Q66);vec3 Position=Out_Position_Q47;vec2 UV=Out_UV_Q47;vec3 Tangent=Blob_Info_Q47;vec3 Binormal=Vec3_Q19;vec3 Normal=Vec3_Q27;vec4 Extra1=Extra1_Q66;vec4 Color=Holo_Edges_Q44;gl_Position=viewProjection*vec4(Position,1);vPosition=Position;vNormal=Normal;vUV=UV;vTangent=Tangent;vBinormal=Binormal;vColor=Color;vExtra1=Extra1;}";class Gh extends ye.M{constructor(){super(),this.RELATIVE_WIDTH=!0,this.ENABLE_FADE=!0,this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class Hh extends Ce{constructor(e,t){super(e,t),this.edgeWidth=.04,this.edgeColor=new M.ov(.592157,.592157,.592157,1),this.proximityMaxIntensity=.45,this.proximityFarDistance=.16,this.proximityNearRadius=1.5,this.proximityAnisotropy=1,this.selectionFuzz=.5,this.selected=0,this.selectionFade=0,this.selectionFadeSize=.3,this.selectedDistance=.08,this.selectedFadeLength=.08,this.blobIntensity=.5,this.blobFarSize=.05,this.blobNearDistance=0,this.blobFarDistance=.08,this.blobFadeLength=.08,this.leftBlobEnable=!0,this.leftBlobNearSize=.025,this.leftBlobPulse=0,this.leftBlobFade=1,this.leftBlobInnerFade=.01,this.rightBlobEnable=!0,this.rightBlobNearSize=.025,this.rightBlobPulse=0,this.rightBlobFade=1,this.rightBlobInnerFade=.01,this.activeFaceDir=new I.Pq(0,0,-1),this.activeFaceUp=new I.Pq(0,1,0),this.enableFade=!0,this.fadeWidth=1.5,this.smoothActiveFace=!0,this.showFrame=!1,this.useBlobTexture=!0,this.globalLeftIndexTipPosition=I.Pq.Zero(),this.globalRightIndexTipPosition=I.Pq.Zero(),this.alphaMode=Pa.Y.ALPHA_ADD,this.disableDepthWrite=!0,this.backFaceCulling=!1,this._blobTexture=new G.g(Hh.BLOB_TEXTURE_URL,this.getScene(),!0,!1,G.g.NEAREST_SAMPLINGMODE)}needAlphaBlending(){return!0}needAlphaTesting(){return!0}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){const i=t._drawWrapper;if(this.isFrozen&&i.effect&&i._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new Gh);const s=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if((0,$.qB)(e,s,!0,!1),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial();const e=new K;s.FOG&&e.addFallback(1,"FOG"),(0,$.c4)(s,e),s.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess;const i=[O.R.PositionKind];s.NORMAL&&i.push(O.R.NormalKind),s.UV1&&i.push(O.R.UVKind),s.UV2&&i.push(O.R.UV2Kind),s.VERTEXCOLOR&&i.push(O.R.ColorKind),s.TANGENT&&i.push(O.R.TangentKind),(0,$.ER)(i,s);const a="fluentButton",o=s.toString(),l=["world","viewProjection","cameraPosition","_Edge_Width_","_Edge_Color_","_Relative_Width_","_Proximity_Max_Intensity_","_Proximity_Far_Distance_","_Proximity_Near_Radius_","_Proximity_Anisotropy_","_Selection_Fuzz_","_Selected_","_Selection_Fade_","_Selection_Fade_Size_","_Selected_Distance_","_Selected_Fade_Length_","_Blob_Enable_","_Blob_Position_","_Blob_Intensity_","_Blob_Near_Size_","_Blob_Far_Size_","_Blob_Near_Distance_","_Blob_Far_Distance_","_Blob_Fade_Length_","_Blob_Inner_Fade_","_Blob_Pulse_","_Blob_Fade_","_Blob_Texture_","_Blob_Enable_2_","_Blob_Position_2_","_Blob_Near_Size_2_","_Blob_Inner_Fade_2_","_Blob_Pulse_2_","_Blob_Fade_2_","_Active_Face_Dir_","_Active_Face_Up_","_Enable_Fade_","_Fade_Width_","_Smooth_Active_Face_","_Show_Frame_","_Use_Blob_Texture_","Use_Global_Left_Index","Use_Global_Right_Index","Global_Left_Index_Tip_Position","Global_Right_Index_Tip_Position","Global_Left_Thumb_Tip_Position","Global_Right_Thumb_Tip_Position","Global_Left_Index_Tip_Proximity","Global_Right_Index_Tip_Proximity"],h=["_Blob_Texture_"],c=[];(0,$.Bb)({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:s,maxSimultaneousLights:4}),t.setEffect(r.getEngine().createEffect(a,{attributes:i,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:o,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),s,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(s._renderId=r.getRenderId(),i._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){const s=this.getScene();if(!i.materialDefines)return;const r=i.effect;r&&(this._activeEffect=r,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",s.activeCamera.position),this._activeEffect.setTexture("_Blob_Texture_",this._blobTexture),this._activeEffect.setFloat("_Edge_Width_",this.edgeWidth),this._activeEffect.setColor4("_Edge_Color_",new M.v9(this.edgeColor.r,this.edgeColor.g,this.edgeColor.b),this.edgeColor.a),this._activeEffect.setFloat("_Proximity_Max_Intensity_",this.proximityMaxIntensity),this._activeEffect.setFloat("_Proximity_Far_Distance_",this.proximityFarDistance),this._activeEffect.setFloat("_Proximity_Near_Radius_",this.proximityNearRadius),this._activeEffect.setFloat("_Proximity_Anisotropy_",this.proximityAnisotropy),this._activeEffect.setFloat("_Selection_Fuzz_",this.selectionFuzz),this._activeEffect.setFloat("_Selected_",this.selected),this._activeEffect.setFloat("_Selection_Fade_",this.selectionFade),this._activeEffect.setFloat("_Selection_Fade_Size_",this.selectionFadeSize),this._activeEffect.setFloat("_Selected_Distance_",this.selectedDistance),this._activeEffect.setFloat("_Selected_Fade_Length_",this.selectedFadeLength),this._activeEffect.setFloat("_Blob_Enable_",this.leftBlobEnable?1:0),this._activeEffect.setFloat("_Blob_Intensity_",this.blobIntensity),this._activeEffect.setFloat("_Blob_Near_Size_",this.leftBlobNearSize),this._activeEffect.setFloat("_Blob_Far_Size_",this.blobFarSize),this._activeEffect.setFloat("_Blob_Near_Distance_",this.blobNearDistance),this._activeEffect.setFloat("_Blob_Far_Distance_",this.blobFarDistance),this._activeEffect.setFloat("_Blob_Fade_Length_",this.blobFadeLength),this._activeEffect.setFloat("_Blob_Inner_Fade_",this.leftBlobInnerFade),this._activeEffect.setFloat("_Blob_Pulse_",this.leftBlobPulse),this._activeEffect.setFloat("_Blob_Fade_",this.leftBlobFade),this._activeEffect.setFloat("_Blob_Enable_2_",this.rightBlobEnable?1:0),this._activeEffect.setFloat("_Blob_Near_Size_2_",this.rightBlobNearSize),this._activeEffect.setFloat("_Blob_Inner_Fade_2_",this.rightBlobInnerFade),this._activeEffect.setFloat("_Blob_Pulse_2_",this.rightBlobPulse),this._activeEffect.setFloat("_Blob_Fade_2_",this.rightBlobFade),this._activeEffect.setVector3("_Active_Face_Dir_",this.activeFaceDir),this._activeEffect.setVector3("_Active_Face_Up_",this.activeFaceUp),this._activeEffect.setFloat("_Fade_Width_",this.fadeWidth),this._activeEffect.setFloat("_Smooth_Active_Face_",this.smoothActiveFace?1:0),this._activeEffect.setFloat("_Show_Frame_",this.showFrame?1:0),this._activeEffect.setFloat("_Use_Blob_Texture_",this.useBlobTexture?1:0),this._activeEffect.setFloat("Use_Global_Left_Index",1),this._activeEffect.setFloat("Use_Global_Right_Index",1),this._activeEffect.setVector4("Global_Left_Index_Tip_Position",new I.IU(this.globalLeftIndexTipPosition.x,this.globalLeftIndexTipPosition.y,this.globalLeftIndexTipPosition.z,1)),this._activeEffect.setVector4("Global_Right_Index_Tip_Position",new I.IU(this.globalRightIndexTipPosition.x,this.globalRightIndexTipPosition.y,this.globalRightIndexTipPosition.z,1)),this._afterBind(t,this._activeEffect,i))}getAnimatables(){return[]}dispose(e){super.dispose(e)}clone(e){return N.p.Clone((()=>new Hh(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.FluentButtonMaterial",e}getClassName(){return"FluentButtonMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new Hh(e.name,t)),e,t,i)}}Hh.BLOB_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/mrtk-fluent-button-blob.png",(0,w.Cg)([(0,D.lK)()],Hh.prototype,"edgeWidth",void 0),(0,w.Cg)([(0,D.qK)()],Hh.prototype,"edgeColor",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"proximityMaxIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"proximityFarDistance",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"proximityNearRadius",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"proximityAnisotropy",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"selectionFuzz",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"selected",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"selectionFade",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"selectionFadeSize",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"selectedDistance",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"selectedFadeLength",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"blobIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"blobFarSize",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"blobNearDistance",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"blobFarDistance",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"blobFadeLength",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"leftBlobEnable",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"leftBlobNearSize",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"leftBlobPulse",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"leftBlobFade",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"leftBlobInnerFade",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"rightBlobEnable",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"rightBlobNearSize",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"rightBlobPulse",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"rightBlobFade",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"rightBlobInnerFade",void 0),(0,w.Cg)([(0,D.P_)()],Hh.prototype,"activeFaceDir",void 0),(0,w.Cg)([(0,D.P_)()],Hh.prototype,"activeFaceUp",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"enableFade",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"fadeWidth",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"smoothActiveFace",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"showFrame",void 0),(0,w.Cg)([(0,D.lK)()],Hh.prototype,"useBlobTexture",void 0),(0,w.Cg)([(0,D.P_)()],Hh.prototype,"globalLeftIndexTipPosition",void 0),(0,w.Cg)([(0,D.P_)()],Hh.prototype,"globalRightIndexTipPosition",void 0),(0,V.Y5)("BABYLON.GUI.FluentButtonMaterial",Hh);class Wh extends Ih{constructor(e,t){super(e),this._isNearPressed=!1,this._interactionSurfaceHeight=0,this._isToggleButton=!1,this._toggleState=!1,this._toggleButtonCallback=()=>{this._onToggle(!this._toggleState)},this.onToggleObservable=new C.cP,this.collidableFrontDirection=I.Pq.Zero(),t&&(this.collisionMesh=t)}get isActiveNearInteraction(){return this._isNearPressed}set collidableFrontDirection(e){if(this._collidableFrontDirection=e.normalize(),this._collisionMesh){const e=I.AA.Matrix[0];e.copyFrom(this._collisionMesh.getWorldMatrix()),e.invert(),I.Pq.TransformNormalToRef(this._collidableFrontDirection,e,this._collidableFrontDirection),this._collidableFrontDirection.normalize()}}get collidableFrontDirection(){if(this._collisionMesh){const e=I.AA.Vector3[0];return I.Pq.TransformNormalToRef(this._collidableFrontDirection,this._collisionMesh.getWorldMatrix(),e),e.normalize()}return this._collidableFrontDirection}set collisionMesh(e){this._collisionMesh&&(this._collisionMesh.isNearPickable=!1,this._collisionMesh.reservedDataStore?.GUI3D&&(this._collisionMesh.reservedDataStore.GUI3D={}),this._collisionMesh.getChildMeshes().forEach((e=>{e.isNearPickable=!1,e.reservedDataStore?.GUI3D&&(e.reservedDataStore.GUI3D={})}))),this._collisionMesh=e,this._injectGUI3DReservedDataStore(this._collisionMesh).control=this,this._collisionMesh.isNearPickable=!0,this._collisionMesh.getChildMeshes().forEach((e=>{this._injectGUI3DReservedDataStore(e).control=this,e.isNearPickable=!0})),this.collidableFrontDirection=e.forward}set isToggleButton(e){e!==this._isToggleButton&&(this._isToggleButton=e,e?this.onPointerUpObservable.add(this._toggleButtonCallback):(this.onPointerUpObservable.removeCallback(this._toggleButtonCallback),this._toggleState&&this._onToggle(!1)))}get isToggleButton(){return this._isToggleButton}set isToggled(e){this._isToggleButton&&this._toggleState!==e&&this._onToggle(e)}get isToggled(){return this._toggleState}_onToggle(e){this._toggleState=e,this.onToggleObservable.notifyObservers(e)}_isInteractionInFrontOfButton(e){return this._getInteractionHeight(e,this._collisionMesh.getAbsolutePosition())>0}getPressDepth(e){if(!this._isNearPressed)return 0;const t=this._getInteractionHeight(e,this._collisionMesh.getAbsolutePosition());return this._interactionSurfaceHeight-t}_getInteractionHeight(e,t){const i=this.collidableFrontDirection;if(0===i.length())return I.Pq.Distance(e,t);const s=I.Pq.Dot(t,i);return I.Pq.Dot(e,i)-s}_generatePointerEventType(e,t,i){if(e===Rt.Zp.POINTERDOWN||e===Rt.Zp.POINTERMOVE){if(!this._isInteractionInFrontOfButton(t))return Rt.Zp.POINTERMOVE;this._isNearPressed=!0,this._interactionSurfaceHeight=this._getInteractionHeight(t,this._collisionMesh.getAbsolutePosition())}if(e===Rt.Zp.POINTERUP){if(0==i)return Rt.Zp.POINTERMOVE;this._isNearPressed=!1}return e}_getTypeName(){return"TouchButton3D"}_createNode(e){return super._createNode(e)}dispose(){super.dispose(),this.onPointerUpObservable.removeCallback(this._toggleButtonCallback),this.onToggleObservable.clear(),this._collisionMesh&&this._collisionMesh.dispose()}}const Xh=Nt.HighestCommonFactor,Kh={...Nt,TwoPi:2*Math.PI,Sign:Math.sign,Log2:Math.log2,HCF:Xh};class Qh extends Wh{_disposeTooltip(){this._tooltipFade=null,this._tooltipTextBlock&&this._tooltipTextBlock.dispose(),this._tooltipTexture&&this._tooltipTexture.dispose(),this._tooltipMesh&&this._tooltipMesh.dispose(),this.onPointerEnterObservable.remove(this._tooltipHoverObserver),this.onPointerOutObservable.remove(this._tooltipOutObserver)}set renderingGroupId(e){this._backPlate.renderingGroupId=e,this._textPlate.renderingGroupId=e,this._frontPlate.renderingGroupId=e,this._tooltipMesh&&(this._tooltipMesh.renderingGroupId=e)}get renderingGroupId(){return this._backPlate.renderingGroupId}get mesh(){return this._backPlate}set tooltipText(e){if(e){if(!this._tooltipFade){const e=this._backPlate._scene.useRightHandedSystem;this._tooltipMesh=_i("",{size:1},this._backPlate._scene);const t=_i("",{size:1,sideOrientation:At.DOUBLESIDE},this._backPlate._scene),i=new Oe("",this._backPlate._scene);i.diffuseColor=M.v9.FromHexString("#212121"),t.material=i,t.isPickable=!1,this._tooltipMesh.addChild(t),t.position=I.Pq.Forward(e).scale(.05),this._tooltipMesh.scaling.y=1/3,this._tooltipMesh.position=I.Pq.Up().scale(.7).add(I.Pq.Forward(e).scale(-.15)),this._tooltipMesh.isPickable=!1,this._tooltipMesh.parent=this._backPlate,this._tooltipTexture=Ch.CreateForMesh(this._tooltipMesh),this._tooltipTextBlock=new ql,this._tooltipTextBlock.scaleY=3,this._tooltipTextBlock.color="white",this._tooltipTextBlock.fontSize=130,this._tooltipTexture.addControl(this._tooltipTextBlock),this._tooltipFade=new zh,this._tooltipFade.delay=500,this._tooltipMesh.addBehavior(this._tooltipFade),this._tooltipHoverObserver=this.onPointerEnterObservable.add((()=>{this._tooltipFade&&this._tooltipFade.fadeIn(!0)})),this._tooltipOutObserver=this.onPointerOutObservable.add((()=>{this._tooltipFade&&this._tooltipFade.fadeIn(!1)}))}this._tooltipTextBlock&&(this._tooltipTextBlock.text=e)}else this._disposeTooltip()}get tooltipText(){return this._tooltipTextBlock?this._tooltipTextBlock.text:null}get text(){return this._text}set text(e){this._text!==e&&(this._text=e,this._rebuildContent())}get imageUrl(){return this._imageUrl}set imageUrl(e){this._imageUrl!==e&&(this._imageUrl=e,this._rebuildContent())}get backMaterial(){return this._backMaterial}get frontMaterial(){return this._frontMaterial}get plateMaterial(){return this._plateMaterial}get shareMaterials(){return this._shareMaterials}set isBackplateVisible(e){this.mesh&&this._backMaterial&&(e&&!this._isBackplateVisible?this._backPlate.visibility=1:!e&&this._isBackplateVisible&&(this._backPlate.visibility=0)),this._isBackplateVisible=e}constructor(e,t=!0){super(e),this._shareMaterials=!0,this._isBackplateVisible=!0,this._frontPlateDepth=.5,this._backPlateDepth=.04,this._backplateColor=new M.v9(.08,.15,.55),this._backplateToggledColor=new M.v9(.25,.4,.95),this._shareMaterials=t,this.pointerEnterAnimation=()=>{this._frontMaterial.leftBlobEnable=!0,this._frontMaterial.rightBlobEnable=!0},this.pointerOutAnimation=()=>{this._frontMaterial.leftBlobEnable=!1,this._frontMaterial.rightBlobEnable=!1},this.pointerDownAnimation=()=>{this._frontPlate&&!this.isActiveNearInteraction&&(this._frontPlate.scaling.z=.2*this._frontPlateDepth,this._frontPlate.position=I.Pq.Forward(this._frontPlate._scene.useRightHandedSystem).scale((this._frontPlateDepth-.2*this._frontPlateDepth)/2),this._textPlate.position=I.Pq.Forward(this._textPlate._scene.useRightHandedSystem).scale(-(this._backPlateDepth+.2*this._frontPlateDepth)/2))},this.pointerUpAnimation=()=>{this._frontPlate&&(this._frontPlate.scaling.z=this._frontPlateDepth,this._frontPlate.position=I.Pq.Forward(this._frontPlate._scene.useRightHandedSystem).scale((this._frontPlateDepth-this._frontPlateDepth)/2),this._textPlate.position=I.Pq.Forward(this._textPlate._scene.useRightHandedSystem).scale(-(this._backPlateDepth+this._frontPlateDepth)/2))},this.onPointerMoveObservable.add((e=>{if(this._frontPlate&&this.isActiveNearInteraction){const t=I.Pq.Zero();if(this._backPlate.getWorldMatrix().decompose(t,void 0,void 0)){let i=this._getInteractionHeight(e,this._backPlate.getAbsolutePosition())/t.z;i=Kh.Clamp(i-this._backPlateDepth/2,.2*this._frontPlateDepth,this._frontPlateDepth),this._frontPlate.scaling.z=i,this._frontPlate.position=I.Pq.Forward(this._frontPlate._scene.useRightHandedSystem).scale((this._frontPlateDepth-i)/2),this._textPlate.position=I.Pq.Forward(this._textPlate._scene.useRightHandedSystem).scale(-(this._backPlateDepth+i)/2)}}})),this._pointerHoverObserver=this.onPointerMoveObservable.add((e=>{this._frontMaterial.globalLeftIndexTipPosition=e}))}_getTypeName(){return"TouchHolographicButton"}_rebuildContent(){this._disposeFacadeTexture();const e=new Zl;if(e.isVertical=!0,(0,S.Nf)()&&document.createElement&&this._imageUrl){const t=new $l;t.source=this._imageUrl,t.paddingTop="40px",t.height="180px",t.width="100px",t.paddingBottom="40px",e.addControl(t)}if(this._text){const t=new ql;t.text=this._text,t.color="white",t.height="30px",t.fontSize=24,e.addControl(t)}this.content=e}_createNode(e){this.name=this.name??"TouchHolographicButton";const t=xi(`${this.name}_collisionMesh`,{width:1,height:1,depth:this._frontPlateDepth},e);t.isPickable=!0,t.isNearPickable=!0,t.visibility=0,t.position=I.Pq.Forward(e.useRightHandedSystem).scale(-this._frontPlateDepth/2),er.ImportMeshAsync(void 0,Qh.MODEL_BASE_URL,Qh.MODEL_FILENAME,e).then((i=>{const s=xi("${this.name}_alphaMesh",{width:1,height:1,depth:1},e);s.isPickable=!1,s.material=new Oe("${this.name}_alphaMesh_material",e),s.material.alpha=.15;const r=i.meshes[1];r.name=`${this.name}_frontPlate`,r.isPickable=!1,r.scaling.z=this._frontPlateDepth,s.parent=r,r.parent=t,this._frontMaterial&&(r.material=this._frontMaterial),this._frontPlate=r})),this._backPlate=xi(`${this.name}_backPlate`,{width:1,height:1,depth:this._backPlateDepth},e),this._backPlate.position=I.Pq.Forward(e.useRightHandedSystem).scale(this._backPlateDepth/2),this._backPlate.isPickable=!1,this._textPlate=super._createNode(e),this._textPlate.name=`${this.name}_textPlate`,this._textPlate.isPickable=!1,this._textPlate.position=I.Pq.Forward(e.useRightHandedSystem).scale(-this._frontPlateDepth/2),this._backPlate.addChild(t),this._backPlate.addChild(this._textPlate);const i=new dt("{this.name}_root",e);return this._backPlate.setParent(i),this.collisionMesh=t,this.collidableFrontDirection=this._backPlate.forward.negate(),i}_applyFacade(e){this._plateMaterial.emissiveTexture=e,this._plateMaterial.opacityTexture=e,this._plateMaterial.diffuseColor=new M.v9(.4,.4,.4)}_createBackMaterial(e){this._backMaterial=new Dh(this.name+"backPlateMaterial",e.getScene()),this._backMaterial.albedoColor=this._backplateColor,this._backMaterial.renderBorders=!0,this._backMaterial.renderHoverLight=!1}_createFrontMaterial(e){this._frontMaterial=new Hh(this.name+"Front Material",e.getScene())}_createPlateMaterial(e){this._plateMaterial=new Oe(this.name+"Plate Material",e.getScene()),this._plateMaterial.specularColor=M.v9.Black()}_onToggle(e){this._backMaterial&&(this._backMaterial.albedoColor=e?this._backplateToggledColor:this._backplateColor),super._onToggle(e)}_affectMaterial(e){this._shareMaterials?(this._host._touchSharedMaterials.backFluentMaterial?this._backMaterial=this._host._touchSharedMaterials.backFluentMaterial:(this._createBackMaterial(e),this._host._touchSharedMaterials.backFluentMaterial=this._backMaterial),this._host._touchSharedMaterials.frontFluentMaterial?this._frontMaterial=this._host._touchSharedMaterials.frontFluentMaterial:(this._createFrontMaterial(e),this._host._touchSharedMaterials.frontFluentMaterial=this._frontMaterial)):(this._createBackMaterial(e),this._createFrontMaterial(e)),this._createPlateMaterial(e),this._backPlate.material=this._backMaterial,this._textPlate.material=this._plateMaterial,this._isBackplateVisible||(this._backPlate.visibility=0),this._frontPlate&&(this._frontPlate.material=this._frontMaterial),this._rebuildContent()}dispose(){super.dispose(),this._disposeTooltip(),this.onPointerMoveObservable.remove(this._pointerHoverObserver),this.shareMaterials||(this._backMaterial.dispose(),this._frontMaterial.dispose(),this._plateMaterial.dispose(),this._pickedPointObserver&&(this._host.onPickedPointChangedObservable.remove(this._pickedPointObserver),this._pickedPointObserver=null))}}Qh.MODEL_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",Qh.MODEL_FILENAME="mrtk-fluent-button.glb";class Yh{constructor(){this._tmpQuaternion=new I.PT,this._tmpVectors=[new I.Pq,new I.Pq,new I.Pq,new I.Pq,new I.Pq,new I.Pq,new I.Pq],this._tmpMatrix=new I.uq,this._tmpInvertView=new I.uq,this._tmpForward=new I.Pq,this._tmpNodeForward=new I.Pq,this._tmpPosition=new I.Pq,this._workingPosition=new I.Pq,this._workingQuaternion=new I.PT,this._lastTick=-1,this._recenterNextUpdate=!0,this.interpolatePose=!0,this.lerpTime=500,this.ignoreCameraPitchAndRoll=!1,this.pitchOffset=15,this.maxViewVerticalDegrees=30,this.maxViewHorizontalDegrees=30,this.orientToCameraDeadzoneDegrees=60,this.ignoreDistanceClamp=!1,this.ignoreAngleClamp=!1,this.verticalMaxDistance=0,this.defaultDistance=.8,this.maximumDistance=2,this.minimumDistance=.3,this.useFixedVerticalOffset=!1,this.fixedVerticalOffset=0,this._enabled=!0}get followedCamera(){return this._followedCamera||this._scene.activeCamera}set followedCamera(e){this._followedCamera=e}get name(){return"Follow"}init(){}attach(e,t){this._scene=e.getScene(),this.attachedNode=e,t&&(this.followedCamera=t),this._addObservables()}detach(){this.attachedNode=null,this._removeObservables()}recenter(){this._recenterNextUpdate=!0}_angleBetweenVectorAndPlane(e,t){return this._tmpVectors[0].copyFrom(e),e=this._tmpVectors[0],this._tmpVectors[1].copyFrom(t),t=this._tmpVectors[1],e.normalize(),t.normalize(),Math.PI/2-Math.acos(I.Pq.Dot(e,t))}_length2D(e){return Math.sqrt(e.x*e.x+e.z*e.z)}_distanceClamp(e,t=!1){let i=this.minimumDistance,s=this.maximumDistance;const r=this.defaultDistance,n=this._tmpVectors[0];n.copyFrom(e);let a=n.length();if(n.normalizeFromLength(a),this.ignoreCameraPitchAndRoll){i=this._length2D(n)*i,s=this._length2D(n)*s;const t=this._length2D(e);n.scaleInPlace(a/t),a=t}let o=a;return o=t?r:(0,Nt.Clamp)(a,i,s),e.copyFrom(n).scaleInPlace(o),a!==o}_applyVerticalClamp(e){0!==this.verticalMaxDistance&&(e.y=(0,Nt.Clamp)(e.y,-this.verticalMaxDistance,this.verticalMaxDistance))}_toOrientationQuatToRef(e,t){I.PT.RotationYawPitchRollToRef(Math.atan2(e.x,e.z),Math.atan2(e.y,Math.sqrt(e.z*e.z+e.x*e.x)),0,t)}_applyPitchOffset(e){const t=this._tmpVectors[0],i=this._tmpVectors[1];t.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),i.copyFromFloats(1,0,0),I.Pq.TransformNormalToRef(t,e,t),t.y=0,t.normalize(),I.Pq.TransformNormalToRef(i,e,i),I.PT.RotationAxisToRef(i,this.pitchOffset*Math.PI/180,this._tmpQuaternion),t.rotateByQuaternionToRef(this._tmpQuaternion,t),this._toOrientationQuatToRef(t,this._tmpQuaternion),this._tmpQuaternion.toRotationMatrix(this._tmpMatrix),e.copyFrom(this._tmpMatrix)}_angularClamp(e,t){const i=this._tmpVectors[5];i.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1);const s=this._tmpVectors[6];s.copyFromFloats(1,0,0),I.Pq.TransformNormalToRef(i,e,i),I.Pq.TransformNormalToRef(s,e,s);const r=I.Pq.UpReadOnly;if(t.length()<ft.bH)return!1;let n=!1;const a=this._tmpQuaternion;if(this.ignoreCameraPitchAndRoll){const e=I.Pq.GetAngleBetweenVectorsOnPlane(t,i,s);I.PT.RotationAxisToRef(s,e,a),t.rotateByQuaternionToRef(a,t)}else{const e=-I.Pq.GetAngleBetweenVectorsOnPlane(t,i,s),r=this.maxViewVerticalDegrees*Math.PI/180*.5;e<-r?(I.PT.RotationAxisToRef(s,-e-r,a),t.rotateByQuaternionToRef(a,t),n=!0):e>r&&(I.PT.RotationAxisToRef(s,-e+r,a),t.rotateByQuaternionToRef(a,t),n=!0)}const o=this._angleBetweenVectorAndPlane(t,s)*(this._scene.useRightHandedSystem?-1:1),l=this.maxViewHorizontalDegrees*Math.PI/180*.5;return o<-l?(I.PT.RotationAxisToRef(r,-o-l,a),t.rotateByQuaternionToRef(a,t),n=!0):o>l&&(I.PT.RotationAxisToRef(r,-o+l,a),t.rotateByQuaternionToRef(a,t),n=!0),n}_orientationClamp(e,t){const i=this._tmpVectors[0];i.copyFrom(e).scaleInPlace(-1).normalize();const s=this._tmpVectors[1],r=this._tmpVectors[2];s.copyFromFloats(0,1,0),I.Pq.CrossToRef(i,s,r);const n=r.length();n<ft.bH||(r.normalizeFromLength(n),I.Pq.CrossToRef(r,i,s),this.attachedNode?.getScene().useRightHandedSystem?I.PT.FromLookDirectionRHToRef(i,s,t):I.PT.FromLookDirectionLHToRef(i,s,t))}_passedOrientationDeadzone(e,t){const i=this._tmpVectors[5];return i.copyFrom(e),i.normalize(),180*Math.abs(I.Pq.GetAngleBetweenVectorsOnPlane(t,i,I.Pq.UpReadOnly))/Math.PI>this.orientToCameraDeadzoneDegrees}_updateLeashing(e){if(this.attachedNode&&this._enabled){const t=this.attachedNode.parent;this.attachedNode.setParent(null);const i=this.attachedNode.getWorldMatrix(),s=this._workingPosition,r=this._workingQuaternion,n=this.attachedNode.getPivotPoint(),a=this._tmpInvertView;a.copyFrom(e.getViewMatrix()),a.invert(),I.Pq.TransformCoordinatesToRef(n,i,s);const o=this._tmpPosition;o.copyFromFloats(0,0,0),I.Pq.TransformCoordinatesToRef(o,i,o),o.scaleInPlace(-1).subtractInPlace(n),s.subtractInPlace(e.globalPosition),this.ignoreCameraPitchAndRoll&&this._applyPitchOffset(a);let l=!1;const h=this._tmpForward;h.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),I.Pq.TransformNormalToRef(h,a,h);const c=this._tmpNodeForward;if(c.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),I.Pq.TransformNormalToRef(c,i,c),this._recenterNextUpdate)s.copyFrom(h).scaleInPlace(this.defaultDistance);else if(this.ignoreAngleClamp){const e=s.length();s.copyFrom(h).scaleInPlace(e)}else l=this._angularClamp(a,s);let u=!1;this.ignoreDistanceClamp||(u=this._distanceClamp(s,l),this._applyVerticalClamp(s)),this.useFixedVerticalOffset&&(s.y=o.y-e.globalPosition.y+this.fixedVerticalOffset),(l||u||this._passedOrientationDeadzone(s,c)||this._recenterNextUpdate)&&this._orientationClamp(s,r),this._workingPosition.subtractInPlace(n),this._recenterNextUpdate=!1,this.attachedNode.setParent(t)}}_updateTransformToGoal(e){if(!this.attachedNode||!this.followedCamera||!this._enabled)return;this.attachedNode.rotationQuaternion||(this.attachedNode.rotationQuaternion=I.PT.Identity());const t=this.attachedNode.parent;if(this.attachedNode.setParent(null),!this.interpolatePose)return this.attachedNode.position.copyFrom(this.followedCamera.globalPosition).addInPlace(this._workingPosition),void this.attachedNode.rotationQuaternion.copyFrom(this._workingQuaternion);const i=new I.Pq;i.copyFrom(this.attachedNode.position).subtractInPlace(this.followedCamera.globalPosition),I.Pq.SmoothToRef(i,this._workingPosition,e,this.lerpTime,i),i.addInPlace(this.followedCamera.globalPosition),this.attachedNode.position.copyFrom(i);const s=new I.PT;s.copyFrom(this.attachedNode.rotationQuaternion),I.PT.SmoothToRef(s,this._workingQuaternion,e,this.lerpTime,this.attachedNode.rotationQuaternion),this.attachedNode.setParent(t)}_addObservables(){this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add((()=>{if(!this.followedCamera)return;const e=Date.now();this._updateLeashing(this.followedCamera),this._updateTransformToGoal(e-this._lastTick),this._lastTick=e}))}_removeObservables(){this._onBeforeRender&&this._scene.onBeforeRenderObservable.remove(this._onBeforeRender)}}class qh{constructor(){this._attachedToElement=!1,this._virtualMeshesInfo={},this._tmpVector=new I.Pq,this._tmpQuaternion=new I.PT,this._dragType={NONE:0,DRAG:1,DRAG_WITH_CONTROLLER:2,NEAR_DRAG:3},this._moving=!1,this._dragging=this._dragType.NONE,this.draggableMeshes=null,this.zDragFactor=3,this.currentDraggingPointerIds=[],this.detachCameraControls=!0,this.onDragStartObservable=new C.cP,this.onDragObservable=new C.cP,this.onDragEndObservable=new C.cP,this.allowMultiPointer=!0}get currentDraggingPointerId(){return void 0!==this.currentDraggingPointerIds[0]?this.currentDraggingPointerIds[0]:-1}set currentDraggingPointerId(e){this.currentDraggingPointerIds[0]=e}get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}get name(){return"BaseSixDofDrag"}get isMoving(){return this._moving}init(){}get _pointerCamera(){return this._scene.cameraToUseForPointers?this._scene.cameraToUseForPointers:this._scene.activeCamera}_createVirtualMeshInfo(){const e=new dt("",qh._virtualScene);e.rotationQuaternion=new I.PT;const t=new dt("",qh._virtualScene);t.rotationQuaternion=new I.PT;const i=new dt("",qh._virtualScene);return i.rotationQuaternion=new I.PT,{dragging:!1,moving:!1,dragMesh:e,originMesh:t,pivotMesh:i,startingPivotPosition:new I.Pq,startingPivotOrientation:new I.PT,startingPosition:new I.Pq,startingOrientation:new I.PT,lastOriginPosition:new I.Pq,lastDragPosition:new I.Pq}}_resetVirtualMeshesPosition(){for(let e=0;e<this.currentDraggingPointerIds.length;e++)this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.rotationQuaternion)}_pointerUpdate2D(e,t,i){!this._pointerCamera||this._pointerCamera.cameraRigMode!=se.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||(e.origin.copyFrom(this._pointerCamera.globalPosition),i=0);const s=this._virtualMeshesInfo[t],r=I.AA.Vector3[0];e.origin.subtractToRef(s.lastOriginPosition,r),s.lastOriginPosition.copyFrom(e.origin);const n=-I.Pq.Dot(r,e.direction);s.originMesh.addChild(s.dragMesh),s.originMesh.addChild(s.pivotMesh),this._applyZOffset(s.dragMesh,n,i),this._applyZOffset(s.pivotMesh,n,i),s.originMesh.position.copyFrom(e.origin);const a=I.AA.Vector3[0];e.origin.addToRef(e.direction,a),s.originMesh.lookAt(a),s.originMesh.removeChild(s.dragMesh),s.originMesh.removeChild(s.pivotMesh)}_pointerUpdateXR(e,t,i,s){const r=this._virtualMeshesInfo[i];if(r.originMesh.position.copyFrom(e.position),this._dragging===this._dragType.NEAR_DRAG&&t?r.originMesh.rotationQuaternion.copyFrom(t.rotationQuaternion):r.originMesh.rotationQuaternion.copyFrom(e.rotationQuaternion),r.pivotMesh.computeWorldMatrix(!0),r.dragMesh.computeWorldMatrix(!0),0!==s){const e=I.AA.Vector3[0],t=I.AA.Vector3[1];e.copyFrom(this._pointerCamera.getForwardRay().direction),r.originMesh.position.subtractToRef(r.lastOriginPosition,t),r.lastOriginPosition.copyFrom(r.originMesh.position);const i=t.length();t.normalize();const n=I.AA.Vector3[2],a=I.AA.Vector3[3];r.dragMesh.absolutePosition.subtractToRef(this._pointerCamera.globalPosition,n),r.dragMesh.absolutePosition.subtractToRef(r.originMesh.position,a);const o=a.length();n.normalize(),a.normalize();let l=Math.abs(I.Pq.Dot(t,a))*I.Pq.Dot(t,e)*s*i*o;const h=.01;l<0&&h-o>l&&(l=Math.min(h-o,0)),a.scaleInPlace(l),a.addToRef(r.pivotMesh.absolutePosition,this._tmpVector),r.pivotMesh.setAbsolutePosition(this._tmpVector),a.addToRef(r.dragMesh.absolutePosition,this._tmpVector),r.dragMesh.setAbsolutePosition(this._tmpVector)}}attach(e){this._ownerNode=e,this._scene=this._ownerNode.getScene(),qh._virtualScene||(qh._virtualScene=new be.Z(this._scene.getEngine(),{virtual:!0}),qh._virtualScene.detachControl());const t=e=>this._ownerNode===e||e.isDescendantOf(this._ownerNode)&&(!this.draggableMeshes||-1!==this.draggableMeshes.indexOf(e));this._pointerObserver=this._scene.onPointerObservable.add((e=>{const i=e.event.pointerId;this._virtualMeshesInfo[i]||(this._virtualMeshesInfo[i]=this._createVirtualMeshInfo());const s=this._virtualMeshesInfo[i],r="xr-near"===e.event.pointerType||"xr"===e.event.pointerType;if(e.type==Rt.Zp.POINTERDOWN){if(!s.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&(!r||e.pickInfo.aimTransform)&&t(e.pickInfo.pickedMesh)){if((!this.allowMultiPointer||r)&&this.currentDraggingPointerIds.length>0)return;!this._pointerCamera||this._pointerCamera.cameraRigMode!==se.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||e.pickInfo.ray.origin.copyFrom(this._pointerCamera.globalPosition),this._ownerNode.computeWorldMatrix(!0);const t=this._virtualMeshesInfo[i];r?(this._dragging=e.pickInfo.originMesh?this._dragType.NEAR_DRAG:this._dragType.DRAG_WITH_CONTROLLER,t.originMesh.position.copyFrom(e.pickInfo.aimTransform.position),this._dragging===this._dragType.NEAR_DRAG&&e.pickInfo.gripTransform?t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.gripTransform.rotationQuaternion):t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.aimTransform.rotationQuaternion)):(this._dragging=this._dragType.DRAG,t.originMesh.position.copyFrom(e.pickInfo.ray.origin)),t.lastOriginPosition.copyFrom(t.originMesh.position),t.dragMesh.position.copyFrom(e.pickInfo.pickedPoint),t.lastDragPosition.copyFrom(e.pickInfo.pickedPoint),t.pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),t.pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.absoluteRotationQuaternion),t.startingPosition.copyFrom(t.dragMesh.position),t.startingPivotPosition.copyFrom(t.pivotMesh.position),t.startingOrientation.copyFrom(t.dragMesh.rotationQuaternion),t.startingPivotOrientation.copyFrom(t.pivotMesh.rotationQuaternion),r?(t.originMesh.addChild(t.dragMesh),t.originMesh.addChild(t.pivotMesh)):t.originMesh.lookAt(t.dragMesh.position),t.dragging=!0,-1===this.currentDraggingPointerIds.indexOf(i)&&this.currentDraggingPointerIds.push(i),this.detachCameraControls&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._pointerCamera.inputs&&this._pointerCamera.inputs.attachedToElement?(this._pointerCamera.detachControl(),this._attachedToElement=!0):this.allowMultiPointer&&0!==this.currentDraggingPointerIds.length||(this._attachedToElement=!1)),this._targetDragStart(t.pivotMesh.position,t.pivotMesh.rotationQuaternion,i),this.onDragStartObservable.notifyObservers({position:t.pivotMesh.position})}}else if(e.type==Rt.Zp.POINTERUP||e.type==Rt.Zp.POINTERDOUBLETAP){const e=this.currentDraggingPointerIds.indexOf(i);s.dragging=!1,-1!==e&&(this.currentDraggingPointerIds.splice(e,1),0===this.currentDraggingPointerIds.length&&(this._moving=!1,this._dragging=this._dragType.NONE,this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1)),s.originMesh.removeChild(s.dragMesh),s.originMesh.removeChild(s.pivotMesh),this._targetDragEnd(i),this.onDragEndObservable.notifyObservers({}))}else if(e.type==Rt.Zp.POINTERMOVE&&-1!==this.currentDraggingPointerIds.indexOf(i)&&s.dragging&&e.pickInfo&&(e.pickInfo.ray||e.pickInfo.aimTransform)){let t=this.zDragFactor;(this.currentDraggingPointerIds.length>1||e.pickInfo.originMesh)&&(t=0),this._ownerNode.computeWorldMatrix(!0),r?this._pointerUpdateXR(e.pickInfo.aimTransform,e.pickInfo.gripTransform,i,t):this._pointerUpdate2D(e.pickInfo.ray,i,t),this._tmpQuaternion.copyFrom(s.startingPivotOrientation),this._tmpQuaternion.x=-this._tmpQuaternion.x,this._tmpQuaternion.y=-this._tmpQuaternion.y,this._tmpQuaternion.z=-this._tmpQuaternion.z,s.pivotMesh.absoluteRotationQuaternion.multiplyToRef(this._tmpQuaternion,this._tmpQuaternion),s.pivotMesh.absolutePosition.subtractToRef(s.startingPivotPosition,this._tmpVector),this.onDragObservable.notifyObservers({delta:this._tmpVector,position:s.pivotMesh.position,pickInfo:e.pickInfo}),this._targetDrag(this._tmpVector,this._tmpQuaternion,i),s.lastDragPosition.copyFrom(s.dragMesh.absolutePosition),this._moving=!0}}))}_applyZOffset(e,t,i){e.position.z-=e.position.z<1?t*i:t*i*e.position.z,e.position.z<0&&(e.position.z=0)}_targetDragStart(e,t,i){}_targetDrag(e,t,i){}_targetDragEnd(e){}_reattachCameraControls(){if(this._pointerCamera)if("ArcRotateCamera"===this._pointerCamera.getClassName()){const e=this._pointerCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._pointerCamera.attachControl(!this._pointerCamera.inputs||this._pointerCamera.inputs.noPreventDefault)}detach(){this._scene&&(this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1),this._scene.onPointerObservable.remove(this._pointerObserver));for(const e in this._virtualMeshesInfo)this._virtualMeshesInfo[e].originMesh.dispose(),this._virtualMeshesInfo[e].dragMesh.dispose();this.onDragEndObservable.clear(),this.onDragObservable.clear(),this.onDragStartObservable.clear()}}class $h extends qh{constructor(){super(...arguments),this._sceneRenderObserver=null,this._targetPosition=new I.Pq(0,0,0),this._targetOrientation=new I.PT,this._targetScaling=new I.Pq(1,1,1),this._startingPosition=new I.Pq(0,0,0),this._startingOrientation=new I.PT,this._startingScaling=new I.Pq(1,1,1),this.onPositionChangedObservable=new C.cP,this.dragDeltaRatio=.2,this.rotateDraggedObject=!0,this.rotateAroundYOnly=!1,this.rotateWithMotionController=!0,this.disableMovement=!1,this.faceCameraOnDragStart=!1}get name(){return"SixDofDrag"}attach(e){super.attach(e),e.isNearGrabbable=!0,e.getChildMeshes().forEach((e=>{e.isNearGrabbable=!0})),this._virtualTransformNode=new dt("virtual_sixDof",qh._virtualScene),this._virtualTransformNode.rotationQuaternion=I.PT.Identity(),this._sceneRenderObserver=e.getScene().onBeforeRenderObservable.add((()=>{if(1===this.currentDraggingPointerIds.length&&this._moving&&!this.disableMovement){const t=I.AA.Vector3[0];t.copyFrom(this._targetPosition).subtractInPlace(e.absolutePosition).scaleInPlace(this.dragDeltaRatio);const i=I.AA.Vector3[1];if(i.copyFrom(t),e.parent){const s=I.AA.Matrix[0];e.parent.absoluteRotationQuaternion.toRotationMatrix(s),s.invert(),I.Pq.TransformNormalToRef(t,s,i)}if(e.position.addInPlace(i),this.onPositionChangedObservable.notifyObservers({position:e.absolutePosition}),!e.parent||e.parent.scaling&&!e.parent.scaling.isNonUniformWithinEpsilon(.001)){const t=I.AA.Quaternion[0];if(t.copyFrom(this._targetOrientation),e.parent){const i=I.AA.Quaternion[0];i.copyFrom(e.parent.absoluteRotationQuaternion),i.invertInPlace(),i.multiplyToRef(this._targetOrientation,t)}I.PT.SlerpToRef(e.rotationQuaternion,t,this.dragDeltaRatio,e.rotationQuaternion)}}}))}_getPositionOffsetAround(e,t,i){const s=I.AA.Matrix[0],r=I.AA.Matrix[1],n=I.AA.Matrix[2],a=I.AA.Matrix[3],o=I.AA.Matrix[4];return I.uq.TranslationToRef(e.x,e.y,e.z,s),I.uq.TranslationToRef(-e.x,-e.y,-e.z,r),I.uq.FromQuaternionToRef(i,n),I.uq.ScalingToRef(t,t,t,a),r.multiplyToRef(n,o),o.multiplyToRef(a,o),o.multiplyToRef(s,o),o.getTranslation()}_onePointerPositionUpdated(e,t){I.AA.Vector3[0].setAll(0),this._dragging===this._dragType.DRAG?this.rotateDraggedObject&&(this.rotateAroundYOnly?I.PT.RotationYawPitchRollToRef(t.toEulerAngles().y,0,0,I.AA.Quaternion[0]):I.AA.Quaternion[0].copyFrom(t),I.AA.Quaternion[0].multiplyToRef(this._startingOrientation,this._targetOrientation)):(this._dragging===this._dragType.NEAR_DRAG||this._dragging===this._dragType.DRAG_WITH_CONTROLLER&&this.rotateWithMotionController)&&t.multiplyToRef(this._startingOrientation,this._targetOrientation),this._targetPosition.copyFrom(this._startingPosition).addInPlace(e)}_twoPointersPositionUpdated(){const e=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].startingPosition,t=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].startingPosition,i=I.AA.Vector3[0];e.addToRef(t,i),i.scaleInPlace(.5);const s=I.AA.Vector3[1];t.subtractToRef(e,s);const r=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].dragMesh.absolutePosition,n=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].dragMesh.absolutePosition,a=I.AA.Vector3[2];r.addToRef(n,a),a.scaleInPlace(.5);const o=I.AA.Vector3[3];n.subtractToRef(r,o);const l=o.length()/s.length(),h=a.subtract(i),c=I.PT.FromEulerAngles(0,I.Pq.GetAngleBetweenVectorsOnPlane(s.normalize(),o.normalize(),I.Pq.UpReadOnly),0),u=this._ownerNode.parent;this._ownerNode.setParent(null);const d=this._getPositionOffsetAround(i.subtract(this._virtualTransformNode.getAbsolutePivotPoint()),l,c);this._virtualTransformNode.rotationQuaternion.multiplyToRef(c,this._ownerNode.rotationQuaternion),this._virtualTransformNode.scaling.scaleToRef(l,this._ownerNode.scaling),this._virtualTransformNode.position.addToRef(h.addInPlace(d),this._ownerNode.position),this.onPositionChangedObservable.notifyObservers({position:this._ownerNode.position}),this._ownerNode.setParent(u)}_targetDragStart(){const e=this.currentDraggingPointerIds.length;this._ownerNode.rotationQuaternion||(this._ownerNode.rotationQuaternion=I.PT.RotationYawPitchRoll(this._ownerNode.rotation.y,this._ownerNode.rotation.x,this._ownerNode.rotation.z));const t=this._ownerNode.getAbsolutePivotPoint();if(1===e){if(this._targetPosition.copyFrom(this._ownerNode.absolutePosition),this._targetOrientation.copyFrom(this._ownerNode.rotationQuaternion),this._targetScaling.copyFrom(this._ownerNode.absoluteScaling),this.faceCameraOnDragStart&&this._scene.activeCamera){const e=I.AA.Vector3[0];this._scene.activeCamera.position.subtractToRef(t,e),e.normalize();const i=I.AA.Quaternion[0];this._scene.useRightHandedSystem?I.PT.FromLookDirectionRHToRef(e,new I.Pq(0,1,0),i):I.PT.FromLookDirectionLHToRef(e,new I.Pq(0,1,0),i),i.normalize(),I.PT.RotationYawPitchRollToRef(i.toEulerAngles().y,0,0,I.AA.Quaternion[0]),this._targetOrientation.copyFrom(I.AA.Quaternion[0])}this._startingPosition.copyFrom(this._targetPosition),this._startingOrientation.copyFrom(this._targetOrientation),this._startingScaling.copyFrom(this._targetScaling)}else 2===e&&(this._virtualTransformNode.setPivotPoint(new I.Pq(0,0,0),0),this._virtualTransformNode.position.copyFrom(this._ownerNode.absolutePosition),this._virtualTransformNode.scaling.copyFrom(this._ownerNode.absoluteScaling),this._virtualTransformNode.rotationQuaternion.copyFrom(this._ownerNode.absoluteRotationQuaternion),this._virtualTransformNode.setPivotPoint(t,1),this._resetVirtualMeshesPosition())}_targetDrag(e,t){1===this.currentDraggingPointerIds.length?this._onePointerPositionUpdated(e,t):2===this.currentDraggingPointerIds.length&&this._twoPointersPositionUpdated()}_targetDragEnd(){if(1===this.currentDraggingPointerIds.length){this._resetVirtualMeshesPosition();const e=this.faceCameraOnDragStart;this.faceCameraOnDragStart=!1,this._targetDragStart(),this.faceCameraOnDragStart=e}}detach(){super.detach(),this._ownerNode&&this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),this._virtualTransformNode&&this._virtualTransformNode.dispose()}}class jh{constructor(){this._attachPointLocalOffset=new I.Pq,this._workingPosition=new I.Pq,this._workingQuaternion=new I.PT,this._lastTick=-1,this._hit=!1,this.hitNormalOffset=.05,this.meshes=[],this.interpolatePose=!0,this.lerpTime=250,this.keepOrientationVertical=!0,this.enabled=!0,this.maxStickingDistance=.8}get name(){return"SurfaceMagnetism"}init(){}attach(e,t){this._attachedMesh=e,this._scene=t||e.getScene(),this._attachedMesh.rotationQuaternion||(this._attachedMesh.rotationQuaternion=I.PT.RotationYawPitchRoll(this._attachedMesh.rotation.y,this._attachedMesh.rotation.x,this._attachedMesh.rotation.z)),this.updateAttachPoint(),this._workingPosition.copyFrom(this._attachedMesh.position),this._workingQuaternion.copyFrom(this._attachedMesh.rotationQuaternion),this._addObservables()}detach(){this._attachedMesh=null,this._removeObservables()}_getTargetPose(e){if(!this._attachedMesh)return null;if(e&&e.hit){const t=e.getNormal(!0,!0),i=e.pickedPoint;if(!t||!i)return null;t.normalize();const s=I.AA.Vector3[0];return s.copyFrom(t),s.scaleInPlace(this.hitNormalOffset),s.addInPlace(i),this._attachedMesh.parent&&(I.AA.Matrix[0].copyFrom(this._attachedMesh.parent.getWorldMatrix()).invert(),I.Pq.TransformNormalToRef(s,I.AA.Matrix[0],s)),{position:s,quaternion:I.PT.RotationYawPitchRoll(-Math.atan2(t.x,-t.z),this.keepOrientationVertical?0:Math.atan2(t.y,Math.sqrt(t.z*t.z+t.x*t.x)),0)}}return null}updateAttachPoint(){this._getAttachPointOffsetToRef(this._attachPointLocalOffset)}findAndUpdateTarget(e){if(this._hit=!1,!e.ray)return!1;const t=e.ray.intersectsMeshes(this.meshes)[0];if(this._attachedMesh&&t&&t.hit&&t.pickedMesh){const e=this._getTargetPose(t);e&&I.Pq.Distance(this._attachedMesh.position,e.position)<this.maxStickingDistance&&(this._workingPosition.copyFrom(e.position),this._workingQuaternion.copyFrom(e.quaternion),this._hit=!0)}return this._hit}_getAttachPointOffsetToRef(e){if(!this._attachedMesh)return void e.setAll(0);const t=I.AA.Quaternion[0];t.copyFrom(this._attachedMesh.rotationQuaternion),this._attachedMesh.rotationQuaternion.copyFromFloats(0,0,0,1),this._attachedMesh.computeWorldMatrix();const i=this._attachedMesh.getHierarchyBoundingVectors(),s=I.AA.Vector3[0];i.max.addToRef(i.min,s),s.scaleInPlace(.5),s.z=i.max.z;const r=I.AA.Matrix[0];this._attachedMesh.getWorldMatrix().invertToRef(r),I.Pq.TransformCoordinatesToRef(s,r,e),this._attachedMesh.rotationQuaternion.copyFrom(t)}_updateTransformToGoal(e){if(!this._attachedMesh||!this._hit)return;const t=this._attachedMesh.parent;this._attachedMesh.setParent(null);const i=I.AA.Vector3[0];if(I.Pq.TransformNormalToRef(this._attachPointLocalOffset,this._attachedMesh.getWorldMatrix(),i),!this.interpolatePose)return this._attachedMesh.position.copyFrom(this._workingPosition).subtractInPlace(i),void this._attachedMesh.rotationQuaternion.copyFrom(this._workingQuaternion);const s=new I.Pq;I.Pq.SmoothToRef(this._attachedMesh.position,this._workingPosition,e,this.lerpTime,s),this._attachedMesh.position.copyFrom(s);const r=new I.PT;r.copyFrom(this._attachedMesh.rotationQuaternion),I.PT.SmoothToRef(r,this._workingQuaternion,e,this.lerpTime,this._attachedMesh.rotationQuaternion),this._attachedMesh.setParent(t)}_addObservables(){this._pointerObserver=this._scene.onPointerObservable.add((e=>{this.enabled&&e.type==Rt.Zp.POINTERMOVE&&e.pickInfo&&this.findAndUpdateTarget(e.pickInfo)})),this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add((()=>{const e=Date.now();this._updateTransformToGoal(e-this._lastTick),this._lastTick=e}))}_removeObservables(){this._scene.onPointerObservable.remove(this._pointerObserver),this._scene.onBeforeRenderObservable.remove(this._onBeforeRender),this._pointerObserver=null,this._onBeforeRender=null}}class Zh{constructor(){this.followBehaviorEnabled=!1,this.sixDofDragBehaviorEnabled=!0,this.surfaceMagnetismBehaviorEnabled=!0,this._followBehavior=new Yh,this._sixDofDragBehavior=new $h,this._surfaceMagnetismBehavior=new jh}get name(){return"Default"}get followBehavior(){return this._followBehavior}get sixDofDragBehavior(){return this._sixDofDragBehavior}get surfaceMagnetismBehavior(){return this._surfaceMagnetismBehavior}init(){}attach(e,t,i){this._scene=e.getScene(),this.attachedNode=e,this._addObservables(),this._followBehavior.attach(e),this._sixDofDragBehavior.attach(e),this._sixDofDragBehavior.draggableMeshes=t||null,this._sixDofDragBehavior.faceCameraOnDragStart=!0,this._surfaceMagnetismBehavior.attach(e,this._scene),i&&(this._surfaceMagnetismBehavior.meshes=i),this._surfaceMagnetismBehavior.enabled=!1}detach(){this.attachedNode=null,this._removeObservables(),this._followBehavior.detach(),this._sixDofDragBehavior.detach(),this._surfaceMagnetismBehavior.detach()}_addObservables(){this._onBeforeRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{this._followBehavior._enabled=!this._sixDofDragBehavior.isMoving&&this.followBehaviorEnabled})),this._onDragObserver=this._sixDofDragBehavior.onDragObservable.add((e=>{this._sixDofDragBehavior.disableMovement=this._surfaceMagnetismBehavior.findAndUpdateTarget(e.pickInfo)}))}_removeObservables(){this._scene.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._sixDofDragBehavior.onDragObservable.remove(this._onDragObserver)}}var Jh,ec;!function(e){e[e.Origin=0]="Origin",e[e.Pivot=1]="Pivot"}(Jh||(Jh={})),function(e){e[e.World=0]="World",e[e.Local=1]="Local"}(ec||(ec={}));class tc{set scaleRatio(e){this._scaleRatio=e}get scaleRatio(){return this._scaleRatio}get isHovered(){return this._isHovered}get attachedMesh(){return this._attachedMesh}set attachedMesh(e){this._attachedMesh=e,e&&(this._attachedNode=e),this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}get attachedNode(){return this._attachedNode}set attachedNode(e){this._attachedNode=e,this._attachedMesh=null,this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach((e=>{e.dispose()})),e.parent=this._rootMesh,this._customMeshSet=!0}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(e){this._additionalTransformNode=e}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){this._coordinatesMode=e;const t=1==e;this.updateGizmoRotationToMatchAttachedMesh=t,this.updateGizmoPositionToMatchAttachedMesh=!0}get coordinatesMode(){return this._coordinatesMode}set updateScale(e){this._updateScale=e}get updateScale(){return this._updateScale}_attachedNodeChanged(e){}constructor(e=fr.DefaultUtilityLayer){this.gizmoLayer=e,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this._updateGizmoPositionToMatchAttachedMesh=!0,this._anchorPoint=0,this._updateScale=!0,this._coordinatesMode=1,this._interactionsEnabled=!0,this._rightHandtoLeftHandMatrix=I.uq.RotationY(Math.PI),this._rootMesh=new At("gizmoRootNode",e.utilityLayerScene),this._rootMesh.rotationQuaternion=I.PT.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add((()=>{this._update()}))}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e}_update(){if(this.attachedNode){let e=this.attachedNode;if(this.attachedMesh&&(e=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh)if(1==this.anchorPoint&&e.getAbsolutePivotPoint){const t=e.getAbsolutePivotPoint();this._rootMesh.position.copyFrom(t)}else{const t=e.getWorldMatrix().getRow(3),i=t?t.toVector3():new I.Pq(0,0,0);this._rootMesh.position.copyFrom(i)}if(this.updateGizmoRotationToMatchAttachedMesh){const t=e._isMesh||"AbstractMesh"===e.getClassName()||"TransformNode"===e.getClassName()||"InstancedMesh"===e.getClassName()?e:void 0;e.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,tc.PreserveScaling?t:void 0),this._rootMesh.rotationQuaternion.normalize()}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){const t=this.gizmoLayer.utilityLayerScene.activeCamera,i=t.globalPosition;this._rootMesh.position.subtractToRef(i,I.AA.Vector3[0]);let s=this.scaleRatio;if(t.mode==se.ORTHOGRAPHIC_CAMERA)t.orthoTop&&t.orthoBottom&&(s*=t.orthoTop-t.orthoBottom);else{const e=t.getScene().useRightHandedSystem?I.Pq.RightHandedForwardReadOnly:I.Pq.LeftHandedForwardReadOnly,i=t.getDirection(e);s*=I.Pq.Dot(I.AA.Vector3[0],i)}this._rootMesh.scaling.setAll(s),e._getWorldMatrixDeterminant()<0&&!tc.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}this.additionalTransformNode&&(this._rootMesh.computeWorldMatrix(!0),this._rootMesh.getWorldMatrix().multiplyToRef(this.additionalTransformNode.getWorldMatrix(),I.AA.Matrix[0]),I.AA.Matrix[0].decompose(this._rootMesh.scaling,this._rootMesh.rotationQuaternion,this._rootMesh.position))}_handlePivotMatrixInverse(e,t,i){if(e.isUsingPivotMatrix()&&!e.isUsingPostMultiplyPivotMatrix())return e.getPivotMatrix().invertToRef(I.AA.Matrix[5]),void I.AA.Matrix[5].multiplyToRef(t,i);i.copyFrom(t)}_matrixChanged(){if(this._attachedNode)if(this._attachedNode._isCamera){const e=this._attachedNode;let t,i;if(e.parent){const i=I.AA.Matrix[1];e.parent._worldMatrix.invertToRef(i),this._attachedNode._worldMatrix.multiplyToRef(i,I.AA.Matrix[0]),t=I.AA.Matrix[0]}else t=this._attachedNode._worldMatrix;if(e.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(t,I.AA.Matrix[1]),i=I.AA.Matrix[1]):i=t,i.decompose(I.AA.Vector3[1],I.AA.Quaternion[0],I.AA.Vector3[0]),"FreeCamera"===this._attachedNode.getClassName()||"FlyCamera"===this._attachedNode.getClassName()||"ArcFollowCamera"===this._attachedNode.getClassName()||"TargetCamera"===this._attachedNode.getClassName()||"TouchCamera"===this._attachedNode.getClassName()||"UniversalCamera"===this._attachedNode.getClassName()){const e=this._attachedNode;e.rotation=I.AA.Quaternion[0].toEulerAngles(),e.rotationQuaternion&&(e.rotationQuaternion.copyFrom(I.AA.Quaternion[0]),e.rotationQuaternion.normalize())}e.position.copyFrom(I.AA.Vector3[0])}else if(this._attachedNode._isMesh||"AbstractMesh"===this._attachedNode.getClassName()||"TransformNode"===this._attachedNode.getClassName()||"InstancedMesh"===this._attachedNode.getClassName()){const e=this._attachedNode;if(e.parent){const t=I.AA.Matrix[0],i=I.AA.Matrix[1];e.parent.getWorldMatrix().invertToRef(t),this._attachedNode.getWorldMatrix().multiplyToRef(t,i);const s=I.AA.Matrix[4];if(this._handlePivotMatrixInverse(e,i,s),s.decompose(I.AA.Vector3[0],I.AA.Quaternion[0],e.position,tc.PreserveScaling?e:void 0,tc.UseAbsoluteScaling),I.AA.Quaternion[0].normalize(),e.isUsingPivotMatrix()){const t=I.AA.Quaternion[1];I.PT.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,t);const i=I.AA.Matrix[2];I.uq.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,i);const s=I.AA.Matrix[2];t.toRotationMatrix(s);const r=e.getPivotMatrix(),n=I.AA.Matrix[3];r.invertToRef(n),r.multiplyToRef(i,I.AA.Matrix[4]),I.AA.Matrix[4].multiplyToRef(s,I.AA.Matrix[5]),I.AA.Matrix[5].multiplyToRef(n,I.AA.Matrix[6]),I.AA.Matrix[6].getTranslationToRef(I.AA.Vector3[1]),e.position.subtractInPlace(I.AA.Vector3[1])}}else{const t=I.AA.Matrix[4];this._handlePivotMatrixInverse(e,this._attachedNode._worldMatrix,t),t.decompose(I.AA.Vector3[0],I.AA.Quaternion[0],e.position,tc.PreserveScaling?e:void 0,tc.UseAbsoluteScaling)}I.AA.Vector3[0].scaleInPlace(1/e.scalingDeterminant),e.scaling.copyFrom(I.AA.Vector3[0]),e.billboardMode||(e.rotationQuaternion?(e.rotationQuaternion.copyFrom(I.AA.Quaternion[0]),e.rotationQuaternion.normalize()):e.rotation=I.AA.Quaternion[0].toEulerAngles())}else if("Bone"===this._attachedNode.getClassName()){const e=this._attachedNode,t=e.getParent();if(t){const i=I.AA.Matrix[0],s=I.AA.Matrix[1];t.getFinalMatrix().invertToRef(i),e.getFinalMatrix().multiplyToRef(i,s),e.getLocalMatrix().copyFrom(s)}else e.getLocalMatrix().copyFrom(e.getFinalMatrix());e.markAsDirty()}else{const e=this._attachedNode;if(e.getTypeID){const t=e.getTypeID();if(t===z.LIGHTTYPEID_DIRECTIONALLIGHT||t===z.LIGHTTYPEID_SPOTLIGHT||t===z.LIGHTTYPEID_POINTLIGHT){const t=e.parent;if(t){const i=I.AA.Matrix[0],s=I.AA.Matrix[1];t.getWorldMatrix().invertToRef(i),e.getWorldMatrix().multiplyToRef(i,s),s.decompose(void 0,I.AA.Quaternion[0],I.AA.Vector3[0])}else this._attachedNode._worldMatrix.decompose(void 0,I.AA.Quaternion[0],I.AA.Vector3[0]);e.position=new I.Pq(I.AA.Vector3[0].x,I.AA.Vector3[0].y,I.AA.Vector3[0].z),e.direction&&(e.direction=new I.Pq(e.direction.x,e.direction.y,e.direction.z))}}}}_setGizmoMeshMaterial(e,t){e&&e.forEach((e=>{e.material=t,e.color&&(e.color=t.diffuseColor)}))}static GizmoAxisPointerObserver(e,t){let i=!1;return e.utilityLayerScene.onPointerObservable.add((e=>{if(e.pickInfo){if(e.type===Rt.Zp.POINTERMOVE){if(i)return;t.forEach((t=>{if(t.colliderMeshes&&t.gizmoMeshes){const i=-1!=t.colliderMeshes?.indexOf(e?.pickInfo?.pickedMesh),s=t.dragBehavior.enabled?i||t.active?t.hoverMaterial:t.material:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=s,e.color&&(e.color=s.diffuseColor)}))}}))}e.type===Rt.Zp.POINTERDOWN&&t.has(e.pickInfo.pickedMesh?.parent)&&(i=!0,t.get(e.pickInfo.pickedMesh?.parent).active=!0,t.forEach((t=>{const i=(-1!=t.colliderMeshes?.indexOf(e?.pickInfo?.pickedMesh)||t.active)&&t.dragBehavior.enabled?t.hoverMaterial:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=i,e.color&&(e.color=i.diffuseColor)}))}))),e.type===Rt.Zp.POINTERUP&&t.forEach((e=>{e.active=!1,i=!1,e.gizmoMeshes.forEach((t=>{t.material=e.dragBehavior.enabled?e.material:e.disableMaterial,t.color&&(t.color=e.material.diffuseColor)}))}))}}))}dispose(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)}}tc.PreserveScaling=!1,tc.UseAbsoluteScaling=!0;class ic{static _RemoveAndStorePivotPoint(e){e&&0===ic._PivotCached&&(e.getPivotPointToRef(ic._OldPivotPoint),ic._PivotPostMultiplyPivotMatrix=e._postMultiplyPivotMatrix,ic._OldPivotPoint.equalsToFloats(0,0,0)||(e.setPivotMatrix(I.uq.IdentityReadOnly),ic._OldPivotPoint.subtractToRef(e.getPivotPoint(),ic._PivotTranslation),ic._PivotTmpVector.copyFromFloats(1,1,1),ic._PivotTmpVector.subtractInPlace(e.scaling),ic._PivotTmpVector.multiplyInPlace(ic._PivotTranslation),e.position.addInPlace(ic._PivotTmpVector))),ic._PivotCached++}static _RestorePivotPoint(e){e&&!ic._OldPivotPoint.equalsToFloats(0,0,0)&&1===ic._PivotCached&&(e.setPivotPoint(ic._OldPivotPoint),e._postMultiplyPivotMatrix=ic._PivotPostMultiplyPivotMatrix,ic._PivotTmpVector.copyFromFloats(1,1,1),ic._PivotTmpVector.subtractInPlace(e.scaling),ic._PivotTmpVector.multiplyInPlace(ic._PivotTranslation),e.position.subtractInPlace(ic._PivotTmpVector)),this._PivotCached--}}ic._PivotCached=0,ic._OldPivotPoint=new I.Pq,ic._PivotTranslation=new I.Pq,ic._PivotTmpVector=new I.Pq,ic._PivotPostMultiplyPivotMatrix=!1;ae.l.ShadersStore.handleVertexShader="precision highp float;attribute vec3 position;uniform vec3 positionOffset;uniform mat4 worldViewProjection;uniform float scale;void main(void) {vec4 vPos=vec4((vec3(position)+positionOffset)*scale,1.0);gl_Position=worldViewProjection*vPos;}";ae.l.ShadersStore.handlePixelShader="uniform vec3 color;void main(void) {gl_FragColor=vec4(color,1.0);}";class sc extends Cn{get hover(){return this._hover}set hover(e){this._hover=e,this._updateInterpolationTarget()}get drag(){return this._drag}set drag(e){this._drag=e,this._updateInterpolationTarget()}constructor(e,t){super(e,t,"handle",{attributes:["position"],uniforms:["worldViewProjection","color","scale","positionOffset"],needAlphaBlending:!1,needAlphaTesting:!1}),this._hover=!1,this._drag=!1,this._color=new M.v9,this._scale=1,this._lastTick=-1,this.animationLength=100,this.hoverColor=new M.v9(0,.467,.84),this.baseColor=new M.v9(1,1,1),this.hoverScale=.75,this.baseScale=.35,this.dragScale=.55,this._positionOffset=I.Pq.Zero(),this._updateInterpolationTarget(),this._lastTick=Date.now(),this._onBeforeRender=this.getScene().onBeforeRenderObservable.add((()=>{const e=Date.now(),t=e-this._lastTick,i=this._targetScale-this._scale,s=M.IG.Color3[0].copyFrom(this._targetColor).subtractToRef(this._color,M.IG.Color3[0]);this._scale=this._scale+i*t/this.animationLength,s.scaleToRef(t/this.animationLength,s),this._color.addToRef(s,this._color),this.setColor3("color",this._color),this.setFloat("scale",this._scale),this.setVector3("positionOffset",this._positionOffset),this._lastTick=e}))}_updateInterpolationTarget(){this.drag?(this._targetColor=this.hoverColor,this._targetScale=this.dragScale):this.hover?(this._targetColor=this.hoverColor,this._targetScale=this.hoverScale):(this._targetColor=this.baseColor,this._targetScale=this.baseScale)}dispose(){super.dispose(),this.getScene().onBeforeRenderObservable.remove(this._onBeforeRender)}}var rc;!function(e){e[e.IDLE=0]="IDLE",e[e.HOVER=1]="HOVER",e[e.DRAG=2]="DRAG"}(rc||(rc={}));class nc{get state(){return this._state}get gizmo(){return this._gizmo}set hover(e){e?this._state|=rc.HOVER:this._state&=~rc.HOVER,this._updateMaterial()}set drag(e){e?this._state|=rc.DRAG:this._state&=~rc.DRAG,this._updateMaterial()}constructor(e,t){this._state=rc.IDLE,this._materials=[],this._scene=t,this._gizmo=e,this.node=this.createNode(),this.node.reservedDataStore={handle:this}}_createMaterial(e){const t=new sc("handle",this._scene);return e&&(t._positionOffset=e),t}_updateMaterial(){const e=this._state;for(const e of this._materials)e.hover=!1,e.drag=!1;if(e&rc.DRAG)for(const e of this._materials)e.drag=!0;else if(e&rc.HOVER)for(const e of this._materials)e.hover=!0}setDragBehavior(e,t,i){const s=new qh;this._dragBehavior=s,this._dragStartObserver=s.onDragStartObservable.add(e),this._draggingObserver=s.onDragObservable.add(t),this._dragEndObserver=s.onDragEndObservable.add(i),this._dragBehavior.attach(this.node)}dispose(){this._dragBehavior.onDragStartObservable.remove(this._dragStartObserver),this._dragBehavior.onDragObservable.remove(this._draggingObserver),this._dragBehavior.onDragEndObservable.remove(this._dragEndObserver),this._dragBehavior.detach();for(const e of this._materials)e.dispose();this.node.dispose()}}class ac extends nc{createNode(){const e=xi("sideVert",{width:1,height:10,depth:.1},this._scene),t=new dt("side",this._scene);e.parent=t;const i=this._createMaterial();return e.material=i,e.isNearGrabbable=!0,this._materials.push(i),t}}class oc extends nc{createNode(){const e=xi("angleHor",{width:3,height:1,depth:.1},this._scene),t=xi("angleVert",{width:1,height:3,depth:.1},this._scene),i=new dt("angle",this._scene);return e.parent=i,t.parent=i,e.material=this._createMaterial(new I.Pq(1,0,0)),t.material=this._createMaterial(new I.Pq(0,1,0)),t.isNearGrabbable=!0,e.isNearGrabbable=!0,this._materials.push(e.material),this._materials.push(t.material),i}}class lc extends tc{set attachedSlate(e){e?(this.attachedMesh=e.mesh,this.updateBoundingBox(),this._pickedPointObserver=e._host.onPickingObservable.add((e=>{if(!this._handleHovered||e&&e.parent===this._handleHovered.node||(this._handleHovered.hover=!1,this._handleHovered=null),e&&e.parent&&e.parent.reservedDataStore&&e.parent.reservedDataStore.handle){const t=e.parent.reservedDataStore.handle;t.gizmo===this&&(this._handleHovered=t,this._handleHovered.hover=!0)}}))):this._attachedSlate&&this._attachedSlate._host.onPickingObservable.remove(this._pickedPointObserver),this._attachedSlate=e}get attachedSlate(){return this._attachedSlate}constructor(e){super(e),this._boundingDimensions=new I.Pq(0,0,0),this._renderObserver=null,this._tmpQuaternion=new I.PT,this._tmpVector=new I.Pq(0,0,0),this._corners=[],this._sides=[],this._boundingBoxGizmo={min:new I.Pq,max:new I.Pq},this._margin=.35,this._handleSize=.075,this._attachedSlate=null,this._existingSlateScale=new I.Pq,this.fixedScreenSize=!1,this.fixedScreenSizeDistanceFactor=10,this._createNode(),this.updateScale=!1,this._renderObserver=this.gizmoLayer.originalScene.onBeforeRenderObservable.add((()=>{this.attachedMesh&&!this._existingSlateScale.equals(this.attachedMesh.scaling)&&this.updateBoundingBox()}))}_createNode(){this._handlesParent=new dt("handlesParent",this.gizmoLayer.utilityLayerScene),this._handlesParent.rotationQuaternion=I.PT.Identity();const e=[{dimensions:new I.Pq(-1,-1,0),origin:new I.Pq(1,0,0)},{dimensions:new I.Pq(1,-1,0),origin:new I.Pq(0,0,0)},{dimensions:new I.Pq(1,1,0),origin:new I.Pq(0,1,0)},{dimensions:new I.Pq(-1,1,0),origin:new I.Pq(1,1,0)}];for(let t=0;t<4;t++){const i=new oc(this,this.gizmoLayer.utilityLayerScene);this._corners.push(i),i.node.rotation.z=Math.PI/2*t,i.node.parent=this._handlesParent,this._assignDragBehaviorCorners(i,((e,t,i,s)=>this._moveHandle(e,t,i,s,!0)),e[t])}for(let e=0;e<4;e++){const t=new ac(this,this.gizmoLayer.utilityLayerScene);this._sides.push(t),t.node.rotation.z=Math.PI/2*e,t.node.parent=this._handlesParent,this._assignDragBehaviorSides(t,e%2==0?new I.Pq(0,1,0):new I.Pq(1,0,0))}this._handlesParent.parent=this._rootMesh}_keepAspectRatio(e,t,i=!1){const s=I.AA.Vector3[0];s.copyFromFloats(t,1,0).normalize(),i&&(s.y*=-1);const r=I.Pq.Dot(e,s);e.copyFrom(s).scaleInPlace(r)}_clampDimensions(e,t,i,s=!1){const r=I.AA.Vector3[0];r.copyFrom(e).multiplyInPlace(i);const n=I.AA.Vector3[1];if(n.copyFromFloats(Math.max(this._attachedSlate.minDimensions.x,r.x+t.x),Math.max(this._attachedSlate.minDimensions.y,r.y+t.y),0),s){const e=t.x/t.y;n.x=Math.max(n.x,n.y*e),n.y=Math.max(n.y,n.x/e)}r.copyFrom(n).subtractInPlace(t),e.x=Math.sign(e.x)*Math.abs(r.x),e.y=Math.sign(e.y)*Math.abs(r.y)}_moveHandle(e,t,i,s,r){if(!this._attachedSlate)return;if(r){const e=t.x/t.y;this._keepAspectRatio(i,e,s.dimensions.x*s.dimensions.y<0)}this._clampDimensions(i,t,s.dimensions,r);const n=I.AA.Vector3[0],a=I.AA.Vector3[1];n.copyFrom(i).multiplyInPlace(s.origin),a.copyFrom(i).multiplyInPlace(s.dimensions),this._attachedSlate.origin.copyFrom(e).addInPlace(n),this._attachedSlate.dimensions.set(t.x+a.x,t.y+a.y)}_assignDragBehaviorCorners(e,t,i){const s=new I.Pq,r=new I.Pq,n=new I.Pq,a=new I.uq,o=new I.Pq;e.setDragBehavior((e=>{this.attachedSlate&&this.attachedMesh&&(s.set(this.attachedSlate.dimensions.x,this.attachedSlate.dimensions.y,ft.bH),r.copyFrom(this.attachedSlate.origin),n.copyFrom(e.position),a.copyFrom(this.attachedMesh.computeWorldMatrix(!0)),a.invert(),this.attachedSlate._followButton.isToggled=!1,I.Pq.TransformNormalToRef(I.Pq.Forward(),this.attachedMesh.getWorldMatrix(),o),o.normalize(),this._handleHovered&&(this._handleDragged=this._handleHovered,this._handleDragged.drag=!0))}),(e=>{this.attachedSlate&&this.attachedMesh&&(((e,t,i,s)=>{e.subtractToRef(i,I.AA.Vector3[0]);const r=I.Pq.Dot(I.AA.Vector3[0],t);I.AA.Vector3[1].copyFrom(t).scaleInPlace(r),I.AA.Vector3[0].subtractInPlace(I.AA.Vector3[1]),I.AA.Vector3[0].addToRef(i,s)})(e.position,o,n,this._tmpVector),this._tmpVector.subtractInPlace(n),I.Pq.TransformNormalToRef(this._tmpVector,a,this._tmpVector),t(r,s,this._tmpVector,i),this.attachedSlate._positionElements(),this.updateBoundingBox())}),(()=>{this.attachedSlate&&this.attachedNode&&(this.attachedSlate._updatePivot(),this._handleDragged&&(this._handleDragged.drag=!1,this._handleDragged=null))}))}_assignDragBehaviorSides(e,t){const i=new I.PT,s=new I.Pq,r=new I.Pq,n=new I.Pq,a=new I.Pq;e.setDragBehavior((e=>{this.attachedSlate&&this.attachedMesh&&(i.copyFrom(this.attachedMesh.rotationQuaternion),s.copyFrom(e.position),n.copyFrom(this.attachedMesh.getAbsolutePivotPoint()),r.copyFrom(s).subtractInPlace(n).normalize(),this.attachedSlate._followButton.isToggled=!1,I.Pq.TransformNormalToRef(t,this.attachedMesh.getWorldMatrix(),a),a.normalize(),this._handleHovered&&(this._handleDragged=this._handleHovered,this._handleDragged.drag=!0))}),(e=>{if(this.attachedSlate&&this.attachedMesh){this._tmpVector.copyFrom(e.position),this._tmpVector.subtractInPlace(n),this._tmpVector.normalize();const s=-I.Pq.GetAngleBetweenVectorsOnPlane(this._tmpVector,r,a);I.PT.RotationAxisToRef(t,s,this._tmpQuaternion),i.multiplyToRef(this._tmpQuaternion,this.attachedMesh.rotationQuaternion)}}),(()=>{this.attachedSlate&&this.attachedNode&&(this.attachedSlate._updatePivot(),this._handleDragged&&(this._handleDragged.drag=!1,this._handleDragged=null))}))}_attachedNodeChanged(e){e&&this.updateBoundingBox()}updateBoundingBox(){if(this.attachedMesh){ic._RemoveAndStorePivotPoint(this.attachedMesh);const e=this.attachedMesh.parent;this.attachedMesh.setParent(null),this._update(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=I.PT.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._tmpQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpVector.copyFrom(this.attachedMesh.position),this.attachedMesh.rotationQuaternion.set(0,0,0,1),this.attachedMesh.position.set(0,0,0);const t=this.attachedMesh.getHierarchyBoundingVectors();t.max.subtractToRef(t.min,this._boundingDimensions),this._boundingBoxGizmo.min=t.min,this._boundingBoxGizmo.max=t.max,this._updateHandlesPosition(),this._updateHandlesScaling(),this.attachedMesh.rotationQuaternion.copyFrom(this._tmpQuaternion),this.attachedMesh.position.copyFrom(this._tmpVector),ic._RestorePivotPoint(this.attachedMesh),this.attachedMesh.setParent(e),this.attachedMesh.computeWorldMatrix(!0),this._existingSlateScale.copyFrom(this.attachedMesh.scaling)}}_updateHandlesPosition(){const e=this._boundingBoxGizmo.min.clone(),t=this._boundingBoxGizmo.max.clone(),i=this._corners[0].node.scaling.length();e.x-=this._margin*i,e.y-=this._margin*i,t.x+=this._margin*i,t.y+=this._margin*i;const s=e.add(t).scaleInPlace(.5);this._corners[0].node.position.copyFromFloats(e.x,e.y,0),this._corners[1].node.position.copyFromFloats(t.x,e.y,0),this._corners[2].node.position.copyFromFloats(t.x,t.y,0),this._corners[3].node.position.copyFromFloats(e.x,t.y,0),this._sides[0].node.position.copyFromFloats(e.x,s.y,0),this._sides[1].node.position.copyFromFloats(s.x,e.y,0),this._sides[2].node.position.copyFromFloats(t.x,s.y,0),this._sides[3].node.position.copyFromFloats(s.x,t.y,0)}_updateHandlesScaling(){if(this._attachedSlate&&this._attachedSlate.mesh){const e=this._attachedSlate.mesh.scaling.x*this._attachedSlate.dimensions.x,t=this._attachedSlate.mesh.scaling.y*this._attachedSlate.dimensions.y,i=Math.min(e,t)*this._handleSize;for(let e=0;e<this._corners.length;e++)this._corners[e].node.scaling.setAll(i);for(let e=0;e<this._sides.length;e++)this._sides[e].node.scaling.setAll(i)}}_update(){if(super._update(),this.gizmoLayer.utilityLayerScene.activeCamera&&this._attachedSlate&&this._attachedSlate.mesh){if(this.fixedScreenSize){this._attachedSlate.mesh.absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);const e=this._handleSize*this._tmpVector.length()/this.fixedScreenSizeDistanceFactor;for(let t=0;t<this._corners.length;t++)this._corners[t].node.scaling.set(e,e,e);for(let t=0;t<this._sides.length;t++)this._sides[t].node.scaling.set(e,e,e)}this._updateHandlesPosition()}}dispose(){this.gizmoLayer.originalScene.onBeforeRenderObservable.remove(this._renderObserver),super.dispose();for(const e of this._corners)e.dispose();for(const e of this._sides)e.dispose()}}class hc{get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}set enabled(e){e!=this._enabled&&this.onEnabledObservable.notifyObservers(e),this._enabled=e}get enabled(){return this._enabled}get options(){return this._options}set options(e){this._options=e}constructor(e){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this._activeDragButton=-1,this.maxDragAngle=0,this.dragButtons=[0,1,2],this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new C.cP,this.onDragStartObservable=new C.cP,this.onDragEndObservable=new C.cP,this.onEnabledObservable=new C.cP,this.moveAttached=!0,this._enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=e=>!0,this._tmpVector=new I.Pq(0,0,0),this._alternatePickedPoint=new I.Pq(0,0,0),this._worldDragAxis=new I.Pq(0,0,0),this._targetPosition=new I.Pq(0,0,0),this._attachedToElement=!1,this._startDragRay=new qi(new I.Pq,new I.Pq),this._lastPointerRay={},this._dragDelta=new I.Pq,this._pointA=new I.Pq(0,0,0),this._pointC=new I.Pq(0,0,0),this._localAxis=new I.Pq(0,0,0),this._lookAt=new I.Pq(0,0,0),this._options=e||{};let t=0;if(this._options.dragAxis&&t++,this._options.dragPlaneNormal&&t++,t>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}get name(){return"PointerDrag"}init(){}attach(e,t){this._scene=e.getScene(),e.isNearGrabbable=!0,this.attachedNode=e,hc._PlaneScene||(this._debugMode?hc._PlaneScene=this._scene:(hc._PlaneScene=new be.Z(this._scene.getEngine(),{virtual:!0}),hc._PlaneScene.detachControl(),this._scene.onDisposeObservable.addOnce((()=>{hc._PlaneScene.dispose(),hc._PlaneScene=null})))),this._dragPlane=_i("pointerDragPlane",{size:this._debugMode?1:1e4,updatable:!1,sideOrientation:At.DOUBLESIDE},hc._PlaneScene),this.lastDragPosition=new I.Pq(0,0,0);const i=t||(e=>this.attachedNode==e||e.isDescendantOf(this.attachedNode));this._pointerObserver=this._scene.onPointerObservable.add((e=>{if(this.enabled){if(e.type==Rt.Zp.POINTERDOWN)this.startAndReleaseDragOnPointerEvents&&!this.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&i(e.pickInfo.pickedMesh)&&-1===this._activeDragButton&&-1!==this.dragButtons.indexOf(e.event.button)&&(this._activeDragButton=e.event.button,this._activePointerInfo=e,this._startDrag(e.event.pointerId,e.pickInfo.ray,e.pickInfo.pickedPoint));else if(e.type==Rt.Zp.POINTERUP)!this.startAndReleaseDragOnPointerEvents||this.currentDraggingPointerId!=e.event.pointerId||this._activeDragButton!==e.event.button&&-1!==this._activeDragButton||this.releaseDrag();else if(e.type==Rt.Zp.POINTERMOVE){const t=e.event.pointerId;if(this.currentDraggingPointerId===hc._AnyMouseId&&t!==hc._AnyMouseId){const i=e.event;("mouse"===i.pointerType||!this._scene.getEngine().hostInformation.isMobile&&i instanceof MouseEvent)&&(this._lastPointerRay[this.currentDraggingPointerId]&&(this._lastPointerRay[t]=this._lastPointerRay[this.currentDraggingPointerId],delete this._lastPointerRay[this.currentDraggingPointerId]),this.currentDraggingPointerId=t)}this._lastPointerRay[t]||(this._lastPointerRay[t]=new qi(new I.Pq,new I.Pq)),e.pickInfo&&e.pickInfo.ray&&(this._lastPointerRay[t].origin.copyFrom(e.pickInfo.ray.origin),this._lastPointerRay[t].direction.copyFrom(e.pickInfo.ray.direction),this.currentDraggingPointerId==t&&this.dragging&&this._moveDrag(e.pickInfo.ray))}}else this._attachedToElement&&this.releaseDrag()})),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{if(this._moving&&this.moveAttached){let e=!1;ic._RemoveAndStorePivotPoint(this.attachedNode),this._targetPosition.subtractToRef(this.attachedNode.absolutePosition,this._tmpVector),this._tmpVector.scaleInPlace(this.dragDeltaRatio),this.attachedNode.getAbsolutePosition().addToRef(this._tmpVector,this._tmpVector),this.validateDrag(this._tmpVector)&&(this.attachedNode.setAbsolutePosition(this._tmpVector),e=!0),ic._RestorePivotPoint(this.attachedNode),e&&this.attachedNode.computeWorldMatrix()}}))}releaseDrag(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo})),this.currentDraggingPointerId=-1,this._activeDragButton=-1,this._activePointerInfo=null,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if("ArcRotateCamera"===this._scene.activeCamera.getClassName()){const e=this._scene.activeCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._scene.activeCamera.attachControl(!this._scene.activeCamera.inputs||this._scene.activeCamera.inputs.noPreventDefault);this._attachedToElement=!1}}startDrag(e=hc._AnyMouseId,t,i){this._startDrag(e,t,i);let s=this._lastPointerRay[e];e===hc._AnyMouseId&&(s=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),s&&this._moveDrag(s)}_startDrag(e,t,i){if(!this._scene.activeCamera||this.dragging||!this.attachedNode)return;ic._RemoveAndStorePivotPoint(this.attachedNode),t?(this._startDragRay.direction.copyFrom(t.direction),this._startDragRay.origin.copyFrom(t.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,i||this._tmpVector);const s=this._pickWithRayOnDragPlane(this._startDragRay);s?(this.dragging=!0,this.currentDraggingPointerId=e,this.lastDragPosition.copyFrom(s),this.onDragStartObservable.notifyObservers({dragPlanePoint:s,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)):this.releaseDrag(),ic._RestorePivotPoint(this.attachedNode)}_moveDrag(e){this._moving=!0;const t=this._pickWithRayOnDragPlane(e);if(t){ic._RemoveAndStorePivotPoint(this.attachedNode),this.updateDragPlane&&this._updateDragPlanePosition(e,t);let i=0;this._options.dragAxis?(this.useObjectOrientationForDragging?I.Pq.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),t.subtractToRef(this.lastDragPosition,this._tmpVector),i=I.Pq.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(i,this._dragDelta)):(i=this._dragDelta.length(),t.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:i,delta:this._dragDelta,dragPlanePoint:t,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this.lastDragPosition.copyFrom(t),ic._RestorePivotPoint(this.attachedNode)}}_pickWithRayOnDragPlane(e){if(!e)return null;let t=Math.acos(I.Pq.Dot(this._dragPlane.forward,e.direction));if(t>Math.PI/2&&(t=Math.PI-t),this.maxDragAngle>0&&t>this.maxDragAngle){if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(e.direction),this.attachedNode.absolutePosition.subtractToRef(e.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*I.Pq.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);const t=I.Pq.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-t,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}return null}const i=this._dragPlane.forward,s=this._dragPlane.position,r=e.direction.dot(i);if(Math.abs(r)<ft.bH)return null;s.subtractToRef(e.origin,I.AA.Vector3[0]);const n=I.AA.Vector3[0].dot(i)/r;return n<0?null:(e.direction.scaleToRef(n,I.AA.Vector3[0]),e.origin.add(I.AA.Vector3[0]))}_updateDragPlanePosition(e,t){this._pointA.copyFrom(t),this._options.dragAxis?(this.useObjectOrientationForDragging?I.Pq.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),e.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(I.Pq.Dot(this._localAxis,this._pointC))>.999?Math.abs(I.Pq.Dot(I.Pq.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(I.Pq.Right()):this._lookAt.copyFrom(I.Pq.UpReadOnly):(I.Pq.CrossToRef(this._localAxis,this._pointC,this._lookAt),I.Pq.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?I.Pq.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(e.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)}detach(){this._lastPointerRay={},this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._dragPlane&&this._dragPlane.dispose(),this.releaseDrag()}}hc._AnyMouseId=-2;class cc extends Ah{get defaultBehavior(){return this._defaultBehavior}get dimensions(){return this._dimensions}set dimensions(e){let t=1;if(e.x<this.minDimensions.x||e.y<this.minDimensions.y){const i=e.x/e.y;t=this.minDimensions.x/this.minDimensions.y>i?this.minDimensions.x/e.x:this.minDimensions.y/e.y}this._dimensions.copyFrom(e).scaleInPlace(t),this._updatePivot(),this._positionElements()}get titleBarHeight(){return this._titleBarHeight}set titleBarHeight(e){this._titleBarHeight=e}set renderingGroupId(e){this._titleBar.renderingGroupId=e,this._titleBarTitle.renderingGroupId=e,this._contentPlate.renderingGroupId=e,this._backPlate.renderingGroupId=e}get renderingGroupId(){return this._titleBar.renderingGroupId}set title(e){this._titleText=e,this._titleTextComponent&&(this._titleTextComponent.text=e)}get title(){return this._titleText}constructor(e){super(e),this.titleBarMargin=.005,this.origin=new I.Pq(0,0,0),this._dimensions=new I.I9(21.875,12.5),this._titleBarHeight=.625,this._titleText="",this._contentScaleRatio=1,this.minDimensions=new I.I9(15.625,6.25),this.defaultDimensions=this._dimensions.clone(),this._followButton=new Qh("followButton"+this.name),this._followButton.isToggleButton=!0,this._closeButton=new Qh("closeButton"+this.name),this._contentViewport=new te.L(0,0,1,1),this._contentDragBehavior=new hc({dragPlaneNormal:new I.Pq(0,0,-1)})}_applyFacade(e){this._contentMaterial.albedoTexture=e,this._resetContentPositionAndZoom(),this._applyContentViewport(),e.attachToMesh(this._contentPlate,!0)}_addControl(e){e._host=this._host,this._host.utilityLayer&&e._prepareNode(this._host.utilityLayer.utilityLayerScene)}_getTypeName(){return"HolographicSlate"}_positionElements(){const e=this._followButton,t=this._closeButton,i=this._titleBar,s=this._titleBarTitle,r=this._contentPlate,n=this._backPlate;if(e&&t&&i){t.scaling.setAll(this.titleBarHeight),e.scaling.setAll(this.titleBarHeight),t.position.copyFromFloats(this.dimensions.x-this.titleBarHeight/2,-this.titleBarHeight/2,0).addInPlace(this.origin),e.position.copyFromFloats(this.dimensions.x-3*this.titleBarHeight/2,-this.titleBarHeight/2,0).addInPlace(this.origin);const a=this.dimensions.y-this.titleBarHeight-this.titleBarMargin,o=r.getScene().useRightHandedSystem;i.scaling.set(this.dimensions.x,this.titleBarHeight,ft.bH),s.scaling.set(this.dimensions.x-2*this.titleBarHeight,this.titleBarHeight,ft.bH),r.scaling.copyFromFloats(this.dimensions.x,a,ft.bH),n.scaling.copyFromFloats(this.dimensions.x,a,ft.bH),i.position.copyFromFloats(this.dimensions.x/2,-this.titleBarHeight/2,0).addInPlace(this.origin),s.position.copyFromFloats(this.dimensions.x/2-this.titleBarHeight,-this.titleBarHeight/2,o?ft.bH:-ft.bH).addInPlace(this.origin),r.position.copyFromFloats(this.dimensions.x/2,-(this.titleBarHeight+this.titleBarMargin+a/2),0).addInPlace(this.origin),n.position.copyFromFloats(this.dimensions.x/2,-(this.titleBarHeight+this.titleBarMargin+a/2),o?-ft.bH:ft.bH).addInPlace(this.origin),this._titleTextComponent.host.scaleTo(cc._DEFAULT_TEXT_RESOLUTION_Y*s.scaling.x/s.scaling.y,cc._DEFAULT_TEXT_RESOLUTION_Y);const l=this.dimensions.x/a;this._contentViewport.width=this._contentScaleRatio,this._contentViewport.height=this._contentScaleRatio/l,this._applyContentViewport(),this._gizmo&&this._gizmo.updateBoundingBox()}}_applyContentViewport(){if(this._contentPlate?.material&&this._contentPlate.material.albedoTexture){const e=this._contentPlate.material.albedoTexture;e.uScale=this._contentScaleRatio,e.vScale=this._contentScaleRatio/this._contentViewport.width*this._contentViewport.height,e.uOffset=this._contentViewport.x,e.vOffset=this._contentViewport.y}}_resetContentPositionAndZoom(){this._contentViewport.x=0,this._contentViewport.y=1-this._contentViewport.height/this._contentViewport.width,this._contentScaleRatio=1}_updatePivot(){if(!this.mesh)return;const e=new I.Pq(.5*this.dimensions.x,.5*-this.dimensions.y,ft.bH);e.addInPlace(this.origin),e.z=0;const t=new I.Pq(0,0,0);I.Pq.TransformCoordinatesToRef(t,this.mesh.computeWorldMatrix(!0),t),this.mesh.setPivotPoint(e);const i=new I.Pq(0,0,0);I.Pq.TransformCoordinatesToRef(i,this.mesh.computeWorldMatrix(!0),i),this.mesh.position.addInPlace(t).subtractInPlace(i)}_createNode(e){const t=new At("slate_"+this.name,e);this._titleBar=xi("titleBar_"+this.name,{size:1},e),this._titleBarTitle=_i("titleText_"+this.name,{size:1},e),this._titleBarTitle.parent=t,this._titleBarTitle.isPickable=!1;const i=Ch.CreateForMesh(this._titleBarTitle);if(this._titleTextComponent=new ql("titleText_"+this.name,this._titleText),this._titleTextComponent.textWrapping=Yl.Ellipsis,this._titleTextComponent.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,this._titleTextComponent.color="white",this._titleTextComponent.fontSize=cc._DEFAULT_TEXT_RESOLUTION_Y/2,this._titleTextComponent.paddingLeft=cc._DEFAULT_TEXT_RESOLUTION_Y/4,i.addControl(this._titleTextComponent),e.useRightHandedSystem){const t=new Nr.IU(0,0,1,1);this._contentPlate=_i("contentPlate_"+this.name,{size:1,sideOrientation:at.BACKSIDE,frontUVs:t},e),this._backPlate=_i("backPlate_"+this.name,{size:1,sideOrientation:at.FRONTSIDE},e)}else{const t=new Nr.IU(0,0,1,1);this._contentPlate=_i("contentPlate_"+this.name,{size:1,sideOrientation:at.FRONTSIDE,frontUVs:t},e),this._backPlate=_i("backPlate_"+this.name,{size:1,sideOrientation:at.BACKSIDE},e)}this._titleBar.parent=t,this._titleBar.isNearGrabbable=!0,this._contentPlate.parent=t,this._backPlate.parent=t,this._attachContentPlateBehavior(),this._addControl(this._followButton),this._addControl(this._closeButton);const s=this._followButton,r=this._closeButton;return s.node.parent=t,r.node.parent=t,this._positionElements(),this._followButton.imageUrl=cc.ASSETS_BASE_URL+cc.FOLLOW_ICON_FILENAME,this._closeButton.imageUrl=cc.ASSETS_BASE_URL+cc.CLOSE_ICON_FILENAME,this._followButton.isBackplateVisible=!1,this._closeButton.isBackplateVisible=!1,this._followButton.onToggleObservable.add((e=>{this._defaultBehavior.followBehaviorEnabled=e,this._defaultBehavior.followBehaviorEnabled&&this._defaultBehavior.followBehavior.recenter()})),this._closeButton.onPointerClickObservable.add((()=>{this.dispose()})),t.rotationQuaternion=I.PT.Identity(),t.isVisible=!1,t}_attachContentPlateBehavior(){this._contentDragBehavior.attach(this._contentPlate),this._contentDragBehavior.moveAttached=!1,this._contentDragBehavior.useObjectOrientationForDragging=!0,this._contentDragBehavior.updateDragPlane=!1;const e=new I.Pq,t=new I.Pq,i=new I.Pq,s=new I.Pq,r=new I.I9;let n,a;this._contentDragBehavior.onDragStartObservable.add((r=>{this.node&&(n=this._contentViewport.clone(),a=this.node.computeWorldMatrix(!0),e.copyFrom(r.dragPlanePoint),t.set(this.dimensions.x,this.dimensions.y,ft.bH),t.y-=this.titleBarHeight+this.titleBarMargin,I.Pq.TransformNormalToRef(t,a,t),i.copyFromFloats(0,1,0),I.Pq.TransformNormalToRef(i,a,i),s.copyFromFloats(1,0,0),I.Pq.TransformNormalToRef(s,a,s),i.normalize(),i.scaleInPlace(1/I.Pq.Dot(i,t)),s.normalize(),s.scaleInPlace(1/I.Pq.Dot(s,t)))}));const o=new I.Pq;this._contentDragBehavior.onDragObservable.add((t=>{o.copyFrom(t.dragPlanePoint),o.subtractInPlace(e),r.copyFromFloats(I.Pq.Dot(o,s),I.Pq.Dot(o,i)),this._contentViewport.x=Kh.Clamp(n.x-o.x,0,1-this._contentViewport.width*this._contentScaleRatio),this._contentViewport.y=Kh.Clamp(n.y-o.y,0,1-this._contentViewport.height*this._contentScaleRatio),this._applyContentViewport()}))}_affectMaterial(e){this._titleBarMaterial=new Vh(`${this.name} plateMaterial`,e.getScene()),this._contentMaterial=new Dh(`${this.name} contentMaterial`,e.getScene()),this._contentMaterial.renderBorders=!0,this._backMaterial=new Vh(`${this.name} backPlate`,e.getScene()),this._backMaterial.lineWidth=ft.bH,this._backMaterial.radius=.005,this._backMaterial.backFaceCulling=!0,this._titleBar.material=this._titleBarMaterial,this._contentPlate.material=this._contentMaterial,this._backPlate.material=this._backMaterial,this._resetContent(),this._applyContentViewport()}_prepareNode(e){super._prepareNode(e),this._gizmo=new lc(this._host.utilityLayer),this._gizmo.attachedSlate=this,this._defaultBehavior=new Zh,this._defaultBehavior.attach(this.node,[this._titleBar]),this._defaultBehavior.sixDofDragBehavior.onDragStartObservable.add((()=>{this._followButton.isToggled=!1})),this._positionChangedObserver=this._defaultBehavior.sixDofDragBehavior.onPositionChangedObservable.add((()=>{this._gizmo.updateBoundingBox()})),this._updatePivot(),this.resetDefaultAspectAndPose(!1)}resetDefaultAspectAndPose(e=!0){if(!this._host||!this._host.utilityLayer||!this.node)return;const t=this._host.utilityLayer.utilityLayerScene,i=t.activeCamera;if(i){const s=i.getWorldMatrix(),r=I.Pq.TransformNormal(I.Pq.Backward(t.useRightHandedSystem),s);this.origin.setAll(0),this._gizmo.updateBoundingBox();const n=this.node.getAbsolutePivotPoint();this.node.position.copyFrom(i.position).subtractInPlace(r).subtractInPlace(n),this.node.rotationQuaternion=I.PT.FromLookDirectionLH(r,new I.Pq(0,1,0)),e&&(this.dimensions=this.defaultDimensions)}}dispose(){super.dispose(),this._titleBarMaterial.dispose(),this._contentMaterial.dispose(),this._titleBar.dispose(),this._titleBarTitle.dispose(),this._contentPlate.dispose(),this._backPlate.dispose(),this._followButton.dispose(),this._closeButton.dispose(),this._host.onPickedPointChangedObservable.remove(this._pickedPointObserver),this._defaultBehavior.sixDofDragBehavior.onPositionChangedObservable.remove(this._positionChangedObserver),this._defaultBehavior.detach(),this._gizmo.dispose(),this._contentDragBehavior.detach()}}cc.ASSETS_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",cc.CLOSE_ICON_FILENAME="IconClose.png",cc.FOLLOW_ICON_FILENAME="IconFollowMe.png",cc._DEFAULT_TEXT_RESOLUTION_Y=102.4;class uc extends Fh{get defaultBehavior(){return this._defaultBehavior}get isPinned(){return this._isPinned}set isPinned(e){this._pinButton.isToggled===e?(this._isPinned=e,this._defaultBehavior.followBehaviorEnabled=!e):this._pinButton.isToggled=e}_createPinButton(e){const t=new Qh("pin"+this.name,!1);return t.imageUrl=uc._ASSETS_BASE_URL+uc._PIN_ICON_FILENAME,t.parent=this,t._host=this._host,t.isToggleButton=!0,t.onToggleObservable.add((e=>{this.isPinned=e})),this._host.utilityLayer&&(t._prepareNode(this._host.utilityLayer.utilityLayerScene),t.scaling.scaleInPlace(Fh.MENU_BUTTON_SCALE),t.node&&(t.node.parent=e)),t}_createNode(e){const t=super._createNode(e);return this._pinButton=this._createPinButton(t),this.isPinned=!1,this._defaultBehavior.attach(t,[this._backPlate]),this._defaultBehavior.followBehavior.ignoreCameraPitchAndRoll=!0,this._defaultBehavior.followBehavior.pitchOffset=-15,this._defaultBehavior.followBehavior.minimumDistance=.3,this._defaultBehavior.followBehavior.defaultDistance=.4,this._defaultBehavior.followBehavior.maximumDistance=.6,this._backPlate.isNearGrabbable=!0,t.isVisible=!1,t}_finalProcessing(){super._finalProcessing(),this._pinButton.position.copyFromFloats((this._backPlate.scaling.x+Fh.MENU_BUTTON_SCALE)/2,this._backPlate.scaling.y/2,0)}constructor(e){super(e),this._isPinned=!1,this._defaultBehavior=new Zh,this._dragObserver=this._defaultBehavior.sixDofDragBehavior.onDragObservable.add((()=>{this.isPinned=!0})),this.backPlateMargin=1}dispose(){super.dispose(),this._defaultBehavior.sixDofDragBehavior.onDragObservable.remove(this._dragObserver),this._defaultBehavior.detach()}}uc._ASSETS_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",uc._PIN_ICON_FILENAME="IconPin.png";ae.l.ShadersStore.mrdlSliderBarPixelShader="uniform vec3 cameraPosition;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;uniform float _Radius_;uniform float _Bevel_Front_;uniform float _Bevel_Front_Stretch_;uniform float _Bevel_Back_;uniform float _Bevel_Back_Stretch_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform bool _Bulge_Enabled_;uniform float _Bulge_Height_;uniform float _Bulge_Radius_;uniform float _Sun_Intensity_;uniform float _Sun_Theta_;uniform float _Sun_Phi_;uniform float _Indirect_Diffuse_;uniform vec4 _Albedo_;uniform float _Specular_;uniform float _Shininess_;uniform float _Sharpness_;uniform float _Subsurface_;uniform vec4 _Left_Color_;uniform vec4 _Right_Color_;uniform float _Reflection_;uniform float _Front_Reflect_;uniform float _Edge_Reflect_;uniform float _Power_;uniform vec4 _Sky_Color_;uniform vec4 _Horizon_Color_;uniform vec4 _Ground_Color_;uniform float _Horizon_Power_;uniform sampler2D _Reflection_Map_;uniform sampler2D _Indirect_Environment_;uniform float _Width_;uniform float _Fuzz_;uniform float _Min_Fuzz_;uniform float _Clip_Fade_;uniform float _Hue_Shift_;uniform float _Saturation_Shift_;uniform float _Value_Shift_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Left_Index_Pos_;uniform vec3 _Right_Index_Pos_;uniform vec3 _Left_Index_Middle_Pos_;uniform vec3 _Right_Index_Middle_Pos_;uniform sampler2D _Decal_;uniform vec2 _Decal_Scale_XY_;uniform bool _Decal_Front_Only_;uniform float _Rim_Intensity_;uniform sampler2D _Rim_Texture_;uniform float _Rim_Hue_Shift_;uniform float _Rim_Saturation_Shift_;uniform float _Rim_Value_Shift_;uniform float _Iridescence_Intensity_;uniform sampler2D _Iridescence_Texture_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform vec4 Global_Left_Index_Middle_Position;uniform vec4 Global_Right_Index_Middle_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;void Blob_Fragment_B30(\nsampler2D Blob_Texture,\nvec4 Blob_Info1,\nvec4 Blob_Info2,\nout vec4 Blob_Color)\n{float k1=dot(Blob_Info1.xy,Blob_Info1.xy);float k2=dot(Blob_Info2.xy,Blob_Info2.xy);vec3 closer=k1<k2 ? vec3(k1,Blob_Info1.z,Blob_Info1.w) : vec3(k2,Blob_Info2.z,Blob_Info2.w);Blob_Color=closer.z*texture(Blob_Texture,vec2(vec2(sqrt(closer.x),closer.y).x,1.0-vec2(sqrt(closer.x),closer.y).y))*clamp(1.0-closer.x,0.0,1.0);}\nvoid FastLinearTosRGB_B42(\nvec4 Linear,\nout vec4 sRGB)\n{sRGB.rgb=sqrt(clamp(Linear.rgb,0.0,1.0));sRGB.a=Linear.a;}\nvoid Scale_RGB_B59(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Fragment_Main_B121(\nfloat Sun_Intensity,\nfloat Sun_Theta,\nfloat Sun_Phi,\nvec3 Normal,\nvec4 Albedo,\nfloat Fresnel_Reflect,\nfloat Shininess,\nvec3 Incident,\nvec4 Horizon_Color,\nvec4 Sky_Color,\nvec4 Ground_Color,\nfloat Indirect_Diffuse,\nfloat Specular,\nfloat Horizon_Power,\nfloat Reflection,\nvec4 Reflection_Sample,\nvec4 Indirect_Sample,\nfloat Sharpness,\nfloat SSS,\nfloat Subsurface,\nvec4 Translucence,\nvec4 Rim_Light,\nvec4 Iridescence,\nout vec4 Result)\n{float theta=Sun_Theta*2.0*3.14159;float phi=Sun_Phi*3.14159;vec3 lightDir= vec3(cos(phi)*cos(theta),sin(phi),cos(phi)*sin(theta));float NdotL=max(dot(lightDir,Normal),0.0);vec3 R=reflect(Incident,Normal);float RdotL=max(0.0,dot(R,lightDir));float specular=pow(RdotL,Shininess);specular=mix(specular,smoothstep(0.495*Sharpness,1.0-0.495*Sharpness,specular),Sharpness);vec4 gi=mix(Ground_Color,Sky_Color,Normal.y*0.5+0.5);Result=((Sun_Intensity*NdotL+Indirect_Sample*Indirect_Diffuse+Translucence)*(1.0+SSS*Subsurface))*Albedo*(1.0-Fresnel_Reflect)+(Sun_Intensity*specular*Specular+Fresnel_Reflect*Reflection*Reflection_Sample)+Fresnel_Reflect*Rim_Light+Iridescence;}\nvoid Bulge_B79(\nbool Enabled,\nvec3 Normal,\nvec3 Tangent,\nfloat Bulge_Height,\nvec4 UV,\nfloat Bulge_Radius,\nvec3 ButtonN,\nout vec3 New_Normal)\n{vec2 xy=clamp(UV.xy*2.0,vec2(-1,-1),vec2(1,1));vec3 B=(cross(Normal,Tangent));float k=-clamp(1.0-length(xy)/Bulge_Radius,0.0,1.0)*Bulge_Height;k=sin(k*3.14159*0.5);k*=smoothstep(0.9998,0.9999,abs(dot(ButtonN,Normal)));New_Normal=Normal*sqrt(1.0-k*k)+(xy.x*Tangent+xy.y*B)*k;New_Normal=Enabled ? New_Normal : Normal;}\nvoid SSS_B77(\nvec3 ButtonN,\nvec3 Normal,\nvec3 Incident,\nout float Result)\n{float NdotI=abs(dot(Normal,Incident));float BdotI=abs(dot(ButtonN,Incident));Result=(abs(NdotI-BdotI)); }\nvoid FingerOcclusion_B67(\nfloat Width,\nfloat DistToCenter,\nfloat Fuzz,\nfloat Min_Fuzz,\nvec3 Position,\nvec3 Forward,\nvec3 Nearest,\nfloat Fade_Out,\nout float NotInShadow)\n{float d=dot((Nearest-Position),Forward);float sh=smoothstep(Width*0.5,Width*0.5+Fuzz*max(d,0.0)+Min_Fuzz,DistToCenter);NotInShadow=1.0-(1.0-sh)*smoothstep(-Fade_Out,0.0,d);}\nvoid FingerOcclusion_B68(\nfloat Width,\nfloat DistToCenter,\nfloat Fuzz,\nfloat Min_Fuzz,\nvec3 Position,\nvec3 Forward,\nvec3 Nearest,\nfloat Fade_Out,\nout float NotInShadow)\n{float d=dot((Nearest-Position),Forward);float sh=smoothstep(Width*0.5,Width*0.5+Fuzz*max(d,0.0)+Min_Fuzz,DistToCenter);NotInShadow=1.0-(1.0-sh)*smoothstep(-Fade_Out,0.0,d);}\nvoid Scale_Color_B91(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=Scalar*Color;}\nvoid From_HSV_B73(\nfloat Hue,\nfloat Saturation,\nfloat Value,\nfloat Alpha,\nout vec4 Color)\n{vec4 K=vec4(1.0,2.0/3.0,1.0/3.0,3.0);vec3 p=abs(fract(vec3(Hue,Hue,Hue)+K.xyz)*6.0-K.www);Color.rgb=Value*mix(K.xxx,clamp(p-K.xxx,0.0,1.0),Saturation);Color.a=Alpha;}\nvoid Fast_Fresnel_B122(\nfloat Front_Reflect,\nfloat Edge_Reflect,\nfloat Power,\nvec3 Normal,\nvec3 Incident,\nout float Transmit,\nout float Reflect)\n{float d=max(-dot(Incident,Normal),0.0);Reflect=Front_Reflect+(Edge_Reflect-Front_Reflect)*pow(.01-d,Power);Transmit=1.0-Reflect;}\nvoid Mapped_Environment_B51(\nsampler2D Reflected_Environment,\nsampler2D Indirect_Environment,\nvec3 Dir,\nout vec4 Reflected_Color,\nout vec4 Indirect_Diffuse)\n{Reflected_Color=texture(Reflected_Environment,vec2(atan(Dir.z,Dir.x)/3.14159*0.5,asin(Dir.y)/3.14159+0.5));Indirect_Diffuse=texture(Indirect_Environment,vec2(atan(Dir.z,Dir.x)/3.14159*0.5,asin(Dir.y)/3.14159+0.5));}\nvec4 SampleEnv_Bid50(vec3 D,vec4 S,vec4 H,vec4 G,float exponent)\n{float k=pow(abs(D.y),exponent);vec4 C;if (D.y>0.0) {C=mix(H,S,k);} else {C=mix(H,G,k); }\nreturn C;}\nvoid Sky_Environment_B50(\nvec3 Normal,\nvec3 Reflected,\nvec4 Sky_Color,\nvec4 Horizon_Color,\nvec4 Ground_Color,\nfloat Horizon_Power,\nout vec4 Reflected_Color,\nout vec4 Indirect_Color)\n{Reflected_Color=SampleEnv_Bid50(Reflected,Sky_Color,Horizon_Color,Ground_Color,Horizon_Power);Indirect_Color=mix(Ground_Color,Sky_Color,Normal.y*0.5+0.5);}\nvoid Min_Segment_Distance_B65(\nvec3 P0,\nvec3 P1,\nvec3 Q0,\nvec3 Q1,\nout vec3 NearP,\nout vec3 NearQ,\nout float Distance)\n{vec3 u=P1-P0;vec3 v=Q1-Q0;vec3 w=P0-Q0;float a=dot(u,u);float b=dot(u,v);float c=dot(v,v);float d=dot(u,w);float e=dot(v,w);float D=a*c-b*b;float sD=D;float tD=D;float sc,sN,tc,tN;if (D<0.00001) {sN=0.0;sD=1.0;tN=e;tD=c;} else {sN=(b*e-c*d);tN=(a*e-b*d);if (sN<0.0) {sN=0.0;tN=e;tD=c;} else if (sN>sD) {sN=sD;tN=e+b;tD=c;}}\nif (tN<0.0) {tN=0.0;if (-d<0.0) {sN=0.0;} else if (-d>a) {sN=sD;} else {sN=-d;sD=a;}} else if (tN>tD) {tN=tD;if ((-d+b)<0.0) {sN=0.0;} else if ((-d+b)>a) {sN=sD;} else {sN=(-d+b);sD=a;}}\nsc=abs(sN)<0.000001 ? 0.0 : sN/sD;tc=abs(tN)<0.000001 ? 0.0 : tN/tD;NearP=P0+sc*u;NearQ=Q0+tc*v;Distance=distance(NearP,NearQ);}\nvoid To_XYZ_B74(\nvec3 Vec3,\nout float X,\nout float Y,\nout float Z)\n{X=Vec3.x;Y=Vec3.y;Z=Vec3.z;}\nvoid Finger_Positions_B64(\nvec3 Left_Index_Pos,\nvec3 Right_Index_Pos,\nvec3 Left_Index_Middle_Pos,\nvec3 Right_Index_Middle_Pos,\nout vec3 Left_Index,\nout vec3 Right_Index,\nout vec3 Left_Index_Middle,\nout vec3 Right_Index_Middle)\n{Left_Index= (Use_Global_Left_Index ? Global_Left_Index_Tip_Position.xyz : Left_Index_Pos);Right_Index= (Use_Global_Right_Index ? Global_Right_Index_Tip_Position.xyz : Right_Index_Pos);Left_Index_Middle= (Use_Global_Left_Index ? Global_Left_Index_Middle_Position.xyz : Left_Index_Middle_Pos);Right_Index_Middle= (Use_Global_Right_Index ? Global_Right_Index_Middle_Position.xyz : Right_Index_Middle_Pos);}\nvoid VaryHSV_B108(\nvec3 HSV_In,\nfloat Hue_Shift,\nfloat Saturation_Shift,\nfloat Value_Shift,\nout vec3 HSV_Out)\n{HSV_Out=vec3(fract(HSV_In.x+Hue_Shift),clamp(HSV_In.y+Saturation_Shift,0.0,1.0),clamp(HSV_In.z+Value_Shift,0.0,1.0));}\nvoid Remap_Range_B114(\nfloat In_Min,\nfloat In_Max,\nfloat Out_Min,\nfloat Out_Max,\nfloat In,\nout float Out)\n{Out=mix(Out_Min,Out_Max,clamp((In-In_Min)/(In_Max-In_Min),0.0,1.0));}\nvoid To_HSV_B75(\nvec4 Color,\nout float Hue,\nout float Saturation,\nout float Value,\nout float Alpha,\nout vec3 HSV)\n{vec4 K=vec4(0.0,-1.0/3.0,2.0/3.0,-1.0);vec4 p=Color.g<Color.b ? vec4(Color.bg,K.wz) : vec4(Color.gb,K.xy);vec4 q=Color.r<p.x ? vec4(p.xyw,Color.r) : vec4(Color.r,p.yzx);float d=q.x-min(q.w,q.y);float e=1.0e-10;Hue=abs(q.z+(q.w-q.y)/(6.0*d+e));Saturation=d/(q.x+e);Value=q.x;Alpha=Color.a;HSV=vec3(Hue,Saturation,Value);}\nvoid Code_B110(\nfloat X,\nout float Result)\n{Result=(acos(X)/3.14159-0.5)*2.0;}\nvoid Rim_Light_B132(\nvec3 Front,\nvec3 Normal,\nvec3 Incident,\nfloat Rim_Intensity,\nsampler2D Texture,\nout vec4 Result)\n{vec3 R=reflect(Incident,Normal);float RdotF=dot(R,Front);float RdotL=sqrt(1.0-RdotF*RdotF);vec2 UV=vec2(R.y*0.5+0.5,0.5);vec4 Color=texture(Texture,UV);Result=Color;}\nvoid main()\n{vec4 Blob_Color_Q30;\n#if BLOB_ENABLE\nBlob_Fragment_B30(_Blob_Texture_,vExtra2,vExtra3,Blob_Color_Q30);\n#else\nBlob_Color_Q30=vec4(0,0,0,0);\n#endif\nvec3 Incident_Q39=normalize(vPosition-cameraPosition);vec3 Normalized_Q38=normalize(vNormal);vec3 Normalized_Q71=normalize(vTangent);vec4 Color_Q83;\n#if DECAL_ENABLE\nColor_Q83=texture(_Decal_,vUV);\n#else\nColor_Q83=vec4(0,0,0,0);\n#endif\nfloat X_Q90;float Y_Q90;float Z_Q90;float W_Q90;X_Q90=vExtra1.x;Y_Q90=vExtra1.y;Z_Q90=vExtra1.z;W_Q90=vExtra1.w;vec4 Linear_Q43;Linear_Q43.rgb=clamp(_Sky_Color_.rgb*_Sky_Color_.rgb,0.0,1.0);Linear_Q43.a=_Sky_Color_.a;vec4 Linear_Q44;Linear_Q44.rgb=clamp(_Horizon_Color_.rgb*_Horizon_Color_.rgb,0.0,1.0);Linear_Q44.a=_Horizon_Color_.a;vec4 Linear_Q45;Linear_Q45.rgb=clamp(_Ground_Color_.rgb*_Ground_Color_.rgb,0.0,1.0);Linear_Q45.a=_Ground_Color_.a;vec3 Left_Index_Q64;vec3 Right_Index_Q64;vec3 Left_Index_Middle_Q64;vec3 Right_Index_Middle_Q64;Finger_Positions_B64(_Left_Index_Pos_,_Right_Index_Pos_,_Left_Index_Middle_Pos_,_Right_Index_Middle_Pos_,Left_Index_Q64,Right_Index_Q64,Left_Index_Middle_Q64,Right_Index_Middle_Q64);vec4 Linear_Q46;Linear_Q46.rgb=clamp(_Albedo_.rgb*_Albedo_.rgb,0.0,1.0);Linear_Q46.a=_Albedo_.a;vec3 Normalized_Q107=normalize(vBinormal);vec3 Incident_Q70=normalize(vPosition-cameraPosition);vec3 New_Normal_Q79;Bulge_B79(_Bulge_Enabled_,Normalized_Q38,Normalized_Q71,_Bulge_Height_,vColor,_Bulge_Radius_,vBinormal,New_Normal_Q79);float Result_Q77;SSS_B77(vBinormal,New_Normal_Q79,Incident_Q39,Result_Q77);vec4 Result_Q91;Scale_Color_B91(Color_Q83,X_Q90,Result_Q91);float Transmit_Q122;float Reflect_Q122;Fast_Fresnel_B122(_Front_Reflect_,_Edge_Reflect_,_Power_,New_Normal_Q79,Incident_Q39,Transmit_Q122,Reflect_Q122);float Product_Q125=Y_Q90*Y_Q90;vec3 NearP_Q65;vec3 NearQ_Q65;float Distance_Q65;Min_Segment_Distance_B65(Left_Index_Q64,Left_Index_Middle_Q64,vPosition,cameraPosition,NearP_Q65,NearQ_Q65,Distance_Q65);vec3 NearP_Q63;vec3 NearQ_Q63;float Distance_Q63;Min_Segment_Distance_B65(Right_Index_Q64,Right_Index_Middle_Q64,vPosition,cameraPosition,NearP_Q63,NearQ_Q63,Distance_Q63);vec3 Reflected_Q47=reflect(Incident_Q39,New_Normal_Q79);vec4 Product_Q103=Linear_Q46*vec4(1,1,1,1);vec4 Result_Q132;Rim_Light_B132(Normalized_Q107,Normalized_Q38,Incident_Q70,_Rim_Intensity_,_Rim_Texture_,Result_Q132);float Dot_Q72=dot(Incident_Q70, Normalized_Q71);float MaxAB_Q123=max(Reflect_Q122,Product_Q125);float NotInShadow_Q67;\n#if OCCLUSION_ENABLED\nFingerOcclusion_B67(_Width_,Distance_Q65,_Fuzz_,_Min_Fuzz_,vPosition,vBinormal,NearP_Q65,_Clip_Fade_,NotInShadow_Q67);\n#else\nNotInShadow_Q67=1.0;\n#endif\nfloat NotInShadow_Q68;\n#if OCCLUSION_ENABLED\nFingerOcclusion_B68(_Width_,Distance_Q63,_Fuzz_,_Min_Fuzz_,vPosition,vBinormal,NearP_Q63,_Clip_Fade_,NotInShadow_Q68);\n#else\nNotInShadow_Q68=1.0;\n#endif\nvec4 Reflected_Color_Q51;vec4 Indirect_Diffuse_Q51;\n#if ENV_ENABLE\nMapped_Environment_B51(_Reflection_Map_,_Indirect_Environment_,Reflected_Q47,Reflected_Color_Q51,Indirect_Diffuse_Q51);\n#else\nReflected_Color_Q51=vec4(0,0,0,1);Indirect_Diffuse_Q51=vec4(0,0,0,1);\n#endif\nvec4 Reflected_Color_Q50;vec4 Indirect_Color_Q50;\n#if SKY_ENABLED\nSky_Environment_B50(New_Normal_Q79,Reflected_Q47,Linear_Q43,Linear_Q44,Linear_Q45,_Horizon_Power_,Reflected_Color_Q50,Indirect_Color_Q50);\n#else\nReflected_Color_Q50=vec4(0,0,0,1);Indirect_Color_Q50=vec4(0,0,0,1);\n#endif\nfloat Hue_Q75;float Saturation_Q75;float Value_Q75;float Alpha_Q75;vec3 HSV_Q75;To_HSV_B75(Product_Q103,Hue_Q75,Saturation_Q75,Value_Q75,Alpha_Q75,HSV_Q75);float Hue_Q127;float Saturation_Q127;float Value_Q127;float Alpha_Q127;vec3 HSV_Q127;To_HSV_B75(Result_Q132,Hue_Q127,Saturation_Q127,Value_Q127,Alpha_Q127,HSV_Q127);float Result_Q110;Code_B110(Dot_Q72,Result_Q110);float AbsA_Q76=abs(Result_Q110);float MinAB_Q58=min(NotInShadow_Q67,NotInShadow_Q68);vec4 Sum_Q48=Reflected_Color_Q51+Reflected_Color_Q50;vec4 Sum_Q49=Indirect_Diffuse_Q51+Indirect_Color_Q50;vec3 HSV_Out_Q126;VaryHSV_B108(HSV_Q127,_Rim_Hue_Shift_,_Rim_Saturation_Shift_,_Rim_Value_Shift_,HSV_Out_Q126);float Out_Q114;Remap_Range_B114(-1.0,1.0,0.0,1.0,Result_Q110,Out_Q114);float Product_Q106;Product_Q106=AbsA_Q76*_Hue_Shift_;float X_Q128;float Y_Q128;float Z_Q128;To_XYZ_B74(HSV_Out_Q126,X_Q128,Y_Q128,Z_Q128);vec2 Vec2_Q112=vec2(Out_Q114,0.5);vec3 HSV_Out_Q108;VaryHSV_B108(HSV_Q75,Product_Q106,_Saturation_Shift_,_Value_Shift_,HSV_Out_Q108);vec4 Color_Q129;From_HSV_B73(X_Q128,Y_Q128,Z_Q128,0.0,Color_Q129);vec4 Color_Q111;\n#if IRIDESCENCE_ENABLED\nColor_Q111=texture(_Iridescence_Texture_,Vec2_Q112);\n#else\nColor_Q111=vec4(0,0,0,0);\n#endif\nfloat X_Q74;float Y_Q74;float Z_Q74;To_XYZ_B74(HSV_Out_Q108,X_Q74,Y_Q74,Z_Q74);vec4 Result_Q131=_Rim_Intensity_*Color_Q129;vec4 Result_Q113=_Iridescence_Intensity_*Color_Q111;vec4 Color_Q73;From_HSV_B73(X_Q74,Y_Q74,Z_Q74,0.0,Color_Q73);vec4 Result_Q84=Result_Q91+(1.0-Result_Q91.a)*Color_Q73;vec4 Result_Q121;Fragment_Main_B121(_Sun_Intensity_,_Sun_Theta_,_Sun_Phi_,New_Normal_Q79,Result_Q84,MaxAB_Q123,_Shininess_,Incident_Q39,_Horizon_Color_,_Sky_Color_,_Ground_Color_,_Indirect_Diffuse_,_Specular_,_Horizon_Power_,_Reflection_,Sum_Q48,Sum_Q49,_Sharpness_,Result_Q77,_Subsurface_,vec4(0,0,0,0),Result_Q131,Result_Q113,Result_Q121);vec4 Result_Q59;Scale_RGB_B59(Result_Q121,MinAB_Q58,Result_Q59);vec4 sRGB_Q42;FastLinearTosRGB_B42(Result_Q59,sRGB_Q42);vec4 Result_Q31=Blob_Color_Q30+(1.0-Blob_Color_Q30.a)*sRGB_Q42;vec4 Result_Q40=Result_Q31; Result_Q40.a=1.0;vec4 Out_Color=Result_Q40;float Clip_Threshold=0.001;bool To_sRGB=false;gl_FragColor=Out_Color;}";ae.l.ShadersStore.mrdlSliderBarVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;\n#ifdef TANGENT\nattribute vec3 tangent;\n#else\nconst vec3 tangent=vec3(0.);\n#endif\nuniform float _Radius_;uniform float _Bevel_Front_;uniform float _Bevel_Front_Stretch_;uniform float _Bevel_Back_;uniform float _Bevel_Back_Stretch_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform bool _Bulge_Enabled_;uniform float _Bulge_Height_;uniform float _Bulge_Radius_;uniform float _Sun_Intensity_;uniform float _Sun_Theta_;uniform float _Sun_Phi_;uniform float _Indirect_Diffuse_;uniform vec4 _Albedo_;uniform float _Specular_;uniform float _Shininess_;uniform float _Sharpness_;uniform float _Subsurface_;uniform vec4 _Left_Color_;uniform vec4 _Right_Color_;uniform float _Reflection_;uniform float _Front_Reflect_;uniform float _Edge_Reflect_;uniform float _Power_;uniform vec4 _Sky_Color_;uniform vec4 _Horizon_Color_;uniform vec4 _Ground_Color_;uniform float _Horizon_Power_;uniform sampler2D _Reflection_Map_;uniform sampler2D _Indirect_Environment_;uniform float _Width_;uniform float _Fuzz_;uniform float _Min_Fuzz_;uniform float _Clip_Fade_;uniform float _Hue_Shift_;uniform float _Saturation_Shift_;uniform float _Value_Shift_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Left_Index_Pos_;uniform vec3 _Right_Index_Pos_;uniform vec3 _Left_Index_Middle_Pos_;uniform vec3 _Right_Index_Middle_Pos_;uniform sampler2D _Decal_;uniform vec2 _Decal_Scale_XY_;uniform bool _Decal_Front_Only_;uniform float _Rim_Intensity_;uniform sampler2D _Rim_Texture_;uniform float _Rim_Hue_Shift_;uniform float _Rim_Saturation_Shift_;uniform float _Rim_Value_Shift_;uniform float _Iridescence_Intensity_;uniform sampler2D _Iridescence_Texture_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;void Object_To_World_Pos_B12(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid Object_To_World_Normal_B32(\nvec3 Nrm_Object,\nout vec3 Nrm_World)\n{Nrm_World=(vec4(Nrm_Object,0.0)).xyz;}\nvoid Blob_Vertex_B23(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nfloat Blob_Fade_Length,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nout vec4 Blob_Info)\n{vec3 blob= (Use_Global_Left_Index ? Global_Left_Index_Tip_Position.xyz : Blob_Position);vec3 delta=blob-Position;float dist=dot(Normal,delta);float lerpValue=clamp((abs(dist)-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);float fadeValue=1.0-clamp((abs(dist)-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float size=Blob_Near_Size+(Blob_Far_Size-Blob_Near_Size)*lerpValue;vec2 blobXY=vec2(dot(delta,Tangent),dot(delta,Bitangent))/(0.0001+size);float Fade=fadeValue*Intensity*Blob_Fade;float Distance=(lerpValue*0.5+0.5)*(1.0-Blob_Pulse);Blob_Info=vec4(blobXY.x,blobXY.y,Distance,Fade);}\nvoid Blob_Vertex_B24(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nfloat Blob_Fade_Length,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nout vec4 Blob_Info)\n{vec3 blob= (Use_Global_Right_Index ? Global_Right_Index_Tip_Position.xyz : Blob_Position);vec3 delta=blob-Position;float dist=dot(Normal,delta);float lerpValue=clamp((abs(dist)-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);float fadeValue=1.0-clamp((abs(dist)-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float size=Blob_Near_Size+(Blob_Far_Size-Blob_Near_Size)*lerpValue;vec2 blobXY=vec2(dot(delta,Tangent),dot(delta,Bitangent))/(0.0001+size);float Fade=fadeValue*Intensity*Blob_Fade;float Distance=(lerpValue*0.5+0.5)*(1.0-Blob_Pulse);Blob_Info=vec4(blobXY.x,blobXY.y,Distance,Fade);}\nvoid Move_Verts_B130(\nfloat Anisotropy,\nvec3 P,\nfloat Radius,\nfloat Bevel,\nvec3 Normal_Object,\nfloat ScaleZ,\nfloat Stretch,\nout vec3 New_P,\nout vec2 New_UV,\nout float Radial_Gradient,\nout vec3 Radial_Dir,\nout vec3 New_Normal)\n{vec2 UV=P.xy*2.0+0.5;vec2 center=clamp(UV,0.0,1.0);vec2 delta=UV-center;float deltad=(length(delta)*2.0);float f=(Bevel+(Radius-Bevel)*Stretch)/Radius;float innerd=clamp(deltad*2.0,0.0,1.0);float outerd=clamp(deltad*2.0-1.0,0.0,1.0);float bevelAngle=outerd*3.14159*0.5;float sinb=sin(bevelAngle);float cosb=cos(bevelAngle);float beveld=(1.0-f)*innerd+f*sinb;float br=outerd;vec2 r2=2.0*vec2(Radius/Anisotropy,Radius);float dir=P.z<0.0001 ? 1.0 : -1.0;New_UV=center+r2*((0.5-center)+normalize(delta+vec2(0.0,0.000001))*beveld*0.5);New_P=vec3(New_UV-0.5,P.z+dir*(1.0-cosb)*Bevel*ScaleZ);Radial_Gradient=clamp((deltad-0.5)*2.0,0.0,1.0);Radial_Dir=vec3(delta*r2,0.0);vec3 beveledNormal=cosb*Normal_Object+sinb*vec3(delta.x,delta.y,0.0);New_Normal=Normal_Object.z==0.0 ? Normal_Object : beveledNormal;}\nvoid Object_To_World_Dir_B60(\nvec3 Dir_Object,\nout vec3 Normal_World,\nout vec3 Normal_World_N,\nout float Normal_Length)\n{Normal_World=(world*vec4(Dir_Object,0.0)).xyz;Normal_Length=length(Normal_World);Normal_World_N=Normal_World/Normal_Length;}\nvoid To_XYZ_B78(\nvec3 Vec3,\nout float X,\nout float Y,\nout float Z)\n{X=Vec3.x;Y=Vec3.y;Z=Vec3.z;}\nvoid Conditional_Float_B93(\nbool Which,\nfloat If_True,\nfloat If_False,\nout float Result)\n{Result=Which ? If_True : If_False;}\nvoid Object_To_World_Dir_B28(\nvec3 Dir_Object,\nout vec3 Binormal_World,\nout vec3 Binormal_World_N,\nout float Binormal_Length)\n{Binormal_World=(world*vec4(Dir_Object,0.0)).xyz;Binormal_Length=length(Binormal_World);Binormal_World_N=Binormal_World/Binormal_Length;}\nvoid Pick_Radius_B69(\nfloat Radius,\nfloat Radius_Top_Left,\nfloat Radius_Top_Right,\nfloat Radius_Bottom_Left,\nfloat Radius_Bottom_Right,\nvec3 Position,\nout float Result)\n{bool whichY=Position.y>0.0;Result=Position.x<0.0 ? (whichY ? Radius_Top_Left : Radius_Bottom_Left) : (whichY ? Radius_Top_Right : Radius_Bottom_Right);Result*=Radius;}\nvoid Conditional_Float_B36(\nbool Which,\nfloat If_True,\nfloat If_False,\nout float Result)\n{Result=Which ? If_True : If_False;}\nvoid Greater_Than_B37(\nfloat Left,\nfloat Right,\nout bool Not_Greater_Than,\nout bool Greater_Than)\n{Greater_Than=Left>Right;Not_Greater_Than=!Greater_Than;}\nvoid Remap_Range_B105(\nfloat In_Min,\nfloat In_Max,\nfloat Out_Min,\nfloat Out_Max,\nfloat In,\nout float Out)\n{Out=mix(Out_Min,Out_Max,clamp((In-In_Min)/(In_Max-In_Min),0.0,1.0));}\nvoid main()\n{vec2 XY_Q85;XY_Q85=(uv-vec2(0.5,0.5))*_Decal_Scale_XY_+vec2(0.5,0.5);vec3 Tangent_World_Q27;vec3 Tangent_World_N_Q27;float Tangent_Length_Q27;Tangent_World_Q27=(world*vec4(vec3(1,0,0),0.0)).xyz;Tangent_Length_Q27=length(Tangent_World_Q27);Tangent_World_N_Q27=Tangent_World_Q27/Tangent_Length_Q27;vec3 Normal_World_Q60;vec3 Normal_World_N_Q60;float Normal_Length_Q60;Object_To_World_Dir_B60(vec3(0,0,1),Normal_World_Q60,Normal_World_N_Q60,Normal_Length_Q60);float X_Q78;float Y_Q78;float Z_Q78;To_XYZ_B78(position,X_Q78,Y_Q78,Z_Q78);vec3 Nrm_World_Q26;Nrm_World_Q26=normalize((world*vec4(normal,0.0)).xyz);vec3 Binormal_World_Q28;vec3 Binormal_World_N_Q28;float Binormal_Length_Q28;Object_To_World_Dir_B28(vec3(0,1,0),Binormal_World_Q28,Binormal_World_N_Q28,Binormal_Length_Q28);float Anisotropy_Q29=Tangent_Length_Q27/Binormal_Length_Q28;float Result_Q69;Pick_Radius_B69(_Radius_,_Radius_Top_Left_,_Radius_Top_Right_,_Radius_Bottom_Left_,_Radius_Bottom_Right_,position,Result_Q69);float Anisotropy_Q53=Binormal_Length_Q28/Normal_Length_Q60;bool Not_Greater_Than_Q37;bool Greater_Than_Q37;Greater_Than_B37(Z_Q78,0.0,Not_Greater_Than_Q37,Greater_Than_Q37);vec4 Linear_Q101;Linear_Q101.rgb=clamp(_Left_Color_.rgb*_Left_Color_.rgb,0.0,1.0);Linear_Q101.a=_Left_Color_.a;vec4 Linear_Q102;Linear_Q102.rgb=clamp(_Right_Color_.rgb*_Right_Color_.rgb,0.0,1.0);Linear_Q102.a=_Right_Color_.a;vec3 Difference_Q61=vec3(0,0,0)-Normal_World_N_Q60;vec4 Out_Color_Q34=vec4(X_Q78,Y_Q78,Z_Q78,1);float Result_Q36;Conditional_Float_B36(Greater_Than_Q37,_Bevel_Back_,_Bevel_Front_,Result_Q36);float Result_Q94;Conditional_Float_B36(Greater_Than_Q37,_Bevel_Back_Stretch_,_Bevel_Front_Stretch_,Result_Q94);vec3 New_P_Q130;vec2 New_UV_Q130;float Radial_Gradient_Q130;vec3 Radial_Dir_Q130;vec3 New_Normal_Q130;Move_Verts_B130(Anisotropy_Q29,position,Result_Q69,Result_Q36,normal,Anisotropy_Q53,Result_Q94,New_P_Q130,New_UV_Q130,Radial_Gradient_Q130,Radial_Dir_Q130,New_Normal_Q130);float X_Q98;float Y_Q98;X_Q98=New_UV_Q130.x;Y_Q98=New_UV_Q130.y;vec3 Pos_World_Q12;Object_To_World_Pos_B12(New_P_Q130,Pos_World_Q12);vec3 Nrm_World_Q32;Object_To_World_Normal_B32(New_Normal_Q130,Nrm_World_Q32);vec4 Blob_Info_Q23;\n#if BLOB_ENABLE\nBlob_Vertex_B23(Pos_World_Q12,Nrm_World_Q26,Tangent_World_N_Q27,Binormal_World_N_Q28,_Blob_Position_,_Blob_Intensity_,_Blob_Near_Size_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_,_Blob_Fade_,Blob_Info_Q23);\n#else\nBlob_Info_Q23=vec4(0,0,0,0);\n#endif\nvec4 Blob_Info_Q24;\n#if BLOB_ENABLE_2\nBlob_Vertex_B24(Pos_World_Q12,Nrm_World_Q26,Tangent_World_N_Q27,Binormal_World_N_Q28,_Blob_Position_2_,_Blob_Intensity_,_Blob_Near_Size_2_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_2_,_Blob_Fade_2_,Blob_Info_Q24);\n#else\nBlob_Info_Q24=vec4(0,0,0,0);\n#endif\nfloat Out_Q105;Remap_Range_B105(0.0,1.0,0.0,1.0,X_Q98,Out_Q105);float X_Q86;float Y_Q86;float Z_Q86;To_XYZ_B78(Nrm_World_Q32,X_Q86,Y_Q86,Z_Q86);vec4 Color_At_T_Q97=mix(Linear_Q101,Linear_Q102,Out_Q105);float Minus_F_Q87=-Z_Q86;float R_Q99;float G_Q99;float B_Q99;float A_Q99;R_Q99=Color_At_T_Q97.r; G_Q99=Color_At_T_Q97.g; B_Q99=Color_At_T_Q97.b; A_Q99=Color_At_T_Q97.a;float ClampF_Q88=clamp(0.0,Minus_F_Q87,1.0);float Result_Q93;Conditional_Float_B93(_Decal_Front_Only_,ClampF_Q88,1.0,Result_Q93);vec4 Vec4_Q89=vec4(Result_Q93,Radial_Gradient_Q130,G_Q99,B_Q99);vec3 Position=Pos_World_Q12;vec3 Normal=Nrm_World_Q32;vec2 UV=XY_Q85;vec3 Tangent=Tangent_World_N_Q27;vec3 Binormal=Difference_Q61;vec4 Color=Out_Color_Q34;vec4 Extra1=Vec4_Q89;vec4 Extra2=Blob_Info_Q23;vec4 Extra3=Blob_Info_Q24;gl_Position=viewProjection*vec4(Position,1);vPosition=Position;vNormal=Normal;vUV=UV;vTangent=Tangent;vBinormal=Binormal;vColor=Color;vExtra1=Extra1;vExtra2=Extra2;vExtra3=Extra3;}";class dc extends ye.M{constructor(){super(),this.SKY_ENABLED=!0,this.BLOB_ENABLE_2=!0,this.IRIDESCENCE_ENABLED=!0,this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class _c extends Ce{constructor(e,t){super(e,t),this.radius=.6,this.bevelFront=.6,this.bevelFrontStretch=.077,this.bevelBack=0,this.bevelBackStretch=0,this.radiusTopLeft=1,this.radiusTopRight=1,this.radiusBottomLeft=1,this.radiusBottomRight=1,this.bulgeEnabled=!1,this.bulgeHeight=-.323,this.bulgeRadius=.73,this.sunIntensity=1.102,this.sunTheta=.76,this.sunPhi=.526,this.indirectDiffuse=.658,this.albedo=new M.ov(.0117647,.505882,.996078,1),this.specular=0,this.shininess=10,this.sharpness=0,this.subsurface=0,this.leftGradientColor=new M.ov(.0117647,.505882,.996078,1),this.rightGradientColor=new M.ov(.0117647,.505882,.996078,1),this.reflection=.749,this.frontReflect=0,this.edgeReflect=.09,this.power=8.13,this.skyColor=new M.ov(.0117647,.964706,.996078,1),this.horizonColor=new M.ov(.0117647,.333333,.996078,1),this.groundColor=new M.ov(0,.254902,.996078,1),this.horizonPower=1,this.width=.02,this.fuzz=.5,this.minFuzz=.001,this.clipFade=.01,this.hueShift=0,this.saturationShift=0,this.valueShift=0,this.blobPosition=new I.Pq(0,0,.1),this.blobIntensity=.5,this.blobNearSize=.01,this.blobFarSize=.03,this.blobNearDistance=0,this.blobFarDistance=.08,this.blobFadeLength=.576,this.blobPulse=0,this.blobFade=1,this.blobPosition2=new I.Pq(.2,0,.1),this.blobNearSize2=.01,this.blobPulse2=0,this.blobFade2=1,this.blobTexture=new G.g("",this.getScene()),this.leftIndexPosition=new I.Pq(0,0,1),this.rightIndexPosition=new I.Pq(-1,-1,-1),this.leftIndexMiddlePosition=new I.Pq(0,0,0),this.rightIndexMiddlePosition=new I.Pq(0,0,0),this.decalScaleXY=new I.I9(1.5,1.5),this.decalFrontOnly=!0,this.rimIntensity=.287,this.rimHueShift=0,this.rimSaturationShift=0,this.rimValueShift=-1,this.iridescenceIntensity=0,this.useGlobalLeftIndex=1,this.useGlobalRightIndex=1,this.globalLeftIndexTipProximity=0,this.globalRightIndexTipProximity=0,this.globalLeftIndexTipPosition=new I.IU(.5,0,-.55,1),this.globaRightIndexTipPosition=new I.IU(0,0,0,1),this.globalLeftThumbTipPosition=new I.IU(.5,0,-.55,1),this.globalRightThumbTipPosition=new I.IU(0,0,0,1),this.globalLeftIndexMiddlePosition=new I.IU(.5,0,-.55,1),this.globalRightIndexMiddlePosition=new I.IU(0,0,0,1),this.alphaMode=Pa.Y.ALPHA_DISABLE,this.backFaceCulling=!1,this._blueGradientTexture=new G.g(_c.BLUE_GRADIENT_TEXTURE_URL,this.getScene(),!0,!1,G.g.NEAREST_SAMPLINGMODE),this._decalTexture=new G.g("",this.getScene()),this._reflectionMapTexture=new G.g("",this.getScene()),this._indirectEnvTexture=new G.g("",this.getScene())}needAlphaBlending(){return!1}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){const i=t._drawWrapper;if(this.isFrozen&&i.effect&&i._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new dc);const s=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if((0,$.qB)(e,s,!1,!1),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial();const e=new K;s.FOG&&e.addFallback(1,"FOG"),(0,$.c4)(s,e),s.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess;const i=[O.R.PositionKind];s.NORMAL&&i.push(O.R.NormalKind),s.UV1&&i.push(O.R.UVKind),s.UV2&&i.push(O.R.UV2Kind),s.VERTEXCOLOR&&i.push(O.R.ColorKind),s.TANGENT&&i.push(O.R.TangentKind),(0,$.ER)(i,s);const a="mrdlSliderBar",o=s.toString(),l=["world","viewProjection","cameraPosition","_Radius_","_Bevel_Front_","_Bevel_Front_Stretch_","_Bevel_Back_","_Bevel_Back_Stretch_","_Radius_Top_Left_","_Radius_Top_Right_","_Radius_Bottom_Left_","_Radius_Bottom_Right_","_Bulge_Enabled_","_Bulge_Height_","_Bulge_Radius_","_Sun_Intensity_","_Sun_Theta_","_Sun_Phi_","_Indirect_Diffuse_","_Albedo_","_Specular_","_Shininess_","_Sharpness_","_Subsurface_","_Left_Color_","_Right_Color_","_Reflection_","_Front_Reflect_","_Edge_Reflect_","_Power_","_Sky_Color_","_Horizon_Color_","_Ground_Color_","_Horizon_Power_","_Reflection_Map_","_Indirect_Environment_","_Width_","_Fuzz_","_Min_Fuzz_","_Clip_Fade_","_Hue_Shift_","_Saturation_Shift_","_Value_Shift_","_Blob_Position_","_Blob_Intensity_","_Blob_Near_Size_","_Blob_Far_Size_","_Blob_Near_Distance_","_Blob_Far_Distance_","_Blob_Fade_Length_","_Blob_Pulse_","_Blob_Fade_","_Blob_Texture_","_Blob_Position_2_","_Blob_Near_Size_2_","_Blob_Pulse_2_","_Blob_Fade_2_","_Left_Index_Pos_","_Right_Index_Pos_","_Left_Index_Middle_Pos_","_Right_Index_Middle_Pos_","_Decal_","_Decal_Scale_XY_","_Decal_Front_Only_","_Rim_Intensity_","_Rim_Texture_","_Rim_Hue_Shift_","_Rim_Saturation_Shift_","_Rim_Value_Shift_","_Iridescence_Intensity_","_Iridescence_Texture_","Use_Global_Left_Index","Use_Global_Right_Index","Global_Left_Index_Tip_Position","Global_Right_Index_Tip_Position","Global_Left_Thumb_Tip_Position","Global_Right_Thumb_Tip_Position","Global_Left_Index_Middle_Position;","Global_Right_Index_Middle_Position","Global_Left_Index_Tip_Proximity","Global_Right_Index_Tip_Proximity"],h=["_Rim_Texture_","_Iridescence_Texture_"],c=[];(0,$.Bb)({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:s,maxSimultaneousLights:4}),t.setEffect(r.getEngine().createEffect(a,{attributes:i,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:o,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),s,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(s._renderId=r.getRenderId(),i._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){if(!i.materialDefines)return;const s=i.effect;s&&(this._activeEffect=s,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",this.getScene().activeCamera.position),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Bevel_Front_",this.bevelFront),this._activeEffect.setFloat("_Bevel_Front_Stretch_",this.bevelFrontStretch),this._activeEffect.setFloat("_Bevel_Back_",this.bevelBack),this._activeEffect.setFloat("_Bevel_Back_Stretch_",this.bevelBackStretch),this._activeEffect.setFloat("_Radius_Top_Left_",this.radiusTopLeft),this._activeEffect.setFloat("_Radius_Top_Right_",this.radiusTopRight),this._activeEffect.setFloat("_Radius_Bottom_Left_",this.radiusBottomLeft),this._activeEffect.setFloat("_Radius_Bottom_Right_",this.radiusBottomRight),this._activeEffect.setFloat("_Bulge_Enabled_",this.bulgeEnabled?1:0),this._activeEffect.setFloat("_Bulge_Height_",this.bulgeHeight),this._activeEffect.setFloat("_Bulge_Radius_",this.bulgeRadius),this._activeEffect.setFloat("_Sun_Intensity_",this.sunIntensity),this._activeEffect.setFloat("_Sun_Theta_",this.sunTheta),this._activeEffect.setFloat("_Sun_Phi_",this.sunPhi),this._activeEffect.setFloat("_Indirect_Diffuse_",this.indirectDiffuse),this._activeEffect.setDirectColor4("_Albedo_",this.albedo),this._activeEffect.setFloat("_Specular_",this.specular),this._activeEffect.setFloat("_Shininess_",this.shininess),this._activeEffect.setFloat("_Sharpness_",this.sharpness),this._activeEffect.setFloat("_Subsurface_",this.subsurface),this._activeEffect.setDirectColor4("_Left_Color_",this.leftGradientColor),this._activeEffect.setDirectColor4("_Right_Color_",this.rightGradientColor),this._activeEffect.setFloat("_Reflection_",this.reflection),this._activeEffect.setFloat("_Front_Reflect_",this.frontReflect),this._activeEffect.setFloat("_Edge_Reflect_",this.edgeReflect),this._activeEffect.setFloat("_Power_",this.power),this._activeEffect.setDirectColor4("_Sky_Color_",this.skyColor),this._activeEffect.setDirectColor4("_Horizon_Color_",this.horizonColor),this._activeEffect.setDirectColor4("_Ground_Color_",this.groundColor),this._activeEffect.setFloat("_Horizon_Power_",this.horizonPower),this._activeEffect.setTexture("_Reflection_Map_",this._reflectionMapTexture),this._activeEffect.setTexture("_Indirect_Environment_",this._indirectEnvTexture),this._activeEffect.setFloat("_Width_",this.width),this._activeEffect.setFloat("_Fuzz_",this.fuzz),this._activeEffect.setFloat("_Min_Fuzz_",this.minFuzz),this._activeEffect.setFloat("_Clip_Fade_",this.clipFade),this._activeEffect.setFloat("_Hue_Shift_",this.hueShift),this._activeEffect.setFloat("_Saturation_Shift_",this.saturationShift),this._activeEffect.setFloat("_Value_Shift_",this.valueShift),this._activeEffect.setVector3("_Blob_Position_",this.blobPosition),this._activeEffect.setFloat("_Blob_Intensity_",this.blobIntensity),this._activeEffect.setFloat("_Blob_Near_Size_",this.blobNearSize),this._activeEffect.setFloat("_Blob_Far_Size_",this.blobFarSize),this._activeEffect.setFloat("_Blob_Near_Distance_",this.blobNearDistance),this._activeEffect.setFloat("_Blob_Far_Distance_",this.blobFarDistance),this._activeEffect.setFloat("_Blob_Fade_Length_",this.blobFadeLength),this._activeEffect.setFloat("_Blob_Pulse_",this.blobPulse),this._activeEffect.setFloat("_Blob_Fade_",this.blobFade),this._activeEffect.setTexture("_Blob_Texture_",this.blobTexture),this._activeEffect.setVector3("_Blob_Position_2_",this.blobPosition2),this._activeEffect.setFloat("_Blob_Near_Size_2_",this.blobNearSize2),this._activeEffect.setFloat("_Blob_Pulse_2_",this.blobPulse2),this._activeEffect.setFloat("_Blob_Fade_2_",this.blobFade2),this._activeEffect.setVector3("_Left_Index_Pos_",this.leftIndexPosition),this._activeEffect.setVector3("_Right_Index_Pos_",this.rightIndexPosition),this._activeEffect.setVector3("_Left_Index_Middle_Pos_",this.leftIndexMiddlePosition),this._activeEffect.setVector3("_Right_Index_Middle_Pos_",this.rightIndexMiddlePosition),this._activeEffect.setTexture("_Decal_",this._decalTexture),this._activeEffect.setVector2("_Decal_Scale_XY_",this.decalScaleXY),this._activeEffect.setFloat("_Decal_Front_Only_",this.decalFrontOnly?1:0),this._activeEffect.setFloat("_Rim_Intensity_",this.rimIntensity),this._activeEffect.setTexture("_Rim_Texture_",this._blueGradientTexture),this._activeEffect.setFloat("_Rim_Hue_Shift_",this.rimHueShift),this._activeEffect.setFloat("_Rim_Saturation_Shift_",this.rimSaturationShift),this._activeEffect.setFloat("_Rim_Value_Shift_",this.rimValueShift),this._activeEffect.setFloat("_Iridescence_Intensity_",this.iridescenceIntensity),this._activeEffect.setTexture("_Iridescence_Texture_",this._blueGradientTexture),this._activeEffect.setFloat("Use_Global_Left_Index",this.useGlobalLeftIndex),this._activeEffect.setFloat("Use_Global_Right_Index",this.useGlobalRightIndex),this._activeEffect.setVector4("Global_Left_Index_Tip_Position",this.globalLeftIndexTipPosition),this._activeEffect.setVector4("Global_Right_Index_Tip_Position",this.globaRightIndexTipPosition),this._activeEffect.setVector4("Global_Left_Thumb_Tip_Position",this.globalLeftThumbTipPosition),this._activeEffect.setVector4("Global_Right_Thumb_Tip_Position",this.globalRightThumbTipPosition),this._activeEffect.setVector4("Global_Left_Index_Middle_Position",this.globalLeftIndexMiddlePosition),this._activeEffect.setVector4("Global_Right_Index_Middle_Position",this.globalRightIndexMiddlePosition),this._activeEffect.setFloat("Global_Left_Index_Tip_Proximity",this.globalLeftIndexTipProximity),this._activeEffect.setFloat("Global_Right_Index_Tip_Proximity",this.globalRightIndexTipProximity),this._afterBind(t,this._activeEffect,i))}getAnimatables(){return[]}dispose(e){super.dispose(e),this._reflectionMapTexture.dispose(),this._indirectEnvTexture.dispose(),this._blueGradientTexture.dispose(),this._decalTexture.dispose()}clone(e){return N.p.Clone((()=>new _c(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.MRDLSliderBarMaterial",e}getClassName(){return"MRDLSliderBarMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new _c(e.name,t)),e,t,i)}}_c.BLUE_GRADIENT_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/MRDL/mrtk-mrdl-blue-gradient.png",(0,w.Cg)([(0,D.lK)()],_c.prototype,"radius",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"bevelFront",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"bevelFrontStretch",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"bevelBack",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"bevelBackStretch",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"radiusTopLeft",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"radiusTopRight",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"radiusBottomLeft",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"radiusBottomRight",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"bulgeEnabled",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"bulgeHeight",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"bulgeRadius",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"sunIntensity",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"sunTheta",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"sunPhi",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"indirectDiffuse",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"albedo",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"specular",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"shininess",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"sharpness",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"subsurface",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"leftGradientColor",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"rightGradientColor",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"reflection",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"frontReflect",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"edgeReflect",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"power",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"skyColor",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"horizonColor",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"groundColor",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"horizonPower",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"width",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"fuzz",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"minFuzz",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"clipFade",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"hueShift",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"saturationShift",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"valueShift",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobPosition",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobIntensity",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobNearSize",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobFarSize",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobNearDistance",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobFarDistance",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobFadeLength",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobPulse",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobFade",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobPosition2",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobNearSize2",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobPulse2",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobFade2",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"blobTexture",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"leftIndexPosition",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"rightIndexPosition",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"leftIndexMiddlePosition",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"rightIndexMiddlePosition",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"decalScaleXY",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"decalFrontOnly",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"rimIntensity",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"rimHueShift",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"rimSaturationShift",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"rimValueShift",void 0),(0,w.Cg)([(0,D.lK)()],_c.prototype,"iridescenceIntensity",void 0),(0,V.Y5)("BABYLON.GUI.MRDLSliderBarMaterial",_c);ae.l.ShadersStore.mrdlSliderThumbPixelShader="uniform vec3 cameraPosition;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;uniform float _Radius_;uniform float _Bevel_Front_;uniform float _Bevel_Front_Stretch_;uniform float _Bevel_Back_;uniform float _Bevel_Back_Stretch_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform bool _Bulge_Enabled_;uniform float _Bulge_Height_;uniform float _Bulge_Radius_;uniform float _Sun_Intensity_;uniform float _Sun_Theta_;uniform float _Sun_Phi_;uniform float _Indirect_Diffuse_;uniform vec4 _Albedo_;uniform float _Specular_;uniform float _Shininess_;uniform float _Sharpness_;uniform float _Subsurface_;uniform vec4 _Left_Color_;uniform vec4 _Right_Color_;uniform float _Reflection_;uniform float _Front_Reflect_;uniform float _Edge_Reflect_;uniform float _Power_;uniform vec4 _Sky_Color_;uniform vec4 _Horizon_Color_;uniform vec4 _Ground_Color_;uniform float _Horizon_Power_;uniform sampler2D _Reflection_Map_;uniform sampler2D _Indirect_Environment_;uniform float _Width_;uniform float _Fuzz_;uniform float _Min_Fuzz_;uniform float _Clip_Fade_;uniform float _Hue_Shift_;uniform float _Saturation_Shift_;uniform float _Value_Shift_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Left_Index_Pos_;uniform vec3 _Right_Index_Pos_;uniform vec3 _Left_Index_Middle_Pos_;uniform vec3 _Right_Index_Middle_Pos_;uniform sampler2D _Decal_;uniform vec2 _Decal_Scale_XY_;uniform bool _Decal_Front_Only_;uniform float _Rim_Intensity_;uniform sampler2D _Rim_Texture_;uniform float _Rim_Hue_Shift_;uniform float _Rim_Saturation_Shift_;uniform float _Rim_Value_Shift_;uniform float _Iridescence_Intensity_;uniform sampler2D _Iridescence_Texture_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform vec4 Global_Left_Index_Middle_Position;uniform vec4 Global_Right_Index_Middle_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;void Blob_Fragment_B180(\nsampler2D Blob_Texture,\nvec4 Blob_Info1,\nvec4 Blob_Info2,\nout vec4 Blob_Color)\n{float k1=dot(Blob_Info1.xy,Blob_Info1.xy);float k2=dot(Blob_Info2.xy,Blob_Info2.xy);vec3 closer=k1<k2 ? vec3(k1,Blob_Info1.z,Blob_Info1.w) : vec3(k2,Blob_Info2.z,Blob_Info2.w);Blob_Color=closer.z*texture(Blob_Texture,vec2(vec2(sqrt(closer.x),closer.y).x,1.0-vec2(sqrt(closer.x),closer.y).y))*clamp(1.0-closer.x,0.0,1.0);}\nvoid FastLinearTosRGB_B192(\nvec4 Linear,\nout vec4 sRGB)\n{sRGB.rgb=sqrt(clamp(Linear.rgb,0.0,1.0));sRGB.a=Linear.a;}\nvoid Scale_RGB_B209(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Fragment_Main_B271(\nfloat Sun_Intensity,\nfloat Sun_Theta,\nfloat Sun_Phi,\nvec3 Normal,\nvec4 Albedo,\nfloat Fresnel_Reflect,\nfloat Shininess,\nvec3 Incident,\nvec4 Horizon_Color,\nvec4 Sky_Color,\nvec4 Ground_Color,\nfloat Indirect_Diffuse,\nfloat Specular,\nfloat Horizon_Power,\nfloat Reflection,\nvec4 Reflection_Sample,\nvec4 Indirect_Sample,\nfloat Sharpness,\nfloat SSS,\nfloat Subsurface,\nvec4 Translucence,\nvec4 Rim_Light,\nvec4 Iridescence,\nout vec4 Result)\n{float theta=Sun_Theta*2.0*3.14159;float phi=Sun_Phi*3.14159;vec3 lightDir= vec3(cos(phi)*cos(theta),sin(phi),cos(phi)*sin(theta));float NdotL=max(dot(lightDir,Normal),0.0);vec3 R=reflect(Incident,Normal);float RdotL=max(0.0,dot(R,lightDir));float specular=pow(RdotL,Shininess);specular=mix(specular,smoothstep(0.495*Sharpness,1.0-0.495*Sharpness,specular),Sharpness);vec4 gi=mix(Ground_Color,Sky_Color,Normal.y*0.5+0.5);Result=((Sun_Intensity*NdotL+Indirect_Sample*Indirect_Diffuse+Translucence)*(1.0+SSS*Subsurface))*Albedo*(1.0-Fresnel_Reflect)+(Sun_Intensity*specular*Specular+Fresnel_Reflect*Reflection*Reflection_Sample)+Fresnel_Reflect*Rim_Light+Iridescence;}\nvoid Bulge_B229(\nbool Enabled,\nvec3 Normal,\nvec3 Tangent,\nfloat Bulge_Height,\nvec4 UV,\nfloat Bulge_Radius,\nvec3 ButtonN,\nout vec3 New_Normal)\n{vec2 xy=clamp(UV.xy*2.0,vec2(-1,-1),vec2(1,1));vec3 B=(cross(Normal,Tangent));float k=-clamp(1.0-length(xy)/Bulge_Radius,0.0,1.0)*Bulge_Height;k=sin(k*3.14159*0.5);k*=smoothstep(0.9998,0.9999,abs(dot(ButtonN,Normal)));New_Normal=Normal*sqrt(1.0-k*k)+(xy.x*Tangent+xy.y*B)*k;New_Normal=Enabled ? New_Normal : Normal;}\nvoid SSS_B227(\nvec3 ButtonN,\nvec3 Normal,\nvec3 Incident,\nout float Result)\n{float NdotI=abs(dot(Normal,Incident));float BdotI=abs(dot(ButtonN,Incident));Result=(abs(NdotI-BdotI)); }\nvoid FingerOcclusion_B217(\nfloat Width,\nfloat DistToCenter,\nfloat Fuzz,\nfloat Min_Fuzz,\nvec3 Position,\nvec3 Forward,\nvec3 Nearest,\nfloat Fade_Out,\nout float NotInShadow)\n{float d=dot((Nearest-Position),Forward);float sh=smoothstep(Width*0.5,Width*0.5+Fuzz*max(d,0.0)+Min_Fuzz,DistToCenter);NotInShadow=1.0-(1.0-sh)*smoothstep(-Fade_Out,0.0,d);}\nvoid FingerOcclusion_B218(\nfloat Width,\nfloat DistToCenter,\nfloat Fuzz,\nfloat Min_Fuzz,\nvec3 Position,\nvec3 Forward,\nvec3 Nearest,\nfloat Fade_Out,\nout float NotInShadow)\n{float d=dot((Nearest-Position),Forward);float sh=smoothstep(Width*0.5,Width*0.5+Fuzz*max(d,0.0)+Min_Fuzz,DistToCenter);NotInShadow=1.0-(1.0-sh)*smoothstep(-Fade_Out,0.0,d);}\nvoid Scale_Color_B241(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=Scalar*Color;}\nvoid From_HSV_B223(\nfloat Hue,\nfloat Saturation,\nfloat Value,\nfloat Alpha,\nout vec4 Color)\n{vec4 K=vec4(1.0,2.0/3.0,1.0/3.0,3.0);vec3 p=abs(fract(vec3(Hue,Hue,Hue)+K.xyz)*6.0-K.www);Color.rgb=Value*mix(K.xxx,clamp(p-K.xxx,0.0,1.0),Saturation);Color.a=Alpha;}\nvoid Fast_Fresnel_B272(\nfloat Front_Reflect,\nfloat Edge_Reflect,\nfloat Power,\nvec3 Normal,\nvec3 Incident,\nout float Transmit,\nout float Reflect)\n{float d=max(-dot(Incident,Normal),0.0);Reflect=Front_Reflect+(Edge_Reflect-Front_Reflect)*pow(1.0-d,Power);Transmit=1.0-Reflect;}\nvoid Mapped_Environment_B201(\nsampler2D Reflected_Environment,\nsampler2D Indirect_Environment,\nvec3 Dir,\nout vec4 Reflected_Color,\nout vec4 Indirect_Diffuse)\n{Reflected_Color=texture(Reflected_Environment,vec2(atan(Dir.z,Dir.x)/3.14159*0.5,asin(Dir.y)/3.14159+0.5));Indirect_Diffuse=texture(Indirect_Environment,vec2(atan(Dir.z,Dir.x)/3.14159*0.5,asin(Dir.y)/3.14159+0.5));}\nvec4 SampleEnv_Bid200(vec3 D,vec4 S,vec4 H,vec4 G,float exponent)\n{float k=pow(abs(D.y),exponent);vec4 C;if (D.y>0.0) {C=mix(H,S,k);} else {C=mix(H,G,k); }\nreturn C;}\nvoid Sky_Environment_B200(\nvec3 Normal,\nvec3 Reflected,\nvec4 Sky_Color,\nvec4 Horizon_Color,\nvec4 Ground_Color,\nfloat Horizon_Power,\nout vec4 Reflected_Color,\nout vec4 Indirect_Color)\n{Reflected_Color=SampleEnv_Bid200(Reflected,Sky_Color,Horizon_Color,Ground_Color,Horizon_Power);Indirect_Color=mix(Ground_Color,Sky_Color,Normal.y*0.5+0.5);}\nvoid Min_Segment_Distance_B215(\nvec3 P0,\nvec3 P1,\nvec3 Q0,\nvec3 Q1,\nout vec3 NearP,\nout vec3 NearQ,\nout float Distance)\n{vec3 u=P1-P0;vec3 v=Q1-Q0;vec3 w=P0-Q0;float a=dot(u,u);float b=dot(u,v);float c=dot(v,v);float d=dot(u,w);float e=dot(v,w);float D=a*c-b*b;float sD=D;float tD=D;float sc,sN,tc,tN;if (D<0.00001) {sN=0.0;sD=1.0;tN=e;tD=c;} else {sN=(b*e-c*d);tN=(a*e-b*d);if (sN<0.0) {sN=0.0;tN=e;tD=c;} else if (sN>sD) {sN=sD;tN=e+b;tD=c;}}\nif (tN<0.0) {tN=0.0;if (-d<0.0) {sN=0.0;} else if (-d>a) {sN=sD;} else {sN=-d;sD=a;}} else if (tN>tD) {tN=tD;if ((-d+b)<0.0) {sN=0.0;} else if ((-d+b)>a) {sN=sD;} else {sN=(-d+b);sD=a;}}\nsc=abs(sN)<0.000001 ? 0.0 : sN/sD;tc=abs(tN)<0.000001 ? 0.0 : tN/tD;NearP=P0+sc*u;NearQ=Q0+tc*v;Distance=distance(NearP,NearQ);}\nvoid To_XYZ_B224(\nvec3 Vec3,\nout float X,\nout float Y,\nout float Z)\n{X=Vec3.x;Y=Vec3.y;Z=Vec3.z;}\nvoid Finger_Positions_B214(\nvec3 Left_Index_Pos,\nvec3 Right_Index_Pos,\nvec3 Left_Index_Middle_Pos,\nvec3 Right_Index_Middle_Pos,\nout vec3 Left_Index,\nout vec3 Right_Index,\nout vec3 Left_Index_Middle,\nout vec3 Right_Index_Middle)\n{Left_Index= (Use_Global_Left_Index ? Global_Left_Index_Tip_Position.xyz : Left_Index_Pos);Right_Index= (Use_Global_Right_Index ? Global_Right_Index_Tip_Position.xyz : Right_Index_Pos);Left_Index_Middle= (Use_Global_Left_Index ? Global_Left_Index_Middle_Position.xyz : Left_Index_Middle_Pos);Right_Index_Middle= (Use_Global_Right_Index ? Global_Right_Index_Middle_Position.xyz : Right_Index_Middle_Pos);}\nvoid VaryHSV_B258(\nvec3 HSV_In,\nfloat Hue_Shift,\nfloat Saturation_Shift,\nfloat Value_Shift,\nout vec3 HSV_Out)\n{HSV_Out=vec3(fract(HSV_In.x+Hue_Shift),clamp(HSV_In.y+Saturation_Shift,0.0,1.0),clamp(HSV_In.z+Value_Shift,0.0,1.0));}\nvoid Remap_Range_B264(\nfloat In_Min,\nfloat In_Max,\nfloat Out_Min,\nfloat Out_Max,\nfloat In,\nout float Out)\n{Out=mix(Out_Min,Out_Max,clamp((In-In_Min)/(In_Max-In_Min),0.0,1.0));}\nvoid To_HSV_B225(\nvec4 Color,\nout float Hue,\nout float Saturation,\nout float Value,\nout float Alpha,\nout vec3 HSV)\n{vec4 K=vec4(0.0,-1.0/3.0,2.0/3.0,-1.0);vec4 p=Color.g<Color.b ? vec4(Color.bg,K.wz) : vec4(Color.gb,K.xy);vec4 q=Color.r<p.x ? vec4(p.xyw,Color.r) : vec4(Color.r,p.yzx);float d=q.x-min(q.w,q.y);float e=1.0e-10;Hue=abs(q.z+(q.w-q.y)/(6.0*d+e));Saturation=d/(q.x+e);Value=q.x;Alpha=Color.a;HSV=vec3(Hue,Saturation,Value);}\nvoid Code_B260(\nfloat X,\nout float Result)\n{Result=(acos(X)/3.14159-0.5)*2.0;}\nvoid Rim_Light_B282(\nvec3 Front,\nvec3 Normal,\nvec3 Incident,\nfloat Rim_Intensity,\nsampler2D Texture,\nout vec4 Result)\n{vec3 R=reflect(Incident,Normal);float RdotF=dot(R,Front);float RdotL=sqrt(1.0-RdotF*RdotF);vec2 UV=vec2(R.y*0.5+0.5,0.5);vec4 Color=texture(Texture,UV);Result=Color;}\nvoid main()\n{vec4 Blob_Color_Q180;\n#if BLOB_ENABLE\nBlob_Fragment_B180(_Blob_Texture_,vExtra2,vExtra3,Blob_Color_Q180);\n#else\nBlob_Color_Q180=vec4(0,0,0,0);\n#endif\nvec3 Incident_Q189=normalize(vPosition-cameraPosition);vec3 Normalized_Q188=normalize(vNormal);vec3 Normalized_Q221=normalize(vTangent);vec4 Color_Q233;\n#if DECAL_ENABLE\nColor_Q233=texture(_Decal_,vUV);\n#else\nColor_Q233=vec4(0,0,0,0);\n#endif\nfloat X_Q240;float Y_Q240;float Z_Q240;float W_Q240;X_Q240=vExtra1.x;Y_Q240=vExtra1.y;Z_Q240=vExtra1.z;W_Q240=vExtra1.w;vec4 Linear_Q193;Linear_Q193.rgb=clamp(_Sky_Color_.rgb*_Sky_Color_.rgb,0.0,1.0);Linear_Q193.a=_Sky_Color_.a;vec4 Linear_Q194;Linear_Q194.rgb=clamp(_Horizon_Color_.rgb*_Horizon_Color_.rgb,0.0,1.0);Linear_Q194.a=_Horizon_Color_.a;vec4 Linear_Q195;Linear_Q195.rgb=clamp(_Ground_Color_.rgb*_Ground_Color_.rgb,0.0,1.0);Linear_Q195.a=_Ground_Color_.a;vec3 Left_Index_Q214;vec3 Right_Index_Q214;vec3 Left_Index_Middle_Q214;vec3 Right_Index_Middle_Q214;Finger_Positions_B214(_Left_Index_Pos_,_Right_Index_Pos_,_Left_Index_Middle_Pos_,_Right_Index_Middle_Pos_,Left_Index_Q214,Right_Index_Q214,Left_Index_Middle_Q214,Right_Index_Middle_Q214);vec4 Linear_Q196;Linear_Q196.rgb=clamp(_Albedo_.rgb*_Albedo_.rgb,0.0,1.0);Linear_Q196.a=_Albedo_.a;vec3 Normalized_Q257=normalize(vBinormal);vec3 Incident_Q220=normalize(vPosition-cameraPosition);vec3 New_Normal_Q229;Bulge_B229(_Bulge_Enabled_,Normalized_Q188,Normalized_Q221,_Bulge_Height_,vColor,_Bulge_Radius_,vBinormal,New_Normal_Q229);float Result_Q227;SSS_B227(vBinormal,New_Normal_Q229,Incident_Q189,Result_Q227);vec4 Result_Q241;Scale_Color_B241(Color_Q233,X_Q240,Result_Q241);float Transmit_Q272;float Reflect_Q272;Fast_Fresnel_B272(_Front_Reflect_,_Edge_Reflect_,_Power_,New_Normal_Q229,Incident_Q189,Transmit_Q272,Reflect_Q272);float Product_Q275=Y_Q240*Y_Q240;vec3 NearP_Q215;vec3 NearQ_Q215;float Distance_Q215;Min_Segment_Distance_B215(Left_Index_Q214,Left_Index_Middle_Q214,vPosition,cameraPosition,NearP_Q215,NearQ_Q215,Distance_Q215);vec3 NearP_Q213;vec3 NearQ_Q213;float Distance_Q213;Min_Segment_Distance_B215(Right_Index_Q214,Right_Index_Middle_Q214,vPosition,cameraPosition,NearP_Q213,NearQ_Q213,Distance_Q213);vec3 Reflected_Q197=reflect(Incident_Q189,New_Normal_Q229);vec4 Product_Q253=Linear_Q196*vec4(1,1,1,1);vec4 Result_Q282;Rim_Light_B282(Normalized_Q257,Normalized_Q188,Incident_Q220,_Rim_Intensity_,_Rim_Texture_,Result_Q282);float Dot_Q222=dot(Incident_Q220, Normalized_Q221);float MaxAB_Q273=max(Reflect_Q272,Product_Q275);float NotInShadow_Q217;\n#if OCCLUSION_ENABLED\nFingerOcclusion_B217(_Width_,Distance_Q215,_Fuzz_,_Min_Fuzz_,vPosition,vBinormal,NearP_Q215,_Clip_Fade_,NotInShadow_Q217);\n#else\nNotInShadow_Q217=1.0;\n#endif\nfloat NotInShadow_Q218;\n#if OCCLUSION_ENABLED\nFingerOcclusion_B218(_Width_,Distance_Q213,_Fuzz_,_Min_Fuzz_,vPosition,vBinormal,NearP_Q213,_Clip_Fade_,NotInShadow_Q218);\n#else\nNotInShadow_Q218=1.0;\n#endif\nvec4 Reflected_Color_Q201;vec4 Indirect_Diffuse_Q201;\n#if ENV_ENABLE\nMapped_Environment_B201(_Reflection_Map_,_Indirect_Environment_,Reflected_Q197,Reflected_Color_Q201,Indirect_Diffuse_Q201);\n#else\nReflected_Color_Q201=vec4(0,0,0,1);Indirect_Diffuse_Q201=vec4(0,0,0,1);\n#endif\nvec4 Reflected_Color_Q200;vec4 Indirect_Color_Q200;\n#if SKY_ENABLED\nSky_Environment_B200(New_Normal_Q229,Reflected_Q197,Linear_Q193,Linear_Q194,Linear_Q195,_Horizon_Power_,Reflected_Color_Q200,Indirect_Color_Q200);\n#else\nReflected_Color_Q200=vec4(0,0,0,1);Indirect_Color_Q200=vec4(0,0,0,1);\n#endif\nfloat Hue_Q225;float Saturation_Q225;float Value_Q225;float Alpha_Q225;vec3 HSV_Q225;To_HSV_B225(Product_Q253,Hue_Q225,Saturation_Q225,Value_Q225,Alpha_Q225,HSV_Q225);float Hue_Q277;float Saturation_Q277;float Value_Q277;float Alpha_Q277;vec3 HSV_Q277;To_HSV_B225(Result_Q282,Hue_Q277,Saturation_Q277,Value_Q277,Alpha_Q277,HSV_Q277);float Result_Q260;Code_B260(Dot_Q222,Result_Q260);float AbsA_Q226=abs(Result_Q260);float MinAB_Q208=min(NotInShadow_Q217,NotInShadow_Q218);vec4 Sum_Q198=Reflected_Color_Q201+Reflected_Color_Q200;vec4 Sum_Q199=Indirect_Diffuse_Q201+Indirect_Color_Q200;vec3 HSV_Out_Q276;VaryHSV_B258(HSV_Q277,_Rim_Hue_Shift_,_Rim_Saturation_Shift_,_Rim_Value_Shift_,HSV_Out_Q276);float Out_Q264;Remap_Range_B264(-1.0,1.0,0.0,1.0,Result_Q260,Out_Q264);float Product_Q256;Product_Q256=AbsA_Q226*_Hue_Shift_;float X_Q278;float Y_Q278;float Z_Q278;To_XYZ_B224(HSV_Out_Q276,X_Q278,Y_Q278,Z_Q278);vec2 Vec2_Q262=vec2(Out_Q264,0.5);vec3 HSV_Out_Q258;VaryHSV_B258(HSV_Q225,Product_Q256,_Saturation_Shift_,_Value_Shift_,HSV_Out_Q258);vec4 Color_Q279;From_HSV_B223(X_Q278,Y_Q278,Z_Q278,0.0,Color_Q279);vec4 Color_Q261;\n#if IRIDESCENCE_ENABLED\nColor_Q261=texture(_Iridescence_Texture_,Vec2_Q262);\n#else\nColor_Q261=vec4(0,0,0,0);\n#endif\nfloat X_Q224;float Y_Q224;float Z_Q224;To_XYZ_B224(HSV_Out_Q258,X_Q224,Y_Q224,Z_Q224);vec4 Result_Q281=_Rim_Intensity_*Color_Q279;vec4 Result_Q263=_Iridescence_Intensity_*Color_Q261;vec4 Color_Q223;From_HSV_B223(X_Q224,Y_Q224,Z_Q224,0.0,Color_Q223);vec4 Result_Q234=Result_Q241+(1.0-Result_Q241.a)*Color_Q223;vec4 Result_Q271;Fragment_Main_B271(_Sun_Intensity_,_Sun_Theta_,_Sun_Phi_,New_Normal_Q229,Result_Q234,MaxAB_Q273,_Shininess_,Incident_Q189,_Horizon_Color_,_Sky_Color_,_Ground_Color_,_Indirect_Diffuse_,_Specular_,_Horizon_Power_,_Reflection_,Sum_Q198,Sum_Q199,_Sharpness_,Result_Q227,_Subsurface_,vec4(0,0,0,0),Result_Q281,Result_Q263,Result_Q271);vec4 Result_Q209;Scale_RGB_B209(Result_Q271,MinAB_Q208,Result_Q209);vec4 sRGB_Q192;FastLinearTosRGB_B192(Result_Q209,sRGB_Q192);vec4 Result_Q181=Blob_Color_Q180+(1.0-Blob_Color_Q180.a)*sRGB_Q192;vec4 Result_Q190=Result_Q181; Result_Q190.a=1.0;vec4 Out_Color=Result_Q190;float Clip_Threshold=0.001;bool To_sRGB=false;gl_FragColor=Out_Color;}";ae.l.ShadersStore.mrdlSliderThumbVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;\n#ifdef TANGENT\nattribute vec3 tangent;\n#else\nconst vec3 tangent=vec3(0.);\n#endif\nuniform float _Radius_;uniform float _Bevel_Front_;uniform float _Bevel_Front_Stretch_;uniform float _Bevel_Back_;uniform float _Bevel_Back_Stretch_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform bool _Bulge_Enabled_;uniform float _Bulge_Height_;uniform float _Bulge_Radius_;uniform float _Sun_Intensity_;uniform float _Sun_Theta_;uniform float _Sun_Phi_;uniform float _Indirect_Diffuse_;uniform vec4 _Albedo_;uniform float _Specular_;uniform float _Shininess_;uniform float _Sharpness_;uniform float _Subsurface_;uniform vec4 _Left_Color_;uniform vec4 _Right_Color_;uniform float _Reflection_;uniform float _Front_Reflect_;uniform float _Edge_Reflect_;uniform float _Power_;uniform vec4 _Sky_Color_;uniform vec4 _Horizon_Color_;uniform vec4 _Ground_Color_;uniform float _Horizon_Power_;uniform sampler2D _Reflection_Map_;uniform sampler2D _Indirect_Environment_;uniform float _Width_;uniform float _Fuzz_;uniform float _Min_Fuzz_;uniform float _Clip_Fade_;uniform float _Hue_Shift_;uniform float _Saturation_Shift_;uniform float _Value_Shift_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Left_Index_Pos_;uniform vec3 _Right_Index_Pos_;uniform vec3 _Left_Index_Middle_Pos_;uniform vec3 _Right_Index_Middle_Pos_;uniform sampler2D _Decal_;uniform vec2 _Decal_Scale_XY_;uniform bool _Decal_Front_Only_;uniform float _Rim_Intensity_;uniform sampler2D _Rim_Texture_;uniform float _Rim_Hue_Shift_;uniform float _Rim_Saturation_Shift_;uniform float _Rim_Value_Shift_;uniform float _Iridescence_Intensity_;uniform sampler2D _Iridescence_Texture_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;void Object_To_World_Pos_B162(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid Object_To_World_Normal_B182(\nvec3 Nrm_Object,\nout vec3 Nrm_World)\n{Nrm_World=(vec4(Nrm_Object,0.0)).xyz;}\nvoid Blob_Vertex_B173(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nfloat Blob_Fade_Length,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nout vec4 Blob_Info)\n{vec3 blob= (Use_Global_Left_Index ? Global_Left_Index_Tip_Position.xyz : Blob_Position);vec3 delta=blob-Position;float dist=dot(Normal,delta);float lerpValue=clamp((abs(dist)-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);float fadeValue=1.0-clamp((abs(dist)-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float size=Blob_Near_Size+(Blob_Far_Size-Blob_Near_Size)*lerpValue;vec2 blobXY=vec2(dot(delta,Tangent),dot(delta,Bitangent))/(0.0001+size);float Fade=fadeValue*Intensity*Blob_Fade;float Distance=(lerpValue*0.5+0.5)*(1.0-Blob_Pulse);Blob_Info=vec4(blobXY.x,blobXY.y,Distance,Fade);}\nvoid Blob_Vertex_B174(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nfloat Blob_Fade_Length,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nout vec4 Blob_Info)\n{vec3 blob= (Use_Global_Right_Index ? Global_Right_Index_Tip_Position.xyz : Blob_Position);vec3 delta=blob-Position;float dist=dot(Normal,delta);float lerpValue=clamp((abs(dist)-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);float fadeValue=1.0-clamp((abs(dist)-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float size=Blob_Near_Size+(Blob_Far_Size-Blob_Near_Size)*lerpValue;vec2 blobXY=vec2(dot(delta,Tangent),dot(delta,Bitangent))/(0.0001+size);float Fade=fadeValue*Intensity*Blob_Fade;float Distance=(lerpValue*0.5+0.5)*(1.0-Blob_Pulse);Blob_Info=vec4(blobXY.x,blobXY.y,Distance,Fade);}\nvoid Move_Verts_B280(\nfloat Anisotropy,\nvec3 P,\nfloat Radius,\nfloat Bevel,\nvec3 Normal_Object,\nfloat ScaleZ,\nfloat Stretch,\nout vec3 New_P,\nout vec2 New_UV,\nout float Radial_Gradient,\nout vec3 Radial_Dir,\nout vec3 New_Normal)\n{vec2 UV=P.xy*2.0+0.5;vec2 center=clamp(UV,0.0,1.0);vec2 delta=UV-center;float deltad=(length(delta)*2.0);float f=(Bevel+(Radius-Bevel)*Stretch)/Radius;float innerd=clamp(deltad*2.0,0.0,1.0);float outerd=clamp(deltad*2.0-1.0,0.0,1.0);float bevelAngle=outerd*3.14159*0.5;float sinb=sin(bevelAngle);float cosb=cos(bevelAngle);float beveld=(1.0-f)*innerd+f*sinb;float br=outerd;vec2 r2=2.0*vec2(Radius/Anisotropy,Radius);float dir=P.z<0.0001 ? 1.0 : -1.0;New_UV=center+r2*((0.5-center)+normalize(delta+vec2(0.0,0.000001))*beveld*0.5);New_P=vec3(New_UV-0.5,P.z+dir*(1.0-cosb)*Bevel*ScaleZ);Radial_Gradient=clamp((deltad-0.5)*2.0,0.0,1.0);Radial_Dir=vec3(delta*r2,0.0);vec3 beveledNormal=cosb*Normal_Object+sinb*vec3(delta.x,delta.y,0.0);New_Normal=Normal_Object.z==0.0 ? Normal_Object : beveledNormal;}\nvoid Object_To_World_Dir_B210(\nvec3 Dir_Object,\nout vec3 Normal_World,\nout vec3 Normal_World_N,\nout float Normal_Length)\n{Normal_World=(world*vec4(Dir_Object,0.0)).xyz;Normal_Length=length(Normal_World);Normal_World_N=Normal_World/Normal_Length;}\nvoid To_XYZ_B228(\nvec3 Vec3,\nout float X,\nout float Y,\nout float Z)\n{X=Vec3.x;Y=Vec3.y;Z=Vec3.z;}\nvoid Conditional_Float_B243(\nbool Which,\nfloat If_True,\nfloat If_False,\nout float Result)\n{Result=Which ? If_True : If_False;}\nvoid Object_To_World_Dir_B178(\nvec3 Dir_Object,\nout vec3 Binormal_World,\nout vec3 Binormal_World_N,\nout float Binormal_Length)\n{Binormal_World=(world*vec4(Dir_Object,0.0)).xyz;Binormal_Length=length(Binormal_World);Binormal_World_N=Binormal_World/Binormal_Length;}\nvoid Pick_Radius_B219(\nfloat Radius,\nfloat Radius_Top_Left,\nfloat Radius_Top_Right,\nfloat Radius_Bottom_Left,\nfloat Radius_Bottom_Right,\nvec3 Position,\nout float Result)\n{bool whichY=Position.y>0.0;Result=Position.x<0.0 ? (whichY ? Radius_Top_Left : Radius_Bottom_Left) : (whichY ? Radius_Top_Right : Radius_Bottom_Right);Result*=Radius;}\nvoid Conditional_Float_B186(\nbool Which,\nfloat If_True,\nfloat If_False,\nout float Result)\n{Result=Which ? If_True : If_False;}\nvoid Greater_Than_B187(\nfloat Left,\nfloat Right,\nout bool Not_Greater_Than,\nout bool Greater_Than)\n{Greater_Than=Left>Right;Not_Greater_Than=!Greater_Than;}\nvoid Remap_Range_B255(\nfloat In_Min,\nfloat In_Max,\nfloat Out_Min,\nfloat Out_Max,\nfloat In,\nout float Out)\n{Out=mix(Out_Min,Out_Max,clamp((In-In_Min)/(In_Max-In_Min),0.0,1.0));}\nvoid main()\n{vec2 XY_Q235;XY_Q235=(uv-vec2(0.5,0.5))*_Decal_Scale_XY_+vec2(0.5,0.5);vec3 Tangent_World_Q177;vec3 Tangent_World_N_Q177;float Tangent_Length_Q177;Tangent_World_Q177=(world*vec4(vec3(1,0,0),0.0)).xyz;Tangent_Length_Q177=length(Tangent_World_Q177);Tangent_World_N_Q177=Tangent_World_Q177/Tangent_Length_Q177;vec3 Normal_World_Q210;vec3 Normal_World_N_Q210;float Normal_Length_Q210;Object_To_World_Dir_B210(vec3(0,0,1),Normal_World_Q210,Normal_World_N_Q210,Normal_Length_Q210);float X_Q228;float Y_Q228;float Z_Q228;To_XYZ_B228(position,X_Q228,Y_Q228,Z_Q228);vec3 Nrm_World_Q176;Nrm_World_Q176=normalize((world*vec4(normal,0.0)).xyz);vec3 Binormal_World_Q178;vec3 Binormal_World_N_Q178;float Binormal_Length_Q178;Object_To_World_Dir_B178(vec3(0,1,0),Binormal_World_Q178,Binormal_World_N_Q178,Binormal_Length_Q178);float Anisotropy_Q179=Tangent_Length_Q177/Binormal_Length_Q178;float Result_Q219;Pick_Radius_B219(_Radius_,_Radius_Top_Left_,_Radius_Top_Right_,_Radius_Bottom_Left_,_Radius_Bottom_Right_,position,Result_Q219);float Anisotropy_Q203=Binormal_Length_Q178/Normal_Length_Q210;bool Not_Greater_Than_Q187;bool Greater_Than_Q187;Greater_Than_B187(Z_Q228,0.0,Not_Greater_Than_Q187,Greater_Than_Q187);vec4 Linear_Q251;Linear_Q251.rgb=clamp(_Left_Color_.rgb*_Left_Color_.rgb,0.0,1.0);Linear_Q251.a=_Left_Color_.a;vec4 Linear_Q252;Linear_Q252.rgb=clamp(_Right_Color_.rgb*_Right_Color_.rgb,0.0,1.0);Linear_Q252.a=_Right_Color_.a;vec3 Difference_Q211=vec3(0,0,0)-Normal_World_N_Q210;vec4 Out_Color_Q184=vec4(X_Q228,Y_Q228,Z_Q228,1);float Result_Q186;Conditional_Float_B186(Greater_Than_Q187,_Bevel_Back_,_Bevel_Front_,Result_Q186);float Result_Q244;Conditional_Float_B186(Greater_Than_Q187,_Bevel_Back_Stretch_,_Bevel_Front_Stretch_,Result_Q244);vec3 New_P_Q280;vec2 New_UV_Q280;float Radial_Gradient_Q280;vec3 Radial_Dir_Q280;vec3 New_Normal_Q280;Move_Verts_B280(Anisotropy_Q179,position,Result_Q219,Result_Q186,normal,Anisotropy_Q203,Result_Q244,New_P_Q280,New_UV_Q280,Radial_Gradient_Q280,Radial_Dir_Q280,New_Normal_Q280);float X_Q248;float Y_Q248;X_Q248=New_UV_Q280.x;Y_Q248=New_UV_Q280.y;vec3 Pos_World_Q162;Object_To_World_Pos_B162(New_P_Q280,Pos_World_Q162);vec3 Nrm_World_Q182;Object_To_World_Normal_B182(New_Normal_Q280,Nrm_World_Q182);vec4 Blob_Info_Q173;\n#if BLOB_ENABLE\nBlob_Vertex_B173(Pos_World_Q162,Nrm_World_Q176,Tangent_World_N_Q177,Binormal_World_N_Q178,_Blob_Position_,_Blob_Intensity_,_Blob_Near_Size_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_,_Blob_Fade_,Blob_Info_Q173);\n#else\nBlob_Info_Q173=vec4(0,0,0,0);\n#endif\nvec4 Blob_Info_Q174;\n#if BLOB_ENABLE_2\nBlob_Vertex_B174(Pos_World_Q162,Nrm_World_Q176,Tangent_World_N_Q177,Binormal_World_N_Q178,_Blob_Position_2_,_Blob_Intensity_,_Blob_Near_Size_2_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_2_,_Blob_Fade_2_,Blob_Info_Q174);\n#else\nBlob_Info_Q174=vec4(0,0,0,0);\n#endif\nfloat Out_Q255;Remap_Range_B255(0.0,1.0,0.0,1.0,X_Q248,Out_Q255);float X_Q236;float Y_Q236;float Z_Q236;To_XYZ_B228(Nrm_World_Q182,X_Q236,Y_Q236,Z_Q236);vec4 Color_At_T_Q247=mix(Linear_Q251,Linear_Q252,Out_Q255);float Minus_F_Q237=-Z_Q236;float R_Q249;float G_Q249;float B_Q249;float A_Q249;R_Q249=Color_At_T_Q247.r; G_Q249=Color_At_T_Q247.g; B_Q249=Color_At_T_Q247.b; A_Q249=Color_At_T_Q247.a;float ClampF_Q238=clamp(0.0,Minus_F_Q237,1.0);float Result_Q243;Conditional_Float_B243(_Decal_Front_Only_,ClampF_Q238,1.0,Result_Q243);vec4 Vec4_Q239=vec4(Result_Q243,Radial_Gradient_Q280,G_Q249,B_Q249);vec3 Position=Pos_World_Q162;vec3 Normal=Nrm_World_Q182;vec2 UV=XY_Q235;vec3 Tangent=Tangent_World_N_Q177;vec3 Binormal=Difference_Q211;vec4 Color=Out_Color_Q184;vec4 Extra1=Vec4_Q239;vec4 Extra2=Blob_Info_Q173;vec4 Extra3=Blob_Info_Q174;gl_Position=viewProjection*vec4(Position,1);vPosition=Position;vNormal=Normal;vUV=UV;vTangent=Tangent;vBinormal=Binormal;vColor=Color;vExtra1=Extra1;vExtra2=Extra2;vExtra3=Extra3;}";class pc extends ye.M{constructor(){super(),this.SKY_ENABLED=!0,this.BLOB_ENABLE_2=!0,this.IRIDESCENCE_ENABLED=!0,this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class fc extends Ce{constructor(e,t){super(e,t),this.radius=.157,this.bevelFront=.065,this.bevelFrontStretch=.077,this.bevelBack=.031,this.bevelBackStretch=0,this.radiusTopLeft=1,this.radiusTopRight=1,this.radiusBottomLeft=1,this.radiusBottomRight=1,this.bulgeEnabled=!1,this.bulgeHeight=-.323,this.bulgeRadius=.73,this.sunIntensity=2,this.sunTheta=.937,this.sunPhi=.555,this.indirectDiffuse=1,this.albedo=new M.ov(.0117647,.505882,.996078,1),this.specular=0,this.shininess=10,this.sharpness=0,this.subsurface=.31,this.leftGradientColor=new M.ov(.0117647,.505882,.996078,1),this.rightGradientColor=new M.ov(.0117647,.505882,.996078,1),this.reflection=.749,this.frontReflect=0,this.edgeReflect=.09,this.power=8.1,this.skyColor=new M.ov(.0117647,.960784,.996078,1),this.horizonColor=new M.ov(.0117647,.333333,.996078,1),this.groundColor=new M.ov(0,.254902,.996078,1),this.horizonPower=1,this.width=.02,this.fuzz=.5,this.minFuzz=.001,this.clipFade=.01,this.hueShift=0,this.saturationShift=0,this.valueShift=0,this.blobPosition=new I.Pq(0,0,.1),this.blobIntensity=.5,this.blobNearSize=.01,this.blobFarSize=.03,this.blobNearDistance=0,this.blobFarDistance=.08,this.blobFadeLength=.576,this.blobPulse=0,this.blobFade=1,this.blobPosition2=new I.Pq(.2,0,.1),this.blobNearSize2=.01,this.blobPulse2=0,this.blobFade2=1,this.blobTexture=new G.g("",this.getScene()),this.leftIndexPosition=new I.Pq(0,0,1),this.rightIndexPosition=new I.Pq(-1,-1,-1),this.leftIndexMiddlePosition=new I.Pq(0,0,0),this.rightIndexMiddlePosition=new I.Pq(0,0,0),this.decalScaleXY=new I.I9(1.5,1.5),this.decalFrontOnly=!0,this.rimIntensity=.287,this.rimHueShift=0,this.rimSaturationShift=0,this.rimValueShift=-1,this.iridescenceIntensity=0,this.useGlobalLeftIndex=1,this.useGlobalRightIndex=1,this.globalLeftIndexTipProximity=0,this.globalRightIndexTipProximity=0,this.globalLeftIndexTipPosition=new I.IU(.5,0,-.55,1),this.globaRightIndexTipPosition=new I.IU(0,0,0,1),this.globalLeftThumbTipPosition=new I.IU(.5,0,-.55,1),this.globalRightThumbTipPosition=new I.IU(0,0,0,1),this.globalLeftIndexMiddlePosition=new I.IU(.5,0,-.55,1),this.globalRightIndexMiddlePosition=new I.IU(0,0,0,1),this.alphaMode=Pa.Y.ALPHA_DISABLE,this.backFaceCulling=!1,this._blueGradientTexture=new G.g(fc.BLUE_GRADIENT_TEXTURE_URL,t,!0,!1,G.g.NEAREST_SAMPLINGMODE),this._decalTexture=new G.g("",this.getScene()),this._reflectionMapTexture=new G.g("",this.getScene()),this._indirectEnvTexture=new G.g("",this.getScene())}needAlphaBlending(){return!1}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){const i=t._drawWrapper;if(this.isFrozen&&i.effect&&i._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new pc);const s=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if((0,$.qB)(e,s,!1,!1),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial();const e=new K;s.FOG&&e.addFallback(1,"FOG"),(0,$.c4)(s,e),s.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess;const i=[O.R.PositionKind];s.NORMAL&&i.push(O.R.NormalKind),s.UV1&&i.push(O.R.UVKind),s.UV2&&i.push(O.R.UV2Kind),s.VERTEXCOLOR&&i.push(O.R.ColorKind),s.TANGENT&&i.push(O.R.TangentKind),(0,$.ER)(i,s);const a="mrdlSliderThumb",o=s.toString(),l=["world","viewProjection","cameraPosition","_Radius_","_Bevel_Front_","_Bevel_Front_Stretch_","_Bevel_Back_","_Bevel_Back_Stretch_","_Radius_Top_Left_","_Radius_Top_Right_","_Radius_Bottom_Left_","_Radius_Bottom_Right_","_Bulge_Enabled_","_Bulge_Height_","_Bulge_Radius_","_Sun_Intensity_","_Sun_Theta_","_Sun_Phi_","_Indirect_Diffuse_","_Albedo_","_Specular_","_Shininess_","_Sharpness_","_Subsurface_","_Left_Color_","_Right_Color_","_Reflection_","_Front_Reflect_","_Edge_Reflect_","_Power_","_Sky_Color_","_Horizon_Color_","_Ground_Color_","_Horizon_Power_","_Reflection_Map_","_Indirect_Environment_","_Width_","_Fuzz_","_Min_Fuzz_","_Clip_Fade_","_Hue_Shift_","_Saturation_Shift_","_Value_Shift_","_Blob_Position_","_Blob_Intensity_","_Blob_Near_Size_","_Blob_Far_Size_","_Blob_Near_Distance_","_Blob_Far_Distance_","_Blob_Fade_Length_","_Blob_Pulse_","_Blob_Fade_","_Blob_Texture_","_Blob_Position_2_","_Blob_Near_Size_2_","_Blob_Pulse_2_","_Blob_Fade_2_","_Left_Index_Pos_","_Right_Index_Pos_","_Left_Index_Middle_Pos_","_Right_Index_Middle_Pos_","_Decal_","_Decal_Scale_XY_","_Decal_Front_Only_","_Rim_Intensity_","_Rim_Texture_","_Rim_Hue_Shift_","_Rim_Saturation_Shift_","_Rim_Value_Shift_","_Iridescence_Intensity_","_Iridescence_Texture_","Use_Global_Left_Index","Use_Global_Right_Index","Global_Left_Index_Tip_Position","Global_Right_Index_Tip_Position","Global_Left_Thumb_Tip_Position","Global_Right_Thumb_Tip_Position","Global_Left_Index_Middle_Position;","Global_Right_Index_Middle_Position","Global_Left_Index_Tip_Proximity","Global_Right_Index_Tip_Proximity"],h=["_Rim_Texture_","_Iridescence_Texture_"],c=[];(0,$.Bb)({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:s,maxSimultaneousLights:4}),t.setEffect(r.getEngine().createEffect(a,{attributes:i,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:o,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),s)}return!(!t.effect||!t.effect.isReady()||(s._renderId=r.getRenderId(),i._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){if(!i.materialDefines)return;const s=i.effect;s&&(this._activeEffect=s,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",this.getScene().activeCamera.position),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Bevel_Front_",this.bevelFront),this._activeEffect.setFloat("_Bevel_Front_Stretch_",this.bevelFrontStretch),this._activeEffect.setFloat("_Bevel_Back_",this.bevelBack),this._activeEffect.setFloat("_Bevel_Back_Stretch_",this.bevelBackStretch),this._activeEffect.setFloat("_Radius_Top_Left_",this.radiusTopLeft),this._activeEffect.setFloat("_Radius_Top_Right_",this.radiusTopRight),this._activeEffect.setFloat("_Radius_Bottom_Left_",this.radiusBottomLeft),this._activeEffect.setFloat("_Radius_Bottom_Right_",this.radiusBottomRight),this._activeEffect.setFloat("_Bulge_Enabled_",this.bulgeEnabled?1:0),this._activeEffect.setFloat("_Bulge_Height_",this.bulgeHeight),this._activeEffect.setFloat("_Bulge_Radius_",this.bulgeRadius),this._activeEffect.setFloat("_Sun_Intensity_",this.sunIntensity),this._activeEffect.setFloat("_Sun_Theta_",this.sunTheta),this._activeEffect.setFloat("_Sun_Phi_",this.sunPhi),this._activeEffect.setFloat("_Indirect_Diffuse_",this.indirectDiffuse),this._activeEffect.setDirectColor4("_Albedo_",this.albedo),this._activeEffect.setFloat("_Specular_",this.specular),this._activeEffect.setFloat("_Shininess_",this.shininess),this._activeEffect.setFloat("_Sharpness_",this.sharpness),this._activeEffect.setFloat("_Subsurface_",this.subsurface),this._activeEffect.setDirectColor4("_Left_Color_",this.leftGradientColor),this._activeEffect.setDirectColor4("_Right_Color_",this.rightGradientColor),this._activeEffect.setFloat("_Reflection_",this.reflection),this._activeEffect.setFloat("_Front_Reflect_",this.frontReflect),this._activeEffect.setFloat("_Edge_Reflect_",this.edgeReflect),this._activeEffect.setFloat("_Power_",this.power),this._activeEffect.setDirectColor4("_Sky_Color_",this.skyColor),this._activeEffect.setDirectColor4("_Horizon_Color_",this.horizonColor),this._activeEffect.setDirectColor4("_Ground_Color_",this.groundColor),this._activeEffect.setFloat("_Horizon_Power_",this.horizonPower),this._activeEffect.setTexture("_Reflection_Map_",this._reflectionMapTexture),this._activeEffect.setTexture("_Indirect_Environment_",this._indirectEnvTexture),this._activeEffect.setFloat("_Width_",this.width),this._activeEffect.setFloat("_Fuzz_",this.fuzz),this._activeEffect.setFloat("_Min_Fuzz_",this.minFuzz),this._activeEffect.setFloat("_Clip_Fade_",this.clipFade),this._activeEffect.setFloat("_Hue_Shift_",this.hueShift),this._activeEffect.setFloat("_Saturation_Shift_",this.saturationShift),this._activeEffect.setFloat("_Value_Shift_",this.valueShift),this._activeEffect.setVector3("_Blob_Position_",this.blobPosition),this._activeEffect.setFloat("_Blob_Intensity_",this.blobIntensity),this._activeEffect.setFloat("_Blob_Near_Size_",this.blobNearSize),this._activeEffect.setFloat("_Blob_Far_Size_",this.blobFarSize),this._activeEffect.setFloat("_Blob_Near_Distance_",this.blobNearDistance),this._activeEffect.setFloat("_Blob_Far_Distance_",this.blobFarDistance),this._activeEffect.setFloat("_Blob_Fade_Length_",this.blobFadeLength),this._activeEffect.setFloat("_Blob_Pulse_",this.blobPulse),this._activeEffect.setFloat("_Blob_Fade_",this.blobFade),this._activeEffect.setTexture("_Blob_Texture_",this.blobTexture),this._activeEffect.setVector3("_Blob_Position_2_",this.blobPosition2),this._activeEffect.setFloat("_Blob_Near_Size_2_",this.blobNearSize2),this._activeEffect.setFloat("_Blob_Pulse_2_",this.blobPulse2),this._activeEffect.setFloat("_Blob_Fade_2_",this.blobFade2),this._activeEffect.setVector3("_Left_Index_Pos_",this.leftIndexPosition),this._activeEffect.setVector3("_Right_Index_Pos_",this.rightIndexPosition),this._activeEffect.setVector3("_Left_Index_Middle_Pos_",this.leftIndexMiddlePosition),this._activeEffect.setVector3("_Right_Index_Middle_Pos_",this.rightIndexMiddlePosition),this._activeEffect.setTexture("_Decal_",this._decalTexture),this._activeEffect.setVector2("_Decal_Scale_XY_",this.decalScaleXY),this._activeEffect.setFloat("_Decal_Front_Only_",this.decalFrontOnly?1:0),this._activeEffect.setFloat("_Rim_Intensity_",this.rimIntensity),this._activeEffect.setTexture("_Rim_Texture_",this._blueGradientTexture),this._activeEffect.setFloat("_Rim_Hue_Shift_",this.rimHueShift),this._activeEffect.setFloat("_Rim_Saturation_Shift_",this.rimSaturationShift),this._activeEffect.setFloat("_Rim_Value_Shift_",this.rimValueShift),this._activeEffect.setFloat("_Iridescence_Intensity_",this.iridescenceIntensity),this._activeEffect.setTexture("_Iridescence_Texture_",this._blueGradientTexture),this._activeEffect.setFloat("Use_Global_Left_Index",this.useGlobalLeftIndex),this._activeEffect.setFloat("Use_Global_Right_Index",this.useGlobalRightIndex),this._activeEffect.setVector4("Global_Left_Index_Tip_Position",this.globalLeftIndexTipPosition),this._activeEffect.setVector4("Global_Right_Index_Tip_Position",this.globaRightIndexTipPosition),this._activeEffect.setVector4("Global_Left_Thumb_Tip_Position",this.globalLeftThumbTipPosition),this._activeEffect.setVector4("Global_Right_Thumb_Tip_Position",this.globalRightThumbTipPosition),this._activeEffect.setVector4("Global_Left_Index_Middle_Position",this.globalLeftIndexMiddlePosition),this._activeEffect.setVector4("Global_Right_Index_Middle_Position",this.globalRightIndexMiddlePosition),this._activeEffect.setFloat("Global_Left_Index_Tip_Proximity",this.globalLeftIndexTipProximity),this._activeEffect.setFloat("Global_Right_Index_Tip_Proximity",this.globalRightIndexTipProximity),this._afterBind(t,this._activeEffect,i))}getAnimatables(){return[]}dispose(e){super.dispose(e),this._reflectionMapTexture.dispose(),this._indirectEnvTexture.dispose(),this._blueGradientTexture.dispose(),this._decalTexture.dispose()}clone(e){return N.p.Clone((()=>new fc(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.MRDLSliderThumbMaterial",e}getClassName(){return"MRDLSliderThumbMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new fc(e.name,t)),e,t,i)}}fc.BLUE_GRADIENT_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/MRDL/mrtk-mrdl-blue-gradient.png",(0,w.Cg)([(0,D.lK)()],fc.prototype,"radius",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"bevelFront",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"bevelFrontStretch",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"bevelBack",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"bevelBackStretch",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"radiusTopLeft",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"radiusTopRight",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"radiusBottomLeft",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"radiusBottomRight",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"bulgeEnabled",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"bulgeHeight",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"bulgeRadius",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"sunIntensity",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"sunTheta",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"sunPhi",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"indirectDiffuse",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"albedo",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"specular",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"shininess",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"sharpness",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"subsurface",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"leftGradientColor",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"rightGradientColor",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"reflection",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"frontReflect",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"edgeReflect",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"power",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"skyColor",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"horizonColor",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"groundColor",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"horizonPower",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"width",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"fuzz",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"minFuzz",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"clipFade",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"hueShift",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"saturationShift",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"valueShift",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobPosition",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobIntensity",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobNearSize",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobFarSize",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobNearDistance",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobFarDistance",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobFadeLength",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobPulse",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobFade",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobPosition2",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobNearSize2",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobPulse2",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobFade2",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"blobTexture",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"leftIndexPosition",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"rightIndexPosition",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"leftIndexMiddlePosition",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"rightIndexMiddlePosition",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"decalScaleXY",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"decalFrontOnly",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"rimIntensity",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"rimHueShift",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"rimSaturationShift",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"rimValueShift",void 0),(0,w.Cg)([(0,D.lK)()],fc.prototype,"iridescenceIntensity",void 0),(0,V.Y5)("BABYLON.GUI.MRDLSliderThumbMaterial",fc);ae.l.ShadersStore.mrdlBackplatePixelShader="uniform vec3 cameraPosition;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vExtra1;varying vec4 vExtra2;uniform float _Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Filter_Width_;uniform vec4 _Base_Color_;uniform vec4 _Line_Color_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform float _Rate_;uniform vec4 _Highlight_Color_;uniform float _Highlight_Width_;uniform vec4 _Highlight_Transform_;uniform float _Highlight_;uniform float _Iridescence_Intensity_;uniform float _Iridescence_Edge_Intensity_;uniform vec4 _Iridescence_Tint_;uniform sampler2D _Iridescent_Map_;uniform float _Angle_;uniform bool _Reflected_;uniform float _Frequency_;uniform float _Vertical_Offset_;uniform vec4 _Gradient_Color_;uniform vec4 _Top_Left_;uniform vec4 _Top_Right_;uniform vec4 _Bottom_Left_;uniform vec4 _Bottom_Right_;uniform float _Edge_Width_;uniform float _Edge_Power_;uniform float _Line_Gradient_Blend_;uniform float _Fade_Out_;void FastLinearTosRGB_B353(\nvec4 Linear,\nout vec4 sRGB)\n{sRGB.rgb=sqrt(clamp(Linear.rgb,0.0,1.0));sRGB.a=Linear.a;}\nvoid Round_Rect_Fragment_B332(\nfloat Radius,\nfloat Line_Width,\nvec4 Line_Color,\nfloat Filter_Width,\nvec2 UV,\nfloat Line_Visibility,\nvec4 Rect_Parms,\nvec4 Fill_Color,\nout vec4 Color)\n{float d=length(max(abs(UV)-Rect_Parms.xy,0.0));float dx=max(fwidth(d)*Filter_Width,0.00001);float g=min(Rect_Parms.z,Rect_Parms.w);float dgrad=max(fwidth(g)*Filter_Width,0.00001);float Inside_Rect=clamp(g/dgrad,0.0,1.0);float inner=clamp((d+dx*0.5-max(Radius-Line_Width,d-dx*0.5))/dx,0.0,1.0);Color=clamp(mix(Fill_Color,Line_Color,inner),0.0,1.0)*Inside_Rect;}\nvoid Iridescence_B343(\nvec3 Position,\nvec3 Normal,\nvec2 UV,\nvec3 Axis,\nvec3 Eye,\nvec4 Tint,\nsampler2D Texture,\nbool Reflected,\nfloat Frequency,\nfloat Vertical_Offset,\nout vec4 Color)\n{vec3 i=normalize(Position-Eye);vec3 r=reflect(i,Normal);float idota=dot(i,Axis);float idotr=dot(i,r);float x=Reflected ? idotr : idota;vec2 xy;xy.x=fract((x*Frequency+1.0)*0.5+UV.y*Vertical_Offset);xy.y=0.5;Color=texture(Texture,xy);Color.rgb*=Tint.rgb;}\nvoid Scale_RGB_B346(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Scale_RGB_B344(\nfloat Scalar,\nvec4 Color,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Line_Fragment_B362(\nvec4 Base_Color,\nvec4 Highlight_Color,\nfloat Highlight_Width,\nvec3 Line_Vertex,\nfloat Highlight,\nout vec4 Line_Color)\n{float k2=1.0-clamp(abs(Line_Vertex.y/Highlight_Width),0.0,1.0);Line_Color=mix(Base_Color,Highlight_Color,Highlight*k2);}\nvoid Edge_B356(\nvec4 RectParms,\nfloat Radius,\nfloat Line_Width,\nvec2 UV,\nfloat Edge_Width,\nfloat Edge_Power,\nout float Result)\n{float d=length(max(abs(UV)-RectParms.xy,0.0));float edge=1.0-clamp((1.0-d/(Radius-Line_Width))/Edge_Width,0.0,1.0);Result=pow(edge,Edge_Power);}\nvoid Gradient_B355(\nvec4 Gradient_Color,\nvec4 Top_Left,\nvec4 Top_Right,\nvec4 Bottom_Left,\nvec4 Bottom_Right,\nvec2 UV,\nout vec4 Result)\n{vec3 top=Top_Left.rgb+(Top_Right.rgb-Top_Left.rgb)*UV.x;vec3 bottom=Bottom_Left.rgb+(Bottom_Right.rgb-Bottom_Left.rgb)*UV.x;Result.rgb=Gradient_Color.rgb*(bottom+(top-bottom)*UV.y);Result.a=1.0;}\nvoid main()\n{float X_Q338;float Y_Q338;float Z_Q338;float W_Q338;X_Q338=vExtra2.x;Y_Q338=vExtra2.y;Z_Q338=vExtra2.z;W_Q338=vExtra2.w;vec4 Color_Q343;\n#if IRIDESCENCE_ENABLE\nIridescence_B343(vPosition,vNormal,vUV,vBinormal,cameraPosition,_Iridescence_Tint_,_Iridescent_Map_,_Reflected_,_Frequency_,_Vertical_Offset_,Color_Q343);\n#else\nColor_Q343=vec4(0,0,0,0);\n#endif\nvec4 Result_Q344;Scale_RGB_B344(_Iridescence_Intensity_,Color_Q343,Result_Q344);vec4 Line_Color_Q362;Line_Fragment_B362(_Line_Color_,_Highlight_Color_,_Highlight_Width_,vTangent,_Highlight_,Line_Color_Q362);float Result_Q356;\n#if EDGE_ONLY\nEdge_B356(vExtra1,Z_Q338,W_Q338,vUV,_Edge_Width_,_Edge_Power_,Result_Q356);\n#else\nResult_Q356=1.0;\n#endif\nvec2 Vec2_Q339=vec2(X_Q338,Y_Q338);vec4 Result_Q355;Gradient_B355(_Gradient_Color_,_Top_Left_,_Top_Right_,_Bottom_Left_,_Bottom_Right_,Vec2_Q339,Result_Q355);vec4 Linear_Q348;Linear_Q348.rgb=clamp(Result_Q355.rgb*Result_Q355.rgb,0.0,1.0);Linear_Q348.a=Result_Q355.a;vec4 Result_Q346;Scale_RGB_B346(Linear_Q348,Result_Q356,Result_Q346);vec4 Sum_Q345=Result_Q346+Result_Q344;vec4 Color_At_T_Q347=mix(Line_Color_Q362,Result_Q346,_Line_Gradient_Blend_);vec4 Base_And_Iridescent_Q350;Base_And_Iridescent_Q350=_Base_Color_+vec4(Sum_Q345.rgb,0.0);vec4 Sum_Q349=Color_At_T_Q347+_Iridescence_Edge_Intensity_*Color_Q343;vec4 Result_Q351=Sum_Q349; Result_Q351.a=1.0;vec4 Color_Q332;Round_Rect_Fragment_B332(Z_Q338,W_Q338,Result_Q351,_Filter_Width_,vUV,1.0,vExtra1,Base_And_Iridescent_Q350,Color_Q332);vec4 Result_Q354=_Fade_Out_*Color_Q332;vec4 sRGB_Q353;FastLinearTosRGB_B353(Result_Q354,sRGB_Q353);vec4 Out_Color=sRGB_Q353;float Clip_Threshold=0.001;bool To_sRGB=false;gl_FragColor=Out_Color;}";ae.l.ShadersStore.mrdlBackplateVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec3 tangent;uniform float _Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Filter_Width_;uniform vec4 _Base_Color_;uniform vec4 _Line_Color_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform float _Rate_;uniform vec4 _Highlight_Color_;uniform float _Highlight_Width_;uniform vec4 _Highlight_Transform_;uniform float _Highlight_;uniform float _Iridescence_Intensity_;uniform float _Iridescence_Edge_Intensity_;uniform vec4 _Iridescence_Tint_;uniform sampler2D _Iridescent_Map_;uniform float _Angle_;uniform bool _Reflected_;uniform float _Frequency_;uniform float _Vertical_Offset_;uniform vec4 _Gradient_Color_;uniform vec4 _Top_Left_;uniform vec4 _Top_Right_;uniform vec4 _Bottom_Left_;uniform vec4 _Bottom_Right_;uniform float _Edge_Width_;uniform float _Edge_Power_;uniform float _Line_Gradient_Blend_;uniform float _Fade_Out_;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vExtra1;varying vec4 vExtra2;void Object_To_World_Pos_B314(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid Round_Rect_Vertex_B357(\nvec2 UV,\nfloat Radius,\nfloat Margin,\nfloat Anisotropy,\nfloat Gradient1,\nfloat Gradient2,\nvec3 Normal,\nvec4 Color_Scale_Translate,\nout vec2 Rect_UV,\nout vec4 Rect_Parms,\nout vec2 Scale_XY,\nout vec2 Line_UV,\nout vec2 Color_UV_Info)\n{Scale_XY=vec2(Anisotropy,1.0);Line_UV=(UV-vec2(0.5,0.5));Rect_UV=Line_UV*Scale_XY;Rect_Parms.xy=Scale_XY*0.5-vec2(Radius,Radius)-vec2(Margin,Margin);Rect_Parms.z=Gradient1; \nRect_Parms.w=Gradient2;Color_UV_Info=(Line_UV+vec2(0.5,0.5))*Color_Scale_Translate.xy+Color_Scale_Translate.zw;}\nvoid Line_Vertex_B333(\nvec2 Scale_XY,\nvec2 UV,\nfloat Time,\nfloat Rate,\nvec4 Highlight_Transform,\nout vec3 Line_Vertex)\n{float angle2=(Rate*Time)*2.0*3.1416;float sinAngle2=sin(angle2);float cosAngle2=cos(angle2);vec2 xformUV=UV*Highlight_Transform.xy+Highlight_Transform.zw;Line_Vertex.x=0.0;Line_Vertex.y=cosAngle2*xformUV.x-sinAngle2*xformUV.y;Line_Vertex.z=0.0; }\nvoid PickDir_B334(\nfloat Degrees,\nvec3 DirX,\nvec3 DirY,\nout vec3 Dir)\n{float a=Degrees*3.14159/180.0;Dir=cos(a)*DirX+sin(a)*DirY;}\nvoid Move_Verts_B327(\nfloat Anisotropy,\nvec3 P,\nfloat Radius,\nout vec3 New_P,\nout vec2 New_UV,\nout float Radial_Gradient,\nout vec3 Radial_Dir)\n{vec2 UV=P.xy*2.0+0.5;vec2 center=clamp(UV,0.0,1.0);vec2 delta=UV-center;vec2 r2=2.0*vec2(Radius/Anisotropy,Radius);New_UV=center+r2*(UV-2.0*center+0.5);New_P=vec3(New_UV-0.5,P.z);Radial_Gradient=1.0-length(delta)*2.0;Radial_Dir=vec3(delta*r2,0.0);}\nvoid Pick_Radius_B336(\nfloat Radius,\nfloat Radius_Top_Left,\nfloat Radius_Top_Right,\nfloat Radius_Bottom_Left,\nfloat Radius_Bottom_Right,\nvec3 Position,\nout float Result)\n{bool whichY=Position.y>0.0;Result=Position.x<0.0 ? (whichY ? Radius_Top_Left : Radius_Bottom_Left) : (whichY ? Radius_Top_Right : Radius_Bottom_Right);Result*=Radius;}\nvoid Edge_AA_Vertex_B328(\nvec3 Position_World,\nvec3 Position_Object,\nvec3 Normal_Object,\nvec3 Eye,\nfloat Radial_Gradient,\nvec3 Radial_Dir,\nvec3 Tangent,\nout float Gradient1,\nout float Gradient2)\n{vec3 I=(Eye-Position_World);vec3 T=(vec4(Tangent,0.0)).xyz;float g=(dot(T,I)<0.0) ? 0.0 : 1.0;if (Normal_Object.z==0.0) { \nGradient1=Position_Object.z>0.0 ? g : 1.0;Gradient2=Position_Object.z>0.0 ? 1.0 : g;} else {Gradient1=g+(1.0-g)*(Radial_Gradient);Gradient2=1.0;}}\nvoid Object_To_World_Dir_B330(\nvec3 Dir_Object,\nout vec3 Binormal_World,\nout vec3 Binormal_World_N,\nout float Binormal_Length)\n{Binormal_World=(world*vec4(Dir_Object,0.0)).xyz;Binormal_Length=length(Binormal_World);Binormal_World_N=Binormal_World/Binormal_Length;}\nvoid RelativeOrAbsoluteDetail_B341(\nfloat Nominal_Radius,\nfloat Nominal_LineWidth,\nbool Absolute_Measurements,\nfloat Height,\nout float Radius,\nout float Line_Width)\n{float scale=Absolute_Measurements ? 1.0/Height : 1.0;Radius=Nominal_Radius*scale;Line_Width=Nominal_LineWidth*scale;}\nvoid main()\n{vec3 Nrm_World_Q326;Nrm_World_Q326=normalize((world*vec4(normal,0.0)).xyz);vec3 Tangent_World_Q329;vec3 Tangent_World_N_Q329;float Tangent_Length_Q329;Tangent_World_Q329=(world*vec4(vec3(1,0,0),0.0)).xyz;Tangent_Length_Q329=length(Tangent_World_Q329);Tangent_World_N_Q329=Tangent_World_Q329/Tangent_Length_Q329;vec3 Binormal_World_Q330;vec3 Binormal_World_N_Q330;float Binormal_Length_Q330;Object_To_World_Dir_B330(vec3(0,1,0),Binormal_World_Q330,Binormal_World_N_Q330,Binormal_Length_Q330);float Radius_Q341;float Line_Width_Q341;RelativeOrAbsoluteDetail_B341(_Radius_,_Line_Width_,_Absolute_Sizes_,Binormal_Length_Q330,Radius_Q341,Line_Width_Q341);vec3 Dir_Q334;PickDir_B334(_Angle_,Tangent_World_N_Q329,Binormal_World_N_Q330,Dir_Q334);float Result_Q336;Pick_Radius_B336(Radius_Q341,_Radius_Top_Left_,_Radius_Top_Right_,_Radius_Bottom_Left_,_Radius_Bottom_Right_,position,Result_Q336);float Anisotropy_Q331=Tangent_Length_Q329/Binormal_Length_Q330;vec4 Out_Color_Q337=vec4(Result_Q336,Line_Width_Q341,0,1);vec3 New_P_Q327;vec2 New_UV_Q327;float Radial_Gradient_Q327;vec3 Radial_Dir_Q327;Move_Verts_B327(Anisotropy_Q331,position,Result_Q336,New_P_Q327,New_UV_Q327,Radial_Gradient_Q327,Radial_Dir_Q327);vec3 Pos_World_Q314;Object_To_World_Pos_B314(New_P_Q327,Pos_World_Q314);float Gradient1_Q328;float Gradient2_Q328;\n#if SMOOTH_EDGES\nEdge_AA_Vertex_B328(Pos_World_Q314,position,normal,cameraPosition,Radial_Gradient_Q327,Radial_Dir_Q327,tangent,Gradient1_Q328,Gradient2_Q328);\n#else\nGradient1_Q328=1.0;Gradient2_Q328=1.0;\n#endif\nvec2 Rect_UV_Q357;vec4 Rect_Parms_Q357;vec2 Scale_XY_Q357;vec2 Line_UV_Q357;vec2 Color_UV_Info_Q357;Round_Rect_Vertex_B357(New_UV_Q327,Result_Q336,0.0,Anisotropy_Q331,Gradient1_Q328,Gradient2_Q328,normal,vec4(1,1,0,0),Rect_UV_Q357,Rect_Parms_Q357,Scale_XY_Q357,Line_UV_Q357,Color_UV_Info_Q357);vec3 Line_Vertex_Q333;Line_Vertex_B333(Scale_XY_Q357,Line_UV_Q357,(20.0),_Rate_,_Highlight_Transform_,Line_Vertex_Q333);float X_Q359;float Y_Q359;X_Q359=Color_UV_Info_Q357.x;Y_Q359=Color_UV_Info_Q357.y;vec4 Vec4_Q358=vec4(X_Q359,Y_Q359,Result_Q336,Line_Width_Q341);vec3 Position=Pos_World_Q314;vec3 Normal=Nrm_World_Q326;vec2 UV=Rect_UV_Q357;vec3 Tangent=Line_Vertex_Q333;vec3 Binormal=Dir_Q334;vec4 Color=Out_Color_Q337;vec4 Extra1=Rect_Parms_Q357;vec4 Extra2=Vec4_Q358;vec4 Extra3=vec4(0,0,0,0);gl_Position=viewProjection*vec4(Position,1);vPosition=Position;vNormal=Normal;vUV=UV;vTangent=Tangent;vBinormal=Binormal;vExtra1=Extra1;vExtra2=Extra2;}";class mc extends ye.M{constructor(){super(),this.IRIDESCENCE_ENABLE=!0,this.SMOOTH_EDGES=!0,this._needNormals=!0,this.rebuild()}}class gc extends Ce{constructor(e,t){super(e,t),this.radius=.3,this.lineWidth=.003,this.absoluteSizes=!1,this._filterWidth=1,this.baseColor=new M.ov(0,0,0,1),this.lineColor=new M.ov(.2,.262745,.4,1),this.radiusTopLeft=1,this.radiusTopRight=1,this.radiusBottomLeft=1,this.radiusBottomRight=1,this._rate=0,this.highlightColor=new M.ov(.239216,.435294,.827451,1),this.highlightWidth=0,this._highlightTransform=new I.IU(1,1,0,0),this._highlight=1,this.iridescenceIntensity=.45,this.iridescenceEdgeIntensity=1,this.iridescenceTint=new M.ov(1,1,1,1),this._angle=-45,this.fadeOut=1,this._reflected=!0,this._frequency=1,this._verticalOffset=0,this.gradientColor=new M.ov(.74902,.74902,.74902,1),this.topLeftGradientColor=new M.ov(.00784314,.294118,.580392,1),this.topRightGradientColor=new M.ov(.305882,0,1,1),this.bottomLeftGradientColor=new M.ov(.133333,.258824,.992157,1),this.bottomRightGradientColor=new M.ov(.176471,.176471,.619608,1),this.edgeWidth=.5,this.edgePower=1,this.edgeLineGradientBlend=.5,this.alphaMode=Pa.Y.ALPHA_DISABLE,this.backFaceCulling=!1,this._iridescentMapTexture=new G.g(gc.IRIDESCENT_MAP_TEXTURE_URL,this.getScene(),!0,!1,G.g.NEAREST_SAMPLINGMODE)}needAlphaBlending(){return!1}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){const i=t._drawWrapper;if(this.isFrozen&&i.effect&&i._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new mc);const s=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if((0,$.qB)(e,s,!1,!1),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial();const e=new K;s.FOG&&e.addFallback(1,"FOG"),(0,$.c4)(s,e),s.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess;const i=[O.R.PositionKind];s.NORMAL&&i.push(O.R.NormalKind),s.UV1&&i.push(O.R.UVKind),s.UV2&&i.push(O.R.UV2Kind),s.VERTEXCOLOR&&i.push(O.R.ColorKind),s.TANGENT&&i.push(O.R.TangentKind),(0,$.ER)(i,s);const a="mrdlBackplate",o=s.toString(),l=["world","viewProjection","cameraPosition","_Radius_","_Line_Width_","_Absolute_Sizes_","_Filter_Width_","_Base_Color_","_Line_Color_","_Radius_Top_Left_","_Radius_Top_Right_","_Radius_Bottom_Left_","_Radius_Bottom_Right_","_Rate_","_Highlight_Color_","_Highlight_Width_","_Highlight_Transform_","_Highlight_","_Iridescence_Intensity_","_Iridescence_Edge_Intensity_","_Iridescence_Tint_","_Iridescent_Map_","_Angle_","_Reflected_","_Frequency_","_Vertical_Offset_","_Gradient_Color_","_Top_Left_","_Top_Right_","_Bottom_Left_","_Bottom_Right_","_Edge_Width_","_Edge_Power_","_Line_Gradient_Blend_","_Fade_Out_"],h=["_Iridescent_Map_"],c=[];(0,$.Bb)({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:s,maxSimultaneousLights:4}),t.setEffect(r.getEngine().createEffect(a,{attributes:i,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:o,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),s)}return!(!t.effect||!t.effect.isReady()||(s._renderId=r.getRenderId(),i._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){if(!i.materialDefines)return;const s=i.effect;s&&(this._activeEffect=s,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",this.getScene().activeCamera.position),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Line_Width_",this.lineWidth),this._activeEffect.setFloat("_Absolute_Sizes_",this.absoluteSizes?1:0),this._activeEffect.setFloat("_Filter_Width_",this._filterWidth),this._activeEffect.setDirectColor4("_Base_Color_",this.baseColor),this._activeEffect.setDirectColor4("_Line_Color_",this.lineColor),this._activeEffect.setFloat("_Radius_Top_Left_",this.radiusTopLeft),this._activeEffect.setFloat("_Radius_Top_Right_",this.radiusTopRight),this._activeEffect.setFloat("_Radius_Bottom_Left_",this.radiusBottomLeft),this._activeEffect.setFloat("_Radius_Bottom_Right_",this.radiusBottomRight),this._activeEffect.setFloat("_Rate_",this._rate),this._activeEffect.setDirectColor4("_Highlight_Color_",this.highlightColor),this._activeEffect.setFloat("_Highlight_Width_",this.highlightWidth),this._activeEffect.setVector4("_Highlight_Transform_",this._highlightTransform),this._activeEffect.setFloat("_Highlight_",this._highlight),this._activeEffect.setFloat("_Iridescence_Intensity_",this.iridescenceIntensity),this._activeEffect.setFloat("_Iridescence_Edge_Intensity_",this.iridescenceEdgeIntensity),this._activeEffect.setDirectColor4("_Iridescence_Tint_",this.iridescenceTint),this._activeEffect.setTexture("_Iridescent_Map_",this._iridescentMapTexture),this._activeEffect.setFloat("_Angle_",this._angle),this._activeEffect.setFloat("_Reflected_",this._reflected?1:0),this._activeEffect.setFloat("_Frequency_",this._frequency),this._activeEffect.setFloat("_Vertical_Offset_",this._verticalOffset),this._activeEffect.setDirectColor4("_Gradient_Color_",this.gradientColor),this._activeEffect.setDirectColor4("_Top_Left_",this.topLeftGradientColor),this._activeEffect.setDirectColor4("_Top_Right_",this.topRightGradientColor),this._activeEffect.setDirectColor4("_Bottom_Left_",this.bottomLeftGradientColor),this._activeEffect.setDirectColor4("_Bottom_Right_",this.bottomRightGradientColor),this._activeEffect.setFloat("_Edge_Width_",this.edgeWidth),this._activeEffect.setFloat("_Edge_Power_",this.edgePower),this._activeEffect.setFloat("_Line_Gradient_Blend_",this.edgeLineGradientBlend),this._activeEffect.setFloat("_Fade_Out_",this.fadeOut),this._afterBind(t,this._activeEffect,i))}getAnimatables(){return[]}dispose(e){super.dispose(e)}clone(e){return N.p.Clone((()=>new gc(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.MRDLBackplateMaterial",e}getClassName(){return"MRDLBackplateMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new gc(e.name,t)),e,t,i)}}gc.IRIDESCENT_MAP_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/MRDL/mrtk-mrdl-backplate-iridescence.png",(0,w.Cg)([(0,D.lK)()],gc.prototype,"radius",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"lineWidth",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"absoluteSizes",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"baseColor",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"lineColor",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"radiusTopLeft",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"radiusTopRight",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"radiusBottomLeft",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"radiusBottomRight",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"highlightColor",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"highlightWidth",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"iridescenceIntensity",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"iridescenceEdgeIntensity",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"iridescenceTint",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"fadeOut",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"gradientColor",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"topLeftGradientColor",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"topRightGradientColor",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"bottomLeftGradientColor",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"bottomRightGradientColor",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"edgeWidth",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"edgePower",void 0),(0,w.Cg)([(0,D.lK)()],gc.prototype,"edgeLineGradientBlend",void 0),(0,V.Y5)("BABYLON.GUI.MRDLBackplateMaterial",gc);class vc extends Eh{constructor(e,t){super(e),this.onValueChangedObservable=new C.cP,this._sliderBackplateVisible=t||!1,this._minimum=0,this._maximum=100,this._step=0,this._value=50}get mesh(){return this.node?this._sliderThumb:null}get minimum(){return this._minimum}set minimum(e){this._minimum!==e&&(this._minimum=Math.max(e,0),this._value=Math.max(Math.min(this._value,this._maximum),this._minimum))}get maximum(){return this._maximum}set maximum(e){this._maximum!==e&&(this._maximum=Math.max(e,this._minimum),this._value=Math.max(Math.min(this._value,this._maximum),this._minimum))}get step(){return this._step}set step(e){this._step!==e&&(this._step=Math.max(Math.min(e,this._maximum-this._minimum),0))}get value(){return this._value}set value(e){this._value!==e&&(this._value=Math.max(Math.min(e,this._maximum),this._minimum),this._sliderThumb&&(this._sliderThumb.position.x=this._convertToPosition(this.value)),this.onValueChangedObservable.notifyObservers(this._value))}get start(){return this.node?this._sliderBar.position.x-this._sliderBar.scaling.x/2:-.5}get end(){return this.node?this._sliderBar.position.x+this._sliderBar.scaling.x/2:.5}get sliderBarMaterial(){return this._sliderBarMaterial}get sliderThumbMaterial(){return this._sliderThumbMaterial}get sliderBackplateMaterial(){return this._sliderBackplateMaterial}get sliderBar(){return this._sliderBar}get sliderThumb(){return this._sliderThumb}get sliderBackplate(){return this._sliderBackplate}set isVisible(e){this._isVisible!==e&&(this._isVisible=e,this.node?.setEnabled(e))}_createNode(e){const t=xi(`${this.name}_sliderbackplate`,{width:1,height:1,depth:1},e);return t.isPickable=!1,t.visibility=0,t.scaling=new I.Pq(1,.5,.8),er.ImportMeshAsync(void 0,vc.MODEL_BASE_URL,vc.MODEL_FILENAME,e).then((e=>{e.meshes.forEach((e=>{e.isPickable=!1}));const i=e.meshes[1],s=e.meshes[1].clone(`${this.name}_sliderbar`,t),r=e.meshes[1].clone(`${this.name}_sliderthumb`,t);i.visibility=0,this._sliderBackplateVisible&&(i.visibility=1,i.name=`${this.name}_sliderbackplate`,i.scaling.x=1,i.scaling.z=.2,i.parent=t,this._sliderBackplateMaterial&&(i.material=this._sliderBackplateMaterial),this._sliderBackplate=i),s&&(s.parent=t,s.position.z=-.1,s.scaling=new I.Pq(.8,.04,.3),this._sliderBarMaterial&&(s.material=this._sliderBarMaterial),this._sliderBar=s),r&&(r.parent=t,r.isPickable=!0,r.position.z=-.115,r.scaling=new I.Pq(.025,.3,.6),r.position.x=this._convertToPosition(this.value),r.addBehavior(this._createBehavior()),this._sliderThumbMaterial&&(r.material=this._sliderThumbMaterial),this._sliderThumb=r),this._injectGUI3DReservedDataStore(t).control=this,t.getChildMeshes().forEach((e=>{this._injectGUI3DReservedDataStore(e).control=this}))})),this._affectMaterial(t),t}_affectMaterial(e){this._sliderBackplateMaterial=this._sliderBackplateMaterial??new gc(`${this.name}_sliderbackplate_material`,e.getScene()),this._sliderBarMaterial=this._sliderBarMaterial??new _c(`${this.name}_sliderbar_material`,e.getScene()),this._sliderThumbMaterial=this._sliderThumbMaterial??new fc(`${this.name}_sliderthumb_material`,e.getScene())}_createBehavior(){const e=new hc({dragAxis:I.Pq.Right()});return e.moveAttached=!1,e.onDragStartObservable.add((()=>{this._draggedPosition=this._sliderThumb.position.x})),e.onDragObservable.add((e=>{this._draggedPosition+=e.dragDistance/this.scaling.x,this.value=this._convertToValue(this._draggedPosition)})),e}_convertToPosition(e){const t=(e-this.minimum)/(this.maximum-this.minimum)*(this.end-this.start)+this.start;return Math.min(Math.max(t,this.start),this.end)}_convertToValue(e){let t=(e-this.start)/(this.end-this.start)*(this.maximum-this.minimum);return t=this.step?Math.round(t/this.step)*this.step:t,Math.max(Math.min(this.minimum+t,this._maximum),this._minimum)}dispose(){super.dispose(),this._sliderBar?.dispose(),this._sliderThumb?.dispose(),this._sliderBarMaterial?.dispose(),this._sliderThumbMaterial?.dispose(),this._sliderBackplate?.dispose(),this._sliderBackplateMaterial?.dispose()}}vc.MODEL_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",vc.MODEL_FILENAME="mrtk-fluent-backplate.glb";class bc{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class xc{get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this.syncWithMask(!0))}syncWithMask(e=!1){if(this.mask||e){this._numActiveAnimatables=0;for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];!this.mask||this.mask.disabled||this.mask.retainsTarget(t.target.name)?(this._numActiveAnimatables++,t.paused&&t.restart()):t.paused||t.pause()}}else this._numActiveAnimatables=this._targetedAnimations.length}removeUnmaskedAnimations(){if(this.mask&&!this.mask.disabled){for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){const t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}set from(e){if(this._from!==e){this._from=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].fromFrame=this._from}}get to(){return this._to}set to(e){if(this._to!==e){this._to=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].toFrame=this._to}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].speedRatio=this._speedRatio}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].loopAnimation=this._loopAnimation}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].isAdditive=this._isAdditive}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let e=0;e<this._animatables.length;e++)this._animatables[e].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){return e=e??this._from,((t=t??this._to)-e)/(this.targetedAnimations[0].animation.framePerSecond*this._speedRatio)}static MergeAnimationGroups(e,t=!0,i=!1,s){if(0===e.length)return null;s=s??e[0].weight;let r=Number.MAX_VALUE,n=-Number.MAX_VALUE;if(i)for(const t of e)t.from<r&&(r=t.from),t.to>n&&(n=t.to);const a=new xc(e[0].name+"_merged",e[0]._scene,s);for(const s of e){i&&s.normalize(r,n);for(const e of s.targetedAnimations)a.addTargetedAnimation(e.animation,e.target);t&&s.dispose()}return a}constructor(e,i=null,s=-1,r=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._shouldStart=!0,this._parentContainer=null,this.onAnimationEndObservable=new C.cP,this.onAnimationLoopObservable=new C.cP,this.onAnimationGroupLoopObservable=new C.cP,this.onAnimationGroupEndObservable=new C.cP,this.onAnimationGroupPauseObservable=new C.cP,this.onAnimationGroupPlayObservable=new C.cP,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=i||t.q.LastCreatedScene,this._weight=s,this._playOrder=r,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new bc;i.animation=e,i.target=t;const s=e.getKeys();return this._from>s[0].frame&&(this._from=s[0].frame),this._to<s[s.length-1].frame&&(this._to=s[s.length-1].frame),null!==this._enableBlending&&(e.enableBlending=this._enableBlending),null!==this._blendingSpeed&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),this._shouldStart=!0,i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){null==e&&(e=this._from),null==t&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const s=this._targetedAnimations[i].animation.getKeys(),r=s[0],n=s[s.length-1];if(r.frame>e){const t={frame:e,value:r.value,inTangent:r.inTangent,outTangent:r.outTangent,interpolation:r.interpolation};s.splice(0,0,t)}if(n.frame<t){const e={frame:t,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};s.push(e)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),this._animationLoopFlags[i]||(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,s,r){if(this._isStarted||0===this._targetedAnimations.length)return this;this._loopAnimation=e,this._shouldStart=!1,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let n=0;n<this._targetedAnimations.length;n++){const a=this._targetedAnimations[n],o=this._scene.beginDirectAnimation(a.target,[a.animation],void 0!==i?i:this._from,void 0!==s?s:this._to,e,t,void 0,void 0,void 0!==r?r:this._isAdditive);o.weight=this._weight,o.playOrder=this._playOrder,o.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(a),this._checkAnimationGroupEnded(o)},this._processLoop(o,a,n),this._animatables.push(o)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length&&!this._shouldStart?(void 0!==e&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(!0),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.syncWithMask(),this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(e=!1){if(!this._isStarted)return this;const t=this._animatables.slice();for(let i=0;i<t.length;i++)t[i].stop(void 0,void 0,!0,e);let i=0;for(let t=0;t<this._scene._activeAnimatables.length;t++){const s=this._scene._activeAnimatables[t];s._runtimeAnimations.length>0?this._scene._activeAnimatables[i++]=s:e&&this._checkAnimationGroupEnded(s,e)}return this._scene._activeAnimatables.length=i,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].weight=e;return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}getCurrentFrame(){return this.animatables[0]?.masterFrame||0}dispose(){this.isStarted&&this.stop(),this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const e=this._parentContainer.animationGroups.indexOf(this);e>-1&&this._parentContainer.animationGroups.splice(e,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e,t=!1){const i=this._animatables.indexOf(e);i>-1&&this._animatables.splice(i,1),0===this._animatables.length&&(this._isStarted=!1,t||this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const s=new xc(e||this.name,this._scene,this._weight,this._playOrder);s._from=this.from,s._to=this.to,s._speedRatio=this.speedRatio,s._loopAnimation=this.loopAnimation,s._isAdditive=this.isAdditive,s._enableBlending=this.enableBlending,s._blendingSpeed=this.blendingSpeed,s.metadata=this.metadata,s.mask=this.mask;for(const e of this._targetedAnimations)s.addTargetedAnimation(i?e.animation.clone():e.animation,t?t(e.target):e.target);return s}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return Je.Y&&Je.Y.HasTags(this)&&(e.tags=Je.Y.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new xc(e.name,t,e.weight,e.playOrder);for(let s=0;s<e.targetedAnimations.length;s++){const r=e.targetedAnimations[s],n=Kt.Parse(r.animation),a=r.targetId;if("influence"===r.animation.property){const e=t.getMorphTargetById(a);e&&i.addTargetedAnimation(n,e)}else{const e=t.getNodeById(a);null!=e&&i.addTargetedAnimation(n,e)}}return Je.Y&&Je.Y.AddTagsTo(i,e.tags),null!==e.from&&null!==e.to&&i.normalize(e.from,e.to),void 0!==e.speedRatio&&(i._speedRatio=e.speedRatio),void 0!==e.loopAnimation&&(i._loopAnimation=e.loopAnimation),void 0!==e.isAdditive&&(i._isAdditive=e.isAdditive),void 0!==e.weight&&(i._weight=e.weight),void 0!==e.playOrder&&(i._playOrder=e.playOrder),void 0!==e.enableBlending&&(i._enableBlending=e.enableBlending),void 0!==e.blendingSpeed&&(i._blendingSpeed=e.blendingSpeed),void 0!==e.metadata&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t,i,s=!1,r){let n;n="object"==typeof t?t:{referenceFrame:t,range:i,cloneOriginalAnimationGroup:s,clonedAnimationName:r};let a=e;n.cloneOriginalAnimationGroup&&(a=e.clone(n.clonedAnimationGroupName||a.name));const o=a.targetedAnimations;for(let e=0;e<o.length;e++){const t=o[e];t.animation=Kt.MakeAnimationAdditive(t.animation,n)}if(a.isAdditive=!0,n.clipKeys){let e=Number.MAX_VALUE,t=-Number.MAX_VALUE;const i=a.targetedAnimations;for(let s=0;s<i.length;s++){const r=i[s].animation.getKeys();e>r[0].frame&&(e=r[0].frame),t<r[r.length-1].frame&&(t=r[r.length-1].frame)}a._from=e,a._to=t}return a}static ClipKeys(e,t,i,s,r){const n=e.clone(s||e.name);return xc.ClipKeysInPlace(n,t,i,r)}static ClipKeysInPlace(e,t,i,s){return xc.ClipInPlace(e,t,i,s,!1)}static ClipFrames(e,t,i,s,r){const n=e.clone(s||e.name);return xc.ClipFramesInPlace(n,t,i,r)}static ClipFramesInPlace(e,t,i,s){return xc.ClipInPlace(e,t,i,s,!0)}static ClipInPlace(e,t,i,s,r=!1){let n=Number.MAX_VALUE,a=-Number.MAX_VALUE;const o=e.targetedAnimations;for(let e=0;e<o.length;e++){const l=o[e],h=s?l.animation:l.animation.clone();r&&(h.createKeyForFrame(t),h.createKeyForFrame(i));const c=h.getKeys(),u=[];let d=Number.MAX_VALUE;for(let e=0;e<c.length;e++){const s=c[e];if(!r&&e>=t&&e<=i||r&&s.frame>=t&&s.frame<=i){const e={frame:s.frame,value:s.value.clone?s.value.clone():s.value,inTangent:s.inTangent,outTangent:s.outTangent,interpolation:s.interpolation,lockedTangent:s.lockedTangent};d===Number.MAX_VALUE&&(d=e.frame),e.frame-=d,u.push(e)}}0!==u.length?(n>u[0].frame&&(n=u[0].frame),a<u[u.length-1].frame&&(a=u[u.length-1].frame),h.setKeys(u,!0),l.animation=h):(o.splice(e,1),e--)}return e._from=n,e._to=a,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}ae.l.ShadersStore.mrdlBackglowPixelShader="uniform vec3 cameraPosition;varying vec3 vNormal;varying vec2 vUV;uniform float _Bevel_Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Tuning_Motion_;uniform float _Motion_;uniform float _Max_Intensity_;uniform float _Intensity_Fade_In_Exponent_;uniform float _Outer_Fuzz_Start_;uniform float _Outer_Fuzz_End_;uniform vec4 _Color_;uniform vec4 _Inner_Color_;uniform float _Blend_Exponent_;uniform float _Falloff_;uniform float _Bias_;float BiasFunc(float b,float v) {return pow(v,log(clamp(b,0.001,0.999))/log(0.5));}\nvoid Fuzzy_Round_Rect_B33(\nfloat Size_X,\nfloat Size_Y,\nfloat Radius_X,\nfloat Radius_Y,\nfloat Line_Width,\nvec2 UV,\nfloat Outer_Fuzz,\nfloat Max_Outer_Fuzz,\nout float Rect_Distance,\nout float Inner_Distance)\n{vec2 halfSize=vec2(Size_X,Size_Y)*0.5;vec2 r=max(min(vec2(Radius_X,Radius_Y),halfSize),vec2(0.001,0.001));float radius=min(r.x,r.y)-Max_Outer_Fuzz;vec2 v=abs(UV);vec2 nearestp=min(v,halfSize-r);float d=distance(nearestp,v);Inner_Distance=clamp(1.0-(radius-d)/Line_Width,0.0,1.0);Rect_Distance=clamp(1.0-(d-radius)/Outer_Fuzz,0.0,1.0)*Inner_Distance;}\nvoid main()\n{float X_Q42;float Y_Q42;X_Q42=vNormal.x;Y_Q42=vNormal.y;float MaxAB_Q24=max(_Tuning_Motion_,_Motion_);float Sqrt_F_Q27=sqrt(MaxAB_Q24);float Power_Q43=pow(MaxAB_Q24,_Intensity_Fade_In_Exponent_);float Value_At_T_Q26=mix(_Outer_Fuzz_Start_,_Outer_Fuzz_End_,Sqrt_F_Q27);float Product_Q23=_Max_Intensity_*Power_Q43;float Rect_Distance_Q33;float Inner_Distance_Q33;Fuzzy_Round_Rect_B33(X_Q42,Y_Q42,_Bevel_Radius_,_Bevel_Radius_,_Line_Width_,vUV,Value_At_T_Q26,_Outer_Fuzz_Start_,Rect_Distance_Q33,Inner_Distance_Q33);float Power_Q44=pow(Inner_Distance_Q33,_Blend_Exponent_);float Result_Q45=pow(BiasFunc(_Bias_,Rect_Distance_Q33),_Falloff_);vec4 Color_At_T_Q25=mix(_Inner_Color_,_Color_,Power_Q44);float Product_Q22=Result_Q45*Product_Q23;vec4 Result_Q28=Product_Q22*Color_At_T_Q25;vec4 Out_Color=Result_Q28;float Clip_Threshold=0.0;gl_FragColor=Out_Color;}";ae.l.ShadersStore.mrdlBackglowVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute vec3 tangent;uniform float _Bevel_Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Tuning_Motion_;uniform float _Motion_;uniform float _Max_Intensity_;uniform float _Intensity_Fade_In_Exponent_;uniform float _Outer_Fuzz_Start_;uniform float _Outer_Fuzz_End_;uniform vec4 _Color_;uniform vec4 _Inner_Color_;uniform float _Blend_Exponent_;uniform float _Falloff_;uniform float _Bias_;varying vec3 vNormal;varying vec2 vUV;void main()\n{vec3 Dir_World_Q41=(world*vec4(tangent,0.0)).xyz;vec3 Dir_World_Q40=(world*vec4((cross(normal,tangent)),0.0)).xyz;float MaxAB_Q24=max(_Tuning_Motion_,_Motion_);float Length_Q16=length(Dir_World_Q41);float Length_Q17=length(Dir_World_Q40);bool Greater_Than_Q37=MaxAB_Q24>0.0;vec3 Sizes_Q35;vec2 XY_Q35;Sizes_Q35=(_Absolute_Sizes_ ? vec3(Length_Q16,Length_Q17,0) : vec3(Length_Q16/Length_Q17,1,0));XY_Q35=(uv-vec2(0.5,0.5))*Sizes_Q35.xy;vec3 Result_Q38=Greater_Than_Q37 ? position : vec3(0,0,0);vec3 Pos_World_Q39=(world*vec4(Result_Q38,1.0)).xyz;vec3 Position=Pos_World_Q39;vec3 Normal=Sizes_Q35;vec2 UV=XY_Q35;vec3 Tangent=vec3(0,0,0);vec3 Binormal=vec3(0,0,0);vec4 Color=vec4(1,1,1,1);gl_Position=viewProjection*vec4(Position,1);vNormal=Normal;vUV=UV;}";class Sc extends ye.M{constructor(){super(),this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class Tc extends Ce{constructor(e,t){super(e,t),this.bevelRadius=.16,this.lineWidth=.16,this.absoluteSizes=!1,this.tuningMotion=0,this.motion=1,this.maxIntensity=.7,this.intensityFadeInExponent=2,this.outerFuzzStart=.04,this.outerFuzzEnd=.04,this.color=new M.ov(.682353,.698039,1,1),this.innerColor=new M.ov(.356863,.392157,.796078,1),this.blendExponent=1.5,this.falloff=2,this.bias=.5,this.alphaMode=Pa.Y.ALPHA_ADD,this.disableDepthWrite=!0,this.backFaceCulling=!1}needAlphaBlending(){return!0}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){const i=t._drawWrapper;if(this.isFrozen&&i.effect&&i._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new Sc);const s=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if((0,$.qB)(e,s,!1,!1),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial();const e=new K;s.FOG&&e.addFallback(1,"FOG"),(0,$.c4)(s,e),s.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess;const i=[O.R.PositionKind];s.NORMAL&&i.push(O.R.NormalKind),s.UV1&&i.push(O.R.UVKind),s.UV2&&i.push(O.R.UV2Kind),s.VERTEXCOLOR&&i.push(O.R.ColorKind),s.TANGENT&&i.push(O.R.TangentKind),(0,$.ER)(i,s);const a="mrdlBackglow",o=s.toString(),l=["world","worldView","worldViewProjection","view","projection","viewProjection","cameraPosition","_Bevel_Radius_","_Line_Width_","_Absolute_Sizes_","_Tuning_Motion_","_Motion_","_Max_Intensity_","_Intensity_Fade_In_Exponent_","_Outer_Fuzz_Start_","_Outer_Fuzz_End_","_Color_","_Inner_Color_","_Blend_Exponent_","_Falloff_","_Bias_"],h=[],c=[];(0,$.Bb)({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:s,maxSimultaneousLights:4}),t.setEffect(r.getEngine().createEffect(a,{attributes:i,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:o,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),s)}return!(!t.effect||!t.effect.isReady()||(s._renderId=r.getRenderId(),i._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){const s=this.getScene();if(!i.materialDefines)return;const r=i.effect;r&&(this._activeEffect=r,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",s.activeCamera.position),this._activeEffect.setFloat("_Bevel_Radius_",this.bevelRadius),this._activeEffect.setFloat("_Line_Width_",this.lineWidth),this._activeEffect.setFloat("_Absolute_Sizes_",this.absoluteSizes?1:0),this._activeEffect.setFloat("_Tuning_Motion_",this.tuningMotion),this._activeEffect.setFloat("_Motion_",this.motion),this._activeEffect.setFloat("_Max_Intensity_",this.maxIntensity),this._activeEffect.setFloat("_Intensity_Fade_In_Exponent_",this.intensityFadeInExponent),this._activeEffect.setFloat("_Outer_Fuzz_Start_",this.outerFuzzStart),this._activeEffect.setFloat("_Outer_Fuzz_End_",this.outerFuzzEnd),this._activeEffect.setDirectColor4("_Color_",this.color),this._activeEffect.setDirectColor4("_Inner_Color_",this.innerColor),this._activeEffect.setFloat("_Blend_Exponent_",this.blendExponent),this._activeEffect.setFloat("_Falloff_",this.falloff),this._activeEffect.setFloat("_Bias_",this.bias),this._afterBind(t,this._activeEffect,i))}getAnimatables(){return[]}dispose(e){super.dispose(e)}clone(e){return N.p.Clone((()=>new Tc(e,this.getScene())),this)}serialize(){const e=N.p.Serialize(this);return e.customType="BABYLON.MRDLBackglowMaterial",e}getClassName(){return"MRDLBackglowMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new Tc(e.name,t)),e,t,i)}}(0,w.Cg)([(0,D.lK)()],Tc.prototype,"bevelRadius",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"lineWidth",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"absoluteSizes",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"tuningMotion",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"motion",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"maxIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"intensityFadeInExponent",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"outerFuzzStart",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"outerFuzzEnd",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"color",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"innerColor",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"blendExponent",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"falloff",void 0),(0,w.Cg)([(0,D.lK)()],Tc.prototype,"bias",void 0),(0,V.Y5)("BABYLON.GUI.MRDLBackglowMaterial",Tc);ae.l.ShadersStore.mrdlFrontplatePixelShader="uniform vec3 cameraPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;uniform float _Radius_;uniform float _Line_Width_;uniform bool _Relative_To_Height_;uniform float _Filter_Width_;uniform vec4 _Edge_Color_;uniform float _Fade_Out_;uniform bool _Smooth_Edges_;uniform bool _Blob_Enable_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Inner_Fade_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform float _Blob_Pulse_Max_Size_;uniform bool _Blob_Enable_2_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Inner_Fade_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform float _Gaze_Intensity_;uniform float _Gaze_Focus_;uniform sampler2D _Blob_Texture_;uniform float _Selection_Fuzz_;uniform float _Selected_;uniform float _Selection_Fade_;uniform float _Selection_Fade_Size_;uniform float _Selected_Distance_;uniform float _Selected_Fade_Length_;uniform float _Proximity_Max_Intensity_;uniform float _Proximity_Far_Distance_;uniform float _Proximity_Near_Radius_;uniform float _Proximity_Anisotropy_;uniform bool _Use_Global_Left_Index_;uniform bool _Use_Global_Right_Index_;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;void Scale_Color_B54(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=Scalar*Color;}\nvoid Scale_RGB_B50(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Proximity_Fragment_B51(\nfloat Proximity_Max_Intensity,\nfloat Proximity_Near_Radius,\nvec4 Deltas,\nfloat Show_Selection,\nfloat Distance_Fade1,\nfloat Distance_Fade2,\nfloat Strength,\nout float Proximity)\n{float proximity1=(1.0-clamp(length(Deltas.xy)/Proximity_Near_Radius,0.0,1.0))*Distance_Fade1;float proximity2=(1.0-clamp(length(Deltas.zw)/Proximity_Near_Radius,0.0,1.0))*Distance_Fade2;Proximity=Strength*(Proximity_Max_Intensity*max(proximity1,proximity2) *(1.0-Show_Selection)+Show_Selection);}\nvoid Blob_Fragment_B56(\nvec2 UV,\nvec3 Blob_Info,\nsampler2D Blob_Texture,\nout vec4 Blob_Color)\n{float k=dot(UV,UV);Blob_Color=Blob_Info.y*texture(Blob_Texture,vec2(vec2(sqrt(k),Blob_Info.x).x,1.0-vec2(sqrt(k),Blob_Info.x).y))*(1.0-clamp(k,0.0,1.0));}\nvoid Round_Rect_Fragment_B61(\nfloat Radius,\nvec4 Line_Color,\nfloat Filter_Width,\nfloat Line_Visibility,\nvec4 Fill_Color,\nbool Smooth_Edges,\nvec4 Rect_Parms,\nout float Inside_Rect)\n{float d=length(max(abs(Rect_Parms.zw)-Rect_Parms.xy,0.0));float dx=max(fwidth(d)*Filter_Width,0.00001);Inside_Rect=Smooth_Edges ? clamp((Radius-d)/dx,0.0,1.0) : 1.0-step(Radius,d);}\nvoid main()\n{float Is_Quad_Q53;Is_Quad_Q53=vNormal.z;vec4 Blob_Color_Q56;Blob_Fragment_B56(vUV,vTangent,_Blob_Texture_,Blob_Color_Q56);float X_Q52;float Y_Q52;float Z_Q52;float W_Q52;X_Q52=vExtra3.x;Y_Q52=vExtra3.y;Z_Q52=vExtra3.z;W_Q52=vExtra3.w;float Proximity_Q51;Proximity_Fragment_B51(_Proximity_Max_Intensity_,_Proximity_Near_Radius_,vExtra2,X_Q52,Y_Q52,Z_Q52,1.0,Proximity_Q51);float Inside_Rect_Q61;Round_Rect_Fragment_B61(W_Q52,vec4(1,1,1,1),_Filter_Width_,1.0,vec4(0,0,0,0),_Smooth_Edges_,vExtra1,Inside_Rect_Q61);vec4 Result_Q50;Scale_RGB_B50(_Edge_Color_,Proximity_Q51,Result_Q50);vec4 Result_Q47=Inside_Rect_Q61*Blob_Color_Q56;vec4 Color_At_T_Q48=mix(Result_Q50,Result_Q47,Is_Quad_Q53);vec4 Result_Q54;Scale_Color_B54(Color_At_T_Q48,_Fade_Out_,Result_Q54);vec4 Out_Color=Result_Q54;float Clip_Threshold=0.001;bool To_sRGB=false;gl_FragColor=Out_Color;}";ae.l.ShadersStore.mrdlFrontplateVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute vec3 tangent;attribute vec4 color;uniform float _Radius_;uniform float _Line_Width_;uniform bool _Relative_To_Height_;uniform float _Filter_Width_;uniform vec4 _Edge_Color_;uniform float _Fade_Out_;uniform bool _Smooth_Edges_;uniform bool _Blob_Enable_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Inner_Fade_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform float _Blob_Pulse_Max_Size_;uniform bool _Blob_Enable_2_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Inner_Fade_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform float _Gaze_Intensity_;uniform float _Gaze_Focus_;uniform sampler2D _Blob_Texture_;uniform float _Selection_Fuzz_;uniform float _Selected_;uniform float _Selection_Fade_;uniform float _Selection_Fade_Size_;uniform float _Selected_Distance_;uniform float _Selected_Fade_Length_;uniform float _Proximity_Max_Intensity_;uniform float _Proximity_Far_Distance_;uniform float _Proximity_Near_Radius_;uniform float _Proximity_Anisotropy_;uniform bool _Use_Global_Left_Index_;uniform bool _Use_Global_Right_Index_;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;void Blob_Vertex_B40(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nvec4 Vx_Color,\nvec2 UV,\nvec3 Face_Center,\nvec2 Face_Size,\nvec2 In_UV,\nfloat Blob_Fade_Length,\nfloat Selection_Fade,\nfloat Selection_Fade_Size,\nfloat Inner_Fade,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nfloat Blob_Enabled,\nfloat DistanceOffset,\nout vec3 Out_Position,\nout vec2 Out_UV,\nout vec3 Blob_Info,\nout vec2 Blob_Relative_UV)\n{float blobSize,fadeIn;vec3 Hit_Position;Blob_Info=vec3(0.0,0.0,0.0);float Hit_Distance=dot(Blob_Position-Face_Center,Normal)+DistanceOffset*Blob_Far_Distance;Hit_Position=Blob_Position-Hit_Distance*Normal;float absD=abs(Hit_Distance);float lerpVal=clamp((absD-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);fadeIn=1.0-clamp((absD-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float innerFade=1.0-clamp(-Hit_Distance/Inner_Fade,0.0,1.0);float farClip=clamp(1.0-step(Blob_Far_Distance+Blob_Fade_Length,absD),0.0,1.0);float size=mix(Blob_Near_Size,Blob_Far_Size,lerpVal)*farClip;blobSize=mix(size,Selection_Fade_Size,Selection_Fade)*innerFade*Blob_Enabled;Blob_Info.x=lerpVal*0.5+0.5;Blob_Info.y=fadeIn*Intensity*(1.0-Selection_Fade)*Blob_Fade;Blob_Info.x*=(1.0-Blob_Pulse);vec3 delta=Hit_Position-Face_Center;vec2 blobCenterXY=vec2(dot(delta,Tangent),dot(delta,Bitangent));vec2 quadUVin=2.0*UV-1.0; \nvec2 blobXY=blobCenterXY+quadUVin*blobSize;vec2 blobClipped=clamp(blobXY,-Face_Size*0.5,Face_Size*0.5);vec2 blobUV=(blobClipped-blobCenterXY)/max(blobSize,0.0001)*2.0;vec3 blobCorner=Face_Center+blobClipped.x*Tangent+blobClipped.y*Bitangent;Out_Position=mix(Position,blobCorner,Vx_Color.rrr);Out_UV=mix(In_UV,blobUV,Vx_Color.rr);Blob_Relative_UV=blobClipped/Face_Size.y;}\nvoid Round_Rect_Vertex_B36(\nvec2 UV,\nvec3 Tangent,\nvec3 Binormal,\nfloat Radius,\nfloat Anisotropy,\nvec2 Blob_Center_UV,\nout vec2 Rect_UV,\nout vec2 Scale_XY,\nout vec4 Rect_Parms)\n{Scale_XY=vec2(Anisotropy,1.0);Rect_UV=(UV-vec2(0.5,0.5))*Scale_XY;Rect_Parms.xy=Scale_XY*0.5-vec2(Radius,Radius);Rect_Parms.zw=Blob_Center_UV;}\nvec2 ProjectProximity(\nvec3 blobPosition,\nvec3 position,\nvec3 center,\nvec3 dir,\nvec3 xdir,\nvec3 ydir,\nout float vdistance\n)\n{vec3 delta=blobPosition-position;vec2 xy=vec2(dot(delta,xdir),dot(delta,ydir));vdistance=abs(dot(delta,dir));return xy;}\nvoid Proximity_Vertex_B33(\nvec3 Blob_Position,\nvec3 Blob_Position_2,\nvec3 Face_Center,\nvec3 Position,\nfloat Proximity_Far_Distance,\nfloat Relative_Scale,\nfloat Proximity_Anisotropy,\nvec3 Normal,\nvec3 Tangent,\nvec3 Binormal,\nout vec4 Extra,\nout float Distance_To_Face,\nout float Distance_Fade1,\nout float Distance_Fade2)\n{float distz1,distz2;Extra.xy=ProjectProximity(Blob_Position,Position,Face_Center,Normal,Tangent*Proximity_Anisotropy,Binormal,distz1)/Relative_Scale;Extra.zw=ProjectProximity(Blob_Position_2,Position,Face_Center,Normal,Tangent*Proximity_Anisotropy,Binormal,distz2)/Relative_Scale;Distance_To_Face=dot(Normal,Position-Face_Center);Distance_Fade1=1.0-clamp(distz1/Proximity_Far_Distance,0.0,1.0);Distance_Fade2=1.0-clamp(distz2/Proximity_Far_Distance,0.0,1.0);}\nvoid Object_To_World_Pos_B12(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid Choose_Blob_B27(\nvec4 Vx_Color,\nvec3 Position1,\nvec3 Position2,\nbool Blob_Enable_1,\nbool Blob_Enable_2,\nfloat Near_Size_1,\nfloat Near_Size_2,\nfloat Blob_Inner_Fade_1,\nfloat Blob_Inner_Fade_2,\nfloat Blob_Pulse_1,\nfloat Blob_Pulse_2,\nfloat Blob_Fade_1,\nfloat Blob_Fade_2,\nout vec3 Position,\nout float Near_Size,\nout float Inner_Fade,\nout float Blob_Enable,\nout float Fade,\nout float Pulse)\n{Position=Position1*(1.0-Vx_Color.g)+Vx_Color.g*Position2;float b1=Blob_Enable_1 ? 1.0 : 0.0;float b2=Blob_Enable_2 ? 1.0 : 0.0;Blob_Enable=b1+(b2-b1)*Vx_Color.g;Pulse=Blob_Pulse_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Pulse_2;Fade=Blob_Fade_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Fade_2;Near_Size=Near_Size_1*(1.0-Vx_Color.g)+Vx_Color.g*Near_Size_2;Inner_Fade=Blob_Inner_Fade_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Inner_Fade_2;}\nvoid Move_Verts_B32(\nvec2 UV,\nfloat Radius,\nfloat Anisotropy,\nfloat Line_Width,\nfloat Visible,\nout vec3 New_P,\nout vec2 New_UV)\n{vec2 xy=2.0*UV-vec2(0.5,0.5);vec2 center=clamp(xy,0.0,1.0);vec2 delta=2.0*(xy-center);float deltaLength=length(delta);vec2 aniso=vec2(1.0/Anisotropy,1.0);center=(center-vec2(0.5,0.5))*(1.0-2.0*Radius*aniso);New_UV=vec2((2.0-2.0*deltaLength)*Visible,0.0);float deltaRadius= (Radius-Line_Width*New_UV.x);New_P.xy=(center+deltaRadius/deltaLength *aniso*delta);New_P.z=0.0;}\nvoid Object_To_World_Dir_B14(\nvec3 Dir_Object,\nout vec3 Binormal_World)\n{Binormal_World=(world*vec4(Dir_Object,0.0)).xyz;}\nvoid Proximity_Visibility_B55(\nfloat Selection,\nvec3 Proximity_Center,\nvec3 Proximity_Center_2,\nfloat Proximity_Far_Distance,\nfloat Proximity_Radius,\nvec3 Face_Center,\nvec3 Normal,\nvec2 Face_Size,\nfloat Gaze,\nout float Width)\n{float boxMaxSize=length(Face_Size)*0.5;float d1=dot(Proximity_Center-Face_Center,Normal);vec3 blob1=Proximity_Center-d1*Normal;float d2=dot(Proximity_Center_2-Face_Center,Normal);vec3 blob2=Proximity_Center_2-d2*Normal;vec3 delta1=blob1-Face_Center;vec3 delta2=blob2-Face_Center;float dist1=dot(delta1,delta1);float dist2=dot(delta2,delta2);float nearestProxDist=sqrt(min(dist1,dist2));Width=(1.0-step(boxMaxSize+Proximity_Radius,nearestProxDist))*(1.0-step(Proximity_Far_Distance,min(d1,d2))*(1.0-step(0.0001,Selection)));Width=max(Gaze,Width);}\nvec2 ramp2(vec2 start,vec2 end,vec2 x)\n{return clamp((x-start)/(end-start),vec2(0.0,0.0),vec2(1.0,1.0));}\nfloat computeSelection(\nvec3 blobPosition,\nvec3 normal,\nvec3 tangent,\nvec3 bitangent,\nvec3 faceCenter,\nvec2 faceSize,\nfloat selectionFuzz,\nfloat farDistance,\nfloat fadeLength\n)\n{vec3 delta=blobPosition-faceCenter;float absD=abs(dot(delta,normal));float fadeIn=1.0-clamp((absD-farDistance)/fadeLength,0.0,1.0);vec2 blobCenterXY=vec2(dot(delta,tangent),dot(delta,bitangent));vec2 innerFace=faceSize*(1.0-selectionFuzz)*0.5;vec2 selectPulse=ramp2(-faceSize*0.5,-innerFace,blobCenterXY)-ramp2(innerFace,faceSize*0.5,blobCenterXY);return selectPulse.x*selectPulse.y*fadeIn;}\nvoid Selection_Vertex_B31(\nvec3 Blob_Position,\nvec3 Blob_Position_2,\nvec3 Face_Center,\nvec2 Face_Size,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nfloat Selection_Fuzz,\nfloat Selected,\nfloat Far_Distance,\nfloat Fade_Length,\nvec3 Active_Face_Dir,\nout float Show_Selection)\n{float select1=computeSelection(Blob_Position,Normal,Tangent,Bitangent,Face_Center,Face_Size,Selection_Fuzz,Far_Distance,Fade_Length);float select2=computeSelection(Blob_Position_2,Normal,Tangent,Bitangent,Face_Center,Face_Size,Selection_Fuzz,Far_Distance,Fade_Length);Show_Selection=mix(max(select1,select2),1.0,Selected);}\nvoid main()\n{vec3 Vec3_Q29=vec3(vec2(0,0).x,vec2(0,0).y,color.r);vec3 Nrm_World_Q24;Nrm_World_Q24=normalize((world*vec4(normal,0.0)).xyz);vec3 Face_Center_Q30;Face_Center_Q30=(world*vec4(vec3(0,0,0),1.0)).xyz;vec3 Tangent_World_Q13;Tangent_World_Q13=(world*vec4(tangent,0.0)).xyz;vec3 Result_Q42;Result_Q42=_Use_Global_Left_Index_ ? Global_Left_Index_Tip_Position.xyz : _Blob_Position_;vec3 Result_Q43;Result_Q43=_Use_Global_Right_Index_ ? Global_Right_Index_Tip_Position.xyz : _Blob_Position_2_;float Value_At_T_Q58=mix(_Blob_Near_Size_,_Blob_Pulse_Max_Size_,_Blob_Pulse_);float Value_At_T_Q59=mix(_Blob_Near_Size_2_,_Blob_Pulse_Max_Size_,_Blob_Pulse_2_);vec3 Cross_Q70=cross(normal,tangent);float Product_Q45=_Gaze_Intensity_*_Gaze_Focus_;float Step_Q46=step(0.0001,Product_Q45);vec3 Tangent_World_N_Q15=normalize(Tangent_World_Q13);vec3 Position_Q27;float Near_Size_Q27;float Inner_Fade_Q27;float Blob_Enable_Q27;float Fade_Q27;float Pulse_Q27;Choose_Blob_B27(color,Result_Q42,Result_Q43,_Blob_Enable_,_Blob_Enable_2_,Value_At_T_Q58,Value_At_T_Q59,_Blob_Inner_Fade_,_Blob_Inner_Fade_2_,_Blob_Pulse_,_Blob_Pulse_2_,_Blob_Fade_,_Blob_Fade_2_,Position_Q27,Near_Size_Q27,Inner_Fade_Q27,Blob_Enable_Q27,Fade_Q27,Pulse_Q27);vec3 Binormal_World_Q14;Object_To_World_Dir_B14(Cross_Q70,Binormal_World_Q14);float Anisotropy_Q21=length(Tangent_World_Q13)/length(Binormal_World_Q14);vec3 Binormal_World_N_Q16=normalize(Binormal_World_Q14);vec2 Face_Size_Q35;float ScaleY_Q35;Face_Size_Q35=vec2(length(Tangent_World_Q13),length(Binormal_World_Q14));ScaleY_Q35=Face_Size_Q35.y;float Out_Radius_Q38;float Out_Line_Width_Q38;Out_Radius_Q38=_Relative_To_Height_ ? _Radius_ : _Radius_/ScaleY_Q35;Out_Line_Width_Q38=_Relative_To_Height_ ? _Line_Width_ : _Line_Width_/ScaleY_Q35;float Show_Selection_Q31;Selection_Vertex_B31(Result_Q42,Result_Q43,Face_Center_Q30,Face_Size_Q35,Nrm_World_Q24,Tangent_World_N_Q15,Binormal_World_N_Q16,_Selection_Fuzz_,_Selected_,_Selected_Distance_,_Selected_Fade_Length_,vec3(0,0,-1),Show_Selection_Q31);float MaxAB_Q41=max(Show_Selection_Q31,Product_Q45);float Width_Q55;Proximity_Visibility_B55(Show_Selection_Q31,Result_Q42,Result_Q43,_Proximity_Far_Distance_,_Proximity_Near_Radius_,Face_Center_Q30,Nrm_World_Q24,Face_Size_Q35,Step_Q46,Width_Q55);vec3 New_P_Q32;vec2 New_UV_Q32;Move_Verts_B32(uv,Out_Radius_Q38,Anisotropy_Q21,Out_Line_Width_Q38,Width_Q55,New_P_Q32,New_UV_Q32);vec3 Pos_World_Q12;Object_To_World_Pos_B12(New_P_Q32,Pos_World_Q12);vec3 Out_Position_Q40;vec2 Out_UV_Q40;vec3 Blob_Info_Q40;vec2 Blob_Relative_UV_Q40;Blob_Vertex_B40(Pos_World_Q12,Nrm_World_Q24,Tangent_World_N_Q15,Binormal_World_N_Q16,Position_Q27,_Blob_Intensity_,Near_Size_Q27,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,color,uv,Face_Center_Q30,Face_Size_Q35,New_UV_Q32,_Blob_Fade_Length_,_Selection_Fade_,_Selection_Fade_Size_,Inner_Fade_Q27,Pulse_Q27,Fade_Q27,Blob_Enable_Q27,0.0,Out_Position_Q40,Out_UV_Q40,Blob_Info_Q40,Blob_Relative_UV_Q40);vec2 Rect_UV_Q36;vec2 Scale_XY_Q36;vec4 Rect_Parms_Q36;Round_Rect_Vertex_B36(New_UV_Q32,Tangent_World_Q13,Binormal_World_Q14,Out_Radius_Q38,Anisotropy_Q21,Blob_Relative_UV_Q40,Rect_UV_Q36,Scale_XY_Q36,Rect_Parms_Q36);vec4 Extra_Q33;float Distance_To_Face_Q33;float Distance_Fade1_Q33;float Distance_Fade2_Q33;Proximity_Vertex_B33(Result_Q42,Result_Q43,Face_Center_Q30,Pos_World_Q12,_Proximity_Far_Distance_,1.0,_Proximity_Anisotropy_,Nrm_World_Q24,Tangent_World_N_Q15,Binormal_World_N_Q16,Extra_Q33,Distance_To_Face_Q33,Distance_Fade1_Q33,Distance_Fade2_Q33);vec4 Vec4_Q37=vec4(MaxAB_Q41,Distance_Fade1_Q33,Distance_Fade2_Q33,Out_Radius_Q38);vec3 Position=Out_Position_Q40;vec3 Normal=Vec3_Q29;vec2 UV=Out_UV_Q40;vec3 Tangent=Blob_Info_Q40;vec3 Binormal=vec3(0,0,0);vec4 Color=vec4(1,1,1,1);vec4 Extra1=Rect_Parms_Q36;vec4 Extra2=Extra_Q33;vec4 Extra3=Vec4_Q37;gl_Position=viewProjection*vec4(Position,1);vNormal=Normal;vUV=UV;vTangent=Tangent;vExtra1=Extra1;vExtra2=Extra2;vExtra3=Extra3;}";class yc extends ye.M{constructor(){super(),this.SMOOTH_EDGES=!0,this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class Cc extends Ce{constructor(e,t){super(e,t),this.radius=.12,this.lineWidth=.01,this.relativeToHeight=!1,this._filterWidth=1,this.edgeColor=new M.ov(.53,.53,.53,1),this.blobEnable=!0,this.blobPosition=new I.Pq(100,100,100),this.blobIntensity=.5,this.blobNearSize=.032,this.blobFarSize=.048,this.blobNearDistance=.008,this.blobFarDistance=.064,this.blobFadeLength=.04,this.blobInnerFade=.01,this.blobPulse=0,this.blobFade=1,this.blobPulseMaxSize=.05,this.blobEnable2=!0,this.blobPosition2=new I.Pq(10,10.1,-.6),this.blobNearSize2=.008,this.blobInnerFade2=.1,this.blobPulse2=0,this.blobFade2=1,this.gazeIntensity=.8,this.gazeFocus=0,this.selectionFuzz=.5,this.selected=1,this.selectionFade=.2,this.selectionFadeSize=0,this.selectedDistance=.08,this.selectedFadeLength=.08,this.proximityMaxIntensity=.45,this.proximityFarDistance=.16,this.proximityNearRadius=.016,this.proximityAnisotropy=1,this.useGlobalLeftIndex=!0,this.useGlobalRightIndex=!0,this.fadeOut=1,this.alphaMode=Pa.Y.ALPHA_ADD,this.disableDepthWrite=!0,this.backFaceCulling=!1,this._blobTexture=new G.g(Cc.BLOB_TEXTURE_URL,t,!0,!1,G.g.NEAREST_SAMPLINGMODE)}needAlphaBlending(){return!0}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){const i=t._drawWrapper;if(this.isFrozen&&i.effect&&i._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new yc);const s=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if((0,$.qB)(e,s,!1,!1),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial();const e=new K;s.FOG&&e.addFallback(1,"FOG"),(0,$.c4)(s,e),s.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess;const i=[O.R.PositionKind];s.NORMAL&&i.push(O.R.NormalKind),s.UV1&&i.push(O.R.UVKind),s.UV2&&i.push(O.R.UV2Kind),s.VERTEXCOLOR&&i.push(O.R.ColorKind),s.TANGENT&&i.push(O.R.TangentKind),(0,$.ER)(i,s);const a="mrdlFrontplate",o=s.toString(),l=["world","worldView","worldViewProjection","view","projection","viewProjection","cameraPosition","_Radius_","_Line_Width_","_Relative_To_Height_","_Filter_Width_","_Edge_Color_","_Fade_Out_","_Smooth_Edges_","_Blob_Enable_","_Blob_Position_","_Blob_Intensity_","_Blob_Near_Size_","_Blob_Far_Size_","_Blob_Near_Distance_","_Blob_Far_Distance_","_Blob_Fade_Length_","_Blob_Inner_Fade_","_Blob_Pulse_","_Blob_Fade_","_Blob_Pulse_Max_Size_","_Blob_Enable_2_","_Blob_Position_2_","_Blob_Near_Size_2_","_Blob_Inner_Fade_2_","_Blob_Pulse_2_","_Blob_Fade_2_","_Gaze_Intensity_","_Gaze_Focus_","_Blob_Texture_","_Selection_Fuzz_","_Selected_","_Selection_Fade_","_Selection_Fade_Size_","_Selected_Distance_","_Selected_Fade_Length_","_Proximity_Max_Intensity_","_Proximity_Far_Distance_","_Proximity_Near_Radius_","_Proximity_Anisotropy_","Global_Left_Index_Tip_Position","Global_Right_Index_Tip_Position","_Use_Global_Left_Index_","_Use_Global_Right_Index_"],h=[],c=[];(0,$.Bb)({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:s,maxSimultaneousLights:4}),t.setEffect(r.getEngine().createEffect(a,{attributes:i,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:o,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),s)}return!(!t.effect||!t.effect.isReady()||(s._renderId=r.getRenderId(),i._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){const s=this.getScene();if(!i.materialDefines)return;const r=i.effect;r&&(this._activeEffect=r,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",s.activeCamera.position),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Line_Width_",this.lineWidth),this._activeEffect.setFloat("_Relative_To_Height_",this.relativeToHeight?1:0),this._activeEffect.setFloat("_Filter_Width_",this._filterWidth),this._activeEffect.setDirectColor4("_Edge_Color_",this.edgeColor),this._activeEffect.setFloat("_Fade_Out_",this.fadeOut),this._activeEffect.setFloat("_Blob_Enable_",this.blobEnable?1:0),this._activeEffect.setVector3("_Blob_Position_",this.blobPosition),this._activeEffect.setFloat("_Blob_Intensity_",this.blobIntensity),this._activeEffect.setFloat("_Blob_Near_Size_",this.blobNearSize),this._activeEffect.setFloat("_Blob_Far_Size_",this.blobFarSize),this._activeEffect.setFloat("_Blob_Near_Distance_",this.blobNearDistance),this._activeEffect.setFloat("_Blob_Far_Distance_",this.blobFarDistance),this._activeEffect.setFloat("_Blob_Fade_Length_",this.blobFadeLength),this._activeEffect.setFloat("_Blob_Inner_Fade_",this.blobInnerFade),this._activeEffect.setFloat("_Blob_Pulse_",this.blobPulse),this._activeEffect.setFloat("_Blob_Fade_",this.blobFade),this._activeEffect.setFloat("_Blob_Pulse_Max_Size_",this.blobPulseMaxSize),this._activeEffect.setFloat("_Blob_Enable_2_",this.blobEnable2?1:0),this._activeEffect.setVector3("_Blob_Position_2_",this.blobPosition2),this._activeEffect.setFloat("_Blob_Near_Size_2_",this.blobNearSize2),this._activeEffect.setFloat("_Blob_Inner_Fade_2_",this.blobInnerFade2),this._activeEffect.setFloat("_Blob_Pulse_2_",this.blobPulse2),this._activeEffect.setFloat("_Blob_Fade_2_",this.blobFade2),this._activeEffect.setFloat("_Gaze_Intensity_",this.gazeIntensity),this._activeEffect.setFloat("_Gaze_Focus_",this.gazeFocus),this._activeEffect.setTexture("_Blob_Texture_",this._blobTexture),this._activeEffect.setFloat("_Selection_Fuzz_",this.selectionFuzz),this._activeEffect.setFloat("_Selected_",this.selected),this._activeEffect.setFloat("_Selection_Fade_",this.selectionFade),this._activeEffect.setFloat("_Selection_Fade_Size_",this.selectionFadeSize),this._activeEffect.setFloat("_Selected_Distance_",this.selectedDistance),this._activeEffect.setFloat("_Selected_Fade_Length_",this.selectedFadeLength),this._activeEffect.setFloat("_Proximity_Max_Intensity_",this.proximityMaxIntensity),this._activeEffect.setFloat("_Proximity_Far_Distance_",this.proximityFarDistance),this._activeEffect.setFloat("_Proximity_Near_Radius_",this.proximityNearRadius),this._activeEffect.setFloat("_Proximity_Anisotropy_",this.proximityAnisotropy),this._activeEffect.setFloat("_Use_Global_Left_Index_",this.useGlobalLeftIndex?1:0),this._activeEffect.setFloat("_Use_Global_Right_Index_",this.useGlobalRightIndex?1:0),this._afterBind(t,this._activeEffect,i))}getAnimatables(){return[]}dispose(e){super.dispose(e)}clone(e){return N.p.Clone((()=>new Cc(e,this.getScene())),this)}serialize(){const e=N.p.Serialize(this);return e.customType="BABYLON.MRDLFrontplateMaterial",e}getClassName(){return"MRDLFrontplateMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new Cc(e.name,t)),e,t,i)}}Cc.BLOB_TEXTURE_URL="",(0,w.Cg)([(0,D.lK)()],Cc.prototype,"radius",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"lineWidth",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"relativeToHeight",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"edgeColor",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobEnable",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobPosition",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobNearSize",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobFarSize",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobNearDistance",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobFarDistance",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobFadeLength",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobInnerFade",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobPulse",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobFade",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobPulseMaxSize",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobEnable2",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobPosition2",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobNearSize2",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobInnerFade2",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobPulse2",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"blobFade2",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"gazeIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"gazeFocus",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"selectionFuzz",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"selected",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"selectionFade",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"selectionFadeSize",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"selectedDistance",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"selectedFadeLength",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"proximityMaxIntensity",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"proximityFarDistance",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"proximityNearRadius",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"proximityAnisotropy",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"useGlobalLeftIndex",void 0),(0,w.Cg)([(0,D.lK)()],Cc.prototype,"useGlobalRightIndex",void 0),(0,V.Y5)("BABYLON.GUI.MRDLFrontplateMaterial",Cc);ae.l.ShadersStore.mrdlInnerquadPixelShader="uniform vec3 cameraPosition;varying vec2 vUV;varying vec3 vTangent;uniform vec4 _Color_;uniform float _Radius_;uniform bool _Fixed_Radius_;uniform float _Filter_Width_;uniform float _Glow_Fraction_;uniform float _Glow_Max_;uniform float _Glow_Falloff_;float FilterStep_Bid194(float edge,float x,float filterWidth)\n{float dx=max(1.0E-5,fwidth(x)*filterWidth);return max((x+dx*0.5-max(edge,x-dx*0.5))/dx,0.0);}\nvoid Round_Rect_B194(\nfloat Size_X,\nfloat Size_Y,\nfloat Radius,\nvec4 Rect_Color,\nfloat Filter_Width,\nvec2 UV,\nfloat Glow_Fraction,\nfloat Glow_Max,\nfloat Glow_Falloff,\nout vec4 Color)\n{vec2 halfSize=vec2(Size_X,Size_Y)*0.5;vec2 r=max(min(vec2(Radius,Radius),halfSize),vec2(0.01,0.01));vec2 v=abs(UV);vec2 nearestp=min(v,halfSize-r);vec2 delta=(v-nearestp)/max(vec2(0.01,0.01),r);float Distance=length(delta);float insideRect=1.0-FilterStep_Bid194(1.0-Glow_Fraction,Distance,Filter_Width);float glow=clamp((1.0-Distance)/Glow_Fraction,0.0,1.0);glow=pow(glow,Glow_Falloff);Color=Rect_Color*max(insideRect,glow*Glow_Max);}\nvoid main()\n{float X_Q192;float Y_Q192;float Z_Q192;X_Q192=vTangent.x;Y_Q192=vTangent.y;Z_Q192=vTangent.z;vec4 Color_Q194;Round_Rect_B194(X_Q192,1.0,Y_Q192,_Color_,_Filter_Width_,vUV,_Glow_Fraction_,_Glow_Max_,_Glow_Falloff_,Color_Q194);vec4 Out_Color=Color_Q194;float Clip_Threshold=0.0;gl_FragColor=Out_Color;}\n";ae.l.ShadersStore.mrdlInnerquadVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute vec3 tangent;attribute vec4 color;uniform vec4 _Color_;uniform float _Radius_;uniform bool _Fixed_Radius_;uniform float _Filter_Width_;uniform float _Glow_Fraction_;uniform float _Glow_Max_;uniform float _Glow_Falloff_;varying vec2 vUV;varying vec3 vTangent;void main()\n{vec3 Pos_World_Q189;Pos_World_Q189=(world*vec4(position,1.0)).xyz;vec3 Dir_World_Q190;Dir_World_Q190=(world*vec4(tangent,0.0)).xyz;vec3 Dir_World_Q191;Dir_World_Q191=(world*vec4((cross(normal,tangent)),0.0)).xyz;float Length_Q180=length(Dir_World_Q190);float Length_Q181=length(Dir_World_Q191);float Quotient_Q184=Length_Q180/Length_Q181;float Quotient_Q195=_Radius_/Length_Q181;vec2 Result_Q193;Result_Q193=vec2((uv.x-0.5)*Length_Q180/Length_Q181,(uv.y-0.5));float Result_Q198=_Fixed_Radius_ ? Quotient_Q195 : _Radius_;vec3 Vec3_Q183=vec3(Quotient_Q184,Result_Q198,0);vec3 Position=Pos_World_Q189;vec3 Normal=vec3(0,0,0);vec2 UV=Result_Q193;vec3 Tangent=Vec3_Q183;vec3 Binormal=vec3(0,0,0);vec4 Color=color;gl_Position=viewProjection*vec4(Position,1);vUV=UV;vTangent=Tangent;}\n";class Pc extends ye.M{constructor(){super(),this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class Ec extends Ce{constructor(e,t){super(e,t),this.color=new M.ov(1,1,1,.05),this.radius=.12,this.fixedRadius=!0,this._filterWidth=1,this.glowFraction=0,this.glowMax=.5,this.glowFalloff=2,this.alphaMode=Pa.Y.ALPHA_COMBINE,this.backFaceCulling=!1}needAlphaBlending(){return!0}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){const i=t._drawWrapper;if(this.isFrozen&&i.effect&&i._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new Pc);const s=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=r.getEngine();if((0,$.qB)(e,s,!0,!1),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial();const e=new K;s.FOG&&e.addFallback(1,"FOG"),(0,$.c4)(s,e),s.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess;const i=[O.R.PositionKind];s.NORMAL&&i.push(O.R.NormalKind),s.UV1&&i.push(O.R.UVKind),s.UV2&&i.push(O.R.UV2Kind),s.VERTEXCOLOR&&i.push(O.R.ColorKind),s.TANGENT&&i.push(O.R.TangentKind),(0,$.ER)(i,s);const a="mrdlInnerquad",o=s.toString(),l=["world","worldView","worldViewProjection","view","projection","viewProjection","cameraPosition","_Color_","_Radius_","_Fixed_Radius_","_Filter_Width_","_Glow_Fraction_","_Glow_Max_","_Glow_Falloff_"],h=[],c=[];(0,$.Bb)({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:s,maxSimultaneousLights:4}),t.setEffect(r.getEngine().createEffect(a,{attributes:i,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:o,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),s)}return!(!t.effect||!t.effect.isReady()||(s._renderId=r.getRenderId(),i._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){const s=this.getScene();if(!i.materialDefines)return;const r=i.effect;r&&(this._activeEffect=r,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",s.activeCamera.position),this._activeEffect.setDirectColor4("_Color_",this.color),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Fixed_Radius_",this.fixedRadius?1:0),this._activeEffect.setFloat("_Filter_Width_",this._filterWidth),this._activeEffect.setFloat("_Glow_Fraction_",this.glowFraction),this._activeEffect.setFloat("_Glow_Max_",this.glowMax),this._activeEffect.setFloat("_Glow_Falloff_",this.glowFalloff),this._afterBind(t,this._activeEffect,i))}getAnimatables(){return[]}dispose(e){super.dispose(e)}clone(e){return N.p.Clone((()=>new Ec(e,this.getScene())),this)}serialize(){const e=N.p.Serialize(this);return e.customType="BABYLON.MRDLInnerquadMaterial",e}getClassName(){return"MRDLInnerquadMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new Ec(e.name,t)),e,t,i)}}(0,w.Cg)([(0,D.lK)()],Ec.prototype,"color",void 0),(0,w.Cg)([(0,D.lK)()],Ec.prototype,"radius",void 0),(0,w.Cg)([(0,D.lK)()],Ec.prototype,"fixedRadius",void 0),(0,w.Cg)([(0,D.lK)()],Ec.prototype,"glowFraction",void 0),(0,w.Cg)([(0,D.lK)()],Ec.prototype,"glowMax",void 0),(0,w.Cg)([(0,D.lK)()],Ec.prototype,"glowFalloff",void 0),(0,V.Y5)("BABYLON.GUI.MRDLInnerquadMaterial",Ec);class Ac extends Wh{_disposeTooltip(){this._tooltipFade=null,this._tooltipTextBlock&&this._tooltipTextBlock.dispose(),this._tooltipTexture&&this._tooltipTexture.dispose(),this._tooltipMesh&&this._tooltipMesh.dispose(),this.onPointerEnterObservable.remove(this._tooltipHoverObserver),this.onPointerOutObservable.remove(this._tooltipOutObserver)}set renderingGroupId(e){this._backPlate.renderingGroupId=e,this._textPlate.renderingGroupId=e,this._frontPlate.renderingGroupId=e,this._backGlow.renderingGroupId=e,this._innerQuad.renderingGroupId=e,this._tooltipMesh&&(this._tooltipMesh.renderingGroupId=e)}get renderingGroupId(){return this._backPlate.renderingGroupId}get mesh(){return this._backPlate}set tooltipText(e){if(e){if(!this._tooltipFade){const e=this._backPlate._scene.useRightHandedSystem;this._tooltipMesh=_i("",{size:1},this._backPlate._scene),this._tooltipMesh.position=I.Pq.Down().scale(.7).add(I.Pq.Forward(e).scale(-.15)),this._tooltipMesh.isPickable=!1,this._tooltipMesh.parent=this._frontPlateCollisionMesh,this._tooltipTexture=Ch.CreateForMesh(this._tooltipMesh);const t=new Ql;t.height=.25,t.width=.8,t.cornerRadius=25,t.color="#ffffff",t.thickness=20,t.background="#060668",this._tooltipTexture.addControl(t),this._tooltipTextBlock=new ql,this._tooltipTextBlock.color="white",this._tooltipTextBlock.fontSize=100,this._tooltipTexture.addControl(this._tooltipTextBlock),this._tooltipFade=new zh,this._tooltipFade.delay=500,this._tooltipMesh.addBehavior(this._tooltipFade),this._tooltipHoverObserver=this.onPointerEnterObservable.add((()=>{this._tooltipFade&&this._tooltipFade.fadeIn(!0)})),this._tooltipOutObserver=this.onPointerOutObservable.add((()=>{this._tooltipFade&&this._tooltipFade.fadeIn(!1)}))}this._tooltipTextBlock&&(this._tooltipTextBlock.text=e)}else this._disposeTooltip()}get tooltipText(){return this._tooltipTextBlock?.text||null}get text(){return this._text}set text(e){this._text!==e&&(this._text=e,this._rebuildContent())}get subtext(){return this._subtext}set subtext(e){this._subtext!==e&&(this._subtext=e,this._rebuildContent())}get imageUrl(){return this._imageUrl}set imageUrl(e){this._imageUrl!==e&&(this._imageUrl=e,this._rebuildContent())}get backMaterial(){return this._backMaterial}get frontMaterial(){return this._frontMaterial}get backGlowMaterial(){return this._backGlowMaterial}get innerQuadMaterial(){return this._innerQuadMaterial}get plateMaterial(){return this._plateMaterial}get shareMaterials(){return this._shareMaterials}set isBackplateVisible(e){this.mesh&&this._backMaterial&&(e&&!this._isBackplateVisible?this._backPlate.visibility=1:!e&&this._isBackplateVisible&&(this._backPlate.visibility=0)),this._isBackplateVisible=e}constructor(e,t=!0){super(e),this.width=1,this.height=1,this.radius=.14,this.textSizeInPixels=18,this.imageSizeInPixels=40,this.plateMaterialColor=new M.v9(.4,.4,.4),this.frontPlateDepth=.2,this.backPlateDepth=.04,this.backGlowOffset=.1,this.flatPlaneDepth=.001,this.innerQuadRadius=this.radius-.04,this.innerQuadColor=new M.ov(0,0,0,0),this.innerQuadToggledColor=new M.ov(.5197843,.6485234,.9607843,.6),this.innerQuadHoverColor=new M.ov(1,1,1,.05),this.innerQuadToggledHoverColor=new M.ov(.5197843,.6485234,.9607843,1),this._isBackplateVisible=!0,this._shareMaterials=!0,this._shareMaterials=t,this.pointerEnterAnimation=()=>{this._frontPlate&&this._textPlate&&!this.isToggleButton&&this._performEnterExitAnimation(1),this.isToggleButton&&this._innerQuadMaterial&&(this.isToggled?this._innerQuadMaterial.color=this.innerQuadToggledHoverColor:this._innerQuadMaterial.color=this.innerQuadHoverColor)},this.pointerOutAnimation=()=>{this._frontPlate&&this._textPlate&&!this.isToggleButton&&this._performEnterExitAnimation(-.8),this.isToggleButton&&this._innerQuadMaterial&&this._onToggle(this.isToggled)},this.pointerDownAnimation=()=>{},this.pointerUpAnimation=()=>{},this._pointerClickObserver=this.onPointerClickObservable.add((()=>{this._frontPlate&&this._backGlow&&!this.isActiveNearInteraction&&this._performClickAnimation(),this.isToggleButton&&this._innerQuadMaterial&&this._onToggle(this.isToggled)})),this._pointerEnterObserver=this.onPointerEnterObservable.add((()=>{this.pointerEnterAnimation()})),this._pointerOutObserver=this.onPointerOutObservable.add((()=>{this.pointerOutAnimation()})),this._toggleObserver=this.onToggleObservable.add((e=>{this._innerQuadMaterial.color=e?this.innerQuadToggledColor:this.innerQuadColor}))}_getTypeName(){return"TouchHolographicButton"}_rebuildContent(){let e;e=this._getAspectRatio()<=1?this._alignContentVertically():this._alignContentHorizontally(),this.content=e}_getAspectRatio(){return this.width/this.height}_alignContentVertically(){const e=new Zl;if(e.isVertical=!0,(0,S.Nf)()&&document.createElement&&this._imageUrl){const t=new $l;t.source=this._imageUrl,t.heightInPixels=180,t.widthInPixels=100,t.paddingTopInPixels=40,t.paddingBottomInPixels=40,e.addControl(t)}if(this._text){const t=new ql;t.text=this._text,t.color="white",t.heightInPixels=30,t.fontSize=24,e.addControl(t)}return e}_alignContentHorizontally(){let e=240;const t=15,i=new Ql;i.widthInPixels=e,i.heightInPixels=e,i.color="transparent",i.setPaddingInPixels(t,t,t,t),e-=30;const s=new Zl;if(s.isVertical=!1,s.scaleY=this._getAspectRatio(),(0,S.Nf)()&&document.createElement&&this._imageUrl){const t=new Ql(`${this.name}_image`);t.widthInPixels=this.imageSizeInPixels,t.heightInPixels=this.imageSizeInPixels,t.color="transparent",e-=this.imageSizeInPixels;const i=new $l;i.source=this._imageUrl,t.addControl(i),s.addControl(t)}if(this._text){const i=new ql(`${this.name}_text`);if(i.text=this._text,i.color="white",i.fontSize=this.textSizeInPixels,i.widthInPixels=e,this._imageUrl&&(i.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,i.paddingLeftInPixels=t),this._subtext){const r=new rh;r.addColumnDefinition(1),r.addRowDefinition(.5),r.addRowDefinition(.5),r.widthInPixels=e,r.heightInPixels=45;const n=new ql(`${this.name}_subtext`);n.text=this._subtext,n.color="#EEEEEEAB",n.fontSize=.75*this.textSizeInPixels,n.fontWeight="600",this._imageUrl&&(n.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,n.paddingLeftInPixels=t),r.addControl(i,0),r.addControl(n,1),s.addControl(r)}else s.addControl(i)}return i.addControl(s),i}_createNode(e){this.name=this.name??"TouchHolographicButton";const t=this._createBackPlate(e),i=this._createFrontPlate(e),s=this._createInnerQuad(e),r=this._createBackGlow(e);this._frontPlateCollisionMesh=i,this._textPlate=super._createNode(e),this._textPlate.name=`${this.name}_textPlate`,this._textPlate.isPickable=!1,this._textPlate.scaling.x=this.width,this._textPlate.parent=i,this._backPlate=t,this._backPlate.position=I.Pq.Forward(e.useRightHandedSystem).scale(this.backPlateDepth/2),this._backPlate.isPickable=!1,this._backPlate.addChild(i),this._backPlate.addChild(s),r&&this._backPlate.addChild(r);const n=new dt(`${this.name}_root`,e);return this._backPlate.setParent(n),this.collisionMesh=i,this.collidableFrontDirection=this._backPlate.forward.negate(),n}_createBackPlate(e){const t=xi(`${this.name}_backPlate`,{},e);return t.isPickable=!1,t.visibility=0,t.scaling.z=.2,er.ImportMeshAsync(void 0,Ac.MRTK_ASSET_BASE_URL,Ac.BACKPLATE_MODEL_FILENAME,e).then((e=>{const i=e.meshes[1];i.visibility=0,this._isBackplateVisible&&(i.visibility=1,i.name=`${this.name}_backPlate`,i.isPickable=!1,i.scaling.x=this.width,i.scaling.y=this.height,i.parent=t),this._backMaterial&&(i.material=this._backMaterial),this._backPlate=i})),t}_createFrontPlate(e){const t=xi(`${this.name}_frontPlate`,{width:this.width,height:this.height,depth:this.frontPlateDepth},e);return t.isPickable=!0,t.isNearPickable=!0,t.visibility=0,t.position=I.Pq.Forward(e.useRightHandedSystem).scale((this.backPlateDepth-this.frontPlateDepth)/2),er.ImportMeshAsync(void 0,Ac.MRTK_ASSET_BASE_URL,Ac.FRONTPLATE_MODEL_FILENAME,e).then((i=>{const s=xi(`${this.name}_collisionPlate`,{width:this.width,height:this.height},e);s.isPickable=!1,s.scaling.z=this.frontPlateDepth,s.visibility=0,s.parent=t,this._collisionPlate=s;const r=i.meshes[1];r.name=`${this.name}_frontPlate`,r.isPickable=!1,r.scaling.x=this.width-this.backGlowOffset,r.scaling.y=this.height-this.backGlowOffset,r.position=I.Pq.Forward(e.useRightHandedSystem).scale(-.5),r.parent=s,this.isToggleButton&&(r.visibility=0),this._frontMaterial&&(r.material=this._frontMaterial),this._textPlate.scaling.x=1,this._textPlate.parent=r,this._frontPlate=r})),t}_createInnerQuad(e){const t=xi(`${this.name}_innerQuad`,{},e);return t.isPickable=!1,t.visibility=0,t.scaling.z=this.flatPlaneDepth,t.position.z+=this.backPlateDepth/2-this.flatPlaneDepth,er.ImportMeshAsync(void 0,Ac.MRTK_ASSET_BASE_URL,Ac.INNERQUAD_MODEL_FILENAME,e).then((e=>{const i=e.meshes[1];i.name=`${this.name}_innerQuad`,i.isPickable=!1,i.scaling.x=this.width-this.backGlowOffset,i.scaling.y=this.height-this.backGlowOffset,i.parent=t,this._innerQuadMaterial&&(i.material=this._innerQuadMaterial),this._innerQuad=i})),t}_createBackGlow(e){if(this.isToggleButton)return;const t=xi(`${this.name}_backGlow`,{},e);return t.isPickable=!1,t.visibility=0,t.scaling.z=this.flatPlaneDepth,t.position.z+=this.backPlateDepth/2-2*this.flatPlaneDepth,er.ImportMeshAsync(void 0,Ac.MRTK_ASSET_BASE_URL,Ac.BACKGLOW_MODEL_FILENAME,e).then((e=>{const i=e.meshes[1];i.name=`${this.name}_backGlow`,i.isPickable=!1,i.scaling.x=this.width-this.backGlowOffset,i.scaling.y=this.height-this.backGlowOffset,i.parent=t,this._backGlowMaterial&&(i.material=this._backGlowMaterial),this._backGlow=i})),t}_applyFacade(e){this._plateMaterial.emissiveTexture=e,this._plateMaterial.opacityTexture=e,this._plateMaterial.diffuseColor=this.plateMaterialColor}_performClickAnimation(){const e=new xc("Click Animation Group"),t=[{name:"backGlowMotion",mesh:this._backGlow,property:"material.motion",keys:[{frame:0,values:[0,0,0]},{frame:20,values:[1,.0144,.0144]},{frame:40,values:[.0027713229489760476,0,0]},{frame:45,values:[.0027713229489760476]}]},{name:"_collisionPlateZSlide",mesh:this._collisionPlate,property:"position.z",keys:[{frame:0,values:[0,0,0]},{frame:20,values:[I.Pq.Forward(this._collisionPlate._scene.useRightHandedSystem).scale(this.frontPlateDepth/2).z,0,0]},{frame:40,values:[0,.005403332496794331]},{frame:45,values:[0]}]},{name:"_collisionPlateZScale",mesh:this._collisionPlate,property:"scaling.z",keys:[{frame:0,values:[this.frontPlateDepth,0,0]},{frame:20,values:[this.backPlateDepth,0,0]},{frame:40,values:[this.frontPlateDepth,.0054]},{frame:45,values:[this.frontPlateDepth]}]}];for(const i of t){const t=new Kt(i.name,i.property,60,Kt.ANIMATIONTYPE_FLOAT,Kt.ANIMATIONLOOPMODE_CYCLE),s=[];for(const e of i.keys)s.push({frame:e.frame,value:e.values[0],inTangent:e.values[1],outTangent:e.values[2],interpolation:e.values[3]});t.setKeys(s),i.mesh&&e.addTargetedAnimation(t,i.mesh)}e.normalize(0,45),e.speedRatio=1,e.play()}_performEnterExitAnimation(e){const t=new xc("Enter Exit Animation Group"),i=[{name:"frontPlateFadeOut",mesh:this._frontPlate,property:"material.fadeOut",keys:[{frame:0,values:[0,0,.025045314830017686,0]},{frame:40,values:[1.00205599570012,.025045314830017686,0,0]}]},{name:"textPlateZSlide",mesh:this._textPlate,property:"position.z",keys:[{frame:0,values:[0,0,0]},{frame:40,values:[I.Pq.Forward(this._textPlate._scene.useRightHandedSystem).scale(-.15).z,0,0]}]}];for(const e of i){const i=new Kt(e.name,e.property,60,Kt.ANIMATIONTYPE_FLOAT,Kt.ANIMATIONLOOPMODE_CYCLE),s=[];for(const t of e.keys)s.push({frame:t.frame,value:t.values[0],inTangent:t.values[1],outTangent:t.values[2],interpolation:t.values[3]});i.setKeys(s),e.mesh&&t.addTargetedAnimation(i,e.mesh)}t.normalize(0,45),t.speedRatio=e,t.play()}_createBackMaterial(e){this._backMaterial=this._backMaterial??new gc(this.name+"backPlateMaterial",e.getScene()),this._backMaterial.absoluteSizes=!0,this._backMaterial.radius=this.radius,this._backMaterial.lineWidth=.02}_createFrontMaterial(e){this._frontMaterial=this._frontMaterial??new Cc(this.name+"Front Material",e.getScene()),this.frontMaterial.radius=this.innerQuadRadius,this.frontMaterial.fadeOut=0}_createBackGlowMaterial(e){const t=this.radius+.04;this._backGlowMaterial=this._backGlowMaterial??new Tc(this.name+"Back Glow Material",e.getScene()),this._backGlowMaterial.bevelRadius=t,this._backGlowMaterial.lineWidth=t,this._backGlowMaterial.motion=0}_createInnerQuadMaterial(e){this._innerQuadMaterial=this._innerQuadMaterial??new Ec("inner_quad",e.getScene()),this._innerQuadMaterial.radius=this.innerQuadRadius,this.isToggleButton&&(this._innerQuadMaterial.color=this.innerQuadColor)}_createPlateMaterial(e){this._plateMaterial=this._plateMaterial??new Oe(this.name+"Plate Material",e.getScene()),this._plateMaterial.specularColor=M.v9.Black()}_onToggle(e){super._onToggle(e)}_affectMaterial(e){this._shareMaterials?(this._host._touchSharedMaterials.mrdlBackplateMaterial?this._backMaterial=this._host._touchSharedMaterials.mrdlBackplateMaterial:(this._createBackMaterial(e),this._host._touchSharedMaterials.mrdlBackplateMaterial=this._backMaterial),this._host._touchSharedMaterials.mrdlFrontplateMaterial?this._frontMaterial=this._host._touchSharedMaterials.mrdlFrontplateMaterial:(this._createFrontMaterial(e),this._host._touchSharedMaterials.mrdlFrontplateMaterial=this._frontMaterial),this._host._touchSharedMaterials.mrdlBackglowMaterial?this._backGlowMaterial=this._host._touchSharedMaterials.mrdlBackglowMaterial:(this._createBackGlowMaterial(e),this._host._touchSharedMaterials.mrdlBackglowMaterial=this._backGlowMaterial),this._host._touchSharedMaterials.mrdlInnerQuadMaterial?this._innerQuadMaterial=this._host._touchSharedMaterials.mrdlInnerQuadMaterial:(this._createInnerQuadMaterial(e),this._host._touchSharedMaterials.mrdlInnerQuadMaterial=this._innerQuadMaterial)):(this._createBackMaterial(e),this._createFrontMaterial(e),this._createBackGlowMaterial(e),this._createInnerQuadMaterial(e)),this._createPlateMaterial(e),this._backPlate.material=this._backMaterial,this._textPlate.material=this._plateMaterial,this._isBackplateVisible||(this._backPlate.visibility=0),this._frontPlate&&(this._frontPlate.material=this._frontMaterial),this._backGlow&&(this._backGlow.material=this._backGlowMaterial),this._innerQuad&&(this._innerQuad.material=this._innerQuadMaterial),this._rebuildContent()}dispose(){super.dispose(),this._disposeTooltip(),this.onPointerClickObservable.remove(this._pointerClickObserver),this.onPointerEnterObservable.remove(this._pointerEnterObserver),this.onPointerOutObservable.remove(this._pointerOutObserver),this.onToggleObservable.remove(this._toggleObserver),this.shareMaterials||(this._backMaterial.dispose(),this._frontMaterial.dispose(),this._plateMaterial.dispose(),this._backGlowMaterial.dispose(),this._innerQuadMaterial.dispose(),this._pickedPointObserver&&(this._host.onPickedPointChangedObservable.remove(this._pickedPointObserver),this._pickedPointObserver=null))}}Ac.MRTK_ASSET_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",Ac.FRONTPLATE_MODEL_FILENAME="mrtk-fluent-frontplate.glb",Ac.BACKPLATE_MODEL_FILENAME="mrtk-fluent-backplate.glb",Ac.BACKGLOW_MODEL_FILENAME="mrtk-fluent-button.glb",Ac.INNERQUAD_MODEL_FILENAME="SlateProximity.glb";class Rc{get scene(){return this._scene}get utilityLayer(){return this._utilityLayer}get controlScaling(){return this._customControlScaling}set controlScaling(e){if(this._customControlScaling!==e&&e>0){const t=e/this._customControlScaling;this._customControlScaling=e,this._rootContainer.children.forEach((i=>{i.scaling.scaleInPlace(t),1!==e&&(i._isScaledByManager=!0)}))}}get useRealisticScaling(){return this.controlScaling===Rc.MRTK_REALISTIC_SCALING}set useRealisticScaling(e){this.controlScaling=e?Rc.MRTK_REALISTIC_SCALING:1}constructor(e){this._customControlScaling=1,this._lastControlOver={},this._lastControlDown={},this.onPickedPointChangedObservable=new C.cP,this.onPickingObservable=new C.cP,this._sharedMaterials={},this._touchSharedMaterials={},this._scene=e||t.q.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add((()=>{this._sceneDisposeObserver=null,this._utilityLayer=null,this.dispose()})),this._utilityLayer=fr._CreateDefaultUtilityLayerFromScene(this._scene),this._utilityLayer.onlyCheckPointerDownEvents=!1,this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.mainSceneTrackerPredicate=e=>e&&e.reservedDataStore?.GUI3D?.control?._node,this._rootContainer=new Mh("RootContainer"),this._rootContainer._host=this;const i=this._utilityLayer.utilityLayerScene;this._pointerOutObserver=this._utilityLayer.onPointerOutObservable.add((e=>{this._handlePointerOut(e,!0)})),this._pointerObserver=i.onPointerObservable.add((e=>{this._doPicking(e)})),this._utilityLayer.utilityLayerScene.autoClear=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,new je("hemi",I.Pq.Up(),this._utilityLayer.utilityLayerScene)}_handlePointerOut(e,t){const i=this._lastControlOver[e];i&&(i._onPointerOut(i),delete this._lastControlOver[e]),t&&this._lastControlDown[e]&&(this._lastControlDown[e].forcePointerUp(),delete this._lastControlDown[e]),this.onPickedPointChangedObservable.notifyObservers(null)}_doPicking(e){if(!this._utilityLayer||!this._utilityLayer.shouldRender||!this._utilityLayer.utilityLayerScene.activeCamera)return!1;const t=e.event,i=t.pointerId||0,s=t.button,r=e.pickInfo;if(r&&this.onPickingObservable.notifyObservers(r.pickedMesh),!r||!r.hit)return this._handlePointerOut(i,e.type===Rt.Zp.POINTERUP),!1;r.pickedPoint&&this.onPickedPointChangedObservable.notifyObservers(r.pickedPoint);const n=r.pickedMesh.reservedDataStore?.GUI3D?.control;return n&&!n._processObservables(e.type,r.pickedPoint,r.originMesh?.position||null,i,s)&&e.type===Rt.Zp.POINTERMOVE&&(this._lastControlOver[i]&&this._lastControlOver[i]._onPointerOut(this._lastControlOver[i]),delete this._lastControlOver[i]),e.type===Rt.Zp.POINTERUP&&(this._lastControlDown[t.pointerId]&&(this._lastControlDown[t.pointerId].forcePointerUp(),delete this._lastControlDown[t.pointerId]),("touch"===t.pointerType||"xr"===t.pointerType&&this._scene.getEngine().hostInformation.isMobile)&&this._handlePointerOut(i,!1)),!0}get rootContainer(){return this._rootContainer}containsControl(e){return this._rootContainer.containsControl(e)}addControl(e){return this._rootContainer.addControl(e),1!==this._customControlScaling&&(e.scaling.scaleInPlace(this._customControlScaling),e._isScaledByManager=!0),this}removeControl(e){return this._rootContainer.removeControl(e),e._isScaledByManager&&(e.scaling.scaleInPlace(1/this._customControlScaling),e._isScaledByManager=!1),this}dispose(){this._rootContainer.dispose();for(const e in this._sharedMaterials)Object.prototype.hasOwnProperty.call(this._sharedMaterials,e)&&this._sharedMaterials[e].dispose();this._sharedMaterials={};for(const e in this._touchSharedMaterials)Object.prototype.hasOwnProperty.call(this._touchSharedMaterials,e)&&this._touchSharedMaterials[e].dispose();this._touchSharedMaterials={},this._pointerOutObserver&&this._utilityLayer&&(this._utilityLayer.onPointerOutObservable.remove(this._pointerOutObserver),this._pointerOutObserver=null),this.onPickedPointChangedObservable.clear(),this.onPickingObservable.clear();const e=this._utilityLayer?this._utilityLayer.utilityLayerScene:null;e&&this._pointerObserver&&(e.onPointerObservable.remove(this._pointerObserver),this._pointerObserver=null),this._scene&&this._sceneDisposeObserver&&(this._scene.onDisposeObservable.remove(this._sceneDisposeObserver),this._sceneDisposeObserver=null),this._utilityLayer&&this._utilityLayer.dispose()}}var Ic;Rc.MRTK_REALISTIC_SCALING=.032;const Mc=(Ic="file:///C:/Users/vinch/Documents/Vincent/Genshin/MMD/model-viewer/node_modules/@babylonjs/havok/lib/esm/HavokPhysics_es.js",function(e){var t,i,s=void 0!==(e=e||{})?e:{};s.ready=new Promise((function(e,s){t=e,i=s}));var n,a=Object.assign({},s),o=[],l=(e,t)=>{throw t},h="";"undefined"!=typeof document&&document.currentScript&&(h=document.currentScript.src),Ic&&(h=Ic),h=0!==h.indexOf("blob:")?h.substr(0,h.replace(/[?#].*/,"").lastIndexOf("/")+1):"";var c=s.print||console.log.bind(console),u=s.printErr||console.warn.bind(console);Object.assign(s,a),a=null,s.arguments&&(o=s.arguments),s.thisProgram&&s.thisProgram,s.quit&&(l=s.quit);var d;s.wasmBinary&&(d=s.wasmBinary);var _,p=s.noExitRuntime||!0;"object"!=typeof WebAssembly&&V("no native wasm support detected");var f,m,g,v,b,x,S,T,y,C,P,E,A=!1,R="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function I(e,t,i){for(var s=t+i,r=t;e[r]&&!(r>=s);)++r;if(r-t>16&&e.buffer&&R)return R.decode(e.subarray(t,r));for(var n="";t<r;){var a=e[t++];if(128&a){var o=63&e[t++];if(192!=(224&a)){var l=63&e[t++];if((a=224==(240&a)?(15&a)<<12|o<<6|l:(7&a)<<18|o<<12|l<<6|63&e[t++])<65536)n+=String.fromCharCode(a);else{var h=a-65536;n+=String.fromCharCode(55296|h>>10,56320|1023&h)}}else n+=String.fromCharCode((31&a)<<6|o)}else n+=String.fromCharCode(a)}return n}function M(e){m=e,s.HEAP8=g=new Int8Array(e),s.HEAP16=b=new Int16Array(e),s.HEAP32=S=new Int32Array(e),s.HEAPU8=v=new Uint8Array(e),s.HEAPU16=x=new Uint16Array(e),s.HEAPU32=T=new Uint32Array(e),s.HEAPF32=y=new Float32Array(e),s.HEAPF64=E=new Float64Array(e),s.HEAP64=C=new BigInt64Array(e),s.HEAPU64=P=new BigUint64Array(e)}s.INITIAL_MEMORY;var O,w=[],D=[],F=[],N=[],L=0,B=null,k=null;function V(e){s.onAbort&&s.onAbort(e),u(e="Aborted("+e+")"),A=!0,f=1,e+=". Build with -sASSERTIONS for more info.";var t=new WebAssembly.RuntimeError(e);throw i(t),t}var U,z;function G(e){return e.startsWith("data:application/octet-stream;base64,")}function H(e){try{if(e==U&&d)return new Uint8Array(d);if(n)return n(e);throw"both async and sync fetching of the wasm failed"}catch(e){V(e)}}function W(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function X(e){for(;e.length>0;)e.shift()(s)}s.locateFile?G(U="HavokPhysics.wasm")||(z=U,U=s.locateFile?s.locateFile(z,h):h+z):U=new URL(r(3311),r.b).toString();var K={};function Q(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function Y(e){return this.fromWireType(S[e>>2])}var q={},$={},j={},Z=48,J=57;function ee(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=Z&&t<=J?"_"+e:e}function te(e,t){return e=ee(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function ie(e,t){var i=te(t,(function(e){this.name=t,this.message=e;var i=new Error(e).stack;void 0!==i&&(this.stack=this.toString()+"\n"+i.replace(/^Error(:[^\n]*)?\n/,""))}));return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},i}var se=void 0;function re(e){throw new se(e)}function ne(e,t,i){function s(t){var s=i(t);s.length!==e.length&&re("Mismatched type converter count");for(var r=0;r<e.length;++r)ue(e[r],s[r])}e.forEach((function(e){j[e]=t}));var r=new Array(t.length),n=[],a=0;t.forEach(((e,t)=>{$.hasOwnProperty(e)?r[t]=$[e]:(n.push(e),q.hasOwnProperty(e)||(q[e]=[]),q[e].push((()=>{r[t]=$[e],++a===n.length&&s(r)})))})),0===n.length&&s(r)}function ae(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}var oe=void 0;function le(e){for(var t="",i=e;v[i];)t+=oe[v[i++]];return t}var he=void 0;function ce(e){throw new he(e)}function ue(e,t,i={}){if(!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var s=t.name;if(e||ce('type "'+s+'" must have a positive integer typeid pointer'),$.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;ce("Cannot register type '"+s+"' twice")}if($[e]=t,delete j[e],q.hasOwnProperty(e)){var r=q[e];delete q[e],r.forEach((e=>e()))}}function de(e,t,i){switch(t){case 0:return i?function(e){return g[e]}:function(e){return v[e]};case 1:return i?function(e){return b[e>>1]}:function(e){return x[e>>1]};case 2:return i?function(e){return S[e>>2]}:function(e){return T[e>>2]};case 3:return i?function(e){return C[e>>3]}:function(e){return P[e>>3]};default:throw new TypeError("Unknown integer type: "+e)}}function _e(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var pe=[],fe=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function me(e){e>4&&0==--fe[e].refcount&&(fe[e]=void 0,pe.push(e))}var ge=e=>(e||ce("Cannot use deleted val. handle = "+e),fe[e].value);function ve(e,t,i){s.hasOwnProperty(e)?((void 0===i||void 0!==s[e].overloadTable&&void 0!==s[e].overloadTable[i])&&ce("Cannot register public name '"+e+"' twice"),function(e,t,i){if(void 0===e[t].overloadTable){var s=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||ce("Function '"+i+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[s.argCount]=s}}(s,e,e),s.hasOwnProperty(i)&&ce("Cannot register multiple overloads of a function with the same number of arguments ("+i+")!"),s[e].overloadTable[i]=t):(s[e]=t,void 0!==i&&(s[e].numArguments=i))}function be(e,t,i){switch(t){case 0:return function(e){var t=i?g:v;return this.fromWireType(t[e])};case 1:return function(e){var t=i?b:x;return this.fromWireType(t[e>>1])};case 2:return function(e){var t=i?S:T;return this.fromWireType(t[e>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function xe(e){var t=Xe(e),i=le(t);return We(t),i}function Se(e,t){var i=$[e];return void 0===i&&ce(t+" has unknown type "+xe(e)),i}function Te(e,t){switch(t){case 2:return function(e){return this.fromWireType(y[e>>2])};case 3:return function(e){return this.fromWireType(E[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function ye(e,t){if(!(e instanceof Function))throw new TypeError("new_ called with constructor type "+typeof e+" which is not a function");var i=te(e.name||"unknownFunctionName",(function(){}));i.prototype=e.prototype;var s=new i,r=e.apply(s,t);return r instanceof Object?r:s}var Ce=[];function Pe(e,t){e=le(e);var i,s,r=((s=Ce[i=t])||(i>=Ce.length&&(Ce.length=i+1),Ce[i]=s=O.get(i)),s);return"function"!=typeof r&&ce("unknown function pointer with signature "+e+": "+t),r}var Ee=void 0,Ae="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function Re(e,t){for(var i=e,s=i>>1,r=s+t/2;!(s>=r)&&x[s];)++s;if((i=s<<1)-e>32&&Ae)return Ae.decode(v.subarray(e,i));for(var n="",a=0;!(a>=t/2);++a){var o=b[e+2*a>>1];if(0==o)break;n+=String.fromCharCode(o)}return n}function Ie(e,t,i){if(void 0===i&&(i=2147483647),i<2)return 0;for(var s=t,r=(i-=2)<2*e.length?i/2:e.length,n=0;n<r;++n){var a=e.charCodeAt(n);b[t>>1]=a,t+=2}return b[t>>1]=0,t-s}function Me(e){return 2*e.length}function Oe(e,t){for(var i=0,s="";!(i>=t/4);){var r=S[e+4*i>>2];if(0==r)break;if(++i,r>=65536){var n=r-65536;s+=String.fromCharCode(55296|n>>10,56320|1023&n)}else s+=String.fromCharCode(r)}return s}function we(e,t,i){if(void 0===i&&(i=2147483647),i<4)return 0;for(var s=t,r=s+i-4,n=0;n<e.length;++n){var a=e.charCodeAt(n);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++n)),S[t>>2]=a,(t+=4)+4>r)break}return S[t>>2]=0,t-s}function De(e){for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s>=55296&&s<=57343&&++i,t+=4}return t}var Fe,Ne={},Le=[],Be=[];function ke(e){try{return _.grow(e-m.byteLength+65535>>>16),M(_.buffer),1}catch(e){}}Fe=()=>performance.now();var Ve=[null,[],[]];function Ue(e,t){var i=Ve[e];0===t||10===t?((1===e?c:u)(I(i,0)),i.length=0):i.push(t)}se=s.InternalError=ie(Error,"InternalError"),function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);oe=e}(),he=s.BindingError=ie(Error,"BindingError"),s.count_emval_handles=function(){for(var e=0,t=5;t<fe.length;++t)void 0!==fe[t]&&++e;return e},s.get_first_emval=function(){for(var e=5;e<fe.length;++e)if(void 0!==fe[e])return fe[e];return null},Ee=s.UnboundTypeError=ie(Error,"UnboundTypeError");var ze,Ge={_embind_finalize_value_array:function(e){var t=K[e];delete K[e];var i=t.elements,s=i.length,r=i.map((function(e){return e.getterReturnType})).concat(i.map((function(e){return e.setterArgumentType}))),n=t.rawConstructor,a=t.rawDestructor;ne([e],r,(function(e){return i.forEach(((t,i)=>{var r=e[i],n=t.getter,a=t.getterContext,o=e[i+s],l=t.setter,h=t.setterContext;t.read=e=>r.fromWireType(n(a,e)),t.write=(e,t)=>{var i=[];l(h,e,o.toWireType(i,t)),Q(i)}})),[{name:t.name,fromWireType:function(e){for(var t=new Array(s),r=0;r<s;++r)t[r]=i[r].read(e);return a(e),t},toWireType:function(e,r){if(s!==r.length)throw new TypeError("Incorrect number of tuple elements for "+t.name+": expected="+s+", actual="+r.length);for(var o=n(),l=0;l<s;++l)i[l].write(o,r[l]);return null!==e&&e.push(a,o),o},argPackAdvance:8,readValueFromPointer:Y,destructorFunction:a}]}))},_embind_register_bigint:function(e,t,i,s,r){t=le(t);var n=_e(i),a=-1!=t.indexOf("u");a&&(r=(1n<<64n)-1n),ue(e,{name:t,fromWireType:function(e){return e},toWireType:function(e,i){if("bigint"!=typeof i&&"number"!=typeof i)throw new TypeError('Cannot convert "'+ae(i)+'" to '+this.name);if(i<s||i>r)throw new TypeError('Passing a number "'+ae(i)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+s+", "+r+"]!");return i},argPackAdvance:8,readValueFromPointer:de(t,n,!a),destructorFunction:null})},_embind_register_bool:function(e,t,i,s,r){var n=_e(i);ue(e,{name:t=le(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?s:r},argPackAdvance:8,readValueFromPointer:function(e){var s;if(1===i)s=g;else if(2===i)s=b;else{if(4!==i)throw new TypeError("Unknown boolean type size: "+t);s=S}return this.fromWireType(s[e>>n])},destructorFunction:null})},_embind_register_emval:function(e,t){ue(e,{name:t=le(t),fromWireType:function(e){var t=ge(e);return me(e),t},toWireType:function(e,t){return(e=>{switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=pe.length?pe.pop():fe.length;return fe[t]={refcount:1,value:e},t}})(t)},argPackAdvance:8,readValueFromPointer:Y,destructorFunction:null})},_embind_register_enum:function(e,t,i,s){var r=_e(i);function n(){}t=le(t),n.values={},ue(e,{name:t,constructor:n,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:be(t,r,s),destructorFunction:null}),ve(t,n)},_embind_register_enum_value:function(e,t,i){var s=Se(e,"enum");t=le(t);var r=s.constructor,n=Object.create(s.constructor.prototype,{value:{value:i},constructor:{value:te(s.name+"_"+t,(function(){}))}});r.values[i]=n,r[t]=n},_embind_register_float:function(e,t,i){var s=_e(i);ue(e,{name:t=le(t),fromWireType:function(e){return e},toWireType:function(e,t){return t},argPackAdvance:8,readValueFromPointer:Te(t,s),destructorFunction:null})},_embind_register_function:function(e,t,i,r,n,a){var o=function(e,t){for(var i=[],s=0;s<e;s++)i.push(T[t+4*s>>2]);return i}(t,i);e=le(e),n=Pe(r,n),ve(e,(function(){!function(e,t){var i=[],s={};throw t.forEach((function e(t){s[t]||$[t]||(j[t]?j[t].forEach(e):(i.push(t),s[t]=!0))})),new Ee(e+": "+i.map(xe).join([", "]))}("Cannot call "+e+" due to unbound types",o)}),t-1),ne([],o,(function(i){var r=[i[0],null].concat(i.slice(1));return function(e,t,i){s.hasOwnProperty(e)||re("Replacing nonexistant public symbol"),void 0!==s[e].overloadTable&&void 0!==i?s[e].overloadTable[i]=t:(s[e]=t,s[e].argCount=i)}(e,function(e,t,i,s,r){var n=t.length;n<2&&ce("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var a=null!==t[1]&&!1,o=!1,l=1;l<t.length;++l)if(null!==t[l]&&void 0===t[l].destructorFunction){o=!0;break}var h="void"!==t[0].name,c="",u="";for(l=0;l<n-2;++l)c+=(0!==l?", ":"")+"arg"+l,u+=(0!==l?", ":"")+"arg"+l+"Wired";var d="return function "+ee(e)+"("+c+") {\nif (arguments.length !== "+(n-2)+") {\nthrowBindingError('function "+e+" called with ' + arguments.length + ' arguments, expected "+(n-2)+" args!');\n}\n";o&&(d+="var destructors = [];\n");var _=o?"destructors":"null",p=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],f=[ce,s,r,Q,t[0],t[1]];for(a&&(d+="var thisWired = classParam.toWireType("+_+", this);\n"),l=0;l<n-2;++l)d+="var arg"+l+"Wired = argType"+l+".toWireType("+_+", arg"+l+"); // "+t[l+2].name+"\n",p.push("argType"+l),f.push(t[l+2]);if(a&&(u="thisWired"+(u.length>0?", ":"")+u),d+=(h?"var rv = ":"")+"invoker(fn"+(u.length>0?", ":"")+u+");\n",o)d+="runDestructors(destructors);\n";else for(l=a?1:2;l<t.length;++l){var m=1===l?"thisWired":"arg"+(l-2)+"Wired";null!==t[l].destructorFunction&&(d+=m+"_dtor("+m+"); // "+t[l].name+"\n",p.push(m+"_dtor"),f.push(t[l].destructorFunction))}return h&&(d+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),d+="}\n",p.push(d),ye(Function,p).apply(null,f)}(e,r,0,n,a),t-1),[]}))},_embind_register_integer:function(e,t,i,s,r){t=le(t),-1===r&&(r=4294967295);var n=_e(i),a=e=>e;if(0===s){var o=32-8*i;a=e=>e<<o>>>o}var l=t.includes("unsigned");ue(e,{name:t,fromWireType:a,toWireType:l?function(e,t){return this.name,t>>>0}:function(e,t){return this.name,t},argPackAdvance:8,readValueFromPointer:de(t,n,0!==s),destructorFunction:null})},_embind_register_memory_view:function(e,t,i){var s=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,BigInt64Array,BigUint64Array][t];function r(e){var t=T,i=t[e>>=2],r=t[e+1];return new s(m,r,i)}ue(e,{name:i=le(i),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0})},_embind_register_std_string:function(e,t){var i="std::string"===(t=le(t));ue(e,{name:t,fromWireType:function(e){var t,s,r,n=T[e>>2],a=e+4;if(i)for(var o=a,l=0;l<=n;++l){var h=a+l;if(l==n||0==v[h]){var c=(r=h-o,(s=o)?I(v,s,r):"");void 0===t?t=c:(t+=String.fromCharCode(0),t+=c),o=h+1}}else{var u=new Array(n);for(l=0;l<n;++l)u[l]=String.fromCharCode(v[a+l]);t=u.join("")}return We(e),t},toWireType:function(e,t){var s;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||ce("Cannot pass non-string to std::string"),s=i&&r?function(e){for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s<=127?t++:s<=2047?t+=2:s>=55296&&s<=57343?(t+=4,++i):t+=3}return t}(t):t.length;var n=He(4+s+1),a=n+4;if(T[n>>2]=s,i&&r)!function(e,t,i,s){if(!(s>0))return 0;for(var r=i+s-1,n=0;n<e.length;++n){var a=e.charCodeAt(n);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++n)),a<=127){if(i>=r)break;t[i++]=a}else if(a<=2047){if(i+1>=r)break;t[i++]=192|a>>6,t[i++]=128|63&a}else if(a<=65535){if(i+2>=r)break;t[i++]=224|a>>12,t[i++]=128|a>>6&63,t[i++]=128|63&a}else{if(i+3>=r)break;t[i++]=240|a>>18,t[i++]=128|a>>12&63,t[i++]=128|a>>6&63,t[i++]=128|63&a}}t[i]=0}(t,v,a,s+1);else if(r)for(var o=0;o<s;++o){var l=t.charCodeAt(o);l>255&&(We(a),ce("String has UTF-16 code units that do not fit in 8 bits")),v[a+o]=l}else for(o=0;o<s;++o)v[a+o]=t[o];return null!==e&&e.push(We,n),n},argPackAdvance:8,readValueFromPointer:Y,destructorFunction:function(e){We(e)}})},_embind_register_std_wstring:function(e,t,i){var s,r,n,a,o;i=le(i),2===t?(s=Re,r=Ie,a=Me,n=()=>x,o=1):4===t&&(s=Oe,r=we,a=De,n=()=>T,o=2),ue(e,{name:i,fromWireType:function(e){for(var i,r=T[e>>2],a=n(),l=e+4,h=0;h<=r;++h){var c=e+4+h*t;if(h==r||0==a[c>>o]){var u=s(l,c-l);void 0===i?i=u:(i+=String.fromCharCode(0),i+=u),l=c+t}}return We(e),i},toWireType:function(e,s){"string"!=typeof s&&ce("Cannot pass non-string to C++ string type "+i);var n=a(s),l=He(4+n+t);return T[l>>2]=n>>o,r(s,l+4,n+t),null!==e&&e.push(We,l),l},argPackAdvance:8,readValueFromPointer:Y,destructorFunction:function(e){We(e)}})},_embind_register_value_array:function(e,t,i,s,r,n){K[e]={name:le(t),rawConstructor:Pe(i,s),rawDestructor:Pe(r,n),elements:[]}},_embind_register_value_array_element:function(e,t,i,s,r,n,a,o,l){K[e].elements.push({getterReturnType:t,getter:Pe(i,s),getterContext:r,setterArgumentType:n,setter:Pe(a,o),setterContext:l})},_embind_register_void:function(e,t){ue(e,{isVoid:!0,name:t=le(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},_emscripten_get_now_is_monotonic:function(){return!0},_emval_call_void_method:function(e,t,i,s){var r,n;(e=Le[e])(t=ge(t),i=void 0===(n=Ne[r=i])?le(r):n,null,s)},_emval_decref:me,_emval_get_method_caller:function(e,t){var i=function(e,t){for(var i=new Array(e),s=0;s<e;++s)i[s]=Se(T[t+4*s>>2],"parameter "+s);return i}(e,t),s=i[0],r=s.name+"_$"+i.slice(1).map((function(e){return e.name})).join("_")+"$",n=Be[r];if(void 0!==n)return n;for(var a=["retType"],o=[s],l="",h=0;h<e-1;++h)l+=(0!==h?", ":"")+"arg"+h,a.push("argType"+h),o.push(i[1+h]);var c,u,d="return function "+ee("methodCaller_"+r)+"(handle, name, destructors, args) {\n",_=0;for(h=0;h<e-1;++h)d+="    var arg"+h+" = argType"+h+".readValueFromPointer(args"+(_?"+"+_:"")+");\n",_+=i[h+1].argPackAdvance;for(d+="    var rv = handle[name]("+l+");\n",h=0;h<e-1;++h)i[h+1].deleteObject&&(d+="    argType"+h+".deleteObject(arg"+h+");\n");return s.isVoid||(d+="    return retType.toWireType(destructors, rv);\n"),d+="};\n",a.push(d),c=ye(Function,a).apply(null,o),u=Le.length,Le.push(c),n=u,Be[r]=n,n},abort:function(){V("")},emscripten_date_now:function(){return Date.now()},emscripten_get_heap_max:function(){return 2147483648},emscripten_get_now:Fe,emscripten_memcpy_big:function(e,t,i){v.copyWithin(e,t,t+i)},emscripten_resize_heap:function(e){var t,i=v.length,s=2147483648;if((e>>>=0)>s)return!1;for(var r=1;r<=4;r*=2){var n=i*(1+.2/r);if(n=Math.min(n,e+100663296),ke(Math.min(s,(t=Math.max(e,n))+(65536-t%65536)%65536)))return!0}return!1},fd_write:function(e,t,i,s){for(var r=0,n=0;n<i;n++){var a=T[t>>2],o=T[t+4>>2];t+=8;for(var l=0;l<o;l++)Ue(e,v[a+l]);r+=o}return T[s>>2]=r,0}},He=(function(){var e={env:Ge,wasi_snapshot_preview1:Ge};function t(e,t){var i,r=e.exports;s.asm=r,M((_=s.asm.memory).buffer),O=s.asm.__indirect_function_table,i=s.asm.__wasm_call_ctors,D.unshift(i),function(e){if(L--,s.monitorRunDependencies&&s.monitorRunDependencies(L),0==L&&(null!==B&&(clearInterval(B),B=null),k)){var t=k;k=null,t()}}()}function r(e){t(e.instance)}function n(t){return(d||"function"!=typeof fetch?Promise.resolve().then((function(){return H(U)})):fetch(U,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+U+"'";return e.arrayBuffer()})).catch((function(){return H(U)}))).then((function(t){return WebAssembly.instantiate(t,e)})).then((function(e){return e})).then(t,(function(e){u("failed to asynchronously prepare wasm: "+e),V(e)}))}if(L++,s.monitorRunDependencies&&s.monitorRunDependencies(L),s.instantiateWasm)try{return s.instantiateWasm(e,t)}catch(e){u("Module.instantiateWasm callback failed with error: "+e),i(e)}(d||"function"!=typeof WebAssembly.instantiateStreaming||G(U)||"function"!=typeof fetch?n(r):fetch(U,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(r,(function(e){return u("wasm streaming compile failed: "+e),u("falling back to ArrayBuffer instantiation"),n(r)}))}))).catch(i)}(),s.___wasm_call_ctors=function(){return(s.___wasm_call_ctors=s.asm.__wasm_call_ctors).apply(null,arguments)},s._HP_GetStatistics=function(){return(s._HP_GetStatistics=s.asm.HP_GetStatistics).apply(null,arguments)},s._HP_Shape_CreateSphere=function(){return(s._HP_Shape_CreateSphere=s.asm.HP_Shape_CreateSphere).apply(null,arguments)},s._HP_Shape_CreateCapsule=function(){return(s._HP_Shape_CreateCapsule=s.asm.HP_Shape_CreateCapsule).apply(null,arguments)},s._HP_Shape_CreateCylinder=function(){return(s._HP_Shape_CreateCylinder=s.asm.HP_Shape_CreateCylinder).apply(null,arguments)},s._HP_Shape_CreateBox=function(){return(s._HP_Shape_CreateBox=s.asm.HP_Shape_CreateBox).apply(null,arguments)},s._HP_Shape_CreateConvexHull=function(){return(s._HP_Shape_CreateConvexHull=s.asm.HP_Shape_CreateConvexHull).apply(null,arguments)},s._HP_Shape_CreateMesh=function(){return(s._HP_Shape_CreateMesh=s.asm.HP_Shape_CreateMesh).apply(null,arguments)},s._HP_Shape_CreateHeightField=function(){return(s._HP_Shape_CreateHeightField=s.asm.HP_Shape_CreateHeightField).apply(null,arguments)},s._HP_Shape_CreateContainer=function(){return(s._HP_Shape_CreateContainer=s.asm.HP_Shape_CreateContainer).apply(null,arguments)},s._HP_Shape_Release=function(){return(s._HP_Shape_Release=s.asm.HP_Shape_Release).apply(null,arguments)},s._HP_Shape_GetType=function(){return(s._HP_Shape_GetType=s.asm.HP_Shape_GetType).apply(null,arguments)},s._HP_Shape_AddChild=function(){return(s._HP_Shape_AddChild=s.asm.HP_Shape_AddChild).apply(null,arguments)},s._HP_Shape_RemoveChild=function(){return(s._HP_Shape_RemoveChild=s.asm.HP_Shape_RemoveChild).apply(null,arguments)},s._HP_Shape_GetNumChildren=function(){return(s._HP_Shape_GetNumChildren=s.asm.HP_Shape_GetNumChildren).apply(null,arguments)},s._HP_Shape_GetChildShape=function(){return(s._HP_Shape_GetChildShape=s.asm.HP_Shape_GetChildShape).apply(null,arguments)},s._HP_Shape_SetChildQSTransform=function(){return(s._HP_Shape_SetChildQSTransform=s.asm.HP_Shape_SetChildQSTransform).apply(null,arguments)},s._HP_Shape_GetChildQSTransform=function(){return(s._HP_Shape_GetChildQSTransform=s.asm.HP_Shape_GetChildQSTransform).apply(null,arguments)},s._HP_Shape_SetFilterInfo=function(){return(s._HP_Shape_SetFilterInfo=s.asm.HP_Shape_SetFilterInfo).apply(null,arguments)},s._HP_Shape_GetFilterInfo=function(){return(s._HP_Shape_GetFilterInfo=s.asm.HP_Shape_GetFilterInfo).apply(null,arguments)},s._HP_Shape_SetMaterial=function(){return(s._HP_Shape_SetMaterial=s.asm.HP_Shape_SetMaterial).apply(null,arguments)},s._HP_Shape_GetMaterial=function(){return(s._HP_Shape_GetMaterial=s.asm.HP_Shape_GetMaterial).apply(null,arguments)},s._HP_Shape_SetDensity=function(){return(s._HP_Shape_SetDensity=s.asm.HP_Shape_SetDensity).apply(null,arguments)},s._HP_Shape_GetDensity=function(){return(s._HP_Shape_GetDensity=s.asm.HP_Shape_GetDensity).apply(null,arguments)},s._HP_Shape_GetBoundingBox=function(){return(s._HP_Shape_GetBoundingBox=s.asm.HP_Shape_GetBoundingBox).apply(null,arguments)},s._HP_Shape_CastRay=function(){return(s._HP_Shape_CastRay=s.asm.HP_Shape_CastRay).apply(null,arguments)},s._HP_Shape_BuildMassProperties=function(){return(s._HP_Shape_BuildMassProperties=s.asm.HP_Shape_BuildMassProperties).apply(null,arguments)},s._HP_ShapePathIterator_GetNext=function(){return(s._HP_ShapePathIterator_GetNext=s.asm.HP_ShapePathIterator_GetNext).apply(null,arguments)},s._HP_Shape_SetTrigger=function(){return(s._HP_Shape_SetTrigger=s.asm.HP_Shape_SetTrigger).apply(null,arguments)},s._HP_Shape_CreateDebugDisplayGeometry=function(){return(s._HP_Shape_CreateDebugDisplayGeometry=s.asm.HP_Shape_CreateDebugDisplayGeometry).apply(null,arguments)},s._HP_DebugGeometry_GetInfo=function(){return(s._HP_DebugGeometry_GetInfo=s.asm.HP_DebugGeometry_GetInfo).apply(null,arguments)},s._HP_DebugGeometry_Release=function(){return(s._HP_DebugGeometry_Release=s.asm.HP_DebugGeometry_Release).apply(null,arguments)},s._HP_Body_Create=function(){return(s._HP_Body_Create=s.asm.HP_Body_Create).apply(null,arguments)},s._HP_Body_Release=function(){return(s._HP_Body_Release=s.asm.HP_Body_Release).apply(null,arguments)},s._HP_Body_SetShape=function(){return(s._HP_Body_SetShape=s.asm.HP_Body_SetShape).apply(null,arguments)},s._HP_Body_GetShape=function(){return(s._HP_Body_GetShape=s.asm.HP_Body_GetShape).apply(null,arguments)},s._HP_Body_SetMotionType=function(){return(s._HP_Body_SetMotionType=s.asm.HP_Body_SetMotionType).apply(null,arguments)},s._HP_Body_GetMotionType=function(){return(s._HP_Body_GetMotionType=s.asm.HP_Body_GetMotionType).apply(null,arguments)},s._HP_Body_SetEventMask=function(){return(s._HP_Body_SetEventMask=s.asm.HP_Body_SetEventMask).apply(null,arguments)},s._HP_Body_GetEventMask=function(){return(s._HP_Body_GetEventMask=s.asm.HP_Body_GetEventMask).apply(null,arguments)},s._HP_Body_SetMassProperties=function(){return(s._HP_Body_SetMassProperties=s.asm.HP_Body_SetMassProperties).apply(null,arguments)},s._HP_Body_GetMassProperties=function(){return(s._HP_Body_GetMassProperties=s.asm.HP_Body_GetMassProperties).apply(null,arguments)},s._HP_Body_SetLinearDamping=function(){return(s._HP_Body_SetLinearDamping=s.asm.HP_Body_SetLinearDamping).apply(null,arguments)},s._HP_Body_GetLinearDamping=function(){return(s._HP_Body_GetLinearDamping=s.asm.HP_Body_GetLinearDamping).apply(null,arguments)},s._HP_Body_SetAngularDamping=function(){return(s._HP_Body_SetAngularDamping=s.asm.HP_Body_SetAngularDamping).apply(null,arguments)},s._HP_Body_GetAngularDamping=function(){return(s._HP_Body_GetAngularDamping=s.asm.HP_Body_GetAngularDamping).apply(null,arguments)},s._HP_Body_SetGravityFactor=function(){return(s._HP_Body_SetGravityFactor=s.asm.HP_Body_SetGravityFactor).apply(null,arguments)},s._HP_Body_GetGravityFactor=function(){return(s._HP_Body_GetGravityFactor=s.asm.HP_Body_GetGravityFactor).apply(null,arguments)},s._HP_Body_GetWorld=function(){return(s._HP_Body_GetWorld=s.asm.HP_Body_GetWorld).apply(null,arguments)},s._HP_Body_SetPosition=function(){return(s._HP_Body_SetPosition=s.asm.HP_Body_SetPosition).apply(null,arguments)},s._HP_Body_GetPosition=function(){return(s._HP_Body_GetPosition=s.asm.HP_Body_GetPosition).apply(null,arguments)},s._HP_Body_SetOrientation=function(){return(s._HP_Body_SetOrientation=s.asm.HP_Body_SetOrientation).apply(null,arguments)},s._HP_Body_GetOrientation=function(){return(s._HP_Body_GetOrientation=s.asm.HP_Body_GetOrientation).apply(null,arguments)},s._HP_Body_SetQTransform=function(){return(s._HP_Body_SetQTransform=s.asm.HP_Body_SetQTransform).apply(null,arguments)},s._HP_Body_GetWorldTransformOffset=function(){return(s._HP_Body_GetWorldTransformOffset=s.asm.HP_Body_GetWorldTransformOffset).apply(null,arguments)},s._HP_Body_GetQTransform=function(){return(s._HP_Body_GetQTransform=s.asm.HP_Body_GetQTransform).apply(null,arguments)},s._HP_Body_SetLinearVelocity=function(){return(s._HP_Body_SetLinearVelocity=s.asm.HP_Body_SetLinearVelocity).apply(null,arguments)},s._HP_Body_GetLinearVelocity=function(){return(s._HP_Body_GetLinearVelocity=s.asm.HP_Body_GetLinearVelocity).apply(null,arguments)},s._HP_Body_SetAngularVelocity=function(){return(s._HP_Body_SetAngularVelocity=s.asm.HP_Body_SetAngularVelocity).apply(null,arguments)},s._HP_Body_GetAngularVelocity=function(){return(s._HP_Body_GetAngularVelocity=s.asm.HP_Body_GetAngularVelocity).apply(null,arguments)},s._HP_Body_ApplyImpulse=function(){return(s._HP_Body_ApplyImpulse=s.asm.HP_Body_ApplyImpulse).apply(null,arguments)},s._HP_Body_ApplyAngularImpulse=function(){return(s._HP_Body_ApplyAngularImpulse=s.asm.HP_Body_ApplyAngularImpulse).apply(null,arguments)},s._HP_Body_SetTargetQTransform=function(){return(s._HP_Body_SetTargetQTransform=s.asm.HP_Body_SetTargetQTransform).apply(null,arguments)},s._HP_Body_SetActivationState=function(){return(s._HP_Body_SetActivationState=s.asm.HP_Body_SetActivationState).apply(null,arguments)},s._HP_Body_GetActivationState=function(){return(s._HP_Body_GetActivationState=s.asm.HP_Body_GetActivationState).apply(null,arguments)},s._HP_Body_SetActivationControl=function(){return(s._HP_Body_SetActivationControl=s.asm.HP_Body_SetActivationControl).apply(null,arguments)},s._HP_Body_SetActivationPriority=function(){return(s._HP_Body_SetActivationPriority=s.asm.HP_Body_SetActivationPriority).apply(null,arguments)},s._HP_Constraint_Create=function(){return(s._HP_Constraint_Create=s.asm.HP_Constraint_Create).apply(null,arguments)},s._HP_Constraint_Release=function(){return(s._HP_Constraint_Release=s.asm.HP_Constraint_Release).apply(null,arguments)},s._HP_Constraint_SetParentBody=function(){return(s._HP_Constraint_SetParentBody=s.asm.HP_Constraint_SetParentBody).apply(null,arguments)},s._HP_Constraint_GetParentBody=function(){return(s._HP_Constraint_GetParentBody=s.asm.HP_Constraint_GetParentBody).apply(null,arguments)},s._HP_Constraint_SetChildBody=function(){return(s._HP_Constraint_SetChildBody=s.asm.HP_Constraint_SetChildBody).apply(null,arguments)},s._HP_Constraint_GetChildBody=function(){return(s._HP_Constraint_GetChildBody=s.asm.HP_Constraint_GetChildBody).apply(null,arguments)},s._HP_Constraint_SetAnchorInParent=function(){return(s._HP_Constraint_SetAnchorInParent=s.asm.HP_Constraint_SetAnchorInParent).apply(null,arguments)},s._HP_Constraint_SetAnchorInChild=function(){return(s._HP_Constraint_SetAnchorInChild=s.asm.HP_Constraint_SetAnchorInChild).apply(null,arguments)},s._HP_Constraint_SetCollisionsEnabled=function(){return(s._HP_Constraint_SetCollisionsEnabled=s.asm.HP_Constraint_SetCollisionsEnabled).apply(null,arguments)},s._HP_Constraint_GetCollisionsEnabled=function(){return(s._HP_Constraint_GetCollisionsEnabled=s.asm.HP_Constraint_GetCollisionsEnabled).apply(null,arguments)},s._HP_Constraint_SetEnabled=function(){return(s._HP_Constraint_SetEnabled=s.asm.HP_Constraint_SetEnabled).apply(null,arguments)},s._HP_Constraint_GetEnabled=function(){return(s._HP_Constraint_GetEnabled=s.asm.HP_Constraint_GetEnabled).apply(null,arguments)},s._HP_Constraint_SetAxisMinLimit=function(){return(s._HP_Constraint_SetAxisMinLimit=s.asm.HP_Constraint_SetAxisMinLimit).apply(null,arguments)},s._HP_Constraint_GetAxisMinLimit=function(){return(s._HP_Constraint_GetAxisMinLimit=s.asm.HP_Constraint_GetAxisMinLimit).apply(null,arguments)},s._HP_Constraint_SetAxisMaxLimit=function(){return(s._HP_Constraint_SetAxisMaxLimit=s.asm.HP_Constraint_SetAxisMaxLimit).apply(null,arguments)},s._HP_Constraint_GetAxisMaxLimit=function(){return(s._HP_Constraint_GetAxisMaxLimit=s.asm.HP_Constraint_GetAxisMaxLimit).apply(null,arguments)},s._HP_Constraint_GetAxisMode=function(){return(s._HP_Constraint_GetAxisMode=s.asm.HP_Constraint_GetAxisMode).apply(null,arguments)},s._HP_Constraint_SetAxisMode=function(){return(s._HP_Constraint_SetAxisMode=s.asm.HP_Constraint_SetAxisMode).apply(null,arguments)},s._HP_Constraint_SetAxisFriction=function(){return(s._HP_Constraint_SetAxisFriction=s.asm.HP_Constraint_SetAxisFriction).apply(null,arguments)},s._HP_Constraint_GetAxisFriction=function(){return(s._HP_Constraint_GetAxisFriction=s.asm.HP_Constraint_GetAxisFriction).apply(null,arguments)},s._HP_Constraint_SetAxisMotorType=function(){return(s._HP_Constraint_SetAxisMotorType=s.asm.HP_Constraint_SetAxisMotorType).apply(null,arguments)},s._HP_Constraint_GetAxisMotorType=function(){return(s._HP_Constraint_GetAxisMotorType=s.asm.HP_Constraint_GetAxisMotorType).apply(null,arguments)},s._HP_Constraint_SetAxisMotorPositionTarget=function(){return(s._HP_Constraint_SetAxisMotorPositionTarget=s.asm.HP_Constraint_SetAxisMotorPositionTarget).apply(null,arguments)},s._HP_Constraint_GetAxisMotorPositionTarget=function(){return(s._HP_Constraint_GetAxisMotorPositionTarget=s.asm.HP_Constraint_GetAxisMotorPositionTarget).apply(null,arguments)},s._HP_Constraint_SetAxisMotorVelocityTarget=function(){return(s._HP_Constraint_SetAxisMotorVelocityTarget=s.asm.HP_Constraint_SetAxisMotorVelocityTarget).apply(null,arguments)},s._HP_Constraint_GetAxisMotorVelocityTarget=function(){return(s._HP_Constraint_GetAxisMotorVelocityTarget=s.asm.HP_Constraint_GetAxisMotorVelocityTarget).apply(null,arguments)},s._HP_Constraint_SetAxisMotorMaxForce=function(){return(s._HP_Constraint_SetAxisMotorMaxForce=s.asm.HP_Constraint_SetAxisMotorMaxForce).apply(null,arguments)},s._HP_Constraint_GetAxisMotorMaxForce=function(){return(s._HP_Constraint_GetAxisMotorMaxForce=s.asm.HP_Constraint_GetAxisMotorMaxForce).apply(null,arguments)},s._HP_Constraint_SetAxisMotorStiffness=function(){return(s._HP_Constraint_SetAxisMotorStiffness=s.asm.HP_Constraint_SetAxisMotorStiffness).apply(null,arguments)},s._HP_Constraint_GetAxisMotorStiffness=function(){return(s._HP_Constraint_GetAxisMotorStiffness=s.asm.HP_Constraint_GetAxisMotorStiffness).apply(null,arguments)},s._HP_Constraint_SetAxisMotorDamping=function(){return(s._HP_Constraint_SetAxisMotorDamping=s.asm.HP_Constraint_SetAxisMotorDamping).apply(null,arguments)},s._HP_Constraint_GetAxisMotorDamping=function(){return(s._HP_Constraint_GetAxisMotorDamping=s.asm.HP_Constraint_GetAxisMotorDamping).apply(null,arguments)},s._HP_Constraint_SetAxisStiffness=function(){return(s._HP_Constraint_SetAxisStiffness=s.asm.HP_Constraint_SetAxisStiffness).apply(null,arguments)},s._HP_Constraint_SetAxisDamping=function(){return(s._HP_Constraint_SetAxisDamping=s.asm.HP_Constraint_SetAxisDamping).apply(null,arguments)},s._HP_Constraint_SetAxisMotorTarget=function(){return(s._HP_Constraint_SetAxisMotorTarget=s.asm.HP_Constraint_SetAxisMotorTarget).apply(null,arguments)},s._HP_Constraint_GetAxisMotorTarget=function(){return(s._HP_Constraint_GetAxisMotorTarget=s.asm.HP_Constraint_GetAxisMotorTarget).apply(null,arguments)},s._HP_World_Create=function(){return(s._HP_World_Create=s.asm.HP_World_Create).apply(null,arguments)},s._HP_World_Release=function(){return(s._HP_World_Release=s.asm.HP_World_Release).apply(null,arguments)},s._HP_World_GetBodyBuffer=function(){return(s._HP_World_GetBodyBuffer=s.asm.HP_World_GetBodyBuffer).apply(null,arguments)},s._HP_World_SetGravity=function(){return(s._HP_World_SetGravity=s.asm.HP_World_SetGravity).apply(null,arguments)},s._HP_World_GetGravity=function(){return(s._HP_World_GetGravity=s.asm.HP_World_GetGravity).apply(null,arguments)},s._HP_World_AddBody=function(){return(s._HP_World_AddBody=s.asm.HP_World_AddBody).apply(null,arguments)},s._HP_World_RemoveBody=function(){return(s._HP_World_RemoveBody=s.asm.HP_World_RemoveBody).apply(null,arguments)},s._HP_World_GetNumBodies=function(){return(s._HP_World_GetNumBodies=s.asm.HP_World_GetNumBodies).apply(null,arguments)},s._HP_World_CastRayWithCollector=function(){return(s._HP_World_CastRayWithCollector=s.asm.HP_World_CastRayWithCollector).apply(null,arguments)},s._HP_World_PointProximityWithCollector=function(){return(s._HP_World_PointProximityWithCollector=s.asm.HP_World_PointProximityWithCollector).apply(null,arguments)},s._HP_World_ShapeProximityWithCollector=function(){return(s._HP_World_ShapeProximityWithCollector=s.asm.HP_World_ShapeProximityWithCollector).apply(null,arguments)},s._HP_World_ShapeCastWithCollector=function(){return(s._HP_World_ShapeCastWithCollector=s.asm.HP_World_ShapeCastWithCollector).apply(null,arguments)},s._HP_World_Step=function(){return(s._HP_World_Step=s.asm.HP_World_Step).apply(null,arguments)},s._HP_World_SetIdealStepTime=function(){return(s._HP_World_SetIdealStepTime=s.asm.HP_World_SetIdealStepTime).apply(null,arguments)},s._HP_World_SetSpeedLimit=function(){return(s._HP_World_SetSpeedLimit=s.asm.HP_World_SetSpeedLimit).apply(null,arguments)},s._HP_World_GetSpeedLimit=function(){return(s._HP_World_GetSpeedLimit=s.asm.HP_World_GetSpeedLimit).apply(null,arguments)},s._HP_World_GetNextCollisionEvent=function(){return(s._HP_World_GetNextCollisionEvent=s.asm.HP_World_GetNextCollisionEvent).apply(null,arguments)},s._HP_World_GetNextTriggerEvent=function(){return(s._HP_World_GetNextTriggerEvent=s.asm.HP_World_GetNextTriggerEvent).apply(null,arguments)},s._HP_QueryCollector_Create=function(){return(s._HP_QueryCollector_Create=s.asm.HP_QueryCollector_Create).apply(null,arguments)},s._HP_QueryCollector_Release=function(){return(s._HP_QueryCollector_Release=s.asm.HP_QueryCollector_Release).apply(null,arguments)},s._HP_QueryCollector_GetNumHits=function(){return(s._HP_QueryCollector_GetNumHits=s.asm.HP_QueryCollector_GetNumHits).apply(null,arguments)},s._HP_QueryCollector_GetCastRayResult=function(){return(s._HP_QueryCollector_GetCastRayResult=s.asm.HP_QueryCollector_GetCastRayResult).apply(null,arguments)},s._HP_QueryCollector_GetPointProximityResult=function(){return(s._HP_QueryCollector_GetPointProximityResult=s.asm.HP_QueryCollector_GetPointProximityResult).apply(null,arguments)},s._HP_QueryCollector_GetShapeProximityResult=function(){return(s._HP_QueryCollector_GetShapeProximityResult=s.asm.HP_QueryCollector_GetShapeProximityResult).apply(null,arguments)},s._HP_QueryCollector_GetShapeCastResult=function(){return(s._HP_QueryCollector_GetShapeCastResult=s.asm.HP_QueryCollector_GetShapeCastResult).apply(null,arguments)},s._main=function(){return(s._main=s.asm.main).apply(null,arguments)},s._malloc=function(){return(He=s._malloc=s.asm.malloc).apply(null,arguments)}),We=s._free=function(){return(We=s._free=s.asm.free).apply(null,arguments)},Xe=(s._HP_Debug_StartRecordingStats=function(){return(s._HP_Debug_StartRecordingStats=s.asm.HP_Debug_StartRecordingStats).apply(null,arguments)},s._HP_Debug_StopRecordingStats=function(){return(s._HP_Debug_StopRecordingStats=s.asm.HP_Debug_StopRecordingStats).apply(null,arguments)},s.___errno_location=function(){return(s.___errno_location=s.asm.__errno_location).apply(null,arguments)},s._htons=function(){return(s._htons=s.asm.htons).apply(null,arguments)},s._ntohs=function(){return(s._ntohs=s.asm.ntohs).apply(null,arguments)},s.___getTypeName=function(){return(Xe=s.___getTypeName=s.asm.__getTypeName).apply(null,arguments)});function Ke(e){var t,i,r=s._main;try{var n=r(0,0);return f=t=n,f=i=t,p||(s.onExit&&s.onExit(i),A=!0),l(i,new W(i)),n}catch(e){return function(e){if(e instanceof W||"unwind"==e)return f;l(1,e)}(e)}}function Qe(e){function i(){ze||(ze=!0,s.calledRun=!0,A||(X(D),X(F),t(s),s.onRuntimeInitialized&&s.onRuntimeInitialized(),Ye&&Ke(),function(){if(s.postRun)for("function"==typeof s.postRun&&(s.postRun=[s.postRun]);s.postRun.length;)e=s.postRun.shift(),N.unshift(e);var e;X(N)}()))}e=e||o,L>0||(function(){if(s.preRun)for("function"==typeof s.preRun&&(s.preRun=[s.preRun]);s.preRun.length;)e=s.preRun.shift(),w.unshift(e);var e;X(w)}(),L>0||(s.setStatus?(s.setStatus("Running..."),setTimeout((function(){setTimeout((function(){s.setStatus("")}),1),i()}),1)):i()))}if(s.__embind_initialize_bindings=function(){return(s.__embind_initialize_bindings=s.asm._embind_initialize_bindings).apply(null,arguments)},s._htonl=function(){return(s._htonl=s.asm.htonl).apply(null,arguments)},s._setThrew=function(){return(s._setThrew=s.asm.setThrew).apply(null,arguments)},s._saveSetjmp=function(){return(s._saveSetjmp=s.asm.saveSetjmp).apply(null,arguments)},s.stackSave=function(){return(s.stackSave=s.asm.stackSave).apply(null,arguments)},s.stackRestore=function(){return(s.stackRestore=s.asm.stackRestore).apply(null,arguments)},s.stackAlloc=function(){return(s.stackAlloc=s.asm.stackAlloc).apply(null,arguments)},k=function e(){ze||Qe(),ze||(k=e)},s.preInit)for("function"==typeof s.preInit&&(s.preInit=[s.preInit]);s.preInit.length>0;)s.preInit.pop()();var Ye=!0;return s.noInitialRun&&(Ye=!1),Qe(),e.ready});r(4581),r(9741),r(2360);ae.l.IncludesShadersStore.imageProcessingCompatibility="#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));\n#endif\n";ae.l.ShadersStore.shadowOnlyPixelShader="precision highp float;uniform vec4 vEyePosition;uniform float alpha;uniform vec3 shadowColor;varying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(1.0,1.0,1.0);\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;float shadow=1.;float glossiness=0.;float aggShadow=0.;float numLights=0.;\n#include<lightFragment>[0..1]\nvec4 color=vec4(shadowColor,(1.0-clamp(shadow,0.,1.))*alpha);\n#include<logDepthFragment>\n#include<fogFragment>\ngl_FragColor=color;\n#include<imageProcessingCompatibility>\n#define CUSTOM_FRAGMENT_MAIN_END\n}",r(6560),r(2215),r(6470);ae.l.ShadersStore.shadowOnlyVertexShader="precision highp float;attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nuniform mat4 view;uniform mat4 viewProjection;\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<logDepthDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);gl_Position=viewProjection*worldPos;vPositionW=vec3(worldPos);\n#ifdef NORMAL\nvNormalW=normalize(vec3(finalWorld*vec4(normal,0.0)));\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n";class Oc extends ye.M{constructor(){super(),this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.LOGARITHMICDEPTH=!1,this.rebuild()}}class wc extends Ce{constructor(e,t){super(e,t),this._needAlphaBlending=!0,this.shadowColor=M.v9.Black()}needAlphaBlending(){return this._needAlphaBlending}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}get activeLight(){return this._activeLight}set activeLight(e){this._activeLight=e}_getFirstShadowLightForMesh(e){for(const t of e.lightSources)if(t.shadowEnabled)return t;return null}isReadyForSubMesh(e,t,i){const s=t._drawWrapper;if(this.isFrozen&&s.effect&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new Oc);const r=t.materialDefines,n=this.getScene();if(this._isReadyForSubMesh(t))return!0;const a=n.getEngine();if(this._activeLight)for(const t of e.lightSources)if(t.shadowEnabled){if(this._activeLight===t)break;const i=e.lightSources.indexOf(this._activeLight);-1!==i&&(e.lightSources.splice(i,1),e.lightSources.splice(0,0,this._activeLight));break}(0,$.OR)(n,a,this,r,!!i),(0,$.fm)(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),r),r._needNormals=(0,$.az)(n,e,r,!1,1);const o=this._getFirstShadowLightForMesh(e)?.getShadowGenerator();if(this._needAlphaBlending=!0,o&&o.getClassName&&"CascadedShadowGenerator"===o.getClassName()){const e=o;this._needAlphaBlending=!e.autoCalcDepthBounds}if((0,$.qB)(e,r,!1,!0),r.isDirty){r.markAsProcessed(),n.resetCachedMaterial();const i=new K;r.FOG&&i.addFallback(1,"FOG"),(0,$.c4)(r,i,1),r.NUM_BONE_INFLUENCERS>0&&i.addCPUSkinningFallback(0,e),r.IMAGEPROCESSINGPOSTPROCESS=n.imageProcessingConfiguration.applyByPostProcess;const s=[O.R.PositionKind];r.NORMAL&&s.push(O.R.NormalKind),(0,$.ni)(s,e,r,i),(0,$.ER)(s,r);const o="shadowOnly",l=r.toString(),h=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","alpha","shadowColor","mBones","logarithmicDepthConstant"],c=[],u=[];(0,q.TV)(h),(0,$.Bb)({uniformsNames:h,uniformBuffersNames:u,samplers:c,defines:r,maxSimultaneousLights:1}),t.setEffect(n.getEngine().createEffect(o,{attributes:s,uniformsNames:h,uniformBuffersNames:u,samplers:c,defines:l,fallbacks:i,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:1}},a),r,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(r._renderId=n.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=!!i,0))}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;if(n){if(this._activeEffect=n,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),(0,$.f$)(t,this._activeEffect),this._mustRebind(s,n,i)&&((0,q.gS)(n,this,s),this.pointsCloud&&this._activeEffect.setFloat("pointSize",this.pointSize),this._activeEffect.setFloat("alpha",this.alpha),this._activeEffect.setColor3("shadowColor",this.shadowColor),this._useLogarithmicDepth&&(0,$.DL)(r,n,s),s.bindEyePosition(n)),s.lightsEnabled){(0,$.RL)(s,t,this._activeEffect,r,1);const e=this._getFirstShadowLightForMesh(t);e&&(e._renderId=-1)}(s.fogEnabled&&t.applyFog&&s.fogMode!==be.Z.FOGMODE_NONE||r.SHADOWCSM0)&&this._activeEffect.setMatrix("view",s.getViewMatrix()),(0,$.Yy)(s,t,this._activeEffect),this._afterBind(t,this._activeEffect,i)}}clone(e){return N.p.Clone((()=>new wc(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.ShadowOnlyMaterial",e}getClassName(){return"ShadowOnlyMaterial"}static Parse(e,t,i){return N.p.Parse((()=>new wc(e.name,t)),e,t,i)}}(0,V.Y5)("BABYLON.ShadowOnlyMaterial",wc);class Dc extends co{constructor(e,t,i,s,r,n){super(e,t,i,s,r,n)}validate(){const e=this.boneTracks;for(let t=0;t<e.length;++t)if(!e[t].validate())return!1;const t=this.movableBoneTracks;for(let e=0;e<t.length;++e)if(!t[e].validate())return!1;const i=this.morphTracks;for(let e=0;e<i.length;++e)if(!i[e].validate())return!1;return this.propertyTrack.validate()&&this.cameraTrack.validate()}}class Fc{trackType;name;frameNumbers;constructor(e,t,i,s,r){this.trackType=e,this.name=t,this.frameNumbers=void 0===s?new Uint32Array(i):new Uint32Array(s,r,i)}validate(){for(let e=1;e<this.frameNumbers.length;++e)if(this.frameNumbers[e-1]>=this.frameNumbers[e])return!1;return!0}get startFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[0]}get endFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[this.frameNumbers.length-1]}}class Nc extends Fc{rotations;rotationInterpolations;constructor(e,t,i,s,r,n){super("bone",e,t,i,s),void 0===i?(this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)):(this.rotations=new Float32Array(i,r,4*t),this.rotationInterpolations=new Uint8Array(i,n,4*t))}}class Lc extends Fc{positions;positionInterpolations;rotations;rotationInterpolations;constructor(e,t,i,s,r,n,a,o){super("movableBone",e,t,i,s),void 0===i?(this.positions=new Float32Array(3*t),this.positionInterpolations=new Uint8Array(12*t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)):(this.positions=new Float32Array(i,r,3*t),this.positionInterpolations=new Uint8Array(i,n,12*t),this.rotations=new Float32Array(i,a,4*t),this.rotationInterpolations=new Uint8Array(i,o,4*t))}}class Bc extends Fc{weights;constructor(e,t,i,s,r){super("morph",e,t,i,s),this.weights=void 0===i?new Float32Array(t):new Float32Array(i,r,t)}}class kc extends Fc{positions;positionInterpolations;rotations;rotationInterpolations;distances;distanceInterpolations;fovs;fovInterpolations;constructor(e,t,i,s,r,n,a,o,l,h,c){super("camera","cameraTrack",e,t,i),void 0===t?(this.positions=new Float32Array(3*e),this.positionInterpolations=new Uint8Array(12*e),this.rotations=new Float32Array(3*e),this.rotationInterpolations=new Uint8Array(4*e),this.distances=new Float32Array(e),this.distanceInterpolations=new Uint8Array(4*e),this.fovs=new Float32Array(e),this.fovInterpolations=new Uint8Array(4*e)):(this.positions=new Float32Array(t,s,3*e),this.positionInterpolations=new Uint8Array(t,r,12*e),this.rotations=new Float32Array(t,n,3*e),this.rotationInterpolations=new Uint8Array(t,a,4*e),this.distances=new Float32Array(t,o,e),this.distanceInterpolations=new Uint8Array(t,l,4*e),this.fovs=new Float32Array(t,h,e),this.fovInterpolations=new Uint8Array(t,c,4*e))}}class Vc extends Fc{visibles;ikBoneNames;_ikStates;constructor(e,t,i,s,r,n){if(super("property","propertyTrack",e,i,s),void 0===i){this.visibles=new Uint8Array(e),this.ikBoneNames=t,this._ikStates=new Array(t.length);for(let i=0;i<t.length;++i)this._ikStates[i]=new Uint8Array(e)}else{this.visibles=new Uint8Array(i,r,e),this.ikBoneNames=t,this._ikStates=new Array(t.length),void 0===n&&(n=new Array(t.length));for(let s=0;s<t.length;++s)this._ikStates[s]=new Uint8Array(i,n[s],e)}}getIkState(e){return this._ikStates[e]}}class Uc{_scene;_loggingEnabled;log;warn;error;constructor(e){this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e}loadFromBuffer(e,t){const i=new $a(t);if(i.initializeTextDecoder("utf-8"),"BVMD"!==i.getDecoderString(4,!1))throw new ks.hX("BVMD signature is not valid.");const s=[i.getInt8(),i.getInt8(),i.getInt8()];if(2!==s[0]||0!==s[1]||0!==s[2])throw new ks.hX(`BVMD version ${s[0]}.${s[1]}.${s[2]} is not supported.`);const r=i.getUint32(),n=new Array(r);for(let e=0;e<r;++e){const s=i.getDecoderString(i.getUint32(),!0),r=i.getUint32(),a=i.getPaddedArrayOffset(4,r),o=i.getPaddedArrayOffset(4,4*r),l=i.getPaddedArrayOffset(1,4*r),h=n[e]=new Nc(s,r,t,a,o,l);i.isDeviceLittleEndian||(i.swap32Array(h.frameNumbers),i.swap32Array(h.rotations))}const a=i.getUint32(),o=new Array(a);for(let e=0;e<a;++e){const s=i.getDecoderString(i.getUint32(),!0),r=i.getUint32(),n=i.getPaddedArrayOffset(4,r),a=i.getPaddedArrayOffset(4,3*r),l=i.getPaddedArrayOffset(1,12*r),h=i.getPaddedArrayOffset(4,4*r),c=i.getPaddedArrayOffset(1,4*r),u=o[e]=new Lc(s,r,t,n,a,l,h,c);i.isDeviceLittleEndian||(i.swap32Array(u.frameNumbers),i.swap32Array(u.positions),i.swap32Array(u.rotations))}const l=i.getUint32(),h=new Array(l);for(let e=0;e<l;++e){const s=i.getDecoderString(i.getUint32(),!0),r=i.getUint32(),n=i.getPaddedArrayOffset(4,r),a=i.getPaddedArrayOffset(4,r),o=h[e]=new Bc(s,r,t,n,a);i.isDeviceLittleEndian||(i.swap32Array(o.frameNumbers),i.swap32Array(o.weights))}const c=i.getUint32(),u=i.getUint32(),d=i.getPaddedArrayOffset(4,c),_=i.getPaddedArrayOffset(1,c),p=new Array(u),f=new Array(u);for(let e=0;e<u;++e)p[e]=i.getDecoderString(i.getUint32(),!0),f[e]=i.getPaddedArrayOffset(1,c);const m=new Vc(c,p,t,d,_,f);i.isDeviceLittleEndian||i.swap32Array(m.frameNumbers);const g=i.getUint32(),v=i.getPaddedArrayOffset(4,g),b=i.getPaddedArrayOffset(4,3*g),x=i.getPaddedArrayOffset(1,12*g),S=i.getPaddedArrayOffset(4,3*g),T=i.getPaddedArrayOffset(1,4*g),y=i.getPaddedArrayOffset(4,g),C=i.getPaddedArrayOffset(1,4*g),P=i.getPaddedArrayOffset(4,g),E=i.getPaddedArrayOffset(1,4*g),A=new kc(g,t,v,b,x,S,T,y,C,P,E);return i.isDeviceLittleEndian||(i.swap32Array(A.frameNumbers),i.swap32Array(A.positions),i.swap32Array(A.rotations),i.swap32Array(A.distances),i.swap32Array(A.fovs)),new Dc(e,n,o,h,m,A)}load(e,t,i,s,r){return this._scene._loadFile(t,((t,s)=>{try{i(this.loadFromBuffer(e,t))}catch(e){r?.(void 0,e)}}),s,!0,!0,r)}loadAsync(e,t,i){return new Promise(((s,r)=>{this.load(e,t,s,i,((e,t)=>r({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){l.V.Log(e)}_logDisabled(){}_warnEnabled(e){l.V.Warn(e)}_warnDisabled(){}_errorEnabled(e){l.V.Error(e)}_errorDisabled(){}}class zc{_audioElements=[];rent(){if(0===this._audioElements.length)return new Audio;{const e=this._audioElements.pop();return e.loop=!1,e.autoplay=!1,e.playbackRate=1,e.volume=1,e.muted=!1,e.preservesPitch=!0,e.ondurationchange=null,e.onerror=null,e.onplaying=null,e.onpause=null,e.onseeked=null,e}}return(e){e.pause(),e.src="",e.load(),this._audioElements.push(e)}}class Gc{static DefaultAudioElementPool=new zc;onLoadErrorObservable;onDurationChangedObservable;onPlaybackRateChangedObservable;onMuteStateChangedObservable;onPlayObservable;onPauseObservable;onSeekObservable;_pool;_audio;_duration;_playbackRate;_isVirtualPlay;_virtualStartTime;_virtualPaused;_virtualPauseCurrentTime;_metadataLoaded;_bindedDispose;_disposeObservableObject;constructor(e,t={}){const i=t.pool??!1;this.onLoadErrorObservable=new C.cP,this.onDurationChangedObservable=new C.cP,this.onPlaybackRateChangedObservable=new C.cP,this.onMuteStateChangedObservable=new C.cP,this.onPlayObservable=new C.cP,this.onPauseObservable=new C.cP,this.onSeekObservable=new C.cP;const s=this._pool="boolean"==typeof i?i?Gc.DefaultAudioElementPool:null:i,r=this._audio=null!==s?s.rent():new Audio;r.loop=!1,r.autoplay=!1,this._duration=0,this._playbackRate=1,this._isVirtualPlay=!1,this._virtualStartTime=0,this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!1,r.ondurationchange=this._onDurationChanged,r.onerror=this._onLoadError,r.onplaying=this._onPlay,r.onpause=this._onPause,r.onseeked=this._onSeek,this._bindedDispose=this.dispose.bind(this),this._disposeObservableObject=e,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)}_onDurationChanged=()=>{this._duration=this._audio.duration,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!0,this.onDurationChangedObservable.notifyObservers()};_onLoadError=()=>{this._duration=0,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!1,this.onLoadErrorObservable.notifyObservers(),this.onDurationChangedObservable.notifyObservers()};_onPlay=()=>{this._isVirtualPlay||(this._audio.playbackRate=this._playbackRate),this.onPlayObservable.notifyObservers()};_onPause=()=>{this._isVirtualPlay?this._virtualPaused&&this.onPauseObservable.notifyObservers():this.onPauseObservable.notifyObservers()};_ignoreSeekedEventOnce=!1;_onSeek=()=>{this._ignoreSeekedEventOnce?this._ignoreSeekedEventOnce=!1:this.onSeekObservable.notifyObservers()};get duration(){return this._duration}get currentTime(){if(this._isVirtualPlay){if(this._virtualPaused)return this._virtualPauseCurrentTime;{const e=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate;return e>this._duration?(this._virtualPaused=!0,this._virtualPauseCurrentTime=this._duration,this._onPause(),this._virtualPauseCurrentTime):e}}return this._audio.currentTime}set currentTime(e){this._isVirtualPlay?(this._virtualPaused?this._virtualPauseCurrentTime=e:this._virtualStartTime=performance.now()/1e3-e/this._playbackRate,this._onSeek()):this._audio.currentTime=e}_setCurrentTimeWithoutNotify(e){this._isVirtualPlay?this._virtualPaused?this._virtualPauseCurrentTime=e:this._virtualStartTime=performance.now()/1e3-e/this._playbackRate:(this._ignoreSeekedEventOnce=!0,this._audio.currentTime=e)}get volume(){return this._audio.volume}set volume(e){this._audio.volume=e}get muted(){return this._isVirtualPlay}mute(){this._isVirtualPlay||(this._isVirtualPlay=!0,this._virtualStartTime=performance.now()/1e3-this._audio.currentTime/this._playbackRate,this._virtualPaused=this._audio.paused,this._virtualPauseCurrentTime=this._audio.currentTime,this._audio.pause(),this.onMuteStateChangedObservable.notifyObservers())}async unmute(){if(!this._isVirtualPlay)return!0;let e=!1;if(this._ignoreSeekedEventOnce=!0,this._virtualPaused)this._audio.currentTime=this._virtualPauseCurrentTime;else{this._audio.currentTime=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate;try{await this._audio.play(),this._audio.playbackRate=this._playbackRate}catch(t){if(!(t instanceof DOMException&&"NotAllowedError"===t.name))throw t;e=!0}}return!e&&(this._isVirtualPlay=!1,this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this.onMuteStateChangedObservable.notifyObservers(),!0)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._setPlaybackRateWithoutNotify(e),this.onPlaybackRateChangedObservable.notifyObservers()}_setPlaybackRateWithoutNotify(e){if(this._isVirtualPlay&&!this._virtualPaused){const t=performance.now()/1e3,i=(t-this._virtualStartTime)*this._playbackRate;this._virtualStartTime=t-i/e}this._playbackRate=e,this._audio.playbackRate=e}get preservesPitch(){return this._audio.preservesPitch}set preservesPitch(e){this._audio.preservesPitch=e}get paused(){return this._isVirtualPlay?this._virtualPaused:this._audio.paused}get source(){return this._audio.src}set source(e){e!==this._audio.src&&(this._audio.src=e,this._metadataLoaded=!1,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._audio.load())}get metadataLoaded(){return this._metadataLoaded}async _virtualPlay(){this._metadataLoaded?(this._virtualPaused&&(this._virtualStartTime=performance.now()/1e3-this._virtualPauseCurrentTime/this._playbackRate,this._virtualPaused=!1),this._isVirtualPlay||(this._isVirtualPlay=!0,this.onMuteStateChangedObservable.notifyObservers()),this._onPlay()):await new Promise(((e,t)=>{const i=()=>{this._virtualPaused&&(this._virtualStartTime=performance.now()/1e3-this._virtualPauseCurrentTime/this._playbackRate,this._virtualPaused=!1),this._isVirtualPlay||(this._isVirtualPlay=!0,this.onMuteStateChangedObservable.notifyObservers()),this._onPlay(),this.onLoadErrorObservable.removeCallback(s),e()},s=()=>{this.onDurationChangedObservable.removeCallback(i),t(new DOMException("The media resource indicated by the src attribute or assigned media provider object was not suitable.","NotSupportedError"))};this.onDurationChangedObservable.addOnce(i),this.onLoadErrorObservable.addOnce(s)}))}_playRequestBlocking=!1;async play(){if(!this._isVirtualPlay||this._virtualPaused)if(this._isVirtualPlay)await this._virtualPlay();else if(!this._playRequestBlocking){this._playRequestBlocking=!0;try{await this._audio.play()}catch(e){if(!(e instanceof DOMException&&"NotAllowedError"===e.name))throw e;await this._virtualPlay()}finally{this._playRequestBlocking=!1}}}pause(){if(this._isVirtualPlay){if(this._virtualPaused)return;this._virtualPaused=!0,this._virtualPauseCurrentTime=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate,this._onPause()}else this._audio.pause()}dispose(){if(null===this._audio)return;const e=this._audio;e.pause(),e.ondurationchange=null,e.onerror=null,e.onplaying=null,e.onpause=null,e.onseeked=null,e.src="",e.load(),null!==this._pool?this._pool.return(e):this._audio.remove(),this.onLoadErrorObservable.clear(),this.onDurationChangedObservable.clear(),this.onPlaybackRateChangedObservable.clear(),this.onMuteStateChangedObservable.clear(),this.onPlayObservable.clear(),this.onPauseObservable.clear(),this.onSeekObservable.clear(),null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose),this._audio=null,this._pool=null}}var Hc,Wc=function(e,t,i,s){var r,n=arguments.length,a=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(n<3?r(a):n>3?r(t,i,a):r(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a};B.AddNodeConstructor("MmdCamera",((e,t)=>()=>new Xc(e,void 0,t)));class Xc extends se{ignoreParentScaling=!1;rotation=new I.Pq;distance=-45;_viewMatrix=I.uq.Zero();_tmpUpVector=I.Pq.Zero();_tmpTargetVector=I.Pq.Zero();onCurrentAnimationChangedObservable;_animations;_animationNameMap=new Map;_currentAnimation;constructor(e,t=new I.Pq(0,10,0),i,s=!0){super(e,t,i,s),this.fov=Math.PI/180*30,this.onCurrentAnimationChangedObservable=new C.cP,this._animations=[],this._animationNameMap=new Map,this._currentAnimation=null}addAnimation(e){let t;if(!e.createRuntimeCameraAnimation)throw new Error('animation is not MmdAnimation or MmdCameraAnimationGroup or MmdCompositeAnimation. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimationGroup" or "babylon-mmd/esm/Runtime/Animation/mmdCompositeRuntimeCameraAnimation"?');t=e.createRuntimeCameraAnimation(this);const i=this._animationNameMap.get(e.name);if(i){const e=this._animations.indexOf(i),s=this._animations[e];this._animations[e]=t,this._currentAnimation===s&&(this._currentAnimation=t,this.onCurrentAnimationChangedObservable.notifyObservers(this._currentAnimation))}else this._animations.push(t);this._animationNameMap.set(e.name,t)}removeAnimation(e){const t=this._animations[e];if(void 0!==t){this._currentAnimation===t&&(this._currentAnimation=null,this.onCurrentAnimationChangedObservable.notifyObservers(null));for(const[e,i]of this._animationNameMap)if(i===t){this._animationNameMap.delete(e);break}this._animations.splice(e,1),t.dispose?.()}}setAnimation(e){if(null===e)return void(null!==this._currentAnimation&&(this._currentAnimation=null,this.onCurrentAnimationChangedObservable.notifyObservers(null)));const t=this._animationNameMap.get(e);if(void 0===t)throw new Error(`Animation ${e} is not found`);this._currentAnimation=t,this.onCurrentAnimationChangedObservable.notifyObservers(this._currentAnimation)}get runtimeAnimations(){return this._animations}get currentAnimation(){return this._currentAnimation}animate(e){null!==this._currentAnimation&&this._currentAnimation.animate(e)}_storedPosition=null;_storedRotation=null;_storedDistance=0;storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this._storedDistance=this.distance,super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.distance=this._storedDistance,!0)}_initCache(){super._initCache(),this._cache.rotation=new I.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.distance=Number.MAX_VALUE}_updateCache(e){e||super._updateCache(),this._cache.rotation.copyFrom(this.rotation),this._cache.distance=this.distance}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache.rotation.equals(this.rotation)&&this._cache.distance===this.distance}static _RotationMatrix=new I.uq;static _CameraEyePosition=new I.Pq;static _UpVector=new I.Pq;static _TargetVector=new I.Pq;_getViewMatrix(){const e=I.uq.RotationYawPitchRollToRef(-this.rotation.y,-this.rotation.x,-this.rotation.z,Xc._RotationMatrix),t=this.position.addToRef(I.Pq.TransformCoordinatesFromFloatsToRef(0,0,this.distance,e,Xc._CameraEyePosition),Xc._CameraEyePosition),i=I.Pq.TransformNormalFromFloatsToRef(0,0,1,e,Xc._TargetVector).addInPlace(t),s=I.Pq.TransformNormalFromFloatsToRef(0,1,0,e,Xc._UpVector);if(this.ignoreParentScaling){if(this.parent){const e=this.parent.getWorldMatrix();I.Pq.TransformCoordinatesToRef(t,e,this._globalPosition),I.Pq.TransformCoordinatesToRef(i,e,this._tmpTargetVector),I.Pq.TransformNormalToRef(s,e,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t),this._tmpTargetVector.copyFrom(i),this._tmpUpVector.copyFrom(s);return this.getScene().useRightHandedSystem?I.uq.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):I.uq.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix),this._viewMatrix}if(this.getScene().useRightHandedSystem?I.uq.LookAtRHToRef(t,i,s,this._viewMatrix):I.uq.LookAtLHToRef(t,i,s,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t);return this._viewMatrix}getClassName(){return"MmdCamera"}}Wc([(0,D.P_)()],Xc.prototype,"rotation",void 0),Wc([(0,D.lK)()],Xc.prototype,"distance",void 0),function(e){e.isMmdMesh=function(e){return!(null===e.metadata||!e.metadata.isMmdModel)},e.isMmdSkinnedMesh=function(e){return!(null===e.metadata||!e.metadata.isMmdModel)&&null!==e.metadata.skeleton}}(Hc||(Hc={}));class Kc{isLocal;affectRotation;affectPosition;ratio;targetBone;appendPosition=I.Pq.Zero();appendRotation=I.PT.Identity();constructor(e,t,i){this.isLocal=!!(e&wa.Bone.Flag.LocalAppendTransform),this.affectRotation=!!(e&wa.Bone.Flag.HasAppendRotate),this.affectPosition=!!(e&wa.Bone.Flag.HasAppendMove),this.ratio=t.ratio,this.targetBone=i}static _IdentityQuaternion=I.PT.Identity();static _TargetBoneWorldMatrix=I.uq.Identity();update(e,t){const i=this.targetBone;if(this.affectRotation){const t=this.appendRotation;if(this.isLocal){const e=i.getWorldMatrixToRef(Kc._TargetBoneWorldMatrix);I.PT.FromRotationMatrixToRef(e,t)}else null!==i.appendTransformSolver&&i.appendTransformSolver.affectRotation?t.copyFrom(i.appendTransformSolver.appendRotation):i.getAnimatedRotationToRef(t);null===i.ikChainInfo||this.isLocal||i.ikChainInfo.ikRotation.multiplyToRef(t,t),1!==this.ratio&&I.PT.SlerpToRef(Kc._IdentityQuaternion,t,this.ratio,t),e.multiplyToRef(t,t)}if(this.affectPosition){const e=this.appendPosition;if(this.isLocal){const t=i.getWorldMatrixToRef(Kc._TargetBoneWorldMatrix);t.multiplyToRef(i.linkedBone.getAbsoluteInverseBindMatrix(),t),t.getTranslationToRef(e)}else null!==i.appendTransformSolver&&i.appendTransformSolver.affectPosition?e.copyFrom(i.appendTransformSolver.appendPosition):i.getAnimationPositionOffsetToRef(e);1!==this.ratio&&e.scaleInPlace(this.ratio),e.addInPlace(t)}}}class Qc{localRotation;localPosition;ikRotation;constructor(){this.localRotation=I.PT.Identity(),this.localPosition=I.Pq.Zero(),this.ikRotation=I.PT.Identity()}}class Yc{bone;minimumAngle;maximumAngle;rotationOrder;solveAxis;constructor(e,t){if(this.bone=e,void 0!==t){{const e=t.minimumAngle,i=t.maximumAngle,s=Math.min(e[0],i[0]),r=Math.min(e[1],i[1]),n=Math.min(e[2],i[2]),a=Math.max(e[0],i[0]),o=Math.max(e[1],i[1]),l=Math.max(e[2],i[2]);this.minimumAngle=new I.Pq(s,r,n),this.maximumAngle=new I.Pq(a,o,l)}const e=this.minimumAngle,i=this.maximumAngle,s=.5*Math.PI;-s<e.x&&i.x<s?this.rotationOrder=0:-s<e.y&&i.y<s?this.rotationOrder=1:this.rotationOrder=2,0===e.x&&0===i.x&&0===e.y&&0===i.y&&0===e.z&&0===i.z?this.solveAxis=1:0===e.y&&0===i.y&&0===e.z&&0===i.z?this.solveAxis=2:0===e.x&&0===i.x&&0===e.z&&0===i.z?this.solveAxis=3:0===e.x&&0===i.x&&0===e.y&&0===i.y?this.solveAxis=4:this.solveAxis=0}else this.minimumAngle=null,this.maximumAngle=null,this.rotationOrder=2,this.solveAxis=0}}class qc{index;get iteration(){return this._iteration}set iteration(e){this._iteration=Math.min(e,256)}limitAngle;ikBone;targetBone;_iteration;_ikChains;_canSkipWhenPhysicsEnabled;constructor(e,t,i){this.index=e,this._iteration=1,this.limitAngle=Math.PI,this.ikBone=t,this.targetBone=i,this._ikChains=[],this._canSkipWhenPhysicsEnabled=!0}addIkChain(e,t,i){e.ikChainInfo=new Qc,t||(this._canSkipWhenPhysicsEnabled=!1);const s=new Yc(e,i);this._ikChains.push(s)}get canSkipWhenPhysicsEnabled(){return this._canSkipWhenPhysicsEnabled}static _IkPosition=new I.Pq;static _TargetPosition=new I.Pq;solve(e){if(0===this._ikChains.length)return;const t=this.ikBone,i=this.targetBone,s=this._ikChains;for(let e=0;e<s.length;++e)s[e].bone.ikChainInfo.ikRotation.set(0,0,0,1);const r=t.getWorldTranslationToRef(qc._IkPosition);i.updateWorldMatrix(e,!0);const n=i.getWorldTranslationToRef(qc._TargetPosition);if(I.Pq.DistanceSquared(r,n)<1e-8)return;for(let t=s.length-1;t>=0;--t)s[t].bone.updateWorldMatrix(e,!1);if(i.updateWorldMatrix(!1,!1),i.getWorldTranslationToRef(n),I.Pq.DistanceSquared(r,n)<1e-8)return;const a=this.iteration,o=a>>1;for(let e=0;e<a;++e){for(let t=0;t<s.length;++t){const i=s[t];1!==i.solveAxis&&this._solveChain(i,t,r,n,e<o)}if(I.Pq.DistanceSquared(r,n)<1e-8)break}}static _ChainPosition=new I.Pq;static _ChainTargetVector=new I.Pq;static _ChainIkVector=new I.Pq;static _ChainRotationAxis=new I.Pq;static _ChainParentRotationMatrix=new I.uq;static _Axis=new I.Pq;static _Rotation=new I.PT;static _RotationMatrix=new I.uq;static _Right=I.Pq.Right();static _Up=I.Pq.Up();static _Forward=I.Pq.Forward();static _Rotation2=new I.PT;static _Rotation3=new I.PT;_solveChain(e,t,i,s,r){const n=this.targetBone,a=e.bone,o=a.getWorldTranslationToRef(qc._ChainPosition),l=o.subtractToRef(s,qc._ChainTargetVector).normalize(),h=o.subtractToRef(i,qc._ChainIkVector).normalize(),c=I.Pq.CrossToRef(l,h,qc._ChainRotationAxis);if(c.lengthSquared()<1e-8)return;const u=null!==a.parentBone?a.parentBone.getWorldMatrixToRef(qc._ChainParentRotationMatrix):I.uq.IdentityToRef(qc._ChainParentRotationMatrix);if(u.setTranslationFromFloats(0,0,0),null!==e.minimumAngle&&r)switch(e.solveAxis){case 0:u.transposeToRef(u),I.Pq.TransformNormalToRef(c,u,c),c.normalize();break;case 2:{const e=u.m,t=I.Pq.Dot(c,qc._Axis.set(e[0],e[1],e[2]));c.x=0<=t?1:-1,c.y=0,c.z=0;break}case 3:{const e=u.m,t=I.Pq.Dot(c,qc._Axis.set(e[4],e[5],e[6]));c.x=0,c.y=0<=t?1:-1,c.z=0;break}case 4:{const e=u.m,t=I.Pq.Dot(c,qc._Axis.set(e[8],e[9],e[10]));c.x=0,c.y=0,c.z=0<=t?1:-1;break}}else u.transposeToRef(u),I.Pq.TransformNormalToRef(c,u,c),c.normalize();let d=I.Pq.Dot(l,h);d=Math.max(-1,Math.min(1,d));const _=Math.min(this.limitAngle*(t+1),Math.acos(d)),p=I.PT.RotationAxisToRef(c,_,qc._Rotation);if(p.multiplyToRef(a.ikChainInfo.ikRotation,a.ikChainInfo.ikRotation),null!==e.minimumAngle){a.ikChainInfo.ikRotation.multiplyToRef(a.ikChainInfo.localRotation,p);const t=I.uq.FromQuaternionToRef(p,qc._RotationMatrix).m,i=88*Math.PI/180;let s,n,o;switch(e.rotationOrder){case 0:{s=Math.asin(-t[9]),Math.abs(s)>i&&(s=s<0?-i:i);let l=Math.cos(s);0!==l&&(l=1/l),n=Math.atan2(t[8]*l,t[10]*l),o=Math.atan2(t[1]*l,t[5]*l);{const t=e.minimumAngle,i=e.maximumAngle;s=this._limitAngle(s,t.x,i.x,r),n=this._limitAngle(n,t.y,i.y,r),o=this._limitAngle(o,t.z,i.z,r)}I.PT.RotationAxisToRef(qc._Up,n,a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(I.PT.RotationAxisToRef(qc._Right,s,qc._Rotation2),a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(I.PT.RotationAxisToRef(qc._Forward,o,qc._Rotation2),a.ikChainInfo.ikRotation);break}case 1:{n=Math.asin(-t[2]),Math.abs(n)>i&&(n=n<0?-i:i);let l=Math.cos(n);0!==l&&(l=1/l),s=Math.atan2(t[6]*l,t[10]*l),o=Math.atan2(t[1]*l,t[0]*l);{const t=e.minimumAngle,i=e.maximumAngle;s=this._limitAngle(s,t.x,i.x,r),n=this._limitAngle(n,t.y,i.y,r),o=this._limitAngle(o,t.z,i.z,r)}I.PT.RotationAxisToRef(qc._Forward,o,a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(I.PT.RotationAxisToRef(qc._Up,n,qc._Rotation2),a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(I.PT.RotationAxisToRef(qc._Right,s,qc._Rotation2),a.ikChainInfo.ikRotation);break}case 2:{o=Math.asin(-t[4]),Math.abs(o)>i&&(o=o<0?-i:i);let l=Math.cos(o);0!==l&&(l=1/l),s=Math.atan2(t[6]*l,t[5]*l),n=Math.atan2(t[8]*l,t[0]*l);{const t=e.minimumAngle,i=e.maximumAngle;s=this._limitAngle(s,t.x,i.x,r),n=this._limitAngle(n,t.y,i.y,r),o=this._limitAngle(o,t.z,i.z,r)}I.PT.RotationAxisToRef(qc._Right,s,a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(I.PT.RotationAxisToRef(qc._Forward,o,qc._Rotation2),a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(I.PT.RotationAxisToRef(qc._Up,n,qc._Rotation2),a.ikChainInfo.ikRotation);break}}const l=I.PT.InverseToRef(a.ikChainInfo.localRotation,qc._Rotation3);a.ikChainInfo.ikRotation.multiplyToRef(l,a.ikChainInfo.ikRotation)}const f=this._ikChains;for(let e=t;e>=0;--e)f[e].bone.updateIkChainWorldMatrix();n.updateWorldMatrix(!1,!1),n.getWorldTranslationToRef(s)}_limitAngle(e,t,i,s){if(e<t){const r=2*t-e;return r<=i&&s?r:t}if(e>i){const r=2*i-e;return r>=t&&s?r:i}return e}}class $c{_runtimeBones;_materials;_morphs;_morphIndexMap;_morphWeights;_activeMorphs;morphTargetManagers;constructor(e,t,i,s,r,n){if(this._runtimeBones=e??[],null!==s){const e=this._materials=new Array(t.length);for(let r=0;r<t.length;++r){const n=t[r],a=[];for(let e=0;e<i.length;++e)i[e].material===n&&a.push(i[e]);e[r]=new s(n,a)}}else this._materials=[];const a=this._morphs=this._createRuntimeMorphData(r,null!==e,null!==s),o=this._morphIndexMap=new Map;for(let e=0;e<a.length;++e){const t=a[e];let i=o.get(t.name);void 0===i&&(i=[],o.set(t.name,i)),i.push(e)}this._morphWeights=new Float32Array(a.length),this._activeMorphs=new Set,this.morphTargetManagers=n}getMorphWeight(e){const t=this._morphIndexMap.get(e);return void 0===t?0:this._morphWeights[t[0]]}getMorphIndices(e){return this._morphIndexMap.get(e)}getMorphWeightFromIndex(e){return this._morphWeights[e]}getMorphWeights(){return this._morphWeights}resetMorphWeights(){this._morphWeights.fill(0)}_updatedMaterials=new Set;update(){const e=this._morphs,t=this._morphIndexMap,i=this._morphWeights,s=this._activeMorphs,r=this.morphTargetManagers;for(let e=0;e<r.length;++e)r[e].areUpdatesFrozen=!0;for(const i of s){const s=t.get(i);for(let t=0;t<s.length;++t)this._resetMorph(e[s[t]])}for(const r of s){const n=t.get(r);for(let t=0;t<n.length;++t){const a=n[t],o=i[a];this._applyMorph(e[a],o),0===o&&s.delete(r)}}for(let e=0;e<r.length;++e)r[e].areUpdatesFrozen=!1;const n=this._updatedMaterials;for(const e of n)e.applyChanges();n.clear()}get morphs(){return this._morphs}_createRuntimeMorphData(e,t,i){const s=[];for(let r=0;r<e.length;++r){const n=e[r];let a=null,o=null,l=null,h=null;switch(n.type){case wa.Morph.Type.GroupMorph:o=n.indices,l=n.ratios;break;case wa.Morph.Type.BoneMorph:t?(o=n.indices,l=n.positions,h=n.rotations):(o=new Int32Array(0),l=new Float32Array(0),h=new Float32Array(0));break;case wa.Morph.Type.MaterialMorph:if(i){const e=n.elements,t=new Array(e.length);for(let i=0;i<e.length;++i){const s=e[i];s.type===wa.Morph.MaterialMorph.Type.Multiply?t[i]={index:s.index,type:s.type,diffuse:1!==s.diffuse[0]||1!==s.diffuse[1]||1!==s.diffuse[2]||1!==s.diffuse[3]?s.diffuse:null,specular:1!==s.specular[0]||1!==s.specular[1]||1!==s.specular[2]?s.specular:null,shininess:1!==s.shininess?s.shininess:null,ambient:1!==s.ambient[0]||1!==s.ambient[1]||1!==s.ambient[2]?s.ambient:null,edgeColor:1!==s.edgeColor[0]||1!==s.edgeColor[1]||1!==s.edgeColor[2]||1!==s.edgeColor[3]?s.edgeColor:null,edgeSize:1!==s.edgeSize?s.edgeSize:null,textureColor:1!==s.textureColor[0]||1!==s.textureColor[1]||1!==s.textureColor[2]||1!==s.textureColor[3]?s.textureColor:null,sphereTextureColor:1!==s.sphereTextureColor[0]||1!==s.sphereTextureColor[1]||1!==s.sphereTextureColor[2]||1!==s.sphereTextureColor[3]?s.sphereTextureColor:null,toonTextureColor:1!==s.toonTextureColor[0]||1!==s.toonTextureColor[1]||1!==s.toonTextureColor[2]||1!==s.toonTextureColor[3]?s.toonTextureColor:null}:t[i]={index:s.index,type:s.type,diffuse:0!==s.diffuse[0]||0!==s.diffuse[1]||0!==s.diffuse[2]||0!==s.diffuse[3]?s.diffuse:null,specular:0!==s.specular[0]||0!==s.specular[1]||0!==s.specular[2]?s.specular:null,shininess:0!==s.shininess?s.shininess:null,ambient:0!==s.ambient[0]||0!==s.ambient[1]||0!==s.ambient[2]?s.ambient:null,edgeColor:0!==s.edgeColor[0]||0!==s.edgeColor[1]||0!==s.edgeColor[2]||0!==s.edgeColor[3]?s.edgeColor:null,edgeSize:0!==s.edgeSize?s.edgeSize:null,textureColor:0!==s.textureColor[0]||0!==s.textureColor[1]||0!==s.textureColor[2]||0!==s.textureColor[3]?s.textureColor:null,sphereTextureColor:0!==s.sphereTextureColor[0]||0!==s.sphereTextureColor[1]||0!==s.sphereTextureColor[2]||0!==s.sphereTextureColor[3]?s.sphereTextureColor:null,toonTextureColor:0!==s.toonTextureColor[0]||0!==s.toonTextureColor[1]||0!==s.toonTextureColor[2]||0!==s.toonTextureColor[3]?s.toonTextureColor:null}}a=t}else a=[];break;case wa.Morph.Type.UvMorph:case wa.Morph.Type.AdditionalUvMorph1:case wa.Morph.Type.AdditionalUvMorph2:case wa.Morph.Type.AdditionalUvMorph3:case wa.Morph.Type.AdditionalUvMorph4:case wa.Morph.Type.VertexMorph:o=n.morphTargets}const c={name:n.name,type:n.type,materialElements:a,elements:o,elements2:l,elements3:h};s.push(c)}return s}_groupMorphForeach(e,t){const i=this._morphs,s=e.elements,r=e.elements2;for(let e=0;e<s.length;++e){const n=s[e],a=r[e],o=i[n];void 0!==o&&o.type!==wa.Morph.Type.GroupMorph&&t(o,a)}}_resetMorph(e){switch(e.type){case wa.Morph.Type.GroupMorph:this._groupMorphForeach(e,((e,t)=>this._resetMorph(e)));break;case wa.Morph.Type.BoneMorph:this._resetBoneMorph(e);break;case wa.Morph.Type.MaterialMorph:{const t=e.materialElements;for(let e=0;e<t.length;++e){const i=t[e],s=this._materials;if(-1===i.index)for(let e=0;e<s.length;++e)s[e]?.reset();else s[i.index]?.reset()}}break;case wa.Morph.Type.VertexMorph:case wa.Morph.Type.UvMorph:case wa.Morph.Type.AdditionalUvMorph1:case wa.Morph.Type.AdditionalUvMorph2:case wa.Morph.Type.AdditionalUvMorph3:case wa.Morph.Type.AdditionalUvMorph4:{const t=e.elements;for(let e=0;e<t.length;++e)t[e].influence=0}}}_applyMorph(e,t){switch(e.type){case wa.Morph.Type.GroupMorph:this._groupMorphForeach(e,((e,i)=>this._applyMorph(e,t*i)));break;case wa.Morph.Type.BoneMorph:this._applyBoneMorph(e,t);break;case wa.Morph.Type.MaterialMorph:{const i=e.materialElements;for(let e=0;e<i.length;++e){const s=i[e],r=this._materials;if(-1===s.index)for(let e=0;e<r.length;++e){const i=r[e];void 0!==i&&this._applyMaterialMorph(s,i,t)}else{const e=r[s.index];void 0!==e&&this._applyMaterialMorph(s,e,t)}}}break;case wa.Morph.Type.VertexMorph:case wa.Morph.Type.UvMorph:case wa.Morph.Type.AdditionalUvMorph1:case wa.Morph.Type.AdditionalUvMorph2:case wa.Morph.Type.AdditionalUvMorph3:case wa.Morph.Type.AdditionalUvMorph4:{const i=e.elements;for(let e=0;e<i.length;++e)i[e].influence+=t}}}_applyMaterialMorph(e,t,i){if(e.type===wa.Morph.MaterialMorph.Type.Multiply){if(null!==e.diffuse){const s=t.diffuse;for(let t=0;t<4;++t)s[t]=s[t]+(s[t]*e.diffuse[t]-s[t])*i}if(null!==e.specular){const s=t.specular;for(let t=0;t<3;++t)s[t]=s[t]+(s[t]*e.specular[t]-s[t])*i}if(null!==e.shininess&&(t.shininess=t.shininess+(t.shininess*e.shininess-t.shininess)*i),null!==e.ambient){const s=t.ambient;for(let t=0;t<3;++t)s[t]=s[t]+(s[t]*e.ambient[t]-s[t])*i}if(null!==e.edgeColor){const s=t.edgeColor;for(let t=0;t<4;++t)s[t]=s[t]+(s[t]*e.edgeColor[t]-s[t])*i}if(null!==e.edgeSize&&(t.edgeSize=t.edgeSize+(t.edgeSize*e.edgeSize-t.edgeSize)*i),null!==e.textureColor){const s=t.textureMultiplicativeColor;for(let t=0;t<4;++t)s[t]=s[t]+(s[t]*e.textureColor[t]-s[t])*i}if(null!==e.sphereTextureColor){const s=t.sphereTextureMultiplicativeColor;for(let t=0;t<4;++t)s[t]=s[t]+(s[t]*e.sphereTextureColor[t]-s[t])*i}if(null!==e.toonTextureColor){const s=t.toonTextureMultiplicativeColor;for(let t=0;t<4;++t)s[t]=s[t]+(s[t]*e.toonTextureColor[t]-s[t])*i}}else{if(null!==e.diffuse){const s=t.diffuse;for(let t=0;t<4;++t)s[t]+=e.diffuse[t]*i}if(null!==e.specular){const s=t.specular;for(let t=0;t<3;++t)s[t]+=e.specular[t]*i}if(null!==e.shininess&&(t.shininess+=e.shininess*i),null!==e.ambient){const s=t.ambient;for(let t=0;t<3;++t)s[t]+=e.ambient[t]*i}if(null!==e.edgeColor){const s=t.edgeColor;for(let t=0;t<4;++t)s[t]+=e.edgeColor[t]*i}if(null!==e.edgeSize&&(t.edgeSize+=e.edgeSize*i),null!==e.textureColor){const s=t.textureAdditiveColor;for(let t=0;t<4;++t)s[t]+=e.textureColor[t]*i}if(null!==e.sphereTextureColor){const s=t.sphereTextureAdditiveColor;for(let t=0;t<4;++t)s[t]+=e.sphereTextureColor[t]*i}if(null!==e.toonTextureColor){const s=t.toonTextureAdditiveColor;for(let t=0;t<4;++t)s[t]+=e.toonTextureColor[t]*i}}this._updatedMaterials.add(t)}}class jc extends $c{setMorphWeight(e,t){const i=this._morphIndexMap.get(e);if(void 0===i)return;const s=this._morphWeights;for(let e=0;e<i.length;++e)s[i[e]]=t;0!==t&&this._activeMorphs.add(e)}setMorphWeightFromIndex(e,t){this._morphWeights[e]=t,0!==t&&this._activeMorphs.add(this._morphs[e].name)}_resetBoneMorph(e){const t=this._runtimeBones,i=e.elements;for(let e=0;e<i.length;++e){const s=t[i[e]];void 0!==s&&(s.morphPositionOffset.set(0,0,0),s.morphRotationOffset.set(0,0,0,1),s.disableMorph())}}_tempQuaternion=new I.PT;_applyBoneMorph(e,t){const i=this._runtimeBones,s=e.elements,r=e.elements2,n=e.elements3;for(let e=0;e<s.length;++e){const a=i[s[e]];void 0!==a&&(a.morphPositionOffset.addInPlaceFromFloats(r[3*e+0]*t,r[3*e+1]*t,r[3*e+2]*t),I.PT.SlerpToRef(a.morphRotationOffset,this._tempQuaternion.copyFromFloats(n[4*e+0],n[4*e+1],n[4*e+2],n[4*e+3]),t,a.morphRotationOffset),0!==t&&a.enableMorph())}}}function Zc(e,t){t.set(e.x,e.y,e.z);const i=t.length();if(i>=1e-8){const s=2*Math.atan2(i,e.w);return t.scaleInPlace(1/i),s}return t.set(1,0,0),0}class Jc{linkedBone;name;parentBone;childBones;transformOrder;flag;transformAfterPhysics;appendTransformSolver;axisLimit;ikSolver;morphPositionOffset;morphRotationOffset;ikChainInfo;worldMatrix;getAnimatedRotationToRef;getAnimationPositionOffsetToRef;constructor(e,t,i,s){this.linkedBone=e,this.name=t.name,this.parentBone=null,this.childBones=[],this.transformOrder=t.transformOrder,this.flag=t.flag,this.transformAfterPhysics=!!(t.flag&wa.Bone.Flag.TransformAfterPhysics),this.appendTransformSolver=null,void 0!==t.axisLimit?this.axisLimit=I.Pq.FromArray(t.axisLimit).normalize():this.axisLimit=null,this.ikSolver=null,this.morphPositionOffset=I.Pq.Zero(),this.morphRotationOffset=I.PT.Identity(),this.ikChainInfo=null,this.worldMatrix=new Float32Array(i.buffer,i.byteOffset+16*s*4,16),this.getAnimatedRotationToRef=this._getAnimatedRotationToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetToRef}static _TempAxis=new I.Pq;_getAnimatedRotationToRef(e){if(null!==this.axisLimit){const t=this.axisLimit;if(0===t.x&&0===t.y&&0===t.z)e.set(0,0,0,1);else{const i=Jc._TempAxis;let s=Zc(this.linkedBone.rotationQuaternion,i);I.Pq.Dot(i,t)<0&&(s=-s),I.PT.RotationAxisToRef(t,s,e)}}else e.copyFrom(this.linkedBone.rotationQuaternion);return e}_getAnimatedRotationWithMorphToRef(e){if(null!==this.axisLimit){const t=this.axisLimit;if(0===t.x&&0===t.y&&0===t.z)e.set(0,0,0,1);else{const i=Jc._TempAxis;let s=Zc(this.linkedBone.rotationQuaternion,i);I.Pq.Dot(i,t)<0&&(s=-s),I.PT.RotationAxisToRef(t,s,e)}}else e.copyFrom(this.linkedBone.rotationQuaternion);return this.morphRotationOffset.multiplyToRef(e,e)}static _TempVector3=new I.Pq;_getAnimationPositionOffsetToRef(e){return e.copyFrom(this.linkedBone.position),this.linkedBone.getRestMatrix().getTranslationToRef(Jc._TempVector3),e.subtractInPlace(Jc._TempVector3)}_getAnimationPositionOffsetWithMorphToRef(e){return e.copyFrom(this.linkedBone.position),e.addInPlace(this.morphPositionOffset),this.linkedBone.getRestMatrix().getTranslationToRef(Jc._TempVector3),e.subtractInPlace(Jc._TempVector3)}enableMorph(){this.getAnimatedRotationToRef=this._getAnimatedRotationWithMorphToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetWithMorphToRef}disableMorph(){this.getAnimatedRotationToRef=this._getAnimatedRotationToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetToRef}resetTransformState(){const e=this.worldMatrix;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,null!==this.ikChainInfo&&(this.ikChainInfo.localRotation.set(0,0,0,1),this.ikChainInfo.localPosition.set(0,0,0),this.ikChainInfo.ikRotation.set(0,0,0,1)),null!==this.appendTransformSolver&&(this.appendTransformSolver.appendRotation.set(0,0,0,1),this.appendTransformSolver.appendPosition.set(0,0,0))}static _TempRotation=I.PT.Identity();static _TempPosition=I.Pq.Zero();static _TempPosition2=I.Pq.Zero();static _TempMatrix=I.uq.Identity();static _TempMatrix2=I.uq.Identity();updateWorldMatrix(e,t){const i=this.getAnimatedRotationToRef(Jc._TempRotation),s=this.getAnimationPositionOffsetToRef(Jc._TempPosition);null!==this.appendTransformSolver&&(this.appendTransformSolver.update(i,s),this.appendTransformSolver.affectRotation&&i.copyFrom(this.appendTransformSolver.appendRotation),this.appendTransformSolver.affectPosition&&s.copyFrom(this.appendTransformSolver.appendPosition)),null!==this.ikChainInfo&&(this.ikChainInfo.localRotation.copyFrom(i),this.ikChainInfo.localPosition.copyFrom(s),this.ikChainInfo.ikRotation.multiplyToRef(i,i));const r=Jc._TempMatrix,n=this.linkedBone.getRestMatrix().getTranslationToRef(Jc._TempPosition2).addInPlace(s),a=this.linkedBone.scaling;if(1!==a.x||1!==a.y||1!==a.z?I.uq.ComposeToRef(a,i,n,r):(I.uq.FromQuaternionToRef(i,r),r.setTranslation(n)),null!==this.parentBone){const e=this.parentBone.getWorldMatrixToRef(Jc._TempMatrix2);r.multiplyToRef(e,r)}r.copyToArray(this.worldMatrix),t&&null!==this.ikSolver&&(e&&this.ikSolver.canSkipWhenPhysicsEnabled||this.ikSolver.solve(e))}updateIkChainWorldMatrix(){const e=this.ikChainInfo,t=e.ikRotation.multiplyToRef(e.localRotation,Jc._TempRotation),i=Jc._TempMatrix,s=this.linkedBone.scaling;if(1!==s.x||1!==s.y||1!==s.z){I.uq.ScalingToRef(s.x,s.y,s.z,i);const e=I.uq.FromQuaternionToRef(t,Jc._TempMatrix2);i.multiplyToRef(e,i)}else I.uq.FromQuaternionToRef(t,i);const r=this.linkedBone.getRestMatrix().getTranslationToRef(Jc._TempPosition);if(r.addInPlace(e.localPosition),i.setTranslation(r),null!==this.parentBone){const e=this.parentBone.getWorldMatrixToRef(Jc._TempMatrix2);i.multiplyToRef(e,i)}i.copyToArray(this.worldMatrix);const n=this.childBones;for(let e=0;e<n.length;++e)n[e]._updateWorldMatrixRecursive()}static _WorldMatrixUpdateStack=[];_updateWorldMatrixRecursive(){const e=Jc._WorldMatrixUpdateStack;for(e.length=0,e.push(this);e.length>0;){const t=e.pop();t.updateWorldMatrix(!1,!1);for(let i=0,s=t.childBones.length;i<s;++i)e.push(t.childBones[i])}}getWorldMatrixToRef(e){return I.uq.FromArrayToRef(this.worldMatrix,0,e)}getWorldTranslationToRef(e){return I.Pq.FromArrayToRef(this.worldMatrix,12,e)}setWorldTranslationFromRef(e){e.toArray(this.worldMatrix,12)}get ikSolverIndex(){return null!==this.ikSolver?this.ikSolver.index:-1}}class eu{mesh;skeleton;worldTransformMatrices;ikSolverStates;runtimeBones;morph;_physicsModel;_logger;_sortedRuntimeBones;onCurrentAnimationChangedObservable;_animations;_currentAnimation;_needStateReset;constructor(e,t,i,s,r){this._logger=r;const n=e.metadata,a=e;a.metadata={isRuntimeMmdModel:!0,header:n.header,meshes:n.meshes,materials:n.materials,skeleton:n.skeleton},this.mesh=a,this.skeleton=t;const o=this.worldTransformMatrices=new Float32Array(16*t.bones.length);{let e=0;const t=n.bones;for(let i=0;i<t.length;++i)void 0!==t[i].ik&&(e+=1);this.ikSolverStates=new Uint8Array(e).fill(1)}t.prepare(),this._disableSkeletonWorldMatrixUpdate(t);const l=this.runtimeBones=this._buildRuntimeSkeleton(t.bones,n.bones,n.rigidBodies,o);(this._sortedRuntimeBones=[...l]).sort(((e,t)=>e.transformOrder-t.transformOrder));const h=[];{const e=n.meshes;for(let t=0;t<e.length;++t){const i=e[t].morphTargetManager;null!==i&&h.push(i)}}this.morph=new jc(l,n.materials,n.meshes,i,n.morphs,h),this._physicsModel=null!==s?s.buildPhysics(e,l,n.rigidBodies,n.joints,r):null,this.onCurrentAnimationChangedObservable=new C.cP,this._animations=[],this._currentAnimation=null,this._needStateReset=!1}dispose(){this._enableSkeletonWorldMatrixUpdate(),this._physicsModel?.dispose(),this.onCurrentAnimationChangedObservable.clear();const e=this._animations;for(let t=0;t<e.length;++t)e[t].dispose?.();this._animations.length=0,this.mesh.metadata=null}get sortedRuntimeBones(){return this._sortedRuntimeBones}addAnimation(e,t,i=!0){let s;if(void 0===e.createRuntimeModelAnimation)throw new Error('animation is not MmdAnimation or MmdModelAnimationGroup or MmdCompositeAnimation. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimationGroup" or "babylon-mmd/esm/Runtime/Animation/mmdCompositeRuntimeModelAnimation"?');s=e.createRuntimeModelAnimation(this,t,this._logger);const r=this._animations.findIndex((t=>t.animation.name===e.name));if(-1!==r){const e=this._animations[r];this._animations[r]=s,this._currentAnimation===e&&(this._currentAnimation=s,this._resetPose(),this._needStateReset=!0,s.induceMaterialRecompile(i,this._logger),this.onCurrentAnimationChangedObservable.notifyObservers(s))}else this._animations.push(s)}removeAnimation(e){const t=this._animations[e];void 0!==t&&(this._currentAnimation===t&&(this._currentAnimation=null,this._resetPose(),this.onCurrentAnimationChangedObservable.notifyObservers(null)),this._animations.splice(e,1),t.dispose?.())}setAnimation(e,t=!0){if(null===e)return void(null!==this._currentAnimation&&(this._currentAnimation=null,this._resetPose(),this.onCurrentAnimationChangedObservable.notifyObservers(null)));const i=this._animations.findIndex((t=>t.animation.name===e));if(-1===i)throw new Error(`Animation '${e}' is not found.`);null!==this._currentAnimation&&(this._resetPose(),this._needStateReset=!0);const s=this._currentAnimation=this._animations[i];s.induceMaterialRecompile(t,this._logger),this.onCurrentAnimationChangedObservable.notifyObservers(s)}get runtimeAnimations(){return this._animations}get currentAnimation(){return this._currentAnimation}initializePhysics(){this._physicsModel?.initialize()}beforePhysics(e){null!==e&&(this._needStateReset&&(this._needStateReset=!1,this.morph.resetMorphWeights(),this.ikSolverStates.fill(1)),null!==this._currentAnimation&&this._currentAnimation.animate(e)),this.morph.update();for(let e=0;e<this._sortedRuntimeBones.length;++e)this._sortedRuntimeBones[e].resetTransformState();this._update(!1),this._physicsModel?.syncBodies()}afterPhysics(){const e=this._physicsModel;null!==e&&e.syncBones(),this._update(!0),this.mesh.metadata.skeleton._markAsDirty()}_update(e){const t=null!==this._physicsModel,i=this._sortedRuntimeBones;for(let s=0;s<i.length;++s){const r=i[s];r.transformAfterPhysics===e&&r.updateWorldMatrix(t,0!==this.ikSolverStates[r.ikSolverIndex])}}_buildRuntimeSkeleton(e,t,i,s){const r=[];for(let i=0;i<t.length;++i){const n=t[i];r.push(new Jc(e[i],n,s,i))}const n=new Set;{const e=new Map;for(let t=0;t<r.length;++t){const i=r[t];e.set(i.name,i)}for(let t=0;t<i.length;++t){const s=i[t];if(s.physicsMode===wa.RigidBody.PhysicsMode.FollowBone)continue;let a=r[s.boneIndex];void 0===a&&(a=e.get(i[t].name)),void 0!==a&&n.add(a)}}let a=0;for(let e=0;e<t.length;++e){const i=t[e],s=r[e],o=i.parentBoneIndex;if(0<=o&&o<r.length){const e=r[o];s.parentBone=e,e.childBones.push(s)}if(void 0!==i.appendTransform){const e=i.appendTransform.parentIndex;0<=e&&e<r.length?s.appendTransformSolver=new Kc(i.flag,i.appendTransform,r[e]):this._logger.error(`Invalid append transform target bone index: ${e}`)}if(void 0!==i.ik){const e=i.ik,t=e.target;if(0<=t&&t<r.length){const i=s.ikSolver=new qc(a,s,r[t]);a+=1,i.iteration=e.iteration,i.limitAngle=e.rotationConstraint;for(let t=0;t<e.links.length;++t){const s=e.links[t],a=s.target;if(0<=a&&a<r.length){const e=r[a];i.addIkChain(e,n.has(e),s.limitation)}else this._logger.error(`Invalid IK link bone index: ${a}`)}}else this._logger.error(`Invalid IK target bone index: ${t}`)}}return r}_originalComputeTransformMatrices=null;_disableSkeletonWorldMatrixUpdate(e){if(null!==this._originalComputeTransformMatrices)return;this._originalComputeTransformMatrices=e._computeTransformMatrices;const t=this.worldTransformMatrices;e._computeTransformMatrices=function(e,i){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const s=this.bones[i];if(s._childUpdateId+=1,-1!==s._index){const r=null===s._index?i:s._index;s.getAbsoluteInverseBindMatrix().multiplyToArray(I.uq.FromArrayToRef(t,16*i,s.getFinalMatrix()),e,16*r)}}this._identity.copyToArray(e,16*this.bones.length)}}_enableSkeletonWorldMatrixUpdate(){null!==this._originalComputeTransformMatrices&&(this.skeleton._computeTransformMatrices=this._originalComputeTransformMatrices,this._originalComputeTransformMatrices=null)}_resetPose(){const e=this._sortedRuntimeBones,t=new I.Pq,i=I.PT.Identity();for(let s=0;s<e.length;++s){const r=e[s].linkedBone;r.getRestMatrix().getTranslationToRef(t),r.position=t,r.setRotationQuaternion(i,mt.$x.LOCAL)}this.mesh.metadata.skeleton._markAsDirty()}}class tu{diffuse;specular;shininess;ambient;edgeColor;edgeSize;textureMultiplicativeColor;textureAdditiveColor;sphereTextureMultiplicativeColor;sphereTextureAdditiveColor;toonTextureMultiplicativeColor;toonTextureAdditiveColor;_material;_referencedMeshes;_initialDiffuse;_initialSpecular;_initialShininess;_initialAmbient;_initialEdgeColor;_initialEdgeSize;_initialTextureMultiplicativeColor;_initialTextureAdditiveColor;_initialSphereTextureMultiplicativeColor;_initialSphereTextureAdditiveColor;_initialToonTextureMultiplicativeColor;_initialToonTextureAdditiveColor;_initialTransparencyMode;constructor(e,t){this._material=e,this._referencedMeshes=t;const i=e.diffuseColor;this.diffuse=[i.r,i.g,i.b,e.alpha];const s=e.specularColor;this.specular=[s.r,s.g,s.b],this.shininess=e.specularPower;const r=e.ambientColor;this.ambient=[r.r,r.g,r.b];const n=e.outlineColor;this.edgeColor=[n.r,n.g,n.b,e.outlineAlpha],this.edgeSize=e.outlineWidth,this.textureMultiplicativeColor=[1,1,1,1],this.textureAdditiveColor=[0,0,0,0],this.sphereTextureMultiplicativeColor=[1,1,1,1],this.sphereTextureAdditiveColor=[0,0,0,0],this.toonTextureMultiplicativeColor=[1,1,1,1],this.toonTextureAdditiveColor=[0,0,0,0],this._initialDiffuse=[...this.diffuse],this._initialSpecular=[...this.specular],this._initialShininess=this.shininess,this._initialAmbient=[...this.ambient],this._initialEdgeColor=[...this.edgeColor],this._initialEdgeSize=this.edgeSize,this._initialTextureMultiplicativeColor=[...this.textureMultiplicativeColor],this._initialTextureAdditiveColor=[...this.textureAdditiveColor],this._initialSphereTextureMultiplicativeColor=[...this.sphereTextureMultiplicativeColor],this._initialSphereTextureAdditiveColor=[...this.sphereTextureAdditiveColor],this._initialToonTextureMultiplicativeColor=[...this.toonTextureMultiplicativeColor],this._initialToonTextureAdditiveColor=[...this.toonTextureAdditiveColor],this._initialTransparencyMode=e.transparencyMode}reset(){for(let e=0;e<4;++e)this.diffuse[e]=this._initialDiffuse[e],this.edgeColor[e]=this._initialEdgeColor[e],this.textureMultiplicativeColor[e]=this._initialTextureMultiplicativeColor[e],this.textureAdditiveColor[e]=this._initialTextureAdditiveColor[e],this.sphereTextureMultiplicativeColor[e]=this._initialSphereTextureMultiplicativeColor[e],this.sphereTextureAdditiveColor[e]=this._initialSphereTextureAdditiveColor[e],this.toonTextureMultiplicativeColor[e]=this._initialToonTextureMultiplicativeColor[e],this.toonTextureAdditiveColor[e]=this._initialToonTextureAdditiveColor[e];for(let e=0;e<3;++e)this.specular[e]=this._initialSpecular[e],this.ambient[e]=this._initialAmbient[e];this.shininess=this._initialShininess,this.edgeSize=this._initialEdgeSize}applyChanges(){const e=this._material;e.diffuseColor.set(this.diffuse[0],this.diffuse[1],this.diffuse[2]),e.alpha=this.diffuse[3],1===this.diffuse[3]?e.transparencyMode=this._initialTransparencyMode:e.transparencyMode=Te.i.MATERIAL_ALPHABLEND;const t=this._referencedMeshes;if(this.diffuse[3]<=0)for(let e=0;e<t.length;++e)t[e].isVisible=!1;else for(let e=0;e<t.length;++e)t[e].isVisible=!0;e.specularColor.set(this.specular[0],this.specular[1],this.specular[2]),e.specularPower=this.shininess,e.ambientColor.set(this.ambient[0],this.ambient[1],this.ambient[2]),e.outlineColor.set(this.edgeColor[0],this.edgeColor[1],this.edgeColor[2]),e.outlineAlpha=this.edgeColor[3],e.outlineWidth=this.edgeSize;{const t=this.textureMultiplicativeColor;e.textureMultiplicativeColor.set(t[0],t[1],t[2],t[3])}{const t=this.textureAdditiveColor;e.textureAdditiveColor.set(t[0],t[1],t[2],t[3])}{const t=this.sphereTextureMultiplicativeColor;e.sphereTextureMultiplicativeColor.set(t[0],t[1],t[2],t[3])}{const t=this.sphereTextureAdditiveColor;e.sphereTextureAdditiveColor.set(t[0],t[1],t[2],t[3])}{const t=this.toonTextureMultiplicativeColor;e.toonTextureMultiplicativeColor.set(t[0],t[1],t[2],t[3])}{const t=this.toonTextureAdditiveColor;e.toonTextureAdditiveColor.set(t[0],t[1],t[2],t[3])}}}class iu{_physics;_models;_camera;_audioPlayer;autoPhysicsInitialization;_loggingEnabled;log;warn;error;_isRegistered;onAnimationDurationChangedObservable;onPlayAnimationObservable;onPauseAnimationObservable;onSeekAnimationObservable;onAnimationTickObservable;_currentFrameTime;_animationTimeScale;_animationPaused;_animationFrameTimeDuration;_useManualAnimationDuration;_needToInitializePhysicsModels;_beforePhysicsBinded;_afterPhysicsBinded;_bindedDispose;_disposeObservableObject;constructor(e=null,t=null){this._physics=t,this._models=[],this._camera=null,this._audioPlayer=null,this.autoPhysicsInitialization=!0,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._isRegistered=!1,this.onAnimationDurationChangedObservable=new C.cP,this.onPlayAnimationObservable=new C.cP,this.onPauseAnimationObservable=new C.cP,this.onSeekAnimationObservable=new C.cP,this.onAnimationTickObservable=new C.cP,this._currentFrameTime=0,this._animationTimeScale=1,this._animationPaused=!0,this._animationFrameTimeDuration=0,this._useManualAnimationDuration=!1,this._needToInitializePhysicsModels=new Set,this._beforePhysicsBinded=null,this._afterPhysicsBinded=this.afterPhysics.bind(this),null!==e?(this._bindedDispose=()=>this.dispose(e),this._disposeObservableObject=e,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)):(this._bindedDispose=null,this._disposeObservableObject=null)}dispose(e){for(let e=0;e<this._models.length;++e)this._models[e].dispose();this._models.length=0,this.setCamera(null),this.setAudioPlayer(null),this.onAnimationDurationChangedObservable.clear(),this.onPlayAnimationObservable.clear(),this.onPauseAnimationObservable.clear(),this.onSeekAnimationObservable.clear(),this.onAnimationTickObservable.clear(),this._needToInitializePhysicsModels.clear(),this.unregister(e),null!==this._disposeObservableObject&&null!==this._bindedDispose&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose)}createMmdModel(e,t={}){if(!Hc.isMmdSkinnedMesh(e))throw new Error("Mesh validation failed.");return this.createMmdModelFromSkeleton(e,e.metadata.skeleton,t)}createMmdModelFromSkeleton(e,t,i={}){void 0===i.materialProxyConstructor&&(i.materialProxyConstructor=tu),void 0===i.buildPhysics&&(i.buildPhysics=!0);const s=new eu(e,t,i.materialProxyConstructor,i.buildPhysics?this._physics:null,this);return this._models.push(s),this._needToInitializePhysicsModels.add(s),s.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),s}destroyMmdModel(e){e.dispose();const t=this._models,i=t.indexOf(e);if(i<0)throw new Error("Model not found.");t.splice(i,1)}initializeMmdModelPhysics(e){this._needToInitializePhysicsModels.add(e)}initializeAllMmdModelsPhysics(e){const t=this._models;if(e)for(let e=0;e<t.length;++e){const i=t[e];null!==i.currentAnimation&&this._needToInitializePhysicsModels.add(i)}else for(let e=0;e<t.length;++e)this._needToInitializePhysicsModels.add(t[e])}setCamera(e){null!==this._camera&&this._camera.onCurrentAnimationChangedObservable.removeCallback(this._onAnimationChanged),null!==e&&e.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),this._camera=e,this._onAnimationChanged(e?.currentAnimation??null)}_setAudioPlayerLastValue=null;async setAudioPlayer(e){if(this._audioPlayer!==e)if(this._setAudioPlayerLastValue=e,null!==this._audioPlayer&&(this._audioPlayer.onDurationChangedObservable.removeCallback(this._onAudioDurationChanged),this._audioPlayer.onPlaybackRateChangedObservable.removeCallback(this._onAudioPlaybackRateChanged),this._audioPlayer.onPlayObservable.removeCallback(this._onAudioPlay),this._audioPlayer.onPauseObservable.removeCallback(this._onAudioPause),this._audioPlayer.onSeekObservable.removeCallback(this._onAudioSeek),this._audioPlayer.pause()),this._audioPlayer=null,null!==e){if(!this._animationPaused){const t=30*e.duration;if(this._currentFrameTime<t&&(e.currentTime=this._currentFrameTime/30,await e.play(),this._setAudioPlayerLastValue!==e))return void e.pause()}this._audioPlayer=e,this._onAudioDurationChanged(),e.onDurationChangedObservable.add(this._onAudioDurationChanged),e.onPlaybackRateChangedObservable.add(this._onAudioPlaybackRateChanged),e.onPlayObservable.add(this._onAudioPlay),e.onPauseObservable.add(this._onAudioPause),e.onSeekObservable.add(this._onAudioSeek),e._setPlaybackRateWithoutNotify(this._animationTimeScale)}else this._onAudioDurationChanged()}register(e){this._isRegistered||(this._isRegistered=!0,this._beforePhysicsBinded=()=>this.beforePhysics(e.getEngine().getDeltaTime()),e.onBeforeAnimationsObservable.add(this._beforePhysicsBinded),e.onBeforeRenderObservable.add(this._afterPhysicsBinded))}unregister(e){this._isRegistered&&(this._isRegistered=!1,e.onBeforeAnimationsObservable.removeCallback(this._beforePhysicsBinded),e.onBeforeRenderObservable.removeCallback(this._afterPhysicsBinded),this._beforePhysicsBinded=null)}beforePhysics(e){if(this._animationPaused){const e=this._models;for(let t=0;t<e.length;++t)e[t].beforePhysics(null)}else{if(null===this._audioPlayer||this._audioPlayer.paused)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else{const t=this._audioPlayer.currentTime,i=t-this._currentFrameTime/30,s=Math.abs(i);if(s<.05)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else if(s<.5)this._currentFrameTime+=i<0?e/1e3*30*this._animationTimeScale*.9:e/1e3*30*this._animationTimeScale*1.1;else{if(this.autoPhysicsInitialization&&60<Math.abs(t-this._currentFrameTime)){const e=this._needToInitializePhysicsModels;for(let t=0;t<this._models.length;++t){const i=this._models[t];null!==i.currentAnimation&&e.add(i)}}this._currentFrameTime=30*t}}const t=this._currentFrameTime;this._animationFrameTimeDuration<=t&&(this._animationPaused=!0,this._currentFrameTime=this._animationFrameTimeDuration,null===this._audioPlayer||this._audioPlayer.paused?this.onPauseAnimationObservable.notifyObservers():this._audioPlayer.pause());const i=this._models;for(let e=0;e<i.length;++e)i[e].beforePhysics(t);null!==this._camera&&this._camera.animate(t),this.onAnimationTickObservable.notifyObservers()}const t=this._needToInitializePhysicsModels;for(const e of t)e.initializePhysics();t.clear()}afterPhysics(){const e=this._models;for(let t=0;t<e.length;++t)e[t].afterPhysics()}_onAnimationChanged=e=>{if(this._useManualAnimationDuration)return;const t=e?.animation.endFrame??0;this._animationFrameTimeDuration<t?this._animationFrameTimeDuration=t:t<this._animationFrameTimeDuration&&(this._animationFrameTimeDuration=this._computeAnimationDuration()),this.onAnimationDurationChangedObservable.notifyObservers()};_computeAnimationDuration(){let e=0;const t=this._models;for(let i=0;i<t.length;++i){const s=t[i];null!==s.currentAnimation&&(e=Math.max(e,s.currentAnimation.animation.endFrame))}return null!==this._camera&&null!==this._camera.currentAnimation&&(e=Math.max(e,this._camera.currentAnimation.animation.endFrame)),null!==this._audioPlayer&&(e=Math.max(e,30*this._audioPlayer.duration)),e}_onAudioDurationChanged=()=>{if(!this._animationPaused&&null!==this._audioPlayer){const e=this._audioPlayer,t=this._currentFrameTime/30;t<e.duration&&(e._setCurrentTimeWithoutNotify(t),e.play().then((()=>{this._setAudioPlayerLastValue===e||e.pause()})))}if(this._useManualAnimationDuration)return;const e=null!==this._audioPlayer?30*this._audioPlayer.duration:0;this._animationFrameTimeDuration<e?this._animationFrameTimeDuration=e:this._animationFrameTimeDuration=this._computeAnimationDuration(),this.onAnimationDurationChangedObservable.notifyObservers()};_onAudioPlaybackRateChanged=()=>{this._animationTimeScale=this._audioPlayer.playbackRate};_onAudioPlay=()=>{this._playAnimationInternal()};_onAudioPause=()=>{this._audioPlayer.currentTime!==this._audioPlayer.duration&&(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers())};_onAudioSeek=()=>{this._seekAnimationInternal(30*this._audioPlayer.currentTime,this._animationPaused)};_playAnimationInternal(){if(this._animationPaused){if(this._animationPaused=!1,this.autoPhysicsInitialization&&0===this._currentFrameTime){const e=this._models,t=this._needToInitializePhysicsModels;for(let i=0;i<e.length;++i)t.add(e[i])}this.onPlayAnimationObservable.notifyObservers()}}async playAnimation(){if(null!==this._audioPlayer&&this._currentFrameTime<30*this._audioPlayer.duration)try{const e=this._currentFrameTime/30;.05<Math.abs(this._audioPlayer.currentTime-e)&&this._audioPlayer._setCurrentTimeWithoutNotify(e),await this._audioPlayer.play()}catch(e){if(!(e instanceof DOMException&&"NotSupportedError"===e.name))throw e;this.error("Failed to play audio."),this._playAnimationInternal()}else this._playAnimationInternal()}pauseAnimation(){null===this._audioPlayer||this._audioPlayer.paused?(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers()):(this._audioPlayer.pause(),this._animationPaused=!0)}_seekAnimationInternal(e,t){if(this.autoPhysicsInitialization&&60<Math.abs(e-this._currentFrameTime)){const e=this._needToInitializePhysicsModels;for(let t=0;t<this._models.length;++t){const i=this._models[t];null!==i.currentAnimation&&e.add(i)}}if(this._currentFrameTime=e,t){const t=this._models;for(let i=0;i<t.length;++i){const s=t[i];null!==s.currentAnimation&&s.currentAnimation.animate(e)}null!==this._camera&&null!==this._camera.currentAnimation&&this._camera.animate(e),this.onAnimationTickObservable.notifyObservers()}this.onSeekAnimationObservable.notifyObservers()}async seekAnimation(e,t=!1){if(e=Math.max(0,Math.min(e,this._animationFrameTimeDuration)),null!==this._audioPlayer)if(this._audioPlayer.paused)if(!this._animationPaused&&30*this._audioPlayer.currentTime<this._animationFrameTimeDuration&&e<30*this._audioPlayer.duration)try{this._audioPlayer._setCurrentTimeWithoutNotify(e/30),await this._audioPlayer.play()}catch(i){if(!(i instanceof DOMException&&"NotSupportedError"===i.name))throw i;this.error("Failed to play audio."),this._seekAnimationInternal(e,t)}else this._seekAnimationInternal(e,t),this._audioPlayer?._setCurrentTimeWithoutNotify(e/30);else this._audioPlayer.currentTime=e/30;else this._seekAnimationInternal(e,t)}get isAnimationPlaying(){return!this._animationPaused}get models(){return this._models}get camera(){return this._camera}get audioPlayer(){return this._audioPlayer}get timeScale(){return this._animationTimeScale}set timeScale(e){this._animationTimeScale=e,null!==this._audioPlayer&&this._audioPlayer._setPlaybackRateWithoutNotify(e)}get currentFrameTime(){return this._currentFrameTime}get currentTime(){return this._currentFrameTime/30}get animationFrameTimeDuration(){return this._animationFrameTimeDuration}get animationDuration(){return this._animationFrameTimeDuration/30}setManualAnimationDuration(e){(null!==e||this._useManualAnimationDuration)&&(null===e?(this._useManualAnimationDuration=!1,this._animationFrameTimeDuration=this._computeAnimationDuration()):(this._useManualAnimationDuration=!0,this._animationFrameTimeDuration=e),this.onAnimationDurationChangedObservable.notifyObservers())}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){l.V.Log(e)}_logDisabled(){}_warnEnabled(e){l.V.Warn(e)}_warnDisabled(){}_errorEnabled(e){l.V.Error(e)}_errorDisabled(){}}class su{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,F.n)("CannonJSPlugin")}constructor(e,t=su.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new I.Pq(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach((function(e){e.dispose()})),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){const s={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(s),this._physicsPlugin.generateJoint(s)}removeJoint(e,t,i){const s=this._joints.filter((function(s){return s.connectedImpostor===t&&s.joint===i&&s.mainImpostor===e}));s.length&&this._physicsPlugin.removeJoint(s[0])}_step(e){this._impostors.forEach((e=>{e.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(e)})),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}}class ru{constructor(){this._hasHit=!1,this._hitNormal=I.Pq.Zero(),this._hitPoint=I.Pq.Zero(),this._triangleIndex=-1}get hitPoint(){return this._hitPoint}get hitNormal(){return this._hitNormal}get hasHit(){return this._hasHit}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormal.set(e.x,e.y,e.z),this._hitPoint.set(t.x,t.y,t.z),this._triangleIndex=i??-1}reset(){this._hasHit=!1,this._hitNormal.setAll(0),this._hitPoint.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0,this.shape=void 0}}class nu extends ru{constructor(){super(...arguments),this._hitDistance=0,this._rayFromWorld=I.Pq.Zero(),this._rayToWorld=I.Pq.Zero()}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormal}get hitPointWorld(){return this._hitPoint}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=I.Pq.Distance(this._rayFromWorld,this._hitPoint)}reset(e=I.Pq.Zero(),t=I.Pq.Zero()){super.reset(),this._rayFromWorld.copyFrom(e),this._rayToWorld.copyFrom(t),this._hitDistance=0}}class au{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,F.n)("")}constructor(e,t=au.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new I.Pq(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}setVelocityLimits(e,t){this._physicsPlugin.setVelocityLimits(e,t)}getMaxLinearVelocity(){return this._physicsPlugin.getMaxLinearVelocity()}getMaxAngularVelocity(){return this._physicsPlugin.getMaxAngularVelocity()}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){const t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i,s){this._physicsPlugin.raycast(e,t,i,s)}raycast(e,t,i){const s=new nu;return this._physicsPlugin.raycast(e,t,s,i),s}}be.Z.prototype.getPhysicsEngine=function(){return this._physicsEngine},be.Z.prototype.enablePhysics=function(e=null,t){if(this._physicsEngine)return!0;let i=this._getComponent(fe.v.NAME_PHYSICSENGINE);i||(i=new ou(this),this._addComponent(i));try{if(t&&1!==t?.getPluginVersion()){if(2!==t?.getPluginVersion())throw new Error("Unsupported Physics plugin version.");this._physicsEngine=new au(e,t)}else this._physicsEngine=new su(e,t);return this._physicsTimeAccumulator=0,!0}catch(e){return l.V.Error(e.message),!1}},be.Z.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},be.Z.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},be.Z.prototype.deleteCompoundImpostor=function(e){const t=e.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},be.Z.prototype._advancePhysicsEngineStep=function(e){if(this._physicsEngine){const t=this._physicsEngine.getSubTimeStep();if(t>0)for(this._physicsTimeAccumulator+=e;this._physicsTimeAccumulator>t;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=t;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class ou{constructor(e){this.name=fe.v.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new C.cP,this.scene.onAfterPhysicsObservable=new C.cP,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?1e3*this.scene._physicsEngine.getTimeStep():1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}Object.defineProperty(dt.prototype,"physicsBody",{get:function(){return this._physicsBody},set:function(e){this._physicsBody!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsBody=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add((()=>{this.physicsBody&&(this.physicsBody.dispose(),this.physicsBody=null)}))))},enumerable:!0,configurable:!0}),dt.prototype.getPhysicsBody=function(){return this.physicsBody},dt.prototype.applyImpulse=function(e,t){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyImpulse(e,t),this},dt.prototype.applyAngularImpulse=function(e){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyAngularImpulse(e),this},new I.uq,new I.uq,I.Pq.Zero(),new I.Pq,new I.PT,new I.Pq;var lu=r(2722);const hu=JSON.parse('[{"_id":10000000,"name":"Paimon","weaponType":"Others","element":"Others","gender":"Others","rarity":5,"directory":"res/chars/Genshin/Paimon","image":"Genshin/Paimon.png","pmx":"派蒙1.0.pmx"},{"_id":10000001,"name":"Pom-Pom","weaponType":"Others","element":"Others","gender":"Others","rarity":5,"directory":"res/chars/HSR/Pom-Pom","image":"HSR/Pom-Pom.png","pmx":"Pom-Pom.pmx"},{"_id":10000002,"name":"Bangboo","weaponType":"Others","element":"Others","gender":"Others","rarity":5,"directory":"res/chars/ZZZ/Bangboo","image":"ZZZ/Bangboo.png","pmx":"邦布.pmx"}]'),cu=JSON.parse('[{"_id":10000027,"name":"Albedo","weaponType":"Sword","element":"Geo","gender":"Male","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Albedo","image":"Genshin/Albedo.png","pmx":"阿贝多.pmx"},{"_id":10000062,"name":"Alhaitham","weaponType":"Sword","element":"Dendro","gender":"Male","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Alhaitham","image":"Genshin/Alhaitham.png","pmx":"艾尔海森.pmx"},{"_id":10000002,"name":"Amber","weaponType":"Bow","element":"Pyro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Amber/Amber","image":"Genshin/Amber.png","pmx":"安柏.pmx"},{"_id":10000043,"name":"Arataki Itto","weaponType":"Claymore","element":"Geo","gender":"Male","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Arataki Itto","image":"Genshin/Arataki Itto.png","pmx":"荒泷一斗.pmx"},{"_id":10000080,"name":"Arlecchino","weaponType":"Polearm","element":"Pyro","gender":"Female","region":"Snezhnaya","rarity":5,"directory":"res/chars/Genshin/Arlecchino","image":"Genshin/Arlecchino.png","pmx":"仆人.pmx"},{"_id":10000066,"name":"Baizhu","weaponType":"Catalyst","element":"Dendro","gender":"Male","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Baizhu","image":"Genshin/Baizhu.png","pmx":"白术.pmx"},{"_id":10000003,"name":"Barbara","weaponType":"Catalyst","element":"Hydro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Barbara/Barbara","image":"Genshin/Barbara.png","pmx":"芭芭拉.pmx"},{"_id":10000004,"name":"Beidou","weaponType":"Claymore","element":"Electro","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Beidou","image":"Genshin/Beidou.png","pmx":"北斗.pmx"},{"_id":10000005,"name":"Bennett","weaponType":"Sword","element":"Pyro","gender":"Male","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Bennett","image":"Genshin/Bennett.png","pmx":"班尼特.pmx"},{"_id":10000054,"name":"Candace","weaponType":"Polearm","element":"Hydro","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Candace","image":"Genshin/Candace.png","pmx":"坎蒂丝.pmx"},{"_id":10000073,"name":"Charlotte","weaponType":"Catalyst","element":"Cryo","gender":"Female","region":"Fontaine","rarity":4,"directory":"res/chars/Genshin/Charlotte","image":"Genshin/Charlotte.png","pmx":"夏洛蒂.pmx"},{"_id":10000076,"name":"Chevreuse","weaponType":"Polearm","element":"Pyro","gender":"Female","region":"Fontaine","rarity":4,"directory":"res/chars/Genshin/Chevreuse","image":"Genshin/Chevreuse.png","pmx":"夏沃蕾.pmx"},{"_id":10000079,"name":"Chiori","weaponType":"Sword","element":"Geo","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Chiori","image":"Genshin/Chiori.png","pmx":"千织.pmx"},{"_id":10000006,"name":"Chongyun","weaponType":"Claymore","element":"Cryo","gender":"Male","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Chongyun","image":"Genshin/Chongyun.png","pmx":"重云.pmx"},{"_id":10000081,"name":"Clorinde","weaponType":"Sword","element":"Electro","gender":"Female","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Clorinde","image":"Genshin/Clorinde.png","pmx":"克洛琳德.pmx"},{"_id":10000051,"name":"Collei","weaponType":"Bow","element":"Dendro","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Collei/Collei","image":"Genshin/Collei.png","pmx":"柯莱.pmx"},{"_id":10000055,"name":"Cyno","weaponType":"Polearm","element":"Electro","gender":"Male","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Cyno","image":"Genshin/Cyno.png","pmx":"赛诺.pmx"},{"_id":10000063,"name":"Dehya","weaponType":"Claymore","element":"Pyro","gender":"Female","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Dehya","image":"Genshin/Dehya.png","pmx":"迪希雅.pmx"},{"_id":10000016,"name":"Diluc","weaponType":"Claymore","element":"Pyro","gender":"Male","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Diluc/Diluc","image":"Genshin/Diluc.png","pmx":"迪卢克.pmx"},{"_id":10000023,"name":"Diona","weaponType":"Bow","element":"Cryo","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Diona","image":"Genshin/Diona.png","pmx":"迪奥娜.pmx"},{"_id":10000053,"name":"Dori","weaponType":"Claymore","element":"Electro","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Dori","image":"Genshin/Dori.png","pmx":"多莉.pmx"},{"_id":10000033,"name":"Eula","weaponType":"Claymore","element":"Cryo","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Eula/Eula","image":"Genshin/Eula.png","pmx":"优菈.pmx"},{"_id":10000059,"name":"Faruzan","weaponType":"Bow","element":"Anemo","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Faruzan","image":"Genshin/Faruzan.png","pmx":"珐露珊.pmx"},{"_id":10000007,"name":"Fischl","weaponType":"Bow","element":"Electro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Fischl/Fischl","image":"Genshin/Fischl.png","pmx":"菲谢尔.pmx"},{"_id":10000070,"name":"Freminet","weaponType":"Claymore","element":"Cryo","gender":"Male","region":"Fontaine","rarity":4,"directory":"res/chars/Genshin/Freminet","image":"Genshin/Freminet.png","pmx":"菲米尼.pmx"},{"_id":10000074,"name":"Furina","weaponType":"Sword","element":"Hydro","gender":"Female","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Furina/Furina","image":"Genshin/Furina.png","pmx":"【芙宁娜】.pmx"},{"_id":10000078,"name":"Gaming","weaponType":"Claymore","element":"Pyro","gender":"Male","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Gaming","image":"Genshin/Gaming.png","pmx":"嘉明.pmx"},{"_id":10000028,"name":"Ganyu","weaponType":"Bow","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Ganyu/Ganyu","image":"Genshin/Ganyu.png","pmx":"甘雨.pmx"},{"_id":10000042,"name":"Gorou","weaponType":"Bow","element":"Geo","gender":"Male","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Gorou/Gorou","image":"Genshin/Gorou.png","pmx":"五郎.pmx"},{"_id":10000030,"name":"Hu Tao","weaponType":"Polearm","element":"Pyro","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Hu Tao","image":"Genshin/Hu Tao.png","pmx":"胡桃.pmx"},{"_id":10000017,"name":"Jean","weaponType":"Sword","element":"Anemo","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Jean/Jean","image":"Genshin/Jean.png","pmx":"琴.pmx"},{"_id":10000034,"name":"Kaedehara Kazuha","weaponType":"Sword","element":"Anemo","gender":"Male","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Kaedehara Kazuha","image":"Genshin/Kaedehara Kazuha.png","pmx":"万叶.pmx"},{"_id":10000008,"name":"Kaeya","weaponType":"Sword","element":"Cryo","gender":"Male","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Kaeya/Kaeya","image":"Genshin/Kaeya.png","pmx":"凯亚.pmx"},{"_id":10000035,"name":"Kamisato Ayaka","weaponType":"Sword","element":"Cryo","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Kamisato Ayaka/Kamisato Ayaka","image":"Genshin/Kamisato Ayaka.png","pmx":"神里绫华.pmx"},{"_id":10000047,"name":"Kamisato Ayato","weaponType":"Sword","element":"Hydro","gender":"Male","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Kamisato Ayato/Kamisato Ayato","image":"Genshin/Kamisato Ayato.png","pmx":"神里绫人.pmx"},{"_id":10000065,"name":"Kaveh","weaponType":"Claymore","element":"Dendro","gender":"Male","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Kaveh","image":"Genshin/Kaveh.png","pmx":"卡维.pmx"},{"_id":10000018,"name":"Keqing","weaponType":"Sword","element":"Electro","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Keqing/Keqing","image":"Genshin/Keqing.png","pmx":"刻晴.pmx"},{"_id":10000067,"name":"Kirara","weaponType":"Sword","element":"Dendro","gender":"Female","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Kirara/Kirara","image":"Genshin/Kirara.png","pmx":"绮良良.pmx"},{"_id":10000022,"name":"Klee","weaponType":"Catalyst","element":"Pyro","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Klee/Klee","image":"Genshin/Klee.png","pmx":"可莉.pmx"},{"_id":10000038,"name":"Kujou Sara","weaponType":"Bow","element":"Electro","gender":"Female","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Kujou Sara","image":"Genshin/Kujou Sara.png","pmx":"九条裟罗.pmx"},{"_id":10000049,"name":"Kuki Shinobu","weaponType":"Sword","element":"Electro","gender":"Female","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Kuki Shinobu","image":"Genshin/Kuki Shinobu.png","pmx":"久岐忍.pmx"},{"_id":10000058,"name":"Layla","weaponType":"Sword","element":"Cryo","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Layla","image":"Genshin/Layla.png","pmx":"莱依拉.pmx"},{"_id":10000009,"name":"Lisa","weaponType":"Catalyst","element":"Electro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Lisa/Lisa","image":"Genshin/Lisa.png","pmx":"丽莎.pmx"},{"_id":10000068,"name":"Lynette","weaponType":"Sword","element":"Anemo","gender":"Female","region":"Fontaine","rarity":4,"directory":"res/chars/Genshin/Lynette/Lynette","image":"Genshin/Lynette.png","pmx":"【琳妮特】.pmx"},{"_id":10000069,"name":"Lyney","weaponType":"Bow","element":"Pyro","gender":"Male","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Lyney/Lyney","image":"Genshin/Lyney.png","pmx":"林尼.pmx"},{"_id":10000064,"name":"Mika","weaponType":"Polearm","element":"Cryo","gender":"Male","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Mika","image":"Genshin/Mika.png","pmx":"米卡.pmx"},{"_id":10000019,"name":"Mona","weaponType":"Catalyst","element":"Hydro","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Mona/Mona","image":"Genshin/Mona.png","pmx":"莫娜.pmx"},{"_id":10000057,"name":"Nahida","weaponType":"Catalyst","element":"Dendro","gender":"Female","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Nahida","image":"Genshin/Nahida.png","pmx":"纳西妲.pmx"},{"_id":10000075,"name":"Navia","weaponType":"Claymore","element":"Geo","gender":"Female","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Navia","image":"Genshin/Navia.png","pmx":"娜维娅.pmx"},{"_id":10000071,"name":"Neuvillette","weaponType":"Catalyst","element":"Hydro","gender":"Male","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Neuvillette","image":"Genshin/Neuvillette.png","pmx":"那维莱特.pmx"},{"_id":10000056,"name":"Nilou","weaponType":"Sword","element":"Hydro","gender":"Female","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Nilou/Nilou","image":"Genshin/Nilou.png","pmx":"妮露.pmx"},{"_id":10000010,"name":"Ningguang","weaponType":"Catalyst","element":"Geo","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Ningguang/Ningguang","image":"Genshin/Ningguang.png","pmx":"凝光.pmx"},{"_id":10000011,"name":"Noelle","weaponType":"Claymore","element":"Geo","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Noelle","image":"Genshin/Noelle.png","pmx":"诺艾尔.pmx"},{"_id":10000020,"name":"Qiqi","weaponType":"Sword","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Qiqi/Qiqi","image":"Genshin/Qiqi.png","pmx":"七七.pmx"},{"_id":10000039,"name":"Raiden Shogun","weaponType":"Polearm","element":"Electro","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Raiden Shogun","image":"Genshin/Raiden Shogun.png","pmx":"雷电将军.pmx"},{"_id":10000012,"name":"Razor","weaponType":"Claymore","element":"Electro","gender":"Male","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Razor","image":"Genshin/Razor.png","pmx":"雷泽.pmx"},{"_id":10000031,"name":"Rosaria","weaponType":"Polearm","element":"Cryo","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Rosaria","image":"Genshin/Rosaria.png","pmx":"罗莎莉亚.pmx"},{"_id":10000040,"name":"Sangonomiya Kokomi","weaponType":"Catalyst","element":"Hydro","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Sangonomiya Kokomi","image":"Genshin/Sangonomiya Kokomi.png","pmx":"珊瑚宫心海.pmx"},{"_id":10000036,"name":"Sayu","weaponType":"Claymore","element":"Anemo","gender":"Female","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Sayu","image":"Genshin/Sayu.png","pmx":"早柚.pmx"},{"_id":10000082,"name":"Sethos","weaponType":"Bow","element":"Electro","gender":"Male","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Sethos","image":"Genshin/Sethos.png","pmx":"赛索斯.pmx"},{"_id":10000045,"name":"Shenhe","weaponType":"Polearm","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Shenhe/Shenhe","image":"Genshin/Shenhe.png","pmx":"申鹤.pmx"},{"_id":10000050,"name":"Shikanoin Heizou","weaponType":"Catalyst","element":"Anemo","gender":"Male","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Shikanoin Heizou","image":"Genshin/Shikanoin Heizou.png","pmx":"鹿野院平藏.pmx"},{"_id":10000083,"name":"Sigewinne","weaponType":"Bow","element":"Hydro","gender":"Female","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Sigewinne","image":"Genshin/Sigewinne.png","pmx":"希格雯.pmx"},{"_id":10000013,"name":"Sucrose","weaponType":"Catalyst","element":"Anemo","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Sucrose","image":"Genshin/Sucrose.png","pmx":"砂糖.pmx"},{"_id":10000024,"name":"Tartaglia","weaponType":"Bow","element":"Hydro","gender":"Male","region":"Snezhnaya","rarity":5,"directory":"res/chars/Genshin/Tartaglia","image":"Genshin/Tartaglia.png","pmx":"达达利亚.pmx"},{"_id":10000041,"name":"Thoma","weaponType":"Polearm","element":"Pyro","gender":"Male","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Thoma","image":"Genshin/Thoma.png","pmx":"托马.pmx"},{"_id":10000052,"name":"Tighnari","weaponType":"Bow","element":"Dendro","gender":"Male","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Tighnari/Tighnari","image":"Genshin/Tighnari.png","pmx":"提纳里.pmx"},{"_id":10000000,"name":"Aether","weaponType":"Sword","element":"Universal","gender":"Male","rarity":5,"directory":"res/chars/Genshin/Aether","image":"Genshin/Aether.png","pmx":"空.pmx"},{"_id":10000001,"name":"Lumine","weaponType":"Sword","element":"Universal","gender":"Female","rarity":5,"directory":"res/chars/Genshin/Lumine","image":"Genshin/Lumine.png","pmx":"荧.pmx"},{"_id":10000021,"name":"Venti","weaponType":"Bow","element":"Anemo","gender":"Male","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Venti","image":"Genshin/Venti.png","pmx":"温迪.pmx"},{"_id":10000060,"name":"Wanderer","weaponType":"Catalyst","element":"Anemo","gender":"Male","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Wanderer","image":"Genshin/Wanderer.png","pmx":"流浪者.pmx"},{"_id":10000072,"name":"Wriothesley","weaponType":"Catalyst","element":"Cryo","gender":"Male","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Wriothesley","image":"Genshin/Wriothesley.png","pmx":"莱欧斯利.pmx"},{"_id":10000014,"name":"Xiangling","weaponType":"Polearm","element":"Pyro","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Xiangling","image":"Genshin/Xiangling.png","pmx":"香菱.pmx"},{"_id":10000077,"name":"Xianyun","weaponType":"Catalyst","element":"Anemo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Xianyun","image":"Genshin/Xianyun.png","pmx":"闲云.pmx"},{"_id":10000029,"name":"Xiao","weaponType":"Polearm","element":"Anemo","gender":"Male","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Xiao","image":"Genshin/Xiao.png","pmx":"魈.pmx"},{"_id":10000015,"name":"Xingqiu","weaponType":"Sword","element":"Hydro","gender":"Male","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Xingqiu/Xingqiu","image":"Genshin/Xingqiu.png","pmx":"行秋.pmx"},{"_id":10000025,"name":"Xinyan","weaponType":"Claymore","element":"Pyro","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Xinyan","image":"Genshin/Xinyan.png","pmx":"辛焱.pmx"},{"_id":10000046,"name":"Yae Miko","weaponType":"Catalyst","element":"Electro","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Yae Miko","image":"Genshin/Yae Miko.png","pmx":"八重神子.pmx"},{"_id":10000032,"name":"Yanfei","weaponType":"Catalyst","element":"Pyro","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Yanfei","image":"Genshin/Yanfei.png","pmx":"烟绯.pmx"},{"_id":10000061,"name":"Yaoyao","weaponType":"Polearm","element":"Dendro","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Yaoyao","image":"Genshin/Yaoyao.png","pmx":"瑶瑶.pmx"},{"_id":10000048,"name":"Yelan","weaponType":"Bow","element":"Hydro","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Yelan","image":"Genshin/Yelan.png","pmx":"夜兰.pmx"},{"_id":10000037,"name":"Yoimiya","weaponType":"Bow","element":"Pyro","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Yoimiya","image":"Genshin/Yoimiya.png","pmx":"宵宫.pmx"},{"_id":10000044,"name":"Yun Jin","weaponType":"Polearm","element":"Geo","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Yun Jin","image":"Genshin/Yun Jin.png","pmx":"云堇.pmx"},{"_id":10000026,"name":"Zhongli","weaponType":"Polearm","element":"Geo","gender":"Male","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Zhongli","image":"Genshin/Zhongli.png","pmx":"钟离.pmx"},{"_id":10000084,"name":"Emilie","weaponType":"Polearm","element":"Dendro","gender":"Female","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Emilie","image":"Genshin/Emilie.png","pmx":"艾梅莉埃.pmx"},{"_id":10000085,"name":"Kachina","weaponType":"Polearm","element":"Geo","gender":"Female","region":"Natlan","rarity":4,"directory":"res/chars/Genshin/Kachina","image":"Genshin/Kachina.png","pmx":"卡齐娜.pmx"},{"_id":10000086,"name":"Mualani","weaponType":"Catalyst","element":"Hydro","gender":"Female","region":"Natlan","rarity":5,"directory":"res/chars/Genshin/Mualani","image":"Genshin/Mualani.png","pmx":"玛拉妮.pmx"},{"_id":10000087,"name":"Kinich","weaponType":"Claymore","element":"Dendro","gender":"Male","region":"Natlan","rarity":5,"directory":"res/chars/Genshin/Kinich","image":"Genshin/Kinich.png","pmx":"基尼奇.pmx"},{"_id":10000088,"name":"Xilonen","weaponType":"Sword","element":"Geo","gender":"Female","region":"Natlan","rarity":5,"directory":"res/chars/Genshin/Xilonen","image":"Genshin/Xilonen.png","pmx":"希诺宁.pmx"},{"_id":10000089,"name":"Ororon","weaponType":"Bow","element":"Electro","gender":"Male","region":"Natlan","rarity":4,"directory":"res/chars/Genshin/Ororon","image":"Genshin/Ororon.png","pmx":"Ororon.pmx"},{"_id":10000090,"name":"Chasca","weaponType":"Bow","element":"Anemo","gender":"Female","region":"Natlan","rarity":5,"directory":"res/chars/Genshin/Chasca","image":"Genshin/Chasca.png","pmx":"恰斯卡.pmx"},{"_id":10000091,"name":"Citlali","weaponType":"Catalyst","element":"Cryo","gender":"Female","region":"Natlan","rarity":5,"directory":"res/chars/Genshin/Citlali","image":"Genshin/Citlali.png","pmx":"茜特拉莉.pmx"},{"_id":10000099,"name":"Mavuika","weaponType":"Sword","element":"Pyro","gender":"Female","region":"Natlan","rarity":5,"directory":"res/chars/Genshin/Mavuika","image":"Genshin/Mavuika.png","pmx":"玛薇卡.pmx"},{"_id":10000100,"name":"Iansan","weaponType":"Polearm","element":"Electro","gender":"Female","region":"Natlan","rarity":5,"directory":"res/chars/Genshin/Iansan","image":"Genshin/Iansan.png","pmx":"Iansan.pmx"},{"_id":1000000,"name":"Guizhong","weaponType":"Universal","element":"Universal","gender":"Female","rarity":6,"directory":"res/chars/Genshin/Guizhong","image":"Genshin/Guizhong.png","pmx":"FC式-归终.pmx"},{"_id":1000001,"name":"Skirk","weaponType":"Universal","element":"Universal","gender":"Female","rarity":6,"directory":"res/chars/Genshin/Skirk","image":"Genshin/Skirk.png","pmx":"丝柯克.pmx"},{"_id":1000002,"name":"Capitano","weaponType":"Universal","element":"Universal","gender":"Male","rarity":6,"directory":"res/chars/Genshin/Capitano","image":"Genshin/Capitano.png","pmx":"Capitano.pmx"},{"_id":1000003,"name":"Dottore","weaponType":"Universal","element":"Universal","gender":"Male","rarity":6,"directory":"res/chars/Genshin/Dottore","image":"Genshin/Dottore.png","pmx":"Dottore Model.pmx"}]'),uu=JSON.parse('[{"_id":10000003,"name":"Barbara","weaponType":"Catalyst","element":"Hydro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Barbara/Skin","image":"Genshin/Barbara.png","pmx":"芭芭拉.pmx"},{"_id":10000016,"name":"Diluc","weaponType":"Claymore","element":"Pyro","gender":"Male","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Diluc/Skin","image":"Genshin/Diluc.png","pmx":"迪卢克.pmx"},{"_id":10000007,"name":"Fischl","weaponType":"Bow","element":"Electro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Fischl/Skin","image":"Genshin/Fischl.png","pmx":"菲谢尔.pmx"},{"_id":10000974,"name":"Furina","weaponType":"Sword","element":"Hydro","gender":"Female","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Furina/Furina","image":"Genshin/Furina.png","pmx":"【芙宁娜_荒】.pmx"},{"_id":10000074,"name":"Furina","weaponType":"Sword","element":"Hydro","gender":"Female","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Furina/Focalors","image":"Genshin/Furina.png","pmx":"芙卡洛斯.pmx"},{"_id":10000028,"name":"Ganyu","weaponType":"Bow","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Ganyu/Skin1","image":"Genshin/Ganyu.png","pmx":"甘雨.pmx"},{"_id":10000928,"name":"Ganyu","weaponType":"Bow","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Ganyu/Skin2","image":"Genshin/Ganyu.png","pmx":"甘雨.pmx"},{"_id":10000017,"name":"Jean","weaponType":"Sword","element":"Anemo","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Jean/Skin","image":"Genshin/Jean.png","pmx":"琴.pmx"},{"_id":10000917,"name":"Jean","weaponType":"Sword","element":"Anemo","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Jean/Skin1","image":"Genshin/Jean.png","pmx":"琴闲替衣装.pmx"},{"_id":10000008,"name":"Kaeya","weaponType":"Sword","element":"Cryo","gender":"Male","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Kaeya/Skin","image":"Genshin/Kaeya.png","pmx":"凯亚.pmx"},{"_id":10000035,"name":"Kamisato Ayaka","weaponType":"Sword","element":"Cryo","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Kamisato Ayaka/Skin","image":"Genshin/Kamisato Ayaka.png","pmx":"神里绫华.pmx"},{"_id":10000018,"name":"Keqing","weaponType":"Sword","element":"Electro","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Keqing/Skin","image":"Genshin/Keqing.png","pmx":"刻晴.pmx"},{"_id":10000067,"name":"Kirara","weaponType":"Sword","element":"Dendro","gender":"Female","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Kirara/Skin","image":"Genshin/Kirara.png","pmx":"绮良良.pmx"},{"_id":10000022,"name":"Klee","weaponType":"Catalyst","element":"Pyro","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Klee/Skin","image":"Genshin/Klee.png","pmx":"可莉.pmx"},{"_id":10000009,"name":"Lisa","weaponType":"Catalyst","element":"Electro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Lisa/Skin","image":"Genshin/Lisa.png","pmx":"丽莎.pmx"},{"_id":10000068,"name":"Lynette","weaponType":"Sword","element":"Anemo","gender":"Female","region":"Fontaine","rarity":4,"directory":"res/chars/Genshin/Lynette/KFC","image":"Genshin/Lynette.png","pmx":"【琳妮特】.pmx"},{"_id":10000069,"name":"Lyney","weaponType":"Bow","element":"Pyro","gender":"Male","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Lyney/KFC","image":"Genshin/Lyney.png","pmx":"林尼.pmx"},{"_id":10000019,"name":"Mona","weaponType":"Catalyst","element":"Hydro","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Mona/Skin","image":"Genshin/Mona.png","pmx":"莫娜.pmx"},{"_id":10000056,"name":"Nilou","weaponType":"Sword","element":"Hydro","gender":"Female","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Nilou/Skin","image":"Genshin/Nilou.png","pmx":"妮露.pmx"},{"_id":10000010,"name":"Ningguang","weaponType":"Catalyst","element":"Geo","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Ningguang/Skin","image":"Genshin/Ningguang.png","pmx":"凝光.pmx"},{"_id":10000045,"name":"Shenhe","weaponType":"Polearm","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Shenhe/Skin1","image":"Genshin/Shenhe.png","pmx":"申鹤.pmx"},{"_id":10000945,"name":"Shenhe","weaponType":"Polearm","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Shenhe/Skin2","image":"Genshin/Shenhe.png","pmx":"申鹤.pmx"},{"_id":10000015,"name":"Xingqiu","weaponType":"Sword","element":"Hydro","gender":"Male","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Xingqiu/Skin","image":"Genshin/Xingqiu.png","pmx":"行秋.pmx"},{"_id":1000002,"name":"Amber","weaponType":"Bow","element":"Pyro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Amber/Skin1","image":"Genshin/Amber.png","pmx":"安柏.pmx"},{"_id":1000902,"name":"Amber","weaponType":"Bow","element":"Pyro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Amber/Skin2","image":"Genshin/Amber.png","pmx":"安柏闲替衣装.pmx"},{"_id":10000033,"name":"Eula","weaponType":"Claymore","element":"Cryo","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Eula/Skin1","image":"Genshin/Eula.png","pmx":"优菈.pmx"},{"_id":10000935,"name":"Kamisato Ayaka","weaponType":"Sword","element":"Cryo","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Kamisato Ayaka/Skin2","image":"Genshin/Kamisato Ayaka.png","pmx":"神里绫华.pmx"},{"_id":10000047,"name":"Kamisato Ayato","weaponType":"Sword","element":"Hydro","gender":"Male","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Kamisato Ayato/Skin1","image":"Genshin/Kamisato Ayato.png","pmx":"神里绫人.pmx"},{"_id":10000051,"name":"Collei","weaponType":"Bow","element":"Dendro","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Collei/Skin1","image":"Genshin/Collei.png","pmx":"柯莱.pmx"},{"_id":10000052,"name":"Tighnari","weaponType":"Bow","element":"Dendro","gender":"Male","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Tighnari/Skin1","image":"Genshin/Tighnari.png","pmx":"提纳里.pmx"},{"_id":10000020,"name":"Qiqi","weaponType":"Sword","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Qiqi/Skin1","image":"Genshin/Qiqi.png","pmx":"七七.pmx"},{"_id":10000042,"name":"Gorou","weaponType":"Bow","element":"Geo","gender":"Male","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Gorou/Miss Hina","image":"Genshin/Gorou.png","pmx":"五郎.pmx"}]'),du=JSON.parse('[{"_id":10000001,"name":"Stelle","weaponType":"Universal","element":"Universal","gender":"Female","rarity":5,"directory":"res/chars/HSR/Stelle","image":"HSR/Stelle.png","pmx":"女主1.0.pmx"},{"_id":10000002,"name":"Caelus","weaponType":"Universal","element":"Universal","gender":"Male","rarity":5,"directory":"res/chars/HSR/Caelus","image":"HSR/Caelus.png","pmx":"男主1.0.pmx"},{"_id":10000003,"name":"Arlan","weaponType":"Destruction","element":"Lightning","gender":"Male","rarity":4,"directory":"res/chars/HSR/Arlan","image":"HSR/Arlan.png","pmx":"阿兰1.0.pmx"},{"_id":10000004,"name":"Asta","weaponType":"Harmony","element":"Fire","gender":"Female","rarity":4,"directory":"res/chars/HSR/Asta","image":"HSR/Asta.png","pmx":"星穹铁道—艾丝妲160.pmx"},{"_id":10000005,"name":"Bailu","weaponType":"Abundance","element":"Lightning","gender":"Female","rarity":5,"directory":"res/chars/HSR/Bailu","image":"HSR/Bailu.png","pmx":"白露1.0.pmx"},{"_id":10000006,"name":"Bronya","weaponType":"Harmony","element":"Wind","gender":"Female","rarity":5,"directory":"res/chars/HSR/Bronya","image":"HSR/Bronya.png","pmx":"布洛妮娅 1.0.pmx"},{"_id":10000007,"name":"Clara","weaponType":"Destruction","element":"Physical","gender":"Female","rarity":5,"directory":"res/chars/HSR/Clara","image":"HSR/Clara.png","pmx":"克拉拉.pmx"},{"_id":10000008,"name":"Dan Heng","weaponType":"The Hunt","element":"Wind","gender":"Male","rarity":4,"directory":"res/chars/HSR/Dan Heng","image":"HSR/Dan Heng.png","pmx":"丹恒.pmx"},{"_id":10000009,"name":"Gepard","weaponType":"Preservation","element":"Ice","gender":"Male","rarity":5,"directory":"res/chars/HSR/Gepard","image":"HSR/Gepard.png","pmx":"杰帕德.pmx"},{"_id":10000010,"name":"Herta","weaponType":"Erudition","element":"Ice","gender":"Female","rarity":4,"directory":"res/chars/HSR/Herta","image":"HSR/Herta.png","pmx":"黑塔.pmx"},{"_id":10000011,"name":"Himeko","weaponType":"Erudition","element":"Fire","gender":"Female","rarity":5,"directory":"res/chars/HSR/Himeko","image":"HSR/Himeko.png","pmx":"姬子2.0.pmx"},{"_id":10000012,"name":"Hook","weaponType":"Destruction","element":"Fire","gender":"Female","rarity":4,"directory":"res/chars/HSR/Hook","image":"HSR/Hook.png","pmx":"虎克.pmx"},{"_id":10000013,"name":"Jing Yuan","weaponType":"Erudition","element":"Lightning","gender":"Male","rarity":5,"directory":"res/chars/HSR/Jing Yuan","image":"HSR/Jing Yuan.png","pmx":"景元.pmx"},{"_id":10000014,"name":"March 7th","weaponType":"Preservation","element":"Ice","gender":"Female","rarity":4,"directory":"res/chars/HSR/March 7th/March 7th (Preservation)","image":"HSR/March 7th.png","pmx":"三月七 1.0.pmx"},{"_id":10000015,"name":"Natasha","weaponType":"Abundance","element":"Physical","gender":"Female","rarity":4,"directory":"res/chars/HSR/Natasha","image":"HSR/Natasha.png","pmx":"娜塔莎1.0.pmx"},{"_id":10000016,"name":"Pela","weaponType":"Nihility","element":"Ice","gender":"Female","rarity":4,"directory":"res/chars/HSR/Pela","image":"HSR/Pela.png","pmx":"佩拉.pmx"},{"_id":10000017,"name":"Qingque","weaponType":"Erudition","element":"Quantum","gender":"Female","rarity":4,"directory":"res/chars/HSR/Qingque","image":"HSR/Qingque.png","pmx":"青雀（分桦）.pmx"},{"_id":10000018,"name":"Sampo","weaponType":"Nihility","element":"Wind","gender":"Male","rarity":4,"directory":"res/chars/HSR/Sampo","image":"HSR/Sampo.png","pmx":"╔ú▓⌐.pmx"},{"_id":10000019,"name":"Seele","weaponType":"The Hunt","element":"Quantum","gender":"Female","rarity":5,"directory":"res/chars/HSR/Seele","image":"HSR/Seele.png","pmx":"希儿.pmx"},{"_id":10000020,"name":"Serval","weaponType":"Erudition","element":"Lightning","gender":"Female","rarity":4,"directory":"res/chars/HSR/Serval","image":"HSR/Serval.png","pmx":"希露瓦1.0.pmx"},{"_id":10000021,"name":"Sushang","weaponType":"The Hunt","element":"Physical","gender":"Female","rarity":4,"directory":"res/chars/HSR/Sushang","image":"HSR/Sushang.png","pmx":"李素裳1.0.pmx"},{"_id":10000022,"name":"Tingyun","weaponType":"Harmony","element":"Lightning","gender":"Female","rarity":4,"directory":"res/chars/HSR/Tingyun","image":"HSR/Tingyun.png","pmx":"停云.pmx"},{"_id":10000023,"name":"Welt","weaponType":"Nihility","element":"Imaginary","gender":"Male","rarity":5,"directory":"res/chars/HSR/Welt","image":"HSR/Welt.png","pmx":"瓦尔特·杨.pmx"},{"_id":10000024,"name":"Yanqing","weaponType":"The Hunt","element":"Ice","gender":"Male","rarity":5,"directory":"res/chars/HSR/Yanqing","image":"HSR/Yanqing.png","pmx":"彦卿1.0.pmx"},{"_id":10000025,"name":"Luocha","weaponType":"Abundance","element":"Imaginary","gender":"Male","rarity":5,"directory":"res/chars/HSR/Luocha","image":"HSR/Luocha.png","pmx":"罗刹.pmx"},{"_id":10000026,"name":"Silver Wolf","weaponType":"Nihility","element":"Quantum","gender":"Female","rarity":5,"directory":"res/chars/HSR/Silver Wolf","image":"HSR/Silver Wolf.png","pmx":"银狼.pmx"},{"_id":10000027,"name":"Yukong","weaponType":"Harmony","element":"Imaginary","gender":"Female","rarity":4,"directory":"res/chars/HSR/Yukong","image":"HSR/Yukong.png","pmx":"星穹铁道—驭空（改5）.pmx"},{"_id":10000028,"name":"Blade","weaponType":"Destruction","element":"Wind","gender":"Male","rarity":5,"directory":"res/chars/HSR/Blade","image":"HSR/Blade.png","pmx":"刃1.0.pmx"},{"_id":10000029,"name":"Kafka","weaponType":"Nihility","element":"Lightning","gender":"Female","rarity":5,"directory":"res/chars/HSR/Kafka","image":"HSR/Kafka.png","pmx":"卡芙卡.pmx"},{"_id":10000030,"name":"Luka","weaponType":"Nihility","element":"Physical","gender":"Female","rarity":4,"directory":"res/chars/HSR/Luka","image":"HSR/Luka.png","pmx":"卢卡（改.pmx"},{"_id":10000031,"name":"Imbibitor Lunae","weaponType":"Destruction","element":"Imaginary","gender":"Male","rarity":5,"directory":"res/chars/HSR/Imbibitor Lunae","image":"HSR/Imbibitor Lunae.png","pmx":"星穹铁道—饮月君1708.pmx"},{"_id":10000032,"name":"Fu Xuan","weaponType":"Preservation","element":"Quantum","gender":"Female","rarity":5,"directory":"res/chars/HSR/Fu Xuan","image":"HSR/Fu Xuan.png","pmx":"符玄（鞋+发饰补差145cm）(目修).pmx"},{"_id":10000033,"name":"Lynx","weaponType":"Abundance","element":"Quantum","gender":"Female","rarity":4,"directory":"res/chars/HSR/Lynx","image":"HSR/Lynx.png","pmx":"┴ß┐╔2.0.pmx"},{"_id":10000034,"name":"Guinaifen","weaponType":"Nihility","element":"Fire","gender":"Female","rarity":4,"directory":"res/chars/HSR/Guinaifen","image":"HSR/Guinaifen.png","pmx":"星穹铁道—桂乃芬.pmx"},{"_id":10000035,"name":"Jingliu","weaponType":"Destruction","element":"Ice","gender":"Female","rarity":5,"directory":"res/chars/HSR/Jingliu","image":"HSR/Jingliu.png","pmx":"镜流2.0.pmx"},{"_id":10000036,"name":"Topaz and Numby","weaponType":"The Hunt","element":"Fire","gender":"Female","rarity":5,"directory":"res/chars/HSR/Topaz and Numby","image":"HSR/Topaz and Numby.png","pmx":"═╨┼┴.pmx"},{"_id":10000037,"name":"Argenti","weaponType":"Erudition","element":"Physical","gender":"Male","rarity":5,"directory":"res/chars/HSR/Argenti","image":"HSR/Argenti.png","pmx":"星穹铁道—银枝3.pmx"},{"_id":10000038,"name":"Hanya","weaponType":"Harmony","element":"Physical","gender":"Female","rarity":4,"directory":"res/chars/HSR/Hanya","image":"HSR/Hanya.png","pmx":"║«╤╗3.0.pmx"},{"_id":10000039,"name":"Huohuo","weaponType":"Abundance","element":"Wind","gender":"Female","rarity":5,"directory":"res/chars/HSR/Huohuo","image":"HSR/Huohuo.png","pmx":"▐╜▐╜4.0.pmx"},{"_id":10000040,"name":"Dr. Ratio","weaponType":"The Hunt","element":"Imaginary","gender":"Male","rarity":5,"directory":"res/chars/HSR/Dr. Ratio","image":"HSR/Dr. Ratio.png","pmx":"星穹铁道—真理医生2.pmx"},{"_id":10000041,"name":"Ruan Mei","weaponType":"Harmony","element":"Ice","gender":"Female","rarity":5,"directory":"res/chars/HSR/Ruan Mei","image":"HSR/Ruan Mei.png","pmx":"╚εíñ├╖1.0.pmx"},{"_id":10000042,"name":"Xueyi","weaponType":"Destruction","element":"Quantum","gender":"Female","rarity":4,"directory":"res/chars/HSR/Xueyi","image":"HSR/Xueyi.png","pmx":"雪衣1.0.pmx"},{"_id":10000043,"name":"Black Swan","weaponType":"Nihility","element":"Wind","gender":"Female","rarity":5,"directory":"res/chars/HSR/Black Swan","image":"HSR/Black Swan.png","pmx":"星穹铁道—黑天鹅（优化）.pmx"},{"_id":10000044,"name":"Misha","weaponType":"Destruction","element":"Ice","gender":"Male","rarity":4,"directory":"res/chars/HSR/Misha","image":"HSR/Misha.png","pmx":"星穹铁道—米沙.pmx"},{"_id":10000045,"name":"Sparkle","weaponType":"Harmony","element":"Quantum","gender":"Female","rarity":5,"directory":"res/chars/HSR/Sparkle","image":"HSR/Sparkle.png","pmx":"╗¿╗≡3.0.pmx"},{"_id":10000046,"name":"Acheron","weaponType":"Nihility","element":"Lightning","gender":"Female","rarity":5,"directory":"res/chars/HSR/Acheron/Acheron","image":"HSR/Acheron.png","pmx":"星穹铁道—黄泉（轴修复）.pmx"},{"_id":10000047,"name":"Aventurine","weaponType":"Preservation","element":"Imaginary","gender":"Female","rarity":5,"directory":"res/chars/HSR/Aventurine","image":"HSR/Aventurine.png","pmx":"星穹铁道—砂金9.pmx"},{"_id":10000048,"name":"Gallagher","weaponType":"Abundance","element":"Fire","gender":"Male","rarity":4,"directory":"res/chars/HSR/Gallagher","image":"HSR/Gallagher.png","pmx":"星穹铁道—加拉赫.pmx"},{"_id":10000049,"name":"Boothill","weaponType":"The Hunt","element":"Physical","gender":"Male","rarity":5,"directory":"res/chars/HSR/Boothill","image":"HSR/Boothill.png","pmx":"星穹铁道—波提欧2.pmx"},{"_id":10000050,"name":"Robin","weaponType":"Harmony","element":"Physical","gender":"Female","rarity":5,"directory":"res/chars/HSR/Robin","image":"HSR/Robin.png","pmx":"星穹铁道—知更鸟（改）.pmx"},{"_id":10000051,"name":"Firefly","weaponType":"Destruction","element":"Fire","gender":"Female","rarity":5,"directory":"res/chars/HSR/Firefly/Firefly","image":"HSR/Firefly.png","pmx":"流萤3.0.pmx"},{"_id":10000052,"name":"Jade","weaponType":"Erudition","element":"Quantum","gender":"Female","rarity":5,"directory":"res/chars/HSR/Jade","image":"HSR/Jade.png","pmx":"星穹铁道—翡翠.pmx"},{"_id":10000053,"name":"March 7th (The Hunt)","weaponType":"The Hunt","element":"Imaginary","gender":"Female","rarity":4,"directory":"res/chars/HSR/March 7th/March 7th (The Hunt)","image":"HSR/March 7th (The Hunt).png","pmx":"星穹铁道—三月七3.pmx"},{"_id":10000054,"name":"Yunli","weaponType":"Destruction","element":"Physical","gender":"Female","rarity":5,"directory":"res/chars/HSR/Yunli","image":"HSR/Yunli.png","pmx":"星穹铁道—云璃2.pmx"},{"_id":10000055,"name":"Jiaoqiu","weaponType":"Nihility","element":"Fire","gender":"Male","rarity":5,"directory":"res/chars/HSR/Jiaoqiu","image":"HSR/Jiaoqiu.png","pmx":"星穹铁道—椒丘2.pmx"},{"_id":10000056,"name":"Moze","weaponType":"The Hunt","element":"Lightning","gender":"Male","rarity":4,"directory":"res/chars/HSR/Moze","image":"HSR/Moze.png","pmx":"貘泽.pmx"},{"_id":10000057,"name":"Feixiao","weaponType":"The Hunt","element":"Wind","gender":"Female","rarity":5,"directory":"res/chars/HSR/Feixiao/Feixiao","image":"HSR/Feixiao.png","pmx":"飞霄2.0.pmx"},{"_id":10000058,"name":"Lingsha","weaponType":"Abundance","element":"Fire","gender":"Female","rarity":5,"directory":"res/chars/HSR/Lingsha","image":"HSR/Lingsha.png","pmx":"霊砂.pmx"},{"_id":10000059,"name":"Rappa","weaponType":"Erudition","element":"Imaginary","gender":"Female","rarity":5,"directory":"res/chars/HSR/Rappa","image":"HSR/Rappa.png","pmx":"星穹铁道—乱破.pmx"},{"_id":10000060,"name":"Sunday","weaponType":"Harmony","element":"Imaginary","gender":"Male","rarity":5,"directory":"res/chars/HSR/Sunday","image":"HSR/Sunday.png","pmx":"星穹铁道—星期日.pmx"},{"_id":1000001,"name":"Mr. Reca","weaponType":"Universal","element":"Universal","gender":"Male","rarity":6,"directory":"res/chars/HSR/Mr. Reca","image":"HSR/Mr. Reca.png","pmx":"芮克七代.pmx"}]'),_u=JSON.parse('[{"_id":10000014,"name":"March 7th","weaponType":"Preservation","element":"Ice","gender":"Female","rarity":4,"directory":"res/chars/HSR/March 7th/Skin1","image":"HSR/March 7th.png","pmx":"三月七.pmx"},{"_id":10000046,"name":"Acheron","weaponType":"Nihility","element":"Lightning","gender":"Female","rarity":5,"directory":"res/chars/HSR/Acheron/Acheron - Red Form","image":"HSR/Acheron.png","pmx":"星穹铁道—黄泉（轴修复）.pmx"},{"_id":10000057,"name":"Feixiao","weaponType":"The Hunt","element":"Wind","gender":"Female","rarity":5,"directory":"res/chars/HSR/Feixiao/Nocape","image":"HSR/Feixiao.png","pmx":"星穹铁道—飞霄（无外套）.pmx"}]'),pu=JSON.parse('[{"_id":10000000,"name":"Belle","weaponType":"Universal","element":"Universal","gender":"Female","region":"Proxies","rarity":5,"directory":"res/chars/ZZZ/Belle","image":"ZZZ/Belle.png","pmx":"铃.pmx"},{"_id":10000001,"name":"Wise","weaponType":"Universal","element":"Universal","gender":"Male","region":"Proxies","rarity":5,"directory":"res/chars/ZZZ/Wise","image":"ZZZ/Wise.png","pmx":"哲.pmx"},{"_id":10000002,"name":"Rina","weaponType":"Support","element":"Electric","gender":"Female","region":"Victoria Housekeeping","rarity":5,"directory":"res/chars/ZZZ/Rina","image":"ZZZ/Rina.png","pmx":"亚历山德丽娜.bpmx"},{"_id":10000003,"name":"Anby","weaponType":"Stun","element":"Electric","gender":"Female","region":"Cunning Hares","rarity":4,"directory":"res/chars/ZZZ/Anby","image":"ZZZ/Anby.png","pmx":"安比.pmx"},{"_id":10000004,"name":"Anton","weaponType":"Attack","element":"Electric","gender":"Male","region":"Belobog Heavy Industries","rarity":4,"directory":"res/chars/ZZZ/Anton","image":"ZZZ/Anton.png","pmx":"安东.pmx"},{"_id":10000005,"name":"Ben","weaponType":"Defense","element":"Fire","gender":"Male","region":"Belobog Heavy Industries","rarity":4,"directory":"res/chars/ZZZ/Ben","image":"ZZZ/Ben.png","pmx":"本.bpmx"},{"_id":10000006,"name":"Billy","weaponType":"Attack","element":"Physical","gender":"Male","region":"Cunning Hares","rarity":4,"directory":"res/chars/ZZZ/Billy","image":"ZZZ/Billy.png","pmx":"比利.pmx"},{"_id":10000007,"name":"Corin","weaponType":"Attack","element":"Physical","gender":"Female","region":"Victoria Housekeeping","rarity":4,"directory":"res/chars/ZZZ/Corin","image":"ZZZ/Corin.png","pmx":"可琳.pmx"},{"_id":10000008,"name":"Ellen","weaponType":"Attack","element":"Ice","gender":"Female","region":"Victoria Housekeeping","rarity":5,"directory":"res/chars/ZZZ/Ellen","image":"ZZZ/Ellen.png","pmx":"艾莲.pmx"},{"_id":10000009,"name":"Grace","weaponType":"Anomaly","element":"Electric","gender":"Female","region":"Belobog Heavy Industries","rarity":5,"directory":"res/chars/ZZZ/Grace","image":"ZZZ/Grace.png","pmx":"格莉丝.pmx"},{"_id":10000010,"name":"Koleda","weaponType":"Stun","element":"Fire","gender":"Female","region":"Belobog Heavy Industries","rarity":5,"directory":"res/chars/ZZZ/Koleda","image":"ZZZ/Koleda.png","pmx":"珂雷妲.pmx"},{"_id":10000011,"name":"Lucy","weaponType":"Support","element":"Fire","gender":"Female","region":"Sons of Calydon","rarity":4,"directory":"res/chars/ZZZ/Lucy","image":"ZZZ/Lucy.png","pmx":"露西_帽.pmx"},{"_id":10000012,"name":"Nekomata","weaponType":"Attack","element":"Physical","gender":"Female","region":"Cunning Hares","rarity":5,"directory":"res/chars/ZZZ/Nekomata","image":"ZZZ/Nekomata.png","pmx":"猫又.pmx"},{"_id":10000013,"name":"Nicole","weaponType":"Support","element":"Ether","gender":"Female","region":"Cunning Hares","rarity":4,"directory":"res/chars/ZZZ/Nicole","image":"ZZZ/Nicole.png","pmx":"妮可.pmx"},{"_id":10000014,"name":"Piper","weaponType":"Anomaly","element":"Physical","gender":"Female","region":"Sons of Calydon","rarity":4,"directory":"res/chars/ZZZ/Piper","image":"ZZZ/Piper.png","pmx":"派派.pmx"},{"_id":10000015,"name":"Soldier 11","weaponType":"Attack","element":"Fire","gender":"Female","region":"Obol Squad","rarity":5,"directory":"res/chars/ZZZ/Soldier 11","image":"ZZZ/Soldier 11.png","pmx":"11号.pmx"},{"_id":10000016,"name":"Soukaku","weaponType":"Support","element":"Ice","gender":"Female","region":"Section 6","rarity":4,"directory":"res/chars/ZZZ/Soukaku","image":"ZZZ/Soukaku.png","pmx":"苍角.pmx"},{"_id":10000017,"name":"Lycaon","weaponType":"Stun","element":"Ice","gender":"Male","region":"Proxies","rarity":5,"directory":"res/chars/ZZZ/Lycaon","image":"ZZZ/Lycaon.png","pmx":"莱卡恩.pmx"},{"_id":10000018,"name":"Zhu Yuan","weaponType":"Attack","element":"Ether","gender":"Female","region":"Criminal Investigation Special Response Team","rarity":5,"directory":"res/chars/ZZZ/Zhu Yuan","image":"ZZZ/Zhu Yuan.png","pmx":"朱鸢.pmx"},{"_id":10000019,"name":"Qingyi","weaponType":"Stun","element":"Electric","gender":"Female","region":"Criminal Investigation Special Response Team","rarity":5,"directory":"res/chars/ZZZ/Qingyi","image":"ZZZ/Qingyi.png","pmx":"Qingyi.pmx"},{"_id":10000020,"name":"Jane Doe","weaponType":"Anomaly","element":"Physical","gender":"Female","region":"Faction Unknown","rarity":5,"directory":"res/chars/ZZZ/Jane Doe","image":"ZZZ/Jane Doe.png","pmx":"简.pmx"},{"_id":10000021,"name":"Seth Lowell","weaponType":"Defense","element":"Electric","gender":"Male","region":"Criminal Investigation Special Response Team","rarity":4,"directory":"res/chars/ZZZ/Seth Lowell","image":"ZZZ/Seth Lowell.png","pmx":"赛斯.pmx"},{"_id":10000022,"name":"Caesar King","weaponType":"Defense","element":"Physical","gender":"Female","region":"Sons of Calydon","rarity":5,"directory":"res/chars/ZZZ/Caesar King","image":"ZZZ/Caesar King.png","pmx":"凯撒.pmx"},{"_id":10000023,"name":"Burnice White","weaponType":"Anomaly","element":"Fire","gender":"Female","region":"Sons of Calydon","rarity":5,"directory":"res/chars/ZZZ/Burnice White","image":"ZZZ/Burnice White.png","pmx":"柏妮思.pmx"},{"_id":10000024,"name":"Tsukishiro Yanagi","weaponType":"Anomaly","element":"Electric","gender":"Female","region":"Section 6","rarity":5,"directory":"res/chars/ZZZ/Tsukishiro Yanagi","image":"ZZZ/Tsukishiro Yanagi.png","pmx":"柳.pmx"},{"_id":10000025,"name":"Lighter","weaponType":"Stun","element":"Fire","gender":"Male","region":"Sons of Calydon","rarity":5,"directory":"res/chars/ZZZ/Lighter","image":"ZZZ/Lighter.png","pmx":"莱特.pmx"},{"_id":1000000,"name":"Hoshimi Miyabi","weaponType":"Support","element":"Ice","gender":"Female","region":"Section 6","rarity":6,"directory":"res/chars/ZZZ/Hoshimi Miyabi","image":"ZZZ/Hoshimi Miyabi.png","pmx":"Hoshimi Miyabi.bpmx"}]');class fu{loadingUIBackgroundColor;loadingUIText;constructor(e,t="Loading",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._resizeLoadingUI=()=>{const e=this._renderingCanvas.getBoundingClientRect(),t=window.getComputedStyle(this._renderingCanvas).position;this._loadingDiv&&(this._loadingDiv.style.position="fixed"===t?"fixed":"absolute",this._loadingDiv.style.left=e.left+"px",this._loadingDiv.style.top=e.top+"px",this._loadingDiv.style.width=e.width+"px",this._loadingDiv.style.height=e.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this.loadingTextDiv=document.createElement("div"),this.loadingTextDiv.style.position="absolute",this.loadingTextDiv.style.left="0",this.loadingTextDiv.style.top="50%",this.loadingTextDiv.style.marginTop="80px",this.loadingTextDiv.style.width="100%",this.loadingTextDiv.style.height="20px",this.loadingTextDiv.style.fontFamily="Arial",this.loadingTextDiv.style.fontSize="14px",this.loadingTextDiv.style.color="white",this.loadingTextDiv.style.textAlign="center",this.loadingTextDiv.style.zIndex="1",this.loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this.loadingTextDiv),this.loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css",this._style.innerHTML="@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }",document.getElementsByTagName("head")[0].appendChild(this._style);const e=!!window.SVGSVGElement,t=new Image,i=["paimon_load","kururin","guinaifen","furina","bangboo"];t.src="res/assets/loads/"+i[Math.floor(Math.random()*i.length)]+".gif",t.style.width="150px",t.style.gridColumn="1",t.style.gridRow="1",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.position="absolute";const s=document.createElement("div");s.style.width="300px",s.style.gridColumn="1",s.style.gridRow="1",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.position="absolute";const r=new Image;if(r.src=fu.DefaultSpinnerUrl?fu.DefaultSpinnerUrl:e?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",r.style.animation="spin1 0.75s infinite linear",r.style.webkitAnimation="spin1 0.75s infinite linear",r.style.transformOrigin="50% 50%",r.style.webkitTransformOrigin="50% 50%",!e){const e={w:16,h:18.5},i={w:30,h:30};t.style.width=`${e.w}vh`,t.style.height=`${e.h}vh`,t.style.left=`calc(50% - ${e.w/2}vh)`,t.style.top=`calc(50% - ${e.h/2}vh)`,r.style.width=`${i.w}vh`,r.style.height=`${i.h}vh`,r.style.left=`calc(50% - ${i.w/2}vh)`,r.style.top=`calc(50% - ${i.h/2}vh)`}s.appendChild(r),this._loadingDiv.appendChild(t),this._loadingDiv.appendChild(s),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){this._loadingDiv&&(this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",(()=>{this.loadingTextDiv&&(this.loadingTextDiv.remove(),this.loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)})))}set loadingUIText(e){this._loadingText=e,this.loadingTextDiv&&(this.loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}var mu,gu;g.$.DefaultLoadingScreenFactory=e=>new fu(e),function(e){e[e.Seconds=0]="Seconds",e[e.Frames=1]="Frames"}(mu||(mu={}));class vu{autoHidePlayerControl;hidePlayerControlTimeout;displayTimeFormat;_mmdRuntime;_audioPlayer;_newCanvasContainer;_playerContainer;_hidePlayerControlTimeoutId;_playButton;_timeSlider;_soundButton;_volumeSlider;_currentFrameNumberSpan;_endFrameNumberSpan;_speedSlider;_fullscreenButton;_bindedDispose;_scene;constructor(e,t,i){const s=e.getEngine().getInputElement();if(null===s)throw new Error("Failed to get root element.");this.autoHidePlayerControl=!0,this.hidePlayerControlTimeout=3e3,this.displayTimeFormat=mu.Seconds,this._mmdRuntime=t,this._audioPlayer=i??null;const r=this._newCanvasContainer=this._createCanvasContainer(s.parentElement);this._playerContainer=null,this._hidePlayerControlTimeoutId=void 0,this._playButton=null,this._timeSlider=null,this._soundButton=null,this._volumeSlider=null,this._currentFrameNumberSpan=null,this._endFrameNumberSpan=null,this._speedSlider=null,this._fullscreenButton=null,this._createPlayerControl(r,t,i),t.onPlayAnimationObservable.add(this._onAnimationPlay),t.onPauseAnimationObservable.add(this._onAnimationPause),t.onAnimationDurationChangedObservable.add(this._onAnimationDurationChanged),t.onAnimationTickObservable.add(this._onAnimationTick),i?.onMuteStateChangedObservable.add(this._onMuteStateChanged),this._bindedDispose=this.dispose.bind(this),this._scene=e,e.onDisposeObservable.add(this._bindedDispose)}_createCanvasContainer(e){const t=e.ownerDocument.createElement("div");for(t.style.display=e.style.display;e.childElementCount>0;){const i=e.childNodes[0];e.removeChild(i),t.appendChild(i)}return e.appendChild(t),t.style.width="100%",t.style.height="100%",t.style.overflow="hidden",t}_restoreCanvasContainer(e){const t=this._newCanvasContainer;for(;t.childElementCount>0;){const i=t.childNodes[0];t.removeChild(i),e.appendChild(i)}e.removeChild(t)}_createPlayerControl(e,t,i){const s=e.ownerDocument,r=this._playerContainer=s.createElement("div");r.style.position="relative",r.style.bottom="120px",r.style.left="0",r.style.width="100%",r.style.height="120px",r.style.transform="translateY(50%)",r.style.transition="transform 0.5s",e.appendChild(r),r.onmouseenter=this._onPlayerControlMouseEnter,r.onmouseleave=this._onPlayerControlMouseLeave;{const n=s.createElement("div");n.style.position="absolute",n.style.bottom="0",n.style.left="0",n.style.width="100%",n.style.height="50%",n.style.boxSizing="border-box",n.style.background="linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.6))",n.style.display="flex",n.style.flexDirection="column",r.appendChild(n);{const r=s.createElement("div");r.style.width="100%",r.style.boxSizing="border-box",r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",n.appendChild(r);{const e=this._timeSlider=s.createElement("input");e.style.width="100%",e.style.height="4px",e.style.border="none",e.style.opacity="0.5",e.type="range",e.min="0",e.max=t.animationFrameTimeDuration.toString(),e.oninput=i=>{i.preventDefault(),t.seekAnimation(Number(e.value),!0)};{let i=!1;e.onmousedown=()=>{t.isAnimationPlaying&&(t.pauseAnimation(),i=!0)},e.onmouseup=()=>{i&&(t.playAnimation(),i=!1)}}r.appendChild(e)}const a=s.createElement("div");a.style.width="100%",a.style.flexGrow="1",a.style.padding="0 5px",a.style.boxSizing="border-box",a.style.display="flex",a.style.flexDirection="row",a.style.alignItems="space-between",n.appendChild(a);{const r=s.createElement("div");r.style.flex="1",r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",a.appendChild(r);{const e=this._playButton=s.createElement("button");if(e.style.width="40px",e.style.border="none",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.color="white",e.style.fontSize="18px",e.innerText=t.isAnimationPlaying?"❚❚":"▶",e.onclick=()=>{t.isAnimationPlaying?t.pauseAnimation():t.playAnimation()},r.appendChild(e),void 0!==i){const e=this._soundButton=s.createElement("button");e.style.width="35px",e.style.border="none",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.color="white",e.style.fontSize="20px",e.innerText=i.muted?"🔇":"🔊",e.onclick=()=>{i.muted?i.unmute():i.mute()},r.appendChild(e);const t=this._volumeSlider=s.createElement("input");t.style.width="80px",t.style.height="4px",t.style.border="none",t.style.opacity="0.5",t.type="range",t.min="0",t.max="1",t.step="0.01",t.value=i.volume.toString(),t.oninput=()=>{i.volume=Number(t.value)},r.appendChild(t)}const n=this._currentFrameNumberSpan=s.createElement("span");n.style.width="40px",n.style.textAlign="right",n.style.color="white",n.innerText=this.displayTimeFormat===mu.Seconds?this._getFormattedTime(t.currentTime):Math.floor(t.currentFrameTime).toString(),r.appendChild(n);const a=this._endFrameNumberSpan=s.createElement("span");a.style.width="50px",a.style.textAlign="left",a.style.color="white",a.innerHTML="&nbsp;/&nbsp;"+(this.displayTimeFormat===mu.Seconds?this._getFormattedTime(t.animationDuration):Math.floor(t.animationFrameTimeDuration).toString()),r.appendChild(a)}const n=s.createElement("div");n.style.flex="1",n.style.display="flex",n.style.flexDirection="row",n.style.alignItems="center",n.style.justifyContent="flex-end",a.appendChild(n);{const i=s.createElement("label");i.style.width="40px",i.style.textAlign="center",i.style.color="white",i.innerText="1.00x",n.appendChild(i);const r=this._speedSlider=s.createElement("input");r.style.width="80px",r.style.height="4px",r.style.border="none",r.style.opacity="0.5",r.type="range",r.min="0.07",r.max="1",r.step="0.01",r.value=t.timeScale.toString(),r.oninput=()=>{t.timeScale=Number(r.value),i.innerText=t.timeScale.toFixed(2)+"x"},n.appendChild(r);const a=this._fullscreenButton=s.createElement("button");a.style.width="40px",a.style.border="none",a.style.color="white",a.style.backgroundColor="rgba(0, 0, 0, 0)",a.style.fontSize="20px",a.innerText="🗖",a.onclick=()=>{s.fullscreenElement?s.exitFullscreen():e.requestFullscreen()},n.appendChild(a)}}}}}_onPlayerControlMouseEnter=()=>{this.autoHidePlayerControl&&(window.clearTimeout(this._hidePlayerControlTimeoutId),this._hidePlayerControlTimeoutId=void 0,this.showPlayerControl())};_onPlayerControlMouseLeave=()=>{this.autoHidePlayerControl&&(this._hidePlayerControlTimeoutId=window.setTimeout(this.hidePlayerControl.bind(this),this.hidePlayerControlTimeout))};_onAnimationPlay=()=>{this._playButton.innerText="❚❚"};_onAnimationPause=()=>{this._playButton.innerText="▶"};_onAnimationDurationChanged=()=>{const e=this._mmdRuntime;this._timeSlider.max=e.animationFrameTimeDuration.toString(),this._endFrameNumberSpan.innerHTML="&nbsp;/&nbsp;"+(this.displayTimeFormat===mu.Seconds?this._getFormattedTime(e.animationDuration):Math.floor(e.animationFrameTimeDuration).toString())};_onAnimationTick=()=>{const e=this._mmdRuntime;if(this._timeSlider.value=e.currentFrameTime.toString(),this.displayTimeFormat===mu.Seconds){const t=this._getFormattedTime(e.currentTime);this._currentFrameNumberSpan.innerText!==t&&(this._currentFrameNumberSpan.innerText=t)}else this._currentFrameNumberSpan.innerText=Math.floor(e.currentFrameTime).toString()};_onMuteStateChanged=()=>{null!==this._soundButton&&(this._soundButton.innerText=this._audioPlayer.muted?"🔇":"🔊")};_formattedTimeCacheKey=NaN;_formatterTimeCacheValue="";_getFormattedTime(e){const t=Math.floor(e);if(t===this._formattedTimeCacheKey)return this._formatterTimeCacheValue;if(!isFinite(e))return this._formattedTimeCacheKey=t,this._formatterTimeCacheValue="-:--","-:--";const i=Math.floor(e/60),s=Math.floor(e%60),r=i.toString()+":"+(s<10?"0":"")+s.toString();return this._formattedTimeCacheKey=t,this._formatterTimeCacheValue=r,r}hidePlayerControl(){this._playerContainer.style.transform="translateY(50%)",this._hidePlayerControlTimeoutId=void 0}showPlayerControl(){this._playerContainer.style.transform="translateY(0)"}dispose(){null!==this._newCanvasContainer&&(this._restoreCanvasContainer(this._newCanvasContainer.parentElement),this._newCanvasContainer=null,this._playButton.onclick=null,this._timeSlider.oninput=null,this._timeSlider.onmousedown=null,this._timeSlider.onmouseup=null,null!==this._audioPlayer&&(this._soundButton.onclick=null,this._volumeSlider.oninput=null),this._speedSlider.oninput=null,this._fullscreenButton.onclick=null,this._playerContainer.onmouseenter=null,this._playerContainer.onmouseleave=null,this._playerContainer.remove(),this._mmdRuntime.onPlayAnimationObservable.removeCallback(this._onAnimationPlay),this._mmdRuntime.onPauseAnimationObservable.removeCallback(this._onAnimationPause),this._mmdRuntime.onAnimationDurationChangedObservable.removeCallback(this._onAnimationDurationChanged),this._mmdRuntime.onAnimationTickObservable.removeCallback(this._onAnimationTick),this._audioPlayer?.onMuteStateChangedObservable.removeCallback(this._onMuteStateChanged),this._scene.onDisposeObservable.removeCallback(this._bindedDispose))}}!function(e){e[e.Seconds=0]="Seconds",e[e.Frames=1]="Frames"}(gu||(gu={}));class bu extends vu{_isMobile;_speedlabel;constructor(e,t,i,s=!1){super(e,t,i),this._speedlabel=null,this._isMobile=s,this._mobileRemoval()}_mobileRemoval(){if(this._isMobile){const e=document.getElementById("plrc"),t=document.getElementById("sLa"),i=document.getElementById("sLi");e.removeChild(t),e.removeChild(i)}}_createPlayerControl(e,t,i){const s=e.ownerDocument,r=this._playerContainer=s.createElement("div");r.style.position="relative",r.style.bottom="120px",r.style.left="0",r.style.width="100%",r.style.height="120px",r.style.transform="translateY(50%)",r.style.transition="transform 0.5s",e.appendChild(r),r.onmouseenter=this._onPlayerControlMouseEnter,r.onmouseleave=this._onPlayerControlMouseLeave;{const n=s.createElement("div");n.style.position="absolute",n.style.bottom="0",n.style.left="0",n.style.width="100%",n.style.height="50%",n.style.boxSizing="border-box",n.style.background="linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.6))",n.style.display="flex",n.style.flexDirection="column",r.appendChild(n);{const r=s.createElement("div");r.style.width="100%",r.style.boxSizing="border-box",r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",n.appendChild(r);{const e=this._timeSlider=s.createElement("input");e.style.width="100%",e.style.height="4px",e.style.border="none",e.style.opacity="0.5",e.type="range",e.min="0",e.max=t.animationFrameTimeDuration.toString(),e.oninput=i=>{i.preventDefault(),t.seekAnimation(Number(e.value),!0)};{let i=!1;e.onmousedown=()=>{t.isAnimationPlaying&&(t.pauseAnimation(),i=!0)},e.onmouseup=()=>{i&&(t.playAnimation(),i=!1)}}r.appendChild(e)}const a=s.createElement("div");a.style.width="100%",a.style.flexGrow="1",a.style.padding="0 5px",a.style.boxSizing="border-box",a.style.display="flex",a.style.flexDirection="row",a.style.alignItems="space-between",n.appendChild(a);{const r=s.createElement("div");r.style.flex="1",r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",a.appendChild(r);{const e=this._playButton=s.createElement("button");if(e.style.width="40px",e.style.border="none",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.color="white",e.style.fontSize="18px",e.innerText=t.isAnimationPlaying?"❚❚":"▶",e.onclick=()=>{t.isAnimationPlaying?t.pauseAnimation():t.playAnimation()},r.appendChild(e),void 0!==i){const e=this._soundButton=s.createElement("button");e.style.width="35px",e.style.border="none",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.color="white",e.style.fontSize="20px",e.innerText=i.muted?"🔇":"🔊",e.onclick=()=>{i.muted?i.unmute():i.mute()},r.appendChild(e);const t=this._volumeSlider=s.createElement("input");t.style.width="80px",t.style.height="4px",t.style.border="none",t.style.opacity="0.5",t.type="range",t.min="0",t.max="1",t.step="0.01",t.value=i.volume.toString(),t.oninput=()=>{i.volume=Number(t.value)},r.appendChild(t)}const n=this._currentFrameNumberSpan=s.createElement("span");n.style.width="40px",n.style.textAlign="right",n.style.color="white",n.innerText=this.displayTimeFormat===gu.Seconds?this._getFormattedTime(t.currentTime):Math.floor(t.currentFrameTime).toString(),r.appendChild(n);const a=this._endFrameNumberSpan=s.createElement("span");a.style.width="50px",a.style.textAlign="left",a.style.color="white",a.innerHTML="&nbsp;/&nbsp;"+(this.displayTimeFormat===gu.Seconds?this._getFormattedTime(t.animationDuration):Math.floor(t.animationFrameTimeDuration).toString()),r.appendChild(a)}const n=s.createElement("div");n.style.flex="1",n.style.display="flex",n.style.flexDirection="row",n.style.alignItems="center",n.style.justifyContent="flex-end",n.id="plrc",a.appendChild(n);{const i=this._speedlabel=s.createElement("label");i.style.width="40px",i.style.textAlign="center",i.style.color="white",i.innerText="1.00x",i.id="sLa",n.appendChild(i);const r=this._speedSlider=s.createElement("input");r.style.width="80px",r.style.height="4px",r.style.border="none",r.style.opacity="0.5",r.type="range",r.min="0.07",r.max="1",r.step="0.01",r.id="sLi",r.value=t.timeScale.toString(),r.oninput=()=>{t.timeScale=Number(r.value),i.innerText=t.timeScale.toFixed(2)+"x"},n.appendChild(r);const a=this._fullscreenButton=s.createElement("button");a.style.width="40px",a.style.border="none",a.style.color="white",a.style.backgroundColor="rgba(0, 0, 0, 0)",a.style.fontSize="20px",a.innerHTML='<img src="res/assets/maximise.png" alt="Fullscreen" style="width: 100%; height: 100%;">',a.onclick=()=>{s.fullscreenElement?s.exitFullscreen():e.requestFullscreen()},n.appendChild(a)}}}}}}class xu{async build(e,t,i){lo.OverrideEngineCreateEffect(t);const s=new lu.CounterAPI,r=hu,n=cu,a=uu,o=_u,l=du,h=pu;n.sort(((e,t)=>t._id-e._id)),a.sort(((e,t)=>t._id-e._id)),o.sort(((e,t)=>t._id-e._id)),l.sort(((e,t)=>t._id-e._id)),h.sort(((e,t)=>t._id-e._id));const c=(e,t)=>e.find((e=>e.name===t)),u=(e,t)=>_(e.filter((e=>e.name===t)),"name",!1);function d(e,t){return e.filter((e=>t.every((t=>String(e[t.key]).includes(t.value)))))}function _(e,t,i=!0){return e.slice().sort(((e,s)=>{const r=e[t],n=s[t];if("number"==typeof r&&"number"==typeof n)return i?r-n:n-r;{const e=String(r),t=String(n);return i?t.localeCompare(e):e.localeCompare(t)}}))}const p=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),f=new Ga;f.afterBuildSingleMaterial=e=>{e.forceDepthWrite=!0,e.useAlphaFromDiffuseTexture=!0,null!==e.diffuseTexture&&(e.diffuseTexture.hasAlpha=!0),e.transparencyMode===Te.i.MATERIAL_ALPHABLEND&&(e.transparencyMode=Te.i.MATERIAL_ALPHATESTANDBLEND,e.alphaCutOff=.01)};const m=[".pmx",".bpmx"].map((e=>er.GetPluginForExtension(e)));for(const e of m)e.loggingEnabled=!0,e.materialBuilder=f;const g=new be.Z(t);let v=!1;window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?(v=!0,g.clearColor=new M.ov(.001,.001,.001,1)):g.clearColor=new M.ov(1,1,1,1);const b=Ch.CreateFullscreenUI("UI");b.layer.layerMask=268435456,b.idealWidth=1e3,b.idealHeight=1e3,b.useSmallestIdeal=!0;const x=.09,S=new dt("mmdRoot",g);S.scaling.scaleInPlace(x),S.position.z=1;const T=new dt("mmdRoot",g);T.scaling.scaleInPlace(x),T.position.z=1;const y=new Xc("mmdCamera",new I.Pq(0,10,0),g);y.maxZ=100,y.minZ=1,y.parent=S,y.layerMask=1;const C=new I.Pq(0,10,-20).scaleInPlace(x),P=new oi("arcRotateCamera",0,0,2.25,new I.Pq(0,10*x,1),g);P.maxZ=100,P.minZ=.1,P.setPosition(C),P.attachControl(e,!1),P.inertia=.8,P.speed=.36,P.zoomToMouseLocation=!0,P.wheelDeltaPercentage=.1,P.upperRadiusLimit=9,P.lowerRadiusLimit=.09,p&&(P.pinchDeltaPercentage=.002),P.layerMask=1;const E=new oi("stillCamera",0,0,2.25,new I.Pq(0,10*x,1),g);E.maxZ=100,E.minZ=.1,E.setPosition(C),E.attachControl(e,!1),E.inertia=.8,E.speed=.36,E.zoomToMouseLocation=!0,E.wheelDeltaPercentage=.1,E.upperRadiusLimit=9,E.lowerRadiusLimit=.09,p&&(E.pinchDeltaPercentage=.002),E.layerMask=1;const A=new oi("guiCamera",Math.PI/2+Math.PI/7,Math.PI/2,100,new I.Pq(0,20,0),g);A.layerMask=268435456;const R=new je("HemisphericLight",new I.Pq(0,1,0),g);R.intensity=.4,R.specular=new M.v9(0,0,0),R.groundColor=new M.v9(1,1,1);const O=new No("DirectionalLight",new I.Pq(.5,-1,1),g);O.intensity=.8,O.autoCalcShadowZBounds=!1,O.autoUpdateExtends=!1,O.shadowMaxZ=20*x,O.shadowMinZ=-15*x,O.orthoTop=18*x,O.orthoBottom=-.27,O.orthoLeft=-10*x,O.orthoRight=10*x,O.shadowOrthoScale=0;const w=new j(1024,O,!0);let D;w.usePercentageCloserFiltering=!0,w.forceBackFacesOnly=!0,w.filteringQuality=j.QUALITY_MEDIUM,w.frustumEdgeFalloff=.1,D=new iu(g),D.loggingEnabled=!0,D.register(g);const F=new Gc(g);F.preservesPitch=!1,F.source="res/cam_motion/Specialist (Never End ver.)/music001.mp3",D.setAudioPlayer(F);let N=new bu(g,D,F,p);N.showPlayerControl();const L=new fu(e);t.loadingScreen=L,t.displayLoadingUI();let B=[];const k=(e,t)=>{B[e]=t,L.loadingTextDiv.innerHTML="<br/><br/><br/><br/>"+B.join("<br/><br/>")};let V=[];const U=new Uc(g);let z,H;U.loggingEnabled=!0,V.push(U.loadAsync("motion","res/cam_motion/Specialist (Never End ver.)/CameraMAIN2.bvmd",(e=>k(0,`Loading camera... ${e.loaded}/${e.total} (${Math.floor(100*e.loaded/e.total)}%)`)))),V.push(U.loadAsync("motion","res/cam_motion/Specialist (Never End ver.)/mmd_Specialist_motion.bvmd",(e=>k(1,`Loading motion... ${e.loaded}/${e.total} (${Math.floor(100*e.loaded/e.total)}%)`))));let W,X=i,K="Genshin",Q=K;const Y=[n,l,h];[W,Q]=((e,t)=>{const i=e=>e.toLowerCase().replace(/[^a-z]/g,""),s=i(t);let r;for(let t=0;t<e.length;t++){let n;if(r=e[t].find((e=>i(e.name)===s)),n=0==t?"Genshin":1==t?"HSR":"ZZZ",r)return[r,n]}const n=e[0].find((e=>"hutao"===i(e.name)));return[n,"Genshin"]})(Y,X),X=W.name;let q=W.pmx.substring(W.pmx.lastIndexOf(".")),$=m.find((e=>e&&Object.keys(e.extensions).includes(q)));if(!(W&&W.directory&&W.pmx))throw new Error("Chosen character or its properties are undefined");V.push(er.ImportMeshAsync(void 0,W.directory+"/",W.pmx,g,(e=>k(2,`Loading model... ${e.loaded}/${e.total} (${Math.floor(100*e.loaded/e.total)}%)`)))),V.push((async()=>{k(2,"Loading physics engine...");const e=await Mc();new Wo(!0,e),k(2,"Loading physics engine... Done")})());let Z=await Promise.all(V);g.onAfterRenderObservable.addOnce((()=>t.hideLoadingUI())),g.activeCameras=[E,A];let J=1.66,ee=69,te=new I.uq,ie=Z[2].meshes[0];ie.parent=S,w.addShadowCaster(ie);for(const e of ie.metadata.meshes)e.receiveShadows=!0;const se=vi("ground1",{width:100,height:100,subdivisions:2,updatable:!1},g),re=se.material=new wc("shadowOnly",g);re.activeLight=O,re.alpha=.4,se.receiveShadows=!0,se.parent=S;let ne=D.createMmdModel(ie);const ae=Z[1];let oe=ne.runtimeBones.find((e=>"頭"===e.name)),le=ne.runtimeBones.find((e=>"センター"===e.name)),he=new I.uq;null!=oe&&null!=le&&(ne.addAnimation(ae),ne.setAnimation("motion"),g.onBeforeDrawPhaseObservable.addOnce((()=>{oe.getWorldMatrixToRef(te).multiplyToRef(ie.getWorldMatrix(),te),te.getTranslationToRef(T.position),J-=T.position.y,ee=T.position.y})),g.onBeforeRenderObservable.add((()=>{le.getWorldMatrixToRef(he).multiplyToRef(ie.getWorldMatrix(),he),he.getTranslationToRef(O.position),O.position.y-=10*x}))),y.addAnimation(Z[0]),y.storeState(),D.setCamera(y),y.setAnimation("motion"),g.onAfterRenderObservable.addOnce((()=>{g.freezeMaterials(),null!=ye&&(ye.isEnabled=!0);const e=g.meshes;for(let t=0,i=e.length;t<i;++t){const i=e[t];i.freezeWorldMatrix(),i.doNotSyncBoundingInfo=!0,i.isPickable=!1,i.doNotSyncBoundingInfo=!0,i.alwaysSelectAsActiveMesh=!0}g.skipPointerMovePicking=!0,g.skipPointerDownPicking=!0,g.skipPointerUpPicking=!0,g.skipFrustumClipping=!0,g.blockMaterialDirtyMechanism=!0,F.mute(),s.up("phoshco","hoyo").then((e=>{console.log(e)}))}));const ce=new xl("default",!0,g,[y,P,E]);ce.samples=4,ce.bloomEnabled=!0,ce.bloomScale=10,ce.chromaticAberrationEnabled=!0,ce.chromaticAberration.aberrationAmount=1,ce.fxaaEnabled=!0,ce.imageProcessing.toneMappingEnabled=!1,ce.imageProcessing.toneMappingType=Se.p.TONEMAPPING_ACES,ce.imageProcessing.vignetteWeight=.5,ce.imageProcessing.vignetteStretch=.5,ce.imageProcessing.vignetteColor=new M.ov(0,0,0,0),ce.imageProcessing.vignetteEnabled=!0,ce.depthOfFieldEnabled=!1,ce.depthOfFieldBlurLevel=Bo.Medium,ce.depthOfField.fStop=.05,ce.depthOfField.focalLength=20;let ue=69;const de=new Fo("","res/stages/hoyo.png",g,!0,new M.ov(1,1,1,1)),_e=new G.g("res/stages/hoyo.png",g,!0),pe=new G.g("res/stages/hoyo_dark.png",g,!0);v&&(de.texture=pe),new ResizeObserver((()=>{const t=e.width/e.height;t>1?(de.scale.y=t,de.scale.x=1,_e.uScale=1,_e.vScale=1/de.scale.y,_e.uOffset=0,_e.vOffset=.5*(1-_e.vScale),pe.uScale=1,pe.vScale=1/de.scale.y,pe.uOffset=0,pe.vOffset=.5*(1-pe.vScale)):(de.scale.y=1,de.scale.x=1/t,_e.uScale=1/de.scale.x,_e.vScale=1,_e.uOffset=.5*(1-_e.uScale),_e.vOffset=0,pe.uScale=1/de.scale.x,pe.vScale=1,pe.uOffset=.5*(1-pe.uScale),pe.vOffset=0)})).observe(e),de.render;const fe=new ql;fe.widthInPixels=100,fe.heightInPixels=50,fe.left=0,fe.text="lol",fe.fontSize=16,fe.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,fe.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_RIGHT,fe.verticalAlignment=Xl.VERTICAL_ALIGNMENT_BOTTOM,fe.color="black",b.addControl(fe),fe.isVisible=!1;const me=new ql;me.widthInPixels=100,me.heightInPixels=50,me.left=0,me.text=`${g.activeCameras[0].name}`,me.fontSize=16,me.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,me.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_RIGHT,me.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,me.color="black",b.addControl(me),me.isVisible=!1;const ge=new ql;ge.resizeToFit=!0,ge.top=0,ge.left=0,ge.paddingTop=10,ge.paddingRight=10,ge.text="Double click / tap to change camera mode.",ge.fontSize=p?26:16,ge.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_CENTER,ge.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_RIGHT,ge.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,ge.color="grey",b.addControl(ge),ge.isVisible=!0;const ve=p?"100px":"50px",xe=jl.CreateImageOnlyButton("but","res/assets/menu.png");let ye;function Ce(e=!1,t,i){null!=ye&&ye.dispose(),ye=new jl,ye=jl.CreateImageOnlyButton("but","res/assets/alter.png"),v&&(ye.image.source="res/assets/alter_light.png"),ye.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,ye.left="10px",ye.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,ye.top=p?"110px":"60px",ye.width=ve,ye.height=ve,ye.thickness=0,b.addControl(ye),ye.isVisible=e,null!=t&&i&&(ye.isEnabled=!1,ye.onPointerClickObservable.addOnce((async function(){Jt(i),Pe=t,Re.isVisible&&(Re.isVisible=!1)})))}xe.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,xe.left="10px",xe.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,xe.top="10px",xe.width=ve,xe.height=ve,xe.thickness=0,b.addControl(xe),xe.onPointerClickObservable.add((function(){Re.isVisible=!Re.isVisible,xe.isVisible&&N.hidePlayerControl()}));let Pe=!1;const Ee=jl.CreateImageOnlyButton("but","res/assets/dark_mode.png");v&&(Ee.image.source="res/assets/light_mode.png"),Ee.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,Ee.left=p?"110px":"60px",Ee.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,Ee.top="10px",Ee.width=ve,Ee.height=ve,Ee.thickness=0,b.addControl(Ee),Ee.onPointerClickObservable.add((function(){v?(g.clearColor=new M.ov(1,1,1,1),de.texture=_e,Ee.image.source="res/assets/dark_mode.png",null!=ye&&(ye.image.source="res/assets/alter.png"),Ae.color="black"):(de.texture=pe,Ee.image.source="res/assets/light_mode.png",null!=ye&&(ye.image.source="res/assets/alter_light.png"),Ae.color="white"),de.render,v=!v}));const Ae=new ql;Ae.heightInPixels=p?100:50,Ae.left=p?"220px":"120px",Ae.top="10px",Ae.text=X,Ae.fontSize=p?40:20,Ae.textHorizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,Ae.horizontalAlignment=Xl.HORIZONTAL_ALIGNMENT_LEFT,Ae.verticalAlignment=Xl.VERTICAL_ALIGNMENT_TOP,Ae.color=v?"white":"black",b.addControl(Ae),Ae.isVisible=!0;const Re=new Ql("charPanel");Re.width="720px",Re.height="920px",Re.background="rgb(44,48,50)",Re.cornerRadius=20,Re.thickness=3,Re.color="black",b.addControl(Re),Re.isVisible=!1,Re.onIsVisibleChangedObservable.add((()=>{Re.isVisible||(E.attachControl(e,!1),P.attachControl(e,!1))})),Re.onPointerEnterObservable.add((function(){E.detachControl(),P.detachControl()})),Re.onPointerOutObservable.add((function(){E.attachControl(e,!1),P.attachControl(e,!1)}));let Ie,Me=!1;Re.onPointerDownObservable.add((()=>{Me=!0})),Re.onPointerUpObservable.add((()=>{setTimeout((()=>{Me=!1}),100)}));let Oe=!0;const we=new Ql;we.width="700px",we.height="900px",we.thickness=0,we.cornerRadius=15,we.background=Re.background,Re.addControl(we);const De=new Zl;De.width="700px",De.height="900px",we.addControl(De);const Fe=new Ql;Fe.width="700px",Fe.height="100px",Fe.thickness=0,De.addControl(Fe);const Ne=jl.CreateSimpleButton("but","Genshin Impact");Ne.width="233px",Ne.height="50px",Ne.color="white",Ne.background="rgb(64,68,70)",Ne.thickness=0,Ne.left=-233,Ne.top=-25,Ne.cornerRadiusX=Ne.cornerRadiusY=15,Fe.addControl(Ne);const Le=jl.CreateSimpleButton("but","Honkai: Star Rail");Le.width="233px",Le.height="50px",Le.color="white",Le.background=Re.background,Le.thickness=0,Le.left=0,Le.top=-25,Le.cornerRadiusX=Le.cornerRadiusY=15,Fe.addControl(Le);const Be=jl.CreateSimpleButton("but","Zenless Zone Zero");Be.width="233px",Be.height="50px",Be.color="white",Be.background=Re.background,Be.thickness=0,Be.left=233,Be.top=-25,Be.cornerRadiusX=Be.cornerRadiusY=15,Fe.addControl(Be);let ke,Ve=!1;const Ue=[{key:"_id",value:"10000"}],ze=[{key:"_id",value:"10000"}],Ge=[{key:"_id",value:"10000"}];let He;function We(){"HSR"!=K&&(Le.background="rgb(64,68,70)","Genshin"==K?(Ne.background=Re.background,Dt()):(Be.background=Re.background,Wt()),K="HSR",He=d(l,ze),He=_(He,ke,Ve),xt(),jt(He))}function Xe(){"ZZZ"!=K&&(Be.background="rgb(64,68,70)","Genshin"==K?(Ne.background=Re.background,Dt()):"HSR"==K&&(xt(),Le.background=Re.background),K="ZZZ",He=d(h,Ge),He=_(He,ke,Ve),Wt(),jt(He))}He=d(n,Ue),ke="_id",Ne.onPointerClickObservable.add((function(){"Genshin"!=K&&(Ne.background="rgb(64,68,70)","HSR"==K?(Le.background=Re.background,xt()):(Be.background=Re.background,Wt()),K="Genshin",He=d(n,Ue),He=_(He,ke,Ve),Dt(),jt(He))})),Le.onPointerClickObservable.add((function(){We()})),Be.onPointerClickObservable.add((function(){Xe()}));const Ke=new Ql;Ke.width="700px",Ke.height="50px",Ke.thickness=0,Ke.top=25,Ke.background="rgb(64,68,70)",Fe.addControl(Ke);const Qe=jl.CreateImageOnlyButton("but","res/assets/descending.png");Qe.height="40px",Qe.width="40px",Qe.left=-328,Qe.thickness=0,Ke.addControl(Qe),Qe.onPointerClickObservable.add((()=>{Ve?(Qe.image.source="res/assets/descending.png",He=_(He,ke,!1),jt(He)):(Qe.image.source="res/assets/ascending.png",He=_(He,ke,!0),jt(He)),Ve=!Ve}));const Ye=jl.CreateSimpleButton("but"," Release ");Ye.height="40px",Ye.width="90px",Ye.left=-258,Ye.background=Re.background,Ye.color="white",Ye.cornerRadius=15,Ye.thickness=0,Ke.addControl(Ye),Ye.onPointerClickObservable.add((()=>{null!=Ye.textBlock&&("_id"==ke?(ke="name",qe.image.source="res/assets/release.png",Ye.textBlock.text=" Name "):(ke="_id",qe.image.source="res/assets/alphabet.png",Ye.textBlock.text=" Release "),He=_(He,ke,Ve),jt(He))}));const qe=jl.CreateImageOnlyButton("but","res/assets/release.png");qe.height="40px",qe.width="40px",qe.left=-278,qe.thickness=0,Ke.addControl(qe),qe.onPointerClickObservable.add((()=>{"_id"==ke?(ke="name",qe.image.source="res/assets/alphabet.png",Ye.textBlock.text=" Name "):(ke="_id",qe.image.source="res/assets/release.png",Ye.textBlock.text=" Release "),He=_(He,ke,Ve),jt(He)})),qe.isVisible=!1;const $e=jl.CreateImageOnlyButton("but","res/assets/Genshin/rarity_4.png");$e.height="40px",$e.width="40px",$e.left=-188,$e.thickness=0,$e.cornerRadius=5,Ke.addControl($e),$e.onPointerClickObservable.add((function(){const e=Ue.findIndex((e=>"rarity"===e.key));if(-1!==e)"4"==Ue[e].value?(Ue.splice(e,1),$e.background="rgba(0,0,0,0)"):(Ue[e].value="4",Ze.background="rgba(0,0,0,0)",$e.background=Re.background);else{const e={key:"rarity",value:"4"};Ue.push(e),$e.background=Re.background}He=d(n,Ue),He=_(He,ke,Ve),jt(He)}));const Ze=jl.CreateImageOnlyButton("but","res/assets/Genshin/rarity_5.png");Ze.height="40px",Ze.width="40px",Ze.left=-148,Ze.thickness=0,Ze.cornerRadius=5,Ke.addControl(Ze),Ze.onPointerClickObservable.add((function(){const e=Ue.findIndex((e=>"rarity"===e.key));if(-1!==e)"5"==Ue[e].value?(Ue.splice(e,1),Ze.background="rgba(0,0,0,0)"):(Ue[e].value="5",$e.background="rgba(0,0,0,0)",Ze.background=Re.background);else{const e={key:"rarity",value:"5"};Ue.push(e),Ze.background=Re.background}He=d(n,Ue),He=_(He,ke,Ve),jt(He)}));const Je=jl.CreateImageOnlyButton("but","res/assets/HSR/rarity_5.png");Je.height="40px",Je.width="40px",Je.left=-238,Je.thickness=0,Je.cornerRadius=5,Ke.addControl(Je),Je.isVisible=!1,Je.onPointerClickObservable.add((function(){const e=ze.findIndex((e=>"rarity"===e.key));if(-1!==e)"4"==ze[e].value?(ze.splice(e,1),Je.background="rgba(0,0,0,0)",Je.image.source="res/assets/HSR/rarity_5.png"):(ze[e].value="4",Je.background=Re.background,Je.image.source="res/assets/HSR/rarity_4.png");else{const e={key:"rarity",value:"5"};ze.push(e),Je.background=Re.background}He=d(l,ze),He=_(He,ke,Ve),jt(He)}));const et=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_AgentRank_A.png");et.height="40px",et.width="40px",et.left=-188,et.thickness=0,et.cornerRadius=5,Ke.addControl(et),et.isVisible=!1,et.onPointerClickObservable.add((function(){const e=Ge.findIndex((e=>"rarity"===e.key));if(-1!==e)"4"==Ge[e].value?(Ge.splice(e,1),et.background="rgba(0,0,0,0)"):(Ge[e].value="4",Ze.background="rgba(0,0,0,0)",et.background=Re.background);else{const e={key:"rarity",value:"4"};Ge.push(e),et.background=Re.background}He=d(h,Ge),He=_(He,ke,Ve),jt(He)}));const tt=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_AgentRank_S.png");function it(e,t,i){const s=Ue.findIndex((e=>e.key===i));if(-1!==s)Ue[s].value==t?(Ue.splice(s,1),e.background="rgba(0,0,0,0)"):(Ue[s].value=t,"element"==i.toString()?(St.background="rgba(0,0,0,0)",Tt.background="rgba(0,0,0,0)",yt.background="rgba(0,0,0,0)",Ct.background="rgba(0,0,0,0)",Pt.background="rgba(0,0,0,0)",Et.background="rgba(0,0,0,0)",At.background="rgba(0,0,0,0)"):(Rt.background="rgba(0,0,0,0)",It.background="rgba(0,0,0,0)",Mt.background="rgba(0,0,0,0)",Ot.background="rgba(0,0,0,0)",wt.background="rgba(0,0,0,0)"),e.background=Re.background);else{const s={key:i,value:t};Ue.push(s),e.background=Re.background}He=d(n,Ue),He=_(He,ke,Ve),jt(He)}function st(e,t,i){const s=ze.findIndex((e=>e.key===i));if(-1!==s)ze[s].value==t?(ze.splice(s,1),e.background="rgba(0,0,0,0)"):(ze[s].value=t,"element"==i.toString()?(nt.background="rgba(0,0,0,0)",at.background="rgba(0,0,0,0)",ot.background="rgba(0,0,0,0)",lt.background="rgba(0,0,0,0)",ht.background="rgba(0,0,0,0)",ct.background="rgba(0,0,0,0)",ut.background="rgba(0,0,0,0)"):(_t.background="rgba(0,0,0,0)",pt.background="rgba(0,0,0,0)",ft.background="rgba(0,0,0,0)",mt.background="rgba(0,0,0,0)",gt.background="rgba(0,0,0,0)",vt.background="rgba(0,0,0,0)",bt.background="rgba(0,0,0,0)"),e.background=Re.background);else{const s={key:i,value:t};ze.push(s),e.background=Re.background}He=d(l,ze),He=_(He,ke,Ve),jt(He)}function rt(e,t,i){const s=Ge.findIndex((e=>e.key===i));if(-1!==s)Ge[s].value==t?(Ge.splice(s,1),e.background="rgba(0,0,0,0)"):(Ge[s].value=t,"element"==i.toString()?(Ft.background="rgba(0,0,0,0)",Nt.background="rgba(0,0,0,0)",Lt.background="rgba(0,0,0,0)",Bt.background="rgba(0,0,0,0)",kt.background="rgba(0,0,0,0)"):(Vt.background="rgba(0,0,0,0)",Ut.background="rgba(0,0,0,0)",zt.background="rgba(0,0,0,0)",Gt.background="rgba(0,0,0,0)",Ht.background="rgba(0,0,0,0)"),e.background=Re.background);else{const s={key:i,value:t};Ge.push(s),e.background=Re.background}He=d(h,Ge),He=_(He,ke,Ve),jt(He)}tt.height="40px",tt.width="40px",tt.left=-148,tt.thickness=0,tt.cornerRadius=5,Ke.addControl(tt),tt.isVisible=!1,tt.onPointerClickObservable.add((function(){const e=Ge.findIndex((e=>"rarity"===e.key));if(-1!==e)"5"==Ge[e].value?(Ge.splice(e,1),tt.background="rgba(0,0,0,0)"):(Ge[e].value="5",et.background="rgba(0,0,0,0)",tt.background=Re.background);else{const e={key:"rarity",value:"5"};Ge.push(e),tt.background=Re.background}He=d(h,Ge),He=_(He,ke,Ve),jt(He)}));const nt=jl.CreateImageOnlyButton("but","res/assets/HSR/element_fire.png");nt.height="40px",nt.width="40px",nt.left=-188,nt.thickness=0,nt.cornerRadius=5,nt.isVisible=!1,Ke.addControl(nt),nt.onPointerClickObservable.add((function(){st(nt,"Fire","element")}));const at=jl.CreateImageOnlyButton("but","res/assets/HSR/element_ice.png");at.height="40px",at.width="40px",at.left=-148,at.thickness=0,at.cornerRadius=5,at.isVisible=!1,Ke.addControl(at),at.onPointerClickObservable.add((function(){st(at,"Ice","element")}));const ot=jl.CreateImageOnlyButton("but","res/assets/HSR/element_imaginary.png");ot.height="40px",ot.width="40px",ot.left=-108,ot.thickness=0,ot.cornerRadius=5,ot.isVisible=!1,Ke.addControl(ot),ot.onPointerClickObservable.add((function(){st(ot,"Imaginary","element")}));const lt=jl.CreateImageOnlyButton("but","res/assets/HSR/element_lightning.png");lt.height="40px",lt.width="40px",lt.left=-68,lt.thickness=0,lt.cornerRadius=5,lt.isVisible=!1,Ke.addControl(lt),lt.onPointerClickObservable.add((function(){st(lt,"Lightning","element")}));const ht=jl.CreateImageOnlyButton("but","res/assets/HSR/element_physical.png");ht.height="40px",ht.width="40px",ht.left=-28,ht.thickness=0,ht.cornerRadius=5,ht.isVisible=!1,Ke.addControl(ht),ht.onPointerClickObservable.add((function(){st(ht,"Physical","element")}));const ct=jl.CreateImageOnlyButton("but","res/assets/HSR/element_quantum.png");ct.height="40px",ct.width="40px",ct.left=12,ct.thickness=0,ct.cornerRadius=5,ct.isVisible=!1,Ke.addControl(ct),ct.onPointerClickObservable.add((function(){st(ct,"Quantum","element")}));const ut=jl.CreateImageOnlyButton("but","res/assets/HSR/element_wind.png");ut.height="40px",ut.width="40px",ut.left=52,ut.thickness=0,ut.cornerRadius=5,ut.isVisible=!1,Ke.addControl(ut),ut.onPointerClickObservable.add((function(){st(ut,"Wind","element")}));const _t=jl.CreateImageOnlyButton("but","res/assets/HSR/path_the_abundance.png");_t.height="40px",_t.width="40px",_t.left=92,_t.thickness=0,_t.cornerRadius=5,_t.isVisible=!1,Ke.addControl(_t),_t.onPointerClickObservable.add((function(){st(_t,"Abundance","weaponType")}));const pt=jl.CreateImageOnlyButton("but","res/assets/HSR/path_the_destruction.png");pt.height="40px",pt.width="40px",pt.left=132,pt.thickness=0,pt.cornerRadius=5,pt.isVisible=!1,Ke.addControl(pt),pt.onPointerClickObservable.add((function(){st(pt,"Destruction","weaponType")}));const ft=jl.CreateImageOnlyButton("but","res/assets/HSR/path_the_erudition.png");ft.height="40px",ft.width="40px",ft.left=172,ft.thickness=0,ft.cornerRadius=5,ft.isVisible=!1,Ke.addControl(ft),ft.onPointerClickObservable.add((function(){st(ft,"Erudition","weaponType")}));const mt=jl.CreateImageOnlyButton("but","res/assets/HSR/path_the_harmony.png");mt.height="40px",mt.width="40px",mt.left=212,mt.thickness=0,mt.cornerRadius=5,mt.isVisible=!1,Ke.addControl(mt),mt.onPointerClickObservable.add((function(){st(mt,"Harmony","weaponType")}));const gt=jl.CreateImageOnlyButton("but","res/assets/HSR/path_the_hunt.png");gt.height="40px",gt.width="40px",gt.left=252,gt.thickness=0,gt.cornerRadius=5,gt.isVisible=!1,Ke.addControl(gt),gt.onPointerClickObservable.add((function(){st(gt,"Hunt","weaponType")}));const vt=jl.CreateImageOnlyButton("but","res/assets/HSR/path_the_nihility.png");vt.height="40px",vt.width="40px",vt.left=292,vt.thickness=0,vt.cornerRadius=5,vt.isVisible=!1,Ke.addControl(vt),vt.onPointerClickObservable.add((function(){st(vt,"Nihility","weaponType")}));const bt=jl.CreateImageOnlyButton("but","res/assets/HSR/path_the_preservation.png");function xt(){nt.isVisible=!nt.isVisible,at.isVisible=!at.isVisible,ot.isVisible=!ot.isVisible,lt.isVisible=!lt.isVisible,ht.isVisible=!ht.isVisible,ct.isVisible=!ct.isVisible,ut.isVisible=!ut.isVisible,_t.isVisible=!_t.isVisible,pt.isVisible=!pt.isVisible,ft.isVisible=!ft.isVisible,mt.isVisible=!mt.isVisible,gt.isVisible=!gt.isVisible,vt.isVisible=!vt.isVisible,bt.isVisible=!bt.isVisible,qe.isVisible=!qe.isVisible,Je.isVisible=!Je.isVisible}bt.height="40px",bt.width="40px",bt.left=332,bt.thickness=0,bt.cornerRadius=5,bt.isVisible=!1,Ke.addControl(bt),bt.onPointerClickObservable.add((function(){st(bt,"Preservation","weaponType")}));const St=jl.CreateImageOnlyButton("but","res/assets/Genshin/element_anemo.png");St.height="40px",St.width="40px",St.left=-108,St.thickness=0,St.cornerRadius=5,Ke.addControl(St),St.onPointerClickObservable.add((function(){it(St,"Anemo","element")}));const Tt=jl.CreateImageOnlyButton("but","res/assets/Genshin/element_geo.png");Tt.height="40px",Tt.width="40px",Tt.left=-68,Tt.thickness=0,Tt.cornerRadius=5,Ke.addControl(Tt),Tt.onPointerClickObservable.add((function(){it(Tt,"Geo","element")}));const yt=jl.CreateImageOnlyButton("but","res/assets/Genshin/element_electro.png");yt.height="40px",yt.width="40px",yt.left=-28,yt.thickness=0,yt.cornerRadius=5,Ke.addControl(yt),yt.onPointerClickObservable.add((function(){it(yt,"Electro","element")}));const Ct=jl.CreateImageOnlyButton("but","res/assets/Genshin/element_dendro.png");Ct.height="40px",Ct.width="40px",Ct.left=12,Ct.thickness=0,Ct.cornerRadius=5,Ke.addControl(Ct),Ct.onPointerClickObservable.add((function(){it(Ct,"Dendro","element")}));const Pt=jl.CreateImageOnlyButton("but","res/assets/Genshin/element_hydro.png");Pt.height="40px",Pt.width="40px",Pt.left=52,Pt.thickness=0,Pt.cornerRadius=5,Ke.addControl(Pt),Pt.onPointerClickObservable.add((function(){it(Pt,"Hydro","element")}));const Et=jl.CreateImageOnlyButton("but","res/assets/Genshin/element_pyro.png");Et.height="40px",Et.width="40px",Et.left=92,Et.thickness=0,Et.cornerRadius=5,Ke.addControl(Et),Et.onPointerClickObservable.add((function(){it(Et,"Pyro","element")}));const At=jl.CreateImageOnlyButton("but","res/assets/Genshin/element_cryo.png");At.height="40px",At.width="40px",At.left=132,At.thickness=0,At.cornerRadius=5,Ke.addControl(At),At.onPointerClickObservable.add((function(){it(At,"Cryo","element")}));const Rt=jl.CreateImageOnlyButton("but","res/assets/Genshin/Sword.png");Rt.height="40px",Rt.width="40px",Rt.left=172,Rt.thickness=0,Rt.cornerRadius=5,Ke.addControl(Rt),Rt.onPointerClickObservable.add((function(){it(Rt,"Sword","weaponType")}));const It=jl.CreateImageOnlyButton("but","res/assets/Genshin/Catalyst.png");It.height="40px",It.width="40px",It.left=212,It.thickness=0,It.cornerRadius=5,Ke.addControl(It),It.onPointerClickObservable.add((function(){it(It,"Catalyst","weaponType")}));const Mt=jl.CreateImageOnlyButton("but","res/assets/Genshin/Bow.png");Mt.height="40px",Mt.width="40px",Mt.left=252,Mt.thickness=0,Mt.cornerRadius=5,Ke.addControl(Mt),Mt.onPointerClickObservable.add((function(){it(Mt,"Bow","weaponType")}));const Ot=jl.CreateImageOnlyButton("but","res/assets/Genshin/Claymore.png");Ot.height="40px",Ot.width="40px",Ot.left=292,Ot.thickness=0,Ot.cornerRadius=5,Ke.addControl(Ot),Ot.onPointerClickObservable.add((function(){it(Ot,"Claymore","weaponType")}));const wt=jl.CreateImageOnlyButton("but","res/assets/Genshin/Pole.png");function Dt(){$e.isVisible=!$e.isVisible,Ze.isVisible=!Ze.isVisible,St.isVisible=!St.isVisible,Tt.isVisible=!Tt.isVisible,yt.isVisible=!yt.isVisible,Ct.isVisible=!Ct.isVisible,Pt.isVisible=!Pt.isVisible,Et.isVisible=!Et.isVisible,At.isVisible=!At.isVisible,Rt.isVisible=!Rt.isVisible,It.isVisible=!It.isVisible,Mt.isVisible=!Mt.isVisible,Ot.isVisible=!Ot.isVisible,wt.isVisible=!wt.isVisible,Ye.isVisible=!Ye.isVisible}wt.height="40px",wt.width="40px",wt.left=332,wt.thickness=0,wt.cornerRadius=5,Ke.addControl(wt),wt.onPointerClickObservable.add((function(){it(wt,"Polearm","weaponType")}));const Ft=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_Electric.png");Ft.height="40px",Ft.width="40px",Ft.left=-68,Ft.thickness=0,Ft.cornerRadius=5,Ft.isVisible=!1,Ke.addControl(Ft),Ft.onPointerClickObservable.add((function(){rt(Ft,"Electric","element")}));const Nt=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_Ether.png");Nt.height="40px",Nt.width="40px",Nt.left=-28,Nt.thickness=0,Nt.cornerRadius=5,Nt.isVisible=!1,Ke.addControl(Nt),Nt.onPointerClickObservable.add((function(){rt(Nt,"Ether","element")}));const Lt=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_Fire.png");Lt.height="40px",Lt.width="40px",Lt.left=12,Lt.thickness=0,Lt.cornerRadius=5,Lt.isVisible=!1,Ke.addControl(Lt),Lt.onPointerClickObservable.add((function(){rt(Lt,"Fire","element")}));const Bt=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_Ice.png");Bt.height="40px",Bt.width="40px",Bt.left=52,Bt.thickness=0,Bt.cornerRadius=5,Bt.isVisible=!1,Ke.addControl(Bt),Bt.onPointerClickObservable.add((function(){rt(Bt,"Ice","element")}));const kt=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_Physical.png");kt.height="40px",kt.width="40px",kt.left=92,kt.thickness=0,kt.cornerRadius=5,kt.isVisible=!1,Ke.addControl(kt),kt.onPointerClickObservable.add((function(){rt(kt,"Physical","element")}));const Vt=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_Anomaly.png");Vt.height="40px",Vt.width="40px",Vt.left=132,Vt.thickness=0,Vt.cornerRadius=5,Vt.isVisible=!1,Ke.addControl(Vt),Vt.onPointerClickObservable.add((function(){rt(Vt,"Anomaly","weaponType")}));const Ut=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_Attack.png");Ut.height="40px",Ut.width="40px",Ut.left=172,Ut.thickness=0,Ut.cornerRadius=5,Ut.isVisible=!1,Ke.addControl(Ut),Ut.onPointerClickObservable.add((function(){rt(Ut,"Attack","weaponType")}));const zt=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_Defense.png");zt.height="40px",zt.width="40px",zt.left=212,zt.thickness=0,zt.cornerRadius=5,zt.isVisible=!1,Ke.addControl(zt),zt.onPointerClickObservable.add((function(){rt(zt,"Defense","weaponType")}));const Gt=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_Stun.png");Gt.height="40px",Gt.width="40px",Gt.left=252,Gt.thickness=0,Gt.cornerRadius=5,Gt.isVisible=!1,Ke.addControl(Gt),Gt.onPointerClickObservable.add((function(){rt(Gt,"Stun","weaponType")}));const Ht=jl.CreateImageOnlyButton("but","res/assets/ZZZ/Icon_Support.png");function Wt(){et.isVisible=!et.isVisible,tt.isVisible=!tt.isVisible,Ft.isVisible=!Ft.isVisible,Nt.isVisible=!Nt.isVisible,Lt.isVisible=!Lt.isVisible,Bt.isVisible=!Bt.isVisible,kt.isVisible=!kt.isVisible,Vt.isVisible=!Vt.isVisible,Ut.isVisible=!Ut.isVisible,zt.isVisible=!zt.isVisible,Gt.isVisible=!Gt.isVisible,Ht.isVisible=!Ht.isVisible,Ye.isVisible=!Ye.isVisible}Ht.height="40px",Ht.width="40px",Ht.left=292,Ht.thickness=0,Ht.cornerRadius=5,Ht.isVisible=!1,Ke.addControl(Ht),Ht.onPointerClickObservable.add((function(){rt(Ht,"Support","weaponType")}));const Xt=new gh("scrollName");Xt.thickness=0,De.addControl(Xt);let Kt,Qt,Yt=!1;Xt.onPointerDownObservable.add((()=>{Yt=!0})),Xt.onPointerUpObservable.add((()=>{Yt=!1}));let qt=new rh,$t=10;function jt(e){qt.dispose(),qt=new rh,$t=Math.ceil(e.length/5)+1,qt.removeRowDefinition,qt.color="black",qt.width="680px",qt.heightInPixels=$t*qt.widthInPixels/5,qt.addColumnDefinition(.2),qt.addColumnDefinition(.2),qt.addColumnDefinition(.2),qt.addColumnDefinition(.2),qt.addColumnDefinition(.2);for(let e=0;e<$t;e++)qt.addRowDefinition(1/$t);Xt.addControl(qt);let t=0;for(let i=0;i<$t;i++)for(let s=0;s<5;s++)if(t>e.length-1){let e;"Genshin"==K?(e=jl.CreateImageOnlyButton("but","res/charsPNG/Genshin/Paimon.png"),e.onPointerClickObservable.add((async function(){Re.isVisible=!Re.isVisible,"Paimon"!=X&&await Jt("Paimon")}))):"HSR"==K?(e=jl.CreateImageOnlyButton("but","res/charsPNG/HSR/Pom-Pom.png"),e.onPointerClickObservable.add((async function(){Re.isVisible=!Re.isVisible,"Pom-Pom"!=X&&await Jt("Pom-Pom")}))):(e=jl.CreateImageOnlyButton("but","res/charsPNG/ZZZ/Bangboo.png"),e.onPointerClickObservable.add((async function(){Re.isVisible=!Re.isVisible,"Bangboo"!=X&&await Jt("Bangboo")}))),e.thickness=0,e.paddingBottom=e.paddingLeft=e.paddingRight=e.paddingTop=5,e.cornerRadius=10,qt.addControl(e,i,s)}else{const r=e[t],n=new Ql;n.cornerRadius=10,n.thickness=0,n.paddingBottom=n.paddingTop=n.paddingRight=n.paddingLeft=5,n.background="rgb(123,92,144)",5==r.rarity?n.background="rgb(146,109,69)":6==r.rarity&&(n.background="rgb(192,79,85)"),qt.addControl(n,i,s);const a=jl.CreateImageOnlyButton("but",`res/charsPNG/${r.image}`);a.thickness=0,a.cornerRadius=10,a.paddingBottom=a.paddingTop=a.paddingRight=a.paddingLeft=4,qt.addControl(a,i,s),a.onPointerClickObservable.add((async function(){Re.isVisible=!Re.isVisible,(X!=r.name||H!=r._id&&1!=Pe)&&await Jt(r.name,r._id)})),t+=1}}jt(He);const Zt={wasAnimationPlaying:!1,previousSeekTimeFrame:0,wasMuted:!1};async function Jt(e,t){if(e){if(D.isAnimationPlaying&&(Zt.wasAnimationPlaying=!0),D.pauseAnimation(),Zt.previousSeekTimeFrame=D.currentFrameTime,z=X,X=e,Ae.text=X,null!=ye&&(ye.isVisible=!1),ie.dispose(!1,!0),N.dispose(),y.restoreState(),D.unregister(g),D=new iu(g),D.loggingEnabled=!0,D.register(g),D.setAudioPlayer(F),N=new bu(g,D,F,p),N.showPlayerControl(),"Paimon"==X||"Pom-Pom"==X||"Bangboo"==X)Pe=!1,W=c(r,X),await ei(W);else if("Genshin"==K){const e=u(a,X);if(z==X)if(e.length>0&&!Pe){W=e[0],Pe=!0,await ei(W);let t=!1;e.length>1&&(t=!0),Ce(!0,t,W.name)}else if(e.length>0&&Pe&&e.length>1){let t=!0,i=0;for(let t=0;t<e.length;t++)W._id===e[t]._id&&(i=t);const s=(i+1)%e.length;s==e.length-1&&(t=!1),i==e.length-1?(W=c(n,X),Pe=!1):(W=e[s],Pe=!0),await ei(W),Ce(!0,t,W.name)}else e.length>0&&Pe&&(Pe=!1,W=c(n,X),await ei(W),Ce(!0,!0,W.name));else Pe=!1,W=c(n,X),await ei(W),e.length>0&&Ce(!0,!0,W.name)}else if("HSR"==K){const e=u(o,X);if(z==X&&H==W?._id)if(e.length>0&&!Pe){W=e[0],Pe=!0,await ei(W);let t=!1;e.length>1&&(t=!0),Ce(!0,t,W.name)}else if(e.length>0&&Pe&&e.length>1){let t=!0,i=0;for(let t=0;t<e.length;t++)W._id===e[t]._id&&(i=t);const s=(i+1)%e.length;s==e.length-1&&(t=!1),i==e.length-1?(W=c(l,X),Pe=!1):(W=e[s],Pe=!0),await ei(W),Ce(!0,t,W.name)}else e.length>0&&Pe&&(Pe=!1,W=c(l,X),await ei(W),Ce(!0,!0,W.name));else Pe=!1,i=t,W=l.find((e=>e._id===i)),await ei(W),e.length>0&&Ce(!0,!0,W.name)}else Pe=!1,W=c("Genshin"===K?n:"HSR"===K?l:"ZZZ"===K?h:[],X),await ei(W);var i;Zt.wasAnimationPlaying?(D.seekAnimation(Zt.previousSeekTimeFrame,!0),Zt.wasAnimationPlaying=!1,D.isAnimationPlaying||D.playAnimation()):(E.target=new I.Pq(0,10*x,1),E.setPosition(C),g.activeCameras[0]=E)}}async function ei(e){if(t.displayLoadingUI(),null!=ye&&(ye.isEnabled=!1),xe.isEnabled=!1,V=[],B=[],H=e._id,q=e.pmx.substring(e.pmx.lastIndexOf(".")),$=m.find((e=>e&&Object.keys(e.extensions).includes(q))),!(e&&e.directory&&e.pmx))throw new Error("Chosen character or its properties are undefined");V.push(er.ImportMeshAsync(void 0,e.directory+"/",e.pmx,g,(e=>k(0,`Loading model... ${e.loaded}/${e.total} (${Math.floor(100*e.loaded/e.total)}%)`)))),Z=await Promise.all(V),g.onAfterRenderObservable.addOnce((()=>{t.hideLoadingUI(),setTimeout((()=>{null!=ye&&(ye.isEnabled=!0),xe.isEnabled=!0}),1500)})),J=1.66,ee=69,te=new I.uq,ie=Z[0].meshes[0],ie.parent=S,w.addShadowCaster(ie);for(const e of ie.metadata.meshes)e.receiveShadows=!0;ne=D.createMmdModel(ie),oe=ne.runtimeBones.find((e=>"頭"===e.name)),le=ne.runtimeBones.find((e=>"センター"===e.name)),he=new I.uq,null!=oe&&null!=le&&(ne.addAnimation(ae),ne.setAnimation("motion"),g.onBeforeDrawPhaseObservable.addOnce((()=>{oe.getWorldMatrixToRef(te).multiplyToRef(ie.getWorldMatrix(),te),te.getTranslationToRef(T.position),T.position.z=1,T.position.x=0,J-=T.position.y,ee=T.position.y})),g.onBeforeRenderObservable.add((()=>{le.getWorldMatrixToRef(he).multiplyToRef(ie.getWorldMatrix(),he),he.getTranslationToRef(O.position),O.position.y-=10*x}))),D.setCamera(y),y.setAnimation("motion"),g.onAfterRenderObservable.addOnce((()=>{g.freezeMaterials();const e=g.meshes;for(let t=0,i=e.length;t<i;++t){const i=e[t];i.freezeWorldMatrix(),i.doNotSyncBoundingInfo=!0,i.isPickable=!1,i.doNotSyncBoundingInfo=!0,i.alwaysSelectAsActiveMesh=!0}g.skipPointerMovePicking=!0,g.skipPointerDownPicking=!0,g.skipPointerUpPicking=!0,g.skipFrustumClipping=!0,g.blockMaterialDirtyMechanism=!0}))}T.position.x=S.position.x,T.position.y=S.position.y,T.position.z=S.position.z,g.onBeforeAnimationsObservable.add((()=>{ue=y.position.y/10,me.text=`${g.activeCameras[0].name}`,T.position.y=ue<ee&&0<ue?0-J*(ue/ee):ue<=0?0:0-J,y.parent=T}));const ti=new I.uq,ii=new I.Pq,si=new I.Pq,ri=new I.Pq;g.onBeforeRenderObservable.add((()=>{const e=y.rotation;I.uq.RotationYawPitchRollToRef(-e.y,-e.x,-e.z,ti),I.Pq.TransformNormalFromFloatsToRef(0,0,1,ti,ii),y.position.addToRef(I.Pq.TransformCoordinatesFromFloatsToRef(0,0,y.distance,ti,si),si),null!=oe&&null!=le&&oe.getWorldMatrixToRef(te).getTranslationToRef(ri).subtractToRef(si,ri),ce.depthOfField.focusDistance=I.Pq.Dot(ri,ii)/I.Pq.Dot(ii,ii)*1e3}));let ni=-1/0;if(e.onclick=()=>{const e=performance.now();300<e-ni?ni=e:(ni=-1/0,g.activeCameras[0]===y?(ce.depthOfFieldEnabled=!1,P.setTarget(new I.Pq(0,10*x,1)),P.setPosition(C),g.activeCameras[0]=P):(ce.depthOfFieldEnabled=!1,g.activeCameras[0]=y),me.text=`${g.activeCameras[0].name}`)},document.body.addEventListener("keydown",(function(e){"Space"===e.code&&(e.preventDefault(),g.activeCameras[0]===E&&(ce.depthOfFieldEnabled=!1,D.isAnimationPlaying||(g.activeCameras[0]=y),me.text=`${g.activeCameras[0].name}`),D.isAnimationPlaying?D.pauseAnimation():D.playAnimation())})),g.onPointerDown=function(e){Me||(Ie=window.setTimeout((()=>{Oe=!1}),100)),function(e){Yt&&(Kt=e.offsetY,Qt=Xt.verticalBar.value)}(e)},g.onPointerUp=function(e){Me||(window.clearTimeout(Ie),Oe&&(Re.isVisible=!1),Oe=!0),Yt&&(Kt=void 0)},g.onPointerMove=function(e){!function(e){if(!Yt)return;if(void 0===Kt)return;if(void 0===Qt)return;let t=e.offsetY-Kt;p&&(t*=3);const i=t/(qt.heightInPixels-Xt.heightInPixels);Xt.verticalBar.value=Qt-i}(e)},"Genshin"==Q){const e=u(a,X);e.length>0&&(W=e[0],Pe=!1,Ce(!0,!0,W.name))}else if("HSR"==Q){We();const e=u(o,X);e.length>0&&(W=e[0],Pe=!1,Ce(!0,!0,W.name))}else"ZZZ"==Q&&Xe();return g}}window.onload=()=>{const e=document.createElement("canvas");e.style.width="100%",e.style.height="100%",e.style.display="block",e.style.border="none",e.style.outline="none",document.body.appendChild(e);const t=new E(e,!1,{preserveDrawingBuffer:!1,stencil:!1,antialias:!0,alpha:!1,premultipliedAlpha:!1,powerPreference:"high-performance",doNotHandleTouchAction:!1,doNotHandleContextLost:!0,audioEngine:!1},!0);let i=window.location.pathname;console.log(i),i.endsWith("/")&&(i=i.slice(0,-1));const s=window.location.hostname.includes("localhost");console.log(s);const r=window.location.hostname.includes("github.io"),n=["model-viewer","docs"];let a="",o="";if(s)a="/",console.log(a),o=i.slice(1).replace(/\/$/,"")||"",console.log(o);else if(r)for(const e of n)if(i.includes(e)){const t=i.indexOf(e)+e.length;a=i.substring(0,i.lastIndexOf("/")),console.log(a),o=i.slice(t+1).replace(/\/$/,"")||"",console.log(o);break}o&&window.history.replaceState(null,"",a),A.Create({canvas:e,engine:t,sceneBuilder:new xu},o).then((e=>e.run()))}})()})();