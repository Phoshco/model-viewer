(()=>{"use strict";var e={641:(e,t,i)=>{e.exports=i.p+"5e7e7553d018c4a35bd3.wasm"}},t={};function i(s){var n=t[s];if(void 0!==n)return n.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,i),r.exports}i.m=e,i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e;i.g.importScripts&&(e=i.g.location+"");var t=i.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var s=t.getElementsByTagName("script");if(s.length)for(var n=s.length-1;n>-1&&!e;)e=s[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=e})(),i.b=document.baseURI||self.location.href,(()=>{class e{constructor(e,t=!1,i,s){this.initialize(e,t,i,s)}initialize(e,t=!1,i,s){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=s,this}}class t{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(){this._remove&&this._remove()}}class s{static FromPromise(e,t){const i=new s;return e.then((e=>{i.notifyObservers(e)})).catch((e=>{if(!t)throw e;t.notifyObservers(e)})),i}get observers(){return this._observers}constructor(t,i=!1){this.notifyIfTriggered=i,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new e(0),t&&(this._onObserverAdded=t)}add(e,i=-1,s=!1,n=null,r=!1){if(!e)return null;const o=new t(e,i,n);return o.unregisterOnNextCall=r,s?this._observers.unshift(o):this._observers.push(o),this._onObserverAdded&&this._onObserverAdded(o),this._hasNotified&&this.notifyIfTriggered&&void 0!==this._lastNotifiedValue&&this.notifyObserver(o,this._lastNotifiedValue),o._remove=()=>{this.remove(o)},o}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return!!e&&(e._remove=null,-1!==this._observers.indexOf(e)&&(this._deferUnregister(e),!0))}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const s=this._observers[i];if(!(s._willBeUnregistered||s.callback!==e||t&&t!==s.scope))return this._deferUnregister(s),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout((()=>{this._remove(e)}),0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return-1!==i&&(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0)}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,s,n){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const r=this._eventState;r.mask=t,r.target=i,r.currentTarget=s,r.skipNextObservers=!1,r.lastReturnValue=e,r.userInfo=n;for(const i of this._observers)if(!i._willBeUnregistered&&(i.mask&t&&(i.unregisterOnNextCall&&this._deferUnregister(i),i.scope?r.lastReturnValue=i.callback.apply(i.scope,[e,r]):r.lastReturnValue=i.callback(e,r)),r.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const s=this._eventState;s.mask=i,s.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,s)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new s;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class n{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,s=1,n=2,r=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=s,this.samplingMode=n,this._comparisonFunction=r,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var r,o;(o=r||(r={}))[o.Unknown=0]="Unknown",o[o.Url=1]="Url",o[o.Temp=2]="Temp",o[o.Raw=3]="Raw",o[o.Dynamic=4]="Dynamic",o[o.RenderTarget=5]="RenderTarget",o[o.MultiRenderTarget=6]="MultiRenderTarget",o[o.Cube=7]="Cube",o[o.CubeRaw=8]="CubeRaw",o[o.CubePrefiltered=9]="CubePrefiltered",o[o.Raw3D=10]="Raw3D",o[o.Raw2DArray=11]="Raw2DArray",o[o.DepthStencil=12]="DepthStencil",o[o.CubeRawRGBD=13]="CubeRawRGBD",o[o.Depth=14]="Depth";class a extends n{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new s,this.onErrorObservable=new s,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=r.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._engine=e,this._source=t,this._uniqueId=a._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){var e;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const e=this.onRebuildCallback(this),t=t=>{t._swapAndDie(this,!1),this.isReady=e.isReady};return void(e.isAsync?e.proxy.then(t):t(e.proxy))}let t;switch(this.source){case r.Temp:break;case r.Url:return void(t=this._engine.createTexture(null!==(e=this._originalUrl)&&void 0!==e?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(e=>{e._swapAndDie(this,!1),this.isReady=!0}),null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer));case r.Raw:t=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),t._swapAndDie(this,!1),this.isReady=!0;break;case r.Raw3D:t=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case r.Raw2DArray:t=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case r.Dynamic:t=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),t._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case r.Cube:return void(t=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,(()=>{t._swapAndDie(this,!1),this.isReady=!0}),null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer));case r.CubeRaw:t=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),t._swapAndDie(this,!1),this.isReady=!0;break;case r.CubeRawRGBD:return;case r.CubePrefiltered:return t=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,(e=>{e&&e._swapAndDie(this,!1),this.isReady=!0}),null,this.format,this._extension),void(t._sphericalPolynomial=this._sphericalPolynomial)}}_swapAndDie(e,t=!0){var i;null===(i=this._hardwareTexture)||void 0===i||i.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const s=this._engine.getLoadedTexturesCache();let n=s.indexOf(this);-1!==n&&s.splice(n,1),n=s.indexOf(e),-1===n&&s.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),0===this._references&&(this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}function l(){return"undefined"!=typeof window}function h(){return"undefined"!=typeof navigator}function c(){return"undefined"!=typeof document}function d(e){let t="",i=e.firstChild;for(;i;)3===i.nodeType&&(t+=i.textContent),i=i.nextSibling;return t}a._Counter=0;class u{static get LastCreatedEngine(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}u.Instances=[],u.OnEnginesDisposedObservable=new s,u._LastCreatedScene=null,u.UseFallbackTexture=!0,u.FallbackTexture="";const _={};function f(e,t=!1){if(!t||!_[e])return _[e]=!0,`${e} needs to be imported before as it contains a side-effect required by your code.`}class p{static _CheckLimit(e,t){let i=p._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},p._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){var i;const s=p._LogLimitOutputs[e];if(!s||!p.MessageLimitReached)return;const n=this._Levels[t];s.current===s.limit&&p[n.name](p.MessageLimitReached.replace(/%LIMIT%/g,""+s.limit).replace(/%TYPE%/g,null!==(i=n.name)&&void 0!==i?i:""))}static _AddLogEntry(e){p._LogCache=e+p._LogCache,p.OnNewCacheEntry&&p.OnNewCacheEntry(e)}static _FormatMessage(e){const t=e=>e<10?"0"+e:""+e,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){const s=Array.isArray(t)?t[0]:t;if(void 0!==i&&!p._CheckLimit(s,i))return;const n=p._FormatMessage(s),r=this._Levels[e],o=Array.isArray(t)?t.slice(1):[];r.logFunc&&r.logFunc("BJS - "+n,...o);const a=`<div style='color:${r.color}'>${n}</div><br>`;p._AddLogEntry(a),p._GenerateLimitMessage(s,e)}static get LogCache(){return p._LogCache}static ClearLogCache(){p._LogCache="",p._LogLimitOutputs={},p.errorsCount=0}static set LogLevels(e){p.Log=p._LogDisabled,p.Warn=p._LogDisabled,p.Error=p._LogDisabled,[p.MessageLogLevel,p.WarningLogLevel,p.ErrorLogLevel].forEach((t=>{if((e&t)===t){const e=this._Levels[t];p[e.name]=p._LogEnabled.bind(p,t)}}))}}p.NoneLogLevel=0,p.MessageLogLevel=1,p.WarningLogLevel=2,p.ErrorLogLevel=4,p.AllLogLevel=7,p.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",p._LogCache="",p._LogLimitOutputs={},p._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],p.errorsCount=0,p.Log=p._LogEnabled.bind(p,p.MessageLogLevel),p.Warn=p._LogEnabled.bind(p,p.WarningLogLevel),p.Error=p._LogEnabled.bind(p,p.ErrorLogLevel);class m{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var i,s,n,r,o,a,l;let h="";if(this.line){let c=this.line;const d=t.processor;if(d){d.lineProcessor&&(c=d.lineProcessor(c,t.isFragment,t.processingContext));const h=null!==(s=null===(i=t.processor)||void 0===i?void 0:i.attributeKeywordName)&&void 0!==s?s:"attribute",u=t.isFragment&&(null===(n=t.processor)||void 0===n?void 0:n.varyingFragmentKeywordName)?null===(r=t.processor)||void 0===r?void 0:r.varyingFragmentKeywordName:!t.isFragment&&(null===(o=t.processor)||void 0===o?void 0:o.varyingVertexKeywordName)?null===(a=t.processor)||void 0===a?void 0:a.varyingVertexKeywordName:"varying";!t.isFragment&&d.attributeProcessor&&this.line.startsWith(h)?c=d.attributeProcessor(this.line,e,t.processingContext):d.varyingProcessor&&((null===(l=d.varyingCheck)||void 0===l?void 0:l.call(d,this.line,t.isFragment))||!d.varyingCheck&&this.line.startsWith(u))?c=d.varyingProcessor(this.line,t.isFragment,e,t.processingContext):d.uniformProcessor&&d.uniformRegexp&&d.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(c=d.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):d.uniformBufferProcessor&&d.uniformBufferRegexp&&d.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(c=d.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):d.textureProcessor&&d.textureRegexp&&d.textureRegexp.test(this.line)?c=d.textureProcessor(this.line,t.isFragment,e,t.processingContext):(d.uniformProcessor||d.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?d.uniformProcessor&&(c=d.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):d.uniformBufferProcessor&&(c=d.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&-1!==this.line.indexOf("}")&&(t.lookForClosingBracketForUniformBuffer=!1,d.endOfUniformBufferProcessor&&(c=d.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}h+=c+"\n"}return this.children.forEach((i=>{h+=i.process(e,t)})),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),h}}class g{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||"\r"===t)continue;if("#"===t[0]){this._lines.push(t);continue}const e=t.trim();if(!e)continue;if(e.startsWith("//")){this._lines.push(t);continue}const i=e.indexOf(";");if(-1===i)this._lines.push(e);else if(i===e.length-1)e.length>1&&this._lines.push(e);else{const e=t.split(";");for(let t=0;t<e.length;t++){let i=e[t];i&&(i=i.trim(),i&&this._lines.push(i+(t!==e.length-1?";":"")))}}}}}class v extends m{process(e,t){for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s.isValid(e))return s.process(e,t)}return""}}class T extends m{isValid(e){return this.testExpression.isTrue(e)}}class b{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(void 0===b._OperatorPriority[i])t.push(i);else{const e=t[t.length-1],s=t[t.length-2];t.length-=2,t.push(`(${s}${i}${e})`)}return t[t.length-1]}static infixToPostfix(e){const t=b._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!(e.includes("&&")||e.includes("||")||e.includes(")")||e.includes("(")))return[e];const i=[];let s=-1;const n=()=>{h=h.trim(),""!==h&&(i.push(h),h="")},r=e=>{s<b._Stack.length-1&&(b._Stack[++s]=e)},o=()=>b._Stack[s],a=()=>-1===s?"!!INVALID EXPRESSION!!":b._Stack[s--];let l=0,h="";for(;l<e.length;){const t=e.charAt(l),c=l<e.length-1?e.substr(l,2):"";if("("===t)h="",r(t);else if(")"===t){for(n();-1!==s&&"("!==o();)i.push(a());a()}else if(b._OperatorPriority[c]>1){for(n();-1!==s&&b._OperatorPriority[o()]>=b._OperatorPriority[c];)i.push(a());r(c),l++}else h+=t;l++}for(n();-1!==s;)"("===o()?a():i.push(a());return b._InfixToPostfixCache.size>=b.InfixToPostfixCacheLimitSize&&b.ClearCache(),b._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(b._InfixToPostfixCache.entries()).sort(((e,t)=>e[1].accessTime-t[1].accessTime));for(let t=0;t<b.InfixToPostfixCacheCleanupSize;t++)b._InfixToPostfixCache.delete(e[t][0])}}b.InfixToPostfixCacheLimitSize=5e4,b.InfixToPostfixCacheCleanupSize=25e3,b._InfixToPostfixCache=new Map,b._OperatorPriority={")":0,"(":1,"||":2,"&&":3},b._Stack=["","","","","","","","","","","","","","","","","","","",""];class E extends b{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=void 0!==e[this.define];return this.not&&(t=!t),t}}class S extends b{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class x extends b{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class C extends b{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];void 0===t&&(t=this.define);let i=!1;const s=parseInt(t),n=parseInt(this.testValue);switch(this.operand){case">":i=s>n;break;case"<":i=s<n;break;case"<=":i=s<=n;break;case">=":i=s>=n;break;case"==":i=s===n;break;case"!=":i=s!==n}return i}}var y;!function(e){e[e.GLSL=0]="GLSL",e[e.WGSL=1]="WGSL"}(y||(y={}));const A=/defined\s*?\((.+?)\)/g,R=/defined\s*?\[(.+?)\]/g,I=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,P=/__decl__/,M=/light\{X\}.(\w*)/g,O=/\{X\}/g,D=[];class N{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,i,s){var n;(null===(n=t.processor)||void 0===n?void 0:n.preProcessShaderCode)&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,(e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e));const n=this._ProcessShaderConversion(e,t,s);i(n,e)}))}static PreProcess(e,t,i,s){var n;(null===(n=t.processor)||void 0===n?void 0:n.preProcessShaderCode)&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,(e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",e));const n=this._ApplyPreProcessing(e,t,s);i(n,e)}))}static Finalize(e,t,i){return i.processor&&i.processor.finalizeShaders?i.processor.finalizeShaders(e,t,i.processingContext):{vertexCode:e,fragmentCode:t}}static _ProcessPrecision(e,t){var i;if(null===(i=t.processor)||void 0===i?void 0:i.noPrecision)return e;const s=t.shouldUseHighPrecisionShader;return-1===e.indexOf("precision highp float")?e=s?"precision highp float;\n"+e:"precision mediump float;\n"+e:s||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const t=/defined\((.+)\)/.exec(e);if(t&&t.length)return new E(t[1].trim(),"!"===e[0]);const i=["==","!=",">=","<=","<",">"];let s="",n=0;for(s of i)if(n=e.indexOf(s),n>-1)break;if(-1===n)return new E(e);const r=e.substring(0,n).trim(),o=e.substring(n+s.length).trim();return new C(r,s,o)}static _BuildSubExpression(e){e=e.replace(A,"defined[$1]");const t=b.infixToPostfix(e),i=[];for(const e of t)if("||"!==e&&"&&"!==e)i.push(e);else if(i.length>=2){let t=i[i.length-1],s=i[i.length-2];i.length-=2;const n="&&"==e?new x:new S;"string"==typeof t&&(t=t.replace(R,"defined($1)")),"string"==typeof s&&(s=s.replace(R,"defined($1)")),n.leftOperand="string"==typeof s?this._ExtractOperation(s):s,n.rightOperand="string"==typeof t?this._ExtractOperation(t):t,i.push(n)}let s=i[i.length-1];return"string"==typeof s&&(s=s.replace(R,"defined($1)")),"string"==typeof s?this._ExtractOperation(s):s}static _BuildExpression(e,t){const i=new T,s=e.substring(0,t);let n=e.substring(t);return n=n.substring(0,(n.indexOf("//")+1||n.length+1)-1).trim(),i.testExpression="#ifdef"===s?new E(n):"#ifndef"===s?new E(n,!0):this._BuildSubExpression(n),i}static _MoveCursorWithinIf(e,t,i){let s=e.currentLine;for(;this._MoveCursor(e,i);){s=e.currentLine;const n=s.substring(0,5).toLowerCase();if("#else"===n){const i=new m;return t.children.push(i),void this._MoveCursor(e,i)}if("#elif"===n){const e=this._BuildExpression(s,5);t.children.push(e),i=e}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine;if(i.indexOf("#")>=0){const s=N._MoveCursorRegex.exec(i);if(s&&s.length){switch(s[0]){case"#ifdef":{const s=new v;t.children.push(s);const n=this._BuildExpression(i,6);s.children.push(n),this._MoveCursorWithinIf(e,s,n);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const s=new v;t.children.push(s);const n=this._BuildExpression(i,7);s.children.push(n),this._MoveCursorWithinIf(e,s,n);break}case"#if":{const s=new v,n=this._BuildExpression(i,3);t.children.push(s),s.children.push(n),this._MoveCursorWithinIf(e,s,n);break}}continue}}const s=new m;if(s.line=i,t.children.push(s),"#"===i[0]&&"d"===i[1]){const e=i.replace(";","").split(" ");s.additionalDefineKey=e[1],3===e.length&&(s.additionalDefineValue=e[2])}}return!1}static _EvaluatePreProcessors(e,t,i){const s=new m,n=new g;return n.lineIndex=-1,n.lines=e.split("\n"),this._MoveCursor(n,s),s.process(t,i)}static _PreparePreProcessors(e,t){var i;const s=e.defines,n={};for(const e of s){const t=e.replace("#define","").replace(";","").trim().split(" ");n[t[0]]=t.length>1?t[1]:""}return(null===(i=e.processor)||void 0===i?void 0:i.shaderLanguage)===y.GLSL&&(n.GL_ES="true"),n.__VERSION__=e.version,n[e.platformName]="true",t._getGlobalDefines(n),n}static _ProcessShaderConversion(e,t,i){let s=this._ProcessPrecision(e,t);if(!t.processor)return s;if(t.processor.shaderLanguage===y.GLSL&&-1!==s.indexOf("#version 3")&&(s=s.replace("#version 300 es",""),!t.processor.parseGLES3))return s;const n=t.defines,r=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(s=t.processor.preProcessor(s,n,t.isFragment,t.processingContext)),s=this._EvaluatePreProcessors(s,r,t),t.processor.postProcessor&&(s=t.processor.postProcessor(s,n,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(s=i.inlineShaderCode(s)),s}static _ApplyPreProcessing(e,t,i){var s,n;let r=e;const o=t.defines,a=this._PreparePreProcessors(t,i);return(null===(s=t.processor)||void 0===s?void 0:s.preProcessor)&&(r=t.processor.preProcessor(r,o,t.isFragment,t.processingContext)),r=this._EvaluatePreProcessors(r,a,t),(null===(n=t.processor)||void 0===n?void 0:n.postProcessor)&&(r=t.processor.postProcessor(r,o,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(r=i.inlineShaderCode(r)),r}static _ProcessIncludes(e,t,i){let s;for(D.length=0;null!==(s=I.exec(e));)D.push(s);let n=String(e),r=[e],o=!1;for(const e of D){let s=e[1];if(-1!==s.indexOf("__decl__")&&(s=s.replace(P,""),t.supportsUniformBuffers&&(s=s.replace("Vertex","Ubo").replace("Fragment","Ubo")),s+="Declaration"),!t.includesShadersStore[s]){const e=t.shadersRepository+"ShadersInclude/"+s+".fx";return void N._FileToolsLoadFile(e,(e=>{t.includesShadersStore[s]=e,this._ProcessIncludes(r.join(""),t,i)}))}{let i=t.includesShadersStore[s];if(e[2]){const t=e[3].split(",");for(let e=0;e<t.length;e+=2){const s=new RegExp(t[e],"g"),n=t[e+1];i=i.replace(s,n)}}if(e[4]){const s=e[5];if(-1!==s.indexOf("..")){const e=s.split(".."),n=parseInt(e[0]);let r=parseInt(e[1]),o=i.slice(0);i="",isNaN(r)&&(r=t.indexParameters[e[1]]);for(let e=n;e<r;e++)t.supportsUniformBuffers||(o=o.replace(M,((e,t)=>t+"{X}"))),i+=o.replace(O,e.toString())+"\n"}else t.supportsUniformBuffers||(i=i.replace(M,((e,t)=>t+"{X}"))),i=i.replace(O,s)}const n=[];for(const t of r){const s=t.split(e[0]);for(let e=0;e<s.length-1;e++)n.push(s[e]),n.push(i);n.push(s[s.length-1])}r=n,o=o||i.indexOf("#include<")>=0||i.indexOf("#include <")>=0}}D.length=0,n=r.join(""),o?this._ProcessIncludes(n.toString(),t,i):i(n)}static _FileToolsLoadFile(e,t,i,s,n,r){throw f("FileTools")}}N._MoveCursorRegex=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;class F{static GetShadersRepository(e=y.GLSL){return e===y.GLSL?F.ShadersRepository:F.ShadersRepositoryWGSL}static GetShadersStore(e=y.GLSL){return e===y.GLSL?F.ShadersStore:F.ShadersStoreWGSL}static GetIncludesShadersStore(e=y.GLSL){return e===y.GLSL?F.IncludesShadersStore:F.IncludesShadersStoreWGSL}}F.ShadersRepository="src/Shaders/",F.ShadersStore={},F.IncludesShadersStore={},F.ShadersRepositoryWGSL="src/ShadersWGSL/",F.ShadersStoreWGSL={},F.IncludesShadersStoreWGSL={};class L{static get ShadersRepository(){return F.ShadersRepository}static set ShadersRepository(e){F.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new s),this._onBindObservable}constructor(e,t,i,n=null,r,o=null,a=null,l=null,h=null,c,d="",u=y.GLSL){var _,f,p;if(this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new s,this.onErrorObservable=new s,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=d,t.attributes){const e=t;if(this._engine=i,this._attributesNames=e.attributes,this._uniformsNames=e.uniformsNames.concat(e.samplers),this._samplerList=e.samplers.slice(),this.defines=e.defines,this.onError=e.onError,this.onCompiled=e.onCompiled,this._fallbacks=e.fallbacks,this._indexParameters=e.indexParameters,this._transformFeedbackVaryings=e.transformFeedbackVaryings||null,this._multiTarget=!!e.multiTarget,this._shaderLanguage=null!==(_=e.shaderLanguage)&&void 0!==_?_:y.GLSL,e.uniformBuffersNames){this._uniformBuffersNamesList=e.uniformBuffersNames.slice();for(let t=0;t<e.uniformBuffersNames.length;t++)this._uniformBuffersNames[e.uniformBuffersNames[t]]=t}this._processFinalCode=null!==(f=e.processFinalCode)&&void 0!==f?f:null,this._processCodeAfterIncludes=null!==(p=e.processCodeAfterIncludes)&&void 0!==p?p:void 0}else this._engine=r,this.defines=null==o?"":o,this._uniformsNames=i.concat(n),this._samplerList=n?n.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=u,this.onError=h,this.onCompiled=l,this._indexParameters=c,this._fallbacks=a;this._attributeLocationByName={},this.uniqueId=L._UniqueIdSeed++,this._processShaderCode()}_processShaderCode(e=null,t=!1){let i,s;const n=this.name,r=l()?this._engine.getHostDocument():null;n.vertexSource?i="source:"+n.vertexSource:n.vertexElement?(i=r?r.getElementById(n.vertexElement):null,i||(i=n.vertexElement)):i=n.vertex||n,n.fragmentSource?s="source:"+n.fragmentSource:n.fragmentElement?(s=r?r.getElementById(n.fragmentElement):null,s||(s=n.fragmentElement)):s=n.fragment||n,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let o={defines:this.defines.split("\n"),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:null!=e?e:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:F.GetShadersRepository(this._shaderLanguage),includesShadersStore:F.GetIncludesShadersStore(this._shaderLanguage),version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};const a=[void 0,void 0],h=()=>{if(a[0]&&a[1]){o.isFragment=!0;const[e,i]=a;N.Process(i,o,((i,s)=>{this._fragmentSourceCodeBeforeMigration=s,this._processFinalCode&&(i=this._processFinalCode("fragment",i));const r=N.Finalize(e,i,o);o=null,this._useFinalCode(r.vertexCode,r.fragmentCode,n,t)}),this._engine)}};this._loadShader(i,"Vertex","",(e=>{N.Initialize(o),N.Process(e,o,((t,i)=>{this._rawVertexSourceCode=e,this._vertexSourceCodeBeforeMigration=i,this._processFinalCode&&(t=this._processFinalCode("vertex",t)),a[0]=t,h()}),this._engine)})),this._loadShader(s,"Fragment","Pixel",(e=>{this._rawFragmentSourceCode=e,a[1]=e,h()}))}_useFinalCode(e,t,i,s=!1){if(i){const s=i.vertexElement||i.vertex||i.spectorName||i,n=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===y.WGSL?"//":"")+"#define SHADER_NAME vertex:"+s+"\n"+e,this._fragmentSourceCode=(this._shaderLanguage===y.WGSL?"//":"")+"#define SHADER_NAME fragment:"+n+"\n"+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect(s)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch(e){return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){this.isReady()?e(this):(this.onCompileObservable.add((t=>{e(t)})),this._pipelineContext&&!this._pipelineContext.isAsync||setTimeout((()=>{this._checkIsReady(null)}),16))}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){return void this._processCompilationErrors(t,e)}this._isDisposed||setTimeout((()=>{this._checkIsReady(e)}),16)}_loadShader(e,t,i,s){if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)return void s(d(e));if("source:"===e.substr(0,7))return void s(e.substr(7));if("base64:"===e.substr(0,7))return void s(window.atob(e.substr(7)));const n=F.GetShadersStore(this._shaderLanguage);if(n[e+t+"Shader"])return void s(n[e+t+"Shader"]);if(i&&n[e+i+"Shader"])return void s(n[e+i+"Shader"]);let r;r="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:F.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(r+"."+t.toLowerCase()+".fx",s)}get vertexSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getVertexShaderCode())&&void 0!==t?t:this._vertexSourceCode}get fragmentSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:null!==(t=null===(e=this._pipelineContext)||void 0===e?void 0:e._getFragmentShaderCode())&&void 0!==t?t:this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,t,i,s){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(e,t)=>{s&&s(t)},this.onCompiled=()=>{const e=this.getEngine().scenes;if(e)for(let t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(e=!1){var t;const i=this._attributesNames,s=this.defines,n=this._pipelineContext;this._isReady=!1;try{const r=this._engine;this._pipelineContext=null!==(t=e?n:void 0)&&void 0!==t?t:r.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key.replace(/\r/g,"").replace(/\n/g,"|");const o=(e,t,i,s)=>this._rebuildProgram(e,t,i,s);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?r._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,o,null,this._transformFeedbackVaryings,this._key):r._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,o,s,this._transformFeedbackVaryings,this._key),r._executeWhenRenderingStateIsCompiled(this._pipelineContext,(()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,i,this._attributes),i)for(let e=0;e<i.length;e++){const t=i[e];this._attributeLocationByName[t]=this._attributes[e]}r.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),n&&!e&&this.getEngine()._deletePipelineContext(n)})),this._pipelineContext.isAsync&&this._checkIsReady(n)}catch(e){this._processCompilationErrors(e,n)}}_getShaderCodeAndErrorLine(e,t,i){const s=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let n=null;if(t&&e){const r=t.match(s);if(r&&2===r.length){const t=parseInt(r[1]),s=e.split("\n",-1);s.length>=t&&(n=`Offending line [${t}] in ${i?"fragment":"vertex"} code: ${s[t-1]}`)}}return[e,n]}_processCompilationErrors(e,t=null){var i,s,n;this._compilationError=e.message;const r=this._attributesNames,o=this._fallbacks;if(p.Error("Unable to compile effect:"),p.Error("Uniforms: "+this._uniformsNames.map((function(e){return" "+e}))),p.Error("Attributes: "+r.map((function(e){return" "+e}))),p.Error("Defines:\n"+this.defines),L.LogShaderCodeOnCompilationError){let e=null,t=null,r=null;(null===(i=this._pipelineContext)||void 0===i?void 0:i._getVertexShaderCode())&&([r,e]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),r&&(p.Error("Vertex code:"),p.Error(r))),(null===(s=this._pipelineContext)||void 0===s?void 0:s._getFragmentShaderCode())&&([r,t]=this._getShaderCodeAndErrorLine(null===(n=this._pipelineContext)||void 0===n?void 0:n._getFragmentShaderCode(),this._compilationError,!0),r&&(p.Error("Fragment code:"),p.Error(r))),e&&p.Error(e),t&&p.Error(t)}p.Error("Error: "+this._compilationError);const a=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,a()),o?(this._pipelineContext=null,o.hasMoreFallbacks?(this._allFallbacksProcessed=!1,p.Error("Trying next fallback."),this.defines=o.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,a(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||a())}get isSupported(){return""===this._compilationError}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setDepthStencilTexture(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(-1===this._samplerList.indexOf(i+"0")){const s=this._samplerList.indexOf(e);for(let e=1;e<t.length;e++){const t=i+(e-1).toString();this._samplerList.splice(s+e,0,t)}let n=0;for(const e of this._samplerList)this._samplers[e]=n,n+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}setTextureFromPostProcess(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}setTextureFromPostProcessOutput(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];void 0===i||L._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(L._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,s){return this._pipelineContext.setInt3(e,t,i,s),this}setInt4(e,t,i,s,n){return this._pipelineContext.setInt4(e,t,i,s,n),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setUInt2(e,t,i),this}setUInt3(e,t,i,s){return this._pipelineContext.setUInt3(e,t,i,s),this}setUInt4(e,t,i,s,n){return this._pipelineContext.setUInt4(e,t,i,s,n),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,s){return this._pipelineContext.setFloat3(e,t,i,s),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,s,n){return this._pipelineContext.setFloat4(e,t,i,s,n),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,i,s=y.GLSL){t&&(F.GetShadersStore(s)[`${e}PixelShader`]=t),i&&(F.GetShadersStore(s)[`${e}VertexShader`]=i)}static ResetCache(){L._BaseCache={}}}L.LogShaderCodeOnCompilationError=!0,L._UniqueIdSeed=0,L._BaseCache={},L.ShadersStore=F.ShadersStore,L.IncludesShadersStore=F.IncludesShadersStore;class w{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class B{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=B.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=B.KEEP,this.opDepthFail=B.KEEP,this.opStencilDepthPass=B.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}B.ALWAYS=519,B.KEEP=7680,B.REPLACE=7681;class U{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,s){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===s||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=s,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,s){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===s||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=s,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class k{constructor(){this.shaderLanguage=y.GLSL}postProcessor(e,t,i,s,n){if(!n.getCaps().drawBuffersExtension){const t=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(t,"")}return e}}const V=/(flat\s)?\s*varying\s*.*/;class G{constructor(){this.shaderLanguage=y.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return V.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const s=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){const t=-1!==e.search(/layout *\(location *= *0\) *out/g);e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(s||t?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else if(-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e}}class z{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=z._Counter++}}z._Counter=0;class H extends z{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class W{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return!!this.program&&(!this.isParallelCompiled||this.engine._isRenderingStateCompiled(this))}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,i,s,n,r,o,a){const l=this.engine;if(l.supportsUniformBuffers)for(const i in t)e.bindUniformBlock(i,t[i]);let h;for(this.engine.getUniforms(this,i).forEach(((e,t)=>{s[i[t]]=e})),this._uniforms=s,h=0;h<n.length;h++)null==e.getUniform(n[h])&&(n.splice(h,1),h--);n.forEach(((e,t)=>{r[e]=t}));for(const e of l.getAttributes(this,o))a.push(e)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_cacheFloat2(e,t,i){let s=this._valueCache[e];if(!s||2!==s.length)return s=[t,i],this._valueCache[e]=s,!0;let n=!1;return s[0]!==t&&(s[0]=t,n=!0),s[1]!==i&&(s[1]=i,n=!0),n}_cacheFloat3(e,t,i,s){let n=this._valueCache[e];if(!n||3!==n.length)return n=[t,i,s],this._valueCache[e]=n,!0;let r=!1;return n[0]!==t&&(n[0]=t,r=!0),n[1]!==i&&(n[1]=i,r=!0),n[2]!==s&&(n[2]=s,r=!0),r}_cacheFloat4(e,t,i,s,n){let r=this._valueCache[e];if(!r||4!==r.length)return r=[t,i,s,n],this._valueCache[e]=r,!0;let o=!1;return r[0]!==t&&(r[0]=t,o=!0),r[1]!==i&&(r[1]=i,o=!0),r[2]!==s&&(r[2]=s,o=!0),r[3]!==n&&(r[3]=n,o=!0),o}setInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setInt4(e,t,i,s,n){this._cacheFloat4(e,t,i,s,n)&&(this.engine.setInt4(this._uniforms[e],t,i,s,n)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setUInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setUInt4(e,t,i,s,n){this._cacheFloat4(e,t,i,s,n)&&(this.engine.setUInt4(this._uniforms[e],t,i,s,n)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];void 0!==i&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setFloat3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,s,n){this._cacheFloat4(e,t,i,s,n)&&(this.engine.setFloat4(this._uniforms[e],t,i,s,n)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}class X{static SetMatrixPrecision(e){if(X.MatrixTrackPrecisionChange=!1,e&&!X.MatrixUse64Bits&&X.MatrixTrackedMatrices)for(let e=0;e<X.MatrixTrackedMatrices.length;++e){const t=X.MatrixTrackedMatrices[e],i=t._m;t._m=new Array(16);for(let e=0;e<16;++e)t._m[e]=i[e]}X.MatrixUse64Bits=e,X.MatrixCurrentType=X.MatrixUse64Bits?Array:Float32Array,X.MatrixTrackedMatrices=null}}X.MatrixUse64Bits=!1,X.MatrixTrackPrecisionChange=!0,X.MatrixCurrentType=Float32Array,X.MatrixTrackedMatrices=[];class Q{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&!(e=t.createTexture()))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){var t,i;return null!==(i=null===(t=this._MSAARenderBuffers)||void 0===t?void 0:t[e])&&void 0!==i?i:null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class Y{static IsWrapper(e){return void 0===e.getPipelineContext}static GetEffect(e){return void 0===e.getPipelineContext?e.effect:e}constructor(e,t=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){var s;this.effect=e,void 0!==t&&(this.defines=t),i&&(null===(s=this.drawContext)||void 0===s||s.reset())}dispose(){var e;null===(e=this.drawContext)||void 0===e||e.dispose()}}class K{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,null===(e=this.stencilGlobal)||void 0===e||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var t;if(!e)return;const i=!this.useStencilGlobalOnly&&!!(null===(t=this.stencilMaterial)||void 0===t?void 0:t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class j{static get Now(){return l()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}class ${}class q{static get NpmPackage(){return"babylonjs@6.35.0"}static get Version(){return"6.35.0"}get description(){let e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}get isDisposed(){return this._isDisposed}static get ShadersRepository(){return L.ShadersRepository}static set ShadersRepository(e){L.ShadersRepository=e}_getShaderProcessor(e){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,this._depthCullingState.depthFunc=e?518:515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(e){this._snapshotRenderingMode=e}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(e,t){if("undefined"==typeof document)return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return q._CreateCanvas(e,t)}createCanvasImage(){return document.createElement("img")}constructor(e,t,i,n){var r,o,a,h,c,d,u,_,f,m,g;this._name="WebGL",this._isDisposed=!1,this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new s,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new s,this.onContextRestoredObservable=new s,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new w,this._stencilStateComposer=new K,this._stencilState=new B,this._alphaState=new U,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._currentRenderTarget=null,this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new s,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=j.Now;let v=null;i=i||{},this._creationOptions=i,this.adaptToDeviceRatio=null!=n&&n,this._stencilStateComposer.stencilGlobal=this._stencilState,X.SetMatrixPrecision(!!i.useHighPrecisionMatrix),i.antialias=null!=t?t:i.antialias,i.deterministicLockstep=null!==(r=i.deterministicLockstep)&&void 0!==r&&r,i.lockstepMaxSteps=null!==(o=i.lockstepMaxSteps)&&void 0!==o?o:4,i.timeStep=null!==(a=i.timeStep)&&void 0!==a?a:1/60,i.audioEngine=null===(h=i.audioEngine)||void 0===h||h,i.stencil=null===(c=i.stencil)||void 0===c||c,this._audioContext=null!==(u=null===(d=i.audioEngineOptions)||void 0===d?void 0:d.audioContext)&&void 0!==u?u:null,this._audioDestination=null!==(f=null===(_=i.audioEngineOptions)||void 0===_?void 0:_.audioDestination)&&void 0!==f?f:null,this.premultipliedAlpha=null===(m=i.premultipliedAlpha)||void 0===m||m,this.useExactSrgbConversions=null!==(g=i.useExactSrgbConversions)&&void 0!==g&&g,this._doNotHandleContextLost=!!i.doNotHandleContextLost,this._isStencilEnable=!!i.stencil,n=n||i.adaptToDeviceRatio||!1;const T=l()&&window.devicePixelRatio||1,b=i.limitDeviceRatio||T;if(this._hardwareScalingLevel=n?1/Math.min(b,T):1,this._lastDevicePixelRatio=T,!e)return;if(e.getContext){if(v=e,this._renderingCanvas=v,void 0===i.preserveDrawingBuffer&&(i.preserveDrawingBuffer=!1),void 0===i.xrCompatible&&(i.xrCompatible=!0),navigator&&navigator.userAgent){this._setupMobileChecks();const e=navigator.userAgent;for(const t of q.ExceptionList){const s=t.key,n=t.targets;if(new RegExp(s).test(e)){if(t.capture&&t.captureConstraint){const i=t.capture,s=t.captureConstraint,n=new RegExp(i).exec(e);if(n&&n.length>0&&parseInt(n[n.length-1])>=s)continue}for(const e of n)switch(e){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1}}}}if(this._doNotHandleContextLost||(this._onContextLost=e=>{e.preventDefault(),this._contextWasLost=!0,p.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost((()=>this._initGLContext()))},v.addEventListener("webglcontextlost",this._onContextLost,!1),v.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=v.getContext("webgl2",i)||v.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch(e){}if(!this._gl){if(!v)throw new Error("The provided canvas is null or undefined.");try{this._gl=v.getContext("webgl",i)||v.getContext("experimental-webgl",i)}catch(e){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const t=this._gl.getContextAttributes();t&&(i.stencil=t.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),void 0!==i.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let e=0;e<this._caps.maxVertexAttribs;e++)this._currentBufferPointers[e]=new $;this._shaderProcessor=this.webGLVersion>1?new G:new k,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const E=`Babylon.js v${q.Version}`;p.Log(E+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",E)}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=-1!==e.indexOf("Mobile")||-1!==e.indexOf("Mac")&&c()&&"ontouchend"in document},this._checkForMobile(),l()&&window.addEventListener("resize",this._checkForMobile))}_restoreEngineAfterContextLost(e){setTimeout((async()=>{var t;this._dummyFramebuffer=null;const i=this._depthCullingState.depthTest,s=this._depthCullingState.depthFunc,n=this._depthCullingState.depthMask,r=this._stencilState.stencilTest;await e(),this.wipeCaches(!0),this._rebuildEffects(),null===(t=this._rebuildComputeEffects)||void 0===t||t.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0),this._depthCullingState.depthTest=i,this._depthCullingState.depthFunc=s,this._depthCullingState.depthMask=n,this._stencilState.stencilTest=r,p.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}),0)}_sharedInit(e){this._renderingCanvas=e}_getShaderProcessingContext(e){return null}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}L.ResetCache()}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuild();for(const e of this._storageBuffers)e._rebuild()}_initGLContext(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const t=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=t&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193),34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(null!==(e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))&&void 0!==e?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{const e=this._gl.getExtension("WEBGL_draw_buffers");if(null!==e){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=e.drawBuffersWEBGL.bind(e),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let t=0;t<16;t++)this._gl["COLOR_ATTACHMENT"+t+"_WEBGL"]=e["COLOR_ATTACHMENT"+t+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const e=this._gl.getExtension("WEBGL_depth_texture");null!=e&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=e.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const e=this._gl.getExtension("OES_vertex_array_object");null!=e&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=e.createVertexArrayOES.bind(e),this._gl.bindVertexArray=e.bindVertexArrayOES.bind(e),this._gl.deleteVertexArray=e.deleteVertexArrayOES.bind(e))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const e=this._gl.getExtension("ANGLE_instanced_arrays");null!=e?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),this._gl.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),this._gl.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const e=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),t=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);e&&t&&(this._caps.highPrecisionShaderSupported=0!==e.precision&&0!==t.precision)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const e=this._gl.getExtension("EXT_blend_minmax");null!=e&&(this._caps.blendMinMax=!0,this._gl.MAX=e.MAX_EXT,this._gl.MIN=e.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const e=this._gl.getExtension("EXT_sRGB");null!=e&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:e.SRGB_EXT,SRGB8:e.SRGB_ALPHA_EXT,SRGB8_ALPHA8:e.SRGB_ALPHA_EXT})}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!(!this._creationOptions||!this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let e=0;e<this._maxSimultaneousTextures;e++)this._nextFreeTextureSlots.push(e);"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideMultiple4Bytes:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(e){if(!e)return this._activeRenderLoops.length=0,void this._cancelFrame();const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),0==this._activeRenderLoops.length&&this._cancelFrame())}_cancelFrame(){if(this._renderingQueueLaunched&&this._frameHandler){if(this._renderingQueueLaunched=!1,l()){const{cancelAnimationFrame:e}=this.getHostWindow()||window;if("function"==typeof e)return e(this._frameHandler)}else if("function"==typeof cancelAnimationFrame)return cancelAnimationFrame(this._frameHandler);return clearTimeout(this._frameHandler)}}_renderLoop(){if(!this._contextWasLost){let e=!0;if((this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e){this.beginFrame();for(let e=0;e<this._activeRenderLoops.length;e++)(0,this._activeRenderLoops[e])();this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return l()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(e,t){return q.QueueNewFrame(e,t)}runRenderLoop(e){-1===this._activeRenderLoops.indexOf(e)&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=()=>this._renderLoop(),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(e,t,i,s=!1){var n,r;const o=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=o;let a=0;if(t&&e){let t=!0;if(this._currentRenderTarget){const i=null===(n=this._currentRenderTarget.texture)||void 0===n?void 0:n.format;if(8===i||9===i||10===i||11===i){const i=null===(r=this._currentRenderTarget.texture)||void 0===r?void 0:r.type;7===i||5===i?(q._TempClearColorUint32[0]=255*e.r,q._TempClearColorUint32[1]=255*e.g,q._TempClearColorUint32[2]=255*e.b,q._TempClearColorUint32[3]=255*e.a,this._gl.clearBufferuiv(this._gl.COLOR,0,q._TempClearColorUint32),t=!1):(q._TempClearColorInt32[0]=255*e.r,q._TempClearColorInt32[1]=255*e.g,q._TempClearColorInt32[2]=255*e.b,q._TempClearColorInt32[3]=255*e.a,this._gl.clearBufferiv(this._gl.COLOR,0,q._TempClearColorInt32),t=!1)}}t&&(this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),a|=this._gl.COLOR_BUFFER_BIT)}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),a|=this._gl.DEPTH_BUFFER_BIT),s&&(this._gl.clearStencil(0),a|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(a)}_viewport(e,t,i,s){e===this._viewportCached.x&&t===this._viewportCached.y&&i===this._viewportCached.z&&s===this._viewportCached.w||(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=s,this._gl.viewport(e,t,i,s))}setViewport(e,t,i){const s=t||this.getRenderWidth(),n=i||this.getRenderHeight(),r=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(r*s,o*n,s*e.width,n*e.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const e=l()&&window.devicePixelRatio||1,t=this._lastDevicePixelRatio/e;this._lastDevicePixelRatio=e,this._hardwareScalingLevel*=t}if(l()&&c())if(this._renderingCanvas){const e=this._renderingCanvas.getBoundingClientRect?this._renderingCanvas.getBoundingClientRect():{width:this._renderingCanvas.width*this._hardwareScalingLevel,height:this._renderingCanvas.height*this._hardwareScalingLevel};t=this._renderingCanvas.clientWidth||e.width||this._renderingCanvas.width||100,i=this._renderingCanvas.clientHeight||e.height||this._renderingCanvas.height||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){return!(!this._renderingCanvas||(e|=0,t|=0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t||(this._renderingCanvas.width=e,this._renderingCanvas.height=t,0)))}bindFramebuffer(e,t=0,i,s,n,r=0,o=0){var a,l,h,c,d,u;const _=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(_._MSAAFramebuffer?_._MSAAFramebuffer:_._framebuffer);const f=this._gl;e.isMulti||(e.is2DArray?f.framebufferTextureLayer(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,null===(a=e.texture._hardwareTexture)||void 0===a?void 0:a.underlyingResource,r,o):e.isCube?f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_CUBE_MAP_POSITIVE_X+t,null===(l=e.texture._hardwareTexture)||void 0===l?void 0:l.underlyingResource,r):_._currentLOD!==r&&(f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,null===(h=e.texture._hardwareTexture)||void 0===h?void 0:h.underlyingResource,r),_._currentLOD=r));const p=e._depthStencilTexture;if(p){const i=e._depthStencilTextureWithStencil?f.DEPTH_STENCIL_ATTACHMENT:f.DEPTH_ATTACHMENT;e.is2DArray?f.framebufferTextureLayer(f.FRAMEBUFFER,i,null===(c=p._hardwareTexture)||void 0===c?void 0:c.underlyingResource,r,o):e.isCube?f.framebufferTexture2D(f.FRAMEBUFFER,i,f.TEXTURE_CUBE_MAP_POSITIVE_X+t,null===(d=p._hardwareTexture)||void 0===d?void 0:d.underlyingResource,r):f.framebufferTexture2D(f.FRAMEBUFFER,i,f.TEXTURE_2D,null===(u=p._hardwareTexture)||void 0===u?void 0:u.underlyingResource,r)}this._cachedViewport&&!n?this.setViewport(this._cachedViewport,i,s):(i||(i=e.width,r&&(i/=Math.pow(2,r))),s||(s=e.height,r&&(s/=Math.pow(2,r))),this._viewport(0,0,i,s)),this.wipeCaches()}setState(e,t=0,i,s=!1,n,r,o=0){var a,l;(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const h=null===(l=null!==(a=this.cullBackFaces)&&void 0!==a?a:n)||void 0===l||l?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==h||i)&&(this._depthCullingState.cullFace=h),this.setZOffset(t),this.setZOffsetUnits(o);const c=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==c||i)&&(this._depthCullingState.frontFace=c),this._stencilStateComposer.stencilMaterial=r}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(e,t=!1,i){var s;const n=e;this._currentRenderTarget=null;const r=this._gl;if(n._MSAAFramebuffer){if(e.isMulti)return void this.unBindMultiColorAttachmentFramebuffer(e,t,i);r.bindFramebuffer(r.READ_FRAMEBUFFER,n._MSAAFramebuffer),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,n._framebuffer),r.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,r.COLOR_BUFFER_BIT,r.NEAREST)}!(null===(s=e.texture)||void 0===s?void 0:s.generateMipMaps)||t||e.isCube||this.generateMipmaps(e.texture),i&&(n._MSAAFramebuffer&&this._bindUnboundFramebuffer(n._framebuffer),i()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,i){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const s=new H(i);return this.bindArrayBuffer(s),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),s.references=1,s}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,i){const s=this._gl.createBuffer(),n=new H(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(n);const r=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),n.references=1,n.is32Bits=4===r.BYTES_PER_ELEMENT,n}_normalizeIndexData(e){if(2===e.BYTES_PER_ELEMENT)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let t=0;t<e.length;t++)if(e[t]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const s=e.program,n=this._gl.getUniformBlockIndex(s,t);this._gl.uniformBlockBinding(s,n,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,s,n,r,o){const a=this._currentBufferPointers[t];if(!a)return;let l=!1;a.active?(a.buffer!==e&&(a.buffer=e,l=!0),a.size!==i&&(a.size=i,l=!0),a.type!==s&&(a.type=s,l=!0),a.normalized!==n&&(a.normalized=n,l=!0),a.stride!==r&&(a.stride=r,l=!0),a.offset!==o&&(a.offset=o,l=!0)):(l=!0,a.active=!0,a.index=t,a.size=i,a.type=s,a.normalized=n,a.stride=r,a.offset=o,a.buffer=e),(l||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),s===this._gl.UNSIGNED_INT||s===this._gl.INT?this._gl.vertexAttribIPointer(t,i,s,r,o):this._gl.vertexAttribPointer(t,i,s,n,r,o))}_bindIndexBufferWithCache(e){null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const s=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let n=0;n<s.length;n++){const r=t.getAttributeLocation(n);if(r>=0){const t=s[n];let o=null;if(i&&(o=i[t]),o||(o=e[t]),!o)continue;this._gl.enableVertexAttribArray(r),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[r]=!0);const a=o.getBuffer();a&&(this._vertexAttribPointer(a,r,o.getSize(),o.type,o.normalized,o.byteStride,o.byteOffset),o.getIsInstanced()&&(this._gl.vertexAttribDivisor(r,o.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(a))))}}}recordVertexArrayObject(e,t,i,s){const n=this._gl.createVertexArray();if(!n)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(n),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,s),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),n}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=t&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,s,n){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=n;const t=n.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let r=0;for(let o=0;o<t;o++)if(o<i.length){const t=n.getAttributeLocation(o);t>=0&&(this._gl.enableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!0,this._vertexAttribPointer(e,t,i[o],this._gl.FLOAT,!1,s,r)),r+=4*i[o]}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,s){this._cachedVertexBuffers===e&&this._cachedEffectForVertexBuffers===i||(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,s)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const i=this._currentInstanceBuffers[t];e!=i&&i.references&&(e=i,this.bindArrayBuffer(i));const s=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(s,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,0===e.references&&(this._deleteBuffer(e),!0)}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==i[0].index)this.bindInstancesBuffer(e,i,!0);else for(let t=0;t<4;t++){const s=i[t];this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0),this._vertexAttribPointer(e,s,4,this._gl.FLOAT,!1,64,16*t),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let s=0;if(i)for(let e=0;e<t.length;e++)s+=4*t[e].attributeSize;for(let i=0;i<t.length;i++){const n=t[i];void 0===n.index&&(n.index=this._currentEffect.getAttributeLocationByName(n.attributeName)),n.index<0||(this._vertexAttribArraysEnabled[n.index]||(this._gl.enableVertexAttribArray(n.index),this._vertexAttribArraysEnabled[n.index]=!0),this._vertexAttribPointer(e,n.index,n.attributeSize,n.attributeType||this._gl.FLOAT,n.normalized||!1,s,n.offset),this._gl.vertexAttribDivisor(n.index,void 0===n.divisor?1:n.divisor),this._currentInstanceLocations.push(n.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t,i=!1;for(;-1!==(t=this._currentInstanceLocations.indexOf(e));)this._currentInstanceLocations.splice(t,1),this._currentInstanceBuffers.splice(t,1),i=!0,t=this._currentInstanceLocations.indexOf(e);i&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,s){this.drawElementsType(e?0:1,t,i,s)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,s){this.drawArraysType(e?0:1,t,i,s)}drawElementsType(e,t,i,s){this.applyStates(),this._reportDrawCall();const n=this._drawMode(e),r=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;s?this._gl.drawElementsInstanced(n,i,r,t*o,s):this._gl.drawElements(n,i,r,t*o)}drawArraysType(e,t,i,s){this.applyStates(),this._reportDrawCall();const n=this._drawMode(e);s?this._gl.drawArraysInstanced(n,t,i,s):this._gl.drawArrays(n,t,i)}_drawMode(e){switch(e){case 0:default:return this._gl.TRIANGLES;case 2:case 3:return this._gl.POINTS;case 1:case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN}}_reportDrawCall(){}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))}_getGlobalDefines(e){if(e)return this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,void(this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS);{let e="";return this.isNDCHalfZRange&&(e+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(e&&(e+="\n"),e+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(e&&(e+="\n"),e+="#define USE_EXACT_SRGB_CONVERSIONS"),e}}createEffect(e,t,i,s,n,r,o,a,l,h=y.GLSL){var c;const d=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,u=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,_=this._getGlobalDefines();let f=null!==(c=null!=n?n:t.defines)&&void 0!==c?c:"";_&&(f+=_);const p=d+"+"+u+"@"+f;if(this._compiledEffects[p]){const e=this._compiledEffects[p];return o&&e.isReady()&&o(e),e}const m=new L(e,t,i,s,this,n,r,o,a,l,p,h);return this._compiledEffects[p]=m,m}static _ConcatenateShader(e,t,i=""){return i+(t?t+"\n":"")+e}_compileShader(e,t,i,s){return this._compileRawShader(q._ConcatenateShader(e,i,s),t)}_compileRawShader(e,t){const i=this._gl,s=i.createShader("vertex"===t?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!s){let e=i.NO_ERROR,s=i.NO_ERROR;for(;(s=i.getError())!==i.NO_ERROR;)e=s;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${e}, gl isContextLost=${i.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return i.shaderSource(s,e),i.compileShader(s),s}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,s,n=null){s=s||this._gl;const r=this._compileRawShader(t,"vertex"),o=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,r,o,s,n)}createShaderProgram(e,t,i,s,n,r=null){n=n||this._gl;const o=this._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"",a=this._compileShader(t,"vertex",s,o),l=this._compileShader(i,"fragment",s,o);return this._createShaderProgram(e,a,l,n,r)}inlineShaderCode(e){return e}createPipelineContext(e){const t=new W;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t}createMaterialContext(){}createDrawContext(){}_createShaderProgram(e,t,i,s,n=null){const r=s.createProgram();if(e.program=r,!r)throw new Error("Unable to create program");return s.attachShader(r,t),s.attachShader(r,i),s.linkProgram(r),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),r}_finalizePipelineContext(e){const t=e.context,i=e.vertexShader,s=e.fragmentShader,n=e.program;if(!t.getProgramParameter(n,t.LINK_STATUS)){if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)){const t=this._gl.getShaderInfoLog(i);if(t)throw e.vertexCompilationError=t,new Error("VERTEX SHADER "+t)}if(!this._gl.getShaderParameter(s,this._gl.COMPILE_STATUS)){const t=this._gl.getShaderInfoLog(s);if(t)throw e.fragmentCompilationError=t,new Error("FRAGMENT SHADER "+t)}const r=t.getProgramInfoLog(n);if(r)throw e.programLinkError=r,new Error(r)}if(this.validateShaderPrograms&&(t.validateProgram(n),!t.getProgramParameter(n,t.VALIDATE_STATUS))){const i=t.getProgramInfoLog(n);if(i)throw e.programValidationError=i,new Error(i)}t.deleteShader(i),t.deleteShader(s),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}_preparePipelineContext(e,t,i,s,n,r,o,a,l,h){const c=e;c.program=s?this.createRawShaderProgram(c,t,i,void 0,l):this.createShaderProgram(c,t,i,a,void 0,l),c.program.__SPECTOR_rebuildProgram=o}_isRenderingStateCompiled(e){const t=e;return!(this._isDisposed||t._isDisposed||!this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)||(this._finalizePipelineContext(t),0))}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(!i.isParallelCompiled)return void t();const s=i.onCompiled;i.onCompiled=s?()=>{s(),t()}:t}getUniforms(e,t){const i=new Array,s=e;for(let e=0;e<t.length;e++)i.push(this._gl.getUniformLocation(s.program,t[e]));return i}getAttributes(e,t){const i=[],s=e;for(let e=0;e<t.length;e++)try{i.push(this._gl.getAttribLocation(s.program,t[e]))}catch(e){i.push(-1)}return i}enableEffect(e){(e=null!==e&&Y.IsWrapper(e)?e.effect:e)&&e!==this._currentEffect&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return!!e&&(this._gl.uniform1i(e,t),!0)}setInt2(e,t,i){return!!e&&(this._gl.uniform2i(e,t,i),!0)}setInt3(e,t,i,s){return!!e&&(this._gl.uniform3i(e,t,i,s),!0)}setInt4(e,t,i,s,n){return!!e&&(this._gl.uniform4i(e,t,i,s,n),!0)}setIntArray(e,t){return!!e&&(this._gl.uniform1iv(e,t),!0)}setIntArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2iv(e,t),0))}setIntArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3iv(e,t),0))}setIntArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4iv(e,t),0))}setUInt(e,t){return!!e&&(this._gl.uniform1ui(e,t),!0)}setUInt2(e,t,i){return!!e&&(this._gl.uniform2ui(e,t,i),!0)}setUInt3(e,t,i,s){return!!e&&(this._gl.uniform3ui(e,t,i,s),!0)}setUInt4(e,t,i,s,n){return!!e&&(this._gl.uniform4ui(e,t,i,s,n),!0)}setUIntArray(e,t){return!!e&&(this._gl.uniform1uiv(e,t),!0)}setUIntArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2uiv(e,t),0))}setUIntArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3uiv(e,t),0))}setUIntArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4uiv(e,t),0))}setArray(e,t){return!(!e||t.length<1||(this._gl.uniform1fv(e,t),0))}setArray2(e,t){return!(!e||t.length%2!=0||(this._gl.uniform2fv(e,t),0))}setArray3(e,t){return!(!e||t.length%3!=0||(this._gl.uniform3fv(e,t),0))}setArray4(e,t){return!(!e||t.length%4!=0||(this._gl.uniform4fv(e,t),0))}setMatrices(e,t){return!!e&&(this._gl.uniformMatrix4fv(e,!1,t),!0)}setMatrix3x3(e,t){return!!e&&(this._gl.uniformMatrix3fv(e,!1,t),!0)}setMatrix2x2(e,t){return!!e&&(this._gl.uniformMatrix2fv(e,!1,t),!0)}setFloat(e,t){return!!e&&(this._gl.uniform1f(e,t),!0)}setFloat2(e,t,i){return!!e&&(this._gl.uniform2f(e,t,i),!0)}setFloat3(e,t,i,s){return!!e&&(this._gl.uniform3f(e,t,i,s),!0)}setFloat4(e,t,i,s,n){return!!e&&(this._gl.uniform4f(e,t,i,s,n),!0)}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let s=i.NEAREST,n=i.NEAREST;switch(e){case 11:s=i.LINEAR,n=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 3:s=i.LINEAR,n=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 8:s=i.NEAREST,n=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 4:s=i.NEAREST,n=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 5:s=i.NEAREST,n=t?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case 6:s=i.NEAREST,n=t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case 7:s=i.NEAREST,n=i.LINEAR;break;case 1:s=i.NEAREST,n=i.NEAREST;break;case 9:s=i.LINEAR,n=t?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case 10:s=i.LINEAR,n=t?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case 2:s=i.LINEAR,n=i.LINEAR;break;case 12:s=i.LINEAR,n=i.NEAREST}return{min:n,mag:s}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new Q(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,s=r.Unknown){var n;let o,l=!1,h=0,c=3,d=5,u=!1,_=1;void 0!==t&&"object"==typeof t?(l=!!t.generateMipMaps,h=void 0===t.type?0:t.type,c=void 0===t.samplingMode?3:t.samplingMode,d=void 0===t.format?5:t.format,u=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,_=null!==(n=t.samples)&&void 0!==n?n:1,o=t.label):l=!!t,u&&(u=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(1!==h||this._caps.textureFloatLinearFiltering)&&(2!==h||this._caps.textureHalfFloatLinearFiltering)||(c=1),1!==h||this._caps.textureFloat||(h=0,p.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const f=this._gl,m=new a(this,s),g=e.width||e,v=e.height||e,T=e.layers||0,b=this._getSamplingParameters(c,l),E=0!==T?f.TEXTURE_2D_ARRAY:f.TEXTURE_2D,S=this._getRGBABufferInternalSizedFormat(h,d,u),x=this._getInternalFormat(d),C=this._getWebGLTextureType(h);return this._bindTextureDirectly(E,m),0!==T?(m.is2DArray=!0,f.texImage3D(E,0,S,g,v,T,0,x,C,null)):f.texImage2D(E,0,S,g,v,0,x,C,null),f.texParameteri(E,f.TEXTURE_MAG_FILTER,b.mag),f.texParameteri(E,f.TEXTURE_MIN_FILTER,b.min),f.texParameteri(E,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(E,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),l&&this._gl.generateMipmap(E),this._bindTextureDirectly(E,null),m._useSRGBBuffer=u,m.baseWidth=g,m.baseHeight=v,m.width=g,m.height=v,m.depth=T,m.isReady=!0,m.samples=_,m.generateMipMaps=l,m.samplingMode=c,m.type=h,m.format=d,m.label=o,this._internalTexturesCache.push(m),m}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)}_createTextureBase(e,t,i,s,n=3,o=null,l=null,h,c,d=null,_=null,f=null,m=null,g,v,T){const b="data:"===(e=e||"").substr(0,5),E="blob:"===e.substr(0,5),S=b&&-1!==e.indexOf(";base64,"),x=_||new a(this,r.Url);x!==_&&(x.label=e.substring(0,60));const C=e;!this._transformTextureUrl||S||_||d||(e=this._transformTextureUrl(e)),C!==e&&(x._originalUrl=C);const y=e.lastIndexOf(".");let A=m||(y>-1?e.substring(y).toLowerCase():""),R=null;A.indexOf("?")>-1&&(A=A.split("?")[0]);for(const e of q._TextureLoaders)if(e.canLoad(A,g)){R=e;break}s&&s.addPendingData(x),x.url=e,x.generateMipMaps=!t,x.samplingMode=n,x.invertY=i,x._useSRGBBuffer=this._getUseSRGBBuffer(!!T,t),this._doNotHandleContextLost||(x._buffer=d);let I=null;o&&!_&&(I=x.onLoadedObservable.add(o)),_||this._internalTexturesCache.push(x);const P=(i,r)=>{s&&s.removePendingData(x),e===C?(I&&x.onLoadedObservable.remove(I),u.UseFallbackTexture&&this._createTextureBase(u.FallbackTexture,t,x.invertY,s,n,null,l,h,c,d,x),i=(i||"Unknown error")+(u.UseFallbackTexture?" - Fallback texture was used":""),x.onErrorObservable.notifyObservers({message:i,exception:r}),l&&l(i,r)):(p.Warn(`Failed to load ${e}, falling back to ${C}`),this._createTextureBase(C,t,x.invertY,s,n,o,l,h,c,d,x,f,m,g,v,T))};if(R){const t=e=>{R.loadData(e,x,((e,t,i,r,o,a)=>{a?P("TextureLoader failed to load data"):h(x,A,s,{width:e,height:t},x.invertY,!i,r,(()=>(o(),!1)),n)}),v)};d?d instanceof ArrayBuffer?t(new Uint8Array(d)):ArrayBuffer.isView(d)?t(d):l&&l("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,(e=>t(new Uint8Array(e))),void 0,s?s.offlineProvider:void 0,!0,((e,t)=>{P("Unable to load "+(e&&e.responseURL,t))}))}else{const i=e=>{E&&!this._doNotHandleContextLost&&(x._buffer=e),h(x,A,s,e,x.invertY,t,!1,c,n)};!b||S?d&&("string"==typeof d.decoding||d.close)?i(d):q._FileToolsLoadImage(e,i,P,s?s.offlineProvider:null,g,x.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):"string"==typeof d||d instanceof ArrayBuffer||ArrayBuffer.isView(d)||d instanceof Blob?q._FileToolsLoadImage(d,i,P,s?s.offlineProvider:null,g,x.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):d&&i(d)}return x}createTexture(e,t,i,s,n=3,o=null,l=null,h=null,c=null,d=null,u=null,_,f,p,m){return this._createTextureBase(e,t,i,s,n,o,l,this._prepareWebGLTexture.bind(this),((e,t,i,n,o,l)=>{const h=this._gl,c=i.width===e&&i.height===t,u=this._getTexImageParametersForCreateTexture(d,n,o._useSRGBBuffer);if(c)return h.texImage2D(h.TEXTURE_2D,0,u.internalFormat,u.format,u.type,i),!1;const _=this._caps.maxTextureSize;if(i.width>_||i.height>_||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!(!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=e,this._workingCanvas.height=t,this._workingContext.drawImage(i,0,0,i.width,i.height,0,0,e,t),h.texImage2D(h.TEXTURE_2D,0,u.internalFormat,u.format,u.type,this._workingCanvas),o.width=e,o.height=t,1));{const e=new a(this,r.Temp);this._bindTextureDirectly(h.TEXTURE_2D,e,!0),h.texImage2D(h.TEXTURE_2D,0,u.internalFormat,u.format,u.type,i),this._rescaleTexture(e,o,s,u.format,(()=>{this._releaseTexture(e),this._bindTextureDirectly(h.TEXTURE_2D,o,!0),l()}))}return!0}),h,c,d,u,_,f,m)}_getTexImageParametersForCreateTexture(e,t,i){let s,n;return null==e&&(e=".jpg"!==t||i?5:4),1===this.webGLVersion?(s=this._getInternalFormat(e,i),n=s):(s=this._getInternalFormat(e,!1),n=this._getRGBABufferInternalSizedFormat(0,e,i)),{internalFormat:n,format:s,type:this._gl.UNSIGNED_BYTE}}static _FileToolsLoadImage(e,t,i,s,n,r){throw f("FileTools")}_rescaleTexture(e,t,i,s,n){}createRawTexture(e,t,i,s,n,r,o,a=null,l=0,h=0,c=!1){throw f("Engine.RawTexture")}createRawCubeTexture(e,t,i,s,n,r,o,a=null){throw f("Engine.RawTexture")}createRawTexture3D(e,t,i,s,n,r,o,a,l=null,h=0){throw f("Engine.RawTexture")}createRawTexture2DArray(e,t,i,s,n,r,o,a,l=null,h=0){throw f("Engine.RawTexture")}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const s=this._getTextureTarget(t),n=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(s,this._gl.TEXTURE_MAG_FILTER,n.mag,t),this._setTextureParameterInteger(s,this._gl.TEXTURE_MIN_FILTER,n.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(s)),this._bindTextureDirectly(s,null),t.samplingMode=e}updateTextureDimensions(e,t,i,s=1){}updateTextureWrappingMode(e,t,i=null,s=null){const n=this._getTextureTarget(e);null!==t&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),null!==i&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&null!==s&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(s),e),e._cachedWrapR=s),this._bindTextureDirectly(n,null)}_setupDepthStencilTexture(e,t,i,s,n,r=1){const o=t.width||t,a=t.height||t,l=t.layers||0;e.baseWidth=o,e.baseHeight=a,e.width=o,e.height=a,e.is2DArray=l>0,e.depth=l,e.isReady=!0,e.samples=r,e.generateMipMaps=!1,e.samplingMode=s?2:1,e.type=0,e._comparisonFunction=n;const h=this._gl,c=this._getTextureTarget(e),d=this._getSamplingParameters(e.samplingMode,!1);h.texParameteri(c,h.TEXTURE_MAG_FILTER,d.mag),h.texParameteri(c,h.TEXTURE_MIN_FILTER,d.min),h.texParameteri(c,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(c,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===n?(h.texParameteri(c,h.TEXTURE_COMPARE_FUNC,515),h.texParameteri(c,h.TEXTURE_COMPARE_MODE,h.NONE)):(h.texParameteri(c,h.TEXTURE_COMPARE_FUNC,n),h.texParameteri(c,h.TEXTURE_COMPARE_MODE,h.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(e,t,i,s,n,r=0,o=0){const a=this._gl;let l=a.TEXTURE_2D;if(e.isCube&&(l=a.TEXTURE_CUBE_MAP_POSITIVE_X+r),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=a.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=a.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=a.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=a.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=a.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=a.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=a.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1}this._gl.compressedTexImage2D(l,o,t,i,s,0,n)}_uploadDataToTextureDirectly(e,t,i=0,s=0,n,r=!1){const o=this._gl,a=this._getWebGLTextureType(e.type),l=this._getInternalFormat(e.format),h=void 0===n?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(n,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let c=o.TEXTURE_2D;e.isCube&&(c=o.TEXTURE_CUBE_MAP_POSITIVE_X+i);const d=Math.round(Math.log(e.width)*Math.LOG2E),u=Math.round(Math.log(e.height)*Math.LOG2E),_=r?e.width:Math.pow(2,Math.max(d-s,0)),f=r?e.height:Math.pow(2,Math.max(u-s,0));o.texImage2D(c,s,h,_,f,0,l,a,t)}updateTextureData(e,t,i,s,n,r,o=0,a=0,l=!1){const h=this._gl,c=this._getWebGLTextureType(e.type),d=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let u=h.TEXTURE_2D,_=h.TEXTURE_2D;e.isCube&&(_=h.TEXTURE_CUBE_MAP_POSITIVE_X+o,u=h.TEXTURE_CUBE_MAP),this._bindTextureDirectly(u,e,!0),h.texSubImage2D(_,a,i,s,n,r,d,c,t),l&&this._gl.generateMipmap(_),this._bindTextureDirectly(u,null)}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){const n=this._gl,r=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(r,e,!0),this._uploadDataToTextureDirectly(e,t,i,s),this._bindTextureDirectly(r,null,!0)}_prepareWebGLTextureContinuation(e,t,i,s,n){const r=this._gl;if(!r)return;const o=this._getSamplingParameters(n,!i);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,o.mag),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,o.min),i||s||r.generateMipmap(r.TEXTURE_2D),this._bindTextureDirectly(r.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,s,n,r,o,a,l=3){const h=this.getCaps().maxTextureSize,c=Math.min(h,this.needPOTTextures?q.GetExponentOfTwo(s.width,h):s.width),d=Math.min(h,this.needPOTTextures?q.GetExponentOfTwo(s.height,h):s.height),u=this._gl;u&&(e._hardwareTexture?(this._bindTextureDirectly(u.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===n||!!n),e.baseWidth=s.width,e.baseHeight=s.height,e.width=c,e.height=d,e.isReady=!0,e.type=-1!==e.type?e.type:0,e.format=-1!==e.format?e.format:".jpg"!==t||e._useSRGBBuffer?5:4,a(c,d,s,t,e,(()=>{this._prepareWebGLTextureContinuation(e,i,r,o,l)}))||this._prepareWebGLTextureContinuation(e,i,r,o,l)):i&&i.removePendingData(e))}_setupFramebufferDepthAttachments(e,t,i,s,n=1){const r=this._gl;if(e&&t)return this._createRenderBuffer(i,s,n,r.DEPTH_STENCIL,r.DEPTH24_STENCIL8,r.DEPTH_STENCIL_ATTACHMENT);if(t){let e=r.DEPTH_COMPONENT16;return this._webGLVersion>1&&(e=r.DEPTH_COMPONENT32F),this._createRenderBuffer(i,s,n,e,e,r.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(i,s,n,r.STENCIL_INDEX8,r.STENCIL_INDEX8,r.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,s,n,r,o=!0){const a=this._gl.createRenderbuffer();return this._updateRenderBuffer(a,e,t,i,s,n,r,o)}_updateRenderBuffer(e,t,i,s,n,r,o,a=!0){const l=this._gl;return l.bindRenderbuffer(l.RENDERBUFFER,e),s>1&&l.renderbufferStorageMultisample?l.renderbufferStorageMultisample(l.RENDERBUFFER,s,r,t,i):l.renderbufferStorage(l.RENDERBUFFER,n,t,i),l.framebufferRenderbuffer(l.FRAMEBUFFER,o,l.RENDERBUFFER,e),a&&l.bindRenderbuffer(l.RENDERBUFFER,null),e}_releaseTexture(e){var t;this._deleteTexture(null===(t=e._hardwareTexture)||void 0===t?void 0:t.underlyingResource),this.unbindAllTextures();const i=this._internalTexturesCache.indexOf(e);-1!==i&&this._internalTexturesCache.splice(i,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);-1!==t&&this._renderTargetWrapperCache.splice(t,1)}_deleteTexture(e){e&&this._gl.deleteTexture(e)}_setProgram(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let t=0;t<i.length;t++){const s=e.getUniform(i[t]);s&&(this._boundUniforms[t]=s)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,s=!1){var n,r;let o=!1;const a=t&&t._associatedChannel>-1;if(i&&a&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||s){if(this._activateCurrentTexture(),t&&t.isMultiview)throw p.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,null!==(r=null===(n=null==t?void 0:t._hardwareTexture)||void 0===n?void 0:n.underlyingResource)&&void 0!==r?r:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(o=!0,this._activateCurrentTexture());return a&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),o}_bindTexture(e,t,i){if(void 0===e)return;t&&(t._associatedChannel=e),this._activeChannel=e;const s=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(s,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,s){void 0!==e&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];i&&i._currentState!==t&&(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,s=!1,n=""){if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const i=t.getInternalTexture();i&&(i._associatedChannel=e),t.update()}else if(4===t.delayLoadState)return t.delayLoad(),!1;let r;r=s?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!i&&r&&(r._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===r&&(i||this._bindSamplerUniformToChannel(r._associatedChannel,e),o=!1),this._activeChannel=e;const a=this._getTextureTarget(r);if(o&&this._bindTextureDirectly(a,r,i),r&&!r.isMultiview){if(r.isCube&&r._cachedCoordinatesMode!==t.coordinatesMode){r._cachedCoordinatesMode=t.coordinatesMode;const e=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0;t.wrapU=e,t.wrapV=e}r._cachedWrapU!==t.wrapU&&(r._cachedWrapU=t.wrapU,this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),r)),r._cachedWrapV!==t.wrapV&&(r._cachedWrapV=t.wrapV,this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),r)),r.is3D&&r._cachedWrapR!==t.wrapR&&(r._cachedWrapR=t.wrapR,this._setTextureParameterInteger(a,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),r)),this._setAnisotropicLevel(a,r,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,s){if(void 0!==e&&t){this._textureUnits&&this._textureUnits.length===i.length||(this._textureUnits=new Int32Array(i.length));for(let t=0;t<i.length;t++){const s=i[t].getInternalTexture();s?(this._textureUnits[t]=e+t,s._associatedChannel=e+t):this._textureUnits[t]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let e=0;e<i.length;e++)this._setTexture(this._textureUnits[e],i[e],!0)}}_setAnisotropicLevel(e,t,i){const s=this._caps.textureAnisotropicFilterExtension;11!==t.samplingMode&&3!==t.samplingMode&&2!==t.samplingMode&&(i=1),s&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,s){this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,s){s&&this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e)}else for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}dispose(){var e,t;this._isDisposed=!0,this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),null===(e=this.releaseComputeEffects)||void 0===e||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},l()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,L.ResetCache();for(const e of this._activeRequests)e.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._creationOptions.loseContextOnDispose&&(null===(t=this._gl.getExtension("WEBGL_lose_context"))||void 0===t||t.loseContext())}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0);const r=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&r===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const e=t.RGBA,s=t.UNSIGNED_BYTE,n=new Uint8Array(4);t.readPixels(0,0,1,1,e,s,n),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(s),t.deleteFramebuffer(n),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(1===this._webGLVersion){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(1===this._webGLVersion){if(void 0!==t)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:default:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}_loadFile(e,t,i,s,n,r){const o=q._FileToolsLoadFile(e,t,i,s,n,r);return this._activeRequests.push(o),o.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),o}static _FileToolsLoadFile(e,t,i,s,n,r){throw f("FileTools")}readPixels(e,t,i,s,n=!0,r=!0){const o=n?4:3,a=n?this._gl.RGBA:this._gl.RGB,l=new Uint8Array(s*i*o);return r&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,s,a,this._gl.UNSIGNED_BYTE,l),Promise.resolve(l)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=null!=t&&!!window.WebGLRenderingContext}catch(e){this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch(e){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}static FloorPOT(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)-(e>>1)}static NearestPOT(e){const t=q.CeilingPOT(e),i=q.FloorPOT(e);return t-e>e-i?i:t}static GetExponentOfTwo(e,t,i=2){let s;switch(i){case 1:s=q.FloorPOT(e);break;case 2:s=q.NearestPOT(e);break;default:s=q.CeilingPOT(e)}return Math.min(s,t)}static QueueNewFrame(e,t){if(l()){const{requestAnimationFrame:i}=t||window;if("function"==typeof i)return i(e)}else if("function"==typeof requestAnimationFrame)return requestAnimationFrame(e);return setTimeout(e,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:c()?document:null}}q._TempClearColorUint32=new Uint32Array(4),q._TempClearColorInt32=new Int32Array(4),q.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}],q._TextureLoaders=[],q.CollisionsEpsilon=.001,q._IsSupported=null,q._HasMajorPerformanceCaveat=null;class Z{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new J(e)}sampleFrame(e=j.Now){if(this._enabled){if(null!=this._lastFrameTimeMs){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class J{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const e=this._samples[this._pos];t=e-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(e-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}class ee{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){ee.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){ee.Enabled&&(this._startMonitoringTime=j.Now)}endMonitoring(e=!0){if(!ee.Enabled)return;e&&this.fetchNewFrame();const t=j.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=j.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}ee.Enabled=!0,q.prototype.setAlphaConstants=function(e,t,i,s){this._alphaState.setAlphaBlendConstants(e,t,i,s)},q.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode!==e){switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}t||(this.depthCullingState.depthMask=0===e),this._alphaMode=e}else if(!t){const t=0===e;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}},q.prototype.getAlphaMode=function(){return this._alphaMode},q.prototype.setAlphaEquation=function(e){if(this._alphaEquation!==e){switch(e){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774)}this._alphaEquation=e}},q.prototype.getAlphaEquation=function(){return this._alphaEquation},q.prototype._readTexturePixelsSync=function(e,t,i,s=-1,n=0,r=null,o=!0,a=!1,l=0,h=0){var c,d;const u=this._gl;if(!u)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const e=u.createFramebuffer();if(!e)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=e}u.bindFramebuffer(u.FRAMEBUFFER,this._dummyFramebuffer),s>-1?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+s,null===(c=e._hardwareTexture)||void 0===c?void 0:c.underlyingResource,n):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,null===(d=e._hardwareTexture)||void 0===d?void 0:d.underlyingResource,n);let _=void 0!==e.type?this._getWebGLTextureType(e.type):u.UNSIGNED_BYTE;return a?r||(r=function(e,t,i=!1,s){switch(e){case 3:{const e=(ArrayBuffer,new Int8Array(t));return s&&e.set(new Int8Array(s)),e}case 0:{const e=(ArrayBuffer,new Uint8Array(t));return s&&e.set(new Uint8Array(s)),e}case 4:{const e=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(i?t/2:t);return s&&e.set(new Int16Array(s)),e}case 5:case 8:case 9:case 10:case 2:{const e=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(i?t/2:t);return s&&e.set(new Uint16Array(s)),e}case 6:{const e=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(i?t/4:t);return s&&e.set(new Int32Array(s)),e}case 7:case 11:case 12:case 13:case 14:case 15:{const e=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(i?t/4:t);return s&&e.set(new Uint32Array(s)),e}case 1:{const e=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(i?t/4:t);return s&&e.set(new Float32Array(s)),e}}const n=(ArrayBuffer,new Uint8Array(t));return s&&n.set(new Uint8Array(s)),n}(e.type,4*t*i)):_===u.UNSIGNED_BYTE?(r||(r=new Uint8Array(4*t*i)),_=u.UNSIGNED_BYTE):(r||(r=new Float32Array(4*t*i)),_=u.FLOAT),o&&this.flushFramebuffer(),u.readPixels(l,h,t,i,u.RGBA,_,r),u.bindFramebuffer(u.FRAMEBUFFER,this._currentFramebuffer),r},q.prototype._readTexturePixels=function(e,t,i,s=-1,n=0,r=null,o=!0,a=!1,l=0,h=0){return Promise.resolve(this._readTexturePixelsSync(e,t,i,s,n,r,o,a,l,h))},q.prototype.updateDynamicIndexBuffer=function(e,t,i=0){let s;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e),s=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,s,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},q.prototype.updateDynamicVertexBuffer=function(e,t,i,s){this.bindArrayBuffer(e),void 0===i&&(i=0);const n=t.byteLength||t.length;void 0===s||s>=n&&0===i?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(i,i+s)):(t=t instanceof ArrayBuffer?new Uint8Array(t,i,s):new Uint8Array(t.buffer,t.byteOffset+i,s),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)),this._resetVertexBufferBinding()};class te extends q{static get NpmPackage(){return q.NpmPackage}static get Version(){return q.Version}static get Instances(){return u.Instances}static get LastCreatedEngine(){return u.LastCreatedEngine}static get LastCreatedScene(){return u.LastCreatedScene}_createImageBitmapFromSource(e,t){return new Promise(((i,s)=>{const n=new Image;n.onload=()=>{n.decode().then((()=>{this.createImageBitmap(n,t).then((e=>{i(e)}))}))},n.onerror=()=>{s(`Error loading image ${n.src}`)},n.src=e}))}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){const s=this.createCanvas(t,i).getContext("2d");if(!s)throw new Error("Unable to get 2d context for resizeImageBitmap");return s.drawImage(e,0,0),s.getImageData(0,0,t,i).data}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<te.Instances.length;i++){const s=te.Instances[i];for(let i=0;i<s.scenes.length;i++)s.scenes[i].markAllMaterialsAsDirty(e,t)}}static DefaultLoadingScreenFactory(e){throw f("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!te._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(e,t,i,n=!1){if(super(e,t,i,n),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=[],this._virtualScenes=new Array,this.onNewSceneAddedObservable=new s,this.postProcesses=[],this.isPointerLock=!1,this.onResizeObservable=new s,this.onCanvasBlurObservable=new s,this.onCanvasFocusObservable=new s,this.onCanvasPointerOutObservable=new s,this.onBeginFrameObservable=new s,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new s,this.onBeforeShaderCompilationObservable=new s,this.onAfterShaderCompilationObservable=new s,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new ee,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new Z,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],te.Instances.push(this),e&&(this._features.supportRenderPasses=!0,i=this._creationOptions,e.getContext)){const t=e;this._sharedInit(t)}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=e=>{this.disableContextMenu&&e.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=t=>{document.elementFromPoint(t.clientX,t.clientY)!==e&&this.onCanvasPointerOutObservable.notifyObservers(t)};const t=this.getHostWindow();t&&"function"==typeof t.addEventListener&&(t.addEventListener("blur",this._onBlur),t.addEventListener("focus",this._onFocus)),e.addEventListener("pointerout",this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!te.audioEngine&&this._creationOptions.audioEngine&&te.AudioEngineFactory&&(te.audioEngine=te.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),c()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&e&&te._RequestPointerlock(e)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)),this.enableOfflineSupport=void 0!==te.OfflineProviderFactory,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}_verifyPointerLock(){var e;null===(e=this._onPointerLockChange)||void 0===e||e.call(this)}getAspectRatio(e,t=!1){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return 1e3*this._timeStep}generateMipMapsForCubemap(e,t=!0){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,t,i,s){const n=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,s),n}scissorClear(e,t,i,s,n){this.enableScissor(e,t,i,s),this.clear(n,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,s){const n=this._gl;n.enable(n.SCISSOR_TEST),n.scissor(e,t,i,s)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}_loadFileAsync(e,t,i){return new Promise(((s,n)=>{this._loadFile(e,(e=>{s(e)}),void 0,t,i,((e,t)=>{n(t)}))}))}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}setDepthStencilTexture(e,t,i,s){void 0!==e&&(t&&(this._boundUniforms[e]=t),i&&i.depthStencilTexture?this._setTexture(e,i,!1,!0,s):this._setTexture(e,null,void 0,void 0,s))}setTextureFromPostProcess(e,t,i){var s;let n=null;t&&(t._forcedOutputTexture?n=t._forcedOutputTexture:t._textures.data[t._currentRenderTextureInd]&&(n=t._textures.data[t._currentRenderTextureInd])),this._bindTexture(e,null!==(s=null==n?void 0:n.texture)&&void 0!==s?s:null,i)}setTextureFromPostProcessOutput(e,t,i){var s,n;this._bindTexture(e,null!==(n=null===(s=null==t?void 0:t._outputTexture)||void 0===s?void 0:s.texture)&&void 0!==n?n:null,i)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++)(0,this._activeRenderLoops[e])()}_cancelFrame(){if(this._renderingQueueLaunched&&this.customAnimationFrameRequester){this._renderingQueueLaunched=!1;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}else super._cancelFrame()}_renderLoop(){if(!this._contextWasLost){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&te._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&te._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&te._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){te._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this.onEndFrameObservable.notifyObservers(this)}setSize(e,t,i=!1){if(!this._renderingCanvas)return!1;if(!super.setSize(e,t,i))return!1;if(this.scenes){for(let e=0;e<this.scenes.length;e++){const t=this.scenes[e];for(let e=0;e<t.cameras.length;e++)t.cameras[e]._currentRenderId=0}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,s,n,r=null){n=n||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const o=super.createShaderProgram(e,t,i,s,n,r);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}_createShaderProgram(e,t,i,s,n=null){const r=s.createProgram();if(e.program=r,!r)throw new Error("Unable to create program");if(s.attachShader(r,t),s.attachShader(r,i),this.webGLVersion>1&&n){const t=this.createTransformFeedback();this.bindTransformFeedback(t),this.setTranformFeedbackVaryings(r,n),e.transformFeedback=t}return s.linkProgram(r),this.webGLVersion>1&&n&&this.bindTransformFeedback(null),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),r}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach((t=>{t.postProcesses.forEach((t=>{t._outputTexture===e&&(t._outputTexture=null)})),t.cameras.forEach((t=>{t._postProcesses.forEach((t=>{t&&t._outputTexture===e&&(t._outputTexture=null)}))}))}))}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(e){const t=++te._RenderPassIdCounter;return this._renderPassNames[t]=null!=e?e:"NONAME",t}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let t=0;t<i.meshes.length;++t){const s=i.meshes[t];if(s.subMeshes)for(let t=0;t<s.subMeshes.length;++t)s.subMeshes[t]._removeDrawWrapper(e)}}}_rescaleTexture(e,t,i,s,n){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const r=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&te._RescalePostProcessFactory&&(this._rescalePostProcess=te._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled((()=>{this._rescalePostProcess.onApply=function(t){t._bindTexture("textureSampler",e)};let o=i;o||(o=this.scenes[this.scenes.length-1]),o.postProcessManager.directRender([this._rescalePostProcess],r,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,s,0,0,t.width,t.height,0),this.unBindFramebuffer(r),r.dispose(),n&&n()})))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e,t=!1,i=3,s=0,n=0){const o=new Q(e,this._gl),l=new a(this,r.Unknown,!0);return l._hardwareTexture=o,l.baseWidth=s,l.baseHeight=n,l.width=s,l.height=n,l.isReady=!0,l.useMipMaps=t,this.updateTextureSamplingMode(i,l),l}_uploadImageToTexture(e,t,i=0,s=0){const n=this._gl,r=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),a=this._getRGBABufferInternalSizedFormat(e.type,o),l=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(l,e,!0),this._unpackFlipY(e.invertY);let h=n.TEXTURE_2D;e.isCube&&(h=n.TEXTURE_CUBE_MAP_POSITIVE_X+i),n.texImage2D(h,s,a,o,r,t),this._bindTextureDirectly(l,null,!0)}updateTextureComparisonFunction(e,t){if(1===this.webGLVersion)return void p.Error("WebGL 1 does not support texture comparison.");const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),0===t?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),0===t?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new H(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const s=this._gl;return new Promise(((n,r)=>{const o=()=>{const a=s.clientWaitSync(e,t,0);a!=s.WAIT_FAILED?a!=s.TIMEOUT_EXPIRED?n():setTimeout(o,i):r()};o()}))}_readPixelsAsync(e,t,i,s,n,r,o){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const a=this._gl,l=a.createBuffer();a.bindBuffer(a.PIXEL_PACK_BUFFER,l),a.bufferData(a.PIXEL_PACK_BUFFER,o.byteLength,a.STREAM_READ),a.readPixels(e,t,i,s,n,r,0),a.bindBuffer(a.PIXEL_PACK_BUFFER,null);const h=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);return h?(a.flush(),this._clientWaitAsync(h,0,10).then((()=>(a.deleteSync(h),a.bindBuffer(a.PIXEL_PACK_BUFFER,l),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,o),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),a.deleteBuffer(l),o)))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();1===u.Instances.length&&te.audioEngine&&(te.audioEngine.dispose(),te.audioEngine=null);const e=this.getHostWindow();e&&"function"==typeof e.removeEventListener&&(e.removeEventListener("blur",this._onBlur),e.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),c()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();const t=u.Instances.indexOf(this);t>=0&&u.Instances.splice(t,1),te.Instances.length||u.OnEnginesDisposedObservable.notifyObservers(this),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){this._renderingCanvas&&this._renderingCanvas.setAttribute&&(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!l())return;const e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!l())return;const e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=te.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement("video")}static _RequestPointerlock(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then((()=>{e.focus()})).catch((()=>{})):e.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}static _ExitFullscreen(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){const t=document.createElement("span");t.innerHTML="Hg",t.setAttribute("style",`font: ${e} !important`);const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const s=document.createElement("div");s.style.whiteSpace="nowrap",s.appendChild(t),s.appendChild(i),document.body.appendChild(s);let n=0,r=0;try{r=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",n=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(s)}return{ascent:n,height:r,descent:r-n}}}te.ALPHA_DISABLE=0,te.ALPHA_ADD=1,te.ALPHA_COMBINE=2,te.ALPHA_SUBTRACT=3,te.ALPHA_MULTIPLY=4,te.ALPHA_MAXIMIZED=5,te.ALPHA_ONEONE=6,te.ALPHA_PREMULTIPLIED=7,te.ALPHA_PREMULTIPLIED_PORTERDUFF=8,te.ALPHA_INTERPOLATE=9,te.ALPHA_SCREENMODE=10,te.DELAYLOADSTATE_NONE=0,te.DELAYLOADSTATE_LOADED=1,te.DELAYLOADSTATE_LOADING=2,te.DELAYLOADSTATE_NOTLOADED=4,te.NEVER=512,te.ALWAYS=519,te.LESS=513,te.EQUAL=514,te.LEQUAL=515,te.GREATER=516,te.GEQUAL=518,te.NOTEQUAL=517,te.KEEP=7680,te.REPLACE=7681,te.INCR=7682,te.DECR=7683,te.INVERT=5386,te.INCR_WRAP=34055,te.DECR_WRAP=34056,te.TEXTURE_CLAMP_ADDRESSMODE=0,te.TEXTURE_WRAP_ADDRESSMODE=1,te.TEXTURE_MIRROR_ADDRESSMODE=2,te.TEXTUREFORMAT_ALPHA=0,te.TEXTUREFORMAT_LUMINANCE=1,te.TEXTUREFORMAT_LUMINANCE_ALPHA=2,te.TEXTUREFORMAT_RGB=4,te.TEXTUREFORMAT_RGBA=5,te.TEXTUREFORMAT_RED=6,te.TEXTUREFORMAT_R=6,te.TEXTUREFORMAT_RG=7,te.TEXTUREFORMAT_RED_INTEGER=8,te.TEXTUREFORMAT_R_INTEGER=8,te.TEXTUREFORMAT_RG_INTEGER=9,te.TEXTUREFORMAT_RGB_INTEGER=10,te.TEXTUREFORMAT_RGBA_INTEGER=11,te.TEXTURETYPE_UNSIGNED_BYTE=0,te.TEXTURETYPE_UNSIGNED_INT=0,te.TEXTURETYPE_FLOAT=1,te.TEXTURETYPE_HALF_FLOAT=2,te.TEXTURETYPE_BYTE=3,te.TEXTURETYPE_SHORT=4,te.TEXTURETYPE_UNSIGNED_SHORT=5,te.TEXTURETYPE_INT=6,te.TEXTURETYPE_UNSIGNED_INTEGER=7,te.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,te.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,te.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,te.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,te.TEXTURETYPE_UNSIGNED_INT_24_8=12,te.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,te.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,te.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,te.TEXTURE_NEAREST_SAMPLINGMODE=1,te.TEXTURE_BILINEAR_SAMPLINGMODE=2,te.TEXTURE_TRILINEAR_SAMPLINGMODE=3,te.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,te.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,te.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,te.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,te.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,te.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,te.TEXTURE_NEAREST_LINEAR=7,te.TEXTURE_NEAREST_NEAREST=1,te.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,te.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,te.TEXTURE_LINEAR_LINEAR=2,te.TEXTURE_LINEAR_NEAREST=12,te.TEXTURE_EXPLICIT_MODE=0,te.TEXTURE_SPHERICAL_MODE=1,te.TEXTURE_PLANAR_MODE=2,te.TEXTURE_CUBIC_MODE=3,te.TEXTURE_PROJECTION_MODE=4,te.TEXTURE_SKYBOX_MODE=5,te.TEXTURE_INVCUBIC_MODE=6,te.TEXTURE_EQUIRECTANGULAR_MODE=7,te.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,te.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,te.SCALEMODE_FLOOR=1,te.SCALEMODE_NEAREST=2,te.SCALEMODE_CEILING=3,te._RescalePostProcessFactory=null,te._RenderPassIdCounter=0;class ie{_canvas;_engine;_scene;_onTick;constructor(e){this._canvas=e.canvas,this._engine=e.engine,this._scene=null,this._onTick=null}static async Create(e){const t=new ie(e);return t._scene=await t._initialize(e.sceneBuilder),t._onTick=t._makeOnTick(),t}run(){const e=this._engine;window.addEventListener("resize",this._onResize),e.runRenderLoop(this._onTick)}dispose(){window.removeEventListener("resize",this._onResize),this._engine.dispose()}_onResize=()=>{this._engine.resize()};async _initialize(e){return await e.build(this._canvas,this._engine)}_makeOnTick(){const e=this._scene;return()=>e.render()}}class se{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._resizeLoadingUI=()=>{const e=this._renderingCanvas.getBoundingClientRect(),t=window.getComputedStyle(this._renderingCanvas).position;this._loadingDiv&&(this._loadingDiv.style.position="fixed"===t?"fixed":"absolute",this._loadingDiv.style.left=e.left+"px",this._loadingDiv.style.top=e.top+"px",this._loadingDiv.style.width=e.width+"px",this._loadingDiv.style.height=e.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css",this._style.innerHTML="@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}\n                    100% { -webkit-transform: rotate(360deg);}\n                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}\n                    100% { transform: rotate(360deg);}\n                }",document.getElementsByTagName("head")[0].appendChild(this._style);const e=!!window.SVGSVGElement,t=new Image;se.DefaultLogoUrl?t.src=se.DefaultLogoUrl:t.src=e?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",t.style.width="150px",t.style.gridColumn="1",t.style.gridRow="1",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.position="absolute";const i=document.createElement("div");i.style.width="300px",i.style.gridColumn="1",i.style.gridRow="1",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.position="absolute";const s=new Image;if(se.DefaultSpinnerUrl?s.src=se.DefaultSpinnerUrl:s.src=e?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",s.style.animation="spin1 0.75s infinite linear",s.style.webkitAnimation="spin1 0.75s infinite linear",s.style.transformOrigin="50% 50%",s.style.webkitTransformOrigin="50% 50%",!e){const e={w:16,h:18.5},i={w:30,h:30};t.style.width=`${e.w}vh`,t.style.height=`${e.h}vh`,t.style.left=`calc(50% - ${e.w/2}vh)`,t.style.top=`calc(50% - ${e.h/2}vh)`,s.style.width=`${i.w}vh`,s.style.height=`${i.h}vh`,s.style.left=`calc(50% - ${i.w/2}vh)`,s.style.top=`calc(50% - ${i.h/2}vh)`}i.appendChild(s),this._loadingDiv.appendChild(t),this._loadingDiv.appendChild(i),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){this._loadingDiv&&(this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",(()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)})))}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}se.DefaultLogoUrl="",se.DefaultSpinnerUrl="",te.DefaultLoadingScreenFactory=e=>new se(e);class ne{static WithinEpsilon(e,t,i=1401298e-51){return Math.abs(e-t)<=i}static ToHex(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}static Sign(e){return 0==(e=+e)||isNaN(e)?e:e>0?1:-1}static Clamp(e,t=0,i=1){return Math.min(i,Math.max(t,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(0===e)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e*=2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}static Repeat(e,t){return e-Math.floor(e/t)*t}static Normalize(e,t,i){return(e-t)/(i-t)}static Denormalize(e,t,i){return e*(i-t)+t}static DeltaAngle(e,t){let i=ne.Repeat(t-e,360);return i>180&&(i-=360),i}static PingPong(e,t){const i=ne.Repeat(e,2*t);return t-Math.abs(i-t)}static SmoothStep(e,t,i){let s=ne.Clamp(i);return s=-2*s*s*s+3*s*s,t*s+e*(1-s)}static MoveTowards(e,t,i){let s=0;return s=Math.abs(t-e)<=i?t:e+ne.Sign(t-e)*i,s}static MoveTowardsAngle(e,t,i){const s=ne.DeltaAngle(e,t);let n=0;return-i<s&&s<i?n=t:(t=e+s,n=ne.MoveTowards(e,t,i)),n}static Lerp(e,t,i){return e+(t-e)*i}static LerpAngle(e,t,i){let s=ne.Repeat(t-e,360);return s>180&&(s-=360),e+s*ne.Clamp(i)}static InverseLerp(e,t,i){let s=0;return s=e!=t?ne.Clamp((i-e)/(t-e)):0,s}static Hermite(e,t,i,s,n){const r=n*n,o=n*r;return e*(2*o-3*r+1)+i*(-2*o+3*r)+t*(o-2*r+n)+s*(o-r)}static Hermite1stDerivative(e,t,i,s,n){const r=n*n;return 6*(r-n)*e+(3*r-4*n+1)*t+6*(-r+n)*i+(3*r-2*n)*s}static RandomRange(e,t){return e===t?e:Math.random()*(t-e)+e}static RangeToPercent(e,t,i){return(e-t)/(i-t)}static PercentToRange(e,t,i){return(i-t)*e+t}static NormalizeRadians(e){return e-ne.TwoPi*Math.floor((e+Math.PI)/ne.TwoPi)}static HCF(e,t){const i=e%t;return 0===i?t:ne.HCF(t,i)}}ne.TwoPi=2*Math.PI;const re=1/2.2,oe=2.2,ae=(Math.sqrt(5),.001);class le{static BuildArray(e,t){const i=[];for(let s=0;s<e;++s)i.push(t());return i}static BuildTuple(e,t){return le.BuildArray(e,t)}}const he=["push","splice","pop","shift","unshift"];function ce(e,t){const i=he.map((i=>function(e,t,i){const s=e[t];if("function"!=typeof s)return null;const n=function(){const s=e.length,r=n.previous.apply(e,arguments);return i(t,s),r};return s.next=n,n.previous=s,e[t]=n,()=>{const i=n.previous;if(!i)return;const s=n.next;s?(i.next=s,s.previous=i):(i.next=void 0,e[t]=i),n.next=void 0,n.previous=void 0}}(e,i,t)));return()=>{i.forEach((e=>{null==e||e()}))}}const de={};function ue(e,t){de[e]=t}function _e(e){return de[e]}const fe=e=>parseInt(e.toString().replace(/\W/g,""));class pe{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){let e=fe(this.x);return e=397*e^fe(this.y),e}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return pe.FromArrayToRef(e,t,this),this}asArray(){const e=[];return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new this.constructor(this.x+e.x,this.y+e.y)}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new this.constructor(this.x*e,this.y*t)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(-1*this.x,-1*this.y)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){const t=new this.constructor(0,0);return this.scaleToRef(e,t),t}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=ae){return e&&ne.WithinEpsilon(this.x,e.x,t)&&ne.WithinEpsilon(this.y,e.y,t)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,t){const i=Math.cos(e),s=Math.sin(e),n=i*this.x-s*this.y,r=s*this.x+i*this.y;return t.x=n,t.y=r,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this.x,this.y):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this.x,this.y)}dot(e){return this.x*e.x+this.y*e.y}static Zero(){return new pe(0,0)}static One(){return new pe(1,1)}static Random(e=0,t=1){return new pe(ne.RandomRange(e,t),ne.RandomRange(e,t))}static get ZeroReadOnly(){return pe._ZeroReadOnly}static FromArray(e,t=0){return new pe(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static CatmullRom(e,t,i,s,n){const r=n*n,o=n*r,a=.5*(2*t.x+(-e.x+i.x)*n+(2*e.x-5*t.x+4*i.x-s.x)*r+(-e.x+3*t.x-3*i.x+s.x)*o),l=.5*(2*t.y+(-e.y+i.y)*n+(2*e.y-5*t.y+4*i.y-s.y)*r+(-e.y+3*t.y-3*i.y+s.y)*o);return new e.constructor(a,l)}static Clamp(e,t,i){let s=e.x;s=s>i.x?i.x:s,s=s<t.x?t.x:s;let n=e.y;return n=n>i.y?i.y:n,n=n<t.y?t.y:n,new e.constructor(s,n)}static Hermite(e,t,i,s,n){const r=n*n,o=n*r,a=2*o-3*r+1,l=-2*o+3*r,h=o-2*r+n,c=o-r,d=e.x*a+i.x*l+t.x*h+s.x*c,u=e.y*a+i.y*l+t.y*h+s.y*c;return new e.constructor(d,u)}static Hermite1stDerivative(e,t,i,s,n){const r=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,n,r),r}static Hermite1stDerivativeToRef(e,t,i,s,n,r){const o=n*n;return r.x=6*(o-n)*e.x+(3*o-4*n+1)*t.x+6*(-o+n)*i.x+(3*o-2*n)*s.x,r.y=6*(o-n)*e.y+(3*o-4*n+1)*t.y+6*(-o+n)*i.y+(3*o-2*n)*s.y,r}static Lerp(e,t,i){const s=e.x+(t.x-e.x)*i,n=e.y+(t.y-e.y)*i;return new e.constructor(s,n)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=new e.constructor;return pe.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,s=e.y<t.y?e.y:t.y;return new e.constructor(i,s)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,s=e.y>t.y?e.y:t.y;return new e.constructor(i,s)}static Transform(e,t){const i=new e.constructor;return pe.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){const s=t.m,n=e.x*s[0]+e.y*s[4]+s[12],r=e.x*s[1]+e.y*s[5]+s[13];return i.x=n,i.y=r,i}static PointInTriangle(e,t,i,s){const n=.5*(-i.y*s.x+t.y*(-i.x+s.x)+t.x*(i.y-s.y)+i.x*s.y),r=n<0?-1:1,o=(t.y*s.x-t.x*s.y+(s.y-t.y)*e.x+(t.x-s.x)*e.y)*r,a=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*r;return o>0&&a>0&&o+a<2*n*r}static Distance(e,t){return Math.sqrt(pe.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y;return i*i+s*s}static Center(e,t){const i=new e.constructor;return pe.CenterToRef(e,t,i)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const s=pe.DistanceSquared(t,i);if(0===s)return pe.Distance(e,t);const n=i.subtract(t),r=Math.max(0,Math.min(1,pe.Dot(e.subtract(t),n)/s)),o=t.add(n.multiplyByFloats(r,r));return pe.Distance(e,o)}}pe._ZeroReadOnly=pe.Zero();class me{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){let e=fe(this._x);return e=397*e^fe(this._y),e=397*e^fe(this._z),e}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return me.FromArrayToRef(e,t,this),this}toQuaternion(){return ve.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new this.constructor(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,s){return s.copyFromFloats(this._x-e,this._y-t,this._z-i)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(-1*this._x,-1*this._y,-1*this._z)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const s=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const n=t*Math.sin(i)*Math.cos(s),r=t*Math.cos(i),o=t*Math.sin(i)*Math.sin(s);return e.set(n,r,o),e}applyRotationQuaternionToRef(e,t){const i=this._x,s=this._y,n=this._z,r=e._x,o=e._y,a=e._z,l=e._w,h=2*(o*n-a*s),c=2*(a*i-r*n),d=2*(r*s-o*i);return t._x=i+l*h+o*d-a*c,t._y=s+l*c+a*h-r*d,t._z=n+l*d+r*c-o*h,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){const i=new this.constructor;return this.projectOnPlaneToRef(e,t,i),i}projectOnPlaneToRef(e,t,i){const s=e.normal,n=e.d,r=be.Vector3[0];this.subtractToRef(t,r),r.normalize();const o=me.Dot(r,s);if(Math.abs(o)<1e-10)i.setAll(1/0);else{const e=-(me.Dot(t,s)+n)/o,a=r.scaleInPlace(e);t.addToRef(a,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=ae){return e&&ne.WithinEpsilon(this._x,e._x,t)&&ne.WithinEpsilon(this._y,e._y,t)&&ne.WithinEpsilon(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,i){return new this.constructor(this._x*e,this._y*t,this._z*i)}divide(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!ne.WithinEpsilon(t,i,e))return!0;const s=Math.abs(this._z);return!ne.WithinEpsilon(t,s,e)||!ne.WithinEpsilon(i,s,e)}get isNonUniform(){const e=Math.abs(this._x);return e!==Math.abs(this._y)||e!==Math.abs(this._z)}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z==0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){if("xyz"===(e=e.toLowerCase()))return this;const t=be.Vector3[0].copyFrom(this);return this.x=t[e[0]],this.y=t[e[1]],this.z=t[e[2]],this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(be.Matrix[0]),me.TransformCoordinatesToRef(this,be.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,be.Vector3[0]),be.Vector3[0].rotateByQuaternionToRef(e,be.Vector3[0]),t.addToRef(be.Vector3[0],i),i}cross(e){const t=new this.constructor;return me.CrossToRef(this,e,t)}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,s){const n=me.Dot(e,i);return(n-s)/(n-me.Dot(t,i))}static GetAngleBetweenVectors(e,t,i){const s=e.normalizeToRef(be.Vector3[1]),n=t.normalizeToRef(be.Vector3[2]);let r=me.Dot(s,n);r=ne.Clamp(r,-1,1);const o=Math.acos(r),a=be.Vector3[3];return me.CrossToRef(s,n,a),me.Dot(a,i)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(r)}static GetAngleBetweenVectorsOnPlane(e,t,i){be.Vector3[0].copyFrom(e);const s=be.Vector3[0];be.Vector3[1].copyFrom(t);const n=be.Vector3[1];be.Vector3[2].copyFrom(i);const r=be.Vector3[2],o=be.Vector3[3],a=be.Vector3[4];s.normalize(),n.normalize(),r.normalize(),me.CrossToRef(r,s,o),me.CrossToRef(o,r,a);const l=Math.atan2(me.Dot(n,o),me.Dot(n,a));return ne.NormalizeRadians(l)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const s=Ee.Vector3[0];return t.subtractToRef(e,s),i._y=Math.atan2(s.x,s.z)||0,i._x=Math.atan2(Math.sqrt(s.x**2+s.z**2),s.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=me.Zero();return me.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,s){i=ne.Clamp(i,0,1);const n=be.Vector3[0],r=be.Vector3[1];n.copyFrom(e);const o=n.length();n.normalizeFromLength(o),r.copyFrom(t);const a=r.length();r.normalizeFromLength(a);const l=me.Dot(n,r);let h,c;if(l<1-ae){const e=Math.acos(l),t=1/Math.sin(e);h=Math.sin((1-i)*e)*t,c=Math.sin(i*e)*t}else h=1-i,c=i;return n.scaleInPlace(h),r.scaleInPlace(c),s.copyFrom(n).addInPlace(r),s.scaleInPlace(ne.Lerp(o,a,i)),s}static SmoothToRef(e,t,i,s,n){return me.SlerpToRef(e,t,0===s?1:i/s,n),n}static FromArray(e,t=0){return new me(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return me.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return me.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,s){return s.copyFromFloats(e,t,i),s}static Zero(){return new me(0,0,0)}static One(){return new me(1,1,1)}static Up(){return new me(0,1,0)}static get UpReadOnly(){return me._UpReadOnly}static get DownReadOnly(){return me._DownReadOnly}static get RightReadOnly(){return me._RightReadOnly}static get LeftReadOnly(){return me._LeftReadOnly}static get LeftHandedForwardReadOnly(){return me._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return me._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return me._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return me._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return me._ZeroReadOnly}static get OneReadOnly(){return me._OneReadOnly}static Down(){return new me(0,-1,0)}static Forward(e=!1){return new me(0,0,e?-1:1)}static Backward(e=!1){return new me(0,0,e?1:-1)}static Right(){return new me(1,0,0)}static Left(){return new me(-1,0,0)}static Random(e=0,t=1){return new me(ne.RandomRange(e,t),ne.RandomRange(e,t),ne.RandomRange(e,t))}static TransformCoordinates(e,t){const i=me.Zero();return me.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return me.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,n){const r=s.m,o=e*r[0]+t*r[4]+i*r[8]+r[12],a=e*r[1]+t*r[5]+i*r[9]+r[13],l=e*r[2]+t*r[6]+i*r[10]+r[14],h=1/(e*r[3]+t*r[7]+i*r[11]+r[15]);return n._x=o*h,n._y=a*h,n._z=l*h,n._isDirty=!0,n}static TransformNormal(e,t){const i=me.Zero();return me.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,s,n){const r=s.m;return n._x=e*r[0]+t*r[4]+i*r[8],n._y=e*r[1]+t*r[5]+i*r[9],n._z=e*r[2]+t*r[6]+i*r[10],n._isDirty=!0,n}static CatmullRom(e,t,i,s,n){const r=n*n,o=n*r,a=.5*(2*t._x+(-e._x+i._x)*n+(2*e._x-5*t._x+4*i._x-s._x)*r+(-e._x+3*t._x-3*i._x+s._x)*o),l=.5*(2*t._y+(-e._y+i._y)*n+(2*e._y-5*t._y+4*i._y-s._y)*r+(-e._y+3*t._y-3*i._y+s._y)*o),h=.5*(2*t._z+(-e._z+i._z)*n+(2*e._z-5*t._z+4*i._z-s._z)*r+(-e._z+3*t._z-3*i._z+s._z)*o);return new e.constructor(a,l,h)}static Clamp(e,t,i){const s=new e.constructor;return me.ClampToRef(e,t,i,s),s}static ClampToRef(e,t,i,s){let n=e._x;n=n>i._x?i._x:n,n=n<t._x?t._x:n;let r=e._y;r=r>i._y?i._y:r,r=r<t._y?t._y:r;let o=e._z;return o=o>i._z?i._z:o,o=o<t._z?t._z:o,s.copyFromFloats(n,r,o),s}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,s,n){const r=n*n,o=n*r,a=2*o-3*r+1,l=-2*o+3*r,h=o-2*r+n,c=o-r,d=e._x*a+i._x*l+t._x*h+s._x*c,u=e._y*a+i._y*l+t._y*h+s._y*c,_=e._z*a+i._z*l+t._z*h+s._z*c;return new e.constructor(d,u,_)}static Hermite1stDerivative(e,t,i,s,n){const r=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,n,r),r}static Hermite1stDerivativeToRef(e,t,i,s,n,r){const o=n*n;return r._x=6*(o-n)*e._x+(3*o-4*n+1)*t._x+6*(-o+n)*i._x+(3*o-2*n)*s._x,r._y=6*(o-n)*e._y+(3*o-4*n+1)*t._y+6*(-o+n)*i._y+(3*o-2*n)*s._y,r._z=6*(o-n)*e._z+(3*o-4*n+1)*t._z+6*(-o+n)*i._z+(3*o-2*n)*s._z,r._isDirty=!0,r}static Lerp(e,t,i){const s=new e.constructor(0,0,0);return me.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){return s._x=e._x+(t._x-e._x)*i,s._y=e._y+(t._y-e._y)*i,s._z=e._z+(t._z-e._z)*i,s._isDirty=!0,s}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z}static Cross(e,t){const i=new e.constructor;return me.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const s=e._y*t._z-e._z*t._y,n=e._z*t._x-e._x*t._z,r=e._x*t._y-e._y*t._x;return i.copyFromFloats(s,n,r),i}static Normalize(e){const t=me.Zero();return me.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,s){const n=new e.constructor;return me.ProjectToRef(e,t,i,s,n),n}static ProjectToRef(e,t,i,s,n){const r=s.width,o=s.height,a=s.x,l=s.y,h=be.Matrix[1];Te.FromValuesToRef(r/2,0,0,0,0,-o/2,0,0,0,0,.5,0,a+r/2,o/2+l,.5,1,h);const c=be.Matrix[0];return t.multiplyToRef(i,c),c.multiplyToRef(h,c),me.TransformCoordinatesToRef(e,c,n),n}static Reflect(e,t){return this.ReflectToRef(e,t,new me)}static ReflectToRef(e,t,i){const s=Ee.Vector3[0];return s.copyFrom(t).scaleInPlace(2*me.Dot(e,t)),i.copyFrom(e).subtractInPlace(s)}static _UnprojectFromInvertedMatrixToRef(e,t,i){me.TransformCoordinatesToRef(e,t,i);const s=t.m,n=e._x*s[3]+e._y*s[7]+e._z*s[11]+s[15];return ne.WithinEpsilon(n,1)&&i.scaleInPlace(1/n),i}static UnprojectFromTransform(e,t,i,s,n){return this.Unproject(e,t,i,s,n,Te.IdentityReadOnly)}static Unproject(e,t,i,s,n,r){const o=new e.constructor;return me.UnprojectToRef(e,t,i,s,n,r,o),o}static UnprojectToRef(e,t,i,s,n,r,o){return me.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,s,n,r,o),o}static UnprojectFloatsToRef(e,t,i,s,n,r,o,a,l){var h;const c=be.Matrix[0];r.multiplyToRef(o,c),c.multiplyToRef(a,c),c.invert();const d=be.Vector3[0];return d.x=e/s*2-1,d.y=-(t/n*2-1),(null===(h=u.LastCreatedEngine)||void 0===h?void 0:h.isNDCHalfZRange)?d.z=i:d.z=2*i-1,me._UnprojectFromInvertedMatrixToRef(d,c,l),l}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(me.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,s=e._y-t._y,n=e._z-t._z;return i*i+s*s+n*n}static ProjectOnTriangleToRef(e,t,i,s,n){const r=be.Vector3[0],o=be.Vector3[1],a=be.Vector3[2],l=be.Vector3[3],h=be.Vector3[4];i.subtractToRef(t,r),s.subtractToRef(t,o),s.subtractToRef(i,a);const c=r.length(),d=o.length(),u=a.length();if(c<ae||d<ae||u<ae)return n.copyFrom(t),me.Distance(e,t);e.subtractToRef(t,h),me.CrossToRef(r,o,l);const _=l.length();if(_<ae)return n.copyFrom(t),me.Distance(e,t);l.normalizeFromLength(_);let f=h.length();if(f<ae)return n.copyFrom(t),0;h.normalizeFromLength(f);const p=me.Dot(l,h),m=be.Vector3[5],g=be.Vector3[6];m.copyFrom(l).scaleInPlace(-f*p),g.copyFrom(e).addInPlace(m);const v=be.Vector3[4],T=be.Vector3[5],b=be.Vector3[7],E=be.Vector3[8];v.copyFrom(r).scaleInPlace(1/c),E.copyFrom(o).scaleInPlace(1/d),v.addInPlace(E).scaleInPlace(-1),T.copyFrom(r).scaleInPlace(-1/c),E.copyFrom(a).scaleInPlace(1/u),T.addInPlace(E).scaleInPlace(-1),b.copyFrom(a).scaleInPlace(-1/u),E.copyFrom(o).scaleInPlace(-1/d),b.addInPlace(E).scaleInPlace(-1);const S=be.Vector3[9];let x;S.copyFrom(g).subtractInPlace(t),me.CrossToRef(v,S,E),x=me.Dot(E,l);const C=x;S.copyFrom(g).subtractInPlace(i),me.CrossToRef(T,S,E),x=me.Dot(E,l);const y=x;S.copyFrom(g).subtractInPlace(s),me.CrossToRef(b,S,E),x=me.Dot(E,l);const A=x,R=be.Vector3[10];let I,P;C>0&&y<0?(R.copyFrom(r),I=t,P=i):y>0&&A<0?(R.copyFrom(a),I=i,P=s):(R.copyFrom(o).scaleInPlace(-1),I=s,P=t);const M=be.Vector3[9],O=be.Vector3[4];if(I.subtractToRef(g,E),P.subtractToRef(g,M),me.CrossToRef(E,M,O),!(me.Dot(O,l)<0))return n.copyFrom(g),Math.abs(f*p);const D=be.Vector3[5];me.CrossToRef(R,O,D),D.normalize();const N=be.Vector3[9];N.copyFrom(I).subtractInPlace(g);const F=N.length();if(F<ae)return n.copyFrom(I),me.Distance(e,I);N.normalizeFromLength(F);const L=me.Dot(D,N),w=be.Vector3[7];w.copyFrom(g).addInPlace(D.scaleInPlace(F*L)),E.copyFrom(w).subtractInPlace(I),f=R.length(),R.normalizeFromLength(f);let B=me.Dot(E,R)/Math.max(f,ae);return B=ne.Clamp(B,0,1),w.copyFrom(I).addInPlace(R.scaleInPlace(B*f)),n.copyFrom(w),me.Distance(e,w)}static Center(e,t){return me.CenterToRef(e,t,me.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const s=new e.constructor;return me.RotationFromAxisToRef(e,t,i,s),s}static RotationFromAxisToRef(e,t,i,s){const n=be.Quaternion[0];return ve.RotationQuaternionFromAxisToRef(e,t,i,n),n.toEulerAnglesToRef(s),s}}me._UpReadOnly=me.Up(),me._DownReadOnly=me.Down(),me._LeftHandedForwardReadOnly=me.Forward(!1),me._RightHandedForwardReadOnly=me.Forward(!0),me._LeftHandedBackwardReadOnly=me.Backward(!1),me._RightHandedBackwardReadOnly=me.Backward(!0),me._RightReadOnly=me.Right(),me._LeftReadOnly=me.Left(),me._ZeroReadOnly=me.Zero(),me._OneReadOnly=me.One();class ge{constructor(e=0,t=0,i=0,s=0){this.x=e,this.y=t,this.z=i,this.w=s}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){let e=fe(this.x);return e=397*e^fe(this.y),e=397*e^fe(this.z),e=397*e^fe(this.w),e}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t){return void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return ge.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,s){return new this.constructor(this.x-e,this.y-t,this.z-i,this.w-s)}subtractFromFloatsToRef(e,t,i,s,n){return n.x=this.x-e,n.y=this.y-t,n.z=this.z-i,n.w=this.w-s,n}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(-1*this.x,-1*this.y,-1*this.z,-1*this.w)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=ae){return e&&ne.WithinEpsilon(this.x,e.x,t)&&ne.WithinEpsilon(this.y,e.y,t)&&ne.WithinEpsilon(this.z,e.z,t)&&ne.WithinEpsilon(this.w,e.w,t)}equalsToFloats(e,t,i,s){return this.x===e&&this.y===t&&this.z===i&&this.w===s}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,s){return new this.constructor(this.x*e,this.y*t,this.z*i,this.w*s)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this.x,this.y,this.z,this.w):this.scaleToRef(1/t,e)}toVector3(){return new me(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.x=this.y=this.z=this.w=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}static FromArray(e,t){return t||(t=0),new ge(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return ge.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,s,n){return n.x=e,n.y=t,n.z=i,n.w=s,n}static Zero(){return new ge(0,0,0,0)}static One(){return new ge(1,1,1,1)}static Random(e=0,t=1){return new ge(ne.RandomRange(e,t),ne.RandomRange(e,t),ne.RandomRange(e,t),ne.RandomRange(e,t))}static get ZeroReadOnly(){return ge._ZeroReadOnly}static Normalize(e){const t=ge.Zero();return ge.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(ge.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y,n=e.z-t.z,r=e.w-t.w;return i*i+s*s+n*n+r*r}static Center(e,t){return ge.CenterToRef(e,t,ge.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}static TransformCoordinates(e,t){const i=ge.Zero();return ge.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return ge.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,n){const r=s.m,o=e*r[0]+t*r[4]+i*r[8]+r[12],a=e*r[1]+t*r[5]+i*r[9]+r[13],l=e*r[2]+t*r[6]+i*r[10]+r[14],h=e*r[3]+t*r[7]+i*r[11]+r[15];return n.x=o,n.y=a,n.z=l,n.w=h,n}static TransformNormal(e,t){const i=new e.constructor;return ge.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){const s=t.m,n=e.x*s[0]+e.y*s[4]+e.z*s[8],r=e.x*s[1]+e.y*s[5]+e.z*s[9],o=e.x*s[2]+e.y*s[6]+e.z*s[10];return i.x=n,i.y=r,i.z=o,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,s,n,r){const o=n.m;return r.x=e*o[0]+t*o[4]+i*o[8],r.y=e*o[1]+t*o[5]+i*o[9],r.z=e*o[2]+t*o[6]+i*o[10],r.w=s,r}static FromVector3(e,t=0){return new ge(e._x,e._y,e._z,t)}static Dot(e,t){return e.dot(t)}}ge._ZeroReadOnly=ge.Zero();class ve{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,s=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=s}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){let e=fe(this._x);return e=397*e^fe(this._y),e=397*e^fe(this._z),e=397*e^fe(this._w),e}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=ae){return e&&ne.WithinEpsilon(this._x,e._x,t)&&ne.WithinEpsilon(this._y,e._y,t)&&ne.WithinEpsilon(this._z,e._z,t)&&ne.WithinEpsilon(this._w,e._w,t)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,s){return this._x=e,this._y=t,this._z=i,this._w=s,this._isDirty=!0,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new this.constructor(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,s=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,n=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,r=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,s,n,r),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return 0==t||1==t||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return 0==e||1==e||this.scaleInPlace(1/e),this}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return 0===e||1===e?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0,1);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return 0===t||1===t?e.copyFromFloats(this._x,this._y,this._z,this._w):this.scaleToRef(1/t,e)}toEulerAngles(){const e=me.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,s=this._y,n=this._w,r=s*t-i*n,o=.4999999;if(r<-o)e._y=2*Math.atan2(s,n),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(r>o)e._y=2*Math.atan2(s,n),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const o=n*n,a=t*t,l=i*i,h=s*s;e._z=Math.atan2(2*(i*s+t*n),-a-l+h+o),e._x=Math.asin(-2*r),e._y=Math.atan2(2*(t*i+s*n),a-l-h+o),e._isDirty=!0}return e}toRotationMatrix(e){return Te.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return ve.FromRotationMatrixToRef(e,this),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}static FromRotationMatrix(e){const t=new ve;return ve.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,s=i[0],n=i[4],r=i[8],o=i[1],a=i[5],l=i[9],h=i[2],c=i[6],d=i[10],u=s+a+d;let _;return u>0?(_=.5/Math.sqrt(u+1),t._w=.25/_,t._x=(c-l)*_,t._y=(r-h)*_,t._z=(o-n)*_,t._isDirty=!0):s>a&&s>d?(_=2*Math.sqrt(1+s-a-d),t._w=(c-l)/_,t._x=.25*_,t._y=(n+o)/_,t._z=(r+h)/_,t._isDirty=!0):a>d?(_=2*Math.sqrt(1+a-s-d),t._w=(r-h)/_,t._x=(n+o)/_,t._y=.25*_,t._z=(l+c)/_,t._isDirty=!0):(_=2*Math.sqrt(1+d-s-a),t._w=(o-n)/_,t._x=(r+h)/_,t._y=(l+c)/_,t._z=.25*_,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const s=ve.Dot(e,t);return 1-s*s<=i}static SmoothToRef(e,t,i,s,n){let r=0===s?1:i/s;return r=ne.Clamp(r,0,1),ve.SlerpToRef(e,t,r,n),n}static Zero(){return new ve(0,0,0,0)}static Inverse(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new ve(0,0,0,1)}static IsIdentity(e){return e&&0===e._x&&0===e._y&&0===e._z&&1===e._w}static RotationAxis(e,t){return ve.RotationAxisToRef(e,t,new ve)}static RotationAxisToRef(e,t,i){const s=Math.sin(t/2);return e.normalize(),i._w=Math.cos(t/2),i._x=e._x*s,i._y=e._y*s,i._z=e._z*s,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new ve(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromEulerAngles(e,t,i){const s=new ve;return ve.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerAnglesToRef(e,t,i,s){return ve.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerVector(e){const t=new ve;return ve.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return ve.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,s=ae){const n=me.Dot(e,t)+1;return n<s?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(me.CrossToRef(e,t,Ee.Vector3[0]),i.set(Ee.Vector3[0].x,Ee.Vector3[0].y,Ee.Vector3[0].z,n)),i.normalize()}static RotationYawPitchRoll(e,t,i){const s=new ve;return ve.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){const n=.5*i,r=.5*t,o=.5*e,a=Math.sin(n),l=Math.cos(n),h=Math.sin(r),c=Math.cos(r),d=Math.sin(o),u=Math.cos(o);return s._x=u*h*l+d*c*a,s._y=d*c*l-u*h*a,s._z=u*c*a-d*h*l,s._w=u*c*l+d*h*a,s._isDirty=!0,s}static RotationAlphaBetaGamma(e,t,i){const s=new ve;return ve.RotationAlphaBetaGammaToRef(e,t,i,s),s}static RotationAlphaBetaGammaToRef(e,t,i,s){const n=.5*(i+e),r=.5*(i-e),o=.5*t;return s._x=Math.cos(r)*Math.sin(o),s._y=Math.sin(r)*Math.sin(o),s._z=Math.sin(n)*Math.cos(o),s._w=Math.cos(n)*Math.cos(o),s._isDirty=!0,s}static RotationQuaternionFromAxis(e,t,i){const s=new ve(0,0,0,0);return ve.RotationQuaternionFromAxisToRef(e,t,i,s),s}static RotationQuaternionFromAxisToRef(e,t,i,s){const n=be.Matrix[0];return Te.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),n),ve.FromRotationMatrixToRef(n,s),s}static FromLookDirectionLH(e,t){const i=new ve;return ve.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const s=be.Matrix[0];return Te.LookDirectionLHToRef(e,t,s),ve.FromRotationMatrixToRef(s,i),i}static FromLookDirectionRH(e,t){const i=new ve;return ve.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const s=be.Matrix[0];return Te.LookDirectionRHToRef(e,t,s),ve.FromRotationMatrixToRef(s,i)}static Slerp(e,t,i){const s=ve.Identity();return ve.SlerpToRef(e,t,i,s),s}static SlerpToRef(e,t,i,s){let n,r,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,a=!1;if(o<0&&(a=!0,o=-o),o>.999999)r=1-i,n=a?-i:i;else{const e=Math.acos(o),t=1/Math.sin(e);r=Math.sin((1-i)*e)*t,n=a?-Math.sin(i*e)*t:Math.sin(i*e)*t}return s._x=r*e._x+n*t._x,s._y=r*e._y+n*t._y,s._z=r*e._z+n*t._z,s._w=r*e._w+n*t._w,s._isDirty=!0,s}static Hermite(e,t,i,s,n){const r=n*n,o=n*r,a=2*o-3*r+1,l=-2*o+3*r,h=o-2*r+n,c=o-r,d=e._x*a+i._x*l+t._x*h+s._x*c,u=e._y*a+i._y*l+t._y*h+s._y*c,_=e._z*a+i._z*l+t._z*h+s._z*c,f=e._w*a+i._w*l+t._w*h+s._w*c;return new e.constructor(d,u,_,f)}static Hermite1stDerivative(e,t,i,s,n){const r=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,n,r),r}static Hermite1stDerivativeToRef(e,t,i,s,n,r){const o=n*n;return r._x=6*(o-n)*e._x+(3*o-4*n+1)*t._x+6*(-o+n)*i._x+(3*o-2*n)*s._x,r._y=6*(o-n)*e._y+(3*o-4*n+1)*t._y+6*(-o+n)*i._y+(3*o-2*n)*s._y,r._z=6*(o-n)*e._z+(3*o-4*n+1)*t._z+6*(-o+n)*i._z+(3*o-2*n)*s._z,r._w=6*(o-n)*e._w+(3*o-4*n+1)*t._w+6*(-o+n)*i._w+(3*o-2*n)*s._w,r._isDirty=!0,r}static Normalize(e){const t=ve.Zero();return ve.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}}class Te{static get Use64Bits(){return X.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=Te._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,s=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=!this._isIdentity&&t,this._isIdentity3x2Dirty=!this._isIdentity3x2&&s}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,X.MatrixTrackPrecisionChange&&X.MatrixTrackedMatrices.push(this),this._m=new X.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,1!==this._m[0]||1!==this._m[5]||1!==this._m[15]||0!==this._m[1]||0!==this._m[2]||0!==this._m[3]||0!==this._m[4]||0!==this._m[6]||0!==this._m[7]||0!==this._m[8]||0!==this._m[9]||0!==this._m[10]||0!==this._m[11]||0!==this._m[12]||0!==this._m[13]||0!==this._m[14]?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(!0===this._isIdentity)return 1;const e=this._m,t=e[0],i=e[1],s=e[2],n=e[3],r=e[4],o=e[5],a=e[6],l=e[7],h=e[8],c=e[9],d=e[10],u=e[11],_=e[12],f=e[13],p=e[14],m=e[15],g=d*m-p*u,v=c*m-f*u,T=c*p-f*d,b=h*m-_*u,E=h*p-d*_,S=h*f-_*c;return t*+(o*g-a*v+l*T)+i*-(r*g-a*b+l*E)+s*+(r*v-o*b+l*S)+n*-(r*T-o*E+a*S)}toString(){return`{${this.m[0]}, ${this.m[1]}, ${this.m[2]}, ${this.m[3]}\n${this.m[4]}, ${this.m[5]}, ${this.m[6]}, ${this.m[7]}\n${this.m[8]}, ${this.m[9]}, ${this.m[10]}, ${this.m[11]}\n${this.m[12]}, ${this.m[13]}, ${this.m[14]}, ${this.m[15]}}`}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return Te.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new this.constructor;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,s=t._m,n=e.m;for(let e=0;e<16;e++)s[e]=i[e]+n[e];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;for(let e=0;e<16;e++)t[e]+=i[e];return this.markAsUpdated(),this}invertToRef(e){if(!0===this._isIdentity)return Te.IdentityToRef(e),e;const t=this._m,i=t[0],s=t[1],n=t[2],r=t[3],o=t[4],a=t[5],l=t[6],h=t[7],c=t[8],d=t[9],u=t[10],_=t[11],f=t[12],p=t[13],m=t[14],g=t[15],v=u*g-m*_,T=d*g-p*_,b=d*m-p*u,E=c*g-f*_,S=c*m-u*f,x=c*p-f*d,C=+(a*v-l*T+h*b),y=-(o*v-l*E+h*S),A=+(o*T-a*E+h*x),R=-(o*b-a*S+l*x),I=i*C+s*y+n*A+r*R;if(0===I)return e.copyFrom(this),e;const P=1/I,M=l*g-m*h,O=a*g-p*h,D=a*m-p*l,N=o*g-f*h,F=o*m-f*l,L=o*p-f*a,w=l*_-u*h,B=a*_-d*h,U=a*u-d*l,k=o*_-c*h,V=o*u-c*l,G=o*d-c*a,z=-(s*v-n*T+r*b),H=+(i*v-n*E+r*S),W=-(i*T-s*E+r*x),X=+(i*b-s*S+n*x),Q=+(s*M-n*O+r*D),Y=-(i*M-n*N+r*F),K=+(i*O-s*N+r*L),j=-(i*D-s*F+n*L),$=-(s*w-n*B+r*U),q=+(i*w-n*k+r*V),Z=-(i*B-s*k+r*G),J=+(i*U-s*V+n*G);return Te.FromValuesToRef(C*P,z*P,Q*P,$*P,y*P,H*P,Y*P,q*P,A*P,W*P,K*P,Z*P,R*P,X*P,j*P,J*P,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new me(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return Te.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]),this}multiply(e){const t=new this.constructor;return this.multiplyToRef(e,t),t}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const s=this._m,n=e.m,r=s[0],o=s[1],a=s[2],l=s[3],h=s[4],c=s[5],d=s[6],u=s[7],_=s[8],f=s[9],p=s[10],m=s[11],g=s[12],v=s[13],T=s[14],b=s[15],E=n[0],S=n[1],x=n[2],C=n[3],y=n[4],A=n[5],R=n[6],I=n[7],P=n[8],M=n[9],O=n[10],D=n[11],N=n[12],F=n[13],L=n[14],w=n[15];return t[i]=r*E+o*y+a*P+l*N,t[i+1]=r*S+o*A+a*M+l*F,t[i+2]=r*x+o*R+a*O+l*L,t[i+3]=r*C+o*I+a*D+l*w,t[i+4]=h*E+c*y+d*P+u*N,t[i+5]=h*S+c*A+d*M+u*F,t[i+6]=h*x+c*R+d*O+u*L,t[i+7]=h*C+c*I+d*D+u*w,t[i+8]=_*E+f*y+p*P+m*N,t[i+9]=_*S+f*A+p*M+m*F,t[i+10]=_*x+f*R+p*O+m*L,t[i+11]=_*C+f*I+p*D+m*w,t[i+12]=g*E+v*y+T*P+b*N,t[i+13]=g*S+v*A+T*M+b*F,t[i+14]=g*x+v*R+T*O+b*L,t[i+15]=g*C+v*I+T*D+b*w,this}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,s=t.m;return i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]&&i[3]===s[3]&&i[4]===s[4]&&i[5]===s[5]&&i[6]===s[6]&&i[7]===s[7]&&i[8]===s[8]&&i[9]===s[9]&&i[10]===s[10]&&i[11]===s[11]&&i[12]===s[12]&&i[13]===s[13]&&i[14]===s[14]&&i[15]===s[15]}clone(){const e=new this.constructor;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=fe(this._m[0]);for(let t=1;t<16;t++)e=397*e^fe(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new ve,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,s,n=!0){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const r=this._m;if(i&&i.copyFromFloats(r[12],r[13],r[14]),(e=e||be.Vector3[0]).x=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),e.y=Math.sqrt(r[4]*r[4]+r[5]*r[5]+r[6]*r[6]),e.z=Math.sqrt(r[8]*r[8]+r[9]*r[9]+r[10]*r[10]),s){const t=(n?s.absoluteScaling.x:s.scaling.x)<0?-1:1,i=(n?s.absoluteScaling.y:s.scaling.y)<0?-1:1,r=(n?s.absoluteScaling.z:s.scaling.z)<0?-1:1;e.x*=t,e.y*=i,e.z*=r}else this.determinant()<=0&&(e.y*=-1);if(0===e._x||0===e._y||0===e._z)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const i=1/e._x,s=1/e._y,n=1/e._z;Te.FromValuesToRef(r[0]*i,r[1]*i,r[2]*i,0,r[4]*s,r[5]*s,r[6]*s,0,r[8]*n,r[9]*n,r[10]*n,0,0,0,0,1,be.Matrix[0]),ve.FromRotationMatrixToRef(be.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=4*e;return new ge(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<=3){const i=4*e;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new this.constructor;return Te.TransposeToRef(this,e),e}transposeToRef(e){return Te.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,s,n){if(e<0||e>3)return this;const r=4*e;return this._m[r+0]=t,this._m[r+1]=i,this._m[r+2]=s,this._m[r+3]=n,this.markAsUpdated(),this}scale(e){const t=new this.constructor;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}toNormalMatrix(e){const t=be.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return Te.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new this.constructor;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=be.Vector3[0];if(!this.decompose(t))return Te.IdentityToRef(e),e;const i=this._m,s=1/t._x,n=1/t._y,r=1/t._z;return Te.FromValuesToRef(i[0]*s,i[1]*s,i[2]*s,0,i[4]*n,i[5]*n,i[6]*n,0,i[8]*r,i[9]*r,i[10]*r,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new Te;return Te.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let s=0;s<16;s++)i._m[s]=e[s+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,s){for(let n=0;n<16;n++)s._m[n]=e[n+t]*i;return s.markAsUpdated(),s}static get IdentityReadOnly(){return Te._IdentityReadOnly}static FromValuesToRef(e,t,i,s,n,r,o,a,l,h,c,d,u,_,f,p,m){const g=m._m;g[0]=e,g[1]=t,g[2]=i,g[3]=s,g[4]=n,g[5]=r,g[6]=o,g[7]=a,g[8]=l,g[9]=h,g[10]=c,g[11]=d,g[12]=u,g[13]=_,g[14]=f,g[15]=p,m.markAsUpdated()}static FromValues(e,t,i,s,n,r,o,a,l,h,c,d,u,_,f,p){const m=new Te,g=m._m;return g[0]=e,g[1]=t,g[2]=i,g[3]=s,g[4]=n,g[5]=r,g[6]=o,g[7]=a,g[8]=l,g[9]=h,g[10]=c,g[11]=d,g[12]=u,g[13]=_,g[14]=f,g[15]=p,m.markAsUpdated(),m}static Compose(e,t,i){const s=new Te;return Te.ComposeToRef(e,t,i,s),s}static ComposeToRef(e,t,i,s){const n=s._m,r=t._x,o=t._y,a=t._z,l=t._w,h=r+r,c=o+o,d=a+a,u=r*h,_=r*c,f=r*d,p=o*c,m=o*d,g=a*d,v=l*h,T=l*c,b=l*d,E=e._x,S=e._y,x=e._z;return n[0]=(1-(p+g))*E,n[1]=(_+b)*E,n[2]=(f-T)*E,n[3]=0,n[4]=(_-b)*S,n[5]=(1-(u+g))*S,n[6]=(m+v)*S,n[7]=0,n[8]=(f+T)*x,n[9]=(m-v)*x,n[10]=(1-(u+p))*x,n[11]=0,n[12]=i._x,n[13]=i._y,n[14]=i._z,n[15]=1,s.markAsUpdated(),s}static Identity(){const e=Te.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return Te.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=Te.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new Te;return Te.RotationXToRef(e,t),t}static Invert(e){const t=new e.constructor;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return Te.FromValuesToRef(1,0,0,0,0,s,i,0,0,-i,s,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationY(e){const t=new Te;return Te.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return Te.FromValuesToRef(s,0,-i,0,0,1,0,0,i,0,s,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationZ(e){const t=new Te;return Te.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return Te.FromValuesToRef(s,i,0,0,-i,s,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(1===s&&0===i),t}static RotationAxis(e,t){const i=new Te;return Te.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const s=Math.sin(-t),n=Math.cos(-t),r=1-n;e.normalize();const o=i._m;return o[0]=e._x*e._x*r+n,o[1]=e._x*e._y*r-e._z*s,o[2]=e._x*e._z*r+e._y*s,o[3]=0,o[4]=e._y*e._x*r+e._z*s,o[5]=e._y*e._y*r+n,o[6]=e._y*e._z*r-e._x*s,o[7]=0,o[8]=e._z*e._x*r-e._y*s,o[9]=e._z*e._y*r+e._x*s,o[10]=e._z*e._z*r+n,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i,s=!1){const n=me.Dot(t,e),r=i._m;if(n<-1+ae)r[0]=-1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=s?1:-1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=s?-1:1,r[11]=0;else{const i=me.Cross(t,e),s=1/(1+n);r[0]=i._x*i._x*s+n,r[1]=i._y*i._x*s-i._z,r[2]=i._z*i._x*s+i._y,r[3]=0,r[4]=i._x*i._y*s+i._z,r[5]=i._y*i._y*s+n,r[6]=i._z*i._y*s-i._x,r[7]=0,r[8]=i._x*i._z*s-i._y,r[9]=i._y*i._z*s+i._x,r[10]=i._z*i._z*s+n,r[11]=0}return r[12]=0,r[13]=0,r[14]=0,r[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const s=new Te;return Te.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){return ve.RotationYawPitchRollToRef(e,t,i,be.Quaternion[0]),be.Quaternion[0].toRotationMatrix(s),s}static Scaling(e,t,i){const s=new Te;return Te.ScalingToRef(e,t,i,s),s}static ScalingToRef(e,t,i,s){return Te.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,s),s._updateIdentityStatus(1===e&&1===t&&1===i),s}static Translation(e,t,i){const s=new Te;return Te.TranslationToRef(e,t,i,s),s}static TranslationToRef(e,t,i,s){return Te.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,s),s._updateIdentityStatus(0===e&&0===t&&0===i),s}static Lerp(e,t,i){const s=new e.constructor;return Te.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){const n=s._m,r=e.m,o=t.m;for(let e=0;e<16;e++)n[e]=r[e]*(1-i)+o[e]*i;return s.markAsUpdated(),s}static DecomposeLerp(e,t,i){const s=new e.constructor;return Te.DecomposeLerpToRef(e,t,i,s),s}static DecomposeLerpToRef(e,t,i,s){const n=be.Vector3[0],r=be.Quaternion[0],o=be.Vector3[1];e.decompose(n,r,o);const a=be.Vector3[2],l=be.Quaternion[1],h=be.Vector3[3];t.decompose(a,l,h);const c=be.Vector3[4];me.LerpToRef(n,a,i,c);const d=be.Quaternion[2];ve.SlerpToRef(r,l,i,d);const u=be.Vector3[5];return me.LerpToRef(o,h,i,u),Te.ComposeToRef(c,d,u,s),s}static LookAtLH(e,t,i){const s=new Te;return Te.LookAtLHToRef(e,t,i,s),s}static LookAtLHToRef(e,t,i,s){const n=be.Vector3[0],r=be.Vector3[1],o=be.Vector3[2];t.subtractToRef(e,o),o.normalize(),me.CrossToRef(i,o,n);const a=n.lengthSquared();0===a?n.x=1:n.normalizeFromLength(Math.sqrt(a)),me.CrossToRef(o,n,r),r.normalize();const l=-me.Dot(n,e),h=-me.Dot(r,e),c=-me.Dot(o,e);return Te.FromValuesToRef(n._x,r._x,o._x,0,n._y,r._y,o._y,0,n._z,r._z,o._z,0,l,h,c,1,s),s}static LookAtRH(e,t,i){const s=new Te;return Te.LookAtRHToRef(e,t,i,s),s}static LookAtRHToRef(e,t,i,s){const n=be.Vector3[0],r=be.Vector3[1],o=be.Vector3[2];e.subtractToRef(t,o),o.normalize(),me.CrossToRef(i,o,n);const a=n.lengthSquared();0===a?n.x=1:n.normalizeFromLength(Math.sqrt(a)),me.CrossToRef(o,n,r),r.normalize();const l=-me.Dot(n,e),h=-me.Dot(r,e),c=-me.Dot(o,e);return Te.FromValuesToRef(n._x,r._x,o._x,0,n._y,r._y,o._y,0,n._z,r._z,o._z,0,l,h,c,1,s),s}static LookDirectionLH(e,t){const i=new Te;return Te.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const s=be.Vector3[0];s.copyFrom(e),s.scaleInPlace(-1);const n=be.Vector3[1];return me.CrossToRef(t,s,n),Te.FromValuesToRef(n._x,n._y,n._z,0,t._x,t._y,t._z,0,s._x,s._y,s._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new Te;return Te.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const s=be.Vector3[2];return me.CrossToRef(t,e,s),Te.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,s,n){const r=new Te;return Te.OrthoLHToRef(e,t,i,s,r,n),r}static OrthoLHToRef(e,t,i,s,n,r){const o=2/e,a=2/t,l=2/(s-i),h=-(s+i)/(s-i);return Te.FromValuesToRef(o,0,0,0,0,a,0,0,0,0,l,0,0,0,h,1,n),r&&n.multiplyToRef(Se,n),n._updateIdentityStatus(1===o&&1===a&&1===l&&0===h),n}static OrthoOffCenterLH(e,t,i,s,n,r,o){const a=new Te;return Te.OrthoOffCenterLHToRef(e,t,i,s,n,r,a,o),a}static OrthoOffCenterLHToRef(e,t,i,s,n,r,o,a){const l=2/(t-e),h=2/(s-i),c=2/(r-n),d=-(r+n)/(r-n),u=(e+t)/(e-t),_=(s+i)/(i-s);return Te.FromValuesToRef(l,0,0,0,0,h,0,0,0,0,c,0,u,_,d,1,o),a&&o.multiplyToRef(Se,o),o.markAsUpdated(),o}static ObliqueOffCenterLHToRef(e,t,i,s,n,r,o,a,l,h,c){const d=-o*Math.cos(a),u=-o*Math.sin(a);return Te.TranslationToRef(0,0,-l,be.Matrix[1]),Te.FromValuesToRef(1,0,0,0,0,1,0,0,d,u,1,0,0,0,0,1,be.Matrix[0]),be.Matrix[1].multiplyToRef(be.Matrix[0],be.Matrix[0]),Te.TranslationToRef(0,0,l,be.Matrix[1]),be.Matrix[0].multiplyToRef(be.Matrix[1],be.Matrix[0]),Te.OrthoOffCenterLHToRef(e,t,i,s,n,r,h,c),be.Matrix[0].multiplyToRef(h,h),h}static OrthoOffCenterRH(e,t,i,s,n,r,o){const a=new Te;return Te.OrthoOffCenterRHToRef(e,t,i,s,n,r,a,o),a}static OrthoOffCenterRHToRef(e,t,i,s,n,r,o,a){return Te.OrthoOffCenterLHToRef(e,t,i,s,n,r,o,a),o._m[10]*=-1,o}static ObliqueOffCenterRHToRef(e,t,i,s,n,r,o,a,l,h,c){const d=o*Math.cos(a),u=o*Math.sin(a);return Te.TranslationToRef(0,0,l,be.Matrix[1]),Te.FromValuesToRef(1,0,0,0,0,1,0,0,d,u,1,0,0,0,0,1,be.Matrix[0]),be.Matrix[1].multiplyToRef(be.Matrix[0],be.Matrix[0]),Te.TranslationToRef(0,0,-l,be.Matrix[1]),be.Matrix[0].multiplyToRef(be.Matrix[1],be.Matrix[0]),Te.OrthoOffCenterRHToRef(e,t,i,s,n,r,h,c),be.Matrix[0].multiplyToRef(h,h),h}static PerspectiveLH(e,t,i,s,n,r=0){const o=new Te,a=2*i/e,l=2*i/t,h=(s+i)/(s-i),c=-2*s*i/(s-i),d=Math.tan(r);return Te.FromValuesToRef(a,0,0,0,0,l,0,d,0,0,h,1,0,0,c,0,o),n&&o.multiplyToRef(Se,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(e,t,i,s,n,r=0,o=!1){const a=new Te;return Te.PerspectiveFovLHToRef(e,t,i,s,a,!0,n,r,o),a}static PerspectiveFovLHToRef(e,t,i,s,n,r=!0,o,a=0,l=!1){const h=i,c=s,d=1/Math.tan(.5*e),u=r?d/t:d,_=r?d:d*t,f=l&&0===h?-1:0!==c?(c+h)/(c-h):1,p=l&&0===h?2*c:0!==c?-2*c*h/(c-h):-2*h,m=Math.tan(a);return Te.FromValuesToRef(u,0,0,0,0,_,0,m,0,0,f,1,0,0,p,0,n),o&&n.multiplyToRef(Se,n),n._updateIdentityStatus(!1),n}static PerspectiveFovReverseLHToRef(e,t,i,s,n,r=!0,o,a=0){const l=1/Math.tan(.5*e),h=r?l/t:l,c=r?l:l*t,d=Math.tan(a);return Te.FromValuesToRef(h,0,0,0,0,c,0,d,0,0,-i,1,0,0,1,0,n),o&&n.multiplyToRef(Se,n),n._updateIdentityStatus(!1),n}static PerspectiveFovRH(e,t,i,s,n,r=0,o=!1){const a=new Te;return Te.PerspectiveFovRHToRef(e,t,i,s,a,!0,n,r,o),a}static PerspectiveFovRHToRef(e,t,i,s,n,r=!0,o,a=0,l=!1){const h=i,c=s,d=1/Math.tan(.5*e),u=r?d/t:d,_=r?d:d*t,f=l&&0===h?1:0!==c?-(c+h)/(c-h):-1,p=l&&0===h?2*c:0!==c?-2*c*h/(c-h):-2*h,m=Math.tan(a);return Te.FromValuesToRef(u,0,0,0,0,_,0,m,0,0,f,-1,0,0,p,0,n),o&&n.multiplyToRef(Se,n),n._updateIdentityStatus(!1),n}static PerspectiveFovReverseRHToRef(e,t,i,s,n,r=!0,o,a=0){const l=1/Math.tan(.5*e),h=r?l/t:l,c=r?l:l*t,d=Math.tan(a);return Te.FromValuesToRef(h,0,0,0,0,c,0,d,0,0,-i,-1,0,0,-1,0,n),o&&n.multiplyToRef(Se,n),n._updateIdentityStatus(!1),n}static GetFinalMatrix(e,t,i,s,n,r){const o=e.width,a=e.height,l=e.x,h=e.y,c=Te.FromValues(o/2,0,0,0,0,-a/2,0,0,0,0,r-n,0,l+o/2,a/2+h,n,1),d=new t.constructor;return t.multiplyToRef(i,d),d.multiplyToRef(s,d),d.multiplyToRef(c,d)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return X.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return X.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new e.constructor;return Te.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=e.m,s=i[0],n=i[4],r=i[8],o=i[12],a=i[1],l=i[5],h=i[9],c=i[13],d=i[2],u=i[6],_=i[10],f=i[14],p=i[3],m=i[7],g=i[11],v=i[15],T=t._m;return T[0]=s,T[1]=n,T[2]=r,T[3]=o,T[4]=a,T[5]=l,T[6]=h,T[7]=c,T[8]=d,T[9]=u,T[10]=_,T[11]=f,T[12]=p,T[13]=m,T[14]=g,T[15]=v,t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new Te;return Te.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,s=e.normal.y,n=e.normal.z,r=-2*i,o=-2*s,a=-2*n;return Te.FromValuesToRef(r*i+1,o*i,a*i,0,r*s,o*s+1,a*s,0,r*n,o*n,a*n+1,0,r*e.d,o*e.d,a*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,s){return Te.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,s),s}static FromQuaternionToRef(e,t){const i=e._x*e._x,s=e._y*e._y,n=e._z*e._z,r=e._x*e._y,o=e._z*e._w,a=e._z*e._x,l=e._y*e._w,h=e._y*e._z,c=e._x*e._w;return t._m[0]=1-2*(s+n),t._m[1]=2*(r+o),t._m[2]=2*(a-l),t._m[3]=0,t._m[4]=2*(r-o),t._m[5]=1-2*(n+i),t._m[6]=2*(h+c),t._m[7]=0,t._m[8]=2*(a+l),t._m[9]=2*(h-c),t._m[10]=1-2*(s+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}Te._UpdateFlagSeed=0,Te._IdentityReadOnly=Te.Identity();class be{}be.Vector3=le.BuildTuple(11,me.Zero),be.Matrix=le.BuildTuple(2,Te.Identity),be.Quaternion=le.BuildTuple(3,ve.Zero);class Ee{}Ee.Vector2=le.BuildTuple(3,pe.Zero),Ee.Vector3=le.BuildTuple(13,me.Zero),Ee.Vector4=le.BuildTuple(3,ge.Zero),Ee.Quaternion=le.BuildTuple(2,ve.Zero),Ee.Matrix=le.BuildTuple(8,Te.Identity),ue("BABYLON.Vector2",pe),ue("BABYLON.Vector3",me),ue("BABYLON.Vector4",ge),ue("BABYLON.Matrix",Te);const Se=Te.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);function xe(e){return Math.pow(e,oe)}function Ce(e){return e<=.04045?.0773993808*e:Math.pow(.947867299*(e+.055),2.4)}function ye(e){return Math.pow(e,re)}function Ae(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class Re{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=255*this.r|0;return e=397*e^(255*this.g|0),e=397*e^(255*this.b|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return Re.FromArrayToRef(e,t,this),this}toColor4(e=1){return new Ie(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return.3*this.r+.59*this.g+.11*this.b}multiply(e){return new Re(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}scale(e){return new Re(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}clampToRef(e=0,t=1,i){return i.r=ne.Clamp(this.r,e,t),i.g=ne.Clamp(this.g,e,t),i.b=ne.Clamp(this.b,e,t),this}add(e){return new Re(this.r+e.r,this.g+e.g,this.b+e.b)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}subtract(e){return new Re(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}clone(){return new Re(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}toHexString(){const e=Math.round(255*this.r),t=Math.round(255*this.g),i=Math.round(255*this.b);return"#"+ne.ToHex(e)+ne.ToHex(t)+ne.ToHex(i)}toHSV(){const e=new Re;return this.toHSVToRef(e),e}toHSVToRef(e){const t=this.r,i=this.g,s=this.b,n=Math.max(t,i,s),r=Math.min(t,i,s);let o=0,a=0;const l=n,h=n-r;0!==n&&(a=h/n),n!=r&&(n==t?(o=(i-s)/h,i<s&&(o+=6)):n==i?o=(s-t)/h+2:n==s&&(o=(t-i)/h+4),o*=60),e.r=o,e.g=a,e.b=l}toLinearSpace(e=!1){const t=new Re;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Ce(this.r),e.g=Ce(this.g),e.b=Ce(this.b)):(e.r=xe(this.r),e.g=xe(this.g),e.b=xe(this.b)),this}toGammaSpace(e=!1){const t=new Re;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=Ae(this.r),e.g=Ae(this.g),e.b=Ae(this.b)):(e.r=ye(this.r),e.g=ye(this.g),e.b=ye(this.b)),this}static HSVtoRGBToRef(e,t,i,s){const n=i*t,r=e/60,o=n*(1-Math.abs(r%2-1));let a=0,l=0,h=0;r>=0&&r<=1?(a=n,l=o):r>=1&&r<=2?(a=o,l=n):r>=2&&r<=3?(l=n,h=o):r>=3&&r<=4?(l=o,h=n):r>=4&&r<=5?(a=o,h=n):r>=5&&r<=6&&(a=n,h=o);const c=i-n;s.set(a+c,l+c,h+c)}static FromHSV(e,t,i){const s=new Re(0,0,0);return Re.HSVtoRGBToRef(e,t,i,s),s}static FromHexString(e){if("#"!==e.substring(0,1)||7!==e.length)return new Re(0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16);return Re.FromInts(t,i,s)}static FromArray(e,t=0){return new Re(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new Re(e/255,t/255,i/255)}static Lerp(e,t,i){const s=new Re(0,0,0);return Re.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,s,n){const r=n*n,o=n*r,a=2*o-3*r+1,l=-2*o+3*r,h=o-2*r+n,c=o-r,d=e.r*a+i.r*l+t.r*h+s.r*c,u=e.g*a+i.g*l+t.g*h+s.g*c,_=e.b*a+i.b*l+t.b*h+s.b*c;return new Re(d,u,_)}static Hermite1stDerivative(e,t,i,s,n){const r=Re.Black();return this.Hermite1stDerivativeToRef(e,t,i,s,n,r),r}static Hermite1stDerivativeToRef(e,t,i,s,n,r){const o=n*n;r.r=6*(o-n)*e.r+(3*o-4*n+1)*t.r+6*(-o+n)*i.r+(3*o-2*n)*s.r,r.g=6*(o-n)*e.g+(3*o-4*n+1)*t.g+6*(-o+n)*i.g+(3*o-2*n)*s.g,r.b=6*(o-n)*e.b+(3*o-4*n+1)*t.b+6*(-o+n)*i.b+(3*o-2*n)*s.b}static Red(){return new Re(1,0,0)}static Green(){return new Re(0,1,0)}static Blue(){return new Re(0,0,1)}static Black(){return new Re(0,0,0)}static get BlackReadOnly(){return Re._BlackReadOnly}static White(){return new Re(1,1,1)}static Purple(){return new Re(.5,0,.5)}static Magenta(){return new Re(1,0,1)}static Yellow(){return new Re(1,1,0)}static Gray(){return new Re(.5,.5,.5)}static Teal(){return new Re(0,1,1)}static Random(){return new Re(Math.random(),Math.random(),Math.random())}}Re._BlackReadOnly=Re.Black();class Ie{constructor(e=0,t=0,i=0,s=1){this.r=e,this.g=t,this.b=i,this.a=s}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return Ie.FromArrayToRef(e,t,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new Ie(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new Ie(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}scale(e){return new Ie(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}clampToRef(e=0,t=1,i){return i.r=ne.Clamp(this.r,e,t),i.g=ne.Clamp(this.g,e,t),i.b=ne.Clamp(this.b,e,t),i.a=ne.Clamp(this.a,e,t),this}multiply(e){return new Ie(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=255*this.r|0;return e=397*e^(255*this.g|0),e=397*e^(255*this.b|0),e=397*e^(255*this.a|0),e}clone(){return new Ie(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,s){return this.r=e,this.g=t,this.b=i,this.a=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}toHexString(e=!1){const t=Math.round(255*this.r),i=Math.round(255*this.g),s=Math.round(255*this.b);if(e)return"#"+ne.ToHex(t)+ne.ToHex(i)+ne.ToHex(s);const n=Math.round(255*this.a);return"#"+ne.ToHex(t)+ne.ToHex(i)+ne.ToHex(s)+ne.ToHex(n)}toLinearSpace(e=!1){const t=new Ie;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Ce(this.r),e.g=Ce(this.g),e.b=Ce(this.b)):(e.r=xe(this.r),e.g=xe(this.g),e.b=xe(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new Ie;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=Ae(this.r),e.g=Ae(this.g),e.b=Ae(this.b)):(e.r=ye(this.r),e.g=ye(this.g),e.b=ye(this.b)),e.a=this.a,this}static FromHexString(e){if("#"!==e.substring(0,1)||9!==e.length&&7!==e.length)return new Ie(0,0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16),n=9===e.length?parseInt(e.substring(7,9),16):255;return Ie.FromInts(t,i,s,n)}static Lerp(e,t,i){const s=new Ie(0,0,0,0);return Ie.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i,s.a=e.a+(t.a-e.a)*i}static Hermite(e,t,i,s,n){const r=n*n,o=n*r,a=2*o-3*r+1,l=-2*o+3*r,h=o-2*r+n,c=o-r,d=e.r*a+i.r*l+t.r*h+s.r*c,u=e.g*a+i.g*l+t.g*h+s.g*c,_=e.b*a+i.b*l+t.b*h+s.b*c,f=e.a*a+i.a*l+t.a*h+s.a*c;return new Ie(d,u,_,f)}static Hermite1stDerivative(e,t,i,s,n){const r=new Ie;return this.Hermite1stDerivativeToRef(e,t,i,s,n,r),r}static Hermite1stDerivativeToRef(e,t,i,s,n,r){const o=n*n;r.r=6*(o-n)*e.r+(3*o-4*n+1)*t.r+6*(-o+n)*i.r+(3*o-2*n)*s.r,r.g=6*(o-n)*e.g+(3*o-4*n+1)*t.g+6*(-o+n)*i.g+(3*o-2*n)*s.g,r.b=6*(o-n)*e.b+(3*o-4*n+1)*t.b+6*(-o+n)*i.b+(3*o-2*n)*s.b,r.a=6*(o-n)*e.a+(3*o-4*n+1)*t.a+6*(-o+n)*i.a+(3*o-2*n)*s.a}static FromColor3(e,t=1){return new Ie(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new Ie(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,s){return new Ie(e/255,t/255,i/255,s/255)}static CheckColors4(e,t){if(e.length===3*t){const t=[];for(let i=0;i<e.length;i+=3){const s=i/3*4;t[s]=e[i],t[s+1]=e[i+1],t[s+2]=e[i+2],t[s+3]=1}return t}return e}}class Pe{}Pe.Color3=le.BuildArray(3,Re.Black),Pe.Color4=le.BuildArray(3,(()=>new Ie(0,0,0,0))),ue("BABYLON.Color3",Re),ue("BABYLON.Color4",Ie);class Me{get isDisposed(){return this._isDisposed}constructor(e,t,i,s=0,n=!1,r=!1,o=!1,a,l){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=r,this._divisor=a||1,this._label=l,t instanceof z?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?s:s*Float32Array.BYTES_PER_ELEMENT,n||this.create()}createVertexBuffer(e,t,i,s,n,r=!1,o){const a=r?t:t*Float32Array.BYTES_PER_ELEMENT,l=s?r?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new Oe(this._engine,this,e,this._updatable,!0,l,void 0===n?this._instanced:n,a,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,t,i,s=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,s?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),this._data=0===t&&void 0===i?e:null)}_increaseReferences(){this._buffer&&(this._isAlreadyOwned?this._buffer.references++:this._isAlreadyOwned=!0)}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class Oe{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=0!=e;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get totalVertices(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,i,s,n,r,o,a,l,h,c=!1,d=!1,u=1,_=!1){var f,p,m,g,v;this._isDisposed=!1;let T=!1;if(this.engine=e,"object"==typeof s&&null!==s?(T=null!==(f=s.updatable)&&void 0!==f&&f,n=s.postponeInternalCreation,r=s.stride,o=s.instanced,a=s.offset,l=s.size,h=s.type,c=null!==(p=s.normalized)&&void 0!==p&&p,d=null!==(m=s.useBytes)&&void 0!==m&&m,u=null!==(g=s.divisor)&&void 0!==g?g:1,_=null!==(v=s.takeBufferOwnership)&&void 0!==v&&v,this._label=s.label):T=!!s,t instanceof Me?(this._buffer=t,this._ownsBuffer=_):(this._buffer=new Me(e,t,T,r,n,o,d,u,this._label),this._ownsBuffer=!0),this.uniqueId=Oe._Counter++,this._kind=i,void 0===h){const e=this.getData();this.type=e?Oe.GetDataType(e):Oe.FLOAT}else this.type=h;const b=Oe.GetTypeByteLength(this.type);d?(this._size=l||(r?r/b:Oe.DeduceStride(i)),this.byteStride=r||this._buffer.byteStride||this._size*b,this.byteOffset=a||0):(this._size=l||r||Oe.DeduceStride(i),this.byteStride=r?r*b:this._buffer.byteStride||this._size*b,this.byteOffset=(a||0)*b),this.normalized=c,this._instanced=void 0!==o&&o,this._instanceDivisor=o?u:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){var e;null===(e=this._buffer)||void 0===e||e._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();return i?(e=null!=e?e:this.totalVertices,Oe.GetFloatData(i,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t)):null}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/Oe.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/Oe.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*Oe.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){Oe.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)}_alignBuffer(){}static DeduceStride(e){switch(e){case Oe.UVKind:case Oe.UV2Kind:case Oe.UV3Kind:case Oe.UV4Kind:case Oe.UV5Kind:case Oe.UV6Kind:return 2;case Oe.NormalKind:case Oe.PositionKind:return 3;case Oe.ColorKind:case Oe.ColorInstanceKind:case Oe.MatricesIndicesKind:case Oe.MatricesIndicesExtraKind:case Oe.MatricesWeightsKind:case Oe.MatricesWeightsExtraKind:case Oe.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?Oe.BYTE:e instanceof Uint8Array?Oe.UNSIGNED_BYTE:e instanceof Int16Array?Oe.SHORT:e instanceof Uint16Array?Oe.UNSIGNED_SHORT:e instanceof Int32Array?Oe.INT:e instanceof Uint32Array?Oe.UNSIGNED_INT:Oe.FLOAT}static GetTypeByteLength(e){switch(e){case Oe.BYTE:case Oe.UNSIGNED_BYTE:return 1;case Oe.SHORT:case Oe.UNSIGNED_SHORT:return 2;case Oe.INT:case Oe.UNSIGNED_INT:case Oe.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,t,i,s,n,r,o,a){if(e instanceof Array){let n=t/4;const o=i/4;for(let t=0;t<r;t+=s){for(let i=0;i<s;i++)a(e[n+i],t+i);n+=o}}else{const l=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),h=Oe.GetTypeByteLength(n);for(let e=0;e<r;e+=s){let r=t;for(let t=0;t<s;t++)a(Oe._GetFloatValue(l,n,r,o),e+t),r+=h;t+=i}}}static _GetFloatValue(e,t,i,s){switch(t){case Oe.BYTE:{let t=e.getInt8(i);return s&&(t=Math.max(t/127,-1)),t}case Oe.UNSIGNED_BYTE:{let t=e.getUint8(i);return s&&(t/=255),t}case Oe.SHORT:{let t=e.getInt16(i,!0);return s&&(t=Math.max(t/32767,-1)),t}case Oe.UNSIGNED_SHORT:{let t=e.getUint16(i,!0);return s&&(t/=65535),t}case Oe.INT:return e.getInt32(i,!0);case Oe.UNSIGNED_INT:return e.getUint32(i,!0);case Oe.FLOAT:return e.getFloat32(i,!0);default:throw new Error(`Invalid component type ${t}`)}}static GetFloatData(e,t,i,s,n,r,o,a){const l=t*Oe.GetTypeByteLength(i),h=o*t;if(i!==Oe.FLOAT||n!==l){const o=new Float32Array(h);return Oe.ForEach(e,s,n,t,i,h,r,((e,t)=>o[t]=e)),o}if(!(e instanceof Array||e instanceof Float32Array)||0!==s||e.length!==h){if(e instanceof Array){const t=s/4;return e.slice(t,t+h)}if(e instanceof ArrayBuffer)return new Float32Array(e,s,h);{let t=e.byteOffset+s;if(a){const i=new Float32Array(h),s=new Float32Array(e.buffer,t,h);return i.set(s),i}const i=t%4;return i&&(t=Math.max(0,t-i)),new Float32Array(e.buffer,t,h)}}return a?e.slice():e}}function De(e,t,i,s){var n,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(o=(r<3?n(o):r>3?n(t,i,o):n(t,i))||o);return r>3&&o&&Object.defineProperty(t,i,o),o}Oe._Counter=0,Oe.BYTE=5120,Oe.UNSIGNED_BYTE=5121,Oe.SHORT=5122,Oe.UNSIGNED_SHORT=5123,Oe.INT=5124,Oe.UNSIGNED_INT=5125,Oe.FLOAT=5126,Oe.PositionKind="position",Oe.NormalKind="normal",Oe.TangentKind="tangent",Oe.UVKind="uv",Oe.UV2Kind="uv2",Oe.UV3Kind="uv3",Oe.UV4Kind="uv4",Oe.UV5Kind="uv5",Oe.UV6Kind="uv6",Oe.ColorKind="color",Oe.ColorInstanceKind="instanceColor",Oe.MatricesIndicesKind="matricesIndices",Oe.MatricesWeightsKind="matricesWeights",Oe.MatricesIndicesExtraKind="matricesIndicesExtra",Oe.MatricesWeightsExtraKind="matricesWeightsExtra",Object.create,Object.create;class Ne{static Eval(e,t){return"true"===(e=e.match(/\([^()]*\)/g)?e.replace(/\([^()]*\)/g,(e=>(e=e.slice(1,e.length-1),Ne._HandleParenthesisContent(e,t)))):Ne._HandleParenthesisContent(e,t))||"false"!==e&&Ne.Eval(e,t)}static _HandleParenthesisContent(e,t){let i;t=t||(e=>"true"===e);const s=e.split("||");for(const e in s)if(Object.prototype.hasOwnProperty.call(s,e)){let n=Ne._SimplifyNegation(s[e].trim());const r=n.split("&&");if(r.length>1)for(let e=0;e<r.length;++e){const s=Ne._SimplifyNegation(r[e].trim());if(i="true"!==s&&"false"!==s?"!"===s[0]?!t(s.substring(1)):t(s):"true"===s,!i){n="false";break}}if(i||"true"===n){i=!0;break}i="true"!==n&&"false"!==n?"!"===n[0]?!t(n.substring(1)):t(n):"true"===n}return i?"true":"false"}static _SimplifyNegation(e){return"!true"===(e=(e=e.replace(/^[\s!]+/,(e=>(e=e.replace(/[\s]/g,(()=>""))).length%2?"!":""))).trim())?e="false":"!false"===e&&(e="true"),e}}class Fe{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>Fe.HasTags(e),e.addTags=t=>Fe.AddTagsTo(e,t),e.removeTags=t=>Fe.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>Fe.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const t=[];for(const i in e._tags)Object.prototype.hasOwnProperty.call(e._tags,i)&&!0===e._tags[i]&&t.push(i);return t.join(" ")}return e._tags}static AddTagsTo(e,t){t&&"string"==typeof t&&t.split(" ").forEach((function(t){Fe._AddTagTo(e,t)}))}static _AddTagTo(e,t){""!==(t=t.trim())&&"true"!==t&&"false"!==t&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(Fe.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!Fe.HasTags(e))return;const i=t.split(" ");for(const t in i)Fe._RemoveTagFrom(e,i[t])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return void 0===t||(""===t?Fe.HasTags(e):Ne.Eval(t,(t=>Fe.HasTags(e)&&e._tags[t])))}}const Le={},we={},Be=function(e,t,i,s={}){const n=e();Fe&&Fe.HasTags(t)&&Fe.AddTagsTo(n,Fe.GetTags(t,!0));const r=Ue(n),o={};for(const e in r){const a=r[e],l=t[e],h=a.type;if(null!=l&&("uniqueId"!==e||qe.AllowLoadingUniqueId))switch(h){case 0:case 6:case 11:n[e]=l;break;case 1:s.cloneTexturesOnlyOnce&&o[l.uniqueId]?n[e]=o[l.uniqueId]:(n[e]=i||l.isRenderTarget?l:l.clone(),o[l.uniqueId]=n[e]);break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:n[e]=i?l:l.clone()}}return n};function Ue(e){const t=e.getClassName();if(we[t])return we[t];we[t]={};const i=we[t];let s=e,n=t;for(;n;){const e=Le[n];for(const t in e)i[t]=e[t];let t,r=!1;do{if(t=Object.getPrototypeOf(s),!t.getClassName){r=!0;break}if(t.getClassName()!==n)break;s=t}while(t);if(r)break;n=t.getClassName(),s=t}return i}function ke(e,t){return(i,s)=>{const n=function(e){const t=e.getClassName();return Le[t]||(Le[t]={}),Le[t]}(i);n[s]||(n[s]={type:e,sourceName:t})}}function Ve(e,t=null){return function(e,t=null){return(i,s)=>{const n=t||"_"+s;Object.defineProperty(i,s,{get:function(){return this[n]},set:function(t){"function"==typeof this.equals&&this.equals(t)||this[n]!==t&&(this[n]=t,i[e].apply(this))},enumerable:!0,configurable:!0})}}(e,t)}function Ge(e){return ke(0,e)}function ze(e){return ke(1,e)}function He(e){return ke(2,e)}function We(e){return ke(3,e)}function Xe(e){return ke(4,e)}function Qe(e){return ke(5,e)}function Ye(e){return ke(6,e)}function Ke(e){return ke(8,e)}function je(e){return ke(9,e)}function $e(e){return ke(12,e)}class qe{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const s=e.animations[i];t.animations.push(s.serialize())}}}static Serialize(e,t){t||(t={}),Fe&&(t.tags=Fe.GetTags(e));const i=Ue(e);for(const s in i){const n=i[s],r=n.sourceName||s,o=n.type,a=e[s];if(null!=a&&("uniqueId"!==s||qe.AllowLoadingUniqueId))switch(o){case 0:t[r]=a;break;case 1:case 3:case 7:case 9:t[r]=a.serialize();break;case 2:case 4:case 5:case 8:case 10:case 12:t[r]=a.asArray();break;case 6:case 11:t[r]=a.id}}return t}static ParseProperties(e,t,i,s){s||(s="");const n=Ue(t);for(const r in n){const o=n[r],a=e[o.sourceName||r],l=o.type;if(null!=a&&("uniqueId"!==r||qe.AllowLoadingUniqueId)){const e=t;switch(l){case 0:e[r]=a;break;case 1:i&&(e[r]=qe._TextureParser(a,i,s));break;case 2:e[r]=Re.FromArray(a);break;case 3:e[r]=qe._FresnelParametersParser(a);break;case 4:e[r]=pe.FromArray(a);break;case 5:e[r]=me.FromArray(a);break;case 6:i&&(e[r]=i.getLastMeshById(a));break;case 7:e[r]=qe._ColorCurvesParser(a);break;case 8:e[r]=Ie.FromArray(a);break;case 9:e[r]=qe._ImageProcessingConfigurationParser(a);break;case 10:e[r]=ve.FromArray(a);break;case 11:i&&(e[r]=i.getCameraById(a));break;case 12:e[r]=Te.FromArray(a)}}}}static Parse(e,t,i,s=null){const n=e();return Fe&&Fe.AddTagsTo(n,t.tags),qe.ParseProperties(t,n,i,s),n}static Clone(e,t,i={}){return Be(e,t,!1,i)}static Instanciate(e,t){return Be(e,t,!0)}}function Ze(e,t,i,s){const n=i.value;i.value=(...i)=>{let r=n;if("undefined"!=typeof _native&&_native[t]){const e=_native[t];r=s?(...t)=>s(...t)?e(...t):n(...t):e}return e[t]=r,r(...i)}}qe.AllowLoadingUniqueId=!1,qe._ImageProcessingConfigurationParser=e=>{throw f("ImageProcessingConfiguration")},qe._FresnelParametersParser=e=>{throw f("FresnelParameters")},qe._ColorCurvesParser=e=>{throw f("ColorCurves")},qe._TextureParser=(e,t,i)=>{throw f("Texture")},Ze.filter=function(e){return(t,i,s)=>Ze(t,i,s,e)};class Je{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new s,this._onClonedObservable=new s}}class et{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,s){const n=this._NodeConstructors[e];return n?n(t,i,s):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return!!this._nodeDataStorage._doNotSerialize||!!this._parentNode&&this._parentNode.doNotSerialize}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&void 0!==this._parentNode._children&&null!==this._parentNode._children){const t=this._parentNode._children.indexOf(this);-1!==t&&this._parentNode._children.splice(t,1),e||this._nodeDataStorage._isDisposed||this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&(void 0!==this._parentNode._children&&null!==this._parentNode._children||(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){-1===this._nodeDataStorage._sceneRootNodesIndex&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(-1!==this._nodeDataStorage._sceneRootNodesIndex){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null){this._isDirty=!1,this._nodeDataStorage=new Je,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new s,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=Te.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new s,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||u.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return-1!==this._behaviors.indexOf(e)||(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce((()=>{e.attach(this)})):e.attach(this),this._behaviors.push(e)),this}removeBehavior(e){const t=this._behaviors.indexOf(e);return-1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return!this._parentNode||!this._parentNode._isDirty&&this._parentUpdateId===this._parentNode._childUpdateId&&this._parentNode.isSynchronized()}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):!(this._parentNode&&!this.isSynchronizedWithParent())&&this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return!1===e?this._nodeDataStorage._isEnabled:!!this._nodeDataStorage._isEnabled&&this._nodeDataStorage._isParentEnabled}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=!this._parentNode||this._parentNode.isEnabled(),this._children&&this._children.forEach((e=>{e._syncParentEnabledState()}))}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return!!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))}_getDescendants(e,t=!1,i){if(this._children)for(let s=0;s<this._children.length;s++){const n=this._children[s];i&&!i(n)||e.push(n),t||n._getDescendants(e,!1,i)}}getDescendants(e,t){const i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,(e=>(!t||t(e))&&void 0!==e.cullingStrategy)),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){e!==this._nodeDataStorage._isReady&&(e?(this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0):this._nodeDataStorage._isReady=!1)}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=et._AnimationRangeFactory(e,t,i);for(let s=0,n=this.animations.length;s<n;s++)this.animations[s]&&this.animations[s].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.animations.length;i<s;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){const s=qe.Clone((()=>new et(e,this.getScene())),this);if(t&&(s.parent=t),!i){const t=this.getDescendants(!0);for(let i=0;i<t.length;i++){const n=t[i];n.clone(e+"."+n.name,s)}}return s}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,s){const n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,i,s):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.push(s)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=Te.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const s of i)s.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const e of this._behaviors)e.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let i=0;i<t.ranges.length;i++){const s=t.ranges[i];e.createAnimationRange(s.name,s.from,s.to)}}getHierarchyBoundingVectors(e=!0,t=null){let i,s;this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);const n=this;if(n.getBoundingInfo&&n.subMeshes){const e=n.getBoundingInfo();i=e.boundingBox.minimumWorld.clone(),s=e.boundingBox.maximumWorld.clone()}else i=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new me(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const e=this.getDescendants(!1);for(const n of e){const e=n;if(e.computeWorldMatrix(!0),t&&!t(e))continue;if(!e.getBoundingInfo||0===e.getTotalVertices())continue;const r=e.getBoundingInfo().boundingBox,o=r.minimumWorld,a=r.maximumWorld;me.CheckExtends(o,i,s),me.CheckExtends(a,i,s)}}return{min:i,max:s}}}et._AnimationRangeFactory=(e,t,i)=>{throw f("AnimationRange")},et._NodeConstructors={},De([Ge()],et.prototype,"name",void 0),De([Ge()],et.prototype,"id",void 0),De([Ge()],et.prototype,"uniqueId",void 0),De([Ge()],et.prototype,"state",void 0),De([Ge()],et.prototype,"metadata",void 0);const tt=(e,t,i)=>e?e.getClassName&&"Mesh"===e.getClassName()?null:!e.getClassName||"SubMesh"!==e.getClassName()&&"PhysicsBody"!==e.getClassName()?e.clone?e.clone():Array.isArray(e)?e.slice():i&&"object"==typeof e?Object.assign({},e):null:e.clone(t):null;class it{static DeepCopy(e,t,i,s,n=!1){const r=function(e){const t=[];do{Object.getOwnPropertyNames(e).forEach((function(e){-1===t.indexOf(e)&&t.push(e)}))}while(e=Object.getPrototypeOf(e));return t}(e);for(const o of r){if("_"===o[0]&&(!s||-1===s.indexOf(o)))continue;if(o.endsWith("Observable"))continue;if(i&&-1!==i.indexOf(o))continue;const r=e[o],a=typeof r;if("function"!==a)try{if("object"===a)if(r instanceof Uint8Array)t[o]=Uint8Array.from(r);else if(r instanceof Array){if(t[o]=[],r.length>0)if("object"==typeof r[0])for(let e=0;e<r.length;e++){const i=tt(r[e],t,n);-1===t[o].indexOf(i)&&t[o].push(i)}else t[o]=r.slice(0)}else t[o]=tt(r,t,n);else t[o]=r}catch(e){p.Warn(e.message)}}}}class st{constructor(){this._xhr="undefined"!=typeof _native&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest,this._requestURL=""}static get IsCustomRequestAvailable(){return Object.keys(st.CustomRequestHeaders).length>0||st.CustomRequestModifiers.length>0}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in st.CustomRequestHeaders){const t=st.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return st.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){st.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const e of st.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;e(this._xhr,t)}return t=(t=t.replace("file:http:","http:")).replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}st.CustomRequestHeaders={},st.CustomRequestModifiers=new Array,st.SkipRequestModificationForBabylonCDN=!0;class nt{}nt.FilesToLoad={};class rt extends Error{}rt._setPrototypeOf=Object.setPrototypeOf||((e,t)=>(e.__proto__=t,e));const ot=3e3;class at extends rt{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",rt._setPrototypeOf(this,at.prototype)}}const lt=e=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i,s,n,r,o,a,l,h="",c=0;const d=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);for(;c<d.length;)i=d[c++],s=c<d.length?d[c++]:Number.NaN,n=c<d.length?d[c++]:Number.NaN,r=i>>2,o=(3&i)<<4|s>>4,a=(15&s)<<2|n>>6,l=63&n,isNaN(s)?a=l=64:isNaN(n)&&(l=64),h+=t.charAt(r)+t.charAt(o)+t.charAt(a)+t.charAt(l);return h},ht=e=>atob(e),ct=e=>{const t=ht(e),i=t.length,s=new Uint8Array(new ArrayBuffer(i));for(let e=0;e<i;e++)s[e]=t.charCodeAt(e);return s.buffer};class dt{static SetImmediate(e){l()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const ut=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class _t extends at{constructor(e,t){super(e,4e3),this.name="LoadFileError",rt._setPrototypeOf(this,_t.prototype),t instanceof st?this.request=t:this.file=t}}class ft extends at{constructor(e,t){super(e,4001),this.request=t,this.name="RequestFileError",rt._setPrototypeOf(this,ft.prototype)}}class pt extends at{constructor(e,t){super(e,4002),this.file=t,this.name="ReadFileError",rt._setPrototypeOf(this,pt.prototype)}}const mt={DefaultRetryStrategy:class{static ExponentialBackoff(e=3,t=500){return(i,s,n)=>0!==s.status||n>=e||-1!==i.indexOf("file:")?-1:Math.pow(2,n)*t}}.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:e=>e,ScriptBaseUrl:"",ScriptPreprocessUrl:e=>e},gt=e=>e.replace(/#/gm,"%23"),vt=(e,t)=>{if((!e||0!==e.indexOf("data:"))&&mt.CorsBehavior)if("string"==typeof mt.CorsBehavior||mt.CorsBehavior instanceof String)t.crossOrigin=mt.CorsBehavior;else{const i=mt.CorsBehavior(e);i&&(t.crossOrigin=i)}},Tt=(e,t,i,s,n="",r)=>{const o=u.LastCreatedEngine;if("undefined"==typeof HTMLImageElement&&!(null==o?void 0:o._features.forceBitmapOverHTMLImageElement))return i("LoadImage is only supported in web or BabylonNative environments."),null;let a,l=!1;e instanceof ArrayBuffer||ArrayBuffer.isView(e)?"undefined"!=typeof Blob&&"undefined"!=typeof URL?(a=URL.createObjectURL(new Blob([e],{type:n})),l=!0):a=`data:${n};base64,`+lt(e):e instanceof Blob?(a=URL.createObjectURL(e),l=!0):(a=gt(e),a=mt.PreprocessUrl(e));const h=t=>{if(i){const s=a||e.toString();i(`Error while trying to load image: ${0===s.indexOf("http")||s.length<=128?s:s.slice(0,128)+"..."}`,t)}};if(null==o?void 0:o._features.forceBitmapOverHTMLImageElement)return Et(a,(s=>{o.createImageBitmap(new Blob([s],{type:n}),Object.assign({premultiplyAlpha:"none"},r)).then((e=>{t(e),l&&URL.revokeObjectURL(a)})).catch((t=>{i&&i("Error while trying to load image: "+e,t)}))}),void 0,s||void 0,!0,((e,t)=>{h(t)})),null;const c=new Image;vt(a,c);const d=[],_=()=>{d.forEach((e=>{e.target.removeEventListener(e.name,e.handler)})),d.length=0};d.push({target:c,name:"load",handler:()=>{_(),t(c),l&&c.src&&URL.revokeObjectURL(c.src)}}),d.push({target:c,name:"error",handler:e=>{_(),h(e),l&&c.src&&URL.revokeObjectURL(c.src)}}),d.push({target:document,name:"securitypolicyviolation",handler:e=>{if(e.blockedURI!==c.src)return;_();const t=new Error(`CSP violation of policy ${e.effectiveDirective} ${e.blockedURI}. Current policy is ${e.originalPolicy}`);u.UseFallbackTexture=!1,h(t),l&&c.src&&URL.revokeObjectURL(c.src),c.src=""}}),d.forEach((e=>{e.target.addEventListener(e.name,e.handler)}));const f="blob:"===a.substring(0,5),p="data:"===a.substring(0,5),m=()=>{f||p||!st.IsCustomRequestAvailable?c.src=a:Et(a,((e,t,i)=>{const s=new Blob([e],{type:!n&&i?i:n}),r=URL.createObjectURL(s);l=!0,c.src=r}),void 0,s||void 0,!0,((e,t)=>{h(t)}))};if(!f&&!p&&s&&s.enableTexturesOffline)s.open((()=>{s&&s.loadImage(a,c)}),m);else{if(-1!==a.indexOf("file:")){const e=decodeURIComponent(a.substring(5).toLowerCase());if(nt.FilesToLoad[e]&&"undefined"!=typeof URL){try{let t;try{t=URL.createObjectURL(nt.FilesToLoad[e])}catch(i){t=URL.createObjectURL(nt.FilesToLoad[e])}c.src=t,l=!0}catch(e){c.src=""}return c}}m()}return c},bt=(e,t,i,n,r)=>{const o=new FileReader,a={onCompleteObservable:new s,abort:()=>o.abort()};return o.onloadend=()=>a.onCompleteObservable.notifyObservers(a),r&&(o.onerror=()=>{r(new pt(`Unable to read ${e.name}`,e))}),o.onload=e=>{t(e.target.result)},i&&(o.onprogress=i),n?o.readAsArrayBuffer(e):o.readAsText(e),a},Et=(e,t,i,n,r,o,a)=>{if(e.name)return bt(e,t,i,r,o?e=>{o(void 0,e)}:void 0);const l=e;if(-1!==l.indexOf("file:")){let e=decodeURIComponent(l.substring(5).toLowerCase());0===e.indexOf("./")&&(e=e.substring(2));const s=nt.FilesToLoad[e];if(s)return bt(s,t,i,r,o?e=>o(void 0,new _t(e.message,e.file)):void 0)}const{match:h,type:c}=yt(l);if(h){const e={onCompleteObservable:new s,abort:()=>()=>{}};try{const e=r?At(l):Rt(l);t(e,void 0,c)}catch(e){o?o(void 0,e):p.Error(e.message||"Failed to parse the Data URL")}return dt.SetImmediate((()=>{e.onCompleteObservable.notifyObservers(e)})),e}return St(l,((e,i)=>{t(e,null==i?void 0:i.responseURL,null==i?void 0:i.getResponseHeader("content-type"))}),i,n,r,o?e=>{o(e.request,new _t(e.message,e.request))}:void 0,a)},St=(e,t,i,n,r,o,a)=>{e=gt(e),e=mt.PreprocessUrl(e);const h=mt.BaseUrl+e;let c=!1;const d={onCompleteObservable:new s,abort:()=>c=!0},u=()=>{let e,s=new st,n=null;const u=()=>{s&&(i&&s.removeEventListener("progress",i),e&&s.removeEventListener("readystatechange",e),s.removeEventListener("loadend",_))};let _=()=>{u(),d.onCompleteObservable.notifyObservers(d),d.onCompleteObservable.clear(),i=void 0,e=null,_=null,o=void 0,a=void 0,t=void 0};d.abort=()=>{c=!0,_&&_(),s&&s.readyState!==(XMLHttpRequest.DONE||4)&&s.abort(),null!==n&&(clearTimeout(n),n=null),s=null};const f=e=>{const t=e.message||"Unknown error";o&&s?o(new ft(t,s)):p.Error(t)},m=d=>{if(s){if(s.open("GET",h),a)try{a(s)}catch(e){return void f(e)}r&&(s.responseType="arraybuffer"),i&&s.addEventListener("progress",i),_&&s.addEventListener("loadend",_),e=()=>{if(!c&&s&&s.readyState===(XMLHttpRequest.DONE||4)){if(e&&s.removeEventListener("readystatechange",e),s.status>=200&&s.status<300||0===s.status&&(!l()||xt())){try{t&&t(r?s.response:s.responseText,s)}catch(e){f(e)}return}const i=mt.DefaultRetryStrategy;if(i){const e=i(h,s,d);if(-1!==e)return u(),s=new st,void(n=setTimeout((()=>m(d+1)),e))}const a=new ft("Error status: "+s.status+" "+s.statusText+" - Unable to load "+h,s);o&&o(a)}},s.addEventListener("readystatechange",e),s.send()}};m(0)};if(n&&n.enableSceneOffline){const s=e=>{e&&e.status>400?o&&o(e):u()},a=()=>{n&&n.loadFile(mt.BaseUrl+e,(e=>{!c&&t&&t(e),d.onCompleteObservable.notifyObservers(d)}),i?e=>{!c&&i&&i(e)}:void 0,s,r)};n.open(a,s)}else u();return d},xt=()=>"undefined"!=typeof location&&"file:"===location.protocol,Ct=e=>ut.test(e),yt=e=>{const t=ut.exec(e);return null===t||0===t.length?{match:!1,type:""}:{match:!0,type:t[0].replace("data:","").replace("base64,","")}};function At(e){return ct(e.split(",")[1])}const Rt=e=>ht(e.split(",")[1]);let It;q._FileToolsLoadImage=Tt,q._FileToolsLoadFile=Et,N._FileToolsLoadFile=Et,((e,t,i,s,n,r,o,a,l,h)=>{It={DecodeBase64UrlToBinary:e,DecodeBase64UrlToString:t,DefaultRetryStrategy:i.DefaultRetryStrategy,BaseUrl:i.BaseUrl,CorsBehavior:i.CorsBehavior,PreprocessUrl:i.PreprocessUrl,IsBase64DataUrl:s,IsFileURL:n,LoadFile:r,LoadImage:o,ReadFile:a,RequestFile:l,SetCorsBehavior:h},Object.defineProperty(It,"DefaultRetryStrategy",{get:function(){return i.DefaultRetryStrategy},set:function(e){i.DefaultRetryStrategy=e}}),Object.defineProperty(It,"BaseUrl",{get:function(){return i.BaseUrl},set:function(e){i.BaseUrl=e}}),Object.defineProperty(It,"PreprocessUrl",{get:function(){return i.PreprocessUrl},set:function(e){i.PreprocessUrl=e}}),Object.defineProperty(It,"CorsBehavior",{get:function(){return i.CorsBehavior},set:function(e){i.CorsBehavior=e}})})(At,Rt,mt,Ct,xt,Et,Tt,bt,St,vt);class Pt{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=_e(e);if(t)return t;p.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let s=window||this;for(let e=0,t=i.length;e<t;e++)s=s[i[e]];return"function"!=typeof s?null:s}}function Mt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}Pt.RegisteredExternalClasses={};class Ot{static get BaseUrl(){return mt.BaseUrl}static set BaseUrl(e){mt.BaseUrl=e}static IsAbsoluteUrl(e){return 0===e.indexOf("//")||-1!==e.indexOf("://")&&-1!==e.indexOf(".")&&-1!==e.indexOf("/")&&!(e.indexOf(":")>e.indexOf("/"))&&(e.indexOf("://")<e.indexOf(".")||0===e.indexOf("data:")||0===e.indexOf("blob:"))}static set ScriptBaseUrl(e){mt.ScriptBaseUrl=e}static get ScriptBaseUrl(){return mt.ScriptBaseUrl}static set ScriptPreprocessUrl(e){mt.ScriptPreprocessUrl=e}static get ScriptPreprocessUrl(){return mt.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return mt.DefaultRetryStrategy}static set DefaultRetryStrategy(e){mt.DefaultRetryStrategy=e}static get CorsBehavior(){return mt.CorsBehavior}static set CorsBehavior(e){mt.CorsBehavior=e}static get UseFallbackTexture(){return u.UseFallbackTexture}static set UseFallbackTexture(e){u.UseFallbackTexture=e}static get RegisteredExternalClasses(){return Pt.RegisteredExternalClasses}static set RegisteredExternalClasses(e){Pt.RegisteredExternalClasses=e}static get fallbackTexture(){return u.FallbackTexture}static set fallbackTexture(e){u.FallbackTexture=e}static FetchToRef(e,t,i,s,n,r){const o=4*((Math.abs(e)*i%i|0)+(Math.abs(t)*s%s|0)*i);r.r=n[o]/255,r.g=n[o+1]/255,r.b=n[o+2]/255,r.a=n[o+3]/255}static Mix(e,t,i){return e*(1-i)+t*i}static Instantiate(e){return Pt.Instantiate(e)}static SetImmediate(e){dt.SetImmediate(e)}static IsExponentOfTwo(e){let t=1;do{t*=2}while(t<e);return t===e}static FloatRound(e){return Math.fround(e)}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return 180*e/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const s=this.ToRadians(e),n=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(n)+i*Math.sin(s),(1-i)*Math.cos(n)+i*Math.cos(s)))}static MakeArray(e,t){return!0===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null}static GetPointerPrefix(e){let t="pointer";return l()&&!window.PointerEvent&&(t="mouse"),!e._badDesktopOS||e._badOS||document&&"ontouchend"in document||(t="mouse"),t}static SetCorsBehavior(e,t){vt(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static CleanUrl(e){return e.replace(/#/gm,"%23")}static get PreprocessUrl(){return mt.PreprocessUrl}static set PreprocessUrl(e){mt.PreprocessUrl=e}static LoadImage(e,t,i,s,n,r){return Tt(e,t,i,s,n,r)}static LoadFile(e,t,i,s,n,r){return Et(e,t,i,s,n,r)}static LoadFileAsync(e,t=!0){return new Promise(((i,s)=>{Et(e,(e=>{i(e)}),void 0,void 0,t,((e,t)=>{s(t)}))}))}static GetBabylonScriptURL(e,t){if(!e)return"";if(Ot.ScriptBaseUrl&&e.startsWith(Ot._DefaultCdnUrl)){const t="/"===Ot.ScriptBaseUrl[Ot.ScriptBaseUrl.length-1]?Ot.ScriptBaseUrl.substring(0,Ot.ScriptBaseUrl.length-1):Ot.ScriptBaseUrl;e=e.replace(Ot._DefaultCdnUrl,t)}return e=Ot.ScriptPreprocessUrl(e),t&&(e=Ot.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,i,s){e=Ot.GetBabylonScriptURL(e),Ot.LoadScript(e,t,i)}static LoadBabylonScriptAsync(e){return e=Ot.GetBabylonScriptURL(e),Ot.LoadScriptAsync(e)}static LoadScript(e,t,i,s){if("function"==typeof importScripts){try{importScripts(e),t()}catch(t){null==i||i(`Unable to load script '${e}' in worker`,t)}return}if(!l())return void(null==i||i(`Cannot load script '${e}' outside of a window or a worker`));const n=document.getElementsByTagName("head")[0],r=document.createElement("script");r.setAttribute("type","text/javascript"),r.setAttribute("src",e),s&&(r.id=s),r.onload=()=>{t&&t()},r.onerror=t=>{i&&i(`Unable to load script '${e}'`,t)},n.appendChild(r)}static LoadScriptAsync(e){return new Promise(((t,i)=>{this.LoadScript(e,(()=>{t()}),((e,t)=>{i(t||new Error(e))}))}))}static ReadFileAsDataURL(e,t,i){const n=new FileReader,r={onCompleteObservable:new s,abort:()=>n.abort()};return n.onloadend=()=>{r.onCompleteObservable.notifyObservers(r)},n.onload=e=>{t(e.target.result)},n.onprogress=i,n.readAsDataURL(e),r}static ReadFile(e,t,i,s,n){return bt(e,t,i,s,n)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,s){it.DeepCopy(e,t,i,s)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.addEventListener(s.name,s.handler,!1);try{window.parent&&window.parent.addEventListener(s.name,s.handler,!1)}catch(e){}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.removeEventListener(s.name,s.handler);try{e.parent&&e.parent.removeEventListener(s.name,s.handler)}catch(e){}}}static async DumpFramebuffer(e,t,i,s,n="image/png",r,o){throw f("DumpTools")}static DumpData(e,t,i,s,n="image/png",r,o=!1,a=!1,l){throw f("DumpTools")}static DumpDataAsync(e,t,i,s="image/png",n,r=!1,o=!1,a){throw f("DumpTools")}static _IsOffScreenCanvas(e){return void 0!==e.convertToBlob}static ToBlob(e,t,i="image/png",s){Ot._IsOffScreenCanvas(e)||e.toBlob||(e.toBlob=function(e,t,i){setTimeout((()=>{const s=atob(this.toDataURL(t,i).split(",")[1]),n=s.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=s.charCodeAt(e);e(new Blob([r]))}))}),Ot._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:s}).then((e=>t(e))):e.toBlob((function(e){t(e)}),i,s)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const e=new Date;t="screenshot_"+(e.getFullYear()+"-"+(e.getMonth()+1)).slice(2)+"-"+e.getDate()+"_"+e.getHours()+"-"+("0"+e.getMinutes()).slice(-2)+".png"}Ot.Download(e,t)}else if(e&&"undefined"!=typeof URL){const t=URL.createObjectURL(e),i=window.open("");if(!i)return;const s=i.document.createElement("img");s.onload=function(){URL.revokeObjectURL(t)},s.src=t,i.document.body.appendChild(s)}}static EncodeScreenshotCanvasData(e,t,i="image/png",s,n){if("string"!=typeof s&&t){if(t){if(Ot._IsOffScreenCanvas(e))return void e.convertToBlob({type:i,quality:n}).then((e=>{const i=new FileReader;i.readAsDataURL(e),i.onloadend=()=>{const e=i.result;t(e)}}));const s=e.toDataURL(i,n);t(s)}}else this.ToBlob(e,(function(e){e&&Ot.DownloadBlob(e,s),t&&t("")}),i,n)}static Download(e,t){if("undefined"==typeof URL)return;const i=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=i,s.download=t,s.addEventListener("click",(()=>{s.parentElement&&s.parentElement.removeChild(s)})),s.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return"boolean"==typeof e[0]?e[0]:"boolean"==typeof e[1]&&e[1]}static CreateScreenshot(e,t,i,s,n="image/png",r=!1,o){throw f("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,s="image/png",n){throw f("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,s,n="image/png",r=1,o=!1,a,l=!1,h=!1,c=!0,d){throw f("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,s="image/png",n=1,r=!1,o,a=!1,l=!1,h=!0,c){throw f("ScreenshotTools")}static RandomId(){return Mt()}static IsBase64(e){return Ct(e)}static DecodeBase64(e){return At(e)}static get errorsCount(){return p.errorsCount}static Log(e){p.Log(e)}static Warn(e){p.Warn(e)}static Error(e){p.Error(e)}static get LogCache(){return p.LogCache}static ClearLogCache(){p.ClearLogCache()}static set LogLevels(e){p.LogLevels=e}static set PerformanceLogLevel(e){return(e&Ot.PerformanceUserMarkLogLevel)===Ot.PerformanceUserMarkLogLevel?(Ot.StartPerformanceCounter=Ot._StartUserMark,void(Ot.EndPerformanceCounter=Ot._EndUserMark)):(e&Ot.PerformanceConsoleLogLevel)===Ot.PerformanceConsoleLogLevel?(Ot.StartPerformanceCounter=Ot._StartPerformanceConsole,void(Ot.EndPerformanceCounter=Ot._EndPerformanceConsole)):(Ot.StartPerformanceCounter=Ot._StartPerformanceCounterDisabled,void(Ot.EndPerformanceCounter=Ot._EndPerformanceCounterDisabled))}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!Ot._Performance){if(!l())return;Ot._Performance=window.performance}t&&Ot._Performance.mark&&Ot._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){t&&Ot._Performance.mark&&(Ot._Performance.mark(e+"-End"),Ot._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(Ot._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(Ot._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return j.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,s=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const n=t?e:Object.getPrototypeOf(e);i=n.constructor.__bjsclassName__,s=n.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(null!=s?s+".":"")+i:null}static DelayAsync(e){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}static IsSafari(){return!!h()&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}}Ot.UseCustomRequestHeaders=!1,Ot.CustomRequestHeaders=st.CustomRequestHeaders,Ot.GetDOMTextContent=d,Ot._DefaultCdnUrl="https://cdn.babylonjs.com",Ot.GetAbsoluteUrl="object"==typeof document?e=>{const t=document.createElement("a");return t.href=e,t.href}:"function"==typeof URL&&"object"==typeof location?e=>new URL(e,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")},Ot.NoneLogLevel=p.NoneLogLevel,Ot.MessageLogLevel=p.MessageLogLevel,Ot.WarningLogLevel=p.WarningLogLevel,Ot.ErrorLogLevel=p.ErrorLogLevel,Ot.AllLogLevel=p.AllLogLevel,Ot.IsWindowObjectExist=l,Ot.PerformanceNoneLogLevel=0,Ot.PerformanceUserMarkLogLevel=1,Ot.PerformanceConsoleLogLevel=2,Ot.StartPerformanceCounter=Ot._StartPerformanceCounterDisabled,Ot.EndPerformanceCounter=Ot._EndPerformanceCounterDisabled;class Dt{constructor(e,t,i,s=0){this.iterations=e,this.index=s-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,s=0){const n=new Dt(e,t,i,s);return n.executeNext(),n}static SyncAsyncForLoop(e,t,i,s,n,r=0){return Dt.Run(Math.ceil(e/t),(s=>{n&&n()?s.breakLoop():setTimeout((()=>{for(let r=0;r<t;++r){const o=s.index*t+r;if(o>=e)break;if(i(o),n&&n()){s.breakLoop();break}}s.executeNext()}),r)}),s)}}u.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z",q.prototype.createUniformBuffer=function(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create uniform buffer");const s=new H(i);return this.bindUniformBuffer(s),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),s.references=1,s},q.prototype.createDynamicUniformBuffer=function(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create dynamic uniform buffer");const s=new H(i);return this.bindUniformBuffer(s),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),s.references=1,s},q.prototype.updateUniformBuffer=function(e,t,i,s){this.bindUniformBuffer(e),void 0===i&&(i=0),void 0===s?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,i,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(i,i+s)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(i,i+s)),this.bindUniformBuffer(null)},q.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)},q.prototype.bindUniformBufferBase=function(e,t,i){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null)},q.prototype.bindUniformBlock=function(e,t,i){const s=e.program,n=this._gl.getUniformBlockIndex(s,t);4294967295!==n&&this._gl.uniformBlockBinding(s,n,i)};class Nt{constructor(e,t,i,s,n=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||n,this._dynamic=i,this._name=null!=s?s:"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return void 0!==this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!=0){const e=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const i=this._uniformLocationPointer-e;for(let e=0;e<i;e++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO)return;if(void 0!==this._uniformLocations[e])return;let s;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},16==t?t*=i:t=t*i+(4-t)*i,s=[];for(let e=0;e<t;e++)s.push(0)}else{if(t instanceof Array)s=t,t=s.length;else{s=[];for(let e=0;e<t;e++)s.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let e=0;e<t;e++)this._data.push(s[e]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}addFloat2(e,t,i){const s=[t,i];this.addUniform(e,s)}addFloat3(e,t,i,s){const n=[t,i,s];this.addUniform(e,n)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const s=[t.r,t.g,t.b,i];this.addUniform(e,s)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNames(){const e=[];for(const t in this._uniformLocations)e.push(t);return e.join(",")}_rebuild(){!this._noUBO&&this._bufferData&&(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO)if(this.bindUniformBuffer(),this._buffer)if(this._dynamic||this._needSync){if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1]){if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1]))return this._needSync=!1,void(this._createBufferOnWrite=this._engine._features.trackUbosInFrame);this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1])}this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(Nt._UpdatedUbosInFrame[this._name]||(Nt._UpdatedUbosInFrame[this._name]=0),Nt._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}else this._createBufferOnWrite=this._engine._features.trackUbosInFrame;else this.create()}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let s=this._uniformLocations[e];if(void 0===s){if(this._buffer)return void p.Error("Cannot add an uniform after UBO has been created.");this.addUniform(e,i),s=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let e=0;e<i;e++)this._bufferData[s+e]=t[e];else{let e=!1;for(let n=0;n<i;n++)(16===i&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[s+n]!==Math.fround(t[n]))&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+n]=t[n]);this._needSync=this._needSync||e}}updateUniformArray(e,t,i){this._checkNewFrame();const s=this._uniformLocations[e];if(void 0===s)return void p.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this._buffer||this.create();const n=this._uniformArraySizes[e];if(this._dynamic)for(let e=0;e<i;e++)this._bufferData[s+e]=t[e];else{let e=!1,r=0,o=0;for(let a=0;a<i;a++)if(this._bufferData[s+4*o+r]!==Ot.FloatRound(t[a])&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+4*o+r]=t[a]),r++,r===n.strideSize){for(;r<4;r++)this._bufferData[s+4*o+r]=0;r=0,o++}this._needSync=this._needSync||e}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_updateMatrix3x3ForUniform(e,t){for(let e=0;e<3;e++)Nt._TempBuffer[4*e]=t[3*e],Nt._TempBuffer[4*e+1]=t[3*e+1],Nt._TempBuffer[4*e+2]=t[3*e+2],Nt._TempBuffer[4*e+3]=0;this.updateUniform(e,Nt._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let e=0;e<2;e++)Nt._TempBuffer[4*e]=t[2*e],Nt._TempBuffer[4*e+1]=t[2*e+1],Nt._TempBuffer[4*e+2]=0,Nt._TempBuffer[4*e+3]=0;this.updateUniform(e,Nt._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){Nt._TempBuffer[0]=t,this.updateUniform(e,Nt._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,s=""){this._currentEffect.setFloat2(e+s,t,i)}_updateFloat2ForUniform(e,t,i){Nt._TempBuffer[0]=t,Nt._TempBuffer[1]=i,this.updateUniform(e,Nt._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,s,n=""){this._currentEffect.setFloat3(e+n,t,i,s)}_updateFloat3ForUniform(e,t,i,s){Nt._TempBuffer[0]=t,Nt._TempBuffer[1]=i,Nt._TempBuffer[2]=s,this.updateUniform(e,Nt._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,s,n,r=""){this._currentEffect.setFloat4(e+r,t,i,s,n)}_updateFloat4ForUniform(e,t,i,s,n){Nt._TempBuffer[0]=t,Nt._TempBuffer[1]=i,Nt._TempBuffer[2]=s,Nt._TempBuffer[3]=n,this.updateUniform(e,Nt._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){Nt._TempBufferInt32View.set(t),this.updateUniformArray(e,Nt._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){Nt._TempBufferUInt32View.set(t),this.updateUniformArray(e,Nt._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){Nt._TempBuffer[0]=t.x,Nt._TempBuffer[1]=t.y,Nt._TempBuffer[2]=t.z,this.updateUniform(e,Nt._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){Nt._TempBuffer[0]=t.x,Nt._TempBuffer[1]=t.y,Nt._TempBuffer[2]=t.z,Nt._TempBuffer[3]=t.w,this.updateUniform(e,Nt._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){Nt._TempBuffer[0]=t.r,Nt._TempBuffer[1]=t.g,Nt._TempBuffer[2]=t.b,this.updateUniform(e,Nt._TempBuffer,3)}_updateColor4ForEffect(e,t,i,s=""){this._currentEffect.setColor4(e+s,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){Nt._TempBuffer[0]=t.r,Nt._TempBuffer[1]=t.g,Nt._TempBuffer[2]=t.b,Nt._TempBuffer[3]=i,this.updateUniform(e,Nt._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){Nt._TempBuffer[0]=t.r,Nt._TempBuffer[1]=t.g,Nt._TempBuffer[2]=t.b,Nt._TempBuffer[3]=t.a,this.updateUniform(e,Nt._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){Nt._TempBufferInt32View[0]=t,this.updateUniform(e,Nt._TempBuffer,1)}_updateInt2ForEffect(e,t,i,s=""){this._currentEffect.setInt2(e+s,t,i)}_updateInt2ForUniform(e,t,i){Nt._TempBufferInt32View[0]=t,Nt._TempBufferInt32View[1]=i,this.updateUniform(e,Nt._TempBuffer,2)}_updateInt3ForEffect(e,t,i,s,n=""){this._currentEffect.setInt3(e+n,t,i,s)}_updateInt3ForUniform(e,t,i,s){Nt._TempBufferInt32View[0]=t,Nt._TempBufferInt32View[1]=i,Nt._TempBufferInt32View[2]=s,this.updateUniform(e,Nt._TempBuffer,3)}_updateInt4ForEffect(e,t,i,s,n,r=""){this._currentEffect.setInt4(e+r,t,i,s,n)}_updateInt4ForUniform(e,t,i,s,n){Nt._TempBufferInt32View[0]=t,Nt._TempBufferInt32View[1]=i,Nt._TempBufferInt32View[2]=s,Nt._TempBufferInt32View[3]=n,this.updateUniform(e,Nt._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){Nt._TempBufferUInt32View[0]=t,this.updateUniform(e,Nt._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,s=""){this._currentEffect.setUInt2(e+s,t,i)}_updateUInt2ForUniform(e,t,i){Nt._TempBufferUInt32View[0]=t,Nt._TempBufferUInt32View[1]=i,this.updateUniform(e,Nt._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,s,n=""){this._currentEffect.setUInt3(e+n,t,i,s)}_updateUInt3ForUniform(e,t,i,s){Nt._TempBufferUInt32View[0]=t,Nt._TempBufferUInt32View[1]=i,Nt._TempBufferUInt32View[2]=s,this.updateUniform(e,Nt._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,s,n,r=""){this._currentEffect.setUInt4(e+r,t,i,s,n)}_updateUInt4ForUniform(e,t,i,s,n){Nt._TempBufferUInt32View[0]=t,Nt._TempBufferUInt32View[1]=i,Nt._TempBufferUInt32View[2]=s,Nt._TempBufferUInt32View[3]=n,this.updateUniform(e,Nt._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let e=0;e<this._buffers.length;++e){const t=this._buffers[e][0];this._engine._releaseBuffer(t)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}Nt._UpdatedUbosInFrame={},Nt._MAX_UNIFORM_SIZE=256,Nt._TempBuffer=new Float32Array(Nt._MAX_UNIFORM_SIZE),Nt._TempBufferInt32View=new Int32Array(Nt._TempBuffer.buffer),Nt._TempBufferUInt32View=new Uint32Array(Nt._TempBuffer.buffer);class Ft{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}Ft.FALLOFF_DEFAULT=0,Ft.FALLOFF_PHYSICAL=1,Ft.FALLOFF_GLTF=2,Ft.FALLOFF_STANDARD=3,Ft.LIGHTMAP_DEFAULT=0,Ft.LIGHTMAP_SPECULAR=1,Ft.LIGHTMAP_SHADOWSONLY=2,Ft.INTENSITYMODE_AUTOMATIC=0,Ft.INTENSITYMODE_LUMINOUSPOWER=1,Ft.INTENSITYMODE_LUMINOUSINTENSITY=2,Ft.INTENSITYMODE_ILLUMINANCE=3,Ft.INTENSITYMODE_LUMINANCE=4,Ft.LIGHTTYPEID_POINTLIGHT=0,Ft.LIGHTTYPEID_DIRECTIONALLIGHT=1,Ft.LIGHTTYPEID_SPOTLIGHT=2,Ft.LIGHTTYPEID_HEMISPHERICLIGHT=3;class Lt extends et{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t),this.diffuse=new Re(1,1,1),this.specular=new Re(1,1,1),this.falloffType=Lt.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=Lt.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new Nt(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,s,n=!0){var r;const o=e.toString();let a=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+o),this._renderId!==t.getRenderId()||this._lastUseSpecular!==s||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=s;const e=this.getScaledIntensity();this.transferToEffect(i,o),this.diffuse.scaleToRef(e,Pe.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",Pe.Color3[0],this.range,o),s&&(this.specular.scaleToRef(e,Pe.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",Pe.Color3[1],this.radius,o)),a=!0}if(this.transferTexturesToEffect(i,o),t.shadowsEnabled&&this.shadowEnabled&&n){const e=null!==(r=this.getShadowGenerator(t.activeCamera))&&void 0!==r?r:this.getShadowGenerator();e&&(e.bindShadowLight(o,i),a=!0)}a?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){var t;return null===this._shadowGenerators?null:null!==(t=this._shadowGenerators.get(e))&&void 0!==t?t:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return me.Zero()}canAffectMesh(e){return!(e&&(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(e)||this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)||0!==this.includeOnlyWithLayerMask&&0==(this.includeOnlyWithLayerMask&e.layerMask)||0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&e.layerMask))}dispose(e,t=!1){if(this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const e=this._parentContainer.lights.indexOf(this);e>-1&&this._parentContainer.lights.splice(e,1),this._parentContainer=null}for(const e of this.getScene().meshes)e._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=Lt.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const s=qe.Clone(i,this);return e&&(s.name=e),t&&(s.parent=t),s.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(s),s}serialize(){const e=qe.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach((t=>{e.excludedMeshesIds.push(t.id)}))),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach((t=>{e.includedOnlyMeshesIds.push(t.id)}))),qe.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){return et.Construct("Light_Type_"+e,t,i)||null}static Parse(e,t){const i=Lt.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const s=qe.Parse(i,e,t);if(e.excludedMeshesIds&&(s._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(s._includedOnlyMeshesIds=e.includedOnlyMeshesIds),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.falloffType&&(s.falloffType=e.falloffType),void 0!==e.lightmapMode&&(s.lightmapMode=e.lightmapMode),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],n=_e("BABYLON.Animation");n&&s.animations.push(n.Parse(i))}et.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&s.setEnabled(e.isEnabled),s}_hookArrayForExcluded(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);for(const e of i)e._resyncLightSource(this);return s};const i=e.splice;e.splice=(t,s)=>{const n=i.apply(e,[t,s]);for(const e of n)e._resyncLightSource(this);return n};for(const t of e)t._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);return this._resyncMeshes(),s};const i=e.splice;e.splice=(t,s)=>{const n=i.apply(e,[t,s]);return this._resyncMeshes(),n},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)-1!==e.lightSources.indexOf(this)&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===Lt.INTENSITYMODE_AUTOMATIC&&(i=t===Lt.LIGHTTYPEID_DIRECTIONALLIGHT?Lt.INTENSITYMODE_ILLUMINANCE:Lt.INTENSITYMODE_LUMINOUSINTENSITY),t){case Lt.LIGHTTYPEID_POINTLIGHT:case Lt.LIGHTTYPEID_SPOTLIGHT:switch(i){case Lt.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case Lt.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case Lt.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius}break;case Lt.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case Lt.INTENSITYMODE_ILLUMINANCE:e=1;break;case Lt.INTENSITYMODE_LUMINANCE:{let t=this.radius;t=Math.max(t,.001),e=2*Math.PI*(1-Math.cos(t));break}}break;case Lt.LIGHTTYPEID_HEMISPHERICLIGHT:e=1}return e}_reorderLightsInScene(){const e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}Lt.FALLOFF_DEFAULT=Ft.FALLOFF_DEFAULT,Lt.FALLOFF_PHYSICAL=Ft.FALLOFF_PHYSICAL,Lt.FALLOFF_GLTF=Ft.FALLOFF_GLTF,Lt.FALLOFF_STANDARD=Ft.FALLOFF_STANDARD,Lt.LIGHTMAP_DEFAULT=Ft.LIGHTMAP_DEFAULT,Lt.LIGHTMAP_SPECULAR=Ft.LIGHTMAP_SPECULAR,Lt.LIGHTMAP_SHADOWSONLY=Ft.LIGHTMAP_SHADOWSONLY,Lt.INTENSITYMODE_AUTOMATIC=Ft.INTENSITYMODE_AUTOMATIC,Lt.INTENSITYMODE_LUMINOUSPOWER=Ft.INTENSITYMODE_LUMINOUSPOWER,Lt.INTENSITYMODE_LUMINOUSINTENSITY=Ft.INTENSITYMODE_LUMINOUSINTENSITY,Lt.INTENSITYMODE_ILLUMINANCE=Ft.INTENSITYMODE_ILLUMINANCE,Lt.INTENSITYMODE_LUMINANCE=Ft.INTENSITYMODE_LUMINANCE,Lt.LIGHTTYPEID_POINTLIGHT=Ft.LIGHTTYPEID_POINTLIGHT,Lt.LIGHTTYPEID_DIRECTIONALLIGHT=Ft.LIGHTTYPEID_DIRECTIONALLIGHT,Lt.LIGHTTYPEID_SPOTLIGHT=Ft.LIGHTTYPEID_SPOTLIGHT,Lt.LIGHTTYPEID_HEMISPHERICLIGHT=Ft.LIGHTTYPEID_HEMISPHERICLIGHT,De([He()],Lt.prototype,"diffuse",void 0),De([He()],Lt.prototype,"specular",void 0),De([Ge()],Lt.prototype,"falloffType",void 0),De([Ge()],Lt.prototype,"intensity",void 0),De([Ge()],Lt.prototype,"range",null),De([Ge()],Lt.prototype,"intensityMode",null),De([Ge()],Lt.prototype,"radius",null),De([Ge()],Lt.prototype,"_renderPriority",void 0),De([Ve("_reorderLightsInScene")],Lt.prototype,"renderPriority",void 0),De([Ge("shadowEnabled")],Lt.prototype,"_shadowEnabled",void 0),De([Ge("excludeWithLayerMask")],Lt.prototype,"_excludeWithLayerMask",void 0),De([Ge("includeOnlyWithLayerMask")],Lt.prototype,"_includeOnlyWithLayerMask",void 0),De([Ge("lightmapMode")],Lt.prototype,"_lightmapMode",void 0);class wt{constructor(e){this.length=0,this.data=new Array(e),this._id=wt._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return-1!==this.indexOf(e)}}wt._GlobalId=0;class Bt extends wt{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return!(e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId||(this.push(e),0))}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}class Ut{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}toGlobal(e,t){return new Ut(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new Ut(this.x,this.y,this.width,this.height)}}class kt{constructor(e,t,i,s){this.normal=new me(e,t,i),this.d=s}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new kt(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=397*e^(0|this.d),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=kt._TmpMatrix;e.invertToRef(t);const i=t.m,s=this.normal.x,n=this.normal.y,r=this.normal.z,o=this.d,a=s*i[0]+n*i[1]+r*i[2]+o*i[3],l=s*i[4]+n*i[5]+r*i[6]+o*i[7],h=s*i[8]+n*i[9]+r*i[10]+o*i[11],c=s*i[12]+n*i[13]+r*i[14]+o*i[15];return new kt(a,l,h,c)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const s=t.x-e.x,n=t.y-e.y,r=t.z-e.z,o=i.x-e.x,a=i.y-e.y,l=i.z-e.z,h=n*l-r*a,c=r*o-s*l,d=s*a-n*o,u=Math.sqrt(h*h+c*c+d*d);let _;return _=0!==u?1/u:0,this.normal.x=h*_,this.normal.y=c*_,this.normal.z=d*_,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return me.Dot(this.normal,e)<=t}signedDistanceTo(e){return me.Dot(e,this.normal)+this.d}static FromArray(e){return new kt(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const s=new kt(0,0,0,0);return s.copyFromPoints(e,t,i),s}static FromPositionAndNormal(e,t){const i=new kt(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,i)}static FromPositionAndNormalToRef(e,t,i){return i.normal.copyFrom(t),i.normal.normalize(),i.d=-e.dot(i.normal),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const s=-(t.x*e.x+t.y*e.y+t.z*e.z);return me.Dot(i,t)+s}}kt._TmpMatrix=Te.Identity();class Vt{static GetPlanes(e){const t=[];for(let e=0;e<6;e++)t.push(new kt(0,0,0,0));return Vt.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){Vt.GetNearPlaneToRef(e,t[0]),Vt.GetFarPlaneToRef(e,t[1]),Vt.GetLeftPlaneToRef(e,t[2]),Vt.GetRightPlaneToRef(e,t[3]),Vt.GetTopPlaneToRef(e,t[4]),Vt.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}class Gt extends et{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,t,i,s;let n=0,r=0;if(this.mode===Gt.PERSPECTIVE_CAMERA)this.fovMode===Gt.FOVMODE_VERTICAL_FIXED?(r=2*this.minZ*Math.tan(this.fov/2),n=this.getEngine().getAspectRatio(this)*r):(n=2*this.minZ*Math.tan(this.fov/2),r=n/this.getEngine().getAspectRatio(this));else{const o=this.getEngine().getRenderWidth()/2,a=this.getEngine().getRenderHeight()/2;n=(null!==(e=this.orthoRight)&&void 0!==e?e:o)-(null!==(t=this.orthoLeft)&&void 0!==t?t:-o),r=(null!==(i=this.orthoTop)&&void 0!==i?i:a)-(null!==(s=this.orthoBottom)&&void 0!==s?s:-a)}return n*r}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}constructor(e,t,i,n=!0){super(e,i),this._position=me.Zero(),this._upVector=me.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=Gt.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Ut(0,0,1,1),this.layerMask=268435455,this.fovMode=Gt.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=Gt.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new s,this.onProjectionMatrixChangedObservable=new s,this.onAfterCheckInputsObservable=new s,this.onRestoreStateObservable=new s,this.isRigCamera=!1,this._rigCameras=new Array,this._skipRendering=!1,this._projectionMatrix=new Te,this._postProcesses=new Array,this._activeMeshes=new wt(256),this._globalPosition=me.Zero(),this._computedViewMatrix=Te.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=Te.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=ve.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),n&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return!!this._stateStored&&(this.fov=this._storedFov,!0)}restoreState(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}isReady(e=!1){if(e)for(const e of this._postProcesses)if(e&&!e.isReady())return!1;return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return!!super._isSynchronized()&&this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===Gt.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==Gt.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let e=0,t=this._rigCameras.length;e<t;e++){const t=this._rigCameras[e],i=t._rigPostProcess;i?("pass"===i.getEffectName()&&(t.isIntermediate=0===this._postProcesses.length),t._postProcesses=this._postProcesses.slice(0).concat(i),i.markTextureDirty()):t._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(p.Error("You're trying to reuse a post process not defined as reusable."),0):(null==t||t<0?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}_getViewMatrix(){return Te.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()||(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix)),this._computedViewMatrix}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,void 0!==e&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var t,i,s,n,r,o,a,l,h,c,d,u,_,f,p,m,g,v,T;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const b=this.getEngine(),E=this.getScene(),S=b.useReverseDepthBuffer;if(this.mode===Gt.PERSPECTIVE_CAMERA){let e;this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=b.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),e=E.useRightHandedSystem?Te.PerspectiveFovRHToRef:Te.PerspectiveFovLHToRef,e(this.fov,b.getAspectRatio(this),S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===Gt.FOVMODE_VERTICAL_FIXED,b.isNDCHalfZRange,this.projectionPlaneTilt,S)}else{const e=b.getRenderWidth()/2,x=b.getRenderHeight()/2;E.useRightHandedSystem?this.oblique?Te.ObliqueOffCenterRHToRef(null!==(t=this.orthoLeft)&&void 0!==t?t:-e,null!==(i=this.orthoRight)&&void 0!==i?i:e,null!==(s=this.orthoBottom)&&void 0!==s?s:-x,null!==(n=this.orthoTop)&&void 0!==n?n:x,S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,b.isNDCHalfZRange):Te.OrthoOffCenterRHToRef(null!==(r=this.orthoLeft)&&void 0!==r?r:-e,null!==(o=this.orthoRight)&&void 0!==o?o:e,null!==(a=this.orthoBottom)&&void 0!==a?a:-x,null!==(l=this.orthoTop)&&void 0!==l?l:x,S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this._projectionMatrix,b.isNDCHalfZRange):this.oblique?Te.ObliqueOffCenterLHToRef(null!==(h=this.orthoLeft)&&void 0!==h?h:-e,null!==(c=this.orthoRight)&&void 0!==c?c:e,null!==(d=this.orthoBottom)&&void 0!==d?d:-x,null!==(u=this.orthoTop)&&void 0!==u?u:x,S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,b.isNDCHalfZRange):Te.OrthoOffCenterLHToRef(null!==(_=this.orthoLeft)&&void 0!==_?_:-e,null!==(f=this.orthoRight)&&void 0!==f?f:e,null!==(p=this.orthoBottom)&&void 0!==p?p:-x,null!==(m=this.orthoTop)&&void 0!==m?m:x,S?this.maxZ:this.minZ,S?this.minZ:this.maxZ,this._projectionMatrix,b.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=null===(g=this.oblique)||void 0===g?void 0:g.angle,this._cache.obliqueLength=null===(v=this.oblique)||void 0===v?void 0:v.length,this._cache.obliqueOffset=null===(T=this.oblique)||void 0===T?void 0:T.offset,this._cache.renderWidth=b.getRenderWidth(),this._cache.renderHeight=b.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){return(this.radius||(this.target?me.Distance(this.position,this.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?Vt.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Vt.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let t=!1;return this.rigCameras.forEach((i=>{i._updateFrustumPlanes(),t=t||e.isInFrustum(i._frustumPlanes)})),t}return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw f("Ray")}getForwardRayToRef(e,t=100,i,s){throw f("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose()}if(this._parentContainer){const e=this._parentContainer.cameras.indexOf(this);e>-1&&this._parentContainer.cameras.splice(e,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==Gt.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let e=this._postProcesses.length;for(;--e>=0;){const t=this._postProcesses[e];t&&t.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const e=this._rigCameras.pop();e&&e.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=Ot.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==Gt.RIG_MODE_NONE){const e=this.createRigCamera(this.name+"_L",0);e&&(e._isLeftCamera=!0);const t=this.createRigCamera(this.name+"_R",1);t&&(t._isRightCamera=!0),e&&t&&(this._rigCameras.push(e),this._rigCameras.push(t))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return Te.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=Ot.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===Gt.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=qe.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),qe.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=qe.Clone(Gt.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=me.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){me.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,s=0,n=!0){return et.Construct(e,t,i,{interaxial_distance:s,isStereoscopicSideBySide:n})||(()=>Gt._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,s=Gt.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),n=qe.Parse(s,e,t);if(void 0!==e.parentId&&(n._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),n.inputs&&(n.inputs.parse(e),n._setupInputs()),e.upVector&&(n.upVector=me.FromArray(e.upVector)),n.setPosition&&(n.position.copyFromFloats(0,0,0),n.setPosition(me.FromArray(e.position))),e.target&&n.setTarget&&n.setTarget(me.FromArray(e.target)),e.cameraRigMode){const t=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};n.setCameraRigMode(e.cameraRigMode,t)}if(e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],s=_e("BABYLON.Animation");s&&n.animations.push(s.Parse(i))}et.ParseAnimationRanges(n,e,t)}return e.autoAnimate&&t.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&n.setEnabled(e.isEnabled),n}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}Gt._CreateDefaultParsedCamera=(e,t)=>{throw f("UniversalCamera")},Gt.PERSPECTIVE_CAMERA=0,Gt.ORTHOGRAPHIC_CAMERA=1,Gt.FOVMODE_VERTICAL_FIXED=0,Gt.FOVMODE_HORIZONTAL_FIXED=1,Gt.RIG_MODE_NONE=0,Gt.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,Gt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,Gt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,Gt.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,Gt.RIG_MODE_STEREOSCOPIC_INTERLACED=14,Gt.RIG_MODE_VR=20,Gt.RIG_MODE_CUSTOM=22,Gt.ForceAttachControlToAlwaysPreventDefault=!1,De([Qe("position")],Gt.prototype,"_position",void 0),De([Qe("upVector")],Gt.prototype,"_upVector",void 0),De([Ge()],Gt.prototype,"orthoLeft",null),De([Ge()],Gt.prototype,"orthoRight",null),De([Ge()],Gt.prototype,"orthoBottom",null),De([Ge()],Gt.prototype,"orthoTop",null),De([Ge()],Gt.prototype,"fov",void 0),De([Ge()],Gt.prototype,"projectionPlaneTilt",void 0),De([Ge()],Gt.prototype,"minZ",void 0),De([Ge()],Gt.prototype,"maxZ",void 0),De([Ge()],Gt.prototype,"inertia",void 0),De([Ge()],Gt.prototype,"mode",null),De([Ge()],Gt.prototype,"layerMask",void 0),De([Ge()],Gt.prototype,"fovMode",void 0),De([Ge()],Gt.prototype,"cameraRigMode",void 0),De([Ge()],Gt.prototype,"interaxialDistance",void 0),De([Ge()],Gt.prototype,"isStereoscopicSideBySide",void 0);class zt{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach(((e,t)=>this.add(e,t)))}get(e){const t=this._data[e];if(void 0!==t)return t}getOrAddWithFactory(e,t){let i=this.get(e);return void 0!==i||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return void 0!==i?i:(this.add(e,t),t)}contains(e){return void 0!==this._data[e]}add(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)}set(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}remove(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data)e(t,this._data[t])}first(e){for(const t in this._data){const i=e(t,this._data[t]);if(i)return i}return null}}class Ht{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[]}static AddParser(e,t){this._BabylonFileParsers[e]=t}static GetParser(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}static AddIndividualParser(e,t){this._IndividualBabylonFileParsers[e]=t}static GetIndividualParser(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}static Parse(e,t,i,s){for(const n in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,n)&&this._BabylonFileParsers[n](e,t,i,s)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach((t=>e=e.concat(t.bones))),e}}Ht._BabylonFileParsers={},Ht._IndividualBabylonFileParsers={};class Wt{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!1,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))"_"!==e[0]&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)-1===this._keys.indexOf(e)&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach((e=>this._setDefaultValue(e)))}_setDefaultValue(e){var t,i,s,n,r;const o=null!==(s=null===(i=null===(t=this._externalProperties)||void 0===t?void 0:t[e])||void 0===i?void 0:i.type)&&void 0!==s?s:typeof this[e],a=null===(r=null===(n=this._externalProperties)||void 0===n?void 0:n[e])||void 0===r?void 0:r.default;switch(o){case"number":this[e]=null!=a?a:0;break;case"string":this[e]=null!=a?a:"";break;default:this[e]=null!=a&&a}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=this[i];switch(typeof s){case"number":case"string":e+="#define "+i+" "+s+"\n";break;default:s&&(e+="#define "+i+"\n")}}return e}}class Xt{constructor(){this._dirty=!0,this._tempColor=new Ie(0,0,0,0),this._globalCurve=new Ie(0,0,0,0),this._highlightsCurve=new Ie(0,0,0,0),this._midtonesCurve=new Ie(0,0,0,0),this._shadowsCurve=new Ie(0,0,0,0),this._positiveCurve=new Ie(0,0,0,0),this._negativeCurve=new Ie(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",s="vCameraColorCurveNeutral",n="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(s,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(n,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(e,t,i,s,n){null!=e&&(e=Xt._Clamp(e,0,360),t=Xt._Clamp(t,-100,100),i=Xt._Clamp(i,-100,100),s=Xt._Clamp(s,-100,100),t=Xt._ApplyColorGradingSliderNonlinear(t),t*=.5,s=Xt._ApplyColorGradingSliderNonlinear(s),t<0&&(t*=-1,e=(e+180)%360),Xt._FromHSBToRef(e,t,50+.25*s,n),n.scaleToRef(2,n),n.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,s){let n=Xt._Clamp(e,0,360);const r=Xt._Clamp(t/100,0,1),o=Xt._Clamp(i/100,0,1);if(0===r)s.r=o,s.g=o,s.b=o;else{n/=60;const e=Math.floor(n),t=n-e,i=o*(1-r),a=o*(1-r*t),l=o*(1-r*(1-t));switch(e){case 0:s.r=o,s.g=l,s.b=i;break;case 1:s.r=a,s.g=o,s.b=i;break;case 2:s.r=i,s.g=o,s.b=l;break;case 3:s.r=i,s.g=a,s.b=o;break;case 4:s.r=l,s.g=i,s.b=o;break;default:s.r=o,s.g=i,s.b=a}}s.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return qe.Clone((()=>new Xt),this)}serialize(){return qe.Serialize(this)}static Parse(e){return qe.Parse((()=>new Xt),e,null,null)}}De([Ge()],Xt.prototype,"_globalHue",void 0),De([Ge()],Xt.prototype,"_globalDensity",void 0),De([Ge()],Xt.prototype,"_globalSaturation",void 0),De([Ge()],Xt.prototype,"_globalExposure",void 0),De([Ge()],Xt.prototype,"_highlightsHue",void 0),De([Ge()],Xt.prototype,"_highlightsDensity",void 0),De([Ge()],Xt.prototype,"_highlightsSaturation",void 0),De([Ge()],Xt.prototype,"_highlightsExposure",void 0),De([Ge()],Xt.prototype,"_midtonesHue",void 0),De([Ge()],Xt.prototype,"_midtonesDensity",void 0),De([Ge()],Xt.prototype,"_midtonesSaturation",void 0),De([Ge()],Xt.prototype,"_midtonesExposure",void 0),qe._ColorCurvesParser=Xt.Parse;class Qt extends Wt{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class Yt{constructor(){this.colorCurves=new Xt,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=Yt.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new Ie(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=Yt.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new s}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&Xt.PrepareUniforms(e),t.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,t){t.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled)return e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,void(e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled);e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===Yt._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType===Yt.TONEMAPPING_ACES?e.TONEMAPPING_ACES=!0:e.TONEMAPPING_ACES=!1,e.CONTRAST=1!==this.contrast,e.EXPOSURE=1!==this.exposure,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&Xt.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),s=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,s),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const n=null!=t?t:s/i;let r=Math.tan(.5*this.vignetteCameraFov),o=r*n;const a=Math.sqrt(o*r);o=Ot.Mix(o,a,this.vignetteStretch),r=Ot.Mix(r,a,this.vignetteStretch),e.setFloat4("vignetteSettings1",o,r,-o*this.vignetteCenterX,-r*this.vignetteCenterY);const l=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,l)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const t=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(t-1)/t,.5/t,t,this.colorGradingTexture.level)}}clone(){return qe.Clone((()=>new Yt),this)}serialize(){return qe.Serialize(this)}static Parse(e){const t=qe.Parse((()=>new Yt),e,null,null);return void 0!==e.vignetteCentreX&&(t.vignetteCenterX=e.vignetteCentreX),void 0!==e.vignetteCentreY&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}var Kt,jt,$t,qt,Zt,Jt,ei,ti;Yt.TONEMAPPING_STANDARD=0,Yt.TONEMAPPING_ACES=1,Yt._VIGNETTEMODE_MULTIPLY=0,Yt._VIGNETTEMODE_OPAQUE=1,De([ke(7,undefined)],Yt.prototype,"colorCurves",void 0),De([Ge()],Yt.prototype,"_colorCurvesEnabled",void 0),De([ze("colorGradingTexture")],Yt.prototype,"_colorGradingTexture",void 0),De([Ge()],Yt.prototype,"_colorGradingEnabled",void 0),De([Ge()],Yt.prototype,"_colorGradingWithGreenDepth",void 0),De([Ge()],Yt.prototype,"_colorGradingBGR",void 0),De([Ge()],Yt.prototype,"_exposure",void 0),De([Ge()],Yt.prototype,"_toneMappingEnabled",void 0),De([Ge()],Yt.prototype,"_toneMappingType",void 0),De([Ge()],Yt.prototype,"_contrast",void 0),De([Ge()],Yt.prototype,"vignetteStretch",void 0),De([Ge()],Yt.prototype,"vignetteCenterX",void 0),De([Ge()],Yt.prototype,"vignetteCenterY",void 0),De([Ge()],Yt.prototype,"vignetteWeight",void 0),De([Ke()],Yt.prototype,"vignetteColor",void 0),De([Ge()],Yt.prototype,"vignetteCameraFov",void 0),De([Ge()],Yt.prototype,"_vignetteBlendMode",void 0),De([Ge()],Yt.prototype,"_vignetteEnabled",void 0),De([Ge()],Yt.prototype,"_ditheringEnabled",void 0),De([Ge()],Yt.prototype,"_ditheringIntensity",void 0),De([Ge()],Yt.prototype,"_skipFinalColorClamp",void 0),De([Ge()],Yt.prototype,"_applyByPostProcess",void 0),De([Ge()],Yt.prototype,"_isEnabled",void 0),qe._ImageProcessingConfigurationParser=Yt.Parse;class ii{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(Oe.NormalKind))return null;let i,s=this.pickedMesh.getIndices();0===(null==s?void 0:s.length)&&(s=null);const n=Ee.Vector3[0],r=Ee.Vector3[1],o=Ee.Vector3[2];if(t){const e=this.pickedMesh.getVerticesData(Oe.NormalKind);let t=s?me.FromArrayToRef(e,3*s[3*this.faceId],n):n.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),a=s?me.FromArrayToRef(e,3*s[3*this.faceId+1],r):r.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),l=s?me.FromArrayToRef(e,3*s[3*this.faceId+2],o):o.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]);t=t.scale(this.bu),a=a.scale(this.bv),l=l.scale(1-this.bu-this.bv),i=new me(t.x+a.x+l.x,t.y+a.y+l.y,t.z+a.z+l.z)}else{const e=this.pickedMesh.getVerticesData(Oe.PositionKind),t=s?me.FromArrayToRef(e,3*s[3*this.faceId],n):n.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),a=s?me.FromArrayToRef(e,3*s[3*this.faceId+1],r):r.copyFromFloats(e[3*(3*this.faceId+1)],e[3*(3*this.faceId+1)+1],e[3*(3*this.faceId+1)+2]),l=s?me.FromArrayToRef(e,3*s[3*this.faceId+2],o):o.copyFromFloats(e[3*(3*this.faceId+2)],e[3*(3*this.faceId+2)+1],e[3*(3*this.faceId+2)+2]),h=t.subtract(a),c=l.subtract(a);i=me.Cross(h,c)}const a=(e,t)=>{let i=e.getWorldMatrix();e.nonUniformScaling&&(Ee.Matrix[0].copyFrom(i),i=Ee.Matrix[0],i.setTranslationFromFloats(0,0,0),i.invert(),i.transposeToRef(Ee.Matrix[1]),i=Ee.Matrix[1]),me.TransformNormalToRef(t,i,t)};if(e&&a(this.pickedMesh,i),this.ray){const t=Ee.Vector3[0].copyFrom(i);e||a(this.pickedMesh,t),me.Dot(t,this.ray.direction)>0&&i.negateInPlace()}return i.normalize(),i}getTextureCoordinates(e=Oe.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let s=pe.FromArray(i,2*t[3*this.faceId]),n=pe.FromArray(i,2*t[3*this.faceId+1]),r=pe.FromArray(i,2*t[3*this.faceId+2]);return s=s.scale(this.bu),n=n.scale(this.bv),r=r.scale(1-this.bu-this.bv),new pe(s.x+n.x+r.x,s.y+n.y+r.y)}}class si{constructor(e,t,i,s,n,r){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=s,this.sourceEvent=n,this.additionalData=r}static CreateNew(e,t,i){const s=e.getScene();return new si(e,s.pointerX,s.pointerY,s.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,s){return new si(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,s)}static CreateNewFromScene(e,t){return new si(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,s){return new si(e,t.x,t.y,null,i,s)}}class ni{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[Oe.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[Oe.PositionKind]=new Oe(this._scene.getEngine(),e,Oe.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[Oe.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!(!i||!(t=t||i._postProcesses.filter((e=>null!=e)))||0===t.length||!this._scene.postProcessesEnabled||(t[0].activate(i,e,null!=t),0))}directRender(e,t=null,i=!1,s=0,n=0,r=!1){var o;const a=this._scene.getEngine();for(let l=0;l<e.length;l++){l<e.length-1?e[l+1].activate(this._scene.activeCamera,null==t?void 0:t.texture):(t?a.bindFramebuffer(t,s,void 0,void 0,i,n):r||a.restoreDefaultFramebuffer(),null===(o=a._debugInsertMarker)||void 0===o||o.call(a,`post process ${e[l].name} output`));const h=e[l],c=h.apply();c&&(h.onBeforeRenderObservable.notifyObservers(c),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,c),a.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(c))}a.setDepthBuffer(!0),a.setDepthWrite(!0)}_finalizeFrame(e,t,i,s,n=!1){var r;const o=this._scene.activeCamera;if(!o)return;if(0===(s=s||o._postProcesses.filter((e=>null!=e))).length||!this._scene.postProcessesEnabled)return;const a=this._scene.getEngine();for(let l=0,h=s.length;l<h;l++){const c=s[l];if(l<h-1?c._outputTexture=s[l+1].activate(o,null==t?void 0:t.texture):(t?(a.bindFramebuffer(t,i,void 0,void 0,n),c._outputTexture=t):(a.restoreDefaultFramebuffer(),c._outputTexture=null),null===(r=a._debugInsertMarker)||void 0===r||r.call(a,`post process ${s[l].name} output`)),e)break;const d=c.apply();d&&(c.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,d),a.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(d))}a.setDepthBuffer(!0),a.setDepthWrite(!0),a.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[Oe.PositionKind];e&&(e.dispose(),this._vertexBuffers[Oe.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class ri{set opaqueSortCompareFn(e){this._opaqueSortCompareFn=e||ri.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){this._alphaTestSortCompareFn=e||ri.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){this._transparentSortCompareFn=e||ri.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,s=null,n=null){this.index=e,this._opaqueSubMeshes=new wt(256),this._transparentSubMeshes=new wt(256),this._alphaTestSubMeshes=new wt(256),this._depthOnlySubMeshes=new wt(256),this._particleSystems=new wt(256),this._spriteManagers=new wt(256),this._empty=!0,this._edgesRenderers=new Bt(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=s,this.transparentSortCompareFn=n}render(e,t,i,s){if(e)return void e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);const n=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(n.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),n.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);const r=n.getStencilBuffer();if(n.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(s),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency){if(n.setStencilBuffer(r),this._scene.useOrderIndependentTransparency){const e=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);e.length&&this._renderTransparent(e)}else this._renderTransparent(this._transparentSubMeshes);n.setAlphaMode(0)}if(n.setStencilBuffer(!1),this._edgesRenderers.length){for(let e=0;e<this._edgesRenderers.length;e++)this._edgesRenderers.data[e].render();n.setAlphaMode(0)}n.setStencilBuffer(r)}_renderOpaqueSorted(e){return ri._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){return ri._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){return ri._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,s){let n,r=0;const o=i?i.globalPosition:ri._ZeroVector;if(s)for(;r<e.length;r++)n=e.data[r],n._alphaIndex=n.getMesh().alphaIndex,n._distanceToCamera=me.Distance(n.getBoundingInfo().boundingSphere.centerWorld,o);const a=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&a.sort(t);const l=a[0].getMesh().getScene();for(r=0;r<a.length;r++)if(n=a[r],!l._activeMeshesFrozenButKeepClipping||n.isInFrustum(l._frustumPlanes)){if(s){const e=n.getMaterial();if(e&&e.needDepthPrePass){const t=e.getScene().getEngine();t.setColorWrite(!1),t.setAlphaMode(0),n.render(!1),t.setColorWrite(!0)}}n.render(s)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:ri.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),s=t.getMesh();return i.material&&s.material?i.material.uniqueId-s.material.uniqueId:i.uniqueId-s.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){void 0===t&&(t=e.getMesh()),void 0===i&&(i=e.getMaterial()),null!=i&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(0===this._particleSystems.length)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const s=this._particleSystems.data[i];if(0===(t&&t.layerMask&s.layerMask))continue;const n=s.emitter;n.position&&e&&-1===e.indexOf(n)||this._scene._activeParticles.addCount(s.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||0===this._spriteManagers.length)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];0!==(e&&e.layerMask&i.layerMask)&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}ri._ZeroVector=me.Zero();class oi{}class ai{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=!1;for(const e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new oi,this._maintainStateBetweenFrames=!1,this._scene=e;for(let e=ai.MIN_RENDERINGGROUPS;e<ai.MAX_RENDERINGGROUPS;e++)this._autoClearDepthStencil[e]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,s){const n=this._renderingGroupInfo;if(n.scene=this._scene,n.camera=this._scene.activeCamera,this._scene.spriteManagers&&s)for(let e=0;e<this._scene.spriteManagers.length;e++){const t=this._scene.spriteManagers[e];this.dispatchSprites(t)}for(let r=ai.MIN_RENDERINGGROUPS;r<ai.MAX_RENDERINGGROUPS;r++){this._depthStencilBufferAlreadyCleaned=r===ai.MIN_RENDERINGGROUPS;const o=this._renderingGroups[r];if(!o||o._empty)continue;const a=Math.pow(2,r);if(n.renderingGroupId=r,this._scene.onBeforeRenderingGroupObservable.notifyObservers(n,a),ai.AUTOCLEAR){const e=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(r):this._autoClearDepthStencil[r];e&&e.autoClear&&this._clearDepthStencilBuffer(e.depth,e.stencil)}for(const e of this._scene._beforeRenderingGroupDrawStage)e.action(r);o.render(e,s,i,t);for(const e of this._scene._afterRenderingGroupDrawStage)e.action(r);this._scene.onAfterRenderingGroupObservable.notifyObservers(n,a)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=ai.MIN_RENDERINGGROUPS;e<ai.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=ai.MIN_RENDERINGGROUPS;e<ai.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=ai.MIN_RENDERINGGROUPS;e<ai.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){void 0===this._renderingGroups[e]&&(this._renderingGroups[e]=new ri(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){void 0===t&&(t=e.getMesh()),this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,s=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=s,this._renderingGroups[e]){const t=this._renderingGroups[e];t.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],t.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],t.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:s}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}ai.MAX_RENDERINGGROUPS=4,ai.MIN_RENDERINGGROUPS=0,ai.AUTOCLEAR=!0;class li{}li.NAME_EFFECTLAYER="EffectLayer",li.NAME_LAYER="Layer",li.NAME_LENSFLARESYSTEM="LensFlareSystem",li.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",li.NAME_PARTICLESYSTEM="ParticleSystem",li.NAME_GAMEPAD="Gamepad",li.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",li.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",li.NAME_PREPASSRENDERER="PrePassRenderer",li.NAME_DEPTHRENDERER="DepthRenderer",li.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",li.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",li.NAME_SPRITE="Sprite",li.NAME_SUBSURFACE="SubSurface",li.NAME_OUTLINERENDERER="Outline",li.NAME_PROCEDURALTEXTURE="ProceduralTexture",li.NAME_SHADOWGENERATOR="ShadowGenerator",li.NAME_OCTREE="Octree",li.NAME_PHYSICSENGINE="PhysicsEngine",li.NAME_AUDIO="Audio",li.NAME_FLUIDRENDERER="FluidRenderer",li.STEP_ISREADYFORMESH_EFFECTLAYER=0,li.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,li.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,li.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,li.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,li.STEP_BEFORECAMERADRAW_PREPASS=0,li.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,li.STEP_BEFORECAMERADRAW_LAYER=2,li.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,li.STEP_BEFORERENDERTARGETDRAW_LAYER=1,li.STEP_BEFORERENDERINGMESH_PREPASS=0,li.STEP_BEFORERENDERINGMESH_OUTLINE=1,li.STEP_AFTERRENDERINGMESH_PREPASS=0,li.STEP_AFTERRENDERINGMESH_OUTLINE=1,li.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,li.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,li.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,li.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,li.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,li.STEP_BEFORECLEAR_PREPASS=1,li.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,li.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,li.STEP_AFTERRENDERTARGETDRAW_LAYER=1,li.STEP_AFTERCAMERADRAW_PREPASS=0,li.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,li.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,li.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,li.STEP_AFTERCAMERADRAW_LAYER=4,li.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,li.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,li.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,li.STEP_AFTERRENDER_AUDIO=0,li.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,li.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,li.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,li.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,li.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,li.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,li.STEP_POINTERMOVE_SPRITE=0,li.STEP_POINTERDOWN_SPRITE=0,li.STEP_POINTERUP_SPRITE=0;class hi extends Array{constructor(e){super(...e)}static Create(){return Object.create(hi.prototype)}registerStep(e,t,i){let s=0,n=Number.MAX_VALUE;for(;s<this.length&&(n=this[s].index,!(e<n));s++);this.splice(s,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}class ci{}ci.POINTERDOWN=1,ci.POINTERUP=2,ci.POINTERMOVE=4,ci.POINTERWHEEL=8,ci.POINTERPICK=16,ci.POINTERTAP=32,ci.POINTERDOUBLETAP=64;class di{constructor(e,t){this.type=e,this.event=t}}class ui extends di{constructor(e,t,i,s){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new pe(i,s)}}class _i extends di{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,s=null){super(e,t),this._pickInfo=i,this._inputManager=s}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}class fi{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1}static get HasTriggers(){for(const e in fi.Triggers)if(Object.prototype.hasOwnProperty.call(fi.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in fi.Triggers)if(Object.prototype.hasOwnProperty.call(fi.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in fi.Triggers)if(Object.prototype.hasOwnProperty.call(fi.Triggers,t)&&parseInt(t)===e)return!0;return!1}}fi.Triggers={};class pi{}pi.KEYDOWN=1,pi.KEYUP=2;class mi{constructor(e,t){this.type=e,this.event=t}}class gi extends mi{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}!function(e){e[e.Generic=0]="Generic",e[e.Keyboard=1]="Keyboard",e[e.Mouse=2]="Mouse",e[e.Touch=3]="Touch",e[e.DualShock=4]="DualShock",e[e.Xbox=5]="Xbox",e[e.Switch=6]="Switch",e[e.DualSense=7]="DualSense"}(Kt||(Kt={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.Move=12]="Move"}(jt||(jt={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.LeftClick=2]="LeftClick",e[e.MiddleClick=3]="MiddleClick",e[e.RightClick=4]="RightClick",e[e.BrowserBack=5]="BrowserBack",e[e.BrowserForward=6]="BrowserForward",e[e.MouseWheelX=7]="MouseWheelX",e[e.MouseWheelY=8]="MouseWheelY",e[e.MouseWheelZ=9]="MouseWheelZ",e[e.DeltaHorizontal=10]="DeltaHorizontal",e[e.DeltaVertical=11]="DeltaVertical"}($t||($t={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(qt||(qt={})),function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.L2=6]="L2",e[e.R2=7]="R2",e[e.Create=8]="Create",e[e.Options=9]="Options",e[e.L3=10]="L3",e[e.R3=11]="R3",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.TouchPad=17]="TouchPad",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(Zt||(Zt={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.LT=6]="LT",e[e.RT=7]="RT",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.LStickXAxis=17]="LStickXAxis",e[e.LStickYAxis=18]="LStickYAxis",e[e.RStickXAxis=19]="RStickXAxis",e[e.RStickYAxis=20]="RStickYAxis"}(Jt||(Jt={})),function(e){e[e.B=0]="B",e[e.A=1]="A",e[e.Y=2]="Y",e[e.X=3]="X",e[e.L=4]="L",e[e.R=5]="R",e[e.ZL=6]="ZL",e[e.ZR=7]="ZR",e[e.Minus=8]="Minus",e[e.Plus=9]="Plus",e[e.LS=10]="LS",e[e.RS=11]="RS",e[e.DPadUp=12]="DPadUp",e[e.DPadDown=13]="DPadDown",e[e.DPadLeft=14]="DPadLeft",e[e.DPadRight=15]="DPadRight",e[e.Home=16]="Home",e[e.Capture=17]="Capture",e[e.LStickXAxis=18]="LStickXAxis",e[e.LStickYAxis=19]="LStickYAxis",e[e.RStickXAxis=20]="RStickXAxis",e[e.RStickYAxis=21]="RStickYAxis"}(ei||(ei={})),function(e){e[e.PointerMove=0]="PointerMove",e[e.PointerDown=1]="PointerDown",e[e.PointerUp=2]="PointerUp"}(ti||(ti={}));class vi{}vi.DOM_DELTA_PIXEL=0,vi.DOM_DELTA_LINE=1,vi.DOM_DELTA_PAGE=2;class Ti{static CreateDeviceEvent(e,t,i,s,n,r,o){switch(e){case Kt.Keyboard:return this._CreateKeyboardEvent(i,s,n,r);case Kt.Mouse:if(i===jt.MouseWheelX||i===jt.MouseWheelY||i===jt.MouseWheelZ)return this._CreateWheelEvent(e,t,i,s,n,r);case Kt.Touch:return this._CreatePointerEvent(e,t,i,s,n,r,o);default:throw`Unable to generate event for device ${Kt[e]}`}}static _CreatePointerEvent(e,t,i,s,n,r,o){const a=this._CreateMouseEvent(e,t,i,s,n,r);e===Kt.Mouse?(a.deviceType=Kt.Mouse,a.pointerId=1,a.pointerType="mouse"):(a.deviceType=Kt.Touch,a.pointerId=null!=o?o:t,a.pointerType="touch");let l=0;return l+=n.pollInput(e,t,jt.LeftClick),l+=2*n.pollInput(e,t,jt.RightClick),l+=4*n.pollInput(e,t,jt.MiddleClick),a.buttons=l,i===jt.Move?a.type="pointermove":i>=jt.LeftClick&&i<=jt.RightClick&&(a.type=1===s?"pointerdown":"pointerup",a.button=i-2),a}static _CreateWheelEvent(e,t,i,s,n,r){const o=this._CreateMouseEvent(e,t,i,s,n,r);switch(o.pointerId=1,o.type="wheel",o.deltaMode=vi.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case jt.MouseWheelX:o.deltaX=s;break;case jt.MouseWheelY:o.deltaY=s;break;case jt.MouseWheelZ:o.deltaZ=s}return o}static _CreateMouseEvent(e,t,i,s,n,r){const o=this._CreateEvent(r),a=n.pollInput(e,t,jt.Horizontal),l=n.pollInput(e,t,jt.Vertical);return r?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-r.getBoundingClientRect().x,o.offsetY=o.movementY-r.getBoundingClientRect().y):(o.movementX=n.pollInput(e,t,$t.DeltaHorizontal),o.movementY=n.pollInput(e,t,$t.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,n),o.clientX=a,o.clientY=l,o.x=a,o.y=l,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,s){const n=this._CreateEvent(s);return this._CheckNonCharacterKeys(n,i),n.deviceType=Kt.Keyboard,n.deviceSlot=0,n.inputIndex=e,n.type=1===t?"keydown":"keyup",n.key=String.fromCharCode(e),n.keyCode=e,n}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(Kt.Keyboard),s=i&&1===t.pollInput(Kt.Keyboard,0,18),n=i&&1===t.pollInput(Kt.Keyboard,0,17),r=i&&(1===t.pollInput(Kt.Keyboard,0,91)||1===t.pollInput(Kt.Keyboard,0,92)||1===t.pollInput(Kt.Keyboard,0,93)),o=i&&1===t.pollInput(Kt.Keyboard,0,16);e.altKey=s,e.ctrlKey=n,e.metaKey=r,e.shiftKey=o}static _CreateEvent(e){const t={preventDefault:()=>{}};return t.target=e,t}}class bi{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,((e,t,s,n)=>{const r=Ti.CreateDeviceEvent(e,t,s,n,this);i(e,t,r)})):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===Kt.Mouse||e===Kt.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const Ei=Object.keys(jt).length/2;class Si{constructor(e,t,i,s){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=Ot.IsSafari(),this._usingMacOS=h()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._pointerMacOSChromeOutEvent=e=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=h()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._isUsingChromium=h()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Chrome"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=Ot.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=s,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const s=this._inputs[e][t];if(!s)throw`Unable to find device ${Kt[e]}`;e>=Kt.DualShock&&e<=Kt.DualSense&&this._updateDevice(e,t,i);const n=s[i];if(void 0===n)throw`Unable to find input ${i} for device ${Kt[e]} in slot ${t}`;return i===jt.Move&&Ot.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),n}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=null==this?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs)for(const e of this._inputs)if(e)for(const t in e){const i=e[+t];if(i)for(let e=0;e<i.length;e++)i[e]=0}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOS&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Kt.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,s){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,Ei);const n=this._inputs[e][t];n[0]=i,n[1]=s}_registerDevice(e,t,i){if(void 0===t)throw`Unable to register device ${Kt[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const s=new Array(i);s.fill(0),this._inputs[e][t]=s,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Kt.Keyboard,0,255));const t=this._inputs[Kt.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&"Meta"!==e.key&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(Kt.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Kt.Keyboard,0,255));const t=this._inputs[Kt.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&"Meta"===e.key&&this._metaKeys.length>0){for(const e of this._metaKeys){const i=Ti.CreateDeviceEvent(Kt.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(Kt.Keyboard,0,i)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(Kt.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[Kt.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;const i=Ti.CreateDeviceEvent(Kt.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Kt.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=h()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{const t=this._getPointerType(e);let i=t===Kt.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===Kt.Touch&&-1===i){const s=this._activeTouchIds.indexOf(-1);if(!(s>=0))return void Ot.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=s,this._activeTouchIds[s]=e.pointerId,this._onDeviceConnected(t,i)}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]||this._addPointerDevice(t,i,e.clientX,e.clientY);const s=this._inputs[t][i];if(s){const n=e;n.inputIndex=jt.Move,s[jt.Horizontal]=e.clientX,s[jt.Vertical]=e.clientY,t===Kt.Touch&&0===s[jt.LeftClick]&&(s[jt.LeftClick]=1),void 0===e.pointerId&&(e.pointerId=this._mouseId),this._onInputChanged(t,i,n),this._usingSafari||-1===e.button||(n.inputIndex=e.button+2,s[e.button+2]=s[e.button+2]?0:1,this._onInputChanged(t,i,n))}},this._pointerDownEvent=e=>{const t=this._getPointerType(e);let i=t===Kt.Mouse?0:e.pointerId;if(t===Kt.Touch){const t=this._activeTouchIds.indexOf(-1);if(!(t>=0))return void Ot.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=t,this._activeTouchIds[t]=e.pointerId}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]?t===Kt.Touch&&this._onDeviceConnected(t,i):this._addPointerDevice(t,i,e.clientX,e.clientY);const s=this._inputs[t][i];if(s){const n=s[jt.Horizontal],r=s[jt.Vertical];if(t===Kt.Mouse){if(void 0===e.pointerId&&(e.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(e){}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId)}catch(e){}s[jt.Horizontal]=e.clientX,s[jt.Vertical]=e.clientY,s[e.button+2]=1;const o=e;o.inputIndex=e.button+2,this._onInputChanged(t,i,o),n===e.clientX&&r===e.clientY||(o.inputIndex=jt.Move,this._onInputChanged(t,i,o))}},this._pointerUpEvent=e=>{var t,i,s,n,r;const o=this._getPointerType(e),a=o===Kt.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(o===Kt.Touch){if(-1===a)return;this._activeTouchIds[a]=-1}const l=null===(t=this._inputs[o])||void 0===t?void 0:t[a];if(l&&0!==l[e.button+2]){const t=l[jt.Horizontal],h=l[jt.Vertical];l[jt.Horizontal]=e.clientX,l[jt.Vertical]=e.clientY,l[e.button+2]=0;const c=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),t===e.clientX&&h===e.clientY||(c.inputIndex=jt.Move,this._onInputChanged(o,a,c)),c.inputIndex=e.button+2,o===Kt.Mouse&&this._mouseId>=0&&(null===(s=(i=this._elementToAttachTo).hasPointerCapture)||void 0===s?void 0:s.call(i,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&(null===(r=(n=this._elementToAttachTo).hasPointerCapture)||void 0===r?void 0:r.call(n,e.pointerId))&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(o,a,c),o===Kt.Touch&&this._onDeviceDisconnected(o,a)}},this._pointerCancelEvent=e=>{var t,i,s,n;if("mouse"===e.pointerType){const e=this._inputs[Kt.Mouse][0];this._mouseId>=0&&(null===(i=(t=this._elementToAttachTo).hasPointerCapture)||void 0===i?void 0:i.call(t,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=jt.LeftClick;t<=jt.BrowserForward;t++)if(1===e[t]){e[t]=0;const i=Ti.CreateDeviceEvent(Kt.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Kt.Mouse,0,i)}}else{const t=this._activeTouchIds.indexOf(e.pointerId);if(-1===t)return;(null===(n=(s=this._elementToAttachTo).hasPointerCapture)||void 0===n?void 0:n.call(s,e.pointerId))&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._inputs[Kt.Touch][t][jt.LeftClick]=0;const i=Ti.CreateDeviceEvent(Kt.Touch,t,jt.LeftClick,0,this,this._elementToAttachTo,e.pointerId);this._onInputChanged(Kt.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(Kt.Touch,t)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch(e){}this._pointerBlurEvent=()=>{var e,t,i,s,n;if(this.isDeviceAvailable(Kt.Mouse)){const i=this._inputs[Kt.Mouse][0];this._mouseId>=0&&(null===(t=(e=this._elementToAttachTo).hasPointerCapture)||void 0===t?void 0:t.call(e,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let e=jt.LeftClick;e<=jt.BrowserForward;e++)if(1===i[e]){i[e]=0;const t=Ti.CreateDeviceEvent(Kt.Mouse,0,e,0,this,this._elementToAttachTo);this._onInputChanged(Kt.Mouse,0,t)}}if(this.isDeviceAvailable(Kt.Touch)){const e=this._inputs[Kt.Touch];for(let t=0;t<this._activeTouchIds.length;t++){const r=this._activeTouchIds[t];if((null===(s=(i=this._elementToAttachTo).hasPointerCapture)||void 0===s?void 0:s.call(i,r))&&this._elementToAttachTo.releasePointerCapture(r),-1!==r&&1===(null===(n=e[t])||void 0===n?void 0:n[jt.LeftClick])){e[t][jt.LeftClick]=0;const i=Ti.CreateDeviceEvent(Kt.Touch,t,jt.LeftClick,0,this,this._elementToAttachTo,r);this._onInputChanged(Kt.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(Kt.Touch,t)}}}},this._pointerWheelEvent=e=>{const t=Kt.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=!0,this._registerDevice(t,0,Ei));const i=this._inputs[t][0];if(i){i[jt.MouseWheelX]=e.deltaX||0,i[jt.MouseWheelY]=e.deltaY||e.wheelDelta||0,i[jt.MouseWheelZ]=e.deltaZ||0;const s=e;void 0===e.pointerId&&(e.pointerId=this._mouseId),0!==i[jt.MouseWheelX]&&(s.inputIndex=jt.MouseWheelX,this._onInputChanged(t,0,s)),0!==i[jt.MouseWheelY]&&(s.inputIndex=jt.MouseWheelY,this._onInputChanged(t,0,s)),0!==i[jt.MouseWheelZ]&&(s.inputIndex=jt.MouseWheelZ,this._onInputChanged(t,0,s))}},this._usingMacOS&&this._isUsingChromium&&(this._pointerMacOSChromeOutEvent=e=>{e.buttons>1&&this._pointerCancelEvent(e)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add((()=>{if(this.isDeviceAvailable(Kt.Mouse)){const e=this._inputs[Kt.Mouse][0];e[jt.MouseWheelX]=0,e[jt.MouseWheelY]=0,e[jt.MouseWheelZ]=0}}))}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const s=navigator.getGamepads()[t];if(s&&e===this._gamepads[t]){const n=this._inputs[e][t];i>=s.buttons.length?n[i]=s.axes[i-s.buttons.length].valueOf():n[i]=s.buttons[i].value}}_getGamepadDeviceType(e){return-1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?Kt.DualSense:Kt.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?Kt.Xbox:-1!==e.indexOf("057e")?Kt.Switch:Kt.Generic}_getPointerType(e){let t=Kt.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=Kt.Touch),t}}class xi{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new s,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class Ci{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){const i=this._devices[t];for(const s in i){const i=+s;e._addDevice(new xi(this._deviceInputSystem,t,i))}}this._registeredManagers.push(e)},this.unregisterManager=e=>{const t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1)};const t=Object.keys(Kt).length/2;this._devices=new Array(t);const i=(e,t)=>{this._devices[e]||(this._devices[e]=new Array),this._devices[e][t]||(this._devices[e][t]=t);for(const i of this._registeredManagers){const s=new xi(this._deviceInputSystem,e,t);i._addDevice(s)}},s=(e,t)=>{var i;(null===(i=this._devices[e])||void 0===i?void 0:i[t])&&delete this._devices[e][t];for(const i of this._registeredManagers)i._removeDevice(e,t)},n=(e,t,i)=>{if(i)for(const s of this._registeredManagers)s._onInputChanged(e,t,i)};"undefined"!=typeof _native?this._deviceInputSystem=new bi(i,s,n):this._deviceInputSystem=new Si(e,i,s,n)}dispose(){this._deviceInputSystem.dispose()}}class yi{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter((e=>!!e)):[]}constructor(e){const t=Object.keys(Kt).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new Ci(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new s((e=>{for(const t of this._devices)if(t)for(const i of t)i&&this.onDeviceConnectedObservable.notifyObserver(e,i)})),this.onDeviceDisconnectedObservable=new s,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add((()=>{this.dispose()}))}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var i,s;const n=null===(i=this._devices[e])||void 0===i?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(n),(null===(s=this._devices[e])||void 0===s?void 0:s[t])&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var s,n;null===(n=null===(s=this._devices[e])||void 0===s?void 0:s[t])||void 0===n||n.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case Kt.Keyboard:case Kt.Mouse:this._firstDevice[e]=0;break;case Kt.Touch:case Kt.DualSense:case Kt.DualShock:case Kt.Xbox:case Kt.Switch:case Kt.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t)for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}break}}}}class Ai{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class Ri{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new pe(0,0),this._previousStartingPointerPosition=new pe(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||u.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new pe(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,s=i.getEngine(),n=s.getInputElement();n&&(n.tabIndex=s.canvasTabIndex,i.doNotHandleCursors||(n.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const s of i._pointerMoveStage){const i=!!(null==(e=e||this._pickMove(t))?void 0:e.pickedMesh);e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,i,n)}const r=t.inputIndex>=jt.MouseWheelX&&t.inputIndex<=jt.MouseWheelZ?ci.POINTERWHEEL:ci.POINTERMOVE;let o;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,r)),e?(o=new _i(r,t,e),this._setRayOnPointerInfo(e,t)):(o=new _i(r,t,null,this),this._movePointerInfo=o),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(o,r)}_setRayOnPointerInfo(e,t){const i=this._scene;e&&i._pickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,Te.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const s=this._scene,n=new ui(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(n.originalPickingInfo=e,n.ray=e.ray,e.originMesh&&(n.nearInteractionPickingInfo=e)),s.onPrePointerObservable.notifyObservers(n,i),!!n.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const s=i.getEngine().getInputElement();if(null==e?void 0:e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&s&&this._pointerOverMesh){const e=this._pointerOverMesh._getActionManagerForTrigger();e&&e.hasPointerTriggers&&(s.style.cursor=e.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=jt.Move,this._checkPrePointerObservable(e,i,ci.POINTERMOVE)||this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,this._checkPrePointerObservable(e,i,ci.POINTERDOWN)||this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(null==e?void 0:e.pickedMesh){this._pickedDownMesh=e.pickedMesh;const s=e.pickedMesh._getActionManagerForTrigger();if(s){if(s.hasPickTriggers)switch(s.processTrigger(5,si.CreateNew(e.pickedMesh,t,e)),t.button){case 0:s.processTrigger(2,si.CreateNew(e.pickedMesh,t,e));break;case 1:s.processTrigger(4,si.CreateNew(e.pickedMesh,t,e));break;case 2:s.processTrigger(3,si.CreateNew(e.pickedMesh,t,e))}s.hasSpecificTrigger(8)&&window.setTimeout((()=>{const e=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,(e=>e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(8)&&e===this._pickedDownMesh),!1,i.cameraToUseForPointers);(null==e?void 0:e.pickedMesh)&&s&&0!==this._totalPointersPressed&&Date.now()-this._startingPointerTime>Ri.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,s.processTrigger(8,si.CreateNew(e.pickedMesh,t)))}),Ri.LongPressDelay)}}else for(const s of i._pointerDownStage)e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let s;const n=ci.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,n),s=new _i(n,t,e),this._setRayOnPointerInfo(e,t)):s=new _i(n,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(s,n)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const s=new PointerEvent("pointerup",t);s.inputIndex=jt.Move;const n=new Ai;i?n.doubleClick=!0:n.singleClick=!0,this._checkPrePointerObservable(e,s,ci.POINTERUP)||this._processPointerUp(e,s,n)}_processPointerUp(e,t,i){const s=this._scene;if(null==e?void 0:e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(s.onPointerPick&&s.onPointerPick(t,e),i.singleClick&&!i.ignore&&s.onPointerObservable.observers.length>this._cameraObserverCount)){const i=ci.POINTERPICK,n=new _i(i,t,e);this._setRayOnPointerInfo(e,t),s.onPointerObservable.notifyObservers(n,i)}const n=e.pickedMesh._getActionManagerForTrigger();if(n&&!i.ignore){n.processTrigger(7,si.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&n.processTrigger(1,si.CreateNew(e.pickedMesh,t,e));const s=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&s&&s.processTrigger(6,si.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const n of s._pointerUpStage)e=n.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const e=this._pickedDownMesh._getActionManagerForTrigger(16);e&&e.processTrigger(16,si.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){const n=new _i(ci.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),s.onPointerObservable.notifyObservers(n,ci.POINTERUP),s.onPointerUp&&s.onPointerUp(t,e,ci.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let n=0;if(i.singleClick?n=ci.POINTERTAP:i.doubleClick&&(n=ci.POINTERDOUBLETAP),n){const i=new _i(n,t,e);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(n)&&s.onPointerObservable.notifyObservers(i,n)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,s=null){const n=this._scene,r=n.getEngine();s||(s=r.getInputElement()),this._alreadyAttached&&this.detachControl(),s&&(this._alreadyAttachedTo=s),this._deviceSourceManager=new yi(r),this._initActionManager=e=>{if(!this._meshPickProceed){const t=n.skipPointerUpPicking||0===n._registeredActions&&!this._checkForPicking()&&!n.onPointerUp?null:n.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,n.pointerUpPredicate,n.pointerUpFastCheck,n.cameraToUseForPointers);this._currentPickResult=t,t&&(e=t.hit&&t.pickedMesh?t.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return e},this._delayedSimpleClick=(e,t,i)=>{if((Date.now()-this._previousStartingPointerTime>Ri.DoubleClickDelay&&!this._doubleClickOccured||e!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,t.singleClick=!0,t.ignore=!1,this._delayedClicks[e])){const t=this._delayedClicks[e].evt,i=ci.POINTERTAP,s=new _i(i,t,this._currentPickResult);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(i)&&n.onPointerObservable.notifyObservers(s,i),this._delayedClicks[e]=null}},this._initClickEvent=(e,t,i,s)=>{var n,r;const o=new Ai;this._currentPickResult=null;let a=null,l=e.hasSpecificMask(ci.POINTERPICK)||t.hasSpecificMask(ci.POINTERPICK)||e.hasSpecificMask(ci.POINTERTAP)||t.hasSpecificMask(ci.POINTERTAP)||e.hasSpecificMask(ci.POINTERDOUBLETAP)||t.hasSpecificMask(ci.POINTERDOUBLETAP);!l&&fi&&(a=this._initActionManager(a,o),a&&(l=a.hasPickTriggers));let h=!1;if(l){const l=i.button;if(o.hasSwiped=this._isPointerSwiping(),!o.hasSwiped){let c=!Ri.ExclusiveDoubleClickMode;if(c||(c=!e.hasSpecificMask(ci.POINTERDOUBLETAP)&&!t.hasSpecificMask(ci.POINTERDOUBLETAP),c&&!fi.HasSpecificTrigger(6)&&(a=this._initActionManager(a,o),a&&(c=!a.hasSpecificTrigger(6)))),c)(Date.now()-this._previousStartingPointerTime>Ri.DoubleClickDelay||l!==this._previousButtonPressed)&&(o.singleClick=!0,s(o,this._currentPickResult),h=!0);else{const e={evt:i,clickInfo:o,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,l,o,s),Ri.DoubleClickDelay)};this._delayedClicks[l]=e}let d=e.hasSpecificMask(ci.POINTERDOUBLETAP)||t.hasSpecificMask(ci.POINTERDOUBLETAP);!d&&fi.HasSpecificTrigger(6)&&(a=this._initActionManager(a,o),a&&(d=a.hasSpecificTrigger(6))),d&&(l===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<Ri.DoubleClickDelay&&!this._doubleClickOccured?(o.hasSwiped||this._isPointerSwiping()?(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=l,Ri.ExclusiveDoubleClickMode?(this._delayedClicks[l]&&(clearTimeout(null===(r=this._delayedClicks[l])||void 0===r?void 0:r.timeoutId),this._delayedClicks[l]=null),s(o,this._previousPickResult)):s(o,this._currentPickResult)):(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,o.doubleClick=!0,o.ignore=!1,Ri.ExclusiveDoubleClickMode&&this._delayedClicks[l]&&(clearTimeout(null===(n=this._delayedClicks[l])||void 0===n?void 0:n.timeoutId),this._delayedClicks[l]=null),s(o,this._currentPickResult)),h=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=l))}}h||s(o,this._currentPickResult)},this._onPointerMove=e=>{if(this._updatePointerPosition(e),this._isSwiping||-1===this._swipeButtonPressed||(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>Ri.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>Ri.DragMovementThreshold),r.isPointerLock&&r._verifyPointerLock(),this._checkPrePointerObservable(null,e,e.inputIndex>=jt.MouseWheelX&&e.inputIndex<=jt.MouseWheelZ?ci.POINTERWHEEL:ci.POINTERMOVE))return;if(!n.cameraToUseForPointers&&!n.activeCamera)return;if(n.skipPointerMovePicking)return void this._processPointerMove(new ii,e);n.pointerMovePredicate||(n.pointerMovePredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||n.constantlyUpdateMeshUnderPointer||null!==e._getActionManagerForTrigger())&&(!n.cameraToUseForPointers||0!=(n.cameraToUseForPointers.layerMask&e.layerMask)));const t=n._registeredActions>0||n.constantlyUpdateMeshUnderPointer?this._pickMove(e):null;this._processPointerMove(t,e)},this._onPointerDown=e=>{var t;if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,Ri.ExclusiveDoubleClickMode)for(let i=0;i<this._delayedClicks.length;i++)if(this._delayedClicks[i])if(e.button===i)clearTimeout(null===(t=this._delayedClicks[i])||void 0===t?void 0:t.timeoutId);else{const e=this._delayedClicks[i].clickInfo;this._doubleClickOccured=!1,e.singleClick=!0,e.ignore=!1;const t=this._delayedClicks[i].evt,s=ci.POINTERTAP,r=new _i(s,t,this._currentPickResult);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(s)&&n.onPointerObservable.notifyObservers(r,s),this._delayedClicks[i]=null}if(this._updatePointerPosition(e),-1===this._swipeButtonPressed&&(this._swipeButtonPressed=e.button),n.preventDefaultOnPointerDown&&s&&(e.preventDefault(),s.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,e,ci.POINTERDOWN))return;if(!n.cameraToUseForPointers&&!n.activeCamera)return;let i;this._pointerCaptures[e.pointerId]=!0,n.pointerDownPredicate||(n.pointerDownPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!n.cameraToUseForPointers||0!=(n.cameraToUseForPointers.layerMask&e.layerMask))),this._pickedDownMesh=null,i=n.skipPointerDownPicking||0===n._registeredActions&&!this._checkForPicking()&&!n.onPointerDown?new ii:n.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,n.pointerDownPredicate,n.pointerDownFastCheck,n.cameraToUseForPointers),this._processPointerDown(i,e)},this._onPointerUp=e=>{0!==this._totalPointersPressed&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(e),n.preventDefaultOnPointerUp&&s&&(e.preventDefault(),s.focus()),this._initClickEvent(n.onPrePointerObservable,n.onPointerObservable,e,((t,i)=>{if(n.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!t.ignore)){if(this._checkPrePointerObservable(null,e,ci.POINTERUP))return this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),void(0===e.buttons&&(this._pointerCaptures[e.pointerId]=!1));t.hasSwiped||(t.singleClick&&n.onPrePointerObservable.hasSpecificMask(ci.POINTERTAP)&&this._checkPrePointerObservable(null,e,ci.POINTERTAP)&&(this._skipPointerTap=!0),t.doubleClick&&n.onPrePointerObservable.hasSpecificMask(ci.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,e,ci.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}this._pointerCaptures[e.pointerId]?(0===e.buttons&&(this._pointerCaptures[e.pointerId]=!1),(n.cameraToUseForPointers||n.activeCamera)&&(n.pointerUpPredicate||(n.pointerUpPredicate=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!n.cameraToUseForPointers||0!=(n.cameraToUseForPointers.layerMask&e.layerMask))),!this._meshPickProceed&&(fi&&fi.HasTriggers||this._checkForPicking()||n.onPointerUp)&&this._initActionManager(null,t),i||(i=this._currentPickResult),this._processPointerUp(i,e,t),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))):this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1)})))},this._onKeyDown=e=>{const t=pi.KEYDOWN;if(n.onPreKeyboardObservable.hasObservers()){const i=new gi(t,e);if(n.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(n.onKeyboardObservable.hasObservers()){const i=new mi(t,e);n.onKeyboardObservable.notifyObservers(i,t)}n.actionManager&&n.actionManager.processTrigger(14,si.CreateNewFromScene(n,e))},this._onKeyUp=e=>{const t=pi.KEYUP;if(n.onPreKeyboardObservable.hasObservers()){const i=new gi(t,e);if(n.onPreKeyboardObservable.notifyObservers(i,t),i.skipOnKeyboardObservable)return}if(n.onKeyboardObservable.hasObservers()){const i=new mi(t,e);n.onKeyboardObservable.notifyObservers(i,t)}n.actionManager&&n.actionManager.processTrigger(15,si.CreateNewFromScene(n,e))},this._deviceSourceManager.onDeviceConnectedObservable.add((s=>{s.deviceType===Kt.Mouse?s.onInputChangedObservable.add((n=>{n.inputIndex===jt.LeftClick||n.inputIndex===jt.MiddleClick||n.inputIndex===jt.RightClick||n.inputIndex===jt.BrowserBack||n.inputIndex===jt.BrowserForward?t&&1===s.getInput(n.inputIndex)?this._onPointerDown(n):e&&0===s.getInput(n.inputIndex)&&this._onPointerUp(n):i&&(n.inputIndex===jt.Move?this._onPointerMove(n):n.inputIndex!==jt.MouseWheelX&&n.inputIndex!==jt.MouseWheelY&&n.inputIndex!==jt.MouseWheelZ||this._onPointerMove(n))})):s.deviceType===Kt.Touch?s.onInputChangedObservable.add((n=>{n.inputIndex===jt.LeftClick&&(t&&1===s.getInput(n.inputIndex)?(this._onPointerDown(n),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):e&&0===s.getInput(n.inputIndex)&&(this._onPointerUp(n),0===this._totalPointersPressed&&(this._isMultiTouchGesture=!1))),i&&n.inputIndex===jt.Move&&this._onPointerMove(n)})):s.deviceType===Kt.Keyboard&&s.onInputChangedObservable.add((e=>{"keydown"===e.type?this._onKeyDown(e):"keyup"===e.type&&this._onKeyUp(e)}))})),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,s){if(!(this._meshUnderPointerId[t]!==e||e&&e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const n=this._meshUnderPointerId[t];let r;n&&(r=n._getActionManagerForTrigger(10),r&&r.processTrigger(10,si.CreateNew(n,s,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,r=e._getActionManagerForTrigger(9),r&&r.processTrigger(9,si.CreateNew(e,s,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}Ri.DragMovementThreshold=10,Ri.LongPressDelay=500,Ri.DoubleClickDelay=300,Ri.ExclusiveDoubleClickMode=!1;class Ii{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}Ii._UniqueIdCounter=1;class Pi{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}}var Mi;!function(e){e[e.BackwardCompatible=0]="BackwardCompatible",e[e.Intermediate=1]="Intermediate",e[e.Aggressive=2]="Aggressive"}(Mi||(Mi={}));class Oi extends Ht{static DefaultMaterialFactory(e){throw f("StandardMaterial")}static CollisionCoordinatorFactory(){throw f("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case Mi.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case Mi.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case Mi.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Ri.DragMovementThreshold}static set DragMovementThreshold(e){Ri.DragMovementThreshold=e}static get LongPressDelay(){return Ri.LongPressDelay}static set LongPressDelay(e){Ri.LongPressDelay=e}static get DoubleClickDelay(){return Ri.DoubleClickDelay}static set DoubleClickDelay(e){Ri.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return Ri.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){Ri.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){const s=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera.globalPosition,n=this.useRightHandedSystem===(null!=this._mirroredCameraPosition);return Ee.Vector4[0].set(s.x,s.y,s.z,n?-1:1),e&&(i?e.setFloat3(t,Ee.Vector4[0].x,Ee.Vector4[0].y,Ee.Vector4[0].z):e.setVector4(t,Ee.Vector4[0])),Ee.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=ce(e,(()=>{this.onActiveCamerasChanged.notifyObservers(this)}))),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=Oi.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=Oi.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}constructor(e,t){super(),this._inputManager=new Ri(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new Ie(.2,.2,.3,1),this.ambientColor=new Re(0,0,0),this.environmentIntensity=1,this._performancePriority=Mi.BackwardCompatible,this.onScenePerformancePriorityChangedObservable=new s,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new s,this._onDisposeObserver=null,this.onBeforeRenderObservable=new s,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new s,this.onAfterRenderCameraObservable=new s,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new s,this.onAfterAnimationsObservable=new s,this.onBeforeDrawPhaseObservable=new s,this.onAfterDrawPhaseObservable=new s,this.onReadyObservable=new s,this.onBeforeCameraRenderObservable=new s,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new s,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new s,this.onAfterActiveMeshesEvaluationObservable=new s,this.onBeforeParticlesRenderingObservable=new s,this.onAfterParticlesRenderingObservable=new s,this.onDataLoadedObservable=new s,this.onNewCameraAddedObservable=new s,this.onCameraRemovedObservable=new s,this.onNewLightAddedObservable=new s,this.onLightRemovedObservable=new s,this.onNewGeometryAddedObservable=new s,this.onGeometryRemovedObservable=new s,this.onNewTransformNodeAddedObservable=new s,this.onTransformNodeRemovedObservable=new s,this.onNewMeshAddedObservable=new s,this.onMeshRemovedObservable=new s,this.onNewSkeletonAddedObservable=new s,this.onSkeletonRemovedObservable=new s,this.onNewMaterialAddedObservable=new s,this.onNewMultiMaterialAddedObservable=new s,this.onMaterialRemovedObservable=new s,this.onMultiMaterialRemovedObservable=new s,this.onNewTextureAddedObservable=new s,this.onTextureRemovedObservable=new s,this.onBeforeRenderTargetsRenderObservable=new s,this.onAfterRenderTargetsRenderObservable=new s,this.onBeforeStepObservable=new s,this.onAfterStepObservable=new s,this.onActiveCameraChanged=new s,this.onActiveCamerasChanged=new s,this.onBeforeRenderingGroupObservable=new s,this.onAfterRenderingGroupObservable=new s,this.onMeshImportedObservable=new s,this.onAnimationFileImportedObservable=new s,this._registeredForLateAnimationBindings=new Bt(256),this._pointerPickingConfiguration=new Pi,this.onPrePointerObservable=new s,this.onPointerObservable=new s,this.onPreKeyboardObservable=new s,this.onKeyboardObservable=new s,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=Oi.FOGMODE_NONE,this.fogColor=new Re(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new me(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new Bt(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new ee,this._activeIndices=new ee,this._activeParticles=new ee,this._activeBones=new ee,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new wt(256),this._processedMaterials=new wt(256),this._renderTargets=new Bt(256),this._materialsRenderTargets=new Bt(256),this._activeParticleSystems=new wt(256),this._activeSkeletons=new Bt(32),this._softwareSkinnedMeshes=new Bt(32),this._activeAnimatables=new Array,this._transformMatrix=Te.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=hi.Create(),this._beforeClearStage=hi.Create(),this._beforeRenderTargetClearStage=hi.Create(),this._gatherRenderTargetsStage=hi.Create(),this._gatherActiveCameraRenderTargetsStage=hi.Create(),this._isReadyForMeshStage=hi.Create(),this._beforeEvaluateActiveMeshStage=hi.Create(),this._evaluateSubMeshStage=hi.Create(),this._preActiveMeshStage=hi.Create(),this._cameraDrawRenderTargetStage=hi.Create(),this._beforeCameraDrawStage=hi.Create(),this._beforeRenderTargetDrawStage=hi.Create(),this._beforeRenderingGroupDrawStage=hi.Create(),this._beforeRenderingMeshStage=hi.Create(),this._afterRenderingMeshStage=hi.Create(),this._afterRenderingGroupDrawStage=hi.Create(),this._afterCameraDrawStage=hi.Create(),this._afterCameraPostProcessStage=hi.Create(),this._afterRenderTargetDrawStage=hi.Create(),this._afterRenderTargetPostProcessStage=hi.Create(),this._afterRenderStage=hi.Create(),this._pointerMoveStage=hi.Create(),this._pointerDownStage=hi.Create(),this._pointerUpStage=hi.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[];const i=Object.assign({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},t);e=this._engine=e||u.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):(u._LastCreatedScene=this,e.scenes.push(this)),this._uid=null,this._renderingManager=new ai(this),ni&&(this.postProcessManager=new ni(this)),l()&&this.attachControl(),this._createUbo(),Yt&&(this._imageProcessingConfiguration=new Yt),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,t&&t.virtual||e.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return void 0!==this._animationRatio?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){var t,i,s;if(this._isDisposed)return!1;let n;const r=this.getEngine(),o=r.currentRenderPassId;r.currentRenderPassId=null!==(i=null===(t=this.activeCamera)||void 0===t?void 0:t.renderPassId)&&void 0!==i?i:o;let a=!0;for(this._pendingData.length>0&&(a=!1),null===(s=this.prePassRenderer)||void 0===s||s.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&a&&(a=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),n=0;n<this.meshes.length;n++){const t=this.meshes[n];if(!t.subMeshes||0===t.subMeshes.length)continue;if(!t.isReady(!0)){a=!1;continue}const i=t.hasThinInstances||"InstancedMesh"===t.getClassName()||"InstancedLinesMesh"===t.getClassName()||r.getCaps().instancedArrays&&t.instances.length>0;for(const e of this._isReadyForMeshStage)e.action(t,i)||(a=!1);if(!e)continue;const s=t.material||this.defaultMaterial;if(s)if(s._storeEffectOnSubMeshes)for(const e of t.subMeshes){const t=e.getMaterial();t&&t.hasRenderTargetTextures&&null!=t.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(t)&&(this._processedMaterials.push(t),this._materialsRenderTargets.concatWithNoDuplicate(t.getRenderTargetTextures()))}else s.hasRenderTargetTextures&&null!=s.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(s)&&(this._processedMaterials.push(s),this._materialsRenderTargets.concatWithNoDuplicate(s.getRenderTargetTextures()))}if(e)for(n=0;n<this._materialsRenderTargets.length;++n)this._materialsRenderTargets.data[n].isReadyForRendering()||(a=!1);for(n=0;n<this.geometries.length;n++)2===this.geometries[n].delayLoadState&&(a=!1);if(this.activeCameras&&this.activeCameras.length>0)for(const e of this.activeCameras)e.isReady(!0)||(a=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(a=!1));for(const e of this.particleSystems)e.isReady()||(a=!1);if(this.layers)for(const e of this.layers)e.isReady()||(a=!1);return r.areAllEffectsReady()||(a=!1),r.currentRenderPassId=o,a}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout((()=>{this.unregisterBeforeRender(t)}))};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){void 0!==t?setTimeout((()=>{this._executeOnceBeforeRender(e)}),t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);-1!==i&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise((t=>{this.executeWhenReady((()=>{t()}),e)}))}_checkIsReady(e=!1){return this._registerTransientComponents(),this.isReady(e)?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):this._isDisposed?(this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=null)):void(this._executeWhenReadyTimeoutId=setTimeout((()=>{this.incrementRenderId(),this._checkIsReady(e)}),100))}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=j.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,s){i||s||!this._multiviewSceneUbo||(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag||(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Vt.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Vt.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,s):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new Nt(this._engine,void 0,!1,null!=e?e:"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return Ii.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach((e=>{this.addMesh(e)})))}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);return-1!==i&&(this.meshes[i]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach((e=>{this.removeMesh(e)})),i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneTransformNodesArray||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(-1!==t){if(t!==this.transformNodes.length-1){const e=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=e,e._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return-1!==t&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return-1!==t&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(-1!==t){for(const t of this.meshes)t._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(-1!==t&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const t=this.activeCameras.indexOf(e);-1!==t&&this.activeCameras.splice(t,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return-1!==t&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return-1!==t&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return-1!==t&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return-1!==t&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(-1!==t&&t<this.materials.length){if(t!==this.materials.length-1){const e=this.materials[this.materials.length-1];this.materials[t]=e,e._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return-1!==t&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return-1!==t&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)-1===t.lightSources.indexOf(e)&&(t.lightSources.push(e),t._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(Ft.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&-1!==e._indexInSceneMaterialArray||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let e=0;e<this.materials.length;e++){const i=this.materials[e];if(t(i))return i}if(e)for(let e=0;e<this.multiMaterials.length;e++){const i=this.multiMaterials[e];if(t(i))return i}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,(t=>t.uniqueId===e))}getMaterialById(e,t=!1){return this._getMaterial(t,(t=>t.id===e))}getMaterialByName(e,t=!1){return this._getMaterial(t,(t=>t.name===e))}getLastMaterialById(e,t=!1){for(let t=this.materials.length-1;t>=0;t--)if(this.materials[t].id===e)return this.materials[t];if(t)for(let t=this.multiMaterials.length-1;t>=0;t--)if(this.multiMaterials[t].id===e)return this.multiMaterials[t];return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].id===e)return i.bones[t]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].name===e)return i.bones[t]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(void 0!==t)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!(!t&&this._getGeometryByUniqueId(e.uniqueId)||(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),0))}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],void 0===t)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const e=this.geometries[this.geometries.length-1];e&&(this.geometries[t]=e,this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter((function(t){return t.id===e}))}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter((function(t){return t.id===e}))}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const s=this.getLightById(e);if(s)return s;const n=this.getCameraById(e);if(n)return n;return this.getBoneById(e)||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const s=this.getLightByName(e);if(s)return s;const n=this.getCameraByName(e);if(n)return n;return this.getBoneByName(e)||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){const s=i.getTarget(t);if(s.id===e)return s}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){const s=i.getTarget(t);if(s.name===e)return s}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return-1!==this._activeMeshes.indexOf(e)}get uid(){return this._uid||(this._uid=Ot.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new zt),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new zt),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,s){if(s||e.isInFrustum(this._frustumPlanes)){for(const i of this._evaluateSubMeshStage)i.action(t,e);const i=e.getMaterial();null!=i&&(i.hasRenderTargetTextures&&null!=i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._materialsRenderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,i))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,s=!0,n=!1){return this.executeWhenReady((()=>{if(this.activeCamera){if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=n,this._skipEvaluateActiveMeshesCompletely=e,s)for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._freeze();t&&t()}else i&&i("No active camera found")})),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce((()=>e.dispose()))}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)return void(this._activeMeshes.length>0&&(null===(e=this.activeCamera)||void 0===e||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset()));if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const e=this._activeMeshes.length;for(let t=0;t<e;t++)this._activeMeshes.data[t].computeWorldMatrix()}if(this._activeParticleSystems){const e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate()}return void this._renderingManager.resetSprites()}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const e of this._beforeEvaluateActiveMeshStage)e.action();const t=this.getActiveMeshCandidates(),i=t.length;for(let e=0;e<i;e++){const i=t.data[e];if(i._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,i.isBlocked)continue;if(this._totalVertices.addCount(i.getTotalVertices(),!1),!i.isReady()||!i.isEnabled()||i.scaling.hasAZeroComponent)continue;i.computeWorldMatrix(),i.actionManager&&i.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(i);let s=this.customLODSelector?this.customLODSelector(i,this.activeCamera):i.getLOD(this.activeCamera);if(i._internalAbstractMeshDataInfo._currentLOD=s,i._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,null!=s&&(s!==i&&0!==s.billboardMode&&s.computeWorldMatrix(),i._preActivate(),i.isVisible&&i.visibility>0&&0!=(i.layerMask&this.activeCamera.layerMask)&&(this._skipFrustumClipping||i.alwaysSelectAsActiveMesh||i.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(i),this.activeCamera._activeMeshes.push(i),s!==i&&s._activate(this._renderId,!1);for(const e of this._preActiveMeshStage)e.action(i);i._activate(this._renderId,!1)&&(i.isAnInstance?i._internalAbstractMeshDataInfo._actAsRegularMesh&&(s=i):s._internalAbstractMeshDataInfo._onlyForInstances=!1,s._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(i,s)),i._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let e=0;e<this.particleSystems.length;e++){const t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;const i=t.emitter;i.position&&!i.isEnabled()||(this._activeParticleSystems.push(t),t.animate(),this._renderingManager.dispatchParticles(t))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,t){this._skeletonsEnabled&&null!==t.skeleton&&void 0!==t.skeleton&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t));let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const s=this.getActiveSubMeshCandidates(t),n=s.length;i=i||1===n;for(let r=0;r<n;r++){const n=s.data[r];this._evaluateSubMesh(n,t,e,i)}}}updateTransformMatrix(e){const t=this.activeCamera;if(t)if(t._renderingMultiview){const i=t._rigCameras[0],s=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),s.getViewMatrix(),s.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(e&&e._multiviewTexture);else if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||(this.autoClear&&this._engine.clear(t.clearColor||this.clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){var s,n,r;if(e&&e._skipRendering)return;const o=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(o.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let t=!0;e._renderingMultiview&&e.outputRenderTarget&&(t=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=t)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let e=0;e<this._softwareSkinnedMeshes.length;e++){const t=this._softwareSkinnedMeshes.data[e];t.applySkeleton(t.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const e of this._gatherActiveCameraRenderTargetsStage)e.action(this._renderTargets);let a=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){Ot.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let e=0;e<this._renderTargets.length;e++){const t=this._renderTargets.data[e];if(t._shouldRender()){this._renderId++;const e=t.activeCamera&&t.activeCamera!==this.activeCamera;t.render(e,this.dumpNextRenderTargets),a=!0}}Ot.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const e of this._cameraDrawRenderTargetStage)a=e.action(this.activeCamera)||a;this._intermediateRendering=!1}this._engine.currentRenderPassId=null!==(r=null!==(n=null===(s=e.outputRenderTarget)||void 0===s?void 0:s.renderPassId)&&void 0!==n?n:e.renderPassId)&&void 0!==r?r:0,a&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),!this.postProcessManager||e._multiviewTexture||this.prePass||this.postProcessManager._prepareFrame();for(const e of this._beforeCameraDrawStage)e.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),o.snapshotRendering&&1===o.snapshotRenderingMode&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const e of this._afterCameraDrawStage)e.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const t=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,t)}for(const e of this._afterCameraPostProcessStage)e.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(0===e.cameraRigMode||e._renderingMultiview)return e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),void this.onAfterRenderCameraObservable.notifyObservers(e);if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let t=0;t<e._rigCameras.length;t++)this._renderForCamera(e._rigCameras[t],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let e=0;t.actionManager&&e<t.actionManager.actions.length;e++){const i=t.actionManager.actions[e];if(12===i.trigger||13===i.trigger){const e=i.getTriggerParameter(),s=e.mesh?e.mesh:e,n=s.intersectsMesh(t,e.usePreciseIntersection),r=t._intersectionsInProgress.indexOf(s);n&&-1===r?12===i.trigger?(i._executeCurrent(si.CreateNew(t,void 0,s)),t._intersectionsInProgress.push(s)):13===i.trigger&&t._intersectionsInProgress.push(s):!n&&r>-1&&(13===i.trigger&&i._executeCurrent(si.CreateNew(t,void 0,s)),t.actionManager.hasSpecificTrigger(13,(e=>{const t=e.mesh?e.mesh:e;return s===t}))&&13!==i.trigger||t._intersectionsInProgress.splice(r,1))}}}}_advancePhysicsEngineStep(e){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(Oi.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Oi.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let s=0;const n=this._engine.getLockstepMaxSteps();let r=Math.floor(e/t);for(r=Math.min(r,n);e>0&&s<r;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,s++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(Oi.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Oi.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if((null==e?void 0:e.outputRenderTarget)&&!(null==e?void 0:e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),null===(t=null==e?void 0:e.rigCameras)||void 0===t?void 0:t.length)for(let t=0;t<e.rigCameras.length;++t){const i=e.rigCameras[t].outputRenderTarget;i&&(i._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}render(e=!0,t=!1){var i,s,n;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),(null===(i=this.activeCameras)||void 0===i?void 0:i.length)&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const e of this._beforeCameraUpdateStage)e.action();if(e)if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];if(t.update(),0!==t.cameraRigMode)for(let e=0;e<t._rigCameras.length;e++)t._rigCameras[e].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(let e=0;e<this.activeCamera._rigCameras.length;e++)this.activeCamera._rigCameras[e].update();this.onBeforeRenderObservable.notifyObservers(this);const r=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const o=(null===(s=this.activeCameras)||void 0===s?void 0:s.length)?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){Ot.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let e=0;e<this.customRenderTargets.length;e++){const t=this.customRenderTargets[e];if(t._shouldRender()){if(this._renderId++,this.activeCamera=t.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");r.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),t.render(o!==this.activeCamera,this.dumpNextRenderTargets)}}Ot.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=null!==(n=null==o?void 0:o.renderPassId)&&void 0!==n?n:0,this.activeCamera=o,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const e of this._beforeClearStage)e.action();this._clearFrameBuffer(this.activeCamera);for(const e of this._gatherRenderTargetsStage)e.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++)this._processSubCameras(this.activeCameras[e],e>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(const e of this._afterRenderStage)e.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let e=0;e<this._toBeDisposed.length;e++){const t=this._toBeDisposed[e];t&&t.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this.stopAllAnimations&&(this._activeAnimatables.forEach((e=>{e.onAnimationEndObservable.clear(),e.onAnimationEnd=null})),this.stopAllAnimations()),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const t of e)t.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(e){p.Error("An error occurred while calling onDisposeObservable!",e)}if(this.detachControl(),this._engine.getInputElement())for(let e=0;e<this.cameras.length;e++)this.cameras[e].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,(e=>e.dispose(!0))),this._disposeList(this.transformNodes,(e=>e.dispose(!0)));const t=this.cameras;this._disposeList(t),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let i=this._engine.scenes.indexOf(this);i>-1&&this._engine.scenes.splice(i,1),u._LastCreatedScene===this&&(this._engine.scenes.length>0?u._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:u._LastCreatedScene=null),i=this._engine._virtualScenes.indexOf(this),i>-1&&this._engine._virtualScenes.splice(i,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=null!=t?t:e=>e.dispose();for(const e of i)t(e);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e].geometry;t&&t.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new me(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach((e=>{if(e.computeWorldMatrix(!0),!e.subMeshes||0===e.subMeshes.length||e.infiniteDistance)return;const s=e.getBoundingInfo(),n=s.boundingBox.minimumWorld,r=s.boundingBox.maximumWorld;me.CheckExtends(n,t,i),me.CheckExtends(r,t,i)})),{min:t,max:i}}createPickingRay(e,t,i,s,n=!1){throw f("Ray")}createPickingRayToRef(e,t,i,s,n,r=!1,o=!1){throw f("Ray")}createPickingRayInCameraSpace(e,t,i){throw f("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,s){throw f("Ray")}get _pickingAvailable(){return!1}pick(e,t,i,s,n,r){const o=f("Ray",!0);return o&&p.Warn(o),new ii}pickWithBoundingInfo(e,t,i,s,n){const r=f("Ray",!0);return r&&p.Warn(r),new ii}pickWithRay(e,t,i,s){throw f("Ray")}multiPick(e,t,i,s,n){throw f("Ray")}multiPickWithRay(e,t,i){throw f("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(void 0===t)return e;const s=[];for(const n in e){const r=e[n];Fe&&Fe.MatchesQuery(r,t)&&(!i||i(r))&&s.push(r)}return s}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,s)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,s,n,r,o){const a=Et(e,t,i,s?this.offlineProvider:void 0,n,r,o);return this._activeRequests.push(a),a.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),a}_loadFileAsync(e,t,i,s,n){return new Promise(((r,o)=>{this._loadFile(e,(e=>{r(e)}),t,i,s,((e,t)=>{o(t)}),n)}))}_requestFile(e,t,i,s,n,r,o){const a=St(e,t,i,s?this.offlineProvider:void 0,n,r,o);return this._activeRequests.push(a),a.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),a}_requestFileAsync(e,t,i,s,n){return new Promise(((r,o)=>{this._requestFile(e,(e=>{r(e)}),t,i,s,(e=>{o(e)}),n)}))}_readFile(e,t,i,s,n){const r=bt(e,t,i,s,n);return this._activeRequests.push(r),r.onCompleteObservable.add((e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)})),r}_readFileAsync(e,t,i){return new Promise(((s,n)=>{this._readFile(e,(e=>{s(e)}),t,i,(e=>{n(e)}))}))}getPerfCollector(){throw f("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}function Di(e){-1===e.indexOf("vClipPlane")&&e.push("vClipPlane"),-1===e.indexOf("vClipPlane2")&&e.push("vClipPlane2"),-1===e.indexOf("vClipPlane3")&&e.push("vClipPlane3"),-1===e.indexOf("vClipPlane4")&&e.push("vClipPlane4"),-1===e.indexOf("vClipPlane5")&&e.push("vClipPlane5"),-1===e.indexOf("vClipPlane6")&&e.push("vClipPlane6")}function Ni(e,t,i){var s,n,r,o,a,l;const h=!!(null!==(s=e.clipPlane)&&void 0!==s?s:t.clipPlane),c=!!(null!==(n=e.clipPlane2)&&void 0!==n?n:t.clipPlane2),d=!!(null!==(r=e.clipPlane3)&&void 0!==r?r:t.clipPlane3),u=!!(null!==(o=e.clipPlane4)&&void 0!==o?o:t.clipPlane4),_=!!(null!==(a=e.clipPlane5)&&void 0!==a?a:t.clipPlane5),f=!!(null!==(l=e.clipPlane6)&&void 0!==l?l:t.clipPlane6);h&&i.push("#define CLIPPLANE"),c&&i.push("#define CLIPPLANE2"),d&&i.push("#define CLIPPLANE3"),u&&i.push("#define CLIPPLANE4"),_&&i.push("#define CLIPPLANE5"),f&&i.push("#define CLIPPLANE6")}function Fi(e,t,i){var s,n,r,o,a,l;let h=null!==(s=t.clipPlane)&&void 0!==s?s:i.clipPlane;Li(e,"vClipPlane",h),h=null!==(n=t.clipPlane2)&&void 0!==n?n:i.clipPlane2,Li(e,"vClipPlane2",h),h=null!==(r=t.clipPlane3)&&void 0!==r?r:i.clipPlane3,Li(e,"vClipPlane3",h),h=null!==(o=t.clipPlane4)&&void 0!==o?o:i.clipPlane4,Li(e,"vClipPlane4",h),h=null!==(a=t.clipPlane5)&&void 0!==a?a:i.clipPlane5,Li(e,"vClipPlane5",h),h=null!==(l=t.clipPlane6)&&void 0!==l?l:i.clipPlane6,Li(e,"vClipPlane6",h)}function Li(e,t,i){i&&e.setFloat4(t,i.normal.x,i.normal.y,i.normal.z,i.d)}Oi.FOGMODE_NONE=0,Oi.FOGMODE_EXP=1,Oi.FOGMODE_EXP2=2,Oi.FOGMODE_LINEAR=3,Oi.MinDeltaTime=1,Oi.MaxDeltaTime=1e3;class wi{static BindSceneUniformBuffer(e,t){t.bindToEffect(e,"Scene")}static PrepareDefinesForMergedUV(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}static BindTextureMatrix(e,t,i){const s=e.getTextureMatrix();t.updateMatrix(i+"Matrix",s)}static GetFogState(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==Oi.FOGMODE_NONE}static PrepareDefinesForMisc(e,t,i,s,n,r,o,a=!1){o._areMiscDirty&&(o.LOGARITHMICDEPTH=i,o.POINTSIZE=s,o.FOG=n&&this.GetFogState(e,t),o.NONUNIFORMSCALING=e.nonUniformScaling,o.ALPHATEST=r,o.DECAL_AFTER_DETAIL=a)}static PrepareDefinesForCamera(e,t){let i=!1;if(e.activeCamera){const s=t.CAMERA_ORTHOGRAPHIC?1:0,n=t.CAMERA_PERSPECTIVE?1:0,r=e.activeCamera.mode===Gt.ORTHOGRAPHIC_CAMERA?1:0,o=e.activeCamera.mode===Gt.PERSPECTIVE_CAMERA?1:0;(s^r||n^o)&&(t.CAMERA_ORTHOGRAPHIC=1===r,t.CAMERA_PERSPECTIVE=1===o,i=!0)}return i}static PrepareDefinesForFrameBoundValues(e,t,i,s,n,r=null,o=!1){let a=wi.PrepareDefinesForCamera(e,s);!1!==r&&(a=function(e,t,i){var s,n,r,o,a,l;let h=!1;const c=!!(null!==(s=e.clipPlane)&&void 0!==s?s:t.clipPlane),d=!!(null!==(n=e.clipPlane2)&&void 0!==n?n:t.clipPlane2),u=!!(null!==(r=e.clipPlane3)&&void 0!==r?r:t.clipPlane3),_=!!(null!==(o=e.clipPlane4)&&void 0!==o?o:t.clipPlane4),f=!!(null!==(a=e.clipPlane5)&&void 0!==a?a:t.clipPlane5),p=!!(null!==(l=e.clipPlane6)&&void 0!==l?l:t.clipPlane6);return i.CLIPPLANE!==c&&(i.CLIPPLANE=c,h=!0),i.CLIPPLANE2!==d&&(i.CLIPPLANE2=d,h=!0),i.CLIPPLANE3!==u&&(i.CLIPPLANE3=u,h=!0),i.CLIPPLANE4!==_&&(i.CLIPPLANE4=_,h=!0),i.CLIPPLANE5!==f&&(i.CLIPPLANE5=f,h=!0),i.CLIPPLANE6!==p&&(i.CLIPPLANE6=p,h=!0),h}(i,e,s)),s.DEPTHPREPASS!==!t.getColorWrite()&&(s.DEPTHPREPASS=!s.DEPTHPREPASS,a=!0),s.INSTANCES!==n&&(s.INSTANCES=n,a=!0),s.THIN_INSTANCES!==o&&(s.THIN_INSTANCES=o,a=!0),a&&s.markAsUnprocessed()}static PrepareDefinesForBones(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=void 0!==t.BONETEXTURE;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=!i&&void 0;const s=e.getScene().prePassRenderer;if(s&&s.enabled){const i=-1===s.excludedSkinnedMesh.indexOf(e);t.BONES_VELOCITY_ENABLED=i}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,void 0!==t.BONETEXTURE&&(t.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!(!i||!i.isEnabled)}static PrepareDefinesForAttributes(e,t,i,s,n=!1,r=!0,o=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(Oe.NormalKind),t._needNormals&&e.isVerticesDataPresent(Oe.TangentKind)&&(t.TANGENT=!0);for(let i=1;i<=6;++i)t["UV"+i]=!!t._needUVs&&e.isVerticesDataPresent(`uv${1===i?"":i}`);if(i){const i=e.useVertexColors&&e.isVerticesDataPresent(Oe.ColorKind);t.VERTEXCOLOR=i,t.VERTEXALPHA=e.hasVertexAlpha&&i&&r}return e.isVerticesDataPresent(Oe.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),s&&this.PrepareDefinesForBones(e,t),n&&this.PrepareDefinesForMorphTargets(e,t),o&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}static PrepareDefinesForMultiview(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=null!==e.activeCamera.outputRenderTarget&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}static PrepareDefinesForOIT(e,t,i){const s=t.ORDER_INDEPENDENT_TRANSPARENCY,n=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,s===t.ORDER_INDEPENDENT_TRANSPARENCY&&n===t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS||t.markAsUnprocessed()}static PrepareDefinesForPrePass(e,t,i){const s=t.PREPASS;if(!t._arePrePassDirty)return;const n=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount,t.PREPASS_NORMAL_WORLDSPACE=e.prePassRenderer.generateNormalsInWorldSpace;for(let i=0;i<n.length;i++){const s=e.prePassRenderer.getIndex(n[i].type);-1!==s?(t[n[i].define]=!0,t[n[i].index]=s):t[n[i].define]=!1}}else{t.PREPASS=!1;for(let e=0;e<n.length;e++)t[n[e].define]=!1}t.PREPASS!=s&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,t,i,s,n,r,o){var a;switch(o.needNormals=!0,void 0===n["LIGHT"+s]&&(o.needRebuild=!0),n["LIGHT"+s]=!0,n["SPOTLIGHT"+s]=!1,n["HEMILIGHT"+s]=!1,n["POINTLIGHT"+s]=!1,n["DIRLIGHT"+s]=!1,i.prepareLightSpecificDefines(n,s),n["LIGHT_FALLOFF_PHYSICAL"+s]=!1,n["LIGHT_FALLOFF_GLTF"+s]=!1,n["LIGHT_FALLOFF_STANDARD"+s]=!1,i.falloffType){case Ft.FALLOFF_GLTF:n["LIGHT_FALLOFF_GLTF"+s]=!0;break;case Ft.FALLOFF_PHYSICAL:n["LIGHT_FALLOFF_PHYSICAL"+s]=!0;break;case Ft.FALLOFF_STANDARD:n["LIGHT_FALLOFF_STANDARD"+s]=!0}if(r&&!i.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),n["SHADOW"+s]=!1,n["SHADOWCSM"+s]=!1,n["SHADOWCSMDEBUG"+s]=!1,n["SHADOWCSMNUM_CASCADES"+s]=!1,n["SHADOWCSMUSESHADOWMAXZ"+s]=!1,n["SHADOWCSMNOBLEND"+s]=!1,n["SHADOWCSM_RIGHTHANDED"+s]=!1,n["SHADOWPCF"+s]=!1,n["SHADOWPCSS"+s]=!1,n["SHADOWPOISSON"+s]=!1,n["SHADOWESM"+s]=!1,n["SHADOWCLOSEESM"+s]=!1,n["SHADOWCUBE"+s]=!1,n["SHADOWLOWQUALITY"+s]=!1,n["SHADOWMEDIUMQUALITY"+s]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const t=null!==(a=i.getShadowGenerator(e.activeCamera))&&void 0!==a?a:i.getShadowGenerator();if(t){const e=t.getShadowMap();e&&e.renderList&&e.renderList.length>0&&(o.shadowEnabled=!0,t.prepareDefines(n,s))}}i.lightmapMode!=Ft.LIGHTMAP_DEFAULT?(o.lightmapMode=!0,n["LIGHTMAPEXCLUDED"+s]=!0,n["LIGHTMAPNOSPECULAR"+s]=i.lightmapMode==Ft.LIGHTMAP_SHADOWSONLY):(n["LIGHTMAPEXCLUDED"+s]=!1,n["LIGHTMAPNOSPECULAR"+s]=!1)}static PrepareDefinesForLights(e,t,i,s,n=4,r=!1){if(!i._areLightsDirty)return i._needNormals;let o=0;const a={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!r)for(const r of t.lightSources)if(this.PrepareDefinesForLight(e,t,r,o,i,s,a),o++,o===n)break;i.SPECULARTERM=a.specularEnabled,i.SHADOWS=a.shadowEnabled;for(let e=o;e<n;e++)void 0!==i["LIGHT"+e]&&(i["LIGHT"+e]=!1,i["HEMILIGHT"+e]=!1,i["POINTLIGHT"+e]=!1,i["DIRLIGHT"+e]=!1,i["SPOTLIGHT"+e]=!1,i["SHADOW"+e]=!1,i["SHADOWCSM"+e]=!1,i["SHADOWCSMDEBUG"+e]=!1,i["SHADOWCSMNUM_CASCADES"+e]=!1,i["SHADOWCSMUSESHADOWMAXZ"+e]=!1,i["SHADOWCSMNOBLEND"+e]=!1,i["SHADOWCSM_RIGHTHANDED"+e]=!1,i["SHADOWPCF"+e]=!1,i["SHADOWPCSS"+e]=!1,i["SHADOWPOISSON"+e]=!1,i["SHADOWESM"+e]=!1,i["SHADOWCLOSEESM"+e]=!1,i["SHADOWCUBE"+e]=!1,i["SHADOWLOWQUALITY"+e]=!1,i["SHADOWMEDIUMQUALITY"+e]=!1);const l=e.getEngine().getCaps();return void 0===i.SHADOWFLOAT&&(a.needRebuild=!0),i.SHADOWFLOAT=a.shadowEnabled&&(l.textureFloatRender&&l.textureFloatLinearFiltering||l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=a.lightmapMode,a.needRebuild&&i.rebuild(),a.needNormals}static PrepareUniformsAndSamplersForLight(e,t,i,s,n=null,r=!1){n&&n.push("Light"+e),r||(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),s&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))}static PrepareUniformsAndSamplersList(e,t,i,s=4){let n,r=null;if(e.uniformsNames){const o=e;n=o.uniformsNames,r=o.uniformBuffersNames,t=o.samplers,i=o.defines,s=o.maxSimultaneousLights||0}else n=e,t||(t=[]);for(let e=0;e<s&&i["LIGHT"+e];e++)this.PrepareUniformsAndSamplersForLight(e,n,t,i["PROJECTEDLIGHTTEXTURE"+e],r);i.NUM_MORPH_INFLUENCERS&&n.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(n.push("bakedVertexAnimationSettings"),n.push("bakedVertexAnimationTextureSizeInverted"),n.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(e,t,i=4,s=0){let n=0;for(let r=0;r<i&&e["LIGHT"+r];r++)r>0&&(n=s+r,t.addFallback(n,"LIGHT"+r)),e.SHADOWS||(e["SHADOW"+r]&&t.addFallback(s,"SHADOW"+r),e["SHADOWPCF"+r]&&t.addFallback(s,"SHADOWPCF"+r),e["SHADOWPCSS"+r]&&t.addFallback(s,"SHADOWPCSS"+r),e["SHADOWPOISSON"+r]&&t.addFallback(s,"SHADOWPOISSON"+r),e["SHADOWESM"+r]&&t.addFallback(s,"SHADOWESM"+r),e["SHADOWCLOSEESM"+r]&&t.addFallback(s,"SHADOWCLOSEESM"+r));return n++}static PrepareAttributesForMorphTargetsInfluencers(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,t,i){const s=i.NUM_MORPH_INFLUENCERS;if(s>0&&u.LastCreatedEngine){const n=u.LastCreatedEngine.getCaps().maxVertexAttribs,r=t.morphTargetManager;if(null==r?void 0:r.isUsingTextureForTargets)return;const o=r&&r.supportsNormals&&i.NORMAL,a=r&&r.supportsTangents&&i.TANGENT,l=r&&r.supportsUVs&&i.UV1;for(let i=0;i<s;i++)e.push(Oe.PositionKind+i),o&&e.push(Oe.NormalKind+i),a&&e.push(Oe.TangentKind+i),l&&e.push(Oe.UVKind+"_"+i),e.length>n&&p.Error("Cannot add more vertex attributes for mesh "+t.name)}}static PrepareAttributesForBakedVertexAnimation(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(e,t,i,s){i.NUM_BONE_INFLUENCERS>0&&(s.addCPUSkinningFallback(0,t),e.push(Oe.MatricesIndicesKind),e.push(Oe.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(Oe.MatricesIndicesExtraKind),e.push(Oe.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(Oe.ColorInstanceKind)}static PushAttributesForInstances(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}static BindLightProperties(e,t,i){e.transferToEffect(t,i+"")}static BindLight(e,t,i,s,n,r=!0){e._bindLight(t,i,s,n,r)}static BindLights(e,t,i,s,n=4){const r=Math.min(t.lightSources.length,n);for(let n=0;n<r;n++){const r=t.lightSources[n];this.BindLight(r,n,e,i,"boolean"==typeof s?s:s.SPECULARTERM,t.receiveShadows)}}static BindFogParameters(e,t,i,s=!1){e.fogEnabled&&t.applyFog&&e.fogMode!==Oi.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),s?(e.fogColor.toLinearSpaceToRef(this._TempFogColor,e.getEngine().useExactSrgbConversions),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))}static BindBonesParameters(e,t,i){if(t&&e&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const s=e.skeleton;if(s.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const i=s.getTransformMatrixTexture(e);t.setTexture("boneSampler",i),t.setFloat("boneTextureWidth",4*(s.bones.length+1))}else{const n=s.getTransformMatrices(e);n&&(t.setMatrices("mBones",n),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=n.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),wi._CopyBonesTransformationMatrices(n,i.previousBones[e.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,t){return t.set(e),t}static BindMorphTargetParameters(e,t){const i=e.morphTargetManager;e&&i&&t.setFloatArray("morphTargetInfluences",i.influences)}static BindLogDepth(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const e=i.activeCamera;e.mode===Gt.ORTHOGRAPHIC_CAMERA&&p.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(e.maxZ+1)/Math.LN2))}}}wi._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},wi._TempFogColor=Re.Black();class Bi{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=0|this.width;return e=397*e^(0|this.height),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new Bi(this.width*e,this.height*t)}clone(){return new Bi(this.width,this.height)}equals(e){return!!e&&this.width===e.width&&this.height===e.height}get surface(){return this.width*this.height}static Zero(){return new Bi(0,0)}add(e){return new Bi(this.width+e.width,this.height+e.height)}subtract(e){return new Bi(this.width-e.width,this.height-e.height)}scale(e){return new Bi(this.width*e,this.height*e)}static Lerp(e,t,i){const s=e.width+(t.width-e.width)*i,n=e.height+(t.height-e.height)*i;return new Bi(s,n)}}class Ui{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return!!this._texture&&this._texture.isCube}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return void 0!==(null==e?void 0:e._shareDepth)}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=Bi.Zero(),this._cachedBaseSize=Bi.Zero(),this._initialSamplingMode=2,this._texture=Ui._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return 4===this.delayLoadState?(this.delayLoad(),!1):!!this._texture&&this._texture.isReady}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return this.isReady()&&this._texture?this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize):(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class ki extends Ui{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return!!this._texture&&this._texture.is3D}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return!!this._texture&&this._texture.is2DArray}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){return this._texture?(null===this._texture._gammaSpace&&(this._texture._gammaSpace=this._gammaSpace),this._texture._gammaSpace&&!this._texture._useSRGBBuffer):this._gammaSpace}set gammaSpace(e){var t;if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this)))}get isRGBD(){return null!=this._texture&&this._texture._isRGBD}set isRGBD(e){var t;e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return!!this._texture&&this._texture._linearSpecularLOD}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=Mt()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=ki.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new s,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?ki._IsScene(e)?this._scene=e:this._engine=e:this._scene=u.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return null!==e}getTextureMatrix(){return Te.IdentityReadOnly}getReflectionTextureMatrix(){return Te.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,s,n,r){const o=this._getEngine();if(!o)return null;const a=o._getUseSRGBBuffer(!!n,t),l=o.getLoadedTexturesCache();for(let o=0;o<l.length;o++){const h=l[o];if(!(void 0!==n&&a!==h._useSRGBBuffer||void 0!==s&&s!==h.invertY||h.url!==e||h.generateMipMaps!==!t||i&&i!==h.samplingMode||void 0!==r&&r!==h.isCube))return h.incrementReferences(),h}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&void 0!==this._texture.type?this._texture.type:0}get textureFormat(){return this._texture&&void 0!==this._texture.format?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,s=!0,n=!1,r=0,o=0,a=Number.MAX_VALUE,l=Number.MAX_VALUE){if(!this._texture)return null;const h=this._getEngine();if(!h)return null;const c=this.getSize();let d=c.width,u=c.height;0!==t&&(d/=Math.pow(2,t),u/=Math.pow(2,t),d=Math.round(d),u=Math.round(u)),a=Math.min(d,a),l=Math.min(u,l);try{return this._texture.isCube?h._readTexturePixels(this._texture,a,l,e,t,i,s,n,r,o):h._readTexturePixels(this._texture,a,l,-1,t,i,s,n,r,o)}catch(e){return null}}_readPixelsSync(e=0,t=0,i=null,s=!0,n=!1){if(!this._texture)return null;const r=this.getSize();let o=r.width,a=r.height;const l=this._getEngine();if(!l)return null;0!=t&&(o/=Math.pow(2,t),a/=Math.pow(2,t),o=Math.round(o),a=Math.round(a));try{return this._texture.isCube?l._readTexturePixelsSync(this._texture,o,a,e,t,i,s,n):l._readTexturePixelsSync(this._texture,o,a,-1,t,i,s,n)}catch(e){return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const e=this._parentContainer.textures.indexOf(this);e>-1&&this._parentContainer.textures.splice(e,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=qe.Serialize(this);return qe.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(0!==i)for(let s=0;s<e.length;s++){const n=e[s];if(n.isReady())0==--i&&t();else{const e=n.onLoadObservable;e?e.addOnce((()=>{0==--i&&t()})):0==--i&&t()}}else t()}static _IsScene(e){return"Scene"===e.getClassName()}}function Vi(e,t,i=!1){const s=t.width,n=t.height;if(e instanceof Float32Array){let t=e.byteLength/e.BYTES_PER_ELEMENT;const i=new Uint8Array(t);for(;--t>=0;){let s=e[t];s<0?s=0:s>1&&(s=1),i[t]=255*s}e=i}const r=document.createElement("canvas");r.width=s,r.height=n;const o=r.getContext("2d");if(!o)return null;const a=o.createImageData(s,n);if(a.data.set(e),o.putImageData(a,0,0),i){const e=document.createElement("canvas");e.width=s,e.height=n;const t=e.getContext("2d");return t?(t.translate(0,n),t.scale(1,-1),t.drawImage(r,0,0),e.toDataURL("image/png")):null}return r.toDataURL("image/png")}ki.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,De([Ge()],ki.prototype,"uniqueId",void 0),De([Ge()],ki.prototype,"name",void 0),De([Ge()],ki.prototype,"metadata",void 0),De([Ge("hasAlpha")],ki.prototype,"_hasAlpha",void 0),De([Ge("getAlphaFromRGB")],ki.prototype,"_getAlphaFromRGB",void 0),De([Ge()],ki.prototype,"level",void 0),De([Ge("coordinatesIndex")],ki.prototype,"_coordinatesIndex",void 0),De([Ge()],ki.prototype,"optimizeUVAllocation",void 0),De([Ge("coordinatesMode")],ki.prototype,"_coordinatesMode",void 0),De([Ge()],ki.prototype,"wrapU",null),De([Ge()],ki.prototype,"wrapV",null),De([Ge()],ki.prototype,"wrapR",void 0),De([Ge()],ki.prototype,"anisotropicFilteringLevel",void 0),De([Ge()],ki.prototype,"isCube",null),De([Ge()],ki.prototype,"is3D",null),De([Ge()],ki.prototype,"is2DArray",null),De([Ge()],ki.prototype,"gammaSpace",null),De([Ge()],ki.prototype,"invertZ",void 0),De([Ge()],ki.prototype,"lodLevelInAlpha",void 0),De([Ge()],ki.prototype,"lodGenerationOffset",null),De([Ge()],ki.prototype,"lodGenerationScale",null),De([Ge()],ki.prototype,"linearSpecularLOD",null),De([ze()],ki.prototype,"irradianceTexture",null),De([Ge()],ki.prototype,"isRenderTarget",void 0);class Gi{}Gi.UseOpenGLOrientationForUV=!1;class zi extends ki{static _CreateVideoTexture(e,t,i,s=!1,n=!1,r=zi.TRILINEAR_SAMPLINGMODE,o={},a,l=5){throw f("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,n,r=zi.TRILINEAR_SAMPLINGMODE,o=null,a=null,l=null,h=!1,c,d,u,_,f){var p,m,g,v,T,b,E,S,x,C;let y;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new s,this._isBlocking=!0,this.name=e||"",this.url=e;let A=!1,R=null,I=!0;"object"==typeof i&&null!==i?(y=null!==(p=i.noMipmap)&&void 0!==p&&p,n=null!==(m=i.invertY)&&void 0!==m?m:!Gi.UseOpenGLOrientationForUV,r=null!==(g=i.samplingMode)&&void 0!==g?g:zi.TRILINEAR_SAMPLINGMODE,o=null!==(v=i.onLoad)&&void 0!==v?v:null,a=null!==(T=i.onError)&&void 0!==T?T:null,l=null!==(b=i.buffer)&&void 0!==b?b:null,h=null!==(E=i.deleteBuffer)&&void 0!==E&&E,c=i.format,d=i.mimeType,u=i.loaderOptions,_=i.creationFlags,A=null!==(S=i.useSRGBBuffer)&&void 0!==S&&S,R=null!==(x=i.internalTexture)&&void 0!==x?x:null,I=null!==(C=i.gammaSpace)&&void 0!==C?C:I):y=!!i,this._gammaSpace=I,this._noMipmap=y,this._invertY=void 0===n?!Gi.UseOpenGLOrientationForUV:n,this._initialSamplingMode=r,this._buffer=l,this._deleteBuffer=h,this._mimeType=d,this._loaderOptions=u,this._creationFlags=_,this._useSRGBBuffer=A,this._forcedExtension=f,c&&(this._format=c);const P=this.getScene(),M=this._getEngine();if(!M)return;M.onBeforeTextureInitObservable.notifyObservers(this);const O=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),null!==this._texture._cachedWrapU&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),null!==this._texture._cachedWrapV&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),null!==this._texture._cachedWrapR&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),o&&o(),!this.isBlocking&&P&&P.resetCachedMaterial()},D=(e,t)=>{this._loadingError=!0,this._errorObject={message:e,exception:t},a&&a(e,t),zi.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!R)return this._delayedOnLoad=O,void(this._delayedOnError=D);if(this._texture=null!=R?R:this._getFromCache(this.url,y,r,this._invertY,A,this.isCube),this._texture)if(this._texture.isReady)dt.SetImmediate((()=>O()));else{const e=this._texture.onLoadedObservable.add(O);this._texture.onErrorObservable.add((t=>{var i;D(t.message,t.exception),null===(i=this._texture)||void 0===i||i.onLoadedObservable.remove(e)}))}else if(P&&P.useDelayedTextureLoading)this.delayLoadState=4,this._delayedOnLoad=O,this._delayedOnError=D;else{try{this._texture=M.createTexture(this.url,y,this._invertY,P,r,O,D,this._buffer,void 0,this._format,this._forcedExtension,d,u,_,A)}catch(e){throw D("error loading",e),e}h&&(this._buffer=null)}}updateURL(e,t=null,i,s){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,(e=>e.hasTexture(this)))),this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=s,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(4!==this.delayLoadState)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?dt.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,s){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,me.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,s),s.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,s.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,s.z+=this.wRotationCenter}checkTransformsAreIdentical(e){return null!==e&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,this._cachedTextureMatrix&&this._rowGenerationMatrix||(this._cachedTextureMatrix=Te.Zero(),this._rowGenerationMatrix=new Te,this._t0=me.Zero(),this._t1=me.Zero(),this._t2=me.Zero()),Te.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(Te.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,Ee.Matrix[0]),Te.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,Ee.Matrix[1]),Te.ScalingToRef(this._cachedUScale,this._cachedVScale,0,Ee.Matrix[2]),Te.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,Ee.Matrix[3]),Ee.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(Ee.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(Ee.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(Ee.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),Te.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();return t?(this.optimizeUVAllocation&&t.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode){if(this.coordinatesMode!==zi.PROJECTION_MODE)return this._cachedReflectionTextureMatrix;if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=Te.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=Te.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case zi.PLANAR_MODE:Te.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break;case zi.PROJECTION_MODE:{Te.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const t=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=t.updateFlag,t.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:Te.IdentityToRef(this._cachedReflectionTextureMatrix)}return t&&e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this))),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return qe.Clone((()=>new zi(this._texture?this._texture.url:null,this.getScene(),e)),this)}serialize(){var e,t;const i=this.name;zi.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const s=super.serialize(zi._SerializeInternalTextureUniqueId);return s?((zi.SerializeBuffers||zi.ForceSerializeBuffers)&&("string"==typeof this._buffer&&"data:"===this._buffer.substr(0,5)?(s.base64String=this._buffer,s.name=s.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?s.base64String="data:image/png;base64,"+lt(this._buffer):(zi.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(s.base64String=!this._engine||this._engine._features.supportSyncTextureRead?function(e,t=0,i=0){const s=e.getInternalTexture();if(!s)return null;const n=e._readPixelsSync(t,i);return n?Vi(n,e.getSize(),s.invertY):null}(this):async function(e,t=0,i=0){const s=e.getInternalTexture();if(!s)return null;const n=await e.readPixels(t,i);return n?Vi(n,e.getSize(),s.invertY):null}(this))),s.invertY=this._invertY,s.samplingMode=this.samplingMode,s._creationFlags=this._creationFlags,s._useSRGBBuffer=this._useSRGBBuffer,zi._SerializeInternalTextureUniqueId&&(s.internalTextureUniqueId=null!==(t=null===(e=this._texture)||void 0===e?void 0:e.uniqueId)&&void 0!==t?t:void 0),s.noMipmap=this._noMipmap,this.name=i,s):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const s=Pt.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&s.updateSamplingMode&&s._samplingMode&&s._samplingMode!==e.samplingMode&&s.updateSamplingMode(e.samplingMode),s}if(e.isCube&&!e.isRenderTarget)return zi._CubeTextureParser(e,t,i);const s=void 0!==e.internalTextureUniqueId;if(!e.name&&!e.isRenderTarget&&!s)return null;let n;if(s){const i=t.getEngine().getLoadedTexturesCache();for(const t of i)if(t.uniqueId===e.internalTextureUniqueId){n=t;break}}const r=t=>{var i;if(t&&t._texture&&(t._texture._cachedWrapU=null,t._texture._cachedWrapV=null,t._texture._cachedWrapR=null),e.samplingMode){const i=e.samplingMode;t&&t.samplingMode!==i&&t.updateSamplingMode(i)}if(t&&e.animations)for(let i=0;i<e.animations.length;i++){const s=e.animations[i],n=_e("BABYLON.Animation");n&&t.animations.push(n.Parse(s))}s&&!n&&(null===(i=null==t?void 0:t._texture)||void 0===i||i._setUniqueId(e.internalTextureUniqueId))};return qe.Parse((()=>{var s,o,a;let l=!0;if(e.noMipmap&&(l=!1),e.mirrorPlane){const i=zi._CreateMirror(e.name,e.renderTargetSize,t,l);return i._waitingRenderList=e.renderList,i.mirrorPlane=kt.FromArray(e.mirrorPlane),r(i),i}if(e.isRenderTarget){let i=null;if(e.isCube){if(t.reflectionProbes)for(let i=0;i<t.reflectionProbes.length;i++){const s=t.reflectionProbes[i];if(s.name===e.name)return s.cubeTexture}}else i=zi._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,l,null!==(s=e._creationFlags)&&void 0!==s?s:0),i._waitingRenderList=e.renderList;return r(i),i}if(e.isVideo){const s=zi._CreateVideoTexture(i+(e.url||e.name),i+(e.src||e.url),t,l,e.invertY,e.samplingMode,e.settings||{});return r(s),s}{let s;if(e.base64String&&!n)s=zi.CreateFromBase64String(e.base64String,e.base64String,t,!l,e.invertY,e.samplingMode,(()=>{r(s)}),null!==(o=e._creationFlags)&&void 0!==o?o:0,null!==(a=e._useSRGBBuffer)&&void 0!==a&&a),s.name=e.name;else{let o;o=e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?e.name:i+e.name,e.url&&(e.url.startsWith("data:")||zi.UseSerializedUrlIfAny)&&(o=e.url);const a={noMipmap:!l,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{r(s)},internalTexture:n};s=new zi(o,t,a)}return s}}),e,t)}static CreateFromBase64String(e,t,i,s,n,r=zi.TRILINEAR_SAMPLINGMODE,o=null,a=null,l=5,h){return new zi("data:"+t,i,s,n,r,o,a,e,!1,l,void 0,void 0,h)}static LoadFromDataString(e,t,i,s=!1,n,r=!0,o=zi.TRILINEAR_SAMPLINGMODE,a=null,l=null,h=5,c){return"data:"!==e.substr(0,5)&&(e="data:"+e),new zi(e,i,n,r,o,a,l,t,s,h,void 0,void 0,c)}}zi.SerializeBuffers=!0,zi.ForceSerializeBuffers=!1,zi.OnTextureLoadErrorObservable=new s,zi._SerializeInternalTextureUniqueId=!1,zi._CubeTextureParser=(e,t,i)=>{throw f("CubeTexture")},zi._CreateMirror=(e,t,i,s)=>{throw f("MirrorTexture")},zi._CreateRenderTargetTexture=(e,t,i,s,n)=>{throw f("RenderTargetTexture")},zi.NEAREST_SAMPLINGMODE=1,zi.NEAREST_NEAREST_MIPLINEAR=8,zi.BILINEAR_SAMPLINGMODE=2,zi.LINEAR_LINEAR_MIPNEAREST=11,zi.TRILINEAR_SAMPLINGMODE=3,zi.LINEAR_LINEAR_MIPLINEAR=3,zi.NEAREST_NEAREST_MIPNEAREST=4,zi.NEAREST_LINEAR_MIPNEAREST=5,zi.NEAREST_LINEAR_MIPLINEAR=6,zi.NEAREST_LINEAR=7,zi.NEAREST_NEAREST=1,zi.LINEAR_NEAREST_MIPNEAREST=9,zi.LINEAR_NEAREST_MIPLINEAR=10,zi.LINEAR_LINEAR=2,zi.LINEAR_NEAREST=12,zi.EXPLICIT_MODE=0,zi.SPHERICAL_MODE=1,zi.PLANAR_MODE=2,zi.CUBIC_MODE=3,zi.PROJECTION_MODE=4,zi.SKYBOX_MODE=5,zi.INVCUBIC_MODE=6,zi.EQUIRECTANGULAR_MODE=7,zi.FIXED_EQUIRECTANGULAR_MODE=8,zi.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,zi.CLAMP_ADDRESSMODE=0,zi.WRAP_ADDRESSMODE=1,zi.MIRROR_ADDRESSMODE=2,zi.UseSerializedUrlIfAny=!1,De([Ge()],zi.prototype,"url",void 0),De([Ge()],zi.prototype,"uOffset",void 0),De([Ge()],zi.prototype,"vOffset",void 0),De([Ge()],zi.prototype,"uScale",void 0),De([Ge()],zi.prototype,"vScale",void 0),De([Ge()],zi.prototype,"uAng",void 0),De([Ge()],zi.prototype,"vAng",void 0),De([Ge()],zi.prototype,"wAng",void 0),De([Ge()],zi.prototype,"uRotationCenter",void 0),De([Ge()],zi.prototype,"vRotationCenter",void 0),De([Ge()],zi.prototype,"wRotationCenter",void 0),De([Ge()],zi.prototype,"homogeneousRotationInUVTransform",void 0),De([Ge()],zi.prototype,"isBlocking",null),ue("BABYLON.Texture",zi),qe._TextureParser=zi.Parse;class Hi{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get texture(){var e,t;return null!==(t=null===(e=this._textures)||void 0===e?void 0:e[0])&&void 0!==t?t:null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const s=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,s}constructor(e,t,i,s,n){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=s,this._depthStencilTexture=null,this.label=n}setTextures(e){Array.isArray(e)?this._textures=e:this._textures=e?[e]:null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e)}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),void 0!==t&&t>=0&&(this._layerIndices[e]=t),void 0!==i&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,n=14,r){var o;return null===(o=this._depthStencilTexture)||void 0===o||o.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:s,depthTextureFormat:n,label:r},this),this._depthStencilTexture}_shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var e,t,i,s,n,o,a,l;let h=null;if(this._isMulti){const i=this.textures;if(i&&i.length>0){let s=!1,n=i.length;const o=i[i.length-1]._source;o!==r.Depth&&o!==r.DepthStencil||(s=!0,n--);const a=[],l=[],c=[],d=[],u=[],_=[],f=[],p={};for(let s=0;s<n;++s){const n=i[s];a.push(n.samplingMode),l.push(n.type),c.push(n.format),void 0!==p[n.uniqueId]?(d.push(-1),f.push(0)):(p[n.uniqueId]=s,n.is2DArray?(d.push(35866),f.push(n.depth)):n.isCube?(d.push(34067),f.push(0)):n.is3D?(d.push(32879),f.push(n.depth)):(d.push(3553),f.push(0))),this._faceIndices&&u.push(null!==(e=this._faceIndices[s])&&void 0!==e?e:0),this._layerIndices&&_.push(null!==(t=this._layerIndices[s])&&void 0!==t?t:0)}const m={samplingModes:a,generateMipMaps:i[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:s,types:l,formats:c,textureCount:n,targetTypes:d,faceIndex:u,layerIndex:_,layerCounts:f},g={width:this.width,height:this.height};h=this._engine.createMultipleRenderTarget(g,m);for(let e=0;e<n;++e){if(-1!==d[e])continue;const t=p[i[e].uniqueId];h.setTexture(h.textures[t],e)}}}else{const e={};if(e.generateDepthBuffer=this._generateDepthBuffer,e.generateMipMaps=null!==(s=null===(i=this.texture)||void 0===i?void 0:i.generateMipMaps)&&void 0!==s&&s,e.generateStencilBuffer=this._generateStencilBuffer,e.samplingMode=null===(n=this.texture)||void 0===n?void 0:n.samplingMode,e.type=null===(o=this.texture)||void 0===o?void 0:o.type,e.format=null===(a=this.texture)||void 0===a?void 0:a.format,this.isCube)h=this._engine.createRenderTargetCubeTexture(this.width,e);else{const t={width:this.width,height:this.height,layers:this.is2DArray?null===(l=this.texture)||void 0===l?void 0:l.depth:void 0};h=this._engine.createRenderTargetTexture(t,e)}h.texture.isReady=!0}return h}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=2===t||3===t||11===t;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,i,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){var e,t;if(this._textures)for(let i=0;null!==(t=i<(null===(e=this._textures)||void 0===e?void 0:e.length))&&void 0!==t&&t;++i)this._textures[i].dispose();this._textures=null}dispose(e=!1){var t;e||(null===(t=this._depthStencilTexture)||void 0===t||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class Wi extends Hi{constructor(e,t,i,s,n){super(e,t,i,s),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=n}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(e){super._shareDepth(e);const t=this._context,i=this._depthStencilBuffer,s=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&e._depthStencilBuffer!==i&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=i;const n=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;this._engine._bindUnboundFramebuffer(s),t.framebufferRenderbuffer(t.FRAMEBUFFER,n,t.RENDERBUFFER,i),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,s=0){var n,r,o,a;if(!e._hardwareTexture)return;const l=this._framebuffer,h=this._engine._currentFramebuffer;if(this._engine._bindUnboundFramebuffer(l),this._engine.webGLVersion>1){const l=this._context,h=l["COLOR_ATTACHMENT"+t];e.is2DArray||e.is3D?(i=null!==(r=null!=i?i:null===(n=this.layerIndices)||void 0===n?void 0:n[t])&&void 0!==r?r:0,l.framebufferTextureLayer(l.FRAMEBUFFER,h,e._hardwareTexture.underlyingResource,s,i)):e.isCube?(i=null!==(a=null!=i?i:null===(o=this.faceIndices)||void 0===o?void 0:o[t])&&void 0!==a?a:0,l.framebufferTexture2D(l.FRAMEBUFFER,h,l.TEXTURE_CUBE_MAP_POSITIVE_X+i,e._hardwareTexture.underlyingResource,s)):l.framebufferTexture2D(l.FRAMEBUFFER,h,l.TEXTURE_2D,e._hardwareTexture.underlyingResource,s)}else{const n=this._context,r=n["COLOR_ATTACHMENT"+t+"_WEBGL"],o=void 0!==i?n.TEXTURE_CUBE_MAP_POSITIVE_X+i:n.TEXTURE_2D;n.framebufferTexture2D(n.FRAMEBUFFER,r,o,e._hardwareTexture.underlyingResource,s)}this._engine._bindUnboundFramebuffer(h)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){var i,s;if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const n=null!==(s=null===(i=this._attachments)||void 0===i?void 0:i.length)&&void 0!==s?s:this.textures.length;for(let e=0;e<n;e++){const t=this.textures[e];t&&(t.is2DArray||t.is3D?this._bindTextureRenderTarget(t,e,this.layerIndices[e]):t.isCube?this._bindTextureRenderTarget(t,e,this.faceIndices[e]):this._bindTextureRenderTarget(t,e))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const s=this.textures[e];s.is2DArray||s.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):s.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}dispose(e=this._disposeOnlyFramebuffers){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}q.prototype._createHardwareRenderTargetWrapper=function(e,t,i){const s=new Wi(e,t,i,this,this._gl);return this._renderTargetWrapperCache.push(s),s},q.prototype.createRenderTargetTexture=function(e,t){var i,s;const n=this._createHardwareRenderTargetWrapper(!1,!1,e);let o,a=!0,l=!1,h=!1,c=1;void 0!==t&&"object"==typeof t&&(a=null===(i=t.generateDepthBuffer)||void 0===i||i,l=!!t.generateStencilBuffer,h=!!t.noColorAttachment,o=t.colorAttachment,c=null!==(s=t.samples)&&void 0!==s?s:1);const d=o||(h?null:this._createInternalTexture(e,t,!0,r.RenderTarget)),u=e.width||e,_=e.height||e,f=this._currentFramebuffer,p=this._gl,m=p.createFramebuffer();return this._bindUnboundFramebuffer(m),n._depthStencilBuffer=this._setupFramebufferDepthAttachments(l,a,u,_),d&&!d.is2DArray&&p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,d._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(f),n._framebuffer=m,n._generateDepthBuffer=a,n._generateStencilBuffer=l,n.setTextures(d),this.updateRenderTargetTextureSampleCount(n,c),n},q.prototype.createDepthStencilTexture=function(e,t,i){if(t.isCube){const s=e.width||e;return this._createDepthStencilCubeTexture(s,t,i)}return this._createDepthStencilTexture(e,t,i)},q.prototype._createDepthStencilTexture=function(e,t,i){const s=this._gl,n=e.layers||0,o=0!==n?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,l=new a(this,r.DepthStencil);if(!this._caps.depthTextureExtension)return p.Error("Depth texture is not supported by your browser or hardware."),l;const h=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t);if(this._bindTextureDirectly(o,l,!0),this._setupDepthStencilTexture(l,e,h.generateStencil,0!==h.comparisonFunction&&h.bilinearFiltering,h.comparisonFunction,h.samples),void 0!==h.depthTextureFormat){if(15!==h.depthTextureFormat&&16!==h.depthTextureFormat&&17!==h.depthTextureFormat&&13!==h.depthTextureFormat&&14!==h.depthTextureFormat&&18!==h.depthTextureFormat)return p.Error("Depth texture format is not supported."),l;l.format=h.depthTextureFormat}else l.format=h.generateStencil?13:16;const c=17===l.format||13===l.format||18===l.format;i._depthStencilTexture=l,i._depthStencilTextureWithStencil=c;let d=s.UNSIGNED_INT;15===l.format?d=s.UNSIGNED_SHORT:17===l.format||13===l.format?d=s.UNSIGNED_INT_24_8:14===l.format?d=s.FLOAT:18===l.format&&(d=s.FLOAT_32_UNSIGNED_INT_24_8_REV);const u=c?s.DEPTH_STENCIL:s.DEPTH_COMPONENT;let _=u;this.webGLVersion>1&&(15===l.format?_=s.DEPTH_COMPONENT16:16===l.format?_=s.DEPTH_COMPONENT24:17===l.format||13===l.format?_=s.DEPTH24_STENCIL8:14===l.format?_=s.DEPTH_COMPONENT32F:18===l.format&&(_=s.DEPTH32F_STENCIL8)),l.is2DArray?s.texImage3D(o,0,_,l.width,l.height,n,0,u,d,null):s.texImage2D(o,0,_,l.width,l.height,0,u,d,null),this._bindTextureDirectly(o,null),this._internalTexturesCache.push(l);const f=i;if(f._depthStencilBuffer){const e=this._currentFramebuffer;this._bindUnboundFramebuffer(f._framebuffer),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,null),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,null),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.STENCIL_ATTACHMENT,s.RENDERBUFFER,null),this._bindUnboundFramebuffer(e),s.deleteRenderbuffer(f._depthStencilBuffer),f._depthStencilBuffer=null}return l},q.prototype.updateRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e||!e.texture)return 1;if(e.samples===t)return t;const i=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(i.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(i.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);const s=e.texture._hardwareTexture;if(s.releaseMSAARenderBuffers(),t>1&&"function"==typeof i.renderbufferStorageMultisample){const n=i.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=n,this._bindUnboundFramebuffer(e._MSAAFramebuffer);const r=this._createRenderBuffer(e.texture.width,e.texture.height,t,-1,this._getRGBABufferInternalSizedFormat(e.texture.type,e.texture.format,e.texture._useSRGBBuffer),i.COLOR_ATTACHMENT0,!1);if(!r)throw new Error("Unable to create multi sampled framebuffer");s.addMSAARenderBuffer(r)}else this._bindUnboundFramebuffer(e._framebuffer);return e.texture.samples=t,e._samples=t,e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.texture.width,e.texture.height,t),this._bindUnboundFramebuffer(null),t},q.prototype.createRenderTargetCubeTexture=function(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!0,e),s=Object.assign({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},t);s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,(1!==s.type||this._caps.textureFloatLinearFiltering)&&(2!==s.type||this._caps.textureHalfFloatLinearFiltering)||(s.samplingMode=1);const n=this._gl,o=new a(this,r.RenderTarget);this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,o,!0);const l=this._getSamplingParameters(s.samplingMode,s.generateMipMaps);1!==s.type||this._caps.textureFloat||(s.type=0,p.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MAG_FILTER,l.mag),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_MIN_FILTER,l.min),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE);for(let t=0;t<6;t++)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this._getRGBABufferInternalSizedFormat(s.type,s.format),e,e,0,this._getInternalFormat(s.format),this._getWebGLTextureType(s.type),null);const h=n.createFramebuffer();return this._bindUnboundFramebuffer(h),i._depthStencilBuffer=this._setupFramebufferDepthAttachments(s.generateStencilBuffer,s.generateDepthBuffer,e,e),s.generateMipMaps&&n.generateMipmap(n.TEXTURE_CUBE_MAP),this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),i._framebuffer=h,i._generateDepthBuffer=s.generateDepthBuffer,i._generateStencilBuffer=s.generateStencilBuffer,o.width=e,o.height=e,o.isReady=!0,o.isCube=!0,o.samples=1,o.generateMipMaps=s.generateMipMaps,o.samplingMode=s.samplingMode,o.type=s.type,o.format=s.format,this._internalTexturesCache.push(o),i.setTextures(o),i};F.ShadersStore.postprocessVertexShader="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";const Xi={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class Qi{constructor(e,t=Xi){var i,s;this._fullscreenViewport=new Ut(0,0,1,1);const n=null!==(i=t.positions)&&void 0!==i?i:Xi.positions,r=null!==(s=t.indices)&&void 0!==s?s:Xi.indices;this.engine=e,this._vertexBuffers={[Oe.PositionKind]:new Oe(e,n,Oe.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(r),this._onContextRestoredObserver=e.onContextRestoredObservable.add((()=>{this._indexBuffer=e.createIndexBuffer(r);for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}))}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return void 0!==e.renderTarget}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const i=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[Oe.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[Oe.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class Yi{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){let t;this.onApplyObservable=new s;const i=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add((()=>{this.effect.setFloat2("scale",1,1)})));const n=e.defines?e.defines.join("\n"):"";this._drawWrapper=new Y(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],i,e.samplerNames,n,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new L(t,e.attributeNames||["position"],i,e.samplerNames,e.engine,n,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add((()=>{this.effect._pipelineContext=null,this.effect._wasPreviouslyReady=!1,this.effect._prepareEffect()})))}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}const Ki="passPixelShader",ji="varying vec2 vUV;uniform sampler2D textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);}";F.ShadersStore[Ki]=ji;const $i=Ki,qi=ji;class Zi{static _CreateDumpRenderer(){if(!Zi._DumpToolsEngine){let e,t=null;const i={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};try{e=new OffscreenCanvas(100,100),t=new q(e,!1,i)}catch(s){e=document.createElement("canvas"),t=new q(e,!1,i)}t.getCaps().parallelShaderCompile=void 0;const s=new Qi(t),n=new Yi({engine:t,name:$i,fragmentShader:qi,samplerNames:["textureSampler"]});Zi._DumpToolsEngine={canvas:e,engine:t,renderer:s,wrapper:n}}return Zi._DumpToolsEngine}static async DumpFramebuffer(e,t,i,s,n="image/png",r,o){const a=await i.readPixels(0,0,e,t),l=new Uint8Array(a.buffer);Zi.DumpData(e,t,l,s,n,r,!0,void 0,o)}static DumpDataAsync(e,t,i,s="image/png",n,r=!1,o=!1,a){return new Promise((l=>{Zi.DumpData(e,t,i,(e=>l(e)),s,n,r,o,a)}))}static DumpData(e,t,i,s,n="image/png",r,o=!1,a=!1,l){const h=Zi._CreateDumpRenderer();if(h.engine.setSize(e,t,!0),i instanceof Float32Array){const e=new Uint8Array(i.length);let t=i.length;for(;t--;){const s=i[t];e[t]=Math.round(255*ne.Clamp(s))}i=e}const c=h.engine.createRawTexture(i,e,t,5,!1,!o,1);h.renderer.setViewport(),h.renderer.applyEffectWrapper(h.wrapper),h.wrapper.effect._bindTexture("textureSampler",c),h.renderer.draw(),a?Ot.ToBlob(h.canvas,(e=>{const t=new FileReader;t.onload=e=>{const t=e.target.result;s&&s(t)},t.readAsArrayBuffer(e)}),n,l):Ot.EncodeScreenshotCanvasData(h.canvas,s,n,r,l),c.dispose()}static Dispose(){Zi._DumpToolsEngine&&(Zi._DumpToolsEngine.wrapper.dispose(),Zi._DumpToolsEngine.renderer.dispose(),Zi._DumpToolsEngine.engine.dispose()),Zi._DumpToolsEngine=null}}Ot.DumpData=Zi.DumpData,Ot.DumpDataAsync=Zi.DumpDataAsync,Ot.DumpFramebuffer=Zi.DumpFramebuffer;class Ji extends zi{get renderList(){return this._renderList}set renderList(e){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=ce(e,this._renderListHasChanged)),this._renderList=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let i;i=Array.isArray(e)?e:[e];for(let e=0;e<i.length;++e)for(let s=0;s<this._renderPassIds.length;++s)i[e].setMaterialForRenderPass(this._renderPassIds[s],void 0!==t?Array.isArray(t)?t[s]:t:void 0)}get isMulti(){var e,t;return null!==(t=null===(e=this._renderTarget)||void 0===e?void 0:e.isMulti)&&void 0!==t&&t}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e,t;return null!==(t=null===(e=this._renderTarget)||void 0===e?void 0:e._depthStencilTexture)&&void 0!==t?t:null}constructor(e,t,i,n=!1,r=!0,o=0,a=!1,l=zi.TRILINEAR_SAMPLINGMODE,h=!0,c=!1,d=!1,u=5,_=!1,f,p,m=!1,g=!1){var v,T,b,E,S,x,C;let y,A=!0;if("object"==typeof n){const e=n;n=!!e.generateMipMaps,r=null===(v=e.doNotChangeAspectRatio)||void 0===v||v,o=null!==(T=e.type)&&void 0!==T?T:0,a=!!e.isCube,l=null!==(b=e.samplingMode)&&void 0!==b?b:zi.TRILINEAR_SAMPLINGMODE,h=null===(E=e.generateDepthBuffer)||void 0===E||E,c=!!e.generateStencilBuffer,d=!!e.isMulti,u=null!==(S=e.format)&&void 0!==S?S:5,_=!!e.delayAllocation,f=e.samples,p=e.creationFlags,m=!!e.noColorAttachment,g=!!e.useSRGBBuffer,y=e.colorAttachment,A=null!==(x=e.gammaSpace)&&void 0!==x?x:A}if(super(null,i,!n,void 0,l,void 0,void 0,void 0,void 0,u),this._unObserveRenderList=null,this._renderListHasChanged=(e,t)=>{var i;const s=this._renderList?this._renderList.length:0;(0===t&&s>0||0===s)&&(null===(i=this.getScene())||void 0===i||i.meshes.forEach((e=>{e._markSubMeshesAsLightDirty()})))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new s,this.onAfterUnbindObservable=new s,this.onBeforeRenderObservable=new s,this.onAfterRenderObservable=new s,this.onClearObservable=new s,this.onResizeObservable=new s,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=me.Zero(),!(i=this.getScene()))return;const R=this.getScene().getEngine();this._gammaSpace=A,this._coordinatesMode=zi.PROJECTION_MODE,this.renderList=[],this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._renderPassIds=[],this._isCubeData=a,this._processSizeParameter(t),this.renderPassId=this._renderPassIds[0],this._resizeObserver=R.onResizeObservable.add((()=>{})),this._generateMipMaps=!!n,this._doNotChangeAspectRatio=r,this._renderingManager=new ai(i),this._renderingManager._useSceneAutoClearSetup=!0,d||(this._renderTargetOptions={generateMipMaps:n,type:o,format:null!==(C=this._format)&&void 0!==C?C:void 0,samplingMode:this.samplingMode,generateDepthBuffer:h,generateStencilBuffer:c,samples:f,creationFlags:p,noColorAttachment:m,useSRGBBuffer:g,colorAttachment:y,label:this.name},this.samplingMode===zi.NEAREST_SAMPLINGMODE&&(this.wrapU=zi.CLAMP_ADDRESSMODE,this.wrapV=zi.CLAMP_ADDRESSMODE),_||(a?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=zi.INVCUBIC_MODE,this._textureMatrix=Te.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==f&&(this.samples=f)))}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,n=14){var r;null===(r=this._renderTarget)||void 0===r||r.createDepthStencilTexture(e,t,i,s,n)}_releaseRenderPassId(){if(this._scene){const e=this._scene.getEngine();for(let t=0;t<this._renderPassIds.length;++t)e.releaseRenderPassId(this._renderPassIds[t])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine(),t=this._isCubeData?6:this.getRenderLayers()||1;for(let i=0;i<t;++i)this._renderPassIds[i]=e.createRenderPassId(`RenderTargetTexture - ${this.name}#${i}`)}_processSizeParameter(e,t=!0){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e;t&&this._createRenderPassId()}get samples(){var e,t;return null!==(t=null===(e=this._renderTarget)||void 0===e?void 0:e.samples)&&void 0!==t?t:this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}addPostProcess(e){if(!this._postProcessManager){const e=this.getScene();if(!e)return;this._postProcessManager=new ni(e),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const e of this._postProcesses)e.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){return this._size.layers||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var t;const i=this.isCube;null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null;const s=this.getScene();s&&(this._processSizeParameter(e,!1),this._renderTarget=i?s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(e=!1,t=!1,i=!1){var s;const n=this.getScene();if(!n)return i;const r=n.getEngine();if(void 0!==this.useCameraPostProcesses&&(e=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(let e=0;e<this._waitingRenderList.length;e++){const t=this._waitingRenderList[e],i=n.getMeshById(t);i&&this.renderList.push(i)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const e=this.getScene();if(!e)return i;const t=e.meshes;for(let e=0;e<t.length;e++){const i=t[e];this.renderListPredicate(i)&&this.renderList.push(i)}}const o=r.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const a=null!==(s=this.activeCamera)&&void 0!==s?s:n.activeCamera,l=n.activeCamera;a&&(a!==n.activeCamera&&(n.setTransformMatrix(a.getViewMatrix(),a.getProjectionMatrix(!0)),n.activeCamera=a),r.setViewport(a.rigParent?a.rigParent.viewport:a.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let h=i;if(i){n.getViewMatrix()||n.updateTransformMatrix();const e=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let t=0;t<e&&h;t++){let e=null;const s=this.renderList?this.renderList:n.getActiveMeshes().data,o=this.renderList?this.renderList.length:n.getActiveMeshes().length;r.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t),this.getCustomRenderList&&(e=this.getCustomRenderList(t,s,o)),e||(e=s),this._doNotChangeAspectRatio||n.updateTransformMatrix(!0);for(let t=0;t<e.length&&h;++t){const s=e[t];if(s.isEnabled()&&!s.isBlocked&&s.isVisible&&s.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(s,this.refreshRate,i)){h=!1;continue}}else if(!s.isReady(!0)){h=!1;continue}}this.onAfterRenderObservable.notifyObservers(t),(this.is2DArray||this.isCube)&&(n.incrementRenderId(),n.resetCachedMaterial())}}else if(this.is2DArray&&!this.isMulti)for(let i=0;i<this.getRenderLayers();i++)this._renderToTarget(0,e,t,i,a),n.incrementRenderId(),n.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let i=0;i<6;i++)this._renderToTarget(i,e,t,void 0,a),n.incrementRenderId(),n.resetCachedMaterial();else this._renderToTarget(0,e,t,void 0,a);return this.onAfterUnbindObservable.notifyObservers(this),r.currentRenderPassId=o,l&&(n.activeCamera=l,this.activeCamera&&this.activeCamera!==n.activeCamera&&n.setTransformMatrix(n.activeCamera.getViewMatrix(),n.activeCamera.getProjectionMatrix(!0)),r.setViewport(n.activeCamera.viewport)),n.resetCachedMaterial(),h}_bestReflectionRenderTargetDimension(e,t){const i=e*t,s=te.NearestPOT(i+16384/(128+i));return Math.min(te.FloorPOT(e),s)}_prepareRenderingManager(e,t,i,s){const n=this.getScene();if(!n)return;this._renderingManager.reset();const r=n.getRenderId();for(let o=0;o<t;o++){const t=e[o];if(t&&!t.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!t.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}if(!t._internalAbstractMeshDataInfo._currentLODIsUpToDate&&n.activeCamera&&(t._internalAbstractMeshDataInfo._currentLOD=n.customLODSelector?n.customLODSelector(t,this.activeCamera||n.activeCamera):t.getLOD(this.activeCamera||n.activeCamera),t._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!t._internalAbstractMeshDataInfo._currentLOD)continue;let e,o=t._internalAbstractMeshDataInfo._currentLOD;if(o._preActivateForIntermediateRendering(r),e=!(!s||!i)&&0==(t.layerMask&i.layerMask),t.isEnabled()&&t.isVisible&&t.subMeshes&&!e&&(o!==t&&o._activate(r,!0),t._activate(r,!0)&&t.subMeshes.length)){t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(o=t):o._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,o._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let e=0;e<o.subMeshes.length;e++){const t=o.subMeshes[e];this._renderingManager.dispatch(t,o)}}}}for(let e=0;e<n.particleSystems.length;e++){const t=n.particleSystems[e],i=t.emitter;t.isStarted()&&i&&(!i.position||i.isEnabled())&&this._renderingManager.dispatchParticles(t)}}_bindFrameBuffer(e=0,t=0){const i=this.getScene();if(!i)return;const s=i.getEngine();this._renderTarget&&s.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t)}))}_prepareFrame(e,t,i,s){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):s&&e.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(t,i)}_renderToTarget(e,t,i,s=0,n=null){var r,o,a,l,h,c;const d=this.getScene();if(!d)return;const u=d.getEngine();if(null===(r=u._debugPushGroup)||void 0===r||r.call(u,`render to face #${e} layer #${s}`,1),this._prepareFrame(d,e,s,t),this.is2DArray?(u.currentRenderPassId=this._renderPassIds[s],this.onBeforeRenderObservable.notifyObservers(s)):(u.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),u.snapshotRendering&&1===u.snapshotRenderingMode)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(u):this.skipInitialClear||u.clear(this.clearColor||d.clearColor,!0,!0,!0);else{let r=null;const c=this.renderList?this.renderList:d.getActiveMeshes().data,_=this.renderList?this.renderList.length:d.getActiveMeshes().length;this.getCustomRenderList&&(r=this.getCustomRenderList(this.is2DArray?s:e,c,_)),r?this._prepareRenderingManager(r,r.length,n,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(c,_,n,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),r=c);for(const t of d._beforeRenderTargetClearStage)t.action(this,e,s);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(u):this.skipInitialClear||u.clear(this.clearColor||d.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||d.updateTransformMatrix(!0);for(const t of d._beforeRenderTargetDrawStage)t.action(this,e,s);this._renderingManager.render(this.customRenderFunction,r,this.renderParticles,this.renderSprites);for(const t of d._afterRenderTargetDrawStage)t.action(this,e,s);const f=null!==(a=null===(o=this._texture)||void 0===o?void 0:o.generateMipMaps)&&void 0!==a&&a;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,null!==(l=this._renderTarget)&&void 0!==l?l:void 0,e,this._postProcesses,this.ignoreCameraViewport):t&&d.postProcessManager._finalizeFrame(!1,null!==(h=this._renderTarget)&&void 0!==h?h:void 0,e);for(const t of d._afterRenderTargetPostProcessStage)t.action(this,e,s);this._texture&&(this._texture.generateMipMaps=f),this._doNotChangeAspectRatio||d.updateTransformMatrix(!0),i&&Zi.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),u)}this._unbindFrameBuffer(u,e),this._texture&&this.isCube&&5===e&&u.generateMipMapsForCubemap(this._texture),null===(c=u._debugPopGroup)||void 0===c||c.call(u,1)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=this.getSize(),t=new Ji(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){var e;null===(e=this._renderTarget)||void 0===e||e.dispose(!0)}releaseInternalTexture(){var e;null===(e=this._renderTarget)||void 0===e||e.releaseTextures(),this._texture=null}dispose(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const t=this.getScene();if(!t)return;let i=t.customRenderTargets.indexOf(this);i>=0&&t.customRenderTargets.splice(i,1);for(const e of t.cameras)i=e.customRenderTargets.indexOf(this),i>=0&&e.customRenderTargets.splice(i,1);null===(e=this._renderTarget)||void 0===e||e.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===Ji.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Ji.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}Ji.REFRESHRATE_RENDER_ONCE=0,Ji.REFRESHRATE_RENDER_ONEVERYFRAME=1,Ji.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,zi._CreateRenderTargetTexture=(e,t,i,s,n)=>new Ji(e,t,i,s);class es{static RegisterShaderCodeProcessing(e,t){t?es._CustomShaderCodeProcessing[null!=e?e:""]=t:delete es._CustomShaderCodeProcessing[null!=e?e:""]}static _GetShaderCodeProcessing(e){var t;return null!==(t=es._CustomShaderCodeProcessing[e])&&void 0!==t?t:es._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach((e=>{e.setSamples(this._samples)}))}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,n,r,o,a=1,l,h,c=null,d=0,u="postprocess",_,f=!1,p=5,m=y.GLSL){var g,v,T,b,E,S,x,C,A,R,I,P;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.alphaMode=0,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new wt(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new pe(1,1),this._texelSize=pe.Zero(),this.onActivateObservable=new s,this.onSizeChangedObservable=new s,this.onApplyObservable=new s,this.onBeforeRenderObservable=new s,this.onAfterRenderObservable=new s,this.name=e;let M=1,O=null;if(i&&!Array.isArray(i)){const e=i;i=null!==(g=e.uniforms)&&void 0!==g?g:null,n=null!==(v=e.samplers)&&void 0!==v?v:null,M=null!==(T=e.size)&&void 0!==T?T:1,o=null!==(b=e.camera)&&void 0!==b?b:null,a=null!==(E=e.samplingMode)&&void 0!==E?E:1,l=e.engine,h=e.reusable,c=null!==(S=e.defines)&&void 0!==S?S:null,d=null!==(x=e.textureType)&&void 0!==x?x:0,u=null!==(C=e.vertexUrl)&&void 0!==C?C:"postprocess",_=e.indexParameters,f=null!==(A=e.blockCompilation)&&void 0!==A&&A,p=null!==(R=e.textureFormat)&&void 0!==R?R:5,m=null!==(I=e.shaderLanguage)&&void 0!==I?I:y.GLSL,O=null!==(P=e.uniformBuffers)&&void 0!==P?P:null}else r&&(M="number"==typeof r?r:{width:r.width,height:r.height});null!=o?(this._camera=o,this._scene=o.getScene(),o.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=M,this.renderTargetSamplingMode=a||1,this._reusable=h||!1,this._textureType=d,this._textureFormat=p,this._shaderLanguage=m,this._samplers=n||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=u,this._parameters=i||[],this._parameters.push("scale"),this._uniformBuffers=O||[],this._indexParameters=_,this._drawWrapper=new Y(this._engine),f||this.updateEffect(c)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){0==this._textures.length&&(this._textures=new wt(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,s,n,r,o,a){var l,h;const c=es._GetShaderCodeProcessing(this.name);if(null==c?void 0:c.defineCustomBindings){const s=null!==(l=null==t?void 0:t.slice())&&void 0!==l?l:[];s.push(...this._parameters);const n=null!==(h=null==i?void 0:i.slice())&&void 0!==h?h:[];n.push(...this._samplers),e=c.defineCustomBindings(this.name,e,s,n),t=s,i=n}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:null!=o?o:this._vertexUrl,fragment:null!=a?a:this._fragmentUrl},{attributes:["position"],uniformsNames:t||this._parameters,uniformBuffersNames:this._uniformBuffers,samplers:i||this._samplers,defines:null!==e?e:"",fallbacks:null,onCompiled:null!=n?n:null,onError:null!=r?r:null,indexParameters:s||this._indexParameters,processCodeAfterIncludes:(null==c?void 0:c.processCodeAfterIncludes)?(e,t)=>c.processCodeAfterIncludes(this.name,e,t):null,processFinalCode:(null==c?void 0:c.processFinalCode)?(e,t)=>c.processFinalCode(this.name,e,t):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture.width===e.width&&this._textureCache[s].texture.height===e.height&&this._textureCache[s].postProcessChannel===i&&this._textureCache[s].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[s].texture.samples===t.samples)return this._textureCache[s].texture;const s=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:s,postProcessChannel:i,lastUsedRenderId:-1}),s}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let e=!1;for(let i=0;i<this._textures.length;i++)if(this._textures.data[i]===this._textureCache[t].texture){e=!0;break}e||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,i=null,s=!1,n=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let r=null;if(i)for(let e=0;e<i._postProcesses.length;e++)if(null!==i._postProcesses[e]){r=i._postProcesses[e];break}const o={width:this.width,height:this.height},a={generateMipMaps:s,generateDepthBuffer:n||r===this,generateStencilBuffer:(n||r===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(o,a,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,a,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let t;e=this.inputTexture;for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture===e){t=this._textureCache[i];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,i){var s,n;const r=(e=e||this._camera).getScene(),o=r.getEngine(),a=o.getCaps().maxTextureSize,l=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,h=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let c=this._options.width||l,d=this._options.height||h;const u=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let _=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const e=o.currentViewport;e&&(c*=e.width,d*=e.height)}(u||this.alwaysForcePOT)&&(this._options.width||(c=o.needPOTTextures?te.GetExponentOfTwo(c,a,this.scaleMode):c),this._options.height||(d=o.needPOTTextures?te.GetExponentOfTwo(d,a,this.scaleMode):d)),this.width===c&&this.height===d&&(_=this._getTarget())||this.resize(c,d,e,u,i),this._textures.forEach((e=>{e.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(e,this.samples)})),this._flushTextureCache(),this._renderId++}return _||(_=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(l/c,h/d),this._engine.bindFramebuffer(_,0,l,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(_,0,void 0,void 0,this.forceFullscreenViewport)),null===(n=(s=this._engine)._debugInsertMarker)||void 0===n||n.call(s,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:r.clearColor,r._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),_}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,t;return null!==(t=null===(e=this._drawWrapper.effect)||void 0===e?void 0:e.isReady())&&void 0!==t&&t}apply(){var e,t,i;if(!(null===(e=this._drawWrapper.effect)||void 0===e?void 0:e.isReady()))return null;let s;return this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),s=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",null==s?void 0:s.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),null===(i=null===(t=es._GetShaderCodeProcessing(this.name))||void 0===t?void 0:t.bindCustomBindings)||void 0===i||i.call(t,this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}dispose(e){let t;if(e=e||this._camera,this._disposeTextures(),this._scene&&(t=this._scene.postProcesses.indexOf(this),-1!==t&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const e=this._parentContainer.postProcesses.indexOf(this);e>-1&&this._parentContainer.postProcesses.splice(e,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),-1!==t&&this._engine.postProcesses.splice(t,1),e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),0===t&&e._postProcesses.length>0){const e=this._camera._getFirstPostProcess();e&&e.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const e=qe.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=es.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const s=_e(e.customType);if(!s||!s._Parse)return null;const n=t?t.getCameraById(e.cameraId):null;return s._Parse(e,n,t,i)}static _Parse(e,t,i,s){return qe.Parse((()=>new es(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat)),e,i,s)}}es._CustomShaderCodeProcessing={},De([Ge()],es.prototype,"uniqueId",void 0),De([Ge()],es.prototype,"name",void 0),De([Ge()],es.prototype,"width",void 0),De([Ge()],es.prototype,"height",void 0),De([Ge()],es.prototype,"renderTargetSamplingMode",void 0),De([Ke()],es.prototype,"clearColor",void 0),De([Ge()],es.prototype,"autoClear",void 0),De([Ge()],es.prototype,"forceAutoClearInAlphaMode",void 0),De([Ge()],es.prototype,"alphaMode",void 0),De([Ge()],es.prototype,"alphaConstants",void 0),De([Ge()],es.prototype,"enablePixelPerfectMode",void 0),De([Ge()],es.prototype,"forceFullscreenViewport",void 0),De([Ge()],es.prototype,"scaleMode",void 0),De([Ge()],es.prototype,"alwaysForcePOT",void 0),De([Ge("samples")],es.prototype,"_samples",void 0),De([Ge()],es.prototype,"adaptScaleToCurrentViewport",void 0),ue("BABYLON.PostProcess",es);F.IncludesShadersStore.kernelBlurVaryingDeclaration="varying vec2 sampleCoord{X};";F.IncludesShadersStore.packingFunctions="vec4 pack(float depth)\n{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}";F.IncludesShadersStore.kernelBlurFragment="#ifdef DOF\nfactor=sampleCoC(sampleCoord{X}); \ncomputedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;\n#endif\n";F.IncludesShadersStore.kernelBlurFragment2="#ifdef DOF\nfactor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;\n#else\ncomputedWeight=KERNEL_DEP_WEIGHT{X};\n#endif\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;\n#else\nblend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;\n#endif\n";F.ShadersStore.kernelBlurPixelShader="uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;\n#ifdef DOF\nuniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }\n#endif\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\n#ifdef PACKEDFLOAT\n#include<packingFunctions>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float computedWeight=0.0;\n#ifdef PACKEDFLOAT\nfloat blend=0.;\n#else\nvec4 blend=vec4(0.);\n#endif\n#ifdef DOF\nfloat sumOfWeights=CENTER_WEIGHT; \nfloat factor=0.0;\n#ifdef PACKEDFLOAT\nblend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;\n#else\nblend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;\n#endif\n#endif\n#include<kernelBlurFragment>[0..varyingCount]\n#include<kernelBlurFragment2>[0..depCount]\n#ifdef PACKEDFLOAT\ngl_FragColor=pack(blend);\n#else\ngl_FragColor=blend;\n#endif\n#ifdef DOF\ngl_FragColor/=sumOfWeights;\n#endif\n}";F.IncludesShadersStore.kernelBlurVertex="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";F.ShadersStore.kernelBlurVertexShader="attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;\n#include<kernelBlurVaryingDeclaration>[0..varyingCount]\nconst vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nsampleCenter=(position*madd+madd);\n#include<kernelBlurVertex>[0..varyingCount]\ngl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class ts extends es{set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,s,n,r=zi.BILINEAR_SAMPLINGMODE,o,a,l=0,h="",c=!1,d=5){super(e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],s,n,r,o,a,null,l,"kernelBlur",{varyingCount:0,depCount:0},!0,d),this._blockCompilation=c,this._packedFloat=!1,this._staticDefines="",this._staticDefines=h,this.direction=t,this.onApplyObservable.add((e=>{this._outputTexture?e.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):e.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)})),this.kernel=i}updateEffect(e=null,t=null,i=null,s,n,r){this._updateParameters(n,r)}_updateParameters(e,t){const i=this._kernel,s=(i-1)/2;let n=[],r=[],o=0;for(let e=0;e<i;e++){const t=e/(i-1),a=this._gaussianWeight(2*t-1);n[e]=e-s,r[e]=a,o+=a}for(let e=0;e<r.length;e++)r[e]/=o;const a=[],l=[],h=[];for(let e=0;e<=s;e+=2){const t=Math.min(e+1,Math.floor(s));if(e===t)h.push({o:n[e],w:r[e]});else{const i=t===s,o=r[e]+r[t]*(i?.5:1),a=n[e]+1/(1+r[e]/r[t]);0===a?(h.push({o:n[e],w:r[e]}),h.push({o:n[e+1],w:r[e+1]})):(h.push({o:a,w:o}),h.push({o:-a,w:o}))}}for(let e=0;e<h.length;e++)l[e]=h[e].o,a[e]=h[e].w;n=l,r=a;const c=this.getEngine().getCaps().maxVaryingVectors,d=Math.max(c,0)-1;let u=Math.min(n.length,d),_="";_+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(_+=`#define CENTER_WEIGHT ${this._glslFloat(r[u-1])}\n`,u--);for(let e=0;e<u;e++)_+=`#define KERNEL_OFFSET${e} ${this._glslFloat(n[e])}\n`,_+=`#define KERNEL_WEIGHT${e} ${this._glslFloat(r[e])}\n`;let f=0;for(let e=d;e<n.length;e++)_+=`#define KERNEL_DEP_OFFSET${f} ${this._glslFloat(n[e])}\n`,_+=`#define KERNEL_DEP_WEIGHT${f} ${this._glslFloat(r[e])}\n`,f++;this.packedFloat&&(_+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(_,null,null,{varyingCount:u,depCount:f},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const e of[t,t-1,t+1,t-2,t+2])if(e%2!=0&&Math.floor(e/2)%2==0&&e>0)return Math.max(e,3);return Math.max(t,3)}_gaussianWeight(e){const t=1/3,i=-e*e/(2*t*t);return 1/(Math.sqrt(2*Math.PI)*t)*Math.exp(i)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}static _Parse(e,t,i,s){return qe.Parse((()=>new ts(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1)),e,i,s)}}De([Ge("kernel")],ts.prototype,"_kernel",void 0),De([Ge("packedFloat")],ts.prototype,"_packedFloat",void 0),De([Xe()],ts.prototype,"direction",void 0),ue("BABYLON.BlurPostProcess",ts);class is{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let e=0;e<i.meshes.length;e++){const s=i.meshes[e];if(s.material){if(s.computeBonesUsingShaders&&0!==s.numBoneInfluencers)if(s.material.getEffect()===t)s.computeBonesUsingShaders=!1;else if(s.subMeshes)for(const e of s.subMeshes)if(e.effect===t){s.computeBonesUsingShaders=!1;break}}else!this._mesh.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=!1)}}else{const t=this._defines[this._currentRank];if(t)for(let i=0;i<t.length;i++)e=e.replace("#define "+t[i],"");this._currentRank++}return e}}F.IncludesShadersStore.bayerDitherFunctions="float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}\nfloat bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5*mod(_P,4.0)); \nreturn 4.0*bayerDither2(P1)+bayerDither2(P2);}\nfloat bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); \nvec2 P2=floor(0.5 *mod(_P,4.0)); \nvec2 P4=floor(0.25*mod(_P,8.0)); \nreturn 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}\n";F.IncludesShadersStore.shadowMapFragmentExtraDeclaration="#if SM_FLOAT==0\n#include<packingFunctions>\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#include<bayerDitherFunctions>\nuniform float softTransparentShadowSM;\n#endif\nvarying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nuniform vec3 lightDataSM;varying vec3 vPositionWSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";F.IncludesShadersStore.clipPlaneFragmentDeclaration="#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nvarying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nvarying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nvarying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nvarying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nvarying float fClipDistance6;\n#endif\n";F.IncludesShadersStore.clipPlaneFragment="#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)\nif (false) {}\n#endif\n#ifdef CLIPPLANE\nelse if (fClipDistance>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE2\nelse if (fClipDistance2>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE3\nelse if (fClipDistance3>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE4\nelse if (fClipDistance4>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE5\nelse if (fClipDistance5>0.0)\n{discard;}\n#endif\n#ifdef CLIPPLANE6\nelse if (fClipDistance6>0.0)\n{discard;}\n#endif\n";F.IncludesShadersStore.shadowMapFragment="float depthSM=vDepthMetricSM;\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\n#if SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\ndepthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\ndepthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_FragDepth=clamp(1.0-depthSM,0.0,1.0);\n#else\ngl_FragDepth=clamp(depthSM,0.0,1.0); \n#endif\n#elif SM_USEDISTANCE==1\ndepthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#if SM_ESM==1\ndepthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);\n#endif\n#if SM_FLOAT==1\ngl_FragColor=vec4(depthSM,1.0,1.0,1.0);\n#else\ngl_FragColor=pack(depthSM);\n#endif\nreturn;";F.ShadersStore.shadowMapPixelShader="#include<shadowMapFragmentExtraDeclaration>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEXTURE\nfloat alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;\n#ifdef ALPHATESTVALUE\nif (alphaFromAlphaTexture<ALPHATESTVALUE)\ndiscard;\n#endif\n#endif\n#if SM_SOFTTRANSPARENTSHADOW==1\n#ifdef ALPHATEXTURE\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;\n#else\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;\n#endif\n#endif\n#include<shadowMapFragment>\n}";F.IncludesShadersStore.bonesDeclaration="#if NUM_BONE_INFLUENCERS>0\nattribute vec4 matricesIndices;attribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;attribute vec4 matricesWeightsExtra;\n#endif\n#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#ifdef BONETEXTURE\nuniform highp sampler2D boneSampler;uniform float boneTextureWidth;\n#else\nuniform mat4 mBones[BonesPerMesh];\n#endif\n#ifdef BONES_VELOCITY_ENABLED\nuniform mat4 mPreviousBones[BonesPerMesh];\n#endif\n#ifdef BONETEXTURE\n#define inline\nmat4 readMatrixFromRawSampler(sampler2D smp,float index)\n{float offset=index *4.0;float dx=1.0/boneTextureWidth;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));return mat4(m0,m1,m2,m3);}\n#endif\n#endif\n#endif\n";F.IncludesShadersStore.bakedVertexAnimationDeclaration="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\nuniform float bakedVertexAnimationTime;uniform vec2 bakedVertexAnimationTextureSizeInverted;uniform vec4 bakedVertexAnimationSettings;uniform sampler2D bakedVertexAnimationTexture;\n#ifdef INSTANCES\nattribute vec4 bakedVertexAnimationSettingsInstanced;\n#endif\n#define inline\nmat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)\n{float offset=index*4.0;float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;float dx=bakedVertexAnimationTextureSizeInverted.x;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));return mat4(m0,m1,m2,m3);}\n#endif\n";F.IncludesShadersStore.morphTargetsVertexGlobalDeclaration="#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#ifdef MORPHTARGETS_TEXTURE \nuniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];uniform vec3 morphTargetTextureInfo;uniform highp sampler2DArray morphTargets;vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)\n{ \nfloat y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV).xyz;}\n#endif\n#endif\n";F.IncludesShadersStore.morphTargetsVertexDeclaration="#ifdef MORPHTARGETS\n#ifndef MORPHTARGETS_TEXTURE\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#ifdef MORPHTARGETS_UV\nattribute vec2 uv_{X};\n#endif\n#endif\n#endif\n";F.IncludesShadersStore.helperFunctions="const float PI=3.1415926535897932384626433832795;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float HALF_MIN=5.96046448e-08; \nconst float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;\n#define saturate(x) clamp(x,0.0,1.0)\n#define absEps(x) abs(x)+Epsilon\n#define maxEps(x) max(x,Epsilon)\n#define saturateEps(x) clamp(x,Epsilon,1.0)\nmat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);return outMatrix;}\nmat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}\n#if USE_EXACT_SRGB_CONVERSIONS\nvec3 toLinearSpaceExact(vec3 color)\n{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));\n#else\nreturn\nvec3(\ncolor.r<=0.04045 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.04045 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.04045 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\nvec3 toGammaSpaceExact(vec3 color)\n{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nreturn mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));\n#else\nreturn\nvec3(\ncolor.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,\ncolor.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,\ncolor.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);\n#endif\n}\n#endif\nfloat toLinearSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,LinearEncodePowerApprox);\n#endif\n}\nvec3 toLinearSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toLinearSpaceExact(color);\n#else\nreturn pow(color,vec3(LinearEncodePowerApprox));\n#endif\n}\nvec4 toLinearSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toLinearSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);\n#endif\n}\nfloat toGammaSpace(float color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nfloat nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;\n#else\nreturn pow(color,GammaEncodePowerApprox);\n#endif\n}\nvec3 toGammaSpace(vec3 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn toGammaSpaceExact(color);\n#else\nreturn pow(color,vec3(GammaEncodePowerApprox));\n#endif\n}\nvec4 toGammaSpace(vec4 color)\n{\n#if USE_EXACT_SRGB_CONVERSIONS\nreturn vec4(toGammaSpaceExact(color.rgb),color.a);\n#else\nreturn vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);\n#endif\n}\nfloat square(float value)\n{return value*value;}\nvec3 square(vec3 value)\n{return value*value;}\nfloat pow5(float value) {float sq=value*value;return sq*sq*value;}\nfloat getLuminance(vec3 color)\n{return clamp(dot(color,LuminanceEncodeApprox),0.,1.);}\nfloat getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}\nfloat dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}\nconst float rgbdMaxRange=255.0;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(clamp(rgb,0.,1.),D); }\nvec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}\n";F.IncludesShadersStore.sceneVertexDeclaration="uniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;\n";F.IncludesShadersStore.meshVertexDeclaration="uniform mat4 world;uniform float visibility;\n";F.IncludesShadersStore.shadowMapVertexDeclaration="#include<sceneVertexDeclaration>\n#include<meshVertexDeclaration>\n";F.IncludesShadersStore.sceneUboDeclaration="layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif \nmat4 view;mat4 projection;vec4 vEyePosition;};\n";F.IncludesShadersStore.meshUboDeclaration="#ifdef WEBGL2\nuniform mat4 world;uniform float visibility;\n#else\nlayout(std140,column_major) uniform;uniform Mesh\n{mat4 world;float visibility;};\n#endif\n#define WORLD_UBO\n";F.IncludesShadersStore.shadowMapUboDeclaration="layout(std140,column_major) uniform;\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";F.IncludesShadersStore.shadowMapVertexExtraDeclaration="#if SM_NORMALBIAS==1\nuniform vec3 lightDataSM;\n#endif\nuniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;\n#if SM_USEDISTANCE==1\nvarying vec3 vPositionWSM;\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nvarying float zSM;\n#endif\n";F.IncludesShadersStore.clipPlaneVertexDeclaration="#ifdef CLIPPLANE\nuniform vec4 vClipPlane;varying float fClipDistance;\n#endif\n#ifdef CLIPPLANE2\nuniform vec4 vClipPlane2;varying float fClipDistance2;\n#endif\n#ifdef CLIPPLANE3\nuniform vec4 vClipPlane3;varying float fClipDistance3;\n#endif\n#ifdef CLIPPLANE4\nuniform vec4 vClipPlane4;varying float fClipDistance4;\n#endif\n#ifdef CLIPPLANE5\nuniform vec4 vClipPlane5;varying float fClipDistance5;\n#endif\n#ifdef CLIPPLANE6\nuniform vec4 vClipPlane6;varying float fClipDistance6;\n#endif\n";F.IncludesShadersStore.morphTargetsVertexGlobal="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE\nfloat vertexID;\n#endif\n#endif\n";F.IncludesShadersStore.morphTargetsVertex="#ifdef MORPHTARGETS\n#ifdef MORPHTARGETS_TEXTURE \nvertexID=float(gl_VertexID)*morphTargetTextureInfo.x;positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];vertexID+=1.0;\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];vertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];vertexID+=1.0;\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#else\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_UV\nuvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];\n#endif\n#endif\n#endif\n";F.IncludesShadersStore.instancesVertex="#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);\n#endif\n#ifdef THIN_INSTANCES\nfinalWorld=world*finalWorld;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nfinalPreviousWorld=previousWorld*finalPreviousWorld;\n#endif\n#endif\n#else\nmat4 finalWorld=world;\n#if defined(PREPASS_VELOCITY) || defined(VELOCITY)\nmat4 finalPreviousWorld=previousWorld;\n#endif\n#endif\n";F.IncludesShadersStore.bonesVertex="#ifndef BAKED_VERTEX_ANIMATION_TEXTURE\n#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\n#ifdef BONETEXTURE\ninfluence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];\n#endif\n#else\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\n#endif\nfinalWorld=finalWorld*influence;\n#endif\n#endif\n";F.IncludesShadersStore.bakedVertexAnimation="#ifdef BAKED_VERTEX_ANIMATION_TEXTURE\n{\n#ifdef INSTANCES\n#define BVASNAME bakedVertexAnimationSettingsInstanced\n#else\n#define BVASNAME bakedVertexAnimationSettings\n#endif\nfloat VATStartFrame=BVASNAME.x;float VATEndFrame=BVASNAME.y;float VATOffsetFrame=BVASNAME.z;float VATSpeed=BVASNAME.w;float totalFrames=VATEndFrame-VATStartFrame+1.0;float time=bakedVertexAnimationTime*VATSpeed/totalFrames;float frameCorrection=time<1.0 ? 0.0 : 1.0;float numOfFrames=totalFrames-frameCorrection;float VATFrameNum=fract(time)*numOfFrames;VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);VATFrameNum=floor(VATFrameNum);VATFrameNum+=VATStartFrame+frameCorrection;mat4 VATInfluence;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\nVATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];\n#endif\nfinalWorld=finalWorld*VATInfluence;}\n#endif\n";F.IncludesShadersStore.shadowMapVertexNormalBias="#if SM_NORMALBIAS==1\n#if SM_DIRECTIONINLIGHTDATA==1\nvec3 worldLightDirSM=normalize(-lightDataSM.xyz);\n#else\nvec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);\n#endif\nfloat ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;\n#endif\n";F.IncludesShadersStore.shadowMapVertexMetric="#if SM_USEDISTANCE==1\nvPositionWSM=worldPos.xyz;\n#endif\n#if SM_DEPTHTEXTURE==1\n#ifdef IS_NDC_HALF_ZRANGE\n#define BIASFACTOR 0.5\n#else\n#define BIASFACTOR 1.0\n#endif\n#ifdef USE_REVERSE_DEPTHBUFFER\ngl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#else\ngl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;\n#endif\n#endif\n#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1\nzSM=gl_Position.z;gl_Position.z=0.0;\n#elif SM_USEDISTANCE==0\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#else\nvDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;\n#endif\n#endif\n";F.IncludesShadersStore.clipPlaneVertex="#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n#ifdef CLIPPLANE2\nfClipDistance2=dot(worldPos,vClipPlane2);\n#endif\n#ifdef CLIPPLANE3\nfClipDistance3=dot(worldPos,vClipPlane3);\n#endif\n#ifdef CLIPPLANE4\nfClipDistance4=dot(worldPos,vClipPlane4);\n#endif\n#ifdef CLIPPLANE5\nfClipDistance5=dot(worldPos,vClipPlane5);\n#endif\n#ifdef CLIPPLANE6\nfClipDistance6=dot(worldPos,vClipPlane6);\n#endif\n";F.ShadersStore.shadowMapVertexShader="attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#endif\n#include<helperFunctions>\n#include<__decl__shadowMapVertex>\n#ifdef ALPHATEXTURE\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<shadowMapVertexExtraDeclaration>\n#include<clipPlaneVertexDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normWorldSM=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormWorldSM=transposeMat3(inverseMat3(normWorldSM));\n#endif\nvec3 vNormalW=normalize(normWorldSM*normalUpdated);\n#endif\n#endif\n#include<shadowMapVertexNormalBias>\ngl_Position=viewProjection*worldPos;\n#include<shadowMapVertexMetric>\n#ifdef ALPHATEXTURE\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n}";F.ShadersStore.depthBoxBlurPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}";F.IncludesShadersStore.shadowMapFragmentSoftTransparentShadow="#if SM_SOFTTRANSPARENTSHADOW==1\nif ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;\n#endif\n";class ss{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===ss.FILTER_BLUREXPONENTIALSHADOWMAP)return void(this.useExponentialShadowMap=!0);if(e===ss.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)return void(this.useCloseExponentialShadowMap=!0);if(e===ss.FILTER_PCF||e===ss.FILTER_PCSS)return void(this.usePoissonSampling=!0)}e!==ss.FILTER_PCF&&e!==ss.FILTER_PCSS||this._scene.getEngine()._features.supportShadowSamplers?this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty()):this.usePoissonSampling=!0}get usePoissonSampling(){return this.filter===ss.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(ss.FILTER_POISSONSAMPLING);(e||this.filter===ss.FILTER_POISSONSAMPLING)&&(this.filter=e?t:ss.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===ss.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(ss.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===ss.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:ss.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===ss.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(ss.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===ss.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:ss.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===ss.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(ss.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===ss.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:ss.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===ss.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(ss.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===ss.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:ss.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===ss.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(ss.FILTER_PCF);(e||this.filter===ss.FILTER_PCF)&&(this.filter=e?t:ss.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===ss.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(ss.FILTER_PCSS);(e||this.filter===ss.FILTER_PCSS)&&(this.filter=e?t:ss.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return this._darkness=e>=1?1:e<=0?0:e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return ss.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(const t of e.getChildMeshes())-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(-1!==i&&this._shadowMap.renderList.splice(i,1),t)for(const t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}_getCamera(){var e;return null!==(e=this._camera)&&void 0!==e?e:this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,n,r){this.onBeforeShadowMapRenderObservable=new s,this.onAfterShadowMapRenderObservable=new s,this.onBeforeShadowMapRenderMeshObservable=new s,this.onAfterShadowMapRenderMeshObservable=new s,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=ss.FILTER_NONE,this._filteringQuality=ss.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=me.Zero(),this._viewMatrix=Te.Zero(),this._projectionMatrix=Te.Zero(),this._transformMatrix=Te.Zero(),this._cachedPosition=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=Te.Identity(),this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=null!=n?n:null,this._useRedTextureType=!!r;let o=t._shadowGenerators;o||(o=t._shadowGenerators=new Map),o.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),ss._SceneComponentInitialization(this._scene);const a=this._scene.getEngine().getCaps();i?a.textureFloatRender&&a.textureFloatLinearFiltering?this._textureType=1:a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering?this._textureType=2:a.textureFloatRender&&a.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new Ji(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new Ji(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=zi.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=zi.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(zi.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,i,s)=>this._renderForShadowMap(e,t,i,s),this._shadowMap.customIsReadyFunction=()=>!0;const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add((()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),null===(t=e._debugPushGroup)||void 0===t||t.call(e,`shadow map generation for pass id ${e.currentRenderPassId}`,1)})),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===ss.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onAfterUnbindObservable.add((()=>{var t,i;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===ss.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void(null===(t=e._debugPopGroup)||void 0===t||t.call(e,1));const s=this.getShadowMapForRendering();s&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,s.renderTarget,!0),e.unBindFramebuffer(s.renderTarget,!0),null===(i=e._debugPopGroup)||void 0===i||i.call(e,1))}));const t=new Ie(0,0,0,0),i=new Ie(1,1,1,1);this._shadowMap.onClearObservable.add((e=>{this._filter===ss.FILTER_PCF?e.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(t,!0,!0,!1):e.clear(i,!0,!0,!1)})),this._shadowMap.onResizeObservable.add((e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}));for(let e=ai.MIN_RENDERINGGROUPS;e<ai.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,!1)}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new Ji(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=zi.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=zi.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(zi.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new ts(this._light.name+"KernelBlurX",new pe(1,0),this.blurKernel,1,null,zi.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._shadowMap)})),this._kernelBlurYPostprocess=new ts(this._light.name+"KernelBlurY",new pe(0,1),this.blurKernel,1,null,zi.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new es(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,zi.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add((e=>{e.setFloat2("screenSize",t,t),e.setTexture("textureSampler",this._shadowMap)})),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,s){let n;if(s.length)for(n=0;n<s.length;n++)this._renderSubMeshForShadowMap(s.data[n]);for(n=0;n<e.length;n++)this._renderSubMeshForShadowMap(e.data[n]);for(n=0;n<t.length;n++)this._renderSubMeshForShadowMap(t.data[n]);if(this._transparencyShadow)for(n=0;n<i.length;n++)this._renderSubMeshForShadowMap(i.data[n],!0);else for(n=0;n<i.length;n++)i.data[n].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){var i,s;const n=e.getRenderingMesh(),r=e.getEffectiveMesh(),o=this._scene,a=o.getEngine(),l=e.getMaterial();if(r._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!l||0===e.verticesCount||e._renderId===o.getRenderId())return;const h=r._getWorldMatrixDeterminant()<0;let c=null!==(i=n.overrideMaterialSideOrientation)&&void 0!==i?i:l.sideOrientation;h&&(c=0===c?1:0);const d=0===c;a.setState(l.backFaceCulling,void 0,void 0,d,l.cullBackFaces);const u=n._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(u.mustReturn)return;const _=a.getCaps().instancedArrays&&(null!==u.visibleInstances[e._id]&&void 0!==u.visibleInstances[e._id]||n.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,_,t)){e._renderId=o.getRenderId();const i=l.shadowDepthWrapper,h=null!==(s=null==i?void 0:i.getEffect(e,this,a.currentRenderPassId))&&void 0!==s?s:e._getDrawWrapper(),c=Y.GetEffect(h);a.enableEffect(h),_||n._bind(e,c,l.fillMode),this.getTransformMatrix(),c.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===Lt.LIGHTTYPEID_DIRECTIONALLIGHT?c.setVector3("lightDataSM",this._cachedDirection):c.setVector3("lightDataSM",this._cachedPosition);const d=this._getCamera();if(d&&c.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(d),this.getLight().getDepthMinZ(d)+this.getLight().getDepthMaxZ(d)),t&&this.enableSoftTransparentShadow&&c.setFloat("softTransparentShadowSM",r.visibility*l.alpha),i)e._setMainDrawWrapperOverride(h),i.standalone?i.baseMaterial.bindForSubMesh(r.getWorldMatrix(),n,e):l.bindForSubMesh(r.getWorldMatrix(),n,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(c.setTexture("diffuseSampler",this._opacityTexture),c.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),n.useBones&&n.computeBonesUsingShaders&&n.skeleton){const e=n.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(n);if(!t)return;c.setTexture("boneSampler",t),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",e.getTransformMatrices(n))}wi.BindMorphTargetParameters(n,c),n.morphTargetManager&&n.morphTargetManager.isUsingTextureForTargets&&n.morphTargetManager._bind(c),Fi(c,l,o)}this._useUBO||i||this._bindCustomEffectForRenderSubMeshForShadowMap(e,c,r),wi.BindSceneUniformBuffer(c,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const f=r.getWorldMatrix();_&&(r.getMeshUniformBuffer().bindToEffect(c,"Mesh"),r.transferToEffect(f)),this.forceBackFacesOnly&&a.setState(!0,0,!1,!0,l.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(n),this.onBeforeShadowMapRenderObservable.notifyObservers(c),n._processRendering(r,e,c,l.fillMode,u,_,((e,t)=>{r===n||e?(r.getMeshUniformBuffer().bindToEffect(c,"Mesh"),r.transferToEffect(e?t:f)):(n.getMeshUniformBuffer().bindToEffect(c,"Mesh"),n.transferToEffect(t))})),this.forceBackFacesOnly&&a.setState(!0,0,!1,!1,l.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(c),this.onAfterShadowMapRenderMeshObservable.notifyObservers(n)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===ss.FILTER_NONE||this.filter===ss.FILTER_PCSS?this._shadowMap.updateSamplingMode(zi.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(zi.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const i=Object.assign({useInstances:!1},t),s=this.getShadowMap();if(!s)return void(e&&e(this));const n=s.renderList;if(!n)return void(e&&e(this));const r=[];for(const e of n)r.push(...e.subMeshes);if(0===r.length)return void(e&&e(this));let o=0;const a=()=>{var t,s;if(this._scene&&this._scene.getEngine()){for(;this.isReady(r[o],i.useInstances,null!==(s=null===(t=r[o].getMaterial())||void 0===t?void 0:t.needAlphaBlendingForMesh(r[o].getMesh()))&&void 0!==s&&s);)if(o++,o>=r.length)return void(e&&e(this));setTimeout(a,16)}};a()}forceCompilationAsync(e){return new Promise((t=>{this.forceCompilation((()=>{t()}),e)}))}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,s){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const n=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&n.isVerticesDataPresent(Oe.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===Lt.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){var s;const n=e.getMaterial(),r=null==n?void 0:n.shadowDepthWrapper;if(this._opacityTexture=null,!n)return!1;const o=[];if(this._prepareShadowDefines(e,t,o,i),r){if(!r.isReadyForSubMesh(e,o,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const i=e._getDrawWrapper(void 0,!0);let r=i.effect,a=i.defines;const l=[Oe.PositionKind],h=e.getMesh();this.normalBias&&h.isVerticesDataPresent(Oe.NormalKind)&&(l.push(Oe.NormalKind),o.push("#define NORMAL"),h.nonUniformScaling&&o.push("#define NONUNIFORMSCALING"));const c=n.needAlphaTesting();if((c||n.needAlphaBlending())&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=n.opacityTexture:this._opacityTexture=n.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const e=null!==(s=n.alphaCutOff)&&void 0!==s?s:ss.DEFAULT_ALPHA_CUTOFF;o.push("#define ALPHATEXTURE"),c&&o.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),h.isVerticesDataPresent(Oe.UVKind)&&(l.push(Oe.UVKind),o.push("#define UV1")),h.isVerticesDataPresent(Oe.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(l.push(Oe.UV2Kind),o.push("#define UV2"))}const d=new is;if(h.useBones&&h.computeBonesUsingShaders&&h.skeleton){l.push(Oe.MatricesIndicesKind),l.push(Oe.MatricesWeightsKind),h.numBoneInfluencers>4&&(l.push(Oe.MatricesIndicesExtraKind),l.push(Oe.MatricesWeightsExtraKind));const e=h.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+h.numBoneInfluencers),h.numBoneInfluencers>0&&d.addCPUSkinningFallback(0,h),e.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(e.bones.length+1))}else o.push("#define NUM_BONE_INFLUENCERS 0");const u=h.morphTargetManager;let _=0;if(u&&u.numInfluencers>0&&(o.push("#define MORPHTARGETS"),_=u.numInfluencers,o.push("#define NUM_MORPH_INFLUENCERS "+_),u.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),wi.PrepareAttributesForMorphTargetsInfluencers(l,h,_)),Ni(n,this._scene,o),t&&(o.push("#define INSTANCES"),wi.PushAttributesForInstances(l),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const e of this.customShaderOptions.defines)-1===o.indexOf(e)&&o.push(e);const f=o.join("\n");if(a!==f){a=f;let e="shadowMap";const t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],s=["diffuseSampler","boneSampler","morphTargets"],n=["Scene","Mesh"];if(Di(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const e of this.customShaderOptions.attributes)-1===l.indexOf(e)&&l.push(e);if(this.customShaderOptions.uniforms)for(const e of this.customShaderOptions.uniforms)-1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(const e of this.customShaderOptions.samplers)-1===s.indexOf(e)&&s.push(e)}const o=this._scene.getEngine();r=o.createEffect(e,{attributes:l,uniformsNames:t,uniformBuffersNames:n,samplers:s,defines:f,fallbacks:d,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:_}},o),i.setEffect(r,a)}if(!r.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(this._blurPostProcesses&&this._blurPostProcesses.length||this._initializeBlurRTTAndPostProcesses()),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const i=this._scene,s=this._light;i.shadowsEnabled&&s.shadowEnabled&&(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===ss.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===ss.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===ss.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===ss.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),s.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const n=this.getShadowMap();n&&(i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix()),this._filter===ss.FILTER_PCF?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n.getSize().width,1/n.getSize().width,this.frustumEdgeFalloff,e)):this._filter===ss.FILTER_PCSS?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),t.setTexture("depthSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n.getSize().width,this._contactHardeningLightSizeUVRatio*n.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/n.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e))}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),me.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(me.Dot(this._lightDirection,me.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),Te.LookAtLHToRef(t,t.add(this._lightDirection),me.Up(),this._viewMatrix);const e=this.getShadowMap();if(e){const t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const e of t)this._shadowMap.renderList.push(e)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();!0!==t.done;t=e.next()){const[e,i]=t.value;i===this&&this._light._shadowGenerators.delete(e)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var e;const t={},i=this.getShadowMap();if(!i)return t;if(t.className=this.getClassName(),t.lightId=this._light.id,t.cameraId=null===(e=this._camera)||void 0===e?void 0:e.id,t.id=this.id,t.mapSize=i.getRenderSize(),t.forceBackFacesOnly=this.forceBackFacesOnly,t.darkness=this.getDarkness(),t.transparencyShadow=this._transparencyShadow,t.frustumEdgeFalloff=this.frustumEdgeFalloff,t.bias=this.bias,t.normalBias=this.normalBias,t.usePercentageCloserFiltering=this.usePercentageCloserFiltering,t.useContactHardeningShadow=this.useContactHardeningShadow,t.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,t.filteringQuality=this.filteringQuality,t.useExponentialShadowMap=this.useExponentialShadowMap,t.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,t.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.usePoissonSampling=this.usePoissonSampling,t.depthScale=this.depthScale,t.blurBoxOffset=this.blurBoxOffset,t.blurKernel=this.blurKernel,t.blurScale=this.blurScale,t.useKernelBlur=this.useKernelBlur,t.renderList=[],i.renderList)for(let e=0;e<i.renderList.length;e++){const s=i.renderList[e];t.renderList.push(s.id)}return t}static Parse(e,t,i){const s=t.getLightById(e.lightId),n=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,r=i?i(e.mapSize,s,n):new ss(e.mapSize,s,void 0,n),o=r.getShadowMap();for(let i=0;i<e.renderList.length;i++)t.getMeshesById(e.renderList[i]).forEach((function(e){o&&(o.renderList||(o.renderList=[]),o.renderList.push(e))}));return void 0!==e.id&&(r.id=e.id),r.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&r.setDarkness(e.darkness),e.transparencyShadow&&r.setTransparencyShadow(!0),void 0!==e.frustumEdgeFalloff&&(r.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(r.bias=e.bias),void 0!==e.normalBias&&(r.normalBias=e.normalBias),e.usePercentageCloserFiltering?r.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?r.useContactHardeningShadow=!0:e.usePoissonSampling?r.usePoissonSampling=!0:e.useExponentialShadowMap?r.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?r.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?r.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?r.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?r.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(r.useBlurExponentialShadowMap=!0),void 0!==e.contactHardeningLightSizeUVRatio&&(r.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(r.filteringQuality=e.filteringQuality),e.depthScale&&(r.depthScale=e.depthScale),e.blurScale&&(r.blurScale=e.blurScale),e.blurBoxOffset&&(r.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(r.useKernelBlur=e.useKernelBlur),e.blurKernel&&(r.blurKernel=e.blurKernel),r}}ss.CLASSNAME="ShadowGenerator",ss.FILTER_NONE=0,ss.FILTER_EXPONENTIALSHADOWMAP=1,ss.FILTER_POISSONSAMPLING=2,ss.FILTER_BLUREXPONENTIALSHADOWMAP=3,ss.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,ss.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,ss.FILTER_PCF=6,ss.FILTER_PCSS=7,ss.QUALITY_HIGH=0,ss.QUALITY_MEDIUM=1,ss.QUALITY_LOW=2,ss.DEFAULT_ALPHA_CUTOFF=.5,ss._SceneComponentInitialization=e=>{throw f("ShadowGeneratorSceneComponent")};class ns{constructor(e,t,i){this.vectors=le.BuildArray(8,me.Zero),this.center=me.Zero(),this.centerWorld=me.Zero(),this.extendSize=me.Zero(),this.extendSizeWorld=me.Zero(),this.directions=le.BuildArray(3,me.Zero),this.vectorsWorld=le.BuildArray(8,me.Zero),this.minimumWorld=me.Zero(),this.maximumWorld=me.Zero(),this.minimum=me.Zero(),this.maximum=me.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const s=e.x,n=e.y,r=e.z,o=t.x,a=t.y,l=t.z,h=this.vectors;this.minimum.copyFromFloats(s,n,r),this.maximum.copyFromFloats(o,a,l),h[0].copyFromFloats(s,n,r),h[1].copyFromFloats(o,a,l),h[2].copyFromFloats(o,n,r),h[3].copyFromFloats(s,a,r),h[4].copyFromFloats(s,n,l),h[5].copyFromFloats(o,a,r),h[6].copyFromFloats(s,a,l),h[7].copyFromFloats(o,n,l),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||Te.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=ns._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),s=i.length();i.normalizeFromLength(s);const n=s*e,r=i.scaleInPlace(.5*n),o=this.center.subtractToRef(r,t[1]),a=this.center.addToRef(r,t[2]);return this.reConstruct(o,a,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,s=this.directions,n=this.vectorsWorld,r=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let e=0;e<8;++e)n[e].copyFrom(r[e]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let s=0;s<8;++s){const o=n[s];me.TransformCoordinatesToRef(r[s],e,o),t.minimizeInPlace(o),i.maximizeInPlace(o)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}me.FromArrayToRef(e.m,0,s[0]),me.FromArrayToRef(e.m,4,s[1]),me.FromArrayToRef(e.m,8,s[2]),this._worldMatrix=e}isInFrustum(e){return ns.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return ns.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,s=t.x,n=t.y,r=t.z,o=i.x,a=i.y,l=i.z,h=e.x,c=e.y,d=e.z,u=-ae;return!(o-h<u||u>h-s||a-c<u||u>c-n||l-d<u||u>d-r)}intersectsSphere(e){return ns.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,s=this.maximumWorld,n=i.x,r=i.y,o=i.z,a=s.x,l=s.y,h=s.z,c=e.x,d=e.y,u=e.z,_=t.x,f=t.y,p=t.z;return!(a<c||n>_||l<d||r>f||h<u||o>p)}dispose(){var e,t;null===(e=this._drawWrapperFront)||void 0===e||e.dispose(),null===(t=this._drawWrapperBack)||void 0===t||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,s){const n=ns._TmpVector3[0];return me.ClampToRef(i,e,t,n),me.DistanceSquared(i,n)<=s*s}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const s=t[i];for(let t=0;t<8;++t)if(s.dotCoordinate(e[t])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let s=!0;const n=t[i];for(let t=0;t<8;++t)if(n.dotCoordinate(e[t])>=0){s=!1;break}if(s)return!1}return!0}}ns._TmpVector3=le.BuildArray(3,me.Zero);class rs{constructor(e,t,i){this.center=me.Zero(),this.centerWorld=me.Zero(),this.minimum=me.Zero(),this.maximum=me.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const s=me.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=.5*s,this._update(i||Te.IdentityReadOnly)}scale(e){const t=this.radius*e,i=rs._TmpVector3,s=i[0].setAll(t),n=this.center.subtractToRef(s,i[1]),r=this.center.addToRef(s,i[2]);return this.reConstruct(n,r,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{me.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=rs._TmpVector3[0];me.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let s=0;s<6;s++)if(e[s].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=me.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=me.DistanceSquared(e.centerWorld,t.centerWorld),s=e.radiusWorld+t.radiusWorld;return!(s*s<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const s=new rs(this._TmpVector3[0],this._TmpVector3[2]);return s._worldMatrix=i||Te.Identity(),s}}rs._TmpVector3=le.BuildArray(3,me.Zero);const os={min:0,max:0},as={min:0,max:0},ls=(e,t,i)=>{const s=me.Dot(t.centerWorld,e),n=Math.abs(me.Dot(t.directions[0],e))*t.extendSize.x+Math.abs(me.Dot(t.directions[1],e))*t.extendSize.y+Math.abs(me.Dot(t.directions[2],e))*t.extendSize.z;i.min=s-n,i.max=s+n},hs=(e,t,i)=>(ls(e,t,os),ls(e,i,as),!(os.min>as.max||as.min>os.max));class cs{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new ns(e,t,i),this.boundingSphere=new rs(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=cs._TmpVector3[0].copyFrom(e).subtractInPlace(t),s=cs._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=me.Minimize(this.minimum,e),i=me.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=Ee.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const i=Ee.Vector3[0];return me.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),me.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return!(2!==t&&3!==t||!this.boundingSphere.isCenterInFrustum(e))||!!this.boundingSphere.isInFrustum(e)&&(!(1!==t&&3!==t)||this.boundingBox.isInFrustum(e))}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,cs._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!!this.boundingSphere.centerWorld&&!!this.boundingSphere.intersectsPoint(e)&&!!this.boundingBox.intersectsPoint(e)}intersects(e,t){if(!rs.Intersects(this.boundingSphere,e.boundingSphere))return!1;if(!ns.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,s=e.boundingBox;return!!(hs(i.directions[0],i,s)&&hs(i.directions[1],i,s)&&hs(i.directions[2],i,s)&&hs(s.directions[0],i,s)&&hs(s.directions[1],i,s)&&hs(s.directions[2],i,s)&&hs(me.Cross(i.directions[0],s.directions[0]),i,s)&&hs(me.Cross(i.directions[0],s.directions[1]),i,s)&&hs(me.Cross(i.directions[0],s.directions[2]),i,s)&&hs(me.Cross(i.directions[1],s.directions[0]),i,s)&&hs(me.Cross(i.directions[1],s.directions[1]),i,s)&&hs(me.Cross(i.directions[1],s.directions[2]),i,s)&&hs(me.Cross(i.directions[2],s.directions[0]),i,s)&&hs(me.Cross(i.directions[2],s.directions[1]),i,s)&&hs(me.Cross(i.directions[2],s.directions[2]),i,s))}}cs._TmpVector3=le.BuildArray(2,me.Zero);F.ShadersStore.depthPixelShader="#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\nvarying float vDepthMetric;\n#ifdef PACKED\n#include<packingFunctions>\n#endif\n#ifdef STORE_CAMERASPACE_Z\nvarying vec4 vViewPos;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef STORE_CAMERASPACE_Z\n#ifdef PACKED\ngl_FragColor=pack(vViewPos.z);\n#else\ngl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);\n#endif\n#else\n#ifdef NONLINEARDEPTH\n#ifdef PACKED\ngl_FragColor=pack(gl_FragCoord.z);\n#else\ngl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);\n#endif\n#else\n#ifdef PACKED\ngl_FragColor=pack(vDepthMetric);\n#else\ngl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n}";F.IncludesShadersStore.instancesDeclaration="#ifdef INSTANCES\nattribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;\n#ifdef INSTANCESCOLOR\nattribute vec4 instanceColor;\n#endif\n#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nattribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;\n#ifdef THIN_INSTANCES\nuniform mat4 previousWorld;\n#endif\n#endif\n#else\n#if !defined(WORLD_UBO)\nuniform mat4 world;\n#endif\n#if defined(VELOCITY) || defined(PREPASS_VELOCITY)\nuniform mat4 previousWorld;\n#endif\n#endif\n";F.IncludesShadersStore.pointCloudVertexDeclaration="#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n";F.IncludesShadersStore.pointCloudVertex="#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n";F.ShadersStore.depthVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef STORE_CAMERASPACE_Z\nuniform mat4 view;varying vec4 vViewPos;\n#endif\n#include<pointCloudVertexDeclaration>\nvarying float vDepthMetric;\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\ngl_Position=viewProjection*worldPos;\n#ifdef STORE_CAMERASPACE_Z\nvViewPos=view*worldPos;\n#else\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));\n#else\nvDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));\n#endif\n#endif\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#include<pointCloudVertex>\n}\n";class ds{setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,s=!1,n=zi.TRILINEAR_SAMPLINGMODE,r=!1,o){this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._scene=e,this._storeNonLinearDepth=s,this._storeCameraSpaceZ=r,this.isPacked=0===t,this.isPacked?this.clearColor=new Ie(1,1,1,1):this.clearColor=new Ie(r?1e8:1,0,0,1),ds._SceneComponentInitialization(this._scene);const a=e.getEngine();this._camera=i,n!==zi.NEAREST_SAMPLINGMODE&&(1!==t||a._caps.textureFloatLinearFiltering||(n=zi.NEAREST_SAMPLINGMODE),2!==t||a._caps.textureHalfFloatLinearFiltering||(n=zi.NEAREST_SAMPLINGMODE));const l=this.isPacked||!a._features.supportExtendedTextureFormats?5:6;this._depthMap=new Ji(null!=o?o:"DepthRenderer",{width:a.getRenderWidth(),height:a.getRenderHeight()},this._scene,!1,!0,t,!1,n,void 0,void 0,void 0,l),this._depthMap.wrapU=zi.CLAMP_ADDRESSMODE,this._depthMap.wrapV=zi.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add((e=>{e.clear(this.clearColor,!0,!0,!0)})),this._depthMap.onBeforeBindObservable.add((()=>{var e;null===(e=a._debugPushGroup)||void 0===e||e.call(a,"depth renderer",1)})),this._depthMap.onAfterUnbindObservable.add((()=>{var e;null===(e=a._debugPopGroup)||void 0===e||e.call(a,1)})),this._depthMap.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],s=i.getRenderingMesh(),n=s._getInstancesRenderList(i._id,!!i.getReplacementMesh()),r=a.getCaps().instancedArrays&&(null!==n.visibleInstances[i._id]&&void 0!==n.visibleInstances[i._id]||s.hasThinInstances);if(!this.isReady(i,r))return!1}return!0};const h=e=>{var t,i;const s=e.getRenderingMesh(),n=e.getEffectiveMesh(),r=this._scene,o=r.getEngine(),a=e.getMaterial();if(n._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!a||n.infiniteDistance||a.disableDepthWrite||0===e.verticesCount||e._renderId===r.getRenderId())return;const l=n._getWorldMatrixDeterminant()<0;let h=null!==(t=s.overrideMaterialSideOrientation)&&void 0!==t?t:a.sideOrientation;l&&(h=0===h?1:0);const c=0===h;o.setState(a.backFaceCulling,0,!1,c,this.reverseCulling?!a.cullBackFaces:a.cullBackFaces);const d=s._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(d.mustReturn)return;const u=o.getCaps().instancedArrays&&(null!==d.visibleInstances[e._id]&&void 0!==d.visibleInstances[e._id]||s.hasThinInstances),_=this._camera||r.activeCamera;if(this.isReady(e,u)&&_){e._renderId=r.getRenderId();const t=null===(i=n._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[o.currentRenderPassId];let l=e._getDrawWrapper();!l&&t&&(l=t._getDrawWrapper());const h=_.mode===Gt.ORTHOGRAPHIC_CAMERA;if(!l)return;const c=l.effect;let f,p;if(o.enableEffect(l),u||s._bind(e,c,a.fillMode),t?t.bindForSubMesh(n.getWorldMatrix(),n,e):(c.setMatrix("viewProjection",r.getTransformMatrix()),c.setMatrix("world",n.getWorldMatrix()),this._storeCameraSpaceZ&&c.setMatrix("view",r.getViewMatrix())),h?(f=!o.useReverseDepthBuffer&&o.isNDCHalfZRange?0:1,p=o.useReverseDepthBuffer&&o.isNDCHalfZRange?0:1):(f=o.useReverseDepthBuffer&&o.isNDCHalfZRange?_.minZ:o.isNDCHalfZRange?0:_.minZ,p=o.useReverseDepthBuffer&&o.isNDCHalfZRange?0:_.maxZ),c.setFloat2("depthValues",f,f+p),!t){if(a.needAlphaTesting()){const e=a.getAlphaTestTexture();e&&(c.setTexture("diffuseSampler",e),c.setMatrix("diffuseMatrix",e.getTextureMatrix()))}if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){const e=s.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(s);if(!t)return;c.setTexture("boneSampler",t),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",e.getTransformMatrices(s))}Fi(c,a,r),wi.BindMorphTargetParameters(s,c),s.morphTargetManager&&s.morphTargetManager.isUsingTextureForTargets&&s.morphTargetManager._bind(c),a.pointsCloud&&c.setFloat("pointSize",a.pointSize)}s._processRendering(n,e,c,a.fillMode,d,u,((e,t)=>c.setMatrix("world",t)))}};this._depthMap.customRenderFunction=(e,t,i,s)=>{let n;if(s.length)for(n=0;n<s.length;n++)h(s.data[n]);for(n=0;n<e.length;n++)h(e.data[n]);for(n=0;n<t.length;n++)h(t.data[n]);if(this.forceDepthWriteTransparentMeshes)for(n=0;n<i.length;n++)h(i.data[n]);else for(n=0;n<i.length;n++)i.data[n].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}isReady(e,t){var i;const s=this._scene.getEngine(),n=e.getMesh(),r=n.getScene(),o=null===(i=n._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[s.currentRenderPassId];if(o)return o.isReadyForSubMesh(n,e,t);const a=e.getMaterial();if(!a||a.disableDepthWrite)return!1;const l=[],h=[Oe.PositionKind];if(a&&a.needAlphaTesting()&&a.getAlphaTestTexture()&&(l.push("#define ALPHATEST"),n.isVerticesDataPresent(Oe.UVKind)&&(h.push(Oe.UVKind),l.push("#define UV1")),n.isVerticesDataPresent(Oe.UV2Kind)&&(h.push(Oe.UV2Kind),l.push("#define UV2"))),n.useBones&&n.computeBonesUsingShaders){h.push(Oe.MatricesIndicesKind),h.push(Oe.MatricesWeightsKind),n.numBoneInfluencers>4&&(h.push(Oe.MatricesIndicesExtraKind),h.push(Oe.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),l.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0));const t=e.getRenderingMesh().skeleton;(null==t?void 0:t.isUsingTextureForMatrices)&&l.push("#define BONETEXTURE")}else l.push("#define NUM_BONE_INFLUENCERS 0");const c=n.morphTargetManager;let d=0;c&&c.numInfluencers>0&&(d=c.numInfluencers,l.push("#define MORPHTARGETS"),l.push("#define NUM_MORPH_INFLUENCERS "+d),c.isUsingTextureForTargets&&l.push("#define MORPHTARGETS_TEXTURE"),wi.PrepareAttributesForMorphTargetsInfluencers(h,n,d)),a.pointsCloud&&l.push("#define POINTSIZE"),t&&(l.push("#define INSTANCES"),wi.PushAttributesForInstances(h),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&l.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&l.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&l.push("#define PACKED"),Ni(a,r,l);const u=e._getDrawWrapper(void 0,!0),_=u.defines,f=l.join("\n");if(_!==f){const e=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];Di(e),u.setEffect(s.createEffect("depth",h,e,["diffuseSampler","morphTargets","boneSampler"],f,void 0,void 0,void 0,{maxSimultaneousMorphTargets:d}),f)}return u.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t]}}}ds._SceneComponentInitialization=e=>{throw f("DepthRendererSceneComponent")};F.ShadersStore.minmaxReduxPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#if defined(INITIAL)\nuniform sampler2D sourceTexture;uniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(sourceTexture,coord,0).r;float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;float minz=min(min(min(f1,f2),f3),f4);\n#ifdef DEPTH_REDUX\nfloat maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);\n#else\nfloat maxz=max(max(max(f1,f2),f3),f4);\n#endif\nglFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(MAIN)\nuniform vec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(ONEBEFORELAST)\nuniform ivec2 texSize;void main(void)\n{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(f1.x,f2.x);float maxz=max(f1.y,f2.y);glFragColor=vec4(minz,maxz,0.,0.);}\n#elif defined(LAST)\nvoid main(void)\n{glFragColor=vec4(0.);if (true) { \ndiscard;}}\n#endif\n";class us{constructor(e){this.onAfterReductionPerformed=new s,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new ni(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{this._postProcessManager._rebuild()}))}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,s=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=s;const n=this._camera.getScene(),r=new es("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,n.getEngine(),!1,"#define INITIAL"+(t?"\n#define DEPTH_REDUX":""),i,void 0,void 0,void 0,7);r.autoClear=!1,r.forceFullscreenViewport=s;let o=this._sourceTexture.getRenderWidth(),a=this._sourceTexture.getRenderHeight();r.onApply=((e,t)=>i=>{i.setTexture("sourceTexture",this._sourceTexture),i.setFloat2("texSize",e,t)})(o,a),this._reductionSteps.push(r);let l=1;for(;o>1||a>1;){o=Math.max(Math.round(o/2),1),a=Math.max(Math.round(a/2),1);const e=new es("Reduction phase "+l,"minmaxRedux",["texSize"],null,{width:o,height:a},null,1,n.getEngine(),!1,"#define "+(1==o&&1==a?"LAST":1==o||1==a?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(e.autoClear=!1,e.forceFullscreenViewport=s,e.onApply=((e,t)=>i=>{1==e||1==t?i.setInt2("texSize",e,t):i.setFloat2("texSize",e,t)})(o,a),this._reductionSteps.push(e),l++,1==o&&1==a){const t=(e,t,i)=>{const s=new Float32Array(4*e*t),r={min:0,max:0};return()=>{n.getEngine()._readTexturePixels(i.inputTexture.texture,e,t,-1,0,s,!1),r.min=s[0],r.max=s[1],this.onAfterReductionPerformed.notifyObservers(r)}};e.onAfterRenderObservable.add(t(o,a,e))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){!this._onAfterUnbindObserver&&this._sourceTexture&&(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add((()=>{var e,t;const i=this._camera.getScene().getEngine();null===(e=i._debugPushGroup)||void 0===e||e.call(i,"min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),i.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),null===(t=i._debugPopGroup)||void 0===t||t.call(i,1)})),this._activated=!0)}deactivate(){this._onAfterUnbindObserver&&this._sourceTexture&&(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}class _s extends us{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){const s=this._camera.getScene();this._depthRenderer&&(delete s._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(s._depthRenderer||(s._depthRenderer={}),(e=this._depthRenderer=new ds(s,t,this._camera,!1,1)).enabled=!1,this._depthRendererId="minmax"+this._camera.id,s._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,s=!0){super.setSourceTexture(e,t,i,s)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const e=this._depthRenderer.getDepthMap().getScene();e&&delete e._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const fs=me.Up(),ps=me.Zero(),ms=new me,gs=new me,vs=new Te;class Ts extends ss{_validateFilter(e){return e===ss.FILTER_NONE||e===ss.FILTER_PCF||e===ss.FILTER_PCSS?e:(p.Error('Unsupported filter "'+e+'"!'),ss.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,Ts.MIN_CASCADES_COUNT),Ts.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._freezeShadowCastersBoundingInfoObservable||e||(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add((()=>this._computeShadowCastersBoundingInfo()))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let t=0;t<e.length;t++){const i=e[t];if(!i)continue;const s=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(s.minimumWorld),this._scbiMax.maximizeInPlace(s.maximumWorld)}const t=this._scene.meshes;for(let e=0;e<t.length;e++){const i=t[e];if(!(i&&i.isVisible&&i.isEnabled&&i.receiveShadows))continue;const s=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(s.minimumWorld),this._scbiMax.maximizeInPlace(s.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return Ts.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();t?this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&0!==t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0):this._shadowMaxZ=e}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e)return this._depthReducer&&this._depthReducer.deactivate(),void this.setMinMaxDistance(0,1);this._depthReducer||(this._depthReducer=new _s(t),this._depthReducer.onAfterReductionPerformed.add((e=>{let t=e.min,i=e.max;t>=i&&(t=0,i=1),t==this._minDistance&&i==this._maxDistance||this.setMinMaxDistance(t,i)})),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){var e,t,i;return null!==(i=null===(t=null===(e=this._depthReducer)||void 0===e?void 0:e.depthRenderer)||void 0===t?void 0:t.getDepthMap().refreshRate)&&void 0!==i?i:-1}set autoCalcDepthBoundsRefreshRate(e){var t;(null===(t=this._depthReducer)||void 0===t?void 0:t.depthRenderer)&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ||this._shadowMaxZ,s=i-t,n=this._minDistance,r=t+n*s,o=t+(this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance)*s,a=o-r,l=o/r;for(let e=0;e<this._cascades.length;++e){const i=(e+1)/this._numCascades,o=r*l**i,h=r+a*i,c=this._lambda*(o-h)+h;this._cascades[e].prevBreakDistance=0===e?n:this._cascades[e-1].breakDistance,this._cascades[e].breakDistance=(c-t)/s,this._viewSpaceFrustumsZ[e]=c,this._frustumLengths[e]=(this._cascades[e].breakDistance-this._cascades[e].prevBreakDistance)*s}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;me.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(me.Dot(this._lightDirection,me.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const t=e.getEngine().useReverseDepthBuffer;for(let i=0;i<this._numCascades;++i){this._computeFrustumInWorldSpace(i),this._computeCascadeFrustum(i),this._cascadeMaxExtents[i].subtractToRef(this._cascadeMinExtents[i],ms),this._frustumCenter[i].addToRef(this._lightDirection.scale(this._cascadeMinExtents[i].z),this._shadowCameraPos[i]),Te.LookAtLHToRef(this._shadowCameraPos[i],this._frustumCenter[i],fs,this._viewMatrices[i]);let s=0,n=ms.z;const r=this._shadowCastersBoundingInfo;r.update(this._viewMatrices[i]),n=Math.min(n,r.boundingBox.maximumWorld.z),s=this._depthClamp&&this.filter!==ss.FILTER_PCSS?Math.max(s,r.boundingBox.minimumWorld.z):Math.min(s,r.boundingBox.minimumWorld.z),Te.OrthoOffCenterLHToRef(this._cascadeMinExtents[i].x,this._cascadeMaxExtents[i].x,this._cascadeMinExtents[i].y,this._cascadeMaxExtents[i].y,t?n:s,t?s:n,this._projectionMatrices[i],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[i].z=s,this._cascadeMaxExtents[i].z=n,this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),me.TransformCoordinatesToRef(ps,this._transformMatrices[i],ms),ms.scaleInPlace(this._mapSize/2),gs.copyFromFloats(Math.round(ms.x),Math.round(ms.y),Math.round(ms.z)),gs.subtractInPlace(ms).scaleInPlace(2/this._mapSize),Te.TranslationToRef(gs.x,gs.y,0,vs),this._projectionMatrices[i].multiplyToRef(vs,this._projectionMatrices[i]),this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),this._transformMatrices[i].copyToArray(this._transformMatricesAsArray,16*i)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,s=this._cascades[e].breakDistance,n=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const r=0===t.maxZ,o=t.maxZ;r&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));const a=Te.Invert(t.getTransformationMatrix());r&&(t.maxZ=o,t.getProjectionMatrix(!0));const l=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let t=0;t<Ts._FrustumCornersNDCSpace.length;++t)ms.copyFrom(Ts._FrustumCornersNDCSpace[(t+l)%Ts._FrustumCornersNDCSpace.length]),n&&-1===ms.z&&(ms.z=0),me.TransformCoordinatesToRef(ms,a,this._frustumCornersWorldSpace[e][t]);for(let t=0;t<Ts._FrustumCornersNDCSpace.length/2;++t)ms.copyFrom(this._frustumCornersWorldSpace[e][t+4]).subtractInPlace(this._frustumCornersWorldSpace[e][t]),gs.copyFrom(ms).scaleInPlace(i),ms.scaleInPlace(s),ms.addInPlace(this._frustumCornersWorldSpace[e][t]),this._frustumCornersWorldSpace[e][t+4].copyFrom(ms),this._frustumCornersWorldSpace[e][t].addInPlace(gs)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),this._getCamera()){for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][t]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let t=0;for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i){const s=this._frustumCornersWorldSpace[e][i].subtractToRef(this._frustumCenter[e],ms).length();t=Math.max(t,s)}t=Math.ceil(16*t)/16,this._cascadeMaxExtents[e].copyFromFloats(t,t,t),this._cascadeMinExtents[e].copyFromFloats(-t,-t,-t)}else{const t=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,ms),Te.LookAtLHToRef(t,ms,fs,vs);for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)me.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][t],vs,ms),this._cascadeMinExtents[e].minimizeInPlace(ms),this._cascadeMaxExtents[e].maximizeInPlace(ms)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=u.LastCreatedEngine;return!!e&&e._features.supportCSM}constructor(e,t,i,s,n=!0){Ts.IsSupported?(super(e,t,i,s,n),this.usePercentageCloserFiltering=!0):p.Error("CascadedShadowMap is not supported by the current engine.")}_initializeGenerator(){var e,t,i,s,n,r,o,a,l,h,c,d,u,_,f,p,m,g,v,T;this.penumbraDarkness=null!==(e=this.penumbraDarkness)&&void 0!==e?e:1,this._numCascades=null!==(t=this._numCascades)&&void 0!==t?t:Ts.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=null!==(i=this.stabilizeCascades)&&void 0!==i&&i,this._freezeShadowCastersBoundingInfoObservable=null!==(s=this._freezeShadowCastersBoundingInfoObservable)&&void 0!==s?s:null,this.freezeShadowCastersBoundingInfo=null!==(n=this.freezeShadowCastersBoundingInfo)&&void 0!==n&&n,this._scbiMin=null!==(r=this._scbiMin)&&void 0!==r?r:new me(0,0,0),this._scbiMax=null!==(o=this._scbiMax)&&void 0!==o?o:new me(0,0,0),this._shadowCastersBoundingInfo=null!==(a=this._shadowCastersBoundingInfo)&&void 0!==a?a:new cs(new me(0,0,0),new me(0,0,0)),this._breaksAreDirty=null===(l=this._breaksAreDirty)||void 0===l||l,this._minDistance=null!==(h=this._minDistance)&&void 0!==h?h:0,this._maxDistance=null!==(c=this._maxDistance)&&void 0!==c?c:1,this._currentLayer=null!==(d=this._currentLayer)&&void 0!==d?d:0,this._shadowMaxZ=null!==(f=null!==(u=this._shadowMaxZ)&&void 0!==u?u:null===(_=this._getCamera())||void 0===_?void 0:_.maxZ)&&void 0!==f?f:1e4,this._debug=null!==(p=this._debug)&&void 0!==p&&p,this._depthClamp=null===(m=this._depthClamp)||void 0===m||m,this._cascadeBlendPercentage=null!==(g=this._cascadeBlendPercentage)&&void 0!==g?g:.1,this._lambda=null!==(v=this._lambda)&&void 0!==v?v:.5,this._autoCalcDepthBounds=null!==(T=this._autoCalcDepthBounds)&&void 0!==T&&T,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new Ji(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(2*this._numCascades),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let e=0;e<this._numCascades;++e){this._cascades[e]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[e]=Te.Zero(),this._projectionMatrices[e]=Te.Zero(),this._transformMatrices[e]=Te.Zero(),this._cascadeMinExtents[e]=new me,this._cascadeMaxExtents[e]=new me,this._frustumCenter[e]=new me,this._shadowCameraPos[e]=new me,this._frustumCornersWorldSpace[e]=new Array(Ts._FrustumCornersNDCSpace.length);for(let t=0;t<Ts._FrustumCornersNDCSpace.length;++t)this._frustumCornersWorldSpace[e][t]=new me}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add((t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===ss.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())})),this._shadowMap.onBeforeBindObservable.add((()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),null===(t=e._debugPushGroup)||void 0===t||t.call(e,`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()})),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==ss.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene,s=this._light;if(!i.shadowsEnabled||!s.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const n=this._getCamera();n&&this._shadowMaxZ<=(n.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const s=this._getCamera();if(!s)return;const n=this.getShadowMap();if(!n)return;const r=n.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===ss.FILTER_PCF)t.setDepthStencilTexture("shadowSampler"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),r,1/r,this.frustumEdgeFalloff,e);else if(this._filter===ss.FILTER_PCSS){for(let e=0;e<this._numCascades;++e)this._lightSizeUVCorrection[2*e+0]=0===e?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[e].x-this._cascadeMinExtents[e].x),this._lightSizeUVCorrection[2*e+1]=0===e?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[e].y-this._cascadeMinExtents[e].y),this._depthCorrection[e]=0===e?1:(this._cascadeMaxExtents[e].z-this._cascadeMinExtents[e].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowSampler"+e,n),t.setTexture("depthSampler"+e,n),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/r,this._contactHardeningLightSizeUVRatio*r,this.frustumEdgeFalloff,e)}else t.setTexture("shadowSampler"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),r,1/r,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(s),this.getLight().getDepthMinZ(s)+this.getLight().getDepthMaxZ(s),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const s=t.renderList[i];e.renderList.push(s.id)}return e}static Parse(e,t){const i=ss.Parse(e,t,((e,t,i)=>new Ts(e,t,void 0,i)));return void 0!==e.numCascades&&(i.numCascades=e.numCascades),void 0!==e.debug&&(i.debug=e.debug),void 0!==e.stabilizeCascades&&(i.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(i.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(i.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(i.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(i.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}Ts._FrustumCornersNDCSpace=[new me(-1,1,-1),new me(1,1,-1),new me(1,-1,-1),new me(-1,-1,-1),new me(-1,1,1),new me(1,1,1),new me(1,-1,1),new me(-1,-1,1)],Ts.CLASSNAME="CascadedShadowGenerator",Ts.DEFAULT_CASCADES_COUNT=4,Ts.MIN_CASCADES_COUNT=2,Ts.MAX_CASCADES_COUNT=4,Ts._SceneComponentInitialization=e=>{throw f("ShadowGeneratorSceneComponent")},Ht.AddParser(li.NAME_SHADOWGENERATOR,((e,t)=>{if(void 0!==e.shadowGenerators&&null!==e.shadowGenerators)for(let i=0,s=e.shadowGenerators.length;i<s;i++){const s=e.shadowGenerators[i];s.className===Ts.CLASSNAME?Ts.Parse(s,t):ss.Parse(s,t)}}));class bs{constructor(e){this.name=li.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(li.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){const t=i.getShadowGenerators();if(t){const i=t.values();for(let t=i.next();!0!==t.done;t=i.next()){const i=t.value;e.shadowGenerators.push(i.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const s=t.lights[i],n=s.getShadowGenerators();if(s.isEnabled()&&s.shadowEnabled&&n){const i=n.values();for(let s=i.next();!0!==s.done;s=i.next()){const i=s.value.getShadowMap();-1!==t.textures.indexOf(i)&&e.push(i)}}}}}ss._SceneComponentInitialization=e=>{let t=e._getComponent(li.NAME_SHADOWGENERATOR);t||(t=new bs(e),e._addComponent(t))};class Es{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,s,n){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&-1!==t.prePassRenderer.getIndex(2)){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=s.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const n=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==n.frameId&&(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=s.clone()}}}class Ss{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}class xs{static extractMinAndMaxIndexed(e,t,i,s,n,r){for(let o=i;o<i+s;o++){const i=3*t[o],s=e[i],a=e[i+1],l=e[i+2];n.minimizeInPlaceFromFloats(s,a,l),r.maximizeInPlaceFromFloats(s,a,l)}}static extractMinAndMax(e,t,i,s,n,r){for(let o=t,a=t*s;o<t+i;o++,a+=s){const t=e[a],i=e[a+1],s=e[a+2];n.minimizeInPlaceFromFloats(t,i,s),r.maximizeInPlaceFromFloats(t,i,s)}}}function Cs(e,t,i,s=null,n){const r=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new me(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return n||(n=3),xs.extractMinAndMax(e,t,i,n,r,o),s&&(r.x-=r.x*s.x+s.y,r.y-=r.y*s.x+s.y,r.z-=r.z*s.x+s.y,o.x+=o.x*s.x+s.y,o.y+=o.y*s.x+s.y,o.z+=o.z*s.x+s.y),{minimum:r,maximum:o}}De([Ze.filter(((...[e,t])=>!Array.isArray(e)&&!Array.isArray(t)))],xs,"extractMinAndMaxIndexed",null),De([Ze.filter(((...[e])=>!Array.isArray(e)))],xs,"extractMinAndMax",null);class ys{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:null===(e=this._getDrawWrapper())||void 0===e?void 0:e.defines}set materialDefines(e){var t;(null!==(t=this._mainDrawWrapperOverride)&&void 0!==t?t:this._getDrawWrapper(void 0,!0)).defines=e}_getDrawWrapper(e,t=!1){e=null!=e?e:this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new Y(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){var i;t&&(null===(i=this._drawWrappers[e])||void 0===i||i.dispose()),this._drawWrappers[e]=void 0}get effect(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:null!==(t=null===(e=this._getDrawWrapper())||void 0===e?void 0:e.effect)&&void 0!==t?t:null}get _drawWrapper(){var e;return null!==(e=this._mainDrawWrapperOverride)&&void 0!==e?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,s=!0){const n=this._drawWrapper;n.setEffect(e,t,s),void 0!==i&&(n.materialContext=i),e||(n.defines=null,n.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers){if(void 0!==e)return void this._removeDrawWrapper(e);for(const e of this._drawWrappers)null==e||e.dispose()}this._drawWrappers=[]}static AddToMesh(e,t,i,s,n,r,o,a=!0){return new ys(e,t,i,s,n,r,o,a)}constructor(e,t,i,s,n,r,o,a=!0,l=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=s,this.indexCount=n,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=r,this._renderingMesh=o||r,l&&r.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=r.subMeshes.length-1,a&&(this.refreshBoundingInfo(),r.computeWorldMatrix(!0))}get IsGlobal(){return 0===this.verticesStart&&this.verticesCount===this._mesh.getTotalVertices()&&0===this.indexStart&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){return(this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null)||this._renderingMesh}getMaterial(e=!0){var t;const i=null!==(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))&&void 0!==t?t:this._renderingMesh.material;if(!i)return e?this._mesh.getScene().defaultMaterial:null;if(this._isMultiMaterial(i)){const e=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==e&&(this._currentMaterial=e,this.resetDrawCache()),e}return i}_isMultiMaterial(e){return void 0!==e.getSubMaterial}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(Oe.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(0===this.indexStart&&this.indexCount===t.length){const e=this._renderingMesh.getBoundingInfo();i={minimum:e.minimum.clone(),maximum:e.maximum.clone()}}else i=function(e,t,i,s,n=null){const r=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new me(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return xs.extractMinAndMaxIndexed(e,t,i,s,r,o),n&&(r.x-=r.x*n.x+n.y,r.y-=r.y*n.x+n.y,r.z-=r.z*n.x+n.y,o.x+=o.x*n.x+n.y,o.y+=o.y*n.x+n.y,o.z+=o.z*n.x+n.y),{minimum:r,maximum:o}}(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new cs(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isInFrustum(e,this._mesh.cullingStrategy)}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return!!t&&t.isCompletelyInFrustum(e)}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let t=this.indexStart;t<this.indexStart+this.indexCount;t+=3)i.push(e[t],e[t+1],e[t+1],e[t+2],e[t+2],e[t]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return!!t&&e.intersectsBox(t.boundingBox)}intersects(e,t,i,s,n){const r=this.getMaterial();if(!r)return null;let o=3,a=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,a=!0}return 4===r.fillMode?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,s):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,s):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,s,n):this._intersectTriangles(e,t,i,o,a,s,n)}_intersectLines(e,t,i,s,n){let r=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){const a=t[i[o]],l=t[i[o+1]],h=e.intersectionSegment(a,l,s);if(!(h<0)&&(n||!r||h<r.distance)&&(r=new Ss(null,null,h),r.faceId=o/2,n))break}return r}_intersectUnIndexedLines(e,t,i,s,n){let r=null;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=2){const o=t[i],a=t[i+1],l=e.intersectionSegment(o,a,s);if(!(l<0)&&(n||!r||l<r.distance)&&(r=new Ss(null,null,l),r.faceId=i/2,n))break}return r}_intersectTriangles(e,t,i,s,n,r,o){let a=null,l=-1;for(let h=this.indexStart;h<this.indexStart+this.indexCount-(3-s);h+=s){l++;const s=i[h],c=i[h+1],d=i[h+2];if(n&&4294967295===d){h+=2;continue}const u=t[s],_=t[c],f=t[d];if(!u||!_||!f)continue;if(o&&!o(u,_,f,e,s,c,d))continue;const p=e.intersectsTriangle(u,_,f);if(p){if(p.distance<0)continue;if((r||!a||p.distance<a.distance)&&(a=p,a.faceId=l,r))break}}return a}_intersectUnIndexedTriangles(e,t,i,s,n){let r=null;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){const o=t[i],a=t[i+1],l=t[i+2];if(n&&!n(o,a,l,e,-1,-1,-1))continue;const h=e.intersectsTriangle(o,a,l);if(h){if(h.distance<0)continue;if((s||!r||h.distance<r.distance)&&(r=h,r.faceId=i/3,s))break}}return r}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new ys(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const e=this.getBoundingInfo();if(!e)return i;i._boundingInfo=new cs(e.minimum,e.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,s,n,r=!0){let o=Number.MAX_VALUE,a=-Number.MAX_VALUE;const l=(n||s).getIndices();for(let e=t;e<t+i;e++){const t=l[e];t<o&&(o=t),t>a&&(a=t)}return new ys(e,o,a-o+1,t,i,s,n,r)}}class As{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){qe.Clone((()=>e),this)}serialize(){return qe.Serialize(this)}parse(e,t,i){qe.Parse((()=>this),e,t,i)}}var Rs,Is;De([Ge()],As.prototype,"func",null),De([Ge()],As.prototype,"funcRef",null),De([Ge()],As.prototype,"funcMask",null),De([Ge()],As.prototype,"opStencilFail",null),De([Ge()],As.prototype,"opDepthFail",null),De([Ge()],As.prototype,"opStencilDepthPass",null),De([Ge()],As.prototype,"mask",null),De([Ge()],As.prototype,"enabled",null),(Is=Rs||(Rs={}))[Is.Created=1]="Created",Is[Is.Disposed=2]="Disposed",Is[Is.GetDefineNames=4]="GetDefineNames",Is[Is.PrepareUniformBuffer=8]="PrepareUniformBuffer",Is[Is.IsReadyForSubMesh=16]="IsReadyForSubMesh",Is[Is.PrepareDefines=32]="PrepareDefines",Is[Is.BindForSubMesh=64]="BindForSubMesh",Is[Is.PrepareEffect=128]="PrepareEffect",Is[Is.GetAnimatables=256]="GetAnimatables",Is[Is.GetActiveTextures=512]="GetActiveTextures",Is[Is.HasTexture=1024]="HasTexture",Is[Is.FillRenderTargetTextures=2048]="FillRenderTargetTextures",Is[Is.HasRenderTargetTextures=4096]="HasRenderTargetTextures",Is[Is.HardBindForSubMesh=8192]="HardBindForSubMesh";class Ps{get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,1!==t&&1!==e||this.markAsDirty(Ps.MiscDirtyFlag+Ps.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(Ps.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(Ps.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new s),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new s),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new s),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(Ps.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(Ps.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case Ps.WireFrameFillMode:case Ps.LineListDrawMode:case Ps.LineLoopDrawMode:case Ps.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?Ps.WireFrameFillMode:Ps.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case Ps.PointFillMode:case Ps.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?Ps.PointFillMode:Ps.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(Ps.MiscDirtyFlag))}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=this.getScene().getEngine().getCaps().fragmentDepthSupported;e&&!t&&p.Warn("Logarithmic depth has been requested for a material on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._markAllSubMeshesAsMiscDirty()}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new s,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new As,this._useUBO=!1,this._fillMode=Ps.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const n=t||u.LastCreatedScene;n&&(this._scene=n,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||Ot.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new Y(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=Ps.ClockWiseSideOrientation:this.sideOrientation=Ps.CounterClockWiseSideOrientation,this._uniformBuffer=new Nt(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),Ps.OnEventObservable.notifyObservers(this,Rs.Created))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const s=t.materialDefines;return!!s&&(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh)}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===Ps.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===Ps.MATERIAL_OPAQUE||this._transparencyMode===Ps.MATERIAL_ALPHATEST}needAlphaBlending(){return!this._disableAlphaBlending&&this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1||!this._disableAlphaBlending&&(e.hasVertexAlpha||this.needAlphaBlending())}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const t of i.subMeshes)t.getMaterial()===this&&t.effect&&(t.effect._wasPreviouslyReady=!1,t.effect._wasPreviouslyUsingInstances=null,t.effect._forceRebindOnNextCall=e);e&&this.markAsDirty(Ps.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),s=(null==t?this.sideOrientation:t)===Ps.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,s,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),s}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(Rs.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const s=i.effect;s&&(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),s._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,wi.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),this._scene._cachedVisibility=e?e.visibility:1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const e=this._scene.getEngine();this._cachedDepthWriteState=e.getDepthWrite(),e.setDepthWrite(!1)}if(this.disableColorWrite){const e=this._scene.getEngine();this._cachedColorWriteState=e.getColorWrite(),e.setColorWrite(!1)}if(0!==this.depthFunction){const e=this._scene.getEngine();this._cachedDepthFunctionState=e.getDepthFunction()||0,e.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),0!==this.depthFunction&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(Rs.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(Rs.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(Rs.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){const i={};if(this._serializePlugins(i),Ps._parsePlugins(i,e,this._scene,t),this.pluginManager)for(const t of this.pluginManager._plugins){const i=e.pluginManager.getPlugin(t.name);t.copyTo(i)}}getBindedMeshes(){if(this.meshMap){const e=[];for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}return this._scene.meshes.filter((e=>e.material===this))}forceCompilation(e,t,i,s){const n=Object.assign({clipPlane:!1,useInstances:!1},i),r=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const a=()=>{if(!this._scene||!this._scene.getEngine())return;const i=r.clipPlane;if(n.clipPlane&&(r.clipPlane=new kt(0,0,0,1)),this._storeEffectOnSubMeshes){let i=!0,r=null;if(e.subMeshes){const t=new ys(0,0,0,0,0,e,void 0,!1,!1);t.materialDefines&&(t.materialDefines._renderId=-1),this.isReadyForSubMesh(e,t,n.useInstances)||(t.effect&&t.effect.getCompilationError()&&t.effect.allFallbacksProcessed()?r=t.effect.getCompilationError():(i=!1,setTimeout(a,16)))}i&&(this.allowShaderHotSwapping=o,r&&s&&s(r),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=o,t&&t(this)):setTimeout(a,16);n.clipPlane&&(r.clipPlane=i)};a()}forceCompilationAsync(e,t){return new Promise(((i,s)=>{this.forceCompilation(e,(()=>{i()}),t,(e=>{s(e)}))}))}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(Ps._DirtyCallbackArray.length=0,e&Ps.TextureDirtyFlag&&Ps._DirtyCallbackArray.push(Ps._TextureDirtyCallBack),e&Ps.LightDirtyFlag&&Ps._DirtyCallbackArray.push(Ps._LightsDirtyCallBack),e&Ps.FresnelDirtyFlag&&Ps._DirtyCallbackArray.push(Ps._FresnelDirtyCallBack),e&Ps.AttributesDirtyFlag&&Ps._DirtyCallbackArray.push(Ps._AttributeDirtyCallBack),e&Ps.MiscDirtyFlag&&Ps._DirtyCallbackArray.push(Ps._MiscDirtyCallBack),e&Ps.PrePassDirtyFlag&&Ps._DirtyCallbackArray.push(Ps._PrePassDirtyCallBack),Ps._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(Ps._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const e of t.subMeshes)e.getMaterial()===this&&e.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const t of i.subMeshes)if(t.getMaterial(!1)===this)for(const i of t._drawWrappers)i&&i.defines&&i.defines.markAllAsDirty&&this._materialContext===i.materialContext&&e(i.defines)}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(Ps._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(Ps._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(Ps._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(Ps._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(Ps._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(Ps._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(Ps._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(Ps._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(Ps._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(Ps._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==Mi.BackwardCompatible){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce((()=>{this.checkReadyOnlyOnce=!1}));this.onDisposeObservable.add((()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)}))}}setPrePassRenderer(e){return!1}dispose(e,t,i){const s=this.getScene();if(s.stopAnimation(this),s.freeProcessedMaterials(),s.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(Rs.Disposed,this._eventInfo),this._parentContainer){const e=this._parentContainer.materials.indexOf(this);e>-1&&this._parentContainer.materials.splice(e,1),this._parentContainer=null}if(!0!==i)if(this.meshMap)for(const t in this.meshMap){const i=this.meshMap[t];i&&(i.material=null,this.releaseVertexArrayObject(i,e))}else{const t=s.meshes;for(const i of t)i.material!==this||i.sourceMesh||(i.material=null,this.releaseVertexArrayObject(i,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){const i=e.geometry;if(i)if(this._storeEffectOnSubMeshes){if(e.subMeshes)for(const s of e.subMeshes)i._releaseVertexArrayObject(s.effect),t&&s.effect&&s.effect.dispose()}else i._releaseVertexArrayObject(this._drawWrapper.effect)}serialize(){const e=qe.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(const t of this.pluginManager._plugins)e.plugins[t.getClassName()]=t.serialize()}static Parse(e,t,i){if(e.customType){if("BABYLON.PBRMaterial"===e.customType&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return p.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null}else e.customType="BABYLON.StandardMaterial";const s=Ot.Instantiate(e.customType).Parse(e,t,i);return s._loadedUniqueId=e.uniqueId,s}static _parsePlugins(e,t,i,s){var n;if(e.plugins)for(const r in e.plugins){const o=e.plugins[r];let a=null===(n=t.pluginManager)||void 0===n?void 0:n.getPlugin(o.name);if(!a){const e=Ot.Instantiate("BABYLON."+r);e&&(a=new e(t))}null==a||a.parse(o,i,s)}}}Ps.TriangleFillMode=0,Ps.WireFrameFillMode=1,Ps.PointFillMode=2,Ps.PointListDrawMode=3,Ps.LineListDrawMode=4,Ps.LineLoopDrawMode=5,Ps.LineStripDrawMode=6,Ps.TriangleStripDrawMode=7,Ps.TriangleFanDrawMode=8,Ps.ClockWiseSideOrientation=0,Ps.CounterClockWiseSideOrientation=1,Ps.TextureDirtyFlag=1,Ps.LightDirtyFlag=2,Ps.FresnelDirtyFlag=4,Ps.AttributesDirtyFlag=8,Ps.MiscDirtyFlag=16,Ps.PrePassDirtyFlag=32,Ps.AllDirtyFlag=63,Ps.MATERIAL_OPAQUE=0,Ps.MATERIAL_ALPHATEST=1,Ps.MATERIAL_ALPHABLEND=2,Ps.MATERIAL_ALPHATESTANDBLEND=3,Ps.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,Ps.MATERIAL_NORMALBLENDMETHOD_RNM=1,Ps.OnEventObservable=new s,Ps._AllDirtyCallBack=e=>e.markAllAsDirty(),Ps._ImageProcessingDirtyCallBack=e=>e.markAsImageProcessingDirty(),Ps._TextureDirtyCallBack=e=>e.markAsTexturesDirty(),Ps._FresnelDirtyCallBack=e=>e.markAsFresnelDirty(),Ps._MiscDirtyCallBack=e=>e.markAsMiscDirty(),Ps._PrePassDirtyCallBack=e=>e.markAsPrePassDirty(),Ps._LightsDirtyCallBack=e=>e.markAsLightDirty(),Ps._AttributeDirtyCallBack=e=>e.markAsAttributesDirty(),Ps._FresnelAndMiscDirtyCallBack=e=>{Ps._FresnelDirtyCallBack(e),Ps._MiscDirtyCallBack(e)},Ps._TextureAndMiscDirtyCallBack=e=>{Ps._TextureDirtyCallBack(e),Ps._MiscDirtyCallBack(e)},Ps._DirtyCallbackArray=[],Ps._RunDirtyCallBacks=e=>{for(const t of Ps._DirtyCallbackArray)t(e)},De([Ge()],Ps.prototype,"id",void 0),De([Ge()],Ps.prototype,"uniqueId",void 0),De([Ge()],Ps.prototype,"name",void 0),De([Ge()],Ps.prototype,"metadata",void 0),De([Ge()],Ps.prototype,"checkReadyOnEveryCall",void 0),De([Ge()],Ps.prototype,"checkReadyOnlyOnce",void 0),De([Ge()],Ps.prototype,"state",void 0),De([Ge("alpha")],Ps.prototype,"_alpha",void 0),De([Ge("backFaceCulling")],Ps.prototype,"_backFaceCulling",void 0),De([Ge("cullBackFaces")],Ps.prototype,"_cullBackFaces",void 0),De([Ge()],Ps.prototype,"sideOrientation",void 0),De([Ge("alphaMode")],Ps.prototype,"_alphaMode",void 0),De([Ge()],Ps.prototype,"_needDepthPrePass",void 0),De([Ge()],Ps.prototype,"disableDepthWrite",void 0),De([Ge()],Ps.prototype,"disableColorWrite",void 0),De([Ge()],Ps.prototype,"forceDepthWrite",void 0),De([Ge()],Ps.prototype,"depthFunction",void 0),De([Ge()],Ps.prototype,"separateCullingPass",void 0),De([Ge("fogEnabled")],Ps.prototype,"_fogEnabled",void 0),De([Ge()],Ps.prototype,"pointSize",void 0),De([Ge()],Ps.prototype,"zOffset",void 0),De([Ge()],Ps.prototype,"zOffsetUnits",void 0),De([Ge()],Ps.prototype,"pointsCloud",null),De([Ge()],Ps.prototype,"fillMode",null),De([Ge()],Ps.prototype,"useLogarithmicDepth",null),De([Ge()],Ps.prototype,"transparencyMode",null);class Ms extends Ps{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new Te,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return!!e&&(!this._storeEffectOnSubMeshes||!e.subMeshes||0===e.subMeshes.length||this.isReadyForSubMesh(e,e.subMeshes[0],t))}_isReadyForSubMesh(e){const t=e.materialDefines;return!(this.checkReadyOnEveryCall||!e.effect||!t||t._renderId!==this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null){super._afterBind(e,t),this.getScene()._cachedEffect=t,t&&(t._forceRebindOnNextCall=!1)}_mustRebind(e,t,i=1){return e.isCachedMaterialInvalid(this,t,i)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}class Os{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,te.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,te.MarkAllMaterialsAsDirty(1))}}Os._DiffuseTextureEnabled=!0,Os._DetailTextureEnabled=!0,Os._DecalMapEnabled=!0,Os._AmbientTextureEnabled=!0,Os._OpacityTextureEnabled=!0,Os._ReflectionTextureEnabled=!0,Os._EmissiveTextureEnabled=!0,Os._SpecularTextureEnabled=!0,Os._BumpTextureEnabled=!0,Os._LightmapTextureEnabled=!0,Os._RefractionTextureEnabled=!0,Os._ColorGradingTextureEnabled=!0,Os._FresnelEnabled=!0,Os._ClearCoatTextureEnabled=!0,Os._ClearCoatBumpTextureEnabled=!0,Os._ClearCoatTintTextureEnabled=!0,Os._SheenTextureEnabled=!0,Os._AnisotropicTextureEnabled=!0,Os._ThicknessTextureEnabled=!0,Os._RefractionIntensityTextureEnabled=!0,Os._TranslucencyIntensityTextureEnabled=!0,Os._IridescenceTextureEnabled=!0;F.IncludesShadersStore.decalFragmentDeclaration="#ifdef DECAL\nuniform vec4 vDecalInfos;\n#endif\n";F.IncludesShadersStore.defaultFragmentDeclaration="uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;\n#endif\n#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)\nuniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; \n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)\nuniform mat4 reflectionMatrix;\n#endif\n#ifndef REFLECTIONMAP_SKYBOX\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";F.IncludesShadersStore.defaultUboDeclaration="layout(std140,column_major) uniform;uniform Material\n{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vReflectionInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 reflectionMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";F.IncludesShadersStore.prePassDeclaration="#ifdef PREPASS\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;\n#ifdef PREPASS_DEPTH\nvarying highp vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nvarying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;\n#endif\n#endif\n";F.IncludesShadersStore.oitDeclaration="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\n#extension GL_EXT_draw_buffers : require\nlayout(location=0) out vec2 depth; \nlayout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;\n#define MAX_DEPTH 99999.0\nhighp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;\n#endif\n";F.IncludesShadersStore.mainUVVaryingDeclaration="#ifdef MAINUV{X}\nvarying vec2 vMainUV{X};\n#endif\n";F.IncludesShadersStore.lightFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};uniform highp sampler2DArray depthSampler{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);vec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};uniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightSampler{X};\n#endif\n#endif\n";F.IncludesShadersStore.lightUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;vec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;vec2 depthValues;} light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightSampler{X};\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};uniform highp sampler2DArray depthSampler{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DArrayShadow shadowSampler{X};\n#else\nuniform highp sampler2DArray shadowSampler{X};\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nconst vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]\n(\nvec3 ( 1.5,0.0,0.0 ),\nvec3 ( 0.0,1.5,0.0 ),\nvec3 ( 0.0,0.0,5.5 ),\nvec3 ( 1.5,0.0,5.5 ),\nvec3 ( 1.5,1.5,0.0 ),\nvec3 ( 1.0,1.0,1.0 ),\nvec3 ( 0.0,1.0,5.5 ),\nvec3 ( 0.5,3.5,0.75 )\n);vec3 shadowDebug{X};\n#endif\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nint index{X}=-1;\n#else\nint index{X}=SHADOWCSMNUM_CASCADES{X}-1;\n#endif\nfloat diff{X}=0.;\n#elif defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X}; \n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};uniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";F.IncludesShadersStore.lightsFragmentFunctions="struct lightingInfo\n{vec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)\n{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}\nelse\n{lightVectorW=normalize(-lightData.xyz);}\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)\n{cosAngle=max(0.,pow(cosAngle,lightData.w));attenuation*=cosAngle;float ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;\n#endif\nreturn result;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}";F.IncludesShadersStore.shadowsFragmentFunctions="#ifdef SHADOWS\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}\n#endif\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}\n#define inline\nfloat computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nreturn depth>shadow ? darkness : 1.0;}\n#define inline\nfloat computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);}\n#define inline\nfloat computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}\n#define inline\nfloat computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define inline\nfloat computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uvLayer));\n#else\nfloat shadow=texture2D(shadowSampler,uvLayer).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}\n#endif\n#define inline\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nreturn shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}\n#define inline\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);\n#ifndef SHADOWFLOAT\nif (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;\n#else\nif (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{return 1.0;}\nelse\n{float shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));\n#else\nfloat shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}\n#ifdef IS_NDC_HALF_ZRANGE\n#define ZINCLIP clipSpace.z\n#else\n#define ZINCLIP uvDepth.z\n#endif\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define GREATEST_LESS_THAN_ONE 0.99999994\n/* disable_uniformity_analysis */\n#define inline\nfloat computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}\n#define inline\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \nvec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.),\nvec3(0.)\n);const vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n#define inline\nfloat computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}\nshadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}\nelse\n{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}\n#define inline\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}\nelse\n{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}\nif (numBlocker<1.0) {return 1.0;}\nelse\n{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}\nshadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}\n#define inline\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}\n#define inline\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}\n#define inline\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}\n#define inline\nfloat computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#define inline\nfloat computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#define inline\nfloat computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)\n{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}\n#endif\n#endif\n";F.IncludesShadersStore.samplerFragmentDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\nuniform sampler2D _SAMPLERNAME_Sampler;\n#endif\n";F.IncludesShadersStore.fresnelFunction="#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}\n#endif\n";F.IncludesShadersStore.reflectionFunction="vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }\nvec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)\n{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }\nvec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}\nvec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)\n{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}\nvec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}\nvec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)\n{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nvec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)\n{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;}\nvec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)\n{return vec3(reflectionMatrix*(view*worldPos));}\nvec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)\n{return vec3(reflectionMatrix*vec4(positionW,1.));}\n#ifdef REFLECTION\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nreturn computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nreturn computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nreturn computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_CUBIC\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nreturn computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);\n#else\nreturn computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);\n#endif\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn computeProjectionCoords(worldPos,view,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn computeSkyBoxCoords(vPositionUVW,reflectionMatrix);\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}\n#endif\n";F.IncludesShadersStore.imageProcessingDeclaration="#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#if defined(VIGNETTE) || defined(DITHER)\nuniform vec2 vInverseScreenSize;\n#endif\n#ifdef VIGNETTE\nuniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif\n#ifdef DITHER\nuniform float ditherIntensity;\n#endif\n";F.IncludesShadersStore.imageProcessingFunctions="#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n/** \n* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.\n* sampler3dSetting.x=textureOffset (0.5/textureSize).\n* sampler3dSetting.y=textureSize.\n*/\n#define inline\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{float sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;}\n#endif\n#ifdef TONEMAPPING_ACES\nconst mat3 ACESInputMat=mat3(\nvec3(0.59719,0.07600,0.02840),\nvec3(0.35458,0.90834,0.13383),\nvec3(0.04823,0.01566,0.83777)\n);const mat3 ACESOutputMat=mat3(\nvec3( 1.60475,-0.10208,-0.00327),\nvec3(-0.53108, 1.10813,-0.07276),\nvec3(-0.07367,-0.00605, 1.07602)\n);vec3 RRTAndODTFit(vec3 v)\n{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}\nvec3 ACESFitted(vec3 color)\n{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS\nvec4 applyImageProcessing(vec4 result) {\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#ifdef TONEMAPPING\n#ifdef TONEMAPPING_ACES\nresult.rgb=ACESFitted(result.rgb);\n#else\nconst float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\n#endif\nresult.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);\n#ifdef CONTRAST\nvec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}\n#endif\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\nfloat luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\n#ifdef DITHER\nfloat rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));\n#endif\n#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND\nreturn result;}";F.IncludesShadersStore.bumpFragmentMainFunctions="#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#if defined(WEBGL2) || defined(WEBGPU)\nmat4 toNormalMatrix(mat4 wMatrix)\n{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}\n#else\nmat4 toNormalMatrix(mat4 m)\n{float\na00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],\na10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],\na20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],\na30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],\nb00=a00*a11-a01*a10,\nb01=a00*a12-a02*a10,\nb02=a00*a13-a03*a10,\nb03=a01*a12-a02*a11,\nb04=a01*a13-a03*a11,\nb05=a02*a13-a03*a12,\nb06=a20*a31-a21*a30,\nb07=a20*a32-a22*a30,\nb08=a20*a33-a23*a30,\nb09=a21*a32-a22*a31,\nb10=a21*a33-a23*a31,\nb11=a22*a33-a23*a32,\ndet=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(\na11*b11-a12*b10+a13*b09,\na02*b10-a01*b11-a03*b09,\na31*b05-a32*b04+a33*b03,\na22*b04-a21*b05-a23*b03,\na12*b08-a10*b11-a13*b07,\na00*b11-a02*b08+a03*b07,\na32*b02-a30*b05-a33*b01,\na20*b05-a22*b02+a23*b01,\na10*b10-a11*b08+a13*b06,\na01*b08-a00*b10-a03*b06,\na30*b04-a31*b02+a33*b00,\na21*b02-a20*b04-a23*b00,\na11*b07-a10*b09-a12*b06,\na00*b09-a01*b07+a02*b06,\na31*b01-a30*b03-a32*b00,\na20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],\nmi[0][1],mi[1][1],mi[2][1],mi[3][1],\nmi[0][2],mi[1][2],mi[2][2],mi[3][2],\nmi[0][3],mi[1][3],mi[2][3],mi[3][3]);}\n#endif\n#endif\nvec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)\n{\n#ifdef NORMALXYSCALE\nnormal=normalize(normal*vec3(scale,scale,1.0));\n#endif\nreturn normalize(cotangentFrame*normal);}\nvec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)\n{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)\n{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}\n#endif\n";F.IncludesShadersStore.bumpFragmentFunctions="#if defined(BUMP)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)\n#endif\n#if defined(DETAIL)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)\n#endif\n#if defined(BUMP) && defined(PARALLAX)\nconst float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)\n{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)\n{}\nelse if (currSampledHeight>currRayHeight)\n{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}\nelse\n{currRayHeight-=stepSize;vLastOffset=vCurrOffset;\n#ifdef PARALLAX_RHS\nvCurrOffset-=stepSize*vMaxOffset;\n#else\nvCurrOffset+=stepSize*vMaxOffset;\n#endif\nlastSampledHeight=currSampledHeight;}}\nreturn vCurrOffset;}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;\n#ifdef PARALLAX_RHS\nreturn texCoordOffset;\n#else\nreturn -texCoordOffset;\n#endif\n}\n#endif\n";F.IncludesShadersStore.logDepthDeclaration="#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;varying float vFragmentDepth;\n#endif\n";F.IncludesShadersStore.fogFragmentDeclaration="#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()\n{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)\n{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}\nelse if (FOGMODE_EXP==vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}\nelse if (FOGMODE_EXP2==vFogInfos.x)\n{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}\nreturn clamp(fogCoeff,0.0,1.0);}\n#endif\n";F.IncludesShadersStore.bumpFragment="vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#elif defined(BUMP)\nfloat normalScale=vBumpInfos.y;\n#else\nfloat normalScale=1.0;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#elif defined(BUMP)\nvec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);\n#else\nvec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#elif defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nvec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef DETAIL\nvec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\n#define CUSTOM_FRAGMENT_BUMP_FRAGMENT\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);\n#elif !defined(DETAIL)\nnormalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);\n#else\nvec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;\n#if DETAIL_NORMALBLENDMETHOD==0 \ndetailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));\n#elif DETAIL_NORMALBLENDMETHOD==1 \ndetailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;\n#endif\nnormalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);\n#endif\n#elif defined(DETAIL)\ndetailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);\n#endif\n";F.IncludesShadersStore.decalFragment="#ifdef DECAL\n#ifdef GAMMADECAL\ndecalColor.rgb=toLinearSpace(decalColor.rgb);\n#endif\n#ifdef DECAL_SMOOTHALPHA\ndecalColor.a*=decalColor.a;\n#endif\nsurfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);\n#endif\n";F.IncludesShadersStore.depthPrePass="#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);return;\n#endif\n";F.IncludesShadersStore.lightFragment="#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n#else\n#ifdef PBR\n#ifdef SPOTLIGHT{X}\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(POINTLIGHT{X})\npreInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(HEMILIGHT{X})\npreInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#elif defined(DIRLIGHT{X})\npreInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);\n#endif\npreInfo.NdotV=NdotV;\n#ifdef SPOTLIGHT{X}\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);\n#endif\n#elif defined(POINTLIGHT{X})\n#ifdef LIGHT_FALLOFF_GLTF{X}\npreInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);\n#elif defined(LIGHT_FALLOFF_PHYSICAL{X})\npreInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);\n#elif defined(LIGHT_FALLOFF_STANDARD{X})\npreInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);\n#else\npreInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);\n#endif\n#else\npreInfo.attenuation=1.0;\n#endif\n#ifdef HEMILIGHT{X}\npreInfo.roughness=roughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#ifdef IRIDESCENCE\npreInfo.iridescenceIntensity=iridescenceIntensity;\n#endif\n#ifdef HEMILIGHT{X}\ninfo.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);\n#elif defined(SS_TRANSLUCENCY)\ninfo.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);\n#else\ninfo.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef SPECULARTERM\n#ifdef ANISOTROPIC\ninfo.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#else\ninfo.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_LINKWITHALBEDO\npreInfo.roughness=sheenOut.sheenIntensity;\n#else\n#ifdef HEMILIGHT{X}\npreInfo.roughness=sheenOut.sheenRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\n#endif\ninfo.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);\n#endif\n#ifdef CLEARCOAT\n#ifdef HEMILIGHT{X}\npreInfo.roughness=clearcoatOut.clearCoatRoughness;\n#else\npreInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);\n#endif\ninfo.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);\n#ifdef CLEARCOAT_TINT\nabsorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;\n#ifdef SPECULARTERM\ninfo.specular*=absorption;\n#endif\n#endif\ninfo.diffuse*=info.clearCoat.w;\n#ifdef SPECULARTERM\ninfo.specular*=info.clearCoat.w;\n#endif\n#ifdef SHEEN\ninfo.sheen*=info.clearCoat.w;\n#endif\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#elif defined(HEMILIGHT{X})\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);\n#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nfor (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) \n{\n#ifdef SHADOWCSM_RIGHTHANDED{X}\ndiff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;\n#else\ndiff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;\n#endif\nif (diff{X}>=0.) {index{X}=i;break;}}\n#ifdef SHADOWCSMUSESHADOWMAXZ{X}\nif (index{X}>=0)\n#endif\n{\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nshadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nshadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];\n#endif\n#ifndef SHADOWCSMNOBLEND{X}\nfloat frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)\n{index{X}+=1;float nextShadow=0.;\n#if defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nnextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#elif defined(SHADOWMEDIUMQUALITY{X})\nnextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#else\nnextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});\n#endif\n#else\nnextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\nshadow=mix(nextShadow,shadow,diffRatio);\n#ifdef SHADOWCSMDEBUG{X}\nshadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);\n#endif\n}\n#endif\n}\n#elif defined(SHADOWCLOSEESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;shadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\naggShadow+=shadow;numLights+=1.0;\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor.rgb*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifndef LIGHTMAPNOSPECULAR{X}\nclearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;\n#endif\n#endif\n#ifdef SHEEN\n#ifndef LIGHTMAPNOSPECULAR{X}\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#else\n#ifdef SHADOWCSMDEBUG{X}\ndiffuseBase+=info.diffuse*shadowDebug{X};\n#else \ndiffuseBase+=info.diffuse*shadow;\n#endif\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#ifdef CLEARCOAT\nclearCoatBase+=info.clearCoat.rgb*shadow;\n#endif\n#ifdef SHEEN\nsheenBase+=info.sheen.rgb*shadow;\n#endif\n#endif\n#endif\n#endif\n";F.IncludesShadersStore.logDepthFragment="#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif\n";F.IncludesShadersStore.fogFragment="#ifdef FOG\nfloat fog=CalcFogFactor();\n#ifdef PBR\nfog=toLinearSpace(fog);\n#endif\ncolor.rgb=mix(vFogColor,color.rgb,fog);\n#endif\n";F.IncludesShadersStore.oitFragment="#ifdef ORDER_INDEPENDENT_TRANSPARENCY\nfloat fragDepth=gl_FragCoord.z; \n#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS\nuint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;\n#endif\nivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);\n#ifdef USE_REVERSE_DEPTHBUFFER\nfloat furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;\n#else\nfloat nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;\n#endif\nfloat alphaMultiplier=1.0-lastFrontColor.a;\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth>nearestDepth || fragDepth<furthestDepth) {\n#else\nif (fragDepth<nearestDepth || fragDepth>furthestDepth) {\n#endif\nreturn;}\n#ifdef USE_REVERSE_DEPTHBUFFER\nif (fragDepth<nearestDepth && fragDepth>furthestDepth) {\n#else\nif (fragDepth>nearestDepth && fragDepth<furthestDepth) {\n#endif\ndepth.rg=vec2(-fragDepth,fragDepth);return;}\n#endif\n";F.ShadersStore.defaultPixelShader="#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\n#include<oitDeclaration>\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULARTERM)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)\n#endif\n#include<fresnelFunction>\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#include<depthPrePass>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nbaseColor.rgb*=vColor.rgb;\n#endif\n#ifdef DETAIL\nbaseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);\n#endif\n#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;float aggShadow=0.;float numLights=0.;\n#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\naggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\n#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);\n#endif\n#ifdef RGBDREFRACTION\nrefractionColor.rgb=fromRGBD(refractionColor);\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor.rgb=toGammaSpace(refractionColor.rgb);\n#endif\nrefractionColor.rgb*=vRefractionInfos.x;\n#endif\nvec4 reflectionColor=vec4(0.,0.,0.,1.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nvReflectionUVW.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor.rgb=toGammaSpace(reflectionColor.rgb);\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n#ifdef ALPHATEST\n#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS\nif (alpha<alphaCutOff)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor.rgb;\n#else\ncolor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);\n#endif\n#endif\ncolor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;gl_FragData[0]=color; \n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_IRRADIANCE\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo); \n#else\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); \n#endif\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(SPECULARTERM)\n#if defined(SPECULAR)\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; \n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;\n#endif\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=color;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";F.IncludesShadersStore.decalVertexDeclaration="#ifdef DECAL\nuniform vec4 vDecalInfos;uniform mat4 decalMatrix;\n#endif\n";F.IncludesShadersStore.defaultVertexDeclaration="uniform mat4 viewProjection;uniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;uniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef REFLECTION\nuniform mat4 reflectionMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n";F.IncludesShadersStore.uvAttributeDeclaration="#ifdef UV{X}\nattribute vec2 uv{X};\n#endif\n";F.IncludesShadersStore.prePassVertexDeclaration="#ifdef PREPASS\n#ifdef PREPASS_DEPTH\nvarying vec3 vViewPos;\n#endif\n#ifdef PREPASS_VELOCITY\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#endif\n";F.IncludesShadersStore.samplerVertexDeclaration="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n";F.IncludesShadersStore.bumpVertexDeclaration="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n";F.IncludesShadersStore.fogVertexDeclaration="#ifdef FOG\nvarying vec3 vFogDistance;\n#endif\n";F.IncludesShadersStore.lightVxFragmentDeclaration="#ifdef LIGHT{X}\nuniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec4 vLightSpecular{X};\n#else\nvec4 vLightSpecular{X}=vec4(0.);\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};\n#elif defined(POINTLIGHT{X})\nuniform vec4 vLightFalloff{X};\n#elif defined(HEMILIGHT{X})\nuniform vec3 vLightGround{X};\n#endif\n#endif\n";F.IncludesShadersStore.lightVxUboDeclaration="#ifdef LIGHT{X}\nuniform Light{X}\n{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;vec4 vLightFalloff;\n#elif defined(POINTLIGHT{X})\nvec4 vLightFalloff;\n#elif defined(HEMILIGHT{X})\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;vec2 depthValues;} light{X};\n#ifdef SHADOW{X}\n#ifdef SHADOWCSM{X}\nuniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};\n#elif defined(SHADOWCUBE{X})\n#else\nvarying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif\n";F.IncludesShadersStore.prePassVertex="#ifdef PREPASS_DEPTH\nvViewPos=(view*worldPos).rgb;\n#endif\n#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*worldPos;\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n";F.IncludesShadersStore.uvVariableDeclaration="#if !defined(UV{X}) && defined(MAINUV{X})\nvec2 uv{X}=vec2(0.,0.);\n#endif\n#ifdef MAINUV{X}\nvMainUV{X}=uv{X};\n#endif\n";F.IncludesShadersStore.samplerVertexImplementation="#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0\nif (v_INFONAME_==0.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}\n#ifdef UV2\nelse if (v_INFONAME_==1.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));}\n#endif\n#ifdef UV3\nelse if (v_INFONAME_==2.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}\n#endif\n#ifdef UV4\nelse if (v_INFONAME_==3.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}\n#endif\n#ifdef UV5\nelse if (v_INFONAME_==4.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}\n#endif\n#ifdef UV6\nelse if (v_INFONAME_==5.)\n{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}\n#endif\n#endif\n";F.IncludesShadersStore.bumpVertex="#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif\n";F.IncludesShadersStore.fogVertex="#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif\n";F.IncludesShadersStore.shadowsVertex="#ifdef SHADOWS\n#if defined(SHADOWCSM{X})\nvPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n}\n#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#ifdef USE_REVERSE_DEPTHBUFFER\nvDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#else\nvDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;\n#endif\n#endif\n#endif\n";F.IncludesShadersStore.vertexColorMixing="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvColor=vec4(1.0);\n#ifdef VERTEXCOLOR\n#ifdef VERTEXALPHA\nvColor*=color;\n#else\nvColor.rgb*=color.rgb;\n#endif\n#endif\n#ifdef INSTANCESCOLOR\nvColor*=instanceColor;\n#endif\n#endif\n";F.IncludesShadersStore.logDepthVertex="#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif\n";F.ShadersStore.defaultVertexShader="#include<__decl__defaultVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<mainUVVaryingDeclaration>[1..7]\n#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#if defined(SPECULARTERM)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)\n#endif\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\nvPositionW=vec3(worldPos);\n#include<prePassVertex>\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#if defined(SPECULARTERM)\n#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)\n#endif\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";const Ds=new RegExp("^([gimus]+)!");class Ns{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const t=e.getClassName();Ns._MaterialPluginClassToMainDefine[t]||(Ns._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++Ns._MaterialPluginCounter),this._material._callbackPluginEventGeneric=(e,t)=>this._handlePluginEvent(e,t),this._plugins.push(e),this._plugins.sort(((e,t)=>e.priority-t.priority)),this._codeInjectionPoints={};const i={};i[Ns._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const e of this._plugins)e.collectDefines(i),this._collectPointNames("vertex",e.getCustomCode("vertex")),this._collectPointNames("fragment",e.getCustomCode("fragment"));return this._defineNamesFromPlugins=i,!0}_activatePlugin(e){-1===this._activePlugins.indexOf(e)&&(this._activePlugins.push(e),this._activePlugins.sort(((e,t)=>e.priority-t.priority)),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort(((e,t)=>e.priority-t.priority)),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const e of this._activePluginsForExtraEvents)if(t=e.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){var i;switch(e){case Rs.GetActiveTextures:{const e=t;for(const t of this._activePlugins)t.getActiveTextures(e.activeTextures);break}case Rs.GetAnimatables:{const e=t;for(const t of this._activePlugins)t.getAnimatables(e.animatables);break}case Rs.HasTexture:{const e=t;let i=!1;for(const t of this._activePlugins)if(i=t.hasTexture(e.texture),i)break;e.hasTexture=i;break}case Rs.Disposed:{const e=t;for(const t of this._plugins)t.dispose(e.forceDisposeTextures);break}case Rs.GetDefineNames:t.defineNames=this._defineNamesFromPlugins;break;case Rs.PrepareEffect:{const e=t;for(const t of this._activePlugins)e.fallbackRank=t.addFallbacks(e.defines,e.fallbacks,e.fallbackRank),t.getAttributes(e.attributes,this._scene,e.mesh);this._uniformList.length>0&&e.uniforms.push(...this._uniformList),this._samplerList.length>0&&e.samplers.push(...this._samplerList),this._uboList.length>0&&e.uniformBuffersNames.push(...this._uboList),e.customCode=this._injectCustomCode(e,e.customCode);break}case Rs.PrepareUniformBuffer:{const e=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const t of this._plugins){const s=t.getUniforms();if(s){if(s.ubo)for(const t of s.ubo){if(t.size&&t.type){const s=null!==(i=t.arraySize)&&void 0!==i?i:0;e.ubo.addUniform(t.name,t.size,s),this._uboDeclaration+=`${t.type} ${t.name}${s>0?`[${s}]`:""};\n`}this._uniformList.push(t.name)}s.vertex&&(this._vertexDeclaration+=s.vertex+"\n"),s.fragment&&(this._fragmentDeclaration+=s.fragment+"\n")}t.getSamplers(this._samplerList),t.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e,t){return(i,s)=>{var n,r;t&&(s=t(i,s)),this._uboDeclaration&&(s=s.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(s=s.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(s=s.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const o=null===(n=this._codeInjectionPoints)||void 0===n?void 0:n[i];if(!o)return s;let a=null;for(let t in o){let n="";for(const s of this._activePlugins){let o=null===(r=s.getCustomCode(i))||void 0===r?void 0:r[t];if(o){if(s.resolveIncludes){if(null===a){const t=y.GLSL;a={defines:[],indexParameters:e.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:F.GetShadersRepository(t),includesShadersStore:F.GetIncludesShadersStore(t),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}}a.isFragment="fragment"===i,N._ProcessIncludes(o,a,(e=>o=e))}n+=o+"\n"}}if(n.length>0)if("!"===t.charAt(0)){t=t.substring(1);let e="g";if("!"===t.charAt(0))e="",t=t.substring(1);else{const i=Ds.exec(t);i&&i.length>=2&&(e=i[1],t=t.substring(e.length+1))}e.indexOf("g")<0&&(e+="g");const i=s,r=new RegExp(t,e);let o=r.exec(i);for(;null!==o;){let e=n;for(let t=0;t<o.length;++t)e=e.replace("$"+t,o[t]);s=s.replace(o[0],e),o=r.exec(i)}}else{const e="#define "+t;s=s.replace(e,"\n"+n+"\n"+e)}}return s}}}Ns._MaterialPluginClassToMainDefine={},Ns._MaterialPluginCounter=0,u.OnEnginesDisposedObservable.add((()=>{Fs.length=0,Ls=!1,Ps.OnEventObservable.remove(ws),ws=null}));const Fs=[];let Ls=!1,ws=null;class Bs{_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,s,n=!0,r=!1,o=!1){this.priority=500,this.resolveIncludes=!1,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,this.resolveIncludes=o,e.pluginManager||(e.pluginManager=new Ns(e),e.onDisposeObservable.add((()=>{e.pluginManager=void 0}))),this._pluginDefineNames=s,this._pluginManager=e.pluginManager,n&&this._pluginManager._addPlugin(this),r&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,s){return!0}hardBindForSubMesh(e,t,i,s){}bindForSubMesh(e,t,i,s){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if("_"===t[0])continue;const i=typeof this._pluginDefineNames[t];e[t]={type:"number"===i?"number":"string"===i?"string":"boolean"===i?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){qe.Clone((()=>e),this)}serialize(){return qe.Serialize(this)}parse(e,t,i){qe.Parse((()=>this),e,t,i)}}De([Ge()],Bs.prototype,"name",void 0),De([Ge()],Bs.prototype,"priority",void 0),De([Ge()],Bs.prototype,"resolveIncludes",void 0),De([Ge()],Bs.prototype,"registerForExtraEvents",void 0);class Us extends Wt{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class ks extends Bs{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DetailMap",140,new Us,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=Ps.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&Os.DetailTextureEnabled&&!this._texture.isReady())}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&Os.DetailTextureEnabled&&this._isEnabled?(wi.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||this._texture&&Os.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),wi.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&Os.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&(null===(t=this._texture)||void 0===t||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}De([ze("detailTexture"),Ve("_markAllSubMeshesAsTexturesDirty")],ks.prototype,"texture",void 0),De([Ge()],ks.prototype,"diffuseBlendLevel",void 0),De([Ge()],ks.prototype,"roughnessBlendLevel",void 0),De([Ge()],ks.prototype,"bumpLevel",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],ks.prototype,"normalBlendMethod",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],ks.prototype,"isEnabled",void 0);const Vs={effect:null,subMesh:null};class Gs extends Wt{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class zs extends Ms{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new Re(0,0,0),this.diffuseColor=new Re(1,1,1),this.specularColor=new Re(1,1,1),this.emissiveColor=new Re(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._renderTargets=new wt(16),this._worldViewProjectionMatrix=Te.Zero(),this._globalAmbientColor=new Re(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new ks(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Es,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),zs.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),zs.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return!!(zs.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||!!(zs.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled)}needAlphaTesting(){return!!this._forceAlphaTest||this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===Ps.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==Ps.MATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Rs.GetDefineNames,this._eventInfo),t.materialDefines=new Gs(this._eventInfo.defineNames));const s=this.getScene(),n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const r=s.getEngine();n._needNormals=wi.PrepareDefinesForLights(s,e,n,!0,this._maxSimultaneousLights,this._disableLighting),wi.PrepareDefinesForMultiview(s,n);const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(wi.PrepareDefinesForPrePass(s,n,this.canRenderToMRT&&!o),wi.PrepareDefinesForOIT(s,n,o),n._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n._needUVs=!1;for(let e=1;e<=6;++e)n["MAINUV"+e]=!1;if(s.texturesEnabled){if(n.DIFFUSEDIRECTUV=0,n.BUMPDIRECTUV=0,n.AMBIENTDIRECTUV=0,n.OPACITYDIRECTUV=0,n.EMISSIVEDIRECTUV=0,n.SPECULARDIRECTUV=0,n.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&zs.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;wi.PrepareDefinesForMergedUV(this._diffuseTexture,n,"DIFFUSE")}else n.DIFFUSE=!1;if(this._ambientTexture&&zs.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return!1;wi.PrepareDefinesForMergedUV(this._ambientTexture,n,"AMBIENT")}else n.AMBIENT=!1;if(this._opacityTexture&&zs.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return!1;wi.PrepareDefinesForMergedUV(this._opacityTexture,n,"OPACITY"),n.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else n.OPACITY=!1;if(this._reflectionTexture&&zs.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking())return!1;switch(n._needNormals=!0,n.REFLECTION=!0,n.ROUGHNESS=this._roughness>0,n.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,n.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===zi.INVCUBIC_MODE,n.REFLECTIONMAP_3D=this._reflectionTexture.isCube,n.REFLECTIONMAP_OPPOSITEZ=n.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,n.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case zi.EXPLICIT_MODE:n.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case zi.PLANAR_MODE:n.setReflectionMode("REFLECTIONMAP_PLANAR");break;case zi.PROJECTION_MODE:n.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case zi.SKYBOX_MODE:n.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case zi.SPHERICAL_MODE:n.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case zi.EQUIRECTANGULAR_MODE:n.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case zi.FIXED_EQUIRECTANGULAR_MODE:n.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case zi.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case zi.CUBIC_MODE:case zi.INVCUBIC_MODE:default:n.setReflectionMode("REFLECTIONMAP_CUBIC")}n.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else n.REFLECTION=!1,n.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&zs.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;wi.PrepareDefinesForMergedUV(this._emissiveTexture,n,"EMISSIVE")}else n.EMISSIVE=!1;if(this._lightmapTexture&&zs.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;wi.PrepareDefinesForMergedUV(this._lightmapTexture,n,"LIGHTMAP"),n.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,n.RGBDLIGHTMAP=this._lightmapTexture.isRGBD}else n.LIGHTMAP=!1;if(this._specularTexture&&zs.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return!1;wi.PrepareDefinesForMergedUV(this._specularTexture,n,"SPECULAR"),n.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}else n.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&zs.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;wi.PrepareDefinesForMergedUV(this._bumpTexture,n,"BUMP"),n.PARALLAX=this._useParallax,n.PARALLAX_RHS=s.useRightHandedSystem,n.PARALLAXOCCLUSION=this._useParallaxOcclusion,n.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else n.BUMP=!1,n.PARALLAX=!1,n.PARALLAX_RHS=!1,n.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&zs.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return!1;n._needUVs=!0,n.REFRACTION=!0,n.REFRACTIONMAP_3D=this._refractionTexture.isCube,n.RGBDREFRACTION=this._refractionTexture.isRGBD,n.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize}else n.REFRACTION=!1;n.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else n.DIFFUSE=!1,n.AMBIENT=!1,n.OPACITY=!1,n.REFLECTION=!1,n.EMISSIVE=!1,n.LIGHTMAP=!1,n.BUMP=!1,n.REFRACTION=!1;n.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),n.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,n.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,n.SPECULAROVERALPHA=this._useSpecularOverAlpha,n.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,n.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,n.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(n._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(n),n.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,n.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}n._areFresnelDirty&&(zs.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(n.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,n.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,n.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,n.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,n.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,n.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,n._needNormals=!0,n.FRESNEL=!0):n.FRESNEL=!1),wi.PrepareDefinesForMisc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,n,this._applyDecalMapAfterDetailMap),wi.PrepareDefinesForFrameBoundValues(s,r,this,n,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=n,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),wi.PrepareDefinesForAttributes(e,n,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let a=!1;if(n.isDirty){const i=n._areLightsDisposed;n.markAsProcessed();const o=new is;n.REFLECTION&&o.addFallback(0,"REFLECTION"),n.SPECULAR&&o.addFallback(0,"SPECULAR"),n.BUMP&&o.addFallback(0,"BUMP"),n.PARALLAX&&o.addFallback(1,"PARALLAX"),n.PARALLAX_RHS&&o.addFallback(1,"PARALLAX_RHS"),n.PARALLAXOCCLUSION&&o.addFallback(0,"PARALLAXOCCLUSION"),n.SPECULAROVERALPHA&&o.addFallback(0,"SPECULAROVERALPHA"),n.FOG&&o.addFallback(1,"FOG"),n.POINTSIZE&&o.addFallback(0,"POINTSIZE"),n.LOGARITHMICDEPTH&&o.addFallback(0,"LOGARITHMICDEPTH"),wi.HandleFallbacksForShadows(n,o,this._maxSimultaneousLights),n.SPECULARTERM&&o.addFallback(0,"SPECULARTERM"),n.DIFFUSEFRESNEL&&o.addFallback(1,"DIFFUSEFRESNEL"),n.OPACITYFRESNEL&&o.addFallback(2,"OPACITYFRESNEL"),n.REFLECTIONFRESNEL&&o.addFallback(3,"REFLECTIONFRESNEL"),n.EMISSIVEFRESNEL&&o.addFallback(4,"EMISSIVEFRESNEL"),n.FRESNEL&&o.addFallback(4,"FRESNEL"),n.MULTIVIEW&&o.addFallback(0,"MULTIVIEW");const l=[Oe.PositionKind];n.NORMAL&&l.push(Oe.NormalKind),n.TANGENT&&l.push(Oe.TangentKind);for(let e=1;e<=6;++e)n["UV"+e]&&l.push(`uv${1===e?"":e}`);n.VERTEXCOLOR&&l.push(Oe.ColorKind),wi.PrepareAttributesForBones(l,e,n,o),wi.PrepareAttributesForInstances(l,n),wi.PrepareAttributesForMorphTargets(l,e,n),wi.PrepareAttributesForBakedVertexAnimation(l,e,n);let h="default";const c=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],d=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],u=["Material","Scene","Mesh"],_={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=o,this._eventInfo.fallbackRank=0,this._eventInfo.defines=n,this._eventInfo.uniforms=c,this._eventInfo.attributes=l,this._eventInfo.samplers=d,this._eventInfo.uniformBuffersNames=u,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=_,this._callbackPluginEventGeneric(Rs.PrepareEffect,this._eventInfo),Es.AddUniforms(c),Es.AddSamplers(d),Yt&&(Yt.PrepareUniforms(c,n),Yt.PrepareSamplers(d,n)),wi.PrepareUniformsAndSamplersList({uniformsNames:c,uniformBuffersNames:u,samplers:d,defines:n,maxSimultaneousLights:this._maxSimultaneousLights}),Di(c);const f={};this.customShaderNameResolve&&(h=this.customShaderNameResolve(h,c,u,d,n,l,f));const p=n.toString(),m=t.effect;let g=s.getEngine().createEffect(h,{attributes:l,uniformsNames:c,uniformBuffersNames:u,samplers:d,defines:p,fallbacks:o,onCompiled:this.onCompiled,onError:this.onError,indexParameters:_,processFinalCode:f.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:n.PREPASS},r);if(this._eventInfo.customCode=void 0,g)if(this._onEffectCreatedObservable&&(Vs.effect=g,Vs.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Vs)),this.allowShaderHotSwapping&&m&&!g.isReady()){if(g=m,n.markAsUnprocessed(),a=this.isFrozen,i)return n._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(g,n,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(n._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!a,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s;const n=this.getScene(),r=i.materialDefines;if(!r)return;const o=i.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,n,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),r.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const a=o._forceRebindOnNextCall||this._mustRebind(n,o,t.visibility);wi.BindBonesParameters(t,o);const l=this._uniformBuffer;if(a){if(this.bindViewProjection(o),!l.useUbo||!this.isFrozen||!l.isSync||o._forceRebindOnNextCall){if(zs.FresnelEnabled&&r.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(l.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),l.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&l.updateColor4("opacityParts",new Re(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(l.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),l.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(l.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),l.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(l.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),l.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),n.texturesEnabled){if(this._diffuseTexture&&zs.DiffuseTextureEnabled&&(l.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),wi.BindTextureMatrix(this._diffuseTexture,l,"diffuse")),this._ambientTexture&&zs.AmbientTextureEnabled&&(l.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),wi.BindTextureMatrix(this._ambientTexture,l,"ambient")),this._opacityTexture&&zs.OpacityTextureEnabled&&(l.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),wi.BindTextureMatrix(this._opacityTexture,l,"opacity")),this._hasAlphaChannel()&&l.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&zs.ReflectionTextureEnabled&&(l.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),l.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const e=this._reflectionTexture;l.updateVector3("vReflectionPosition",e.boundingBoxPosition),l.updateVector3("vReflectionSize",e.boundingBoxSize)}if(this._emissiveTexture&&zs.EmissiveTextureEnabled&&(l.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),wi.BindTextureMatrix(this._emissiveTexture,l,"emissive")),this._lightmapTexture&&zs.LightmapTextureEnabled&&(l.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),wi.BindTextureMatrix(this._lightmapTexture,l,"lightmap")),this._specularTexture&&zs.SpecularTextureEnabled&&(l.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),wi.BindTextureMatrix(this._specularTexture,l,"specular")),this._bumpTexture&&n.getEngine().getCaps().standardDerivatives&&zs.BumpTextureEnabled&&(l.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),wi.BindTextureMatrix(this._bumpTexture,l,"bump"),n._mirroredCameraPosition?l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&zs.RefractionTextureEnabled){let e=1;if(this._refractionTexture.isCube||(l.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(e=this._refractionTexture.depth)),l.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,e,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const e=this._refractionTexture;l.updateVector3("vRefractionPosition",e.boundingBoxPosition),l.updateVector3("vRefractionSize",e.boundingBoxSize)}}}this.pointsCloud&&l.updateFloat("pointSize",this.pointSize),r.SPECULARTERM&&l.updateColor4("vSpecularColor",this.specularColor,this.specularPower),l.updateColor3("vEmissiveColor",zs.EmissiveTextureEnabled?this.emissiveColor:Re.BlackReadOnly),l.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),n.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),l.updateColor3("vAmbientColor",this._globalAmbientColor)}n.texturesEnabled&&(this._diffuseTexture&&zs.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&zs.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&zs.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&zs.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&zs.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&zs.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&zs.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&n.getEngine().getCaps().standardDerivatives&&zs.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&zs.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Fi(o,this,n),this.bindEyePosition(o)}else n.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);!a&&this.isFrozen||(n.lightsEnabled&&!this._disableLighting&&wi.BindLights(n,t,o,r,this._maxSimultaneousLights),(n.fogEnabled&&t.applyFog&&n.fogMode!==Oi.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||r.PREPASS)&&this.bindView(o),wi.BindFogParameters(n,t,o),r.NUM_MORPH_INFLUENCERS&&wi.BindMorphTargetParameters(t,o),r.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(s=t.bakedVertexAnimationManager)||void 0===s||s.bind(o,r.INSTANCES)),this.useLogarithmicDepth&&wi.BindLogDepth(r,o,n),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),l.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e}dispose(e,t){var i,s,n,r,o,a,l,h,c;t&&(null===(i=this._diffuseTexture)||void 0===i||i.dispose(),null===(s=this._ambientTexture)||void 0===s||s.dispose(),null===(n=this._opacityTexture)||void 0===n||n.dispose(),null===(r=this._reflectionTexture)||void 0===r||r.dispose(),null===(o=this._emissiveTexture)||void 0===o||o.dispose(),null===(a=this._specularTexture)||void 0===a||a.dispose(),null===(l=this._bumpTexture)||void 0===l||l.dispose(),null===(h=this._lightmapTexture)||void 0===h||h.dispose(),null===(c=this._refractionTexture)||void 0===c||c.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){const s=qe.Clone((()=>new zs(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return s.name=e,s.id=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}static Parse(e,t,i){const s=qe.Parse((()=>new zs(e.name,t)),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),Ps._parsePlugins(e,s,t,i),s}static get DiffuseTextureEnabled(){return Os.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){Os.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return Os.DetailTextureEnabled}static set DetailTextureEnabled(e){Os.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return Os.AmbientTextureEnabled}static set AmbientTextureEnabled(e){Os.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return Os.OpacityTextureEnabled}static set OpacityTextureEnabled(e){Os.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return Os.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){Os.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return Os.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){Os.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return Os.SpecularTextureEnabled}static set SpecularTextureEnabled(e){Os.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return Os.BumpTextureEnabled}static set BumpTextureEnabled(e){Os.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return Os.LightmapTextureEnabled}static set LightmapTextureEnabled(e){Os.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return Os.RefractionTextureEnabled}static set RefractionTextureEnabled(e){Os.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return Os.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){Os.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return Os.FresnelEnabled}static set FresnelEnabled(e){Os.FresnelEnabled=e}}De([ze("diffuseTexture")],zs.prototype,"_diffuseTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesAndMiscDirty")],zs.prototype,"diffuseTexture",void 0),De([ze("ambientTexture")],zs.prototype,"_ambientTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"ambientTexture",void 0),De([ze("opacityTexture")],zs.prototype,"_opacityTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesAndMiscDirty")],zs.prototype,"opacityTexture",void 0),De([ze("reflectionTexture")],zs.prototype,"_reflectionTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"reflectionTexture",void 0),De([ze("emissiveTexture")],zs.prototype,"_emissiveTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"emissiveTexture",void 0),De([ze("specularTexture")],zs.prototype,"_specularTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"specularTexture",void 0),De([ze("bumpTexture")],zs.prototype,"_bumpTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"bumpTexture",void 0),De([ze("lightmapTexture")],zs.prototype,"_lightmapTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"lightmapTexture",void 0),De([ze("refractionTexture")],zs.prototype,"_refractionTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"refractionTexture",void 0),De([He("ambient")],zs.prototype,"ambientColor",void 0),De([He("diffuse")],zs.prototype,"diffuseColor",void 0),De([He("specular")],zs.prototype,"specularColor",void 0),De([He("emissive")],zs.prototype,"emissiveColor",void 0),De([Ge()],zs.prototype,"specularPower",void 0),De([Ge("useAlphaFromDiffuseTexture")],zs.prototype,"_useAlphaFromDiffuseTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesAndMiscDirty")],zs.prototype,"useAlphaFromDiffuseTexture",void 0),De([Ge("useEmissiveAsIllumination")],zs.prototype,"_useEmissiveAsIllumination",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"useEmissiveAsIllumination",void 0),De([Ge("linkEmissiveWithDiffuse")],zs.prototype,"_linkEmissiveWithDiffuse",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"linkEmissiveWithDiffuse",void 0),De([Ge("useSpecularOverAlpha")],zs.prototype,"_useSpecularOverAlpha",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"useSpecularOverAlpha",void 0),De([Ge("useReflectionOverAlpha")],zs.prototype,"_useReflectionOverAlpha",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"useReflectionOverAlpha",void 0),De([Ge("disableLighting")],zs.prototype,"_disableLighting",void 0),De([Ve("_markAllSubMeshesAsLightsDirty")],zs.prototype,"disableLighting",void 0),De([Ge("useObjectSpaceNormalMap")],zs.prototype,"_useObjectSpaceNormalMap",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"useObjectSpaceNormalMap",void 0),De([Ge("useParallax")],zs.prototype,"_useParallax",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"useParallax",void 0),De([Ge("useParallaxOcclusion")],zs.prototype,"_useParallaxOcclusion",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"useParallaxOcclusion",void 0),De([Ge()],zs.prototype,"parallaxScaleBias",void 0),De([Ge("roughness")],zs.prototype,"_roughness",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"roughness",void 0),De([Ge()],zs.prototype,"indexOfRefraction",void 0),De([Ge()],zs.prototype,"invertRefractionY",void 0),De([Ge()],zs.prototype,"alphaCutOff",void 0),De([Ge("useLightmapAsShadowmap")],zs.prototype,"_useLightmapAsShadowmap",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"useLightmapAsShadowmap",void 0),De([We("diffuseFresnelParameters")],zs.prototype,"_diffuseFresnelParameters",void 0),De([Ve("_markAllSubMeshesAsFresnelDirty")],zs.prototype,"diffuseFresnelParameters",void 0),De([We("opacityFresnelParameters")],zs.prototype,"_opacityFresnelParameters",void 0),De([Ve("_markAllSubMeshesAsFresnelAndMiscDirty")],zs.prototype,"opacityFresnelParameters",void 0),De([We("reflectionFresnelParameters")],zs.prototype,"_reflectionFresnelParameters",void 0),De([Ve("_markAllSubMeshesAsFresnelDirty")],zs.prototype,"reflectionFresnelParameters",void 0),De([We("refractionFresnelParameters")],zs.prototype,"_refractionFresnelParameters",void 0),De([Ve("_markAllSubMeshesAsFresnelDirty")],zs.prototype,"refractionFresnelParameters",void 0),De([We("emissiveFresnelParameters")],zs.prototype,"_emissiveFresnelParameters",void 0),De([Ve("_markAllSubMeshesAsFresnelDirty")],zs.prototype,"emissiveFresnelParameters",void 0),De([Ge("useReflectionFresnelFromSpecular")],zs.prototype,"_useReflectionFresnelFromSpecular",void 0),De([Ve("_markAllSubMeshesAsFresnelDirty")],zs.prototype,"useReflectionFresnelFromSpecular",void 0),De([Ge("useGlossinessFromSpecularMapAlpha")],zs.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"useGlossinessFromSpecularMapAlpha",void 0),De([Ge("maxSimultaneousLights")],zs.prototype,"_maxSimultaneousLights",void 0),De([Ve("_markAllSubMeshesAsLightsDirty")],zs.prototype,"maxSimultaneousLights",void 0),De([Ge("invertNormalMapX")],zs.prototype,"_invertNormalMapX",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"invertNormalMapX",void 0),De([Ge("invertNormalMapY")],zs.prototype,"_invertNormalMapY",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"invertNormalMapY",void 0),De([Ge("twoSidedLighting")],zs.prototype,"_twoSidedLighting",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],zs.prototype,"twoSidedLighting",void 0),De([Ge("applyDecalMapAfterDetailMap")],zs.prototype,"_applyDecalMapAfterDetailMap",void 0),De([Ve("_markAllSubMeshesAsMiscDirty")],zs.prototype,"applyDecalMapAfterDetailMap",void 0),ue("BABYLON.StandardMaterial",zs),Oi.DefaultMaterialFactory=e=>new zs("default material",e);F.ShadersStore.rgbdDecodePixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}";F.ShadersStore.passCubePixelShader="varying vec2 vUV;uniform samplerCube textureSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec2 uv=vUV*2.0-1.0;\n#ifdef POSITIVEX\ngl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));\n#endif\n#ifdef NEGATIVEX\ngl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));\n#endif\n#ifdef POSITIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));\n#endif\n#ifdef NEGATIVEY\ngl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));\n#endif\n#ifdef POSITIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,1.001));\n#endif\n#ifdef NEGATIVEZ\ngl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));\n#endif\n}";class Hs extends es{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,s,n,r,o=0,a=!1){super(e,"pass",null,null,t,i,s,n,r,void 0,o,void 0,null,a)}static _Parse(e,t,i,s){return qe.Parse((()=>new Hs(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable)),e,i,s)}}let Ws,Xs;function Qs(e){Ws||(Ws=new Float32Array(1),Xs=new Int32Array(Ws.buffer)),Ws[0]=e;const t=Xs[0];let i=t>>16&32768,s=t>>12&2047;const n=t>>23&255;return n<103?i:n>142?(i|=31744,i|=(255==n?0:1)&&8388607&t,i):n<113?(s|=2048,i|=(s>>114-n)+(s>>113-n&1),i):(i|=n-112<<10|s>>1,i+=1&s,i)}function Ys(e){const t=(32768&e)>>15,i=(31744&e)>>10,s=1023&e;return 0===i?(t?-1:1)*Math.pow(2,-14)*(s/Math.pow(2,10)):31==i?s?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,i-15)*(1+s/Math.pow(2,10))}ue("BABYLON.PassPostProcess",Hs),te._RescalePostProcessFactory=e=>new Hs("rescale",1,null,2,e,!1,0);class Ks{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),s=i.getCaps(),n=t.isReady;let r=!1;s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(r=!0,t.type=2):s.textureFloatRender&&s.textureFloatLinearFiltering&&(r=!0,t.type=1),r&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const o=()=>{if(r){const s=new es("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1);s.externalTextureSamplerBinding=!0;const n=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});s.getEffect().executeWhenCompiled((()=>{s.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([s],n,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),s&&s.dispose(),n._swapAndDie(t),t.isReady=!0}))}};n?o():e.onLoadObservable.addOnce(o)}static EncodeTextureToRGBD(e,t,i=0){return function(e,t,i,s,n,r,o,a){const l=t.getEngine();return t.isReady=!1,n=null!=n?n:t.samplingMode,s=null!=s?s:t.type,r=null!=r?r:t.format,o=null!=o?o:t.width,a=null!=a?a:t.height,-1===s&&(s=0),new Promise((h=>{const c=new es("postprocess",e,null,null,1,null,n,l,!1,void 0,s,void 0,null,!1,r);c.externalTextureSamplerBinding=!0;const d=l.createRenderTargetTexture({width:o,height:a},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:n,type:s,format:r});c.getEffect().executeWhenCompiled((()=>{c.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},i.postProcessManager.directRender([c],d,!0),l.restoreDefaultFramebuffer(),l._releaseTexture(t),c&&c.dispose(),d._swapAndDie(t),t.type=s,t.format=5,t.isReady=!0,h(t)}))}))}("rgbdEncode",e,t,i,1,5)}}let js=0;const $s=e=>{if(!e.environmentBRDFTexture){const t=e.useDelayedTextureLoading;e.useDelayedTextureLoading=!1;const i=e._blockEntityCollection;e._blockEntityCollection=!1;const s=zi.CreateFromBase64String("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==","EnvironmentBRDFTexture"+js++,e,!0,!1,zi.BILINEAR_SAMPLINGMODE);e._blockEntityCollection=i;const n=e.getEngine().getLoadedTexturesCache(),r=n.indexOf(s.getInternalTexture());-1!==r&&n.splice(r,1),s.isRGBD=!0,s.wrapU=zi.CLAMP_ADDRESSMODE,s.wrapV=zi.CLAMP_ADDRESSMODE,e.environmentBRDFTexture=s,e.useDelayedTextureLoading=t,Ks.ExpandRGBDTexture(s);const o=e.getEngine().onContextRestoredObservable.add((()=>{s.isRGBD=!0;const e=()=>{s.isReady()?Ks.ExpandRGBDTexture(s):Ot.SetImmediate(e)};e()}));e.onDisposeObservable.add((()=>{e.getEngine().onContextRestoredObservable.remove(o)}))}return e.environmentBRDFTexture};class qs extends Wt{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class Zs extends Bs{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRBRDF",90,new qs,t),this._useEnergyConservation=Zs.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Zs.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=Zs.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Zs.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=Zs.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Zs.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=Zs.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Zs.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}var Js,en,tn,sn;Zs.DEFAULT_USE_ENERGY_CONSERVATION=!0,Zs.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,Zs.DEFAULT_USE_SPHERICAL_HARMONICS=!0,Zs.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,De([Ge(),Ve("_markAllSubMeshesAsMiscDirty")],Zs.prototype,"useEnergyConservation",void 0),De([Ge(),Ve("_markAllSubMeshesAsMiscDirty")],Zs.prototype,"useSmithVisibilityHeightCorrelated",void 0),De([Ge(),Ve("_markAllSubMeshesAsMiscDirty")],Zs.prototype,"useSphericalHarmonics",void 0),De([Ge(),Ve("_markAllSubMeshesAsMiscDirty")],Zs.prototype,"useSpecularGlossinessInputEnergyConservation",void 0),(sn=Js||(Js={}))[sn.LOCAL=0]="LOCAL",sn[sn.WORLD=1]="WORLD",sn[sn.BONE=2]="BONE";class nn{}nn.X=new me(1,0,0),nn.Y=new me(0,1,0),nn.Z=new me(0,0,1),function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(en||(en={})),function(e){e[e.CW=0]="CW",e[e.CCW=1]="CCW"}(tn||(tn={}));class rn{static CreateQuadraticBezier(e,t,i,s){s=s>2?s:3;const n=[],r=(e,t,i,s)=>(1-e)*(1-e)*t+2*e*(1-e)*i+e*e*s;for(let o=0;o<=s;o++)n.push(new me(r(o/s,e.x,t.x,i.x),r(o/s,e.y,t.y,i.y),r(o/s,e.z,t.z,i.z)));return new rn(n)}static CreateCubicBezier(e,t,i,s,n){n=n>3?n:4;const r=[],o=(e,t,i,s,n)=>(1-e)*(1-e)*(1-e)*t+3*e*(1-e)*(1-e)*i+3*e*e*(1-e)*s+e*e*e*n;for(let a=0;a<=n;a++)r.push(new me(o(a/n,e.x,t.x,i.x,s.x),o(a/n,e.y,t.y,i.y,s.y),o(a/n,e.z,t.z,i.z,s.z)));return new rn(r)}static CreateHermiteSpline(e,t,i,s,n){const r=[],o=1/n;for(let a=0;a<=n;a++)r.push(me.Hermite(e,t,i,s,a*o));return new rn(r)}static CreateCatmullRomSpline(e,t,i){const s=[],n=1/t;let r=0;if(i){const i=e.length;for(let o=0;o<i;o++){r=0;for(let a=0;a<t;a++)s.push(me.CatmullRom(e[o%i],e[(o+1)%i],e[(o+2)%i],e[(o+3)%i],r)),r+=n}s.push(s[0])}else{const i=[];i.push(e[0].clone()),Array.prototype.push.apply(i,e),i.push(e[e.length-1].clone());let o=0;for(;o<i.length-3;o++){r=0;for(let e=0;e<t;e++)s.push(me.CatmullRom(i[o],i[o+1],i[o+2],i[o+3],r)),r+=n}o--,s.push(me.CatmullRom(i[o],i[o+1],i[o+2],i[o+3],r))}return new rn(s)}static ArcThru3Points(e,t,i,s=32,n=!1,r=!1){const o=[],a=t.subtract(e),l=i.subtract(t),h=e.subtract(i),c=me.Cross(a,l),d=c.length();if(d<Math.pow(10,-8))return new rn(o);const u=a.lengthSquared(),_=l.lengthSquared(),f=h.lengthSquared(),p=c.lengthSquared(),m=.5*a.length()*l.length()*h.length()/d,g=-.5*_*me.Dot(a,h)/p,v=-.5*f*me.Dot(a,l)/p,T=-.5*u*me.Dot(l,h)/p,b=e.scale(g).add(t.scale(v)).add(i.scale(T)),E=e.subtract(b).normalize(),S=me.Cross(c,E).normalize();if(r){const t=2*Math.PI/s;for(let e=0;e<=2*Math.PI;e+=t)o.push(b.add(E.scale(m*Math.cos(e)).add(S.scale(m*Math.sin(e)))));o.push(e)}else{const t=1/s;let r=0,a=me.Zero();do{a=b.add(E.scale(m*Math.cos(r)).add(S.scale(m*Math.sin(r)))),o.push(a),r+=t}while(!a.equalsWithEpsilon(i,m*t*1.1));o.push(i),n&&o.push(e)}return new rn(o)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){const t=this._points[this._points.length-1],i=this._points.slice(),s=e.getPoints();for(let e=1;e<s.length;e++)i.push(s[e].subtract(s[0]).add(t));return new rn(i)}_computeLength(e){let t=0;for(let i=1;i<e.length;i++)t+=e[i].subtract(e[i-1]).length();return t}}const on=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],an=[()=>1,e=>e.y,e=>e.z,e=>e.x,e=>e.x*e.y,e=>e.y*e.z,e=>3*e.z*e.z-1,e=>e.x*e.z,e=>e.x*e.x-e.y*e.y],ln=(e,t)=>on[e]*an[e](t),hn=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class cn{constructor(){this.preScaled=!1,this.l00=me.Zero(),this.l1_1=me.Zero(),this.l10=me.Zero(),this.l11=me.Zero(),this.l2_2=me.Zero(),this.l2_1=me.Zero(),this.l20=me.Zero(),this.l21=me.Zero(),this.l22=me.Zero()}addLight(e,t,i){Ee.Vector3[0].set(t.r,t.g,t.b);const s=Ee.Vector3[0],n=Ee.Vector3[1];s.scaleToRef(i,n),n.scaleToRef(ln(0,e),Ee.Vector3[2]),this.l00.addInPlace(Ee.Vector3[2]),n.scaleToRef(ln(1,e),Ee.Vector3[2]),this.l1_1.addInPlace(Ee.Vector3[2]),n.scaleToRef(ln(2,e),Ee.Vector3[2]),this.l10.addInPlace(Ee.Vector3[2]),n.scaleToRef(ln(3,e),Ee.Vector3[2]),this.l11.addInPlace(Ee.Vector3[2]),n.scaleToRef(ln(4,e),Ee.Vector3[2]),this.l2_2.addInPlace(Ee.Vector3[2]),n.scaleToRef(ln(5,e),Ee.Vector3[2]),this.l2_1.addInPlace(Ee.Vector3[2]),n.scaleToRef(ln(6,e),Ee.Vector3[2]),this.l20.addInPlace(Ee.Vector3[2]),n.scaleToRef(ln(7,e),Ee.Vector3[2]),this.l21.addInPlace(Ee.Vector3[2]),n.scaleToRef(ln(8,e),Ee.Vector3[2]),this.l22.addInPlace(Ee.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(hn[0]),this.l1_1.scaleInPlace(hn[1]),this.l10.scaleInPlace(hn[2]),this.l11.scaleInPlace(hn[3]),this.l2_2.scaleInPlace(hn[4]),this.l2_1.scaleInPlace(hn[5]),this.l20.scaleInPlace(hn[6]),this.l21.scaleInPlace(hn[7]),this.l22.scaleInPlace(hn[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(on[0]),this.l1_1.scaleInPlace(on[1]),this.l10.scaleInPlace(on[2]),this.l11.scaleInPlace(on[3]),this.l2_2.scaleInPlace(on[4]),this.l2_1.scaleInPlace(on[5]),this.l20.scaleInPlace(on[6]),this.l21.scaleInPlace(on[7]),this.l22.scaleInPlace(on[8])}updateFromArray(e){return me.FromArrayToRef(e[0],0,this.l00),me.FromArrayToRef(e[1],0,this.l1_1),me.FromArrayToRef(e[2],0,this.l10),me.FromArrayToRef(e[3],0,this.l11),me.FromArrayToRef(e[4],0,this.l2_2),me.FromArrayToRef(e[5],0,this.l2_1),me.FromArrayToRef(e[6],0,this.l20),me.FromArrayToRef(e[7],0,this.l21),me.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return me.FromFloatsToRef(e[0],e[1],e[2],this.l00),me.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),me.FromFloatsToRef(e[6],e[7],e[8],this.l10),me.FromFloatsToRef(e[9],e[10],e[11],this.l11),me.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),me.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),me.FromFloatsToRef(e[18],e[19],e[20],this.l20),me.FromFloatsToRef(e[21],e[22],e[23],this.l21),me.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return(new cn).updateFromArray(e)}static FromPolynomial(e){const t=new cn;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class dn{constructor(){this.x=me.Zero(),this.y=me.Zero(),this.z=me.Zero(),this.xx=me.Zero(),this.yy=me.Zero(),this.zz=me.Zero(),this.xy=me.Zero(),this.yz=me.Zero(),this.zx=me.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=cn.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){Ee.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=Ee.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),Ee.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),Ee.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(Ee.Vector3[0]).addInPlace(Ee.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(Ee.Vector3[0]).subtractInPlace(Ee.Vector3[1]),this.zz.copyFrom(e.l00),Ee.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(Ee.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return(new dn).updateFromHarmonics(e)}static FromArray(e){const t=new dn;return me.FromArrayToRef(e[0],0,t.x),me.FromArrayToRef(e[1],0,t.y),me.FromArrayToRef(e[2],0,t.z),me.FromArrayToRef(e[3],0,t.xx),me.FromArrayToRef(e[4],0,t.yy),me.FromArrayToRef(e[5],0,t.zz),me.FromArrayToRef(e[6],0,t.yz),me.FromArrayToRef(e[7],0,t.zx),me.FromArrayToRef(e[8],0,t.xy),t}}class un{constructor(e,t,i,s){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=s}}class _n{static ConvertCubeMapTextureToSphericalPolynomial(e){var t;if(!e.isCube)return null;null===(t=e.getScene())||void 0===t||t.getEngine().flushFramebuffer();const i=e.getSize().width,s=e.readPixels(0,void 0,void 0,!1),n=e.readPixels(1,void 0,void 0,!1);let r,o;e.isRenderTarget?(r=e.readPixels(3,void 0,void 0,!1),o=e.readPixels(2,void 0,void 0,!1)):(r=e.readPixels(2,void 0,void 0,!1),o=e.readPixels(3,void 0,void 0,!1));const a=e.readPixels(4,void 0,void 0,!1),l=e.readPixels(5,void 0,void 0,!1),h=e.gammaSpace;let c=0;return 1!=e.textureType&&2!=e.textureType||(c=1),new Promise((e=>{Promise.all([n,s,r,o,a,l]).then((([t,s,n,r,o,a])=>{const l={size:i,right:s,left:t,up:n,down:r,front:o,back:a,format:5,type:c,gammaSpace:h};e(this.ConvertCubeMapToSphericalPolynomial(l))}))}))}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new cn;let i=0;const s=2/e.size,n=s,r=.5*s,o=r-1;for(let a=0;a<6;a++){const l=this._FileFaces[a],h=e[l.name];let c=o;const d=5===e.format?4:3;for(let a=0;a<e.size;a++){let u=o;for(let n=0;n<e.size;n++){const o=l.worldAxisForFileX.scale(u).add(l.worldAxisForFileY.scale(c)).add(l.worldAxisForNormal);o.normalize();const _=this._AreaElement(u-r,c-r)-this._AreaElement(u-r,c+r)-this._AreaElement(u+r,c-r)+this._AreaElement(u+r,c+r);let f=h[a*e.size*d+n*d+0],p=h[a*e.size*d+n*d+1],m=h[a*e.size*d+n*d+2];isNaN(f)&&(f=0),isNaN(p)&&(p=0),isNaN(m)&&(m=0),0===e.type&&(f/=255,p/=255,m/=255),e.gammaSpace&&(f=Math.pow(ne.Clamp(f),oe),p=Math.pow(ne.Clamp(p),oe),m=Math.pow(ne.Clamp(m),oe));const g=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const e=Math.max(f,p,m);if(e>g){const t=g/e;f*=t,p*=t,m*=t}}else f=ne.Clamp(f,0,g),p=ne.Clamp(p,0,g),m=ne.Clamp(m,0,g);const v=new Re(f,p,m);t.addLight(o,v,_),i+=_,u+=s}c+=n}}const a=4*Math.PI*6/6/i;return t.scaleInPlace(a),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),dn.FromHarmonics(t)}}_n._FileFaces=[new un("right",new me(1,0,0),new me(0,0,-1),new me(0,-1,0)),new un("left",new me(-1,0,0),new me(0,0,1),new me(0,-1,0)),new un("up",new me(0,1,0),new me(1,0,0),new me(0,0,1)),new un("down",new me(0,-1,0),new me(1,0,0),new me(0,0,-1)),new un("front",new me(0,0,1),new me(1,0,0),new me(0,-1,0)),new un("back",new me(0,0,-1),new me(-1,0,0),new me(0,-1,0))],_n.MAX_HDRI_VALUE=4096,_n.PRESERVE_CLAMPED_COLORS=!1,ki.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(ki.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=_n.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});F.IncludesShadersStore.pbrFragmentDeclaration="uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REALTIME_FILTERING\nuniform vec2 vReflectionFilteringInfo;\n#endif\nuniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; \n#endif\n#endif\n#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)\nuniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; \n#endif\n#ifdef CLEARCOAT\nuniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT\nuniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#endif\n#ifdef IRIDESCENCE\nuniform vec4 vIridescenceParams;\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\nuniform vec3 vAnisotropy;\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\nuniform vec4 vSheenColor;\n#ifdef SHEEN_ROUGHNESS\nuniform float vSheenRoughness;\n#endif\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#ifdef REALTIME_FILTERING\nuniform vec2 vRefractionFilteringInfo;\n#endif\n#ifdef SS_DISPERSION\nuniform float dispersion;\n#endif\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\nuniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;\n#endif\n#ifdef PREPASS\n#ifdef SS_SCATTERING\nuniform float scatteringDiffusionProfile;\n#endif\n#endif\n#if DEBUGMODE>0\nuniform vec2 vDebugMode;\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;\n#endif\n#include<decalFragmentDeclaration>\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#define ADDITIONAL_FRAGMENT_DECLARATION\n";F.IncludesShadersStore.pbrUboDeclaration="layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;\n#define ADDITIONAL_UBO_DECLARATION\n};\n#include<sceneUboDeclaration>\n#include<meshUboDeclaration>\n";F.IncludesShadersStore.pbrFragmentExtraDeclaration="varying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n";F.IncludesShadersStore.samplerFragmentAlternateDeclaration="#ifdef _DEFINENAME_\n#if _DEFINENAME_DIRECTUV==1\n#define v_VARYINGNAME_UV vMainUV1\n#elif _DEFINENAME_DIRECTUV==2\n#define v_VARYINGNAME_UV vMainUV2\n#elif _DEFINENAME_DIRECTUV==3\n#define v_VARYINGNAME_UV vMainUV3\n#elif _DEFINENAME_DIRECTUV==4\n#define v_VARYINGNAME_UV vMainUV4\n#elif _DEFINENAME_DIRECTUV==5\n#define v_VARYINGNAME_UV vMainUV5\n#elif _DEFINENAME_DIRECTUV==6\n#define v_VARYINGNAME_UV vMainUV6\n#else\nvarying vec2 v_VARYINGNAME_UV;\n#endif\n#endif\n";F.IncludesShadersStore.pbrFragmentSamplersDeclaration="#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)\n#ifdef CLEARCOAT\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D clearCoatRoughnessSampler;\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)\n#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D sheenRoughnessSampler;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform samplerCube irradianceSampler;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform sampler2D irradianceSampler;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;\n#endif\n#endif\n#endif\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)\n#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)\n#endif\n";F.IncludesShadersStore.subSurfaceScatteringFunctions="bool testLightingForSSS(float diffusionProfile)\n{return diffusionProfile<1.;}";F.IncludesShadersStore.importanceSampling="vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nvec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}\nvec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { \nfloat phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}";F.IncludesShadersStore.pbrHelperFunctions="#define MINIMUMVARIANCE 0.0005\nfloat convertRoughnessToAverageSlope(float roughness)\n{return square(roughness)+MINIMUMVARIANCE;}\nfloat fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}\nvec2 getAARoughnessFactors(vec3 normalVector) {\n#ifdef SPECULARAA\nvec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2(0.);\n#endif\n}\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_LEGACY\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}\n#else\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}\n#endif\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\nvec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}\nvec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}\nvec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}\nvec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);return clearCoatAbsorption;}\n#endif\n#ifdef MICROSURFACEAUTOMATIC\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}\n#endif\n";F.IncludesShadersStore.harmonicsFunctions="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nvec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00\n+ vSphericalL1_1*(normal.y)\n+ vSphericalL10*(normal.z)\n+ vSphericalL11*(normal.x)\n+ vSphericalL2_2*(normal.y*normal.x)\n+ vSphericalL2_1*(normal.y*normal.z)\n+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+ vSphericalL21*(normal.z*normal.x)\n+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}\n#else\nvec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}\n#endif\n#endif\n";F.IncludesShadersStore.pbrDirectLightingSetupFunctions="struct preLightingInfo\n{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float roughness;\n#ifdef IRIDESCENCE\nfloat iridescenceIntensity;\n#endif\n};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightOffset=lightData.xyz-vPositionW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\npreLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}\npreLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;}";F.IncludesShadersStore.pbrDirectLightingFalloffFunctions="float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)\n{return max(0.,1.0-length(lightOffset)/range);}\nfloat computeDistanceLightFalloff_Physical(float lightDistanceSquared)\n{return 1.0/maxEps(lightDistanceSquared);}\nfloat computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)\n{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfloat computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)\n{falloff=max(0.,pow(cosAngle,exponent));}\nreturn falloff;}\nfloat computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)\n{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}\nfloat computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)\n{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}";F.IncludesShadersStore.pbrBRDFFunctions="#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}\n#endif\n#ifdef ENVIRONMENTBRDF\nvec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup.rgb=fromRGBD(brdfLookup.rgba);\n#endif\nreturn brdfLookup.rgb;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;}\n#endif\n/* NOT USED\n#if defined(SHEEN) && defined(SHEEN_SOFTER)\nfloat getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)\n{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}\n#endif\n*/\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nvec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n/**\n* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.\n* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table\n*/\nvec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}\n#endif\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\nfloat fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)\n{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}\n#ifdef CLEARCOAT\nvec3 getR0RemappedForClearCoat(vec3 f0) {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturate(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);\n#endif\n}\n#endif\n#ifdef IRIDESCENCE\nconst mat3 XYZ_TO_REC709=mat3(\n3.2404542,-0.9692660, 0.0556434,\n-1.5371385, 1.8760108,-0.2040259,\n-0.4985314, 0.0415560, 1.0572252\n);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}\nvec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}\nfloat getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}\nvec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}\nvec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}\nfloat cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); \nvec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)\n{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}\nreturn max(I,vec3(0.0));}\n#endif\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}\n#ifdef SHEEN\nfloat normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)\n{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}\n#endif\n#ifdef ANISOTROPIC\nfloat normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}\n#endif\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {\n#ifdef MOBILE\nfloat GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);\n#else\nfloat a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);\n#endif\n}\n#else\nfloat smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)\n{\n#ifdef MOBILE\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nfloat alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfloat smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)\n{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}\n#endif\n#ifdef ANISOTROPIC\nfloat smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}\n#endif\n#ifdef CLEARCOAT\nfloat visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }\n#endif\n#ifdef SHEEN\nfloat visibility_Ashikhmin(float NdotL,float NdotV)\n{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}\n/* NOT USED\n#ifdef SHEEN_SOFTER\nfloat l(float x,float alphaG)\n{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}\nfloat lambdaSheen(float cosTheta,float alphaG)\n{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}\nfloat visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)\n{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}\n#endif\n*/\n#endif\nfloat diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}\n#ifdef SS_TRANSLUCENCY\nvec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}\nfloat computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}\n#endif\n";F.IncludesShadersStore.hdrFilteringFunctions="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfloat radicalInverse_VdC(uint bits) \n{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }\nvec2 hammersley(uint i,uint N)\n{return vec2(float(i)/float(N),radicalInverse_VdC(i));}\n#else\nfloat vanDerCorpus(int n,int base)\n{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)\n{if(n>0)\n{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}\nreturn result;}\nvec2 hammersley(int i,int N)\n{return vec2(float(i)/float(N),vanDerCorpus(i,2));}\n#endif\nfloat log4(float x) {return log2(x)/2.;}\nconst float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;\n#define inline\nvec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{vec3 n=normalize(inputN);vec3 result=vec3(0.0);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);vec3 Ns=vec3(0.,0.,1.);float NoL=dot(Ns,Ls);if (NoL>0.) {float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.0,maxLevel);vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c;}}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}\n#define inline\nvec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; \nif (alphaG==0.) {\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;\n#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;}}\nresult=result/weight;return result;}}\n#endif\n#endif\n";F.IncludesShadersStore.pbrDirectLightingFunctions="#define CLEARCOATREFLECTANCE90 1.0\nstruct lightingInfo\n{vec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef CLEARCOAT\nvec4 clearCoat;\n#endif\n#ifdef SHEEN\nvec3 sheen;\n#endif\n};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\nfloat lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nvec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}\nvec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}\n#ifdef SS_TRANSLUCENCY\nvec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {float NdotL=absEps(info.NdotLUnclamped);float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}\n#endif\n#ifdef SPECULARTERM\nvec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nfloat smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef ANISOTROPIC\nvec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\n#ifdef IRIDESCENCE\nfresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);\n#endif\nfloat distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n#ifdef CLEARCOAT\nvec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);}\nvec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}\n#endif\n#ifdef SHEEN\nvec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER\nfloat visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);\n#else */\nfloat visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */\nfloat sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}\n#endif\n";F.IncludesShadersStore.pbrIBLFunctions="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}\nfloat getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfloat environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}\n#endif\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}\n#endif\n";F.IncludesShadersStore.pbrBlockAlbedoOpacity="struct albedoOpacityOutParams\n{vec3 surfaceAlbedo;float alpha;};\n#define pbr_inline\nvoid albedoOpacityBlock(\nin vec4 vAlbedoColor,\n#ifdef ALBEDO\nin vec4 albedoTexture,\nin vec2 albedoInfos,\n#endif\n#ifdef OPACITY\nin vec4 opacityMap,\nin vec2 vOpacityInfos,\n#endif\n#ifdef DETAIL\nin vec4 detailColor,\nin vec4 vDetailInfos,\n#endif\n#ifdef DECAL\nin vec4 decalColor,\nin vec4 vDecalInfos,\n#endif\nout albedoOpacityOutParams outParams\n)\n{vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#ifndef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nsurfaceAlbedo*=vColor.rgb;\n#endif\n#ifdef DETAIL\nfloat detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; \n#endif\n#ifdef DECAL_AFTER_DETAIL\n#include<decalFragment>\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nalpha*=vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST \n#if DEBUGMODE != 88\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifndef ALPHABLEND\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;}\n";F.IncludesShadersStore.pbrBlockReflectivity="struct reflectivityOutParams\n{float microSurface;float roughness;vec3 surfaceReflectivityColor;\n#ifdef METALLICWORKFLOW\nvec3 surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nvec3 ambientOcclusionColor;\n#endif\n#if DEBUGMODE>0\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness;\n#ifdef REFLECTIVITY\nvec4 surfaceMetallicColorMap;\n#endif\n#ifndef FROSTBITE_REFLECTANCE\nvec3 metallicF0;\n#endif\n#else\n#ifdef REFLECTIVITY\nvec4 surfaceReflectivityColorMap;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid reflectivityBlock(\nin vec4 vReflectivityColor,\n#ifdef METALLICWORKFLOW\nin vec3 surfaceAlbedo,\nin vec4 metallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nin vec3 reflectivityInfos,\nin vec4 surfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nin vec3 ambientOcclusionColorIn,\n#endif\n#ifdef MICROSURFACEMAP\nin vec4 microSurfaceTexel,\n#endif\n#ifdef DETAIL\nin vec4 detailColor,\nin vec4 vDetailInfos,\n#endif\nout reflectivityOutParams outParams\n)\n{float microSurface=vReflectivityColor.a;vec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nfloat detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#if DEBUGMODE>0\noutParams.metallicRoughness=metallicRoughness;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\nmicroSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;\n#ifdef FROSTBITE_REFLECTANCE\noutParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);\n#else\nvec3 metallicF0=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=metallicF0;\n#endif\noutParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\n#endif\nmicroSurface=saturate(microSurface);float roughness=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;}\n";F.IncludesShadersStore.pbrBlockAmbientOcclusion="struct ambientOcclusionOutParams\n{vec3 ambientOcclusionColor;\n#if DEBUGMODE>0 && defined(AMBIENT)\nvec3 ambientOcclusionColorMap;\n#endif\n};\n#define pbr_inline\nvoid ambientOcclusionBlock(\n#ifdef AMBIENT\nin vec3 ambientOcclusionColorMap_,\nin vec4 vAmbientInfos,\n#endif\nout ambientOcclusionOutParams outParams\n)\n{vec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;}\n";F.IncludesShadersStore.pbrBlockAlphaFresnel="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{float alpha;};\n#define pbr_inline\nvoid alphaFresnelBlock(\nin vec3 normalW,\nin vec3 viewDirectionW,\nin float alpha,\nin float microSurface,\nout alphaFresnelOutParams outParams\n)\n{float opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\noutParams.alpha=1.0;\n#endif\n#endif\n}\n#endif\n#endif\n";F.IncludesShadersStore.pbrBlockAnisotropic="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;\n#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)\nvec3 anisotropyMapData;\n#endif\n};\n#define pbr_inline\nvoid anisotropicBlock(\nin vec3 vAnisotropy,\nin float roughness,\n#ifdef ANISOTROPIC_TEXTURE\nin vec3 anisotropyMapData,\n#endif\nin mat3 TBN,\nin vec3 normalW,\nin vec3 viewDirectionW,\nout anisotropicOutParams outParams\n)\n{float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nanisotropy*=anisotropyMapData.b;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\nanisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;\n#ifdef ANISOTROPIC_LEGACY\nanisotropyDirection.rg*=anisotropyMapData.rg;\n#else\nanisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);\n#endif\n#endif\nmat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);}\n#endif\n";F.IncludesShadersStore.pbrBlockReflection="#ifdef REFLECTION\nstruct reflectionOutParams\n{vec4 environmentRadiance;vec3 environmentIrradiance;\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords;\n#else\nvec2 reflectionCoords;\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nvec3 irradianceVector;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid createReflectionCoords(\nin vec3 vPositionW,\nin vec3 normalW,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REFLECTIONMAP_3D\nout vec3 reflectionCoords\n#else\nout vec2 reflectionCoords\n#endif\n)\n{\n#ifdef ANISOTROPIC\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n}\n#define pbr_inline\n#define inline\nvoid sampleReflectionTexture(\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nconst vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nconst vec2 reflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout vec4 environmentRadiance\n)\n{\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);} else {environmentRadiance=mix(\nenvironmentMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\nenvironmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}\n#define pbr_inline\n#define inline\nvoid reflectionBlock(\nin vec3 vPositionW,\nin vec3 normalW,\nin float alphaG,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nin float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nin float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\n#else\nin sampler2D reflectionSampler,\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nin vec3 vEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nin mat4 reflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nin samplerCube irradianceSampler,\n#else\nin sampler2D irradianceSampler,\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\nout reflectionOutParams outParams\n)\n{vec4 environmentRadiance=vec4(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.);\n#else\nvec2 reflectionCoords=vec2(0.);\n#endif\ncreateReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\nreflectionCoords\n);sampleReflectionTexture(\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionSampler,\nreflectionCoords,\n#else\nreflectionSampler,\nreflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentRadiance\n);vec3 environmentIrradiance=vec3(0.,0.,0.);\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#ifdef ANISOTROPIC\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;}\n#endif\n";F.IncludesShadersStore.pbrBlockSheen="#ifdef SHEEN\nstruct sheenOutParams\n{float sheenIntensity;vec3 sheenColor;float sheenRoughness;\n#ifdef SHEEN_LINKWITHALBEDO\nvec3 surfaceAlbedo;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfloat sheenAlbedoScaling;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 finalSheenRadianceScaled;\n#endif\n#if DEBUGMODE>0\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 sheenEnvironmentReflectance;\n#endif\n#endif\n};\n#define pbr_inline\n#define inline\nvoid sheenBlock(\nin vec4 vSheenColor,\n#ifdef SHEEN_ROUGHNESS\nin float vSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nin vec4 sheenMapRoughnessData,\n#endif\n#endif\nin float roughness,\n#ifdef SHEEN_TEXTURE\nin vec4 sheenMapData,\nin float sheenMapLevel,\n#endif\nin float reflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nin vec3 baseColor,\nin vec3 surfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nin float NdotV,\nin vec3 environmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nin vec2 AARoughnessFactors,\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\nin vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\nin vec3 reflectionCoords,\n#else\nin sampler2D reflectionSampler,\nin vec2 reflectionCoords,\n#endif\nin float NdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nin float seo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nin float eho,\n#endif\n#endif\nout sheenOutParams outParams\n)\n{float sheenIntensity=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nfloat sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvec3 sheenColor=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\n#ifdef SHEEN_GAMMATEXTURE\nsheenColor.rgb*=toLinearSpace(sheenMapData.rgb);\n#else\nsheenColor.rgb*=sheenMapData.rgb;\n#endif\nsheenColor.rgb*=sheenMapLevel;\n#endif\n#ifdef SHEEN_ROUGHNESS\nfloat sheenRoughness=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\n#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL\nsheenRoughness*=sheenMapData.a;\n#else\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#endif\n#else\nfloat sheenRoughness=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\nsheenColor*=sheenIntensity;\n#endif\n#ifdef ENVIRONMENTBRDF\n/*#ifdef SHEEN_SOFTER\nvec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));\n#else*/\n#ifdef SHEEN_ROUGHNESS\nvec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvec3 environmentSheenBrdf=environmentBrdf;\n#endif\n/*#endif*/\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nfloat sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(\nsheenAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nsheenRoughness,\n#endif\nreflectionSampler,\nreflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentSheenRadiance\n);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\noutParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;}\n#endif\n";F.IncludesShadersStore.pbrBlockClearcoat="struct clearcoatOutParams\n{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;\n#ifdef REFLECTION\nvec3 finalClearCoatRadianceScaled;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nvec3 energyConservationFactorClearCoat;\n#endif\n#if DEBUGMODE>0\n#ifdef CLEARCOAT_BUMP\nmat3 TBNClearCoat;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData;\n#endif\n#ifdef REFLECTION\nvec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;\n#endif\nfloat clearCoatNdotV;\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\n#define inline\nvoid clearcoatBlock(\nin vec3 vPositionW,\nin vec3 geometricNormalW,\nin vec3 viewDirectionW,\nin vec2 vClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nin vec4 clearCoatMapRoughnessData,\n#endif\nin vec3 specularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nin vec2 clearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nin vec4 vClearCoatTintParams,\nin float clearCoatColorAtDistance,\nin vec4 vClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nin vec4 clearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nin vec2 vClearCoatBumpInfos,\nin vec4 clearCoatBumpMapData,\nin vec2 vClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nin mat3 vTBN,\n#else\nin vec2 vClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nin mat4 normalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nin vec3 faceNormal,\n#endif\n#ifdef REFLECTION\nin vec3 vReflectionMicrosurfaceInfos,\nin vec2 vReflectionInfos,\nin vec3 vReflectionColor,\nin vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSampler,\n#else\nin sampler2D reflectionSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nin samplerCube reflectionSamplerLow,\nin samplerCube reflectionSamplerHigh,\n#else\nin sampler2D reflectionSamplerLow,\nin sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nin float ambientMonochrome,\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\nin float frontFacingMultiplier,\n#endif\nout clearcoatOutParams outParams\n)\n{float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL\nclearCoatRoughness*=clearCoatMapData.y;\n#else\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\n#ifdef CLEARCOAT_TINT_GAMMATEXTURE\nclearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);\n#else\nclearCoatColor*=clearCoatTintMapData.rgb;\n#endif\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;\n#endif\n#ifdef CLEARCOAT_REMAP_F0\nvec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvec3 specularEnvironmentR0Updated=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nfloat clearCoatNormalScale=1.0;\n#else\nfloat clearCoatNormalScale=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBNClearCoat=vTBN;\n#else\nvec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))\nvec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n#if defined(REFLECTION)\nfloat clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 clearCoatReflectionCoords=clearCoatReflectionVector;\n#else\nvec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nsampleReflectionTexture(\nclearCoatAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nclearCoatNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nclearCoatRoughness,\n#endif\nreflectionSampler,\nclearCoatReflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentClearCoatRadiance\n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\nfloat fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\n}\n#endif\n";F.IncludesShadersStore.pbrBlockIridescence="struct iridescenceOutParams\n{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};\n#ifdef IRIDESCENCE\n#define pbr_inline\n#define inline\nvoid iridescenceBlock(\nin vec4 vIridescenceParams,\nin float viewAngle,\nin vec3 specularEnvironmentR0,\n#ifdef IRIDESCENCE_TEXTURE\nin vec2 iridescenceMapData,\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nin vec2 iridescenceThicknessMapData,\n#endif\n#ifdef CLEARCOAT\nin float NdotVUnclamped,\n#ifdef CLEARCOAT_TEXTURE\nin vec2 clearCoatMapData,\n#endif\n#endif\nout iridescenceOutParams outParams\n)\n{float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;\n#ifdef IRIDESCENCE_TEXTURE\niridescenceIntensity*=iridescenceMapData.x;\n#ifdef IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE\niridescenceThicknessWeight=iridescenceMapData.g;\n#endif\n#endif\n#if defined(IRIDESCENCE_THICKNESS_TEXTURE)\niridescenceThicknessWeight=iridescenceThicknessMapData.g;\n#endif\nfloat iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; \n#ifdef CLEARCOAT\nfloat clearCoatIntensity=vClearCoatParams.x;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#endif\ntopIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));\n#endif\nvec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;}\n#endif\n";F.IncludesShadersStore.pbrBlockSubSurface="struct subSurfaceOutParams\n{vec3 specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvec3 finalRefraction;vec3 surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nfloat alpha;\n#endif\n#ifdef REFLECTION\nfloat refractionFactorForIrradiance;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvec3 transmittance;float translucencyIntensity;\n#ifdef REFLECTION\nvec3 refractionIrradiance;\n#endif\n#endif\n#if DEBUGMODE>0\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction;vec3 refractionTransmittance;\n#endif\n#endif\n};\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#define pbr_inline\n#define inline\nvec4 sampleEnvironmentRefraction(\nin float ior\n,in float thickness\n,in float refractionLOD\n,in vec3 normalW\n,in vec3 vPositionW\n,in vec3 viewDirectionW\n,in mat4 view\n,in vec4 vRefractionInfos\n,in mat4 refractionMatrix\n,in vec4 vRefractionMicrosurfaceInfos\n,in float alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,in samplerCube refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in samplerCube refractionSamplerLow\n,in samplerCube refractionSamplerHigh\n#endif\n#else\n,in sampler2D refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,in sampler2D refractionSamplerLow\n,in sampler2D refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,in anisotropicOutParams anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,in vec2 vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,in vec3 refractionPosition\n,in vec3 refractionSize\n#endif\n) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);\n#else\nvec3 refractionVector=refract(-viewDirectionW,normalW,ior);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n#ifdef SS_REFRACTIONMAP_3D\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nrefractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);\n#endif\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\n#ifdef SS_USE_THICKNESS_AS_DEPTH\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\n#endif\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef LODBASEDMICROSFURACE\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\n#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)\nenvironmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nfloat lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);} else {environmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);}\n#endif\n#ifdef SS_RGBDREFRACTION\nenvironmentRefraction.rgb=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nenvironmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);\n#endif\nreturn environmentRefraction;}\n#endif\n#define pbr_inline\n#define inline\nvoid subSurfaceBlock(\nin vec3 vSubSurfaceIntensity,\nin vec2 vThicknessParam,\nin vec4 vTintColor,\nin vec3 normalW,\nin vec3 specularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nin vec4 thicknessMap,\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nin vec4 refractionIntensityMap,\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nin vec4 translucencyIntensityMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nin mat4 reflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nin vec3 irradianceVector_,\n#endif\n#if defined(REALTIME_FILTERING)\nin samplerCube reflectionSampler,\nin vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nin samplerCube irradianceSampler,\n#else\nin sampler2D irradianceSampler,\n#endif\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\nin vec3 surfaceAlbedo,\n#endif\n#ifdef SS_REFRACTION\nin vec3 vPositionW,\nin vec3 viewDirectionW,\nin mat4 view,\nin vec4 vRefractionInfos,\nin mat4 refractionMatrix,\nin vec4 vRefractionMicrosurfaceInfos,\nin vec4 vLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nin float alpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nin float NdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nin float roughness,\n#endif\nin float alphaG,\n#ifdef SS_REFRACTIONMAP_3D\nin samplerCube refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nin samplerCube refractionSamplerLow,\nin samplerCube refractionSamplerHigh,\n#endif\n#else\nin sampler2D refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nin sampler2D refractionSamplerLow,\nin sampler2D refractionSamplerHigh,\n#endif\n#endif\n#ifdef ANISOTROPIC\nin anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nin vec2 vRefractionFilteringInfo,\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nin vec3 refractionPosition,\nin vec3 refractionSize,\n#endif\n#ifdef SS_DISPERSION\nin float dispersion,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nin vec3 vDiffusionDistance,\n#endif\nout subSurfaceOutParams outParams\n)\n{outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nfloat refractionIntensity=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);outParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nfloat translucencyIntensity=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#if defined(SS_USE_GLTF_TEXTURES)\nfloat thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#else\nfloat thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#endif\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#ifdef SS_MASK_FROM_THICKNESS_TEXTURE\n#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)\n#if defined(SS_USE_GLTF_TEXTURES)\nrefractionIntensity*=thicknessMap.r;\n#else\nrefractionIntensity*=thicknessMap.g;\n#endif\n#endif\n#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#endif\n#else\nfloat thickness=vThicknessParam.y;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\n#ifdef SS_USE_GLTF_TEXTURES\nrefractionIntensity*=refractionIntensityMap.r;\n#else\nrefractionIntensity*=refractionIntensityMap.g;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\ntranslucencyIntensity*=translucencyIntensityMap.b;\n#endif\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);vec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;\n#endif\n#ifdef SS_REFRACTION\nvec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef SS_HAS_THICKNESS\nfloat ior=vRefractionInfos.y;\n#else\nfloat ior=vRefractionMicrosurfaceInfos.w;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nfloat refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nfloat refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);\n#else\nfloat refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);\n#endif\nfloat refraction_ior=vRefractionInfos.y;\n#ifdef SS_DISPERSION\nfloat realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];\n#endif\nvec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG\n#ifdef SS_REFRACTIONMAP_3D\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#else\n,refractionSampler\n#ifndef LODBASEDMICROSFURACE\n,refractionSamplerLow\n,refractionSamplerHigh\n#endif\n#endif\n#ifdef ANISOTROPIC\n,anisotropicOut\n#endif\n#ifdef REALTIME_FILTERING\n,vRefractionFilteringInfo\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n,refractionPosition\n,refractionSize\n#endif\n);\n#ifdef SS_DISPERSION\nenvironmentRefraction[i]=envSample[i];}\n#else\nenvironmentRefraction=envSample;\n#endif\nenvironmentRefraction.rgb*=vRefractionInfos.x;\n#endif\n#ifdef SS_REFRACTION\nvec3 refractionTransmittance=vec3(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\nfloat maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;\n#else\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\nenvironmentRefraction.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);\n#ifdef REFLECTION\noutParams.refractionFactorForIrradiance=(1.-refractionIntensity);\n#endif\n#ifdef UNUSED_MULTIPLEBOUNCES\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n#endif\nrefractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvec3 irradianceVector=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);\n#else\nvec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec3 irradianceCoords=irradianceVector;\n#else\nvec2 irradianceCoords=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);\n#ifdef RGBDREFLECTION\nrefractionIrradiance.rgb=fromRGBD(refractionIrradiance);\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);\n#endif\n#else\nvec4 refractionIrradiance=vec4(0.);\n#endif\nrefractionIrradiance.rgb*=transmittance;\n#ifdef SS_ALBEDOFORTRANSLUCENCYTINT\nrefractionIrradiance.rgb*=surfaceAlbedo.rgb;\n#endif\noutParams.refractionIrradiance=refractionIrradiance.rgb;\n#endif\n}\n#endif\n";F.IncludesShadersStore.pbrBlockNormalGeometric="vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\nvec3 geometricNormalW=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;\n#endif\n";F.IncludesShadersStore.pbrBlockNormalFinal="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n";F.IncludesShadersStore.pbrBlockLightmapInit="#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor.rgb=toLinearSpace(lightmapColor.rgb);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n";F.IncludesShadersStore.pbrBlockGeometryInfo="float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\nvec3 environmentBrdf=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=aoOut.ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n";F.IncludesShadersStore.pbrBlockReflectance0="float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);\n#else \nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);\n#endif\n#ifdef ALPHAFRESNEL\nfloat reflectance90=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n";F.IncludesShadersStore.pbrBlockReflectance="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);\n#ifdef RADIANCEOCCLUSION\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\nvec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\nspecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nspecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n";F.IncludesShadersStore.pbrBlockDirectLighting="vec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvec3 clearCoatBase=vec3(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvec3 sheenBase=vec3(0.,0.,0.);\n#endif\npreLightingInfo preInfo;lightingInfo info;float shadow=1.; \nfloat aggShadow=0.;float numLights=0.;\n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvec3 absorption=vec3(0.);\n#endif\n";F.IncludesShadersStore.pbrBlockFinalLitComponents="aggShadow=aggShadow/numLights;\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n#ifdef REFLECTION\nvec3 finalIrradiance=reflectionOut.environmentIrradiance;\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\nfinalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef REFLECTION\nvec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n#ifdef SHEEN\nvec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef CLEARCOAT\nvec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n";F.IncludesShadersStore.pbrBlockFinalUnlitComponents="vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\n#ifdef GAMMAEMISSIVE\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\n#else\nfinalEmissive*=emissiveColorTex.rgb;\n#endif\nfinalEmissive*= vEmissiveInfos.y;\n#endif\nfinalEmissive*=vLightingIntensity.y;\n#ifdef AMBIENT\nvec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);\n#else\nvec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;\n";F.IncludesShadersStore.pbrBlockFinalColorComposition="vec4 finalColor=vec4(\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalAmbient +\nfinalDiffuse,\nalpha);\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor.rgb;\n#else\nfinalColor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\nfinalColor.rgb+=finalEmissive;\n#define CUSTOM_FRAGMENT_BEFORE_FOG\nfinalColor=max(finalColor,0.0);\n";F.IncludesShadersStore.pbrBlockImageProcessing="#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)\n#if !defined(SKIPFINALCOLORCLAMP)\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#endif\n#else\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\nfinalColor.rgb*=finalColor.a;\n#endif\n";F.IncludesShadersStore.pbrDebug="#if DEBUGMODE>0\nif (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {\n#if DEBUGMODE==1\ngl_FragColor.rgb=vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==2 && defined(NORMAL)\ngl_FragColor.rgb=vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)\ngl_FragColor.rgb=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==5\ngl_FragColor.rgb=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==6 && defined(MAINUV1)\ngl_FragColor.rgb=vec3(vMainUV1,0.0);\n#elif DEBUGMODE==7 && defined(MAINUV2)\ngl_FragColor.rgb=vec3(vMainUV2,0.0);\n#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==10 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==11 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==12 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==13 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE==20 && defined(ALBEDO)\ngl_FragColor.rgb=albedoTexture.rgb;\n#ifndef GAMMAALBEDO\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==21 && defined(AMBIENT)\ngl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE==22 && defined(OPACITY)\ngl_FragColor.rgb=opacityMap.rgb;\n#elif DEBUGMODE==23 && defined(EMISSIVE)\ngl_FragColor.rgb=emissiveColorTex.rgb;\n#ifndef GAMMAEMISSIVE\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==24 && defined(LIGHTMAP)\ngl_FragColor.rgb=lightmapColor.rgb;\n#ifndef GAMMALIGHTMAP\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ngl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ngl_FragColor.rgb=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ngl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ngl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;\n#elif DEBUGMODE==32 && defined(BUMP)\ngl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;\n#elif DEBUGMODE==40 && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==41 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)\ngl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==50\ngl_FragColor.rgb=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==51 && defined(SPECULARTERM)\ngl_FragColor.rgb=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==52 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==53 && defined(SHEEN)\ngl_FragColor.rgb=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==54 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;\n#ifndef GAMMAREFLECTION\n#define DEBUGMODE_GAMMA\n#endif\n#elif DEBUGMODE==60\ngl_FragColor.rgb=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==61\ngl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);\n#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.metallicF0;\n#elif DEBUGMODE==63\ngl_FragColor.rgb=vec3(roughness);\n#elif DEBUGMODE==64\ngl_FragColor.rgb=vec3(alphaG);\n#elif DEBUGMODE==65\ngl_FragColor.rgb=vec3(NdotV);\n#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ngl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==67 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE==68 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ngl_FragColor.rgb=subSurfaceOut.transmittance;\n#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.refractionTransmittance;\n#elif DEBUGMODE==72\ngl_FragColor.rgb=vec3(microSurface);\n#elif DEBUGMODE==73\ngl_FragColor.rgb=vAlbedoColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vReflectivityColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==75\ngl_FragColor.rgb=vEmissiveColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)\ngl_FragColor.rgb=vec3(seo);\n#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)\ngl_FragColor.rgb=vec3(eho);\n#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ngl_FragColor.rgb=vec3(energyConservationFactor);\n#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=specularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)\ngl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE==86 && defined(ALPHABLEND)\ngl_FragColor.rgb=vec3(luminanceOverAlpha);\n#elif DEBUGMODE==87\ngl_FragColor.rgb=vec3(alpha);\n#elif DEBUGMODE==88 && defined(ALBEDO)\ngl_FragColor.rgb=vec3(albedoTexture.a);\n#else\nfloat stripeWidth=30.;float stripePos=floor((gl_FragCoord.x+gl_FragCoord.y)/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);\n#endif\ngl_FragColor.rgb*=vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ngl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ngl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);\n#endif\ngl_FragColor.a=1.0;\n#ifdef PREPASS\ngl_FragData[0]=toLinearSpace(gl_FragColor); \ngl_FragData[1]=vec4(0.,0.,0.,0.); \n#endif\n#ifdef DEBUGMODE_FORCERETURN\nreturn;\n#endif\n}\n#endif\n";F.ShadersStore.pbrPixelShader="#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\nprecision highp float;\n#include<oitDeclaration>\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n#include<__decl__pbrFragment>\n#include<pbrFragmentExtraDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockIridescence>\n#include<pbrBlockSubSurface>\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\nalbedoOpacityOutParams albedoOpacityOut;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#endif\n#ifdef DECAL\nvec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);\n#endif\nalbedoOpacityBlock(\nvAlbedoColor,\n#ifdef ALBEDO\nalbedoTexture,\nvAlbedoInfos,\n#endif\n#ifdef OPACITY\nopacityMap,\nvOpacityInfos,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\n#ifdef DECAL\ndecalColor,\nvDecalInfos,\n#endif\nalbedoOpacityOut\n);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\nambientOcclusionOutParams aoOut;\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;\n#endif\nambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nvAmbientInfos,\n#endif\naoOut\n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else\nvec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;\n#if defined(REFLECTIVITY)\nvec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\n#ifdef REFLECTIVITY_GAMMA\nsurfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);\n#endif\nsurfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvec4 metallicReflectanceFactors=vMetallicReflectanceFactors;\n#ifdef REFLECTANCE\nvec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);\n#ifdef REFLECTANCE_GAMMA\nreflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);\n#endif\nmetallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;\n#endif\n#ifdef METALLIC_REFLECTANCE\nvec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);\n#ifdef METALLIC_REFLECTANCE_GAMMA\nmetallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);\n#endif\n#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY\nmetallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;\n#endif\nmetallicReflectanceFactors*=metallicReflectanceFactorsMap.a;\n#endif\n#endif\nreflectivityBlock(\nvReflectivityColor,\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo,\nmetallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nvReflectivityInfos,\nsurfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor,\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurfaceTexel,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\nreflectivityOut\n);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nalphaFresnelOutParams alphaFresnelOut;alphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface,\nalphaFresnelOut\n);alpha=alphaFresnelOut.alpha;\n#endif\n#endif\n#include<pbrBlockGeometryInfo>\n#ifdef ANISOTROPIC\nanisotropicOutParams anisotropicOut;\n#ifdef ANISOTROPIC_TEXTURE\nvec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;\n#endif\nanisotropicBlock(\nvAnisotropy,\nroughness,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW,\nanisotropicOut\n);\n#endif\n#ifdef REFLECTION\nreflectionOutParams reflectionOut;\n#ifndef USE_CUSTOM_REFLECTION\nreflectionBlock(\nvPositionW,\nnormalW,\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\nreflectionSampler,\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nvEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nreflectionOut\n);\n#else\n#define CUSTOM_REFLECTION\n#endif\n#endif\n#include<pbrBlockReflectance0>\n#ifdef SHEEN\nsheenOutParams sheenOut;\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;\n#endif\nsheenBlock(\nvSheenColor,\n#ifdef SHEEN_ROUGHNESS\nvSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nsheenMapRoughnessData,\n#endif\n#endif\nroughness,\n#ifdef SHEEN_TEXTURE\nsheenMapData,\nvSheenInfos.y,\n#endif\nreflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nbaseColor,\nsurfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nNdotV,\nenvironmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nAARoughnessFactors,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\nreflectionOut.reflectionCoords,\nNdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nseo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\neho,\n#endif\n#endif\nsheenOut\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;\n#endif\n#endif\n#ifdef IRIDESCENCE\niridescenceOutParams iridescenceOut;\n#ifdef IRIDESCENCE_TEXTURE\nvec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nvec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;\n#endif\niridescenceBlock(\nvIridescenceParams,\nNdotV,\nspecularEnvironmentR0,\n#ifdef IRIDESCENCE_TEXTURE\niridescenceMapData,\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\niridescenceThicknessMapData,\n#endif\n#ifdef CLEARCOAT\nNdotVUnclamped,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#endif\niridescenceOut\n);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;\n#endif\nclearcoatOutParams clearcoatOut;\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);\n#endif\n#ifdef CLEARCOAT_BUMP\nvec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatBlock(\nvPositionW,\ngeometricNormalW,\nviewDirectionW,\nvClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatMapRoughnessData,\n#endif\nspecularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nvClearCoatTintParams,\nclearCoatColorAtDistance,\nvClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nclearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nvClearCoatBumpInfos,\nclearCoatBumpMapData,\nvClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nvTBN,\n#else\nvClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nnormalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nfaceNormal,\n#endif\n#ifdef REFLECTION\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nambientMonochrome,\n#endif\n#endif\n#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n(gl_FrontFacing ? 1. : -1.),\n#endif\nclearcoatOut\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n#include<pbrBlockReflectance>\nsubSurfaceOutParams subSurfaceOut;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nvec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nvec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);\n#endif\nsubSurfaceBlock(\nvSubSurfaceIntensity,\nvThicknessParam,\nvTintColor,\nnormalW,\nspecularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nthicknessMap,\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nrefractionIntensityMap,\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\ntranslucencyIntensityMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nreflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionOut.irradianceVector,\n#endif\n#if defined(REALTIME_FILTERING)\nreflectionSampler,\nvReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#endif\n#endif\n#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\nsurfaceAlbedo,\n#endif\n#ifdef SS_REFRACTION\nvPositionW,\nviewDirectionW,\nview,\nvRefractionInfos,\nrefractionMatrix,\nvRefractionMicrosurfaceInfos,\nvLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nNdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nroughness,\n#endif\nalphaG,\nrefractionSampler,\n#ifndef LODBASEDMICROSFURACE\nrefractionSamplerLow,\nrefractionSamplerHigh,\n#endif\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nvRefractionFilteringInfo,\n#endif\n#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\nvRefractionPosition,\nvRefractionSize,\n#endif\n#ifdef SS_DISPERSION\ndispersion,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvDiffusionDistance,\n#endif\nsubSurfaceOut\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#endif\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n#include<pbrBlockFinalLitComponents>\n#endif \n#include<pbrBlockFinalUnlitComponents>\n#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\nfloat writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\nvec3 sqAlbedo=sqrt(surfaceAlbedo); \n#endif\n#ifdef PREPASS_IRRADIANCE\nvec3 irradiance=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\n#ifdef SS_SCATTERING\ngl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); \nirradiance/=sqAlbedo;\n#else\ngl_FragData[0]=finalColor; \nfloat scatteringDiffusionProfile=255.;\n#endif\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); \n#else\ngl_FragData[0]=vec4(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTH\ngl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); \n#endif\n#ifdef PREPASS_NORMAL\n#ifdef PREPASS_NORMAL_WORLDSPACE\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo); \n#else\ngl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); \n#endif\n#endif\n#ifdef PREPASS_ALBEDO_SQRT\ngl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); \n#endif\n#ifdef PREPASS_REFLECTIVITY\n#ifndef UNLIT\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=finalColor;\n#endif\n#include<oitFragment>\n#if ORDER_INDEPENDENT_TRANSPARENCY\nif (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}\n#endif\n#include<pbrDebug>\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";F.IncludesShadersStore.pbrVertexDeclaration="uniform mat4 view;uniform mat4 viewProjection;\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY \nuniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;\n#endif\n#ifdef METALLIC_REFLECTANCE\nuniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;\n#endif\n#ifdef REFLECTANCE\nuniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#ifdef IRIDESCENCE\n#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)\nuniform vec4 vIridescenceInfos;\n#endif\n#ifdef IRIDESCENCE_TEXTURE\nuniform mat4 iridescenceMatrix;\n#endif\n#ifdef IRIDESCENCE_THICKNESS_TEXTURE\nuniform mat4 iridescenceThicknessMatrix;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;\n#endif\n#ifdef SS_REFRACTIONINTENSITY_TEXTURE\nuniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;\n#endif\n#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE\nuniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;\n#endif\n#endif\n#ifdef NORMAL\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;\n#else\nuniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;\n#endif\n#endif\n#endif\n#endif\n#ifdef DETAIL\nuniform vec4 vDetailInfos;uniform mat4 detailMatrix;\n#endif\n#include<decalVertexDeclaration>\n#define ADDITIONAL_VERTEX_DECLARATION\n";F.ShadersStore.pbrVertexShader="precision highp float;\n#include<__decl__pbrVertex>\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#include<uvAttributeDeclaration>[2..7]\n#include<mainUVVaryingDeclaration>[1..7]\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)\n#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)\n#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)\n#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)\n#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)\n#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)\n#ifdef CLEARCOAT\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)\n#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)\n#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)\n#endif\n#ifdef SHEEN\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)\n#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)\n#endif\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);\n#include<prePassVertex>\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#include<uvVariableDeclaration>[2..7]\n#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)\n#ifdef CLEARCOAT\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)\n#endif\n#ifdef IRIDESCENCE\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)\n#endif\n#ifdef SHEEN\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)\n#endif\n#ifdef ANISOTROPIC\n#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)\n#endif\n#ifdef SUBSURFACE\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)\n#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#include<vertexColorMixing>\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";class fn extends Wt{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class pn extends Bs{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRClearCoat",100,new fn,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=pn._DefaultIndexOfRefraction,this.indexOfRefraction=pn._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=Re.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const s=this._material._disableBumpMap;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Os.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&Os.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1;if(i.getCaps().standardDerivatives&&this._bumpTexture&&Os.ClearCoatBumpTextureEnabled&&!s&&!this._bumpTexture.isReady())return!1;if(this._isTintEnabled&&this._tintTexture&&Os.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=null!==this._texture&&this._texture._texture===(null===(i=this._textureRoughness)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Os.ClearCoatTextureEnabled?wi.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&Os.ClearCoatTextureEnabled?wi.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&Os.ClearCoatBumpTextureEnabled?wi.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===pn._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&Os.ClearCoatTintTextureEnabled?(wi.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,s){var n,r,o,a,l,h,c,d;if(!this._isEnabled)return;const u=s.materialDefines,_=this._material.isFrozen,f=this._material._disableBumpMap,p=this._material._invertNormalMapX,m=this._material._invertNormalMapY,g=u.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!_||!e.isSync){g&&Os.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),wi.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&Os.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",null!==(r=null===(n=this._texture)||void 0===n?void 0:n.coordinatesIndex)&&void 0!==r?r:0,null!==(a=null===(o=this._texture)||void 0===o?void 0:o.level)&&void 0!==a?a:0,null!==(h=null===(l=this._textureRoughness)||void 0===l?void 0:l.coordinatesIndex)&&void 0!==h?h:0,null!==(d=null===(c=this._textureRoughness)||void 0===c?void 0:c.level)&&void 0!==d?d:0),this._texture&&wi.BindTextureMatrix(this._texture,e,"clearCoat"),!this._textureRoughness||g||u.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE||wi.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&Os.ClearCoatTextureEnabled&&!f&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),wi.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",p?1:-1,m?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",p?-1:1,m?-1:1)),this._tintTexture&&Os.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),wi.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const s=1-this._indexOfRefraction,_=1+this._indexOfRefraction,v=Math.pow(-s/_,2),T=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",v,T,s,_),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&Os.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!g&&!u.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Os.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&Os.ClearCoatBumpTextureEnabled&&!f&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&Os.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,s,n;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._textureRoughness)||void 0===i||i.dispose(),null===(s=this._bumpTexture)||void 0===s||s.dispose(),null===(n=this._tintTexture)||void 0===n||n.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}pn._DefaultIndexOfRefraction=1.5,De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],pn.prototype,"isEnabled",void 0),De([Ge()],pn.prototype,"intensity",void 0),De([Ge()],pn.prototype,"roughness",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],pn.prototype,"indexOfRefraction",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],pn.prototype,"texture",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],pn.prototype,"useRoughnessFromMainTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],pn.prototype,"textureRoughness",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],pn.prototype,"remapF0OnInterfaceChange",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],pn.prototype,"bumpTexture",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],pn.prototype,"isTintEnabled",void 0),De([He()],pn.prototype,"tintColor",void 0),De([Ge()],pn.prototype,"tintColorAtDistance",void 0),De([Ge()],pn.prototype,"tintThickness",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],pn.prototype,"tintTexture",void 0);class mn extends Wt{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1}}class gn extends Bs{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRIridescence",110,new mn,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=gn._DefaultMinimumThickness,this.maximumThickness=gn._DefaultMaximumThickness,this.indexOfRefraction=gn._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){if(!this._isEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Os.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._thicknessTexture&&Os.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.IRIDESCENCE=!0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=null!==this._texture&&this._texture._texture===(null===(i=this._thicknessTexture)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._thicknessTexture),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Os.IridescenceTextureEnabled?wi.PrepareDefinesForMergedUV(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,!e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this._thicknessTexture&&Os.IridescenceTextureEnabled?wi.PrepareDefinesForMergedUV(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t,i,s){var n,r,o,a,l,h,c,d;if(!this._isEnabled)return;const u=s.materialDefines,_=this._material.isFrozen,f=u.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;e.useUbo&&_&&e.isSync||(f&&Os.IridescenceTextureEnabled?(e.updateFloat4("vIridescenceInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),wi.BindTextureMatrix(this._texture,e,"iridescence")):(this._texture||this._thicknessTexture)&&Os.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",null!==(r=null===(n=this._texture)||void 0===n?void 0:n.coordinatesIndex)&&void 0!==r?r:0,null!==(a=null===(o=this._texture)||void 0===o?void 0:o.level)&&void 0!==a?a:0,null!==(h=null===(l=this._thicknessTexture)||void 0===l?void 0:l.coordinatesIndex)&&void 0!==h?h:0,null!==(d=null===(c=this._thicknessTexture)||void 0===c?void 0:c.level)&&void 0!==d?d:0),this._texture&&wi.BindTextureMatrix(this._texture,e,"iridescence"),!this._thicknessTexture||f||u.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE||wi.BindTextureMatrix(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&Os.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&!f&&!u.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&Os.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._thicknessTexture)||void 0===i||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}gn._DefaultMinimumThickness=100,gn._DefaultMaximumThickness=400,gn._DefaultIndexOfRefraction=1.3,De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],gn.prototype,"isEnabled",void 0),De([Ge()],gn.prototype,"intensity",void 0),De([Ge()],gn.prototype,"minimumThickness",void 0),De([Ge()],gn.prototype,"maximumThickness",void 0),De([Ge()],gn.prototype,"indexOfRefraction",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],gn.prototype,"texture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],gn.prototype,"thicknessTexture",void 0);class vn extends Wt{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class Tn extends Bs{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new vn,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new pe(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&Os.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(Oe.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Os.AnisotropicTextureEnabled?wi.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;e.useUbo&&i&&e.isSync||(this._texture&&Os.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),wi.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&Os.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),void 0===e.legacy&&(this.legacy=!0)}}De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Tn.prototype,"isEnabled",void 0),De([Ge()],Tn.prototype,"intensity",void 0),De([Xe()],Tn.prototype,"direction",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Tn.prototype,"texture",void 0),De([Ge(),Ve("_markAllSubMeshesAsMiscDirty")],Tn.prototype,"legacy",void 0);class bn extends Wt{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1}}class En extends Bs{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"Sheen",120,new bn,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=Re.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){if(!this._isEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._texture&&Os.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&Os.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=null!==this._roughness,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=null!==this._texture&&this._texture._texture===(null===(i=this._textureRoughness)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Os.SheenTextureEnabled?(wi.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&Os.SheenTextureEnabled?wi.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,s){var n,r,o,a,l,h,c,d;if(!this._isEnabled)return;const u=s.materialDefines,_=this._material.isFrozen,f=u.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;e.useUbo&&_&&e.isSync||(f&&Os.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),wi.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&Os.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",null!==(r=null===(n=this._texture)||void 0===n?void 0:n.coordinatesIndex)&&void 0!==r?r:0,null!==(a=null===(o=this._texture)||void 0===o?void 0:o.level)&&void 0!==a?a:0,null!==(h=null===(l=this._textureRoughness)||void 0===l?void 0:l.coordinatesIndex)&&void 0!==h?h:0,null!==(d=null===(c=this._textureRoughness)||void 0===c?void 0:c.level)&&void 0!==d?d:0),this._texture&&wi.BindTextureMatrix(this._texture,e,"sheen"),!this._textureRoughness||f||u.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE||wi.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this._roughness&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&Os.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!f&&!u.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Os.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&(null===(t=this._texture)||void 0===t||t.dispose(),null===(i=this._textureRoughness)||void 0===i||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],En.prototype,"isEnabled",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],En.prototype,"linkSheenWithAlbedo",void 0),De([Ge()],En.prototype,"intensity",void 0),De([He()],En.prototype,"color",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],En.prototype,"texture",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],En.prototype,"useRoughnessFromMainTexture",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],En.prototype,"roughness",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],En.prototype,"textureRoughness",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],En.prototype,"albedoScaling",void 0);class Sn extends Wt{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_MASK_FROM_THICKNESS_TEXTURE=!1,this.SS_USE_GLTF_TEXTURES=!1}}class xn extends Bs{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){this._volumeIndexOfRefraction=e>=1?e:-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}constructor(e,t=!0){super(e,"PBRSubSurface",130,new Sn,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=Re.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=Re.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this._useGltfStyleTextures=!1,this.useGltfStyleTextures=!1,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&Os.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;const e=this._getRefractionTexture(t);if(e&&Os.RefractionTextureEnabled&&!e.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,void(e.SS_USE_GLTF_TEXTURES=!1);if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;const i=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,s=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,n=(i||!this._refractionIntensityTexture)&&(s||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&Os.ThicknessTextureEnabled&&wi.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&Os.RefractionIntensityTextureEnabled&&!n&&wi.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&Os.TranslucencyIntensityTextureEnabled&&!n&&wi.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!=0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&n,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&n,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&n,this._isRefractionEnabled&&t.texturesEnabled){const i=this._getRefractionTexture(t);i&&Os.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;s.getRenderingMesh().getWorldMatrix().decompose(Ee.Vector3[0]);const n=Math.max(Math.abs(Ee.Vector3[0].x),Math.abs(Ee.Vector3[0].y),Math.abs(Ee.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*n,(this.maximumThickness-this.minimumThickness)*n)}bindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const n=s.materialDefines,r=this._material.isFrozen,o=this._material.realTimeFiltering,a=n.LODBASEDMICROSFURACE,l=this._getRefractionTexture(t);if(!e.useUbo||!r||!e.isSync){if(this._thicknessTexture&&Os.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),wi.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&Os.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),wi.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&Os.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),wi.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),l&&Os.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",l.getRefractionTextureMatrix());let t=1;l.isCube||l.depth&&(t=l.depth);const i=l.getSize().width,s=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",l.level,1/s,t,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",i,l.lodGenerationScale,l.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",i,ne.Log2(i)),l.boundingBoxSize){const t=l;e.updateVector3("vRefractionPosition",t.boundingBoxPosition),e.updateVector3("vRefractionSize",t.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&Os.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&Os.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&Os.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),l&&Os.RefractionTextureEnabled&&(a?e.setTexture("refractionSampler",l):(e.setTexture("refractionSampler",l._lodTextureMid||l),e.setTexture("refractionSamplerLow",l._lodTextureLow||l),e.setTexture("refractionSamplerHigh",l._lodTextureHigh||l))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){Os.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e}hasRenderTargetTextures(){return!!(Os.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"}]}}}De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"isRefractionEnabled",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"isTranslucencyEnabled",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"isDispersionEnabled",void 0),De([Ge(),Ve("_markScenePrePassDirty")],xn.prototype,"isScatteringEnabled",void 0),De([Ge()],xn.prototype,"_scatteringDiffusionProfileIndex",void 0),De([Ge()],xn.prototype,"refractionIntensity",void 0),De([Ge()],xn.prototype,"translucencyIntensity",void 0),De([Ge()],xn.prototype,"useAlbedoToTintRefraction",void 0),De([Ge()],xn.prototype,"useAlbedoToTintTranslucency",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"thicknessTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"refractionTexture",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"indexOfRefraction",void 0),De([Ge()],xn.prototype,"_volumeIndexOfRefraction",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"volumeIndexOfRefraction",null),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"invertRefractionY",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"linkRefractionWithTransparency",void 0),De([Ge()],xn.prototype,"minimumThickness",void 0),De([Ge()],xn.prototype,"maximumThickness",void 0),De([Ge()],xn.prototype,"useThicknessAsDepth",void 0),De([He()],xn.prototype,"tintColor",void 0),De([Ge()],xn.prototype,"tintColorAtDistance",void 0),De([Ge()],xn.prototype,"dispersion",void 0),De([He()],xn.prototype,"diffusionDistance",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"useMaskFromThicknessTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"refractionIntensityTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"translucencyIntensityTexture",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"useGltfStyleTextures",void 0);const Cn={effect:null,subMesh:null};class yn extends Wt{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class An extends Ms{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}constructor(e,t){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new ge(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=An.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=Re.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new Re(0,0,0),this._albedoColor=new Re(1,1,1),this._reflectivityColor=new Re(1,1,1),this._reflectionColor=new Re(1,1,1),this._emissiveColor=new Re(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=An.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new wt(16),this._globalAmbientColor=new Re(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new Zs(this),this.clearCoat=new pn(this),this.iridescence=new gn(this),this.anisotropy=new Tn(this),this.sheen=new En(this),this.subSurface=new xn(this),this.detailMap=new ks(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),Os.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=$s(this.getScene()),this.prePassConfiguration=new Es}get hasRenderTargetTextures(){return!!(Os.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){var e;return this._transparencyMode===An.PBRMATERIAL_OPAQUE||this._transparencyMode===An.PBRMATERIAL_ALPHATEST||(null===(e=this.subSurface)||void 0===e?void 0:e.disableAlphaBlending)}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())}needAlphaTesting(){var e;return!!this._forceAlphaTest||!(null===(e=this.subSurface)||void 0===e?void 0:e.disableAlphaBlending)&&this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===An.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==An.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){var s;if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Rs.GetDefineNames,this._eventInfo),t.materialDefines=new yn(this._eventInfo.defineNames));const n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const r=this.getScene(),o=r.getEngine();if(n._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,r.texturesEnabled)){if(this._albedoTexture&&Os.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking())return!1;if(this._ambientTexture&&Os.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking())return!1;if(this._opacityTexture&&Os.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const e=this._getReflectionTexture();if(e&&Os.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;if(e.irradianceTexture){if(!e.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!e.sphericalPolynomial&&(null===(s=e.getInternalTexture())||void 0===s?void 0:s._sphericalPolynomialPromise))return!1}if(this._lightmapTexture&&Os.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking())return!1;if(this._emissiveTexture&&Os.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(Os.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking())return!1;if(this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking())return!1;if(this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(o.getCaps().standardDerivatives&&this._bumpTexture&&Os.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady())return!1;if(this._environmentBRDFTexture&&Os.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(n._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;o.getCaps().standardDerivatives||e.isVerticesDataPresent(Oe.NormalKind)||(e.createNormals(!0),p.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const a=t.effect,l=n._areLightsDisposed;let h=this._prepareEffect(e,n,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),c=!1;if(h)if(this._onEffectCreatedObservable&&(Cn.effect=h,Cn.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Cn)),this.allowShaderHotSwapping&&a&&!h.isReady()){if(h=a,n.markAsUnprocessed(),c=this.isFrozen,l)return n._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(h,n,this._materialContext);return!(!t.effect||!t.effect.isReady()||(n._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!c,t.effect._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),0))}isMetallicWorkflow(){return!(null==this._metallic&&null==this._roughness&&!this._metallicTexture)}_prepareEffect(e,t,i=null,s=null,n=null,r=null,o){if(this._prepareDefines(e,t,n,r,o),!t.isDirty)return null;t.markAsProcessed();const a=this.getScene().getEngine(),l=new is;let h=0;t.USESPHERICALINVERTEX&&l.addFallback(h++,"USESPHERICALINVERTEX"),t.FOG&&l.addFallback(h,"FOG"),t.SPECULARAA&&l.addFallback(h,"SPECULARAA"),t.POINTSIZE&&l.addFallback(h,"POINTSIZE"),t.LOGARITHMICDEPTH&&l.addFallback(h,"LOGARITHMICDEPTH"),t.PARALLAX&&l.addFallback(h,"PARALLAX"),t.PARALLAX_RHS&&l.addFallback(h,"PARALLAX_RHS"),t.PARALLAXOCCLUSION&&l.addFallback(h++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&l.addFallback(h++,"ENVIRONMENTBRDF"),t.TANGENT&&l.addFallback(h++,"TANGENT"),t.BUMP&&l.addFallback(h++,"BUMP"),h=wi.HandleFallbacksForShadows(t,l,this._maxSimultaneousLights,h++),t.SPECULARTERM&&l.addFallback(h++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&l.addFallback(h++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&l.addFallback(h++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&l.addFallback(h++,"LIGHTMAP"),t.NORMAL&&l.addFallback(h++,"NORMAL"),t.AMBIENT&&l.addFallback(h++,"AMBIENT"),t.EMISSIVE&&l.addFallback(h++,"EMISSIVE"),t.VERTEXCOLOR&&l.addFallback(h++,"VERTEXCOLOR"),t.MORPHTARGETS&&l.addFallback(h++,"MORPHTARGETS"),t.MULTIVIEW&&l.addFallback(0,"MULTIVIEW");const c=[Oe.PositionKind];t.NORMAL&&c.push(Oe.NormalKind),t.TANGENT&&c.push(Oe.TangentKind);for(let e=1;e<=6;++e)t["UV"+e]&&c.push(`uv${1===e?"":e}`);t.VERTEXCOLOR&&c.push(Oe.ColorKind),wi.PrepareAttributesForBones(c,e,t,l),wi.PrepareAttributesForInstances(c,t),wi.PrepareAttributesForMorphTargets(c,e,t),wi.PrepareAttributesForBakedVertexAnimation(c,e,t);let d="pbr";const u=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],_=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],f=["Material","Scene","Mesh"],p={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=l,this._eventInfo.fallbackRank=h,this._eventInfo.defines=t,this._eventInfo.uniforms=u,this._eventInfo.attributes=c,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=f,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=p,this._callbackPluginEventGeneric(Rs.PrepareEffect,this._eventInfo),Es.AddUniforms(u),Es.AddSamplers(_),Di(u),Yt&&(Yt.PrepareUniforms(u,t),Yt.PrepareSamplers(_,t)),wi.PrepareUniformsAndSamplersList({uniformsNames:u,uniformBuffersNames:f,samplers:_,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const m={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,u,f,_,t,c,m));const g=t.toString(),v=a.createEffect(d,{attributes:c,uniformsNames:u,uniformBuffersNames:f,samplers:_,defines:g,fallbacks:l,onCompiled:i,onError:s,indexParameters:p,processFinalCode:m.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},a);return this._eventInfo.customCode=void 0,v}_prepareDefines(e,t,i=null,s=null,n=!1){var r;const o=this.getScene(),a=o.getEngine();wi.PrepareDefinesForLights(o,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,wi.PrepareDefinesForMultiview(o,t);const l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(wi.PrepareDefinesForPrePass(o,t,this.canRenderToMRT&&!l),wi.PrepareDefinesForOIT(o,t,l),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let e=1;e<=6;++e)t["MAINUV"+e]=!1;if(o.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,a.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&Os.DiffuseTextureEnabled?(wi.PrepareDefinesForMergedUV(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&Os.AmbientTextureEnabled?(wi.PrepareDefinesForMergedUV(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&Os.OpacityTextureEnabled?(wi.PrepareDefinesForMergedUV(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const e=this._getReflectionTexture();if(e&&Os.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=e.gammaSpace,t.RGBDREFLECTION=e.isRGBD,t.LODINREFLECTIONALPHA=e.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=e.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,a._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=e.coordinatesMode===zi.INVCUBIC_MODE,t.REFLECTIONMAP_3D=e.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.coordinatesMode){case zi.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case zi.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case zi.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case zi.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case zi.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case zi.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case zi.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case zi.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case zi.CUBIC_MODE:case zi.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!e.boundingBoxSize}e.coordinatesMode!==zi.SKYBOX_MODE&&(e.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):e.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||a.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&Os.LightmapTextureEnabled?(wi.PrepareDefinesForMergedUV(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&Os.EmissiveTextureEnabled?(wi.PrepareDefinesForMergedUV(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,Os.SpecularTextureEnabled){if(this._metallicTexture?(wi.PrepareDefinesForMergedUV(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(wi.PrepareDefinesForMergedUV(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){const e=null!==this._metallicReflectanceTexture&&this._metallicReflectanceTexture._texture===(null===(r=this._reflectanceTexture)||void 0===r?void 0:r._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!e,this._metallicReflectanceTexture?(wi.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!e&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(wi.PrepareDefinesForMergedUV(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1}else t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1;this._microSurfaceTexture?wi.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1}else t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1;a.getCaps().standardDerivatives&&this._bumpTexture&&Os.BumpTextureEnabled&&!this._disableBumpMap?(wi.PrepareDefinesForMergedUV(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&Os.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAX_RHS=o.useRightHandedSystem,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAX_RHS=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&Os.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===An.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===An.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=a.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1==0?".":""}`,t.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(wi.PrepareDefinesForMisc(e,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(Oe.NormalKind),t.DEBUGMODE=this._debugMode),wi.PrepareDefinesForFrameBoundValues(o,a,this,t,!!i,s,n),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),wi.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==An.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const s=Object.assign({clipPlane:!1,useInstances:!1},i);this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(Rs.GetDefineNames,this._eventInfo);const n=new yn(this._eventInfo.defineNames),r=this._prepareEffect(e,n,void 0,void 0,s.useInstances,s.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Cn.effect=r,Cn.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Cn)),r.isReady()?t&&t(this):r.onCompileObservable.add((()=>{t&&t(this)}))}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s,n,r,o;const a=this.getScene(),l=i.materialDefines;if(!l)return;const h=i.effect;if(!h)return;this._activeEffect=h,t.getMeshUniformBuffer().bindToEffect(h,"Mesh"),t.transferToEffect(e);const c=a.getEngine();this._uniformBuffer.bindToEffect(h,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,a,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),l.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const d=h._forceRebindOnNextCall||this._mustRebind(a,h,t.visibility);wi.BindBonesParameters(t,this._activeEffect,this.prePassConfiguration);let u=null;const _=this._uniformBuffer;if(d){if(this.bindViewProjection(h),u=this._getReflectionTexture(),!_.useUbo||!this.isFrozen||!_.isSync||h._forceRebindOnNextCall){if(a.texturesEnabled){if(this._albedoTexture&&Os.DiffuseTextureEnabled&&(_.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),wi.BindTextureMatrix(this._albedoTexture,_,"albedo")),this._ambientTexture&&Os.AmbientTextureEnabled&&(_.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),wi.BindTextureMatrix(this._ambientTexture,_,"ambient")),this._opacityTexture&&Os.OpacityTextureEnabled&&(_.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),wi.BindTextureMatrix(this._opacityTexture,_,"opacity")),u&&Os.ReflectionTextureEnabled){if(_.updateMatrix("reflectionMatrix",u.getReflectionTextureMatrix()),_.updateFloat2("vReflectionInfos",u.level,0),u.boundingBoxSize){const e=u;_.updateVector3("vReflectionPosition",e.boundingBoxPosition),_.updateVector3("vReflectionSize",e.boundingBoxSize)}if(this.realTimeFiltering){const e=u.getSize().width;_.updateFloat2("vReflectionFilteringInfo",e,ne.Log2(e))}if(!l.USEIRRADIANCEMAP){const e=u.sphericalPolynomial;if(l.USESPHERICALFROMREFLECTIONMAP&&e)if(l.SPHERICAL_HARMONICS){const t=e.preScaledHarmonics;_.updateVector3("vSphericalL00",t.l00),_.updateVector3("vSphericalL1_1",t.l1_1),_.updateVector3("vSphericalL10",t.l10),_.updateVector3("vSphericalL11",t.l11),_.updateVector3("vSphericalL2_2",t.l2_2),_.updateVector3("vSphericalL2_1",t.l2_1),_.updateVector3("vSphericalL20",t.l20),_.updateVector3("vSphericalL21",t.l21),_.updateVector3("vSphericalL22",t.l22)}else _.updateFloat3("vSphericalX",e.x.x,e.x.y,e.x.z),_.updateFloat3("vSphericalY",e.y.x,e.y.y,e.y.z),_.updateFloat3("vSphericalZ",e.z.x,e.z.y,e.z.z),_.updateFloat3("vSphericalXX_ZZ",e.xx.x-e.zz.x,e.xx.y-e.zz.y,e.xx.z-e.zz.z),_.updateFloat3("vSphericalYY_ZZ",e.yy.x-e.zz.x,e.yy.y-e.zz.y,e.yy.z-e.zz.z),_.updateFloat3("vSphericalZZ",e.zz.x,e.zz.y,e.zz.z),_.updateFloat3("vSphericalXY",e.xy.x,e.xy.y,e.xy.z),_.updateFloat3("vSphericalYZ",e.yz.x,e.yz.y,e.yz.z),_.updateFloat3("vSphericalZX",e.zx.x,e.zx.y,e.zx.z)}_.updateFloat3("vReflectionMicrosurfaceInfos",u.getSize().width,u.lodGenerationScale,u.lodGenerationOffset)}this._emissiveTexture&&Os.EmissiveTextureEnabled&&(_.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),wi.BindTextureMatrix(this._emissiveTexture,_,"emissive")),this._lightmapTexture&&Os.LightmapTextureEnabled&&(_.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),wi.BindTextureMatrix(this._lightmapTexture,_,"lightmap")),Os.SpecularTextureEnabled&&(this._metallicTexture?(_.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),wi.BindTextureMatrix(this._metallicTexture,_,"reflectivity")):this._reflectivityTexture&&(_.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),wi.BindTextureMatrix(this._reflectivityTexture,_,"reflectivity")),this._metallicReflectanceTexture&&(_.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),wi.BindTextureMatrix(this._metallicReflectanceTexture,_,"metallicReflectance")),this._reflectanceTexture&&l.REFLECTANCE&&(_.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),wi.BindTextureMatrix(this._reflectanceTexture,_,"reflectance")),this._microSurfaceTexture&&(_.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),wi.BindTextureMatrix(this._microSurfaceTexture,_,"microSurfaceSampler"))),this._bumpTexture&&c.getCaps().standardDerivatives&&Os.BumpTextureEnabled&&!this._disableBumpMap&&(_.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),wi.BindTextureMatrix(this._bumpTexture,_,"bump"),a._mirroredCameraPosition?_.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):_.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&_.updateFloat("pointSize",this.pointSize),l.METALLICWORKFLOW){Pe.Color3[0].r=void 0===this._metallic||null===this._metallic?1:this._metallic,Pe.Color3[0].g=void 0===this._roughness||null===this._roughness?1:this._roughness,_.updateColor4("vReflectivityColor",Pe.Color3[0],1);const e=null!==(n=null===(s=this.subSurface)||void 0===s?void 0:s._indexOfRefraction)&&void 0!==n?n:1.5,t=1,i=Math.pow((e-t)/(e+t),2);this._metallicReflectanceColor.scaleToRef(i*this._metallicF0Factor,Pe.Color3[0]);const r=this._metallicF0Factor;_.updateColor4("vMetallicReflectanceFactors",Pe.Color3[0],r)}else _.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);_.updateColor3("vEmissiveColor",Os.EmissiveTextureEnabled?this._emissiveColor:Re.BlackReadOnly),_.updateColor3("vReflectionColor",this._reflectionColor),!l.SS_REFRACTION&&(null===(r=this.subSurface)||void 0===r?void 0:r._linkRefractionWithTransparency)?_.updateColor4("vAlbedoColor",this._albedoColor,1):_.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*a.environmentIntensity,this._lightingInfos.w=this._specularIntensity,_.updateVector4("vLightingIntensity",this._lightingInfos),a.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),_.updateColor3("vAmbientColor",this._globalAmbientColor),_.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}a.texturesEnabled&&(this._albedoTexture&&Os.DiffuseTextureEnabled&&_.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&Os.AmbientTextureEnabled&&_.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Os.OpacityTextureEnabled&&_.setTexture("opacitySampler",this._opacityTexture),u&&Os.ReflectionTextureEnabled&&(l.LODBASEDMICROSFURACE?_.setTexture("reflectionSampler",u):(_.setTexture("reflectionSampler",u._lodTextureMid||u),_.setTexture("reflectionSamplerLow",u._lodTextureLow||u),_.setTexture("reflectionSamplerHigh",u._lodTextureHigh||u)),l.USEIRRADIANCEMAP&&_.setTexture("irradianceSampler",u.irradianceTexture)),l.ENVIRONMENTBRDF&&_.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&Os.EmissiveTextureEnabled&&_.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Os.LightmapTextureEnabled&&_.setTexture("lightmapSampler",this._lightmapTexture),Os.SpecularTextureEnabled&&(this._metallicTexture?_.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&_.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&_.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&l.REFLECTANCE&&_.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&_.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&c.getCaps().standardDerivatives&&Os.BumpTextureEnabled&&!this._disableBumpMap&&_.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(h),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Fi(this._activeEffect,this,a),this.bindEyePosition(h)}else a.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);!d&&this.isFrozen||(a.lightsEnabled&&!this._disableLighting&&wi.BindLights(a,t,this._activeEffect,l,this._maxSimultaneousLights),(a.fogEnabled&&t.applyFog&&a.fogMode!==Oi.FOGMODE_NONE||u||this.subSurface.refractionTexture||t.receiveShadows||l.PREPASS)&&this.bindView(h),wi.BindFogParameters(a,t,this._activeEffect,!0),l.NUM_MORPH_INFLUENCERS&&wi.BindMorphTargetParameters(t,this._activeEffect),l.BAKED_VERTEX_ANIMATION_TEXTURE&&(null===(o=t.bakedVertexAnimationManager)||void 0===o||o.bind(h,l.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),wi.BindLogDepth(l,this._activeEffect,a)),this._afterBind(t,this._activeEffect),_.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e}setPrePassRenderer(){var e;if(!(null===(e=this.subSurface)||void 0===e?void 0:e.isScatteringEnabled))return!1;const t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}dispose(e,t){var i,s,n,r,o,a,l,h,c,d,u,_;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),null===(i=this._albedoTexture)||void 0===i||i.dispose(),null===(s=this._ambientTexture)||void 0===s||s.dispose(),null===(n=this._opacityTexture)||void 0===n||n.dispose(),null===(r=this._reflectionTexture)||void 0===r||r.dispose(),null===(o=this._emissiveTexture)||void 0===o||o.dispose(),null===(a=this._metallicTexture)||void 0===a||a.dispose(),null===(l=this._reflectivityTexture)||void 0===l||l.dispose(),null===(h=this._bumpTexture)||void 0===h||h.dispose(),null===(c=this._lightmapTexture)||void 0===c||c.dispose(),null===(d=this._metallicReflectanceTexture)||void 0===d||d.dispose(),null===(u=this._reflectanceTexture)||void 0===u||u.dispose(),null===(_=this._microSurfaceTexture)||void 0===_||_.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}An.PBRMATERIAL_OPAQUE=Ps.MATERIAL_OPAQUE,An.PBRMATERIAL_ALPHATEST=Ps.MATERIAL_ALPHATEST,An.PBRMATERIAL_ALPHABLEND=Ps.MATERIAL_ALPHABLEND,An.PBRMATERIAL_ALPHATESTANDBLEND=Ps.MATERIAL_ALPHATESTANDBLEND,An.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,An.LIGHTFALLOFF_PHYSICAL=0,An.LIGHTFALLOFF_GLTF=1,An.LIGHTFALLOFF_STANDARD=2,De([je()],An.prototype,"_imageProcessingConfiguration",void 0),De([Ve("_markAllSubMeshesAsMiscDirty")],An.prototype,"debugMode",void 0);class Rn extends An{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===An.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?An.LIGHTFALLOFF_PHYSICAL:An.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===An.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?An.LIGHTFALLOFF_GLTF:An.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=Rn.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=Re.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new Re(0,0,0),this.albedoColor=new Re(1,1,1),this.reflectivityColor=new Re(1,1,1),this.reflectionColor=new Re(1,1,1),this.emissiveColor=new Re(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=$s(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){const s=qe.Clone((()=>new Rn(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return s.id=e,s.name=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){const s=qe.Parse((()=>new Rn(e.name,t)),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),Ps._parsePlugins(e,s,t,i),e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}Rn.PBRMATERIAL_OPAQUE=An.PBRMATERIAL_OPAQUE,Rn.PBRMATERIAL_ALPHATEST=An.PBRMATERIAL_ALPHATEST,Rn.PBRMATERIAL_ALPHABLEND=An.PBRMATERIAL_ALPHABLEND,Rn.PBRMATERIAL_ALPHATESTANDBLEND=An.PBRMATERIAL_ALPHATESTANDBLEND,Rn.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=An.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"directIntensity",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"emissiveIntensity",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"environmentIntensity",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"specularIntensity",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"disableBumpMap",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"albedoTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"ambientTexture",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"ambientTextureStrength",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesAndMiscDirty")],Rn.prototype,"opacityTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"reflectionTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"emissiveTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"reflectivityTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"metallicTexture",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"metallic",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"roughness",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"metallicF0Factor",void 0),De([He(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"metallicReflectanceColor",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"metallicReflectanceTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"reflectanceTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"microSurfaceTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"bumpTexture",void 0),De([ze(),Ve("_markAllSubMeshesAsTexturesDirty",null)],Rn.prototype,"lightmapTexture",void 0),De([He("ambient"),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"ambientColor",void 0),De([He("albedo"),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"albedoColor",void 0),De([He("reflectivity"),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"reflectivityColor",void 0),De([He("reflection"),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"reflectionColor",void 0),De([He("emissive"),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"emissiveColor",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"microSurface",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useLightmapAsShadowmap",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesAndMiscDirty")],Rn.prototype,"useAlphaFromAlbedoTexture",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesAndMiscDirty")],Rn.prototype,"forceAlphaTest",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesAndMiscDirty")],Rn.prototype,"alphaCutOff",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useSpecularOverAlpha",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useRoughnessFromMetallicTextureGreen",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useMetallnessFromMetallicTextureBlue",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useAmbientInGrayScale",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),De([Ge()],Rn.prototype,"usePhysicalLightFalloff",null),De([Ge()],Rn.prototype,"useGLTFLightFalloff",null),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useRadianceOverAlpha",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useObjectSpaceNormalMap",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useParallax",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useParallaxOcclusion",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"parallaxScaleBias",void 0),De([Ge(),Ve("_markAllSubMeshesAsLightsDirty")],Rn.prototype,"disableLighting",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"forceIrradianceInFragment",void 0),De([Ge(),Ve("_markAllSubMeshesAsLightsDirty")],Rn.prototype,"maxSimultaneousLights",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"invertNormalMapX",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"invertNormalMapY",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"twoSidedLighting",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useAlphaFresnel",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useLinearAlphaFresnel",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"environmentBRDFTexture",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"forceNormalForward",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"enableSpecularAntiAliasing",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useHorizonOcclusion",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],Rn.prototype,"useRadianceOcclusion",void 0),De([Ge(),Ve("_markAllSubMeshesAsMiscDirty")],Rn.prototype,"unlit",void 0),De([Ge(),Ve("_markAllSubMeshesAsMiscDirty")],Rn.prototype,"applyDecalMapAfterDetailMap",void 0),ue("BABYLON.PBRMaterial",Rn),et.AddNodeConstructor("Light_Type_3",((e,t)=>()=>new In(e,me.Zero(),t)));class In extends Lt{constructor(e,t,i){super(e,i),this.groundColor=new Re(0,0,0),this.direction=t||me.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=me.Normalize(e.subtract(me.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=me.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=me.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=Te.Identity()),this._worldMatrix}getTypeID(){return Lt.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}function Pn(e,t,i){try{const s=e.next();s.done?t(s):s.value?s.value.then((()=>{s.value=void 0,t(s)}),i):t(s)}catch(e){i(e)}}function Mn(e,t,i,s,n){const r=()=>{let o;const a=e=>{e.done?i(e.value):void 0===o?o=!0:r()};do{o=void 0,n&&n.aborted?s(new Error("Aborted")):t(e,a,s),void 0===o&&(o=!1)}while(o)};r()}function On(e,t){let i;return Mn(e,Pn,(e=>i=e),(e=>{throw e}),t),i}De([He()],In.prototype,"groundColor",void 0),De([Qe()],In.prototype,"direction",void 0);class Dn{}class Nn{constructor(){var e;this.uniqueId=0,this.metadata={},this._applyTo=(e=this._applyToCoroutine.bind(this),(...t)=>On(e(...t),undefined)),this.uniqueId=Nn._UniqueIDGenerator,Nn._UniqueIDGenerator++}set(e,t){switch(e.length||p.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case Oe.PositionKind:this.positions=e;break;case Oe.NormalKind:this.normals=e;break;case Oe.TangentKind:this.tangents=e;break;case Oe.UVKind:this.uvs=e;break;case Oe.UV2Kind:this.uvs2=e;break;case Oe.UV3Kind:this.uvs3=e;break;case Oe.UV4Kind:this.uvs4=e;break;case Oe.UV5Kind:this.uvs5=e;break;case Oe.UV6Kind:this.uvs6=e;break;case Oe.ColorKind:this.colors=e;break;case Oe.MatricesIndicesKind:this.matricesIndices=e;break;case Oe.MatricesWeightsKind:this.matricesWeights=e;break;case Oe.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case Oe.MatricesWeightsExtraKind:this.matricesWeightsExtra=e}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){if(this.positions&&(e.setVerticesData(Oe.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(Oe.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(Oe.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(Oe.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(Oe.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(Oe.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(Oe.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(Oe.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(Oe.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(Oe.ColorKind,this.colors,t),i&&(yield)),this.matricesIndices&&(e.setVerticesData(Oe.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(Oe.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(Oe.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(Oe.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){const t=e;t.subMeshes=[];for(const e of this.materialInfos)new ys(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,t)}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(Oe.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(Oe.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(Oe.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(Oe.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(Oe.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(Oe.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(Oe.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(Oe.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(Oe.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(Oe.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(Oe.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(Oe.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(Oe.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(Oe.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,s=e.length){const n=Ee.Vector3[0],r=Ee.Vector3[1];for(let o=i;o<i+s;o+=3)me.FromArrayToRef(e,o,n),me.TransformCoordinatesToRef(n,t,r),e[o]=r.x,e[o+1]=r.y,e[o+2]=r.z}static _TransformVector3Normals(e,t,i=0,s=e.length){const n=Ee.Vector3[0],r=Ee.Vector3[1];for(let o=i;o<i+s;o+=3)me.FromArrayToRef(e,o,n),me.TransformNormalToRef(n,t,r),e[o]=r.x,e[o+1]=r.y,e[o+2]=r.z}static _TransformVector4Normals(e,t,i=0,s=e.length){const n=Ee.Vector4[0],r=Ee.Vector4[1];for(let o=i;o<i+s;o+=4)ge.FromArrayToRef(e,o,n),ge.TransformNormalToRef(n,t,r),e[o]=r.x,e[o+1]=r.y,e[o+2]=r.z,e[o+3]=r.w}static _FlipFaces(e,t=0,i=e.length){for(let s=t;s<t+i;s+=3){const t=e[s+1];e[s+1]=e[s+2],e[s+2]=t}}transform(e){const t=e.determinant()<0;return this.positions&&Nn._TransformVector3Coordinates(this.positions,e),this.normals&&Nn._TransformVector3Normals(this.normals,e),this.tangents&&Nn._TransformVector4Normals(this.tangents,e),t&&this.indices&&Nn._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];const e=[];for(const t of this.materialInfos){const i=new Nn;if(this.positions&&(i.positions=this.positions.slice(3*t.verticesStart,3*(t.verticesCount+t.verticesStart))),this.normals&&(i.normals=this.normals.slice(3*t.verticesStart,3*(t.verticesCount+t.verticesStart))),this.tangents&&(i.tangents=this.tangents.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.colors&&(i.colors=this.colors.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.uvs&&(i.uvs=this.uvs.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs2&&(i.uvs2=this.uvs2.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs3&&(i.uvs3=this.uvs3.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs4&&(i.uvs4=this.uvs4.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs5&&(i.uvs5=this.uvs5.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.uvs6&&(i.uvs6=this.uvs6.slice(2*t.verticesStart,2*(t.verticesCount+t.verticesStart))),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(4*t.verticesStart,4*(t.verticesCount+t.verticesStart))),this.indices){i.indices=[];for(let e=t.indexStart;e<t.indexStart+t.indexCount;e++)i.indices.push(this.indices[e]-t.verticesStart)}const s=new Dn;s.indexStart=0,s.indexCount=i.indices?i.indices.length:0,s.materialIndex=t.materialIndex,s.verticesStart=0,s.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[s],e.push(i)}return e}merge(e,t=!1,i=!1,s=!1,n=!1){const r=Array.isArray(e)?e.map((e=>({vertexData:e}))):[{vertexData:e}];return On(this._mergeCoroutine(void 0,r,t,!1,i,s,n))}*_mergeCoroutine(e,t,i=!1,s,n,r=!1,o=!1){var a,l,h,c;this._validate();let d=t.map((e=>e.vertexData)),u=this;if(o)for(const e of d)e&&(e._validate(),!this.normals&&e.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&e.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&e.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&e.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&e.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&e.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&e.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&e.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&e.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&e.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&e.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&e.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&e.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(const e of d)if(e)if(o)this.normals&&!e.normals&&(e.normals=new Float32Array(e.positions.length)),this.tangents&&!e.tangents&&(e.tangents=new Float32Array(e.positions.length/3*4)),this.uvs&&!e.uvs&&(e.uvs=new Float32Array(e.positions.length/3*2)),this.uvs2&&!e.uvs2&&(e.uvs2=new Float32Array(e.positions.length/3*2)),this.uvs3&&!e.uvs3&&(e.uvs3=new Float32Array(e.positions.length/3*2)),this.uvs4&&!e.uvs4&&(e.uvs4=new Float32Array(e.positions.length/3*2)),this.uvs5&&!e.uvs5&&(e.uvs5=new Float32Array(e.positions.length/3*2)),this.uvs6&&!e.uvs6&&(e.uvs6=new Float32Array(e.positions.length/3*2)),this.colors&&!e.colors&&(e.colors=new Float32Array(e.positions.length/3*4),e.colors.fill(1)),this.matricesIndices&&!e.matricesIndices&&(e.matricesIndices=new Float32Array(e.positions.length/3*4)),this.matricesWeights&&!e.matricesWeights&&(e.matricesWeights=new Float32Array(e.positions.length/3*4)),this.matricesIndicesExtra&&!e.matricesIndicesExtra&&(e.matricesIndicesExtra=new Float32Array(e.positions.length/3*4)),this.matricesWeightsExtra&&!e.matricesWeightsExtra&&(e.matricesWeightsExtra=new Float32Array(e.positions.length/3*4));else if(e._validate(),!this.normals!=!e.normals||!this.tangents!=!e.tangents||!this.uvs!=!e.uvs||!this.uvs2!=!e.uvs2||!this.uvs3!=!e.uvs3||!this.uvs4!=!e.uvs4||!this.uvs5!=!e.uvs5||!this.uvs6!=!e.uvs6||!this.colors!=!e.colors||!this.matricesIndices!=!e.matricesIndices||!this.matricesWeights!=!e.matricesWeights||!this.matricesIndicesExtra!=!e.matricesIndicesExtra||!this.matricesWeightsExtra!=!e.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");if(r){let i=0,s=0,n=0;const r=[];let o=null;const a=[];for(const t of this.splitBasedOnMaterialID())a.push({vertexData:t,transform:e});for(const e of t)if(e.vertexData)for(const t of e.vertexData.splitBasedOnMaterialID())a.push({vertexData:t,transform:e.transform});a.sort(((e,t)=>{const i=e.vertexData.materialInfos?e.vertexData.materialInfos[0].materialIndex:0,s=t.vertexData.materialInfos?t.vertexData.materialInfos[0].materialIndex:0;return i>s?1:i===s?0:-1}));for(const e of a){const t=e.vertexData;if(i=t.materialInfos?t.materialInfos[0].materialIndex:0,o&&o.materialIndex===i)o.indexCount+=t.indices.length,o.verticesCount+=t.positions.length/3;else{const e=new Dn;e.materialIndex=i,e.indexStart=s,e.indexCount=t.indices.length,e.verticesStart=n,e.verticesCount=t.positions.length/3,r.push(e),o=e}s+=t.indices.length,n+=t.positions.length/3}const l=a.splice(0,1)[0];u=l.vertexData,e=l.transform,d=a.map((e=>e.vertexData)),t=a,this.materialInfos=r}const _=d.reduce(((e,t)=>{var i,s;return e+(null!==(s=null===(i=t.indices)||void 0===i?void 0:i.length)&&void 0!==s?s:0)}),null!==(l=null===(a=u.indices)||void 0===a?void 0:a.length)&&void 0!==l?l:0);let f=n||d.some((e=>e.indices===u.indices))?null===(h=u.indices)||void 0===h?void 0:h.slice():u.indices;if(_>0){let n=null!==(c=null==f?void 0:f.length)&&void 0!==c?c:0;if(f||(f=new Array(_)),f.length!==_){if(Array.isArray(f))f.length=_;else{const e=i||f instanceof Uint32Array?new Uint32Array(_):new Uint16Array(_);e.set(f),f=e}e&&e.determinant()<0&&Nn._FlipFaces(f,0,n)}let r=u.positions?u.positions.length/3:0;for(const{vertexData:e,transform:i}of t)if(e.indices){for(let t=0;t<e.indices.length;t++)f[n+t]=e.indices[t]+r;i&&i.determinant()<0&&Nn._FlipFaces(f,n,e.indices.length),r+=e.positions.length/3,n+=e.indices.length,s&&(yield)}}return this.indices=f,this.positions=Nn._MergeElement(Oe.PositionKind,u.positions,e,t.map((e=>[e.vertexData.positions,e.transform]))),s&&(yield),u.normals&&(this.normals=Nn._MergeElement(Oe.NormalKind,u.normals,e,t.map((e=>[e.vertexData.normals,e.transform]))),s&&(yield)),u.tangents&&(this.tangents=Nn._MergeElement(Oe.TangentKind,u.tangents,e,t.map((e=>[e.vertexData.tangents,e.transform]))),s&&(yield)),u.uvs&&(this.uvs=Nn._MergeElement(Oe.UVKind,u.uvs,e,t.map((e=>[e.vertexData.uvs,e.transform]))),s&&(yield)),u.uvs2&&(this.uvs2=Nn._MergeElement(Oe.UV2Kind,u.uvs2,e,t.map((e=>[e.vertexData.uvs2,e.transform]))),s&&(yield)),u.uvs3&&(this.uvs3=Nn._MergeElement(Oe.UV3Kind,u.uvs3,e,t.map((e=>[e.vertexData.uvs3,e.transform]))),s&&(yield)),u.uvs4&&(this.uvs4=Nn._MergeElement(Oe.UV4Kind,u.uvs4,e,t.map((e=>[e.vertexData.uvs4,e.transform]))),s&&(yield)),u.uvs5&&(this.uvs5=Nn._MergeElement(Oe.UV5Kind,u.uvs5,e,t.map((e=>[e.vertexData.uvs5,e.transform]))),s&&(yield)),u.uvs6&&(this.uvs6=Nn._MergeElement(Oe.UV6Kind,u.uvs6,e,t.map((e=>[e.vertexData.uvs6,e.transform]))),s&&(yield)),u.colors&&(this.colors=Nn._MergeElement(Oe.ColorKind,u.colors,e,t.map((e=>[e.vertexData.colors,e.transform]))),s&&(yield)),u.matricesIndices&&(this.matricesIndices=Nn._MergeElement(Oe.MatricesIndicesKind,u.matricesIndices,e,t.map((e=>[e.vertexData.matricesIndices,e.transform]))),s&&(yield)),u.matricesWeights&&(this.matricesWeights=Nn._MergeElement(Oe.MatricesWeightsKind,u.matricesWeights,e,t.map((e=>[e.vertexData.matricesWeights,e.transform]))),s&&(yield)),u.matricesIndicesExtra&&(this.matricesIndicesExtra=Nn._MergeElement(Oe.MatricesIndicesExtraKind,u.matricesIndicesExtra,e,t.map((e=>[e.vertexData.matricesIndicesExtra,e.transform]))),s&&(yield)),u.matricesWeightsExtra&&(this.matricesWeightsExtra=Nn._MergeElement(Oe.MatricesWeightsExtraKind,u.matricesWeightsExtra,e,t.map((e=>[e.vertexData.matricesWeightsExtra,e.transform])))),this}static _MergeElement(e,t,i,s){const n=s.filter((e=>null!==e[0]&&void 0!==e[0]));if(!t&&0==n.length)return t;if(!t)return this._MergeElement(e,n[0][0],n[0][1],n.slice(1));const r=n.reduce(((e,t)=>e+t[0].length),t.length),o=e===Oe.PositionKind?Nn._TransformVector3Coordinates:e===Oe.NormalKind?Nn._TransformVector3Normals:e===Oe.TangentKind?Nn._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const e=new Float32Array(r);e.set(t),i&&o(e,i,0,t.length);let s=t.length;for(const[t,i]of n)e.set(t,s),i&&o(e,i,s,t.length),s+=t.length;return e}{const e=new Array(r);for(let i=0;i<t.length;i++)e[i]=t[i];i&&o(e,i,0,t.length);let s=t.length;for(const[t,i]of n){for(let i=0;i<t.length;i++)e[s+i]=t[i];i&&o(e,i,s,t.length),s+=t.length}return e}}_validate(){if(!this.positions)throw new at("Positions are required",0);const e=(e,t)=>{const i=Oe.DeduceStride(e);if(t.length%i!=0)throw new Error("The "+e+"s array count must be a multiple of "+i);return t.length/i},t=e(Oe.PositionKind,this.positions),i=(i,s)=>{const n=e(i,s);if(n!==t)throw new Error("The "+i+"s element count ("+n+") does not match the positions count ("+t+")")};this.normals&&i(Oe.NormalKind,this.normals),this.tangents&&i(Oe.TangentKind,this.tangents),this.uvs&&i(Oe.UVKind,this.uvs),this.uvs2&&i(Oe.UV2Kind,this.uvs2),this.uvs3&&i(Oe.UV3Kind,this.uvs3),this.uvs4&&i(Oe.UV4Kind,this.uvs4),this.uvs5&&i(Oe.UV5Kind,this.uvs5),this.uvs6&&i(Oe.UV6Kind,this.uvs6),this.colors&&i(Oe.ColorKind,this.colors),this.matricesIndices&&i(Oe.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(Oe.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(Oe.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(Oe.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){const e=this.serialize();return Nn.Parse(e)}serialize(){const e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors)),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=Array.from(this.indices),this.materialInfos){e.materialInfos=[];for(const t of this.materialInfos){const i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i)}}return e}static ExtractFromMesh(e,t,i){return Nn._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return Nn._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const s=new Nn;return e.isVerticesDataPresent(Oe.PositionKind)&&(s.positions=e.getVerticesData(Oe.PositionKind,t,i)),e.isVerticesDataPresent(Oe.NormalKind)&&(s.normals=e.getVerticesData(Oe.NormalKind,t,i)),e.isVerticesDataPresent(Oe.TangentKind)&&(s.tangents=e.getVerticesData(Oe.TangentKind,t,i)),e.isVerticesDataPresent(Oe.UVKind)&&(s.uvs=e.getVerticesData(Oe.UVKind,t,i)),e.isVerticesDataPresent(Oe.UV2Kind)&&(s.uvs2=e.getVerticesData(Oe.UV2Kind,t,i)),e.isVerticesDataPresent(Oe.UV3Kind)&&(s.uvs3=e.getVerticesData(Oe.UV3Kind,t,i)),e.isVerticesDataPresent(Oe.UV4Kind)&&(s.uvs4=e.getVerticesData(Oe.UV4Kind,t,i)),e.isVerticesDataPresent(Oe.UV5Kind)&&(s.uvs5=e.getVerticesData(Oe.UV5Kind,t,i)),e.isVerticesDataPresent(Oe.UV6Kind)&&(s.uvs6=e.getVerticesData(Oe.UV6Kind,t,i)),e.isVerticesDataPresent(Oe.ColorKind)&&(s.colors=e.getVerticesData(Oe.ColorKind,t,i)),e.isVerticesDataPresent(Oe.MatricesIndicesKind)&&(s.matricesIndices=e.getVerticesData(Oe.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(Oe.MatricesWeightsKind)&&(s.matricesWeights=e.getVerticesData(Oe.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(Oe.MatricesIndicesExtraKind)&&(s.matricesIndicesExtra=e.getVerticesData(Oe.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(Oe.MatricesWeightsExtraKind)&&(s.matricesWeightsExtra=e.getVerticesData(Oe.MatricesWeightsExtraKind,t,i)),s.indices=e.getIndices(t,i),s}static CreateRibbon(e){throw f("ribbonBuilder")}static CreateBox(e){throw f("boxBuilder")}static CreateTiledBox(e){throw f("tiledBoxBuilder")}static CreateTiledPlane(e){throw f("tiledPlaneBuilder")}static CreateSphere(e){throw f("sphereBuilder")}static CreateCylinder(e){throw f("cylinderBuilder")}static CreateTorus(e){throw f("torusBuilder")}static CreateLineSystem(e){throw f("linesBuilder")}static CreateDashedLines(e){throw f("linesBuilder")}static CreateGround(e){throw f("groundBuilder")}static CreateTiledGround(e){throw f("groundBuilder")}static CreateGroundFromHeightMap(e){throw f("groundBuilder")}static CreatePlane(e){throw f("planeBuilder")}static CreateDisc(e){throw f("discBuilder")}static CreatePolygon(e,t,i,s,n,r,o){throw f("polygonBuilder")}static CreateIcoSphere(e){throw f("icoSphereBuilder")}static CreatePolyhedron(e){throw f("polyhedronBuilder")}static CreateCapsule(e={orientation:me.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw f("capsuleBuilder")}static CreateTorusKnot(e){throw f("torusKnotBuilder")}static ComputeNormals(e,t,i,s){let n=0,r=0,o=0,a=0,l=0,h=0,c=0,d=0,u=0,_=0,f=0,p=0,m=0,g=0,v=0,T=0,b=0,E=0,S=0,x=0,C=!1,y=!1,A=!1,R=!1,I=1,P=0,M=null;s&&(C=!!s.facetNormals,y=!!s.facetPositions,A=!!s.facetPartitioning,I=!0===s.useRightHandedSystem?-1:1,P=s.ratio||0,R=!!s.depthSort,M=s.distanceTo,R&&void 0===M&&(M=me.Zero()));let O=0,D=0,N=0,F=0;for(A&&s&&s.bbSize&&(O=s.subDiv.X*P/s.bbSize.x,D=s.subDiv.Y*P/s.bbSize.y,N=s.subDiv.Z*P/s.bbSize.z,F=s.subDiv.max*s.subDiv.max,s.facetPartitioning.length=0),n=0;n<e.length;n++)i[n]=0;const L=t.length/3|0;for(n=0;n<L;n++){if(p=3*t[3*n],m=p+1,g=p+2,v=3*t[3*n+1],T=v+1,b=v+2,E=3*t[3*n+2],S=E+1,x=E+2,r=e[p]-e[v],o=e[m]-e[T],a=e[g]-e[b],l=e[E]-e[v],h=e[S]-e[T],c=e[x]-e[b],d=I*(o*c-a*h),u=I*(a*l-r*c),_=I*(r*h-o*l),f=Math.sqrt(d*d+u*u+_*_),f=0===f?1:f,d/=f,u/=f,_/=f,C&&s&&(s.facetNormals[n].x=d,s.facetNormals[n].y=u,s.facetNormals[n].z=_),y&&s&&(s.facetPositions[n].x=(e[p]+e[v]+e[E])/3,s.facetPositions[n].y=(e[m]+e[T]+e[S])/3,s.facetPositions[n].z=(e[g]+e[b]+e[x])/3),A&&s){const t=Math.floor((s.facetPositions[n].x-s.bInfo.minimum.x*P)*O),i=Math.floor((s.facetPositions[n].y-s.bInfo.minimum.y*P)*D),r=Math.floor((s.facetPositions[n].z-s.bInfo.minimum.z*P)*N),o=Math.floor((e[p]-s.bInfo.minimum.x*P)*O),a=Math.floor((e[m]-s.bInfo.minimum.y*P)*D),l=Math.floor((e[g]-s.bInfo.minimum.z*P)*N),h=Math.floor((e[v]-s.bInfo.minimum.x*P)*O),c=Math.floor((e[T]-s.bInfo.minimum.y*P)*D),d=Math.floor((e[b]-s.bInfo.minimum.z*P)*N),u=Math.floor((e[E]-s.bInfo.minimum.x*P)*O),_=Math.floor((e[S]-s.bInfo.minimum.y*P)*D),f=Math.floor((e[x]-s.bInfo.minimum.z*P)*N),C=o+s.subDiv.max*a+F*l,y=h+s.subDiv.max*c+F*d,A=u+s.subDiv.max*_+F*f,R=t+s.subDiv.max*i+F*r;s.facetPartitioning[R]=s.facetPartitioning[R]?s.facetPartitioning[R]:new Array,s.facetPartitioning[C]=s.facetPartitioning[C]?s.facetPartitioning[C]:new Array,s.facetPartitioning[y]=s.facetPartitioning[y]?s.facetPartitioning[y]:new Array,s.facetPartitioning[A]=s.facetPartitioning[A]?s.facetPartitioning[A]:new Array,s.facetPartitioning[C].push(n),y!=C&&s.facetPartitioning[y].push(n),A!=y&&A!=C&&s.facetPartitioning[A].push(n),R!=C&&R!=y&&R!=A&&s.facetPartitioning[R].push(n)}if(R&&s&&s.facetPositions){const e=s.depthSortedFacets[n];e.ind=3*n,e.sqDistance=me.DistanceSquared(s.facetPositions[n],M)}i[p]+=d,i[m]+=u,i[g]+=_,i[v]+=d,i[T]+=u,i[b]+=_,i[E]+=d,i[S]+=u,i[x]+=_}for(n=0;n<i.length/3;n++)d=i[3*n],u=i[3*n+1],_=i[3*n+2],f=Math.sqrt(d*d+u*u+_*_),f=0===f?1:f,d/=f,u/=f,_/=f,i[3*n]=d,i[3*n+1]=u,i[3*n+2]=_}static _ComputeSides(e,t,i,s,n,r,o){const a=i.length,l=s.length;let h,c;switch(e=e||Nn.DEFAULTSIDE){case Nn.FRONTSIDE:break;case Nn.BACKSIDE:for(h=0;h<a;h+=3){const e=i[h];i[h]=i[h+2],i[h+2]=e}for(c=0;c<l;c++)s[c]=-s[c];break;case Nn.DOUBLESIDE:{const e=t.length,d=e/3;for(let i=0;i<e;i++)t[e+i]=t[i];for(h=0;h<a;h+=3)i[h+a]=i[h+2]+d,i[h+1+a]=i[h+1]+d,i[h+2+a]=i[h]+d;for(c=0;c<l;c++)s[l+c]=-s[c];const u=n.length;let _=0;for(_=0;_<u;_++)n[_+u]=n[_];for(r=r||new ge(0,0,1,1),o=o||new ge(0,0,1,1),_=0,h=0;h<u/2;h++)n[_]=r.x+(r.z-r.x)*n[_],n[_+1]=r.y+(r.w-r.y)*n[_+1],n[_+u]=o.x+(o.z-o.x)*n[_+u],n[_+u+1]=o.y+(o.w-o.y)*n[_+u+1],_+=2;break}}}static Parse(e){const t=new Nn,i=e.positions;i&&t.set(i,Oe.PositionKind);const s=e.normals;s&&t.set(s,Oe.NormalKind);const n=e.tangents;n&&t.set(n,Oe.TangentKind);const r=e.uvs;r&&t.set(r,Oe.UVKind);const o=e.uvs2;o&&t.set(o,Oe.UV2Kind);const a=e.uvs3;a&&t.set(a,Oe.UV3Kind);const l=e.uvs4;l&&t.set(l,Oe.UV4Kind);const h=e.uvs5;h&&t.set(h,Oe.UV5Kind);const c=e.uvs6;c&&t.set(c,Oe.UV6Kind);const d=e.colors;d&&t.set(Ie.CheckColors4(d,i.length/3),Oe.ColorKind);const u=e.matricesIndices;u&&t.set(u,Oe.MatricesIndicesKind);const _=e.matricesWeights;_&&t.set(_,Oe.MatricesWeightsKind);const f=e.indices;f&&(t.indices=f);const p=e.materialInfos;if(p){t.materialInfos=[];for(const e of p){const i=new Dn;i.indexCount=e.indexCount,i.indexStart=e.indexStart,i.verticesCount=e.verticesCount,i.verticesStart=e.verticesStart,i.materialIndex=e.materialIndex,t.materialInfos.push(i)}}return t}static ImportVertexData(e,t){const i=Nn.Parse(e);t.setAllVerticesData(i,e.updatable)}}Nn.FRONTSIDE=0,Nn.BACKSIDE=1,Nn.DOUBLESIDE=2,Nn.DEFAULTSIDE=0,Nn._UniqueIDGenerator=0,De([Ze.filter(((...[e])=>!Array.isArray(e)))],Nn,"_TransformVector3Coordinates",null),De([Ze.filter(((...[e])=>!Array.isArray(e)))],Nn,"_TransformVector3Normals",null),De([Ze.filter(((...[e])=>!Array.isArray(e)))],Nn,"_TransformVector4Normals",null),De([Ze.filter(((...[e])=>!Array.isArray(e)))],Nn,"_FlipFaces",null);class Fn{static get ForceFullSceneLoadingForIncremental(){return Fn._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Fn._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Fn._ShowLoadingScreen}static set ShowLoadingScreen(e){Fn._ShowLoadingScreen=e}static get loggingLevel(){return Fn._LoggingLevel}static set loggingLevel(e){Fn._LoggingLevel=e}static get CleanBoneMatrixWeights(){return Fn._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Fn._CleanBoneMatrixWeights=e}}Fn._ForceFullSceneLoadingForIncremental=!1,Fn._ShowLoadingScreen=!0,Fn._CleanBoneMatrixWeights=!1,Fn._LoggingLevel=0;class Ln{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new Ln(Ln.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,s=!1,n=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||u.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=s,i?this.setAllVerticesData(i,s):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),n&&(this.applyToMesh(n),n.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return 1===this.delayLoadState||0===this.delayLoadState}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,s){i&&Array.isArray(t)&&(t=new Float32Array(t));const n=new Oe(this._engine,t,e,{updatable:i,postponeInternalCreation:0===this._meshes.length,stride:s,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(n)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const s=e.getKind();this._vertexBuffers[s]&&i&&this._vertexBuffers[s].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[s]=e;const n=this._meshes,r=n.length;if(s===Oe.PositionKind){this._totalVertices=null!=t?t:e.totalVertices,this._updateExtend(e.getFloatData()),this._resetPointsArrayCache();const i=this._extend&&this._extend.minimum||new me(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),s=this._extend&&this._extend.maximum||new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let e=0;e<r;e++){const t=n[e];t.buildBoundingInfo(i,s),t._createGlobalSubMesh(t.isUnIndexed),t.computeWorldMatrix(!0),t.synchronizeInstances()}}this._notifyUpdate(s)}updateVerticesDataDirectly(e,t,i,s=!1){const n=this.getVertexBuffer(e);n&&(n.updateDirectly(t,i,s),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const s=this.getVertexBuffer(e);s&&(s.update(t),e===Oe.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const e=this._meshes;for(const t of e){t.hasBoundingInfo?t.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):t.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const e=t.subMeshes;for(const t of e)t.refreshBoundingInfo()}}}_bind(e,t,i,s){if(!e)return;void 0===t&&(t=this._indexBuffer);const n=this.getVertexBuffers();if(!n)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!s)return void this._engine.bindBuffers(n,t,e,i);const r=s||this._vertexArrayObjects;r[e.key]||(r[e.key]=this._engine.recordVertexArrayObject(n,t,e,i)),this._engine.bindVertexArrayObject(r[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const s=this.getVertexBuffer(e);return s?s.getFloatData(this._totalVertices,i||t&&1!==this._meshes.length):null}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return!!t&&t.isUpdatable()}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(this._indexBufferIsUpdatable){const s=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),s)for(const e of this._meshes)e._createGlobalSubMesh(!0)}else this.setIndices(e,null,!0)}setIndexBuffer(e,t,i){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=i,e.is32Bits||(e.is32Bits=this._totalIndices>65535);for(const e of this._meshes)e._createGlobalSubMesh(!0),e.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),null!=t&&(this._totalVertices=t);for(const e of this._meshes)e._createGlobalSubMesh(!0),e.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?void 0!==this._totalIndices?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return t||e&&1!==this._meshes.length?i.slice():i}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){e&&this._vertexArrayObjects&&this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,s=i.indexOf(e);-1!==s&&(i.splice(s,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,0===i.length&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&!(e=this.getVerticesData(Oe.PositionKind)))return;this._extend=Cs(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)1===t&&this._vertexBuffers[i].create(),i===Oe.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());1===t&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const e of this._meshes)e._markSubMeshesAsAttributesDirty()}load(e,t){2!==this.delayLoadState&&(this.isReady()?t&&t():(this.delayLoadState=2,this._queueLoad(e,t)))}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,(i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const s=this._meshes,n=s.length;for(let e=0;e<n;e++)this._applyToMesh(s[e]);t&&t()}),void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(null!=e&&e.length>0){for(let t=0;t<e.length;t+=3){const i=e[t+0];e[t+0]=e[t+2],e[t+2]=i}this.setIndices(e)}const t=this.getVerticesData(Oe.PositionKind,!1);if(null!=t&&t.length>0){for(let e=0;e<t.length;e+=3)t[e+2]=-t[e+2];this.setVerticesData(Oe.PositionKind,t,!1)}const i=this.getVerticesData(Oe.NormalKind,!1);if(null!=i&&i.length>0){for(let e=0;e<i.length;e+=3)i[e+2]=-i[e+2];this.setVerticesData(Oe.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(Oe.PositionKind);if(!e||0===e.length)return!1;for(let t=3*this._positionsCache.length,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=me.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const e in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const e in this._vertexBuffers)this._vertexBuffers[e].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const e=this._parentContainer.geometries.indexOf(this);e>-1&&this._parentContainer.geometries.splice(e,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new Nn;t.indices=[];const i=this.getIndices();if(i)for(let e=0;e<i.length;e++)t.indices.push(i[e]);let s,n=!1,r=!1;for(s in this._vertexBuffers){const e=this.getVerticesData(s);if(e&&(e instanceof Float32Array?t.set(new Float32Array(e),s):t.set(e.slice(0),s),!r)){const e=this.getVertexBuffer(s);e&&(n=e.isUpdatable(),r=!n)}}const o=new Ln(e,this._scene,t,n);for(s in o.delayLoadState=this.delayLoadState,o.delayLoadingFile=this.delayLoadingFile,o._delayLoadingFunction=this._delayLoadingFunction,this._delayInfo)o._delayInfo=o._delayInfo||[],o._delayInfo.push(s);return o._boundingInfo=new cs(this._extend.minimum,this._extend.maximum),o}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Fe&&Fe.HasTags(this)&&(e.tags=Fe.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(Oe.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(Oe.PositionKind)),this.isVertexBufferUpdatable(Oe.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(Oe.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(Oe.NormalKind)),this.isVertexBufferUpdatable(Oe.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(Oe.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(Oe.TangentKind)),this.isVertexBufferUpdatable(Oe.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(Oe.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(Oe.UVKind)),this.isVertexBufferUpdatable(Oe.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(Oe.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(Oe.UV2Kind)),this.isVertexBufferUpdatable(Oe.UV2Kind)&&(e.uvs2._updatable=!0)),this.isVerticesDataPresent(Oe.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(Oe.UV3Kind)),this.isVertexBufferUpdatable(Oe.UV3Kind)&&(e.uvs3._updatable=!0)),this.isVerticesDataPresent(Oe.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(Oe.UV4Kind)),this.isVertexBufferUpdatable(Oe.UV4Kind)&&(e.uvs4._updatable=!0)),this.isVerticesDataPresent(Oe.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(Oe.UV5Kind)),this.isVertexBufferUpdatable(Oe.UV5Kind)&&(e.uvs5._updatable=!0)),this.isVerticesDataPresent(Oe.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(Oe.UV6Kind)),this.isVertexBufferUpdatable(Oe.UV6Kind)&&(e.uvs6._updatable=!0)),this.isVerticesDataPresent(Oe.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(Oe.ColorKind)),this.isVertexBufferUpdatable(Oe.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(Oe.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(Oe.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(Oe.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(Oe.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(Oe.MatricesWeightsKind)),this.isVertexBufferUpdatable(Oe.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return Ot.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),s=e.geometryUniqueId,n=e.geometryId;if(s||n){const e=s?this._GetGeometryByLoadedUniqueId(s,i):i.getGeometryById(n);e&&e.applyToMesh(t)}else if(e instanceof ArrayBuffer){const i=t._binaryInfo;if(i.positionsAttrDesc&&i.positionsAttrDesc.count>0){const s=new Float32Array(e,i.positionsAttrDesc.offset,i.positionsAttrDesc.count);t.setVerticesData(Oe.PositionKind,s,!1)}if(i.normalsAttrDesc&&i.normalsAttrDesc.count>0){const s=new Float32Array(e,i.normalsAttrDesc.offset,i.normalsAttrDesc.count);t.setVerticesData(Oe.NormalKind,s,!1)}if(i.tangetsAttrDesc&&i.tangetsAttrDesc.count>0){const s=new Float32Array(e,i.tangetsAttrDesc.offset,i.tangetsAttrDesc.count);t.setVerticesData(Oe.TangentKind,s,!1)}if(i.uvsAttrDesc&&i.uvsAttrDesc.count>0){const s=new Float32Array(e,i.uvsAttrDesc.offset,i.uvsAttrDesc.count);if(Gi.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(Oe.UVKind,s,!1)}if(i.uvs2AttrDesc&&i.uvs2AttrDesc.count>0){const s=new Float32Array(e,i.uvs2AttrDesc.offset,i.uvs2AttrDesc.count);if(Gi.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(Oe.UV2Kind,s,!1)}if(i.uvs3AttrDesc&&i.uvs3AttrDesc.count>0){const s=new Float32Array(e,i.uvs3AttrDesc.offset,i.uvs3AttrDesc.count);if(Gi.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(Oe.UV3Kind,s,!1)}if(i.uvs4AttrDesc&&i.uvs4AttrDesc.count>0){const s=new Float32Array(e,i.uvs4AttrDesc.offset,i.uvs4AttrDesc.count);if(Gi.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(Oe.UV4Kind,s,!1)}if(i.uvs5AttrDesc&&i.uvs5AttrDesc.count>0){const s=new Float32Array(e,i.uvs5AttrDesc.offset,i.uvs5AttrDesc.count);if(Gi.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(Oe.UV5Kind,s,!1)}if(i.uvs6AttrDesc&&i.uvs6AttrDesc.count>0){const s=new Float32Array(e,i.uvs6AttrDesc.offset,i.uvs6AttrDesc.count);if(Gi.UseOpenGLOrientationForUV)for(let e=1;e<s.length;e+=2)s[e]=1-s[e];t.setVerticesData(Oe.UV6Kind,s,!1)}if(i.colorsAttrDesc&&i.colorsAttrDesc.count>0){const s=new Float32Array(e,i.colorsAttrDesc.offset,i.colorsAttrDesc.count);t.setVerticesData(Oe.ColorKind,s,!1,i.colorsAttrDesc.stride)}if(i.matricesIndicesAttrDesc&&i.matricesIndicesAttrDesc.count>0){const s=new Int32Array(e,i.matricesIndicesAttrDesc.offset,i.matricesIndicesAttrDesc.count),n=[];for(let e=0;e<s.length;e++){const t=s[e];n.push(255&t),n.push((65280&t)>>8),n.push((16711680&t)>>16),n.push(t>>24&255)}t.setVerticesData(Oe.MatricesIndicesKind,n,!1)}if(i.matricesIndicesExtraAttrDesc&&i.matricesIndicesExtraAttrDesc.count>0){const s=new Int32Array(e,i.matricesIndicesExtraAttrDesc.offset,i.matricesIndicesExtraAttrDesc.count),n=[];for(let e=0;e<s.length;e++){const t=s[e];n.push(255&t),n.push((65280&t)>>8),n.push((16711680&t)>>16),n.push(t>>24&255)}t.setVerticesData(Oe.MatricesIndicesExtraKind,n,!1)}if(i.matricesWeightsAttrDesc&&i.matricesWeightsAttrDesc.count>0){const s=new Float32Array(e,i.matricesWeightsAttrDesc.offset,i.matricesWeightsAttrDesc.count);t.setVerticesData(Oe.MatricesWeightsKind,s,!1)}if(i.indicesAttrDesc&&i.indicesAttrDesc.count>0){const s=new Int32Array(e,i.indicesAttrDesc.offset,i.indicesAttrDesc.count);t.setIndices(s,null)}if(i.subMeshesAttrDesc&&i.subMeshesAttrDesc.count>0){const s=new Int32Array(e,i.subMeshesAttrDesc.offset,5*i.subMeshesAttrDesc.count);t.subMeshes=[];for(let e=0;e<i.subMeshesAttrDesc.count;e++){const i=s[5*e+0],n=s[5*e+1],r=s[5*e+2],o=s[5*e+3],a=s[5*e+4];ys.AddToMesh(i,n,r,o,a,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(Oe.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(Oe.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(Oe.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(Oe.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(Oe.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(Oe.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(Oe.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(Oe.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(Oe.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(Oe.ColorKind,Ie.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(Oe.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const i=[];for(let t=0;t<e.matricesIndices.length;t++){const s=e.matricesIndices[t];i.push(255&s),i.push((65280&s)>>8),i.push((16711680&s)>>16),i.push(s>>24&255)}t.setVerticesData(Oe.MatricesIndicesKind,i,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(Oe.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const i=[];for(let t=0;t<e.matricesIndicesExtra.length;t++){const s=e.matricesIndicesExtra[t];i.push(255&s),i.push((65280&s)>>8),i.push((16711680&s)>>16),i.push(s>>24&255)}t.setVerticesData(Oe.MatricesIndicesExtraKind,i,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(Ln._CleanMatricesWeights(e,t),t.setVerticesData(Oe.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(Oe.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let i=0;i<e.subMeshes.length;i++){const s=e.subMeshes[i];ys.AddToMesh(s.materialIndex,s.verticesStart,s.verticesCount,s.indexStart,s.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){const i=.001;if(!Fn.CleanBoneMatrixWeights)return;let s=0;if(!(e.skeletonId>-1))return;{const i=t.getScene().getLastSkeletonById(e.skeletonId);if(!i)return;s=i.bones.length}const n=t.getVerticesData(Oe.MatricesIndicesKind),r=t.getVerticesData(Oe.MatricesIndicesExtraKind),o=e.matricesWeights,a=e.matricesWeightsExtra,l=e.numBoneInfluencer,h=o.length;for(let e=0;e<h;e+=4){let t=0,h=-1;for(let s=0;s<4;s++){const n=o[e+s];t+=n,n<i&&h<0&&(h=s)}if(a)for(let s=0;s<4;s++){const n=a[e+s];t+=n,n<i&&h<0&&(h=s+4)}if((h<0||h>l-1)&&(h=l-1),t>i){const i=1/t;for(let t=0;t<4;t++)o[e+t]*=i;if(a)for(let t=0;t<4;t++)a[e+t]*=i}else h>=4?(a[e+h-4]=1-t,r[e+h-4]=s):(o[e+h]=1-t,n[e+h]=s)}t.setVerticesData(Oe.MatricesIndicesKind,n),e.matricesWeightsExtra&&t.setVerticesData(Oe.MatricesIndicesExtraKind,r)}static Parse(e,t,i){const s=new Ln(e.id,t,void 0,e.updatable);return s._loadedUniqueId=e.uniqueId,Fe&&Fe.AddTagsTo(s,e.tags),e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s._boundingInfo=new cs(me.FromArray(e.boundingBoxMinimum),me.FromArray(e.boundingBoxMaximum)),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(Oe.UVKind),e.hasUVs2&&s._delayInfo.push(Oe.UV2Kind),e.hasUVs3&&s._delayInfo.push(Oe.UV3Kind),e.hasUVs4&&s._delayInfo.push(Oe.UV4Kind),e.hasUVs5&&s._delayInfo.push(Oe.UV5Kind),e.hasUVs6&&s._delayInfo.push(Oe.UV6Kind),e.hasColors&&s._delayInfo.push(Oe.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(Oe.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(Oe.MatricesWeightsKind),s._delayLoadingFunction=Nn.ImportVertexData):Nn.ImportVertexData(e,s),t.pushGeometry(s,!0),s}}const wn=Te.Compose(me.One(),ve.FromEulerAngles(0,Math.PI,0),me.Zero());class Bn extends et{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=0!=(this._billboardMode&Bn.BILLBOARDMODE_USE_POSITION),this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==Bn.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t),this._forward=new me(0,0,1),this._up=new me(0,1,0),this._right=new me(1,0,0),this._position=me.Zero(),this._rotation=me.Zero(),this._rotationQuaternion=null,this._scaling=me.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=Bn.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=Te.Zero(),this._usePivotMatrix=!1,this._absolutePosition=me.Zero(),this._absoluteScaling=me.Zero(),this._absoluteRotationQuaternion=ve.Identity(),this._pivotMatrix=Te.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new s,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return me.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return me.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return me.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=Te.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==Bn.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=Te.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);s&&i&&i(this,s);for(const e of this.getChildTransformNodes(!0))e.instantiateHierarchy(s,t,i);return s}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||ve.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,s;if(void 0===e.x){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],s=arguments[2]}else t=e.x,i=e.y,s=e.z;if(this.parent){const e=Ee.Matrix[0];this.parent.getWorldMatrix().invertToRef(e),me.TransformCoordinatesFromFloatsToRef(t,i,s,e,this.position)}else this.position.x=t,this.position.y=i,this.position.z=s;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=me.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=Ee.Matrix[0];return this._localMatrix.invertToRef(e),me.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=me.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,s=0,n=Js.LOCAL){const r=Bn._LookAtVectorCache,o=n===Js.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,r),this.setDirection(r,t,i,s),n===Js.WORLD&&this.parent)if(this.rotationQuaternion){const e=Ee.Matrix[0];this.rotationQuaternion.toRotationMatrix(e);const t=Ee.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(t),t.invert(),e.multiplyToRef(t,e),this.rotationQuaternion.fromRotationMatrix(e)}else{const e=Ee.Quaternion[0];ve.FromEulerVectorToRef(this.rotation,e);const t=Ee.Matrix[0];e.toRotationMatrix(t);const i=Ee.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(i),i.invert(),t.multiplyToRef(i,t),e.fromRotationMatrix(t),e.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=me.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return me.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,s=0){const n=-Math.atan2(e.z,e.x)+Math.PI/2,r=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,r);return this.rotationQuaternion?ve.RotationYawPitchRollToRef(n+t,o+i,s,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=n+t,this.rotation.z=s),this}setPivotPoint(e,t=Js.LOCAL){0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==Js.WORLD){const t=Ee.Matrix[0];i.invertToRef(t),e=me.TransformCoordinates(e,t)}return this.setPivotMatrix(Te.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=me.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=me.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),me.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const s=Ee.Quaternion[0],n=Ee.Vector3[0],r=Ee.Vector3[1],o=Ee.Matrix[1];Te.IdentityToRef(o);const a=Ee.Matrix[0];this.computeWorldMatrix(!0);let l=this.rotationQuaternion;return l||(l=Bn._TmpRotation,ve.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),Te.ComposeToRef(this.scaling,l,this.position,a),this.parent&&a.multiplyToRef(this.parent.computeWorldMatrix(!0),a),e&&(e.computeWorldMatrix(!0).invertToRef(o),a.multiplyToRef(o,a)),a.decompose(r,s,n,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(r),this.position.copyFrom(n),this.parent=e,i&&this.setPivotMatrix(Te.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling!==e&&(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,this.parent=e?this._currentParentWhenAttachingToBone:null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){let s;if(e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0)),i&&i!==Js.LOCAL){if(this.parent){const i=this.parent.getWorldMatrix(),s=Ee.Matrix[0];i.invertToRef(s),e=me.TransformNormal(e,s),i.determinant()<0&&(t*=-1)}s=ve.RotationAxisToRef(e,t,Bn._RotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else s=ve.RotationAxisToRef(e,t,Bn._RotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=ve.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const s=Ee.Vector3[0],n=Ee.Vector3[1],r=Ee.Vector3[2],o=Ee.Quaternion[0],a=Ee.Matrix[0],l=Ee.Matrix[1],h=Ee.Matrix[2],c=Ee.Matrix[3];return e.subtractToRef(this.position,s),Te.TranslationToRef(s.x,s.y,s.z,a),Te.TranslationToRef(-s.x,-s.y,-s.z,l),Te.RotationAxisToRef(t,i,h),l.multiplyToRef(h,c),c.multiplyToRef(a,c),c.decompose(n,o,r),this.position.addInPlace(r),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const s=e.scale(t);if(i&&i!==Js.LOCAL)this.setAbsolutePosition(this.getAbsolutePosition().add(s));else{const e=this.getPositionExpressedInLocalSpace().add(s);this.setPositionWithLocalVector(e)}return this}addRotation(e,t,i){let s;this.rotationQuaternion?s=this.rotationQuaternion:(s=Ee.Quaternion[1],ve.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,s));const n=Ee.Quaternion[0];return ve.RotationYawPitchRollToRef(t,e,i,n),s.multiplyInPlace(n),this.rotationQuaternion||s.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==Bn.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const s=this._cache;s.pivotMatrixUpdated=!1,s.billboardMode=this.billboardMode,s.infiniteDistance=this.infiniteDistance,s.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const n=this._getEffectiveParent(),r=Bn._TmpScaling;let o,a=this._position;if(this._infiniteDistance&&!this.parent&&t){const e=t.getWorldMatrix(),i=new me(e.m[12],e.m[13],e.m[14]);a=Bn._TmpTranslation,a.copyFromFloats(this._position.x+i.x,this._position.y+i.y,this._position.z+i.z)}if(r.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant),this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,o=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(ve.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(o=Bn._TmpRotation,ve.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,o)),this._usePivotMatrix){const e=Ee.Matrix[1];Te.ScalingToRef(r.x,r.y,r.z,e);const t=Ee.Matrix[0];o.toRotationMatrix(t),this._pivotMatrix.multiplyToRef(e,Ee.Matrix[4]),Ee.Matrix[4].multiplyToRef(t,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(a.x,a.y,a.z)}else Te.ComposeToRef(r,o,a,this._localMatrix);if(n&&n.getWorldMatrix){if(e&&n.computeWorldMatrix(e),s.useBillboardPath){if(this._transformToBoneReferal){const e=this.parent;e.getSkeleton().prepare(),e.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),Ee.Matrix[7])}else Ee.Matrix[7].copyFrom(n.getWorldMatrix());const e=Ee.Vector3[5],t=Ee.Vector3[6],i=Ee.Quaternion[0];Ee.Matrix[7].decompose(t,i,e),Te.ScalingToRef(t.x,t.y,t.z,Ee.Matrix[7]),Ee.Matrix[7].setTranslation(e),Bn.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(i,e),this._localMatrix.setTranslation(e)),this._localMatrix.multiplyToRef(Ee.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){const e=this.parent;e.getSkeleton().prepare(),this._localMatrix.multiplyToRef(e.getFinalMatrix(),Ee.Matrix[6]),Ee.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(n.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(s.useBillboardPath&&t&&this.billboardMode&&!s.useBillboardPosition){const e=Ee.Vector3[0];if(this._worldMatrix.getTranslationToRef(e),Ee.Matrix[1].copyFrom(t.getViewMatrix()),this._scene.useRightHandedSystem&&Ee.Matrix[1].multiplyToRef(wn,Ee.Matrix[1]),Ee.Matrix[1].setTranslationFromFloats(0,0,0),Ee.Matrix[1].invertToRef(Ee.Matrix[0]),(this.billboardMode&Bn.BILLBOARDMODE_ALL)!==Bn.BILLBOARDMODE_ALL){Ee.Matrix[0].decompose(void 0,Ee.Quaternion[0],void 0);const e=Ee.Vector3[1];Ee.Quaternion[0].toEulerAnglesToRef(e),(this.billboardMode&Bn.BILLBOARDMODE_X)!==Bn.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&Bn.BILLBOARDMODE_Y)!==Bn.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&Bn.BILLBOARDMODE_Z)!==Bn.BILLBOARDMODE_Z&&(e.z=0),Te.RotationYawPitchRollToRef(e.y,e.x,e.z,Ee.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(Ee.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(Ee.Vector3[0])}else if(s.useBillboardPath&&t&&s.useBillboardPosition){const e=Ee.Vector3[0];this._worldMatrix.getTranslationToRef(e);const i=t.globalPosition;this._worldMatrix.invertToRef(Ee.Matrix[1]);const s=Ee.Vector3[1];me.TransformCoordinatesToRef(i,Ee.Matrix[1],s),s.normalize();const n=-Math.atan2(s.z,s.x)+Math.PI/2,r=Math.sqrt(s.x*s.x+s.z*s.z),o=-Math.atan2(s.y,r);if(ve.RotationYawPitchRollToRef(n,o,0,Ee.Quaternion[0]),(this.billboardMode&Bn.BILLBOARDMODE_ALL)!==Bn.BILLBOARDMODE_ALL){const e=Ee.Vector3[1];Ee.Quaternion[0].toEulerAnglesToRef(e),(this.billboardMode&Bn.BILLBOARDMODE_X)!==Bn.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&Bn.BILLBOARDMODE_Y)!==Bn.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&Bn.BILLBOARDMODE_Z)!==Bn.BILLBOARDMODE_Z&&(e.z=0),Te.RotationYawPitchRollToRef(e.y,e.x,e.z,Ee.Matrix[0])}else Te.FromQuaternionToRef(Ee.Quaternion[0],Ee.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(Ee.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(Ee.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):n&&n._nonUniformScaling?this._updateNonUniformScalingState(n._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=Te.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const e=this.getChildren();for(let t=0;t<e.length;++t){const i=e[t];if(i){i.computeWorldMatrix();const e=Ee.Matrix[0];i._localMatrix.multiplyToRef(this._localMatrix,e);const t=Ee.Quaternion[0];e.decompose(i.scaling,t,i.position),i.rotationQuaternion?i.rotationQuaternion.copyFrom(t):t.toEulerAnglesToRef(i.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=ve.Identity()),this._worldMatrix=Te.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),me.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const s=qe.Clone((()=>new Bn(e,this.getScene())),this);if(s.name=e,s.id=e,t&&(s.parent=t),!i){const t=this.getDescendants(!0);for(let i=0;i<t.length;i++){const n=t[i];n.clone&&n.clone(e+"."+n.name,s)}}return s}serialize(e){const t=qe.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}static Parse(e,t,i){const s=qe.Parse((()=>new Bn(e.name,t)),e,t,i);return e.localMatrix?s.setPreTransformMatrix(Te.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(Te.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s._waitingParsedUniqueId=e.uniqueId,void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,(e=>(!t||t(e))&&e instanceof Bn)),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const e=this._parentContainer.transformNodes.indexOf(this);e>-1&&this._parentContainer.transformNodes.splice(e,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const e=this.getChildTransformNodes(!0);for(const t of e)t.parent=null,t.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let s=null,n=null;t&&(this.rotationQuaternion?(n=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(s=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const r=this.getHierarchyBoundingVectors(e,i),o=r.max.subtract(r.min),a=Math.max(o.x,o.y,o.z);if(0===a)return this;const l=1/a;return this.scaling.scaleInPlace(l),t&&(this.rotationQuaternion&&n?this.rotationQuaternion.copyFrom(n):this.rotation&&s&&this.rotation.copyFrom(s)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}Bn.BILLBOARDMODE_NONE=0,Bn.BILLBOARDMODE_X=1,Bn.BILLBOARDMODE_Y=2,Bn.BILLBOARDMODE_Z=4,Bn.BILLBOARDMODE_ALL=7,Bn.BILLBOARDMODE_USE_POSITION=128,Bn.BillboardUseParentOrientation=!1,Bn._TmpRotation=ve.Zero(),Bn._TmpScaling=me.Zero(),Bn._TmpTranslation=me.Zero(),Bn._LookAtVectorCache=new me(0,0,0),Bn._RotationAxisCache=new ve,De([Qe("position")],Bn.prototype,"_position",void 0),De([Qe("rotation")],Bn.prototype,"_rotation",void 0),De([ke(10,"rotationQuaternion")],Bn.prototype,"_rotationQuaternion",void 0),De([Qe("scaling")],Bn.prototype,"_scaling",void 0),De([Ge("billboardMode")],Bn.prototype,"_billboardMode",void 0),De([Ge()],Bn.prototype,"scalingDeterminant",void 0),De([Ge("infiniteDistance")],Bn.prototype,"_infiniteDistance",void 0),De([Ge()],Bn.prototype,"ignoreNonUniformScaling",void 0),De([Ge()],Bn.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class Un{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new me(0,0,0),this._diffPositionForCollisions=new me(0,0,0),this._collisionResponse=!0}}class kn{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=me.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class Vn{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new kn,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new Un,this._enableDistantPicking=!1,this._rawBoundingInfo=null}}class Gn extends Bn{static get BILLBOARDMODE_NONE(){return Bn.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return Bn.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return Bn.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return Bn.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return Bn.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return Bn.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return!!super._updateNonUniformScalingState(e)&&(this._markSubMeshesAsMiscDirty(),!0)}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(1===t&&1!==e||1!==t&&1===e)&&this._markSubMeshesAsDirty((e=>{e.markAsMiscDirty(),e.markAsPrePassDirty()}))}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){var t;return null===(t=this._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===t?void 0:t[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new Vn,this._waitingMaterialId=null,this.cullingStrategy=Gn.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new s,this.onCollisionPositionChangeObservable=new s,this.onMaterialChangedObservable=new s,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=Re.Red(),this.outlineWidth=.02,this.overlayColor=Re.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new me(.5,1,.5),this.ellipsoidOffset=new me(0,0,0),this.edgesWidth=1,this.edgesColor=new Ie(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new s,this._onCollisionPositionChange=(e,t,i=null)=>{t.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>te.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),i&&this.onCollideObservable.notifyObservers(i),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},(t=this.getScene()).addMesh(this),this._resyncLightSources(),this._uniformBuffer=new Nt(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case Mi.Aggressive:this.doNotSyncBoundingInfo=!0;case Mi.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+("InstancedMesh"!==this.getClassName()?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==Bn.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive)){if(!e)return this.actionManager;if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),null!==this._occlusionQuery&&(this._occlusionQuery=null),this.subMeshes)for(const e of this.subMeshes)e._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let s=!1;if(-1===i){if(!t)return;this._lightSources.push(e)}else{if(t)return;s=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(s)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);-1!==i&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const s=t._drawWrappers[i];s&&s.defines&&s.defines.markAllAsDirty&&e(s.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty((t=>t.markAsLightDirty(e)))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty((e=>e.markAsAttributesDirty()))}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty((e=>e.markAsMiscDirty()))}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(this.subMeshes)for(const t of this.subMeshes)t.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,s){return this}updateVerticesData(e,t,i,s){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){var e;return null!==(e=this.rawBoundingInfo)&&void 0!==e?e:this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return null!==this._boundingInfo}buildBoundingInfo(e,t,i){return this._boundingInfo=new cs(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(Oe.MatricesIndicesKind)&&this.isVerticesDataPresent(Oe.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===Bn.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const s=new Te;(this.rotationQuaternion?this.rotationQuaternion:ve.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(s);const n=me.Zero(),r=this.definedFacingForward?-1:1;return me.TransformCoordinatesFromFloatsToRef(e*r,t,i*r,s,n),n}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const s=this.definedFacingForward?1:-1;return new me(e*s,t,i*s)}refreshBoundingInfo(e=!1,t=!1){return this._boundingInfo&&this._boundingInfo.isLocked||this._refreshBoundingInfo(this._getPositionData(e,t),null),this}_refreshBoundingInfo(e,t){if(e){const i=Cs(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new cs(i.minimum,i.maximum)}if(this.subMeshes)for(let t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo(e);this._updateBoundingInfo()}_getData(e=!1,t=!1,i,s=Oe.PositionKind){if((i=null!=i?i:this.getVerticesData(s).slice())&&t&&this.morphTargetManager){let e=0,t=0;for(let n=0;n<i.length;n++){let r=i[n];for(let e=0;e<this.morphTargetManager.numTargets;e++){const t=this.morphTargetManager.getTarget(e),o=t.influence;if(0!==o){let e=null;switch(s){case Oe.PositionKind:e=t.getPositions();break;case Oe.NormalKind:e=t.getNormals();break;case Oe.TangentKind:e=t.getTangents();break;case Oe.UVKind:e=t.getUVs()}e&&(r+=(e[n]-i[n])*o)}}if(i[n]=r,e++,s===Oe.PositionKind&&this._positions&&3===e){e=0;const s=3*t;this._positions[t++].copyFromFloats(i[s],i[s+1],i[s+2])}}}if(i&&e&&this.skeleton){const e=this.getVerticesData(Oe.MatricesIndicesKind),t=this.getVerticesData(Oe.MatricesWeightsKind);if(t&&e){const n=this.numBoneInfluencers>4,r=n?this.getVerticesData(Oe.MatricesIndicesExtraKind):null,o=n?this.getVerticesData(Oe.MatricesWeightsExtraKind):null,a=this.skeleton.getTransformMatrices(this),l=Ee.Vector3[0],h=Ee.Matrix[0],c=Ee.Matrix[1];let d=0;for(let u=0;u<i.length;u+=3,d+=4){let _,f;for(h.reset(),_=0;_<4;_++)f=t[d+_],f>0&&(Te.FromFloat32ArrayToRefScaled(a,Math.floor(16*e[d+_]),f,c),h.addToSelf(c));if(n)for(_=0;_<4;_++)f=o[d+_],f>0&&(Te.FromFloat32ArrayToRefScaled(a,Math.floor(16*r[d+_]),f,c),h.addToSelf(c));s===Oe.NormalKind?me.TransformNormalFromFloatsToRef(i[u],i[u+1],i[u+2],h,l):me.TransformCoordinatesFromFloatsToRef(i[u],i[u+1],i[u+2],h,l),l.toArray(i,u),s===Oe.PositionKind&&this._positions&&this._positions[u/3].copyFrom(l)}}}return i}getNormalsData(e=!1,t=!1){return this._getData(e,t,null,Oe.NormalKind)}getPositionData(e=!1,t=!1,i){return this._getData(e,t,i,Oe.PositionKind)}_getPositionData(e,t){var i;let s=this.getVerticesData(Oe.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),s&&(e&&this.skeleton||t&&this.morphTargetManager)){if(s=s.slice(),this._generatePointsArray(),this._positions){const e=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(e.length);for(let t=0;t<e.length;t++)this._internalAbstractMeshDataInfo._positions[t]=(null===(i=e[t])||void 0===i?void 0:i.clone())||new me}return this.getPositionData(e,t,s)}return s}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new cs(me.Zero(),me.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const s=this.subMeshes[i];(t>1||!s.IsGlobal)&&s.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){const s=this.getBoundingInfo(),n=e.getBoundingInfo();if(s.intersects(n,t))return!0;if(i)for(const i of this.getChildMeshes())if(i.intersectsMesh(e,t,!0))return!0;return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const t=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=t.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,t.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,i){var s;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const i=e.verticesStart,s=e.verticesStart+e.verticesCount;for(let n=i;n<s;n++)e._lastColliderWorldVertices.push(me.TransformCoordinates(this._positions[n],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),7===(null===(s=e.getMaterial())||void 0===s?void 0:s.fillMode)),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),s=i.length;for(let n=0;n<s;n++){const r=i.data[n];s>1&&!r._checkCollision(e)||this._collideForSubMesh(r,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=Ee.Matrix[0],i=Ee.Matrix[1];return Te.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,s=!1,n,r=!1){const o=new ii,a=this.getClassName(),l="InstancedLinesMesh"===a||"LinesMesh"===a||"GreasedLineMesh"===a?this.intersectionThreshold:0,h=this.getBoundingInfo();if(!this.subMeshes)return o;if(!(r||e.intersectsSphere(h.boundingSphere,l)&&e.intersectsBox(h.boundingBox,l)))return o;if(s)return o.hit=!r,o.pickedMesh=r?null:this,o.distance=r?0:me.Distance(e.origin,h.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let c=null;const d=this._scene.getIntersectingSubMeshCandidates(this,e),u=d.length;let _=!1;for(let e=0;e<u;e++){const t=d.data[e].getMaterial();if(t&&(7==t.fillMode||0==t.fillMode||1==t.fillMode||2==t.fillMode||4==t.fillMode)){_=!0;break}}if(!_)return o.hit=!0,o.pickedMesh=this,o.distance=me.Distance(e.origin,h.boundingSphere.center),o.subMeshId=-1,o;for(let s=0;s<u;s++){const n=d.data[s];if(u>1&&!r&&!n.canIntersects(e))continue;const o=n.intersects(e,this._positions,this.getIndices(),t,i);if(o&&(t||!c||o.distance<c.distance)&&(c=o,c.subMeshId=s,t))break}if(c){const t=null!=n?n:this.getWorldMatrix(),i=Ee.Vector3[0],s=Ee.Vector3[1];me.TransformCoordinatesToRef(e.origin,t,i),e.direction.scaleToRef(c.distance,s);const r=me.TransformNormal(s,t).addInPlace(i);return o.hit=!0,o.distance=me.Distance(i,r),o.pickedPoint=r,o.pickedMesh=this,o.bu=c.bu||0,o.bv=c.bv||0,o.subMeshFaceId=c.faceId,o.faceId=c.faceId+d.data[c.subMeshId].indexStart/(-1!==this.getClassName().indexOf("LinesMesh")?2:3),o.subMeshId=c.subMeshId,o}return o}clone(e,t,i){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=[];return this}dispose(e,t=!1){let i;const s=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),s.freeActiveMeshes(),s.freeRenderingGroups(),s.renderingManager.maintainStateBetweenFrames&&s.renderingManager.restoreDispachedFlags(),void 0!==this.actionManager&&null!==this.actionManager&&(this._scene.meshes.some((e=>e!==this&&e.actionManager===this.actionManager))||this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const e=this._intersectionsInProgress[i],t=e._intersectionsInProgress.indexOf(this);e._intersectionsInProgress.splice(t,1)}this._intersectionsInProgress.length=0,s.lights.forEach((e=>{let t=e.includedOnlyMeshes.indexOf(this);-1!==t&&e.includedOnlyMeshes.splice(t,1),t=e.excludedMeshes.indexOf(this),-1!==t&&e.excludedMeshes.splice(t,1);const i=e.getShadowGenerators();if(i){const e=i.values();for(let i=e.next();!0!==i.done;i=e.next()){const e=i.value.getShadowMap();e&&e.renderList&&(t=e.renderList.indexOf(this),-1!==t&&e.renderList.splice(t,1))}}})),"InstancedMesh"===this.getClassName()&&"InstancedLinesMesh"===this.getClassName()||this.releaseSubMeshes();const n=s.getEngine();if(null!==this._occlusionQuery&&(this.isOcclusionQueryInProgress=!1,n.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),n.wipeCaches(),s.removeMesh(this),this._parentContainer){const e=this._parentContainer.meshes.indexOf(this);e>-1&&this._parentContainer.meshes.splice(e,1),this._parentContainer=null}if(t&&this.material&&("MultiMaterial"===this.material.getClassName()?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<s.particleSystems.length;i++)s.particleSystems[i].emitter===this&&(s.particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=[]),e.facetPositions||(e.facetPositions=[]),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=me.Zero(),e.facetPositions[t]=me.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(Oe.PositionKind),i=this.getIndices(),s=this.getVerticesData(Oe.NormalKind),n=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let t=!1;for(let e=0;e<i.length;e++)if(i[e]>65535){t=!0;break}e.depthSortedIndices=t?new Uint32Array(i):new Uint16Array(i)}if(e.facetDepthSortFunction=function(e,t){return t.sqDistance-e.sqDistance},!e.facetDepthSortFrom){const t=this.getScene().activeCamera;e.facetDepthSortFrom=t?t.position:me.Zero()}e.depthSortedFacets=[];for(let t=0;t<e.facetNb;t++){const i={ind:3*t,sqDistance:0};e.depthSortedFacets.push(i)}e.invertedMatrix=Te.Identity(),e.facetDepthSortOrigin=me.Zero()}e.bbSize.x=n.maximum.x-n.minimum.x>ae?n.maximum.x-n.minimum.x:ae,e.bbSize.y=n.maximum.y-n.minimum.y>ae?n.maximum.y-n.minimum.y:ae,e.bbSize.z=n.maximum.z-n.minimum.z>ae?n.maximum.z-n.minimum.z:ae;let r=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(r=r>e.bbSize.z?r:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/r),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/r),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/r),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=n,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),me.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,s&&Nn.ComputeNormals(t,i,s,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const t=e.depthSortedIndices.length/3|0;for(let s=0;s<t;s++){const t=e.depthSortedFacets[s].ind;e.depthSortedIndices[3*s]=i[t],e.depthSortedIndices[3*s+1]=i[t+1],e.depthSortedIndices[3*s+2]=i[t+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=me.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],s=this.getWorldMatrix();return me.TransformCoordinatesToRef(i,s,t),this}getFacetNormal(e){const t=me.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return me.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const s=this.getBoundingInfo(),n=this._internalAbstractMeshDataInfo._facetData,r=Math.floor((e-s.minimum.x*n.partitioningBBoxRatio)*n.subDiv.X*n.partitioningBBoxRatio/n.bbSize.x),o=Math.floor((t-s.minimum.y*n.partitioningBBoxRatio)*n.subDiv.Y*n.partitioningBBoxRatio/n.bbSize.y),a=Math.floor((i-s.minimum.z*n.partitioningBBoxRatio)*n.subDiv.Z*n.partitioningBBoxRatio/n.bbSize.z);return r<0||r>n.subDiv.max||o<0||o>n.subDiv.max||a<0||a>n.subDiv.max?null:n.facetPartitioning[r+n.subDiv.max*o+n.subDiv.max*n.subDiv.max*a]}getClosestFacetAtCoordinates(e,t,i,s,n=!1,r=!0){const o=this.getWorldMatrix(),a=Ee.Matrix[5];o.invertToRef(a);const l=Ee.Vector3[8];me.TransformCoordinatesFromFloatsToRef(e,t,i,a,l);const h=this.getClosestFacetAtLocalCoordinates(l.x,l.y,l.z,s,n,r);return s&&me.TransformCoordinatesFromFloatsToRef(s.x,s.y,s.z,o,s),h}getClosestFacetAtLocalCoordinates(e,t,i,s,n=!1,r=!0){let o=null,a=0,l=0,h=0,c=0,d=0,u=0,_=0,f=0;const p=this.getFacetLocalPositions(),m=this.getFacetLocalNormals(),g=this.getFacetsAtLocalCoordinates(e,t,i);if(!g)return null;let v,T,b,E=Number.MAX_VALUE,S=E;for(let x=0;x<g.length;x++)v=g[x],T=m[v],b=p[v],c=(e-b.x)*T.x+(t-b.y)*T.y+(i-b.z)*T.z,(!n||n&&r&&c>=0||n&&!r&&c<=0)&&(c=T.x*b.x+T.y*b.y+T.z*b.z,d=-(T.x*e+T.y*t+T.z*i-c)/(T.x*T.x+T.y*T.y+T.z*T.z),u=e+T.x*d,_=t+T.y*d,f=i+T.z*d,a=u-e,l=_-t,h=f-i,S=a*a+l*l+h*h,S<E&&(E=S,o=v,s&&(s.x=u,s.y=_,s.z=f)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){const t=this.getVerticesData(Oe.PositionKind),i=this.getIndices();let s;return s=this.isVerticesDataPresent(Oe.NormalKind)?this.getVerticesData(Oe.NormalKind):[],Nn.ComputeNormals(t,i,s,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(Oe.NormalKind,s,e),this}alignWithNormal(e,t){t||(t=nn.Y);const i=Ee.Vector3[0],s=Ee.Vector3[1];return me.CrossToRef(t,e,s),me.CrossToRef(e,s,i),this.rotationQuaternion?ve.RotationQuaternionFromAxisToRef(i,e,s,this.rotationQuaternion):me.RotationFromAxisToRef(i,e,s,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw f("EdgesRenderer")}enableEdgesRendering(e,t,i){throw f("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter((e=>e.emitter===this))}}Gn.OCCLUSION_TYPE_NONE=0,Gn.OCCLUSION_TYPE_OPTIMISTIC=1,Gn.OCCLUSION_TYPE_STRICT=2,Gn.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,Gn.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,Gn.CULLINGSTRATEGY_STANDARD=0,Gn.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,Gn.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,Gn.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,ue("BABYLON.AbstractMesh",Gn);class zn extends Ps{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...i)=>{const s=t.apply(e,i);return this._markAllSubMeshesAsTexturesDirty(),s};const i=e.splice;e.splice=(t,s)=>{const n=i.apply(e,[t,s]);return this._markAllSubMeshesAsTexturesDirty(),n}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map((e=>e?e.getActiveTextures():[])))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if(null===(t=this.subMaterials[i])||void 0===t?void 0:t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let s=0;s<this.subMaterials.length;s++){const n=this.subMaterials[s];if(n){if(n._storeEffectOnSubMeshes){if(!n.isReadyForSubMesh(e,t,i))return!1;continue}if(!n.isReady(e))return!1}}return!0}clone(e,t){const i=new zn(e,this.getScene());for(let s=0;s<this.subMaterials.length;s++){let n=null;const r=this.subMaterials[s];n=t&&r?r.clone(e+"-"+r.name):this.subMaterials[s],i.subMaterials.push(n)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,Fe&&(e.tags=Fe.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const s=this.getScene();if(!s)return;if(i)for(let i=0;i<this.subMaterials.length;i++){const s=this.subMaterials[i];s&&s.dispose(e,t)}const n=s.multiMaterials.indexOf(this);n>=0&&s.multiMaterials.splice(n,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new zn(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,Fe&&Fe.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach((e=>i.subMaterials.push(t.getLastMaterialById(e)))),i}}ue("BABYLON.MultiMaterial",zn);class Hn{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class Wn{}class Xn{constructor(){this.visibleInstances={},this.batchCache=new Qn,this.batchCacheReplacementModeInFrozenMode=new Qn,this.instancesBufferSize=2048}}class Qn{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}}class Yn{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class Kn{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}class jn extends Gn{static _GetDefaultSideOrientation(e){return e||jn.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(Oe.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(Oe.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new s),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new s),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new s),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new s),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new s),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,t=null,i=null,n=null,r,o=!0){if(super(e,t),this._internalMeshDataInfo=new Kn,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new Xn,this._thinInstanceDataStorage=new Yn,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=jn.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._onBeforeDraw=(e,t,i)=>{e&&i&&(this._uniformBuffer?this.transferToEffect(t):i.bindOnlyWorldMatrix(t))},n){if(n._geometry&&n._geometry.applyToMesh(this),it.DeepCopy(n,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=n,t.useClonedMeshMap&&(n._internalMeshDataInfo.meshMap||(n._internalMeshDataInfo.meshMap={}),n._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=n._originalBuilderSideOrientation,this._creationDataStorage=n._creationDataStorage,n._ranges){const e=n._ranges;for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&e[t]&&this.createAnimationRange(t,e[t].from,e[t].to)}if(n.metadata&&n.metadata.clone?this.metadata=n.metadata.clone():this.metadata=n.metadata,this._internalMetadata=n._internalMetadata,Fe&&Fe.HasTags(n)&&Fe.AddTagsTo(this,Fe.GetTags(n,!0)),this.setEnabled(n.isEnabled(!1)),this.parent=n.parent,this.setPivotMatrix(n.getPivotMatrix()),this.id=e+"."+n.id,this.material=n.material,!r){const t=n.getDescendants(!0);for(let i=0;i<t.length;i++){const s=t[i];s.clone&&s.clone(e+"."+s.name,this)}}if(n.morphTargetManager&&(this.morphTargetManager=n.morphTargetManager),t.getPhysicsEngine){const e=t.getPhysicsEngine();if(o&&e)if(1===e.getPluginVersion()){const t=e.getImpostorForPhysicsObject(n);t&&(this.physicsImpostor=t.clone(this))}else 2===e.getPluginVersion()&&n.physicsBody&&n.physicsBody.clone(this)}for(let e=0;e<t.particleSystems.length;e++){const i=t.particleSystems[e];i.emitter===n&&i.clone(i.name,this)}this.skeleton=n.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}null!==i&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=e=>{e.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add((()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))})))},this.onMeshReadyObservable=new s(this._internalMeshDataInfo._onMeshReadyObserverAdded),n&&n.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const s=0===this.getTotalVertices()||t&&t.doNotInstantiate&&(!0===t.doNotInstantiate||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));s.parent=e||this.parent,s.position=this.position.clone(),s.scaling=this.scaling.clone(),this.rotationQuaternion?s.rotationQuaternion=this.rotationQuaternion.clone():s.rotation=this.rotation.clone(),i&&i(this,s);for(const e of this.getChildTransformNodes(!0))"InstancedMesh"===e.getClassName()&&"Mesh"===s.getClassName()&&e.sourceMesh===this?e.instantiateHierarchy(s,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:s},i):e.instantiateHierarchy(s,t,i);return s}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const e=this.getIndices(),i=this.getVerticesData(Oe.PositionKind);i&&e&&(t+=", flat shading: "+(i.length/3===e.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort(((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0))}addLODLevel(e,t){if(t&&t._masterMesh)return p.Warn("You cannot use a mesh as LOD level twice"),this;const i=new Hn(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const s=t._LODLevels[i];if(s.distanceOrScreenCoverage===e)return s.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||0===i._LODLevels.length)return this;const s=t||this.getBoundingInfo().boundingSphere,n=e.mode===Gt.ORTHOGRAPHIC_CAMERA?e.minZ:s.centerWorld.subtract(e.globalPosition).length();let r=n,o=1;if(i._useLODScreenCoverage){const t=e.screenArea;let i=s.radiusWorld*e.minZ/n;i=i*i*Math.PI,r=i/t,o=-1}if(o*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>o*r)return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,this),this;for(let e=0;e<i._LODLevels.length;e++){const t=i._LODLevels[e];if(o*t.distanceOrScreenCoverage<o*r){if(t.mesh){if(4===t.mesh.delayLoadState)return t.mesh._checkDelayState(),this;if(2===t.mesh.delayLoadState)return this;t.mesh._preActivate(),t.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,t.mesh),t.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return null===this._geometry||void 0===this._geometry?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,s){var n,r;if(!this._geometry)return null;let o=s||null===(r=null===(n=this._userInstancedBuffersStorage)||void 0===n?void 0:n.vertexBuffers[e])||void 0===r?void 0:r.getFloatData(this.instances.length+1,i||t&&1!==this._geometry.meshes.length);return o||(o=this._geometry.getVerticesData(e,t,i)),o}getVertexBuffer(e,t){var i,s;return this._geometry?null!==(s=t||null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])&&void 0!==s?s:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){var i;return this._geometry?!t&&void 0!==(null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])||this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)}isVertexBufferUpdatable(e,t){var i;if(!this._geometry)return!!this._delayInfo&&-1!==this._delayInfo.indexOf(e);if(!t){const t=null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e];if(t)return t.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const e=[];return this._delayInfo&&this._delayInfo.forEach((function(t){e.push(t)})),e}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const e in this._userInstancedBuffersStorage.vertexBuffers)-1===t.indexOf(e)&&t.push(e);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return null!==this._masterMesh&&void 0!==this._masterMesh}isReady(e=!1,t=!1){var i,s,n,r,o,a,l;if(2===this.delayLoadState)return!1;if(!super.isReady(e))return!1;if(!this.subMeshes||0===this.subMeshes.length)return!0;if(!e)return!0;const h=this.getEngine(),c=this.getScene(),d=t||h.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const u=this.material||c.defaultMaterial;if(u)if(u._storeEffectOnSubMeshes)for(const e of this.subMeshes){const t=e.getMaterial();if(t)if(t._storeEffectOnSubMeshes){if(!t.isReadyForSubMesh(this,e,d))return!1}else if(!t.isReady(this,d))return!1}else if(!u.isReady(this,d))return!1;const _=h.currentRenderPassId;for(const e of this.lightSources){const t=e.getShadowGenerators();if(!t)continue;const c=t.values();for(let e=c.next();!0!==e.done;e=c.next()){const t=e.value;if(t&&(!(null===(i=t.getShadowMap())||void 0===i?void 0:i.renderList)||(null===(s=t.getShadowMap())||void 0===s?void 0:s.renderList)&&-1!==(null===(r=null===(n=t.getShadowMap())||void 0===n?void 0:n.renderList)||void 0===r?void 0:r.indexOf(this)))){const e=null!==(o=t.getShadowMap().renderPassIds)&&void 0!==o?o:[h.currentRenderPassId];for(let i=0;i<e.length;++i){h.currentRenderPassId=e[i];for(const e of this.subMeshes)if(!t.isReady(e,d,null!==(l=null===(a=e.getMaterial())||void 0===a?void 0:a.needAlphaBlendingForMesh(this))&&void 0!==l&&l))return h.currentRenderPassId=_,!1}h.currentRenderPassId=_}}}for(const e of this._internalMeshDataInfo._LODLevels)if(e.mesh&&!e.mesh.isReady(d))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t||(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null),this}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(void 0!==this._instanceDataStorage.previousRenderId&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const s=i.length;let n=!1;if(e)n=!0;else for(const e of this.subMeshes){if(e.indexStart+e.indexCount>s){n=!0;break}if(e.verticesStart+e.verticesCount>t){n=!0;break}}if(!n)return this.subMeshes[0]}return this.releaseSubMeshes(),new ys(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,s=0;for(;i%3!=0;)i++;this.releaseSubMeshes();for(let n=0;n<e&&!(s>=t);n++)ys.CreateFromIndices(0,s,n===e-1?t-s:i,this,void 0,!1),s+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,s){if(this._geometry)this._geometry.setVerticesData(e,t,i,s);else{const s=new Nn;s.set(t,e);const n=this.getScene();new Ln(Ln.RandomId(),n,s,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);i&&i.isUpdatable()!==t&&this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=Ln.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,s){return this._geometry?(s?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(Oe.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(Oe.PositionKind,i,!1,!1),t){const e=this.getIndices(),t=this.getVerticesData(Oe.NormalKind);if(!t)return this;Nn.ComputeNormals(i,e,t),this.updateVerticesData(Oe.NormalKind,t,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(1===this._geometry.meshes.length)return this;const e=this._geometry,t=this._geometry.copy(Ln.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,i){let s=this._geometry;s||(s=new Ln(Ln.RandomId(),this.getScene(),void 0,void 0,this)),s.setIndexBuffer(e,t,i)}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{const t=new Nn;t.indices=e;const s=this.getScene();new Ln(Ln.RandomId(),s,t,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,s=!0){if(!this._geometry)return this;const n=this.getScene().getEngine();let r;if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t),this._unIndexed)r=null;else switch(this._getRenderingFillMode(i)){case Ps.PointFillMode:r=null;break;case Ps.WireFrameFillMode:r=e._getLinesIndexBuffer(this.getIndices(),n);break;default:case Ps.TriangleFillMode:r=this._geometry.getIndexBuffer()}return s&&this._userInstancedBuffersStorage&&!this.hasThinInstances?this._geometry._bind(t,r,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(t,r),this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const s=this.getScene().getEngine();return this._unIndexed||t==Ps.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==Ps.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),s=i._isInIntermediateRendering(),n=s?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,r=this._instanceDataStorage.batchCache;if(r.mustReturn=!1,r.renderSelf[e]=t||!n&&this.isEnabled()&&this.isVisible,r.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const t=this._instanceDataStorage.visibleInstances,n=i.getRenderId(),o=s?t.intermediateDefaultRenderId:t.defaultRenderId;r.visibleInstances[e]=t[n],!r.visibleInstances[e]&&o&&(r.visibleInstances[e]=t[o])}return r.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&null!==r.visibleInstances[e]&&void 0!==r.visibleInstances[e],this._instanceDataStorage.previousBatch=r,r}_renderWithInstances(e,t,i,s,n){var r;const o=i.visibleInstances[e._id],a=o?o.length:0,l=this._instanceDataStorage,h=l.instancesBufferSize;let c=l.instancesBuffer,d=l.instancesPreviousBuffer;const u=16*(a+1)*4;for(;l.instancesBufferSize<u;)l.instancesBufferSize*=2;l.instancesData&&h==l.instancesBufferSize||(l.instancesData=new Float32Array(l.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousData||h!=l.instancesBufferSize)&&(l.instancesPreviousData=new Float32Array(l.instancesBufferSize/4));let _=0,f=0;const p=i.renderSelf[e._id],m=!c||h!==l.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousBuffer;if(this._instanceDataStorage.manualUpdate||l.isFrozen&&!m)f=(p?1:0)+a;else{const t=this.getWorldMatrix();if(p&&(this._scene.needsPreviousWorldMatrices&&(l.masterMeshPreviousWorldMatrix?(l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,_),l.masterMeshPreviousWorldMatrix.copyFrom(t)):(l.masterMeshPreviousWorldMatrix=t.clone(),l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,_))),t.copyToArray(l.instancesData,_),_+=16,f++),o){if(jn.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&(null===(r=e.getMaterial())||void 0===r?void 0:r.needAlphaBlendingForMesh(e.getRenderingMesh()))){const e=this._scene.activeCamera.globalPosition;for(let t=0;t<o.length;t++){const i=o[t];i._distanceToCamera=me.Distance(i.getBoundingInfo().boundingSphere.centerWorld,e)}o.sort(((e,t)=>e._distanceToCamera>t._distanceToCamera?-1:e._distanceToCamera<t._distanceToCamera?1:0))}for(let e=0;e<o.length;e++){const t=o[e],i=t.getWorldMatrix();i.copyToArray(l.instancesData,_),this._scene.needsPreviousWorldMatrices&&(t._previousWorldMatrix?(t._previousWorldMatrix.copyToArray(l.instancesPreviousData,_),t._previousWorldMatrix.copyFrom(i)):(t._previousWorldMatrix=i.clone(),t._previousWorldMatrix.copyToArray(l.instancesPreviousData,_))),_+=16,f++}}}return m?(c&&c.dispose(),d&&d.dispose(),c=new Me(n,l.instancesData,!0,16,!1,!0),l.instancesBuffer=c,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=c.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=c.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=c.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=c.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new Me(n,l.instancesPreviousData,!0,16,!1,!0),l.instancesPreviousBuffer=d,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||(c.updateDirectly(l.instancesData,0,f),!this._scene.needsPreviousWorldMatrices||this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.previousManualUpdate||d.updateDirectly(l.instancesPreviousData,0,f)),this._processInstancedBuffers(o,p),this.getScene()._activeIndices.addCount(e.indexCount*f,!1),n._currentDrawContext&&(n._currentDrawContext.useInstancing=!0),this._bind(e,s,t),this._draw(e,t,f),!this._scene.needsPreviousWorldMatrices||m||!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.forceMatrixUpdates||this._instanceDataStorage.previousManualUpdate||d.updateDirectly(l.instancesData,0,f),n.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,s){var n,r;const o=null!==(r=null===(n=this._thinInstanceDataStorage)||void 0===n?void 0:n.instancesCount)&&void 0!==r?r:0;this.getScene()._activeIndices.addCount(e.indexCount*o,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,o),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,o):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),s.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,s,n,r,o,a){const l=this.getScene(),h=l.getEngine();if(s=this._getRenderingFillMode(s),r&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,s,i,h),this;if(r)this._renderWithInstances(t,s,n,i,h);else{h._currentDrawContext&&(h._currentDrawContext.useInstancing=!1);let i=0;n.renderSelf[t._id]&&(o&&o(!1,e.getWorldMatrix(),a),i++,this._draw(t,s,this._instanceDataStorage.overridenInstanceCount));const r=n.visibleInstances[t._id];if(r){const e=r.length;i+=e;for(let i=0;i<e;i++){const e=r[i].getWorldMatrix();o&&o(!0,e,a),this._draw(t,s)}}l._activeIndices.addCount(t.indexCount*i,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}renderWithRenderPassId(e,t,i,s,n=!0){const r=this._scene.getEngine(),o=r.currentRenderPassId;if(void 0!==e&&(r.currentRenderPassId=e),s)(!n||n&&s.isInFrustum(this._scene._frustumPlanes))&&this.render(s,!!t,i);else for(let e=0;e<this.subMeshes.length;e++){const s=this.subMeshes[e];(!n||n&&s.isInFrustum(this._scene._frustumPlanes))&&this.render(s,!!t,i)}return void 0!==e&&(r.currentRenderPassId=o),this}render(e,t,i){var s,n,r,o,a;const l=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;const h=null!==(n=null===(s=l.activeCameras)||void 0===s?void 0:s.length)&&void 0!==n?n:0;if((h>1&&l.activeCamera===l.activeCameras[0]||h<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const c=this._getInstancesRenderList(e._id,!!i);if(c.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const d=l.getEngine();let u=0,_=null;this.ignoreCameraMaxZ&&l.activeCamera&&!l._isInIntermediateRendering()&&(u=l.activeCamera.maxZ,_=l.activeCamera,l.activeCamera.maxZ=0,l.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const f=e.getRenderingMesh(),p=c.hardwareInstancedRendering[e._id]||f.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,m=this._instanceDataStorage,g=e.getMaterial();if(!g)return _&&(_.maxZ=u,l.updateTransformMatrix(!0)),this;if(m.isFrozen&&this._internalMeshDataInfo._effectiveMaterial&&this._internalMeshDataInfo._effectiveMaterial===g){if(g._storeEffectOnSubMeshes&&!(null===(r=e.effect)||void 0===r?void 0:r._wasPreviouslyReady)||!g._storeEffectOnSubMeshes&&!(null===(o=g.getEffect())||void 0===o?void 0:o._wasPreviouslyReady))return _&&(_.maxZ=u,l.updateTransformMatrix(!0)),this}else{if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,e,p))return _&&(_.maxZ=u,l.updateTransformMatrix(!0)),this}else if(!g.isReady(this,p))return _&&(_.maxZ=u,l.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=g}let v;t&&d.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode),v=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const T=null!==(a=null==v?void 0:v.effect)&&void 0!==a?a:null;for(const t of l._beforeRenderingMeshStage)t.action(this,e,c,T);if(!v||!T)return _&&(_.maxZ=u,l.updateTransformMatrix(!0)),this;const b=i||this;let E;if(m.isFrozen||!this._internalMeshDataInfo._effectiveMaterial.backFaceCulling&&null===this.overrideMaterialSideOrientation&&!this._internalMeshDataInfo._effectiveMaterial.twoSidedLighting)E=m.sideOrientation;else{const e=b._getWorldMatrixDeterminant();E=this.overrideMaterialSideOrientation,null==E&&(E=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),e<0&&(E=E===Ps.ClockWiseSideOrientation?Ps.CounterClockWiseSideOrientation:Ps.ClockWiseSideOrientation),m.sideOrientation=E}const S=this._internalMeshDataInfo._effectiveMaterial._preBind(v,E);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&d.setDepthWrite(!0);const x=this._internalMeshDataInfo._effectiveMaterial,C=x.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),p||this._bind(e,T,C,!1);const y=b.getWorldMatrix();x._storeEffectOnSubMeshes?x.bindForSubMesh(y,this,e):x.bind(y,this),!x.backFaceCulling&&x.separateCullingPass&&(d.setState(!0,x.zOffset,!1,!S,x.cullBackFaces,x.stencil,x.zOffsetUnits),this._processRendering(this,e,T,C,c,p,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),d.setState(!0,x.zOffset,!1,S,x.cullBackFaces,x.stencil,x.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,T,C,c,p,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const t of l._afterRenderingMeshStage)t.action(this,e,c,T);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),_&&(_.maxZ=u,l.updateTransformMatrix(!0)),l.performancePriority!==Mi.Aggressive||m.isFrozen||this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(Oe.MatricesWeightsKind)&&(this.isVerticesDataPresent(Oe.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(Oe.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const t=e[i]+e[i+1]+e[i+2]+e[i+3];if(0===t)e[i]=1;else{const s=1/t;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s}}this.setVerticesData(Oe.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(Oe.MatricesWeightsExtraKind),t=this.getVerticesData(Oe.MatricesWeightsKind),i=t.length;for(let s=0;s<i;s+=4){let i=t[s]+t[s+1]+t[s+2]+t[s+3];if(i+=e[s]+e[s+1]+e[s+2]+e[s+3],0===i)t[s]=1;else{const n=1/i;t[s]*=n,t[s+1]*=n,t[s+2]*=n,t[s+3]*=n,e[s]*=n,e[s+1]*=n,e[s+2]*=n,e[s+3]*=n}}this.setVerticesData(Oe.MatricesWeightsKind,t),this.setVerticesData(Oe.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(Oe.MatricesWeightsExtraKind),t=this.getVerticesData(Oe.MatricesWeightsKind);if(null===t||null==this.skeleton)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let s=0,n=0,r=0,o=0;const a=null===e?4:8,l=[];for(let e=0;e<=a;e++)l[e]=0;for(let h=0;h<i;h+=4){let i=t[h],c=i,d=0===c?0:1;for(let n=1;n<a;n++){const r=n<4?t[h+n]:e[h+n-4];r>i&&s++,0!==r&&d++,c+=r,i=r}if(l[d]++,d>r&&(r=d),0===c)n++;else{const i=1/c;let s=0;for(let n=0;n<a;n++)s+=n<4?Math.abs(t[h+n]-t[h+n]*i):Math.abs(e[h+n-4]-e[h+n-4]*i);s>.001&&o++}}const h=this.skeleton.bones.length,c=this.getVerticesData(Oe.MatricesIndicesKind),d=this.getVerticesData(Oe.MatricesIndicesExtraKind);let u=0;for(let e=0;e<i;e+=4)for(let t=0;t<a;t++){const i=t<4?c[e+t]:d[e+t-4];(i>=h||i<0)&&u++}return{skinned:!0,valid:0===n&&0===o&&0===u,report:"Number of Weights = "+i/4+"\nMaximum influences = "+r+"\nMissing Weights = "+n+"\nNot Sorted = "+s+"\nNot Normalized = "+o+"\nWeightCounts = ["+l+"]\nNumber of bones = "+h+"\nBad Bone Indices = "+u}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):4===this.delayLoadState&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return Ot.LoadFile(this.delayLoadingFile,(t=>{t instanceof ArrayBuffer?this._delayLoadingFunction(t,this):this._delayLoadingFunction(JSON.parse(t),this),this.instances.forEach((e=>{e.refreshBoundingInfo(),e._syncSubMeshes()})),this.delayLoadState=1,e.removePendingData(this)}),(()=>{}),e.offlineProvider,t),this}isInFrustum(e){return 2!==this.delayLoadState&&!!super.isInFrustum(e)&&(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const s=this.getScene().multiMaterials;for(i=s.length-1;i>-1;i--)if(s[i].id===e)return this.material=s[i],this;return this}getAnimatables(){const e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(Oe.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(Oe.PositionKind);const s=me.Zero();let n;for(n=0;n<i.length;n+=3)me.TransformCoordinatesFromFloatsToRef(i[n],i[n+1],i[n+2],e,s).toArray(i,n);if(this.setVerticesData(Oe.PositionKind,i,this.getVertexBuffer(Oe.PositionKind).isUpdatable()),this.isVerticesDataPresent(Oe.NormalKind)){for(i=this.getVerticesData(Oe.NormalKind),n=0;n<i.length;n+=3)me.TransformNormalFromFloatsToRef(i[n],i[n+1],i[n+2],e,s).normalize().toArray(i,n);this.setVerticesData(Oe.NormalKind,i,this.getVertexBuffer(Oe.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return!!this._geometry&&this._geometry._generatePointsArray()}clone(e="",t=null,i,s=!0){return new jn(e,this.getScene(),t,this,i,s)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const e in i.meshMap){const t=i.meshMap[e];t&&(t._internalMeshDataInfo._source=null,i.meshMap[e]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const e=this.getScene().meshes;for(const t of e){const e=t;e._internalMeshDataInfo&&e._internalMeshDataInfo._source&&e._internalMeshDataInfo._source===this&&(e._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,s,n,r,o=!1,a){const l=this.getScene();return Ot.LoadImage(e,(e=>{const a=e.width,l=e.height,h=this.getEngine().createCanvas(a,l).getContext("2d");h.drawImage(e,0,0);const c=h.getImageData(0,0,a,l).data;this.applyDisplacementMapFromBuffer(c,a,l,t,i,n,r,o),s&&s(this)}),a||(()=>{}),l.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,s,n,r,o,a=!1){if(!this.isVerticesDataPresent(Oe.PositionKind)||!this.isVerticesDataPresent(Oe.NormalKind)||!this.isVerticesDataPresent(Oe.UVKind))return p.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const l=this.getVerticesData(Oe.PositionKind,!0,!0),h=this.getVerticesData(Oe.NormalKind),c=this.getVerticesData(Oe.UVKind);let d=me.Zero();const u=me.Zero(),_=pe.Zero();r=r||pe.Zero(),o=o||new pe(1,1);for(let a=0;a<l.length;a+=3){me.FromArrayToRef(l,a,d),me.FromArrayToRef(h,a,u),pe.FromArrayToRef(c,a/3*2,_);const f=4*((Math.abs(_.x*o.x+r.x%1)*(t-1)%t|0)+(Math.abs(_.y*o.y+r.y%1)*(i-1)%i|0)*t),p=e[f]/255*.3+e[f+1]/255*.59+e[f+2]/255*.11;u.normalize(),u.scaleInPlace(s+(n-s)*p),d=d.add(u),d.toArray(l,a)}return Nn.ComputeNormals(l,this.getIndices(),h),a?(this.setVerticesData(Oe.PositionKind,l),this.setVerticesData(Oe.NormalKind,h),this.setVerticesData(Oe.UVKind,c)):(this.updateVerticesData(Oe.PositionKind,l),this.updateVerticesData(Oe.NormalKind,h)),this}_getFlattenedNormals(e,t){const i=new Float32Array(3*e.length);let s=0;const n=this.overrideMaterialSideOrientation===(this._scene.useRightHandedSystem?1:0);for(let r=0;r<e.length;r+=3){const o=me.FromArray(t,3*e[r]),a=me.FromArray(t,3*e[r+1]),l=me.FromArray(t,3*e[r+2]),h=o.subtract(a),c=l.subtract(a),d=me.Normalize(me.Cross(h,c));n&&d.scaleInPlace(-1);for(let e=0;e<3;e++)i[s++]=d.x,i[s++]=d.y,i[s++]=d.z}return i}_convertToUnIndexedMesh(e=!1){const t=this.getVerticesDataKinds(),i=this.getIndices(),s={},n=(e,t)=>{const s=new Float32Array(i.length*t);let n=0;for(let r=0;r<i.length;r++)for(let o=0;o<t;o++)s[n++]=e[i[r]*t+o];return s},r=this.geometry?this.subMeshes.slice(0):[];for(const e of t)s[e]=this.getVerticesData(e);for(const r of t){const t=this.getVertexBuffer(r),o=t.getStrideSize();if(e&&r===Oe.NormalKind){const e=this._getFlattenedNormals(i,s[Oe.PositionKind]);this.setVerticesData(Oe.NormalKind,e,t.isUpdatable(),o)}else this.setVerticesData(r,n(s[r],o),t.isUpdatable(),o)}if(this.morphTargetManager){for(let t=0;t<this.morphTargetManager.numTargets;t++){const s=this.morphTargetManager.getTarget(t),r=s.getPositions();s.setPositions(n(r,3));const o=s.getNormals();o&&s.setNormals(e?this._getFlattenedNormals(i,r):n(o,3));const a=s.getTangents();a&&s.setTangents(n(a,3));const l=s.getUVs();l&&s.setUVs(n(l,2))}this.morphTargetManager.synchronize()}for(let e=0;e<i.length;e++)i[e]=e;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(const e of r)ys.AddToMesh(e.materialIndex,e.indexStart,e.indexCount,e.indexStart,e.indexCount,this);return this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){const t=Nn.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(Oe.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let e;for(i=0;i<t.indices.length;i+=3)e=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=e}return t.applyToMesh(this,this.isVertexBufferUpdatable(Oe.PositionKind)),this}increaseVertices(e=1){const t=Nn.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,s=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,n=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,r=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(i&&s){t.indices=i,t.positions=s,n&&(t.uvs=n),r&&(t.normals=r);const o=e+1,a=new Array;for(let e=0;e<o+1;e++)a[e]=new Array;let l,h;const c=new me(0,0,0),d=new me(0,0,0),u=new pe(0,0),_=new Array,f=new Array,p=new Array;let m,g,v,T=s.length;n&&(g=n.length),r&&(v=r.length);for(let e=0;e<i.length;e+=3){f[0]=i[e],f[1]=i[e+1],f[2]=i[e+2];for(let e=0;e<3;e++)if(l=f[e],h=f[(e+1)%3],void 0===p[l]&&void 0===p[h]?(p[l]=new Array,p[h]=new Array):(void 0===p[l]&&(p[l]=new Array),void 0===p[h]&&(p[h]=new Array)),void 0===p[l][h]&&void 0===p[h][l]){p[l][h]=[],c.x=(s[3*h]-s[3*l])/o,c.y=(s[3*h+1]-s[3*l+1])/o,c.z=(s[3*h+2]-s[3*l+2])/o,r&&(d.x=(r[3*h]-r[3*l])/o,d.y=(r[3*h+1]-r[3*l+1])/o,d.z=(r[3*h+2]-r[3*l+2])/o),n&&(u.x=(n[2*h]-n[2*l])/o,u.y=(n[2*h+1]-n[2*l+1])/o),p[l][h].push(l);for(let e=1;e<o;e++)p[l][h].push(s.length/3),s[T++]=s[3*l]+e*c.x,s[T++]=s[3*l+1]+e*c.y,s[T++]=s[3*l+2]+e*c.z,r&&(r[v++]=r[3*l]+e*d.x,r[v++]=r[3*l+1]+e*d.y,r[v++]=r[3*l+2]+e*d.z),n&&(n[g++]=n[2*l]+e*u.x,n[g++]=n[2*l+1]+e*u.y);p[l][h].push(h),p[h][l]=new Array,m=p[l][h].length;for(let e=0;e<m;e++)p[h][l][e]=p[l][h][m-1-e]}a[0][0]=i[e],a[1][0]=p[i[e]][i[e+1]][1],a[1][1]=p[i[e]][i[e+2]][1];for(let t=2;t<o;t++){a[t][0]=p[i[e]][i[e+1]][t],a[t][t]=p[i[e]][i[e+2]][t],c.x=(s[3*a[t][t]]-s[3*a[t][0]])/t,c.y=(s[3*a[t][t]+1]-s[3*a[t][0]+1])/t,c.z=(s[3*a[t][t]+2]-s[3*a[t][0]+2])/t,r&&(d.x=(r[3*a[t][t]]-r[3*a[t][0]])/t,d.y=(r[3*a[t][t]+1]-r[3*a[t][0]+1])/t,d.z=(r[3*a[t][t]+2]-r[3*a[t][0]+2])/t),n&&(u.x=(n[2*a[t][t]]-n[2*a[t][0]])/t,u.y=(n[2*a[t][t]+1]-n[2*a[t][0]+1])/t);for(let e=1;e<t;e++)a[t][e]=s.length/3,s[T++]=s[3*a[t][0]]+e*c.x,s[T++]=s[3*a[t][0]+1]+e*c.y,s[T++]=s[3*a[t][0]+2]+e*c.z,r&&(r[v++]=r[3*a[t][0]]+e*d.x,r[v++]=r[3*a[t][0]+1]+e*d.y,r[v++]=r[3*a[t][0]+2]+e*d.z),n&&(n[g++]=n[2*a[t][0]]+e*u.x,n[g++]=n[2*a[t][0]+1]+e*u.y)}a[o]=p[i[e+1]][i[e+2]],_.push(a[0][0],a[1][0],a[1][1]);for(let e=1;e<o;e++){let t;for(t=0;t<e;t++)_.push(a[e][t],a[e+1][t],a[e+1][t+1]),_.push(a[e][t],a[e+1][t+1],a[e][t+1]);_.push(a[e][t],a[e+1][t],a[e+1][t+1])}}t.indices=_,t.applyToMesh(this,this.isVertexBufferUpdatable(Oe.PositionKind))}else p.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions")}forceSharedVertices(){const e=Nn.ExtractFromMesh(this),t=e.uvs,i=e.indices,s=e.positions,n=e.colors,r=e.matricesIndices,o=e.matricesWeights,a=e.matricesIndicesExtra,l=e.matricesWeightsExtra;if(void 0===i||void 0===s||null===i||null===s)p.Warn("VertexData contains empty entries");else{const h=new Array,c=new Array,d=new Array,u=new Array,_=new Array,f=new Array,p=new Array,m=new Array;let g=new Array,v=0;const T={};let b,E;for(let e=0;e<i.length;e+=3){E=[i[e],i[e+1],i[e+2]],g=[];for(let e=0;e<3;e++){g[e]="";for(let t=0;t<3;t++)Math.abs(s[3*E[e]+t])<1e-8&&(s[3*E[e]+t]=0),g[e]+=s[3*E[e]+t]+"|"}if(g[0]!=g[1]&&g[0]!=g[2]&&g[1]!=g[2])for(let e=0;e<3;e++){if(b=T[g[e]],void 0===b){T[g[e]]=v,b=v++;for(let t=0;t<3;t++)h.push(s[3*E[e]+t]);if(null!=n)for(let t=0;t<4;t++)u.push(n[4*E[e]+t]);if(null!=t)for(let i=0;i<2;i++)d.push(t[2*E[e]+i]);if(null!=r)for(let t=0;t<4;t++)_.push(r[4*E[e]+t]);if(null!=o)for(let t=0;t<4;t++)f.push(o[4*E[e]+t]);if(null!=a)for(let t=0;t<4;t++)p.push(a[4*E[e]+t]);if(null!=l)for(let t=0;t<4;t++)m.push(l[4*E[e]+t])}c.push(b)}}const S=new Array;Nn.ComputeNormals(h,c,S),e.positions=h,e.indices=c,e.normals=S,null!=t&&(e.uvs=d),null!=n&&(e.colors=u),null!=r&&(e.matricesIndices=_),null!=o&&(e.matricesWeights=f),null!=a&&(e.matricesIndicesExtra=p),null!=o&&(e.matricesWeightsExtra=m),e.applyToMesh(this,this.isVertexBufferUpdatable(Oe.PositionKind))}}static _instancedMeshFactory(e,t){throw f("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw f("PhysicsImpostor")}createInstance(e){return jn._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(Oe.PositionKind);if(!i||!t)return this;const s=[];for(let e=0;e<i.length;e+=3)s.push(me.FromArray(i,e));const n=[];return Dt.SyncAsyncForLoop(s.length,40,(e=>{const t=s.length-1-e,i=s[t];for(let e=0;e<t;++e){const r=s[e];if(i.equals(r)){n[t]=e;break}}}),(()=>{for(let e=0;e<t.length;++e)t[e]=n[t[e]]||t[e];const i=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=i,e&&e(this)})),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),Fe&&Fe.HasTags(this)&&(e.tags=Fe.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let t=0;t<this.subMeshes.length;t++){const i=this.subMeshes[t];e.subMeshes.push({materialIndex:i.materialIndex,verticesStart:i.verticesStart,verticesCount:i.verticesCount,indexStart:i.indexStart,indexCount:i.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(li.NAME_PHYSICSENGINE)){const t=this.getPhysicsImpostor();t&&(e.physicsMass=t.getParam("mass"),e.physicsFriction=t.getParam("friction"),e.physicsRestitution=t.getParam("mass"),e.physicsImpostor=t.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let t=0;t<this.instances.length;t++){const i=this.instances[t];if(i.doNotSerialize)continue;const s={name:i.name,id:i.id,isEnabled:i.isEnabled(!1),isVisible:i.isVisible,isPickable:i.isPickable,checkCollisions:i.checkCollisions,position:i.position.asArray(),scaling:i.scaling.asArray()};if(i.parent&&i.parent._serializeAsParent(s),i.rotationQuaternion?s.rotationQuaternion=i.rotationQuaternion.asArray():i.rotation&&(s.rotation=i.rotation.asArray()),this.getScene()._getComponent(li.NAME_PHYSICSENGINE)){const e=i.getPhysicsImpostor();e&&(s.physicsMass=e.getParam("mass"),s.physicsFriction=e.getParam("friction"),s.physicsRestitution=e.getParam("mass"),s.physicsImpostor=e.type)}i.metadata&&(s.metadata=i.metadata),i.actionManager&&(s.actions=i.actionManager.serialize(i.name)),e.instances.push(s),qe.AppendSerializedAnimations(i,s),s.ranges=i.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const t={data:{},sizes:{},strides:{}};for(const e in this._userThinInstanceBuffersStorage.data)t.data[e]=Array.from(this._userThinInstanceBuffersStorage.data[e]),t.sizes[e]=this._userThinInstanceBuffersStorage.sizes[e],t.strides[e]=this._userThinInstanceBuffersStorage.strides[e];e.thinInstances.userThinInstance=t}return qe.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices())return p.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),s=i.getPositions();if(!s)return void p.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(Oe.PositionKind+t,s,!1,3);const n=i.getNormals();n&&this.geometry.setVerticesData(Oe.NormalKind+t,n,!1,3);const r=i.getTangents();r&&this.geometry.setVerticesData(Oe.TangentKind+t,r,!1,3);const o=i.getUVs();o&&this.geometry.setVerticesData(Oe.UVKind+"_"+t,o,!1,2)}}else{let e=0;for(;this.geometry.isVerticesDataPresent(Oe.PositionKind+e);)this.geometry.removeVerticesData(Oe.PositionKind+e),this.geometry.isVerticesDataPresent(Oe.NormalKind+e)&&this.geometry.removeVerticesData(Oe.NormalKind+e),this.geometry.isVerticesDataPresent(Oe.TangentKind+e)&&this.geometry.removeVerticesData(Oe.TangentKind+e),this.geometry.isVerticesDataPresent(Oe.UVKind+e)&&this.geometry.removeVerticesData(Oe.UVKind+"_"+e),e++}}static Parse(e,t,i){let s;if(s=e.type&&"LinesMesh"===e.type?jn._LinesMeshParser(e,t):e.type&&"GroundMesh"===e.type?jn._GroundMeshParser(e,t):e.type&&"GoldbergMesh"===e.type?jn._GoldbergMeshParser(e,t):e.type&&"GreasedLineMesh"===e.type?jn._GreasedLineMeshParser(e,t):e.type&&"TrailMesh"===e.type?jn._TrailMeshParser(e,t):new jn(e.name,t),s.id=e.id,s._waitingParsedUniqueId=e.uniqueId,Fe&&Fe.AddTagsTo(s,e.tags),s.position=me.FromArray(e.position),void 0!==e.metadata&&(s.metadata=e.metadata),e.rotationQuaternion?s.rotationQuaternion=ve.FromArray(e.rotationQuaternion):e.rotation&&(s.rotation=me.FromArray(e.rotation)),s.scaling=me.FromArray(e.scaling),e.localMatrix?s.setPreTransformMatrix(Te.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(Te.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s.isVisible=e.isVisible,s.infiniteDistance=e.infiniteDistance,s.showBoundingBox=e.showBoundingBox,s.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(s.applyFog=e.applyFog),void 0!==e.pickable&&(s.isPickable=e.pickable),void 0!==e.alphaIndex&&(s.alphaIndex=e.alphaIndex),s.receiveShadows=e.receiveShadows,void 0!==e.billboardMode&&(s.billboardMode=e.billboardMode),void 0!==e.visibility&&(s.visibility=e.visibility),s.checkCollisions=e.checkCollisions,void 0!==e.overrideMaterialSideOrientation&&(s.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation),void 0!==e.isBlocker&&(s.isBlocker=e.isBlocker),s._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(s._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.actions&&(s._waitingData.actions=e.actions),void 0!==e.overlayAlpha&&(s.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(s.overlayColor=Re.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(s.renderOverlay=e.renderOverlay),s.isUnIndexed=!!e.isUnIndexed,s.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s.buildBoundingInfo(me.FromArray(e.boundingBoxMinimum),me.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(s._binaryInfo=e._binaryInfo),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(Oe.UVKind),e.hasUVs2&&s._delayInfo.push(Oe.UV2Kind),e.hasUVs3&&s._delayInfo.push(Oe.UV3Kind),e.hasUVs4&&s._delayInfo.push(Oe.UV4Kind),e.hasUVs5&&s._delayInfo.push(Oe.UV5Kind),e.hasUVs6&&s._delayInfo.push(Oe.UV6Kind),e.hasColors&&s._delayInfo.push(Oe.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(Oe.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(Oe.MatricesWeightsKind),s._delayLoadingFunction=Ln._ImportGeometry,Fn.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):Ln._ImportGeometry(e,s),e.materialUniqueId?s._waitingMaterialId=e.materialUniqueId:e.materialId&&(s._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(s.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),void 0!==e.skeletonId&&null!==e.skeletonId&&(s.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(s.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let t=0;t<e.animations.length;t++){const i=e.animations[t],n=_e("BABYLON.Animation");n&&s.animations.push(n.Parse(i))}et.ParseAnimationRanges(s,e,t)}if(e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?s.layerMask=Math.abs(parseInt(e.layerMask)):s.layerMask=268435455,e.physicsImpostor&&jn._PhysicsImpostorParser(t,s,e),e.lodMeshIds&&(s._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let i=0;i<e.instances.length;i++){const n=e.instances[i],r=s.createInstance(n.name);if(n.id&&(r.id=n.id),Fe&&(n.tags?Fe.AddTagsTo(r,n.tags):Fe.AddTagsTo(r,e.tags)),r.position=me.FromArray(n.position),void 0!==n.metadata&&(r.metadata=n.metadata),void 0!==n.parentId&&(r._waitingParentId=n.parentId),void 0!==n.parentInstanceIndex&&(r._waitingParentInstanceIndex=n.parentInstanceIndex),void 0!==n.isEnabled&&null!==n.isEnabled&&r.setEnabled(n.isEnabled),void 0!==n.isVisible&&null!==n.isVisible&&(r.isVisible=n.isVisible),void 0!==n.isPickable&&null!==n.isPickable&&(r.isPickable=n.isPickable),n.rotationQuaternion?r.rotationQuaternion=ve.FromArray(n.rotationQuaternion):n.rotation&&(r.rotation=me.FromArray(n.rotation)),r.scaling=me.FromArray(n.scaling),null!=n.checkCollisions&&null!=n.checkCollisions&&(r.checkCollisions=n.checkCollisions),null!=n.pickable&&null!=n.pickable&&(r.isPickable=n.pickable),null!=n.showBoundingBox&&null!=n.showBoundingBox&&(r.showBoundingBox=n.showBoundingBox),null!=n.showSubMeshesBoundingBox&&null!=n.showSubMeshesBoundingBox&&(r.showSubMeshesBoundingBox=n.showSubMeshesBoundingBox),null!=n.alphaIndex&&null!=n.showSubMeshesBoundingBox&&(r.alphaIndex=n.alphaIndex),n.physicsImpostor&&jn._PhysicsImpostorParser(t,r,n),void 0!==n.actions&&(r._waitingData.actions=n.actions),n.animations){for(let e=0;e<n.animations.length;e++){const t=n.animations[e],i=_e("BABYLON.Animation");i&&r.animations.push(i.Parse(t))}et.ParseAnimationRanges(r,n,t),n.autoAnimate&&t.beginAnimation(r,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1)}}if(e.thinInstances){const t=e.thinInstances;if(s.thinInstanceEnablePicking=!!t.enablePicking,t.matrixData?(s.thinInstanceSetBuffer("matrix",new Float32Array(t.matrixData),16,!1),s._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,s._thinInstanceDataStorage.instancesCount=t.instancesCount):s._thinInstanceDataStorage.matrixBufferSize=t.matrixBufferSize,e.thinInstances.userThinInstance){const t=e.thinInstances.userThinInstance;for(const e in t.data)s.thinInstanceSetBuffer(e,new Float32Array(t.data[e]),t.strides[e],!1),s._userThinInstanceBuffersStorage.sizes[e]=t.sizes[e]}}return s}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(Oe.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(Oe.PositionKind)||this.setVerticesData(Oe.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(Oe.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(Oe.NormalKind)||this.setVerticesData(Oe.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(Oe.PositionKind))return this;if(!this.isVerticesDataPresent(Oe.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(Oe.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(Oe.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(Oe.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let n=this.getVerticesData(Oe.NormalKind);if(t){if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n))}const r=this.getVerticesData(Oe.MatricesIndicesKind),o=this.getVerticesData(Oe.MatricesWeightsKind);if(!o||!r)return this;const a=this.numBoneInfluencers>4,l=a?this.getVerticesData(Oe.MatricesIndicesExtraKind):null,h=a?this.getVerticesData(Oe.MatricesWeightsExtraKind):null,c=e.getTransformMatrices(this),d=me.Zero(),u=new Te,_=new Te;let f,p=0;for(let e=0;e<s.length;e+=3,p+=4){let m;for(f=0;f<4;f++)m=o[p+f],m>0&&(Te.FromFloat32ArrayToRefScaled(c,Math.floor(16*r[p+f]),m,_),u.addToSelf(_));if(a)for(f=0;f<4;f++)m=h[p+f],m>0&&(Te.FromFloat32ArrayToRefScaled(c,Math.floor(16*l[p+f]),m,_),u.addToSelf(_));me.TransformCoordinatesFromFloatsToRef(i._sourcePositions[e],i._sourcePositions[e+1],i._sourcePositions[e+2],u,d),d.toArray(s,e),t&&(me.TransformNormalFromFloatsToRef(i._sourceNormals[e],i._sourceNormals[e+1],i._sourceNormals[e+2],u,d),d.toArray(n,e)),u.reset()}return this.updateVerticesData(Oe.PositionKind,s),t&&this.updateVerticesData(Oe.NormalKind,n),this}static MinMax(e){let t=null,i=null;return e.forEach((function(e){const s=e.getBoundingInfo().boundingBox;t&&i?(t.minimizeInPlace(s.minimumWorld),i.maximizeInPlace(s.maximumWorld)):(t=s.minimumWorld,i=s.maximumWorld)})),t&&i?{min:t,max:i}:{min:me.Zero(),max:me.Zero()}}static Center(e){const t=e instanceof Array?jn.MinMax(e):e;return me.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,s,n,r){return On(jn._MergeMeshesCoroutine(e,t,i,s,n,r,!1))}static MergeMeshesAsync(e,t=!0,i,s,n,r){return o=jn._MergeMeshesCoroutine(e,t,i,s,n,r,!0),a=function(e=25){let t;return(i,s,n)=>{const r=performance.now();void 0===t||r-t>e?(t=r,setTimeout((()=>{Pn(i,s,n)}),0)):Pn(i,s,n)}}(),new Promise(((e,t)=>{Mn(o,a,e,t,l)}));var o,a,l}static*_MergeMeshesCoroutine(e,t=!0,i,s,n,r,o){if(0===(e=e.filter(Boolean)).length)return null;let a;if(!i){let t=0;for(a=0;a<e.length;a++)if(t+=e[a].getTotalVertices(),t>=65536)return p.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}r&&(n=!1);const l=new Array,h=new Array,c=new Array,d=e[0].overrideMaterialSideOrientation;for(a=0;a<e.length;a++){const t=e[a];if(t.isAnInstance)return p.Warn("Cannot merge instance meshes."),null;if(d!==t.overrideMaterialSideOrientation)return p.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(n&&c.push(t.getTotalIndices()),r)if(t.material){const e=t.material;if(e instanceof zn){for(let t=0;t<e.subMaterials.length;t++)l.indexOf(e.subMaterials[t])<0&&l.push(e.subMaterials[t]);for(let i=0;i<t.subMeshes.length;i++)h.push(l.indexOf(e.subMaterials[t.subMeshes[i].materialIndex])),c.push(t.subMeshes[i].indexCount)}else{l.indexOf(e)<0&&l.push(e);for(let i=0;i<t.subMeshes.length;i++)h.push(l.indexOf(e)),c.push(t.subMeshes[i].indexCount)}}else for(let e=0;e<t.subMeshes.length;e++)h.push(0),c.push(t.subMeshes[e].indexCount)}const u=e[0],_=e=>{const t=e.computeWorldMatrix(!0);return{vertexData:Nn.ExtractFromMesh(e,!1,!1),transform:t}},{vertexData:f,transform:m}=_(u);o&&(yield);const g=new Array(e.length-1);for(let t=1;t<e.length;t++)g[t-1]=_(e[t]),o&&(yield);const v=f._mergeCoroutine(m,g,i,o,!t);let T=v.next();for(;!T.done;)o&&(yield),T=v.next();const b=T.value;s||(s=new jn(u.name+"_merged",u.getScene()));const E=b._applyToCoroutine(s,void 0,o);let S=E.next();for(;!S.done;)o&&(yield),S=E.next();if(s.checkCollisions=u.checkCollisions,s.overrideMaterialSideOrientation=u.overrideMaterialSideOrientation,t)for(a=0;a<e.length;a++)e[a].dispose();if(n||r){s.releaseSubMeshes(),a=0;let e=0;for(;a<c.length;)ys.CreateFromIndices(0,e,c[a],s,void 0,!1),e+=c[a],a++;for(const e of s.subMeshes)e.refreshBoundingInfo();s.computeWorldMatrix(!0)}if(r){const e=new zn(u.name+"_merged",u.getScene());e.subMaterials=l;for(let e=0;e<s.subMeshes.length;e++)s.subMeshes[e].materialIndex=h[e];s.material=e}else s.material=u.material;return s}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(-1!=t){if(t!==this.instances.length-1){const e=this.instances[this.instances.length-1];this.instances[t]=e,e._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===Ps.CounterClockWiseSideOrientation}_getRenderingFillMode(e){var t;const i=this.getScene();return i.forcePointsCloud?Ps.PointFillMode:i.forceWireframe?Ps.WireFrameFillMode:null!==(t=this.overrideRenderingFillMode)&&void 0!==t?t:e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,s,n,r,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,s,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,s,n){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,s,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,s){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,s,n,r,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,s,n,r,o){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,s,n,r,o,a,l,h){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,s,n){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,s,n,r,o,a){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,s,n,r,o){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,s,n,r,o,a){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,s,n,r,o,a,l,h){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,s,n,r,o,a,l,h,c,d){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,s,n,r,o){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,s,n){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,s,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,s,n,r,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,s,n,r,o,a,l,h,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,s,n,r,o,a,l,h){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,s,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}}jn.FRONTSIDE=Nn.FRONTSIDE,jn.BACKSIDE=Nn.BACKSIDE,jn.DOUBLESIDE=Nn.DOUBLESIDE,jn.DEFAULTSIDE=Nn.DEFAULTSIDE,jn.NO_CAP=0,jn.CAP_START=1,jn.CAP_END=2,jn.CAP_ALL=3,jn.NO_FLIP=0,jn.FLIP_TILE=1,jn.ROTATE_TILE=2,jn.FLIP_ROW=3,jn.ROTATE_ROW=4,jn.FLIP_N_ROTATE_TILE=5,jn.FLIP_N_ROTATE_ROW=6,jn.CENTER=0,jn.LEFT=1,jn.RIGHT=2,jn.TOP=3,jn.BOTTOM=4,jn.INSTANCEDMESH_SORT_TRANSPARENT=!1,jn._GroundMeshParser=(e,t)=>{throw f("GroundMesh")},jn._GoldbergMeshParser=(e,t)=>{throw f("GoldbergMesh")},jn._LinesMeshParser=(e,t)=>{throw f("LinesMesh")},jn._GreasedLineMeshParser=(e,t)=>{throw f("GreasedLineMesh")},jn._GreasedLineRibbonMeshParser=(e,t)=>{throw f("GreasedLineRibbonMesh")},jn._TrailMeshParser=(e,t)=>{throw f("TrailMesh")},ue("BABYLON.Mesh",jn);class $n{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add((e=>{e.type!==ci.POINTERDOWN?e.type===ci.POINTERUP&&(this._isPointerDown=!1):this._isPointerDown=!0})),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{if(this._reachTargetAlpha())return;const e=j.Now;let t=0;null!=this._lastFrameTime&&(t=e-this._lastFrameTime),this._lastFrameTime=e,this._applyUserInteraction();const i=e-this._lastInteractionTime-this._idleRotationWaitTime,s=Math.max(Math.min(i/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*s,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(t/1e3))}))}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=null!=e?e:j.Now}_reachTargetAlpha(){return!(!this._attachedCamera||!this.targetAlpha)&&Math.abs(this._attachedCamera.alpha-this.targetAlpha)<ae}_userIsZooming(){return!!this._attachedCamera&&0!==this._attachedCamera.inertialRadiusOffset}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&0!==this._attachedCamera.inertialRadiusOffset&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=j.Now)}_userIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}class qn{constructor(){this._easingMode=qn.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case qn.EASINGMODE_EASEIN:return this.easeInCore(e);case qn.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?.5*(1-this.easeInCore(2*(1-e)))+.5:.5*this.easeInCore(2*e)}}qn.EASINGMODE_EASEIN=0,qn.EASINGMODE_EASEOUT=1,qn.EASINGMODE_EASEINOUT=2;class Zn extends qn{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}}class Jn extends qn{easeInCore(e){return e*e}}class er extends qn{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}}var tr;!function(e){e[e.NONE=0]="NONE",e[e.STEP=1]="STEP"}(tr||(tr={}));class ir{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new ir(this.name,this.from,this.to)}}const sr=Object.freeze(new ve(0,0,0,0)),nr=Object.freeze(me.Zero()),rr=Object.freeze(pe.Zero()),or=Object.freeze(Bi.Zero()),ar=Object.freeze(Re.Black()),lr=Object.freeze(new Ie(0,0,0,0)),hr={key:0,repeatCount:0,loopMode:2};class cr{static _PrepareAnimation(e,t,i,s,n,r,o,a){let l;if(!isNaN(parseFloat(n))&&isFinite(n)?l=cr.ANIMATIONTYPE_FLOAT:n instanceof ve?l=cr.ANIMATIONTYPE_QUATERNION:n instanceof me?l=cr.ANIMATIONTYPE_VECTOR3:n instanceof pe?l=cr.ANIMATIONTYPE_VECTOR2:n instanceof Re?l=cr.ANIMATIONTYPE_COLOR3:n instanceof Ie?l=cr.ANIMATIONTYPE_COLOR4:n instanceof Bi&&(l=cr.ANIMATIONTYPE_SIZE),null==l)return null;const h=new cr(e,t,i,l,o),c=[{frame:0,value:n},{frame:s,value:r}];return h.setKeys(c),void 0!==a&&h.setEasingFunction(a),h}static CreateAnimation(e,t,i,s){const n=new cr(e+"Animation",e,i,t,cr.ANIMATIONLOOPMODE_CONSTANT);return n.setEasingFunction(s),n}static CreateAndStartAnimation(e,t,i,s,n,r,o,a,l,h,c){const d=cr._PrepareAnimation(e,i,s,n,r,o,a,l);return d?(t.getScene&&(c=t.getScene()),c?c.beginDirectAnimation(t,[d],0,n,1===d.loopMode,1,h):null):null}static CreateAndStartHierarchyAnimation(e,t,i,s,n,r,o,a,l,h,c){const d=cr._PrepareAnimation(e,s,n,r,o,a,l,h);return d?t.getScene().beginDirectHierarchyAnimation(t,i,[d],0,r,1===d.loopMode,1,c):null}static CreateMergeAndStartAnimation(e,t,i,s,n,r,o,a,l,h){const c=cr._PrepareAnimation(e,i,s,n,r,o,a,l);return c?(t.animations.push(c),t.getScene().beginAnimation(t,0,n,1===c.loopMode,1,h)):null}static MakeAnimationAdditive(e,t,i,s=!1,n){var r,o;let a;a="object"==typeof t?t:{referenceFrame:null!=t?t:0,range:i,cloneOriginalAnimation:s,clonedAnimationName:n};let l=e;if(a.cloneOriginalAnimation&&(l=e.clone(),l.name=a.clonedAnimationName||l.name),!l._keys.length)return l;const h=a.referenceFrame&&a.referenceFrame>=0?a.referenceFrame:0;let c=0;const d=l._keys[0];let u=l._keys.length-1;const _=l._keys[u],f={referenceValue:d.value,referencePosition:Ee.Vector3[0],referenceQuaternion:Ee.Quaternion[0],referenceScaling:Ee.Vector3[1],keyPosition:Ee.Vector3[2],keyQuaternion:Ee.Quaternion[1],keyScaling:Ee.Vector3[3]};let p=d.frame,m=_.frame;if(a.range){const e=l.getRange(a.range);e&&(p=e.from,m=e.to)}else p=null!==(r=a.fromFrame)&&void 0!==r?r:p,m=null!==(o=a.toFrame)&&void 0!==o?o:m;if(p!==d.frame&&(c=l.createKeyForFrame(p)),m!==_.frame&&(u=l.createKeyForFrame(m)),1===l._keys.length){const e=l._getKeyValue(l._keys[0]);f.referenceValue=e.clone?e.clone():e}else if(h<=d.frame){const e=l._getKeyValue(d.value);f.referenceValue=e.clone?e.clone():e}else if(h>=_.frame){const e=l._getKeyValue(_.value);f.referenceValue=e.clone?e.clone():e}else{hr.key=0;const e=l._interpolate(h,hr);f.referenceValue=e.clone?e.clone():e}l.dataType===cr.ANIMATIONTYPE_QUATERNION?f.referenceValue.normalize().conjugateInPlace():l.dataType===cr.ANIMATIONTYPE_MATRIX&&(f.referenceValue.decompose(f.referenceScaling,f.referenceQuaternion,f.referencePosition),f.referenceQuaternion.normalize().conjugateInPlace());let g=Number.MAX_VALUE;const v=a.clipKeys?[]:null;for(let e=c;e<=u;e++){let t=l._keys[e];if(v&&(t={frame:t.frame,value:t.value.clone?t.value.clone():t.value,inTangent:t.inTangent,outTangent:t.outTangent,interpolation:t.interpolation,lockedTangent:t.lockedTangent},g===Number.MAX_VALUE&&(g=t.frame),t.frame-=g,v.push(t)),!e||l.dataType===cr.ANIMATIONTYPE_FLOAT||t.value!==d.value)switch(l.dataType){case cr.ANIMATIONTYPE_MATRIX:t.value.decompose(f.keyScaling,f.keyQuaternion,f.keyPosition),f.keyPosition.subtractInPlace(f.referencePosition),f.keyScaling.divideInPlace(f.referenceScaling),f.referenceQuaternion.multiplyToRef(f.keyQuaternion,f.keyQuaternion),Te.ComposeToRef(f.keyScaling,f.keyQuaternion,f.keyPosition,t.value);break;case cr.ANIMATIONTYPE_QUATERNION:f.referenceValue.multiplyToRef(t.value,t.value);break;case cr.ANIMATIONTYPE_VECTOR2:case cr.ANIMATIONTYPE_VECTOR3:case cr.ANIMATIONTYPE_COLOR3:case cr.ANIMATIONTYPE_COLOR4:t.value.subtractToRef(f.referenceValue,t.value);break;case cr.ANIMATIONTYPE_SIZE:t.value.width-=f.referenceValue.width,t.value.height-=f.referenceValue.height;break;default:t.value-=f.referenceValue}}return v&&l.setKeys(v,!0),l}static TransitionTo(e,t,i,s,n,r,o,a=null){if(o<=0)return i[e]=t,a&&a(),null;const l=n*(o/1e3);r.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:l,value:t}]),i.animations||(i.animations=[]),i.animations.push(r);const h=s.beginAnimation(i,0,l,!1);return h.onAnimationEnd=a,h}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,s,n,r){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=s,this.loopMode=n,this.enableBlending=r,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=s,this.loopMode=void 0===n?cr.ANIMATIONLOOPMODE_CYCLE:n,this.uniqueId=cr._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let e=!0;for(const i in this._ranges)e&&(t+=", ",e=!1),t+=i;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort(((e,t)=>e.frame-t.frame))}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new ir(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const e=i.from,t=i.to;for(let i=this._keys.length-1;i>=0;i--)this._keys[i].frame>=e&&this._keys[i].frame<=t&&this._keys.splice(i,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return ne.Lerp(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,s,n){return ne.Hermite(e,t,i,s,n)}quaternionInterpolateFunction(e,t,i){return ve.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,s,n){return ve.Hermite(e,t,i,s,n).normalize()}vector3InterpolateFunction(e,t,i){return me.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,s,n){return me.Hermite(e,t,i,s,n)}vector2InterpolateFunction(e,t,i){return pe.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,s,n){return pe.Hermite(e,t,i,s,n)}sizeInterpolateFunction(e,t,i){return Bi.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return Re.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,s,n){return Re.Hermite(e,t,i,s,n)}color4InterpolateFunction(e,t,i){return Ie.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,s,n){return Ie.Hermite(e,t,i,s,n)}_getKeyValue(e){return"function"==typeof e?e():e}evaluate(e){return hr.key=0,this._interpolate(e,hr)}_interpolate(e,t,i=!1){var s;if(t.loopMode===cr.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const n=this._keys,r=n.length;let o=t.key;for(;o>=0&&e<n[o].frame;)--o;for(;o+1<=r-1&&e>=n[o+1].frame;)++o;if(t.key=o,o<0)return i?void 0:this._getKeyValue(n[0].value);if(o+1>r-1)return i?void 0:this._getKeyValue(n[r-1].value);const a=n[o],l=n[o+1];if(i&&(e===a.frame||e===l.frame))return;const h=this._getKeyValue(a.value),c=this._getKeyValue(l.value);if(a.interpolation===tr.STEP)return l.frame>e?h:c;const d=void 0!==a.outTangent&&void 0!==l.inTangent,u=l.frame-a.frame;let _=(e-a.frame)/u;const f=a.easingFunction||this.getEasingFunction();switch(null!==f&&(_=f.ease(_)),this.dataType){case cr.ANIMATIONTYPE_FLOAT:{const e=d?this.floatInterpolateFunctionWithTangents(h,a.outTangent*u,c,l.inTangent*u,_):this.floatInterpolateFunction(h,c,_);switch(t.loopMode){case cr.ANIMATIONLOOPMODE_CYCLE:case cr.ANIMATIONLOOPMODE_CONSTANT:case cr.ANIMATIONLOOPMODE_YOYO:return e;case cr.ANIMATIONLOOPMODE_RELATIVE:case cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(null!==(s=t.offsetValue)&&void 0!==s?s:0)*t.repeatCount+e}break}case cr.ANIMATIONTYPE_QUATERNION:{const e=d?this.quaternionInterpolateFunctionWithTangents(h,a.outTangent.scale(u),c,l.inTangent.scale(u),_):this.quaternionInterpolateFunction(h,c,_);switch(t.loopMode){case cr.ANIMATIONLOOPMODE_CYCLE:case cr.ANIMATIONLOOPMODE_CONSTANT:case cr.ANIMATIONLOOPMODE_YOYO:return e;case cr.ANIMATIONLOOPMODE_RELATIVE:case cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||sr).scale(t.repeatCount))}return e}case cr.ANIMATIONTYPE_VECTOR3:{const e=d?this.vector3InterpolateFunctionWithTangents(h,a.outTangent.scale(u),c,l.inTangent.scale(u),_):this.vector3InterpolateFunction(h,c,_);switch(t.loopMode){case cr.ANIMATIONLOOPMODE_CYCLE:case cr.ANIMATIONLOOPMODE_CONSTANT:case cr.ANIMATIONLOOPMODE_YOYO:return e;case cr.ANIMATIONLOOPMODE_RELATIVE:case cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||nr).scale(t.repeatCount))}break}case cr.ANIMATIONTYPE_VECTOR2:{const e=d?this.vector2InterpolateFunctionWithTangents(h,a.outTangent.scale(u),c,l.inTangent.scale(u),_):this.vector2InterpolateFunction(h,c,_);switch(t.loopMode){case cr.ANIMATIONLOOPMODE_CYCLE:case cr.ANIMATIONLOOPMODE_CONSTANT:case cr.ANIMATIONLOOPMODE_YOYO:return e;case cr.ANIMATIONLOOPMODE_RELATIVE:case cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||rr).scale(t.repeatCount))}break}case cr.ANIMATIONTYPE_SIZE:switch(t.loopMode){case cr.ANIMATIONLOOPMODE_CYCLE:case cr.ANIMATIONLOOPMODE_CONSTANT:case cr.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(h,c,_);case cr.ANIMATIONLOOPMODE_RELATIVE:case cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(h,c,_).add((t.offsetValue||or).scale(t.repeatCount))}break;case cr.ANIMATIONTYPE_COLOR3:{const e=d?this.color3InterpolateFunctionWithTangents(h,a.outTangent.scale(u),c,l.inTangent.scale(u),_):this.color3InterpolateFunction(h,c,_);switch(t.loopMode){case cr.ANIMATIONLOOPMODE_CYCLE:case cr.ANIMATIONLOOPMODE_CONSTANT:case cr.ANIMATIONLOOPMODE_YOYO:return e;case cr.ANIMATIONLOOPMODE_RELATIVE:case cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||ar).scale(t.repeatCount))}break}case cr.ANIMATIONTYPE_COLOR4:{const e=d?this.color4InterpolateFunctionWithTangents(h,a.outTangent.scale(u),c,l.inTangent.scale(u),_):this.color4InterpolateFunction(h,c,_);switch(t.loopMode){case cr.ANIMATIONLOOPMODE_CYCLE:case cr.ANIMATIONLOOPMODE_CONSTANT:case cr.ANIMATIONLOOPMODE_YOYO:return e;case cr.ANIMATIONLOOPMODE_RELATIVE:case cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||lr).scale(t.repeatCount))}break}case cr.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case cr.ANIMATIONLOOPMODE_CYCLE:case cr.ANIMATIONLOOPMODE_CONSTANT:case cr.ANIMATIONLOOPMODE_YOYO:return cr.AllowMatricesInterpolation?this.matrixInterpolateFunction(h,c,_,t.workValue):h;case cr.ANIMATIONLOOPMODE_RELATIVE:case cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return h}}return 0}matrixInterpolateFunction(e,t,i,s){return cr.AllowMatrixDecomposeForInterpolation?s?(Te.DecomposeLerpToRef(e,t,i,s),s):Te.DecomposeLerp(e,t,i):s?(Te.LerpToRef(e,t,i,s),s):Te.Lerp(e,t,i)}clone(){const e=new cr(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){hr.key=0;const t=this._interpolate(e,hr,!0);if(!t)return this._keys[hr.key].frame===e?hr.key:hr.key+1;const i={frame:e,value:t.clone?t.clone():t};return this._keys.splice(hr.key+1,0,i),hr.key+1}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let s=0;s<i.length;s++){const n=i[s],r={};switch(r.frame=n.frame,t){case cr.ANIMATIONTYPE_FLOAT:r.values=[n.value],void 0!==n.inTangent&&r.values.push(n.inTangent),void 0!==n.outTangent&&(void 0===n.inTangent&&r.values.push(void 0),r.values.push(n.outTangent)),void 0!==n.interpolation&&(void 0===n.inTangent&&r.values.push(void 0),void 0===n.outTangent&&r.values.push(void 0),r.values.push(n.interpolation));break;case cr.ANIMATIONTYPE_QUATERNION:case cr.ANIMATIONTYPE_MATRIX:case cr.ANIMATIONTYPE_VECTOR3:case cr.ANIMATIONTYPE_COLOR3:case cr.ANIMATIONTYPE_COLOR4:r.values=n.value.asArray(),null!=n.inTangent&&r.values.push(n.inTangent.asArray()),null!=n.outTangent&&(void 0===n.inTangent&&r.values.push(void 0),r.values.push(n.outTangent.asArray())),void 0!==n.interpolation&&(void 0===n.inTangent&&r.values.push(void 0),void 0===n.outTangent&&r.values.push(void 0),r.values.push(n.interpolation))}e.keys.push(r)}e.ranges=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.ranges.push(s)}return e}static _UniversalLerp(e,t,i){const s=e.constructor;return s.Lerp?s.Lerp(e,t,i):s.Slerp?s.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new cr(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,s=[];let n,r;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),r=0;r<e.keys.length;r++){const t=e.keys[r];let o,a,l;switch(i){case cr.ANIMATIONTYPE_FLOAT:n=t.values[0],t.values.length>=2&&(o=t.values[1]),t.values.length>=3&&(a=t.values[2]),t.values.length>=4&&(l=t.values[3]);break;case cr.ANIMATIONTYPE_QUATERNION:if(n=ve.FromArray(t.values),t.values.length>=8){const e=ve.FromArray(t.values.slice(4,8));e.equals(ve.Zero())||(o=e)}if(t.values.length>=12){const e=ve.FromArray(t.values.slice(8,12));e.equals(ve.Zero())||(a=e)}t.values.length>=13&&(l=t.values[12]);break;case cr.ANIMATIONTYPE_MATRIX:n=Te.FromArray(t.values),t.values.length>=17&&(l=t.values[16]);break;case cr.ANIMATIONTYPE_COLOR3:n=Re.FromArray(t.values),t.values[3]&&(o=Re.FromArray(t.values[3])),t.values[4]&&(a=Re.FromArray(t.values[4])),t.values[5]&&(l=t.values[5]);break;case cr.ANIMATIONTYPE_COLOR4:n=Ie.FromArray(t.values),t.values[4]&&(o=Ie.FromArray(t.values[4])),t.values[5]&&(a=Ie.FromArray(t.values[5])),t.values[6]&&(l=Ie.FromArray(t.values[6]));break;case cr.ANIMATIONTYPE_VECTOR3:default:n=me.FromArray(t.values),t.values[3]&&(o=me.FromArray(t.values[3])),t.values[4]&&(a=me.FromArray(t.values[4])),t.values[5]&&(l=t.values[5])}const h={};h.frame=t.frame,h.value=n,null!=o&&(h.inTangent=o),null!=a&&(h.outTangent=a),null!=l&&(h.interpolation=l),s.push(h)}if(t.setKeys(s),e.ranges)for(r=0;r<e.ranges.length;r++)n=e.ranges[r],t.createRange(n.name,n.from,n.to);return t}static AppendSerializedAnimations(e,t){qe.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise(((i,s)=>{const n=new st;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){let t=JSON.parse(n.responseText);if(t.animations&&(t=t.animations),t.length){const e=[];for(const i of t)e.push(this.Parse(i));i(e)}else{const s=this.Parse(t);e&&(s.name=e),i(s)}}else s("Unable to load the animation")})),n.open("GET",t),n.send()}))}static ParseFromSnippetAsync(e){return new Promise(((t,i)=>{const s=new st;s.addEventListener("readystatechange",(()=>{if(4==s.readyState)if(200==s.status){const i=JSON.parse(JSON.parse(s.responseText).jsonPayload);if(i.animations){const s=JSON.parse(i.animations),n=[];for(const t of s.animations){const i=this.Parse(t);i.snippetId=e,n.push(i)}t(n)}else{const s=JSON.parse(i.animation),n=this.Parse(s);n.snippetId=e,t(n)}}else i("Unable to load the snippet "+e)})),s.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send()}))}}cr._UniqueIdGenerator=0,cr.AllowMatricesInterpolation=!1,cr.AllowMatrixDecomposeForInterpolation=!0,cr.SnippetUrl="https://snippet.babylonjs.com",cr.ANIMATIONTYPE_FLOAT=0,cr.ANIMATIONTYPE_VECTOR3=1,cr.ANIMATIONTYPE_QUATERNION=2,cr.ANIMATIONTYPE_MATRIX=3,cr.ANIMATIONTYPE_COLOR3=4,cr.ANIMATIONTYPE_COLOR4=7,cr.ANIMATIONTYPE_VECTOR2=5,cr.ANIMATIONTYPE_SIZE=6,cr.ANIMATIONLOOPMODE_RELATIVE=0,cr.ANIMATIONLOOPMODE_CYCLE=1,cr.ANIMATIONLOOPMODE_CONSTANT=2,cr.ANIMATIONLOOPMODE_YOYO=4,cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5,cr.CreateFromSnippetAsync=cr.ParseFromSnippetAsync,ue("BABYLON.Animation",cr),et._AnimationRangeFactory=(e,t,i)=>new ir(e,t,i);class dr{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add((e=>{if(!e)return;e.computeWorldMatrix(!0);const t=e.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=.05*t,this.upperRadiusTransitionRange=.05*t})):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))}))}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return!!this._attachedCamera&&this._attachedCamera.radius===e&&!this._radiusIsAnimating}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(dr.EasingFunction.setEasingMode(dr.EasingMode),this._radiusBounceTransition=cr.CreateAnimation("radius",cr.ANIMATIONTYPE_FLOAT,60,dr.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=cr.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,(()=>this._clearAnimationLocks()));t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}dr.EasingFunction=new class extends qn{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}(.3),dr.EasingMode=qn.EASINGMODE_EASEOUT;class ur{constructor(){this.onTargetFramingAnimationEndObservable=new s,this._mode=ur.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();ur.EasingFunction.setEasingMode(ur.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add((e=>{e.type!==ci.POINTERDOWN?e.type===ci.POINTERUP&&(this._isPointerDown=!1):this._isPointerDown=!0})),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add((e=>{e&&this.zoomOnMesh(e,void 0,(()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()}))})),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add((()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()}))}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(s.minimumWorld,s.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(s.min,s.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const s=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new me(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let t=0;t<e.length;t++){const i=e[t].getHierarchyBoundingVectors(!0);me.CheckExtends(i.min,s,n),me.CheckExtends(i.max,s,n)}this.zoomOnBoundingInfo(s,n,t,i)}zoomOnBoundingInfo(e,t,i=!1,s=null){let n;if(!this._attachedCamera)return!1;const r=e.y,o=r+(t.y-r)*this._positionScale,a=t.subtract(e).scale(.5);if(i)n=new me(0,o,0);else{const t=e.add(a);n=new me(t.x,o,t.z)}this._vectorTransition||(this._vectorTransition=cr.CreateAnimation("target",cr.ANIMATIONTYPE_VECTOR3,60,ur.EasingFunction)),this._betaIsAnimating=!0;let l=cr.TransitionTo("target",n,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);l&&this._animatables.push(l);let h=0;if(this._mode===ur.FitFrustumSidesMode){const i=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=a.length()+this._attachedCamera.minZ),h=i}else this._mode===ur.IgnoreBoundsSizeMode&&(h=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&null===this._attachedCamera.lowerRadiusLimit&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const i=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/i,this._attachedCamera.wheelPrecision=100/h}return this._radiusTransition||(this._radiusTransition=cr.CreateAnimation("radius",cr.ANIMATIONTYPE_FLOAT,60,ur.EasingFunction)),l=cr.TransitionTo("radius",h,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,(()=>{this.stopAllAnimations(),s&&s(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()})),l&&this._animatables.push(l),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){const i=this._attachedCamera;if(!i)return 0;let s=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===ur.IgnoreBoundsSizeMode&&(s=s<i.lowerRadiusLimit?i.lowerRadiusLimit:s),i.upperRadiusLimit&&(s=s>i.upperRadiusLimit?i.upperRadiusLimit:s),s}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=j.Now-this._lastInteractionTime,t=.5*Math.PI-this._defaultElevation,i=.5*Math.PI;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=cr.CreateAnimation("beta",cr.ANIMATIONTYPE_FLOAT,60,ur.EasingFunction));const e=cr.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,(()=>{this._clearAnimationLocks(),this.stopAllAnimations()}));e&&this._animatables.push(e)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=j.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}ur.EasingFunction=new class extends qn{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}},ur.EasingMode=qn.EASINGMODE_EASEINOUT,ur.IgnoreBoundsSizeMode=0,ur.FitFrustumSidesMode=1;class _r extends Gt{constructor(e,t,i,s=!0){super(e,t,i,s),this._tmpUpVector=me.Zero(),this._tmpTargetVector=me.Zero(),this.cameraDirection=new me(0,0,0),this.cameraRotation=new pe(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new ve,this.rotation=new me(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=me.Zero(),this._initialFocalDistance=1,this._viewMatrix=Te.Zero(),this._camMatrix=Te.Zero(),this._cameraTransformMatrix=Te.Zero(),this._cameraRotationMatrix=Te.Zero(),this._referencePoint=new me(0,0,1),this._transformedReferencePoint=me.Zero(),this._deferredPositionUpdate=new me,this._deferredRotationQuaternionUpdate=new ve,this._deferredRotationUpdate=new me,this._deferredUpdated=!1,this._deferOnly=!1,this._defaultUp=me.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)}_initCache(){super._initCache(),this._cache.lockedTarget=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new ve(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(100*e.getFps()))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=ae),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),Te.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&ve.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(Ee.Matrix[0]),me.TransformNormalToRef(this.cameraDirection,Ee.Matrix[0],Ee.Vector3[0]),this._deferredPositionUpdate.addInPlace(Ee.Vector3[0]),void(this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate));this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;if(this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i){if(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,!this.noRotationConstraint){const e=1.570796;this._deferredRotationUpdate.x>e&&(this._deferredRotationUpdate.x=e),this._deferredRotationUpdate.x<-e&&(this._deferredRotationUpdate.x=-e)}this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(ve.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))}t&&(Math.abs(this.cameraDirection.x)<this.speed*ae&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*ae&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*ae&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*ae&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*ae&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):Te.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return me.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),me.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?nn.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(ve.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),nn.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const s=this.parent.getWorldMatrix();me.TransformCoordinatesToRef(e,s,this._globalPosition),me.TransformCoordinatesToRef(t,s,this._tmpTargetVector),me.TransformNormalToRef(i,s,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?Te.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):Te.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix)}else if(this.getScene().useRightHandedSystem?Te.LookAtRHToRef(e,t,i,this._viewMatrix):Te.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==Gt.RIG_MODE_NONE){const t=new _r(e,this.position.clone(),this.getScene());return t.isRigCamera=!0,t.rigParent=this,this.cameraRigMode===Gt.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new ve),t._cameraRigParams={},t.rotationQuaternion=new ve),t.mode=this.mode,t.orthoLeft=this.orthoLeft,t.orthoRight=this.orthoRight,t.orthoTop=this.orthoTop,t.orthoBottom=this.orthoBottom,t}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Gt.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Gt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Gt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Gt.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Gt.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===Gt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,s=this.cameraRigMode===Gt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*s,t);break}case Gt.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position)}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,_r._TargetFocalPoint),_r._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const i=_r._TargetFocalPoint.addInPlace(this.position);Te.TranslationToRef(-i.x,-i.y,-i.z,_r._TargetTransformMatrix),_r._TargetTransformMatrix.multiplyToRef(Te.RotationAxis(t.upVector,e),_r._RigCamTransformMatrix),Te.TranslationToRef(i.x,i.y,i.z,_r._TargetTransformMatrix),_r._RigCamTransformMatrix.multiplyToRef(_r._TargetTransformMatrix,_r._RigCamTransformMatrix),me.TransformCoordinatesToRef(this.position,_r._RigCamTransformMatrix,t.position),t.setTarget(i)}getClassName(){return"TargetCamera"}}_r._RigCamTransformMatrix=new Te,_r._TargetTransformMatrix=new Te,_r._TargetFocalPoint=new me,De([Qe()],_r.prototype,"rotation",void 0),De([Ge()],_r.prototype,"speed",void 0),De([Ye("lockedTargetId")],_r.prototype,"lockedTarget",void 0);var fr={};class pr{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();this.attached[t]?p.Warn("camera input of type "+t+" already exists on camera"):(this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault))}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e)return i.detachControl(),i.camera=null,delete this.attached[t],void this.rebuildInputCheck()}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=!Gt.ForceAttachControlToAlwaysPreventDefault&&e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const e in this.attached){const i=this.attached[e],s=qe.Serialize(i);t[i.getClassName()]=s}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const e in t){const i=fr[e];if(i){const s=t[e],n=qe.Parse((()=>new i),s,null);this.add(n)}}}else for(const t in this.attached){const i=fr[this.attached[t].getClassName()];if(i){const s=qe.Parse((()=>new i),e,null);this.remove(this.attached[t]),this.add(s)}}}}class mr{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=Ot.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let s=0,n=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=r=>{var o,a;const l=r.event,h="touch"===l.pointerType;if(r.type!==ci.POINTERMOVE&&-1===this.buttons.indexOf(l.button))return;const c=l.target;if(this._altKey=l.altKey,this._ctrlKey=l.ctrlKey,this._metaKey=l.metaKey,this._shiftKey=l.shiftKey,this._buttonsPressed=l.buttons,t.isPointerLock){const e=l.movementX,t=l.movementY;this.onTouch(null,e,t),this._pointA=null,this._pointB=null}else{if(r.type!==ci.POINTERDOWN&&h&&(null===(o=this._pointA)||void 0===o?void 0:o.pointerId)!==l.pointerId&&(null===(a=this._pointB)||void 0===a?void 0:a.pointerId)!==l.pointerId)return;if(r.type!==ci.POINTERDOWN||-1!==this._currentActiveButton&&!h)if(r.type===ci.POINTERDOUBLETAP)this.onDoubleTap(l.pointerType);else if(r.type!==ci.POINTERUP||this._currentActiveButton!==l.button&&!h){if(r.type===ci.POINTERMOVE)if(e||l.preventDefault(),this._pointA&&null===this._pointB){const e=l.clientX-this._pointA.x,t=l.clientY-this._pointA.y;this.onTouch(this._pointA,e,t),this._pointA.x=l.clientX,this._pointA.y=l.clientY}else if(this._pointA&&this._pointB){const e=this._pointA.pointerId===l.pointerId?this._pointA:this._pointB;e.x=l.clientX,e.y=l.clientY;const t=this._pointA.x-this._pointB.x,i=this._pointA.y-this._pointB.y,o=t*t+i*i,a={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:l.pointerId,type:r.type};this.onMultiTouch(this._pointA,this._pointB,s,o,n,a),n=a,s=o}}else{try{null==c||c.releasePointerCapture(l.pointerId)}catch(e){}h||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==l.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==l.pointerId?this._pointB=null:this._pointA=this._pointB=null,(0!==s||n)&&(this.onMultiTouch(this._pointA,this._pointB,s,0,n,null),s=0,n=null),this._currentActiveButton=-1,this.onButtonUp(l),e||l.preventDefault()}else{try{null==c||c.setPointerCapture(l.pointerId)}catch(e){}if(null===this._pointA)this._pointA={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType};else{if(null!==this._pointB)return;this._pointB={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType}}-1!==this._currentActiveButton||h||(this._currentActiveButton=l.button),this.onButtonDown(l),e||(l.preventDefault(),i&&i.focus())}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ci.POINTERDOWN|ci.POINTERUP|ci.POINTERMOVE|ci.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,s=0,n=null,this.onLostFocus()},this._contextMenuBind=e=>this.onContextMenu(e),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const r=this.camera.getScene().getEngine().getHostWindow();r&&Ot.RegisterTopRootEvents(r,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&Ot.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,s,n,r){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}De([Ge()],mr.prototype,"buttons",void 0);class gr extends mr{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(0!==this.panningSensibility&&e&&t){const i=t.x-e.x,s=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=s/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||gr.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=.001*(t-e)*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){0!==this.panningSensibility&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,s,n,r){0===i&&null===n||0===s&&null===r||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,s),this._computeMultiTouchPanning(n,r)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(s)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,s),this._isPinching=!0):this._computeMultiTouchPanning(n,r)):this.multiTouchPanning?this._computeMultiTouchPanning(n,r):this.pinchZoom&&this._computePinchZoom(i,s))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}gr.MinimumRadiusForPinch=.001,De([Ge()],gr.prototype,"buttons",void 0),De([Ge()],gr.prototype,"angularSensibilityX",void 0),De([Ge()],gr.prototype,"angularSensibilityY",void 0),De([Ge()],gr.prototype,"pinchPrecision",void 0),De([Ge()],gr.prototype,"pinchDeltaPercentage",void 0),De([Ge()],gr.prototype,"useNaturalPinchZoom",void 0),De([Ge()],gr.prototype,"pinchZoom",void 0),De([Ge()],gr.prototype,"panningSensibility",void 0),De([Ge()],gr.prototype,"multiTouchPanning",void 0),De([Ge()],gr.prototype,"multiTouchPanAndZoom",void 0),fr.ArcRotateCameraPointersInput=gr;class vr{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=Ot.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===pi.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysReset.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),i.preventDefault&&(e||i.preventDefault())}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];-1!==this.keysLeft.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:-1!==this.keysUp.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:-1!==this.keysRight.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:-1!==this.keysDown.indexOf(i)?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:-1!==this.keysReset.indexOf(i)&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}De([Ge()],vr.prototype,"keysUp",void 0),De([Ge()],vr.prototype,"keysDown",void 0),De([Ge()],vr.prototype,"keysLeft",void 0),De([Ge()],vr.prototype,"keysRight",void 0),De([Ge()],vr.prototype,"keysReset",void 0),De([Ge()],vr.prototype,"panningSensibility",void 0),De([Ge()],vr.prototype,"zoomingSensibility",void 0),De([Ge()],vr.prototype,"useAltToZoom",void 0),De([Ge()],vr.prototype,"angularSpeed",void 0),fr.ArcRotateCameraKeyboardMoveInput=vr;class Tr{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new me(0,0,0),this._globalOffset=new me(0,0,0),this._inertialPanning=me.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const s=.01*e*this.wheelDeltaPercentage*t;return i=e>0?s/(1+this.wheelDeltaPercentage):s*(1+this.wheelDeltaPercentage),i}attachControl(e){e=Ot.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==ci.POINTERWHEEL)return;const i=t.event;let s=0;const n=i.deltaMode===vi.DOM_DELTA_LINE?40:1,r=-i.deltaY*n;if(this.customComputeDeltaFromMouseWheel)s=this.customComputeDeltaFromMouseWheel(r,this,i);else if(this.wheelDeltaPercentage){if(s=this._computeDeltaFromMouseWheelLegacyEvent(r,this.camera.radius),s>0){let e=this.camera.radius,t=this.camera.inertialRadiusOffset+s;for(let i=0;i<20&&Math.abs(t)>.001;i++)e-=t,t*=this.camera.inertia;e=ne.Clamp(e,0,Number.MAX_VALUE),s=this._computeDeltaFromMouseWheelLegacyEvent(r,e)}}else s=r/(40*this.wheelPrecision);s&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(s)):this.camera.inertialRadiusOffset+=s),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,ci.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=kt.FromPositionAndNormal(e.target,t)}_getPosition(){var e;const t=this.camera,i=t.getScene(),s=i.createPickingRay(i.pointerX,i.pointerY,Te.Identity(),t,!1);0===t.targetScreenOffset.x&&0===t.targetScreenOffset.y||(this._viewOffset.set(t.targetScreenOffset.x,t.targetScreenOffset.y,0),t.getViewMatrix().invertToRef(t._cameraTransformMatrix),this._globalOffset=me.TransformNormal(this._viewOffset,t._cameraTransformMatrix),s.origin.addInPlace(this._globalOffset));let n=0;return this._hitPlane&&(n=null!==(e=s.intersectsPlane(this._hitPlane))&&void 0!==e?e:0),s.origin.addInPlace(s.direction.scaleInPlace(n))}_zoomToMouse(e){var t,i;const s=this.camera,n=1-s.inertia;if(s.lowerRadiusLimit){const i=null!==(t=s.lowerRadiusLimit)&&void 0!==t?t:0;s.radius-(s.inertialRadiusOffset+e)/n<i&&(e=(s.radius-i)*n-s.inertialRadiusOffset)}if(s.upperRadiusLimit){const t=null!==(i=s.upperRadiusLimit)&&void 0!==i?i:0;s.radius-(s.inertialRadiusOffset+e)/n>t&&(e=(s.radius-t)*n-s.inertialRadiusOffset)}const r=e/n/s.radius,o=this._getPosition(),a=Ee.Vector3[6];o.subtractToRef(s.target,a),a.scaleInPlace(r),a.scaleInPlace(n),this._inertialPanning.addInPlace(a),s.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<ae&&(e.x=0),Math.abs(e.y)<ae&&(e.y=0),Math.abs(e.z)<ae&&(e.z=0)}}De([Ge()],Tr.prototype,"wheelPrecision",void 0),De([Ge()],Tr.prototype,"zoomToMouseLocation",void 0),De([Ge()],Tr.prototype,"wheelDeltaPercentage",void 0),fr.ArcRotateCameraMouseWheelInput=Tr;class br extends pr{constructor(e){super(e)}addMouseWheel(){return this.add(new Tr),this}addPointers(){return this.add(new gr),this}addKeyboard(){return this.add(new vr),this}}et.AddNodeConstructor("ArcRotateCamera",((e,t)=>()=>new Er(e,0,0,1,me.Zero(),t)));class Er extends _r{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new Te,this._upToYMatrix=new Te,this._upVector=me.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){Te.RotationAlignToRef(me.UpReadOnly,this._upVector,this._yToUpMatrix),Te.RotationAlignToRef(this._upVector,me.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return!!e&&e.useNaturalPinchZoom}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return!!e&&e.zoomToMouseLocation}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return null!=this._bouncingBehavior}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new dr,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return null!=this._framingBehavior}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new ur,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return null!=this._autoRotationBehavior}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new $n,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,n,r,o,a=!0){super(e,me.Zero(),o,a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=me.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=pe.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this._viewMatrix=new Te,this.panningAxis=new me(1,1,0),this._transformedDirection=new me,this.mapPanning=!1,this.onMeshTargetChangedObservable=new s,this.checkCollisions=!1,this.collisionRadius=new me(.5,.5,.5),this._previousPosition=me.Zero(),this._collisionVelocity=me.Zero(),this._newPosition=me.Zero(),this._computationVector=me.Zero(),this._onCollisionPositionChange=(e,t,i=null)=>{i?(this.setPosition(t),this.onCollide&&this.onCollide(i)):this._previousPosition.copyFrom(this._position);const s=Math.cos(this.alpha),n=Math.sin(this.alpha),r=Math.cos(this.beta);let o=Math.sin(this.beta);0===o&&(o=1e-4);const a=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*s*o,this.radius*r,this.radius*n*o),a.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let l=this.upVector;this.allowUpsideDown&&this.beta<0&&(l=l.clone(),l=l.negate()),this._computeViewMatrix(this._position,a,l),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=me.Zero(),r&&this.setTarget(r),this.alpha=t,this.beta=i,this.radius=n,this.getViewMatrix(),this.inputs=new br(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=pe.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const e=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?e.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(e)}return this._getLockedTargetPosition()||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0)}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset)}attachControl(e,t,i=!0,s=2){const n=arguments;t=Ot.BackCompatCameraNoPreventDefault(n),this._useCtrlForPanning=i,this._panningMouseButton=s,"boolean"==typeof n[0]&&(n.length>1&&(this._useCtrlForPanning=n[1]),n.length>2&&(this._panningMouseButton=n[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset){const e=this.invertRotation?-1:1,t=this._calculateHandednessMultiplier();let i=this.inertialAlphaOffset*t;this.beta<0&&(i*=-1),this.alpha+=i*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<ae&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<ae&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*ae&&(this.inertialRadiusOffset=0)}if(0!==this.inertialPanningX||0!==this.inertialPanningY){const e=new me(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),me.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){const e=this.upVector,t=me.CrossToRef(this._transformedDirection,e,this._transformedDirection);me.CrossToRef(e,t,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);this._targetHost||(this.panningDistanceLimit?(this._transformedDirection.addInPlace(this._target),me.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)):this._target.addInPlace(this._transformedDirection)),this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*ae&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*ae&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){null===this.lowerBetaLimit||void 0===this.lowerBetaLimit?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),null===this.upperBetaLimit||void 0===this.upperBetaLimit?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),null!==this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),null!==this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),0===this._upVector.x&&1===this._upVector.y&&0===this._upVector.z||me.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),0===this.radius&&(this.radius=1e-4);const e=this.alpha;0===this._computationVector.x&&0===this._computationVector.z?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=2*t*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,s=!1){var n;if(s=null!==(n=this.overrideCloneAlphaBetaRadius)&&void 0!==n?n:s,e.getBoundingInfo)this._targetBoundingCenter=t?e.getBoundingInfo().boundingBox.centerWorld.clone():null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const t=e,s=this._getTargetPosition();if(s&&!i&&s.equals(t))return;this._targetHost=null,this._target=t,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}s||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let s=Math.sin(this.beta);0===s&&(s=1e-4),0===this.radius&&(this.radius=1e-4);const n=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*s,this.radius*i,this.radius*t*s),0===this._upVector.x&&1===this._upVector.y&&0===this._upVector.z||me.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),n.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const e=this.getScene().collisionCoordinator;this._collider||(this._collider=e.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,e.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let e=this.upVector;this.allowUpsideDown&&s<0&&(e=e.negate()),this._computeViewMatrix(this._position,n,e),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=n,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=jn.MinMax(e);let s=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);s=Math.max(Math.min(s,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=s*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:s},t)}focusOn(e,t=!1){let i,s;if(void 0===e.min){const t=e||this.getScene().meshes;i=jn.MinMax(t),s=me.Distance(i.min,i.max)}else i=e,s=e.distance;this._target=jn.Center(i),t||(this.maxZ=2*s)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case Gt.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Gt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Gt.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Gt.RIG_MODE_STEREOSCOPIC_INTERLACED:case Gt.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(0===t?1:-1);break;case Gt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(0===t?-1:1)}const s=new Er(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return s._cameraRigParams={},s.isRigCamera=!0,s.rigParent=this,s.upVector=this.upVector,s.mode=this.mode,s.orthoLeft=this.orthoLeft,s.orthoRight=this.orthoRight,s.orthoBottom=this.orthoBottom,s.orthoTop=this.orthoTop,s}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case Gt.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Gt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Gt.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Gt.RIG_MODE_STEREOSCOPIC_INTERLACED:case Gt.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Gt.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){const s=me.Distance(e,t),n=this.getScene().getEngine().getAspectRatio(this),r=Math.tan(this.fov/2),o=r*n,a=.5*s*i,l=a*Math.sqrt(1+1/(o*o)),h=a*Math.sqrt(1+1/(r*r));return Math.max(l,h)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}De([Ge()],Er.prototype,"alpha",void 0),De([Ge()],Er.prototype,"beta",void 0),De([Ge()],Er.prototype,"radius",void 0),De([Ge()],Er.prototype,"overrideCloneAlphaBetaRadius",void 0),De([Qe("target")],Er.prototype,"_target",void 0),De([Ye("targetHost")],Er.prototype,"_targetHost",void 0),De([Ge()],Er.prototype,"inertialAlphaOffset",void 0),De([Ge()],Er.prototype,"inertialBetaOffset",void 0),De([Ge()],Er.prototype,"inertialRadiusOffset",void 0),De([Ge()],Er.prototype,"lowerAlphaLimit",void 0),De([Ge()],Er.prototype,"upperAlphaLimit",void 0),De([Ge()],Er.prototype,"lowerBetaLimit",void 0),De([Ge()],Er.prototype,"upperBetaLimit",void 0),De([Ge()],Er.prototype,"lowerRadiusLimit",void 0),De([Ge()],Er.prototype,"upperRadiusLimit",void 0),De([Ge()],Er.prototype,"inertialPanningX",void 0),De([Ge()],Er.prototype,"inertialPanningY",void 0),De([Ge()],Er.prototype,"pinchToPanMaxDistance",void 0),De([Ge()],Er.prototype,"panningDistanceLimit",void 0),De([Qe()],Er.prototype,"panningOriginTarget",void 0),De([Ge()],Er.prototype,"panningInertia",void 0),De([Ge()],Er.prototype,"zoomToMouseLocation",null),De([Ge()],Er.prototype,"zoomOnFactor",void 0),De([Xe()],Er.prototype,"targetScreenOffset",void 0),De([Ge()],Er.prototype,"allowUpsideDown",void 0),De([Ge()],Er.prototype,"useInputToRestoreState",void 0);class Sr extends Ji{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,s,n=0,r=zi.BILINEAR_SAMPLINGMODE,o=!0){if(super(e,t,i,s,!0,n,!1,r,o),this.mirrorPlane=new kt(0,1,0,1),this._transformMatrix=Te.Zero(),this._mirrorMatrix=Te.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,!(i=this.getScene()))return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateGammaSpace()}));const a=i.getEngine();let l;a.supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeBindObservable.add((()=>{var t;null===(t=a._debugPushGroup)||void 0===t||t.call(a,`mirror generation for ${e}`,1)})),this.onAfterUnbindObservable.add((()=>{var e;null===(e=a._debugPopGroup)||void 0===e||e.call(a,1)})),this.onBeforeRenderObservable.add((()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),Te.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),l=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=me.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)})),this.onAfterRenderObservable.add((()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=l}))}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new ts("horizontal blur",new pe(1,0),this._blurKernelX,this._blurRatio,null,zi.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,1===this._blurRatio&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new ts("vertical blur",new pe(0,1),this._blurKernelY,this._blurRatio,null,zi.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=1!==this._blurRatio,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Sr(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){var e;super.dispose();const t=this.getScene();t&&t.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),null===(e=this._sceneUBO)||void 0===e||e.dispose()}}zi._CreateMirror=(e,t,i,s)=>new Sr(e,t,i,s),q.prototype._createDepthStencilCubeTexture=function(e,t,i){const s=new a(this,r.DepthStencil);if(s.isCube=!0,1===this.webGLVersion)return p.Error("Depth cube texture is not supported by WebGL 1."),s;const n=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t),o=this._gl;this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,s,!0),this._setupDepthStencilTexture(s,e,n.generateStencil,n.bilinearFiltering,n.comparisonFunction),i._depthStencilTexture=s,i._depthStencilTextureWithStencil=n.generateStencil;for(let t=0;t<6;t++)n.generateStencil?o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,o.DEPTH24_STENCIL8,e,e,0,o.DEPTH_STENCIL,o.UNSIGNED_INT_24_8,null):o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,o.DEPTH_COMPONENT24,e,e,0,o.DEPTH_COMPONENT,o.UNSIGNED_INT,null);return this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(s),s},q.prototype._partialLoadFile=function(e,t,i,s,n=null){this._loadFile(e,(e=>{i[t]=e,i._internalCount++,6===i._internalCount&&s(i)}),void 0,void 0,!0,((e,t)=>{n&&e&&n(e.status+" "+e.statusText,t)}))},q.prototype._cascadeLoadFiles=function(e,t,i,s=null){const n=[];n._internalCount=0;for(let e=0;e<6;e++)this._partialLoadFile(i[e],e,n,t,s)},q.prototype._cascadeLoadImgs=function(e,t,i,s,n=null,r){const o=[];o._internalCount=0;for(let a=0;a<6;a++)this._partialLoadImg(s[a],a,o,e,t,i,n,r)},q.prototype._partialLoadImg=function(e,t,i,s,n,r,o=null,a){const l=Mt();Tt(e,(e=>{i[t]=e,i._internalCount++,s&&s.removePendingData(l),6===i._internalCount&&r&&r(n,i)}),((e,t)=>{s&&s.removePendingData(l),o&&o(e,t)}),s?s.offlineProvider:null,a),s&&s.addPendingData(l)},q.prototype._setCubeMapTextureParams=function(e,t,i){const s=this._gl;s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,t?s.LINEAR_MIPMAP_LINEAR:s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),e.samplingMode=t?3:2,t&&this.getCaps().textureMaxLevel&&void 0!==i&&i>0&&(s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAX_LEVEL,i),e._maxLodLevel=i),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null)},q.prototype.createCubeTextureBase=function(e,t,i,s,n=null,o=null,l,h=null,c=!1,d=0,u=0,_=null,f=null,m=null,g=!1){const v=_||new a(this,r.Cube);v.isCube=!0,v.url=e,v.generateMipMaps=!s,v._lodGenerationScale=d,v._lodGenerationOffset=u,v._useSRGBBuffer=!!g&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!s),v!==_&&(v.label=e.substring(0,60)),this._doNotHandleContextLost||(v._extension=h,v._files=i);const T=e;this._transformTextureUrl&&!_&&(e=this._transformTextureUrl(e));const b=e.split("?")[0],E=b.lastIndexOf("."),S=h||(E>-1?b.substring(E).toLowerCase():"");let x=null;for(const e of q._TextureLoaders)if(e.canLoad(S)){x=e;break}const C=(r,a)=>{e===T?o&&r&&o(r.status+" "+r.statusText,a):(p.Warn(`Failed to load ${e}, falling back to the ${T}`),this.createCubeTextureBase(T,t,i,!!s,n,o,l,h,c,d,u,v,f,m,g))};if(x){const s=e=>{f&&f(v,e),x.loadCubeData(e,v,c,n,o)};i&&6===i.length?x.supportCascades?this._cascadeLoadFiles(t,(e=>s(e.map((e=>new Uint8Array(e))))),i,o):o?o("Textures type does not support cascades."):p.Warn("Texture loader does not support cascades."):this._loadFile(e,(e=>s(new Uint8Array(e))),void 0,void 0,!0,C)}else{if(!i||0===i.length)throw new Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(t,v,((e,t)=>{m&&m(e,t)}),i,o)}return this._internalTexturesCache.push(v),v},q.prototype.createCubeTexture=function(e,t,i,s,n=null,r=null,o,a=null,l=!1,h=0,c=0,d=null,u,_=!1){const f=this._gl;return this.createCubeTextureBase(e,t,i,!!s,n,r,o,a,l,h,c,d,(e=>this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,e,!0)),((e,t)=>{const i=this.needPOTTextures?q.GetExponentOfTwo(t[0].width,this._caps.maxCubemapTextureSize):t[0].width,r=i,a=[f.TEXTURE_CUBE_MAP_POSITIVE_X,f.TEXTURE_CUBE_MAP_POSITIVE_Y,f.TEXTURE_CUBE_MAP_POSITIVE_Z,f.TEXTURE_CUBE_MAP_NEGATIVE_X,f.TEXTURE_CUBE_MAP_NEGATIVE_Y,f.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(!1);const l=o?this._getInternalFormat(o,e._useSRGBBuffer):e._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:f.RGBA;let h=o?this._getInternalFormat(o):f.RGBA;e._useSRGBBuffer&&1===this.webGLVersion&&(h=l);for(let e=0;e<a.length;e++)if(t[e].width!==i||t[e].height!==r){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void p.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=i,this._workingCanvas.height=r,this._workingContext.drawImage(t[e],0,0,t[e].width,t[e].height,0,0,i,r),f.texImage2D(a[e],0,l,h,f.UNSIGNED_BYTE,this._workingCanvas)}else f.texImage2D(a[e],0,l,h,f.UNSIGNED_BYTE,t[e]);s||f.generateMipmap(f.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(e,!s),e.width=i,e.height=r,e.isReady=!0,o&&(e.format=o),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),n&&n()}),!!_)};class xr extends ki{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(Te.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let s="";return e.forEach((e=>s+=e)),new xr(s,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,s=!0){const n=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const r=new xr(e,t,null,!1,null,null,null,void 0,!0,i,s);return t.useDelayedTextureLoading=n,r}constructor(e,t,i=null,n=!1,r=null,o=null,a=null,l=5,h=!1,c=null,d=!1,u=.8,_=0,f,p){var m;super(t),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new s,this.boundingBoxPosition=me.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new Te,this.name=e,this.url=e,this._noMipmap=n,this.hasAlpha=!1,this._format=l,this.isCube=!0,this._textureMatrix=Te.Identity(),this._createPolynomials=d,this.coordinatesMode=zi.CUBIC_MODE,this._extensions=i,this._files=r,this._forcedExtension=c,this._loaderOptions=f,this._useSRGBBuffer=p,this._lodScale=u,this._lodOffset=_,(e||r)&&this.updateURL(e,c,o,h,a,i,null===(m=this.getScene())||void 0===m?void 0:m.useDelayedTextureLoading,r)}getClassName(){return"CubeTexture"}updateURL(e,t,i=null,s=!1,n=null,r=null,o=!1,a=null){this.name&&!this.name.startsWith("data:")||(this.name=e),this.url=e,t&&(this._forcedExtension=t);const l=e.lastIndexOf("."),h=t||(l>-1?e.substring(l).toLowerCase():""),c=0===h.indexOf(".dds"),d=0===h.indexOf(".env"),u=0===h.indexOf(".basis");if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=s,s&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),a)this._files=a;else if(u||d||c||r||(r=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,r){for(let t=0;t<r.length;t++)this._files.push(e+r[t]);this._extensions=r}o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=n):this._loadTexture(i,n)}delayLoad(e){4===this.delayLoadState&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t,i;if(e.updateFlag===this._textureMatrix.updateFlag)return;if(e.isIdentity()!==this._textureMatrix.isIdentity()&&(null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1,(e=>-1!==e.getActiveTextures().indexOf(this)))),this._textureMatrix=e,!(null===(i=this.getScene())||void 0===i?void 0:i.useRightHandedSystem))return;const s=Ee.Vector3[0],n=Ee.Quaternion[0],r=Ee.Vector3[1];this._textureMatrix.decompose(s,n,r),n.z*=-1,n.w*=-1,Te.ComposeToRef(s,n,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){var e;return(null===(e=this.getScene())||void 0===e?void 0:e.useRightHandedSystem)?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){var i;const s=this.getScene(),n=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const r=()=>{var t;this.onLoadObservable.notifyObservers(this),n&&(n.dispose(),null===(t=this.getScene())||void 0===t||t.markAllMaterialsAsDirty(1)),e&&e()},o=(e,i)=>{this._loadingError=!0,this._errorObject={message:e,exception:i},t&&t(e,i),zi.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?Ot.SetImmediate((()=>r())):this._texture.onLoadedObservable.add((()=>r())):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,s,this._lodScale,this._lodOffset,e,o,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,s,this._files,this._noMipmap,e,o,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),null===(i=this._texture)||void 0===i||i.onLoadedObservable.add((()=>this.onLoadObservable.notifyObservers(this))))}static Parse(e,t,i){const s=qe.Parse((()=>{var s;let n=!1;return e.prefiltered&&(n=e.prefiltered),new xr(i+(null!==(s=e.url)&&void 0!==s?s:e.name),t,e.extensions,!1,e.files||null,null,null,void 0,n,e.forcedExtension)}),e,t);if(e.boundingBoxPosition&&(s.boundingBoxPosition=me.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(s.boundingBoxSize=me.FromArray(e.boundingBoxSize)),e.animations)for(let t=0;t<e.animations.length;t++){const i=e.animations[t],n=_e("BABYLON.Animation");n&&s.animations.push(n.Parse(i))}return s}clone(){let e=0;const t=qe.Clone((()=>{const t=new xr(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=t.uniqueId,t}),this);return t.uniqueId=e,t}}De([Ge()],xr.prototype,"url",void 0),De([Qe()],xr.prototype,"boundingBoxPosition",void 0),De([Qe()],xr.prototype,"boundingBoxSize",null),De([Ge("rotationY")],xr.prototype,"rotationY",null),De([Ge("files")],xr.prototype,"_files",void 0),De([Ge("forcedExtension")],xr.prototype,"_forcedExtension",void 0),De([Ge("extensions")],xr.prototype,"_extensions",void 0),De([$e("textureMatrix")],xr.prototype,"_textureMatrix",void 0),De([$e("textureMatrixRefraction")],xr.prototype,"_textureMatrixRefraction",void 0),zi._CubeTextureParser=xr.Parse,ue("BABYLON.CubeTexture",xr);F.IncludesShadersStore.backgroundFragmentDeclaration="uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nuniform vec4 vPrimaryColorShadow;\n#endif\nuniform float shadowLevel;uniform float alpha;\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;\n#endif\n#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)\nuniform vec3 vBackgroundCenter;\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 vReflectionControl;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef PROJECTED_GROUND\nuniform vec2 projectedGroundInfos;\n#endif\n";F.IncludesShadersStore.backgroundUboDeclaration="layout(std140,column_major) uniform;uniform Material\n{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform vec2 vReflectionInfos;uniform mat4 diffuseMatrix;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;};\n#include<sceneUboDeclaration>\n";F.ShadersStore.backgroundPixelShader="#ifdef TEXTURELODSUPPORT\n#extension GL_EXT_shader_texture_lod : enable\n#endif\nprecision highp float;\n#include<__decl__backgroundFragment>\n#include<helperFunctions>\nvarying vec3 vPositionW;\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif \n#ifdef MAINUV2 \nvarying vec2 vMainUV2; \n#endif \n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV==1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV==2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef TEXTURELODSUPPORT\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE;\n#endif\n#ifndef SHADOWONLY\n#define SHADOWONLY;\n#endif\n#include<imageProcessingDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<imageProcessingFunctions>\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<logDepthDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<fogFragmentDeclaration>\n#ifdef REFLECTIONFRESNEL\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\nvec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}\n#endif\n#ifdef PROJECTED_GROUND\nfloat diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }\nvec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}\nfloat sphereIntersect(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return -1.0; }\nh=sqrt(h);return-b+h;}\nvec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersect(eyePosition,camDir,radius);vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersect(eyePosition,p,radius);vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(0.0,1.0,0.0);\n#endif\nfloat shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;\n#include<lightFragment>[0..maxSimultaneousLights]\n#ifdef SHADOWINUSE\nglobalShadow/=shadowLightCount;\n#else\nglobalShadow=1.0;\n#endif\n#ifndef BACKMAT_SHADOWONLY\nvec4 reflectionColor=vec4(1.,1.,1.,1.);\n#ifdef REFLECTION\n#ifdef PROJECTED_GROUND\nvec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=reflectionVector;\n#else\nvec2 reflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n#ifdef REFLECTIONBLUR\nfloat reflectionLOD=vReflectionInfos.y;\n#ifdef TEXTURELODSUPPORT\nreflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nreflectionSpecularMid,\nlodReflectionNormalizedDoubled\n);} else {reflectionColor=mix(\nreflectionSpecularMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);}\n#endif\n#else\nvec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;\n#endif\n#ifdef RGBDREFLECTION\nreflectionColor.rgb=fromRGBD(reflectionColor);\n#endif\n#ifdef GAMMAREFLECTION\nreflectionColor.rgb=toLinearSpace(reflectionColor.rgb);\n#endif\n#ifdef REFLECTIONBGR\nreflectionColor.rgb=reflectionColor.bgr;\n#endif\nreflectionColor.rgb*=vReflectionInfos.x;\n#endif\nvec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;\n#ifdef DIFFUSE\nvec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);\n#ifdef GAMMADIFFUSE\ndiffuseMap.rgb=toLinearSpace(diffuseMap.rgb);\n#endif\ndiffuseMap.rgb*=vDiffuseInfos.y;\n#ifdef DIFFUSEHASALPHA\nfinalAlpha*=diffuseMap.a;\n#endif\ndiffuseColor=diffuseMap.rgb;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 colorBase=diffuseColor;\n#else\nvec3 colorBase=reflectionColor.rgb*diffuseColor;\n#endif\ncolorBase=max(colorBase,0.0);\n#ifdef USERGBCOLOR\nvec3 finalColor=colorBase;\n#else\n#ifdef USEHIGHLIGHTANDSHADOWCOLORS\nvec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);\n#else\nvec3 mainColor=vPrimaryColor.rgb;\n#endif\nvec3 finalColor=colorBase*mainColor;\n#endif\n#ifdef REFLECTIONFRESNEL\nvec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;\n#ifdef REFLECTIONFALLOFF\nfloat reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;\n#endif\nfinalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));\n#endif\n#ifdef OPACITYFRESNEL\nfloat viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;\n#endif\n#ifdef SHADOWINUSE\nfinalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);\n#endif\nvec4 color=vec4(finalColor,finalAlpha);\n#else\nvec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef IMAGEPROCESSINGPOSTPROCESS\n#if !defined(SKIPFINALCOLORCLAMP)\ncolor.rgb=clamp(color.rgb,0.,30.0);\n#endif\n#else\ncolor=applyImageProcessing(color);\n#endif\n#ifdef PREMULTIPLYALPHA\ncolor.rgb*=color.a;\n#endif\n#ifdef NOISE\ncolor.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);\n#endif\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";F.IncludesShadersStore.backgroundVertexDeclaration="uniform mat4 view;uniform mat4 viewProjection;uniform float shadowLevel;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;\n#endif\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n";F.ShadersStore.backgroundVertexShader="precision highp float;\n#include<__decl__backgroundVertex>\n#include<helperFunctions>\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nvarying vec2 vDiffuseUV;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightVxFragment>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}\n#else\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#endif\nvec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normal);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#ifdef EQUIRECTANGULAR_RELFECTION_FOV\nmat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}\n#endif\n#endif\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0\nif (vDiffuseInfos.x==0.)\n{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}\nelse\n{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n";class Cr extends Wt{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class yr extends Ms{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t*=2,this.reflectionReflectance0=yr.StandardReflectance0*t,this.reflectionReflectance90=yr.StandardReflectance90*t):(t=2*t-1,this.reflectionReflectance0=yr.StandardReflectance0+(1-yr.StandardReflectance0)*t,this.reflectionReflectance90=yr.StandardReflectance90+(1-yr.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()}))))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.primaryColor=Re.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=me.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new wt(16),this._reflectionControls=ge.Zero(),this._white=Re.White(),this._primaryShadowColor=Re.Black(),this._primaryHighlightColor=Re.Black(),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!(!this._diffuseTexture||!this._diffuseTexture.isRenderTarget)||!(!this._reflectionTexture||!this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new Cr);const s=this.getScene(),n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const r=s.getEngine();if(wi.PrepareDefinesForLights(s,e,n,!1,this._maxSimultaneousLights),n._needNormals=!0,wi.PrepareDefinesForMultiview(s,n),n._areTexturesDirty){if(n._needUVs=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(n.TEXTURELODSUPPORT=!0),this._diffuseTexture&&Os.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;wi.PrepareDefinesForMergedUV(this._diffuseTexture,n,"DIFFUSE"),n.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,n.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,n.OPACITYFRESNEL=this._opacityFresnel}else n.DIFFUSE=!1,n.DIFFUSEDIRECTUV=0,n.DIFFUSEHASALPHA=!1,n.GAMMADIFFUSE=!1,n.OPACITYFRESNEL=!1;const e=this._reflectionTexture;if(e&&Os.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;switch(n.REFLECTION=!0,n.GAMMAREFLECTION=e.gammaSpace,n.RGBDREFLECTION=e.isRGBD,n.REFLECTIONBLUR=this._reflectionBlur>0,n.LODINREFLECTIONALPHA=e.lodLevelInAlpha,n.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,n.REFLECTIONBGR=this.switchToBGR,e.coordinatesMode===zi.INVCUBIC_MODE&&(n.INVERTCUBICMAP=!0),n.REFLECTIONMAP_3D=e.isCube,n.REFLECTIONMAP_OPPOSITEZ=n.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,e.coordinatesMode){case zi.EXPLICIT_MODE:n.REFLECTIONMAP_EXPLICIT=!0;break;case zi.PLANAR_MODE:n.REFLECTIONMAP_PLANAR=!0;break;case zi.PROJECTION_MODE:n.REFLECTIONMAP_PROJECTION=!0;break;case zi.SKYBOX_MODE:n.REFLECTIONMAP_SKYBOX=!0;break;case zi.SPHERICAL_MODE:n.REFLECTIONMAP_SPHERICAL=!0;break;case zi.EQUIRECTANGULAR_MODE:n.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case zi.FIXED_EQUIRECTANGULAR_MODE:n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case zi.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case zi.CUBIC_MODE:case zi.INVCUBIC_MODE:default:n.REFLECTIONMAP_CUBIC=!0}this.reflectionFresnel?(n.REFLECTIONFRESNEL=!0,n.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(n.REFLECTIONFRESNEL=!1,n.REFLECTIONFALLOFF=!1)}else n.REFLECTION=!1,n.REFLECTIONFRESNEL=!1,n.REFLECTIONFALLOFF=!1,n.REFLECTIONBLUR=!1,n.REFLECTIONMAP_3D=!1,n.REFLECTIONMAP_SPHERICAL=!1,n.REFLECTIONMAP_PLANAR=!1,n.REFLECTIONMAP_CUBIC=!1,n.REFLECTIONMAP_PROJECTION=!1,n.REFLECTIONMAP_SKYBOX=!1,n.REFLECTIONMAP_EXPLICIT=!1,n.REFLECTIONMAP_EQUIRECTANGULAR=!1,n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,n.INVERTCUBICMAP=!1,n.REFLECTIONMAP_OPPOSITEZ=!1,n.LODINREFLECTIONALPHA=!1,n.GAMMAREFLECTION=!1,n.RGBDREFLECTION=!1}n.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,n.USERGBCOLOR=this._useRGBColor,n.NOISE=this._enableNoise}if(n._areLightsDirty&&(n.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel),n.BACKMAT_SHADOWONLY=this._shadowOnly),n._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(n)}if(n._areMiscDirty&&(n.REFLECTIONMAP_3D&&this._enableGroundProjection?(n.PROJECTED_GROUND=!0,n.REFLECTIONMAP_SKYBOX=!0):n.PROJECTED_GROUND=!1),wi.PrepareDefinesForMisc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),n),wi.PrepareDefinesForFrameBoundValues(s,r,this,n,i,null,t.getRenderingMesh().hasThinInstances),wi.PrepareDefinesForAttributes(e,n,!1,!0,!1)&&e&&(s.getEngine().getCaps().standardDerivatives||e.isVerticesDataPresent(Oe.NormalKind)||(e.createNormals(!0),p.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name))),n.isDirty){n.markAsProcessed(),s.resetCachedMaterial();const i=new is;n.FOG&&i.addFallback(0,"FOG"),n.POINTSIZE&&i.addFallback(1,"POINTSIZE"),n.MULTIVIEW&&i.addFallback(0,"MULTIVIEW"),wi.HandleFallbacksForShadows(n,i,this._maxSimultaneousLights);const o=[Oe.PositionKind];n.NORMAL&&o.push(Oe.NormalKind),n.UV1&&o.push(Oe.UVKind),n.UV2&&o.push(Oe.UV2Kind),wi.PrepareAttributesForBones(o,e,n,i),wi.PrepareAttributesForInstances(o,n);const a=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];Di(a);const l=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],h=["Material","Scene"];Yt&&(Yt.PrepareUniforms(a,n),Yt.PrepareSamplers(l,n)),wi.PrepareUniformsAndSamplersList({uniformsNames:a,uniformBuffersNames:h,samplers:l,defines:n,maxSimultaneousLights:this._maxSimultaneousLights});const c=n.toString(),d=s.getEngine().createEffect("background",{attributes:o,uniformsNames:a,uniformBuffersNames:h,samplers:l,defines:c,fallbacks:i,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},r);t.setEffect(d,n,this._materialContext),this.buildUniformLayout()}return!(!t.effect||!t.effect.isReady()||(n._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){0===this._primaryColorShadowLevel&&0===this._primaryColorHighlightLevel||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const s=this.getScene(),n=i.materialDefines;if(!n)return;const r=i.effect;if(!r)return;this._activeEffect=r,this.bindOnlyWorldMatrix(e),wi.BindBonesParameters(t,this._activeEffect);const o=this._mustRebind(s,r,t.visibility);if(o){this._uniformBuffer.bindToEffect(r,"Material"),this.bindViewProjection(r);const e=this._reflectionTexture;this._uniformBuffer.useUbo&&this.isFrozen&&this._uniformBuffer.isSync||(s.texturesEnabled&&(this._diffuseTexture&&Os.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),wi.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),e&&Os.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",e.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",e.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",e.getSize().width,e.lodGenerationScale,e.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),n.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),s.texturesEnabled&&(this._diffuseTexture&&Os.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),e&&Os.ReflectionTextureEnabled&&(n.REFLECTIONBLUR&&n.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",e):n.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",e._lodTextureMid||e),this._uniformBuffer.setTexture("reflectionSamplerLow",e._lodTextureLow||e),this._uniformBuffer.setTexture("reflectionSamplerHigh",e._lodTextureHigh||e)):this._uniformBuffer.setTexture("reflectionSampler",e),n.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),n.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),Fi(this._activeEffect,this,s),s.bindEyePosition(r)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(r,"Material"),this._needToBindSceneUbo=!0);!o&&this.isFrozen||(s.lightsEnabled&&wi.BindLights(s,t,this._activeEffect,n,this._maxSimultaneousLights),this.bindView(r),wi.BindFogParameters(s,t,this._activeEffect,!0),this._useLogarithmicDepth&&wi.BindLogDepth(n,r,s),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),this._uniformBuffer.update()}hasTexture(e){return!!super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return qe.Clone((()=>new yr(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return qe.Parse((()=>new yr(e.name,t)),e,t,i)}}function Ar(e){const t=[],i=[],s=[],n=[],r=e.width||e.size||1,o=e.height||e.size||1,a=0===e.sideOrientation?0:e.sideOrientation||Nn.DEFAULTSIDE,l=r/2,h=o/2;i.push(-l,-h,0),s.push(0,0,-1),n.push(0,Gi.UseOpenGLOrientationForUV?1:0),i.push(l,-h,0),s.push(0,0,-1),n.push(1,Gi.UseOpenGLOrientationForUV?1:0),i.push(l,h,0),s.push(0,0,-1),n.push(1,Gi.UseOpenGLOrientationForUV?0:1),i.push(-l,h,0),s.push(0,0,-1),n.push(0,Gi.UseOpenGLOrientationForUV?0:1),t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),Nn._ComputeSides(a,i,t,s,n,e.frontUVs,e.backUVs);const c=new Nn;return c.indices=t,c.positions=i,c.normals=s,c.uvs=n,c}function Rr(e,t={},i=null){const s=new jn(e,i);return t.sideOrientation=jn._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Ar(t).applyToMesh(s,t.updatable),t.sourcePlane&&(s.translate(t.sourcePlane.normal,-t.sourcePlane.d),s.setDirection(t.sourcePlane.normal.scale(-1))),s}yr.StandardReflectance0=.05,yr.StandardReflectance90=.5,De([He()],yr.prototype,"_primaryColor",void 0),De([Ve("_markAllSubMeshesAsLightsDirty")],yr.prototype,"primaryColor",void 0),De([He()],yr.prototype,"__perceptualColor",void 0),De([Ge()],yr.prototype,"_primaryColorShadowLevel",void 0),De([Ge()],yr.prototype,"_primaryColorHighlightLevel",void 0),De([Ve("_markAllSubMeshesAsLightsDirty")],yr.prototype,"primaryColorHighlightLevel",null),De([ze()],yr.prototype,"_reflectionTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"reflectionTexture",void 0),De([Ge()],yr.prototype,"_reflectionBlur",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"reflectionBlur",void 0),De([ze()],yr.prototype,"_diffuseTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"diffuseTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"shadowLights",void 0),De([Ge()],yr.prototype,"_shadowLevel",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"shadowLevel",void 0),De([Qe()],yr.prototype,"_sceneCenter",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"sceneCenter",void 0),De([Ge()],yr.prototype,"_opacityFresnel",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"opacityFresnel",void 0),De([Ge()],yr.prototype,"_reflectionFresnel",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"reflectionFresnel",void 0),De([Ge()],yr.prototype,"_reflectionFalloffDistance",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"reflectionFalloffDistance",void 0),De([Ge()],yr.prototype,"_reflectionAmount",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"reflectionAmount",void 0),De([Ge()],yr.prototype,"_reflectionReflectance0",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"reflectionReflectance0",void 0),De([Ge()],yr.prototype,"_reflectionReflectance90",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"reflectionReflectance90",void 0),De([Ge()],yr.prototype,"_useRGBColor",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"useRGBColor",void 0),De([Ge()],yr.prototype,"_enableNoise",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"enableNoise",void 0),De([Ge()],yr.prototype,"_maxSimultaneousLights",void 0),De([Ve("_markAllSubMeshesAsTexturesDirty")],yr.prototype,"maxSimultaneousLights",void 0),De([Ge()],yr.prototype,"_shadowOnly",void 0),De([Ve("_markAllSubMeshesAsLightsDirty")],yr.prototype,"shadowOnly",void 0),De([je()],yr.prototype,"_imageProcessingConfiguration",void 0),De([Ge(),Ve("_markAllSubMeshesAsMiscDirty")],yr.prototype,"enableGroundProjection",void 0),De([Ge()],yr.prototype,"projectedGroundRadius",void 0),De([Ge()],yr.prototype,"projectedGroundHeight",void 0),ue("BABYLON.BackgroundMaterial",yr),Nn.CreatePlane=Ar,jn.CreatePlane=(e,t,i,s,n)=>Rr(e,{size:t,width:t,height:t,sideOrientation:n,updatable:s},i),jn._GroundMeshParser=(e,t)=>Ir.Parse(e,t);class Ir extends jn{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);this.createOrUpdateSubmeshesOctree&&this.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),s=Ee.Matrix[5];i.invertToRef(s);const n=Ee.Vector3[8];if(me.TransformCoordinatesFromFloatsToRef(e,0,t,s,n),e=n.x,t=n.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());const r=this._getFacetAt(e,t),o=-(r.x*e+r.z*t+r.w)/r.y;return me.TransformCoordinatesFromFloatsToRef(0,o,0,i,n),n.y}getNormalAtCoordinates(e,t){const i=new me(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const s=this.getWorldMatrix(),n=Ee.Matrix[5];s.invertToRef(n);const r=Ee.Vector3[8];if(me.TransformCoordinatesFromFloatsToRef(e,0,t,n,r),e=r.x,t=r.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());const o=this._getFacetAt(e,t);return me.TransformNormalFromFloatsToRef(o.x,o.y,o.z,s,i),this}updateCoordinateHeights(){return this._heightQuads&&0!=this._heightQuads.length||this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),s=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),n=this._heightQuads[s*this._subdivisionsX+i];let r;return r=t<n.slope.x*e+n.slope.y?n.facet1:n.facet2,r}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s={slope:pe.Zero(),facet1:new ge(0,0,0,0),facet2:new ge(0,0,0,0)};this._heightQuads[i*e+t]=s}return this}_computeHeightQuads(){const e=this.getVerticesData(Oe.PositionKind);if(!e)return this;const t=Ee.Vector3[3],i=Ee.Vector3[2],s=Ee.Vector3[1],n=Ee.Vector3[0],r=Ee.Vector3[4],o=Ee.Vector3[5],a=Ee.Vector3[6],l=Ee.Vector3[7],h=Ee.Vector3[8];let c=0,d=0,u=0,_=0,f=0,p=0,m=0;const g=this._subdivisionsX,v=this._subdivisionsY;for(let T=0;T<v;T++)for(let v=0;v<g;v++){c=3*v,d=T*(g+1)*3,u=(T+1)*(g+1)*3,t.x=e[d+c],t.y=e[d+c+1],t.z=e[d+c+2],i.x=e[d+c+3],i.y=e[d+c+4],i.z=e[d+c+5],s.x=e[u+c],s.y=e[u+c+1],s.z=e[u+c+2],n.x=e[u+c+3],n.y=e[u+c+4],n.z=e[u+c+5],_=(n.z-t.z)/(n.x-t.x),f=t.z-_*t.x,i.subtractToRef(t,r),s.subtractToRef(t,o),n.subtractToRef(t,a),me.CrossToRef(a,o,l),me.CrossToRef(r,a,h),l.normalize(),h.normalize(),p=-(l.x*t.x+l.y*t.y+l.z*t.z),m=-(h.x*i.x+h.y*i.y+h.z*i.z);const b=this._heightQuads[T*g+v];b.slope.copyFromFloats(_,f),b.facet1.copyFromFloats(l.x,l.y,l.z,p),b.facet2.copyFromFloats(h.x,h.y,h.z,m)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new Ir(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function Pr(e){const t=[],i=[],s=[],n=[];let r,o;const a=e.width||1,l=e.height||1,h=0|(e.subdivisionsX||e.subdivisions||1),c=0|(e.subdivisionsY||e.subdivisions||1);for(r=0;r<=c;r++)for(o=0;o<=h;o++){const e=new me(o*a/h-a/2,0,(c-r)*l/c-l/2),t=new me(0,1,0);i.push(e.x,e.y,e.z),s.push(t.x,t.y,t.z),n.push(o/h,Gi.UseOpenGLOrientationForUV?r/c:1-r/c)}for(r=0;r<c;r++)for(o=0;o<h;o++)t.push(o+1+(r+1)*(h+1)),t.push(o+1+r*(h+1)),t.push(o+r*(h+1)),t.push(o+(r+1)*(h+1)),t.push(o+1+(r+1)*(h+1)),t.push(o+r*(h+1));const d=new Nn;return d.indices=t,d.positions=i,d.normals=s,d.uvs=n,d}function Mr(e){const t=void 0!==e.xmin&&null!==e.xmin?e.xmin:-1,i=void 0!==e.zmin&&null!==e.zmin?e.zmin:-1,s=void 0!==e.xmax&&null!==e.xmax?e.xmax:1,n=void 0!==e.zmax&&null!==e.zmax?e.zmax:1,r=e.subdivisions||{w:1,h:1},o=e.precision||{w:1,h:1},a=[],l=[],h=[],c=[];let d,u,_,f;r.h=r.h<1?1:r.h,r.w=r.w<1?1:r.w,o.w=o.w<1?1:o.w,o.h=o.h<1?1:o.h;const p=(s-t)/r.w,m=(n-i)/r.h;function g(e,t,i,s){const n=l.length/3,r=o.w+1;for(d=0;d<o.h;d++)for(u=0;u<o.w;u++){const e=[n+u+d*r,n+(u+1)+d*r,n+(u+1)+(d+1)*r,n+u+(d+1)*r];a.push(e[1]),a.push(e[2]),a.push(e[3]),a.push(e[0]),a.push(e[1]),a.push(e[3])}const _=me.Zero(),f=new me(0,1,0);for(d=0;d<=o.h;d++)for(_.z=d*(s-t)/o.h+t,u=0;u<=o.w;u++)_.x=u*(i-e)/o.w+e,_.y=0,l.push(_.x,_.y,_.z),h.push(f.x,f.y,f.z),c.push(u/o.w,d/o.h)}for(_=0;_<r.h;_++)for(f=0;f<r.w;f++)g(t+f*p,i+_*m,t+(f+1)*p,i+(_+1)*m);const v=new Nn;return v.indices=a,v.positions=l,v.normals=h,v.uvs=c,v}function Or(e){const t=[],i=[],s=[],n=[];let r,o;const a=e.colorFilter||new Re(.3,.59,.11),l=e.alphaFilter||0;let h=!1;if(e.minHeight>e.maxHeight){h=!0;const t=e.maxHeight;e.maxHeight=e.minHeight,e.minHeight=t}for(r=0;r<=e.subdivisions;r++)for(o=0;o<=e.subdivisions;o++){const t=new me(o*e.width/e.subdivisions-e.width/2,0,(e.subdivisions-r)*e.height/e.subdivisions-e.height/2),c=4*(((t.x+e.width/2)/e.width*(e.bufferWidth-1)|0)+((1-(t.z+e.height/2)/e.height)*(e.bufferHeight-1)|0)*e.bufferWidth);let d=e.buffer[c]/255,u=e.buffer[c+1]/255,_=e.buffer[c+2]/255;const f=e.buffer[c+3]/255;h&&(d=1-d,u=1-u,_=1-_);const p=d*a.r+u*a.g+_*a.b;t.y=f>=l?e.minHeight+(e.maxHeight-e.minHeight)*p:e.minHeight-ae,i.push(t.x,t.y,t.z),s.push(0,0,0),n.push(o/e.subdivisions,1-r/e.subdivisions)}for(r=0;r<e.subdivisions;r++)for(o=0;o<e.subdivisions;o++){const s=o+1+(r+1)*(e.subdivisions+1),n=o+1+r*(e.subdivisions+1),a=o+r*(e.subdivisions+1),l=o+(r+1)*(e.subdivisions+1),h=i[3*s+1]>=e.minHeight,c=i[3*n+1]>=e.minHeight,d=i[3*a+1]>=e.minHeight;h&&c&&d&&(t.push(s),t.push(n),t.push(a)),i[3*l+1]>=e.minHeight&&h&&d&&(t.push(l),t.push(s),t.push(a))}Nn.ComputeNormals(i,t,s);const c=new Nn;return c.indices=t,c.positions=i,c.normals=s,c.uvs=n,c}function Dr(e,t={},i){const s=new Ir(e,i);return s._setReady(!1),s._subdivisionsX=t.subdivisionsX||t.subdivisions||1,s._subdivisionsY=t.subdivisionsY||t.subdivisions||1,s._width=t.width||1,s._height=t.height||1,s._maxX=s._width/2,s._maxZ=s._height/2,s._minX=-s._maxX,s._minZ=-s._maxZ,Pr(t).applyToMesh(s,t.updatable),s._setReady(!0),s}function Nr(e){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],s=[];let n=[];const r=e.width||e.size||1,o=e.height||e.size||1,a=e.depth||e.size||1,l=e.wrap||!1;let h=void 0===e.topBaseAt?1:e.topBaseAt,c=void 0===e.bottomBaseAt?0:e.bottomBaseAt;h=(h+4)%4,c=(c+4)%4;let d=[2,0,3,1][h],u=[2,0,1,3][c],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(l){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let e=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],i=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const s=[17,18,19,16],n=[22,23,20,21];for(;d>0;)e.unshift(e.pop()),s.unshift(s.pop()),d--;for(;u>0;)i.unshift(i.pop()),n.unshift(n.pop()),u--;e=e.flat(),i=i.flat(),_=_.concat(e).concat(i),t.push(s[0],s[2],s[3],s[0],s[1],s[2]),t.push(n[0],n[2],n[3],n[0],n[1],n[2])}const f=[r/2,o/2,a/2];n=_.reduce(((e,t,i)=>e.concat(t*f[i%3])),[]);const p=0===e.sideOrientation?0:e.sideOrientation||Nn.DEFAULTSIDE,m=e.faceUV||new Array(6),g=e.faceColors,v=[];for(let e=0;e<6;e++)void 0===m[e]&&(m[e]=new ge(0,0,1,1)),g&&void 0===g[e]&&(g[e]=new Ie(1,1,1,1));for(let e=0;e<6;e++)if(s.push(m[e].z,Gi.UseOpenGLOrientationForUV?1-m[e].w:m[e].w),s.push(m[e].x,Gi.UseOpenGLOrientationForUV?1-m[e].w:m[e].w),s.push(m[e].x,Gi.UseOpenGLOrientationForUV?1-m[e].y:m[e].y),s.push(m[e].z,Gi.UseOpenGLOrientationForUV?1-m[e].y:m[e].y),g)for(let t=0;t<4;t++)v.push(g[e].r,g[e].g,g[e].b,g[e].a);Nn._ComputeSides(p,n,t,i,s,e.frontUVs,e.backUVs);const T=new Nn;if(T.indices=t,T.positions=n,T.normals=i,T.uvs=s,g){const e=p===Nn.DOUBLESIDE?v.concat(v):v;T.colors=e}return T}function Fr(e,t={},i=null){const s=new jn(e,i);return t.sideOrientation=jn._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Nr(t).applyToMesh(s,t.updatable),s}Nn.CreateGround=Pr,Nn.CreateTiledGround=Mr,Nn.CreateGroundFromHeightMap=Or,jn.CreateGround=(e,t,i,s,n,r)=>Dr(e,{width:t,height:i,subdivisions:s,updatable:r},n),jn.CreateTiledGround=(e,t,i,s,n,r,o,a,l)=>function(e,t,i=null){const s=new jn(e,i);return Mr(t).applyToMesh(s,t.updatable),s}(e,{xmin:t,zmin:i,xmax:s,zmax:n,subdivisions:r,precision:o,updatable:l},a),jn.CreateGroundFromHeightMap=(e,t,i,s,n,r,o,a,l,h,c)=>function(e,t,i={},s=null){const n=i.width||10,r=i.height||10,o=i.subdivisions||1,a=i.minHeight||0,l=i.maxHeight||1,h=i.colorFilter||new Re(.3,.59,.11),c=i.alphaFilter||0,d=i.updatable,_=i.onReady;s=s||u.LastCreatedScene;const f=new Ir(e,s);f._subdivisionsX=o,f._subdivisionsY=o,f._width=n,f._height=r,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1);const p=(e,t,i)=>{Or({width:n,height:r,subdivisions:o,minHeight:a,maxHeight:l,colorFilter:h,buffer:e,bufferWidth:t,bufferHeight:i,alphaFilter:c}).applyToMesh(f,d),_&&_(f),f._setReady(!0)};if("string"==typeof t){const e=e=>{const t=e.width,i=e.height;if(s.isDisposed)return;const n=null==s?void 0:s.getEngine().resizeImageBitmap(e,t,i);p(n,t,i)};Ot.LoadImage(t,e,i.onError?i.onError:()=>{},s.offlineProvider)}else p(t.data,t.width,t.height);return f}(e,t,{width:i,height:s,subdivisions:n,minHeight:r,maxHeight:o,updatable:l,onReady:h,alphaFilter:c},a),Nn.CreateBox=Nr,jn.CreateBox=(e,t,i=null,s,n)=>Fr(e,{size:t,sideOrientation:n,updatable:s},i);class Lr{static _GetDefaultOptions(e){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new Re(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new Re(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:me.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(e,t){this._errorHandler=(e,t)=>{this.onErrorObservable.notifyObservers({message:e,exception:t})},this._options=Object.assign(Object.assign({},Lr._GetDefaultOptions(t)),e),this._scene=t,this.onErrorObservable=new s,this._setupBackground(),this._setupImageProcessing()}updateOptions(e){const t=Object.assign(Object.assign({},this._options),e);this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new Ie(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof ki)return void(this._scene.environmentTexture=this._options.environmentTexture);const e=xr.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new jn("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,t=this._options.skyboxSize,i=this._options.rootPosition;if(!this._scene.meshes||1===this._scene.meshes.length)return{groundSize:e,skyboxSize:t,rootPosition:i};const s=this._scene.getWorldExtends((e=>e!==this._ground&&e!==this._rootMesh&&e!==this._skybox)),n=s.max.subtract(s.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof Er&&this._scene.activeCamera.upperRadiusLimit&&(e=2*this._scene.activeCamera.upperRadiusLimit,t=e);const r=n.length();r>e&&(e=2*r,t=e),e*=1.1,t*=1.5,i=s.min.add(n.scale(.5)),i.y=s.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:i}}_setupGround(e){this._ground&&!this._ground.isDisposed()||(this._ground=Rr("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add((()=>{this._ground=null}))),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new yr("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){this._groundMaterial&&(this._groundTexture||(this._options.groundTexture instanceof ki?this._groundMaterial.diffuseTexture=this._options.groundTexture:(this._groundTexture=new zi(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture)))}_setupGroundMirrorTexture(e){const t=zi.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new Sr("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,zi.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new kt(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(let e=0;e<this._scene.meshes.length;e++){const t=this._scene.meshes[e];t!==this._ground&&t!==this._skybox&&t!==this._rootMesh&&this._groundMirror.renderList.push(t)}const i=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new Ie(i.r,i.g,i.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){this._skybox&&!this._skybox.isDisposed()||(this._skybox=Fr("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:jn.BACKSIDE},this._scene),this._skybox.onDisposeObservable.add((()=>{this._skybox=null}))),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new yr("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){this._skyboxMaterial&&(this._skyboxTexture||(this._options.skyboxTexture instanceof ki?this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture:(this._skyboxTexture=new xr(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=zi.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture)))}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}Lr._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",Lr._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",Lr._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env";class wr{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=Ot.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((()=>{this._keys.length=0})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((t=>{const i=t.event;if(!i.metaKey)if(t.type===pi.KEYDOWN)-1===this.keysUp.indexOf(i.keyCode)&&-1===this.keysDown.indexOf(i.keyCode)&&-1===this.keysLeft.indexOf(i.keyCode)&&-1===this.keysRight.indexOf(i.keyCode)&&-1===this.keysUpward.indexOf(i.keyCode)&&-1===this.keysDownward.indexOf(i.keyCode)&&-1===this.keysRotateLeft.indexOf(i.keyCode)&&-1===this.keysRotateRight.indexOf(i.keyCode)&&-1===this.keysRotateUp.indexOf(i.keyCode)&&-1===this.keysRotateDown.indexOf(i.keyCode)||(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysUpward.indexOf(i.keyCode)||-1!==this.keysDownward.indexOf(i.keyCode)||-1!==this.keysRotateLeft.indexOf(i.keyCode)||-1!==this.keysRotateRight.indexOf(i.keyCode)||-1!==this.keysRotateUp.indexOf(i.keyCode)||-1!==this.keysRotateDown.indexOf(i.keyCode)){const t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),e||i.preventDefault()}})))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(i)?e._localDirection.copyFromFloats(-s,0,0):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,0,s):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(s,0,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,0,-s):-1!==this.keysUpward.indexOf(i)?e._localDirection.copyFromFloats(0,s,0):-1!==this.keysDownward.indexOf(i)?e._localDirection.copyFromFloats(0,-s,0):-1!==this.keysRotateLeft.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):-1!==this.keysRotateRight.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):-1!==this.keysRotateUp.indexOf(i)?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):-1!==this.keysRotateDown.indexOf(i)&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),me.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}}De([Ge()],wr.prototype,"keysUp",void 0),De([Ge()],wr.prototype,"keysUpward",void 0),De([Ge()],wr.prototype,"keysDown",void 0),De([Ge()],wr.prototype,"keysDownward",void 0),De([Ge()],wr.prototype,"keysLeft",void 0),De([Ge()],wr.prototype,"keysRight",void 0),De([Ge()],wr.prototype,"rotationSpeed",void 0),De([Ge()],wr.prototype,"keysRotateLeft",void 0),De([Ge()],wr.prototype,"keysRotateRight",void 0),De([Ge()],wr.prototype,"keysRotateUp",void 0),De([Ge()],wr.prototype,"keysRotateDown",void 0),fr.FreeCameraKeyboardMoveInput=wr;class Br{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new s,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=Ot.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=s=>{const n=s.event,r="touch"===n.pointerType;if(!this.touchEnabled&&r)return;if(s.type!==ci.POINTERMOVE&&-1===this.buttons.indexOf(n.button))return;const o=n.target;if(s.type===ci.POINTERDOWN){if(r&&-1!==this._activePointerId||!r&&-1!==this._currentActiveButton)return;this._activePointerId=n.pointerId;try{null==o||o.setPointerCapture(n.pointerId)}catch(e){}-1===this._currentActiveButton&&(this._currentActiveButton=n.button),this._previousPosition={x:n.clientX,y:n.clientY},e||(n.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(s.event)}else if(s.type===ci.POINTERUP){if(r&&this._activePointerId!==n.pointerId||!r&&this._currentActiveButton!==n.button)return;try{null==o||o.releasePointerCapture(n.pointerId)}catch(e){}this._currentActiveButton=-1,this._previousPosition=null,e||n.preventDefault(),this._activePointerId=-1}else if(s.type===ci.POINTERMOVE&&(this._activePointerId===n.pointerId||!r))if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(s.event);else if(this._previousPosition){const t=this.camera._calculateHandednessMultiplier(),i=(n.clientX-this._previousPosition.x)*t,s=n.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=i/this.angularSensibility,this.camera.cameraRotation.x+=s/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:i,offsetY:s}),this._previousPosition={x:n.clientX,y:n.clientY},e||n.preventDefault()}}),this._onMouseMove=i=>{if(!t.isPointerLock)return;const s=this.camera._calculateHandednessMultiplier(),n=i.movementX*s;this.camera.cameraRotation.y+=n/this.angularSensibility;const r=i.movementY;this.camera.cameraRotation.x+=r/this.angularSensibility,this._previousPosition=null,e||i.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ci.POINTERDOWN|ci.POINTERUP|ci.POINTERMOVE),i&&(this._contextMenuBind=e=>this.onContextMenu(e),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}De([Ge()],Br.prototype,"buttons",void 0),De([Ge()],Br.prototype,"angularSensibility",void 0),fr.FreeCameraMouseInput=Br;class Ur{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new s,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=Ot.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==ci.POINTERWHEEL)return;const i=t.event,s=i.deltaMode===vi.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*s*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*s*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*s*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,ci.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}var kr;De([Ge()],Ur.prototype,"wheelPrecisionX",void 0),De([Ge()],Ur.prototype,"wheelPrecisionY",void 0),De([Ge()],Ur.prototype,"wheelPrecisionZ",void 0),function(e){e[e.MoveRelative=0]="MoveRelative",e[e.RotateRelative=1]="RotateRelative",e[e.MoveScene=2]="MoveScene"}(kr||(kr={}));class Vr extends Ur{constructor(){super(...arguments),this._moveRelative=me.Zero(),this._rotateRelative=me.Zero(),this._moveScene=me.Zero(),this._wheelXAction=kr.MoveRelative,this._wheelXActionCoordinate=en.X,this._wheelYAction=kr.MoveRelative,this._wheelYActionCoordinate=en.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){null===e&&this._wheelXAction!==kr.MoveRelative||(this._wheelXAction=kr.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==kr.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){null===e&&this._wheelYAction!==kr.MoveRelative||(this._wheelYAction=kr.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==kr.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){null===e&&this._wheelZAction!==kr.MoveRelative||(this._wheelZAction=kr.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==kr.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){null===e&&this._wheelXAction!==kr.RotateRelative||(this._wheelXAction=kr.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==kr.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){null===e&&this._wheelYAction!==kr.RotateRelative||(this._wheelYAction=kr.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==kr.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){null===e&&this._wheelZAction!==kr.RotateRelative||(this._wheelZAction=kr.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==kr.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){null===e&&this._wheelXAction!==kr.MoveScene||(this._wheelXAction=kr.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==kr.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){null===e&&this._wheelYAction!==kr.MoveScene||(this._wheelYAction=kr.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==kr.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){null===e&&this._wheelZAction!==kr.MoveScene||(this._wheelZAction=kr.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==kr.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(0===this._wheelDeltaX&&0===this._wheelDeltaY&&0==this._wheelDeltaZ)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=Te.Zero();this.camera.getViewMatrix().invertToRef(e);const t=me.Zero();me.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(0===e)return;if(null===t||null===i)return;let s=null;switch(t){case kr.MoveRelative:s=this._moveRelative;break;case kr.RotateRelative:s=this._rotateRelative;break;case kr.MoveScene:s=this._moveScene}switch(i){case en.X:s.set(e,0,0);break;case en.Y:s.set(0,e,0);break;case en.Z:s.set(0,0,e)}}}De([Ge()],Vr.prototype,"wheelXMoveRelative",null),De([Ge()],Vr.prototype,"wheelYMoveRelative",null),De([Ge()],Vr.prototype,"wheelZMoveRelative",null),De([Ge()],Vr.prototype,"wheelXRotateRelative",null),De([Ge()],Vr.prototype,"wheelYRotateRelative",null),De([Ge()],Vr.prototype,"wheelZRotateRelative",null),De([Ge()],Vr.prototype,"wheelXMoveScene",null),De([Ge()],Vr.prototype,"wheelYMoveScene",null),De([Ge()],Vr.prototype,"wheelZMoveScene",null),fr.FreeCameraMouseWheelInput=Vr;class Gr{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=Ot.IsSafari()}attachControl(e){e=Ot.BackCompatCameraNoPreventDefault(arguments);let t=null;if(void 0===this._pointerInput&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const s=i.event,n="mouse"===s.pointerType||this._isSafari&&void 0===s.pointerType;if(this.allowMouse||!n)if(i.type===ci.POINTERDOWN){if(e||s.preventDefault(),this._pointerPressed.push(s.pointerId),1!==this._pointerPressed.length)return;t={x:s.clientX,y:s.clientY}}else if(i.type===ci.POINTERUP){e||s.preventDefault();const i=this._pointerPressed.indexOf(s.pointerId);if(-1===i)return;if(this._pointerPressed.splice(i,1),0!=i)return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===ci.POINTERMOVE){if(e||s.preventDefault(),!t)return;if(0!=this._pointerPressed.indexOf(s.pointerId))return;this._offsetX=s.clientX-t.x,this._offsetY=-(s.clientY-t.y)}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ci.POINTERDOWN|ci.POINTERUP|ci.POINTERMOVE),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const e=this.camera.getEngine().getInputElement();e&&e.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(null===this._offsetX||null===this._offsetY)return;if(0===this._offsetX&&0===this._offsetY)return;const e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&1===this._pointerPressed.length||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const t=e._computeLocalCameraSpeed(),i=new me(0,0,0!==this.touchMoveSensibility?t*this._offsetY/this.touchMoveSensibility:0);Te.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(me.TransformCoordinates(i,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}De([Ge()],Gr.prototype,"touchAngularSensibility",void 0),De([Ge()],Gr.prototype,"touchMoveSensibility",void 0),fr.FreeCameraTouchInput=Gr;class zr extends pr{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new wr),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new Br(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new Vr,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new Gr),this}clear(){super.clear(),this._mouseInput=null}}class Hr extends _r{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new me(.5,1,.5),this.ellipsoidOffset=new me(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=me.Zero(),this._diffPosition=me.Zero(),this._newPosition=me.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,i=null)=>{this._newPosition.copyFrom(t),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>te.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&i&&this.onCollide(i))},this.inputs=new zr(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=Ot.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new me(0,0,0),this.cameraRotation=new pe(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;t=this.parent?me.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=me.Zero(),this._transformedDirection=me.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}De([Qe()],Hr.prototype,"ellipsoid",void 0),De([Qe()],Hr.prototype,"ellipsoidOffset",void 0),De([Ge()],Hr.prototype,"checkCollisions",void 0),De([Ge()],Hr.prototype,"applyGravity",void 0),zr.prototype.addDeviceOrientation=function(e){return this._deviceOrientationInput||(this._deviceOrientationInput=new Wr,e&&(this._deviceOrientationInput.smoothFactor=e),this.add(this._deviceOrientationInput)),this};class Wr{static WaitForOrientationChangeAsync(e){return new Promise(((t,i)=>{let s=!1;const n=()=>{window.removeEventListener("deviceorientation",n),s=!0,t()};e&&setTimeout((()=>{s||(window.removeEventListener("deviceorientation",n),i("WaitForOrientationChangeAsync timed out"))}),e),"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"==e?window.addEventListener("deviceorientation",n):Ot.Warn("Permission not granted.")})).catch((e=>{Ot.Error(e)})):window.addEventListener("deviceorientation",n)}))}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new ve,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new s,this._orientationChanged=()=>{this._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-Ot.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=null!==e.alpha?Ot.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=null!==e.beta?Ot.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=null!==e.gamma?Ot.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=null!==e.alpha?e.alpha:0,this._beta=null!==e.beta?e.beta:0,this._gamma=null!==e.gamma?e.gamma:0),null!==e.alpha&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTranform=new ve(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,null==this._camera||this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new ve),this._camera&&this._camera.onDisposeObservable.add((()=>{this._onDeviceOrientationChangedObservable.clear()}))}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e?t():Ot.Warn("Permission not granted.")})).catch((e=>{Ot.Error(e)})):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(ve.RotationYawPitchRollToRef(Ot.ToRadians(this._alpha),Ot.ToRadians(this._beta),-Ot.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}fr.FreeCameraDeviceOrientationInput=Wr,et.AddNodeConstructor("DeviceOrientationCamera",((e,t)=>()=>new Xr(e,me.Zero(),t)));class Xr extends Hr{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new ve,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new ve,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce((()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add((e=>{0!=this._dragFactor&&(this._initialQuaternion||(this._initialQuaternion=new ve),ve.FromEulerAnglesToRef(0,e.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))})))}))}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=nn.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new ve),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach((t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0})),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class Qr{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return Te.Translation(e,0,0)}get rightHMatrix(){const e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return Te.Translation(-e,0,0)}get leftPreViewMatrix(){return Te.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return Te.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new Qr;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}F.ShadersStore.vrDistortionCorrectionPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 LensCenter;uniform vec2 Scale;uniform vec2 ScaleIn;uniform vec4 HmdWarpParam;vec2 HmdWarp(vec2 in01) {vec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);return LensCenter+Scale*rvector;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 tc=HmdWarp(vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,0.0);else{gl_FragColor=texture2D(textureSampler,tc);}}";class Yr extends es{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,s){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,s.postProcessScaleFactor,t,zi.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=s.distortionK,this._postProcessScaleFactor=s.postProcessScaleFactor,this._lensCenterOffset=s.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add((()=>{this._scaleIn=new pe(2,2/this.aspectRatio),this._scaleFactor=new pe(1/this._postProcessScaleFactor*.5,1/this._postProcessScaleFactor*.5*this.aspectRatio),this._lensCenter=new pe(this._isRightEye?.5-.5*this._lensCenterOffset:.5+.5*this._lensCenterOffset,.5)})),this.onApplyObservable.add((e=>{e.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),e.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),e.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),e.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])}))}}F.ShadersStore.vrMultiviewToSingleviewPixelShader="precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}";class Kr extends Ji{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}function jr(e,t){const i=new Nt(e,void 0,!0,t);return i.addUniform("viewProjection",16),i.addUniform("viewProjectionR",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}te.prototype.createMultiviewRenderTargetTexture=function(e,t,i,s){const n=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const o=this._createHardwareRenderTargetWrapper(!1,!1,{width:e,height:t});o._framebuffer=n.createFramebuffer();const l=new a(this,r.Unknown,!0);return l.width=e,l.height=t,l.isMultiview=!0,i||(i=n.createTexture(),n.bindTexture(n.TEXTURE_2D_ARRAY,i),n.texStorage3D(n.TEXTURE_2D_ARRAY,1,n.RGBA8,e,t,2)),o._colorTextureArray=i,s||(s=n.createTexture(),n.bindTexture(n.TEXTURE_2D_ARRAY,s),n.texStorage3D(n.TEXTURE_2D_ARRAY,1,n.DEPTH24_STENCIL8,e,t,2)),o._depthStencilTextureArray=s,l.isReady=!0,o.setTextures(l),o._depthStencilTexture=l,o},te.prototype.bindMultiviewFramebuffer=function(e){const t=e,i=this._gl,s=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw"Invalid multiview frame buffer";this.getCaps().oculusMultiview?(s.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,t.samples,0,2),s.framebufferTextureMultisampleMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,t.samples,0,2)):(s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,t._depthStencilTextureArray,0,0,2))},te.prototype.bindSpaceWarpFramebuffer=function(e){const t=e,i=this._gl,s=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(t,void 0,void 0,void 0,!0),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),!t._colorTextureArray||!t._depthStencilTextureArray)throw new Error("Invalid Space Warp framebuffer");s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0,t._colorTextureArray,0,0,2),s.framebufferTextureMultiviewOVR(i.DRAW_FRAMEBUFFER,i.DEPTH_ATTACHMENT,t._depthStencilTextureArray,0,0,2)},Gt.prototype._useMultiviewToSingleView=!1,Gt.prototype._multiviewTexture=null,Gt.prototype._resizeOrCreateMultiviewTexture=function(e,t){this._multiviewTexture?this._multiviewTexture.getRenderWidth()==e&&this._multiviewTexture.getRenderHeight()==t||(this._multiviewTexture.dispose(),this._multiviewTexture=new Kr(this.getScene(),{width:e,height:t})):this._multiviewTexture=new Kr(this.getScene(),{width:e,height:t})};const $r=Oi.prototype.createSceneUniformBuffer;Oi.prototype._transformMatrixR=Te.Zero(),Oi.prototype._multiviewSceneUbo=null,Oi.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=jr(this.getEngine(),"scene_multiview")},Oi.prototype.createSceneUniformBuffer=function(e){return this._multiviewSceneUbo?jr(this.getEngine(),e):$r.bind(this)(e)},Oi.prototype._updateMultiviewUbo=function(e,t){e&&t&&e.multiplyToRef(t,this._transformMatrixR),e&&t&&(e.multiplyToRef(t,Ee.Matrix[0]),Vt.GetRightPlaneToRef(Ee.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},Oi.prototype._renderMultiviewToSingleView=function(e){e._resizeOrCreateMultiviewTexture(e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.width>0?e._rigPostProcess.width:this.getEngine().getRenderWidth(!0),e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.height>0?e._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),e.outputRenderTarget=e._multiviewTexture,this._renderForCamera(e),e.outputRenderTarget=null;for(let t=0;t<e._rigCameras.length;t++){const i=this.getEngine();this._activeCamera=e._rigCameras[t],i.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class qr extends es{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,zi.BILINEAR_SAMPLINGMODE);const s=null!=t?t:this.getCamera();this.onSizeChangedObservable.add((()=>{})),this.onApplyObservable.add((e=>{s._scene.activeCamera&&s._scene.activeCamera.isLeftCamera?e.setInt("imageIndex",0):e.setInt("imageIndex",1),e.setTexture("multiviewSampler",s._multiviewTexture)}))}}et.AddNodeConstructor("VRDeviceOrientationFreeCamera",((e,t)=>()=>new Zr(e,me.Zero(),t)));class Zr extends Xr{constructor(e,t,i,s=!0,n=Qr.GetDefault()){super(e,t,i),this._setRigMode=e=>function(e,t){const i=t.vrCameraMetrics||Qr.GetDefault();e._rigCameras[0]._cameraRigParams.vrMetrics=i,e._rigCameras[0].viewport=new Ut(0,0,.5,1),e._rigCameras[0]._cameraRigParams.vrWorkMatrix=new Te,e._rigCameras[0]._cameraRigParams.vrHMatrix=i.leftHMatrix,e._rigCameras[0]._cameraRigParams.vrPreViewMatrix=i.leftPreViewMatrix,e._rigCameras[0].getProjectionMatrix=e._rigCameras[0]._getVRProjectionMatrix,e._rigCameras[1]._cameraRigParams.vrMetrics=i,e._rigCameras[1].viewport=new Ut(.5,0,.5,1),e._rigCameras[1]._cameraRigParams.vrWorkMatrix=new Te,e._rigCameras[1]._cameraRigParams.vrHMatrix=i.rightHMatrix,e._rigCameras[1]._cameraRigParams.vrPreViewMatrix=i.rightPreViewMatrix,e._rigCameras[1].getProjectionMatrix=e._rigCameras[1]._getVRProjectionMatrix,i.multiviewEnabled&&(e.getScene().getEngine().getCaps().multiview?(e._useMultiviewToSingleView=!0,e._rigPostProcess=new qr("VRMultiviewToSingleview",e,i.postProcessScaleFactor)):(p.Warn("Multiview is not supported, falling back to standard rendering"),i.multiviewEnabled=!1)),i.compensateDistortion&&(e._rigCameras[0]._rigPostProcess=new Yr("VR_Distort_Compensation_Left",e._rigCameras[0],!1,i),e._rigCameras[1]._rigPostProcess=new Yr("VR_Distort_Compensation_Right",e._rigCameras[1],!0,i))}(this,e),n.compensateDistortion=s,this.setCameraRigMode(Gt.RIG_MODE_VR,{vrCameraMetrics:n})}getClassName(){return"VRDeviceOrientationFreeCamera"}}class Jr{get isConnected(){return this._isConnected}constructor(e,t,i,s=0,n=1,r=2,o=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=Jr.GAMEPAD,this._leftStickAxisX=s,this._leftStickAxisY=n,this._rightStickAxisX=r,this._rightStickAxisY=o,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){!this._onleftstickchanged||this._leftStick.x===e.x&&this._leftStick.y===e.y||this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){!this._onrightstickchanged||this._rightStick.x===e.x&&this._rightStick.y===e.y||this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}Jr.GAMEPAD=0,Jr.GENERIC=1,Jr.XBOX=2,Jr.POSE_ENABLED=3,Jr.DUALSHOCK=4;class eo extends Jr{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new s,this.onButtonUpObservable=new s,this.type=Jr.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}var to,io,so,no,ro,oo;!function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.X=2]="X",e[e.Y=3]="Y",e[e.LB=4]="LB",e[e.RB=5]="RB",e[e.Back=8]="Back",e[e.Start=9]="Start",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(to||(to={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(io||(io={}));class ao extends Jr{constructor(e,t,i,n=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new s,this.onButtonUpObservable=new s,this.onPadDownObservable=new s,this.onPadUpObservable=new s,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=Jr.XBOX,this._isXboxOnePad=n}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,to.A)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,to.B)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,to.X)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,to.Y)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,to.Start)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,to.Back)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,to.LB)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,to.RB)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,to.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,to.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,io.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,io.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,io.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,io.Right)}update(){super.update(),this._isXboxOnePad,this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class lo{constructor(e,t,i=Number.MAX_VALUE){this.origin=e,this.direction=t,this.length=i}clone(){return new lo(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const s=lo._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),n=lo._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let r,o,a,l,h=0,c=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<s.x||this.origin.x>n.x)return!1}else if(r=1/this.direction.x,o=(s.x-this.origin.x)*r,a=(n.x-this.origin.x)*r,a===-1/0&&(a=1/0),o>a&&(l=o,o=a,a=l),h=Math.max(o,h),c=Math.min(a,c),h>c)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<s.y||this.origin.y>n.y)return!1}else if(r=1/this.direction.y,o=(s.y-this.origin.y)*r,a=(n.y-this.origin.y)*r,a===-1/0&&(a=1/0),o>a&&(l=o,o=a,a=l),h=Math.max(o,h),c=Math.min(a,c),h>c)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<s.z||this.origin.z>n.z)return!1}else if(r=1/this.direction.z,o=(s.z-this.origin.z)*r,a=(n.z-this.origin.z)*r,a===-1/0&&(a=1/0),o>a&&(l=o,o=a,a=l),h=Math.max(o,h),c=Math.min(a,c),h>c)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,s=e.center.y-this.origin.y,n=e.center.z-this.origin.z,r=i*i+s*s+n*n,o=e.radius+t,a=o*o;if(r<=a)return!0;const l=i*this.direction.x+s*this.direction.y+n*this.direction.z;return!(l<0)&&r-l*l<=a}intersectsTriangle(e,t,i){const s=lo._TmpVector3[0],n=lo._TmpVector3[1],r=lo._TmpVector3[2],o=lo._TmpVector3[3],a=lo._TmpVector3[4];t.subtractToRef(e,s),i.subtractToRef(e,n),me.CrossToRef(this.direction,n,r);const l=me.Dot(s,r);if(0===l)return null;const h=1/l;this.origin.subtractToRef(e,o);const c=me.Dot(o,r)*h;if(c<0||c>1)return null;me.CrossToRef(o,s,a);const d=me.Dot(this.direction,a)*h;if(d<0||c+d>1)return null;const u=me.Dot(n,a)*h;return u>this.length?null:new Ss(1-c-d,c,u)}intersectsPlane(e){let t;const i=me.Dot(e.normal,this.direction);if(Math.abs(i)<9.99999997475243e-7)return null;{const s=me.Dot(e.normal,this.origin);return t=(-e.d-s)/i,t<0?t<-9.99999997475243e-7?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const e=(this.origin.y-t)/this.direction.y;return e>0?null:new me(this.origin.x+this.direction.x*-e,t,this.origin.z+this.direction.z*-e)}case"x":{const e=(this.origin.x-t)/this.direction.x;return e>0?null:new me(t,this.origin.y+this.direction.y*-e,this.origin.z+this.direction.z*-e)}case"z":{const e=(this.origin.z-t)/this.direction.z;return e>0?null:new me(this.origin.x+this.direction.x*-e,this.origin.y+this.direction.y*-e,t)}default:return null}}intersectsMesh(e,t,i,s=!1,n,r=!1){const o=Ee.Matrix[0];return e.getWorldMatrix().invertToRef(o),this._tmpRay?lo.TransformToRef(this,o,this._tmpRay):this._tmpRay=lo.Transform(this,o),e.intersects(this._tmpRay,t,i,s,n,r)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let s=0;s<e.length;s++){const n=this.intersectsMesh(e[s],t);n.hit&&i.push(n)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const s=this.origin,n=Ee.Vector3[0],r=Ee.Vector3[1],o=Ee.Vector3[2],a=Ee.Vector3[3];t.subtractToRef(e,n),this.direction.scaleToRef(lo._Rayl,o),s.addToRef(o,r),e.subtractToRef(s,a);const l=me.Dot(n,n),h=me.Dot(n,o),c=me.Dot(o,o),d=me.Dot(n,a),u=me.Dot(o,a),_=l*c-h*h;let f,p,m=_,g=_;_<lo._Smallnum?(f=0,m=1,p=u,g=c):(f=h*u-c*d,p=l*u-h*d,f<0?(f=0,p=u,g=c):f>m&&(f=m,p=u+h,g=c)),p<0?(p=0,-d<0?f=0:-d>l?f=m:(f=-d,m=l)):p>g&&(p=g,-d+h<0?f=0:-d+h>l?f=m:(f=-d+h,m=l));const v=Math.abs(f)<lo._Smallnum?0:f/m,T=Math.abs(p)<lo._Smallnum?0:p/g,b=Ee.Vector3[4];o.scaleToRef(T,b);const E=Ee.Vector3[5];n.scaleToRef(v,E),E.addInPlace(a);const S=Ee.Vector3[6];return E.subtractToRef(b,S),T>0&&T<=this.length&&S.lengthSquared()<i*i?E.length():-1}update(e,t,i,s,n,r,o,a=!1){if(a){lo._RayDistant||(lo._RayDistant=lo.Zero()),lo._RayDistant.unprojectRayToRef(e,t,i,s,Te.IdentityReadOnly,r,o);const a=Ee.Matrix[0];n.invertToRef(a),lo.TransformToRef(lo._RayDistant,a,this)}else this.unprojectRayToRef(e,t,i,s,n,r,o);return this}static Zero(){return new lo(me.Zero(),me.Zero())}static CreateNew(e,t,i,s,n,r,o){return lo.Zero().update(e,t,i,s,n,r,o)}static CreateNewFromTo(e,t,i=Te.IdentityReadOnly){const s=t.subtract(e),n=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return s.normalize(),lo.Transform(new lo(e,s,n),i)}static Transform(e,t){const i=new lo(new me(0,0,0),new me(0,0,0));return lo.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){me.TransformCoordinatesToRef(e.origin,t,i.origin),me.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;const s=i.direction,n=s.length();if(0!==n&&1!==n){const e=1/n;s.x*=e,s.y*=e,s.z*=e,i.length*=n}}unprojectRayToRef(e,t,i,s,n,r,o){const a=Ee.Matrix[0];n.multiplyToRef(r,a),a.multiplyToRef(o,a),a.invert();const l=u.LastCreatedEngine,h=Ee.Vector3[0];h.x=e/i*2-1,h.y=-(t/s*2-1),h.z=(null==l?void 0:l.useReverseDepthBuffer)?1:(null==l?void 0:l.isNDCHalfZRange)?0:-1;const c=Ee.Vector3[1].copyFromFloats(h.x,h.y,1-1e-8),d=Ee.Vector3[2],_=Ee.Vector3[3];me._UnprojectFromInvertedMatrixToRef(h,a,d),me._UnprojectFromInvertedMatrixToRef(c,a,_),this.origin.copyFrom(d),_.subtractToRef(d,this.direction),this.direction.normalize()}}lo._TmpVector3=le.BuildArray(6,me.Zero),lo._RayDistant=lo.Zero(),lo._Smallnum=1e-8,lo._Rayl=1e9,Oi.prototype.createPickingRay=function(e,t,i,s,n=!1){const r=lo.Zero();return this.createPickingRayToRef(e,t,i,r,s,n),r},Oi.prototype.createPickingRayToRef=function(e,t,i,s,n,r=!1,o=!1){const a=this.getEngine();if(!n&&!(n=this.activeCamera))return this;const l=n.viewport,h=a.getRenderHeight(),{x:c,y:d,width:u,height:_}=l.toGlobal(a.getRenderWidth(),h),f=1/a.getHardwareScalingLevel();return e=e*f-c,t=t*f-(h-d-_),s.update(e,t,u,_,i||Te.IdentityReadOnly,r?Te.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),o),this},Oi.prototype.createPickingRayInCameraSpace=function(e,t,i){const s=lo.Zero();return this.createPickingRayInCameraSpaceToRef(e,t,s,i),s},Oi.prototype.createPickingRayInCameraSpaceToRef=function(e,t,i,s){if(!ii)return this;const n=this.getEngine();if(!s&&!(s=this.activeCamera))throw new Error("Active camera not set");const r=s.viewport,o=n.getRenderHeight(),{x:a,y:l,width:h,height:c}=r.toGlobal(n.getRenderWidth(),o),d=Te.Identity(),u=1/n.getHardwareScalingLevel();return e=e*u-a,t=t*u-(o-l-c),i.update(e,t,h,c,d,d,s.getProjectionMatrix()),this},Oi.prototype._internalPickForMesh=function(e,t,i,s,n,r,o,a){const l=t(s,i.enableDistantPicking),h=i.intersects(l,n,o,r,s,a);return h&&h.hit?!n&&null!=e&&h.distance>=e.distance?null:h:null},Oi.prototype._internalPick=function(e,t,i,s,n){let r=null;const o=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),a=this.cameraToUseForPointers||this.activeCamera;for(let l=0;l<this.meshes.length;l++){const h=this.meshes[l];if(t){if(!t(h))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;const c=o&&h.isWorldMatrixCameraDependent(),d=h.computeWorldMatrix(c,a);if(h.hasThinInstances&&h.thinInstanceEnablePicking){const t=this._internalPickForMesh(r,e,h,d,!0,!0,n);if(t){if(s)return t;const o=Ee.Matrix[1],a=h.thinInstanceGetWorldMatrices();for(let t=0;t<a.length;t++){a[t].multiplyToRef(d,o);const l=this._internalPickForMesh(r,e,h,o,i,s,n,!0);if(l&&(r=l,r.thinInstanceIndex=t,i))return r}}}else{const t=this._internalPickForMesh(r,e,h,d,i,s,n);if(t&&(r=t,i))return r}}return r||new ii},Oi.prototype._internalMultiPick=function(e,t,i){if(!ii)return null;const s=[],n=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),r=this.cameraToUseForPointers||this.activeCamera;for(let o=0;o<this.meshes.length;o++){const a=this.meshes[o];if(t){if(!t(a))continue}else if(!a.isEnabled()||!a.isVisible||!a.isPickable)continue;const l=n&&a.isWorldMatrixCameraDependent(),h=a.computeWorldMatrix(l,r);if(a.hasThinInstances&&a.thinInstanceEnablePicking){if(this._internalPickForMesh(null,e,a,h,!0,!0,i)){const t=Ee.Matrix[1],n=a.thinInstanceGetWorldMatrices();for(let r=0;r<n.length;r++){n[r].multiplyToRef(h,t);const o=this._internalPickForMesh(null,e,a,t,!1,!1,i,!0);o&&(o.thinInstanceIndex=r,s.push(o))}}}else{const t=this._internalPickForMesh(null,e,a,h,!1,!1,i);t&&s.push(t)}}return s},Oi.prototype.pickWithBoundingInfo=function(e,t,i,s,n){if(!ii)return null;const r=this._internalPick((i=>(this._tempPickingRay||(this._tempPickingRay=lo.Zero()),this.createPickingRayToRef(e,t,i,this._tempPickingRay,n||null),this._tempPickingRay)),i,s,!0);return r&&(r.ray=this.createPickingRay(e,t,Te.Identity(),n||null)),r},Object.defineProperty(Oi.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1}),Oi.prototype.pick=function(e,t,i,s,n,r,o=!1){const a=this._internalPick(((i,s)=>(this._tempPickingRay||(this._tempPickingRay=lo.Zero()),this.createPickingRayToRef(e,t,i,this._tempPickingRay,n||null,!1,s),this._tempPickingRay)),i,s,!1,r);return a&&(a.ray=this.createPickingRay(e,t,Te.Identity(),n||null)),a},Oi.prototype.pickWithRay=function(e,t,i,s){const n=this._internalPick((t=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=Te.Identity()),t.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=lo.Zero()),lo.TransformToRef(e,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform)),t,i,!1,s);return n&&(n.ray=e),n},Oi.prototype.multiPick=function(e,t,i,s,n){return this._internalMultiPick((i=>this.createPickingRay(e,t,i,s||null)),i,n)},Oi.prototype.multiPickWithRay=function(e,t,i){return this._internalMultiPick((t=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=Te.Identity()),t.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=lo.Zero()),lo.TransformToRef(e,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform)),t,i)},Gt.prototype.getForwardRay=function(e=100,t,i){return this.getForwardRayToRef(new lo(me.Zero(),me.Zero(),e),e,t,i)},Gt.prototype.getForwardRayToRef=function(e,t=100,i,s){i||(i=this.getWorldMatrix()),e.length=t,s?e.origin.copyFrom(s):e.origin.copyFrom(this.position);const n=Ee.Vector3[2];n.set(0,0,this._scene.useRightHandedSystem?-1:1);const r=Ee.Vector3[3];return me.TransformNormalToRef(n,i,r),me.NormalizeToRef(r,e.direction),e},q.prototype.createDynamicTexture=function(e,t,i,s){const n=new a(this,r.Dynamic);return n.baseWidth=e,n.baseHeight=t,i&&(e=this.needPOTTextures?q.GetExponentOfTwo(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?q.GetExponentOfTwo(t,this._caps.maxTextureSize):t),n.width=e,n.height=t,n.isReady=!1,n.generateMipMaps=i,n.samplingMode=s,this.updateTextureSamplingMode(s,n),this._internalTexturesCache.push(n),n},q.prototype.updateDynamicTexture=function(e,t,i,s=!1,n,r=!1,o=!1){if(!e)return;const a=this._gl,l=a.TEXTURE_2D,h=this._bindTextureDirectly(l,e,!0,r);this._unpackFlipY(void 0===i?e.invertY:i),s&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const c=this._getWebGLTextureType(e.type),d=this._getInternalFormat(n||e.format),u=this._getRGBABufferInternalSizedFormat(e.type,d);a.texImage2D(l,0,u,d,c,t),e.generateMipMaps&&a.generateMipmap(l),h||this._bindTextureDirectly(l,null),s&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),n&&(e.format=n),e._dynamicTextureSource=t,e._premulAlpha=s,e.invertY=i||!1,e.isReady=!0};class ho extends zi{constructor(e,t,i=null,s=!1,n=3,r=5,o){super(null,i,!s,o,n,void 0,void 0,void 0,void 0,r),this.name=e,this.wrapU=zi.CLAMP_ADDRESSMODE,this.wrapV=zi.CLAMP_ADDRESSMODE,this._generateMipMaps=s;const a=this._getEngine();if(!a)return;t.getContext?(this._canvas=t,this._texture=a.createDynamicTexture(t.width,t.height,s,n)):(this._canvas=a.createCanvas(1,1),t.width||0===t.width?this._texture=a.createDynamicTexture(t.width,t.height,s,n):this._texture=a.createDynamicTexture(t,t,s,n));const l=this.getSize();this._canvas.width!==l.width&&(this._canvas.width=l.width),this._canvas.height!==l.height&&(this._canvas.height=l.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){const i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(e){const t=this.getSize();e&&(this._context.fillStyle=e),this._context.clearRect(0,0,t.width,t.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===e||e,t,this._format||void 0,void 0,i)}drawText(e,t,i,s,n,r,o,a=!0){const l=this.getSize();if(r&&(this._context.fillStyle=r,this._context.fillRect(0,0,l.width,l.height)),this._context.font=s,null==t){const i=this._context.measureText(e);t=(l.width-i.width)/2}if(null==i){const e=parseInt(s.replace(/\D/g,""));i=l.height/2+e/3.65}this._context.fillStyle=n||"",this._context.fillText(e,t,i),a&&this.update(o)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new ho(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){const e=this.getScene();e&&!e.isReady()&&p.Warn("The scene must be ready before serializing the dynamic texture");const t=super.serialize();return ho._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return void 0!==e.toDataURL}_rebuild(){this.update()}}!function(e){e[e.Cross=0]="Cross",e[e.Circle=1]="Circle",e[e.Square=2]="Square",e[e.Triangle=3]="Triangle",e[e.L1=4]="L1",e[e.R1=5]="R1",e[e.Share=8]="Share",e[e.Options=9]="Options",e[e.LeftStick=10]="LeftStick",e[e.RightStick=11]="RightStick"}(so||(so={})),function(e){e[e.Up=12]="Up",e[e.Down=13]="Down",e[e.Left=14]="Left",e[e.Right=15]="Right"}(no||(no={}));class co extends Jr{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new s,this.onButtonUpObservable=new s,this.onPadDownObservable=new s,this.onPadUpObservable=new s,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=Jr.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(1===e&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),0===e&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(1===e&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),0===e&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,so.Cross)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,so.Circle)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,so.Square)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,so.Triangle)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,so.Options)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,so.Share)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,so.L1)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,so.R1)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,so.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,so.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,no.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,no.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,no.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,no.Right)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class uo{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new s,l()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new s((e=>{for(const t in this._babylonGamepads){const i=this._babylonGamepads[t];i&&i._isConnected&&this.onGamepadConnectedObservable.notifyObserver(e,i)}})),this._onGamepadConnectedEvent=e=>{const t=e.gamepad;if(t.index in this._babylonGamepads&&this._babylonGamepads[t.index].isConnected)return;let i;this._babylonGamepads[t.index]?(i=this._babylonGamepads[t.index],i.browserGamepad=t,i._isConnected=!0):i=this._addNewGamepad(t),this.onGamepadConnectedObservable.notifyObservers(i),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=e=>{const t=e.gamepad;for(const e in this._babylonGamepads)if(this._babylonGamepads[e].index===t.index){const t=this._babylonGamepads[e];t._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(t),t.dispose&&t.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const e=this._scene?this._scene.getEngine().getHostWindow():window;e&&(e.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),e.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=Jr.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach((e=>{e.dispose()})),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){let t;this._oneGamepadConnected||(this._oneGamepadConnected=!0);const i=-1!==e.id.search("054c")&&-1===e.id.search("0ce6"),s=-1!==e.id.search("Xbox One");return t=s||-1!==e.id.search("Xbox 360")||-1!==e.id.search("xinput")||-1!==e.id.search("045e")&&-1===e.id.search("Surface Dock")?new ao(e.id,e.index,e,s):i?new co(e.id,e.index,e):new eo(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(t&&t.isConnected)try{t.update()}catch(e){-1===this._loggedErrors.indexOf(t.index)&&(Ot.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&te.QueueNewFrame((()=>{this._checkGamepadsStatus()}))}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const e=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(e)}}}}class _o{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=Te.Identity(),this._deltaTransform=me.Zero(),this._vector3=me.Zero(),this._vector2=pe.Zero()}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add((e=>{e.type!==Jr.POSE_ENABLED&&(this.gamepad&&e.type!==Jr.XBOX||(this.gamepad=e))})),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add((e=>{this.gamepad===e&&(this.gamepad=null)})),this.gamepad=e.getGamepadByType(Jr.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;0!==this.gamepadMoveSensibility&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&0!==this.gamepadAngularSensibility?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):Te.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const s=50*e._computeLocalCameraSpeed();this._vector3.copyFromFloats(t.x*s,0,-t.y*s),me.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}De([Ge()],_o.prototype,"gamepadAngularSensibility",void 0),De([Ge()],_o.prototype,"gamepadMoveSensibility",void 0),fr.FreeCameraGamepadInput=_o;class fo{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return 1!==this._yAxisScale}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add((e=>{e.type!==Jr.POSE_ENABLED&&(this.gamepad&&e.type!==Jr.XBOX||(this.gamepad=e))})),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add((e=>{this.gamepad===e&&(this.gamepad=null)})),this.gamepad=e.getGamepadByType(Jr.XBOX)}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(0!=t.x){const i=t.x/this.gamepadRotationSensibility;0!=i&&Math.abs(i)>.005&&(e.inertialAlphaOffset+=i)}if(0!=t.y){const i=t.y/this.gamepadRotationSensibility*this._yAxisScale;0!=i&&Math.abs(i)>.005&&(e.inertialBetaOffset+=i)}}const i=this.gamepad.leftStick;if(i&&0!=i.y){const e=i.y/this.gamepadMoveSensibility;0!=e&&Math.abs(e)>.005&&(this.camera.inertialRadiusOffset-=e)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}De([Ge()],fo.prototype,"gamepadRotationSensibility",void 0),De([Ge()],fo.prototype,"gamepadMoveSensibility",void 0),fr.ArcRotateCameraGamepadInput=fo,Object.defineProperty(Oi.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new uo(this);let e=this._getComponent(li.NAME_GAMEPAD);e||(e=new po(this),this._addComponent(e))}return this._gamepadManager},enumerable:!0,configurable:!0}),zr.prototype.addGamepad=function(){return this.add(new _o),this},br.prototype.addGamepad=function(){return this.add(new fo),this};class po{constructor(e){this.name=li.NAME_GAMEPAD,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(li.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}_beforeCameraUpdate(){const e=this.scene._gamepadManager;e&&e._isMonitoring&&e._checkGamepadsStatus()}}class mo{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,s){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=s,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===cr.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=Te.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,0!==this._minFrame){const e={frame:0,value:this._minValue};this._keys.splice(0,0,e)}if(this._target instanceof Array){let e=0;for(const t of this._target)this._preparePath(t,e),this._getOriginalValues(e),e++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const n=t.getEvents();n&&n.length>0&&n.forEach((e=>{this._events.push(e._clone())})),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let s=e[i[0]];for(let e=1;e<i.length-1;e++)s=s[i[e]];this._targetPath=i[i.length-1],this._activeTargets[t]=s}else this._targetPath=i[0],this._activeTargets[t]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let e=0;for(const t of this._target)void 0!==this._originalValue[e]&&this._setValue(t,this._activeTargets[e],this._originalValue[e],-1,e),e++}else void 0!==this._originalValue[0]&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let e=0;e<this._events.length;e++)this._events[e].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray)for(let i=0;i<this._target.length;i++){const s=this._target[i];this._setValue(s,this._activeTargets[i],e,t,i)}else this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];t=i.getLocalMatrix&&"_matrix"===this._targetPath?i.getLocalMatrix():i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_setValue(e,t,i,s,n){if(this._currentActiveTarget=t,this._weight=s,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const e=t[this._targetPath];e.clone?this._originalBlendValue=e.clone():this._originalBlendValue=e}this._originalBlendValue.m?cr.AllowMatrixDecomposeForInterpolation?this._currentValue?Te.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=Te.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?Te.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=Te.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=cr._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const s=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=s}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:(null==i?void 0:i.clone)?this._currentValue=i.clone():this._currentValue=i;-1!==s?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[n]):this._animationState.loopMode===cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[n],t[this._targetPath]):t[this._targetPath]=this._originalValue[n]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const t=this._animation.getKeys();e<t[0].frame?e=t[0].frame:e>t[t.length-1].frame&&(e=t[t.length-1].frame);const i=this._events;if(i.length)for(let t=0;t<i.length;t++)i[t].onlyOnce||(i[t].isDone=i[t].frame<e);this._currentFrame=e;const s=this._animation._interpolate(e,this._animationState);this.setValue(s,-1)}_prepareForSpeedRatioChange(e){const t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,s,n,r=-1){const o=this._animation,a=o.targetPropertyPath;if(!a||a.length<1)return this._stopped=!0,!1;let l=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const h=i-t;let c,d,u=e*(o.framePerSecond*n)/1e3+this._absoluteFrameOffset,_=0;if(s&&this._animationState.loopMode===cr.ANIMATIONLOOPMODE_YOYO){const e=(u-t)/h;u=Math.abs(Math.sin(e*Math.PI))*h+t}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=u,!s&&i>=t&&u>=h)l=!1,_=o._getKeyValue(this._maxValue);else if(!s&&t>=i&&u<=h)l=!1,_=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==cr.ANIMATIONLOOPMODE_CYCLE){const e=i.toString()+t.toString();if(!this._offsetsCache[e]){this._animationState.repeatCount=0,this._animationState.loopMode=cr.ANIMATIONLOOPMODE_CYCLE;const s=o._interpolate(t,this._animationState),n=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case cr.ANIMATIONTYPE_FLOAT:this._offsetsCache[e]=n-s;break;case cr.ANIMATIONTYPE_QUATERNION:case cr.ANIMATIONTYPE_VECTOR3:case cr.ANIMATIONTYPE_VECTOR2:case cr.ANIMATIONTYPE_SIZE:case cr.ANIMATIONTYPE_COLOR3:this._offsetsCache[e]=n.subtract(s)}this._highLimitsCache[e]=n}_=this._highLimitsCache[e],c=this._offsetsCache[e]}if(void 0===c)switch(o.dataType){case cr.ANIMATIONTYPE_FLOAT:c=0;break;case cr.ANIMATIONTYPE_QUATERNION:c=sr;break;case cr.ANIMATIONTYPE_VECTOR3:c=nr;break;case cr.ANIMATIONTYPE_VECTOR2:c=rr;break;case cr.ANIMATIONTYPE_SIZE:c=or;break;case cr.ANIMATIONTYPE_COLOR3:c=ar;break;case cr.ANIMATIONTYPE_COLOR4:c=lr}if(this._host&&this._host.syncRoot){const e=this._host.syncRoot;d=t+h*((e.masterFrame-e.fromFrame)/(e.toFrame-e.fromFrame))}else d=u>0&&t>i||u<0&&t<i?l&&0!==h?i+u%h:t:l&&0!==h?t+u%h:i;const f=this._events;if(n>0&&this.currentFrame>d||n<0&&this.currentFrame<d){this._onLoop();for(let e=0;e<f.length;e++)f[e].onlyOnce||(f[e].isDone=!1);this._animationState.key=n>0?0:o.getKeys().length-1}this._currentFrame=d,this._animationState.repeatCount=0===h?0:u/h>>0,this._animationState.highLimitValue=_,this._animationState.offsetValue=c;const p=o._interpolate(d,this._animationState);if(this.setValue(p,r),f.length)for(let e=0;e<f.length;e++)if(h>0&&d>=f[e].frame&&f[e].frame>=t||h<0&&d<=f[e].frame&&f[e].frame<=t){const t=f[e];t.isDone||(t.onlyOnce&&(f.splice(e,1),e--),t.isDone=!0,t.action(d))}return l||(this._stopped=!0),l}}class go extends et{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){(e.updateFlag!==this._localMatrix.updateFlag||this._needToCompose)&&(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,s=null,n=null,r=null,o=null){var a;super(e,t.getScene()),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=null!==(a=null==s?void 0:s.clone())&&void 0!==a?a:Te.Identity(),this._restMatrix=null!=n?n:this._localMatrix.clone(),this._bindMatrix=null!=r?r:this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new Te,this._absoluteBindMatrix=new Te,this._absoluteInverseBindMatrix=new Te,this._finalMatrix=new Te,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const e=this.parent.children.indexOf(this);-1!==e&&this.parent.children.splice(e,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){var e;if(this._linkedTransformNode){const t=Ee.Vector3[0],i=Ee.Quaternion[0],s=Ee.Vector3[1];this.getRestMatrix().decompose(t,i,s),this._linkedTransformNode.position.copyFrom(s),this._linkedTransformNode.rotationQuaternion=null!==(e=this._linkedTransformNode.rotationQuaternion)&&void 0!==e?e:ve.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=me.Zero(),this._localRotation=ve.Zero(),this._localPosition=me.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){this._needToCompose&&(this._localScaling?(this._needToCompose=!1,Te.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)):this._needToCompose=!1)}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let e=0;e<this.children.length;e++)this.children[e]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=Js.LOCAL,i,s=!0){const n=this.getLocalMatrix();if(t==Js.LOCAL)s?(n.addAtIndex(12,e.x),n.addAtIndex(13,e.y),n.addAtIndex(14,e.z)):n.setTranslationFromFloats(e.x,e.y,e.z);else{let t=null;i&&(t=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=go._TmpMats[0],o=go._TmpVecs[0];this.parent?i&&t?(r.copyFrom(this.parent.getAbsoluteMatrix()),r.multiplyToRef(t,r)):r.copyFrom(this.parent.getAbsoluteMatrix()):Te.IdentityToRef(r),s&&r.setTranslationFromFloats(0,0,0),r.invert(),me.TransformCoordinatesToRef(e,r,o),s?(n.addAtIndex(12,o.x),n.addAtIndex(13,o.y),n.addAtIndex(14,o.z)):n.setTranslationFromFloats(o.x,o.y,o.z)}this._markAsDirtyAndDecompose()}translate(e,t=Js.LOCAL,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=Js.LOCAL,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,Js.WORLD,t)}scale(e,t,i,s=!1){const n=this.getLocalMatrix(),r=go._TmpMats[0];Te.ScalingToRef(e,t,i,r),r.multiplyToRef(n,n),r.invert();for(const s of this.children){const n=s.getLocalMatrix();n.multiplyToRef(r,n),n.multiplyAtIndex(12,e),n.multiplyAtIndex(13,t),n.multiplyAtIndex(14,i),s._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),s)for(const n of this.children)n.scale(e,t,i,s)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,s=Js.LOCAL,n){if(s===Js.LOCAL){const r=go._TmpQuat;return ve.RotationYawPitchRollToRef(e,t,i,r),void this.setRotationQuaternion(r,s,n)}const r=go._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,n))return;const o=go._TmpMats[1];Te.RotationYawPitchRollToRef(e,t,i,o),r.multiplyToRef(o,o),this._rotateWithMatrix(o,s,n)}rotate(e,t,i=Js.LOCAL,s){const n=go._TmpMats[0];n.setTranslationFromFloats(0,0,0),Te.RotationAxisToRef(e,t,n),this._rotateWithMatrix(n,i,s)}setAxisAngle(e,t,i=Js.LOCAL,s){if(i===Js.LOCAL){const n=go._TmpQuat;return ve.RotationAxisToRef(e,t,n),void this.setRotationQuaternion(n,i,s)}const n=go._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,s))return;const r=go._TmpMats[1];Te.RotationAxisToRef(e,t,r),n.multiplyToRef(r,r),this._rotateWithMatrix(r,i,s)}setRotation(e,t=Js.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=Js.LOCAL,i){if(t===Js.LOCAL)return this._decompose(),this._localRotation.copyFrom(e),void this._markAsDirtyAndCompose();const s=go._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const n=go._TmpMats[1];Te.FromQuaternionToRef(e,n),s.multiplyToRef(n,n),this._rotateWithMatrix(n,t,i)}setRotationMatrix(e,t=Js.LOCAL,i){if(t===Js.LOCAL){const s=go._TmpQuat;return ve.FromRotationMatrixToRef(e,s),void this.setRotationQuaternion(s,t,i)}const s=go._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const n=go._TmpMats[1];n.copyFrom(e),s.multiplyToRef(e,n),this._rotateWithMatrix(n,t,i)}_rotateWithMatrix(e,t=Js.LOCAL,i){const s=this.getLocalMatrix(),n=s.m[12],r=s.m[13],o=s.m[14],a=this.getParent(),l=go._TmpMats[3],h=go._TmpMats[4];a&&t==Js.WORLD?(i?(l.copyFrom(i.getWorldMatrix()),a.getAbsoluteMatrix().multiplyToRef(l,l)):l.copyFrom(a.getAbsoluteMatrix()),h.copyFrom(l),h.invert(),s.multiplyToRef(l,s),s.multiplyToRef(e,s),s.multiplyToRef(h,s)):t==Js.WORLD&&i?(l.copyFrom(i.getWorldMatrix()),h.copyFrom(l),h.invert(),s.multiplyToRef(l,s),s.multiplyToRef(e,s),s.multiplyToRef(h,s)):s.multiplyToRef(e,s),s.setTranslationFromFloats(n,r,o),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const i=go._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),Te.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):Te.IdentityToRef(i),e.invert(),!isNaN(e.m[0])&&(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=Js.LOCAL,t=null){const i=me.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=Js.LOCAL,t,i){if(e==Js.LOCAL){const e=this.getLocalMatrix();i.x=e.m[12],i.y=e.m[13],i.z=e.m[14]}else{let e=null;t&&(e=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let s=go._TmpMats[0];t&&e?(s.copyFrom(this.getAbsoluteMatrix()),s.multiplyToRef(e,s)):s=this.getAbsoluteMatrix(),i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}}getAbsolutePosition(e=null){const t=me.Zero();return this.getPositionToRef(Js.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(Js.WORLD,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const e=this._skeleton.getPoseMatrix();e&&this._absoluteMatrix.multiplyToRef(e,this._absoluteMatrix)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const i=me.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=go._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&s&&n.multiplyToRef(s,n),me.TransformNormalToRef(e,n,i),i.normalize()}getRotation(e=Js.LOCAL,t=null){const i=me.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=Js.LOCAL,t=null,i){const s=go._TmpQuat;this.getRotationQuaternionToRef(e,t,s),s.toEulerAnglesToRef(i)}getRotationQuaternion(e=Js.LOCAL,t=null){const i=ve.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=Js.LOCAL,t=null,i){if(e==Js.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{const e=go._TmpMats[0],s=this.getAbsoluteMatrix();t?s.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(s),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.decompose(void 0,i,void 0)}}getRotationMatrix(e=Js.LOCAL,t){const i=Te.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=Js.LOCAL,t,i){if(e==Js.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{const e=go._TmpMats[0],s=this.getAbsoluteMatrix();t?s.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(s),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=me.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=go._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&s&&n.multiplyToRef(s,n),me.TransformCoordinatesToRef(e,n,i)}getLocalPositionFromAbsolute(e,t=null){const i=me.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const n=go._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&s&&n.multiplyToRef(s,n),n.invert(),me.TransformCoordinatesToRef(e,n,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}}go._TmpVecs=le.BuildArray(2,me.Zero),go._TmpQuat=ve.Identity(),go._TmpMats=le.BuildArray(5,Te.Identity);class vo{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){this._weight=-1!==e?Math.min(Math.max(e,0),1):-1}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,null!==this._goToFrame&&this.goToFrame(this._goToFrame)}get elapsedTime(){return null===this._localDelayOffset?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,n=100,r=!1,o=1,a,l,h,c=!1,d=0){this.target=t,this.fromFrame=i,this.toFrame=n,this.loopAnimation=r,this.onAnimationEnd=a,this.onAnimationLoop=h,this.isAdditive=c,this.playOrder=d,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new s,this.onAnimationLoopObservable=new s,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=o,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const e=this._scene._activeAnimatables.indexOf(this);e>-1&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const s=t[i],n=new mo(e,s,this._scene,this);n._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(n)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const s=i[0].animation.framePerSecond;this._frameToSyncFromJump=null!==(t=this._frameToSyncFromJump)&&void 0!==t?t:i[0].currentFrame;const n=0===this.speedRatio?0:(e-this._frameToSyncFromJump)/s*1e3/this.speedRatio;this._manualJumpDelay=-n}for(let t=0;t<i.length;t++)i[t].goToFrame(e);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1){if(e||t){const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){const n=this._runtimeAnimations;for(let i=n.length-1;i>=0;i--){const s=n[i];e&&s.animation.name!=e||t&&!t(s.target)||(s.dispose(),n.splice(i,1))}0==n.length&&(i||this._scene._activeAnimatables.splice(s,1),this._raiseOnAnimationEnd())}}else{const e=this._scene._activeAnimatables.indexOf(this);if(e>-1){i||this._scene._activeAnimatables.splice(e,1);const t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].dispose();this._runtimeAnimations.length=0,this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise((e=>{this.onAnimationEndObservable.add((()=>{e(this)}),void 0,void 0,this,!0)}))}_animate(e){if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,0===this._weight)return!0;let t=!1;const i=this._runtimeAnimations;let s;for(s=0;s<i.length;s++){const n=i[s].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||n}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(s=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(s,1),s=0;s<i.length;s++)i[s].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}Oi.prototype._animate=function(){if(!this.animationsEnabled)return;const e=j.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=e}this.deltaTime=this.useConstantAnimationDeltaTime?16:(e-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=e;const t=this._activeAnimatables;if(0===t.length)return;this._animationTime+=this.deltaTime;const i=this._animationTime;for(let e=0;e<t.length;e++){const s=t[e];!s._animate(i)&&s.disposeOnEnd&&e--}this._processLateAnimationBindings()},Oi.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort(((e,t)=>e.playOrder-t.playOrder))},Oi.prototype.beginWeightedAnimation=function(e,t,i,s=1,n,r=1,o,a,l,h,c=!1){const d=this.beginAnimation(e,t,i,n,r,o,a,!1,l,h,c);return d.weight=s,d},Oi.prototype.beginAnimation=function(e,t,i,s,n=1,r,o,a=!0,l,h,c=!1){t>i&&n>0&&(n*=-1),a&&this.stopAnimation(e,void 0,l),o||(o=new vo(this,e,t,i,s,n,r,void 0,h,c));const d=!l||l(e);if(e.animations&&d&&o.appendAnimations(e,e.animations),e.getAnimatables){const c=e.getAnimatables();for(let e=0;e<c.length;e++)this.beginAnimation(c[e],t,i,s,n,r,o,a,l,h)}return o.reset(),o},Oi.prototype.beginHierarchyAnimation=function(e,t,i,s,n,r=1,o,a,l=!0,h,c,d=!1){const u=e.getDescendants(t),_=[];_.push(this.beginAnimation(e,i,s,n,r,o,a,l,h,void 0,d));for(const e of u)_.push(this.beginAnimation(e,i,s,n,r,o,a,l,h,void 0,d));return _},Oi.prototype.beginDirectAnimation=function(e,t,i,s,n,r,o,a,l=!1){if(void 0===r&&(r=1),i>s&&r>0)r*=-1;else if(s>i&&r<0){const e=s;s=i,i=e}return new vo(this,e,i,s,n,r,o,t,a,l)},Oi.prototype.beginDirectHierarchyAnimation=function(e,t,i,s,n,r,o,a,l,h=!1){const c=e.getDescendants(t),d=[];d.push(this.beginDirectAnimation(e,i,s,n,r,o,a,l,h));for(const e of c)d.push(this.beginDirectAnimation(e,i,s,n,r,o,a,l,h));return d},Oi.prototype.getAnimatableByTarget=function(e){for(let t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},Oi.prototype.getAllAnimatablesByTarget=function(e){const t=[];for(let i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i].target===e&&t.push(this._activeAnimatables[i]);return t},Oi.prototype.stopAnimation=function(e,t,i){const s=this.getAllAnimatablesByTarget(e);for(const e of s)e.stop(t,i)},Oi.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const e of this.animationGroups)e.stop()},Oi.prototype._registerTargetForLateAnimationBinding=function(e,t){const i=e.target;this._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[e.targetPath]||(i._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(i._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),i._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(i._lateAnimationHolders[e.targetPath].animations.push(e),i._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)},Oi.prototype._processLateAnimationBindingsForMatrices=function(e){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return e.originalValue;let t=1;const i=Ee.Vector3[0],s=Ee.Vector3[1],n=Ee.Quaternion[0];let r=0;const o=e.animations[0],a=e.originalValue;let l=1,h=!1;if(e.totalWeight<1)l=1-e.totalWeight,a.decompose(s,n,i);else{if(r=1,t=e.totalWeight,l=o.weight/t,1==l){if(!e.totalAdditiveWeight)return o.currentValue;h=!0}o.currentValue.decompose(s,n,i)}if(!h){s.scaleInPlace(l),i.scaleInPlace(l),n.scaleInPlace(l);for(let o=r;o<e.animations.length;o++){const r=e.animations[o];if(0===r.weight)continue;l=r.weight/t;const a=Ee.Vector3[2],h=Ee.Vector3[3],c=Ee.Quaternion[1];r.currentValue.decompose(h,c,a),h.scaleAndAddToRef(l,s),c.scaleAndAddToRef(ve.Dot(n,c)>0?l:-l,n),a.scaleAndAddToRef(l,i)}n.normalize()}for(let t=0;t<e.additiveAnimations.length;t++){const r=e.additiveAnimations[t];if(0===r.weight)continue;const o=Ee.Vector3[2],a=Ee.Vector3[3],l=Ee.Quaternion[1];r.currentValue.decompose(a,l,o),a.multiplyToRef(s,a),me.LerpToRef(s,a,r.weight,s),n.multiplyToRef(l,l),ve.SlerpToRef(n,l,r.weight,n),o.scaleAndAddToRef(r.weight,i)}const c=o?o._animationState.workValue:Ee.Matrix[0].clone();return Te.ComposeToRef(s,n,i,c),c},Oi.prototype._processLateAnimationBindingsForQuaternions=function(e,t){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return t;const i=e.animations[0],s=e.originalValue;let n=t;if(0===e.totalWeight&&e.totalAdditiveWeight>0)n.copyFrom(s);else if(1===e.animations.length){if(ve.SlerpToRef(s,i.currentValue,Math.min(1,e.totalWeight),n),0===e.totalAdditiveWeight)return n}else if(e.animations.length>1){let i,r,o=1;if(e.totalWeight<1){const t=1-e.totalWeight;i=[],r=[],i.push(s),r.push(t)}else{if(2===e.animations.length&&(ve.SlerpToRef(e.animations[0].currentValue,e.animations[1].currentValue,e.animations[1].weight/e.totalWeight,t),0===e.totalAdditiveWeight))return t;i=[],r=[],o=e.totalWeight}for(let t=0;t<e.animations.length;t++){const s=e.animations[t];i.push(s.currentValue),r.push(s.weight/o)}let a=0;for(let e=0;e<i.length;)e?(a+=r[e],ve.SlerpToRef(n,i[e],r[e]/a,n),e++):(ve.SlerpToRef(i[e],i[e+1],r[e+1]/(r[e]+r[e+1]),t),n=t,a=r[e]+r[e+1],e+=2)}for(let t=0;t<e.additiveAnimations.length;t++){const i=e.additiveAnimations[t];0!==i.weight&&(n.multiplyToRef(i.currentValue,Ee.Quaternion[0]),ve.SlerpToRef(n,Ee.Quaternion[0],i.weight,n))}return n},Oi.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let e=0;e<this._registeredForLateAnimationBindings.length;e++){const t=this._registeredForLateAnimationBindings.data[e];for(const e in t._lateAnimationHolders){const i=t._lateAnimationHolders[e],s=i.animations[0],n=i.originalValue;if(null==n)continue;const r=cr.AllowMatrixDecomposeForInterpolation&&n.m;let o=t[e];if(r)o=this._processLateAnimationBindingsForMatrices(i);else if(void 0!==n.w)o=this._processLateAnimationBindingsForQuaternions(i,o||ve.Identity());else{let e=0,t=1;const r=s&&s._animationState.loopMode===cr.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(i.totalWeight<1)o=r?n.clone?n.clone():n:s&&n.scale?n.scale(1-i.totalWeight):s?n*(1-i.totalWeight):n.clone?n.clone():n;else if(s){t=i.totalWeight;const a=s.weight/t;o=1!==a?s.currentValue.scale?s.currentValue.scale(a):s.currentValue*a:s.currentValue,r&&(o.addToRef?o.addToRef(n,o):o+=n),e=1}for(let s=e;s<i.animations.length;s++){const e=i.animations[s],n=e.weight/t;n&&(e.currentValue.scaleAndAddToRef?e.currentValue.scaleAndAddToRef(n,o):o+=e.currentValue*n)}for(let e=0;e<i.additiveAnimations.length;e++){const t=i.additiveAnimations[e],s=t.weight;s&&(t.currentValue.scaleAndAddToRef?t.currentValue.scaleAndAddToRef(s,o):o+=t.currentValue*s)}}t[e]=o}t._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},go.prototype.copyAnimationRange=function(e,t,i,s=!1,n=null){0===this.animations.length&&(this.animations.push(new cr(this.name,"_matrix",e.animations[0].framePerSecond,cr.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const r=e.animations[0].getRange(t);if(!r)return!1;const o=r.from,a=r.to,l=e.animations[0].getKeys(),h=e.length,c=e.getParent(),d=this.getParent(),u=s&&c&&h&&this.length&&h!==this.length,_=u&&d&&c?d.length/c.length:1,f=s&&!d&&n&&(1!==n.x||1!==n.y||1!==n.z),p=this.animations[0].getKeys();let m,g,v;for(let e=0,t=l.length;e<t;e++)m=l[e],m.frame>=o&&m.frame<=a&&(s?(v=m.value.clone(),u?(g=v.getTranslation(),v.setTranslation(g.scaleInPlace(_))):f&&n?(g=v.getTranslation(),v.setTranslation(g.multiplyInPlace(n))):v=m.value):v=m.value,p.push({frame:m.frame+i,value:v}));return this.animations[0].createRange(t,o+i,a+i),!0};class To{get isFixedFoveationSupported(){return"XRWebGLLayer"==this.layerType&&"number"==typeof this.layer.fixedFoveation}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}constructor(e,t,i,s,n){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=s,this.createRenderTargetTextureProvider=n}}class bo{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){const i=new a(this._engine,r.Unknown,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new Q(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,s,n,r){if(!this._engine)throw new Error("Engine is disposed");const o={width:e,height:t},a=r?new Kr(this._scene,o):new Ji("XR renderTargetTexture",o,this._scene),l=a.renderTarget;if(l._samples=a.samples,!i&&s||(l._framebuffer=i),s)if(r)l._colorTextureArray=s;else{const e=this._createInternalTexture(o,s);l.setTexture(e,0),a._texture=e}return n&&(r?l._depthStencilTextureArray=n:l._depthStencilTexture=this._createInternalTexture(o,n)),a.disableRescaling(),"undefined"!=typeof XRWebGLBinding&&(a.skipInitialClear=!0),this._renderTargetTextures.push(a),a}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach((e=>e.dispose())),this._renderTargetTextures.length=0}}class Eo extends To{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new So(e.scene,this))),this.layer=e}}class So extends bo{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){const i=this._layer.getViewport(t);if(!i)return!1;const s=this._framebufferDimensions.framebufferWidth,n=this._framebufferDimensions.framebufferHeight;return e.x=i.x/s,e.y=i.y/n,e.width=i.width/s,e.height=i.height/n,!0}getRenderTargetTextureForEye(e){const t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,s=this._layer.framebuffer;return this._rtt&&t===this._framebufferDimensions.framebufferWidth&&i===this._framebufferDimensions.framebufferHeight&&s===this._framebuffer||(this._rtt=this._createRenderTargetTexture(t,i,s),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=s),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class xo{static GetDefaults(e){const t=new xo;return t.canvasOptions={antialias:!0,depth:!0,stencil:!e||e.isStencilEnable,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class Co{constructor(e,t=xo.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new s,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce((()=>{this._engine=null})),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{const e=document.createElement("canvas");e.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(e)}e.onXRSessionInit.add((()=>{this._addCanvas()})),e.onXRSessionEnded.add((()=>{this._removeCanvas()}))}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null)}async initializeXRLayerAsync(e){const t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new Eo(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then((()=>{}),(()=>{Ot.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")})).then((()=>t())):Promise.resolve(t())}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce((()=>{this._setCanvasSize(!0)}))}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){this._canvas&&this._engine&&(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class yo extends To{constructor(e){super((()=>e.framebufferWidth),(()=>e.framebufferHeight),e,"XRWebGLLayer",(e=>new Ao(e,this))),this.layer=e}}class Ao extends bo{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class Ro{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class Io{constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new s,this.onXRReferenceSpaceChanged=new s,this.onXRSessionEnded=new s,this.onXRSessionInit=new s,this.inXRFrameLoop=!1,this.inXRSession=!1,this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce((()=>{this._engine=null})),e.onDisposeObservable.addOnce((()=>{this.dispose()}))}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){var e;this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),null===(e=this._engine)||void 0===e||e.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}exitXRAsync(){return this.session&&this.inXRSession?(this.inXRSession=!1,this.session.end().catch((()=>{p.Warn("Could not end XR session.")}))):Promise.resolve()}trySetViewportForView(e,t){var i;return(null===(i=this._baseLayerRTTProvider)||void 0===i?void 0:i.trySetViewportForView(e,t))||!1}getRenderTargetTextureForEye(e){var t;return(null===(t=this._baseLayerRTTProvider)||void 0===t?void 0:t.getRenderTargetTextureForEye(e))||null}getRenderTargetTextureForView(e){var t;return(null===(t=this._baseLayerRTTProvider)||void 0===t?void 0:t.getRenderTargetTextureForView(e))||null}getWebXRRenderTarget(e){const t=this.scene.getEngine();return this._xrNavigator.xr.native?new Ro(this):((e=e||xo.GetDefaults(t)).canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new Co(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then((t=>(this.session=t,this._sessionMode=e,this.onXRSessionInit.notifyObservers(t),this.inXRSession=!0,this.session.addEventListener("end",(()=>{var e;this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&(null===(e=this._baseLayerRTTProvider)||void 0===e||e.dispose()),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null}),{once:!0}),this.session)))}isSessionSupportedAsync(e){return Io.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){var e;this.inXRSession&&this._engine&&(this._engine.customAnimationFrameRequester={requestAnimationFrame:e=>this.session.requestAnimationFrame(e),renderFunction:(e,t)=>{var i;this.inXRSession&&this._engine&&(this.currentFrame=t,this.currentTimestamp=e,t&&(this.inXRFrameLoop=!0,this._engine.framebufferDimensionsObject=(null===(i=this._baseLayerRTTProvider)||void 0===i?void 0:i.getFramebufferDimensions())||null,this.onXRFrameObservable.notifyObservers(t),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1))}},this._engine.framebufferDimensionsObject=(null===(e=this._baseLayerRTTProvider)||void 0===e?void 0:e.getFramebufferDimensions())||null,"undefined"!=typeof window&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then((e=>e),(e=>(p.Error("XR.requestReferenceSpace failed for the following reason: "),p.Error(e),p.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then((e=>{const t=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return e.getOffsetReferenceSpace(t)}),(e=>{throw p.Error(e),'XR initialization failed: required "viewer" reference space type not supported.'}))))).then((e=>this.session.requestReferenceSpace("viewer").then((t=>(this.viewerReferenceSpace=t,e))))).then((e=>(this.referenceSpace=this.baseReferenceSpace=e,this.referenceSpace)))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){var t,i;this.isNative&&(null===(t=this._baseLayerRTTProvider)||void 0===t||t.dispose()),this._baseLayerWrapper=e,this._baseLayerRTTProvider=(null===(i=this._baseLayerWrapper)||void 0===i?void 0:i.createRenderTargetTextureProvider(this))||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new yo(e.baseLayer):new Eo(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);const t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then((e=>{const t=void 0===e||e;return Promise.resolve(t)})).catch((e=>(p.Warn(e),Promise.resolve(!1)))):Promise.resolve(!1)}get isNative(){var e;return null!==(e=this._xrNavigator.xr.native)&&void 0!==e&&e}get currentFrameRate(){var e;return null===(e=this.session)||void 0===e?void 0:e.frameRate}get supportedFrameRates(){var e;return null===(e=this.session)||void 0===e?void 0:e.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():!this.inXRSession&&t||this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){var e;return(null===(e=this._baseLayerWrapper)||void 0===e?void 0:e.isFixedFoveationSupported)||!1}get fixedFoveation(){var e;return(null===(e=this._baseLayerWrapper)||void 0===e?void 0:e.fixedFoveation)||null}set fixedFoveation(e){const t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}get enabledFeatures(){var e,t;return null!==(t=null===(e=this.session)||void 0===e?void 0:e.enabledFeatures)&&void 0!==t?t:null}}function Po(e){const t=[],i=[],s=[],n=[],r=e.diameter||1,o=e.thickness||.5,a=0|(e.tessellation||16),l=0===e.sideOrientation?0:e.sideOrientation||Nn.DEFAULTSIDE,h=a+1;for(let e=0;e<=a;e++){const l=e/a,c=e*Math.PI*2/a-Math.PI/2,d=Te.Translation(r/2,0,0).multiply(Te.RotationY(c));for(let r=0;r<=a;r++){const c=1-r/a,u=r*Math.PI*2/a+Math.PI,_=Math.cos(u),f=Math.sin(u);let p=new me(_,f,0),m=p.scale(o/2);const g=new pe(l,c);m=me.TransformCoordinates(m,d),p=me.TransformNormal(p,d),i.push(m.x,m.y,m.z),s.push(p.x,p.y,p.z),n.push(g.x,Gi.UseOpenGLOrientationForUV?1-g.y:g.y);const v=(e+1)%h,T=(r+1)%h;t.push(e*h+r),t.push(e*h+T),t.push(v*h+r),t.push(e*h+T),t.push(v*h+T),t.push(v*h+r)}}Nn._ComputeSides(l,i,t,s,n,e.frontUVs,e.backUVs);const c=new Nn;return c.indices=t,c.positions=i,c.normals=s,c.uvs=n,c}function Mo(e,t={},i){const s=new jn(e,i);return t.sideOrientation=jn._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Po(t).applyToMesh(s,t.updatable),s}!function(e){e[e.ENTERING_XR=0]="ENTERING_XR",e[e.EXITING_XR=1]="EXITING_XR",e[e.IN_XR=2]="IN_XR",e[e.NOT_IN_XR=3]="NOT_IN_XR"}(ro||(ro={})),function(e){e[e.NOT_TRACKING=0]="NOT_TRACKING",e[e.TRACKING_LOST=1]="TRACKING_LOST",e[e.TRACKING=2]="TRACKING"}(oo||(oo={})),Nn.CreateTorus=Po,jn.CreateTorus=(e,t,i,s,n,r,o)=>Mo(e,{diameter:t,thickness:i,tessellation:s,sideOrientation:o,updatable:r},n);class Oo{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=Oo._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=Mo("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const t=new zs("targetMat",e);t.specularColor=Re.Black(),t.emissiveColor=new Re(.7,.7,.7),t.backFaceCulling=!1,this._gazeTracker.material=t}}_getForwardRay(e){return new lo(me.Zero(),new me(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}Oo._IdCounter=0;class Do extends Oo{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new lo(me.Zero(),me.Forward())}}class No{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(e,t={}){if(this.webVROptions=t,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new s,this.onAfterEnteringVRObservable=new s,this.onExitingVRObservable=new s,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=No.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new me(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new me(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new Re(.2,.2,1),this._pickedGazeColor=new Re(0,0,1),this.onNewMeshSelected=new s,this.onNewMeshPicked=new s,this.onBeforeCameraTeleport=new s,this.onAfterCameraTeleport=new s,this.onSelectedMeshUnselected=new s,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=e=>{e.type!==Jr.POSE_ENABLED&&(e.leftStick&&e.onleftstickchanged((e=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(e,this._cameraGazer),this._checkTeleportBackwards(e,this._cameraGazer))})),e.rightStick&&e.onrightstickchanged((e=>{this._teleportationInitialized&&this._checkRotate(e,this._cameraGazer)})),e.type===Jr.XBOX&&(e.onbuttondown((e=>{this._interactionsEnabled&&e===to.A&&this._cameraGazer._selectionPointerDown()})),e.onbuttonup((e=>{this._interactionsEnabled&&e===to.A&&this._cameraGazer._selectionPointerUp()}))))},this._workingVector=me.Zero(),this._workingQuaternion=ve.Identity(),this._workingMatrix=Te.Identity(),p.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),"getVRDisplays"in navigator||void 0!==t.useXR||(t.useXR=!0),void 0===t.createFallbackVRDeviceOrientationFreeCamera&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),void 0===t.createDeviceOrientationCamera&&(t.createDeviceOrientationCamera=!0),void 0===t.laserToggle&&(t.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new me(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new Xr("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof _r&&this._scene.activeCamera.rotation)){const e=this._scene.activeCamera;e.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(e.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(ve.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z)),this._deviceOrientationCamera.rotation=e.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?Io.IsSessionSupportedAsync("immersive-vr").then((i=>{i?(p.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then((t=>{this.xr=t,this.xrTestDone=!0,this._cameraGazer=new Do((()=>this.xr.baseExperience.camera),e),this.xr.baseExperience.onStateChangedObservable.add((e=>{switch(e){case ro.ENTERING_XR:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case ro.EXITING_XR:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case ro.IN_XR:this._hasEnteredVR=!0;break;case ro.NOT_IN_XR:this._hasEnteredVR=!1}}))}))):this._completeVRInit(e,t)})):this._completeVRInit(e,t)}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new Zr("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new Do((()=>this.currentVRCamera),e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let e=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";e+=".babylonVRicon.vrdisplaypresenting { display: none; }";const t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",(()=>{this.isInVRMode||this.enterVR()}));const i=this._scene.getEngine().getHostWindow();i&&(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=e=>{27===e.keyCode&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add((()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())}),ci.POINTERDOUBLETAP,!1),e.onDisposeObservable.add((()=>{this.dispose()})),this._updateButtonVisibility(),this._circleEase=new Zn,this._circleEase.setEasingMode(qn.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add((t=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&"mouse"===t.event.pointerType&&(t.type===ci.POINTERDOWN?this._cameraGazer._selectionPointerDown():t.type===ci.POINTERUP&&this._cameraGazer._selectionPointerUp())})),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===ro.IN_XR||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){this._useCustomVRButton||this._btnVRDisplayed||!this._btnVR||(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){this._btnVR&&!this._useCustomVRButton&&(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr)this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);else{if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){p.Warn("Error in your custom logic onEnteringVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=ve.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce((()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})}))),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}}exitVR(){if(this.xr)this.xr.baseExperience.exitXRAsync();else if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){p.Warn("Error in your custom logic onExitingVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr)return void(this.xr.baseExperience.state===ro.IN_XR&&this.xr.pointerSelection.attach());this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>!!(this._isTeleportationFloor(e)||-1===e.name.indexOf("gazeTracker")&&-1===e.name.indexOf("teleportationTarget")&&-1===e.name.indexOf("torusTeleportation"))&&this.raySelectionPredicate(e),this._interactionsEnabled=!0}}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!(!this._floorMeshName||e.name!==this._floorMeshName)}addFloorMesh(e){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e))}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const t=this._floorMeshesCollection.indexOf(e);-1!==t&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const t=e.floorMeshes||[];if(!t.length){const i=this._scene.getMeshByName(e.floorMeshName);i&&t.push(i)}if(this.xr)return t.forEach((e=>{this.xr.teleportation.addFloorMesh(e)})),void(this.xr.teleportation.attached||this.xr.teleportation.attach());if(!this.xrTestDone){const t=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(t),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};return void this._scene.registerBeforeRender(t)}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),void 0!==e.easingFunction&&(this._teleportationEasing=e.easingFunction);const t=new Yt;t.vignetteColor=new Ie(0,0,0,0),t.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(e,t){this._teleportationRequestInitiated&&!t._teleportationRequestInitiated||(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){t._teleportationRequestInitiated||(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;const e=ve.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),i=this.currentVRCamera.position;e.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,ve.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),me.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const s=new lo(i,this._workingVector),n=this._scene.pickWithRay(s,this._raySelectionPredicate);n&&n.pickedPoint&&n.pickedMesh&&this._isTeleportationFloor(n.pickedMesh)&&n.distance<5&&this.teleportCamera(n.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}_createTeleportationCircles(){this._teleportationTarget=Dr("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=new ho("DynamicTexture",512,this._scene,!0);e.hasAlpha=!0;const t=e.getContext();t.beginPath(),t.arc(256,256,200,0,2*Math.PI,!1),t.fillStyle=this._teleportationFillColor,t.fill(),t.lineWidth=10,t.strokeStyle=this._teleportationBorderColor,t.stroke(),t.closePath(),e.update();const i=new zs("TextPlaneMaterial",this._scene);i.diffuseTexture=e,this._teleportationTarget.material=i;const s=Mo("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);s.isPickable=!1,s.parent=this._teleportationTarget;const n=new cr("animationInnerCircle","position.y",30,cr.ANIMATIONTYPE_FLOAT,cr.ANIMATIONLOOPMODE_CYCLE),r=[];r.push({frame:0,value:0}),r.push({frame:30,value:.4}),r.push({frame:60,value:0}),n.setKeys(r);const o=new er;o.setEasingMode(qn.EASINGMODE_EASEINOUT),n.setEasingFunction(o),s.animations=[],s.animations.push(n),this._scene.beginAnimation(s,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof Hr))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const t=ve.FromRotationMatrix(Te.RotationY(Math.PI/4*this._rotationAngle)),i=new cr("animationRotation","rotationQuaternion",90,cr.ANIMATIONTYPE_QUATERNION,cr.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),s.push({frame:6,value:t}),i.setKeys(s),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];const n=new cr("animationPP","vignetteWeight",90,cr.ANIMATIONTYPE_FLOAT,cr.ANIMATIONLOOPMODE_CONSTANT),r=[];r.push({frame:0,value:0}),r.push({frame:3,value:4}),r.push({frame:6,value:0}),n.setKeys(r),n.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(n);const o=new cr("animationPP2","vignetteStretch",90,cr.ANIMATIONTYPE_FLOAT,cr.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:3,value:10}),a.push({frame:6,value:0}),o.setKeys(a),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(e){if(!(this.currentVRCamera instanceof Hr))return;let t,i;if(this._workingVector.copyFrom(e),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector),this._teleportationMode==No.TELEPORTATIONMODE_CONSTANTSPEED){i=90;const e=me.Distance(this.currentVRCamera.position,this._workingVector);t=this._teleportationSpeed/e}else i=Math.round(90*this._teleportationTime/1e3),t=1;this.currentVRCamera.animations=[];const s=new cr("animationCameraTeleportation","position",90,cr.ANIMATIONTYPE_VECTOR3,cr.ANIMATIONLOOPMODE_CONSTANT),n=[{frame:0,value:this.currentVRCamera.position},{frame:i,value:this._workingVector}];s.setKeys(n),s.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(s),this._postProcessMove.animations=[];const r=Math.round(i/2),o=new cr("animationPP","vignetteWeight",90,cr.ANIMATIONTYPE_FLOAT,cr.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:r,value:8}),a.push({frame:i,value:0}),o.setKeys(a),this._postProcessMove.animations.push(o);const l=new cr("animationPP2","vignetteStretch",90,cr.ANIMATIONTYPE_FLOAT,cr.ANIMATIONLOOPMODE_CONSTANT),h=[];h.push({frame:0,value:0}),h.push({frame:r,value:10}),h.push({frame:i,value:0}),l.setKeys(h),this._postProcessMove.animations.push(l),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,i,!1,t,(()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)})),this._hideTeleportationTarget()}setLaserColor(e,t=this._pickedLaserColor){this._pickedLaserColor=t}setLaserLightingState(e=!0){}setGazeColor(e,t=this._pickedGazeColor){this._pickedGazeColor=t}changeLaserColor(e){this.updateControllerLaserColor}changeGazeColor(e){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=e)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}No.TELEPORTATIONMODE_CONSTANTTIME=0,No.TELEPORTATIONMODE_CONSTANTSPEED=1;const Fo=131072,Lo=131072;function wo(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const Bo=wo("DXT1"),Uo=wo("DXT3"),ko=wo("DXT5"),Vo=wo("DX10");class Go{static GetDDSInfo(e){const t=new Int32Array(e.buffer,e.byteOffset,31),i=new Int32Array(e.buffer,e.byteOffset,35);let s=1;t[2]&Fo&&(s=Math.max(1,t[7]));const n=t[21],r=n===Vo?i[32]:0;let o=0;switch(n){case 113:o=2;break;case 116:o=1;break;case Vo:if(10===r){o=2;break}if(2===r){o=1;break}}return{width:t[4],height:t[3],mipmapCount:s,isFourCC:4==(4&t[20]),isRGB:64==(64&t[20]),isLuminance:(t[20]&Lo)===Lo,isCube:512==(512&t[28]),isCompressed:n===Bo||n===Uo||n===ko,dxgiFormat:r,textureType:o}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,i,s,n,r){const o=new Float32Array(s),a=new Uint16Array(n,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[l]=Ys(a[s]),o[l+1]=Ys(a[s+1]),o[l+2]=Ys(a[s+2]),Go.StoreLODInAlphaChannel?o[l+3]=r:o[l+3]=Ys(a[s+3]),l+=4}return o}static _GetHalfFloatRGBAArrayBuffer(e,t,i,s,n,r){if(Go.StoreLODInAlphaChannel){const o=new Uint16Array(s),a=new Uint16Array(n,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[l]=a[s],o[l+1]=a[s+1],o[l+2]=a[s+2],o[l+3]=Qs(r),l+=4}return o}return new Uint16Array(n,i,s)}static _GetFloatRGBAArrayBuffer(e,t,i,s,n,r){if(Go.StoreLODInAlphaChannel){const o=new Float32Array(s),a=new Float32Array(n,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[l]=a[s],o[l+1]=a[s+1],o[l+2]=a[s+2],o[l+3]=r,l+=4}return o}return new Float32Array(n,i,s)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,i,s,n,r){const o=new Uint16Array(s),a=new Float32Array(n,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++)o[l]=Qs(a[l]),o[l+1]=Qs(a[l+1]),o[l+2]=Qs(a[l+2]),Go.StoreLODInAlphaChannel?o[l+3]=Qs(r):o[l+3]=Qs(a[l+3]),l+=4;return o}static _GetFloatAsUIntRGBAArrayBuffer(e,t,i,s,n,r){const o=new Uint8Array(s),a=new Float32Array(n,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[l]=255*ne.Clamp(a[s]),o[l+1]=255*ne.Clamp(a[s+1]),o[l+2]=255*ne.Clamp(a[s+2]),Go.StoreLODInAlphaChannel?o[l+3]=r:o[l+3]=255*ne.Clamp(a[s+3]),l+=4}return o}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,i,s,n,r){const o=new Uint8Array(s),a=new Uint16Array(n,i);let l=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);o[l]=255*ne.Clamp(Ys(a[s])),o[l+1]=255*ne.Clamp(Ys(a[s+1])),o[l+2]=255*ne.Clamp(Ys(a[s+2])),Go.StoreLODInAlphaChannel?o[l+3]=r:o[l+3]=255*ne.Clamp(Ys(a[s+3])),l+=4}return o}static _GetRGBAArrayBuffer(e,t,i,s,n,r,o,a,l){const h=new Uint8Array(s),c=new Uint8Array(n,i);let d=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=4*(t+i*e);h[d]=c[s+r],h[d+1]=c[s+o],h[d+2]=c[s+a],h[d+3]=c[s+l],d+=4}return h}static _ExtractLongWordOrder(e){return 0===e||255===e||-16777216===e?0:1+Go._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,i,s,n,r,o,a){const l=new Uint8Array(s),h=new Uint8Array(n,i);let c=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=3*(t+i*e);l[c]=h[s+r],l[c+1]=h[s+o],l[c+2]=h[s+a],c+=3}return l}static _GetLuminanceArrayBuffer(e,t,i,s,n){const r=new Uint8Array(s),o=new Uint8Array(n,i);let a=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=t+i*e;r[a]=o[s],a++}return r}static UploadDDSLevels(e,t,i,s,n,r,o=-1,a,l=!0){let h=null;s.sphericalPolynomial&&(h=[]);const c=!!e.getCaps().s3tc;t.generateMipMaps=n;const d=new Int32Array(i.buffer,i.byteOffset,31);let u,_,f,m,g,v,T,b=0,E=0,S=1;if(542327876!==d[0])return void p.Error("Invalid magic number in DDS header");if(!s.isFourCC&&!s.isRGB&&!s.isLuminance)return void p.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(s.isCompressed&&!c)return void p.Error("Compressed textures are not supported on this platform.");let x=d[22];m=d[1]+4;let C=!1;if(s.isFourCC)switch(u=d[21],u){case Bo:S=8,E=33777;break;case Uo:S=16,E=33778;break;case ko:S=16,E=33779;break;case 113:C=!0,x=64;break;case 116:C=!0,x=128;break;case Vo:{m+=20;let e=!1;switch(s.dxgiFormat){case 10:C=!0,x=64,e=!0;break;case 2:C=!0,x=128,e=!0;break;case 88:s.isRGB=!0,s.isFourCC=!1,x=32,e=!0}if(e)break}default:return void p.Error(["Unsupported FourCC code:",(y=u,String.fromCharCode(255&y,y>>8&255,y>>16&255,y>>24&255))])}var y;const A=Go._ExtractLongWordOrder(d[23]),R=Go._ExtractLongWordOrder(d[24]),I=Go._ExtractLongWordOrder(d[25]),P=Go._ExtractLongWordOrder(d[26]);C&&(E=e._getRGBABufferInternalSizedFormat(s.textureType)),v=1,d[2]&Fo&&!1!==n&&(v=Math.max(1,d[7]));const M=a||0,O=e.getCaps();for(let n=M;n<r;n++){for(_=d[4],f=d[3],T=0;T<v;++T){if(-1===o||o===T){const r=-1===o?T:0;if(!s.isCompressed&&s.isFourCC){t.format=5,b=_*f*4;let s=null;if(e._badOS||e._badDesktopOS||!O.textureHalfFloat&&!O.textureFloat)128===x?(s=Go._GetFloatAsUIntRGBAArrayBuffer(_,f,i.byteOffset+m,b,i.buffer,r),h&&0==r&&h.push(Go._GetFloatRGBAArrayBuffer(_,f,i.byteOffset+m,b,i.buffer,r))):64===x&&(s=Go._GetHalfFloatAsUIntRGBAArrayBuffer(_,f,i.byteOffset+m,b,i.buffer,r),h&&0==r&&h.push(Go._GetHalfFloatAsFloatRGBAArrayBuffer(_,f,i.byteOffset+m,b,i.buffer,r))),t.type=0;else{const e=O.textureFloat&&(l&&O.textureFloatLinearFiltering||!l),n=O.textureHalfFloat&&(l&&O.textureHalfFloatLinearFiltering||!l),o=(128===x||64===x&&!n)&&e?1:(64===x||128===x&&!e)&&n?2:0;let a,c=null;if(128===x)switch(o){case 1:a=Go._GetFloatRGBAArrayBuffer,c=null;break;case 2:a=Go._GetFloatAsHalfFloatRGBAArrayBuffer,c=Go._GetFloatRGBAArrayBuffer;break;case 0:a=Go._GetFloatAsUIntRGBAArrayBuffer,c=Go._GetFloatRGBAArrayBuffer}else switch(o){case 1:a=Go._GetHalfFloatAsFloatRGBAArrayBuffer,c=null;break;case 2:a=Go._GetHalfFloatRGBAArrayBuffer,c=Go._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:a=Go._GetHalfFloatAsUIntRGBAArrayBuffer,c=Go._GetHalfFloatAsFloatRGBAArrayBuffer}t.type=o,s=a(_,f,i.byteOffset+m,b,i.buffer,r),h&&0==r&&h.push(c?c(_,f,i.byteOffset+m,b,i.buffer,r):s)}s&&e._uploadDataToTextureDirectly(t,s,n,r)}else if(s.isRGB)t.type=0,24===x?(t.format=4,b=_*f*3,g=Go._GetRGBArrayBuffer(_,f,i.byteOffset+m,b,i.buffer,A,R,I),e._uploadDataToTextureDirectly(t,g,n,r)):(t.format=5,b=_*f*4,g=Go._GetRGBAArrayBuffer(_,f,i.byteOffset+m,b,i.buffer,A,R,I,P),e._uploadDataToTextureDirectly(t,g,n,r));else if(s.isLuminance){const s=e._getUnpackAlignement(),o=_;b=Math.floor((_+s-1)/s)*s*(f-1)+o,g=Go._GetLuminanceArrayBuffer(_,f,i.byteOffset+m,b,i.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,g,n,r)}else b=Math.max(4,_)/4*Math.max(4,f)/4*S,g=new Uint8Array(i.buffer,i.byteOffset+m,b),t.type=0,e._uploadCompressedDataToTextureDirectly(t,E,_,f,g,n,r)}m+=x?_*f*(x/8):b,_*=.5,f*=.5,_=Math.max(1,_),f=Math.max(1,f)}if(void 0!==a)break}h&&h.length>0?s.sphericalPolynomial=_n.ConvertCubeMapToSphericalPolynomial({size:d[4],right:h[0],left:h[1],up:h[2],down:h[3],front:h[4],back:h[5],format:5,type:1,gammaSpace:!1}):s.sphericalPolynomial=void 0}}Go.StoreLODInAlphaChannel=!1,q.prototype.createPrefilteredCubeTexture=function(e,t,i,s,n=null,o=null,l,h=null,c=!0){return this.createCubeTexture(e,t,null,!1,(e=>{if(!e)return void(n&&n(null));const o=e.texture;if(c?e.info.sphericalPolynomial&&(o._sphericalPolynomial=e.info.sphericalPolynomial):o._sphericalPolynomial=new dn,o._source=r.CubePrefiltered,this.getCaps().textureLOD)return void(n&&n(o));const l=this._gl,h=e.width;if(!h)return;const d=[];for(let n=0;n<3;n++){const c=1-n/2,u=s,_=ne.Log2(h)*i+s,f=u+(_-u)*c,m=Math.round(Math.min(Math.max(f,0),_)),g=new a(this,r.Temp);if(g.type=o.type,g.format=o.format,g.width=Math.pow(2,Math.max(ne.Log2(h)-m,0)),g.height=g.width,g.isCube=!0,g._cachedWrapU=0,g._cachedWrapV=0,this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,g,!0),g.samplingMode=2,l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),e.isDDS){const t=e.info,i=e.data;this._unpackFlipY(t.isCompressed),Go.UploadDDSLevels(this,g,i,t,!0,6,m)}else p.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null);const v=new ki(t);v._isCube=!0,v._texture=g,g.isReady=!0,d.push(v)}o._lodTextureHigh=d[2],o._lodTextureMid=d[1],o._lodTextureLow=d[0],n&&n(o)}),o,l,h,c,i,s)},te._TextureLoaders.push(new class{constructor(){this.supportCascades=!0}canLoad(e){return e.endsWith(".dds")}loadCubeData(e,t,i,s){const n=t.getEngine();let r,o=!1,a=1e3;if(Array.isArray(e))for(let i=0;i<e.length;i++){const s=e[i];r=Go.GetDDSInfo(s),t.width=r.width,t.height=r.height,o=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&t.generateMipMaps,n._unpackFlipY(r.isCompressed),Go.UploadDDSLevels(n,t,s,r,o,6,-1,i),r.isFourCC||1!==r.mipmapCount?a=r.mipmapCount-1:n.generateMipMapsForCubemap(t)}else{const s=e;r=Go.GetDDSInfo(s),t.width=r.width,t.height=r.height,i&&(r.sphericalPolynomial=new dn),o=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&t.generateMipMaps,n._unpackFlipY(r.isCompressed),Go.UploadDDSLevels(n,t,s,r,o,6),r.isFourCC||1!==r.mipmapCount?a=r.mipmapCount-1:n.generateMipMapsForCubemap(t,!1)}n._setCubeMapTextureParams(t,o,a),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s({isDDS:!0,width:t.width,info:r,data:e,texture:t})}loadData(e,t,i){const s=Go.GetDDSInfo(e),n=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&t.generateMipMaps&&s.width>>s.mipmapCount-1==1;i(s.width,s.height,n,s.isFourCC,(()=>{Go.UploadDDSLevels(t.getEngine(),t,e,s,n,1)}))}});F.ShadersStore.rgbdEncodePixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}";const zo="image/png",Ho=2,Wo=[134,22,135,150,246,214,150,54];function Xo(e){if(e.version>Ho)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${Ho}".`);return 2===e.version?e:e=Object.assign(Object.assign({},e),{version:2,imageType:zo})}function Qo(e,t,i){const s=(i=Xo(i)).specular;return s?(e._lodGenerationScale=s.lodGenerationScale,function(e,t,i=zo){if(!Ot.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const s=ne.ILog2(e.width)+1,n=e.getEngine();let o=!1,l=!1,h=null,c=null,d=null;const u=n.getCaps();if(e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,e),u.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?u.textureHalfFloatRender&&u.textureHalfFloatLinearFiltering?(o=!0,e.type=2):u.textureFloatRender&&u.textureFloatLinearFiltering&&(o=!0,e.type=1):o=!1:(o=!1,l=!0,d={}),o)h=new es("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,e.type,void 0,null,!1),e._isRGBD=!1,e.invertY=!1,c=n.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,l){const t=3,i=e._lodGenerationScale,o=e._lodGenerationOffset;for(let l=0;l<t;l++){const h=(s-1)*i+o,c=o+(h-o)*(1-l/(t-1)),u=Math.round(Math.min(Math.max(c,0),h)),_=new a(n,r.Temp);_.isCube=!0,_.invertY=!0,_.generateMipMaps=!1,n.updateTextureSamplingMode(2,_);const f=new ki(null);switch(f._isCube=!0,f._texture=_,d[u]=f,l){case 0:e._lodTextureLow=f;break;case 1:e._lodTextureMid=f;break;case 2:e._lodTextureHigh=f}}}const _=[];for(let s=0;s<t.length;s++)for(let r=0;r<6;r++){const a=t[s][r],u=new Blob([a],{type:i}),f=URL.createObjectURL(u);let p;if(n._features.forceBitmapOverHTMLImageElement)p=n.createImageBitmap(u,{premultiplyAlpha:"none"}).then((t=>Yo(t,n,o,h,f,r,s,l,d,c,e)));else{const t=new Image;t.src=f,p=new Promise(((i,a)=>{t.onload=()=>{Yo(t,n,o,h,f,r,s,l,d,c,e).then((()=>i())).catch((e=>{a(e)}))},t.onerror=e=>{a(e)}}))}_.push(p)}if(t.length<s){let i;const r=Math.pow(2,s-1-t.length),o=r*r*4;switch(e.type){case 0:i=new Uint8Array(o);break;case 2:i=new Uint16Array(o);break;case 1:i=new Float32Array(o)}for(let r=t.length;r<s;r++)for(let t=0;t<6;t++)n._uploadArrayBufferViewToTexture(e,i,t,r)}return Promise.all(_).then((()=>{c&&(n._releaseTexture(e),c._swapAndDie(e)),h&&h.dispose(),l&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}))}(e,function(e,t){const i=(t=Xo(t)).specular;let s=ne.Log2(t.width);if(s=Math.round(s)+1,i.mipmaps.length!==6*s)throw new Error(`Unsupported specular mipmaps number "${i.mipmaps.length}"`);const n=new Array(s);for(let t=0;t<s;t++){n[t]=new Array(6);for(let s=0;s<6;s++){const r=i.mipmaps[6*t+s];n[t][s]=new Uint8Array(e.buffer,e.byteOffset+i.specularDataPosition+r.position,r.length)}}return n}(t,i),i.imageType)):Promise.resolve()}function Yo(e,t,i,s,n,r,o,a,l,h,c){return new Promise(((d,u)=>{if(i){const i=t.createTexture(null,!0,!0,null,1,null,(e=>{u(e)}),e);s.getEffect().executeWhenCompiled((()=>{s.externalTextureSamplerBinding=!0,s.onApply=s=>{s._bindTexture("textureSampler",i),s.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([s],h,!0,r,o),t.restoreDefaultFramebuffer(),i.dispose(),URL.revokeObjectURL(n),d())}))}else{if(t._uploadImageToTexture(c,e,r,o),a){const i=l[o];i&&t._uploadImageToTexture(i._texture,e,r,0)}d()}}))}te._TextureLoaders.push(new class{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".env")}loadCubeData(e,t,i,s,n){if(Array.isArray(e))return;const r=function(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let i=0;for(let e=0;e<Wo.length;e++)if(t.getUint8(i++)!==Wo[e])return p.Error("Not a babylon environment map"),null;let s="",n=0;for(;n=t.getUint8(i++);)s+=String.fromCharCode(n);let r=JSON.parse(s);return r=Xo(r),r.specular&&(r.specular.specularDataPosition=i,r.specular.lodGenerationScale=r.specular.lodGenerationScale||.8),r}(e);if(r){t.width=r.width,t.height=r.width;try{(function(e,t){const i=(t=Xo(t)).irradiance;if(!i)return;const s=new dn;me.FromArrayToRef(i.x,0,s.x),me.FromArrayToRef(i.y,0,s.y),me.FromArrayToRef(i.z,0,s.z),me.FromArrayToRef(i.xx,0,s.xx),me.FromArrayToRef(i.yy,0,s.yy),me.FromArrayToRef(i.zz,0,s.zz),me.FromArrayToRef(i.yz,0,s.yz),me.FromArrayToRef(i.zx,0,s.zx),me.FromArrayToRef(i.xy,0,s.xy),e._sphericalPolynomial=s})(t,r),Qo(t,e,r).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}),(e=>{null==n||n("Can not upload environment levels",e)}))}catch(e){null==n||n("Can not upload environment file",e)}}else n&&n("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}});class Ko{constructor(e,t){if(this.data=e,this.isInvalid=!1,!Ko.IsValid(e))return this.isInvalid=!0,void p.Error("texture missing KTX identifier");const i=Uint32Array.BYTES_PER_ELEMENT,s=new DataView(this.data.buffer,this.data.byteOffset+12,13*i),n=67305985===s.getUint32(0,!0);return this.glType=s.getUint32(1*i,n),this.glTypeSize=s.getUint32(2*i,n),this.glFormat=s.getUint32(3*i,n),this.glInternalFormat=s.getUint32(4*i,n),this.glBaseInternalFormat=s.getUint32(5*i,n),this.pixelWidth=s.getUint32(6*i,n),this.pixelHeight=s.getUint32(7*i,n),this.pixelDepth=s.getUint32(8*i,n),this.numberOfArrayElements=s.getUint32(9*i,n),this.numberOfFaces=s.getUint32(10*i,n),this.numberOfMipmapLevels=s.getUint32(11*i,n),this.bytesOfKeyValueData=s.getUint32(12*i,n),0!==this.glType?(p.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(p.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(p.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==t?(p.Error("number of faces expected"+t+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=Ko.COMPRESSED_2D))}uploadLevels(e,t){switch(this.loadType){case Ko.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);case Ko.TEX_2D:case Ko.COMPRESSED_3D:case Ko.TEX_3D:}}_upload2DCompressedLevels(e,t){let i=Ko.HEADER_LEN+this.bytesOfKeyValueData,s=this.pixelWidth,n=this.pixelHeight;const r=t?this.numberOfMipmapLevels:1;for(let t=0;t<r;t++){const r=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(let o=0;o<this.numberOfFaces;o++){const a=new Uint8Array(this.data.buffer,this.data.byteOffset+i,r);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,s,n,a,o,t),i+=r,i+=3-(r+3)%4}s=Math.max(1,.5*s),n=Math.max(1,.5*n)}}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}}Ko.HEADER_LEN=64,Ko.COMPRESSED_2D=0,Ko.COMPRESSED_3D=1,Ko.TEX_2D=2,Ko.TEX_3D=3;class jo{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map((e=>({workerPromise:Promise.resolve(e),idle:!0})))}dispose(){for(const e of this._workerInfos)e.workerPromise.then((e=>{e.terminate()}));this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then((i=>{t(i,(()=>{const t=this._pendingActions.shift();t?this._execute(e,t):e.idle=!0}))}))}}class $o extends jo{constructor(e,t,i=$o.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,((i,s)=>{t(i,(()=>{s(),e.idle&&(e.timeoutId=setTimeout((()=>{e.workerPromise.then((e=>{e.terminate()}));const t=this._workerInfos.indexOf(e);-1!==t&&this._workerInfos.splice(t,1)}),this._options.idleTimeElapsedBeforeRelease))}))}))}}var qo,Zo,Jo,ea;function ta(e){e.wasmUASTCToASTC&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(KTX2DECODER.MSCTranscoder.JSModuleURL=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=e.wasmZSTDDecoder)}$o.DefaultOptions={idleTimeElapsedBeforeRelease:1e3},function(e){e[e.ETC1S=0]="ETC1S",e[e.UASTC4x4=1]="UASTC4x4"}(qo||(qo={})),function(e){e[e.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",e[e.BC7_RGBA=1]="BC7_RGBA",e[e.BC3_RGBA=2]="BC3_RGBA",e[e.BC1_RGB=3]="BC1_RGB",e[e.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",e[e.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",e[e.ETC2_RGBA=6]="ETC2_RGBA",e[e.ETC1_RGB=7]="ETC1_RGB",e[e.RGBA32=8]="RGBA32",e[e.R8=9]="R8",e[e.RG8=10]="RG8"}(Zo||(Zo={})),function(e){e[e.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",e[e.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.RGBA8Format=32856]="RGBA8Format",e[e.R8Format=33321]="R8Format",e[e.RG8Format=33323]="RG8Format"}(Jo||(Jo={}));class ia{static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static _Initialize(e){if(ia._WorkerPoolPromise||ia._DecoderModulePromise)return;const t={jsDecoderModule:Ot.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:Ot.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:Ot.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:Ot.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:Ot.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:Ot.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:Ot.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:Ot.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:Ot.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:Ot.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};e&&"function"==typeof Worker&&"undefined"!=typeof URL?ia._WorkerPoolPromise=new Promise((i=>{const s=`${ta}(${sa})()`,n=URL.createObjectURL(new Blob([s],{type:"application/javascript"}));i(new $o(e,(()=>new Promise(((e,i)=>{const s=new Worker(n),r=e=>{s.removeEventListener("error",r),s.removeEventListener("message",o),i(e)},o=t=>{"init"===t.data.action&&(s.removeEventListener("error",r),s.removeEventListener("message",o),e(s))};s.addEventListener("error",r),s.addEventListener("message",o),s.postMessage({action:"init",urls:t})})))))})):"undefined"==typeof KTX2DECODER?ia._DecoderModulePromise=Ot.LoadBabylonScriptAsync(t.jsDecoderModule).then((()=>(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,ta(t),new KTX2DECODER.KTX2Decoder))):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,ia._DecoderModulePromise=Promise.resolve(new KTX2DECODER.KTX2Decoder))}constructor(e,t=ia.DefaultNumWorkers){this._engine=e,ia._Initialize(t)}uploadAsync(e,t,i){const s=this._engine.getCaps(),n={astc:!!s.astc,bptc:!!s.bptc,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,etc1:!!s.etc1};if(ia._WorkerPoolPromise)return ia._WorkerPoolPromise.then((s=>new Promise(((r,o)=>{s.push(((s,a)=>{const l=e=>{s.removeEventListener("error",l),s.removeEventListener("message",h),o(e),a()},h=e=>{if("decoded"===e.data.action){if(s.removeEventListener("error",l),s.removeEventListener("message",h),e.data.success)try{this._createTexture(e.data.decodedData,t,i),r()}catch(e){o({message:e})}else o({message:e.data.msg});a()}};s.addEventListener("error",l),s.addEventListener("message",h),s.postMessage({action:"setDefaultDecoderOptions",options:ia.DefaultDecoderOptions._getKTX2DecoderOptions()});const c=new Uint8Array(e.byteLength);c.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),s.postMessage({action:"decode",data:c,caps:n,options:i},[c.buffer])}))}))));if(ia._DecoderModulePromise)return ia._DecoderModulePromise.then((i=>(ia.DefaultDecoderOptions.isDirty&&(KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=ia.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise(((n,r)=>{i.decode(e,s).then((e=>{this._createTexture(e,t),n()})).catch((e=>{r({message:e})}))})))));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let s=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,s=!1}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let i=0;i<e.mipmaps.length;++i){const n=e.mipmaps[i];if(!n||!n.data)throw new Error("KTX2 container - could not transcode one of the image");s?(t.width=n.width,t.height=n.height,this._engine._uploadDataToTextureDirectly(t,n.data,0,i,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,n.width,n.height,n.data,0,i)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}}function sa(){let e;onmessage=t=>{if(t.data)switch(t.data.action){case"init":{const i=t.data.urls;importScripts(i.jsDecoderModule),ta(i),e=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=t.data.options;break;case"decode":e.decode(t.data.data,t.data.caps,t.data.options).then((e=>{const t=[];for(let i=0;i<e.mipmaps.length;++i){const s=e.mipmaps[i];s&&s.data&&t.push(s.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:e},t)})).catch((e=>{postMessage({action:"decoded",success:!1,msg:e})}))}}}ia.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null},ia.DefaultNumWorkers=ia.GetDefaultNumWorkers(),ia.DefaultDecoderOptions=new class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[Zo.BC1_RGB,Zo.BC3_RGBA],yes:{transcodeFormat:Zo.RGBA32,engineFormat:Jo.RGBA8Format,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}},te._TextureLoaders.unshift(new class{constructor(){this.supportCascades=!1}canLoad(e,t){return e.endsWith(".ktx")||e.endsWith(".ktx2")||"image/ktx"===t||"image/ktx2"===t}loadCubeData(e,t,i,s){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const n=t.getEngine(),r=new Ko(e,6),o=r.numberOfMipmapLevels>1&&t.generateMipMaps;n._unpackFlipY(!0),r.uploadLevels(t,t.generateMipMaps),t.width=r.pixelWidth,t.height=r.pixelHeight,n._setCubeMapTextureParams(t,o,r.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}loadData(e,t,i,s){if(Ko.IsValid(e)){t._invertVScale=!t.invertY;const s=new Ko(e,1),n=function(e){switch(e){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(s.glInternalFormat);n?(t.format=n,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=s.glInternalFormat,i(s.pixelWidth,s.pixelHeight,t.generateMipMaps,!0,(()=>{s.uploadLevels(t,t.generateMipMaps)}),s.isInvalid)}else ia.IsValid(e)?new ia(t.getEngine()).uploadAsync(e,t,s).then((()=>{i(t.width,t.height,t.generateMipMaps,!0,(()=>{}),!1)}),(e=>{p.Warn(`Failed to load KTX2 texture data: ${e.message}`),i(0,0,!1,!1,(()=>{}),!0)})):(p.Error("texture missing KTX identifier"),i(0,0,!1,!1,(()=>{}),!0))}});class na extends Hr{constructor(e,t,i){super(e,me.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=ve.Identity(),this._referencedPosition=new me,this._trackingState=oo.NOT_TRACKING,this.onXRCameraInitializedObservable=new s,this.onBeforeCameraTeleport=new s,this.onAfterCameraTeleport=new s,this.onTrackingStateChanged=new s,this.compensateOnFirstFrame=!0,this._rotate180=new ve(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new ve,this.cameraRigMode=Gt.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add((()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame})),this._xrSessionManager.onXRFrameObservable.add((()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()}),void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new Ut(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new Ut(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){e&&e!==this&&(e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,ve.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace())}getClassName(){return"WebXRCamera"}setTarget(e){const t=Ee.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();const i=Math.atan2(t.x,t.z);this.rotationQuaternion.toEulerAnglesToRef(t),ve.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0}_updateFromXRSession(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e)return void this._setTrackingState(oo.NOT_TRACKING);const t=e.emulatedPosition?oo.TRACKING_LOST:oo.TRACKING;if(this._setTrackingState(t),this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ){const e={depthFar:this.maxZ||1e4,depthNear:this.minZ};this._xrSessionManager.updateRenderState(e),this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ}if(e.transform){const t=e.transform.orientation;if(void 0===e.transform.orientation.x)return;const i=e.transform.position;this._referencedPosition.set(i.x,i.y,i.z),this._referenceQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach(((e,t)=>{var i;const s=this.rigCameras[t];s.isLeftCamera||s.isRightCamera||("right"===e.eye?s._isRightCamera=!0:"left"===e.eye&&(s._isLeftCamera=!0));const n=e.transform.position,r=e.transform.orientation;s.parent=this.parent,s.position.set(n.x,n.y,n.z),s.rotationQuaternion.set(r.x,r.y,r.z,r.w),this._scene.useRightHandedSystem?s.rotationQuaternion.multiplyInPlace(this._rotate180):(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1),Te.FromFloat32ArrayToRefScaled(e.projectionMatrix,0,1,s._projectionMatrix),this._scene.useRightHandedSystem||s._projectionMatrix.toggleProjectionMatrixHandInPlace(),0===t&&this._projectionMatrix.copyFrom(s._projectionMatrix);const o=this._xrSessionManager.getRenderTargetTextureForView(e);this._renderingMultiview=(null===(i=null==o?void 0:o._texture)||void 0===i?void 0:i.isMultiview)||!1,this._renderingMultiview?0==t&&(this._xrSessionManager.trySetViewportForView(this.viewport,e),this.outputRenderTarget=o):(this._xrSessionManager.trySetViewportForView(s.viewport,e),s.outputRenderTarget=o||this._xrSessionManager.getRenderTargetTextureForView(e)),s.layerMask=this.layerMask}))}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const e=new _r("XR-RigCamera: "+this.rigCameras.length,me.Zero(),this.getScene());e.minZ=.1,e.rotationQuaternion=new ve,e.updateUpVectorFromRotation=!0,e.isRigCamera=!0,e.rigParent=this,e.freezeProjectionMatrix(),this.rigCameras.push(e)}for(;this.rigCameras.length>e;){const e=this.rigCameras.pop();e&&e.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=Ee.Matrix[0],t=Ee.Matrix[1],i=Ee.Matrix[2];Te.ComposeToRef(na._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),Te.ComposeToRef(na._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const s=new XRRigidTransform({x:this._referencedPosition.x,y:this._referencedPosition.y,z:this._referencedPosition.z},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(s)}}}na._ScaleReadOnly=me.One();class ra{}ra.ANCHOR_SYSTEM="xr-anchor-system",ra.BACKGROUND_REMOVER="xr-background-remover",ra.HIT_TEST="xr-hit-test",ra.MESH_DETECTION="xr-mesh-detection",ra.PHYSICS_CONTROLLERS="xr-physics-controller",ra.PLANE_DETECTION="xr-plane-detection",ra.POINTER_SELECTION="xr-controller-pointer-selection",ra.TELEPORTATION="xr-controller-teleportation",ra.FEATURE_POINTS="xr-feature-points",ra.HAND_TRACKING="xr-hand-tracking",ra.IMAGE_TRACKING="xr-image-tracking",ra.NEAR_INTERACTION="xr-near-interaction",ra.DOM_OVERLAY="xr-dom-overlay",ra.MOVEMENT="xr-controller-movement",ra.LIGHT_ESTIMATION="xr-light-estimation",ra.EYE_TRACKING="xr-eye-tracking",ra.WALKING_LOCOMOTION="xr-walking-locomotion",ra.LAYERS="xr-layers",ra.DEPTH_SENSING="xr-depth-sensing",ra.SPACE_WARP="xr-space-warp",ra.RAW_CAMERA_ACCESS="xr-raw-camera-access";class oa{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add((()=>{this.getEnabledFeatures().forEach((e=>{const t=this._features[e];!t.enabled||t.featureImplementation.attached||t.featureImplementation.disableAutoAttach||this.attachFeature(e)}))})),this._xrSessionManager.onXRSessionEnded.add((()=>{this.getEnabledFeatures().forEach((e=>{const t=this._features[e];t.enabled&&t.featureImplementation.attached&&this.detachFeature(e)}))}))}static AddWebXRFeature(e,t,i=1,s=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),s&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,s){const n=this._AvailableFeatures[e][t];if(!n)throw new Error("feature not found");return n(i,s)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&t.featureImplementation.attach()}detachFeature(e){const t=this._features[e];t&&t.featureImplementation.attached&&t.featureImplementation.detach()}disableFeature(e){const t="string"==typeof e?e:e.Name,i=this._features[t];return!(!i||!i.enabled||(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],0))}dispose(){this.getEnabledFeatures().forEach((e=>{this.disableFeature(e)}))}enableFeature(e,t="latest",i={},s=!0,n=!0){const r="string"==typeof e?e:e.Name;let o=0;if("string"==typeof t){if(!t)throw new Error(`Error in provided version - ${r} (${t})`);if(o="stable"===t?oa.GetStableVersionOfFeature(r):"latest"===t?oa.GetLatestVersionOfFeature(r):+t,-1===o||isNaN(o))throw new Error(`feature not found - ${r} (${t})`)}else o=t;const a=oa._ConflictingFeatures[r];if(void 0!==a&&-1!==this.getEnabledFeatures().indexOf(a))throw new Error(`Feature ${r} cannot be enabled while ${a} is enabled.`);const l=this._features[r],h=oa.ConstructFeature(r,o,this._xrSessionManager,i);if(!h)throw new Error(`feature not found - ${r}`);l&&this.disableFeature(r);const c=h();if(c.dependsOn){const e=c.dependsOn.every((e=>!!this._features[e]));if(!e)throw new Error(`Dependant features missing. Make sure the following features are enabled - ${c.dependsOn.join(", ")}`)}if(c.isCompatible())return this._features[r]={featureImplementation:c,enabled:!0,version:o,required:n},s?this._xrSessionManager.session&&!this._features[r].featureImplementation.attached&&this.attachFeature(r):this._features[r].featureImplementation.disableAutoAttach=!0,this._features[r].featureImplementation;if(n)throw new Error("required feature not compatible");return Ot.Warn(`Feature ${r} not compatible with the current environment/browser and was not enabled.`),c}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const t=this.getEnabledFeatures();for(const i of t){const t=this._features[i],s=t.featureImplementation.xrNativeFeatureName;if(s&&(t.required?(e.requiredFeatures=e.requiredFeatures||[],-1===e.requiredFeatures.indexOf(s)&&e.requiredFeatures.push(s)):(e.optionalFeatures=e.optionalFeatures||[],-1===e.optionalFeatures.indexOf(s)&&e.optionalFeatures.push(s))),t.featureImplementation.getXRSessionInitExtension){const i=await t.featureImplementation.getXRSessionInitExtension();e=Object.assign(Object.assign({},e),i)}}return e}}oa._AvailableFeatures={},oa._ConflictingFeatures={[ra.TELEPORTATION]:ra.MOVEMENT,[ra.MOVEMENT]:ra.TELEPORTATION},et.AddNodeConstructor("TouchCamera",((e,t)=>()=>new aa(e,me.Zero(),t)));class aa extends Hr{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!1:e.allowMouse=!0}}et.AddNodeConstructor("FreeCamera",((e,t)=>()=>new la(e,me.Zero(),t)));class la extends aa{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}Gt._CreateDefaultParsedCamera=(e,t)=>new la(e,me.Zero(),t);class ha{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new s,this.onStateChangedObservable=new s,this.state=ro.NOT_IN_XR,this.sessionManager=new Io(e),this.camera=new na("webxr",e,this.sessionManager),this.featuresManager=new oa(this.sessionManager),e.onDisposeObservable.addOnce((()=>{this.dispose()}))}static CreateAsync(e){const t=new ha(e);return t.sessionManager.initializeAsync().then((()=>(t._supported=!0,t))).catch((e=>{throw t._setState(ro.NOT_IN_XR),t.dispose(),e}))}dispose(){var e;this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),null===(e=this._spectatorCamera)||void 0===e||e.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),s={}){var n,r,o;if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(ro.ENTERING_XR),"viewer"!==t&&"local"!==t&&(s.optionalFeatures=s.optionalFeatures||[],s.optionalFeatures.push(t)),s=await this.featuresManager._extendXRSessionInitObject(s),"immersive-ar"===e&&"unbounded"!==t&&p.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,s),await this.sessionManager.setReferenceSpaceTypeAsync(t);const a=await i.initializeXRLayerAsync(this.sessionManager.session),l={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};return this.featuresManager.getEnabledFeature(ra.LAYERS)||(l.baseLayer=a),this.sessionManager.updateRenderState(l),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!(null===(r=null===(n=this._nonVRCamera)||void 0===n?void 0:n.inputs)||void 0===r?void 0:r.attachedToElement),null===(o=this._nonVRCamera)||void 0===o||o.detachControl(),this._scene.activeCamera=this.camera,"immersive-ar"!==e?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),this.sessionManager.onXRSessionEnded.addOnce((()=>{this.state!==ro.EXITING_XR&&this._setState(ro.EXITING_XR),this.camera.rigCameras.forEach((e=>{e.outputRenderTarget=null})),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),"immersive-ar"!==e&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(ro.NOT_IN_XR)})),this.sessionManager.onXRFrameObservable.addOnce((()=>{this._setState(ro.IN_XR)})),this.sessionManager}catch(e){throw p.Log(e),p.Log(e.message),this._setState(ro.NOT_IN_XR),e}}exitXRAsync(){return this.state!==ro.IN_XR?Promise.resolve():(this._setState(ro.EXITING_XR),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const t=1/((null==e?void 0:e.fps)?e.fps:1e3)*1e3,i=(null==e?void 0:e.preferredCameraIndex)?null==e?void 0:e.preferredCameraIndex:0,s=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=t&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[i].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[i].absoluteRotation))};if(this._spectatorMode){if(i>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const e=()=>{this.state===ro.IN_XR?(this._spectatorCamera=new la("webxr-spectator",me.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new ve,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(s),this._scene.onAfterRenderCameraObservable.add((e=>{e===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)}))):this.state===ro.EXITING_XR&&(this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=null)};this.onStateChangedObservable.add(e),e()}else this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class ca{constructor(e,t,i=-1,n=[]){this.id=e,this.type=t,this._buttonIndex=i,this._axesIndices=n,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new s,this.onButtonStateChangedObservable=new s}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return 0!==this._axesIndices.length}isButton(){return-1!==this._buttonIndex}update(e){let t=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const i=e.buttons[this._buttonIndex];if(!i)return;this._currentValue!==i.value&&(this.changes.value={current:i.value,previous:this._currentValue},t=!0,this._currentValue=i.value),this._touched!==i.touched&&(this.changes.touched={current:i.touched,previous:this._touched},t=!0,this._touched=i.touched),this._pressed!==i.pressed&&(this.changes.pressed={current:i.pressed,previous:this._pressed},t=!0,this._pressed=i.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],i=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],i=!0)),t&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}ca.BUTTON_TYPE="button",ca.SQUEEZE_TYPE="squeeze",ca.THUMBSTICK_TYPE="thumbstick",ca.TOUCHPAD_TYPE="touchpad",ca.TRIGGER_TYPE="trigger",function(e){e[e.Clean=0]="Clean",e[e.Stop=1]="Stop",e[e.Sync=2]="Sync",e[e.NoSync=3]="NoSync"}(ea||(ea={}));class da{static get ForceFullSceneLoadingForIncremental(){return Fn.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Fn.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Fn.ShowLoadingScreen}static set ShowLoadingScreen(e){Fn.ShowLoadingScreen=e}static get loggingLevel(){return Fn.loggingLevel}static set loggingLevel(e){Fn.loggingLevel=e}static get CleanBoneMatrixWeights(){return Fn.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Fn.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return da._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(e){return da._RegisteredPlugins[e]||(p.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),da.GetDefaultPlugin())}static _GetPluginForDirectLoad(e){for(const t in da._RegisteredPlugins){const i=da._RegisteredPlugins[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return da._RegisteredPlugins[t]}return da.GetDefaultPlugin()}static _GetPluginForFilename(e){const t=e.indexOf("?");-1!==t&&(e=e.substring(0,t));const i=e.lastIndexOf("."),s=e.substring(i,e.length).toLowerCase();return da._GetPluginForExtension(s)}static _GetDirectLoad(e){return"data:"===e.substr(0,5)?e.substr(5):null}static _FormatErrorMessage(e,t,i){let s="Unable to load from "+(e.rawData?"binary data":e.url);return t?s+=`: ${t}`:i&&(s+=`: ${i}`),s}static _LoadData(e,t,i,s,n,r,o,a){const l=da._GetDirectLoad(e.url);if(e.rawData&&!o)throw"When using ArrayBufferView to load data the file extension must be provided.";const h=o?da._GetPluginForExtension(o):l?da._GetPluginForDirectLoad(e.url):da._GetPluginForFilename(e.url);if(e.rawData&&!h.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";let c;if(c=void 0!==h.plugin.createPlugin?h.plugin.createPlugin():h.plugin,!c)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(da.OnPluginActivatedObservable.notifyObservers(c),l&&(c.canDirectLoad&&c.canDirectLoad(e.url)||!Ct(e.url))){if(c.directLoad){const e=c.directLoad(t,l);e.then?e.then((e=>{i(c,e)})).catch((e=>{n("Error in directLoad of _loadData: "+e,e)})):i(c,e)}else i(c,l);return c}const d=h.isBinary,u=(e,s)=>{t.isDisposed?n("Scene has been disposed"):i(c,e,s)};let _=null,f=!1;const p=c.onDisposeObservable;p&&p.add((()=>{f=!0,_&&(_.abort(),_=null),r()}));const m=()=>{if(f)return;const i=(e,t)=>{n(null==e?void 0:e.statusText,t)};if(!c.loadFile&&e.rawData)throw"Plugin does not support loading ArrayBufferView.";_=c.loadFile?c.loadFile(t,e.rawData||e.file||e.url,e.rootUrl,u,s,d,i,a):t._loadFile(e.file||e.url,u,s,!0,d,i)},g=t.getEngine();let v=g.enableOfflineSupport;if(v){let i=!1;for(const s of t.disableOfflineSupportExceptionRules)if(s.test(e.url)){i=!0;break}v=!i}return v&&te.OfflineProviderFactory?t.offlineProvider=te.OfflineProviderFactory(e.url,m,g.disableManifestCheck):m(),c}static _GetFileInfo(e,t){let i,s,n=null,r=null;if(t)if(t.name){const e=t;i=`file:${e.name}`,s=e.name,n=e}else if(ArrayBuffer.isView(t))i="",s="arrayBuffer",r=t;else if("string"==typeof t&&t.startsWith("data:"))i=t,s="";else{const n=t;if("/"===n.substr(0,1))return Ot.Error("Wrong sceneFilename parameter"),null;i=e+n,s=n}else i=e,s=Ot.GetFilename(e),e=Ot.GetFolderPath(e);return{url:i,rootUrl:e,name:s,file:n,rawData:r}}static GetPluginForExtension(e){return da._GetPluginForExtension(e).plugin}static IsPluginForExtensionAvailable(e){return!!da._RegisteredPlugins[e]}static RegisterPlugin(e){if("string"==typeof e.extensions){const t=e.extensions;da._RegisteredPlugins[t.toLowerCase()]={plugin:e,isBinary:!1}}else{const t=e.extensions;Object.keys(t).forEach((i=>{da._RegisteredPlugins[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}}))}}static ImportMesh(e,t,i="",s=u.LastCreatedScene,n=null,r=null,o=null,a=null,l=""){if(!s)return p.Error("No scene available to import mesh to"),null;const h=da._GetFileInfo(t,i);if(!h)return null;const c={};s.addPendingData(c);const d=()=>{s.removePendingData(c)},_=(e,t)=>{const i=da._FormatErrorMessage(h,e,t);o?o(s,i,new at(i,ot,t)):p.Error(i),d()},f=r?e=>{try{r(e)}catch(e){_("Error in onProgress callback: "+e,e)}}:void 0,m=(e,t,i,r,o,a,l)=>{if(s.importedMeshesFiles.push(h.url),n)try{n(e,t,i,r,o,a,l)}catch(e){_("Error in onSuccess callback: "+e,e)}s.removePendingData(c)};return da._LoadData(h,s,((t,i,n)=>{if(t.rewriteRootURL&&(h.rootUrl=t.rewriteRootURL(h.rootUrl,n)),t.importMesh){const n=[],r=[],o=[];if(!t.importMesh(e,s,i,h.rootUrl,n,r,o,_))return;s.loadingPluginName=t.name,m(n,r,o,[],[],[],[])}else t.importMeshAsync(e,s,i,h.rootUrl,f,h.name).then((e=>{s.loadingPluginName=t.name,m(e.meshes,e.particleSystems,e.skeletons,e.animationGroups,e.transformNodes,e.geometries,e.lights)})).catch((e=>{_(e.message,e)}))}),f,_,d,a,l)}static ImportMeshAsync(e,t,i="",s=u.LastCreatedScene,n=null,r=null,o=""){return new Promise(((a,l)=>{da.ImportMesh(e,t,i,s,((e,t,i,s,n,r,o)=>{a({meshes:e,particleSystems:t,skeletons:i,animationGroups:s,transformNodes:n,geometries:r,lights:o})}),n,((e,t,i)=>{l(i||new Error(t))}),r,o)}))}static Load(e,t="",i=u.LastCreatedEngine,s=null,n=null,r=null,o=null,a=""){return i?da.Append(e,t,new Oi(i),s,n,r,o,a):(Ot.Error("No engine available"),null)}static LoadAsync(e,t="",i=u.LastCreatedEngine,s=null,n=null,r=""){return new Promise(((o,a)=>{da.Load(e,t,i,(e=>{o(e)}),s,((e,t,i)=>{a(i||new Error(t))}),n,r)}))}static Append(e,t="",i=u.LastCreatedScene,s=null,n=null,r=null,o=null,a=""){if(!i)return p.Error("No scene available to append to"),null;const l=da._GetFileInfo(e,t);if(!l)return null;const h={};i.addPendingData(h);const c=()=>{i.removePendingData(h)};da.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady((()=>{i.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1})));const d=(e,t)=>{const s=da._FormatErrorMessage(l,e,t);r?r(i,s,new at(s,ot,t)):p.Error(s),c()},_=n?e=>{try{n(e)}catch(e){d("Error in onProgress callback",e)}}:void 0,f=()=>{if(s)try{s(i)}catch(e){d("Error in onSuccess callback",e)}i.removePendingData(h)};return da._LoadData(l,i,((e,t)=>{if(e.load){if(!e.load(i,t,l.rootUrl,d))return;i.loadingPluginName=e.name,f()}else e.loadAsync(i,t,l.rootUrl,_,l.name).then((()=>{i.loadingPluginName=e.name,f()})).catch((e=>{d(e.message,e)}))}),_,d,c,o,a)}static AppendAsync(e,t="",i=u.LastCreatedScene,s=null,n=null,r=""){return new Promise(((o,a)=>{da.Append(e,t,i,(e=>{o(e)}),s,((e,t,i)=>{a(i||new Error(t))}),n,r)}))}static LoadAssetContainer(e,t="",i=u.LastCreatedScene,s=null,n=null,r=null,o=null,a=""){if(!i)return p.Error("No scene available to load asset container to"),null;const l=da._GetFileInfo(e,t);if(!l)return null;const h={};i.addPendingData(h);const c=()=>{i.removePendingData(h)},d=(e,t)=>{const s=da._FormatErrorMessage(l,e,t);r?r(i,s,new at(s,ot,t)):p.Error(s),c()},_=n?e=>{try{n(e)}catch(e){d("Error in onProgress callback",e)}}:void 0,f=e=>{if(s)try{s(e)}catch(e){d("Error in onSuccess callback",e)}i.removePendingData(h)};return da._LoadData(l,i,((e,t)=>{if(e.loadAssetContainer){const s=e.loadAssetContainer(i,t,l.rootUrl,d);if(!s)return;s.populateRootNodes(),i.loadingPluginName=e.name,f(s)}else e.loadAssetContainerAsync?e.loadAssetContainerAsync(i,t,l.rootUrl,_,l.name).then((t=>{t.populateRootNodes(),i.loadingPluginName=e.name,f(t)})).catch((e=>{d(e.message,e)})):d("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")}),_,d,c,o,a)}static LoadAssetContainerAsync(e,t="",i=u.LastCreatedScene,s=null,n=null){return new Promise(((r,o)=>{da.LoadAssetContainer(e,t,i,(e=>{r(e)}),s,((e,t,i)=>{o(i||new Error(t))}),n)}))}static ImportAnimations(e,t="",i=u.LastCreatedScene,s=!0,n=ea.Clean,r=null,o=null,a=null,l=null,h=null){if(!i)return void p.Error("No scene available to load animations to");if(s){for(const e of i.animatables)e.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach((e=>{e.dispose()})),i.getNodes().forEach((e=>{e.animations&&(e.animations=[])}))}else switch(n){case ea.Clean:i.animationGroups.slice().forEach((e=>{e.dispose()}));break;case ea.Stop:i.animationGroups.forEach((e=>{e.stop()}));break;case ea.Sync:i.animationGroups.forEach((e=>{e.reset(),e.restart()}));break;case ea.NoSync:break;default:return void p.Error("Unknown animation group loading mode value '"+n+"'")}const c=i.animatables.length;this.LoadAssetContainer(e,t,i,(e=>{e.mergeAnimationsTo(i,i.animatables.slice(c),r),e.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),o&&o(i)}),a,l,h)}static ImportAnimationsAsync(e,t="",i=u.LastCreatedScene,s=!0,n=ea.Clean,r=null,o=null,a=null,l=null,h=null){return new Promise(((o,l)=>{da.ImportAnimations(e,t,i,s,n,r,(e=>{o(e)}),a,((e,t,i)=>{l(i||new Error(t))}),h)}))}}da.NO_LOGGING=0,da.MINIMAL_LOGGING=1,da.SUMMARY_LOGGING=2,da.DETAILED_LOGGING=3,da.OnPluginActivatedObservable=new s,da._RegisteredPlugins={},da._ShowingLoadingScreen=!1;class ua{constructor(e,t,i,n,r=!1,o){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=n,this._doNotLoadControllerMesh=r,this._controllerCache=o,this._initComponent=e=>{if(!e)return;const t=this.layout.components[e],i=t.type,s=t.gamepadIndices.button,n=[];void 0!==t.gamepadIndices.xAxis&&void 0!==t.gamepadIndices.yAxis&&n.push(t.gamepadIndices.xAxis,t.gamepadIndices.yAxis),this.components[e]=new ca(e,i,s,n)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new s,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach((e=>this.getComponent(e).dispose())),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach((e=>{e.setEnabled(!1)})),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache))}getAllComponentsOfType(e){return this.getComponentIds().map((e=>this.components[e])).filter((t=>t.type===e))}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const e=!this._getModelLoadingConstraints();let t=this._getGenericFilenameAndPath();return e?p.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),new Promise(((i,s)=>{const n=t=>{e?this._getGenericParentMesh(t):this._setRootMesh(t),this._processLoadedModel(t),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){const e=this._controllerCache.filter((e=>e.filename===t.filename&&e.path===t.path));if(e[0])return e[0].meshes.forEach((e=>e.setEnabled(!0))),void n(e[0].meshes)}da.ImportMesh("",t.path,t.filename,this.scene,(e=>{this._controllerCache&&this._controllerCache.push(Object.assign(Object.assign({},t),{meshes:e})),n(e)}),null,((e,i)=>{p.Log(i),p.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),s(i)}))}))}updateFromXRFrame(e){this.getComponentIds().forEach((e=>this.getComponent(e).update(this.gamepadObject))),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren((e=>e.name===t),!1)[0]}_getImmediateChildByName(e,t){return e.getChildren((e=>e.name==t),!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh)return;if(!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;const s=i?.5*t+.5:t;ve.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,s,e.valueMesh.rotationQuaternion),me.LerpToRef(e.minMesh.position,e.maxMesh.position,s,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new jn(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.parent||(e.isPickable=!1,e.setParent(this.rootMesh))})),this.rootMesh.rotationQuaternion=ve.FromEulerAngles(0,Math.PI,0)}}class _a extends ua{constructor(e,t,i){super(e,fa[i],t,i),this.profileId=_a.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new jn(this.profileId+" "+this.handedness,this.scene),e.forEach((e=>{e.isPickable=!1,e.parent||e.setParent(this.rootMesh)})),this.rootMesh.rotationQuaternion=ve.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}_a.ProfileId="generic-trigger";const fa={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};function pa(e){const t=0|(e.segments||32),i=e.diameterX||e.diameter||1,s=e.diameterY||e.diameter||1,n=e.diameterZ||e.diameter||1,r=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,o=e.slice&&e.slice<=0?1:e.slice||1,a=0===e.sideOrientation?0:e.sideOrientation||Nn.DEFAULTSIDE,l=!!e.dedupTopBottomIndices,h=new me(i/2,s/2,n/2),c=2+t,d=2*c,u=[],_=[],f=[],p=[];for(let e=0;e<=c;e++){const t=e/c,i=t*Math.PI*o;for(let e=0;e<=d;e++){const s=e/d,n=s*Math.PI*2*r,o=Te.RotationZ(-i),a=Te.RotationY(n),l=me.TransformCoordinates(me.Up(),o),c=me.TransformCoordinates(l,a),u=c.multiply(h),m=c.divide(h).normalize();_.push(u.x,u.y,u.z),f.push(m.x,m.y,m.z),p.push(s,Gi.UseOpenGLOrientationForUV?1-t:t)}if(e>0){const t=_.length/3;for(let i=t-2*(d+1);i+d+2<t;i++)l?(e>1&&(u.push(i),u.push(i+1),u.push(i+d+1)),(e<c||o<1)&&(u.push(i+d+1),u.push(i+1),u.push(i+d+2))):(u.push(i),u.push(i+1),u.push(i+d+1),u.push(i+d+1),u.push(i+1),u.push(i+d+2))}}Nn._ComputeSides(a,_,u,f,p,e.frontUVs,e.backUVs);const m=new Nn;return m.indices=u,m.positions=_,m.normals=f,m.uvs=p,m}function ma(e,t={},i=null){const s=new jn(e,i);return t.sideOrientation=jn._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,pa(t).applyToMesh(s,t.updatable),s}Nn.CreateSphere=pa,jn.CreateSphere=(e,t,i,s,n,r)=>ma(e,{segments:t,diameterX:i,diameterY:i,diameterZ:i,sideOrientation:r,updatable:n},s);class ga extends ua{constructor(e,t,i,s,n){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,n),this._repositoryUrl=s,this.controllerCache=n,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach((e=>{this._touchDots[e].dispose()}))}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=da.IsPluginForExtensionAvailable(".glb");return e||p.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach((e=>{const t=this.layout.components[e];this._buttonMeshMapping[e]={mainMesh:this._getChildByName(this.rootMesh,t.rootNodeName),states:{}},Object.keys(t.visualResponses).forEach((i=>{const s=t.visualResponses[i];if("transform"===s.valueNodeProperty)this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,s.valueNodeName),minMesh:this._getChildByName(this.rootMesh,s.minNodeName),maxMesh:this._getChildByName(this.rootMesh,s.maxNodeName)};else{const n=t.type===ca.TOUCHPAD_TYPE&&t.touchPointNodeName?t.touchPointNodeName:s.valueNodeName;if(this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,n)},t.type===ca.TOUCHPAD_TYPE&&!this._touchDots[i]){const t=ma(i+"dot",{diameter:.0015,segments:8},this.scene);t.material=new zs(i+"mat",this.scene),t.material.diffuseColor=Re.Red(),t.parent=this._buttonMeshMapping[e].states[i].valueMesh||null,t.isVisible=!1,this._touchDots[i]=t}}}))}))}_setRootMesh(e){let t;this.rootMesh=new jn(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){const s=e[i];s.isPickable=!1,s.parent||(t=s)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(nn.Y,Math.PI,Js.WORLD)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach((e=>{const t=this.getComponent(e);if(!t.hasChanges)return;const i=this._buttonMeshMapping[e],s=this.layout.components[e];Object.keys(s.visualResponses).forEach((e=>{const n=s.visualResponses[e];let r=t.value;if("xAxis"===n.componentProperty?r=t.axes.x:"yAxis"===n.componentProperty&&(r=t.axes.y),"transform"===n.valueNodeProperty)this._lerpTransform(i.states[e],r,"button"!==n.componentProperty);else{const s=i.states[e].valueMesh;s&&(s.isVisible=t.touched||t.pressed),this._touchDots[e]&&(this._touchDots[e].isVisible=t.touched||t.pressed)}}))}))}}const va=[];class Ta{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(e){const t=this._Fallbacks[e]||[];return t.unshift(e),t}static GetMotionControllerWithXRInput(e,t,i){const s=[];i&&s.push(i),s.push(...e.profiles||[]),s.length&&!s[0]&&s.pop(),e.gamepad&&e.gamepad.id&&e.gamepad.id===(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0)&&s.push("oculus-touch-v2");const n=s.indexOf("windows-mixed-reality");if(-1!==n&&s.splice(n,0,"microsoft-mixed-reality"),s.length||s.push("generic-trigger"),this.UseOnlineRepository){const i=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,n=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return i.call(this,s,e,t).catch((()=>n.call(this,s,e,t)))}return this._LoadProfilesFromAvailableControllers(s,e,t)}static RegisterController(e,t){this._AvailableControllers[e]=t}static RegisterFallbacksForProfileId(e,t){this._Fallbacks[e]?this._Fallbacks[e].push(...t):this._Fallbacks[e]=t}static UpdateProfilesList(){return this._ProfilesList=Ot.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then((e=>JSON.parse(e))),this._ProfilesList}static ClearControllerCache(){va.forEach((e=>{e.meshes.forEach((e=>{e.dispose(!1,!0)}))})),va.length=0}static _LoadProfileFromRepository(e,t,i){return Promise.resolve().then((()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList())).then((t=>{for(let i=0;i<e.length;++i)if(e[i]&&t[e[i]])return e[i];throw new Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)})).then((e=>(this._ProfileLoadingPromises[e]||(this._ProfileLoadingPromises[e]=Ot.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${e}/profile.json`,!1).then((e=>JSON.parse(e)))),this._ProfileLoadingPromises[e]))).then((e=>new ga(i,t,e,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:va)))}static _LoadProfilesFromAvailableControllers(e,t,i){for(let s=0;s<e.length;++s){if(!e[s])continue;const n=this.FindFallbackWithProfileId(e[s]);for(let e=0;e<n.length;++e){const s=this._AvailableControllers[n[e]];if(s)return Promise.resolve(s(t,i))}}throw new Error("no controller requested was found in the available controllers list")}}Ta._AvailableControllers={},Ta._Fallbacks={},Ta._ProfileLoadingPromises={},Ta.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",Ta.PrioritizeOnlineRepository=!0,Ta.UseOnlineRepository=!0,Ta.DisableControllerCache=!0,Ta.RegisterController(_a.ProfileId,((e,t)=>new _a(t,e.gamepad,e.handedness))),Ta.DefaultFallbacks();let ba=0;class Ea{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new me,this._disposed=!1,this.onDisposeObservable=new s,this.onMeshLoadedObservable=new s,this.onMotionControllerInitObservable=new s,this._uniqueId=`controller-${ba++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new Gn(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new ve,this.inputSource.gripSpace&&(this.grip=new Gn(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new ve),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&"tracked-pointer"===this.inputSource.targetRayMode&&Ta.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then((e=>{this.motionController=e,this.onMotionControllerInitObservable.notifyObservers(e),this._options.doNotLoadControllerMesh||this.motionController._doNotLoadControllerMesh||this.motionController.loadModel().then((e=>{var t;e&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach((e=>e.renderingGroupId=this._options.renderingGroupId))),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&(null===(t=this.motionController)||void 0===t||t.dispose())}))}),(()=>{Ot.Warn("Could not find a matching motion controller for the registered input source")}))}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){const i=t&&this.grip?this.grip:this.pointer;me.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i){const s=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=s,s){const e=s.transform.position;this.pointer.position.set(e.x,e.y,e.z);const t=s.transform.orientation;this.pointer.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent}if(this.inputSource.gripSpace&&this.grip){const s=e.getPose(this.inputSource.gripSpace,t);if(s){const e=s.transform.position,t=s.transform.orientation;this.grip.position.set(e.x,e.y,e.z),this.grip.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent}this.motionController&&this.motionController.updateFromXRFrame(e)}}class Sa{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new s,this.onControllerRemovedObservable=new s,this._onInputSourcesChange=e=>{this._addAndRemoveControllers(e.added,e.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add((()=>{this._addAndRemoveControllers([],this.controllers.map((e=>e.inputSource)))})),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add((e=>{e.addEventListener("inputsourceschange",this._onInputSourcesChange)})),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add((e=>{this.controllers.forEach((t=>{t.updateFromXRFrame(e,this.xrSessionManager.referenceSpace,this.xrCamera)}))})),this._options.customControllersRepositoryURL&&(Ta.BaseRepositoryUrl=this._options.customControllersRepositoryURL),Ta.UseOnlineRepository=!this._options.disableOnlineControllerRepository,Ta.UseOnlineRepository)try{Ta.UpdateProfilesList().catch((()=>{Ta.UseOnlineRepository=!1}))}catch(e){Ta.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){const i=this.controllers.map((e=>e.inputSource));for(const t of e)if(-1===i.indexOf(t)){const e=new Ea(this.xrSessionManager.scene,t,Object.assign(Object.assign({},this._options.controllerOptions||{}),{forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation}));this.controllers.push(e),this.onControllerAddedObservable.notifyObservers(e)}const s=[],n=[];this.controllers.forEach((e=>{-1===t.indexOf(e.inputSource)?s.push(e):n.push(e)})),this.controllers=s,n.forEach((e=>{this.onControllerRemovedObservable.notifyObservers(e),e.dispose()}))}dispose(){this.controllers.forEach((e=>{e.dispose()})),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),Ta.ClearControllerCache()}}function xa(e){const t=e.height||2;let i=0===e.diameterTop?0:e.diameterTop||e.diameter||1,s=0===e.diameterBottom?0:e.diameterBottom||e.diameter||1;i=i||1e-5,s=s||1e-5;const n=0|(e.tessellation||24),r=0|(e.subdivisions||1),o=!!e.hasRings,a=!!e.enclose,l=0===e.cap?0:e.cap||jn.CAP_ALL,h=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1,c=0===e.sideOrientation?0:e.sideOrientation||Nn.DEFAULTSIDE,d=e.faceUV||new Array(3),u=e.faceColors,_=2+(1+(1!==h&&a?2:0))*(o?r:1);let f;for(f=0;f<_;f++)u&&void 0===u[f]&&(u[f]=new Ie(1,1,1,1));for(f=0;f<_;f++)d&&void 0===d[f]&&(d[f]=new ge(0,0,1,1));const p=[],m=[],g=[],v=[],T=[],b=2*Math.PI*h/n;let E,S,x;const C=(s-i)/2/t,y=me.Zero(),A=me.Zero(),R=me.Zero(),I=me.Zero(),P=me.Zero(),M=nn.Y;let O,D,N,F=1,L=1,w=0,B=0;for(O=0;O<=r;O++)for(S=O/r,x=(S*(i-s)+s)/2,F=o&&0!==O&&O!==r?2:1,N=0;N<F;N++){for(o&&(L+=N),a&&(L+=2*N),D=0;D<=n;D++)E=D*b,y.x=Math.cos(-E)*x,y.y=-t/2+S*t,y.z=Math.sin(-E)*x,0===i&&O===r?(A.x=g[g.length-3*(n+1)],A.y=g[g.length-3*(n+1)+1],A.z=g[g.length-3*(n+1)+2]):(A.x=y.x,A.z=y.z,A.y=Math.sqrt(A.x*A.x+A.z*A.z)*C,A.normalize()),0===D&&(R.copyFrom(y),I.copyFrom(A)),m.push(y.x,y.y,y.z),g.push(A.x,A.y,A.z),B=o?w!==L?d[L].y:d[L].w:d[L].y+(d[L].w-d[L].y)*S,v.push(d[L].x+(d[L].z-d[L].x)*D/n,Gi.UseOpenGLOrientationForUV?1-B:B),u&&T.push(u[L].r,u[L].g,u[L].b,u[L].a);1!==h&&a&&(m.push(y.x,y.y,y.z),m.push(0,y.y,0),m.push(0,y.y,0),m.push(R.x,R.y,R.z),me.CrossToRef(M,A,P),P.normalize(),g.push(P.x,P.y,P.z,P.x,P.y,P.z),me.CrossToRef(I,M,P),P.normalize(),g.push(P.x,P.y,P.z,P.x,P.y,P.z),B=o?w!==L?d[L+1].y:d[L+1].w:d[L+1].y+(d[L+1].w-d[L+1].y)*S,v.push(d[L+1].x,Gi.UseOpenGLOrientationForUV?1-B:B),v.push(d[L+1].z,Gi.UseOpenGLOrientationForUV?1-B:B),B=o?w!==L?d[L+2].y:d[L+2].w:d[L+2].y+(d[L+2].w-d[L+2].y)*S,v.push(d[L+2].x,Gi.UseOpenGLOrientationForUV?1-B:B),v.push(d[L+2].z,Gi.UseOpenGLOrientationForUV?1-B:B),u&&(T.push(u[L+1].r,u[L+1].g,u[L+1].b,u[L+1].a),T.push(u[L+1].r,u[L+1].g,u[L+1].b,u[L+1].a),T.push(u[L+2].r,u[L+2].g,u[L+2].b,u[L+2].a),T.push(u[L+2].r,u[L+2].g,u[L+2].b,u[L+2].a))),w!==L&&(w=L)}const U=1!==h&&a?n+4:n;for(O=0,L=0;L<r;L++){let e=0,t=0,i=0,s=0;for(D=0;D<n;D++)e=O*(U+1)+D,t=(O+1)*(U+1)+D,i=O*(U+1)+(D+1),s=(O+1)*(U+1)+(D+1),p.push(e,t,i),p.push(s,i,t);1!==h&&a&&(p.push(e+2,t+2,i+2),p.push(s+2,i+2,t+2),p.push(e+4,t+4,i+4),p.push(s+4,i+4,t+4)),O=o?O+2:O+1}const k=e=>{const r=e?i/2:s/2;if(0===r)return;let o,a,l;const c=e?d[_-1]:d[0];let f=null;u&&(f=e?u[_-1]:u[0]);const b=m.length/3,E=e?t/2:-t/2,S=new me(0,E,0);m.push(S.x,S.y,S.z),g.push(0,e?1:-1,0);const x=c.y+.5*(c.w-c.y);v.push(c.x+.5*(c.z-c.x),Gi.UseOpenGLOrientationForUV?1-x:x),f&&T.push(f.r,f.g,f.b,f.a);const C=new pe(.5,.5);for(l=0;l<=n;l++){o=2*Math.PI*l*h/n;const t=Math.cos(-o),i=Math.sin(-o);a=new me(t*r,E,i*r);const s=new pe(t*C.x+.5,i*C.y+.5);m.push(a.x,a.y,a.z),g.push(0,e?1:-1,0);const d=c.y+(c.w-c.y)*s.y;v.push(c.x+(c.z-c.x)*s.x,Gi.UseOpenGLOrientationForUV?1-d:d),f&&T.push(f.r,f.g,f.b,f.a)}for(l=0;l<n;l++)e?(p.push(b),p.push(b+(l+2)),p.push(b+(l+1))):(p.push(b),p.push(b+(l+1)),p.push(b+(l+2)))};l!==jn.CAP_START&&l!==jn.CAP_ALL||k(!1),l!==jn.CAP_END&&l!==jn.CAP_ALL||k(!0),Nn._ComputeSides(c,m,p,g,v,e.frontUVs,e.backUVs);const V=new Nn;return V.indices=p,V.positions=m,V.normals=g,V.uvs=v,u&&(V.colors=T),V}function Ca(e,t={},i){const s=new jn(e,i);return t.sideOrientation=jn._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,xa(t).applyToMesh(s,t.updatable),s}Nn.CreateCylinder=xa,jn.CreateCylinder=(e,t,i,s,n,r,o,a,l)=>(void 0!==o&&o instanceof Oi||(void 0!==o&&(l=a||jn.DEFAULTSIDE,a=o),o=r,r=1),Ca(e,{height:t,diameterTop:i,diameterBottom:s,tessellation:n,subdivisions:r,sideOrientation:l,updatable:a},o));class ya{constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName="",this.onFeatureAttachObservable=new s,this.onFeatureDetachObservable=new s}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,(e=>this._onXRFrame(e))),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach((e=>{e.observable.remove(e.observer)})),this.onFeatureDetachObservable.notifyObservers(this),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t){this._removeOnDetach.push({observable:e,observer:e.add(t)})}}class Aa{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return t=this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new In("shared gizmo light",new me(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=Re.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return null==Aa._DefaultUtilityLayer?Aa._CreateDefaultUtilityLayerFromScene(u.LastCreatedScene):Aa._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return Aa._DefaultUtilityLayer=new Aa(e),Aa._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{Aa._DefaultUtilityLayer=null})),Aa._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return null==Aa._DefaultKeepDepthUtilityLayer&&(Aa._DefaultKeepDepthUtilityLayer=new Aa(u.LastCreatedScene),Aa._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,Aa._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce((()=>{Aa._DefaultKeepDepthUtilityLayer=null}))),Aa._DefaultKeepDepthUtilityLayer}constructor(e,t=!0){this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new s,this.utilityLayerScene=new Oi(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add((t=>{if(!this.utilityLayerScene.activeCamera)return;if(!this.pickingEnabled)return;if(!this.processAllEvents&&t.type!==ci.POINTERMOVE&&t.type!==ci.POINTERUP&&t.type!==ci.POINTERDOWN&&t.type!==ci.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const i=t.event;if(e.isPointerCaptured(i.pointerId))return void(this._pointerCaptures[i.pointerId]=!1);const s=i=>{let s=null;if(t.nearInteractionPickingInfo)s=t.nearInteractionPickingInfo.pickedMesh.getScene()==i?t.nearInteractionPickingInfo:new ii;else if(i!==this.utilityLayerScene&&t.originalPickingInfo)s=t.originalPickingInfo;else{let n=null;this._renderCamera&&(n=i._activeCamera,i._activeCamera=this._renderCamera,t.ray=null),s=t.ray?i.pickWithRay(t.ray):i.pick(e.pointerX,e.pointerY),n&&(i._activeCamera=n)}return s},n=s(this.utilityLayerScene);if(!t.ray&&n&&(t.ray=n.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(t),this.onlyCheckPointerDownEvents&&t.type!=ci.POINTERDOWN)return t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new _i(t.type,t.event,n),t.type),void(t.type===ci.POINTERUP&&this._pointerCaptures[i.pointerId]&&(this._pointerCaptures[i.pointerId]=!1));if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)n&&n.hit&&(t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new _i(t.type,t.event,n),t.type),t.skipOnPointerObservable=!0);else{const i=s(e),r=t.event;i&&n&&(0===n.distance&&i.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,r),t.skipOnPointerObservable=!0):t.type===ci.POINTERDOWN?this._pointerCaptures[r.pointerId]=!0:t.type!==ci.POINTERMOVE&&t.type!==ci.POINTERUP||(this._lastPointerEvents[r.pointerId]&&(this.onPointerOutObservable.notifyObservers(r.pointerId),delete this._lastPointerEvents[r.pointerId]),this._notifyObservers(t,i,r)):!this._pointerCaptures[r.pointerId]&&(n.distance<i.distance||0===i.distance)?(this._notifyObservers(t,n,r),t.skipOnPointerObservable||(t.skipOnPointerObservable=n.distance>0)):!this._pointerCaptures[r.pointerId]&&n.distance>=i.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,r),t.skipOnPointerObservable=!0):(t.type!==ci.POINTERMOVE&&t.type!==ci.POINTERUP||this._lastPointerEvents[r.pointerId]&&(this.onPointerOutObservable.notifyObservers(r.pointerId),delete this._lastPointerEvents[r.pointerId]),this._notifyObservers(t,n,r))),t.type===ci.POINTERUP&&this._pointerCaptures[r.pointerId]&&(this._pointerCaptures[r.pointerId]=!1))}})),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add((e=>{this.shouldRender&&e==this.getRenderCamera()&&this.render()})),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add((()=>{this.dispose()})),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new _i(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}Aa._DefaultUtilityLayer=null,Aa._DefaultKeepDepthUtilityLayer=null;class Ra extends ya{constructor(e,t){super(e),this._options=t,this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e.pointer);switch(this._controllers[e.uniqueId]={xrController:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new lo(new me,new me),disabledByNearInteraction:!1,id:Ra._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(e);case"gaze":return this._attachGazeMode(e);case"screen":return this._attachScreenRayMode(e)}},this._controllers={},this._tmpVectorForPickCompare=new me,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new Re(.9,.9,.9),this.laserPointerDefaultColor=new Re(.7,.7,.7),this.selectionMeshDefaultColor=new Re(.8,.8,.8),this.selectionMeshPickedColor=new Re(.3,.3,1),this._identityMatrix=Te.Identity(),this._screenCoordinatesRef=me.Zero(),this._viewportRef=new Ut(0,0,0,0),this._scene=this._xrSessionManager.scene}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new lo(new me,new me),disabledByNearInteraction:!1,id:Ra._IdCounter++},this._attachGazeMode()}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){const i=Object.keys(this._controllers);for(let s=0;s<i.length;++s)if(this._controllers[i[s]].id===e)return void(this._controllers[i[s]].disabledByNearInteraction=t)}_onXRFrame(e){Object.keys(this._controllers).forEach((e=>{const t=this._controllers[e];if(!this._options.enablePointerSelectionOnAllControllers&&e!==this._attachedController||t.disabledByNearInteraction)return t.selectionMesh.isVisible=!1,t.laserPointer.isVisible=!1,void(t.pick=null);let i;if(t.laserPointer.isVisible=this.displayLaserPointer,t.xrController)i=t.xrController.pointer.position,t.xrController.getWorldPointerRayToRef(t.tmpRay);else{if(!t.webXRCamera)return;i=t.webXRCamera.position,t.webXRCamera.getForwardRayToRef(t.tmpRay)}if(this._options.maxPointerDistance&&(t.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&i){const e=this._xrSessionManager.scene,s=this._options.xrInput.xrCamera;s&&(s.viewport.toGlobalToRef(e.getEngine().getRenderWidth(),e.getEngine().getRenderHeight(),this._viewportRef),me.ProjectToRef(i,this._identityMatrix,e.getTransformMatrix(),this._viewportRef,this._screenCoordinatesRef),"number"!=typeof this._screenCoordinatesRef.x||"number"!=typeof this._screenCoordinatesRef.y||isNaN(this._screenCoordinatesRef.x)||isNaN(this._screenCoordinatesRef.y)||(e.pointerX=this._screenCoordinatesRef.x,e.pointerY=this._screenCoordinatesRef.y,t.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let s=null;this._utilityLayerScene&&(s=this._utilityLayerScene.pickWithRay(t.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const n=this._scene.pickWithRay(t.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);s&&s.hit?n&&n.hit?s.distance<n.distance?t.pick=s:t.pick=n:t.pick=s:t.pick=n,t.pick&&t.xrController&&(t.pick.aimTransform=t.xrController.pointer,t.pick.gripTransform=t.xrController.grip||null);const r=t.pick;if(r&&r.pickedPoint&&r.hit){this._updatePointerDistance(t.laserPointer,r.distance),t.selectionMesh.position.copyFrom(r.pickedPoint),t.selectionMesh.scaling.x=Math.sqrt(r.distance),t.selectionMesh.scaling.y=Math.sqrt(r.distance),t.selectionMesh.scaling.z=Math.sqrt(r.distance);const e=this._convertNormalToDirectionOfRay(r.getNormal(!0),t.tmpRay),i=.001;if(t.selectionMesh.position.copyFrom(r.pickedPoint),e){const s=me.Cross(nn.Y,e),n=me.Cross(e,s);me.RotationFromAxisToRef(n,e,s,t.selectionMesh.rotation),t.selectionMesh.position.addInPlace(e.scale(i))}t.selectionMesh.isVisible=this.displaySelectionMesh,t.meshUnderPointer=r.pickedMesh}else t.selectionMesh.isVisible=!1,this._updatePointerDistance(t.laserPointer,1),t.meshUnderPointer=null}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Aa.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,s=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let n=new ii;const r=Mo("selection",{diameter:.0525,thickness:.015,tessellation:20},s);r.isVisible=!1,r.isPickable=!1,r.parent=t.selectionMesh;let o=0,a=!1;const l={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{if(t.pick){if(this._augmentPointerInit(l,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,r.isVisible=!1,t.pick.hit)if(this._pickingMoved(n,t.pick))a&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,l)),a=!1,o=0;else if(o>i/10&&(r.isVisible=!0),o+=this._scene.getEngine().getDeltaTime(),o>=i)this._scene.simulatePointerDown(t.pick,l),a=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,l),r.isVisible=!1;else{const e=1-o/i;r.scaling.set(e,e,e)}else a=!1,o=0;this._scene.simulatePointerMove(t.pick,l),n=t.pick}})),void 0!==this._options.renderingGroupId&&(r.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce((()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&a&&(this._scene.simulatePointerUp(t.pick,l),t.finalPointerUpTriggered=!0),r.dispose()}))}_attachScreenRayMode(e){const t=this._controllers[e.uniqueId];let i=!1;const s={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{this._augmentPointerInit(s,t.id,t.screenCoordinates),!t.pick||this._options.disablePointerUpOnTouchOut&&i||(i?this._scene.simulatePointerMove(t.pick,s):(this._scene.simulatePointerDown(t.pick,s),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,s)))})),e.onDisposeObservable.addOnce((()=>{this._augmentPointerInit(s,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame((()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,s),t.finalPointerUpTriggered=!0)}))}))}_attachTrackedPointerRayMode(e){const t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))})),e.inputSource.gamepad){const s=s=>{this._options.overrideButtonId&&(t.selectionComponent=s.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=s.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((s=>{if(s.changes.pressed){const n=s.changes.pressed.current;t.pick?(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),n?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)):!n||this._options.enablePointerSelectionOnAllControllers||this._options.disableSwitchOnClick||(this._attachedController=e.uniqueId)}}))};e.motionController?s(e.motionController):e.onMotionControllerInitObservable.add(s)}else{const e=e=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)},s=e=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)};t.eventListeners={selectend:s,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",s)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(me.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){const t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),!t.finalPointerUpTriggered&&t.pointerDownTriggered){const e={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame((()=>{this._augmentPointerInit(e,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new ii,e),t.finalPointerUpTriggered=!0}))}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce((()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}catch(e){Ot.Warn("controller already detached.")}}))}}_generateNewMeshPair(e){const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Aa.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():Ca("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;const s=new zs("laserPointerMat",t);s.emissiveColor=this.laserPointerDefaultColor,s.alpha=.7,i.material=s,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;const n=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():Mo("gazeTracker",{diameter:.0105,thickness:.0075,tessellation:20},t);n.bakeCurrentTransformIntoVertices(),n.isPickable=!1,n.isVisible=!1;const r=new zs("targetMat",t);return r.specularColor=Re.Black(),r.emissiveColor=this.selectionMeshDefaultColor,r.backFaceCulling=!1,n.material=r,void 0!==this._options.renderingGroupId&&(i.renderingGroupId=this._options.renderingGroupId,n.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:n}}_pickingMoved(e,t){var i;if(!e.hit||!t.hit)return!0;if(!(e.pickedMesh&&e.pickedPoint&&t.pickedMesh&&t.pickedPoint))return!0;if(e.pickedMesh!==t.pickedMesh)return!0;null===(i=e.pickedPoint)||void 0===i||i.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const s=.01*(this._options.gazeModePointerMovedFactor||1)*t.distance;return this._tmpVectorForPickCompare.length()>s}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}var Ia,Pa,Ma,Oa,Da,Na,Fa,La;Ra._IdCounter=200,Ra.Name=ra.POINTER_SELECTION,Ra.Version=1,oa.AddWebXRFeature(Ra.Name,((e,t)=>()=>new Ra(e,t)),Ra.Version,!0),function(e){e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Vector2=4]="Vector2",e[e.Vector3=8]="Vector3",e[e.Vector4=16]="Vector4",e[e.Color3=32]="Color3",e[e.Color4=64]="Color4",e[e.Matrix=128]="Matrix",e[e.Object=256]="Object",e[e.AutoDetect=1024]="AutoDetect",e[e.BasedOnInput=2048]="BasedOnInput",e[e.All=4095]="All"}(Ia||(Ia={})),function(e){e[e.Vertex=1]="Vertex",e[e.Fragment=2]="Fragment",e[e.Neutral=4]="Neutral",e[e.VertexAndFragment=3]="VertexAndFragment"}(Pa||(Pa={}));class wa{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}finalize(e){const t=e.sharedData.emitComments,i=this.target===Pa.Fragment;this.compilationString=`\n${t?"//Entry point\n":""}void main(void) {\n${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\n${t?"//Constants\n":""}${this._constantDeclaration}\n${this.compilationString}`);let s="";for(const e in this.functions)s+=this.functions[e]+"\n";this.compilationString=`\n${s}\n${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\n${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\n${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\n}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\n${t?"//Varyings\n":""}${this.sharedData.varyingDeclaration}\n${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\n${t?"//Samplers\n":""}${this._samplerDeclaration}\n${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\n${t?"//Uniforms\n":""}${this._uniformDeclaration}\n${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`\n${t?"//Attributes\n":""}${this._attributeDeclaration}\n${this.compilationString}`),this.compilationString="precision highp float;\n"+this.compilationString,this.compilationString="#if defined(WEBGL2) || defines(WEBGPU)\nprecision highp sampler2DArray;\n#endif\n"+this.compilationString,i&&(this.compilationString="#if defined(PREPASS)\r\n#extension GL_EXT_draw_buffers : require\r\nlayout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r\nhighp vec4 gl_FragColor;\r\n#endif\r\n"+this.compilationString);for(const e in this.extensions){const t=this.extensions[e];this.compilationString=`\n${t}\n${this.compilationString}`}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),void 0===this.sharedData.variableNames[e]?(this.sharedData.variableNames[e]=0,"output"===e||"texture"===e?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return void 0===this.sharedData.defineNames[e]?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2D ${e};\n`,this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};\n`,this.samplers.push(e))}_getGLType(e){switch(e){case Ia.Float:return"float";case Ia.Int:return"int";case Ia.Vector2:return"vec2";case Ia.Color3:case Ia.Vector3:return"vec3";case Ia.Color4:case Ia.Vector4:return"vec4";case Ia.Matrix:return"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}\n${t}\n#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+"\n"+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\n`;let s=L.IncludesShadersStore[e]+"\n";if(this.sharedData.emitComments&&(s=t+"\n"+s),!i)return s;if(i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){const t=i.replaceStrings[e];s=s.replace(t.search,t.replace)}return s}_emitFunctionFromInclude(e,t,i,s=""){const n=e+s;if(!this.functions[n]){if(!i||!(i.removeAttributes||i.removeUniforms||i.removeVaryings||i.removeIfDef||i.replaceStrings))return i&&i.repeatKey?this.functions[n]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]\n`:this.functions[n]=`#include<${e}>${(null==i?void 0:i.substitutionVars)?"("+(null==i?void 0:i.substitutionVars)+")":""}\n`,void(this.sharedData.emitComments&&(this.functions[n]=t+"\n"+this.functions[n]));if(this.functions[n]=L.IncludesShadersStore[e],this.sharedData.emitComments&&(this.functions[n]=t+"\n"+this.functions[n]),i.removeIfDef&&(this.functions[n]=this.functions[n].replace(/^\s*?#ifdef.+$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#endif.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#else.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[n]=this.functions[n].replace(/\s*?attribute .+?;/g,"\n")),i.removeUniforms&&(this.functions[n]=this.functions[n].replace(/\s*?uniform .*?;/g,"\n")),i.removeVaryings&&(this.functions[n]=this.functions[n].replace(/\s*?(varying|in) .+?;/g,"\n")),i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){const t=i.replaceStrings[e];this.functions[n]=this.functions[n].replace(t.search,t.replace)}}}_registerTempVariable(e){return-1===this.sharedData.temps.indexOf(e)&&(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",s=!1){return-1===this.sharedData.varyings.indexOf(e)&&(this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}\n`:this.sharedData.varyingDeclaration+=`${s?"#ifndef":"#ifdef"} ${i}\n`),this.sharedData.varyingDeclaration+=`varying ${t} ${e};\n`,i&&(this.sharedData.varyingDeclaration+="#endif\n"),!0)}_emitUniformFromString(e,t,i="",s=!1){-1===this.uniforms.indexOf(e)&&(this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}\n`:this._uniformDeclaration+=`${s?"#ifndef":"#ifdef"} ${i}\n`),this._uniformDeclaration+=`uniform ${t} ${e};\n`,i&&(this._uniformDeclaration+="#endif\n"))}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}}class Ba{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(){let e="";this.checks.emitVertex||this.allowEmptyVertexProgram||(e+="NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\n"),this.checks.emitFragment||(e+="NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\n");for(const t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.\n`;if(e)throw"Build of NodeMaterial failed:\n"+e}}!function(e){e[e.Compatible=0]="Compatible",e[e.TypeIncompatible=1]="TypeIncompatible",e[e.TargetIncompatible=2]="TargetIncompatible",e[e.HierarchyIssue=3]="HierarchyIssue"}(Ma||(Ma={})),function(e){e[e.Input=0]="Input",e[e.Output=1]="Output"}(Oa||(Oa={}));class Ua{static AreEquivalentTypes(e,t){switch(e){case Ia.Vector3:if(t===Ia.Color3)return!0;break;case Ia.Vector4:if(t===Ia.Color4)return!0;break;case Ia.Color3:if(t===Ia.Vector3)return!0;break;case Ia.Color4:if(t===Ia.Vector4)return!0}return!1}get direction(){return this._direction}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===Ia.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===Ia.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get target(){return this._prioritizeVertex&&this._ownerBlock?this._target!==Pa.VertexAndFragment?this._target:this._ownerBlock.target===Pa.Fragment?Pa.Fragment:Pa.Vertex:this._target}set target(e){this._target=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get isConnectedToInputBlock(){return null!==this.connectedPoint&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map((e=>e.ownerBlock))}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===Pa.Vertex)return!0;if((e.ownerBlock.target===Pa.Neutral||e.ownerBlock.target===Pa.VertexAndFragment)&&e.ownerBlock.outputs.some((e=>e.isDirectlyConnectedToVertexOutput)))return!0}return!1}get isConnectedInVertexShader(){if(this.target===Pa.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===Pa.Vertex)return!0;if(e.target===Pa.Vertex)return!0;if((e.ownerBlock.target===Pa.Neutral||e.ownerBlock.target===Pa.VertexAndFragment)&&e.ownerBlock.outputs.some((e=>e.isConnectedInVertexShader)))return!0}return!1}get isConnectedInFragmentShader(){if(this.target===Pa.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints){if(e.ownerBlock.target===Pa.Fragment)return!0;if((e.ownerBlock.target===Pa.Neutral||e.ownerBlock.target===Pa.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0}return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=Ia.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new s,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=Pa.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===Ma.Compatible}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===Pa.Fragment){if(i.target===Pa.Vertex)return Ma.TargetIncompatible;for(const e of i.outputs)if(e.ownerBlock.target!=Pa.Neutral&&e.isConnectedInVertexShader)return Ma.TargetIncompatible}if(this.type!==e.type&&e.innerType!==Ia.AutoDetect)return Ua.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)||e._acceptedConnectionPointType&&Ua.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?Ma.Compatible:Ma.TypeIncompatible;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return Ma.TypeIncompatible;let s=i,n=t;return this.direction===Oa.Input&&(s=t,n=i),s.isAnAncestorOf(n)?Ma.HierarchyIssue:Ma.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return-1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<Ia.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear()}}class ka{get name(){return this._name}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){0==(this._target&e)&&(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter((t=>t.name===e));return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter((t=>t.name===e));return t.length?t[0]:null}constructor(e,t=Pa.Vertex,i=!1){this._isFinalMerger=!1,this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===Pa.Neutral,this._isFinalMerger=i,this._isInput="InputBlock"===this.getClassName(),this._isTeleportOut="NodeMaterialTeleportOutBlock"===this.getClassName(),this._isTeleportIn="NodeMaterialTeleportInBlock"===this.getClassName(),this._name=e,this.uniqueId=Ii.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===Pa.Neutral}initialize(e){}bind(e,t,i,s){}_declareOutput(e,t){return`${t._getGLType(e.type)} ${e.associatedVariableName}`}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return-1===t.indexOf(".")&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some((e=>e.isConnectedInFragmentShader))}registerInput(e,t,i=!1,s,n){return(n=null!=n?n:new Ua(e,this,Oa.Input)).type=t,n.isOptional=i,s&&(n.target=s),this._inputs.push(n),this}registerOutput(e,t,i,s){return(s=null!=s?s:new Ua(e,this,Oa.Output)).type=t,i&&(s.target=i),this._outputs.push(s),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!(t.connectedPoint||e&&e.type!==t.type&&t.type!==Ia.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===Pa.Neutral||0!=(e.target&t.target))return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return-1===t||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(t.hasEndpoints)for(const i of t.endpoints){if(i.ownerBlock===e)return!0;if(i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(0===this._outputs.length)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),s=!0;for(;s;){const n=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&n&&i.canConnectTo(n))i.connectTo(n),s=!1;else{if(!i)throw"Unable to find a compatible match";i=this.getSiblingOutput(i)}}return this}_buildBlock(e){}updateUniformsAndSamples(e,t,i,s){}provideFallbacks(e,t){}initializeDefines(e,t,i,s=!1){}prepareDefines(e,t,i,s=!1,n){}autoConfigure(e,t=(()=>!0)){}replaceRepeatableContent(e,t,i,s){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return!(this.isInput||this.isFinalMerger||this._outputs.some((e=>e.isDirectlyConnectedToVertexOutput))||this.target===Pa.Vertex||this.target!==Pa.VertexAndFragment&&this.target!==Pa.Neutral||!this._outputs.some((e=>e.isConnectedInVertexShader)))}isReady(e,t,i,s=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,s){e.build(t,s);const n=null!=t._vertexState,r=e._buildTarget===Pa.Vertex&&e.target!==Pa.VertexAndFragment;if(n&&(0==(e.target&e._buildTarget)||0==(e.target&i.target)||this.target!==Pa.VertexAndFragment&&r)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const e=i.connectedPoint;t._vertexState._emitVaryingFromString("v_"+e.associatedVariableName,t._getGLType(e.type))&&(t._vertexState.compilationString+=`${"v_"+e.associatedVariableName} = ${e.associatedVariableName};\n`),i.associatedVariableName="v_"+e.associatedVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const t of this._outputs)t.associatedVariableName||(t.associatedVariableName=e._getFreeVariableName(t.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==Pa.Neutral){if(0==(i.target&this.target))continue;if(0==(i.target&e.target))continue}const s=i.connectedPoint.ownerBlock;s&&s!==this&&this._processBuild(s,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&p.Log(`${e.target===Pa.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case Pa.Vertex:e.sharedData.checks.emitVertex=!0;break;case Pa.Fragment:e.sharedData.checks.emitFragment=!0}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\n//${this.name}\n`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if(0!=(i.target&e.target))for(const s of i.endpoints){const i=s.ownerBlock;i&&0!=(i.target&e.target)&&-1!==t.indexOf(i)&&this._processBuild(i,e,s,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\n${e}.visibleOnFrame = ${this.visibleOnFrame};\n${e}.target = ${this.target};\n`}_dumpCode(e,t){t.push(this);const i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do{t++,this._codeVariableName=i+t}while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let s=`\n// ${this.getClassName()}\n`;this.comments&&(s+=`// ${this.comments}\n`),s+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\n`,s+=this._dumpPropertiesCode();for(const i of this.inputs){if(!i.isConnected)continue;const n=i.connectedPoint.ownerBlock;-1===t.indexOf(n)&&(s+=n._dumpCode(e,t))}for(const i of this.outputs)if(i.hasEndpoints)for(const n of i.endpoints){const i=n.ownerBlock;i&&-1===t.indexOf(i)&&(s+=i._dumpCode(e,t))}return s}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const s=i.connectedPoint,n=s.ownerBlock;t+=n._dumpCodeForOutputConnections(e),t+=`${n._codeVariableName}.${n._outputRename(s.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\n`}return t}clone(e,t=""){const i=this.serialize(),s=_e(i.customType);if(s){const n=new s;return n._deserialize(i,e,t),n}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i){var s;this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=null!==(s=e.target)&&void 0!==s?s:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach(((e,t)=>{e.displayName&&(this.inputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.inputs[t].isExposedOnFrame=e.isExposedOnFrame,this.inputs[t].exposedPortPosition=e.exposedPortPosition)})),i&&i.forEach(((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)}))}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class Va extends ka{constructor(e){super(e,Pa.Neutral),this.complementW=1,this.complementZ=0,this.target=Pa.Vertex,this.registerInput("vector",Ia.AutoDetect),this.registerInput("transform",Ia.Matrix),this.registerOutput("output",Ia.Vector4),this.registerOutput("xyz",Ia.Vector3),this._inputs[0].onConnectionObservable.add((e=>{if(e.ownerBlock.isInput){const t=e.ownerBlock;"normal"!==t.name&&"tangent"!==t.name||(this.complementW=0)}}))}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform;if(t.connectedPoint){if(0===this.complementW){const s=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",s),e.sharedData.blocksWithDefines.push(this);const n=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.compilationString+=`mat3 ${n} = mat3(${i.associatedVariableName});\n`,e.compilationString+="#ifdef NONUNIFORMSCALING\n",e.compilationString+=`${n} = transposeMat3(inverseMat3(${n}));\n`,e.compilationString+="#endif\n",t.connectedPoint.type){case Ia.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${n} * vec3(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\n`;break;case Ia.Vector3:case Ia.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${n} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\n`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${n} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\n`}}else{const s=i.associatedVariableName;switch(t.connectedPoint.type){case Ia.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\n`;break;case Ia.Vector3:case Ia.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\n`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * ${t.associatedVariableName};\n`}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\n`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=void 0!==e.complementZ?e.complementZ:0,this.complementW=void 0!==e.complementW?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\n`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\n`,e}}ue("BABYLON.TransformBlock",Va);class Ga extends ka{constructor(e){super(e,Pa.Vertex,!0),this.registerInput("vector",Ia.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(const t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector;return e.compilationString+=`gl_Position = ${t.associatedVariableName};\n`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.compilationString+="vFragmentDepth = 1.0 + gl_Position.w;\n",e.compilationString+="gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\n"),this}}function za(e,t=Da.Boolean,i="PROPERTIES",s){return(n,r)=>{let o=n._propStore;o||(o=[],n._propStore=o),o.push({propertyName:r,displayName:e,type:t,groupName:i,options:null!=s?s:{}})}}ue("BABYLON.VertexOutputBlock",Ga),function(e){e[e.Boolean=0]="Boolean",e[e.Float=1]="Float",e[e.Int=2]="Int",e[e.Vector2=3]="Vector2",e[e.List=4]="List"}(Da||(Da={}));class Ha extends ka{constructor(e){super(e,Pa.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",Ia.Color4,!0),this.registerInput("rgb",Ia.AutoDetect,!0),this.registerInput("a",Ia.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Vector3|Ia.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&wi.BindLogDepth(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,s=this.a;e.sharedData.hints.needAlphaBlending=t.isConnected||s.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const n=`//${this.name}`;if(e._emitFunctionFromInclude("helperFunctions",n),t.connectedPoint)s.isConnected?e.compilationString+=`gl_FragColor = vec4(${t.associatedVariableName}.rgb, ${s.associatedVariableName});\n`:e.compilationString+=`gl_FragColor = ${t.associatedVariableName};\n`;else if(i.connectedPoint){let t="1.0";s.connectedPoint&&(t=s.associatedVariableName),i.connectedPoint.type===Ia.Float?e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${t});\n`:e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}, ${t});\n`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+="gl_FragColor = toLinearSpace(gl_FragColor);\n",e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+="gl_FragColor = toGammaSpace(gl_FragColor);\n",e.compilationString+="#endif\n",(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e.compilationString+="gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\n"),e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+="gl_FragData[0] = gl_FragColor;\r\n",e.compilationString+="#endif\r\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\n`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace,this.useLogarithmicDepth=null!==(s=e.useLogarithmicDepth)&&void 0!==s&&s}}De([za("Convert to gamma space",Da.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Ha.prototype,"convertToGammaSpace",void 0),De([za("Convert to linear space",Da.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Ha.prototype,"convertToLinearSpace",void 0),De([za("Use logarithmic depth",Da.Boolean,"PROPERTIES")],Ha.prototype,"useLogarithmicDepth",void 0),ue("BABYLON.FragmentOutputBlock",Ha),function(e){e[e.Uniform=0]="Uniform",e[e.Attribute=1]="Attribute",e[e.Varying=2]="Varying",e[e.Undefined=3]="Undefined"}(Na||(Na={})),function(e){e[e.World=1]="World",e[e.View=2]="View",e[e.Projection=3]="Projection",e[e.ViewProjection=4]="ViewProjection",e[e.WorldView=5]="WorldView",e[e.WorldViewProjection=6]="WorldViewProjection",e[e.CameraPosition=7]="CameraPosition",e[e.FogColor=8]="FogColor",e[e.DeltaTime=9]="DeltaTime",e[e.CameraParameters=10]="CameraParameters",e[e.MaterialAlpha=11]="MaterialAlpha"}(Fa||(Fa={})),function(e){e[e.None=0]="None",e[e.Time=1]="Time",e[e.RealTime=2]="RealTime"}(La||(La={}));const Wa={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},Xa={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},Qa={particle_texturemask:!0};class Ya extends ka{get type(){if(this._type===Ia.AutoDetect){if(this.isUniform&&null!=this.value){if(!isNaN(this.value))return this._type=Ia.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=Ia.Vector2,this._type;case"Vector3":return this._type=Ia.Vector3,this._type;case"Vector4":return this._type=Ia.Vector4,this._type;case"Color3":return this._type=Ia.Color3,this._type;case"Color4":return this._type=Ia.Color4,this._type;case"Matrix":return this._type=Ia.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=Ia.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=Ia.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=Ia.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=Ia.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case Fa.World:case Fa.WorldView:case Fa.WorldViewProjection:case Fa.View:case Fa.ViewProjection:case Fa.Projection:return this._type=Ia.Matrix,this._type;case Fa.CameraPosition:return this._type=Ia.Vector3,this._type;case Fa.FogColor:return this._type=Ia.Color3,this._type;case Fa.DeltaTime:case Fa.MaterialAlpha:return this._type=Ia.Float,this._type;case Fa.CameraParameters:return this._type=Ia.Vector4,this._type}}return this._type}constructor(e,t=Pa.Vertex,i=Ia.AutoDetect){super(e,t,!1),this._mode=Na.Undefined,this._animationType=La.None,this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new s,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return!!this.isAttribute||super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=Na.Attribute,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===Ia.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=Na.Uniform,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=Na.Uniform}get associatedVariableName(){return this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===Na.Undefined}get isUniform(){return this._mode===Na.Uniform}set isUniform(e){this._mode=e?Na.Uniform:Na.Undefined,this.associatedVariableName=""}get isAttribute(){return this._mode===Na.Attribute}set isAttribute(e){this._mode=e?Na.Attribute:Na.Undefined,this.associatedVariableName=""}get isVarying(){return this._mode===Na.Varying}set isVarying(e){this._mode=e?Na.Varying:Na.Undefined,this.associatedVariableName=""}get isSystemValue(){return null!=this._systemValue}get systemValue(){return this._systemValue}set systemValue(e){this._mode=Na.Uniform,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case La.Time:this.type===Ia.Float&&(this.value+=.01*e.getAnimationRatio());break;case La.RealTime:this.type===Ia.Float&&(this.value=(j.Now-e.getEngine().startTime)/1e3)}}_emitDefine(e){return"!"===e[0]?`#ifndef ${e.substring(1)}\n`:`#ifdef ${e}\n`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case Ia.Float:this.value=0;break;case Ia.Vector2:this.value=pe.Zero();break;case Ia.Vector3:this.value=me.Zero();break;case Ia.Vector4:this.value=ge.Zero();break;case Ia.Color3:this.value=Re.White();break;case Ia.Color4:this.value=new Ie(1,1,1,1);break;case Ia.Matrix:this.value=Te.Identity()}}_emitConstant(e){switch(this.type){case Ia.Float:return`${e._emitFloat(this.value)}`;case Ia.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case Ia.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case Ia.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case Ia.Color3:return Pe.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&Pe.Color3[0].toGammaSpaceToRef(Pe.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Pe.Color3[0].toLinearSpaceToRef(Pe.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${Pe.Color3[0].r}, ${Pe.Color3[0].g}, ${Pe.Color3[0].b})`;case Ia.Color4:return Pe.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&Pe.Color4[0].toGammaSpaceToRef(Pe.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Pe.Color4[0].toLinearSpaceToRef(Pe.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${Pe.Color4[0].r}, ${Pe.Color4[0].g}, ${Pe.Color4[0].b}, ${Pe.Color4[0].a})`}return""}get _noContextSwitch(){return Xa[this.name]}_emit(e,t){var i;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(-1!==e.constants.indexOf(this.associatedVariableName))return;return e.constants.push(this.associatedVariableName),void(e._constantDeclaration+=this._declareOutput(this.output,e)+` = ${this._emitConstant(e)};\n`)}if(-1!==e.uniforms.indexOf(this.associatedVariableName))return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t)),e._uniformDeclaration+=`uniform ${e._getGLType(this.type)} ${this.associatedVariableName};\n`,t&&(e._uniformDeclaration+="#endif\n");const i=e.sharedData.hints;if(null!==this._systemValue&&void 0!==this._systemValue)switch(this._systemValue){case Fa.WorldView:i.needWorldViewMatrix=!0;break;case Fa.WorldViewProjection:i.needWorldViewProjectionMatrix=!0}else this._animationType!==La.None&&e.sharedData.animatedInputs.push(this)}else if(this.isAttribute){if(this.associatedVariableName=null!==(i=Wa[this.name])&&void 0!==i?i:this.name,this.target===Pa.Vertex&&e._vertexState)return void(Xa[this.name]?Qa[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):this._emit(e._vertexState,t));if(-1!==e.attributes.indexOf(this.associatedVariableName))return;e.attributes.push(this.associatedVariableName),Xa[this.name]?Qa[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):(t&&(e._attributeDeclaration+=this._emitDefine(t)),e._attributeDeclaration+=`attribute ${e._getGLType(this.type)} ${this.associatedVariableName};\n`,t&&(e._attributeDeclaration+="#endif\n"))}}_transmitWorld(e,t,i,s){if(!this._systemValue)return;const n=this.associatedVariableName;switch(this._systemValue){case Fa.World:e.setMatrix(n,t);break;case Fa.WorldView:e.setMatrix(n,i);break;case Fa.WorldViewProjection:e.setMatrix(n,s)}}_transmit(e,t,i){if(this.isAttribute)return;const s=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case Fa.World:case Fa.WorldView:case Fa.WorldViewProjection:return;case Fa.View:e.setMatrix(s,t.getViewMatrix());break;case Fa.Projection:e.setMatrix(s,t.getProjectionMatrix());break;case Fa.ViewProjection:e.setMatrix(s,t.getTransformMatrix());break;case Fa.CameraPosition:t.bindEyePosition(e,s,!0);break;case Fa.FogColor:e.setColor3(s,t.fogColor);break;case Fa.DeltaTime:e.setFloat(s,t.deltaTime/1e3);break;case Fa.CameraParameters:t.activeCamera&&e.setFloat4(s,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case Fa.MaterialAlpha:e.setFloat(s,i.alpha)}return}const n=this._valueCallback?this._valueCallback():this._storedValue;if(null!==n)switch(this.type){case Ia.Float:e.setFloat(s,n);break;case Ia.Int:e.setInt(s,n);break;case Ia.Color3:Pe.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&Pe.Color3[0].toGammaSpaceToRef(Pe.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Pe.Color3[0].toLinearSpaceToRef(Pe.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(s,Pe.Color3[0]);break;case Ia.Color4:Pe.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&Pe.Color4[0].toGammaSpaceToRef(Pe.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&Pe.Color4[0].toLinearSpaceToRef(Pe.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(s,Pe.Color4[0]);break;case Ia.Vector2:e.setVector2(s,n);break;case Ia.Vector3:e.setVector3(s,n);break;case Ia.Vector4:e.setVector4(s,n);break;case Ia.Matrix:e.setMatrix(s,n)}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\n`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${Fa[this._systemValue]});\n`;if(this.isUniform){const t=[];let i="";switch(this.type){case Ia.Float:i=`${this.value}`;break;case Ia.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case Ia.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case Ia.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case Ia.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case Ia.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case Ia.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`}return t.push(`${e}.value = ${i}`),this.type===Ia.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${La[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(";\n")}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,null!=this._storedValue&&this._mode===Na.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,"tangent"===e.name&&e.mode===Na.Attribute&&e.type===Ia.Vector3&&(this._type=Ia.Vector4),e.valueType)if("number"===e.valueType)this._storedValue=e.value;else{const t=_e(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}ue("BABYLON.InputBlock",Ya);class Ka extends ka{constructor(e){super(e,Pa.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",Ia.AutoDetect,!1,Pa.VertexAndFragment),this.registerOutput("rgba",Ia.Color4,Pa.Neutral),this.registerOutput("rgb",Ia.Color3,Pa.Neutral),this.registerOutput("r",Ia.Float,Pa.Neutral),this.registerOutput("g",Ia.Float,Pa.Neutral),this.registerOutput("b",Ia.Float,Pa.Neutral),this.registerOutput("a",Ia.Float,Pa.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Vector2|Ia.Vector3|Ia.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?Pa.VertexAndFragment:Pa.Fragment:Pa.VertexAndFragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec2")),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===Pa.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\n`}else this.uv.ownerBlock.target!==Pa.Fragment?e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\n`:e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\n`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===Pa.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target!==Pa.Fragment?(e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n"):e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==Pa.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=zi.Parse(e.texture,t,i))}}ue("BABYLON.CurrentScreenBlock",Ka);class ja extends ka{constructor(e){super(e,Pa.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",Ia.AutoDetect,!1,Pa.VertexAndFragment),this.registerOutput("rgba",Ia.Color4,Pa.Neutral),this.registerOutput("rgb",Ia.Color3,Pa.Neutral),this.registerOutput("r",Ia.Float,Pa.Neutral),this.registerOutput("g",Ia.Float,Pa.Neutral),this.registerOutput("b",Ia.Float,Pa.Neutral),this.registerOutput("a",Ia.Float,Pa.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Vector2|Ia.Vector3|Ia.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=(()=>!0)){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"particle_uv"===e.name&&t(e)));i||(i=new Ya("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`,e.compilationString+=`#ifdef ${this._linearDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+=`#ifdef ${this._gammaDefineName}\n`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n`,e.compilationString+="#endif\n"}_buildBlock(e){if(super._buildBlock(e),e.target===Pa.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this.uv.associatedVariableName});\n`;for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,t.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=zi.Parse(e.texture,t,i))}}ue("BABYLON.ParticleTextureBlock",ja);class $a extends ka{constructor(e){super(e,Pa.Fragment),this._isUnique=!0,this.registerInput("color",Ia.Color4,!1,Pa.Fragment),this.registerOutput("rampColor",Ia.Color4,Pa.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==Pa.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`\n            #ifdef RAMPGRADIENT\n                vec4 baseColor = ${this.color.associatedVariableName};\n                float alpha = ${this.color.associatedVariableName}.a;\n\n                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);\n\n                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));\n                baseColor.rgb *= rampColor.rgb;\n\n                // Remapped alpha\n                float finalAlpha = baseColor.a;\n                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);\n\n                ${this._declareOutput(this.rampColor,e)} = baseColor;\n            #else\n                ${this._declareOutput(this.rampColor,e)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}ue("BABYLON.ParticleRampGradientBlock",$a);class qa extends ka{constructor(e){super(e,Pa.Fragment),this._isUnique=!0,this.registerInput("color",Ia.Color4,!1,Pa.Fragment),this.registerInput("alphaTexture",Ia.Float,!1,Pa.Fragment),this.registerInput("alphaColor",Ia.Float,!1,Pa.Fragment),this.registerOutput("blendColor",Ia.Color4,Pa.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==Pa.Vertex)return e.compilationString+=`\n            #ifdef BLENDMULTIPLYMODE\n                ${this._declareOutput(this.blendColor,e)};\n                float sourceAlpha = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};\n                ${this.blendColor.associatedVariableName}.rgb = ${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);\n                ${this.blendColor.associatedVariableName}.a = ${this.color.associatedVariableName}.a;\n            #else\n                ${this._declareOutput(this.blendColor,e)} = ${this.color.associatedVariableName};\n            #endif\n        `,this}}ue("BABYLON.ParticleBlendMultiplyBlock",qa);class Za extends ka{constructor(e){super(e,Pa.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",Ia.Vector4,!0),this.registerInput("xyz ",Ia.Vector3,!0),this.registerInput("xy ",Ia.Vector2,!0),this.registerInput("zw ",Ia.Vector2,!0),this.registerInput("x",Ia.Float,!0),this.registerInput("y",Ia.Float,!0),this.registerInput("z",Ia.Float,!0),this.registerInput("w",Ia.Float,!0),this.registerOutput("xyzw",Ia.Vector4),this.registerOutput("xyz",Ia.Vector3),this.registerOutput("xy",Ia.Vector2),this.registerOutput("zw",Ia.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,s=this.z,n=this.w,r=this.xyIn,o=this.zwIn,a=this.xyzIn,l=this.xyzwIn,h=this._outputs[0],c=this._outputs[1],d=this._outputs[2],u=this._outputs[3];return l.isConnected?(h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = ${l.associatedVariableName}${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};\n`)):a.isConnected?(h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = vec4(${a.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = ${a.associatedVariableName}${this._buildSwizzle(3)};\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};\n`)):r.isConnected?(h.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(h,e)+` = vec4(${r.associatedVariableName}, ${o.associatedVariableName})${this._buildSwizzle(4)};\n`:e.compilationString+=this._declareOutput(h,e)+` = vec4(${r.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = vec3(${r.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${r.associatedVariableName}${this._buildSwizzle(2)};\n`),u.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(u,e)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\n`:e.compilationString+=this._declareOutput(u,e)+` = vec2(${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};\n`)):(h.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(h,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${o.associatedVariableName})${this._buildSwizzle(4)};\n`:e.compilationString+=this._declareOutput(h,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\n`),c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\n`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = vec2(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};\n`),u.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(u,e)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\n`:e.compilationString+=this._declareOutput(u,e)+` = vec2(${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};\n`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){var s,n,r,o;super._deserialize(e,t,i),this.xSwizzle=null!==(s=e.xSwizzle)&&void 0!==s?s:"x",this.ySwizzle=null!==(n=e.ySwizzle)&&void 0!==n?n:"y",this.zSwizzle=null!==(r=e.zSwizzle)&&void 0!==r?r:"z",this.wSwizzle=null!==(o=e.wSwizzle)&&void 0!==o?o:"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\n`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\n`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\n`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\n`,e}}ue("BABYLON.VectorMergerBlock",Za);class Ja extends ka{constructor(e){super(e,Pa.Neutral),this.sourceRange=new pe(-1,1),this.targetRange=new pe(0,1),this.registerInput("input",Ia.AutoDetect),this.registerInput("sourceMin",Ia.Float,!0),this.registerInput("sourceMax",Ia.Float,!0),this.registerInput("targetMin",Ia.Float,!0),this.registerInput("targetMax",Ia.Float,!0),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),s=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),n=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),r=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(t,e)+` = ${n} + (${this._inputs[0].associatedVariableName} - ${i}) * (${r} - ${n}) / (${s} - ${i});\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\n`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\n`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=pe.FromArray(e.sourceRange),this.targetRange=pe.FromArray(e.targetRange)}}De([za("From",Da.Vector2)],Ja.prototype,"sourceRange",void 0),De([za("To",Da.Vector2)],Ja.prototype,"targetRange",void 0),ue("BABYLON.RemapBlock",Ja);class el extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push(Ia.Float),this._inputs[1].acceptedConnectionPointTypes.push(Ia.Float)}getClassName(){return"MultiplyBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\n`,this}}var tl;ue("BABYLON.MultiplyBlock",el),function(e){e[e.Material=0]="Material",e[e.PostProcess=1]="PostProcess",e[e.Particle=2]="Particle",e[e.ProceduralTexture=3]="ProceduralTexture"}(tl||(tl={}));class il{constructor(){this.direction1=new me(0,1,0),this.direction2=new me(0,1,0),this.minEmitBox=new me(-.5,-.5,-.5),this.maxEmitBox=new me(.5,.5,.5)}startDirectionFunction(e,t,i,s){const n=ne.RandomRange(this.direction1.x,this.direction2.x),r=ne.RandomRange(this.direction1.y,this.direction2.y),o=ne.RandomRange(this.direction1.z,this.direction2.z);if(s)return t.x=n,t.y=r,void(t.z=o);me.TransformNormalFromFloatsToRef(n,r,o,e,t)}startPositionFunction(e,t,i,s){const n=ne.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),r=ne.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),o=ne.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(s)return t.x=n,t.y=r,void(t.z=o);me.TransformCoordinatesFromFloatsToRef(n,r,o,e,t)}clone(){const e=new il;return it.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){me.FromArrayToRef(e.direction1,0,this.direction1),me.FromArrayToRef(e.direction2,0,this.direction2),me.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),me.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}class sl{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){0!==this._angle?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,s){s?Ee.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),Ee.Vector3[0]).normalize();const n=ne.RandomRange(0,this.directionRandomizer),r=ne.RandomRange(0,this.directionRandomizer),o=ne.RandomRange(0,this.directionRandomizer);t.x=Ee.Vector3[0].x+n,t.y=Ee.Vector3[0].y+r,t.z=Ee.Vector3[0].z+o,t.normalize()}startPositionFunction(e,t,i,s){const n=ne.RandomRange(0,2*Math.PI);let r;this.emitFromSpawnPointOnly?r=1e-4:(r=ne.RandomRange(0,this.heightRange),r=1-r*r);let o=this._radius-ne.RandomRange(0,this._radius*this.radiusRange);o*=r;const a=o*Math.sin(n),l=o*Math.cos(n),h=r*this._height;if(s)return t.x=a,t.y=h,void(t.z=l);me.TransformCoordinatesFromFloatsToRef(a,h,l,e,t)}clone(){const e=new sl(this._radius,this._angle,this.directionRandomizer);return it.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+="\n#define CONEEMITTERSPAWNPOINT"),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=void 0!==e.radiusRange?e.radiusRange:1,this.heightRange=void 0!==e.radiusRange?e.heightRange:1,this.emitFromSpawnPointOnly=void 0!==e.emitFromSpawnPointOnly&&e.emitFromSpawnPointOnly}}class nl{constructor(e=1,t=1,i=1,s=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=s,this._tempVector=me.Zero()}startDirectionFunction(e,t,i,s,n){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),me.TransformNormalToRef(this._tempVector,n,this._tempVector);const r=ne.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let o=Math.atan2(this._tempVector.x,this._tempVector.z);o+=ne.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=r,this._tempVector.x=Math.sin(o),this._tempVector.z=Math.cos(o),this._tempVector.normalize(),s?t.copyFrom(this._tempVector):me.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,s){const n=ne.RandomRange(-this.height/2,this.height/2),r=ne.RandomRange(0,2*Math.PI),o=ne.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),a=Math.sqrt(o)*this.radius,l=a*Math.cos(r),h=a*Math.sin(r);s?t.copyFromFloats(l,n,h):me.TransformCoordinatesFromFloatsToRef(l,n,h,e,t)}clone(){const e=new nl(this.radius,this.directionRandomizer);return it.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class rl extends nl{constructor(e=1,t=1,i=1,s=new me(0,1,0),n=new me(0,1,0)){super(e,t,i),this.direction1=s,this.direction2=n}startDirectionFunction(e,t){const i=ne.RandomRange(this.direction1.x,this.direction2.x),s=ne.RandomRange(this.direction1.y,this.direction2.y),n=ne.RandomRange(this.direction1.z,this.direction2.z);me.TransformNormalFromFloatsToRef(i,s,n,e,t)}clone(){const e=new rl(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return it.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define CYLINDEREMITTER\n#define DIRECTEDCYLINDEREMITTER"}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class ol{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,s){const n=i.position.subtract(e.getTranslation()).normalize(),r=ne.RandomRange(0,this.directionRandomizer),o=ne.RandomRange(0,this.directionRandomizer),a=ne.RandomRange(0,this.directionRandomizer);n.x+=r,n.y+=o,n.z+=a,n.normalize(),s?t.copyFrom(n):me.TransformNormalFromFloatsToRef(n.x,n.y,n.z,e,t)}startPositionFunction(e,t,i,s){const n=this.radius-ne.RandomRange(0,this.radius*this.radiusRange),r=ne.RandomRange(0,1),o=ne.RandomRange(0,2*Math.PI),a=Math.acos(2*r-1),l=n*Math.cos(o)*Math.sin(a),h=n*Math.cos(a),c=n*Math.sin(o)*Math.sin(a);s?t.copyFromFloats(l,Math.abs(h),c):me.TransformCoordinatesFromFloatsToRef(l,Math.abs(h),c,e,t)}clone(){const e=new ol(this.radius,this.directionRandomizer);return it.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class al{constructor(){this.direction1=new me(0,1,0),this.direction2=new me(0,1,0)}startDirectionFunction(e,t,i,s){const n=ne.RandomRange(this.direction1.x,this.direction2.x),r=ne.RandomRange(this.direction1.y,this.direction2.y),o=ne.RandomRange(this.direction1.z,this.direction2.z);s?t.copyFromFloats(n,r,o):me.TransformNormalFromFloatsToRef(n,r,o,e,t)}startPositionFunction(e,t,i,s){s?t.copyFromFloats(0,0,0):me.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new al;return it.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){me.FromArrayToRef(e.direction1,0,this.direction1),me.FromArrayToRef(e.direction2,0,this.direction2)}}class ll{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,s){const n=i.position.subtract(e.getTranslation()).normalize(),r=ne.RandomRange(0,this.directionRandomizer),o=ne.RandomRange(0,this.directionRandomizer),a=ne.RandomRange(0,this.directionRandomizer);n.x+=r,n.y+=o,n.z+=a,n.normalize(),s?t.copyFrom(n):me.TransformNormalFromFloatsToRef(n.x,n.y,n.z,e,t)}startPositionFunction(e,t,i,s){const n=this.radius-ne.RandomRange(0,this.radius*this.radiusRange),r=ne.RandomRange(0,1),o=ne.RandomRange(0,2*Math.PI),a=Math.acos(2*r-1),l=n*Math.cos(o)*Math.sin(a),h=n*Math.cos(a),c=n*Math.sin(o)*Math.sin(a);s?t.copyFromFloats(l,h,c):me.TransformCoordinatesFromFloatsToRef(l,h,c,e,t)}clone(){const e=new ll(this.radius,this.directionRandomizer);return it.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class hl extends ll{constructor(e=1,t=new me(0,1,0),i=new me(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=ne.RandomRange(this.direction1.x,this.direction2.x),s=ne.RandomRange(this.direction1.y,this.direction2.y),n=ne.RandomRange(this.direction1.z,this.direction2.z);me.TransformNormalFromFloatsToRef(i,s,n,e,t)}clone(){const e=new hl(this.radius,this.direction1,this.direction2);return it.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define SPHEREEMITTER\n#define DIRECTEDSPHEREEMITTER"}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class cl{get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:me.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:me.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:me.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:me.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let s=0;for(const i of t){if(i.gradient===e){t.splice(s,1);break}s++}return i&&i.dispose(),this}constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=me.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new me(10,10,10),this.onAnimationEnd=null,this.blendMode=cl.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new pe(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new me(0,0,0),this._useLogarithmicDepth=!1,this.gravity=me.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new Ie(1,1,1,1),this.color2=new Ie(1,1,1,1),this.colorDead=new Ie(0,0,0,1),this.textureMask=new Ie(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new Qt,this.id=e,this.name=e}createPointEmitter(e,t){const i=new al;return i.direction1=e,i.direction2=t,this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=new ol(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=new ll(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new me(0,1,0),i=new me(0,1,0)){const s=new hl(e,t,i);return this.particleEmitterType=s,s}createCylinderEmitter(e=1,t=1,i=1,s=0){const n=new nl(e,t,i,s);return this.particleEmitterType=n,n}createDirectedCylinderEmitter(e=1,t=1,i=1,s=new me(0,1,0),n=new me(0,1,0)){const r=new rl(e,t,i,s,n);return this.particleEmitterType=r,r}createConeEmitter(e=1,t=Math.PI/4){const i=new sl(e,t);return this.particleEmitterType=i,i}createBoxEmitter(e,t,i,s){const n=new il;return this.particleEmitterType=n,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=s,n}}cl.BLENDMODE_ONEONE=0,cl.BLENDMODE_STANDARD=1,cl.BLENDMODE_ADD=2,cl.BLENDMODE_MULTIPLY=3,cl.BLENDMODE_MULTIPLYADD=4;class dl extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("rgba",Ia.Color4,!0),this.registerInput("rgb ",Ia.Color3,!0),this.registerOutput("rgb",Ia.Color3),this.registerOutput("r",Ia.Float),this.registerOutput("g",Ia.Float),this.registerOutput("b",Ia.Float),this.registerOutput("a",Ia.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return"rgb "===e?"rgbIn":e}_outputRename(e){return"rgb"===e?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],s=this._outputs[1],n=this._outputs[2],r=this._outputs[3],o=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.rgb;\n`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.r;\n`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.g;\n`),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${t.associatedVariableName}.b;\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.a;\n`),this}}ue("BABYLON.ColorSplitterBlock",dl);class ul{constructor(e){this.name=li.NAME_PROCEDURALTEXTURE,this.scene=e,this.scene.proceduralTextures=[]}register(){this.scene._beforeClearStage.registerStep(li.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){Ot.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}Ot.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}F.ShadersStore.proceduralVertexShader="attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class _l extends zi{constructor(e,t,i,n,r=null,o=!0,a=!1,l=0){super(null,n,!o),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new s,this.onBeforeGenerationObservable=new s,this.nodeMaterialSource=null,this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null;let h=(n=this.getScene()||u.LastCreatedScene)._getComponent(li.NAME_PROCEDURALTEXTURE);h||(h=new ul(n),n._addComponent(h)),n.proceduralTextures.push(this),this._fullEngine=n.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=o,this._drawWrapper=new Y(this._fullEngine),this.setFragment(i),this._fallbackTexture=r;const c=this._createRtWrapper(a,t,o,l);this._texture=c.texture;const d=[];d.push(1,1),d.push(-1,1),d.push(-1,-1),d.push(1,-1),this._vertexBuffers[Oe.PositionKind]=new Oe(this._fullEngine,d,Oe.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,s){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s}),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s}),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId||(this._contentData?this._contentData.then((e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId})):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId)),this._contentData}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[Oe.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Ji.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Ji.REFRESHRATE_RENDER_ONCE)}reset(){var e;null===(e=this._drawWrapper.effect)||void 0===e||e.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return""}executeWhenReady(e){if(this.isReady())return void e(this);const t=this.getEffect();t&&t.executeWhenCompiled((()=>{e(this)}))}isReady(){const e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;const i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:"string"==typeof this._fragment?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(i,[Oe.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,(()=>{var e;null===(e=this._rtWrapper)||void 0===e||e.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0}))),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return this.isEnabled&&this.isReady()&&this._texture?!this._fallbackTextureUsed&&(-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)):(this._texture&&(this._texture.isReady=!1),!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const s=this._createRtWrapper(i,e,t,this._textureType);this._texture=s.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){-1===this._uniforms.indexOf(e)&&this._uniforms.push(e)}setTexture(e,t){return-1===this._samplers.indexOf(e)&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){var t,i;const s=this.getScene();if(!s)return;const n=this._fullEngine;if(n.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),n.setState(!1),!this.nodeMaterialSource){for(const e in this._textures)this._drawWrapper.effect.setTexture(e,this._textures[e]);for(const e in this._ints)this._drawWrapper.effect.setInt(e,this._ints[e]);for(const e in this._floats)this._drawWrapper.effect.setFloat(e,this._floats[e]);for(const e in this._floatsArrays)this._drawWrapper.effect.setArray(e,this._floatsArrays[e]);for(const e in this._colors3)this._drawWrapper.effect.setColor3(e,this._colors3[e]);for(const e in this._colors4){const t=this._colors4[e];this._drawWrapper.effect.setFloat4(e,t.r,t.g,t.b,t.a)}for(const e in this._vectors2)this._drawWrapper.effect.setVector2(e,this._vectors2[e]);for(const e in this._vectors3)this._drawWrapper.effect.setVector3(e,this._vectors3[e]);for(const e in this._matrices)this._drawWrapper.effect.setMatrix(e,this._matrices[e])}if(!this._texture||!this._rtWrapper)return;null===(t=n._debugPushGroup)||void 0===t||t.call(n,`procedural texture generation for ${this.name}`,1);const r=n.currentViewport;if(this.isCube)for(let e=0;e<6;e++)n.bindFramebuffer(this._rtWrapper,e,void 0,void 0,!0),n.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",e),this.autoClear&&n.clear(s.clearColor,!0,!1,!1),n.drawElementsType(Ps.TriangleFillMode,0,6);else n.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0),n.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&n.clear(s.clearColor,!0,!1,!1),n.drawElementsType(Ps.TriangleFillMode,0,6);n.unBindFramebuffer(this._rtWrapper,this.isCube),r&&n.setViewport(r),this.isCube&&n.generateMipMapsForCubemap(this._texture),null===(i=n._debugPopGroup)||void 0===i||i.call(n,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new _l(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[Oe.PositionKind];i&&(i.dispose(),this._vertexBuffers[Oe.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}var fl;De([Ge()],_l.prototype,"isEnabled",void 0),De([Ge()],_l.prototype,"autoClear",void 0),De([Ge()],_l.prototype,"_generateMipMaps",void 0),De([Ge()],_l.prototype,"_size",void 0),De([Ge()],_l.prototype,"refreshRate",null),ue("BABYLON.ProceduralTexture",_l),function(e){e[e.Cos=0]="Cos",e[e.Sin=1]="Sin",e[e.Abs=2]="Abs",e[e.Exp=3]="Exp",e[e.Exp2=4]="Exp2",e[e.Round=5]="Round",e[e.Floor=6]="Floor",e[e.Ceiling=7]="Ceiling",e[e.Sqrt=8]="Sqrt",e[e.Log=9]="Log",e[e.Tan=10]="Tan",e[e.ArcTan=11]="ArcTan",e[e.ArcCos=12]="ArcCos",e[e.ArcSin=13]="ArcSin",e[e.Fract=14]="Fract",e[e.Sign=15]="Sign",e[e.Radians=16]="Radians",e[e.Degrees=17]="Degrees"}(fl||(fl={}));class pl extends ka{constructor(e){super(e,Pa.Neutral),this.operation=fl.Cos,this.registerInput("input",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case fl.Cos:i="cos";break;case fl.Sin:i="sin";break;case fl.Abs:i="abs";break;case fl.Exp:i="exp";break;case fl.Exp2:i="exp2";break;case fl.Round:i="round";break;case fl.Floor:i="floor";break;case fl.Ceiling:i="ceil";break;case fl.Sqrt:i="sqrt";break;case fl.Log:i="log";break;case fl.Tan:i="tan";break;case fl.ArcTan:i="atan";break;case fl.ArcCos:i="acos";break;case fl.ArcSin:i="asin";break;case fl.Fract:i="fract";break;case fl.Sign:i="sign";break;case fl.Radians:i="radians";break;case fl.Degrees:i="degrees"}return e.compilationString+=this._declareOutput(t,e)+` = ${i}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${fl[this.operation]};\n`}}ue("BABYLON.TrigonometryBlock",pl);const ml={effect:null,subMesh:null};class gl extends Wt{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){void 0===this[e]&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class vl extends Ms{static _BlockIsTextureBlock(e){return"TextureBlock"===e.getClassName()||"ReflectionTextureBaseBlock"===e.getClassName()||"RefractionBlock"===e.getClassName()||"CurrentScreenBlock"===e.getClassName()||"ParticleTextureBlock"===e.getClassName()||"ImageSourceBlock"===e.getClassName()||"TriPlanarBlock"===e.getClassName()||"BiPlanarBlock"===e.getClassName()||"PrePassTextureBlock"===e.getClassName()}_getGlobalNodeMaterialEditor(){return"undefined"!=typeof NODEEDITOR?NODEEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeEditor?BABYLON:void 0}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){super(e,t||u.LastCreatedScene),this._buildId=vl._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new Te,this._cachedWorldViewProjectionMatrix=new Te,this._optimizers=new Array,this._animationFrame=-1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new s,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=tl.Material,this.forceAlphaBlending=!1,this._options=Object.assign({emitComments:!1},i),this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._markAllSubMeshesAsImageProcessingDirty()}))))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e){if(t)return Ot.Warn("More than one block was found with the name `"+e+"`"),t;t=i}return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(-1!==t)return this._optimizers.splice(t,1),this}addOutputNode(e){if(null===e.target)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return 0!=(e.target&Pa.Vertex)&&this._addVertexOutputNode(e),0!=(e.target&Pa.Fragment)&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return null===e.target||(0!=(e.target&Pa.Vertex)&&this._removeVertexOutputNode(e),0!=(e.target&Pa.Fragment)&&this._removeFragmentOutputNode(e)),this}_addVertexOutputNode(e){if(-1===this._vertexOutputNodes.indexOf(e))return e.target=Pa.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(-1!==t)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(-1===this._fragmentOutputNodes.indexOf(e))return e.target=Pa.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(-1!==t)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return!this.ignoreAlpha&&(this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending)}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,s=!0){(e.target===Pa.VertexAndFragment||t.target===Pa.Fragment&&e.target===Pa.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,s)}_initializeBlock(e,t,i,s=!0){if(e.initialize(t),s&&e.autoConfigure(this),e._preparationId=this._buildId,-1===this.attachedBlocks.indexOf(e)){if(e.isUnique){const t=e.getClassName();for(const e of this.attachedBlocks)if(e.getClassName()===t)throw`Cannot have multiple blocks of type ${t} in the same NodeMaterial`}this.attachedBlocks.push(e)}for(const n of e.inputs){n.associatedVariableName="";const r=n.connectedPoint;if(r){const n=r.ownerBlock;n!==e&&this._processInitializeOnLink(n,t,i,s)}}if(e.isTeleportOut){const n=e;n.entryPoint&&this._processInitializeOnLink(n.entryPoint,t,i,s)}for(const t of e.outputs)t.associatedVariableName=""}_resetDualBlocks(e,t){e.target===Pa.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._resetDualBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){this._vertexCompilationState||i||(i=!0),this._buildWasSuccessful=!1;const s=this.getScene().getEngine(),n=this._mode===tl.Particle;if(0===this._vertexOutputNodes.length&&!n)throw"You must define at least one vertexOutputNode";if(0===this._fragmentOutputNodes.length)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new wa,this._vertexCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._vertexCompilationState.target=Pa.Vertex,this._fragmentCompilationState=new wa,this._fragmentCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._fragmentCompilationState.target=Pa.Fragment,this._sharedData=new Ba,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=n;const r=[],o=[];for(const e of this._vertexOutputNodes)r.push(e),this._initializeBlock(e,this._vertexCompilationState,o,i);for(const e of this._fragmentOutputNodes)o.push(e),this._initializeBlock(e,this._fragmentCompilationState,r,i);this.optimize();for(const e of r)e.build(this._vertexCompilationState,r);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const e of o)this._resetDualBlocks(e,this._buildId-1);for(const e of o)e.build(this._fragmentCompilationState,o);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=vl._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(p.Log("Vertex shader:"),p.Log(this._vertexCompilationState.compilationString),p.Log("Fragment shader:"),p.Log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);const a=this.getScene().meshes;for(const e of a)if(e.subMeshes)for(const t of e.subMeshes){if(t.getMaterial()!==this)continue;if(!t.materialDefines)continue;const e=t.materialDefines;e.markAllAsDirty(),e.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();const l=this.getScene().prePassRenderer;l&&l.markAsDirty()}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,s=t.TANGENT,n=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(Oe.NormalKind),t.TANGENT=e.isVerticesDataPresent(Oe.TangentKind);const r=e.useVertexColors&&e.isVerticesDataPresent(Oe.ColorKind);t.VERTEXCOLOR_NME=r;let o=!1;for(let i=1;i<=6;++i){const s=t["UV"+i];t["UV"+i]=e.isVerticesDataPresent(`uv${1===i?"":i}`),o=o||t["UV"+i]!==s}const a=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;wi.PrepareDefinesForPrePass(this.getScene(),t,!a),(i!==t.NORMAL||s!==t.TANGENT||n!==t.VERTEXCOLOR_NME||o)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){const e=this.getBlockByPredicate((e=>"PrePassOutputBlock"===e.getClassName())),t=[4];return e?(this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.viewNormal.isConnected&&t.push(6),e.worldPosition.isConnected&&t.push(1)),t):t}get prePassTextureInputs(){const e=this.getAllTextureBlocks().filter((e=>"PrePassTextureBlock"===e.getClassName())),t=[];for(const i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.normal.isConnected&&!t.includes(6)&&t.push(6);return t}setPrePassRenderer(e){const t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(const e of t)i.texturesRequired.includes(e)||i.texturesRequired.push(e);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,s,n,r=0,o=5){return this.mode!==tl.PostProcess?(p.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,s,n,r,o)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,s=1,n,r,o=0,a=5){let l=this.name+this._buildId;const h=new gl,c=new Gn(l+"PostProcess",this.getScene());let d=this._buildId;return this._processDefines(c,h),L.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l):e=new es(this.name+"PostProcess",l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,s,n,r,h.toString(),o,l,{maxSimultaneousLights:this.maxSimultaneousLights},!1,a),e.nodeMaterialSource=this,e.onApplyObservable.add((t=>{d!==this._buildId&&(delete L.ShadersStore[l+"VertexShader"],delete L.ShadersStore[l+"PixelShader"],l=this.name+this._buildId,h.markAllAsDirty(),d=this._buildId),this._processDefines(c,h)&&(L.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),dt.SetImmediate((()=>e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l)))),this._checkInternals(t)})),e}createProceduralTexture(e,t){if(this.mode!==tl.ProceduralTexture)return p.Log("Incompatible material mode"),null;let i=this.name+this._buildId;const s=new _l(i,e,null,t),n=new Gn(i+"Procedural",this.getScene());n.reservedDataStore={hidden:!0};const r=new gl,o=this._processDefines(n,r);L.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);let a=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[Oe.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,r.toString(),null==o?void 0:o.fallbacks,void 0);s.nodeMaterialSource=this,s._setEffect(a);let l=this._buildId;return s.onBeforeGenerationObservable.add((()=>{l!==this._buildId&&(delete L.ShadersStore[i+"VertexShader"],delete L.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,r.markAllAsDirty(),l=this._buildId);const e=this._processDefines(n,r);e&&(L.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),dt.SetImmediate((()=>{a=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[Oe.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,r.toString(),null==e?void 0:e.fallbacks,void 0),s._setEffect(a)}))),this._checkInternals(a)})),s}_createEffectForParticles(e,t,i,s,n,r,o,a=""){let l=this.name+this._buildId+"_"+t;r||(r=new gl),o||(o=this.getScene().getMeshByName(this.name+"Particle"))||((o=new Gn(this.name+"Particle",this.getScene())).reservedDataStore={hidden:!0});let h=this._buildId;const c=[];let d=a;if(!n){const a=this._processDefines(o,r);L.RegisterShader(l,this._fragmentCompilationState._builtCompilationString),e.fillDefines(c,t),d=c.join("\n"),n=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,r.toString()+"\n"+d,null==a?void 0:a.fallbacks,i,s,e),e.setCustomEffect(n,t)}n.onBindObservable.add((n=>{h!==this._buildId&&(delete L.ShadersStore[l+"PixelShader"],l=this.name+this._buildId+"_"+t,r.markAllAsDirty(),h=this._buildId),c.length=0,e.fillDefines(c,t);const u=c.join("\n");u!==d&&(r.markAllAsDirty(),d=u);const _=this._processDefines(o,r);if(_)return L.RegisterShader(l,this._fragmentCompilationState._builtCompilationString),n=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,r.toString()+"\n"+d,null==_?void 0:_.fallbacks,i,s,e),e.setCustomEffect(n,t),void this._createEffectForParticles(e,t,i,s,n,r,o,a);this._checkInternals(n)}))}_checkInternals(e){if(this._sharedData.animatedInputs){const e=this.getScene(),t=e.getFrameId();if(this._animationFrame!==t){for(const t of this._sharedData.animatedInputs)t.animate(e);this._animationFrame=t}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){this.mode===tl.Particle?(this._createEffectForParticles(e,cl.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,cl.BLENDMODE_MULTIPLY,t,i)):p.Log("Incompatible material mode")}createAsShadowDepthWrapper(e){this.mode===tl.Material?e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene()):p.Log("Incompatible material mode")}_processDefines(e,t,i=!1,s){let n=null;const r=this.getScene();if(wi.PrepareDefinesForCamera(r,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach((s=>{s.initializeDefines(e,this,t,i)})),this._sharedData.blocksWithDefines.forEach((n=>{n.prepareDefines(e,this,t,i,s)})),t.isDirty){const i=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach((i=>{i.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)}));const s=[];this._sharedData.dynamicUniformBlocks.forEach((e=>{e.updateUniformsAndSamples(this._vertexCompilationState,this,t,s)}));const r=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach((e=>{-1===r.indexOf(e)&&r.push(e)}));const o=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach((e=>{-1===o.indexOf(e)&&o.push(e)}));const a=new is;this._sharedData.blocksWithFallbacks.forEach((t=>{t.provideFallbacks(e,a)})),n={lightDisposed:i,uniformBuffers:s,mergedUniforms:r,mergedSamplers:o,fallbacks:a}}return n}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const s=this.getScene();if(this._sharedData.animatedInputs){const e=s.getFrameId();if(this._animationFrame!==e){for(const e of this._sharedData.animatedInputs)e.animate(s);this._animationFrame=e}}if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new gl);const n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const r=s.getEngine();if(this._prepareDefinesForAttributes(e,n),this._sharedData.blockingBlocks.some((t=>!t.isReady(e,this,n,i))))return!1;const o=this._processDefines(e,n,i,t);if(o){const e=t.effect,i=n.toString();let a=r.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:o.mergedUniforms,uniformBuffersNames:o.uniformBuffers,samplers:o.mergedSamplers,defines:i,fallbacks:o.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:n.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS}},r);if(a)if(this._onEffectCreatedObservable&&(ml.effect=a,ml.subMesh=t,this._onEffectCreatedObservable.notifyObservers(ml)),this.allowShaderHotSwapping&&e&&!a.isReady()){if(a=e,n.markAsUnprocessed(),o.lightDisposed)return n._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(a,n,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(n._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),0))}get compiledShaders(){return`// Vertex shader\n${this._vertexCompilationState.compilationString}\n\n// Fragment shader\n${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const t of this._sharedData.inputBlocks)t._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const s=this.getScene(),n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e);const r=this._mustRebind(s,n,t.visibility),o=this._sharedData;if(r){for(const e of o.bindableBlocks)e.bind(n,this,t,i);for(const e of o.forcedBindableBlocks)e.bind(n,this,t,i);for(const e of o.inputBlocks)e._transmit(n,s,this)}else if(!this.isFrozen)for(const e of o.forcedBindableBlocks)e.bind(n,this,t,i);this._afterBind(t,this._activeEffect)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter((e=>e.texture)).map((e=>e.texture))),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){const e=[];for(const t of this.attachedBlocks)vl._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const e of this.getTextureBlocks().filter((e=>e.texture)).map((e=>e.texture)))e.dispose();for(const e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){const t=Object.assign({nodeMaterial:this},e);this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise((t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),void 0===this.BJSNODEMATERIALEDITOR){const i=e&&e.editorURL?e.editorURL:vl.EditorURL;Ot.LoadBabylonScript(i,(()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(null==e?void 0:e.nodeEditorConfig),t()}))}else this._createNodeEditor(null==e?void 0:e.nodeEditorConfig),t()}))}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const e=new Ya("Position");e.setAsAttribute("position");const t=new Ya("World");t.setAsSystemValue(Fa.World);const i=new Va("WorldPos");e.connectTo(i),t.connectTo(i);const s=new Ya("ViewProjection");s.setAsSystemValue(Fa.ViewProjection);const n=new Va("WorldPos * ViewProjectionTransform");i.connectTo(n),s.connectTo(n);const r=new Ga("VertexOutput");n.connectTo(r);const o=new Ya("color");o.value=new Ie(.8,.8,.8,1);const a=new Ha("FragmentOutput");o.connectTo(a),this.addOutputNode(r),this.addOutputNode(a),this._mode=tl.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new Ya("Position");e.setAsAttribute("position2d");const t=new Ya("Constant1");t.isConstant=!0,t.value=1;const i=new Za("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new Ga("VertexOutput");i.connectTo(s);const n=new Ya("Scale");n.visibleInInspector=!0,n.value=new pe(1,1);const r=new Ja("uv0");e.connectTo(r);const o=new el("UV scale");r.connectTo(o),n.connectTo(o);const a=new Ka("CurrentScreen");o.connectTo(a),a.texture=new zi("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const l=new Ha("FragmentOutput");a.connectTo(l,{output:"rgba"}),this.addOutputNode(s),this.addOutputNode(l),this._mode=tl.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new Ya("Position");e.setAsAttribute("position2d");const t=new Ya("Constant1");t.isConstant=!0,t.value=1;const i=new Za("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new Ga("VertexOutput");i.connectTo(s);const n=new Ya("Time");n.value=0,n.min=0,n.max=0,n.isBoolean=!1,n.matrixMode=0,n.animationType=La.Time,n.isConstant=!1;const r=new Ya("Color3");r.value=new Re(1,1,1),r.isConstant=!1;const o=new Ha("FragmentOutput"),a=new Za("VectorMerger");a.visibleInInspector=!1;const l=new pl("Cos");l.operation=fl.Cos,e.connectTo(a),n.output.connectTo(l.input),l.output.connectTo(a.z),a.xyzOut.connectTo(o.rgb),this.addOutputNode(s),this.addOutputNode(o),this._mode=tl.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new Ya("uv");e.setAsAttribute("particle_uv");const t=new ja("ParticleTexture");e.connectTo(t);const i=new Ya("Color");i.setAsAttribute("particle_color");const s=new el("Texture * Color");t.connectTo(s),i.connectTo(s);const n=new $a("ParticleRampGradient");s.connectTo(n);const r=new dl("ColorSplitter");i.connectTo(r);const o=new qa("ParticleBlendMultiply");n.connectTo(o),t.connectTo(o,{output:"a"}),r.connectTo(o,{output:"a"});const a=new Ha("FragmentOutput");o.connectTo(a),this.addOutputNode(a),this._mode=tl.Particle}async loadAsync(e,t=""){return vl.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(-1===t.indexOf(e)){t.push(e);for(const i of e.inputs){const s=i.connectedPoint;if(s){const i=s.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}if(e.isTeleportOut){const i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,t);const s=[];for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,s);let n=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\n`;n+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${tl[this.mode]};\n`;for(const s of t)s.isInput&&-1===e.indexOf(s)&&(n+=s._dumpCode(i,e));for(const t of s)t.isInput&&-1===e.indexOf(t)&&(n+=t._dumpCode(i,e));e=[],n+="\n// Connections\n";for(const t of this._vertexOutputNodes)n+=t._dumpCodeForOutputConnections(e);for(const t of this._fragmentOutputNodes)n+=t._dumpCodeForOutputConnections(e);n+="\n// Output nodes\n";for(const e of this._vertexOutputNodes)n+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;for(const e of this._fragmentOutputNodes)n+=`nodeMaterial.addOutputNode(${e._codeVariableName});\n`;return n+="nodeMaterial.build();\n",n}serialize(e){const t=e?{}:qe.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const e of this._vertexOutputNodes)this._gatherBlocks(e,i),t.outputNodes.push(e.uniqueId);for(const e of this._fragmentOutputNodes)this._gatherBlocks(e,i),-1===t.outputNodes.indexOf(e.uniqueId)&&t.outputNodes.push(e.uniqueId)}t.blocks=[];for(const e of i)t.blocks.push(e.serialize());if(!e)for(const e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t}_restoreConnections(e,t,i){for(const s of e.outputs)for(const n of t.blocks){const r=i[n.id];if(r)for(const o of n.inputs)if(i[o.targetBlockId]!==e||o.targetConnectionName!==s.name);else{const e=r.getInputByName(o.inputName);if(!e||e.isConnected)continue;s.connectTo(e,!0),this._restoreConnections(r,t,i)}}}parseSerializedObject(e,t="",i=!1){var s;i||this.clear();const n={};for(const i of e.blocks){const e=_e(i.customType);if(e){const s=new e;s._deserialize(i,this.getScene(),t),n[i.id]=s,this.attachedBlocks.push(s)}}for(const e of this.attachedBlocks)if(e.isTeleportOut){const t=e,i=t._tempEntryPointUniqueId;i&&n[i].attachToEndpoint(t)}for(let t=0;t<e.blocks.length;t++){const s=n[e.blocks[t].id];s&&(s.inputs.length&&!i||this._restoreConnections(s,e,n))}if(e.outputNodes)for(const t of e.outputNodes)this.addOutputNode(n[t]);if(e.locations||e.editorData&&e.editorData.locations){const t=e.locations||e.editorData.locations;for(const e of t)n[e.blockId]&&(e.blockId=n[e.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&t.concat(this.editorData.locations),e.locations?this.editorData={locations:t}:(this.editorData=e.editorData,this.editorData.locations=t);const s=[];for(const e in n)s[e]=n[e].uniqueId;this.editorData.map=s}this.comment=e.comment,void 0!==e.forceAlphaBlending&&(this.forceAlphaBlending=e.forceAlphaBlending),i||(this._mode=null!==(s=e.mode)&&void 0!==s?s:tl.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),s=qe.Clone((()=>new vl(e,this.getScene(),this.options)),this);return s.id=e,s.name=e,s.parseSerializedObject(i),s._buildId=this._buildId,s.build(!1,!t),s}whenTexturesReadyAsync(){const e=[];return this.getActiveTextures().forEach((t=>{const i=t.getInternalTexture();i&&!i.isReady&&e.push(new Promise(((e,t)=>{i.onLoadedObservable.addOnce((()=>{e()})),i.onErrorObservable.addOnce((e=>{t(e)}))})))})),Promise.all(e)}static Parse(e,t,i=""){const s=qe.Parse((()=>new vl(e.name,t)),e,t,i);return s.parseSerializedObject(e,i),s.build(),s}static async ParseFromFileAsync(e,t,i,s="",n=!1,r){const o=null!=r?r:new vl(e,i),a=await i._loadFileAsync(t),l=JSON.parse(a);return o.parseSerializedObject(l,s),n||o.build(),o}static ParseFromSnippetAsync(e,t=u.LastCreatedScene,i="",s,n=!1,r=!1){return"_BLANK"===e?Promise.resolve(vl.CreateDefault("blank",t)):new Promise(((o,a)=>{const l=new st;l.addEventListener("readystatechange",(()=>{if(4==l.readyState)if(200==l.status){const h=JSON.parse(JSON.parse(l.responseText).jsonPayload),c=JSON.parse(h.nodeMaterial);s||((s=qe.Parse((()=>new vl(e,t)),c,t,i)).uniqueId=t.getUniqueId()),s.parseSerializedObject(c),s.snippetId=e;try{n||s.build()}catch(e){a(e)}r?s.whenTexturesReadyAsync().then((()=>{o(s)})).catch((e=>{a(e)})):o(s)}else a("Unable to load the snippet "+e)})),l.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),l.send()}))}static CreateDefault(e,t){const i=new vl(e,t);return i.setToDefault(),i.build(),i}}var Tl,bl;vl._BuildIdGenerator=0,vl.EditorURL=`${Ot._DefaultCdnUrl}/v${te.Version}/nodeEditor/babylon.nodeEditor.js`,vl.SnippetUrl="https://snippet.babylonjs.com",vl.IgnoreTexturesAtLoadTime=!1,De([Ge()],vl.prototype,"ignoreAlpha",void 0),De([Ge()],vl.prototype,"maxSimultaneousLights",void 0),De([Ge("mode")],vl.prototype,"_mode",void 0),De([Ge("comment")],vl.prototype,"comment",void 0),De([Ge()],vl.prototype,"forceAlphaBlending",void 0),ue("BABYLON.NodeMaterial",vl),ys.prototype._projectOnTrianglesToRef=function(e,t,i,s,n,r){const o=Ee.Vector3[0],a=Ee.Vector3[1];let l=1/0;for(let r=this.indexStart;r<this.indexStart+this.indexCount-(3-s);r+=s){const s=i[r],h=i[r+1],c=i[r+2];if(n&&4294967295===c){r+=2;continue}const d=t[s],u=t[h],_=t[c];if(!d||!u||!_)continue;const f=me.ProjectOnTriangleToRef(e,d,u,_,a);f<l&&(o.copyFrom(a),l=f)}return r.copyFrom(o),l},ys.prototype._projectOnUnIndexedTrianglesToRef=function(e,t,i,s){const n=Ee.Vector3[0],r=Ee.Vector3[1];let o=1/0;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){const s=t[i],a=t[i+1],l=t[i+2],h=me.ProjectOnTriangleToRef(e,s,a,l,r);h<o&&(n.copyFrom(r),o=h)}return s.copyFrom(n),o},ys.prototype.projectToRef=function(e,t,i,s){const n=this.getMaterial();if(!n)return-1;let r=3,o=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:r=1,o=!0}return 4===n.fillMode?-1:!i.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(e,t,i,s):this._projectOnTrianglesToRef(e,t,i,r,o,s)},function(e){e[e.DEHYDRATED=0]="DEHYDRATED",e[e.HOVER=1]="HOVER",e[e.TOUCH=2]="TOUCH"}(Tl||(Tl={})),function(e){e[e.DISABLED=0]="DISABLED",e[e.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",e[e.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"}(bl||(bl={}));class El extends ya{constructor(e,t){super(e),this._options=t,this._tmpRay=new lo(new me,new me),this._attachController=e=>{if(this._controllers[e.uniqueId])return;const{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:s}=this._generateNewTouchPointMesh(),n=this._generateVisualCue();switch(this._controllers[e.uniqueId]={xrController:e,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:s,currentAnimationState:Tl.DEHYDRATED,grabRay:new lo(new me,new me),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,id:El._IdCounter++,pickedPointVisualCue:n},this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(e);case"gaze":case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new Re(.8,.8,.8),this.selectionMeshPickedColor=new Re(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,void 0===this._options.nearInteractionControllerMode&&(this._options.nearInteractionControllerMode=bl.CENTERED_IN_FRONT),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return!!super.attach()&&(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),this._scene.constantlyUpdateMeshUnderPointer=!0,!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){var i;if(e.currentAnimationState!==t&&this._options.nearInteractionControllerMode===bl.CENTERED_IN_FRONT&&!(null===(i=e.xrController)||void 0===i?void 0:i.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case Tl.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===Tl.HOVER)break;case Tl.HOVER:if(e.touchCollisionMeshFunction(!0),t===Tl.TOUCH)break}else switch(e.currentAnimationState){case Tl.TOUCH:if(e.touchCollisionMeshFunction(!1),t===Tl.HOVER)break;case Tl.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===Tl.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){var s;const n=this._controllers[e];n.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(Ee.Vector3[0]),n.grabRay.direction.copyFrom(Ee.Vector3[0]),this._options.nearInteractionControllerMode!==bl.CENTERED_IN_FRONT||(null===(s=n.xrController)||void 0===s?void 0:s.inputSource.hand)||(n.xrController.getWorldPointerRayToRef(this._tmpRay),n.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),n.grabRay.length=this._nearGrabLengthScale*this._hoverRadius,n.touchCollisionMesh.position.copyFrom(n.grabRay.origin)}_onXRFrame(e){Object.keys(this._controllers).forEach((t=>{var i;const s=this._controllers[t],n=null===(i=s.xrController)||void 0===i?void 0:i.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!s.xrController||!n&&(!this._options.nearInteractionControllerMode||!s.xrController.inputSource.gamepad))return void(s.pick=null);if(s.hoverInteraction=!1,s.nearInteraction=!1,!s.xrController)return;if(n){const i=n.get("index-finger-tip");if(i){const s=e.getJointPose(i,this._xrSessionManager.referenceSpace);if(s&&s.transform){const e=this._scene.useRightHandedSystem?1:-1;Ee.Vector3[0].set(s.transform.position.x,s.transform.position.y,s.transform.position.z*e),Ee.Quaternion[0].set(s.transform.orientation.x,s.transform.orientation.y,s.transform.orientation.z*e,s.transform.orientation.w*e),this._processTouchPoint(t,Ee.Vector3[0],Ee.Quaternion[0])}}}else if(s.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==bl.DISABLED){let e=s.xrController.pointer;s.xrController.grip&&this._options.nearInteractionControllerMode===bl.CENTERED_ON_CONTROLLER&&(e=s.xrController.grip),this._processTouchPoint(t,e.position,e.rotationQuaternion)}const r=(e,t)=>{let i=null;return i=t&&t.hit?e&&e.hit?t.distance<e.distance?t:e:t:e,i},o=e=>{let t=new ii,i=!1;const s=e&&e.pickedPoint&&e.hit;return(null==e?void 0:e.pickedPoint)&&(i=0===e.pickedPoint.x&&0===e.pickedPoint.y&&0===e.pickedPoint.z),s&&!i&&(t=e),t};if(!s.grabInteraction){let e=null,t=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(s,this._hoverRadius,this._utilityLayerScene,(e=>this._nearInteractionPredicate(e))));const i=r(this._pickWithSphere(s,this._hoverRadius,this._scene,(e=>this._nearInteractionPredicate(e))),t);if(i&&i.hit&&(e=o(i),e.hit&&(s.hoverInteraction=!0)),s.hoverInteraction){let t=null;const i=n?this._pickRadius:this._controllerPickRadius;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(s,i,this._utilityLayerScene,(e=>this._nearPickPredicate(e))));const a=o(r(this._pickWithSphere(s,i,this._scene,(e=>this._nearPickPredicate(e))),t));a.hit&&(e=a,s.nearInteraction=!0)}s.stalePick=s.pick,s.pick=e,s.pick&&s.pick.pickedPoint&&s.pick.hit?(s.meshUnderPointer=s.pick.pickedMesh,s.pickedPointVisualCue.position.copyFrom(s.pick.pickedPoint),s.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(s.id,!0)):(s.meshUnderPointer=null,s.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(s.id,!1))}let a=Tl.DEHYDRATED;s.grabInteraction||s.nearInteraction?a=Tl.TOUCH:s.hoverInteraction&&(a=Tl.HOVER),this._handleTransitionAnimation(s,a)}))}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Aa.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Aa.DefaultUtilityLayer.utilityLayerScene:this._scene,t=ma("nearInteraction",{diameter:.0105},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=ve.Identity();const i=new zs("targetMat",e);return i.specularColor=Re.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return!this._farInteractionFeature||this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e)}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add((()=>{(this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController)&&t.xrController&&(t.xrController.inputSource.hand||this._options.nearInteractionControllerMode&&t.xrController.inputSource.gamepad)&&(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.nearInteractionTargetMesh=null))}));const s=s=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),s&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i)):!s&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)):!s||this._options.enableNearInteractionOnAllControllers||this._options.disableSwitchOnClick||(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const i=e=>{t.squeezeComponent=e.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;s(t)}})):(t.selectionComponent=e.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add((e=>{if(e.changes.pressed){const t=e.changes.pressed.current;s(t)}})))};e.motionController?i(e.motionController):e.onMotionControllerInitObservable.add(i)}else{const e=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i))},s=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)};t.eventListeners={selectend:s,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",s)}}_detachController(e){const t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach((e=>{const i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)})),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame((()=>{const e={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new ii,e)})),delete this._controllers[e],this._attachedController===e)){const e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}_generateNewTouchPointMesh(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Aa.DefaultUtilityLayer.utilityLayerScene:this._scene,t=ma("PickSphere",{diameter:1},e);t.isVisible=!1,this._options.motionControllerOrbMaterial?t.material=this._options.motionControllerOrbMaterial:vl.ParseFromSnippetAsync("8RUNKL#3",e).then((e=>{t.material=e}));const i=new Jn;i.setEasingMode(qn.EASINGMODE_EASEINOUT);const s=new me(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius),n=this._controllerPickRadius*(4/3),r=new me(n,n,n),o=this._controllerPickRadius*(7/6),a=new me(o,o,o),l=.8*this._controllerPickRadius,h=new me(l,l,l),c=1.5*this._controllerPickRadius,d=[{frame:0,value:s},{frame:10,value:new me(c,c,c)},{frame:18,value:r}],u=[{frame:0,value:r},{frame:10,value:h},{frame:18,value:s}],_=[{frame:0,value:me.ZeroReadOnly},{frame:12,value:a},{frame:15,value:s}],f=[{frame:0,value:s},{frame:10,value:me.ZeroReadOnly},{frame:15,value:me.ZeroReadOnly}],p=new cr("touch","scaling",60,cr.ANIMATIONTYPE_VECTOR3,cr.ANIMATIONLOOPMODE_CONSTANT),m=new cr("release","scaling",60,cr.ANIMATIONTYPE_VECTOR3,cr.ANIMATIONLOOPMODE_CONSTANT),g=new cr("hydrate","scaling",60,cr.ANIMATIONTYPE_VECTOR3,cr.ANIMATIONLOOPMODE_CONSTANT),v=new cr("dehydrate","scaling",60,cr.ANIMATIONTYPE_VECTOR3,cr.ANIMATIONLOOPMODE_CONSTANT);return p.setEasingFunction(i),m.setEasingFunction(i),g.setEasingFunction(i),v.setEasingFunction(i),p.setKeys(d),m.setKeys(u),g.setKeys(_),v.setKeys(f),{touchCollisionMesh:t,touchCollisionMeshFunction:i=>{const s=i?p:m;e.beginDirectAnimation(t,[s],0,18,!1,1)},hydrateCollisionMeshFunction:i=>{const s=i?g:v;i&&(t.isVisible=!0),e.beginDirectAnimation(t,[s],0,15,!1,1,(()=>{i||(t.isVisible=!1)}))}}}_pickWithSphere(e,t,i,s){const n=new ii;if(n.distance=1/0,e.touchCollisionMesh&&e.xrController){const r=e.touchCollisionMesh.position,o=rs.CreateFromCenterAndRadius(r,t);for(let t=0;t<i.meshes.length;t++){const r=i.meshes[t];if(!s(r)||!this._controllerAvailablePredicate(r,e.xrController.uniqueId))continue;const a=El.PickMeshWithSphere(r,o);a&&a.hit&&a.distance<n.distance&&(n.hit=a.hit,n.pickedMesh=r,n.pickedPoint=a.pickedPoint,n.aimTransform=e.xrController.pointer,n.gripTransform=e.xrController.grip||null,n.originMesh=e.touchCollisionMesh,n.distance=a.distance)}}return n}static PickMeshWithSphere(e,t,i=!1){const s=e.subMeshes,n=new ii,r=e.getBoundingInfo();if(!e._generatePointsArray())return n;if(!e.subMeshes||!r)return n;if(!i&&!rs.Intersects(r.boundingSphere,t))return n;const o=Ee.Vector3[0],a=Ee.Vector3[1];let l,h,c,d=1/0;const u=Ee.Vector3[2],_=Ee.Matrix[0];_.copyFrom(e.getWorldMatrix()),_.invert(),me.TransformCoordinatesToRef(t.center,_,u);for(let i=0;i<s.length;i++)s[i].projectToRef(u,e._positions,e.getIndices(),a),me.TransformCoordinatesToRef(a,e.getWorldMatrix(),a),l=me.Distance(a,t.center),c=me.Distance(a,e.getAbsolutePosition()),h=me.Distance(t.center,e.getAbsolutePosition()),-1!==h&&-1!==c&&c>h&&(l=0,a.copyFrom(t.center)),-1!==l&&l<d&&(d=l,o.copyFrom(a));return d<t.radius&&(n.hit=!0,n.distance=d,n.pickedMesh=e,n.pickedPoint=o.clone()),n}}El._IdCounter=200,El.Name=ra.NEAR_INTERACTION,El.Version=1,oa.AddWebXRFeature(El.Name,((e,t)=>()=>new El(e,t)),El.Version,!0);class Sl{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class xl{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new s,this._onSessionGranted=e=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),"undefined"!=typeof window&&window.location&&"http:"===window.location.protocol&&"localhost"!==window.location.hostname)throw Ot.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const e=t.sessionMode||"immersive-vr",i=t.referenceSpaceType||"local-floor";let s=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+("undefined"==typeof SVGSVGElement?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";s+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const n=document.createElement("style");n.appendChild(document.createTextNode(s)),document.getElementsByTagName("head")[0].appendChild(n);const r=document.createElement("button");r.className="babylonVRicon",r.title=`${e} - ${i}`,this._buttons.push(new Sl(r,e,i)),this._buttons[this._buttons.length-1].update=function(e){this.element.style.display=null===e||e===this?"":"none",r.className="babylonVRicon"+(e===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce((()=>{this.dispose()})))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;const i=this._buttons.map((t=>e.sessionManager.isSessionSupportedAsync(t.sessionMode)));e.onStateChangedObservable.add((e=>{e==ro.NOT_IN_XR&&this._updateButtons(null)})),(await Promise.all(i)).forEach(((e,t)=>{e?(this.overlay.appendChild(this._buttons[t].element),this._buttons[t].element.onclick=this._enterXRWithButtonIndex.bind(this,t)):Ot.Warn(`Session mode "${this._buttons[t].sessionMode}" not supported in browser`)}))}static async CreateAsync(e,t,i){const s=new xl(e,i);return await s.setHelperAsync(t,i.renderTarget||void 0),s}async _enterXRWithButtonIndex(e=0){if(this._helper.state==ro.IN_XR)await this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==ro.NOT_IN_XR)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);const i=this._buttons[e].element,s=i.title;i.title="Error entering XR session : "+s,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach((e=>{e.update(this._activeButton)})),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}jn._instancedMeshFactory=(e,t)=>{const i=new Cl(e,t);if(t.instancedBuffers){i.instancedBuffers={};for(const e in t.instancedBuffers)i.instancedBuffers[e]=t.instancedBuffers[e]}return i};class Cl extends Gn{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const e of t.getAnimationRanges())null!=e&&this.createAnimationRange(e.name,e.from,e.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.receiveShadows)!==e&&Ot.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.material)!==e&&Ot.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.visibility)!==e&&Ot.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var t;(null===(t=this._sourceMesh)||void 0===t?void 0:t.skeleton)!==e&&Ot.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){this._sourceMesh&&e!==this._sourceMesh.renderingGroupId&&p.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}setVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,s),this.sourceMesh}updateVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,s),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||p.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==Bn.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new Te);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,Ee.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(Ee.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(t&&0!==t.length){const t=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,t.boundingSphere)}else this._currentLOD=this.sourceMesh;return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,s){const n=(s||this._sourceMesh).createInstance(e);if(it.DeepCopy(this,n,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(n.parent=t),!i)for(let e=0;e<this.getScene().meshes.length;e++){const t=this.getScene().meshes[e];t.parent===this&&t.clone(t.name,n)}return n.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(n),n}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);s&&i&&i(this,s);for(const e of this.getChildTransformNodes(!0))e.instantiateHierarchy(s,t,i);return s}}jn.prototype.registerInstancedBuffer=function(e,t){var i,s;if(null===(s=null===(i=this._userInstancedBuffersStorage)||void 0===i?void 0:i.vertexBuffers[e])||void 0===s||s.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const e of this.instances)e.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[e]=null,this._userInstancedBuffersStorage.strides[e]=t,this._userInstancedBuffersStorage.sizes[e]=32*t,this._userInstancedBuffersStorage.data[e]=new Float32Array(this._userInstancedBuffersStorage.sizes[e]),this._userInstancedBuffersStorage.vertexBuffers[e]=new Oe(this.getEngine(),this._userInstancedBuffersStorage.data[e],e,!0,!1,t,!0);for(const t of this.instances)t.instancedBuffers[e]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()},jn.prototype._processInstancedBuffers=function(e,t){const i=e?e.length:0;for(const s in this.instancedBuffers){let n=this._userInstancedBuffersStorage.sizes[s];const r=this._userInstancedBuffersStorage.strides[s],o=(i+1)*r;for(;n<o;)n*=2;this._userInstancedBuffersStorage.data[s].length!=n&&(this._userInstancedBuffersStorage.data[s]=new Float32Array(n),this._userInstancedBuffersStorage.sizes[s]=n,this._userInstancedBuffersStorage.vertexBuffers[s]&&(this._userInstancedBuffersStorage.vertexBuffers[s].dispose(),this._userInstancedBuffersStorage.vertexBuffers[s]=null));const a=this._userInstancedBuffersStorage.data[s];let l=0;if(t){const e=this.instancedBuffers[s];e.toArray?e.toArray(a,l):e.copyToArray?e.copyToArray(a,l):a[l]=e,l+=r}for(let t=0;t<i;t++){const i=e[t].instancedBuffers[s];i.toArray?i.toArray(a,l):i.copyToArray?i.copyToArray(a,l):a[l]=i,l+=r}this._userInstancedBuffersStorage.vertexBuffers[s]?this._userInstancedBuffersStorage.vertexBuffers[s].updateDirectly(a,0):(this._userInstancedBuffersStorage.vertexBuffers[s]=new Oe(this.getEngine(),this._userInstancedBuffersStorage.data[s],s,!0,!1,r,!0),this._invalidateInstanceVertexArrayObject())}},jn.prototype._invalidateInstanceVertexArrayObject=function(){if(this._userInstancedBuffersStorage&&void 0!==this._userInstancedBuffersStorage.vertexArrayObjects){for(const e in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[e]);this._userInstancedBuffersStorage.vertexArrayObjects={}}},jn.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const e in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[e]&&this._userInstancedBuffersStorage.vertexBuffers[e].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};const yl={effect:null,subMesh:null};class Al extends Ms{constructor(e,t,i,s={},n=!0){super(e,t,n),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new Te,this._cachedWorldViewProjectionMatrix=new Te,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options=Object.assign({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},s)}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)}setTexture(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._textures[e]=t,this}setTextureArray(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return-1===this._options.externalTextures.indexOf(e)&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce(((e,t)=>(t.toArray(e,e.length),e)),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(16*t.length);for(let e=0;e<t.length;e++)t[e].copyToArray(i,16*e);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return-1===this._options.uniformBuffers.indexOf(e)&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return-1===this._options.samplerObjects.indexOf(e)&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return-1===this._options.storageBuffers.indexOf(e)&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){const i=e.trimEnd()+" ",s=this.options.defines.findIndex((t=>t===e||t.startsWith(i)));return s>=0&&this.options.defines.splice(s,1),("boolean"!=typeof t||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){var s,n,r,o;const a=i&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(a){if(i.effect&&i.effect._wasPreviouslyReady)return!0}else{const e=this._drawWrapper.effect;if(e&&e._wasPreviouslyReady&&e._wasPreviouslyUsingInstances===t)return!0}const l=this.getScene(),h=l.getEngine(),c=[],d=[],u=new is;let _=this._shaderPath,f=this._options.uniforms,p=this._options.uniformBuffers,m=this._options.samplers;h.getCaps().multiview&&l.activeCamera&&l.activeCamera.outputRenderTarget&&l.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,c.push("#define MULTIVIEW"),-1!==this._options.uniforms.indexOf("viewProjection")&&-1===this._options.uniforms.indexOf("viewProjectionR")&&this._options.uniforms.push("viewProjectionR"));for(let e=0;e<this._options.defines.length;e++){const t=0===this._options.defines[e].indexOf("#define")?this._options.defines[e]:`#define ${this._options.defines[e]}`;c.push(t)}for(let e=0;e<this._options.attributes.length;e++)d.push(this._options.attributes[e]);if(e&&e.isVerticesDataPresent(Oe.ColorKind)&&(-1===d.indexOf(Oe.ColorKind)&&d.push(Oe.ColorKind),c.push("#define VERTEXCOLOR")),t&&(c.push("#define INSTANCES"),wi.PushAttributesForInstances(d,this._materialHelperNeedsPreviousMatrices),(null==e?void 0:e.hasThinInstances)&&(c.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(Oe.ColorInstanceKind)&&(d.push(Oe.ColorInstanceKind),c.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){d.push(Oe.MatricesIndicesKind),d.push(Oe.MatricesWeightsKind),e.numBoneInfluencers>4&&(d.push(Oe.MatricesIndicesExtraKind),d.push(Oe.MatricesWeightsExtraKind));const t=e.skeleton;c.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),u.addCPUSkinningFallback(0,e),t.isUsingTextureForMatrices?(c.push("#define BONETEXTURE"),-1===this._options.uniforms.indexOf("boneTextureWidth")&&this._options.uniforms.push("boneTextureWidth"),-1===this._options.samplers.indexOf("boneSampler")&&this._options.samplers.push("boneSampler")):(c.push("#define BonesPerMesh "+(t.bones.length+1)),-1===this._options.uniforms.indexOf("mBones")&&this._options.uniforms.push("mBones"))}else c.push("#define NUM_BONE_INFLUENCERS 0");let g=0;const v=e?e.morphTargetManager:null;if(v){const e=v.supportsUVs&&-1!==c.indexOf("#define UV1"),t=v.supportsTangents&&-1!==c.indexOf("#define TANGENT"),i=v.supportsNormals&&-1!==c.indexOf("#define NORMAL");g=v.numInfluencers,e&&c.push("#define MORPHTARGETS_UV"),t&&c.push("#define MORPHTARGETS_TANGENT"),i&&c.push("#define MORPHTARGETS_NORMAL"),g>0&&c.push("#define MORPHTARGETS"),v.isUsingTextureForTargets&&(c.push("#define MORPHTARGETS_TEXTURE"),-1===this._options.uniforms.indexOf("morphTargetTextureIndices")&&this._options.uniforms.push("morphTargetTextureIndices"),-1===this._options.samplers.indexOf("morphTargets")&&this._options.samplers.push("morphTargets")),c.push("#define NUM_MORPH_INFLUENCERS "+g);for(let s=0;s<g;s++)d.push(Oe.PositionKind+s),i&&d.push(Oe.NormalKind+s),t&&d.push(Oe.TangentKind+s),e&&d.push(Oe.UVKind+"_"+s);g>0&&(f=f.slice(),f.push("morphTargetInfluences"),f.push("morphTargetTextureInfo"),f.push("morphTargetTextureIndices"))}else c.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const t=e.bakedVertexAnimationManager;t&&t.isEnabled&&(c.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===this._options.uniforms.indexOf("bakedVertexAnimationSettings")&&this._options.uniforms.push("bakedVertexAnimationSettings"),-1===this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),-1===this._options.uniforms.indexOf("bakedVertexAnimationTime")&&this._options.uniforms.push("bakedVertexAnimationTime"),-1===this._options.samplers.indexOf("bakedVertexAnimationTexture")&&this._options.samplers.push("bakedVertexAnimationTexture")),wi.PrepareAttributesForBakedVertexAnimation(d,e,c)}for(const e in this._textures)if(!this._textures[e].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&c.push("#define ALPHATEST"),!1!==this._options.useClipPlane&&(Di(f),Ni(this,l,c)),this._useLogarithmicDepth&&(c.push("#define LOGARITHMICDEPTH"),-1===this._options.uniforms.indexOf("logarithmicDepthConstant")&&this._options.uniforms.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(f=f.slice(),p=p.slice(),m=m.slice(),_=this.customShaderNameResolve(_,f,p,m,c,d));const T=a?i._getDrawWrapper():this._drawWrapper,b=null!==(s=null==T?void 0:T.effect)&&void 0!==s?s:null,E=null!==(n=null==T?void 0:T.defines)&&void 0!==n?n:null,S=c.join("\n");let x=b;return E!==S&&(x=h.createEffect(_,{attributes:d,uniformsNames:f,uniformBuffersNames:p,samplers:m,defines:S,fallbacks:u,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:g},shaderLanguage:this._options.shaderLanguage},h),a?i.setEffect(x,S,this._materialContext):T&&T.setEffect(x,S),this._onEffectCreatedObservable&&(yl.effect=x,yl.subMesh=null!==(r=null!=i?i:null==e?void 0:e.subMeshes[0])&&void 0!==r?r:null,this._onEffectCreatedObservable.notifyObservers(yl))),x._wasPreviouslyUsingInstances=!!t,null!==(o=!(null==x?void 0:x.isReady()))&&void 0!==o&&!o&&(b!==x&&l.resetCachedMaterial(),x._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,t){const i=this.getScene(),s=null!=t?t:this.getEffect();s&&(-1!==this._options.uniforms.indexOf("world")&&s.setMatrix("world",e),-1!==this._options.uniforms.indexOf("worldView")&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),s.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==this._options.uniforms.indexOf("worldViewProjection")&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),s.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))}bindForSubMesh(e,t,i){var s;this.bind(e,t,null===(s=i._drawWrapperOverride)||void 0===s?void 0:s.effect,i)}bind(e,t,i,s){var n;const r=s&&this._storeEffectOnSubMeshes,o=null!=i?i:r?s.effect:this.getEffect();if(!o)return;const a=this.getScene();this._activeEffect=o,this.bindOnlyWorldMatrix(e,i);const l=this._options.uniformBuffers;let h=!1;if(o&&l&&l.length>0&&a.getEngine().supportsUniformBuffers)for(let i=0;i<l.length;++i)switch(l[i]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e));break;case"Scene":wi.BindSceneUniformBuffer(o,a.getSceneUniformBuffer()),a.finalizeSceneUbo(),h=!0}const c=t&&r?this._mustRebind(a,o,t.visibility):a.getCachedMaterial()!==this;if(o&&c){let e;for(e in h||-1===this._options.uniforms.indexOf("view")||o.setMatrix("view",a.getViewMatrix()),h||-1===this._options.uniforms.indexOf("projection")||o.setMatrix("projection",a.getProjectionMatrix()),h||-1===this._options.uniforms.indexOf("viewProjection")||(o.setMatrix("viewProjection",a.getTransformMatrix()),this._multiview&&o.setMatrix("viewProjectionR",a._transformMatrixR)),a.activeCamera&&-1!==this._options.uniforms.indexOf("cameraPosition")&&o.setVector3("cameraPosition",a.activeCamera.globalPosition),wi.BindBonesParameters(t,o),Fi(o,this,a),this._useLogarithmicDepth&&wi.BindLogDepth(r?s.materialDefines:o.defines,o,a),this._textures)o.setTexture(e,this._textures[e]);for(e in this._textureArrays)o.setTextureArray(e,this._textureArrays[e]);for(e in this._externalTextures)o.setExternalTexture(e,this._externalTextures[e]);for(e in this._ints)o.setInt(e,this._ints[e]);for(e in this._uints)o.setUInt(e,this._uints[e]);for(e in this._floats)o.setFloat(e,this._floats[e]);for(e in this._floatsArrays)o.setArray(e,this._floatsArrays[e]);for(e in this._colors3)o.setColor3(e,this._colors3[e]);for(e in this._colors3Arrays)o.setArray3(e,this._colors3Arrays[e]);for(e in this._colors4){const t=this._colors4[e];o.setFloat4(e,t.r,t.g,t.b,t.a)}for(e in this._colors4Arrays)o.setArray4(e,this._colors4Arrays[e]);for(e in this._vectors2)o.setVector2(e,this._vectors2[e]);for(e in this._vectors3)o.setVector3(e,this._vectors3[e]);for(e in this._vectors4)o.setVector4(e,this._vectors4[e]);for(e in this._quaternions)o.setQuaternion(e,this._quaternions[e]);for(e in this._matrices)o.setMatrix(e,this._matrices[e]);for(e in this._matrixArrays)o.setMatrices(e,this._matrixArrays[e]);for(e in this._matrices3x3)o.setMatrix3x3(e,this._matrices3x3[e]);for(e in this._matrices2x2)o.setMatrix2x2(e,this._matrices2x2[e]);for(e in this._vectors2Arrays)o.setArray2(e,this._vectors2Arrays[e]);for(e in this._vectors3Arrays)o.setArray3(e,this._vectors3Arrays[e]);for(e in this._vectors4Arrays)o.setArray4(e,this._vectors4Arrays[e]);for(e in this._quaternionsArrays)o.setArray4(e,this._quaternionsArrays[e]);for(e in this._uniformBuffers){const t=this._uniformBuffers[e].getBuffer();t&&o.bindUniformBuffer(t,e)}for(e in this._textureSamplers)o.setTextureSampler(e,this._textureSamplers[e]);for(e in this._storageBuffers)o.setStorageBuffer(e,this._storageBuffers[e])}if(o&&t&&(c||!this.isFrozen)){const e=t.morphTargetManager;e&&e.numInfluencers>0&&wi.BindMorphTargetParameters(t,o);const i=t.bakedVertexAnimationManager;i&&i.isEnabled&&(null===(n=t.bakedVertexAnimationManager)||void 0===n||n.bind(o,!!o._wasPreviouslyUsingInstances))}this._afterBind(t,o)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let t=0;t<i.length;t++)e.push(i[t])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let t=0;t<i.length;t++)if(i[t]===e)return!0}return!1}clone(e){const t=qe.Clone((()=>new Al(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes)),this);t.name=e,t.id=e,"object"==typeof t._shaderPath&&(t._shaderPath=Object.assign({},t._shaderPath)),this._options=Object.assign({},this._options),Object.keys(this._options).forEach((e=>{const t=this._options[e];Array.isArray(t)&&(this._options[e]=t.slice(0))})),this.stencil.copyTo(t.stencil);for(const e in this._textures)t.setTexture(e,this._textures[e]);for(const e in this._textureArrays)t.setTextureArray(e,this._textureArrays[e]);for(const e in this._externalTextures)t.setExternalTexture(e,this._externalTextures[e]);for(const e in this._ints)t.setInt(e,this._ints[e]);for(const e in this._uints)t.setUInt(e,this._uints[e]);for(const e in this._floats)t.setFloat(e,this._floats[e]);for(const e in this._floatsArrays)t.setFloats(e,this._floatsArrays[e]);for(const e in this._colors3)t.setColor3(e,this._colors3[e]);for(const e in this._colors3Arrays)t._colors3Arrays[e]=this._colors3Arrays[e];for(const e in this._colors4)t.setColor4(e,this._colors4[e]);for(const e in this._colors4Arrays)t._colors4Arrays[e]=this._colors4Arrays[e];for(const e in this._vectors2)t.setVector2(e,this._vectors2[e]);for(const e in this._vectors3)t.setVector3(e,this._vectors3[e]);for(const e in this._vectors4)t.setVector4(e,this._vectors4[e]);for(const e in this._quaternions)t.setQuaternion(e,this._quaternions[e]);for(const e in this._quaternionsArrays)t._quaternionsArrays[e]=this._quaternionsArrays[e];for(const e in this._matrices)t.setMatrix(e,this._matrices[e]);for(const e in this._matrixArrays)t._matrixArrays[e]=this._matrixArrays[e].slice();for(const e in this._matrices3x3)t.setMatrix3x3(e,this._matrices3x3[e]);for(const e in this._matrices2x2)t.setMatrix2x2(e,this._matrices2x2[e]);for(const e in this._vectors2Arrays)t.setArray2(e,this._vectors2Arrays[e]);for(const e in this._vectors3Arrays)t.setArray3(e,this._vectors3Arrays[e]);for(const e in this._vectors4Arrays)t.setArray4(e,this._vectors4Arrays[e]);for(const e in this._uniformBuffers)t.setUniformBuffer(e,this._uniformBuffers[e]);for(const e in this._textureSamplers)t.setTextureSampler(e,this._textureSamplers[e]);for(const e in this._storageBuffers)t.setStorageBuffer(e,this._storageBuffers[e]);return t}dispose(e,t,i){if(t){let e;for(e in this._textures)this._textures[e].dispose();for(e in this._textureArrays){const t=this._textureArrays[e];for(let e=0;e<t.length;e++)t[e].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=qe.Serialize(this);let t;for(t in e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes,e.stencil=this.stencil.serialize(),e.textures={},this._textures)e.textures[t]=this._textures[t].serialize();for(t in e.textureArrays={},this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let s=0;s<i.length;s++)e.textureArrays[t].push(i[s].serialize())}for(t in e.ints={},this._ints)e.ints[t]=this._ints[t];for(t in e.uints={},this._uints)e.uints[t]=this._uints[t];for(t in e.floats={},this._floats)e.floats[t]=this._floats[t];for(t in e.FloatArrays={},this._floatsArrays)e.FloatArrays[t]=this._floatsArrays[t];for(t in e.colors3={},this._colors3)e.colors3[t]=this._colors3[t].asArray();for(t in e.colors3Arrays={},this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];for(t in e.colors4={},this._colors4)e.colors4[t]=this._colors4[t].asArray();for(t in e.colors4Arrays={},this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];for(t in e.vectors2={},this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();for(t in e.vectors3={},this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();for(t in e.vectors4={},this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();for(t in e.quaternions={},this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();for(t in e.matrices={},this._matrices)e.matrices[t]=this._matrices[t].asArray();for(t in e.matrixArray={},this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];for(t in e.matrices3x3={},this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];for(t in e.matrices2x2={},this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];for(t in e.vectors2Arrays={},this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];for(t in e.vectors3Arrays={},this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];for(t in e.vectors4Arrays={},this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];for(t in e.quaternionsArrays={},this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const s=qe.Parse((()=>new Al(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes)),e,t,i);let n;for(n in e.stencil&&s.stencil.parse(e.stencil,t,i),e.textures)s.setTexture(n,zi.Parse(e.textures[n],t,i));for(n in e.textureArrays){const r=e.textureArrays[n],o=[];for(let e=0;e<r.length;e++)o.push(zi.Parse(r[e],t,i));s.setTextureArray(n,o)}for(n in e.ints)s.setInt(n,e.ints[n]);for(n in e.uints)s.setUInt(n,e.uints[n]);for(n in e.floats)s.setFloat(n,e.floats[n]);for(n in e.floatsArrays)s.setFloats(n,e.floatsArrays[n]);for(n in e.colors3)s.setColor3(n,Re.FromArray(e.colors3[n]));for(n in e.colors3Arrays){const t=e.colors3Arrays[n].reduce(((e,t,i)=>(i%3==0?e.push([t]):e[e.length-1].push(t),e)),[]).map((e=>Re.FromArray(e)));s.setColor3Array(n,t)}for(n in e.colors4)s.setColor4(n,Ie.FromArray(e.colors4[n]));for(n in e.colors4Arrays){const t=e.colors4Arrays[n].reduce(((e,t,i)=>(i%4==0?e.push([t]):e[e.length-1].push(t),e)),[]).map((e=>Ie.FromArray(e)));s.setColor4Array(n,t)}for(n in e.vectors2)s.setVector2(n,pe.FromArray(e.vectors2[n]));for(n in e.vectors3)s.setVector3(n,me.FromArray(e.vectors3[n]));for(n in e.vectors4)s.setVector4(n,ge.FromArray(e.vectors4[n]));for(n in e.quaternions)s.setQuaternion(n,ve.FromArray(e.quaternions[n]));for(n in e.matrices)s.setMatrix(n,Te.FromArray(e.matrices[n]));for(n in e.matrixArray)s._matrixArrays[n]=new Float32Array(e.matrixArray[n]);for(n in e.matrices3x3)s.setMatrix3x3(n,e.matrices3x3[n]);for(n in e.matrices2x2)s.setMatrix2x2(n,e.matrices2x2[n]);for(n in e.vectors2Arrays)s.setArray2(n,e.vectors2Arrays[n]);for(n in e.vectors3Arrays)s.setArray3(n,e.vectors3Arrays[n]);for(n in e.vectors4Arrays)s.setArray4(n,e.vectors4Arrays[n]);for(n in e.quaternionsArrays)s.setArray4(n,e.quaternionsArrays[n]);return s}static ParseFromFileAsync(e,t,i,s=""){return new Promise(((n,r)=>{const o=new st;o.addEventListener("readystatechange",(()=>{if(4==o.readyState)if(200==o.status){const t=JSON.parse(o.responseText),r=this.Parse(t,i||u.LastCreatedScene,s);e&&(r.name=e),n(r)}else r("Unable to load the ShaderMaterial")})),o.open("GET",t),o.send()}))}static ParseFromSnippetAsync(e,t,i=""){return new Promise(((s,n)=>{const r=new st;r.addEventListener("readystatechange",(()=>{if(4==r.readyState)if(200==r.status){const n=JSON.parse(JSON.parse(r.responseText).jsonPayload),o=JSON.parse(n.shaderMaterial),a=this.Parse(o,t||u.LastCreatedScene,i);a.snippetId=e,s(a)}else n("Unable to load the snippet "+e)})),r.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),r.send()}))}}Al.SnippetUrl="https://snippet.babylonjs.com",Al.CreateFromSnippetAsync=Al.ParseFromSnippetAsync,ue("BABYLON.ShaderMaterial",Al);F.ShadersStore.colorPixelShader="#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\n#define VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n#define CUSTOM_FRAGMENT_MAIN_END\n}";F.ShadersStore.colorVertexShader="attribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef MULTIVIEW\nuniform mat4 viewProjectionR;\n#endif\n#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)\nvarying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#include<clipPlaneVertex>\n#include<vertexColorMixing>\n#define CUSTOM_VERTEX_MAIN_END\n}",jn._LinesMeshParser=(e,t)=>Rl.Parse(e,t);class Rl extends jn{_isShaderMaterial(e){return"ShaderMaterial"===e.getClassName()}constructor(e,t=null,i=null,s=null,n,r,o,a){super(e,t,i,s,n),this.useVertexColor=r,this.useVertexAlpha=o,this.color=new Re(1,1,1),this.alpha=1,s&&(this.color=s.color.clone(),this.alpha=s.alpha,this.useVertexColor=s.useVertexColor,this.useVertexAlpha=s.useVertexAlpha),this.intersectionThreshold=.1;const l={attributes:[Oe.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:[],useClipPlane:null};!1===o?l.needAlphaBlending=!1:l.defines.push("#define VERTEXALPHA"),r?(l.defines.push("#define VERTEXCOLOR"),l.attributes.push(Oe.ColorKind)):(l.uniforms.push("color"),this._color4=new Ie),a?this.material=a:(this.material=new Al("colorShader",this.getScene(),"color",l,!1),this.material.doNotSerialize=!0)}isReady(){return!!this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage||this.hasThinInstances)&&super.isReady()}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=Ps.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,i):this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r:e,g:t,b:i}=this.color;this._color4.set(e,t,i,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const s=this.getScene().getEngine();return this._unIndexed?s.drawArraysType(Ps.LineListDrawMode,e.verticesStart,e.verticesCount,i):s.drawElementsType(Ps.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new Rl(e,this.getScene(),t,this,i)}createInstance(e){const t=new Il(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const e in this.instancedBuffers)t.instancedBuffers[e]=this.instancedBuffers[e]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new Rl(e.name,t);return i.color=Re.FromArray(e.color),i.alpha=e.alpha,i}}class Il extends Cl{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function Pl(e){const t=[],i=[],s=e.lines,n=e.colors,r=[];let o=0;for(let e=0;e<s.length;e++){const a=s[e];for(let s=0;s<a.length;s++){const{x:l,y:h,z:c}=a[s];if(i.push(l,h,c),n){const t=n[e],{r:i,g:o,b:a,a:l}=t[s];r.push(i,o,a,l)}s>0&&(t.push(o-1),t.push(o)),o++}}const a=new Nn;return a.indices=t,a.positions=i,n&&(a.colors=r),a}function Ml(e){const t=e.dashSize||3,i=e.gapSize||1,s=e.dashNb||200,n=e.points,r=[],o=[],a=me.Zero();let l=0,h=0,c=0,d=0,u=0,_=0,f=0;for(f=0;f<n.length-1;f++)n[f+1].subtractToRef(n[f],a),l+=a.length();for(c=l/s,d=t*c/(t+i),f=0;f<n.length-1;f++){n[f+1].subtractToRef(n[f],a),h=Math.floor(a.length()/c),a.normalize();for(let e=0;e<h;e++)u=c*e,r.push(n[f].x+u*a.x,n[f].y+u*a.y,n[f].z+u*a.z),r.push(n[f].x+(u+d)*a.x,n[f].y+(u+d)*a.y,n[f].z+(u+d)*a.z),o.push(_,_+1),_+=2}const p=new Nn;return p.positions=r,p.indices=o,p}function Ol(e,t,i=null){const s=t.colors?[t.colors]:null;return function(e,t,i=null){const s=t.instance,n=t.lines,r=t.colors;if(s){const e=s.getVerticesData(Oe.PositionKind);let t,i;r&&(t=s.getVerticesData(Oe.ColorKind));let o=0,a=0;for(let s=0;s<n.length;s++){const l=n[s];for(let n=0;n<l.length;n++)e[o]=l[n].x,e[o+1]=l[n].y,e[o+2]=l[n].z,r&&t&&(i=r[s],t[a]=i[n].r,t[a+1]=i[n].g,t[a+2]=i[n].b,t[a+3]=i[n].a,a+=4),o+=3}return s.updateVerticesData(Oe.PositionKind,e,!1,!1),r&&t&&s.updateVerticesData(Oe.ColorKind,t,!1,!1),s}const o=new Rl(e,i,null,void 0,void 0,!!r,t.useVertexAlpha,t.material);return Pl(t).applyToMesh(o,t.updatable),o}(e,{lines:[t.points],updatable:t.updatable,instance:t.instance,colors:s,useVertexAlpha:t.useVertexAlpha,material:t.material},i)}var Dl,Nl;function Fl(e){var t;let i=0;const s=Date.now();e.observableParameters=null!==(t=e.observableParameters)&&void 0!==t?t:{};const n=e.contextObservable.add((t=>{const r=Date.now();i=r-s;const o={startTime:s,currentTime:r,deltaTime:i,completeRate:i/e.timeout,payload:t};e.onTick&&e.onTick(o),e.breakCondition&&e.breakCondition()&&(e.contextObservable.remove(n),e.onAborted&&e.onAborted(o)),i>=e.timeout&&(e.contextObservable.remove(n),e.onEnded&&e.onEnded(o))}),e.observableParameters.mask,e.observableParameters.insertFirst,e.observableParameters.scope);return n}Nn.CreateLineSystem=Pl,Nn.CreateDashedLines=Ml,jn.CreateLines=(e,t,i=null,s=!1,n=null)=>Ol(e,{points:t,updatable:s,instance:n},i),jn.CreateDashedLines=(e,t,i,s,n,r=null,o,a)=>function(e,t,i=null){const s=t.points,n=t.instance,r=t.gapSize||1,o=t.dashSize||3;if(n){const e=e=>{const t=me.Zero(),i=e.length/6;let r=0,o=0,a=0,l=0,h=0,c=0,d=0,u=0;for(d=0;d<s.length-1;d++)s[d+1].subtractToRef(s[d],t),r+=t.length();a=r/i;const _=n._creationDataStorage.dashSize;for(l=_*a/(_+n._creationDataStorage.gapSize),d=0;d<s.length-1;d++)for(s[d+1].subtractToRef(s[d],t),o=Math.floor(t.length()/a),t.normalize(),u=0;u<o&&c<e.length;)h=a*u,e[c]=s[d].x+h*t.x,e[c+1]=s[d].y+h*t.y,e[c+2]=s[d].z+h*t.z,e[c+3]=s[d].x+(h+l)*t.x,e[c+4]=s[d].y+(h+l)*t.y,e[c+5]=s[d].z+(h+l)*t.z,c+=6,u++;for(;c<e.length;)e[c]=s[d].x,e[c+1]=s[d].y,e[c+2]=s[d].z,c+=3};return(t.dashNb||t.dashSize||t.gapSize||t.useVertexAlpha||t.material)&&p.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),n.updateMeshPositions(e,!1),n}const a=new Rl(e,i,null,void 0,void 0,void 0,t.useVertexAlpha,t.material);return Ml(t).applyToMesh(a,t.updatable),a._creationDataStorage=new Wn,a._creationDataStorage.dashSize=o,a._creationDataStorage.gapSize=r,a}(e,{points:t,dashSize:i,gapSize:s,dashNb:n,updatable:o,instance:a},r),function(e){e[e.INIT=0]="INIT",e[e.STARTED=1]="STARTED",e[e.ENDED=2]="ENDED"}(Dl||(Dl={}));class Ll extends ya{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const t=this._options.teleportationTargetMesh.getChildMeshes(!1,(e=>"rotationCone"===e.name));t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new Ie(1,1,1,1),this._tmpRay=new lo(new me,new me),this._tmpVector=new me,this._tmpQuaternion=new ve,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new s,this.teleportationEnabled=!0,this._rotationEnabled=!0,this._attachController=e=>{if(this._controllers[e.uniqueId]||this._options.forceHandedness&&e.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[e.uniqueId]={xrController:e,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1}};const t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){const i=()=>{if(e.motionController){const i=e.motionController.getComponentOfType(ca.THUMBSTICK_TYPE)||e.motionController.getComponentOfType(ca.TOUCHPAD_TYPE);if(!i||this._options.useMainComponentOnly){const i=e.motionController.getMainComponent();if(!i)return;t.teleportationComponent=i,t.onButtonChangedObserver=i.onButtonStateChangedObservable.add((()=>{this.teleportationEnabled&&i.changes.pressed&&(i.changes.pressed.current?(t.teleportationState.forward=!0,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0,Fl({timeout:this._options.timeToTeleport||3e3,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!i.pressed,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})):(t.teleportationState.forward=!1,this._currentTeleportationControllerId=""))}))}else t.teleportationComponent=i,t.onAxisChangedObserver=i.onAxisValueChangedObservable.add((i=>{if(i.y<=.7&&t.teleportationState.backwards&&(t.teleportationState.backwards=!1),i.y>.7&&!t.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!t.teleportationState.backwards){t.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,ve.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const e=this._xrSessionManager.scene.pickWithRay(this._tmpRay,(e=>-1!==this._floorMeshes.indexOf(e)));e&&e.pickedPoint&&(this._options.xrInput.xrCamera.position.x=e.pickedPoint.x,this._options.xrInput.xrCamera.position.z=e.pickedPoint.z)}if(i.y<-.7&&!this._currentTeleportationControllerId&&!t.teleportationState.rotating&&this.teleportationEnabled&&(t.teleportationState.forward=!0,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),i.x){if(t.teleportationState.forward)this._currentTeleportationControllerId===t.xrController.uniqueId&&(this.rotationEnabled?setTimeout((()=>{t.teleportationState.currentRotation=Math.atan2(i.x,i.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))})):t.teleportationState.currentRotation=0);else if(!t.teleportationState.rotating&&Math.abs(i.x)>.7){t.teleportationState.rotating=!0;const e=this.rotationAngle*(i.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);ve.FromEulerAngles(0,e,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion)}}else t.teleportationState.rotating=!1;0===i.x&&0===i.y&&(t.teleportationState.blocked&&(t.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),t.teleportationState.forward&&this._teleportForward(e.uniqueId))}))}};e.motionController?i():e.onMotionControllerInitObservable.addOnce((()=>{i()}))}else this._xrSessionManager.scene.onPointerObservable.add((i=>{i.type===ci.POINTERDOWN?(t.teleportationState.forward=!0,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0,Fl({timeout:this._options.timeToTeleport||3e3,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})):i.type===ci.POINTERUP&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="")}))},this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new Ie(1,0,0,.75),this._setTargetMeshVisibility(!1)}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return!!super.attach()&&(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,(e=>{this._detachController(e.uniqueId)})),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach((e=>{this._detachController(e)})),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0)}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0)}removeFloorMesh(e){const t=this._floorMeshes.indexOf(e);-1!==t&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const t=this._options.pickBlockerMeshes.indexOf(e);-1!==t&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){const t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(-1===t)for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}return-1!==t&&(this._snapToPositions.splice(t,1),!0)}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;const s=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!s)return;s.rotationQuaternion=s.rotationQuaternion||new ve;const e=this._controllers[this._currentTeleportationControllerId];if(e&&e.teleportationState.forward){ve.RotationYawPitchRollToRef(e.teleportationState.currentRotation+e.teleportationState.baseRotation,0,0,s.rotationQuaternion);let t=!1;if(e.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const s=i.pickWithRay(this._tmpRay,(e=>{if(this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(e))return!0;const t=this._floorMeshes.indexOf(e);return-1!==t&&this._floorMeshes[t].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y}));if(s&&s.pickedMesh&&this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(s.pickedMesh))return e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1),void this._showParabolicPath(s);s&&s.pickedPoint&&(e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(s),this._setTargetMeshVisibility(!0),this._showParabolicPath(s))}if(this.parabolicRayEnabled&&!t){const s=e.xrController.pointer.rotationQuaternion.toEulerAngles().x,n=Math.PI/2-Math.abs(s)+1,r=this.parabolicCheckRadius*n;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(2*r),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(r)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const o=i.pickWithRay(this._tmpRay,(e=>!(!this._options.pickBlockerMeshes||-1===this._options.pickBlockerMeshes.indexOf(e))||-1!==this._floorMeshes.indexOf(e)));if(o&&o.pickedMesh&&this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(o.pickedMesh))return e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1),void this._showParabolicPath(o);o&&o.pickedPoint&&(e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(o),this._setTargetMeshVisibility(!0),this._showParabolicPath(o))}this._setTargetMeshVisibility(t)}else this._setTargetMeshVisibility(!1)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Aa.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=Dr("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const i=512,s=new ho("teleportationPlaneDynamicTexture",i,e,!0);s.hasAlpha=!0;const n=s.getContext(),r=i/2,o=i/2,a=200;n.beginPath(),n.arc(r,o,a,0,2*Math.PI,!1),n.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",n.fill(),n.lineWidth=10,n.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",n.stroke(),n.closePath(),s.update();const l=new zs("teleportationPlaneMaterial",e);l.diffuseTexture=s,t.material=l}const i=Mo("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){const t=new cr("animationInnerCircle","position.y",30,cr.ANIMATIONTYPE_FLOAT,cr.ANIMATIONLOOPMODE_CYCLE),s=[];s.push({frame:0,value:0}),s.push({frame:30,value:.4}),s.push({frame:60,value:0}),t.setKeys(s);const n=new er;n.setEasingMode(qn.EASINGMODE_EASEINOUT),t.setEasingFunction(n),i.animations=[],i.animations.push(t),e.beginAnimation(i,0,60,!0)}const s=Ca("rotationCone",{diameterTop:0,tessellation:4},e);if(s.isPickable=!1,s.scaling.set(.5,.12,.2),s.rotate(nn.X,Math.PI/2),s.position.z=.6,s.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,s.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const t=new zs("torusConsMat",e);t.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,t.disableLighting?t.emissiveColor=new Re(.3,.3,1):t.diffuseColor=new Re(.3,.3,1),t.alpha=.9,i.material=t,s.material=t,this._teleportationRingMaterial=t}void 0!==this._options.renderingGroupId&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._setTargetMeshVisibility(!1)}_detachController(e){const t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,s=Number.MAX_VALUE;if(this._snapToPositions.length){const n=t*t;this._snapToPositions.forEach((t=>{const r=me.DistanceSquared(t,e);r<=n&&r<s&&(s=r,i=t)}))}return i}_setTargetMeshPosition(e){const t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;const i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t){this._options.teleportationTargetMesh&&(this._options.teleportationTargetMesh.isVisible!==e||t)&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach((t=>{t.isVisible=e})),e?this._selectionFeature&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&this._selectionFeature.attach()))}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Aa.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],s=rn.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),n=i.teleportationState.blocked?this._blockedRayColor:void 0,r=new Array(26).fill(n||this._cachedColor4White);this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(s.getPoints(),e):this._quadraticBezierCurve=Ol("teleportation path line",{points:s.getPoints(),instance:this._quadraticBezierCurve,updatable:!0,colors:r},t),this._quadraticBezierCurve.isPickable=!1,void 0!==this._options.renderingGroupId&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const t=this._controllers[e];if(t&&t.teleportationState.forward&&this.teleportationEnabled&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!this.snapPointsOnly||this._snappedToPoint))if(this.skipNextTeleportation)this.skipNextTeleportation=!1;else if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const e=this._options.xrInput.xrCamera.realWorldHeight;this._options.xrInput.xrCamera.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=e,ve.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this._options.xrInput.xrCamera.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}Ll.Name=ra.TELEPORTATION,Ll.Version=1,oa.AddWebXRFeature(Ll.Name,((e,t)=>()=>new Ll(e,t)),Ll.Version,!0);class wl{constructor(){}static CreateAsync(e,t={}){const i=new wl;if(e.onDisposeObservable.addOnce((()=>{i.dispose()})),!t.disableDefaultUI){const s=Object.assign({renderTarget:i.renderTarget},t.uiOptions||{});t.optionalFeatures&&("boolean"==typeof t.optionalFeatures?s.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:s.optionalFeatures=t.optionalFeatures),i.enterExitUI=new xl(e,s)}return ha.CreateAsync(e).then((e=>{if(i.baseExperience=e,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new Sa(e.sessionManager,e.camera,Object.assign({controllerOptions:{renderingGroupId:t.renderingGroupId}},t.inputOptions||{})),!t.disablePointerSelection){const e=Object.assign(Object.assign({},t.pointerSelectionOptions),{xrInput:i.input,renderingGroupId:t.renderingGroupId});i.pointerSelection=i.baseExperience.featuresManager.enableFeature(Ra.Name,t.useStablePlugins?"stable":"latest",e),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(Ll.Name,t.useStablePlugins?"stable":"latest",Object.assign({floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId},t.teleportationOptions)),i.teleportation.setSelectionFeature(i.pointerSelection))}return t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(El.Name,t.useStablePlugins?"stable":"latest",Object.assign({xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0},t.nearInteractionOptions))),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),t.disableDefaultUI?void 0:i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)})).then((()=>i)).catch((e=>(p.Error("Error initializing XR"),p.Error(e),i)))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}Oi.prototype.createDefaultLight=function(e=!1){if(e&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();0===this.lights.length&&new In("default light",me.Up(),this)},Oi.prototype.createDefaultCamera=function(e=!1,t=!1,i=!1){if(t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const t=this.getWorldExtends((e=>e.isVisible&&e.isEnabled())),s=t.max.subtract(t.min),n=t.min.add(s.scale(.5));let r,o=1.5*s.length();if(isFinite(o)||(o=1,n.copyFromFloats(0,0,0)),e){const e=new Er("default camera",-Math.PI/2,Math.PI/2,o,n,this);e.lowerRadiusLimit=.01*o,e.wheelPrecision=100/o,r=e}else{const e=new Hr("default camera",new me(n.x,n.y,-o),this);e.setTarget(n),r=e}r.minZ=.01*o,r.maxZ=1e3*o,r.speed=.2*o,this.activeCamera=r,i&&r.attachControl()}},Oi.prototype.createDefaultCameraOrLight=function(e=!1,t=!1,i=!1){this.createDefaultLight(t),this.createDefaultCamera(e,t,i)},Oi.prototype.createDefaultSkybox=function(e,t=!1,i=1e3,s=0,n=!0){if(!e)return p.Warn("Can not create default skybox without environment texture."),null;n&&e&&(this.environmentTexture=e);const r=Fr("hdrSkyBox",{size:i},this);if(t){const t=new Rn("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=zi.SKYBOX_MODE),t.microSurface=1-s,t.disableLighting=!0,t.twoSidedLighting=!0,r.material=t}else{const t=new zs("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=zi.SKYBOX_MODE),t.disableLighting=!0,r.material=t}return r.isPickable=!1,r.infiniteDistance=!0,r.ignoreCameraMaxZ=!0,r},Oi.prototype.createDefaultEnvironment=function(e){return Lr?new Lr(e,this):null},Oi.prototype.createDefaultVRExperience=function(e={}){return new No(this,e)},Oi.prototype.createDefaultXRExperienceAsync=function(e={}){return wl.CreateAsync(this,e).then((e=>e))},ue("BABYLON.BonesBlock",class extends ka{constructor(e){super(e,Pa.Vertex),this.registerInput("matricesIndices",Ia.Vector4),this.registerInput("matricesWeights",Ia.Vector4),this.registerInput("matricesIndicesExtra",Ia.Vector4,!0),this.registerInput("matricesWeightsExtra",Ia.Vector4,!0),this.registerInput("world",Ia.Matrix),this.registerOutput("output",Ia.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e,t=(()=>!0)){if(!this.matricesIndices.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesIndices"===e.name&&t(e)));i||(i=new Ya("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"matricesWeights"===e.name&&t(e)));i||(i=new Ya("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.World&&t(e)));i||(i=new Ya("world"),i.setAsSystemValue(Fa.World)),i.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){wi.BindBonesParameters(i,e)}prepareDefines(e,t,i){i._areAttributesDirty&&wi.PrepareDefinesForBones(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const s=this._outputs[0],n=this.world;return e.compilationString+="#if NUM_BONE_INFLUENCERS>0\n",e.compilationString+=this._declareOutput(s,e)+` = ${n.associatedVariableName} * ${i};\n`,e.compilationString+="#else\n",e.compilationString+=this._declareOutput(s,e)+` = ${n.associatedVariableName};\n`,e.compilationString+="#endif\n",this}}),ue("BABYLON.InstancesBlock",class extends ka{constructor(e){super(e,Pa.Vertex),this.registerInput("world0",Ia.Vector4),this.registerInput("world1",Ia.Vector4),this.registerInput("world2",Ia.Vector4),this.registerInput("world3",Ia.Vector4),this.registerInput("world",Ia.Matrix,!0),this.registerOutput("output",Ia.Matrix),this.registerOutput("instanceID",Ia.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e,t=(()=>!0)){if(!this.world0.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world0"===e.name&&t(e)));i||(i=new Ya("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world1"===e.name&&t(e)));i||(i=new Ya("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world2"===e.name&&t(e)));i||(i=new Ya("world2"),i.setAsAttribute("world2")),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world3"===e.name&&t(e)));i||(i=new Ya("world3"),i.setAsAttribute("world3")),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"world"===e.name&&t(e)));i||(i=new Ya("world"),i.setAsSystemValue(Fa.World)),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,s=!1,n){let r=!1;i.INSTANCES!==s&&(i.setValue("INSTANCES",s),r=!0),n&&i.THIN_INSTANCES!==!!(null==n?void 0:n.getRenderingMesh().hasThinInstances)&&(i.setValue("THIN_INSTANCES",!!(null==n?void 0:n.getRenderingMesh().hasThinInstances)),r=!0),r&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],s=this._outputs[1],n=this.world0,r=this.world1,o=this.world2,a=this.world3;return e.compilationString+="#ifdef INSTANCES\n",e.compilationString+=this._declareOutput(i,e)+` = mat4(${n.associatedVariableName}, ${r.associatedVariableName}, ${o.associatedVariableName}, ${a.associatedVariableName});\n`,e.compilationString+="#ifdef THIN_INSTANCES\n",e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};\n`,e.compilationString+="#endif\n",t._caps.canUseGLInstanceID?e.compilationString+=this._declareOutput(s,e)+" = float(gl_InstanceID);\n":e.compilationString+=this._declareOutput(s,e)+" = 0.0;\n",e.compilationString+="#else\n",e.compilationString+=this._declareOutput(i,e)+` = ${this.world.associatedVariableName};\n`,e.compilationString+=this._declareOutput(s,e)+" = 0.0;\n",e.compilationString+="#endif\n",this}});class Bl extends ka{constructor(e){super(e,Pa.Vertex),this.registerInput("position",Ia.Vector3),this.registerInput("normal",Ia.Vector3),this.registerInput("tangent",Ia.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(Ia.Color4|Ia.Vector4|Ia.Vector3),this.registerInput("uv",Ia.Vector2),this.registerOutput("positionOutput",Ia.Vector3),this.registerOutput("normalOutput",Ia.Vector3),this.registerOutput("tangentOutput",Ia.Vector4),this.registerOutput("uvOutput",Ia.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences")}autoConfigure(e,t=(()=>!0)){if(!this.position.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"position"===e.name&&t(e)));i||(i=new Ya("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"normal"===e.name&&t(e)));i||(i=new Ya("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"tangent"===e.name&&t(e)));i||(i=new Ya("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new Ya("uv"),i.setAsAttribute("uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){const t=e.morphTargetManager;(null==t?void 0:t.isUsingTextureForTargets)&&t.numInfluencers!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}i._areAttributesDirty&&wi.PrepareDefinesForMorphTargets(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(wi.BindMorphTargetParameters(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,s){const n=this.position,r=this.normal,o=this.tangent,a=this.uv,l=this.positionOutput,h=this.normalOutput,c=this.tangentOutput,d=this.uvOutput,u=e,_=s.NUM_MORPH_INFLUENCERS,f=i.morphTargetManager,p=f&&f.supportsNormals&&s.NORMAL,m=f&&f.supportsTangents&&s.TANGENT,g=f&&f.supportsUVs&&s.UV1;let v="";(null==f?void 0:f.isUsingTextureForTargets)&&_>0&&(v+="float vertexID;\n");for(let e=0;e<_;e++)v+="#ifdef MORPHTARGETS\n",(null==f?void 0:f.isUsingTextureForTargets)?(v+="vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\n",v+=`${l.associatedVariableName} += (readVector3FromRawSampler(${e}, vertexID) - ${n.associatedVariableName}) * morphTargetInfluences[${e}];\n`,v+="vertexID += 1.0;\n"):v+=`${l.associatedVariableName} += (position${e} - ${n.associatedVariableName}) * morphTargetInfluences[${e}];\n`,p&&(v+="#ifdef MORPHTARGETS_NORMAL\n",(null==f?void 0:f.isUsingTextureForTargets)?(v+=`${h.associatedVariableName} += (readVector3FromRawSampler(${e}, vertexID) - ${r.associatedVariableName}) * morphTargetInfluences[${e}];\n`,v+="vertexID += 1.0;\n"):v+=`${h.associatedVariableName} += (normal${e} - ${r.associatedVariableName}) * morphTargetInfluences[${e}];\n`,v+="#endif\n"),g&&(v+="#ifdef MORPHTARGETS_UV\n",(null==f?void 0:f.isUsingTextureForTargets)?(v+=`${d.associatedVariableName} += (readVector3FromRawSampler(${e}, vertexID).xy - ${a.associatedVariableName}) * morphTargetInfluences[${e}];\n`,v+="vertexID += 1.0;\n"):v+=`${d.associatedVariableName}.xy += (uv_${e} - ${a.associatedVariableName}.xy) * morphTargetInfluences[${e}];\n`,v+="#endif\n"),m&&(v+="#ifdef MORPHTARGETS_TANGENT\n",(null==f?void 0:f.isUsingTextureForTargets)?v+=`${c.associatedVariableName}.xyz += (readVector3FromRawSampler(${e}, vertexID) - ${o.associatedVariableName}.xyz) * morphTargetInfluences[${e}];\n`:v+=`${c.associatedVariableName}.xyz += (tangent${e} - ${o.associatedVariableName}.xyz) * morphTargetInfluences[${e}];\n`,o.type===Ia.Vector4?v+=`${c.associatedVariableName}.w = ${o.associatedVariableName}.w;\n`:v+=`${c.associatedVariableName}.w = 1.;\n`,v+="#endif\n"),v+="#endif\n";if(u.compilationString=u.compilationString.replace(this._repeatableContentAnchor,v),_>0)for(let e=0;e<_;e++)u.attributes.push(Oe.PositionKind+e),p&&u.attributes.push(Oe.NormalKind+e),m&&u.attributes.push(Oe.TangentKind+e),g&&u.attributes.push(Oe.UVKind+"_"+e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,s=this.tangent,n=this.uv,r=this.positionOutput,o=this.normalOutput,a=this.tangentOutput,l=this.uvOutput,h=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",h),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",h,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${this._declareOutput(r,e)} = ${t.associatedVariableName};\n`,e.compilationString+="#ifdef NORMAL\n",e.compilationString+=`${this._declareOutput(o,e)} = ${i.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${this._declareOutput(o,e)} = vec3(0., 0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef TANGENT\n",e.compilationString+=`${this._declareOutput(a,e)} = ${s.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${this._declareOutput(a,e)} = vec4(0., 0., 0., 0.);\n`,e.compilationString+="#endif\n",e.compilationString+="#ifdef UV1\n",e.compilationString+=`${this._declareOutput(l,e)} = ${n.associatedVariableName};\n`,e.compilationString+="#else\n",e.compilationString+=`${this._declareOutput(l,e)} = vec2(0., 0.);\n`,e.compilationString+="#endif\n",this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}ue("BABYLON.MorphTargetsBlock",Bl);class Ul extends Lt{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=Te.Identity(),this._projectionMatrix=Te.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return!(!this.parent||!this.parent.getWorldMatrix||(this.transformedPosition||(this.transformedPosition=me.Zero()),me.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=me.Zero()),me.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),0))}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=me.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=me.Cross(this.direction,nn.Y),t=me.Cross(e,this.direction);return me.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=me.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=Te.Identity()),Te.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),this.parent&&this.parent.getWorldMatrix||(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){const t=Ee.Vector3[0];let i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),me.NormalizeToRef(this.getShadowDirection(e),t),1===Math.abs(me.Dot(t,me.Up()))&&(t.z=1e-13);const s=Ee.Vector3[1];return i.addToRef(t,s),Te.LookAtLHToRef(i,s,me.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,null!=e?e:this._viewMatrix,null!=t?t:[]),this._projectionMatrix}}De([Qe()],Ul.prototype,"position",null),De([Qe()],Ul.prototype,"direction",null),De([Ge()],Ul.prototype,"shadowMinZ",null),De([Ge()],Ul.prototype,"shadowMaxZ",null),et.AddNodeConstructor("Light_Type_0",((e,t)=>()=>new kl(e,me.Zero(),t)));class kl extends Ul{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return Lt.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new me(1,0,0);case 1:return new me(-1,0,0);case 2:return new me(0,-1,0);case 3:return new me(0,1,0);case 4:return new me(0,0,1);case 5:return new me(0,0,-1)}return me.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;const n=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,r=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;Te.PerspectiveFovLHToRef(this.shadowAngle,1,o?r:n,o?n:r,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}De([Ge()],kl.prototype,"shadowAngle",null),ue("BABYLON.LightInformationBlock",class extends ka{constructor(e){super(e,Pa.Vertex),this.registerInput("worldPosition",Ia.Vector4,!1,Pa.Vertex),this.registerOutput("direction",Ia.Vector3),this.registerOutput("color",Ia.Color3),this.registerOutput("intensity",Ia.Float),this.registerOutput("shadowBias",Ia.Float),this.registerOutput("shadowNormalBias",Ia.Float),this.registerOutput("shadowDepthScale",Ia.Float),this.registerOutput("shadowDepthRange",Ia.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let s=this.light;const n=t.getScene();if(!s&&n.lights.length&&(s=this.light=n.lights[0],this._forcePrepareDefines=!0),!s||!s.isEnabled)return e.setFloat3(this._lightDataUniformName,0,0,0),void e.setFloat4(this._lightColorUniformName,0,0,0,0);s.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,s.diffuse,s.intensity);const r=s.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(r?e.setFloat3(this._lightShadowUniformName,r.bias,r.normalBias,r.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(r&&n.activeCamera){const t=s;e.setFloat2(this._lightShadowExtraUniformName,t.getDepthMinZ(n.activeCamera),t.getDepthMinZ(n.activeCamera)+t.getDepthMaxZ(n.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const s=this.light;i.setValue(this._lightTypeDefineName,!!(s&&s instanceof kl),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,s=this.intensity,n=this.shadowBias,r=this.shadowNormalBias,o=this.shadowDepthScale,a=this.shadowDepthRange;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+=`#ifdef ${this._lightTypeDefineName}\n`,e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${this._lightDataUniformName});\n`,e.compilationString+="#else\n",e.compilationString+=this._declareOutput(t,e)+` = ${this._lightDataUniformName};\n`,e.compilationString+="#endif\n",e.compilationString+=this._declareOutput(i,e)+` = ${this._lightColorUniformName}.rgb;\n`,e.compilationString+=this._declareOutput(s,e)+` = ${this._lightColorUniformName}.a;\n`,(n.hasEndpoints||r.hasEndpoints||o.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,"vec3"),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${this._lightShadowUniformName}.x;\n`),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${this._lightShadowUniformName}.y;\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${this._lightShadowUniformName}.z;\n`)),a.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,"vec2"),e.compilationString+=this._declareOutput(a,e)+` = ${this._lightShadowUniformName};\n`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}});class Vl extends ka{constructor(e){super(e,Pa.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",Ia.AutoDetect),this.registerOutput("output",Ia.Color4),this.registerOutput("rgb",Ia.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Color4|Ia.Vector3|Ia.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity")}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){var t;super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const i=this.color,s=this._outputs[0],n=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",n),e._emitFunctionFromInclude("imageProcessingDeclaration",n),e._emitFunctionFromInclude("imageProcessingFunctions",n),(null===(t=i.connectedPoint)||void 0===t?void 0:t.isConnected)&&(i.connectedPoint.type===Ia.Color4||i.connectedPoint.type===Ia.Vector4?e.compilationString+=`${this._declareOutput(s,e)} = ${i.associatedVariableName};\n`:e.compilationString+=`${this._declareOutput(s,e)} = vec4(${i.associatedVariableName}, 1.0);\n`,e.compilationString+="#ifdef IMAGEPROCESSINGPOSTPROCESS\n",this.convertInputToLinearSpace&&(e.compilationString+=`${s.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\n`),e.compilationString+="#else\n",e.compilationString+="#ifdef IMAGEPROCESSING\n",this.convertInputToLinearSpace&&(e.compilationString+=`${s.associatedVariableName}.rgb = toLinearSpace(${i.associatedVariableName}.rgb);\n`),e.compilationString+=`${s.associatedVariableName} = applyImageProcessing(${s.associatedVariableName});\n`,e.compilationString+="#endif\n",e.compilationString+="#endif\n",this.rgb.hasEndpoints&&(e.compilationString+=this._declareOutput(this.rgb,e)+` = ${this.output.associatedVariableName}.xyz;\n`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\n`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.convertInputToLinearSpace=null===(s=e.convertInputToLinearSpace)||void 0===s||s}}De([za("Convert input to linear space",Da.Boolean,"ADVANCED")],Vl.prototype,"convertInputToLinearSpace",void 0),ue("BABYLON.ImageProcessingBlock",Vl);class Gl extends Ua{constructor(e,t,i,s,n){super(e,t,i),this._blockType=s,this._blockName=n,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof Gl&&e._blockName===this._blockName?Ma.Compatible:Ma.TypeIncompatible}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class zl extends ka{constructor(e){super(e,Pa.Fragment,!0),this.registerInput("normal",Ia.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(Ia.Color4|Ia.Vector4|Ia.Vector3),this.registerInput("tangent",Ia.Vector4,!1),this.registerInput("world",Ia.Matrix,!1),this.registerOutput("TBN",Ia.Object,Pa.Fragment,new Gl("TBN",this,Oa.Output,zl,"TBNBlock")),this.registerOutput("row0",Ia.Vector3,Pa.Fragment),this.registerOutput("row1",Ia.Vector3,Pa.Fragment),this.registerOutput("row2",Ia.Vector3,Pa.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return Pa.Fragment}set target(e){}autoConfigure(e,t=(()=>!0)){if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.isSystemValue&&e.systemValue===Fa.World&&t(e)));i||(i=new Ya("world"),i.setAsSystemValue(Fa.World)),i.output.connectTo(this.world)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"normal"===e.name&&t(e)));i||(i=new Ya("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"tangent"===e.name&&e.type===Ia.Vector4&&t(e)));i||(i=new Ya("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}}prepareDefines(e,t,i){var s,n,r,o;const a=this.normal,l=this.tangent;let h=a.isConnected;(null===(s=a.connectInputBlock)||void 0===s?void 0:s.isAttribute)&&!e.isVerticesDataPresent(null===(n=a.connectInputBlock)||void 0===n?void 0:n.name)&&(h=!1);let c=l.isConnected;(null===(r=l.connectInputBlock)||void 0===r?void 0:r.isAttribute)&&!e.isVerticesDataPresent(null===(o=l.connectInputBlock)||void 0===o?void 0:o.name)&&(c=!1);const d=h&&c;i.setValue("TBNBLOCK",d,!0)}_buildBlock(e){super._buildBlock(e);const t=this.normal,i=this.tangent,s=this.world,n=this.TBN,r=this.row0,o=this.row1,a=this.row2;return e.target===Pa.Fragment&&(e.compilationString+=`\n                // ${this.name}\n                vec3 tbnNormal = normalize(${t.associatedVariableName}).xyz;\n                vec3 tbnTangent = normalize(${i.associatedVariableName}.xyz);\n                vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;\n                mat3 ${n.associatedVariableName} = mat3(${s.associatedVariableName}) * mat3(tbnTangent, tbnBitangent, tbnNormal);\n            `,r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = vec3(${n.associatedVariableName}[0][0], ${n.associatedVariableName}[0][1], ${n.associatedVariableName}[0][2]);\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec3(${n.associatedVariableName}[1[0], ${n.associatedVariableName}[1][1], ${n.associatedVariableName}[1][2]);\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec3(${n.associatedVariableName}[2][0], ${n.associatedVariableName}[2][1], ${n.associatedVariableName}[2][2]);\n`),e.sharedData.blocksWithDefines.push(this)),this}}ue("BABYLON.TBNBlock",zl);class Hl extends ka{constructor(e){super(e,Pa.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",Ia.Vector4,!1),this.registerInput("worldNormal",Ia.Vector4,!1),this.registerInput("worldTangent",Ia.Vector4,!0),this.registerInput("uv",Ia.Vector2,!1),this.registerInput("normalMapColor",Ia.Color3,!1),this.registerInput("strength",Ia.Float,!1),this.registerInput("viewDirection",Ia.Vector3,!0),this.registerInput("parallaxScale",Ia.Float,!0),this.registerInput("parallaxHeight",Ia.Float,!0),this.registerInput("TBN",Ia.Object,!0,Pa.VertexAndFragment,new Gl("TBN",this,Oa.Input,zl,"TBNBlock")),this.registerInput("world",Ia.Matrix,!0),this.registerOutput("output",Ia.Vector4),this.registerOutput("uvOffset",Ia.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}prepareDefines(e,t,i){const s=this.normalMapColor.connectedPoint._ownerBlock.samplerName,n=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&s||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",n,!0),i.setValue("PARALLAX_RHS",t.getScene().useRightHandedSystem,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e,t=(()=>!0)){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"uv"===e.name&&t(e)));i||(i=new Ya("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){const e=new Ya("strength");e.value=1,e.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,s=this.worldPosition,n=this.worldNormal,r=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2"),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float"),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,"mat4");let o=null;this.normalMapColor.connectedPoint&&(o=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const a=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&o||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),l=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",h=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${e._emitFloat(this.strength.connectInputBlock.value)}`:`\n#if !defined(NORMALXYSCALE)\n1.0/\n#endif\n${this.strength.associatedVariableName}`;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const c={search:/defined\(TANGENT\)/g,replace:r.isConnected?"defined(TANGENT)":"defined(IGNORE)"},d=this.TBN;d.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${d.associatedVariableName};\n            #endif\n            `:r.isConnected&&(e.compilationString+=`vec3 tbnNormal = normalize(${n.associatedVariableName}.xyz);\n`,e.compilationString+=`vec3 tbnTangent = normalize(${r.associatedVariableName}.xyz);\n`,e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,e.compilationString+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\n"),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:[c,{search:/varying mat3 vTBN;/g,replace:""},{search:/uniform mat4 normalMatrix;/g,replace:""}]}),e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:"#define inline\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)"},{search:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture2D\(bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const u=a&&o?`texture2D(${o}, ${i.associatedVariableName} + uvOffset).xyz`:this.normalMapColor.associatedVariableName;return e.compilationString+=this._declareOutput(this.output,e)+" = vec4(0.);\n",e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:[{search:/texture2D\(bumpSampler,vBumpUV\)/g,replace:`${u}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`mat4 normalMatrix = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:/perturbNormal\(TBN,texture2D\(bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:`perturbNormal(TBN, ${u}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${a&&this.useParallaxOcclusion?o:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${a?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vBumpInfos.y/g,replace:h},{search:/vBumpInfos.z/g,replace:l},{search:/vBumpUV/g,replace:i.associatedVariableName},{search:/vPositionW/g,replace:s.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:n.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:a?this.viewDirection.associatedVariableName:"vec3(0.)"},c]}),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};\n`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};\n`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\n`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};\n`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}De([za("Invert X axis",Da.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Hl.prototype,"invertX",void 0),De([za("Invert Y axis",Da.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Hl.prototype,"invertY",void 0),De([za("Use parallax occlusion",Da.Boolean)],Hl.prototype,"useParallaxOcclusion",void 0),De([za("Object Space Mode",Da.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Hl.prototype,"useObjectSpaceNormalMap",void 0),ue("BABYLON.PerturbNormalBlock",Hl),ue("BABYLON.DiscardBlock",class extends ka{constructor(e){super(e,Pa.Fragment,!0),this.registerInput("value",Ia.Float,!0),this.registerInput("cutoff",Ia.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,this.cutoff.isConnected&&this.value.isConnected)return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) discard;\n`,this}}),ue("BABYLON.FrontFacingBlock",class extends ka{constructor(e){super(e,Pa.Fragment),this.registerOutput("output",Ia.Float,Pa.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===Pa.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+" = gl_FrontFacing ? 1.0 : 0.0;\n",this}}),ue("BABYLON.DerivativeBlock",class extends ka{constructor(e){super(e,Pa.Fragment),this.registerInput("input",Ia.AutoDetect,!1),this.registerOutput("dx",Ia.BasedOnInput),this.registerOutput("dy",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),t.hasEndpoints&&(e.compilationString+=this._declareOutput(t,e)+` = dFdx(${this.input.associatedVariableName});\n`),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = dFdy(${this.input.associatedVariableName});\n`),this}}),ue("BABYLON.FragCoordBlock",class extends ka{constructor(e){super(e,Pa.Fragment),this.registerOutput("xy",Ia.Vector2,Pa.Fragment),this.registerOutput("xyz",Ia.Vector3,Pa.Fragment),this.registerOutput("xyzw",Ia.Vector4,Pa.Fragment),this.registerOutput("x",Ia.Float,Pa.Fragment),this.registerOutput("y",Ia.Float,Pa.Fragment),this.registerOutput("z",Ia.Float,Pa.Fragment),this.registerOutput("w",Ia.Float,Pa.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";for(const i of this._outputs)i.hasEndpoints&&(t+=`${this._declareOutput(i,e)} = gl_FragCoord.${i.name};\n`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===Pa.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}),ue("BABYLON.ScreenSizeBlock",class extends ka{constructor(e){super(e,Pa.Fragment),this.registerOutput("xy",Ia.Vector2,Pa.Fragment),this.registerOutput("x",Ia.Float,Pa.Fragment),this.registerOutput("y",Ia.Float,Pa.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const s of this._outputs)s.hasEndpoints&&(i+=`${this._declareOutput(s,e)} = ${t}.${s.name};\n`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===Pa.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this}}),ue("BABYLON.ScreenSpaceBlock",class extends ka{constructor(e){super(e,Pa.Fragment),this.registerInput("vector",Ia.AutoDetect),this.registerInput("worldViewProjection",Ia.Matrix),this.registerOutput("output",Ia.Vector2),this.registerOutput("x",Ia.Float),this.registerOutput("y",Ia.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Vector3|Ia.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e,t=(()=>!0)){if(!this.worldViewProjection.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.WorldViewProjection&&t(e)));i||(i=new Ya("worldViewProjection"),i.setAsSystemValue(Fa.WorldViewProjection)),i.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;const s=i.associatedVariableName,n=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case Ia.Vector3:e.compilationString+=`vec4 ${n} = ${s} * vec4(${t.associatedVariableName}, 1.0);\n`;break;case Ia.Vector4:e.compilationString+=`vec4 ${n} = ${s} * ${t.associatedVariableName};\n`}return e.compilationString+=`${n}.xy /= ${n}.w;`,e.compilationString+=`${n}.xy = ${n}.xy * 0.5 + vec2(0.5, 0.5);`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${n}.xy;\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${n}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${n}.y;\n`),this}}),ue("BABYLON.TwirlBlock",class extends ka{constructor(e){super(e,Pa.Fragment),this.registerInput("input",Ia.Vector2),this.registerInput("strength",Ia.Float),this.registerInput("center",Ia.Vector2),this.registerInput("offset",Ia.Vector2),this.registerOutput("output",Ia.Vector2),this.registerOutput("x",Ia.Float),this.registerOutput("y",Ia.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new Ya("center");e.value=new pe(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new Ya("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new Ya("offset");e.value=new pe(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),s=e._getFreeVariableName("x"),n=e._getFreeVariableName("y"),r=e._getFreeVariableName("result");return e.compilationString+=`\n            vec2 ${t} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};\n            float ${i} = ${this.strength.associatedVariableName} * length(${t});\n            float ${s} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;\n            float ${n} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;\n            vec2 ${r} = vec2(${s} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${n} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);\n        `,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${r};\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${r}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${r}.y;\n`),this}});class Wl extends ka{constructor(e){super(e,Pa.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",Ia.Float),this.registerInput("worldPosition",Ia.Vector3),this.registerInput("worldNormal",Ia.Vector3),this.registerInput("worldTangent",Ia.AutoDetect,!0),this.registerOutput("output",Ia.Vector4),this.registerOutput("xyz",Ia.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Vector3|Ia.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];this.generateInWorldSpace||this.worldTangent.isConnected||p.Error(`You must connect the 'worldTangent' input of the ${this.name} block!`);const i=this.generateInWorldSpace?"":"\n            vec3 biTangent = cross(normal, tangent);\n            mat3 TBN = mat3(tangent, biTangent, normal);\n            ",s=this.generateInWorldSpace?"":"\n            result = TBN * result;\n            result = result * vec3(0.5) + vec3(0.5);\n            ",n=`\n            vec4 heightToNormal(in float height, in vec3 position, in vec3 tangent, in vec3 normal) {\n                ${i}\n                ${this.automaticNormalizationTangent?"tangent = normalize(tangent);":""}\n                ${this.automaticNormalizationNormal?"normal = normalize(normal);":""}\n                vec3 worlddX = dFdx(position);\n                vec3 worlddY = dFdy(position);\n                vec3 crossX = cross(normal, worlddX);\n                vec3 crossY = cross(normal, worlddY);\n                float d = abs(dot(crossY, worlddX));\n                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));\n                inToNormal.y *= -1.0;\n                vec3 result = normalize((d * normal) - inToNormal);\n                ${s}\n                return vec4(result, 0.);\n            }`;return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",n,"// heightToNormal"),e.compilationString+=this._declareOutput(t,e)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:"vec3(0.)"}.xyz, ${this.worldNormal.associatedVariableName});\n`,this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\n`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};\n`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};\n`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};\n`,e}serialize(){const e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}De([za("Generate in world space instead of tangent space",Da.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Wl.prototype,"generateInWorldSpace",void 0),De([za("Force normalization for the worldNormal input",Da.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Wl.prototype,"automaticNormalizationNormal",void 0),De([za("Force normalization for the worldTangent input",Da.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Wl.prototype,"automaticNormalizationTangent",void 0),ue("BABYLON.HeightToNormalBlock",Wl),ue("BABYLON.FragDepthBlock",class extends ka{constructor(e){super(e,Pa.Fragment,!0),this.registerInput("depth",Ia.Float,!0),this.registerInput("worldPos",Ia.Vector4,!0),this.registerInput("viewProjection",Ia.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){return super._buildBlock(e),this.depth.isConnected?e.compilationString+=`gl_FragDepth = ${this.depth.associatedVariableName};\n`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`\n                vec4 p = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};\n                float v = p.z / p.w;\n                #ifndef IS_NDC_HALF_ZRANGE\n                    v = v * 0.5 + 0.5;\n                #endif\n                gl_FragDepth = v;\n    \n            `:p.Warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}),ue("BABYLON.ShadowMapBlock",class extends ka{constructor(e){super(e,Pa.Fragment),this.registerInput("worldPosition",Ia.Vector4,!1),this.registerInput("viewProjection",Ia.Matrix,!1),this.registerInput("worldNormal",Ia.AutoDetect,!0),this.registerOutput("depth",Ia.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Vector3|Ia.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM")}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitUniformFromString("biasAndScaleSM","vec3"),e._emitUniformFromString("lightDataSM","vec3"),e._emitUniformFromString("depthValuesSM","vec2"),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`vec4 worldPos = ${this.worldPosition.associatedVariableName};\n`,e.compilationString+="vec3 vPositionWSM;\n",e.compilationString+="float vDepthMetricSM = 0.0;\n",e.compilationString+="float zSM;\n",this.worldNormal.isConnected&&(e.compilationString+=`vec3 vNormalW = ${this.worldNormal.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`vec4 clipPos = ${this.viewProjection.associatedVariableName} * worldPos;\n`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]}),e.compilationString+="\n            #if SM_DEPTHTEXTURE == 1\n                #ifdef IS_NDC_HALF_ZRANGE\n                    gl_FragDepth = (clipPos.z / clipPos.w);\n                #else\n                    gl_FragDepth = (clipPos.z / clipPos.w) * 0.5 + 0.5;\n                #endif\n            #endif\n        ",e.compilationString+=`${this._declareOutput(this.depth,e)} = vec3(depthSM, 1., 1.);\n`,this}}),ue("BABYLON.PrePassOutputBlock",class extends ka{constructor(e){super(e,Pa.Fragment,!0),this.registerInput("viewDepth",Ia.Float,!0),this.registerInput("worldPosition",Ia.AutoDetect,!0),this.registerInput("viewNormal",Ia.AutoDetect,!0),this.registerInput("reflectivity",Ia.AutoDetect,!0),this.inputs[1].addExcludedConnectionPointFromAllowedTypes(Ia.Vector3|Ia.Vector4),this.inputs[2].addExcludedConnectionPointFromAllowedTypes(Ia.Vector3|Ia.Vector4),this.inputs[3].addExcludedConnectionPointFromAllowedTypes(Ia.Vector3|Ia.Vector4|Ia.Color3|Ia.Color4)}getClassName(){return"PrePassOutputBlock"}get viewDepth(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get viewNormal(){return this._inputs[2]}get reflectivity(){return this._inputs[3]}_buildBlock(e){super._buildBlock(e);const t=this.worldPosition,i=this.viewNormal,s=this.viewDepth,n=this.reflectivity;e.sharedData.blocksWithDefines.push(this);const r=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",r),e.compilationString+="#if defined(PREPASS)\r\n",e.compilationString+="#ifdef PREPASS_DEPTH\r\n",s.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_DEPTH_INDEX] = vec4(${s.associatedVariableName}, 0.0, 0.0, 1.0);\r\n`:e.compilationString+=" gl_FragData[PREPASS_DEPTH_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_POSITION\r\n",t.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_POSITION_INDEX] = vec4(${t.associatedVariableName}.rgb, ${t.connectedPoint.type===Ia.Vector4?t.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_POSITION_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_NORMAL\r\n",i.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_NORMAL_INDEX] = vec4(${i.associatedVariableName}.rgb, ${i.connectedPoint.type===Ia.Vector4?i.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_NORMAL_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#ifdef PREPASS_REFLECTIVITY\r\n",n.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_REFLECTIVITY_INDEX] = vec4(${n.associatedVariableName}.rgb, ${n.connectedPoint.type===Ia.Vector4?n.associatedVariableName+".a":"1.0"});\r\n`:e.compilationString+=" gl_FragData[PREPASS_REFLECTIVITY_INDEX] = vec4(0.0, 0.0, 0.0, 1.0);\r\n",e.compilationString+="#endif\r\n",e.compilationString+="#endif\r\n",this}}),ue("BABYLON.FogBlock",class extends ka{constructor(e){super(e,Pa.VertexAndFragment,!1),this.registerInput("worldPosition",Ia.Vector4,!1,Pa.Vertex),this.registerInput("view",Ia.Matrix,!1,Pa.Vertex),this.registerInput("input",Ia.AutoDetect,!1,Pa.Fragment),this.registerInput("fogColor",Ia.AutoDetect,!1,Pa.Fragment),this.registerOutput("output",Ia.Color3,Pa.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Vector3|Ia.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Vector3|Ia.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e,t=(()=>!0)){if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.View&&t(e)));i||(i=new Ya("view"),i.setAsSystemValue(Fa.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.FogColor&&t(e)));i||(i=new Ya("fogColor",void 0,Ia.Color3),i.setAsSystemValue(Fa.FogColor)),i.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const s=e.getScene();i.setValue("FOG",t.fogEnabled&&wi.GetFogState(e,s))}bind(e,t,i){if(!i)return;const s=i.getScene();e.setFloat4(this._fogParameters,s.fogMode,s.fogStart,s.fogEnd,s.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===Pa.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});const t=e._getFreeVariableName("fog"),i=this.input,s=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const n=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+="#ifdef FOG\n",e.compilationString+=`float ${t} = CalcFogFactor(${this._fogDistanceName}, ${this._fogParameters});\n`,e.compilationString+=this._declareOutput(n,e)+` = ${t} * ${i.associatedVariableName}.rgb + (1.0 - ${t}) * ${s.associatedVariableName}.rgb;\n`,e.compilationString+=`#else\n${this._declareOutput(n,e)} =  ${i.associatedVariableName}.rgb;\n`,e.compilationString+="#endif\n"}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+=`${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;\n`}return this}});class Xl extends ka{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,p.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?Pa.Fragment:Pa.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?Pa.Fragment:Pa.Vertex}constructor(e){super(e,Pa.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",Ia.Vector4,!1,Pa.Vertex),this.registerInput("worldNormal",Ia.Vector4,!1,Pa.Fragment),this.registerInput("cameraPosition",Ia.Vector3,!1,Pa.Fragment),this.registerInput("glossiness",Ia.Float,!0,Pa.Fragment),this.registerInput("glossPower",Ia.Float,!0,Pa.Fragment),this.registerInput("diffuseColor",Ia.Color3,!0,Pa.Fragment),this.registerInput("specularColor",Ia.Color3,!0,Pa.Fragment),this.registerInput("view",Ia.Matrix,!0),this.registerOutput("diffuseOutput",Ia.Color3,Pa.Fragment),this.registerOutput("specularOutput",Ia.Color3,Pa.Fragment),this.registerOutput("shadow",Ia.Float,Pa.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}autoConfigure(e,t=(()=>!0)){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.CameraPosition&&t(e)));i||(i=new Ya("cameraPosition"),i.setAsSystemValue(Fa.CameraPosition)),i.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const s=e.getScene();if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};wi.PrepareDefinesForLight(s,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else wi.PrepareDefinesForLights(s,e,i,!0,t.maxSimultaneousLights)}updateUniformsAndSamples(e,t,i,s){for(let n=0;n<t.maxSimultaneousLights&&i["LIGHT"+n];n++){const t=e.uniforms.indexOf("vLightData"+n)>=0;wi.PrepareUniformsAndSamplersForLight(n,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+n],s,t)}}bind(e,t,i){if(!i)return;const s=i.getScene();this.light?wi.BindLight(this.light,this._lightId,s,e,!0):wi.BindLights(s,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const s="v_"+t.associatedVariableName;e._emitVaryingFromString(s,"vec4")&&(e.compilationString+=`${s} = ${t.associatedVariableName};\n`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${t.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_buildBlock(e){if(super._buildBlock(e),e.target!==Pa.Fragment)return void this._injectVertexCode(e);this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=`//${this.name}`,i=this.worldPosition;let s=i.associatedVariableName;this.generateOnlyFragmentCode?(s=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`vec3 ${s};\n`,t),e.compilationString+=`${s} = ${i.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${i.associatedVariableName}`:void 0})):s="v_"+s+".xyz",e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("lightsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:s}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:s}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),0===this._lightId&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${s});\n`),e.compilationString+="lightingInfo info;\n",e.compilationString+="float shadow = 1.;\n",e.compilationString+="float aggShadow = 0.;\n",e.compilationString+="float numLights = 0.;\n",e.compilationString+=`float glossiness = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\n`,e.compilationString+="vec3 diffuseBase = vec3(0., 0., 0.);\n",e.compilationString+="vec3 specularBase = vec3(0., 0., 0.);\n",e.compilationString+=`vec3 normalW = ${this.worldNormal.associatedVariableName}.xyz;\n`),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/vPositionW/g,replace:s+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{repeatKey:"maxSimultaneousLights",substitutionVars:`vPositionW,${s}.xyz`}),0===this._lightId&&(e.compilationString+="aggShadow = aggShadow / numLights;\n");const n=this.diffuseOutput,r=this.specularOutput;return e.compilationString+=this._declareOutput(n,e)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\n`,r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\n`),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+" = aggShadow;\n"),this}serialize(){const e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}De([za("Generate only fragment code",Da.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Xl._OnGenerateOnlyFragmentCodeChanged}})],Xl.prototype,"generateOnlyFragmentCode",void 0),ue("BABYLON.LightBlock",Xl);class Ql extends ka{get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:u.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}get samplerName(){return this._samplerName}constructor(e){super(e,Pa.VertexAndFragment),this.registerOutput("source",Ia.Object,Pa.VertexAndFragment,new Gl("source",this,Oa.Output,Ql,"ImageSourceBlock"))}bind(e){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.target===Pa.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!vl.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=zi.Parse(e.texture,t,i))}}ue("BABYLON.ImageSourceBlock",Ql);class Yl extends ka{get texture(){var e;return this.source.isConnected?(null===(e=this.source.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:u.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _IsPrePassTextureBlock(e){return"PrePassTextureBlock"===(null==e?void 0:e.getClassName())}get _isSourcePrePass(){return Yl._IsPrePassTextureBlock(this._imageSource)}get samplerName(){if(this._imageSource){if(!Yl._IsPrePassTextureBlock(this._imageSource))return this._imageSource.samplerName;if(this.source.connectedPoint)return this._imageSource.getSamplerName(this.source.connectedPoint)}return this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=null!==(t=this.texture.getScene())&&void 0!==t?t:u.LastCreatedScene;null==e||e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=null!==(t=this.texture.getScene())&&void 0!==t?t:u.LastCreatedScene;null==e||e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?Pa.Fragment:Pa.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",Ia.AutoDetect,!1,Pa.VertexAndFragment),this.registerInput("source",Ia.Object,!0,Pa.VertexAndFragment,new Gl("source",this,Oa.Input,Ql,"ImageSourceBlock")),this.registerInput("layer",Ia.Float,!0),this.registerInput("lod",Ia.Float,!0),this.registerOutput("rgba",Ia.Color4,Pa.Neutral),this.registerOutput("rgb",Ia.Color3,Pa.Neutral),this.registerOutput("r",Ia.Float,Pa.Neutral),this.registerOutput("g",Ia.Float,Pa.Neutral),this.registerOutput("b",Ia.Float,Pa.Neutral),this.registerOutput("a",Ia.Float,Pa.Neutral),this.registerOutput("level",Ia.Float,Pa.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Vector2|Ia.Vector3|Ia.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get lod(){return this._inputs[3]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}get target(){if(this._fragmentOnly)return Pa.Fragment;if(!this.uv.isConnected)return Pa.VertexAndFragment;if(this.uv.sourceBlock.isInput)return Pa.VertexAndFragment;let e=this.uv.connectedPoint;for(;e;){if(e.target===Pa.Fragment)return Pa.Fragment;if(e.target===Pa.Vertex)return Pa.VertexAndFragment;if(e.target===Pa.Neutral||e.target===Pa.VertexAndFragment){const t=e.ownerBlock;if(t.target===Pa.Fragment)return Pa.Fragment;e=null;for(const i of t.inputs)if(i.connectedPoint){e=i.connectedPoint;break}}}return Pa.VertexAndFragment}set target(e){}autoConfigure(e,t=(()=>!0)){if(!this.uv.isConnected)if(e.mode===tl.PostProcess){const i=e.getBlockByPredicate((e=>"uv"===e.name&&t(e)));i&&i.connectTo(this)}else{const i=e.mode===tl.Particle?"particle_uv":"uv";let s=e.getInputBlockByPredicate((e=>e.isAttribute&&e.name===i&&t(e)));s||(s=new Ya("uv"),s.setAsAttribute(i)),s.output.connectTo(this.uv)}}initializeDefines(e,t,i){i._areTexturesDirty&&void 0!==this._mainUVDefineName&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix)return void(this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)));const s=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,n=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,s,!0),i.setValue(this._gammaDefineName,n,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),null==i[this._mainUVDefineName]&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!!this._isSourcePrePass||!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this._isSourcePrePass&&e.setFloat(this._textureInfoName,1),this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==Pa.Fragment}_injectVertexCode(e){const t=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+t.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`${this._transformedUVName} = vec2(${this._textureTransformName} * vec4(${t.associatedVariableName}.xy, 1.0, 0.0));\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`,e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,e.compilationString+="#endif\n",this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name,!0)}}_getUVW(e){var t,i,s;let n=e;return null!==(s=null===(i=null===(t=this._texture)||void 0===t?void 0:t._texture)||void 0===i?void 0:i.is2DArray)&&void 0!==s&&s&&(n=`vec3(${e}, ${this.layer.isConnected?this.layer.associatedVariableName:"0"})`),n}get _samplerFunc(){return this.lod.isConnected?"texture2DLodEXT":"texture2D"}get _samplerLodSuffix(){return this.lod.isConnected?`, ${this.lod.associatedVariableName}`:""}_generateTextureLookup(e){const t=this.samplerName;e.compilationString+=`#ifdef ${this._defineName}\n`,e.compilationString+=`vec4 ${this._tempTextureRead} = ${this._samplerFunc}(${t}, ${this._getUVW(this._transformedUVName)}${this._samplerLodSuffix});\n`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\n`,e.compilationString+=`vec4 ${this._tempTextureRead} = ${this._samplerFunc}(${t}, ${this._getUVW(this._mainUVName?this._mainUVName:this.uv.associatedVariableName)}${this._samplerLodSuffix});\n`,e.compilationString+="#endif\n"}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===Pa.Fragment)return;this._generateTextureLookup(e)}else this.uv.ownerBlock.target!==Pa.Fragment?this._generateTextureLookup(e):e.compilationString+=`vec4 ${this._tempTextureRead} = ${this._samplerFunc}(${this.samplerName}, ${this._getUVW(i.associatedVariableName)}${this._samplerLodSuffix});\n`}_generateConversionCode(e,t,i){"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i,s=!1){if(s){if(e.target===Pa.Fragment)return;return e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i)}if(this.uv.ownerBlock.target===Pa.Fragment)return e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`,void this._generateConversionCode(e,t,i);let n="";this.disableLevelMultiplication||(n=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${n};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){var t,i,s,n;if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===Pa.Vertex||this._fragmentOnly||e.target===Pa.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===Pa.Fragment||this._isMixed&&e.target===Pa.Vertex)&&(this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),(null===(i=null===(t=this._texture)||void 0===t?void 0:t._texture)||void 0===i?void 0:i.is2DArray)?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target!==Pa.Fragment)return void this._injectVertexCode(e);if(!this._outputs.some((e=>e.isConnectedInFragmentShader)))return;this._isMixed&&!this._imageSource&&((null===(n=null===(s=this._texture)||void 0===s?void 0:s._texture)||void 0===n?void 0:n.is2DArray)?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName));const r=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",r),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!vl.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=zi.Parse(e.texture,t,i))}}ue("BABYLON.TextureBlock",Yl);class Kl extends ka{get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:u.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?Pa.Fragment:Pa.VertexAndFragment)}constructor(e){super(e,Pa.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}autoConfigure(e,t=(()=>!0)){if(!this.position.isConnected){let i=e.getInputBlockByPredicate((e=>e.isAttribute&&"position"===e.name&&t(e)));i||(i=new Ya("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.World&&t(e)));i||(i=new Ya("world"),i.setAsSystemValue(Fa.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.View&&t(e)));i||(i=new Ya("view"),i.setAsSystemValue(Fa.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const s=this._getTexture();s&&s.getTextureMatrix&&(i.setValue(this._define3DName,s.isCube,!0),i.setValue(this._defineLocalCubicName,!!s.boundingBoxSize,!0),i.setValue(this._defineExplicitName,0===s.coordinatesMode,!0),i.setValue(this._defineSkyboxName,5===s.coordinatesMode,!0),i.setValue(this._defineCubicName,3===s.coordinatesMode||6===s.coordinatesMode,!0),i.setValue("INVERTCUBICMAP",6===s.coordinatesMode,!0),i.setValue(this._defineSphericalName,1===s.coordinatesMode,!0),i.setValue(this._definePlanarName,2===s.coordinatesMode,!0),i.setValue(this._defineProjectionName,4===s.coordinatesMode,!0),i.setValue(this._defineEquirectangularName,7===s.coordinatesMode,!0),i.setValue(this._defineEquirectangularFixedName,8===s.coordinatesMode,!0),i.setValue(this._defineMirroredEquirectangularFixedName,9===s.coordinatesMode,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){const s=this._getTexture();if(i&&s&&(e.setMatrix(this._reflectionMatrixName,s.getReflectionTextureMatrix()),s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s),s.boundingBoxSize)){const t=s;e.setVector3(this._reflectionPositionName,t.boundingBoxPosition),e.setVector3(this._reflectionSizeName,t.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===Pa.Vertex)return"";this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,"mat4");let t="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");const i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(i,"vec4"))&&(t+=`${this.generateOnlyFragmentCode?"vec4 ":""}${i} = ${this.worldPosition.associatedVariableName};\n`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,"vec3",this._defineSkyboxName))&&(t+=`#ifdef ${this._defineSkyboxName}\n`,t+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;\n`,t+="#endif\n"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,"vec3",`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(t+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})\n`,t+=`${this.generateOnlyFragmentCode?"vec3 ":""}${this._directionWName} = normalize(vec3(${this.world.associatedVariableName} * vec4(${this.position.associatedVariableName}.xyz, 0.0)));\n`,t+="#endif\n"),t}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}\n`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\n`,e._samplerDeclaration+="#else\n",e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\n`,e._samplerDeclaration+="#endif\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,"vec3"),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,"vec3")}handleFragmentSideCodeReflectionCoords(e,t,i=!1,s=!1){t||(t=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);const n=this._reflectionMatrixName,r=`normalize(${this._directionWName})`,o=`${this._positionUVWName}`,a=`${this.cameraPosition.associatedVariableName}`,l=`${this.view.associatedVariableName}`;e+=".xyz";let h=`\n            #ifdef ${this._defineMirroredEquirectangularFixedName}\n                vec3 ${this._reflectionVectorName} = computeMirroredFixedEquirectangularCoords(${t}, ${e}, ${r});\n            #endif\n\n            #ifdef ${this._defineEquirectangularFixedName}\n                vec3 ${this._reflectionVectorName} = computeFixedEquirectangularCoords(${t}, ${e}, ${r});\n            #endif\n\n            #ifdef ${this._defineEquirectangularName}\n                vec3 ${this._reflectionVectorName} = computeEquirectangularCoords(${t}, ${e}, ${a}.xyz, ${n});\n            #endif\n\n            #ifdef ${this._defineSphericalName}\n                vec3 ${this._reflectionVectorName} = computeSphericalCoords(${t}, ${e}, ${l}, ${n});\n            #endif\n\n            #ifdef ${this._definePlanarName}\n                vec3 ${this._reflectionVectorName} = computePlanarCoords(${t}, ${e}, ${a}.xyz, ${n});\n            #endif\n\n            #ifdef ${this._defineCubicName}\n                #ifdef ${this._defineLocalCubicName}\n                    vec3 ${this._reflectionVectorName} = computeCubicLocalCoords(${t}, ${e}, ${a}.xyz, ${n}, ${this._reflectionSizeName}, ${this._reflectionPositionName});\n                #else\n                vec3 ${this._reflectionVectorName} = computeCubicCoords(${t}, ${e}, ${a}.xyz, ${n});\n                #endif\n            #endif\n\n            #ifdef ${this._defineProjectionName}\n                vec3 ${this._reflectionVectorName} = computeProjectionCoords(${t}, ${l}, ${n});\n            #endif\n\n            #ifdef ${this._defineSkyboxName}\n                vec3 ${this._reflectionVectorName} = computeSkyBoxCoords(${o}, ${n});\n            #endif\n\n            #ifdef ${this._defineExplicitName}\n                vec3 ${this._reflectionVectorName} = vec3(0, 0, 0);\n            #endif\n`;return s||(h+=`#ifdef ${this._defineOppositeZ}\n                ${this._reflectionVectorName}.z *= -1.0;\n            #endif\n`),i||(h+=`\n                #ifdef ${this._define3DName}\n                    vec3 ${this._reflectionCoordsName} = ${this._reflectionVectorName};\n                #else\n                    vec2 ${this._reflectionCoordsName} = ${this._reflectionVectorName}.xy;\n                    #ifdef ${this._defineProjectionName}\n                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;\n                    #endif\n                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;\n                #endif\n`),h}handleFragmentSideCodeReflectionColor(e,t=".rgb"){let i=`${"vec"+(0===t.length?"4":t.length-1)} ${this._reflectionColorName};\n            #ifdef ${this._define3DName}\n`;return i+=e?`${this._reflectionColorName} = textureCubeLodEXT(${this._cubeSamplerName}, ${this._reflectionVectorName}, ${e})${t};\n`:`${this._reflectionColorName} = textureCube(${this._cubeSamplerName}, ${this._reflectionVectorName})${t};\n`,i+="\n            #else\n",i+=e?`${this._reflectionColorName} = texture2DLodEXT(${this._2DSamplerName}, ${this._reflectionCoordsName}, ${e})${t};\n`:`${this._reflectionColorName} = texture2D(${this._2DSamplerName}, ${this._reflectionCoordsName})${t};\n`,i+="#endif\n",i}writeOutputs(e,t){let i="";if(e.target===Pa.Fragment)for(const s of this._outputs)s.hasEndpoints&&(i+=`${this._declareOutput(s,e)} = ${t}.${s.name};\n`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});\n`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);\n`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!vl.IgnoreTexturesAtLoadTime&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=xr.Parse(e.texture,t,i):this.texture=zi.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}De([za("Generate only fragment code",Da.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Kl._OnGenerateOnlyFragmentCodeChanged}})],Kl.prototype,"generateOnlyFragmentCode",void 0),ue("BABYLON.ReflectionTextureBaseBlock",Kl),ue("BABYLON.ReflectionTextureBlock",class extends Kl{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,p.Error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,p.Error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?Pa.Fragment:Pa.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?Pa.Fragment:Pa.Vertex}constructor(e){super(e),this.registerInput("position",Ia.AutoDetect,!1,Pa.Vertex),this.registerInput("worldPosition",Ia.Vector4,!1,Pa.Vertex),this.registerInput("worldNormal",Ia.Vector4,!1,Pa.Fragment),this.registerInput("world",Ia.Matrix,!1,Pa.Vertex),this.registerInput("cameraPosition",Ia.Vector3,!1,Pa.Fragment),this.registerInput("view",Ia.Matrix,!1,Pa.Fragment),this.registerOutput("rgb",Ia.Color3,Pa.Fragment),this.registerOutput("rgba",Ia.Color4,Pa.Fragment),this.registerOutput("r",Ia.Float,Pa.Fragment),this.registerOutput("g",Ia.Float,Pa.Fragment),this.registerOutput("b",Ia.Float,Pa.Fragment),this.registerOutput("a",Ia.Float,Pa.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Vector3|Ia.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e,t=(()=>!0)){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.CameraPosition&&t(e)));i||(i=new Ya("cameraPosition"),i.setAsSystemValue(Fa.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec4(0.)"),this;if(e.target!==Pa.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`vec4 ${t} = normalize(${this.worldNormal.associatedVariableName});\n`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}});class jl extends ka{constructor(e){super(e,Pa.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",Ia.AutoDetect,!1,Pa.VertexAndFragment),this.registerOutput("depth",Ia.Float,Pa.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Vector2|Ia.Vector3|Ia.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?Pa.VertexAndFragment:Pa.Fragment:Pa.VertexAndFragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec"+(t.type===Ia.Vector3?"3":t.type===Ia.Vector4?"4":"2"))),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\n`,this._outputs.some((e=>e.isConnectedInVertexShader))){this._writeTextureRead(e,!0);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===Pa.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\n`}else this.uv.ownerBlock.target!==Pa.Fragment?e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\n`:e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\n`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===Pa.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`}else this.uv.ownerBlock.target,Pa.Fragment,e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\n`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==Pa.Fragment)return e._emit2DSampler(this._samplerName),void this._injectVertexCode(e);if(this._outputs.some((e=>e.isConnectedInFragmentShader))){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}De([za("Use non linear depth",Da.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let s=!1;return i.useNonLinearDepth&&(i.storeCameraSpaceZ=!1,s=!0),e&&e.disableDepthRenderer(),s}}})],jl.prototype,"useNonLinearDepth",void 0),De([za("Store Camera space Z",Da.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{const i=t;let s=!1;return i.storeCameraSpaceZ&&(i.useNonLinearDepth=!1,s=!0),e&&e.disableDepthRenderer(),s}}})],jl.prototype,"storeCameraSpaceZ",void 0),De([za("Force 32 bits float",Da.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:e=>null==e?void 0:e.disableDepthRenderer()}})],jl.prototype,"force32itsFloat",void 0),ue("BABYLON.SceneDepthBlock",jl),ue("BABYLON.ClipPlanesBlock",class extends ka{constructor(e){super(e,Pa.VertexAndFragment,!0),this.registerInput("worldPosition",Ia.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6")}get worldPosition(){return this._inputs[0]}get target(){return Pa.VertexAndFragment}set target(e){}prepareDefines(e,t,i){var s,n,r,o,a,l;const h=e.getScene(),c=!!(null!==(s=t.clipPlane)&&void 0!==s?s:h.clipPlane),d=!!(null!==(n=t.clipPlane2)&&void 0!==n?n:h.clipPlane2),u=!!(null!==(r=t.clipPlane3)&&void 0!==r?r:h.clipPlane3),_=!!(null!==(o=t.clipPlane4)&&void 0!==o?o:h.clipPlane4),f=!!(null!==(a=t.clipPlane5)&&void 0!==a?a:h.clipPlane5),p=!!(null!==(l=t.clipPlane6)&&void 0!==l?l:h.clipPlane6);i.setValue("CLIPPLANE",c,!0),i.setValue("CLIPPLANE2",d,!0),i.setValue("CLIPPLANE3",u,!0),i.setValue("CLIPPLANE4",_,!0),i.setValue("CLIPPLANE5",f,!0),i.setValue("CLIPPLANE6",p,!0)}bind(e,t,i){i&&Fi(e,t,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==Pa.Fragment){const i=this.worldPosition;return e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane","vec4"),e._emitUniformFromString("vClipPlane2","vec4"),e._emitUniformFromString("vClipPlane3","vec4"),e._emitUniformFromString("vClipPlane4","vec4"),e._emitUniformFromString("vClipPlane5","vec4"),void e._emitUniformFromString("vClipPlane6","vec4")}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}),ue("BABYLON.PrePassTextureBlock",class extends ka{get texture(){return null}set texture(e){}constructor(e,t=Pa.VertexAndFragment){super(e,t,!1),this.registerOutput("position",Ia.Object,Pa.VertexAndFragment,new Gl("position",this,Oa.Output,Ql,"ImageSourceBlock")),this.registerOutput("depth",Ia.Object,Pa.VertexAndFragment,new Gl("depth",this,Oa.Output,Ql,"ImageSourceBlock")),this.registerOutput("normal",Ia.Object,Pa.VertexAndFragment,new Gl("normal",this,Oa.Output,Ql,"ImageSourceBlock"))}getSamplerName(e){return e===this._outputs[0]?this._positionSamplerName:e===this._outputs[1]?this._depthSamplerName:e===this._outputs[2]?this._normalSamplerName:""}get position(){return this._outputs[0]}get depth(){return this._outputs[1]}get normal(){return this._outputs[2]}get positionSamplerName(){return this._positionSamplerName}get normalSamplerName(){return this._normalSamplerName}get depthSamplerName(){return this._depthSamplerName}getClassName(){return"PrePassTextureBlock"}_buildBlock(e){if(super._buildBlock(e),e.target!==Pa.Vertex)return this._positionSamplerName="prepassPositionSampler",this._depthSamplerName="prepassDepthSampler",this._normalSamplerName="prepassNormalSampler",e.sharedData.variableNames.prepassPositionSampler=0,e.sharedData.variableNames.prepassDepthSampler=0,e.sharedData.variableNames.prepassNormalSampler=0,e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this),e._emit2DSampler(this._positionSamplerName),e._emit2DSampler(this._depthSamplerName),e._emit2DSampler(this._normalSamplerName),this}bind(e,t){const i=t.getScene().enablePrePassRenderer();if(!i)return;const s=i.defaultRT;s.textures&&(this.position.isConnected&&e.setTexture(this._positionSamplerName,s.textures[i.getIndex(1)]),this.depth.isConnected&&e.setTexture(this._depthSamplerName,s.textures[i.getIndex(5)]),this.normal.isConnected&&e.setTexture(this._normalSamplerName,s.textures[i.getIndex(6)]))}}),ue("BABYLON.NodeMaterialTeleportInBlock",class extends ka{get endpoints(){return this._endpoints}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==Pa.VertexAndFragment)return t.target;if(e.connectedPoint.target!==Pa.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){0==(this._target&e)&&(this._target=e)}constructor(e){super(e,Pa.Neutral),this._endpoints=[],this.registerInput("input",Ia.AutoDetect)}getClassName(){return"NodeMaterialTeleportInBlock"}get input(){return this._inputs[0]}isConnectedInFragmentShader(){return this.endpoints.some((e=>e.output.isConnectedInFragmentShader))}_dumpCode(e,t){let i=super._dumpCode(e,t);for(const s of this.endpoints)-1===t.indexOf(s)&&(i+=s._dumpCode(e,t));return i}isAnAncestorOf(e){for(const t of this.endpoints){if(t===e)return!0;if(t.isAnAncestorOf(e))return!0}return!1}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){const t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}dispose(){super.dispose();for(const e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}}),ue("BABYLON.NodeMaterialTeleportOutBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",Ia.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeMaterialTeleportOutBlock"}get output(){return this._outputs[0]}get target(){return this._entryPoint?this._entryPoint.target:this._target}set target(e){0==(this._target&e)&&(this._target=e)}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(e){super._buildBlock(e),this.entryPoint&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${this.entryPoint.input.associatedVariableName};\n`)}clone(e,t=""){const i=super.clone(e,t);return this.entryPoint&&this.entryPoint.attachToEndpoint(i),i}_customBuildStep(e,t){this.entryPoint&&this.entryPoint.build(e,t)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});\n`),e}serialize(){var e,t;const i=super.serialize();return i.entryPoint=null!==(t=null===(e=this.entryPoint)||void 0===e?void 0:e.uniqueId)&&void 0!==t?t:"",i}_deserialize(e,t,i){super._deserialize(e,t,i),this._tempEntryPointUniqueId=e.entryPoint}}),ue("BABYLON.AddBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push(Ia.Float),this._inputs[1].acceptedConnectionPointTypes.push(Ia.Float)}getClassName(){return"AddBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\n`,this}}),ue("BABYLON.ScaleBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("input",Ia.AutoDetect),this.registerInput("factor",Ia.Float),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\n`,this}});class $l extends ka{constructor(e){super(e,Pa.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = clamp(${this.value.associatedVariableName}, ${this._writeFloat(this.minimum)}, ${this._writeFloat(this.maximum)});\n`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};\n`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};\n`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}De([za("Minimum",Da.Float)],$l.prototype,"minimum",void 0),De([za("Maximum",Da.Float)],$l.prototype,"maximum",void 0),ue("BABYLON.ClampBlock",$l),ue("BABYLON.CrossBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerOutput("output",Ia.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ia.Float),this._inputs[0].excludedConnectionPointTypes.push(Ia.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ia.Vector2),this._inputs[1].excludedConnectionPointTypes.push(Ia.Float),this._inputs[1].excludedConnectionPointTypes.push(Ia.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ia.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\n`,this}}),ue("BABYLON.CustomBlock",class extends ka{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach((s=>{const n=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),r=e._getGLType(s.type);t=t.replace(n,r),i=i.replace(n,r)})),this._outputs.forEach((s=>{const n=new RegExp("\\{TYPE_"+s.name+"\\}","gm"),r=e._getGLType(s.type);t=t.replace(n,r),i=i.replace(n,r)})),e._emitFunction(i,t,""),this._outputs.forEach((t=>{e.compilationString+=this._declareOutput(t,e)+";\n"})),e.compilationString+=i+"(";let s=!1;return this._inputs.forEach(((t,i)=>{var n,r,o;i>0&&(e.compilationString+=", "),this._inputSamplers&&-1!==this._inputSamplers.indexOf(t.name)?e.compilationString+=null!==(o=null===(r=null===(n=t.connectedPoint)||void 0===n?void 0:n.ownerBlock)||void 0===r?void 0:r.samplerName)&&void 0!==o?o:t.associatedVariableName:e.compilationString+=t.associatedVariableName,s=!0})),this._outputs.forEach(((t,i)=>{(i>0||s)&&(e.compilationString+=", "),e.compilationString+=t.associatedVariableName})),e.compilationString+=");\n",this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};\n`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){var t,i,s;this._options=e,this._code=e.code.join("\n")+"\n",this.name=this.name||e.name,this.target=Pa[e.target],null===(t=e.inParameters)||void 0===t||t.forEach(((e,t)=>{const i=Ia[e.type];"sampler2D"===e.type||"samplerCube"===e.type?(this._inputSamplers=this._inputSamplers||[],this._inputSamplers.push(e.name),this.registerInput(e.name,Ia.Object,!0,Pa.VertexAndFragment,new Gl(e.name,this,Oa.Input,Ql,"ImageSourceBlock"))):this.registerInput(e.name,i),Object.defineProperty(this,e.name,{get:function(){return this._inputs[t]},enumerable:!0,configurable:!0})})),null===(i=e.outParameters)||void 0===i||i.forEach(((e,t)=>{this.registerOutput(e.name,Ia[e.type]),Object.defineProperty(this,e.name,{get:function(){return this._outputs[t]},enumerable:!0,configurable:!0}),"BasedOnInput"===e.type&&(this._outputs[t]._typeConnectionSource=this._findInputByName(e.typeFromInput)[0])})),null===(s=e.inLinkedConnectionTypes)||void 0===s||s.forEach((e=>{this._linkConnectionTypes(this._findInputByName(e.input1)[1],this._findInputByName(e.input2)[1])}))}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}),ue("BABYLON.DotBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerOutput("output",Ia.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ia.Float),this._inputs[0].excludedConnectionPointTypes.push(Ia.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ia.Float),this._inputs[1].excludedConnectionPointTypes.push(Ia.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),ue("BABYLON.NormalizeBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("input",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Ia.Float),this._inputs[0].excludedConnectionPointTypes.push(Ia.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(${i.associatedVariableName});\n`,this}}),ue("BABYLON.ColorMergerBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",Ia.Color3,!0),this.registerInput("r",Ia.Float,!0),this.registerInput("g",Ia.Float,!0),this.registerInput("b",Ia.Float,!0),this.registerInput("a",Ia.Float,!0),this.registerOutput("rgba",Ia.Color4),this.registerOutput("rgb",Ia.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return"rgb "===e?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,s=this.b,n=this.a,r=this.rgbIn,o=this._outputs[0],a=this._outputs[1];return r.isConnected?(o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec4(${r.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${r.associatedVariableName}${this._buildSwizzle(3)};\n`)):(o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\n`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){var s,n,r,o;super._deserialize(e,t,i),this.rSwizzle=null!==(s=e.rSwizzle)&&void 0!==s?s:"r",this.gSwizzle=null!==(n=e.gSwizzle)&&void 0!==n?n:"g",this.bSwizzle=null!==(r=e.bSwizzle)&&void 0!==r?r:"b",this.aSwizzle=null!==(o=e.aSwizzle)&&void 0!==o?o:"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";\n`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";\n`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";\n`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";\n`,e}}),ue("BABYLON.VectorSplitterBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("xyzw",Ia.Vector4,!0),this.registerInput("xyz ",Ia.Vector3,!0),this.registerInput("xy ",Ia.Vector2,!0),this.registerOutput("xyz",Ia.Vector3),this.registerOutput("xy",Ia.Vector2),this.registerOutput("zw",Ia.Vector2),this.registerOutput("x",Ia.Float),this.registerOutput("y",Ia.Float),this.registerOutput("z",Ia.Float),this.registerOutput("w",Ia.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],s=this._outputs[1],n=this._outputs[2],r=this._outputs[3],o=this._outputs[4],a=this._outputs[5],l=this._outputs[6];return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=this._declareOutput(i,e)+` = vec3(${t.associatedVariableName}, 0.0);\n`:e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.xyz;\n`),n.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=this._declareOutput(n,e)+` = ${this.xyzw.associatedVariableName}.zw;\n`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.xy;\n`),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${t.associatedVariableName}.x;\n`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.y;\n`),a.hasEndpoints&&(e.compilationString+=this._declareOutput(a,e)+` = ${t.associatedVariableName}.z;\n`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = ${t.associatedVariableName}.w;\n`),this}}),ue("BABYLON.LerpBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerInput("gradient",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(Ia.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\n`,this}}),ue("BABYLON.DivideBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push(Ia.Float),this._inputs[1].acceptedConnectionPointTypes.push(Ia.Float)}getClassName(){return"DivideBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\n`,this}}),ue("BABYLON.SubtractBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].acceptedConnectionPointTypes.push(Ia.Float),this._inputs[1].acceptedConnectionPointTypes.push(Ia.Float)}getClassName(){return"SubtractBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\n`,this}}),ue("BABYLON.StepBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("value",Ia.Float),this.registerInput("edge",Ia.Float),this.registerOutput("output",Ia.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\n`,this}});class ql extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("input",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(Ia.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = 1. - ${this.input.associatedVariableName};\n`,this}}ue("BABYLON.OneMinusBlock",ql),ue("BABYLON.OppositeBlock",ql);class Zl extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("worldPosition",Ia.Vector4),this.registerInput("cameraPosition",Ia.Vector3),this.registerOutput("output",Ia.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e,t=(()=>!0)){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.CameraPosition&&t(e)));i||(i=new Ya("cameraPosition"),i.setAsSystemValue(Fa.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);\n`,this}}ue("BABYLON.ViewDirectionBlock",Zl),ue("BABYLON.FresnelBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("worldNormal",Ia.Vector4),this.registerInput("viewDirection",Ia.Vector3),this.registerInput("bias",Ia.Float),this.registerInput("power",Ia.Float),this.registerOutput("fresnel",Ia.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new Zl("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const e=new Ya("bias");e.value=0,e.output.connectTo(this.bias)}if(!this.power.isConnected){const e=new Ya("power");e.value=1,e.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\n`,this}}),ue("BABYLON.MaxBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),ue("BABYLON.MinBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),ue("BABYLON.DistanceBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerOutput("output",Ia.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ia.Float),this._inputs[0].excludedConnectionPointTypes.push(Ia.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ia.Float),this._inputs[1].excludedConnectionPointTypes.push(Ia.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\n`,this}}),ue("BABYLON.LengthBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("value",Ia.AutoDetect),this.registerOutput("output",Ia.Float),this._inputs[0].excludedConnectionPointTypes.push(Ia.Float),this._inputs[0].excludedConnectionPointTypes.push(Ia.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = length(${this.value.associatedVariableName});\n`,this}}),ue("BABYLON.NegateBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("value",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = -1.0 * ${this.value.associatedVariableName};\n`,this}}),ue("BABYLON.PowBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("value",Ia.AutoDetect),this.registerInput("power",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = pow(${this.value.associatedVariableName}, ${this.power.associatedVariableName});\n`,this}}),ue("BABYLON.RandomNumberBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("seed",Ia.AutoDetect),this.registerOutput("output",Ia.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Vector2|Ia.Vector3|Ia.Vector4|Ia.Color3|Ia.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=this._declareOutput(t,e)+` = getRand(${this.seed.associatedVariableName}.xy);\n`,this}}),ue("BABYLON.ArcTan2Block",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("x",Ia.Float),this.registerInput("y",Ia.Float),this.registerOutput("output",Ia.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = atan(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\n`,this}}),ue("BABYLON.SmoothStepBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("value",Ia.AutoDetect),this.registerInput("edge0",Ia.Float),this.registerInput("edge1",Ia.Float),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = smoothstep(${this.edge0.associatedVariableName}, ${this.edge1.associatedVariableName}, ${this.value.associatedVariableName});\n`,this}}),ue("BABYLON.ReciprocalBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("input",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return this.input.type===Ia.Matrix?e.compilationString+=this._declareOutput(t,e)+` = inverse(${this.input.associatedVariableName});\n`:e.compilationString+=this._declareOutput(t,e)+` = 1. / ${this.input.associatedVariableName};\n`,this}}),ue("BABYLON.ReplaceColorBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("value",Ia.AutoDetect),this.registerInput("reference",Ia.AutoDetect),this.registerInput("distance",Ia.Float),this.registerInput("replacement",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(Ia.Float),this._inputs[0].excludedConnectionPointTypes.push(Ia.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ia.Float),this._inputs[1].excludedConnectionPointTypes.push(Ia.Matrix),this._inputs[3].excludedConnectionPointTypes.push(Ia.Float),this._inputs[3].excludedConnectionPointTypes.push(Ia.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+";\n",e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\n`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};\n`,e.compilationString+="} else {\n",e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};\n`,e.compilationString+="}\n",this}}),ue("BABYLON.PosterizeBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("value",Ia.AutoDetect),this.registerInput("steps",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(Ia.Matrix),this._inputs[1].excludedConnectionPointTypes.push(Ia.Matrix)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\n`,this}}),function(e){e[e.SawTooth=0]="SawTooth",e[e.Square=1]="Square",e[e.Triangle=2]="Triangle"}(Nl||(Nl={})),ue("BABYLON.WaveBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.kind=Nl.SawTooth,this.registerInput("input",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Ia.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case Nl.SawTooth:e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\n`;break;case Nl.Square:e.compilationString+=this._declareOutput(t,e)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\n`;break;case Nl.Triangle:e.compilationString+=this._declareOutput(t,e)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\n`}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}});class Jl{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}ue("BABYLON.GradientBlock",class extends ka{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,Pa.Neutral),this.colorSteps=[new Jl(0,Re.Black()),new Jl(1,Re.White())],this.onValueChangedObservable=new s,this.registerInput("gradient",Ia.AutoDetect),this.registerOutput("output",Ia.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Float|Ia.Vector2|Ia.Vector3|Ia.Vector4|Ia.Color3|Ia.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e){const t=this.colorSteps[e];return`vec3(${t.color.r}, ${t.color.g}, ${t.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint)return void(e.compilationString+=this._declareOutput(t,e)+" = vec3(0., 0., 0.);\n");const i=e._getFreeVariableName("gradientTempColor"),s=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`vec3 ${i} = ${this._writeColorConstant(0)};\n`,e.compilationString+=`float ${s};\n`;let n=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==Ia.Float&&(n+=".x");for(let t=1;t<this.colorSteps.length;t++){const r=this.colorSteps[t],o=this.colorSteps[t-1];e.compilationString+=`${s} = clamp((${n} - ${e._emitFloat(o.step)}) / (${e._emitFloat(r.step)} -  ${e._emitFloat(o.step)}), 0.0, 1.0) * step(${e._emitFloat(t)}, ${e._emitFloat(this.colorSteps.length-1)});\n`,e.compilationString+=`${i} = mix(${i}, ${this._writeColorConstant(t)}, ${s});\n`}return e.compilationString+=this._declareOutput(t,e)+` = ${i};\n`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const t of e.colorSteps)this.colorSteps.push(new Jl(t.step,new Re(t.color.r,t.color.g,t.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];\n`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));\n`;return e}}),ue("BABYLON.NLerpBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerInput("gradient",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(Ia.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\n`,this}});class eh extends ka{constructor(e){super(e,Pa.Neutral),this.manhattanDistance=!1,this.registerInput("seed",Ia.Vector3),this.registerInput("jitter",Ia.Float),this.registerOutput("output",Ia.Vector2),this.registerOutput("x",Ia.Float),this.registerOutput("y",Ia.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t="vec3 permute(vec3 x){\n";t+="    return mod((34.0 * x + 1.0) * x, 289.0);\n",t+="}\n\n",t+="vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\n",t+="    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\n",t+="}\n\n",t+="vec2 worley(vec3 P, float jitter, bool manhattanDistance){\n",t+="    float K = 0.142857142857; // 1/7\n",t+="    float Ko = 0.428571428571; // 1/2-K/2\n",t+="    float  K2 = 0.020408163265306; // 1/(7*7)\n",t+="    float Kz = 0.166666666667; // 1/6\n",t+="    float Kzo = 0.416666666667; // 1/2-1/6*2\n",t+="\n",t+="    vec3 Pi = mod(floor(P), 289.0);\n",t+="    vec3 Pf = fract(P) - 0.5;\n",t+="\n",t+="    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\n",t+="    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\n",t+="\n",t+="    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\n",t+="    vec3 p1 = permute(p + Pi.y - 1.0);\n",t+="    vec3 p2 = permute(p + Pi.y);\n",t+="    vec3 p3 = permute(p + Pi.y + 1.0);\n",t+="\n",t+="    vec3 p11 = permute(p1 + Pi.z - 1.0);\n",t+="    vec3 p12 = permute(p1 + Pi.z);\n",t+="    vec3 p13 = permute(p1 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p21 = permute(p2 + Pi.z - 1.0);\n",t+="    vec3 p22 = permute(p2 + Pi.z);\n",t+="    vec3 p23 = permute(p2 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 p31 = permute(p3 + Pi.z - 1.0);\n",t+="    vec3 p32 = permute(p3 + Pi.z);\n",t+="    vec3 p33 = permute(p3 + Pi.z + 1.0);\n",t+="\n",t+="    vec3 ox11 = fract(p11*K) - Ko;\n",t+="    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\n",t+="    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\n",t+="\n",t+="    vec3 ox12 = fract(p12*K) - Ko;\n",t+="    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\n",t+="    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox13 = fract(p13*K) - Ko;\n",t+="    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\n",t+="    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox21 = fract(p21*K) - Ko;\n",t+="    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\n",t+="    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox22 = fract(p22*K) - Ko;\n",t+="    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\n",t+="    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox23 = fract(p23*K) - Ko;\n",t+="    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\n",t+="    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox31 = fract(p31*K) - Ko;\n",t+="    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\n",t+="    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox32 = fract(p32*K) - Ko;\n",t+="    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\n",t+="    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 ox33 = fract(p33*K) - Ko;\n",t+="    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\n",t+="    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\n",t+="\n",t+="    vec3 dx11 = Pfx + jitter*ox11;\n",t+="    vec3 dy11 = Pfy.x + jitter*oy11;\n",t+="    vec3 dz11 = Pfz.x + jitter*oz11;\n",t+="\n",t+="    vec3 dx12 = Pfx + jitter*ox12;\n",t+="    vec3 dy12 = Pfy.x + jitter*oy12;\n",t+="    vec3 dz12 = Pfz.y + jitter*oz12;\n",t+="\n",t+="    vec3 dx13 = Pfx + jitter*ox13;\n",t+="    vec3 dy13 = Pfy.x + jitter*oy13;\n",t+="    vec3 dz13 = Pfz.z + jitter*oz13;\n",t+="\n",t+="    vec3 dx21 = Pfx + jitter*ox21;\n",t+="    vec3 dy21 = Pfy.y + jitter*oy21;\n",t+="    vec3 dz21 = Pfz.x + jitter*oz21;\n",t+="\n",t+="    vec3 dx22 = Pfx + jitter*ox22;\n",t+="    vec3 dy22 = Pfy.y + jitter*oy22;\n",t+="    vec3 dz22 = Pfz.y + jitter*oz22;\n",t+="\n",t+="    vec3 dx23 = Pfx + jitter*ox23;\n",t+="    vec3 dy23 = Pfy.y + jitter*oy23;\n",t+="    vec3 dz23 = Pfz.z + jitter*oz23;\n",t+="\n",t+="    vec3 dx31 = Pfx + jitter*ox31;\n",t+="    vec3 dy31 = Pfy.z + jitter*oy31;\n",t+="    vec3 dz31 = Pfz.x + jitter*oz31;\n",t+="\n",t+="    vec3 dx32 = Pfx + jitter*ox32;\n",t+="    vec3 dy32 = Pfy.z + jitter*oy32;\n",t+="    vec3 dz32 = Pfz.y + jitter*oz32;\n",t+="\n",t+="    vec3 dx33 = Pfx + jitter*ox33;\n",t+="    vec3 dy33 = Pfy.z + jitter*oy33;\n",t+="    vec3 dz33 = Pfz.z + jitter*oz33;\n",t+="\n",t+="    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\n",t+="    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\n",t+="    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\n",t+="    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\n",t+="    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\n",t+="    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\n",t+="    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\n",t+="    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\n",t+="    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\n",t+="\n",t+="    vec3 d1a = min(d11, d12);\n",t+="    d12 = max(d11, d12);\n",t+="    d11 = min(d1a, d13); // Smallest now not in d12 or d13\n",t+="    d13 = max(d1a, d13);\n",t+="    d12 = min(d12, d13); // 2nd smallest now not in d13\n",t+="    vec3 d2a = min(d21, d22);\n",t+="    d22 = max(d21, d22);\n",t+="    d21 = min(d2a, d23); // Smallest now not in d22 or d23\n",t+="    d23 = max(d2a, d23);\n",t+="    d22 = min(d22, d23); // 2nd smallest now not in d23\n",t+="    vec3 d3a = min(d31, d32);\n",t+="    d32 = max(d31, d32);\n",t+="    d31 = min(d3a, d33); // Smallest now not in d32 or d33\n",t+="    d33 = max(d3a, d33);\n",t+="    d32 = min(d32, d33); // 2nd smallest now not in d33\n",t+="    vec3 da = min(d11, d21);\n",t+="    d21 = max(d11, d21);\n",t+="    d11 = min(da, d31); // Smallest now in d11\n",t+="    d31 = max(da, d31); // 2nd smallest now not in d31\n",t+="    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\n",t+="    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\n",t+="    d12 = min(d12, d21); // 2nd smallest now not in d21\n",t+="    d12 = min(d12, d22); // nor in d22\n",t+="    d12 = min(d12, d31); // nor in d31\n",t+="    d12 = min(d12, d32); // nor in d32\n",t+="    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\n",t+="    d11.y = min(d11.y,d12.z); // Only two more to go\n",t+="    d11.y = min(d11.y,d11.z); // Done! (Phew!)\n",t+="    return sqrt(d11.xy); // F1, F2\n",t+="}\n\n",e._emitFunction("worley3D","vec3 permute(vec3 x){\n    return mod((34.0 * x + 1.0) * x, 289.0);\n}\n\nvec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\n    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\n}\n\nvec2 worley(vec3 P, float jitter, bool manhattanDistance){\n    float K = 0.142857142857; // 1/7\n    float Ko = 0.428571428571; // 1/2-K/2\n    float  K2 = 0.020408163265306; // 1/(7*7)\n    float Kz = 0.166666666667; // 1/6\n    float Kzo = 0.416666666667; // 1/2-1/6*2\n\n    vec3 Pi = mod(floor(P), 289.0);\n    vec3 Pf = fract(P) - 0.5;\n\n    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\n    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\n    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\n\n    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\n    vec3 p1 = permute(p + Pi.y - 1.0);\n    vec3 p2 = permute(p + Pi.y);\n    vec3 p3 = permute(p + Pi.y + 1.0);\n\n    vec3 p11 = permute(p1 + Pi.z - 1.0);\n    vec3 p12 = permute(p1 + Pi.z);\n    vec3 p13 = permute(p1 + Pi.z + 1.0);\n\n    vec3 p21 = permute(p2 + Pi.z - 1.0);\n    vec3 p22 = permute(p2 + Pi.z);\n    vec3 p23 = permute(p2 + Pi.z + 1.0);\n\n    vec3 p31 = permute(p3 + Pi.z - 1.0);\n    vec3 p32 = permute(p3 + Pi.z);\n    vec3 p33 = permute(p3 + Pi.z + 1.0);\n\n    vec3 ox11 = fract(p11*K) - Ko;\n    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\n    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\n\n    vec3 ox12 = fract(p12*K) - Ko;\n    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\n    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\n\n    vec3 ox13 = fract(p13*K) - Ko;\n    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\n    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\n\n    vec3 ox21 = fract(p21*K) - Ko;\n    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\n    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\n\n    vec3 ox22 = fract(p22*K) - Ko;\n    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\n    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\n\n    vec3 ox23 = fract(p23*K) - Ko;\n    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\n    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\n\n    vec3 ox31 = fract(p31*K) - Ko;\n    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\n    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\n\n    vec3 ox32 = fract(p32*K) - Ko;\n    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\n    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\n\n    vec3 ox33 = fract(p33*K) - Ko;\n    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\n    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\n\n    vec3 dx11 = Pfx + jitter*ox11;\n    vec3 dy11 = Pfy.x + jitter*oy11;\n    vec3 dz11 = Pfz.x + jitter*oz11;\n\n    vec3 dx12 = Pfx + jitter*ox12;\n    vec3 dy12 = Pfy.x + jitter*oy12;\n    vec3 dz12 = Pfz.y + jitter*oz12;\n\n    vec3 dx13 = Pfx + jitter*ox13;\n    vec3 dy13 = Pfy.x + jitter*oy13;\n    vec3 dz13 = Pfz.z + jitter*oz13;\n\n    vec3 dx21 = Pfx + jitter*ox21;\n    vec3 dy21 = Pfy.y + jitter*oy21;\n    vec3 dz21 = Pfz.x + jitter*oz21;\n\n    vec3 dx22 = Pfx + jitter*ox22;\n    vec3 dy22 = Pfy.y + jitter*oy22;\n    vec3 dz22 = Pfz.y + jitter*oz22;\n\n    vec3 dx23 = Pfx + jitter*ox23;\n    vec3 dy23 = Pfy.y + jitter*oy23;\n    vec3 dz23 = Pfz.z + jitter*oz23;\n\n    vec3 dx31 = Pfx + jitter*ox31;\n    vec3 dy31 = Pfy.z + jitter*oy31;\n    vec3 dz31 = Pfz.x + jitter*oz31;\n\n    vec3 dx32 = Pfx + jitter*ox32;\n    vec3 dy32 = Pfy.z + jitter*oy32;\n    vec3 dz32 = Pfz.y + jitter*oz32;\n\n    vec3 dx33 = Pfx + jitter*ox33;\n    vec3 dy33 = Pfy.z + jitter*oy33;\n    vec3 dz33 = Pfz.z + jitter*oz33;\n\n    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\n    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\n    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\n    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\n    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\n    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\n    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\n    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\n    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\n\n    vec3 d1a = min(d11, d12);\n    d12 = max(d11, d12);\n    d11 = min(d1a, d13); // Smallest now not in d12 or d13\n    d13 = max(d1a, d13);\n    d12 = min(d12, d13); // 2nd smallest now not in d13\n    vec3 d2a = min(d21, d22);\n    d22 = max(d21, d22);\n    d21 = min(d2a, d23); // Smallest now not in d22 or d23\n    d23 = max(d2a, d23);\n    d22 = min(d22, d23); // 2nd smallest now not in d23\n    vec3 d3a = min(d31, d32);\n    d32 = max(d31, d32);\n    d31 = min(d3a, d33); // Smallest now not in d32 or d33\n    d33 = max(d3a, d33);\n    d32 = min(d32, d33); // 2nd smallest now not in d33\n    vec3 da = min(d11, d21);\n    d21 = max(d11, d21);\n    d11 = min(da, d31); // Smallest now in d11\n    d31 = max(da, d31); // 2nd smallest now not in d31\n    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\n    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\n    d12 = min(d12, d21); // 2nd smallest now not in d21\n    d12 = min(d12, d22); // nor in d22\n    d12 = min(d12, d31); // nor in d31\n    d12 = min(d12, d32); // nor in d32\n    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\n    d11.y = min(d11.y,d12.z); // Only two more to go\n    d11.y = min(d11.y,d11.z); // Done! (Phew!)\n    return sqrt(d11.xy); // F1, F2\n}\n\n","// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`vec2 ${i} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\n`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\n`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${i}.x;\n`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${i}.y;\n`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};\n`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}De([za("Use Manhattan Distance",Da.Boolean,"PROPERTIES",{notifiers:{update:!1}})],eh.prototype,"manhattanDistance",void 0),ue("BABYLON.WorleyNoise3DBlock",eh),ue("BABYLON.SimplexPerlin3DBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("seed",Ia.Vector3),this.registerOutput("output",Ia.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;let t="const float SKEWFACTOR = 1.0/3.0;\n";return t+="const float UNSKEWFACTOR = 1.0/6.0;\n",t+="const float SIMPLEX_CORNER_POS = 0.5;\n",t+="const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\n",t+="float SimplexPerlin3D( vec3 P ){\n",t+="    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\n",t+="    P *= SIMPLEX_TETRAHADRON_HEIGHT;\n",t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+="    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\n",t+="    vec3 g = step(x0.yzx, x0.xyz);\n",t+="    vec3 l = 1.0 - g;\n",t+="    vec3 Pi_1 = min( g.xyz, l.zxy );\n",t+="    vec3 Pi_2 = max( g.xyz, l.zxy );\n",t+="    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\n",t+="    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\n",t+="    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\n",t+="    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\n",t+="    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\n",t+="    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\n",t+="    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\n",t+="    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\n",t+="    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\n",t+="    Pt *= Pt;\n",t+="    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\n",t+="    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\n",t+="    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\n",t+="    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\n",t+="    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\n",t+="    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\n",t+="    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\n",t+="    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\n",t+="    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\n",t+="    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\n",t+="    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\n",t+="    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\n",t+="    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\n",t+="    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\n",t+="    kernel_weights = max(0.5 - kernel_weights, 0.0);\n",t+="    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\n",t+="    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\n",t+="}\n",e._emitFunction("SimplexPerlin3D","const float SKEWFACTOR = 1.0/3.0;\nconst float UNSKEWFACTOR = 1.0/6.0;\nconst float SIMPLEX_CORNER_POS = 0.5;\nconst float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\nfloat SimplexPerlin3D( vec3 P ){\n    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\n    P *= SIMPLEX_TETRAHADRON_HEIGHT;\n    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\n    vec3 g = step(x0.yzx, x0.xyz);\n    vec3 l = 1.0 - g;\n    vec3 Pi_1 = min( g.xyz, l.zxy );\n    vec3 Pi_2 = max( g.xyz, l.zxy );\n    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\n    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\n    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\n    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\n    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\n    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\n    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\n    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\n    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\n    Pt *= Pt;\n    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\n    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\n    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\n    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\n    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\n    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\n    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\n    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\n    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\n    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\n    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\n    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\n    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\n    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\n    kernel_weights = max(0.5 - kernel_weights, 0.0);\n    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\n    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\n}\n","// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = SimplexPerlin3D(${this.seed.associatedVariableName});\n`,this}}),ue("BABYLON.NormalBlendBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("normalMap0",Ia.AutoDetect),this.registerInput("normalMap1",Ia.AutoDetect),this.registerOutput("output",Ia.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Color4|Ia.Vector3|Ia.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Color4|Ia.Vector3|Ia.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],s=this._inputs[1],n=e._getFreeVariableName("stepR"),r=e._getFreeVariableName("stepG");return e.compilationString+=`float ${n} = step(0.5, ${i.associatedVariableName}.r);\n`,e.compilationString+=`float ${r} = step(0.5, ${i.associatedVariableName}.g);\n`,e.compilationString+=this._declareOutput(t,e)+";\n",e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${n}) * ${i.associatedVariableName}.r * ${s.associatedVariableName}.r * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${s.associatedVariableName}.r) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${r}) * ${i.associatedVariableName}.g * ${s.associatedVariableName}.g * 2.0 + ${r} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${s.associatedVariableName}.g) * 2.0);\n`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${s.associatedVariableName}.b;\n`,this}}),ue("BABYLON.Rotate2dBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("input",Ia.Vector2),this.registerInput("angle",Ia.Float),this.registerOutput("output",Ia.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new Ya("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.angle,s=this.input;return e.compilationString+=this._declareOutput(t,e)+` = vec2(cos(${i.associatedVariableName}) * ${s.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${s.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${s.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${s.associatedVariableName}.y);\n`,this}}),ue("BABYLON.ReflectBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("incident",Ia.AutoDetect),this.registerInput("normal",Ia.AutoDetect),this.registerOutput("output",Ia.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Vector3|Ia.Vector4|Ia.Color3|Ia.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(Ia.Vector3|Ia.Vector4|Ia.Color3|Ia.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\n`,this}}),ue("BABYLON.RefractBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("incident",Ia.AutoDetect),this.registerInput("normal",Ia.AutoDetect),this.registerInput("ior",Ia.Float),this.registerOutput("output",Ia.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Vector3|Ia.Vector4|Ia.Color3|Ia.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(Ia.Vector3|Ia.Vector4|Ia.Color3|Ia.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\n`,this}}),ue("BABYLON.DesaturateBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("color",Ia.Color3),this.registerInput("level",Ia.Float),this.registerOutput("output",Ia.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.color.associatedVariableName,s=e._getFreeVariableName("colorMin"),n=e._getFreeVariableName("colorMax"),r=e._getFreeVariableName("colorMerge");return e.compilationString+=`float ${s} = min(min(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`float ${n} = max(max(${i}.x, ${i}.y), ${i}.z);\n`,e.compilationString+=`float ${r} = 0.5 * (${s} + ${n});\n`,e.compilationString+=this._declareOutput(t,e)+` = mix(${i}, vec3(${r}, ${r}, ${r}), ${this.level.associatedVariableName});\n`,this}});class th extends ka{constructor(e){super(e,Pa.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",Ia.Float,!0,Pa.Fragment),this.registerInput("color",Ia.Color3,!0,Pa.Fragment),this.registerInput("roughness",Ia.Float,!0,Pa.Fragment),this.registerOutput("sheen",Ia.Object,Pa.Fragment,new Gl("sheen",this,Oa.Output,th,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e){let t="";return t=`#ifdef SHEEN\n            sheenOutParams sheenOut;\n\n            vec4 vSheenColor = vec4(${this.color.isConnected?this.color.associatedVariableName:"vec3(1.)"}, ${this.intensity.isConnected?this.intensity.associatedVariableName:"1."});\n\n            sheenBlock(\n                vSheenColor,\n            #ifdef SHEEN_ROUGHNESS\n                ${this.roughness.isConnected?this.roughness.associatedVariableName:"0."},\n            #endif\n                roughness,\n            #ifdef SHEEN_TEXTURE\n                vec4(0.),\n                1.0,\n            #endif\n                reflectance,\n            #ifdef SHEEN_LINKWITHALBEDO\n                baseColor,\n                surfaceAlbedo,\n            #endif\n            #ifdef ENVIRONMENTBRDF\n                NdotV,\n                environmentBrdf,\n            #endif\n            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\n                AARoughnessFactors,\n                ${null==e?void 0:e._vReflectionMicrosurfaceInfosName},\n                ${null==e?void 0:e._vReflectionInfosName},\n                ${null==e?void 0:e.reflectionColor},\n                vLightingIntensity,\n                #ifdef ${null==e?void 0:e._define3DName}\n                    ${null==e?void 0:e._cubeSamplerName},\n                #else\n                    ${null==e?void 0:e._2DSamplerName},\n                #endif\n                reflectionOut.reflectionCoords,\n                NdotVUnclamped,\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null==e?void 0:e._define3DName}\n                        ${null==e?void 0:e._cubeSamplerName},\n                        ${null==e?void 0:e._cubeSamplerName},\n                    #else\n                        ${null==e?void 0:e._2DSamplerName},\n                        ${null==e?void 0:e._2DSamplerName},\n                    #endif\n                #endif\n                #if !defined(${null==e?void 0:e._defineSkyboxName}) && defined(RADIANCEOCCLUSION)\n                    seo,\n                #endif\n                #if !defined(${null==e?void 0:e._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${null==e?void 0:e._define3DName})\n                    eho,\n                #endif\n            #endif\n                sheenOut\n            );\n\n            #ifdef SHEEN_LINKWITHALBEDO\n                surfaceAlbedo = sheenOut.surfaceAlbedo;\n            #endif\n        #endif\n`,t}_buildBlock(e){return e.target===Pa.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};\n`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};\n`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}De([za("Albedo scaling",Da.Boolean,"PROPERTIES",{notifiers:{update:!0}})],th.prototype,"albedoScaling",void 0),De([za("Link sheen with albedo",Da.Boolean,"PROPERTIES",{notifiers:{update:!0}})],th.prototype,"linkSheenWithAlbedo",void 0),ue("BABYLON.SheenBlock",th);class ih extends ka{constructor(e){super(e,Pa.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",Ia.Float,!0,Pa.Fragment),this.registerInput("direction",Ia.Vector2,!0,Pa.Fragment),this.registerInput("uv",Ia.Vector2,!0),this.registerInput("worldTangent",Ia.Vector4,!0),this.registerInput("TBN",Ia.Object,!0,Pa.VertexAndFragment,new Gl("TBN",this,Oa.Input,zl,"TBNBlock")),this.registerInput("roughness",Ia.Float,!0,Pa.Fragment),this.registerOutput("anisotropy",Ia.Object,Pa.Fragment,new Gl("anisotropy",this,Oa.Output,ih,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get roughness(){return this._inputs[5]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,s=this.uv,n=this.worldPositionConnectionPoint,r=this.worldNormalConnectionPoint,o=this.worldTangent;s.isConnected||p.Error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const a={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${l.associatedVariableName};\n            #endif\n            `:o.isConnected&&(t+=`vec3 tbnNormal = normalize(${r.associatedVariableName}.xyz);\n`,t+=`vec3 tbnTangent = normalize(${o.associatedVariableName}.xyz);\n`,t+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,t+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\n"),t+=`\n            #if defined(${o.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                mat3 TBN = vTBN;\n            #else\n                mat3 TBN = cotangent_frame(${r.associatedVariableName+".xyz"}, ${"v_"+n.associatedVariableName+".xyz"}, ${s.isConnected?s.associatedVariableName:"vec2(0.)"}, vec2(1., 1.));\n            #endif\n`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[a]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));const s=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0";return i+=`anisotropicOutParams anisotropicOut;\n            anisotropicBlock(\n                vec3(${this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)"}, ${s}),\n                ${this.roughness.isConnected?this.roughness.associatedVariableName:"0."},\n            #ifdef ANISOTROPIC_TEXTURE\n                vec3(0.),\n            #endif\n                TBN,\n                normalW,\n                viewDirectionW,\n                anisotropicOut\n            );\n`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0),i.setValue("ANISOTROPIC_LEGACY",!this.roughness.isConnected)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===Pa.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float")),this}}ue("BABYLON.AnisotropyBlock",ih);class sh extends Kl{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,p.Error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?Pa.Fragment:Pa.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",Ia.AutoDetect,!1,Pa.Vertex),this.registerInput("world",Ia.Matrix,!1,Pa.Vertex),this.registerInput("color",Ia.Color3,!0,Pa.Fragment),this.registerOutput("reflection",Ia.Object,Pa.Fragment,new Gl("reflection",this,Oa.Output,sh,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Vector3|Ia.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this._getTexture(),n=s&&s.getTextureMatrix;i.setValue("REFLECTION",n,!0),n&&(i.setValue(this._defineLODReflectionAlpha,s.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,s.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!s.invertZ:s.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",s.gammaSpace,!0),i.setValue("RGBDREFLECTION",s.isRGBD,!0),s&&s.coordinatesMode!==zi.SKYBOX_MODE&&s.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,s){super.bind(e,t,i);const n=this._getTexture();if(!n||!s)return;n.isCube?e.setTexture(this._cubeSamplerName,n):e.setTexture(this._2DSamplerName,n);const r=n.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,r,n.lodGenerationScale,n.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,r,ne.Log2(r));const o=s.materialDefines,a=n.sphericalPolynomial;if(o.USESPHERICALFROMREFLECTIONMAP&&a)if(o.SPHERICAL_HARMONICS){const t=a.preScaledHarmonics;e.setVector3("vSphericalL00",t.l00),e.setVector3("vSphericalL1_1",t.l1_1),e.setVector3("vSphericalL10",t.l10),e.setVector3("vSphericalL11",t.l11),e.setVector3("vSphericalL2_2",t.l2_2),e.setVector3("vSphericalL2_1",t.l2_1),e.setVector3("vSphericalL20",t.l20),e.setVector3("vSphericalL21",t.l21),e.setVector3("vSphericalL22",t.l22)}else e.setFloat3("vSphericalX",a.x.x,a.x.y,a.x.z),e.setFloat3("vSphericalY",a.y.x,a.y.y,a.y.z),e.setFloat3("vSphericalZ",a.z.x,a.z.y,a.z.z),e.setFloat3("vSphericalXX_ZZ",a.xx.x-a.zz.x,a.xx.y-a.zz.y,a.xx.z-a.zz.z),e.setFloat3("vSphericalYY_ZZ",a.yy.x-a.zz.x,a.yy.y-a.zz.y,a.yy.z-a.zz.z),e.setFloat3("vSphericalZZ",a.zz.x,a.zz.y,a.zz.z),e.setFloat3("vSphericalXY",a.xy.x,a.xy.y,a.xy.z),e.setFloat3("vSphericalYZ",a.yz.x,a.yz.y,a.yz.z),e.setFloat3("vSphericalZX",a.zx.x,a.zx.y,a.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const i=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\n                vec3 ${i} = vec3(${this._reflectionMatrixName} * vec4(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;\n                #ifdef ${this._defineOppositeZ}\n                    ${i}.z *= -1.0;\n                #endif\n                ${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${i});\n            #endif\n`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`\n            #ifdef ${this._define3DName}\n                #define sampleReflection(s, c) textureCube(s, c)\n            #else\n                #define sampleReflection(s, c) texture2D(s, c)\n            #endif\n`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`\n            #ifdef ${this._define3DName}\n                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)\n            #else\n                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)\n            #endif\n`,`//${this.name}`);const s=`\n            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {\n                ${this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0,!0)}\n                return ${this._reflectionVectorName};\n            }\n`;return e._emitFunction("computeReflectionCoordsPBR",s,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,"vec3"),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,"vec2"),i+=`#ifdef REFLECTION\n            vec2 ${this._vReflectionInfosName} = vec2(1., 0.);\n\n            reflectionOutParams reflectionOut;\n\n            reflectionBlock(\n                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName}.xyz,\n                ${t},\n                alphaG,\n                ${this._vReflectionMicrosurfaceInfosName},\n                ${this._vReflectionInfosName},\n                ${this.reflectionColor},\n            #ifdef ANISOTROPIC\n                anisotropicOut,\n            #endif\n            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})\n                NdotVUnclamped,\n            #endif\n            #ifdef ${this._defineLinearSpecularReflection}\n                roughness,\n            #endif\n            #ifdef ${this._define3DName}\n                ${this._cubeSamplerName},\n            #else\n                ${this._2DSamplerName},\n            #endif\n            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)\n                ${this._vEnvironmentIrradianceName},\n            #endif\n            #ifdef USESPHERICALFROMREFLECTIONMAP\n                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                    ${this._reflectionMatrixName},\n                #endif\n            #endif\n            #ifdef USEIRRADIANCEMAP\n                irradianceSampler, // ** not handled **\n            #endif\n            #ifndef LODBASEDMICROSFURACE\n                #ifdef ${this._define3DName}\n                    ${this._cubeSamplerName},\n                    ${this._cubeSamplerName},\n                #else\n                    ${this._2DSamplerName},\n                    ${this._2DSamplerName},\n                #endif\n            #endif\n            #ifdef REALTIME_FILTERING\n                ${this._vReflectionFilteringInfoName},\n            #endif\n                reflectionOut\n            );\n        #endif\n`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==Pa.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};\n`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};\n`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};\n`,e}serialize(){var e,t;const i=super.serialize();return i.useSphericalHarmonics=this.useSphericalHarmonics,i.forceIrradianceInFragment=this.forceIrradianceInFragment,i.gammaSpace=null===(t=null===(e=this.texture)||void 0===e?void 0:e.gammaSpace)||void 0===t||t,i}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}De([za("Spherical Harmonics",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],sh.prototype,"useSphericalHarmonics",void 0),De([za("Force irradiance in fragment",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],sh.prototype,"forceIrradianceInFragment",void 0),ue("BABYLON.ReflectionBlock",sh);class nh extends ka{constructor(e){super(e,Pa.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",Ia.Float,!1,Pa.Fragment),this.registerInput("roughness",Ia.Float,!0,Pa.Fragment),this.registerInput("indexOfRefraction",Ia.Float,!0,Pa.Fragment),this.registerInput("normalMapColor",Ia.Color3,!0,Pa.Fragment),this.registerInput("uv",Ia.Vector2,!0,Pa.Fragment),this.registerInput("tintColor",Ia.Color3,!0,Pa.Fragment),this.registerInput("tintAtDistance",Ia.Float,!0,Pa.Fragment),this.registerInput("tintThickness",Ia.Float,!0,Pa.Fragment),this.registerInput("worldTangent",Ia.Vector4,!0),this.registerInput("worldNormal",Ia.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(Ia.Color4|Ia.Vector4|Ia.Vector3),this.registerInput("TBN",Ia.Object,!0,Pa.VertexAndFragment,new Gl("TBN",this,Oa.Input,zl,"TBNBlock")),this.registerOutput("clearcoat",Ia.Object,Pa.Fragment,new Gl("clearcoat",this,Oa.Output,nh,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new Ya("ClearCoat intensity",Pa.Fragment,Ia.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",!this.indexOfRefraction.isConnected||this.indexOfRefraction.connectInputBlock.value===pn._DefaultIndexOfRefraction,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){var s,n;super.bind(e,t,i);const r=null!==(n=null===(s=this.indexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==n?n:pn._DefaultIndexOfRefraction,o=1-r,a=1+r,l=Math.pow(-o/a,2),h=1/r;e.setFloat4("vClearCoatRefractionParams",l,h,o,a);const c=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,d=(null==c?void 0:c.perturbedNormal.isConnected)?c.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",(null==d?void 0:d.invertX)?1:-1,(null==d?void 0:d.invertY)?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",(null==d?void 0:d.invertX)?-1:1,(null==d?void 0:d.invertY)?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let s="";const n=`//${this.name}`,r=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const o={search:/defined\(TANGENT\)/g,replace:r.isConnected?"defined(TANGENT)":"defined(IGNORE)"},a=this.TBN;return a.isConnected?e.compilationString+=`\n            #ifdef TBNBLOCK\n            mat3 vTBN = ${a.associatedVariableName};\n            #endif\n            `:r.isConnected&&(s+=`vec3 tbnNormal = normalize(${i}.xyz);\n`,s+=`vec3 tbnTangent = normalize(${r.associatedVariableName}.xyz);\n`,s+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};\n`,s+="mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\n"),e._emitFunctionFromInclude("bumpFragmentMainFunctions",n,{replaceStrings:[o]}),s}static GetCode(e,t,i,s,n,r,o){let a="";const l=(null==t?void 0:t.intensity.isConnected)?t.intensity.associatedVariableName:"1.",h=(null==t?void 0:t.roughness.isConnected)?t.roughness.associatedVariableName:"0.",c=(null==t?void 0:t.normalMapColor.isConnected)?t.normalMapColor.associatedVariableName:"vec3(0.)",d=(null==t?void 0:t.uv.isConnected)?t.uv.associatedVariableName:"vec2(0.)",u=(null==t?void 0:t.tintColor.isConnected)?t.tintColor.associatedVariableName:"vec3(1.)",_=(null==t?void 0:t.tintThickness.isConnected)?t.tintThickness.associatedVariableName:"1.",f=(null==t?void 0:t.tintAtDistance.isConnected)?t.tintAtDistance.associatedVariableName:"1.";if(t){e._emitUniformFromString("vClearCoatRefractionParams","vec4"),e._emitUniformFromString("vClearCoatTangentSpaceParams","vec2");const i=t.worldNormal;a+=`vec3 vGeometricNormaClearCoatW = ${i.isConnected?"normalize("+i.associatedVariableName+".xyz)":"geometricNormalW"};\n`}else a+="vec3 vGeometricNormaClearCoatW = geometricNormalW;\n";return n&&t&&(a+=t._generateTBNSpace(e,s,o),r=t.worldTangent.isConnected),a+=`clearcoatOutParams clearcoatOut;\n\n        #ifdef CLEARCOAT\n            vec2 vClearCoatParams = vec2(${l}, ${h});\n            vec4 vClearCoatTintParams = vec4(${u}, ${_});\n\n            clearcoatBlock(\n                ${s}.xyz,\n                vGeometricNormaClearCoatW,\n                viewDirectionW,\n                vClearCoatParams,\n                specularEnvironmentR0,\n            #ifdef CLEARCOAT_TEXTURE\n                vec2(0.),\n            #endif\n            #ifdef CLEARCOAT_TINT\n                vClearCoatTintParams,\n                ${f},\n                vClearCoatRefractionParams,\n                #ifdef CLEARCOAT_TINT_TEXTURE\n                    vec4(0.),\n                #endif\n            #endif\n            #ifdef CLEARCOAT_BUMP\n                vec2(0., 1.),\n                vec4(${c}, 0.),\n                ${d},\n                #if defined(${r?"TANGENT":"IGNORE"}) && defined(NORMAL)\n                    vTBN,\n                #else\n                    vClearCoatTangentSpaceParams,\n                #endif\n                #ifdef OBJECTSPACE_NORMALMAP\n                    normalMatrix,\n                #endif\n            #endif\n            #if defined(FORCENORMALFORWARD) && defined(NORMAL)\n                faceNormal,\n            #endif\n            #ifdef REFLECTION\n                ${null==i?void 0:i._vReflectionMicrosurfaceInfosName},\n                ${null==i?void 0:i._vReflectionInfosName},\n                ${null==i?void 0:i.reflectionColor},\n                vLightingIntensity,\n                #ifdef ${null==i?void 0:i._define3DName}\n                    ${null==i?void 0:i._cubeSamplerName},\n                #else\n                    ${null==i?void 0:i._2DSamplerName},\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null==i?void 0:i._define3DName}\n                        ${null==i?void 0:i._cubeSamplerName},\n                        ${null==i?void 0:i._cubeSamplerName},\n                    #else\n                        ${null==i?void 0:i._2DSamplerName},\n                        ${null==i?void 0:i._2DSamplerName},\n                    #endif\n                #endif\n            #endif\n            #if defined(ENVIRONMENTBRDF) && !defined(${null==i?void 0:i._defineSkyboxName})\n                #ifdef RADIANCEOCCLUSION\n                    ambientMonochrome,\n                #endif\n            #endif\n            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)\n                (gl_FrontFacing ? 1. : -1.),\n            #endif\n                clearcoatOut\n            );\n        #else\n            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;\n        #endif\n`,a}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===Pa.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,"float")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};\n`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.remapF0OnInterfaceChange=null===(s=e.remapF0OnInterfaceChange)||void 0===s||s}}De([za("Remap F0 on interface change",Da.Boolean,"ADVANCED")],nh.prototype,"remapF0OnInterfaceChange",void 0),ue("BABYLON.ClearCoatBlock",nh);class rh extends ka{constructor(e){super(e,Pa.Fragment),this._isUnique=!0,this.registerInput("intensity",Ia.Float,!0,Pa.Fragment),this.registerInput("indexOfRefraction",Ia.Float,!0,Pa.Fragment),this.registerInput("thickness",Ia.Float,!0,Pa.Fragment),this.registerOutput("iridescence",Ia.Object,Pa.Fragment,new Gl("iridescence",this,Oa.Output,rh,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new Ya("Iridescence intensity",Pa.Fragment,Ia.Float);e.value=1,e.output.connectTo(this.intensity);const t=new Ya("Iridescence ior",Pa.Fragment,Ia.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new Ya("Iridescence thickness",Pa.Fragment,Ia.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e){let t="";return t+=`iridescenceOutParams iridescenceOut;\n\n        #ifdef IRIDESCENCE\n            iridescenceBlock(\n                vec4(${(null==e?void 0:e.intensity.isConnected)?e.intensity.associatedVariableName:"1."}, ${(null==e?void 0:e.indexOfRefraction.isConnected)?e.indexOfRefraction.associatedVariableName:gn._DefaultIndexOfRefraction}, 1., ${(null==e?void 0:e.thickness.isConnected)?e.thickness.associatedVariableName:gn._DefaultMaximumThickness}),\n                NdotV,\n                specularEnvironmentR0,\n                #ifdef CLEARCOAT\n                    NdotVUnclamped,\n                #endif\n                iridescenceOut\n            );\n\n            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;\n            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;\n        #endif\n`,t}_buildBlock(e){return e.target===Pa.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}ue("BABYLON.IridescenceBlock",rh);class oh extends ka{constructor(e){super(e,Pa.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",Ia.Float,!1,Pa.Fragment),this.registerInput("tintAtDistance",Ia.Float,!0,Pa.Fragment),this.registerInput("volumeIndexOfRefraction",Ia.Float,!0,Pa.Fragment),this.registerOutput("refraction",Ia.Object,Pa.Fragment,new Gl("refraction",this,Oa.Output,oh,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e,t=(()=>!0)){if(!this.intensity.isConnected){const e=new Ya("Refraction intensity",Pa.Fragment,Ia.Float);e.value=1,e.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.View&&t(e)));i||(i=new Ya("view"),i.setAsSystemValue(Fa.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this._getTexture(),n=s&&s.getTextureMatrix;i.setValue("SS_REFRACTION",n,!0),n&&(i.setValue(this._define3DName,s.isCube,!0),i.setValue(this._defineLODRefractionAlpha,s.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,s.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem&&s.isCube?!s.invertZ:s.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",s.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",s.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!s.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){var s,n,r,o;super.bind(e,t,i);const a=this._getTexture();if(!a)return;a.isCube?e.setTexture(this._cubeSamplerName,a):e.setTexture(this._2DSamplerName,a),e.setMatrix(this._refractionMatrixName,a.getRefractionTextureMatrix());let l=1;a.isCube||a.depth&&(l=a.depth);const h=null!==(o=null!==(n=null===(s=this.volumeIndexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==n?n:null===(r=this.indexOfRefractionConnectionPoint.connectInputBlock)||void 0===r?void 0:r.value)&&void 0!==o?o:1.5;e.setFloat4(this._vRefractionInfosName,a.level,1/h,l,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,a.getSize().width,a.lodGenerationScale,a.lodGenerationOffset,1/h);const c=a.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,c,ne.Log2(c)),a.boundingBoxSize){const t=a;e.setVector3("vRefractionPosition",t.boundingBoxPosition),e.setVector3("vRefractionSize",t.boundingBoxSize)}}getCode(e){return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+=`#ifdef ${this._define3DName}\n`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\n`,e._samplerDeclaration+="#else\n",e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\n`,e._samplerDeclaration+="#endif\n",e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,"mat4"),e._emitFunction("sampleRefraction",`\n            #ifdef ${this._define3DName}\n                #define sampleRefraction(s, c) textureCube(s, c)\n            #else\n                #define sampleRefraction(s, c) texture2D(s, c)\n            #endif\n`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`\n            #ifdef ${this._define3DName}\n                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)\n            #else\n                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)\n            #endif\n`,`//${this.name}`),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,"vec4"),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,"vec4"),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,"vec2"),e._emitUniformFromString("vRefractionPosition","vec3"),e._emitUniformFromString("vRefractionSize","vec3"),""}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e=this.texture.isCube?`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");\n`:`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};\n`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};\n`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};\n`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=xr.Parse(e.texture,t,i):this.texture=zi.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}De([za("Link refraction to transparency",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],oh.prototype,"linkRefractionWithTransparency",void 0),De([za("Invert refraction Y",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],oh.prototype,"invertRefractionY",void 0),De([za("Use thickness as depth",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],oh.prototype,"useThicknessAsDepth",void 0),ue("BABYLON.RefractionBlock",oh);class ah extends ka{constructor(e){super(e,Pa.Fragment),this._isUnique=!0,this.registerInput("thickness",Ia.Float,!1,Pa.Fragment),this.registerInput("tintColor",Ia.Color3,!0,Pa.Fragment),this.registerInput("translucencyIntensity",Ia.Float,!0,Pa.Fragment),this.registerInput("translucencyDiffusionDist",Ia.Color3,!0,Pa.Fragment),this.registerInput("refraction",Ia.Object,!0,Pa.Fragment,new Gl("refraction",this,Oa.Input,oh,"RefractionBlock")),this.registerInput("dispersion",Ia.Float,!0,Pa.Fragment),this.registerOutput("subsurface",Ia.Object,Pa.Fragment,new Gl("subsurface",this,Oa.Output,ah,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vSubSurfaceIntensity"),e._excludeVariableName("dispersion")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get dispersion(){return this._inputs[5]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new Ya("SubSurface thickness",Pa.Fragment,Ia.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",s||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",s,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0),i.setValue("SS_DISPERSION",this.dispersion.isConnected,!0)}static GetCode(e,t,i,s){var n,r,o,a,l,h,c,d,u,_,f,p,m,g,v,T;let b="";const E=(null==t?void 0:t.thickness.isConnected)?t.thickness.associatedVariableName:"0.",S=(null==t?void 0:t.tintColor.isConnected)?t.tintColor.associatedVariableName:"vec3(1.)",x=(null==t?void 0:t.translucencyIntensity.isConnected)?null==t?void 0:t.translucencyIntensity.associatedVariableName:"1.",C=(null==t?void 0:t.translucencyDiffusionDist.isConnected)?null==t?void 0:t.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",y=(null==t?void 0:t.refraction.isConnected)?null===(n=null==t?void 0:t.refraction.connectedPoint)||void 0===n?void 0:n.ownerBlock:null,A=(null==y?void 0:y.tintAtDistance.isConnected)?y.tintAtDistance.associatedVariableName:"1.",R=(null==y?void 0:y.intensity.isConnected)?y.intensity.associatedVariableName:"1.",I=(null==y?void 0:y.view.isConnected)?y.view.associatedVariableName:"",P=(null==t?void 0:t.dispersion.isConnected)?null==t?void 0:t.dispersion.associatedVariableName:"0.0";return b+=null!==(r=null==y?void 0:y.getCode(e))&&void 0!==r?r:"",b+=`subSurfaceOutParams subSurfaceOut;\n\n        #ifdef SUBSURFACE\n            vec2 vThicknessParam = vec2(0., ${E});\n            vec4 vTintColor = vec4(${S}, ${A});\n            vec3 vSubSurfaceIntensity = vec3(${R}, ${x}, 0.);\n            float dispersion = ${P};\n            subSurfaceBlock(\n                vSubSurfaceIntensity,\n                vThicknessParam,\n                vTintColor,\n                normalW,\n                specularEnvironmentReflectance,\n            #ifdef SS_THICKNESSANDMASK_TEXTURE\n                vec4(0.),\n            #endif\n            #ifdef REFLECTION\n                #ifdef SS_TRANSLUCENCY\n                    ${null==i?void 0:i._reflectionMatrixName},\n                    #ifdef USESPHERICALFROMREFLECTIONMAP\n                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\n                            reflectionOut.irradianceVector,\n                        #endif\n                        #if defined(REALTIME_FILTERING)\n                            ${null==i?void 0:i._cubeSamplerName},\n                            ${null==i?void 0:i._vReflectionFilteringInfoName},\n                        #endif\n                        #endif\n                    #ifdef USEIRRADIANCEMAP\n                        irradianceSampler,\n                    #endif\n                #endif\n            #endif\n            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)\n                surfaceAlbedo,\n            #endif\n            #ifdef SS_REFRACTION\n                ${s}.xyz,\n                viewDirectionW,\n                ${I},\n                ${null!==(o=null==y?void 0:y._vRefractionInfosName)&&void 0!==o?o:""},\n                ${null!==(a=null==y?void 0:y._refractionMatrixName)&&void 0!==a?a:""},\n                ${null!==(l=null==y?void 0:y._vRefractionMicrosurfaceInfosName)&&void 0!==l?l:""},\n                vLightingIntensity,\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha,\n                #endif\n                #ifdef ${null!==(h=null==y?void 0:y._defineLODRefractionAlpha)&&void 0!==h?h:"IGNORE"}\n                    NdotVUnclamped,\n                #endif\n                #ifdef ${null!==(c=null==y?void 0:y._defineLinearSpecularRefraction)&&void 0!==c?c:"IGNORE"}\n                    roughness,\n                #endif\n                alphaG,\n                #ifdef ${null!==(d=null==y?void 0:y._define3DName)&&void 0!==d?d:"IGNORE"}\n                    ${null!==(u=null==y?void 0:y._cubeSamplerName)&&void 0!==u?u:""},\n                #else\n                    ${null!==(_=null==y?void 0:y._2DSamplerName)&&void 0!==_?_:""},\n                #endif\n                #ifndef LODBASEDMICROSFURACE\n                    #ifdef ${null!==(f=null==y?void 0:y._define3DName)&&void 0!==f?f:"IGNORE"}\n                        ${null!==(p=null==y?void 0:y._cubeSamplerName)&&void 0!==p?p:""},\n                        ${null!==(m=null==y?void 0:y._cubeSamplerName)&&void 0!==m?m:""},\n                    #else\n                        ${null!==(g=null==y?void 0:y._2DSamplerName)&&void 0!==g?g:""},\n                        ${null!==(v=null==y?void 0:y._2DSamplerName)&&void 0!==v?v:""},\n                    #endif\n                #endif\n                #ifdef ANISOTROPIC\n                    anisotropicOut,\n                #endif\n                #ifdef REALTIME_FILTERING\n                    ${null!==(T=null==y?void 0:y._vRefractionFilteringInfoName)&&void 0!==T?T:""},\n                #endif\n                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC\n                    vRefractionPosition,\n                    vRefractionSize,\n                #endif\n                #ifdef SS_DISPERSION\n                    dispersion,\n                #endif\n            #endif\n            #ifdef SS_TRANSLUCENCY\n                ${C},\n            #endif\n                subSurfaceOut\n            );\n\n            #ifdef SS_REFRACTION\n                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;\n                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY\n                    alpha = subSurfaceOut.alpha;\n                #endif\n            #endif\n        #else\n            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;\n        #endif\n`,b}_buildBlock(e){return e.target===Pa.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}ue("BABYLON.SubSurfaceBlock",ah);const lh={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["aggShadow",""],alpha:["alpha",""]};class hh extends ka{static _OnGenerateOnlyFragmentCodeChanged(e,t){const i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,p.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?Pa.Fragment:Pa.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?Pa.Fragment:Pa.Vertex}constructor(e){super(e,Pa.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=Re.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",Ia.Vector4,!1,Pa.Vertex),this.registerInput("worldNormal",Ia.Vector4,!1,Pa.Fragment),this.registerInput("view",Ia.Matrix,!1),this.registerInput("cameraPosition",Ia.Vector3,!1,Pa.Fragment),this.registerInput("perturbedNormal",Ia.Vector4,!0,Pa.Fragment),this.registerInput("baseColor",Ia.Color3,!0,Pa.Fragment),this.registerInput("metallic",Ia.Float,!1,Pa.Fragment),this.registerInput("roughness",Ia.Float,!1,Pa.Fragment),this.registerInput("ambientOcc",Ia.Float,!0,Pa.Fragment),this.registerInput("opacity",Ia.Float,!0,Pa.Fragment),this.registerInput("indexOfRefraction",Ia.Float,!0,Pa.Fragment),this.registerInput("ambientColor",Ia.Color3,!0,Pa.Fragment),this.registerInput("reflection",Ia.Object,!0,Pa.Fragment,new Gl("reflection",this,Oa.Input,sh,"ReflectionBlock")),this.registerInput("clearcoat",Ia.Object,!0,Pa.Fragment,new Gl("clearcoat",this,Oa.Input,nh,"ClearCoatBlock")),this.registerInput("sheen",Ia.Object,!0,Pa.Fragment,new Gl("sheen",this,Oa.Input,th,"SheenBlock")),this.registerInput("subsurface",Ia.Object,!0,Pa.Fragment,new Gl("subsurface",this,Oa.Input,ah,"SubSurfaceBlock")),this.registerInput("anisotropy",Ia.Object,!0,Pa.Fragment,new Gl("anisotropy",this,Oa.Input,ih,"AnisotropyBlock")),this.registerInput("iridescence",Ia.Object,!0,Pa.Fragment,new Gl("iridescence",this,Oa.Input,rh,"IridescenceBlock")),this.registerOutput("ambientClr",Ia.Color3,Pa.Fragment),this.registerOutput("diffuseDir",Ia.Color3,Pa.Fragment),this.registerOutput("specularDir",Ia.Color3,Pa.Fragment),this.registerOutput("clearcoatDir",Ia.Color3,Pa.Fragment),this.registerOutput("sheenDir",Ia.Color3,Pa.Fragment),this.registerOutput("diffuseInd",Ia.Color3,Pa.Fragment),this.registerOutput("specularInd",Ia.Color3,Pa.Fragment),this.registerOutput("clearcoatInd",Ia.Color3,Pa.Fragment),this.registerOutput("sheenInd",Ia.Color3,Pa.Fragment),this.registerOutput("refraction",Ia.Color3,Pa.Fragment),this.registerOutput("lighting",Ia.Color3,Pa.Fragment),this.registerOutput("shadow",Ia.Float,Pa.Fragment),this.registerOutput("alpha",Ia.Float,Pa.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e,t=(()=>!0)){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.CameraPosition&&t(e)));i||(i=new Ya("cameraPosition"),i.setAsSystemValue(Fa.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=e.getInputBlockByPredicate((e=>e.systemValue===Fa.View&&t(e)));i||(i=new Ya("view"),i.setAsSystemValue(Fa.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("DEBUGMODE_FORCERETURN",!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===An.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===An.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const s=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",s.indexOf(".")<0?s+".":s,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const n=e.getScene();if(n.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&Os.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),i._areLightsDirty)if(this.light){const t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};wi.PrepareDefinesForLight(n,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else wi.PrepareDefinesForLights(n,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,wi.PrepareDefinesForMultiview(n,i)}updateUniformsAndSamples(e,t,i,s){for(let n=0;n<t.maxSimultaneousLights&&i["LIGHT"+n];n++){const t=e.uniforms.indexOf("vLightData"+n)>=0;wi.PrepareUniformsAndSamplersForLight(n,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+n],s,t)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){var s,n;if(!i)return;const r=i.getScene();this.light?wi.BindLight(this.light,this._lightId,r,e,!0):wi.BindLights(r,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const o=this._scene.ambientColor;o&&e.setColor3("ambientFromScene",o);const a=r.useRightHandedSystem===(null!=r._mirroredCameraPosition);e.setFloat(this._invertNormalName,a?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const l=null!==(n=null===(s=this.indexOfRefraction.connectInputBlock)||void 0===s?void 0:s.value)&&void 0!==n?n:1.5,h=Math.pow((l-1)/(l+1),2);this._metallicReflectanceColor.scaleToRef(h*this._metallicF0Factor,Pe.Color3[0]);const c=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,Pe.Color3[0],c),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){var t,i;const s=this.worldPosition,n=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",n,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",n,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const r="v_"+s.associatedVariableName;e._emitVaryingFromString(r,"vec4")&&(e.compilationString+=`${r} = ${s.associatedVariableName};\n`);const o=this.reflection.isConnected?null===(t=this.reflection.connectedPoint)||void 0===t?void 0:t.ownerBlock:null;o&&(o.viewConnectionPoint=this.view),e.compilationString+=null!==(i=null==o?void 0:o.handleVertexSide(e))&&void 0!==i?i:"",e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+="#if DEBUGMODE > 0\n",e._injectAtEnd+="vClipSpacePosition = gl_Position;\n",e._injectAtEnd+="#endif\n"),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",n,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:s.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${s.associatedVariableName};\n`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\n`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",n,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(){let e="albedoOpacityOutParams albedoOpacityOut;\n";return e+=`albedoOpacityBlock(\n                vec4(${this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)"}, 1.),\n            #ifdef ALBEDO\n                vec4(1.),\n                vec2(1., 1.),\n            #endif\n            #ifdef OPACITY\n                vec4(${this.opacity.isConnected?this.opacity.associatedVariableName:"1."}),\n                vec2(1., 1.),\n            #endif\n                albedoOpacityOut\n            );\n\n            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;\n            float alpha = albedoOpacityOut.alpha;\n`,e}_getAmbientOcclusionCode(){let e="ambientOcclusionOutParams aoOut;\n";return e+=`ambientOcclusionBlock(\n            #ifdef AMBIENT\n                vec3(${this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1."}),\n                vec4(0., 1.0, 1.0, 0.),\n            #endif\n                aoOut\n            );\n`,e}_getReflectivityCode(e){let t="reflectivityOutParams reflectivityOut;\n";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),t+=`vec3 baseColor = surfaceAlbedo;\n\n            reflectivityBlock(\n                vec4(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.),\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo,\n                ${this._vMetallicReflectanceFactorsName},\n            #endif\n            #ifdef REFLECTIVITY\n                vec3(0., 0., 1.),\n                vec4(1.),\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor,\n            #endif\n            #ifdef MICROSURFACEMAP\n                microSurfaceTexel, <== not handled!\n            #endif\n                reflectivityOut\n            );\n\n            float microSurface = reflectivityOut.microSurface;\n            float roughness = reflectivityOut.roughness;\n\n            #ifdef METALLICWORKFLOW\n                surfaceAlbedo = reflectivityOut.surfaceAlbedo;\n            #endif\n            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\n                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;\n            #endif\n`,t}_buildBlock(e){var t,i,s,n,r,o,a,l,h,c,d,u,_,f,m,g,v,T,b,E,S,x,C,y,A,R,I,P,M,O,D,N,F,L,w,B,U,k,V,G,z;super._buildBlock(e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=$s(this._scene));const H=this.reflection.isConnected?null===(t=this.reflection.connectedPoint)||void 0===t?void 0:t.ownerBlock:null;if(H&&(H.worldPositionConnectionPoint=this.worldPosition,H.cameraPositionConnectionPoint=this.cameraPosition,H.worldNormalConnectionPoint=this.worldNormal,H.viewConnectionPoint=this.view),e.target!==Pa.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);const W=`//${this.name}`,X=this.perturbedNormal;let Q=this.worldPosition.associatedVariableName;this.generateOnlyFragmentCode?(Q=e._getFreeVariableName("globalWorldPos"),e._emitFunction("pbr_globalworldpos",`vec3 ${Q};\n`,W),e.compilationString+=`${Q} = ${this.worldPosition.associatedVariableName}.xyz;\n`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",W,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+="#if DEBUGMODE > 0\n",e.compilationString+="vec4 vClipSpacePosition = vec4((vec2(gl_FragCoord.xy) / vec2(1.0)) * 2.0 - 1.0, 0.0, 1.0);\n",e.compilationString+="#endif\n"):Q="v_"+Q,this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",W,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",W,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",W),e._emitFunctionFromInclude("importanceSampling",W),e._emitFunctionFromInclude("pbrHelperFunctions",W),e._emitFunctionFromInclude("imageProcessingDeclaration",W),e._emitFunctionFromInclude("imageProcessingFunctions",W),e._emitFunctionFromInclude("shadowsFragmentFunctions",W),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",W,{replaceStrings:[{search:/vPositionW/g,replace:Q+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",W),e._emitFunctionFromInclude("pbrBRDFFunctions",W,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(i=null==H?void 0:H._defineSkyboxName)&&void 0!==i?i:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",W),e._emitFunctionFromInclude("pbrDirectLightingFunctions",W,{replaceStrings:[{search:/vPositionW/g,replace:Q+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",W),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",W),e._emitFunctionFromInclude("pbrBlockReflectivity",W),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",W),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",W),e._emitFunctionFromInclude("pbrBlockAnisotropic",W),e._emitUniformFromString("vLightingIntensity","vec4"),(null==H?void 0:H.generateOnlyFragmentCode)&&(e.compilationString+=H.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`vec4 ${this._vNormalWName} = normalize(${this.worldNormal.associatedVariableName});\n`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${Q}.xyz);\n`),e.compilationString+=`vec3 geometricNormalW = ${this._vNormalWName}.xyz;\n`,e.compilationString+=`vec3 normalW = ${X.isConnected?"normalize("+X.associatedVariableName+".xyz)":"geometricNormalW"};\n`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",W,{replaceStrings:[{search:/vPositionW/g,replace:Q+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",W),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",W),e.compilationString+="#ifdef UNLIT\n                vec3 diffuseBase = vec3(1., 1., 1.);\n            #else\n",e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",W,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(s=null==H?void 0:H._defineSkyboxName)&&void 0!==s?s:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(n=null==H?void 0:H._define3DName)&&void 0!==n?n:"REFLECTIONMAP_3D"}]});const Y=this.anisotropy.isConnected?null===(r=this.anisotropy.connectedPoint)||void 0===r?void 0:r.ownerBlock:null;Y&&(Y.worldPositionConnectionPoint=this.worldPosition,Y.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=Y.getCode(e,!this.perturbedNormal.isConnected)),H&&H.hasTexture&&(e.compilationString+=H.getCode(e,Y?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",W,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(o=null==H?void 0:H._define3DName)&&void 0!==o?o:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(a=null==H?void 0:H._defineOppositeZ)&&void 0!==a?a:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(l=null==H?void 0:H._defineProjectionName)&&void 0!==l?l:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(h=null==H?void 0:H._defineSkyboxName)&&void 0!==h?h:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(c=null==H?void 0:H._defineLODReflectionAlpha)&&void 0!==c?c:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(d=null==H?void 0:H._defineLinearSpecularReflection)&&void 0!==d?d:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:null!==(u=null==H?void 0:H._vReflectionFilteringInfoName)&&void 0!==u?u:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",W,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});const K=this.sheen.isConnected?null===(_=this.sheen.connectedPoint)||void 0===_?void 0:_.ownerBlock:null;K&&(e.compilationString+=K.getCode(H)),e._emitFunctionFromInclude("pbrBlockSheen",W,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(f=null==H?void 0:H._define3DName)&&void 0!==f?f:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(m=null==H?void 0:H._defineSkyboxName)&&void 0!==m?m:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(g=null==H?void 0:H._defineLODReflectionAlpha)&&void 0!==g?g:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(v=null==H?void 0:H._defineLinearSpecularReflection)&&void 0!==v?v:"LINEARSPECULARREFLECTION"}]});const j=this.iridescence.isConnected?null===(T=this.iridescence.connectedPoint)||void 0===T?void 0:T.ownerBlock:null;e.compilationString+=rh.GetCode(j),e._emitFunctionFromInclude("pbrBlockIridescence",W,{replaceStrings:[]});const $=this.clearcoat.isConnected?null===(b=this.clearcoat.connectedPoint)||void 0===b?void 0:b.ownerBlock:null,q=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,Z=this.perturbedNormal.isConnected&&(null===(S=(null===(E=this.perturbedNormal.connectedPoint)||void 0===E?void 0:E.ownerBlock).worldTangent)||void 0===S?void 0:S.isConnected),J=this.anisotropy.isConnected&&(null===(x=this.anisotropy.connectedPoint)||void 0===x?void 0:x.ownerBlock).worldTangent.isConnected;let ee=Z||!this.perturbedNormal.isConnected&&J;e.compilationString+=nh.GetCode(e,$,H,Q,q,ee,this.worldNormal.associatedVariableName),q&&(ee=null!==(C=null==$?void 0:$.worldTangent.isConnected)&&void 0!==C&&C),e._emitFunctionFromInclude("pbrBlockClearcoat",W,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:null!==(y=null==H?void 0:H._define3DName)&&void 0!==y?y:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(A=null==H?void 0:H._defineOppositeZ)&&void 0!==A?A:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(R=null==H?void 0:H._defineProjectionName)&&void 0!==R?R:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(I=null==H?void 0:H._defineSkyboxName)&&void 0!==I?I:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:null!==(P=null==H?void 0:H._defineLODReflectionAlpha)&&void 0!==P?P:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:null!==(M=null==H?void 0:H._defineLinearSpecularReflection)&&void 0!==M?M:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:ee?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",W,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:null!==(O=null==H?void 0:H._defineSkyboxName)&&void 0!==O?O:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:null!==(D=null==H?void 0:H._define3DName)&&void 0!==D?D:"REFLECTIONMAP_3D"}]});const te=this.subsurface.isConnected?null===(N=this.subsurface.connectedPoint)||void 0===N?void 0:N.ownerBlock:null,ie=this.subsurface.isConnected?null===(L=(null===(F=this.subsurface.connectedPoint)||void 0===F?void 0:F.ownerBlock).refraction.connectedPoint)||void 0===L?void 0:L.ownerBlock:null;ie&&(ie.viewConnectionPoint=this.view,ie.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=ah.GetCode(e,te,H,Q),e._emitFunctionFromInclude("pbrBlockSubSurface",W,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:null!==(w=null==H?void 0:H._define3DName)&&void 0!==w?w:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:null!==(B=null==H?void 0:H._defineOppositeZ)&&void 0!==B?B:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:null!==(U=null==H?void 0:H._defineProjectionName)&&void 0!==U?U:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:null!==(k=null==ie?void 0:ie._define3DName)&&void 0!==k?k:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:null!==(V=null==ie?void 0:ie._defineLODRefractionAlpha)&&void 0!==V?V:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:null!==(G=null==ie?void 0:ie._defineLinearSpecularRefraction)&&void 0!==G?G:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:null!==(z=null==ie?void 0:ie._defineOppositeZ)&&void 0!==z?z:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",W),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",W,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/vPositionW/g,replace:Q+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",W,{repeatKey:"maxSimultaneousLights",substitutionVars:`vPositionW,${Q}.xyz`}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",W),e.compilationString+="#endif\n";const se=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)";let ne=An.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();-1===ne.indexOf(".")&&(ne+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",W,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:se+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:ne}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",W,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",W,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",W,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:Q},{search:/albedoTexture\.rgb;/g,replace:"vec3(1.);\ngl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\n"}]});for(const t of this._outputs)if(t.hasEndpoints){const i=lh[t.name];if(i){const[s,n]=i;n&&(e.compilationString+=`#if ${n}\n`),e.compilationString+=`${this._declareOutput(t,e)} = ${s};\n`,n&&(e.compilationString+="#else\n",e.compilationString+=`${this._declareOutput(t,e)} = vec3(0.);\n`,e.compilationString+="#endif\n")}else p.Error(`There's no remapping for the ${t.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};\n`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};\n`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};\n`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};\n`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\n`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\n`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\n`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};\n`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\n`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};\n`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};\n`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};\n`,e+=`${this._codeVariableName}.unlit = ${this.unlit};\n`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};\n`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};\n`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};\n`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};\n`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){var s,n;super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=null!==(s=e.lightFalloff)&&void 0!==s?s:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=null!==(n=e.realTimeFilteringQuality)&&void 0!==n?n:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}var ch,dh,uh;De([za("Direct lights",Da.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],hh.prototype,"directIntensity",void 0),De([za("Environment lights",Da.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],hh.prototype,"environmentIntensity",void 0),De([za("Specular highlights",Da.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],hh.prototype,"specularIntensity",void 0),De([za("Light falloff",Da.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:An.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:An.LIGHTFALLOFF_GLTF},{label:"Standard",value:An.LIGHTFALLOFF_STANDARD}]})],hh.prototype,"lightFalloff",void 0),De([za("Alpha Testing",Da.Boolean,"OPACITY")],hh.prototype,"useAlphaTest",void 0),De([za("Alpha CutOff",Da.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],hh.prototype,"alphaTestCutoff",void 0),De([za("Alpha blending",Da.Boolean,"OPACITY")],hh.prototype,"useAlphaBlending",void 0),De([za("Radiance over alpha",Da.Boolean,"RENDERING",{notifiers:{update:!0}})],hh.prototype,"useRadianceOverAlpha",void 0),De([za("Specular over alpha",Da.Boolean,"RENDERING",{notifiers:{update:!0}})],hh.prototype,"useSpecularOverAlpha",void 0),De([za("Specular anti-aliasing",Da.Boolean,"RENDERING",{notifiers:{update:!0}})],hh.prototype,"enableSpecularAntiAliasing",void 0),De([za("Realtime filtering",Da.Boolean,"RENDERING",{notifiers:{update:!0}})],hh.prototype,"realTimeFiltering",void 0),De([za("Realtime filtering quality",Da.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],hh.prototype,"realTimeFilteringQuality",void 0),De([za("Energy Conservation",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],hh.prototype,"useEnergyConservation",void 0),De([za("Radiance occlusion",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],hh.prototype,"useRadianceOcclusion",void 0),De([za("Horizon occlusion",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],hh.prototype,"useHorizonOcclusion",void 0),De([za("Unlit",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],hh.prototype,"unlit",void 0),De([za("Force normal forward",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],hh.prototype,"forceNormalForward",void 0),De([za("Generate only fragment code",Da.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:hh._OnGenerateOnlyFragmentCodeChanged}})],hh.prototype,"generateOnlyFragmentCode",void 0),De([za("Debug mode",Da.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],hh.prototype,"debugMode",void 0),De([za("Split position",Da.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],hh.prototype,"debugLimit",void 0),De([za("Output factor",Da.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],hh.prototype,"debugFactor",void 0),ue("BABYLON.PBRMetallicRoughnessBlock",hh),ue("BABYLON.ModBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("left",Ia.AutoDetect),this.registerInput("right",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[1].acceptedConnectionPointTypes.push(Ia.Float)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\n`,this}}),ue("BABYLON.MatrixBuilder",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("row0",Ia.Vector4),this.registerInput("row1",Ia.Vector4),this.registerInput("row2",Ia.Vector4),this.registerInput("row3",Ia.Vector4),this.registerOutput("output",Ia.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new Ya("row0");e.value=new ge(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new Ya("row1");e.value=new ge(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new Ya("row2");e.value=new ge(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new Ya("row3");e.value=new ge(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.row0,s=this.row1,n=this.row2,r=this.row3;return e.compilationString+=this._declareOutput(t,e)+` = mat4(${i.associatedVariableName}, ${s.associatedVariableName}, ${n.associatedVariableName}, ${r.associatedVariableName});\n`,this}}),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=1]="NotEqual",e[e.LessThan=2]="LessThan",e[e.GreaterThan=3]="GreaterThan",e[e.LessOrEqual=4]="LessOrEqual",e[e.GreaterOrEqual=5]="GreaterOrEqual",e[e.Xor=6]="Xor",e[e.Or=7]="Or",e[e.And=8]="And"}(ch||(ch={})),ue("BABYLON.ConditionalBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.condition=ch.LessThan,this.registerInput("a",Ia.Float),this.registerInput("b",Ia.Float),this.registerInput("true",Ia.AutoDetect,!0),this.registerInput("false",Ia.AutoDetect,!0),this.registerOutput("output",Ia.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=Ia.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",s=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case ch.Equal:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} == ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case ch.NotEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} != ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case ch.LessThan:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} < ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case ch.LessOrEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} <= ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case ch.GreaterThan:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} > ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case ch.GreaterOrEqual:e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} >= ${this.b.associatedVariableName} ? ${i} : ${s};\n`;break;case ch.Xor:e.compilationString+=this._declareOutput(t,e)+` = (mod(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 2.0) > 0.0) ? ${i} : ${s};\n`;break;case ch.Or:e.compilationString+=this._declareOutput(t,e)+` = (min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0) ? ${i} : ${s};\n`;break;case ch.And:e.compilationString+=this._declareOutput(t,e)+` = (${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)  ? ${i} : ${s};\n`}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${ch[this.condition]};\n`}});class _h extends ka{constructor(e){super(e,Pa.Neutral),this.octaves=6,this.registerInput("seed",Ia.AutoDetect),this.registerInput("chaos",Ia.AutoDetect,!0),this.registerInput("offsetX",Ia.Float,!0),this.registerInput("offsetY",Ia.Float,!0),this.registerInput("offsetZ",Ia.Float,!0),this.registerOutput("output",Ia.Float),this._inputs[0].acceptedConnectionPointTypes.push(Ia.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(Ia.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;if(super._buildBlock(e),!this.seed.isConnected)return;if(!this._outputs[0].hasEndpoints)return;const s=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode","\n\n        float cloudRandom(in float p) { p = fract(p * 0.011); p *= p + 7.5; p *= p + p; return fract(p); }\n\n        // Based on Morgan McGuire @morgan3d\n        // https://www.shadertoy.com/view/4dS3Wd\n        float cloudNoise(in vec2 x, in vec2 chaos) {\n            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);\n\n            vec2 i = floor(x);\n            vec2 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec2 u = f * f * (3.0 - 2.0 * f);\n            return mix(\n                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),\n                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),\n                    u.y\n                );\n        }\n\n        float cloudNoise(in vec3 x, in vec3 chaos) {\n            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);\n\n            vec3 i = floor(x);\n            vec3 f = fract(x);\n\n            float n = dot(i, step);\n\n            vec3 u = f * f * (3.0 - 2.0 * f);\n            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),\n                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),\n                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);\n        }","// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,"\n        float fbm(in vec2 st, in vec2 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = .5;\n            float frequency = 0.;\n\n            // Loop of octaves\n            for (int i = 0; i < OCTAVES; i++) {\n                value += amplitude * cloudNoise(st, chaos);\n                st *= 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }\n\n        float fbm(in vec3 x, in vec3 chaos) {\n            // Initial values\n            float value = 0.0;\n            float amplitude = 0.5;\n            for (int i = 0; i < OCTAVES; ++i) {\n                value += amplitude * cloudNoise(x, chaos);\n                x = x * 2.0;\n                amplitude *= 0.5;\n            }\n            return value;\n        }".replace(/fbm/gi,s).replace(/OCTAVES/gi,(0|this.octaves).toString()),"// CloudBlockCode FBM");const n=e._getFreeVariableName("st"),r=(null===(t=this.seed.connectedPoint)||void 0===t?void 0:t.type)===Ia.Vector2?"vec2":"vec3";e.compilationString+=`${r} ${n} = ${this.seed.associatedVariableName};\n`,this.offsetX.isConnected&&(e.compilationString+=`${n}.x += 0.1 * ${this.offsetX.associatedVariableName};\n`),this.offsetY.isConnected&&(e.compilationString+=`${n}.y += 0.1 * ${this.offsetY.associatedVariableName};\n`),this.offsetZ.isConnected&&"vec3"===r&&(e.compilationString+=`${n}.z += 0.1 * ${this.offsetZ.associatedVariableName};\n`);let o="";return o=this.chaos.isConnected?this.chaos.associatedVariableName:(null===(i=this.seed.connectedPoint)||void 0===i?void 0:i.type)===Ia.Vector2?"vec2(0., 0.)":"vec3(0., 0., 0.)",e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${s}(${n}, ${o});\n`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};\n`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}De([za("Octaves",Da.Int)],_h.prototype,"octaves",void 0),ue("BABYLON.CloudBlock",_h),ue("BABYLON.VoronoiNoiseBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("seed",Ia.Vector2),this.registerInput("offset",Ia.Float),this.registerInput("density",Ia.Float),this.registerOutput("output",Ia.Float),this.registerOutput("cells",Ia.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t="vec2 voronoiRandom(vec2 seed, float offset){\n            mat2 m = mat2(15.27, 47.63, 99.41, 89.98);\n            vec2 uv = fract(sin(m * seed) * 46839.32);\n            return vec2(sin(uv.y * offset) * 0.5 + 0.5, cos(uv.x * offset) * 0.5 + 0.5);\n        }\n        ";e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t="void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){\n            vec2 g = floor(seed * density);\n            vec2 f = fract(seed * density);\n            float t = 8.0;\n            vec3 res = vec3(8.0, 0.0, 0.0);\n\n            for(int y=-1; y<=1; y++)\n            {\n                for(int x=-1; x<=1; x++)\n                {\n                    vec2 lattice = vec2(x,y);\n                    vec2 randomOffset = voronoiRandom(lattice + g, offset);\n                    float d = distance(lattice + randomOffset, f);\n                    if(d < res.x)\n                    {\n                        res = vec3(d, randomOffset.x, randomOffset.y);\n                        outValue = res.x;\n                        cells = res.y;\n                    }\n                }\n            }\n        }\n        ",e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),s=e._getFreeVariableName("tempCells");return e.compilationString+=`float ${i} = 0.0;\n`,e.compilationString+=`float ${s} = 0.0;\n`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${i}, ${s});\n`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\n`),this.cells.hasEndpoints&&(e.compilationString+=this._declareOutput(this.cells,e)+` = ${s};\n`),this}}),ue("BABYLON.ElbowBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("input",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==Pa.VertexAndFragment)return t.target;if(e.connectedPoint.target!==Pa.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){0==(this._target&e)&&(this._target=e)}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${i.associatedVariableName};\n`,this}});class fh extends ka{get texture(){var e;return this.source.isConnected?(null===(e=this.source.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=null!==(t=null==e?void 0:e.getScene())&&void 0!==t?t:u.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this._texture))),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,(t=>t.hasTexture(e)))}get textureY(){var e;return this.sourceY.isConnected?(null===(e=this.sourceY.connectedPoint)||void 0===e?void 0:e.ownerBlock).texture:null}get textureZ(){var e,t;return(null===(e=this.sourceZ)||void 0===e?void 0:e.isConnected)?(null===(t=this.sourceY.connectedPoint)||void 0===t?void 0:t.ownerBlock).texture:null}_getImageSourceBlock(e){return(null==e?void 0:e.isConnected)?e.connectedPoint.ownerBlock:null}get samplerName(){const e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){var e,t;return null!==(t=null===(e=this._getImageSourceBlock(this.sourceY))||void 0===e?void 0:e.samplerName)&&void 0!==t?t:null}get samplerZName(){var e,t;return null!==(t=null===(e=this._getImageSourceBlock(this.sourceZ))||void 0===e?void 0:e.samplerName)&&void 0!==t?t:null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){var t;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const e=null!==(t=this.texture.getScene())&&void 0!==t?t:u.LastCreatedScene;null==e||e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const e=null!==(t=this.texture.getScene())&&void 0!==t?t:u.LastCreatedScene;null==e||e.markAllMaterialsAsDirty(1,(e=>e.hasTexture(this.texture)))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,Pa.Neutral),this.projectAsCube=!1,this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",Ia.AutoDetect,!1),this.registerInput("normal",Ia.AutoDetect,!1),this.registerInput("sharpness",Ia.Float,!0),this.registerInput("source",Ia.Object,!0,Pa.VertexAndFragment,new Gl("source",this,Oa.Input,Ql,"ImageSourceBlock")),this.registerInput("sourceY",Ia.Object,!0,Pa.VertexAndFragment,new Gl("sourceY",this,Oa.Input,Ql,"ImageSourceBlock")),t||this.registerInput("sourceZ",Ia.Object,!0,Pa.VertexAndFragment,new Gl("sourceZ",this,Oa.Input,Ql,"ImageSourceBlock")),this.registerOutput("rgba",Ia.Color4,Pa.Neutral),this.registerOutput("rgb",Ia.Color3,Pa.Neutral),this.registerOutput("r",Ia.Float,Pa.Neutral),this.registerOutput("g",Ia.Float,Pa.Neutral),this.registerOutput("b",Ia.Float,Pa.Neutral),this.registerOutput("a",Ia.Float,Pa.Neutral),this.registerOutput("level",Ia.Float,Pa.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Vector3|Ia.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(Ia.Color3|Ia.Vector3|Ia.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const s=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,n=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,s,!0),i.setValue(this._gammaDefineName,n,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_generateTextureLookup(e){var t,i;const s=this.samplerName,n=null!==(t=this.samplerYName)&&void 0!==t?t:s,r=null!==(i=this.samplerZName)&&void 0!==i?i:s,o=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",a=e._getFreeVariableName("x"),l=e._getFreeVariableName("y"),h=e._getFreeVariableName("z"),c=e._getFreeVariableName("w"),d=e._getFreeVariableName("n"),u=e._getFreeVariableName("uvx"),_=e._getFreeVariableName("uvy"),f=e._getFreeVariableName("uvz");e.compilationString+=`\n            vec3 ${d} = ${this.normal.associatedVariableName}.xyz;\n\n            vec2 ${u} = ${this.position.associatedVariableName}.yz;\n            vec2 ${_} = ${this.position.associatedVariableName}.zx;\n            vec2 ${f} = ${this.position.associatedVariableName}.xy;\n        `,this.projectAsCube&&(e.compilationString+=`\n                ${u}.xy = ${u}.yx;\n\n                if (${d}.x >= 0.0) {\n                    ${u}.x = -${u}.x;\n                }\n                if (${d}.y < 0.0) {\n                    ${_}.y = -${_}.y;\n                }\n                if (${d}.z < 0.0) {\n                    ${f}.x = -${f}.x;\n                }\n            `),e.compilationString+=`\n            vec4 ${a} = texture2D(${s}, ${u});\n            vec4 ${l} = texture2D(${n}, ${_});\n            vec4 ${h} = texture2D(${r}, ${f});\n           \n            // blend weights\n            vec3 ${c} = pow(abs(${d}), vec3(${o}));\n\n            // blend and return\n            vec4 ${this._tempTextureRead} = (${a}*${c}.x + ${l}*${c}.y + ${h}*${c}.z) / (${c}.x + ${c}.y + ${c}.z);        \n        `}_generateConversionCode(e,t,i){"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}\n                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\n                    #endif\n                `),e.compilationString+=`#ifdef ${this._gammaDefineName}\n                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\n                #endif\n            `)}_writeOutput(e,t,i){let s="";this.disableLevelMultiplication||(s=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${s};\n`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,"float"),this._generateTextureLookup(e);for(const t of this._outputs)t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\n`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\n`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\n`,e+=`${this._codeVariableName}.projectAsCube = ${this.projectAsCube};\n`,this.texture?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\n`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\n`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\n`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\n`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\n`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\n`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\n`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\n`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\n`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\n`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\n`,e):e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,e.projectAsCube=this.projectAsCube,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,this.projectAsCube=!!e.projectAsCube,e.texture&&!vl.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=zi.Parse(e.texture,t,i))}}De([za("Project as cube",Da.Boolean,"ADVANCED",{notifiers:{update:!0}})],fh.prototype,"projectAsCube",void 0),ue("BABYLON.TriPlanarBlock",fh),ue("BABYLON.BiPlanarBlock",class extends fh{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_generateTextureLookup(e){var t;const i=this.samplerName,s=null!==(t=this.samplerYName)&&void 0!==t?t:this.samplerName,n=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",r=e._getFreeVariableName("dpdx"),o=e._getFreeVariableName("dpdy"),a=e._getFreeVariableName("n"),l=e._getFreeVariableName("ma"),h=e._getFreeVariableName("mi"),c=e._getFreeVariableName("me"),d=e._getFreeVariableName("x"),u=e._getFreeVariableName("y"),_=e._getFreeVariableName("y");e.compilationString+=`\n            // grab coord derivatives for texturing\n            vec3 ${r} = dFdx(${this.position.associatedVariableName}.xyz);\n            vec3 ${o} = dFdy(${this.position.associatedVariableName}.xyz);\n            vec3 ${a} = abs(${this.normal.associatedVariableName}.xyz);\n        \n            // determine major axis (in x; yz are following axis)\n            ivec3 ${l} = (${a}.x>${a}.y && ${a}.x>${a}.z) ? ivec3(0,1,2) :\n                    (${a}.y>${a}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine minor axis (in x; yz are following axis)\n            ivec3 ${h} = (${a}.x<${a}.y && ${a}.x<${a}.z) ? ivec3(0,1,2) :\n                    (${a}.y<${a}.z)            ? ivec3(1,2,0) :\n                                            ivec3(2,0,1) ;\n            // determine median axis (in x;  yz are following axis)\n            ivec3 ${c} = ivec3(3) - ${h} - ${l};\n            \n            // project+fetch\n            vec4 ${d} = textureGrad( ${i}, vec2(   ${this.position.associatedVariableName}[${l}.y],   ${this.position.associatedVariableName}[${l}.z]), \n                                    vec2(${r}[${l}.y],${r}[${l}.z]), \n                                    vec2(${o}[${l}.y],${o}[${l}.z]) );\n            vec4 ${u} = textureGrad( ${s}, vec2(   ${this.position.associatedVariableName}[${c}.y],   ${this.position.associatedVariableName}[${c}.z]), \n                                    vec2(${r}[${c}.y],${r}[${c}.z]),\n                                    vec2(${o}[${c}.y],${o}[${c}.z]) );\n            \n            // blend factors\n            vec2 ${_} = vec2(${a}[${l}.x],${a}[${c}.x]);\n            // make local support\n            ${_} = clamp( (${_}-0.5773)/(1.0-0.5773), 0.0, 1.0 );\n            // shape transition\n            ${_} = pow( ${_}, vec2(${n}/8.0) );\n            // blend and return\n            vec4 ${this._tempTextureRead} = (${d}*${_}.x + ${u}*${_}.y) / (${_}.x + ${_}.y);\n        `}}),ue("BABYLON.MatrixDeterminantBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("input",Ia.Matrix),this.registerOutput("output",Ia.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = determinant(${i.associatedVariableName});\n`,this}}),ue("BABYLON.MatrixTransposeBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.registerInput("input",Ia.Matrix),this.registerOutput("output",Ia.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this.output,i=this.input;return e.compilationString+=this._declareOutput(t,e)+`${t.associatedVariableName} = transpose(${i.associatedVariableName});\n`,this}}),function(e){e[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Tangent=2]="Tangent",e[e.VertexColor=3]="VertexColor",e[e.UV1=4]="UV1",e[e.UV2=5]="UV2",e[e.UV3=6]="UV3",e[e.UV4=7]="UV4",e[e.UV5=8]="UV5",e[e.UV6=9]="UV6"}(dh||(dh={}));class ph extends ka{constructor(e){super(e,Pa.Neutral),this.attributeType=dh.None,this.registerInput("input",Ia.AutoDetect),this.registerInput("fallback",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].onConnectionObservable.add((e=>{var t;if(this.attributeType)return;const i=e.ownerBlock;if(i instanceof Ya&&i.isAttribute)switch(i.name){case"color":this.attributeType=dh.VertexColor;break;case"normal":this.attributeType=dh.Normal;break;case"tangent":this.attributeType=dh.Tangent;break;case"uv":this.attributeType=dh.UV1;break;case"uv2":this.attributeType=dh.UV2;break;case"uv3":this.attributeType=dh.UV3;break;case"uv4":this.attributeType=dh.UV4;break;case"uv5":this.attributeType=dh.UV5;break;case"uv6":this.attributeType=dh.UV6}else if(i instanceof Bl)switch(null===(t=this.input.connectedPoint)||void 0===t?void 0:t.name){case"normalOutput":this.attributeType=dh.Normal;break;case"tangentOutput":this.attributeType=dh.Tangent;break;case"uvOutput":this.attributeType=dh.UV1}}))}getClassName(){return"MeshAttributeExistsBlock"}get input(){return this._inputs[0]}get fallback(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.attributeType){case dh.VertexColor:t="VERTEXCOLOR_NME";break;case dh.Normal:t="NORMAL";break;case dh.Tangent:t="TANGENT";break;case dh.UV1:t="UV1";break;case dh.UV2:t="UV2";break;case dh.UV3:t="UV3";break;case dh.UV4:t="UV4";break;case dh.UV5:t="UV5";break;case dh.UV6:t="UV6"}const i=this._declareOutput(this.output,e);return t&&(e.compilationString+=`#ifdef ${t}\n`),e.compilationString+=`${i} = ${this.input.associatedVariableName};\n`,t&&(e.compilationString+="#else\n",e.compilationString+=`${i} = ${this.fallback.associatedVariableName};\n`,e.compilationString+="#endif\n"),this}serialize(){const e=super.serialize();return e.attributeType=this.attributeType,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.attributeType=null!==(s=e.attributeType)&&void 0!==s?s:dh.None}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.attributeType = ${this.attributeType};\n`,e}}De([za("Attribute lookup",Da.List,void 0,{notifiers:{update:!0},options:[{label:"(None)",value:dh.None},{label:"Normal",value:dh.Normal},{label:"Tangent",value:dh.Tangent},{label:"Vertex Color",value:dh.VertexColor},{label:"UV1",value:dh.UV1},{label:"UV2",value:dh.UV2},{label:"UV3",value:dh.UV3},{label:"UV4",value:dh.UV4},{label:"UV5",value:dh.UV5},{label:"UV6",value:dh.UV6}]})],ph.prototype,"attributeType",void 0),ue("BABYLON.MeshAttributeExistsBlock",ph),function(e){e[e.EaseInSine=0]="EaseInSine",e[e.EaseOutSine=1]="EaseOutSine",e[e.EaseInOutSine=2]="EaseInOutSine",e[e.EaseInQuad=3]="EaseInQuad",e[e.EaseOutQuad=4]="EaseOutQuad",e[e.EaseInOutQuad=5]="EaseInOutQuad",e[e.EaseInCubic=6]="EaseInCubic",e[e.EaseOutCubic=7]="EaseOutCubic",e[e.EaseInOutCubic=8]="EaseInOutCubic",e[e.EaseInQuart=9]="EaseInQuart",e[e.EaseOutQuart=10]="EaseOutQuart",e[e.EaseInOutQuart=11]="EaseInOutQuart",e[e.EaseInQuint=12]="EaseInQuint",e[e.EaseOutQuint=13]="EaseOutQuint",e[e.EaseInOutQuint=14]="EaseInOutQuint",e[e.EaseInExpo=15]="EaseInExpo",e[e.EaseOutExpo=16]="EaseOutExpo",e[e.EaseInOutExpo=17]="EaseInOutExpo",e[e.EaseInCirc=18]="EaseInCirc",e[e.EaseOutCirc=19]="EaseOutCirc",e[e.EaseInOutCirc=20]="EaseInOutCirc",e[e.EaseInBack=21]="EaseInBack",e[e.EaseOutBack=22]="EaseOutBack",e[e.EaseInOutBack=23]="EaseInOutBack",e[e.EaseInElastic=24]="EaseInElastic",e[e.EaseOutElastic=25]="EaseOutElastic",e[e.EaseInOutElastic=26]="EaseInOutElastic"}(uh||(uh={})),ue("BABYLON.CurveBlock",class extends ka{constructor(e){super(e,Pa.Neutral),this.type=uh.EaseInOutSine,this.registerInput("input",Ia.AutoDetect),this.registerOutput("output",Ia.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(Ia.Matrix),this._inputs[0].excludedConnectionPointTypes.push(Ia.Object),this._inputs[0].excludedConnectionPointTypes.push(Ia.Int)}getClassName(){return"CurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_duplicateEntry(e,t){return`ret.${t} = ${e.replace(/VAL/g,"v."+t)}`}_duplicateEntryDirect(e){return`return ${e.replace(/VAL/g,"v")}`}_duplicateVector(e,t){if("float"===t)return this._duplicateEntryDirect(e);const i=parseInt(t.replace("vec",""));let s=`\n            vec${i} ret = vec${i}(0.0);\n        `;for(let t=1;t<=i;t++)s+=this._duplicateEntry(e,1===t?"x":2===t?"y":3===t?"z":"w")+";\n";return s+="return ret;\n",s}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="",s="",n="";switch(this.input.type){case Ia.Float:n="float";break;case Ia.Vector2:n="vec2";break;case Ia.Vector3:case Ia.Color3:n="vec3";break;case Ia.Vector4:case Ia.Color4:n="vec4"}switch(s=uh[this.type]+"_"+n,this.type){case uh.EaseInSine:i="return 1.0 - cos((v * 3.1415) / 2.0)";break;case uh.EaseOutSine:i="return sin((v * 3.1415) / 2.0)";break;case uh.EaseInOutSine:i="return -(cos(v * 3.1415) - 1.0) / 2.0";break;case uh.EaseInQuad:i="return v * v";break;case uh.EaseOutQuad:i="return (1.0 - v) * (1.0 - v)";break;case uh.EaseInOutQuad:{const e="VAL < 0.5 ? 2.0 * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 2.0) / 2.0";i=this._duplicateVector(e,n);break}case uh.EaseInCubic:i="return v * v * v";break;case uh.EaseOutCubic:{const e="1.0 - pow(1.0 - VAL, 3.0)";i=this._duplicateVector(e,n);break}case uh.EaseInOutCubic:{const e="VAL < 0.5 ? 4.0 * VAL * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 3.0) / 2.0";i=this._duplicateVector(e,n);break}case uh.EaseInQuart:i="return v * v * v * v";break;case uh.EaseOutQuart:{const e="1.0 - pow(1.0 - VAL, 4.0)";i=this._duplicateVector(e,n);break}case uh.EaseInOutQuart:{const e="VAL < 0.5 ? 8.0 * VAL * VAL * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 4.0) / 2.0";i=this._duplicateVector(e,n);break}case uh.EaseInQuint:i="return v * v * v * v * v";break;case uh.EaseOutQuint:{const e="1.0 - pow(1.0 - VAL, 5.0)";i=this._duplicateVector(e,n);break}case uh.EaseInOutQuint:{const e="VAL < 0.5 ? 16.0 * VAL * VAL * VAL * VAL * VAL : 1.0 - pow(-2.0 * VAL + 2.0, 5.0) / 2.0";i=this._duplicateVector(e,n);break}case uh.EaseInExpo:{const e="VAL == 0.0 ? 0.0 : pow(2.0, 10.0 * VAL - 10.0)";i=this._duplicateVector(e,n);break}case uh.EaseOutExpo:{const e="VAL == 1.0 ? 1.0 : 1.0 - pow(2.0, -10.0 * VAL)";i=this._duplicateVector(e,n);break}case uh.EaseInOutExpo:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : VAL < 0.5 ? pow(2.0, 20.0 * VAL - 10.0) / 2.0 : (2.0 - pow(2.0, -20.0 * VAL + 10.0)) / 2.0";i=this._duplicateVector(e,n);break}case uh.EaseInCirc:{const e="1.0 - sqrt(1.0 - pow(VAL, 2.0))";i=this._duplicateVector(e,n);break}case uh.EaseOutCirc:{const e="sqrt(1.0 - pow(VAL - 1.0, 2.0))";i=this._duplicateVector(e,n);break}case uh.EaseInOutCirc:{const e="VAL < 0.5 ? (1.0 - sqrt(1.0 - pow(2.0 * VAL, 2.0))) / 2.0 : (sqrt(1.0 - pow(-2.0 * VAL + 2.0, 2.0)) + 1.0) / 2.0";i=this._duplicateVector(e,n);break}case uh.EaseInBack:i="return 2.70158 * v * v * v - 1.70158 * v * v";break;case uh.EaseOutBack:{const e="2.70158 * pow(VAL - 1.0, 3.0) + 1.70158 * pow(VAL - 1.0, 2.0)";i=this._duplicateVector(e,n);break}case uh.EaseInOutBack:{const e="VAL < 0.5 ? (pow(2.0 * VAL, 2.0) * ((3.5949095) * 2.0 * VAL - 2.5949095)) / 2.0 : (pow(2.0 * VAL - 2.0, 2.0) * (3.5949095 * (VAL * 2.0 - 2.0) + 3.5949095) + 2.0) / 2.0";i=this._duplicateVector(e,n);break}case uh.EaseInElastic:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : -pow(2.0, 10.0 * VAL - 10.0) * sin((VAL * 10.0 - 10.75) * ((2.0 * 3.1415) / 3.0))";i=this._duplicateVector(e,n);break}case uh.EaseOutElastic:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : pow(2.0, -10.0 * VAL) * sin((VAL * 10.0 - 0.75) * ((2.0 * 3.1415) / 3.0)) + 1.0";i=this._duplicateVector(e,n);break}case uh.EaseInOutElastic:{const e="VAL == 0.0 ? 0.0 : VAL == 1.0 ? 1.0 : VAL < 0.5 ? -(pow(2.0, 20.0 * VAL - 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 : (pow(2.0, -20.0 * VAL + 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 + 1.0";i=this._duplicateVector(e,n);break}}return e._emitFunction(s,`${n} ${s}(${n} v) {${i};}\n`,""),e.compilationString+=this._declareOutput(t,e)+` = ${s}(${this.input.associatedVariableName});\n`,this}serialize(){const e=super.serialize();return e.curveType=this.type,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.CurveBlockTypes.${uh[this.type]};\n`}});class mh{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===t||0===e)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new s,this._onDataLayoutChanged=new s,this._animationPropertiesOverride=null,this._scene=i||u.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=qe.Clone((()=>new mh(this.name,this.influence,this._scene)),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),qe.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new mh(e.name,e.influence);if(i.setPositions(e.positions),null!=e.id&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let t=0;t<e.animations.length;t++){const s=e.animations[t],n=_e("BABYLON.Animation");n&&i.animations.push(n.Parse(s))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const s=new mh(t,i,e.getScene());return s.setPositions(e.getVerticesData(Oe.PositionKind)),e.isVerticesDataPresent(Oe.NormalKind)&&s.setNormals(e.getVerticesData(Oe.NormalKind)),e.isVerticesDataPresent(Oe.TangentKind)&&s.setTangents(e.getVerticesData(Oe.TangentKind)),e.isVerticesDataPresent(Oe.UVKind)&&s.setUVs(e.getVerticesData(Oe.UVKind)),s}}function gh(e,t,i,s){let n,r=1;1===s?n=new Float32Array(t*i*4):2===s?(n=new Uint16Array(t*i*4),r=15360):n=7===s?new Uint32Array(t*i*4):new Uint8Array(t*i*4);for(let s=0;s<t;s++)for(let o=0;o<i;o++){const i=3*(o*t+s),a=4*(o*t+s);n[a+0]=e[i+0],n[a+1]=e[i+1],n[a+2]=e[i+2],n[a+3]=r}return n}function vh(e){return function(t,i,s,n,o,l,h,c,d=null,u=0){const _=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,f=e?r.Raw3D:r.Raw2DArray,p=new a(this,f);p.baseWidth=i,p.baseHeight=s,p.baseDepth=n,p.width=i,p.height=s,p.depth=n,p.format=o,p.type=u,p.generateMipMaps=l,p.samplingMode=c,e?p.is3D=!0:p.is2DArray=!0,this._doNotHandleContextLost||(p._bufferView=t),e?this.updateRawTexture3D(p,t,o,h,d,u):this.updateRawTexture2DArray(p,t,o,h,d,u),this._bindTextureDirectly(_,p,!0);const m=this._getSamplingParameters(c,l);return this._gl.texParameteri(_,this._gl.TEXTURE_MAG_FILTER,m.mag),this._gl.texParameteri(_,this._gl.TEXTURE_MIN_FILTER,m.min),l&&this._gl.generateMipmap(_),this._bindTextureDirectly(_,null),this._internalTexturesCache.push(p),p}}function Th(e){return function(t,i,s,n,r=null,o=0){const a=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(o),h=this._getInternalFormat(s),c=this._getRGBABufferInternalSizedFormat(o,s);this._bindTextureDirectly(a,t,!0),this._unpackFlipY(void 0===n||!!n),this._doNotHandleContextLost||(t._bufferView=i,t.format=s,t.invertY=n,t._compression=r),t.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&i?this._gl.compressedTexImage3D(a,0,this.getCaps().s3tc[r],t.width,t.height,t.depth,0,i):this._gl.texImage3D(a,0,c,t.width,t.height,t.depth,0,h,l,i),t.generateMipMaps&&this._gl.generateMipmap(a),this._bindTextureDirectly(a,null),t.isReady=!0}}De([Ge()],mh.prototype,"id",void 0),q.prototype.updateRawTexture=function(e,t,i,s,n=null,r=0,o=!1){if(!e)return;const a=this._getRGBABufferInternalSizedFormat(r,i,o),l=this._getInternalFormat(i),h=this._getWebGLTextureType(r);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===s||!!s),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.type=r,e.invertY=s,e._compression=n),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&t?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],e.width,e.height,0,t):this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,e.width,e.height,0,l,h,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0},q.prototype.createRawTexture=function(e,t,i,s,n,o,l,h=null,c=0,d=0,u=!1){const _=new a(this,r.Raw);_.baseWidth=t,_.baseHeight=i,_.width=t,_.height=i,_.format=s,_.generateMipMaps=n,_.samplingMode=l,_.invertY=o,_._compression=h,_.type=c,_._useSRGBBuffer=this._getUseSRGBBuffer(u,!n),this._doNotHandleContextLost||(_._bufferView=e),this.updateRawTexture(_,e,s,o,h,c,_._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,_,!0);const f=this._getSamplingParameters(l,n);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,f.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,f.min),n&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(_),_},q.prototype.createRawCubeTexture=function(e,t,i,s,n,o,l,h=null){const c=this._gl,d=new a(this,r.CubeRaw);d.isCube=!0,d.format=i,d.type=s,this._doNotHandleContextLost||(d._bufferViewArray=e);const u=this._getWebGLTextureType(s);let _=this._getInternalFormat(i);_===c.RGB&&(_=c.RGBA),u!==c.FLOAT||this._caps.textureFloatLinearFiltering?u!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?u!==c.FLOAT||this._caps.textureFloatRender?u!==c.HALF_FLOAT||this._caps.colorBufferFloat||(n=!1,p.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(n=!1,p.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(n=!1,l=1,p.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(n=!1,l=1,p.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));const f=t,m=f;if(d.width=f,d.height=m,d.invertY=o,d._compression=h,!this.needPOTTextures||Ot.IsExponentOfTwo(d.width)&&Ot.IsExponentOfTwo(d.height)||(n=!1),e)this.updateRawCubeTexture(d,e,i,s,o,h);else{const e=this._getRGBABufferInternalSizedFormat(s),t=0;this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,d,!0);for(let i=0;i<6;i++)h?c.compressedTexImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,this.getCaps().s3tc[h],d.width,d.height,0,void 0):c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+i,t,e,d.width,d.height,0,_,u,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,d,!0),e&&n&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const g=this._getSamplingParameters(l,n);return c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MAG_FILTER,g.mag),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_MIN_FILTER,g.min),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_CUBE_MAP,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,null),d.generateMipMaps=n,d.samplingMode=l,d.isReady=!0,d},q.prototype.updateRawCubeTexture=function(e,t,i,s,n,r=null,o=0){e._bufferViewArray=t,e.format=i,e.type=s,e.invertY=n,e._compression=r;const a=this._gl,l=this._getWebGLTextureType(s);let h=this._getInternalFormat(i);const c=this._getRGBABufferInternalSizedFormat(s);let d=!1;h===a.RGB&&(h=a.RGBA,d=!0),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(void 0===n||!!n),e.width%4!=0&&a.pixelStorei(a.UNPACK_ALIGNMENT,1);for(let i=0;i<6;i++){let n=t[i];r?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+i,o,this.getCaps().s3tc[r],e.width,e.height,0,n):(d&&(n=gh(n,e.width,e.height,s)),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+i,o,c,e.width,e.height,0,h,l,n))}(!this.needPOTTextures||Ot.IsExponentOfTwo(e.width)&&Ot.IsExponentOfTwo(e.height))&&e.generateMipMaps&&0===o&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),e.isReady=!0},q.prototype.createRawCubeTextureFromUrl=function(e,t,i,s,n,r,o,a,l=null,h=null,c=3,d=!1){const u=this._gl,_=this.createRawCubeTexture(null,i,s,n,!r,d,c,null);null==t||t.addPendingData(_),_.url=e,_.isReady=!1,this._internalTexturesCache.push(_);const f=e=>{const i=_.width,r=o(e);if(r){if(a){const e=this._getWebGLTextureType(n);let t=this._getInternalFormat(s);const o=this._getRGBABufferInternalSizedFormat(n);let l=!1;t===u.RGB&&(t=u.RGBA,l=!0),this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,_,!0),this._unpackFlipY(!1);const h=a(r);for(let s=0;s<h.length;s++){const r=i>>s;for(let i=0;i<6;i++){let a=h[s][i];l&&(a=gh(a,r,r,n)),u.texImage2D(i,s,o,r,r,0,t,e,a)}}this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(_,r,s,n,d);_.isReady=!0,null==t||t.removePendingData(_),_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear(),l&&l()}};return this._loadFile(e,(e=>{f(e)}),void 0,null==t?void 0:t.offlineProvider,!0,((e,i)=>{null==t||t.removePendingData(_),h&&e&&h(e.status+" "+e.statusText,i)})),_},q.prototype.createRawTexture2DArray=vh(!1),q.prototype.createRawTexture3D=vh(!0),q.prototype.updateRawTexture2DArray=Th(!1),q.prototype.updateRawTexture3D=Th(!0);class bh extends zi{get depth(){return this._depth}constructor(e,t,i,s,n,r,o=!0,a=!1,l=zi.TRILINEAR_SAMPLINGMODE,h=0,c){super(null,r,!o,a),this.format=n,this._texture=r.getEngine().createRawTexture2DArray(e,t,i,s,n,o,a,l,null,h,c),this._depth=s,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,s,n,r=!0,o=!1,a=3,l=0){return new bh(e,t,i,s,5,n,r,o,a,l)}}class Eh{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new wt(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,e||(e=u.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const e=this._scene.getEngine().getCaps();this._canUseTextureForTargets=e.canUseGLVertexID&&e.textureFloat&&e.maxVertexTextureImageUnits>0&&e.texture2DArrayMaxLayerCount>1}}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){var e;return Eh.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!(null===(e=this._scene)||void 0===e?void 0:e.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add((e=>{this._syncActiveTargets(e)}))),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add((()=>{this._syncActiveTargets(!0)}))),this._syncActiveTargets(!0)}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture)}clone(){const e=new Eh(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),this._morphTargetTextureIndices&&this._morphTargetTextureIndices.length===this._targets.length||(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const e of this._targets){if(i++,0===e.influence&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=Eh.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(e),this._morphTargetTextureIndices[t]=i,this._tempInfluences[t++]=e.influence,this._supportsNormals=this._supportsNormals&&e.hasNormals,this._supportsTangents=this._supportsTangents&&e.hasTangents,this._supportsUVs=this._supportsUVs&&e.hasUVs;const s=e.getPositions();if(s){const e=s.length/3;if(0===this._vertexCount)this._vertexCount=e;else if(this._vertexCount!==e)return void p.Error("Incompatible target. Targets must all have the same vertices count.")}}this._morphTargetTextureIndices.length!==t&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,t)),this._influences&&this._influences.length===t||(this._influences=new Float32Array(t));for(let e=0;e<t;e++)this._influences[e]=this._tempInfluences[e];e&&this.synchronize()}synchronize(){if(this._scene&&!this.areUpdatesFrozen){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){const e=this._targetStoreTexture.getSize();e.width===this._textureWidth&&e.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();const e=this._targets.length,t=new Float32Array(e*this._textureWidth*this._textureHeight*4);let i=0;for(let s=0;s<e;s++){const e=this._targets[s],n=e.getPositions(),r=e.getNormals(),o=e.getUVs(),a=e.getTangents();if(!n)return void(0===s&&p.Error("Invalid morph target. Target must have positions."));i=s*this._textureWidth*this._textureHeight*4;for(let e=0;e<this._vertexCount;e++)t[i]=n[3*e],t[i+1]=n[3*e+1],t[i+2]=n[3*e+2],i+=4,this._supportsNormals&&r&&(t[i]=r[3*e],t[i+1]=r[3*e+1],t[i+2]=r[3*e+2],i+=4),this._supportsUVs&&o&&(t[i]=o[2*e],t[i+1]=o[2*e+1],i+=4),this._supportsTangents&&a&&(t[i]=a[3*e],t[i+1]=a[3*e+1],t[i+2]=a[3*e+2],i+=4)}this._targetStoreTexture=bh.CreateRGBATexture(t,this._textureWidth,this._textureHeight,e,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const i=new Eh(t);i._uniqueId=e.id;for(const s of e.targets)i.addTarget(mh.Parse(s,t));return i}}Eh.EnableTextureStorage=!0,Eh.MaxActiveMorphTargetsInVertexAttributeMode=8;class Sh extends Ht{}class xh{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach((e=>{e.dispose()})),this.rootNodes.length=0,this.skeletons.slice(0).forEach((e=>{e.dispose()})),this.skeletons.length=0,this.animationGroups.slice(0).forEach((e=>{e.dispose()})),this.animationGroups.length=0}}class Ch extends Ht{constructor(e){super(),this._wasAddedToScene=!1,(e=e||u.LastCreatedScene)&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add((()=>{this._wasAddedToScene||this.dispose()})),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add((()=>{for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();for(const e of this.particleSystems)e.rebuild();for(const e of this.textures)e._rebuild()})))}_topologicalSort(e){const t=new Map;for(const i of e)t.set(i.uniqueId,i);const i={dependsOn:new Map,dependedBy:new Map};for(const t of e){const e=t.uniqueId;i.dependsOn.set(e,new Set),i.dependedBy.set(e,new Set)}for(const s of e){const e=s.uniqueId,n=i.dependsOn.get(e);if(s instanceof Cl){const r=s.sourceMesh;t.has(r.uniqueId)&&(n.add(r.uniqueId),i.dependedBy.get(r.uniqueId).add(e))}const r=i.dependedBy.get(e);for(const n of s.getDescendants()){const s=n.uniqueId;t.has(s)&&(r.add(s),i.dependsOn.get(s).add(e))}}const s=[],n=[];for(const s of e){const e=s.uniqueId;0===i.dependsOn.get(e).size&&(n.push(s),t.delete(e))}const r=n;for(;r.length>0;){const e=r.shift();s.push(e);const n=i.dependedBy.get(e.uniqueId);for(const s of Array.from(n.values())){const n=i.dependsOn.get(s);n.delete(e.uniqueId),0===n.size&&t.get(s)&&(r.push(t.get(s)),t.delete(s))}}return t.size>0&&(p.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach((e=>p.Error(e.name)))),s}_addNodeAndDescendantsToList(e,t,i,s){if(i&&(!s||s(i))&&!t.has(i.uniqueId)){e.push(i),t.add(i.uniqueId);for(const n of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,n,s)}}_isNodeInContainer(e){return e instanceof jn&&-1!==this.meshes.indexOf(e)||e instanceof Bn&&-1!==this.transformNodes.indexOf(e)||e instanceof Lt&&-1!==this.lights.indexOf(e)||e instanceof Gt&&-1!==this.cameras.indexOf(e)}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return p.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return p.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return p.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return p.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||Ot.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const s={},n={},r=new xh,o=[],a=[],l=Object.assign({doNotInstantiate:!0},i),h=[],c=new Set;for(const e of this.transformNodes)null===e.parent&&this._addNodeAndDescendantsToList(h,c,e,l.predicate);for(const e of this.meshes)null===e.parent&&this._addNodeAndDescendantsToList(h,c,e,l.predicate);const d=this._topologicalSort(h),u=(i,o)=>{if(((t,i)=>{if(s[t.uniqueId]=i.uniqueId,n[i.uniqueId]=i,e&&(i.name=e(t.name)),i instanceof jn){const e=i;if(e.morphTargetManager){const i=t.morphTargetManager;e.morphTargetManager=i.clone();for(let t=0;t<i.numTargets;t++){const r=i.getTarget(t),o=e.morphTargetManager.getTarget(t);s[r.uniqueId]=o.uniqueId,n[o.uniqueId]=o}}}})(i,o),i.parent){const e=s[i.parent.uniqueId],t=n[e];o.parent=t||i.parent}if(o.position&&i.position&&o.position.copyFrom(i.position),o.rotationQuaternion&&i.rotationQuaternion&&o.rotationQuaternion.copyFrom(i.rotationQuaternion),o.rotation&&i.rotation&&o.rotation.copyFrom(i.rotation),o.scaling&&i.scaling&&o.scaling.copyFrom(i.scaling),o.material){const r=o;if(r.material)if(t){const t=i.material;if(-1===a.indexOf(t)){let i=t.clone(e?e(t.name):"Clone of "+t.name);if(a.push(t),s[t.uniqueId]=i.uniqueId,n[i.uniqueId]=i,"MultiMaterial"===t.getClassName()){const r=t;for(const t of r.subMaterials)t&&(i=t.clone(e?e(t.name):"Clone of "+t.name),a.push(t),s[t.uniqueId]=i.uniqueId,n[i.uniqueId]=i);r.subMaterials=r.subMaterials.map((e=>e&&n[s[e.uniqueId]]))}}"InstancedMesh"!==r.getClassName()&&(r.material=n[s[t.uniqueId]])}else"MultiMaterial"===r.material.getClassName()?-1===this.scene.multiMaterials.indexOf(r.material)&&this.scene.addMultiMaterial(r.material):-1===this.scene.materials.indexOf(r.material)&&this.scene.addMaterial(r.material)}null===o.parent&&r.rootNodes.push(o)};return d.forEach((e=>{if("InstancedMesh"===e.getClassName()){const t=e,i=t.sourceMesh,r=s[i.uniqueId],o=("number"==typeof r?n[r]:i).createInstance(t.name);u(t,o)}else{let t=!0;"TransformNode"===e.getClassName()||"Node"===e.getClassName()||e.skeleton||!e.getTotalVertices||0===e.getTotalVertices()?t=!1:l.doNotInstantiate&&(t="function"==typeof l.doNotInstantiate?!l.doNotInstantiate(e):!l.doNotInstantiate);const i=t?e.createInstance(`instance of ${e.name}`):e.clone(`Clone of ${e.name}`,null,!0);if(!i)throw new Error(`Could not clone or instantiate node on Asset Container ${e.name}`);u(e,i)}})),this.skeletons.forEach((t=>{if(l.predicate&&!l.predicate(t))return;const i=t.clone(e?e(t.name):"Clone of "+t.name);for(const e of this.meshes)if(e.skeleton===t&&!e.isAnInstance){const t=n[s[e.uniqueId]];if(!t||t.isAnInstance)continue;if(t.skeleton=i,-1!==o.indexOf(i))continue;o.push(i);for(const e of i.bones)e._linkedTransformNode&&(e._linkedTransformNode=n[s[e._linkedTransformNode.uniqueId]])}r.skeletons.push(i)})),this.animationGroups.forEach((t=>{if(l.predicate&&!l.predicate(t))return;const i=t.clone(e?e(t.name):"Clone of "+t.name,(e=>n[s[e.uniqueId]]||e));r.animationGroups.push(i)})),r}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||Ot.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];this.cameras.forEach((i=>{e&&!e(i)||(this.scene.addCamera(i),t.push(i))})),this.lights.forEach((i=>{e&&!e(i)||(this.scene.addLight(i),t.push(i))})),this.meshes.forEach((i=>{e&&!e(i)||(this.scene.addMesh(i),t.push(i))})),this.skeletons.forEach((t=>{e&&!e(t)||this.scene.addSkeleton(t)})),this.animations.forEach((t=>{e&&!e(t)||this.scene.addAnimation(t)})),this.animationGroups.forEach((t=>{e&&!e(t)||this.scene.addAnimationGroup(t)})),this.multiMaterials.forEach((t=>{e&&!e(t)||this.scene.addMultiMaterial(t)})),this.materials.forEach((t=>{e&&!e(t)||this.scene.addMaterial(t)})),this.morphTargetManagers.forEach((t=>{e&&!e(t)||this.scene.addMorphTargetManager(t)})),this.geometries.forEach((t=>{e&&!e(t)||this.scene.addGeometry(t)})),this.transformNodes.forEach((i=>{e&&!e(i)||(this.scene.addTransformNode(i),t.push(i))})),this.actionManagers.forEach((t=>{e&&!e(t)||this.scene.addActionManager(t)})),this.textures.forEach((t=>{e&&!e(t)||this.scene.addTexture(t)})),this.reflectionProbes.forEach((t=>{e&&!e(t)||this.scene.addReflectionProbe(t)}));for(const e of t)e.parent&&-1===this.scene.getNodes().indexOf(e.parent)&&(e.setParent?e.setParent(null):e.parent=null)}removeAllFromScene(){this._isValidHierarchy()||Ot.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach((t=>{e&&!e(t)||this.scene.removeCamera(t)})),this.lights.forEach((t=>{e&&!e(t)||this.scene.removeLight(t)})),this.meshes.forEach((t=>{e&&!e(t)||this.scene.removeMesh(t,!0)})),this.skeletons.forEach((t=>{e&&!e(t)||this.scene.removeSkeleton(t)})),this.animations.forEach((t=>{e&&!e(t)||this.scene.removeAnimation(t)})),this.animationGroups.forEach((t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)})),this.multiMaterials.forEach((t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)})),this.materials.forEach((t=>{e&&!e(t)||this.scene.removeMaterial(t)})),this.morphTargetManagers.forEach((t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)})),this.geometries.forEach((t=>{e&&!e(t)||this.scene.removeGeometry(t)})),this.transformNodes.forEach((t=>{e&&!e(t)||this.scene.removeTransformNode(t)})),this.actionManagers.forEach((t=>{e&&!e(t)||this.scene.removeActionManager(t)})),this.textures.forEach((t=>{e&&!e(t)||this.scene.removeTexture(t)})),this.reflectionProbes.forEach((t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)}))}dispose(){this.cameras.slice(0).forEach((e=>{e.dispose()})),this.cameras.length=0,this.lights.slice(0).forEach((e=>{e.dispose()})),this.lights.length=0,this.meshes.slice(0).forEach((e=>{e.dispose()})),this.meshes.length=0,this.skeletons.slice(0).forEach((e=>{e.dispose()})),this.skeletons.length=0,this.animationGroups.slice(0).forEach((e=>{e.dispose()})),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach((e=>{e.dispose()})),this.multiMaterials.length=0,this.materials.slice(0).forEach((e=>{e.dispose()})),this.materials.length=0,this.geometries.slice(0).forEach((e=>{e.dispose()})),this.geometries.length=0,this.transformNodes.slice(0).forEach((e=>{e.dispose()})),this.transformNodes.length=0,this.actionManagers.slice(0).forEach((e=>{e.dispose()})),this.actionManagers.length=0,this.textures.slice(0).forEach((e=>{e.dispose()})),this.textures.length=0,this.reflectionProbes.slice(0).forEach((e=>{e.dispose()})),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach((e=>{e.dispose()})),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(e&&t)for(const s of e){let e=!0;if(i)for(const t of i)if(s===t){e=!1;break}e&&(t.push(s),s._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,void 0===e&&(e=new Sh);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||("_environmentTexture"===t?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new jn("assetContainerRootMesh",this.scene);return this.meshes.forEach((t=>{t.parent||e.addChild(t)})),this.meshes.unshift(e),e}mergeAnimationsTo(e=u.LastCreatedScene,t,i=null){if(!e)return p.Error("No scene available to merge animations to"),[];const s=i||(t=>{let i=null;const s=t.animations.length?t.animations[0].targetProperty:"",n=t.name.split(".").join("").split("_primitive")[0];switch(s){case"position":case"rotationQuaternion":i=e.getTransformNodeByName(t.name)||e.getTransformNodeByName(n);break;case"influence":i=e.getMorphTargetByName(t.name)||e.getMorphTargetByName(n);break;default:i=e.getNodeByName(t.name)||e.getNodeByName(n)}return i});this.getNodes().forEach((e=>{const t=s(e);if(null!==t){for(const i of e.animations){const e=t.animations.filter((e=>e.targetProperty===i.targetProperty));for(const i of e){const e=t.animations.indexOf(i,0);e>-1&&t.animations.splice(e,1)}}t.animations=t.animations.concat(e.animations)}}));const n=[];return this.animationGroups.slice().forEach((e=>{n.push(e.clone(e.name,s)),e.animatables.forEach((e=>{e.stop()}))})),t.forEach((t=>{const i=s(t.target);i&&(e.beginAnimation(i,t.fromFrame,t.toFrame,t.loopAnimation,t.speedRatio,t.onAnimationEnd?t.onAnimationEnd:void 0,void 0,!0,void 0,t.onAnimationLoop?t.onAnimationLoop:void 0),e.stopAnimation(t.target))})),n}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.transformNodes.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.lights.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})),this.cameras.forEach((e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}))}addAllAssetsToContainer(e){if(!e)return;const t=[],i=new Set;for(t.push(e);t.length>0;){const e=t.pop();if(e instanceof jn?(e.geometry&&-1===this.geometries.indexOf(e.geometry)&&this.geometries.push(e.geometry),this.meshes.push(e)):e instanceof Bn?this.transformNodes.push(e):e instanceof Lt?this.lights.push(e):e instanceof Gt&&this.cameras.push(e),e instanceof Gn){if(e.material&&-1===this.materials.indexOf(e.material)){this.materials.push(e.material);for(const t of e.material.getActiveTextures())-1===this.textures.indexOf(t)&&this.textures.push(t)}e.skeleton&&-1===this.skeletons.indexOf(e.skeleton)&&this.skeletons.push(e.skeleton),e.morphTargetManager&&-1===this.morphTargetManagers.indexOf(e.morphTargetManager)&&this.morphTargetManagers.push(e.morphTargetManager)}for(const s of e.getChildren())i.has(s)||t.push(s);i.add(e)}this.populateRootNodes()}}class yh extends zi{constructor(e,t,i,s,n,r=!0,o=!1,a=3,l=0,h,c){super(null,n,!r,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,h),this.format=s,this._engine&&(this._engine._caps.textureFloatLinearFiltering||1!==l||(a=1),this._engine._caps.textureHalfFloatLinearFiltering||2!==l||(a=1),this._texture=this._engine.createRawTexture(e,t,i,s,r,o,a,null,l,null!=h?h:0,null!=c&&c),this.wrapU=zi.CLAMP_ADDRESSMODE,this.wrapV=zi.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,i,s,n=!0,r=!1,o=3){return new yh(e,t,i,1,s,n,r,o)}static CreateLuminanceAlphaTexture(e,t,i,s,n=!0,r=!1,o=3){return new yh(e,t,i,2,s,n,r,o)}static CreateAlphaTexture(e,t,i,s,n=!0,r=!1,o=3){return new yh(e,t,i,0,s,n,r,o)}static CreateRGBTexture(e,t,i,s,n=!0,r=!1,o=3,a=0,l=0,h=!1){return new yh(e,t,i,4,s,n,r,o,a,l,h)}static CreateRGBATexture(e,t,i,s,n=!0,r=!1,o=3,a=0,l=0,h=!1){return new yh(e,t,i,5,s,n,r,o,a,l,h)}static CreateRGBAStorageTexture(e,t,i,s,n=!0,r=!1,o=3,a=0,l=!1){return new yh(e,t,i,5,s,n,r,o,a,1,l)}static CreateRTexture(e,t,i,s,n=!0,r=!1,o=zi.TRILINEAR_SAMPLINGMODE,a=1){return new yh(e,t,i,6,s,n,r,o,a)}static CreateRStorageTexture(e,t,i,s,n=!0,r=!1,o=zi.TRILINEAR_SAMPLINGMODE,a=1){return new yh(e,t,i,6,s,n,r,o,a,1)}}class Ah{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=Te.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new s,this.bones=[],this._scene=i||u.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const n=this._scene.getEngine().getCaps();this._canUseTextureForBones=n.textureFloat&&n.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter((e=>!e.getParent()))}getTransformMatrices(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):(this._transformMatrices&&!this._isDirty||this.prepare(),this._transformMatrices)}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let e=!0;for(const i in this._ranges)e&&(t+=", ",e=!1),t+=i;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new ir(e,t,i);for(let s=0,n=this.bones.length;s<n;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.bones.length;i<s;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let s=!0;const n=this._getHighestAnimationFrame()+1,r={},o=e.bones;let a,l;for(l=0,a=o.length;l<a;l++)r[o[l].name]=o[l];this.bones.length!==o.length&&(p.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${o.length}`),s=!1);const h=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(l=0,a=this.bones.length;l<a;l++){const e=this.bones[l].name,o=r[e];o?s=s&&this.bones[l].copyAnimationRange(o,t,n,i,h):(p.Warn("copyAnimationRange: not same rig, missing source bone "+e),s=!1)}const c=e.getAnimationRange(t);return c&&(this._ranges[t]=new ir(t,c.from+n,c.to+n)),s}returnToRest(){for(const e of this.bones)-1!==e._index&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const i=this.bones[t].animations[0].getHighestFrame();e<i&&(e=i)}return e}beginAnimation(e,t,i,s){const n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,i,s):null}static MakeAnimationAdditive(e,t=0,i){const s=e.getAnimationRange(i);if(!s)return null;const n=e._scene.getAllAnimatablesByTarget(e);let r=null;for(let e=0;e<n.length;e++){const t=n[e];if(t.fromFrame===(null==s?void 0:s.from)&&t.toFrame===(null==s?void 0:s.to)){r=t;break}}const o=e.getAnimatables();for(let e=0;e<o.length;e++){const s=o[e].animations;if(s)for(let e=0;e<s.length;e++)cr.MakeAnimationAdditive(s[e],t,i)}return r&&(r.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const s=this.bones[i];s._childUpdateId++;const n=s.getParent();if(n?s.getLocalMatrix().multiplyToRef(n.getFinalMatrix(),s.getFinalMatrix()):t?s.getLocalMatrix().multiplyToRef(t,s.getFinalMatrix()):s.getFinalMatrix().copyFrom(s.getLocalMatrix()),-1!==s._index){const t=null===s._index?i:s._index;s.getAbsoluteInverseBindMatrix().multiplyToArray(s.getFinalMatrix(),e,16*t)}}this._identity.copyToArray(e,16*this.bones.length)}prepare(e=!1){if(!e){const e=this.getScene().getRenderId();if(this._currentRenderId===e)return;this._currentRenderId=e}if(this._numBonesWithLinkedTransformNode>0)for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let i=this._isDirty;if(e._bonesTransformMatrices&&e._bonesTransformMatrices.length===16*(this.bones.length+1)||(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),i=!0),i){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const e of this.bones)e.getParent()||(e.getBindMatrix().multiplyToRef(t,Ee.Matrix[1]),e._updateAbsoluteBindMatrices(Ee.Matrix[1]));if(this.isUsingTextureForMatrices){const t=4*(this.bones.length+1);e._transformMatrixTexture&&e._transformMatrixTexture.getSize().width===t||(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=yh.CreateRGBATexture(e._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=yh.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new Ah(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let e=0;e<this.bones.length;e++){const t=this.bones[e];let s=null;const n=t.getParent();if(n){const e=this.bones.indexOf(n);s=i.bones[e]}const r=new go(t.name,i,s,t.getBindMatrix().clone(),t.getRestMatrix().clone());r._index=t._index,t._linkedTransformNode&&r.linkTransformNode(t._linkedTransformNode),it.DeepCopy(t.animations,r.animations)}if(this._ranges){i._ranges={};for(const e in this._ranges){const t=this._ranges[e];t&&(i._ranges[e]=t.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){this.bones.forEach((t=>{t.animations.forEach((t=>{t.enableBlending=!0,t.blendingSpeed=e}))}))}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var e;const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let i=0;i<this.bones.length;i++){const s=this.bones[i],n=s.getParent(),r={parentBoneIndex:n?this.bones.indexOf(n):-1,index:s.getIndex(),name:s.name,id:s.id,matrix:s.getBindMatrix().toArray(),rest:s.getRestMatrix().toArray(),linkedTransformNodeId:null===(e=s.getTransformNode())||void 0===e?void 0:e.id};t.bones.push(r),s.length&&(r.length=s.length),s.metadata&&(r.metadata=s.metadata),s.animations&&s.animations.length>0&&(r.animation=s.animations[0].serialize()),t.ranges=[];for(const e in this._ranges){const i=this._ranges[e];if(!i)continue;const s={};s.name=e,s.from=i.from,s.to=i.to,t.ranges.push(s)}}return t}static Parse(e,t){const i=new Ah(e.name,e.id,t);let s;for(e.dimensionsAtRest&&(i.dimensionsAtRest=me.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix,s=0;s<e.bones.length;s++){const t=e.bones[s],n=e.bones[s].index;let r=null;t.parentBoneIndex>-1&&(r=i.bones[t.parentBoneIndex]);const o=t.rest?Te.FromArray(t.rest):null,a=new go(t.name,i,r,Te.FromArray(t.matrix),o,null,n);void 0!==t.id&&null!==t.id&&(a.id=t.id),t.length&&(a.length=t.length),t.metadata&&(a.metadata=t.metadata),t.animation&&a.animations.push(cr.Parse(t.animation)),void 0!==t.linkedTransformNodeId&&null!==t.linkedTransformNodeId&&(i._hasWaitingData=!0,a._waitingTransformNodeId=t.linkedTransformNodeId)}if(e.ranges)for(s=0;s<e.ranges.length;s++){const t=e.ranges[s];i.createAnimationRange(t.name,t.from,t.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const s=this.bones[e];if(!s)return;void 0===s._index&&(s._index=e);const n=s.getParent();n&&this._sortBones(this.bones.indexOf(n),t,i),t.push(s)}setCurrentPoseAsRest(){this.bones.forEach((e=>{e.setCurrentPoseAsRest()}))}}class Rh{static Data=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="]}class Ih{uniqueId;leftLoadCount;isRequesting;errorTextureDatas;constructor(e){this.uniqueId=e,this.leftLoadCount=0,this.isRequesting=!0,this.errorTextureDatas=[]}}class Ph{observable;hasLoadError;constructor(){this.observable=new s,this.hasLoadError=!1}}class Mh{cacheKey;_scene;_assetContainer;_onLoad;_onError;_arrayBuffer;_texture;constructor(e,t,i,s,n,r,o){this.cacheKey=e,this._scene=t,this._assetContainer=i,this._onLoad=r,this._onError=o,this._arrayBuffer=null,this._texture=null,n||t._loadFile(s,(s=>{const n=this._arrayBuffer=s;this._createTexture(t,i,e,n,r,((e,t)=>{this._arrayBuffer=null,o?.(e,t)}))}),void 0,!0,!0,((e,t)=>{o?.(e?e.status+" "+e.statusText:"",t)}))}loadFromArrayBuffer(e){this._arrayBuffer=e,this._createTexture(this._scene,this._assetContainer,this.cacheKey,this._arrayBuffer,this._onLoad,((e,t)=>{this._arrayBuffer=null,this._onError?.(e,t)}))}_createTexture(e,t,i,s,n,r){e._blockEntityCollection=!!t;const o=this._texture=new zi("data:"+i,e,void 0,void 0,void 0,(()=>{null===this._texture?null!==n&&dt.SetImmediate(n):n?.()}),r,s,!0);o._parentContainer=t,e._blockEntityCollection=!1,t?.textures.push(o),o.name=i}get arrayBuffer(){return this._arrayBuffer}get texture(){return this._texture}}class Oh{onModelTextureLoadedObservable=new Map;textureCache=new Map;_textureLoadInfoMap=new Map;_loadingModels=new Map;_errorTexturesReferenceCount=new Map;static _EmptyResult={texture:null,arrayBuffer:null};_incrementLeftLoadCount(e){let t=this._loadingModels.get(e);void 0===t&&(t=new Ih(e),this._loadingModels.set(e,t)),t.leftLoadCount+=1;let i=this.onModelTextureLoadedObservable.get(e);return void 0===i&&(i=new s,this.onModelTextureLoadedObservable.set(e,i)),t}_decrementLeftLoadCount(e){if(e.leftLoadCount-=1,!e.isRequesting&&0===e.leftLoadCount){this._removeErrorTexturesReferenceCount(e.uniqueId),this._loadingModels.delete(e.uniqueId);const t=this.onModelTextureLoadedObservable.get(e.uniqueId);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e.uniqueId)}}loadModelTexturesEnd(e){const t=this._loadingModels.get(e);if(void 0!==t&&(t.isRequesting=!1,0===t.leftLoadCount)){this._removeErrorTexturesReferenceCount(e),this._loadingModels.delete(e);const t=this.onModelTextureLoadedObservable.get(e);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e)}}_addErrorTextureReferenceCount(e,t){this._loadingModels.get(e).errorTextureDatas.push(t),this._errorTexturesReferenceCount.set(t,(this._errorTexturesReferenceCount.get(t)??0)+1)}_removeErrorTexturesReferenceCount(e){const t=this._loadingModels.get(e);for(let e=0;e<t.errorTextureDatas.length;++e){const i=t.errorTextureDatas[e],s=this._errorTexturesReferenceCount.get(i)-1;0===s?null!==i.texture?i.texture.dispose():(this._textureLoadInfoMap.delete(i.cacheKey),this.textureCache.delete(i.cacheKey),this._errorTexturesReferenceCount.delete(i)):this._errorTexturesReferenceCount.set(i,s)}}_handleTextureOnDispose(e){e.texture.onDisposeObservable.addOnce((()=>{this._textureLoadInfoMap.delete(e.cacheKey),this.textureCache.delete(e.cacheKey),this._errorTexturesReferenceCount.delete(e)}))}async _loadTextureAsyncInternal(e,t,i,s,n,r){const o=this._incrementLeftLoadCount(e);let a=this._textureLoadInfoMap.get(t);void 0===a&&(a=new Ph,this._textureLoadInfoMap.set(t,a));let l=this.textureCache.get(t);if(void 0===l&&!a.hasLoadError){const o=null!==s?Rh.Data[s]:t;l=new Mh(t,n,r,o,null!==i,(()=>{this._handleTextureOnDispose(l),a.hasLoadError=!1,a.observable.notifyObservers(!1),a.observable.clear()}),((t,i)=>{null!==l.texture&&this._handleTextureOnDispose(l),this._addErrorTextureReferenceCount(e,l),a.hasLoadError=!0,a.observable.notifyObservers(!0),a.observable.clear()})),this.textureCache.set(t,l);const h=i instanceof Blob?await i.arrayBuffer():i;null!==h&&l.loadFromArrayBuffer(h)}return null!==l.texture&&l.texture.isReady()?(this._decrementLeftLoadCount(o),a.hasLoadError?Oh._EmptyResult:l):new Promise((e=>{a.observable.addOnce((t=>{this._decrementLeftLoadCount(o),e(t?Oh._EmptyResult:l)}))}))}async loadTextureAsync(e,t,i,s,n){const r="number"==typeof i,o=r?r?"file:shared_toon_texture_"+i:i:this.pathNormalize(t+i);return await this._loadTextureAsyncInternal(e,o,null,r?i:null,s,n)}async loadTextureFromBufferAsync(e,t,i,s,n,r=!0){return r&&(t=this.pathNormalize(t)),await this._loadTextureAsyncInternal(e,t,i,null,s,n)}pathNormalize(e){const t=(e=e.replace(/\\/g,"/")).split("/"),i=[];for(let e=0;e<t.length;++e){const s=t[e];"."!==s&&(".."===s?i.pop():i.push(s))}return i.join("/")}}class Dh{}Dh.ALPHA_DISABLE=0,Dh.ALPHA_ADD=1,Dh.ALPHA_COMBINE=2,Dh.ALPHA_SUBTRACT=3,Dh.ALPHA_MULTIPLY=4,Dh.ALPHA_MAXIMIZED=5,Dh.ALPHA_ONEONE=6,Dh.ALPHA_PREMULTIPLIED=7,Dh.ALPHA_PREMULTIPLIED_PORTERDUFF=8,Dh.ALPHA_INTERPOLATE=9,Dh.ALPHA_SCREENMODE=10,Dh.ALPHA_ONEONE_ONEONE=11,Dh.ALPHA_ALPHATOCOLOR=12,Dh.ALPHA_REVERSEONEMINUS=13,Dh.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,Dh.ALPHA_ONEONE_ONEZERO=15,Dh.ALPHA_EXCLUSION=16,Dh.ALPHA_LAYER_ACCUMULATE=17,Dh.ALPHA_EQUATION_ADD=0,Dh.ALPHA_EQUATION_SUBSTRACT=1,Dh.ALPHA_EQUATION_REVERSE_SUBTRACT=2,Dh.ALPHA_EQUATION_MAX=3,Dh.ALPHA_EQUATION_MIN=4,Dh.ALPHA_EQUATION_DARKEN=5,Dh.DELAYLOADSTATE_NONE=0,Dh.DELAYLOADSTATE_LOADED=1,Dh.DELAYLOADSTATE_LOADING=2,Dh.DELAYLOADSTATE_NOTLOADED=4,Dh.NEVER=512,Dh.ALWAYS=519,Dh.LESS=513,Dh.EQUAL=514,Dh.LEQUAL=515,Dh.GREATER=516,Dh.GEQUAL=518,Dh.NOTEQUAL=517,Dh.KEEP=7680,Dh.ZERO=0,Dh.REPLACE=7681,Dh.INCR=7682,Dh.DECR=7683,Dh.INVERT=5386,Dh.INCR_WRAP=34055,Dh.DECR_WRAP=34056,Dh.TEXTURE_CLAMP_ADDRESSMODE=0,Dh.TEXTURE_WRAP_ADDRESSMODE=1,Dh.TEXTURE_MIRROR_ADDRESSMODE=2,Dh.TEXTURE_CREATIONFLAG_STORAGE=1,Dh.TEXTUREFORMAT_ALPHA=0,Dh.TEXTUREFORMAT_LUMINANCE=1,Dh.TEXTUREFORMAT_LUMINANCE_ALPHA=2,Dh.TEXTUREFORMAT_RGB=4,Dh.TEXTUREFORMAT_RGBA=5,Dh.TEXTUREFORMAT_RED=6,Dh.TEXTUREFORMAT_R=6,Dh.TEXTUREFORMAT_RG=7,Dh.TEXTUREFORMAT_RED_INTEGER=8,Dh.TEXTUREFORMAT_R_INTEGER=8,Dh.TEXTUREFORMAT_RG_INTEGER=9,Dh.TEXTUREFORMAT_RGB_INTEGER=10,Dh.TEXTUREFORMAT_RGBA_INTEGER=11,Dh.TEXTUREFORMAT_BGRA=12,Dh.TEXTUREFORMAT_DEPTH24_STENCIL8=13,Dh.TEXTUREFORMAT_DEPTH32_FLOAT=14,Dh.TEXTUREFORMAT_DEPTH16=15,Dh.TEXTUREFORMAT_DEPTH24=16,Dh.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,Dh.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,Dh.TEXTUREFORMAT_STENCIL8=19,Dh.TEXTUREFORMAT_UNDEFINED=4294967295,Dh.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,Dh.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,Dh.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,Dh.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,Dh.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,Dh.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,Dh.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,Dh.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,Dh.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,Dh.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,Dh.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,Dh.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,Dh.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,Dh.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,Dh.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,Dh.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,Dh.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,Dh.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,Dh.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,Dh.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,Dh.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,Dh.TEXTURETYPE_UNSIGNED_BYTE=0,Dh.TEXTURETYPE_UNSIGNED_INT=0,Dh.TEXTURETYPE_FLOAT=1,Dh.TEXTURETYPE_HALF_FLOAT=2,Dh.TEXTURETYPE_BYTE=3,Dh.TEXTURETYPE_SHORT=4,Dh.TEXTURETYPE_UNSIGNED_SHORT=5,Dh.TEXTURETYPE_INT=6,Dh.TEXTURETYPE_UNSIGNED_INTEGER=7,Dh.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,Dh.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,Dh.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,Dh.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,Dh.TEXTURETYPE_UNSIGNED_INT_24_8=12,Dh.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,Dh.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,Dh.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,Dh.TEXTURETYPE_UNDEFINED=16,Dh.TEXTURE_2D=3553,Dh.TEXTURE_2D_ARRAY=35866,Dh.TEXTURE_CUBE_MAP=34067,Dh.TEXTURE_CUBE_MAP_ARRAY=3735928559,Dh.TEXTURE_3D=32879,Dh.TEXTURE_NEAREST_SAMPLINGMODE=1,Dh.TEXTURE_NEAREST_NEAREST=1,Dh.TEXTURE_BILINEAR_SAMPLINGMODE=2,Dh.TEXTURE_LINEAR_LINEAR=2,Dh.TEXTURE_TRILINEAR_SAMPLINGMODE=3,Dh.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,Dh.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,Dh.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,Dh.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,Dh.TEXTURE_NEAREST_LINEAR=7,Dh.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,Dh.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,Dh.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,Dh.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,Dh.TEXTURE_LINEAR_NEAREST=12,Dh.TEXTURE_EXPLICIT_MODE=0,Dh.TEXTURE_SPHERICAL_MODE=1,Dh.TEXTURE_PLANAR_MODE=2,Dh.TEXTURE_CUBIC_MODE=3,Dh.TEXTURE_PROJECTION_MODE=4,Dh.TEXTURE_SKYBOX_MODE=5,Dh.TEXTURE_INVCUBIC_MODE=6,Dh.TEXTURE_EQUIRECTANGULAR_MODE=7,Dh.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,Dh.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,Dh.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,Dh.TEXTURE_FILTERING_QUALITY_HIGH=64,Dh.TEXTURE_FILTERING_QUALITY_MEDIUM=16,Dh.TEXTURE_FILTERING_QUALITY_LOW=8,Dh.SCALEMODE_FLOOR=1,Dh.SCALEMODE_NEAREST=2,Dh.SCALEMODE_CEILING=3,Dh.MATERIAL_TextureDirtyFlag=1,Dh.MATERIAL_LightDirtyFlag=2,Dh.MATERIAL_FresnelDirtyFlag=4,Dh.MATERIAL_AttributesDirtyFlag=8,Dh.MATERIAL_MiscDirtyFlag=16,Dh.MATERIAL_PrePassDirtyFlag=32,Dh.MATERIAL_AllDirtyFlag=63,Dh.MATERIAL_TriangleFillMode=0,Dh.MATERIAL_WireFrameFillMode=1,Dh.MATERIAL_PointFillMode=2,Dh.MATERIAL_PointListDrawMode=3,Dh.MATERIAL_LineListDrawMode=4,Dh.MATERIAL_LineLoopDrawMode=5,Dh.MATERIAL_LineStripDrawMode=6,Dh.MATERIAL_TriangleStripDrawMode=7,Dh.MATERIAL_TriangleFanDrawMode=8,Dh.MATERIAL_ClockWiseSideOrientation=0,Dh.MATERIAL_CounterClockWiseSideOrientation=1,Dh.ACTION_NothingTrigger=0,Dh.ACTION_OnPickTrigger=1,Dh.ACTION_OnLeftPickTrigger=2,Dh.ACTION_OnRightPickTrigger=3,Dh.ACTION_OnCenterPickTrigger=4,Dh.ACTION_OnPickDownTrigger=5,Dh.ACTION_OnDoublePickTrigger=6,Dh.ACTION_OnPickUpTrigger=7,Dh.ACTION_OnPickOutTrigger=16,Dh.ACTION_OnLongPressTrigger=8,Dh.ACTION_OnPointerOverTrigger=9,Dh.ACTION_OnPointerOutTrigger=10,Dh.ACTION_OnEveryFrameTrigger=11,Dh.ACTION_OnIntersectionEnterTrigger=12,Dh.ACTION_OnIntersectionExitTrigger=13,Dh.ACTION_OnKeyDownTrigger=14,Dh.ACTION_OnKeyUpTrigger=15,Dh.PARTICLES_BILLBOARDMODE_Y=2,Dh.PARTICLES_BILLBOARDMODE_ALL=7,Dh.PARTICLES_BILLBOARDMODE_STRETCHED=8,Dh.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,Dh.MESHES_CULLINGSTRATEGY_STANDARD=0,Dh.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,Dh.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,Dh.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,Dh.SCENELOADER_NO_LOGGING=0,Dh.SCENELOADER_MINIMAL_LOGGING=1,Dh.SCENELOADER_SUMMARY_LOGGING=2,Dh.SCENELOADER_DETAILED_LOGGING=3,Dh.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,Dh.PREPASS_POSITION_TEXTURE_TYPE=1,Dh.PREPASS_VELOCITY_TEXTURE_TYPE=2,Dh.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,Dh.PREPASS_COLOR_TEXTURE_TYPE=4,Dh.PREPASS_DEPTH_TEXTURE_TYPE=5,Dh.PREPASS_NORMAL_TEXTURE_TYPE=6,Dh.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,Dh.BUFFER_CREATIONFLAG_READ=1,Dh.BUFFER_CREATIONFLAG_WRITE=2,Dh.BUFFER_CREATIONFLAG_READWRITE=3,Dh.BUFFER_CREATIONFLAG_UNIFORM=4,Dh.BUFFER_CREATIONFLAG_VERTEX=8,Dh.BUFFER_CREATIONFLAG_INDEX=16,Dh.BUFFER_CREATIONFLAG_STORAGE=32,Dh.RENDERPASS_MAIN=0,Dh.INPUT_ALT_KEY=18,Dh.INPUT_CTRL_KEY=17,Dh.INPUT_META_KEY1=91,Dh.INPUT_META_KEY2=92,Dh.INPUT_META_KEY3=93,Dh.INPUT_SHIFT_KEY=16,Dh.SNAPSHOTRENDERING_STANDARD=0,Dh.SNAPSHOTRENDERING_FAST=1,Dh.PERSPECTIVE_CAMERA=0,Dh.ORTHOGRAPHIC_CAMERA=1,Dh.FOVMODE_VERTICAL_FIXED=0,Dh.FOVMODE_HORIZONTAL_FIXED=1,Dh.RIG_MODE_NONE=0,Dh.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,Dh.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,Dh.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,Dh.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,Dh.RIG_MODE_STEREOSCOPIC_INTERLACED=14,Dh.RIG_MODE_VR=20,Dh.RIG_MODE_CUSTOM=22,Dh.MAX_SUPPORTED_UV_SETS=6,Dh.GL_ALPHA_EQUATION_ADD=32774,Dh.GL_ALPHA_EQUATION_MIN=32775,Dh.GL_ALPHA_EQUATION_MAX=32776,Dh.GL_ALPHA_EQUATION_SUBTRACT=32778,Dh.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,Dh.GL_ALPHA_FUNCTION_SRC=768,Dh.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,Dh.GL_ALPHA_FUNCTION_SRC_ALPHA=770,Dh.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,Dh.GL_ALPHA_FUNCTION_DST_ALPHA=772,Dh.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,Dh.GL_ALPHA_FUNCTION_DST_COLOR=774,Dh.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,Dh.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,Dh.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,Dh.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,Dh.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,Dh.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,Dh.SnippetUrl="https://snippet.babylonjs.com";class Nh{static MatricesSdefCKind="matricesSdefC";static MatricesSdefR0Kind="matricesSdefR0";static MatricesSdefR1Kind="matricesSdefR1"}const Fh="\n#ifndef SDEFDECLARATION\n#define SDEFDECLARATION\n\n#if NUM_BONE_INFLUENCERS > 0 && defined(SDEF)\nattribute vec3 matricesSdefC;\nattribute vec3 matricesSdefR0;\nattribute vec3 matricesSdefR1;\n\nvec4 rotationMatrixToQuaternion(mat3 matrix) {\n    float trace = matrix[0][0] + matrix[1][1] + matrix[2][2];\n    float s;\n\n    float sqrtParam;\n    if (trace > 0.0) {\n        sqrtParam = trace + 1.0;\n    } else if (matrix[0][0] > matrix[1][1] && matrix[0][0] > matrix[2][2]) {\n        sqrtParam = 1.0 + matrix[0][0] - matrix[1][1] - matrix[2][2];\n    } else if (matrix[1][1] > matrix[2][2]) {\n        sqrtParam = 1.0 + matrix[1][1] - matrix[0][0] - matrix[2][2];\n    } else {\n        sqrtParam = 1.0 + matrix[2][2] - matrix[0][0] - matrix[1][1];\n    }\n    float sqrtValue = sqrt(sqrtParam);\n\n    if (trace > 0.0) {\n        s = 0.5 / sqrtValue;\n\n        return vec4(\n            (matrix[1][2] - matrix[2][1]) * s,\n            (matrix[2][0] - matrix[0][2]) * s,\n            (matrix[0][1] - matrix[1][0]) * s,\n            0.25 / s\n        );\n    } else if (matrix[0][0] > matrix[1][1] && matrix[0][0] > matrix[2][2]) {\n        s = 2.0 * sqrtValue;\n\n        return vec4(\n            0.25 * s,\n            (matrix[0][1] + matrix[1][0]) / s,\n            (matrix[2][0] + matrix[0][2]) / s,\n            (matrix[1][2] - matrix[2][1]) / s\n        );\n    } else if (matrix[1][1] > matrix[2][2]) {\n        s = 2.0 * sqrtValue;\n        \n        return vec4(\n            (matrix[0][1] + matrix[1][0]) / s,\n            0.25 * s,\n            (matrix[1][2] + matrix[2][1]) / s,\n            (matrix[2][0] - matrix[0][2]) / s\n        );\n    } else {\n        s = 2.0 * sqrtValue;\n\n        return vec4(\n            (matrix[2][0] + matrix[0][2]) / s,\n            (matrix[1][2] + matrix[2][1]) / s,\n            0.25 * s,\n            (matrix[0][1] - matrix[1][0]) / s\n        );\n    }\n}\n\nmat3 quaternionToRotationMatrix(vec4 q) {\n    float xx = q.x * q.x;\n    float yy = q.y * q.y;\n    float zz = q.z * q.z;\n    float xy = q.x * q.y;\n    float zw = q.z * q.w;\n    float zx = q.z * q.x;\n    float yw = q.y * q.w;\n    float yz = q.y * q.z;\n    float xw = q.x * q.w;\n\n    return mat3(\n        1.0 - 2.0 * (yy + zz), 2.0 * (xy + zw), 2.0 * (zx - yw),\n        2.0 * (xy - zw), 1.0 - 2.0 * (zz + xx), 2.0 * (yz + xw),\n        2.0 * (zx + yw), 2.0 * (yz - xw), 1.0 - 2.0 * (yy + xx)\n    );\n}\n\nvec4 slerp(vec4 q0, vec4 q1, float t) {\n    float cosTheta = dot(q0, q1);\n\n    // if (cosTheta < 0.0) {\n    //     q1 = -q1;\n    //     cosTheta = -cosTheta;\n    // }\n    q1 = mix(-q1, q1, step(0.0, cosTheta));\n    cosTheta = abs(cosTheta);\n    \n    if (cosTheta > 0.999999) {\n        return normalize(mix(q0, q1, t));\n    }\n\n    float theta = acos(cosTheta);\n    float sinTheta = sin(theta);\n\n    float w0 = sin((1.0 - t) * theta) / sinTheta;\n    float w1 = sin(t * theta) / sinTheta;\n\n    return q0 * w0 + q1 * w1;\n}\n#endif\n\n#endif\n",Lh="\n#ifndef SDEFVERTEX\n#define SDEFVERTEX\n\n#if !defined(BAKED_VERTEX_ANIMATION_TEXTURE) && defined(SDEF)\n\n#if NUM_BONE_INFLUENCERS > 0\n{\n    float weight0 = matricesWeights[0];\n    float weight1 = matricesWeights[1];\n\n    #ifdef BONETEXTURE\n        mat4 transformMatrix0 = readMatrixFromRawSampler(boneSampler, matricesIndices[0]);\n        mat4 transformMatrix1 = readMatrixFromRawSampler(boneSampler, matricesIndices[1]);\n    #else\n        mat4 transformMatrix0 = mBones[int(matricesIndices[0])];\n        mat4 transformMatrix1 = mBones[int(matricesIndices[1])];\n    #endif\n\n    mat3 slerpedRotationMatrix = quaternionToRotationMatrix(slerp(\n        rotationMatrixToQuaternion(mat3(transformMatrix0)), \n        rotationMatrixToQuaternion(mat3(transformMatrix1)),\n        weight1\n    ));\n\n    // -center transform\n    mat4 sdefInflunce = mat4(\n        vec4(1.0, 0.0, 0.0, 0.0),\n        vec4(0.0, 1.0, 0.0, 0.0),\n        vec4(0.0, 0.0, 1.0, 0.0),\n        vec4(-matricesSdefC, 1.0)\n    );\n\n    // rotation\n    mat4 rotationMatrix = mat4(\n        vec4(slerpedRotationMatrix[0], 0.0),\n        vec4(slerpedRotationMatrix[1], 0.0),\n        vec4(slerpedRotationMatrix[2], 0.0),\n        vec4(0.0, 0.0, 0.0, 1.0)\n    );\n    sdefInflunce = rotationMatrix * sdefInflunce;\n\n    // add position offset\n    vec3 positionOffset =\n        vec3(transformMatrix0 * vec4(matricesSdefR0, 1)) * weight0 +\n        vec3(transformMatrix1 * vec4(matricesSdefR1, 1)) * weight1;\n\n    sdefInflunce[3] += vec4(positionOffset, 0.0);\n    \n    float useLinearDeform = step(0.0, -abs(matricesSdefR0.x));\n\n    influence = mat4(\n        mix(sdefInflunce[0], influence[0], useLinearDeform),\n        mix(sdefInflunce[1], influence[1], useLinearDeform),\n        mix(sdefInflunce[2], influence[2], useLinearDeform),\n        mix(sdefInflunce[3], influence[3], useLinearDeform)\n    );\n}\n#endif\n\n#endif\n\n#endif\n";class wh extends Wt{SPHERE_TEXTURE=!1;SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1;SPHERE_TEXTURE_BLEND_MODE_ADD=!1;TOON_TEXTURE=!1;IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1;TEXTURE_COLOR=!1;SPHERE_TEXTURE_COLOR=!1;TOON_TEXTURE_COLOR=!1;SDEF=!1}var Bh,Uh,kh;!function(e){e[e.Multiply=1]="Multiply",e[e.Add=2]="Add"}(Bh||(Bh={}));class Vh extends Bs{_sphereTexture=null;_sphereTextureBlendMode=Bh.Add;_toonTexture=null;_ignoreDiffuseWhenToonTextureIsNull=!1;textureColor=new Ie(1,1,1,1);sphereTextureColor=new Ie(1,1,1,1);toonTextureColor=new Ie(1,1,1,1);_useTextureColor=!1;_useSphereTextureColor=!1;_useToonTextureColor=!1;_isEnabled=!1;get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this.markAllDefinesAsDirty(),this._enable(e))}get sphereTexture(){return this._sphereTexture}set sphereTexture(e){this._sphereTexture!==e&&(this._sphereTexture=e,this.markAllSubMeshesAsTexturesDirty())}get sphereTextureBlendMode(){return this._sphereTextureBlendMode}set sphereTextureBlendMode(e){this._sphereTextureBlendMode!==e&&(this._sphereTextureBlendMode=e,this.markAllDefinesAsDirty())}get toonTexture(){return this._toonTexture}set toonTexture(e){this._toonTexture!==e&&(this._toonTexture=e,this.markAllSubMeshesAsTexturesDirty())}get ignoreDiffuseWhenToonTextureIsNull(){return this._ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._ignoreDiffuseWhenToonTextureIsNull!==e&&(this._ignoreDiffuseWhenToonTextureIsNull=e,this.markAllDefinesAsDirty())}get useTextureColor(){return this._useTextureColor}set useTextureColor(e){this._useTextureColor!==e&&(this._useTextureColor=e,this.markAllDefinesAsDirty())}get useSphereTextureColor(){return this._useSphereTextureColor}set useSphereTextureColor(e){this._useSphereTextureColor!==e&&(this._useSphereTextureColor=e,this.markAllDefinesAsDirty())}get useToonTextureColor(){return this._useToonTextureColor}set useToonTextureColor(e){this._useToonTextureColor!==e&&(this._useToonTextureColor=e,this.markAllDefinesAsDirty())}_internalMarkAllSubMeshesAsTexturesDirty;markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"MmdMaterial",100,new wh,t),this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[Dh.MATERIAL_TextureDirtyFlag]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._sphereTexture&&!this._sphereTexture.isReadyOrNotBlocking())}bindForSubMesh(e,t,i,s){if(!this._isEnabled)return;const n=s.materialDefines,r=this._material.isFrozen;e.useUbo&&r&&e.isSync||(n.DIFFUSE&&n.TEXTURE_COLOR&&e.updateDirectColor4("textureColor",this.textureColor),n.NORMAL&&n.SPHERE_TEXTURE&&n.SPHERE_TEXTURE_COLOR&&e.updateDirectColor4("sphereTextureColor",this.sphereTextureColor),n.TOON_TEXTURE&&n.TOON_TEXTURE_COLOR&&e.updateDirectColor4("toonTextureColor",this.toonTextureColor),n.SPHERE_TEXTURE&&null!==s.effect&&this._material.bindView(s.effect)),t.texturesEnabled&&(n.NORMAL&&this._sphereTexture&&e.setTexture("sphereSampler",this._sphereTexture),this._toonTexture&&e.setTexture("toonSampler",this._toonTexture))}dispose(e){e&&(this._sphereTexture?.dispose(),this._toonTexture?.dispose())}getCustomCode(e){if("vertex"===e){const e={};return e.CUSTOM_VERTEX_DEFINITIONS=Fh,e[`!${this._escapeRegExp("finalWorld=finalWorld*influence;")}`]=`\n                ${Lh}\n                \n                finalWorld = finalWorld * influence;\n            `,e}if("fragment"===e){const e={CUSTOM_FRAGMENT_DEFINITIONS:"\n                #if defined(SPHERE_TEXTURE) && defined(NORMAL)\n                    uniform sampler2D sphereSampler;\n                #endif\n                #ifdef TOON_TEXTURE\n                    uniform sampler2D toonSampler;\n                #endif\n            ",CUSTOM_FRAGMENT_MAIN_BEGIN:"\n                #ifdef TOON_TEXTURE\n                    vec3 toonNdl;\n                #endif\n            "};return e[`!${this._escapeRegExp("#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif")}`]="\n                #if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\n                    uniform mat4 view;\n                #elif defined(NORMAL) && defined(SPHERE_TEXTURE)\n                    uniform mat4 view;\n                #endif\n            ",e[`!${this._escapeRegExp("baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);")}`]="\n                #if defined(DIFFUSE) && defined(TEXTURE_COLOR)\n                    baseColor = texture2D(diffuseSampler, vDiffuseUV + uvOffset) * textureColor;\n                #else\n                    baseColor = texture2D(diffuseSampler, vDiffuseUV + uvOffset);\n                #endif\n            ",e[`!${this._escapeRegExp("struct lightingInfo\n{")}`]="\n                struct lightingInfo {\n                #ifdef TOON_TEXTURE\n                    #if !defined(NDOTL)\n                        float ndl;\n                    #endif\n                    float isToon;\n                #endif\n            ",e[`!${this._escapeRegExp("result.diffuse=ndl*diffuseColor*attenuation;")}`]="\n                #ifdef TOON_TEXTURE\n                    result.diffuse = diffuseColor * attenuation;\n                    result.ndl = ndl;\n                    result.isToon = 1.0;\n                #elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED)   \n                    result.diffuse = diffuseColor * attenuation;\n                #else\n                    result.diffuse = ndl * diffuseColor * attenuation;\n                #endif\n            ",e[`!${this._escapeRegExp("diffuseBase+=info.diffuse*shadow;")}`]="\n                #ifdef TOON_TEXTURE\n                    toonNdl = vec3(clamp(info.ndl * shadow, 0.02, 0.98));\n                    toonNdl.r = texture2D(toonSampler, vec2(0.5, toonNdl.r)).r;\n                    toonNdl.g = texture2D(toonSampler, vec2(0.5, toonNdl.g)).g;\n                    toonNdl.b = texture2D(toonSampler, vec2(0.5, toonNdl.b)).b;\n\n                    #ifdef TOON_TEXTURE_COLOR\n                        toonNdl *= toonTextureColor.rgb * toonTextureColor.a;\n                    #endif\n\n                    diffuseBase += mix(info.diffuse * shadow, toonNdl * info.diffuse, info.isToon);\n                #elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED)\n                    diffuseBase += info.diffuse;\n                #else\n                    diffuseBase += info.diffuse * shadow;\n                #endif\n            ",e.CUSTOM_FRAGMENT_BEFORE_FOG="\n                #if defined(NORMAL) && defined(SPHERE_TEXTURE)\n                    vec3 viewSpaceNormal = normalize(mat3(view) * vNormalW);\n\n                    vec2 sphereUV = viewSpaceNormal.xy * 0.5 + 0.5;\n\n                    vec4 sphereReflectionColor = texture2D(sphereSampler, sphereUV);\n                    #ifdef SPHERE_TEXTURE_COLOR\n                        sphereReflectionColor *= sphereTextureColor;\n                    #endif\n                    sphereReflectionColor.rgb *= diffuseBase;\n\n                    #ifdef SPHERE_TEXTURE_BLEND_MODE_MULTIPLY\n                        color *= sphereReflectionColor;\n                    #elif defined(SPHERE_TEXTURE_BLEND_MODE_ADD)\n                        color += vec4(sphereReflectionColor.rgb, sphereReflectionColor.a * alpha);\n                    #endif\n                #endif\n            ",e}return null}prepareDefines(e,t,i){if(this._isEnabled){const s=t.texturesEnabled;e.SPHERE_TEXTURE=null!==this._sphereTexture&&s,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=this._sphereTextureBlendMode===Bh.Multiply,e.SPHERE_TEXTURE_BLEND_MODE_ADD=this._sphereTextureBlendMode===Bh.Add,e.TOON_TEXTURE=null!==this._toonTexture&&s,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=this._ignoreDiffuseWhenToonTextureIsNull,e.TEXTURE_COLOR=this._useTextureColor,e.SPHERE_TEXTURE_COLOR=this._useSphereTextureColor,e.TOON_TEXTURE_COLOR=this._useToonTextureColor,e.SDEF=!!(i.useBones&&i.computeBonesUsingShaders&&i.skeleton)}else e.SPHERE_TEXTURE=!1,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1,e.SPHERE_TEXTURE_BLEND_MODE_ADD=!1,e.TOON_TEXTURE=!1,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1,e.TEXTURE_COLOR=!1,e.SPHERE_TEXTURE_COLOR=!1,e.TOON_TEXTURE_COLOR=!1,e.SDEF=!1}hasTexture(e){return this._sphereTexture===e||this._toonTexture===e}getActiveTextures(e){this._sphereTexture&&e.push(this._sphereTexture),this._toonTexture&&e.push(this._toonTexture)}getAnimatables(e){this._sphereTexture&&this._sphereTexture.animations&&0<this._sphereTexture.animations.length&&e.push(this._sphereTexture),this._toonTexture&&this._toonTexture.animations&&0<this._toonTexture.animations.length&&e.push(this._toonTexture)}getSamplers(e){e.push("sphereSampler","toonSampler")}getAttributes(e,t,i){this._isEnabled&&i.useBones&&i.computeBonesUsingShaders&&i.skeleton&&i.isVerticesDataPresent(Nh.MatricesSdefCKind)&&(e.push(Nh.MatricesSdefCKind),e.push(Nh.MatricesSdefR0Kind),e.push(Nh.MatricesSdefR1Kind))}getUniforms(){return{ubo:[{name:"textureColor",size:4,type:"vec4"},{name:"sphereTextureColor",size:4,type:"vec4"},{name:"toonTextureColor",size:4,type:"vec4"}],fragment:"\n                #if defined(DIFFUSE) && defined(TEXTURE_COLOR)\n                    uniform vec4 textureColor;\n                #endif\n                #if defined(SPHERE_TEXTURE) && defined(SPHERE_TEXTURE_COLOR)\n                    uniform vec4 sphereTextureColor;\n                #endif\n                #if defined(TOON_TEXTURE) && defined(TOON_TEXTURE_COLOR)\n                    uniform vec4 toonTextureColor;\n                #endif\n            "}}getClassName(){return"MmdPluginMaterial"}_escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class Gh extends zs{_pluginMaterial;renderOutline=!1;outlineWidth=.01;outlineColor=new Re(0,0,0);outlineAlpha=1;constructor(e,t){super(e,t),this.specularColor=new Re(0,0,0);const i=this._pluginMaterial=new Vh(this);i.isEnabled=!0,i.ignoreDiffuseWhenToonTextureIsNull=!0}get sphereTexture(){return this._pluginMaterial.sphereTexture}set sphereTexture(e){this._pluginMaterial.sphereTexture=e}get sphereTextureBlendMode(){return this._pluginMaterial.sphereTextureBlendMode}set sphereTextureBlendMode(e){this._pluginMaterial.sphereTextureBlendMode=e}get toonTexture(){return this._pluginMaterial.toonTexture}set toonTexture(e){this._pluginMaterial.toonTexture=e}get ignoreDiffuseWhenToonTextureIsNull(){return this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull=e}get textureColor(){return this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureColor}set textureColor(e){this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureColor=e}get sphereTextureColor(){return this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureColor}set sphereTextureColor(e){this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureColor=e}get toonTextureColor(){return this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureColor}set toonTextureColor(e){this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureColor=e}}!function(e){let t,i,s,n,r,o,a,l,h;!function(e){let t;!function(e){e[e.Utf16le=0]="Utf16le",e[e.Utf8=1]="Utf8",e[e.ShiftJis=2]="ShiftJis"}(t=e.Encoding||(e.Encoding={}))}(t=e.Header||(e.Header={})),function(e){let t;!function(e){e[e.Bdef1=0]="Bdef1",e[e.Bdef2=1]="Bdef2",e[e.Bdef4=2]="Bdef4",e[e.Sdef=3]="Sdef",e[e.Qdef=4]="Qdef"}(t=e.BoneWeightType||(e.BoneWeightType={}))}(i=e.Vertex||(e.Vertex={})),function(e){let t,i;!function(e){e[e.IsDoubleSided=1]="IsDoubleSided",e[e.EnabledGroundShadow=2]="EnabledGroundShadow",e[e.EnabledDrawShadow=4]="EnabledDrawShadow",e[e.EnabledReceiveShadow=8]="EnabledReceiveShadow",e[e.EnabledToonEdge=16]="EnabledToonEdge",e[e.EnabledVertexColor=32]="EnabledVertexColor",e[e.EnabledPointDraw=64]="EnabledPointDraw",e[e.EnabledLineDraw=128]="EnabledLineDraw"}(t=e.Flag||(e.Flag={})),function(e){e[e.Off=0]="Off",e[e.Multiply=1]="Multiply",e[e.Add=2]="Add",e[e.SubTexture=3]="SubTexture"}(i=e.SphereTextureMode||(e.SphereTextureMode={}))}(s=e.Material||(e.Material={})),function(e){let t;!function(e){e[e.UseBoneIndexAsTailPosition=1]="UseBoneIndexAsTailPosition",e[e.IsRotatable=2]="IsRotatable",e[e.IsMovable=4]="IsMovable",e[e.IsVisible=8]="IsVisible",e[e.IsControllable=16]="IsControllable",e[e.IsIkEnabled=32]="IsIkEnabled",e[e.LocalAppendTransform=128]="LocalAppendTransform",e[e.HasAppendRotate=256]="HasAppendRotate",e[e.HasAppendMove=512]="HasAppendMove",e[e.HasAxisLimit=1024]="HasAxisLimit",e[e.HasLocalVector=2048]="HasLocalVector",e[e.TransformAfterPhysics=4096]="TransformAfterPhysics",e[e.IsExternalParentTransformed=8192]="IsExternalParentTransformed"}(t=e.Flag||(e.Flag={}))}(n=e.Bone||(e.Bone={})),function(e){let t,i,s;!function(e){e[e.System=0]="System",e[e.Eyebrow=1]="Eyebrow",e[e.Eye=2]="Eye",e[e.Lip=3]="Lip",e[e.Other=4]="Other"}(t=e.Category||(e.Category={})),function(e){e[e.GroupMorph=0]="GroupMorph",e[e.VertexMorph=1]="VertexMorph",e[e.BoneMorph=2]="BoneMorph",e[e.UvMorph=3]="UvMorph",e[e.AdditionalUvMorph1=4]="AdditionalUvMorph1",e[e.AdditionalUvMorph2=5]="AdditionalUvMorph2",e[e.AdditionalUvMorph3=6]="AdditionalUvMorph3",e[e.AdditionalUvMorph4=7]="AdditionalUvMorph4",e[e.MaterialMorph=8]="MaterialMorph",e[e.FlipMorph=9]="FlipMorph",e[e.ImpulseMorph=10]="ImpulseMorph"}(i=e.Type||(e.Type={})),function(e){let t;!function(e){e[e.Multiply=0]="Multiply",e[e.Add=1]="Add"}(t=e.Type||(e.Type={}))}(s=e.MaterialMorph||(e.MaterialMorph={}))}(r=e.Morph||(e.Morph={})),function(e){let t;!function(e){let t;!function(e){e[e.Bone=0]="Bone",e[e.Morph=1]="Morph"}(t=e.FrameType||(e.FrameType={}))}(t=e.FrameData||(e.FrameData={}))}(o=e.DisplayFrame||(e.DisplayFrame={})),function(e){let t,i;!function(e){e[e.Sphere=0]="Sphere",e[e.Box=1]="Box",e[e.Capsule=2]="Capsule"}(t=e.ShapeType||(e.ShapeType={})),function(e){e[e.FollowBone=0]="FollowBone",e[e.Physics=1]="Physics",e[e.PhysicsWithBone=2]="PhysicsWithBone"}(i=e.PhysicsMode||(e.PhysicsMode={}))}(a=e.RigidBody||(e.RigidBody={})),function(e){let t;!function(e){e[e.Spring6dof=0]="Spring6dof",e[e.Sixdof=1]="Sixdof",e[e.P2p=2]="P2p",e[e.ConeTwist=3]="ConeTwist",e[e.Slider=4]="Slider",e[e.Hinge=5]="Hinge"}(t=e.Type||(e.Type={}))}(l=e.Joint||(e.Joint={})),function(e){let t,i,s;!function(e){e[e.TriMesh=0]="TriMesh",e[e.Rope=1]="Rope"}(t=e.Type||(e.Type={})),function(e){e[e.Blink=1]="Blink",e[e.ClusterCreation=2]="ClusterCreation",e[e.LinkCrossing=4]="LinkCrossing"}(i=e.Flag||(e.Flag={})),function(e){e[e.VertexPoint=0]="VertexPoint",e[e.VertexTwoSided=1]="VertexTwoSided",e[e.VertexOneSided=2]="VertexOneSided",e[e.FaceTwoSided=3]="FaceTwoSided",e[e.FaceOneSided=4]="FaceOneSided"}(s=e.AeroDynamicModel||(e.AeroDynamicModel={}))}(h=e.SoftBody||(e.SoftBody={}))}(Uh||(Uh={}));class zh{files;_fileMap=new Map;constructor(e,t,i){if(t=this._pathNormalize(t),this.files=e,0!==e.length)if(e[0]instanceof File)for(const s of e){const e=this._pathNormalize(s.webkitRelativePath);if(!e.startsWith(t))continue;const n=i+e.slice(t.length);this._fileMap.set(this._pathNormalize(n),s)}else for(const t of e){const e=i+t.relativePath;this._fileMap.set(this._pathNormalize(e),t)}}resolve(e){const t=this._pathNormalize(e);return this._fileMap.get(t)}_pathNormalize(e){return e.replace(/\\/g,"/").toUpperCase()}}!function(e){e[e.Opaque=Ps.MATERIAL_OPAQUE]="Opaque",e[e.AlphaTest=Ps.MATERIAL_ALPHATEST]="AlphaTest",e[e.AlphaBlend=Ps.MATERIAL_ALPHABLEND]="AlphaBlend"}(kh||(kh={}));class Hh{texture;onLoadObservable;constructor(){this.texture=null,this.onLoadObservable=new s}awaitLoad(){return new Promise((e=>{null!==this.texture?e(this):this.onLoadObservable.addOnce((()=>e(this)))}))}}class Wh{_resolution;_textureCache;_context;_vertexShader;_fragmentShader;_program;_uvBuffer;_indexBuffer;_indicesBytePerElement;constructor(e,t,i=512){this._resolution=i,this._textureCache=new Map,this._context=this._createRenderingContext(),this._vertexShader=null,this._fragmentShader=null,this._program=null,this._uvBuffer=null,this._indexBuffer=null,this._indicesBytePerElement=t.BYTES_PER_ELEMENT,!1!==this._prepareContext()&&!1!==this._bindUvAndIndexBuffer(e,t)||this.dispose()}_createRenderingContext(){const e=document.createElement("canvas");return e.width=this._resolution,e.height=this._resolution,e.getContext("webgl2",{alpha:!1,antialias:!1,depth:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1})}_prepareContext(){if(null===this._context)return!1;const e=this._context;e.clearColor(0,0,0,0);const t=this._vertexShader=e.createShader(e.VERTEX_SHADER);if(null===t)return!1;if(e.shaderSource(t,"\n            precision highp float;\n            attribute vec2 uv;\n            varying vec2 vUv;\n\n            void main() {\n                vUv = uv;\n                gl_Position = vec4(uv * 2.0 - 1.0, 0.0, 1.0);\n            }\n        "),e.compileShader(t),!e.getShaderParameter(t,e.COMPILE_STATUS))return console.error(e.getShaderInfoLog(t)),!1;const i=this._fragmentShader=e.createShader(e.FRAGMENT_SHADER);if(null===i)return!1;const s=`\n            precision highp float;\n            uniform sampler2D texture;\n            varying vec2 vUv;\n\n            void main() {\n                vec2 onePixel = vec2(1.0 / ${this._resolution.toFixed(1)});\n\n                float minAlpha = 1.0;\n                for (int i = 0; i < 2; ++i) {\n                    for (int j = 0; j < 2; ++j) {\n                        float alpha = texture2D(texture, vUv + vec2(onePixel.x * float(i), onePixel.y * float(j))).a;\n                        minAlpha = min(minAlpha, alpha);\n                    }\n                }\n                gl_FragColor = vec4(vec3(1.0) - minAlpha, 1.0);\n            }\n        `;if(e.shaderSource(i,s),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS))return console.error(e.getShaderInfoLog(i)),!1;const n=this._program=e.createProgram();return null!==n&&(e.attachShader(n,t),e.attachShader(n,i),e.linkProgram(n),e.getProgramParameter(n,e.LINK_STATUS)?(e.useProgram(n),!0):(console.error(e.getProgramInfoLog(n)),!1))}async _getWebGlTexture(e,t){const i=this._context;if(null===i)return null;const s=this._textureCache.get(e);if(void 0!==s)return await s.awaitLoad(),s.texture;const n=new Hh;this._textureCache.set(e,n);let r,o=null,a=!1;if(o=await new Promise((t=>{const i=new Image;i.onload=()=>{a=!0,t(i)},i.onerror=()=>{URL.revokeObjectURL(i.src),t(null)},i.src=URL.createObjectURL(new Blob([e]))})),null!==o?r={width:o.width,height:o.height}:null!==t&&(t.isReady()||await new Promise((e=>{t.onLoadObservable.addOnce((()=>{e()}))})),r=t.getSize(),o=await t.readPixels(0,0,void 0,!1,!1,0,0,r.width,r.height)),null===o)return null;const l=i.createTexture();return null===l?null:(i.bindTexture(i.TEXTURE_2D,l),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,r.width,r.height,0,i.RGBA,i.UNSIGNED_BYTE,o),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,1),a&&URL.revokeObjectURL(o.src),n.texture=l,n.onLoadObservable.notifyObservers(),l)}_bindUvAndIndexBuffer(e,t){const i=this._context;if(null===i)return!1;const s=this._program;if(null===s)return!1;const n=this._uvBuffer=i.createBuffer();if(null===n)return!1;i.bindBuffer(i.ARRAY_BUFFER,n),i.bufferData(i.ARRAY_BUFFER,e,i.STATIC_DRAW);const r=i.getAttribLocation(s,"uv");i.enableVertexAttribArray(r),i.vertexAttribPointer(r,2,i.FLOAT,!1,0,0);const o=this._indexBuffer=i.createBuffer();return null!==o&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,o),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t,i.STATIC_DRAW),!0)}async textureHasAlphaOnGeometry(e,t,i,s,n,r){const o=this._context;if(null===o)return kh.Opaque;const a=this._program;if(null===a)return kh.Opaque;const l=await this._getWebGlTexture(e,t);if(null===l)return kh.Opaque;o.clear(o.COLOR_BUFFER_BIT);const h=o.getUniformLocation(a,"texture");o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,l),o.uniform1i(h,0),o.drawElements(o.TRIANGLES,s,2===this._indicesBytePerElement?o.UNSIGNED_SHORT:o.UNSIGNED_INT,i*this._indicesBytePerElement);const c=this._resolution,d=new Uint8Array(c*c*4);o.readPixels(0,0,c,c,o.RGBA,o.UNSIGNED_BYTE,d);let u=0,_=0,f=0;for(let e=0;e<c;e+=2)for(let t=0;t<c;t+=2){const i=d[4*(e*c+t)];u=Math.max(u,i),0<i&&i<255&&(_+=i,f+=1)}return 0!==f&&(_/=f),u<n?kh.Opaque:_+r<u?kh.AlphaTest:kh.AlphaBlend}dispose(){const e=this._context;if(null!==e){e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindTexture(e.TEXTURE_2D,null),e.useProgram(null),e.deleteBuffer(this._uvBuffer),e.deleteBuffer(this._indexBuffer);for(const t of this._textureCache.values())e.deleteTexture(t.texture);e.deleteProgram(this._program),e.deleteShader(this._vertexShader),e.deleteShader(this._fragmentShader),this._context=null,this._vertexShader=null,this._fragmentShader=null,this._program=null,this._uvBuffer=null,this._indexBuffer=null}}}class Xh{static EdgeSizeScaleFactor=.01;alphaThreshold=195;alphaBlendThreshold=100;useAlphaEvaluation=!0;alphaEvaluationResolution=512;_textureLoader=new Oh;buildMaterials(e,t,i,s,n,r,o,a,l,h,c,d,u,_){const f=o.blockMaterialDirtyMechanism;o._forceBlockMaterialDirtyMechanism(!0);let p=null;const m=()=>null!==p?p:this.useAlphaEvaluation?p=new Wh(h,l,this.alphaEvaluationResolution):null,g=new zh(r,s,n),v=[],T={lengthComputable:!0,loaded:0,total:3*t.length},b=()=>{T.loaded+=1,u?.(T)};let E=0;for(let r=0;r<t.length;++r){const l=t[r];o._blockEntityCollection=!!a;const h=new Gh(l.name,o);h._parentContainer=a,o._blockEntityCollection=!1,a?.materials.push(h);{const t=[],u=this.loadGeneralScalarProperties(h,l);void 0!==u&&t.push(u);const _=this.loadDiffuseTexture(e,h,l,i,o,a,s,n,g,E,d,m,b);void 0!==_&&t.push(_);const f=this.loadSphereTexture(e,h,l,i,o,a,s,n,g,d,b);void 0!==f&&t.push(f);const p=this.loadToonTexture(e,h,l,i,o,a,s,n,g,d,b);void 0!==p&&t.push(p);const T=this.loadOutlineRenderingProperties(h,l,d);void 0!==T&&t.push(T),v.push(...t),Promise.all(t).then((()=>{this.afterBuildSingleMaterial(h,r,l,c,i,o,s)}))}c.subMaterials.push(h),E+=l.surfaceCount}this._textureLoader.loadModelTexturesEnd(e);const S=this._textureLoader.onModelTextureLoadedObservable.get(e);void 0!==S?S.addOnce((()=>{Promise.all(v).then((()=>{p?.dispose(),o._forceBlockMaterialDirtyMechanism(f),_?.()}))})):Promise.all(v).then((()=>{p?.dispose(),o._forceBlockMaterialDirtyMechanism(f),_?.()}))}loadGeneralScalarProperties=(e,t)=>{const i=t.diffuse;e.diffuseColor=new Re(i[0],i[1],i[2]);const s=t.specular;e.specularColor=new Re(s[0],s[1],s[2]);const n=t.ambient;e.ambientColor=new Re(n[0],n[1],n[2]);const r=t.diffuse[3];e.alpha=r,e.specularPower=t.shininess};loadDiffuseTexture=async(e,t,i,s,n,r,o,a,l,h,c,d,u)=>{t.backFaceCulling=!(i.flag&Uh.Material.Flag.IsDoubleSided);const _=s[i.textureIndex];if(void 0!==_){const s=a+_;let f;const p=l.resolve(s);f=void 0!==p?await this._textureLoader.loadTextureFromBufferAsync(e,s,p instanceof File?p:p.data,n,r):await this._textureLoader.loadTextureAsync(e,o,_,n,r);const m=f.texture;if(null!==m){t.diffuseTexture=m;let e=Number.MAX_SAFE_INTEGER;const s=i.evauatedTransparency;if(void 0!==s&&-1!==s)e=s;else{const t=d();null!==t&&(e=await t.textureHasAlphaOnGeometry(f.arrayBuffer,f.texture,h,i.surfaceCount,this.alphaThreshold,this.alphaBlendThreshold))}if(e!==Number.MAX_SAFE_INTEGER){const i=e!==Ps.MATERIAL_OPAQUE;i&&(m.hasAlpha=!0),t.useAlphaFromDiffuseTexture=i,t.transparencyMode=e,i&&(t.backFaceCulling=!1)}u?.()}else c.error(`Failed to load diffuse texture: ${s}`),u?.()}else u?.()};loadSphereTexture=async(e,t,i,s,n,r,o,a,l,h,c)=>{if(i.sphereTextureMode!==Uh.Material.SphereTextureMode.Off){const d=s[i.sphereTextureIndex];if(void 0!==d){const s=a+d;let u;const _=l.resolve(s);u=void 0!==_?(await this._textureLoader.loadTextureFromBufferAsync(e,s,_ instanceof File?_:_.data,n,r)).texture:(await this._textureLoader.loadTextureAsync(e,o,d,n,r)).texture,null!==u?(t.sphereTexture=u,t.sphereTextureBlendMode=1===i.sphereTextureMode?Bh.Multiply:Bh.Add):h.error(`Failed to load sphere texture: ${s}`),c?.()}else c?.()}else c?.()};loadToonTexture=async(e,t,i,s,n,r,o,a,l,h,c)=>{let d;if(d=i.isSharedToonTexture?-1===i.toonTextureIndex?void 0:i.toonTextureIndex:s[i.toonTextureIndex],void 0!==d){const i=a+d;let s;const u="string"==typeof d?l.resolve(i):void 0;s=void 0!==u?(await this._textureLoader.loadTextureFromBufferAsync(e,i,u instanceof File?u:u.data,n,r)).texture:(await this._textureLoader.loadTextureAsync(e,o,d,n,r)).texture,null!==s?t.toonTexture=s:h.error(`Failed to load toon texture: ${i}`),c?.()}else c?.()};loadOutlineRenderingProperties=(e,t,i)=>{if(t.flag&Uh.Material.Flag.EnabledToonEdge){void 0===Oi.prototype.getMmdOutlineRenderer&&i.warn('MMD Outline Renderer is not available. Please import "babylon-mmd/esm/Loader/mmdOutlineRenderer".'),e.renderOutline=!0,e.outlineWidth=t.edgeSize*Xh.EdgeSizeScaleFactor;const s=t.edgeColor;e.outlineColor=new Re(s[0],s[1],s[2]),e.outlineAlpha=s[3]}};afterBuildSingleMaterial=()=>{}}class Qh{lengthComputable;total;_onProgress;_unprocessedTasks;_processingTasks;_endedTaskNames;_endedTasksTotal;constructor(e,t,i){this.lengthComputable=e;let s=0;for(let e=0;e<t.length;++e)s+=t[e].cost;this.total=s,this._onProgress=i;const n=this._unprocessedTasks=new Map;for(let e=0;e<t.length;++e){if(n.has(t[e].name))throw new Error(`Duplicated task name: ${t[e].name}`);n.set(t[e].name,t[e])}this._processingTasks=new Map,this._endedTaskNames=new Set,this._endedTasksTotal=0}_getTaskState(e){let t=this._processingTasks.get(e);if(void 0===t){const i=this._unprocessedTasks.get(e);if(void 0===i){if(this._endedTaskNames.has(e))return null;throw new Error(`Task not found: ${e}`)}t={name:i.name,cost:i.cost,progress:0},this._processingTasks.set(e,t),this._unprocessedTasks.delete(e)}return t}processTask(e,t){const i=this._getTaskState(e);null!==i&&(i.progress+=t,i.progress>=i.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=i.cost))}setTaskProgress(e,t){const i=this._getTaskState(e);return null!==i&&(i.progress=t,i.progress>=i.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=i.cost),!0)}setTaskProgressRatio(e,t,i){const s=this._getTaskState(e);return null!==s&&(s.progress=i?Math.floor(s.cost*t):s.cost*t,s.progress>=s.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=s.cost),!0)}endTask(e){const t=this._getTaskState(e);null!==t&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=t.cost)}invokeProgressEvent(){null!==this._onProgress&&this._onProgress({lengthComputable:this.lengthComputable,loaded:this.loaded,total:this.total})}get loaded(){let e=this._endedTasksTotal;for(const[t,i]of this._processingTasks)e+=i.progress;return e}}class Yh extends jn{applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId===this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(Oe.PositionKind))return this;if(!this.isVerticesDataPresent(Oe.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(Oe.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(Oe.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(Oe.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let n=this.getVerticesData(Oe.NormalKind);if(t){if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n))}const r=this.isVerticesDataPresent(Nh.MatricesSdefCKind);let o=null,a=null,l=null;r&&(o=this.getVerticesData(Nh.MatricesSdefCKind),a=this.getVerticesData(Nh.MatricesSdefR0Kind),l=this.getVerticesData(Nh.MatricesSdefR1Kind));const h=this.getVerticesData(Oe.MatricesIndicesKind),c=this.getVerticesData(Oe.MatricesWeightsKind);if(!c||!h)return this;const d=this.numBoneInfluencers>4,u=d?this.getVerticesData(Oe.MatricesIndicesExtraKind):null,_=d?this.getVerticesData(Oe.MatricesWeightsExtraKind):null,f=e.getTransformMatrices(this),p=me.Zero(),m=new Te,g=new Te,v=new Te,T=new Te,b=new ve,E=new ve,S=new me,x=i._sourcePositions,C=i._sourceNormals;let y,A=0;for(let e=0;e<s.length;e+=3,A+=4){let i=0;if(r&&(i=a[e]),0===i){let i;for(y=0;y<4;y++)i=c[A+y],i>0&&(Te.FromFloat32ArrayToRefScaled(f,Math.floor(16*h[A+y]),i,g),m.addToSelf(g));if(d)for(y=0;y<4;y++)i=_[A+y],i>0&&(Te.FromFloat32ArrayToRefScaled(f,Math.floor(16*u[A+y]),i,g),m.addToSelf(g));me.TransformCoordinatesFromFloatsToRef(x[e],x[e+1],x[e+2],m,p),p.toArray(s,e),t&&(me.TransformNormalFromFloatsToRef(C[e],C[e+1],C[e+2],m,p),p.toArray(n,e)),m.reset()}else{const i=c[A+0],r=c[A+1];Te.FromArrayToRef(f,Math.floor(16*h[A+0]),v),Te.FromArrayToRef(f,Math.floor(16*h[A+1]),T),ve.FromRotationMatrixToRef(v,b),ve.FromRotationMatrixToRef(T,E),Te.FromQuaternionToRef(ve.SlerpToRef(b,E,r,b),g),me.TransformCoordinatesFromFloatsToRef(x[e]-o[e],x[e+1]-o[e+1],x[e+2]-o[e+2],g,S),me.TransformCoordinatesFromFloatsToRef(a[e],a[e+1],a[e+2],v,p).scaleAndAddToRef(i,S),me.TransformCoordinatesFromFloatsToRef(l[e],l[e+1],l[e+2],T,p).scaleAndAddToRef(r,S),S.toArray(s,e),t&&(me.TransformNormalFromFloatsToRef(C[e],C[e+1],C[e+2],g,S),S.toArray(n,e))}}return this.updateVerticesData(Oe.PositionKind,s),t&&this.updateVerticesData(Oe.NormalKind,n),this}}class Kh{name;extensions;materialBuilder;useSdef;buildSkeleton;buildMorph;boundingBoxMargin;_loggingEnabled;log;warn;error;constructor(e,t){this.name=e,this.extensions=t,this.materialBuilder=new Xh,this.useSdef=!0,this.buildSkeleton=!0,this.buildMorph=!0,this.boundingBoxMargin=10,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}importMeshAsync(e,t,i,s,n,r){return this._loadAsyncInternal(t,null,i,s,n)}loadAsync(e,t,i,s,n){return this._loadAsyncInternal(e,null,t,i,s).then((()=>{}))}loadAssetContainerAsync(e,t,i,s,n){const r=new Ch(e);return this._loadAsyncInternal(e,r,t,i,s).then((()=>r))}async _loadAsyncInternal(e,t,i,s,n){const r=await this._parseFileAsync(i.arrayBuffer),o=new Qh(!0,this._getProgressTaskCosts(i,r),n??null);o.endTask("Parse"),o.invokeProgressEvent(),e._blockEntityCollection=!!t;const a=new(i.useSdef?Yh:jn)(r.header.modelName,e);a._parentContainer=t,e._blockEntityCollection=!1,a.setEnabled(!1);const{vertexData:l,geometry:h}=await this._buildGeometryAsync(i,r,a,e,t,o),{multiMaterial:c,textureLoadPromise:d}=await this._buildMaterialAsync(i,r,a,e,t,l,s,o);this._buildSubMeshes(r,a);const u=[];let _=null;i.buildSkeleton?_=await this._buildSkeletonAsync(r,a,e,t,u,o):o.endTask("Build Skeleton");const f=[];let p=null;return i.buildMorph?p=await this._buildMorphAsync(r,a,e,t,l,f,o):o.endTask("Build Morph"),0!==i.boundingBoxMargin&&this._applyBoundingBoxMargin(a,i.boundingBoxMargin),a.metadata={isMmdModel:!0,header:{modelName:r.header.modelName,englishModelName:r.header.englishModelName,comment:r.header.comment,englishComment:r.header.englishComment},bones:u,morphs:f,rigidBodies:r.rigidBodies,joints:r.joints},o.invokeProgressEvent(),await d,o.endTask("Texture Load"),o.invokeProgressEvent(),a.setEnabled(!0),null!==t&&(t.meshes.push(a),t.geometries.push(h),t.multiMaterials.push(c),null!==_&&t.skeletons.push(_),null!==p&&t.morphTargetManagers.push(p)),{meshes:[a],particleSystems:[],skeletons:null!==_?[_]:[],animationGroups:[],transformNodes:[],geometries:[h],lights:[]}}_getProgressTaskCosts(e,t){let i=0;if(e.buildMorph){const e=t.morphs;for(let t=0;t<e.length;++t){const s=e[t];s.type!==Uh.Morph.Type.VertexMorph&&s.type!==Uh.Morph.Type.UvMorph&&s.type!==Uh.Morph.Type.AdditionalUvMorph1&&s.type!==Uh.Morph.Type.AdditionalUvMorph2&&s.type!==Uh.Morph.Type.AdditionalUvMorph3&&s.type!==Uh.Morph.Type.AdditionalUvMorph4||(i+=s.indices.length)}}return[{name:"Parse",cost:Math.floor(e.arrayBuffer.byteLength/100)},{name:"Build Material",cost:100*t.materials.length},{name:"Build Skeleton",cost:e.buildSkeleton?100*t.bones.length:0},{name:"Build Morph",cost:i},{name:"Texture Load",cost:3e4*t.textures.length}]}async _buildSkeletonAsync(e,t,i,s,n,r){i._blockEntityCollection=!!s;const o=new Ah(e.header.modelName,e.header.modelName+"_skeleton",i);o._parentContainer=s,i._blockEntityCollection=!1;{const t=e.bones,i=[],s=[];for(let e=0;e<t.length;++e){const r=t[e];let a=!1;if(0<=r.parentBoneIndex&&r.parentBoneIndex<t.length){let i=r.parentBoneIndex;for(;-1!==i;){if(i===e){a=!0,this.warn(`Bone loop detected. Ignore Parenting. Bone index: ${e}`);break}i=t[i].parentBoneIndex}e<=r.parentBoneIndex&&this.warn(`Parent bone index is greater equal than child bone index. Bone index: ${e} Parent bone index: ${r.parentBoneIndex}`)}else-1!==r.parentBoneIndex&&this.error(`Parent bone index is out of range. Bone index: ${e} Parent bone index: ${r.parentBoneIndex}`);const l=r.position,h=new me(l[0],l[1],l[2]);if(0<=r.parentBoneIndex&&r.parentBoneIndex<i.length&&!a){const e=t[r.parentBoneIndex];h.x-=e.position[0],h.y-=e.position[1],h.z-=e.position[2]}const c=Te.Identity().setTranslation(h),d=new go(r.name,o,void 0,c,void 0,void 0,e);i.push(d),s.push(a);const u={name:r.name,parentBoneIndex:r.parentBoneIndex,transformOrder:r.transformOrder,flag:r.flag,appendTransform:r.appendTransform,ik:r.ik};n.push(u)}for(let e=0;e<i.length;++e){const n=t[e],r=i[e];0<=n.parentBoneIndex&&n.parentBoneIndex<i.length&&!s[e]&&r.setParent(i[n.parentBoneIndex],!1)}for(let e=0;e<i.length;++e){const t=i[e];null===t.getParent()&&t._updateAbsoluteBindMatrices()}}return r.endTask("Build Skeleton"),r.invokeProgressEvent(),t.skeleton=o}_applyBoundingBoxMargin(e,t){if(void 0===e.subMeshes)return;const i=e.subMeshes;for(let e=0;e<i.length;++e){const s=i[e],n=s.getBoundingInfo();s.setBoundingInfo(new cs((new me).setAll(-t).addInPlace(n.minimum),(new me).setAll(t).addInPlace(n.maximum)))}const s=e.getBoundingInfo();e.setBoundingInfo(new cs((new me).setAll(-t).addInPlace(s.minimum),(new me).setAll(t).addInPlace(s.maximum))),e._updateBoundingInfo()}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){p.Log(e)}_logDisabled(){}_warnEnabled(e){p.Warn(e)}_warnDisabled(){}_errorEnabled(e){p.Error(e)}_errorDisabled(){}}class jh{static _IdMap=new WeakMap;static _NextId=0;constructor(){}static GetId(e){let t=this._IdMap.get(e);return void 0===t&&(t=this._NextId,this._NextId+=1,this._IdMap.set(e,t)),t}}class $h{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class qh{isDeviceLittleEndian;_dataView;_decoder;_offset;constructor(e){this.isDeviceLittleEndian=this._getIsDeviceLittleEndian(),this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}_getIsDeviceLittleEndian(){const e=new Int16Array([256]);return 1===new Int8Array(e.buffer)[1]}swap16Array(e){for(let t=0;t<e.length;++t){const i=e[t];e[t]=(255&i)<<8|i>>8&255}}swap32Array(e){for(let t=0;t<e.length;++t){const i=e[t];e[t]=(255&i)<<24|(65280&i)<<8|i>>8&65280|i>>24&255}}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);e.set(t),this._offset+=e.byteLength}getUint16(){const e=this._dataView.getUint16(this._offset,!0);return this._offset+=2,e}getUint16Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap16Array(e)}getInt16(){const e=this._dataView.getInt16(this._offset,!0);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,!0);return this._offset+=4,e}getUint32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getInt32(){const e=this._dataView.getInt32(this._offset,!0);return this._offset+=4,e}getInt32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getFloat32(){const e=this._dataView.getFloat32(this._offset,!0);return this._offset+=4,e}getFloat32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getFloat32Tuple(e){const t=new Array(e);for(let i=0;i<e;++i)t[i]=this._dataView.getFloat32(this._offset,!0),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let i=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<i.length;++e)if(0===i[e]){i=i.subarray(0,e);break}return this._decoder.decode(i)}getSignatureString(e){const t=new TextDecoder("utf-8"),i=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(i)}getPaddedArrayOffset(e,t){this._offset+=this._offset%e==0?0:e-this._offset%e;const i=this._offset;return this._offset+=e*t,i}get bytesAvailable(){return this._dataView.byteLength-this._offset}}class Zh{constructor(){}static async ParseAsync(e,t=new $h){const i=new qh(e);i.initializeTextDecoder("utf-8");const s=this._ParseHeader(i),n=await this._ParseGeometryAsync(i),r=await this._ParseTexturesAsync(i),o=this._ParseMaterials(i),a=this._ParseBones(i),l=this._ParseMorphs(i),h=this._ParseDisplayFrames(i),c=this._ParseRigidBodies(i),d=this._ParseJoints(i);return i.bytesAvailable>0&&t.warn(`There are ${i.bytesAvailable} bytes left after parsing`),{header:s,geometry:n,textures:r,materials:o,bones:a,morphs:l,displayFrames:h,rigidBodies:c,joints:d}}static _ParseHeader(e){if(e.bytesAvailable<7)throw new RangeError("is not bpmx file");const t=e.getDecoderString(4,!1);if("BPMX"!==t)throw new RangeError("is not bpmx file");return{signature:t,version:[e.getInt8(),e.getInt8(),e.getInt8()],modelName:e.getDecoderString(e.getUint32(),!1),englishModelName:e.getDecoderString(e.getUint32(),!1),comment:e.getDecoderString(e.getUint32(),!1),englishComment:e.getDecoderString(e.getUint32(),!1)}}static async _ParseGeometryAsync(e){const t=e.getUint32();let i=performance.now();const s=new Float32Array(3*t);e.getFloat32Array(s),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now());const n=new Float32Array(3*t);e.getFloat32Array(n),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now());const r=new Float32Array(2*t);e.getFloat32Array(r),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now());const o=e.getUint8(),a=e.getUint32(),l=2===o?new Uint16Array(a):new Uint32Array(a);2===o?e.getUint16Array(l):e.getUint32Array(l),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now());const h=new Float32Array(4*t);e.getFloat32Array(h);const c=new Float32Array(4*t);e.getFloat32Array(c),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now());const d=0!==e.getUint8(),u=d?{c:new Float32Array(3*t),r0:new Float32Array(3*t),r1:new Float32Array(3*t)}:void 0;return d&&(e.getFloat32Array(u.c),e.getFloat32Array(u.r0),e.getFloat32Array(u.r1)),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now()),{positions:s,normals:n,uvs:r,indices:l,matricesIndices:h,matricesWeights:c,sdef:u}}static async _ParseTexturesAsync(e){const t=e.getUint32();let i=performance.now();const s=[];for(let n=0;n<t;++n){const t=e.getDecoderString(e.getUint32(),!1),n=e.getUint32(),r=new ArrayBuffer(n);e.getUint8Array(new Uint8Array(r)),s.push({relativePath:t,data:r}),100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now())}return s}static _ParseMaterials(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),evauatedTransparency:e.getInt8(),flag:e.getUint8(),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureIndex:e.getInt32(),sphereTextureIndex:e.getInt32(),sphereTextureMode:e.getUint8(),isSharedToonTexture:1===e.getUint8(),toonTextureIndex:e.getInt32(),comment:e.getDecoderString(e.getUint32(),!1),surfaceCount:e.getInt32()};i.push(t)}return i}static _ParseBones(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t=e.getDecoderString(e.getUint32(),!1),s=e.getDecoderString(e.getUint32(),!1),n=e.getFloat32Tuple(3),r=e.getInt32(),o=e.getInt32(),a=e.getUint16();let l,h,c,d,u,_;if(l=a&Uh.Bone.Flag.UseBoneIndexAsTailPosition?e.getInt32():e.getFloat32Tuple(3),(a&Uh.Bone.Flag.HasAppendMove||a&Uh.Bone.Flag.HasAppendRotate)&&(h={parentIndex:e.getInt32(),ratio:e.getFloat32()}),a&Uh.Bone.Flag.HasAxisLimit&&(c=e.getFloat32Tuple(3)),a&Uh.Bone.Flag.HasLocalVector&&(d={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)}),a&Uh.Bone.Flag.IsExternalParentTransformed&&(u=e.getInt32()),a&Uh.Bone.Flag.IsIkEnabled){const t=e.getInt32(),i=e.getInt32(),s=e.getFloat32(),n=[],r=e.getInt32();for(let t=0;t<r;++t){const t={target:e.getInt32(),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};n.push(t)}_={target:t,iteration:i,rotationConstraint:s,links:n}}const f={name:t,englishName:s,position:n,parentBoneIndex:r,transformOrder:o,flag:a,tailPosition:l,appendTransform:h,axisLimit:c,localVector:d,externalParentTransform:u,ik:_};i.push(f)}return i}static _ParseMorphs(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t=e.getDecoderString(e.getUint32(),!1),s=e.getDecoderString(e.getUint32(),!1),n=e.getUint8(),r=e.getUint8();let o={name:t,englishName:s,category:n,type:r};const a=e.getUint32();switch(r){case Uh.Morph.Type.GroupMorph:{const t=new Int32Array(a);e.getInt32Array(t);const i=new Float32Array(a);e.getFloat32Array(i),o={...o,indices:t,ratios:i}}break;case Uh.Morph.Type.VertexMorph:{const t=new Int32Array(a);e.getInt32Array(t);const i=new Float32Array(3*a);e.getFloat32Array(i),o={...o,indices:t,positions:i}}break;case Uh.Morph.Type.BoneMorph:{const t=new Int32Array(a);e.getInt32Array(t);const i=new Float32Array(3*a);e.getFloat32Array(i);const s=new Float32Array(4*a);e.getFloat32Array(s),o={...o,indices:t,positions:i,rotations:s}}break;case Uh.Morph.Type.UvMorph:case Uh.Morph.Type.AdditionalUvMorph1:case Uh.Morph.Type.AdditionalUvMorph2:case Uh.Morph.Type.AdditionalUvMorph3:case Uh.Morph.Type.AdditionalUvMorph4:{const t=new Int32Array(a);e.getInt32Array(t);const i=new Float32Array(4*a);e.getFloat32Array(i),o={...o,indices:t,offsets:i}}break;case Uh.Morph.Type.MaterialMorph:{const t=[];for(let i=0;i<a;++i){const i={index:e.getInt32(),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};t.push(i)}o={...o,elements:t}}break;default:throw new Error(`Unknown morph type: ${r}`)}i.push(o)}return i}static _ParseDisplayFrames(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t=e.getDecoderString(e.getUint32(),!1),s=e.getDecoderString(e.getUint32(),!1),n=1===e.getUint8(),r=e.getUint32(),o=[];for(let t=0;t<r;++t){const t={type:e.getUint8(),index:e.getInt32()};o.push(t)}const a={name:t,englishName:s,isSpecialFrame:n,frames:o};i.push(a)}return i}static _ParseRigidBodies(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),boneIndex:e.getInt32(),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};i.push(t)}return i}static _ParseJoints(e){const t=e.getUint32(),i=[];for(let s=0;s<t;++s){const t={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),type:e.getUint8(),rigidbodyIndexA:e.getInt32(),rigidbodyIndexB:e.getInt32(),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};i.push(t)}return i}}da&&da.RegisterPlugin(new class extends Kh{constructor(){super("bpmx",{".bpmx":{isBinary:!0}})}loadFile(e,t,i,s,n,r,o){const a=this.materialBuilder,l=this.useSdef,h=this.buildSkeleton,c=this.buildMorph,d=this.boundingBoxMargin;return e._loadFile(t,((e,i)=>{const n={arrayBuffer:e,pmFileId:t instanceof File?jh.GetId(t).toString():t,materialBuilder:a,useSdef:l,buildSkeleton:h,buildMorph:c,boundingBoxMargin:d};s(n,i)}),n,!0,r,o)}async _parseFileAsync(e){return await Zh.ParseAsync(e,this).catch((e=>Promise.reject(e)))}_getProgressTaskCosts(e,t){const i=super._getProgressTaskCosts(e,t);return i.push({name:"Build Geometry",cost:t.geometry.indices.length}),i}async _buildGeometryAsync(e,t,i,s,n,r){const o=new Nn;o.positions=t.geometry.positions,o.normals=t.geometry.normals,o.uvs=t.geometry.uvs,o.indices=t.geometry.indices,o.matricesIndices=t.geometry.matricesIndices,o.matricesWeights=t.geometry.matricesWeights,s._blockEntityCollection=!!n;const a=new Ln(t.header.modelName,s,o,!1);if(a._parentContainer=n,s._blockEntityCollection=!1,e.useSdef&&void 0!==t.geometry.sdef){const e=t.geometry.sdef,i=o.positions.length/3;for(let t=0;t<i;++t){const i=o.matricesWeights[4*t+0],s=o.matricesWeights[4*t+1],n=e.c,r=e.r0,a=e.r1,l=n[3*t+0],h=n[3*t+1],c=n[3*t+2];let d=r[3*t+0],u=r[3*t+1],_=r[3*t+2],f=a[3*t+0],p=a[3*t+1],m=a[3*t+2];const g=d*i+f*s,v=u*i+p*s,T=_*i+m*s;d=l+d-g,u=h+u-v,_=c+_-T,f=l+f-g,p=h+p-v,m=c+m-T;const b=.5*(l+d),E=.5*(h+u),S=.5*(c+_),x=.5*(l+f),C=.5*(h+p),y=.5*(c+m);r[3*t+0]=b,r[3*t+1]=E,r[3*t+2]=S,a[3*t+0]=x,a[3*t+1]=C,a[3*t+2]=y}a.setVerticesData(Nh.MatricesSdefCKind,e.c,!1,3),a.setVerticesData(Nh.MatricesSdefR0Kind,e.r0,!1,3),a.setVerticesData(Nh.MatricesSdefR1Kind,e.r1,!1,3)}return a.applyToMesh(i),r.endTask("Build Geometry"),r.invokeProgressEvent(),{vertexData:o,geometry:a}}async _buildMaterialAsync(e,t,i,s,n,r,o,a){s._blockEntityCollection=!!n;const l=new zn(t.header.modelName+"_multi",s);let h;l._parentContainer=n,s._blockEntityCollection=!1;const c=new Array(t.textures.length);for(let e=0;e<t.textures.length;++e)c[e]=t.textures[e].relativePath;const d=new Promise((d=>{h=e.materialBuilder.buildMaterials(i.uniqueId,t.materials,c,o,"file:"+e.pmFileId+"_",t.textures,s,n,r.indices,r.uvs,l,this,(e=>{e.lengthComputable&&(a.setTaskProgressRatio("Texture Load",e.loaded/e.total,!0),a.invokeProgressEvent())}),(()=>d()))}));return void 0!==h&&await h,i.material=l,a.endTask("Build Material"),a.invokeProgressEvent(),{multiMaterial:l,textureLoadPromise:d}}_buildSubMeshes(e,t){if(void 0===t.subMeshes)return;t.subMeshes.length=0;const i=e.materials;let s=0;for(let n=0;n<i.length;++n){const r=i[n];new ys(n,0,Math.floor(e.geometry.positions.length/3),s,r.surfaceCount,t),s+=r.surfaceCount}}async _buildMorphAsync(e,t,i,s,n,r,o){i._blockEntityCollection=!!s;const a=new Eh(i);a._parentContainer=s,i._blockEntityCollection=!1;{const t=e.morphs,s=[];let l=0;for(let a=0;a<t.length;++a){const h=t[a];switch(h.type){case Uh.Morph.Type.GroupMorph:case Uh.Morph.Type.BoneMorph:case Uh.Morph.Type.MaterialMorph:r.push(h);break;case Uh.Morph.Type.VertexMorph:case Uh.Morph.Type.UvMorph:case Uh.Morph.Type.AdditionalUvMorph1:case Uh.Morph.Type.AdditionalUvMorph2:case Uh.Morph.Type.AdditionalUvMorph3:case Uh.Morph.Type.AdditionalUvMorph4:r.push({name:h.name,englishName:h.englishName,category:h.category,type:h.type,index:s.length})}if(h.type!==Uh.Morph.Type.VertexMorph&&h.type!==Uh.Morph.Type.UvMorph&&h.type!==Uh.Morph.Type.AdditionalUvMorph1&&h.type!==Uh.Morph.Type.AdditionalUvMorph2&&h.type!==Uh.Morph.Type.AdditionalUvMorph3&&h.type!==Uh.Morph.Type.AdditionalUvMorph4)continue;const c=new mh(h.name,0,i);if(s.push(c),h.type===Uh.Morph.Type.VertexMorph){const t=new Float32Array(e.geometry.positions);t.set(n.positions);const i=h.indices,s=h.positions;let r=performance.now();for(let e=0;e<i.length;++e){const n=i[e];t[3*n+0]+=s[3*e+0],t[3*n+1]+=s[3*e+1],t[3*n+2]+=s[3*e+2],e%1e4==0&&100<performance.now()-r&&(o.setTaskProgress("Build Morph",l+e),o.invokeProgressEvent(),await Ot.DelayAsync(0),r=performance.now())}o.setTaskProgress("Build Morph",l+i.length),l+=i.length,c.setPositions(t)}else{const t=new Float32Array(e.geometry.uvs);t.set(n.uvs);const i=h.indices,s=h.offsets;let r=performance.now();for(let e=0;e<i.length;++e){const n=i[e];t[2*n+0]+=s[4*e+0],t[2*n+1]+=s[4*e+1],e%1e4==0&&100<performance.now()-r&&(o.setTaskProgress("Build Morph",l+e),o.invokeProgressEvent(),await Ot.DelayAsync(0),r=performance.now())}o.setTaskProgress("Build Morph",l+i.length),l+=i.length,c.setPositions(n.positions),c.setUVs(t)}}a.areUpdatesFrozen=!0;for(let e=0;e<s.length;++e)a.addTarget(s[e]);a.areUpdatesFrozen=!1,o.endTask("Build Morph")}return t.morphTargetManager=a}});class Jh{_vertexIndexSize;_textureIndexSize;_materialIndexSize;_boneIndexSize;_morphIndexSize;_rigidBodyIndexSize;constructor(e,t,i,s,n,r){this._vertexIndexSize=e,this._textureIndexSize=t,this._materialIndexSize=i,this._boneIndexSize=s,this._morphIndexSize=n,this._rigidBodyIndexSize=r}getVertexIndex(e){switch(this._vertexIndexSize){case 1:return e.getUint8();case 2:return e.getUint16();case 4:return e.getInt32();default:throw new Error(`Invalid vertexIndexSize: ${this._vertexIndexSize}`)}}_getNonVertexIndex(e,t){switch(t){case 1:return e.getInt8();case 2:return e.getInt16();case 4:return e.getInt32();default:throw new Error(`Invalid indexSize: ${t}`)}}getTextureIndex(e){return this._getNonVertexIndex(e,this._textureIndexSize)}getMaterialIndex(e){return this._getNonVertexIndex(e,this._materialIndexSize)}getBoneIndex(e){return this._getNonVertexIndex(e,this._boneIndexSize)}getMorphIndex(e){return this._getNonVertexIndex(e,this._morphIndexSize)}getRigidBodyIndex(e){return this._getNonVertexIndex(e,this._rigidBodyIndexSize)}}class ec{constructor(){}static async ParseAsync(e,t=new $h){const i=new qh(e),s=this._ParseHeader(i,t),n=new Jh(s.vertexIndexSize,s.textureIndexSize,s.materialIndexSize,s.boneIndexSize,s.morphIndexSize,s.rigidBodyIndexSize),r=await this._ParseVerticesAsync(i,n,s),o=this._ParseFaces(i,n,s),a=this._ParseTextures(i),l=this._ParseMaterials(i,n),h=this._ParseBones(i,n),c=this._ParseMorphs(i,n),d=this._ParseDisplayFrames(i,n),u=this._ParseRigidBodies(i,n),_=this._ParseJoints(i,n),f=s.version<=2?[]:this._ParseSoftBodies(i,n,s);return i.bytesAvailable>0&&t.warn(`There are ${i.bytesAvailable} bytes left after parsing`),{header:s,vertices:r,faces:o,textures:a,materials:l,bones:h,morphs:c,displayFrames:d,rigidBodies:u,joints:_,softBodies:f}}static _ParseHeader(e,t){if(e.bytesAvailable<17)throw new RangeError("is not pmx file");const i=e.getSignatureString(3);if("PMX"!==i)throw new RangeError("is not pmx file");e.getInt8();const s=e.getFloat32(),n=e.getUint8(),r=e.getUint8();e.initializeTextDecoder(r===Uh.Header.Encoding.Utf8?"utf-8":"utf-16le");const o=e.getUint8(),a=e.getUint8(),l=e.getUint8(),h=e.getUint8(),c=e.getUint8(),d=e.getUint8(),u=e.getUint8();if(n<8)throw new Error(`Invalid globalsCount: ${n}`);if(8<n){t.warn(`globalsCount is greater than 8: ${n} files may be corrupted or higher version`);for(let t=8;t<n;++t)e.getUint8()}return{signature:i,version:s,encoding:r,additionalVec4Count:o,vertexIndexSize:a,textureIndexSize:l,materialIndexSize:h,boneIndexSize:c,morphIndexSize:d,rigidBodyIndexSize:u,modelName:e.getDecoderString(e.getInt32(),!1),englishModelName:e.getDecoderString(e.getInt32(),!1),comment:e.getDecoderString(e.getInt32(),!1),englishComment:e.getDecoderString(e.getInt32(),!1)}}static async _ParseVerticesAsync(e,t,i){const s=e.getInt32(),n=[];let r=performance.now();for(let o=0;o<s;++o){const s=e.getFloat32Tuple(3),a=e.getFloat32Tuple(3),l=e.getFloat32Tuple(2),h=[];for(let t=0;t<i.additionalVec4Count;++t)h.push(e.getFloat32Tuple(4));const c=e.getUint8();let d;switch(c){case Uh.Vertex.BoneWeightType.Bdef1:d={boneIndices:t.getBoneIndex(e),boneWeights:null};break;case Uh.Vertex.BoneWeightType.Bdef2:d={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:e.getFloat32()};break;case Uh.Vertex.BoneWeightType.Bdef4:d={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;case Uh.Vertex.BoneWeightType.Sdef:d={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:{boneWeight0:e.getFloat32(),c:e.getFloat32Tuple(3),r0:e.getFloat32Tuple(3),r1:e.getFloat32Tuple(3)}};break;case Uh.Vertex.BoneWeightType.Qdef:d={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;default:throw new Error(`Invalid weightType: ${c}`)}const u=e.getFloat32();n.push({position:s,normal:a,uv:l,additionalVec4:h,weightType:c,boneWeight:d,edgeScale:u}),o%1e4==0&&100<performance.now()-r&&(await new Promise((e=>setTimeout(e,0))),r=performance.now())}return n}static _ParseFaces(e,t,i){const s=e.getInt32(),n=new ArrayBuffer(s*i.vertexIndexSize);let r;switch(i.vertexIndexSize){case 1:r=new Uint8Array(n);break;case 2:r=new Uint16Array(n);break;case 4:r=new Int32Array(n);break;default:throw new Error(`Invalid vertexIndexSize: ${i.vertexIndexSize}`)}for(let i=0;i<s;++i)r[i]=t.getVertexIndex(e);return r}static _ParseTextures(e){const t=e.getInt32(),i=[];for(let s=0;s<t;++s){const t=e.getDecoderString(e.getInt32(),!1);i.push(t)}return i}static _ParseMaterials(e,t){const i=e.getInt32(),s=[];for(let n=0;n<i;++n){const i=e.getDecoderString(e.getInt32(),!1),n=e.getDecoderString(e.getInt32(),!1),r=e.getFloat32Tuple(4),o=e.getFloat32Tuple(3),a=e.getFloat32(),l=e.getFloat32Tuple(3),h=e.getUint8(),c=e.getFloat32Tuple(4),d=e.getFloat32(),u=t.getTextureIndex(e),_=t.getTextureIndex(e),f=e.getUint8(),p=1===e.getUint8(),m={name:i,englishName:n,diffuse:r,specular:o,shininess:a,ambient:l,flag:h,edgeColor:c,edgeSize:d,textureIndex:u,sphereTextureIndex:_,sphereTextureMode:f,isSharedToonTexture:p,toonTextureIndex:p?e.getUint8():t.getTextureIndex(e),comment:e.getDecoderString(e.getInt32(),!1),surfaceCount:e.getInt32()};s.push(m)}return s}static _ParseBones(e,t){const i=e.getInt32(),s=[];for(let n=0;n<i;++n){const i=e.getDecoderString(e.getInt32(),!1),n=e.getDecoderString(e.getInt32(),!1),r=e.getFloat32Tuple(3),o=t.getBoneIndex(e),a=e.getInt32(),l=e.getUint16();let h,c,d,u,_,f;if(h=l&Uh.Bone.Flag.UseBoneIndexAsTailPosition?t.getBoneIndex(e):e.getFloat32Tuple(3),(l&Uh.Bone.Flag.HasAppendMove||l&Uh.Bone.Flag.HasAppendRotate)&&(c={parentIndex:t.getBoneIndex(e),ratio:e.getFloat32()}),l&Uh.Bone.Flag.HasAxisLimit&&(d=e.getFloat32Tuple(3)),l&Uh.Bone.Flag.HasLocalVector&&(u={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)}),l&Uh.Bone.Flag.IsExternalParentTransformed&&(_=e.getInt32()),l&Uh.Bone.Flag.IsIkEnabled){const i=t.getBoneIndex(e),s=e.getInt32(),n=e.getFloat32(),r=[],o=e.getInt32();for(let i=0;i<o;++i){const i={target:t.getBoneIndex(e),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};r.push(i)}f={target:i,iteration:s,rotationConstraint:n,links:r}}const p={name:i,englishName:n,position:r,parentBoneIndex:o,transformOrder:a,flag:l,tailPosition:h,appendTransform:c,axisLimit:d,localVector:u,externalParentTransform:_,ik:f};s.push(p)}return s}static _ParseMorphs(e,t){const i=e.getInt32(),s=[];for(let n=0;n<i;++n){const i=e.getDecoderString(e.getInt32(),!1),n=e.getDecoderString(e.getInt32(),!1),r=e.getInt8(),o=e.getInt8();let a={name:i,englishName:n,category:r,type:o};const l=e.getInt32();switch(o){case Uh.Morph.Type.GroupMorph:{const i=new Int32Array(l),s=new Float32Array(l);for(let n=0;n<l;++n)i[n]=t.getMorphIndex(e),s[n]=e.getFloat32();a={...a,indices:i,ratios:s}}break;case Uh.Morph.Type.VertexMorph:{const i=new Int32Array(l),s=new Float32Array(3*l);for(let n=0;n<l;++n)i[n]=t.getVertexIndex(e),s[3*n+0]=e.getFloat32(),s[3*n+1]=e.getFloat32(),s[3*n+2]=e.getFloat32();a={...a,indices:i,positions:s}}break;case Uh.Morph.Type.BoneMorph:{const i=new Int32Array(l),s=new Float32Array(3*l),n=new Float32Array(4*l);for(let r=0;r<l;++r)i[r]=t.getBoneIndex(e),s[3*r+0]=e.getFloat32(),s[3*r+1]=e.getFloat32(),s[3*r+2]=e.getFloat32(),n[4*r+0]=e.getFloat32(),n[4*r+1]=e.getFloat32(),n[4*r+2]=e.getFloat32(),n[4*r+3]=e.getFloat32();a={...a,indices:i,positions:s,rotations:n}}break;case Uh.Morph.Type.UvMorph:case Uh.Morph.Type.AdditionalUvMorph1:case Uh.Morph.Type.AdditionalUvMorph2:case Uh.Morph.Type.AdditionalUvMorph3:case Uh.Morph.Type.AdditionalUvMorph4:{const i=new Int32Array(l),s=new Float32Array(4*l);for(let n=0;n<l;++n)i[n]=t.getVertexIndex(e),s[4*n+0]=e.getFloat32(),s[4*n+1]=e.getFloat32(),s[4*n+2]=e.getFloat32(),s[4*n+3]=e.getFloat32();a={...a,indices:i,offsets:s}}break;case Uh.Morph.Type.MaterialMorph:{const i=[];for(let s=0;s<l;++s){const s={index:t.getMaterialIndex(e),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};i.push(s)}a={...a,elements:i}}break;case Uh.Morph.Type.FlipMorph:{const i=new Int32Array(l),s=new Float32Array(l);for(let n=0;n<l;++n)i[n]=t.getMorphIndex(e),s[n]=e.getFloat32();a={...a,indices:i,ratios:s}}break;case Uh.Morph.Type.ImpulseMorph:{const i=new Int32Array(l),s=new Array(l),n=new Float32Array(3*l),r=new Float32Array(3*l);for(let o=0;o<l;++o)i[o]=t.getRigidBodyIndex(e),s[o]=1===e.getUint8(),n[3*o+0]=e.getFloat32(),n[3*o+1]=e.getFloat32(),n[3*o+2]=e.getFloat32(),r[3*o+0]=e.getFloat32(),r[3*o+1]=e.getFloat32(),r[3*o+2]=e.getFloat32();a={...a,indices:i,isLocals:s,velocities:n,torques:r}}break;default:throw new Error(`Unknown morph type: ${o}`)}s.push(a)}return s}static _ParseDisplayFrames(e,t){const i=e.getInt32(),s=[];for(let n=0;n<i;++n){const i=e.getDecoderString(e.getInt32(),!1),n=e.getDecoderString(e.getInt32(),!1),r=1===e.getUint8(),o=e.getInt32(),a=[];for(let i=0;i<o;++i){const i=e.getUint8(),s={type:i,index:i===Uh.DisplayFrame.FrameData.FrameType.Bone?t.getBoneIndex(e):t.getMorphIndex(e)};a.push(s)}const l={name:i,englishName:n,isSpecialFrame:r,frames:a};s.push(l)}return s}static _ParseRigidBodies(e,t){const i=e.getInt32(),s=[];for(let n=0;n<i;++n){const i={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),boneIndex:t.getBoneIndex(e),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};s.push(i)}return s}static _ParseJoints(e,t){const i=e.getInt32(),s=[];for(let n=0;n<i;++n){const i={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),type:e.getUint8(),rigidbodyIndexA:t.getRigidBodyIndex(e),rigidbodyIndexB:t.getRigidBodyIndex(e),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};s.push(i)}return s}static _ParseSoftBodies(e,t,i){const s=e.getInt32(),n=[];for(let r=0;r<s;++r){const s=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),o=e.getUint8(),a=t.getMaterialIndex(e),l=e.getUint8(),h=e.getUint16(),c=e.getUint8(),d=e.getInt32(),u=e.getInt32(),_=e.getFloat32(),f=e.getFloat32(),p=e.getInt32(),m={vcf:e.getFloat32(),dp:e.getFloat32(),dg:e.getFloat32(),lf:e.getFloat32(),pr:e.getFloat32(),vc:e.getFloat32(),df:e.getFloat32(),mt:e.getFloat32(),chr:e.getFloat32(),khr:e.getFloat32(),shr:e.getFloat32(),ahr:e.getFloat32()},g={srhrCl:e.getFloat32(),skhrCl:e.getFloat32(),sshrCl:e.getFloat32(),srSpltCl:e.getFloat32(),skSpltCl:e.getFloat32(),ssSpltCl:e.getFloat32()},v={vIt:e.getInt32(),pIt:e.getInt32(),dIt:e.getInt32(),cIt:e.getInt32()},T={lst:e.getInt32(),ast:e.getInt32(),vst:e.getInt32()},b=e.getInt32(),E=[];for(let i=0;i<b;++i){const i={rigidbodyIndex:t.getRigidBodyIndex(e),vertexIndex:t.getVertexIndex(e),isNearMode:0!==e.getUint8()};E.push(i)}const S=e.getInt32(),x=new ArrayBuffer(S*i.vertexIndexSize);let C;switch(i.vertexIndexSize){case 1:C=new Uint8Array(x);break;case 2:C=new Uint16Array(x);break;case 4:C=new Int32Array(x);break;default:throw new Error(`Invalid vertexIndexSize: ${i.vertexIndexSize}`)}for(let i=0;i<S;++i)C[i]=t.getVertexIndex(e);const y={name:s,englishName:r,type:o,materialIndex:a,collisionGroup:l,collisionMask:h,flags:c,bLinkDistance:d,clusterCount:u,totalMass:_,collisionMargin:f,aeroModel:p,config:m,cluster:g,iteration:v,material:T,anchors:E,vertexPins:C};n.push(y)}return n}}class tc extends Kh{referenceFiles;constructor(e,t){super(e,t),this.referenceFiles=[]}loadFile(e,t,i,s,n,r,o){const a=this.materialBuilder,l=this.useSdef,h=this.buildSkeleton,c=this.buildMorph,d=this.boundingBoxMargin,u=this.referenceFiles;return e._loadFile(t,((e,i)=>{const n={arrayBuffer:e,pmFileId:t instanceof File?jh.GetId(t).toString():t,materialBuilder:a,useSdef:l,buildSkeleton:h,buildMorph:c,boundingBoxMargin:d,referenceFiles:u};s(n,i)}),n,!0,r,o)}_getProgressTaskCosts(e,t){const i=super._getProgressTaskCosts(e,t);return i.push({name:"Build Face",cost:t.faces.length}),i.push({name:"Build Vertex",cost:t.vertices.length}),i}async _buildGeometryAsync(e,t,i,s,n,r){const o=new Nn,a=e.useSdef?new Float32Array(3*t.vertices.length):void 0,l=e.useSdef?new Float32Array(3*t.vertices.length):void 0,h=e.useSdef?new Float32Array(3*t.vertices.length):void 0;let c=!1;{const i=t.vertices,s=new Float32Array(3*i.length),n=new Float32Array(3*i.length),d=new Float32Array(2*i.length),u=new Float32Array(4*i.length),_=new Float32Array(4*i.length);let f;f=t.faces instanceof Uint8Array||t.faces instanceof Uint16Array?new Uint16Array(t.faces.length):new Uint32Array(t.faces.length);{let e=performance.now();const i=t.faces;for(let t=0;t<f.length;t+=3)f[t+0]=i[t+0],f[t+1]=i[t+2],f[t+2]=i[t+1],t%1e4==0&&100<performance.now()-e&&(r.setTaskProgress("Build Face",t),r.invokeProgressEvent(),await Ot.DelayAsync(0),e=performance.now());r.endTask("Build Face"),r.invokeProgressEvent()}{let t=performance.now();for(let o=0;o<i.length;++o){const f=i[o];switch(s[3*o+0]=f.position[0],s[3*o+1]=f.position[1],s[3*o+2]=f.position[2],n[3*o+0]=f.normal[0],n[3*o+1]=f.normal[1],n[3*o+2]=f.normal[2],d[2*o+0]=f.uv[0],d[2*o+1]=1-f.uv[1],f.weightType){case Uh.Vertex.BoneWeightType.Bdef1:{const e=f.boneWeight;u[4*o+0]=e.boneIndices,u[4*o+1]=0,u[4*o+2]=0,u[4*o+3]=0,_[4*o+0]=1,_[4*o+1]=0,_[4*o+2]=0,_[4*o+3]=0}break;case Uh.Vertex.BoneWeightType.Bdef2:{const e=f.boneWeight;u[4*o+0]=e.boneIndices[0],u[4*o+1]=e.boneIndices[1],u[4*o+2]=0,u[4*o+3]=0,_[4*o+0]=e.boneWeights,_[4*o+1]=1-e.boneWeights,_[4*o+2]=0,_[4*o+3]=0}break;case Uh.Vertex.BoneWeightType.Bdef4:case Uh.Vertex.BoneWeightType.Qdef:{const e=f.boneWeight;u[4*o+0]=e.boneIndices[0],u[4*o+1]=e.boneIndices[1],u[4*o+2]=e.boneIndices[2],u[4*o+3]=e.boneIndices[3],_[4*o+0]=e.boneWeights[0],_[4*o+1]=e.boneWeights[1],_[4*o+2]=e.boneWeights[2],_[4*o+3]=e.boneWeights[3]}break;case Uh.Vertex.BoneWeightType.Sdef:{const t=f.boneWeight;u[4*o+0]=t.boneIndices[0],u[4*o+1]=t.boneIndices[1],u[4*o+2]=0,u[4*o+3]=0;const i=t.boneWeights,s=i.boneWeight0,n=1-s;if(_[4*o+0]=s,_[4*o+1]=n,_[4*o+2]=0,_[4*o+3]=0,e.useSdef){const e=i.c[0],t=i.c[1],r=i.c[2];let d=i.r0[0],u=i.r0[1],_=i.r0[2],f=i.r1[0],p=i.r1[1],m=i.r1[2];const g=d*s+f*n,v=u*s+p*n,T=_*s+m*n;d=e+d-g,u=t+u-v,_=r+_-T,f=e+f-g,p=t+p-v,m=r+m-T;const b=.5*(e+d),E=.5*(t+u),S=.5*(r+_),x=.5*(e+f),C=.5*(t+p),y=.5*(r+m);a[3*o+0]=e,a[3*o+1]=t,a[3*o+2]=r,l[3*o+0]=b,l[3*o+1]=E,l[3*o+2]=S,h[3*o+0]=x,h[3*o+1]=C,h[3*o+2]=y,c=!0}}}o%1e4==0&&100<performance.now()-t&&(r.setTaskProgress("Build Vertex",o),r.invokeProgressEvent(),await Ot.DelayAsync(0),t=performance.now())}r.endTask("Build Vertex"),r.invokeProgressEvent()}o.positions=s,o.normals=n,o.uvs=d,o.indices=f,o.matricesIndices=u,o.matricesWeights=_}s._blockEntityCollection=!!n;const d=new Ln(t.header.modelName,s,o,!1);return d._parentContainer=n,s._blockEntityCollection=!1,e.useSdef&&c&&(d.setVerticesData(Nh.MatricesSdefCKind,a,!1,3),d.setVerticesData(Nh.MatricesSdefR0Kind,l,!1,3),d.setVerticesData(Nh.MatricesSdefR1Kind,h,!1,3)),d.applyToMesh(i),{vertexData:o,geometry:d}}async _buildMaterialAsync(e,t,i,s,n,r,o,a){s._blockEntityCollection=!!n;const l=new zn(t.header.modelName+"_multi",s);let h;l._parentContainer=n,s._blockEntityCollection=!1;const c=new Promise((c=>{h=e.materialBuilder.buildMaterials(i.uniqueId,t.materials,t.textures,o,"file:"+e.pmFileId+"_",e.referenceFiles,s,n,r.indices,r.uvs,l,this,(e=>{e.lengthComputable&&(a.setTaskProgressRatio("Texture Load",e.loaded/e.total,!0),a.invokeProgressEvent())}),(()=>c()))}));return void 0!==h&&await h,i.material=l,a.endTask("Build Material"),a.invokeProgressEvent(),{multiMaterial:l,textureLoadPromise:c}}_buildSubMeshes(e,t){if(void 0===t.subMeshes)return;t.subMeshes.length=0;const i=e.materials;let s=0;for(let n=0;n<i.length;++n){const r=i[n];new ys(n,0,e.vertices.length,s,r.surfaceCount,t),s+=r.surfaceCount}}async _buildMorphAsync(e,t,i,s,n,r,o){i._blockEntityCollection=!!s;const a=new Eh(i);a._parentContainer=s,i._blockEntityCollection=!1;{const t=e.morphs,s=[];let l=0;for(let a=0;a<t.length;++a){const h=t[a];switch(h.type){case Uh.Morph.Type.GroupMorph:case Uh.Morph.Type.BoneMorph:case Uh.Morph.Type.MaterialMorph:r.push(h);break;case Uh.Morph.Type.VertexMorph:case Uh.Morph.Type.UvMorph:case Uh.Morph.Type.AdditionalUvMorph1:case Uh.Morph.Type.AdditionalUvMorph2:case Uh.Morph.Type.AdditionalUvMorph3:case Uh.Morph.Type.AdditionalUvMorph4:r.push({name:h.name,englishName:h.englishName,category:h.category,type:h.type,index:s.length});break;default:this.warn(`Unsupported morph type: ${h.type}`)}if(h.type!==Uh.Morph.Type.VertexMorph&&h.type!==Uh.Morph.Type.UvMorph&&h.type!==Uh.Morph.Type.AdditionalUvMorph1&&h.type!==Uh.Morph.Type.AdditionalUvMorph2&&h.type!==Uh.Morph.Type.AdditionalUvMorph3&&h.type!==Uh.Morph.Type.AdditionalUvMorph4)continue;const c=new mh(h.name,0,i);if(s.push(c),h.type===Uh.Morph.Type.VertexMorph){const t=new Float32Array(3*e.vertices.length);t.set(n.positions);const i=h.indices,s=h.positions;let r=performance.now();for(let e=0;e<i.length;++e){const n=i[e];t[3*n+0]+=s[3*e+0],t[3*n+1]+=s[3*e+1],t[3*n+2]+=s[3*e+2],e%1e4==0&&100<performance.now()-r&&(o.setTaskProgress("Build Morph",l+e),o.invokeProgressEvent(),await Ot.DelayAsync(0),r=performance.now())}o.setTaskProgress("Build Morph",l+i.length),l+=i.length,c.setPositions(t)}else{const t=new Float32Array(2*e.vertices.length);t.set(n.uvs);const i=h.indices,s=h.offsets;let r=performance.now();for(let e=0;e<i.length;++e){const n=i[e];t[2*n+0]+=s[4*e+0],t[2*n+1]+=s[4*e+1],e%1e4==0&&100<performance.now()-r&&(o.setTaskProgress("Build Morph",l+e),o.invokeProgressEvent(),await Ot.DelayAsync(0),r=performance.now())}o.setTaskProgress("Build Morph",l+i.length),l+=i.length,c.setPositions(n.positions),c.setUVs(t)}}a.areUpdatesFrozen=!0;for(let e=0;e<s.length;++e)a.addTarget(s[e]);a.areUpdatesFrozen=!1,o.endTask("Build Morph")}return t.morphTargetManager=a}}da&&da.RegisterPlugin(new class extends tc{constructor(){super("pmx",{".pmx":{isBinary:!0}})}async _parseFileAsync(e){return await ec.ParseAsync(e,this).catch((e=>Promise.reject(e)))}});class ic{name;boneTracks;moveableBoneTracks;morphTracks;propertyTrack;cameraTrack;startFrame;endFrame;constructor(e,t,i,s,n,r){this.name=e,this.boneTracks=t,this.moveableBoneTracks=i,this.morphTracks=s,this.propertyTrack=n,this.cameraTrack=r;let o=Number.MAX_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER;for(let e=0;e<t.length;++e){const i=t[e];o=Math.min(o,i.startFrame),a=Math.max(a,i.endFrame)}for(let e=0;e<i.length;++e){const t=i[e];o=Math.min(o,t.startFrame),a=Math.max(a,t.endFrame)}for(let e=0;e<s.length;++e){const t=s[e];o=Math.min(o,t.startFrame),a=Math.max(a,t.endFrame)}o=Math.min(o,n.startFrame),a=Math.max(a,n.endFrame),o=Math.min(o,r.startFrame),a=Math.max(a,r.endFrame),this.startFrame=o,this.endFrame=a}validate(){const e=this.boneTracks;for(let t=0;t<e.length;++t)if(!e[t].validate())return!1;const t=this.moveableBoneTracks;for(let e=0;e<t.length;++e)if(!t[e].validate())return!1;const i=this.morphTracks;for(let e=0;e<i.length;++e)if(!i[e].validate())return!1;return this.propertyTrack.validate()&&this.cameraTrack.validate()}}class sc{static Interpolate(e,t,i,s,n){let r=.5,o=r,a=1-o;const l=Math;let h,c,d;for(let i=0;i<15;++i){h=3*a*a*o,c=3*a*o*o,d=o*o*o;const i=h*e+c*t+d-n;if(l.abs(i)<1e-5)break;r/=2,o+=i<0?r:-r,a=1-o}return h*i+c*s+d}}class nc{_lastResults=new Map;_upperBoundFrameIndex(e,t){const i=t.frameNumbers;let s=this._lastResults.get(t);void 0===s&&(s=[Number.NEGATIVE_INFINITY,0],this._lastResults.set(t,s));const n=e-s[0];if(Math.abs(n)<6){let t=s[1];for(;0<t&&e<i[t-1];)t-=1;for(;t<i.length&&i[t]<=e;)t+=1;return s[0]=e,s[1]=t,t}{let t=0,n=i.length;for(;t<n;){const s=t+(n-t>>1);e<i[s]?n=s:t=s+1}return s[0]=e,s[1]=t,t}}}class rc extends nc{animation;_camera;constructor(e,t){super(),this.animation=e.cameraTrack,this._camera=t}static _CameraPositionA=new me;static _CameraPositionB=new me;static _CameraRotationA=new me;static _CameraRotationB=new me;static _DegToRad=Math.PI/180;animate(e){const t=this.animation;if(0===t.frameNumbers.length)return;const i=this._camera,s=Math.max(t.startFrame,Math.min(t.endFrame,e)),n=this._upperBoundFrameIndex(s,t),r=n-1,o=t.frameNumbers[r],a=t.frameNumbers[n];if(void 0===a||o+1===a){const e=t.positions;i.position.set(e[3*r],e[3*r+1],e[3*r+2]);const s=t.rotations;i.rotation.set(s[3*r],s[3*r+1],s[3*r+2]),i.distance=t.distances[r],i.fov=t.fovs[r]*rc._DegToRad}else{const e=(s-o)/(a-o),l=t.positions,h=t.positionInterpolations,c=rc._CameraPositionA.set(l[3*r],l[3*r+1],l[3*r+2]),d=rc._CameraPositionB.set(l[3*n],l[3*n+1],l[3*n+2]),u=sc.Interpolate(h[12*n]/127,h[12*n+1]/127,h[12*n+2]/127,h[12*n+3]/127,e),_=sc.Interpolate(h[12*n+4]/127,h[12*n+5]/127,h[12*n+6]/127,h[12*n+7]/127,e),f=sc.Interpolate(h[12*n+8]/127,h[12*n+9]/127,h[12*n+10]/127,h[12*n+11]/127,e);i.position.set(c.x+(d.x-c.x)*u,c.y+(d.y-c.y)*_,c.z+(d.z-c.z)*f);const p=t.rotations,m=t.rotationInterpolations,g=rc._CameraRotationA.set(p[3*r],p[3*r+1],p[3*r+2]),v=rc._CameraRotationB.set(p[3*n],p[3*n+1],p[3*n+2]),T=sc.Interpolate(m[4*n]/127,m[4*n+1]/127,m[4*n+2]/127,m[4*n+3]/127,e),b=1-T;i.rotation.set(g.x*b+v.x*T,g.y*b+v.y*T,g.z*b+v.z*T);const E=t.distances[r],S=t.distances[n],x=sc.Interpolate(t.distanceInterpolations[4*n]/127,t.distanceInterpolations[4*n+1]/127,t.distanceInterpolations[4*n+2]/127,t.distanceInterpolations[4*n+3]/127,e);i.distance=E+(S-E)*x;const C=t.fovs[r],y=t.fovs[n],A=sc.Interpolate(t.fovInterpolations[4*n]/127,t.fovInterpolations[4*n+1]/127,t.fovInterpolations[4*n+2]/127,t.fovInterpolations[4*n+3]/127,e);i.fov=(C+(y-C)*A)*rc._DegToRad}}static Create(e,t){return new rc(e,t)}}function oc(e,t,i,s){let n=!1,r=!1,o=!1;const a=new Set;for(let s=0;s<i.length;++s){const l=i[s];if(null!==l){for(let i=0;i<l.length;++i){const s=t.morphs[l[i]];if(s.type===Uh.Morph.Type.MaterialMorph){const t=s.materialElements;for(let i=0;i<t.length;++i){const s=t[i];if(null!==s.textureColor&&!n){const t=s.index;if(-1===s.index){for(let t=0;t<e.length;++t)e[t].textureColor;n=!0}else e[t].textureColor,a.add(t.toString())}if(null!==s.sphereTextureColor&&!r){const t=s.index;if(-1===s.index){for(let t=0;t<e.length;++t)e[t].sphereTextureColor;r=!0}else e[t].sphereTextureColor,a.add(t.toString())}if(null!==s.toonTextureColor&&!o){const t=s.index;if(-1===s.index){for(let t=0;t<e.length;++t)e[t].toonTextureColor;o=!0}else e[t].toonTextureColor,a.add(t.toString())}}}}if(n&&r&&o)break}}n||r||o?s?.log("All materials could be recompiled for morph animation"):0<a.size&&s?.log(`Materials ${Array.from(a).join(", ")} could be recompiled for morph animation`)}ic.prototype.createRuntimeCameraAnimation=function(e){return rc.Create(this,e)};class ac extends nc{animation;boneBindIndexMap;moveableBoneBindIndexMap;_morphController;morphBindIndexMap;_mesh;ikSolverBindIndexMap;constructor(e,t,i,s,n,r,o){super(),this.animation=e,this.boneBindIndexMap=t,this.moveableBoneBindIndexMap=i,this._morphController=s,this.morphBindIndexMap=n,this.ikSolverBindIndexMap=o,this._mesh=r}static _BonePositionA=new me;static _BonePositionB=new me;static _BonePosition=new me;static _BoneRotationA=new ve;static _BoneRotationB=new ve;animate(e){const t=this.animation,i=t.boneTracks;if(0<i.length){const t=this.boneBindIndexMap;for(let s=0;s<i.length;++s){const n=t[s];if(null===n)continue;const r=i[s],o=Math.max(r.startFrame,Math.min(r.endFrame,e)),a=this._upperBoundFrameIndex(o,r),l=a-1,h=r.frameNumbers[a];if(void 0===h){const e=r.rotations;n.setRotationQuaternion(ac._BoneRotationB.set(e[4*l],e[4*l+1],e[4*l+2],e[4*l+3]),Js.LOCAL)}else{const e=r.frameNumbers[l],t=(o-e)/(h-e),i=r.rotations,s=r.rotationInterpolations,c=ac._BoneRotationA.set(i[4*l],i[4*l+1],i[4*l+2],i[4*l+3]),d=ac._BoneRotationB.set(i[4*a],i[4*a+1],i[4*a+2],i[4*a+3]),u=sc.Interpolate(s[4*a]/127,s[4*a+1]/127,s[4*a+2]/127,s[4*a+3]/127,t);ve.SlerpToRef(c,d,u,c),n.setRotationQuaternion(c,Js.LOCAL)}}}const s=t.moveableBoneTracks;if(0<s.length){const t=this.moveableBoneBindIndexMap;for(let i=0;i<s.length;++i){const n=t[i];if(null===n)continue;const r=s[i],o=Math.max(r.startFrame,Math.min(r.endFrame,e)),a=this._upperBoundFrameIndex(o,r),l=a-1,h=r.frameNumbers[a];if(void 0===h){const e=r.positions;n.getRestMatrix().getTranslationToRef(ac._BonePosition),n.position=ac._BonePosition.addInPlaceFromFloats(e[3*l],e[3*l+1],e[3*l+2]);const t=r.rotations;n.setRotationQuaternion(ac._BoneRotationB.set(t[4*l],t[4*l+1],t[4*l+2],t[4*l+3]),Js.LOCAL)}else{const e=r.frameNumbers[l],t=(o-e)/(h-e),i=r.positions,s=r.positionInterpolations,c=ac._BonePositionA.set(i[3*l],i[3*l+1],i[3*l+2]),d=ac._BonePositionB.set(i[3*a],i[3*a+1],i[3*a+2]),u=sc.Interpolate(s[12*a]/127,s[12*a+1]/127,s[12*a+2]/127,s[12*a+3]/127,t),_=sc.Interpolate(s[12*a+4]/127,s[12*a+5]/127,s[12*a+6]/127,s[12*a+7]/127,t),f=sc.Interpolate(s[12*a+8]/127,s[12*a+9]/127,s[12*a+10]/127,s[12*a+11]/127,t);c.x+=(d.x-c.x)*u,c.y+=(d.y-c.y)*_,c.z+=(d.z-c.z)*f,n.getRestMatrix().getTranslationToRef(ac._BonePosition),n.position=ac._BonePosition.addInPlace(c);const p=r.rotations,m=r.rotationInterpolations,g=ac._BoneRotationA.set(p[4*l],p[4*l+1],p[4*l+2],p[4*l+3]),v=ac._BoneRotationB.set(p[4*a],p[4*a+1],p[4*a+2],p[4*a+3]),T=sc.Interpolate(m[4*a]/127,m[4*a+1]/127,m[4*a+2]/127,m[4*a+3]/127,t);ve.SlerpToRef(g,v,T,g),n.setRotationQuaternion(g,Js.LOCAL)}}}const n=t.morphTracks;if(0<n.length){const t=this._morphController,i=this.morphBindIndexMap;for(let s=0;s<n.length;++s){const r=i[s];if(null===r)continue;const o=n[s],a=Math.max(o.startFrame,Math.min(o.endFrame,e)),l=this._upperBoundFrameIndex(a,o),h=l-1,c=o.frameNumbers[l];if(void 0===c){const e=Math.max(o.weights[h],1e-16);for(let i=0;i<r.length;++i)t.setMorphWeightFromIndex(r[i],e)}else{const e=o.frameNumbers[h],i=(a-e)/(c-e),s=o.weights[h],n=o.weights[l],d=Math.max(s+(n-s)*i,1e-16);for(let e=0;e<r.length;++e)t.setMorphWeightFromIndex(r[e],d)}}}if(0<t.propertyTrack.frameNumbers.length){const i=t.propertyTrack,s=Math.max(i.startFrame,Math.min(i.endFrame,e)),n=this._upperBoundFrameIndex(s,i)-1;this._mesh.visibility=i.visibles[n];const r=this.ikSolverBindIndexMap,o=i.ikStates;for(let e=0;e<r.length;++e){const t=r[e];if(null===t)continue;const i=o[e];t.enabled=0!==i[n]}}}_materialRecompileInduced=!1;induceMaterialRecompile(e){this._materialRecompileInduced||(this._materialRecompileInduced=!0,ac.InduceMaterialRecompile(this._mesh.material.subMaterials,this._morphController,this.morphBindIndexMap,e))}static Create(e,t,i,s){const n=t.skeleton.bones,r=new Map;if(void 0===i)for(let e=0;e<n.length;++e)r.set(n[e].name,n[e]);else for(let e=0;e<n.length;++e)r.set(i[n[e].name]??n[e].name,n[e]);const o=new Array(e.boneTracks.length),a=e.boneTracks;for(let e=0;e<a.length;++e){const t=a[e],i=r.get(t.name);void 0===i?(s?.warn(`Binding failed: bone ${t.name} not found`),o[e]=null):o[e]=i}const l=new Array(e.moveableBoneTracks.length),h=e.moveableBoneTracks;for(let e=0;e<h.length;++e){const t=h[e],i=r.get(t.name);void 0===i?(s?.warn(`Binding failed: bone ${t.name} not found`),l[e]=null):l[e]=i}const c=t.morph,d=new Array(e.morphTracks.length),u=e.morphTracks;for(let e=0;e<u.length;++e){const t=u[e],n=i?.[t.name]??t.name,r=c.getMorphIndices(n);void 0===r?(s?.warn(`Binding failed: morph ${n} not found`),d[e]=null):d[e]=r}const _=t.sortedRuntimeBones,f=new Map;if(void 0===i)for(let e=0;e<_.length;++e)f.set(_[e].name,e);else for(let e=0;e<_.length;++e)f.set(i[_[e].name]??_[e].name,e);const p=new Array(e.propertyTrack.ikBoneNames.length),m=e.propertyTrack.ikBoneNames;for(let e=0;e<m.length;++e){const t=m[e],i=f.get(t);if(void 0===i)s?.warn(`Binding failed: IK bone ${t} not found`),p[e]=null;else{const n=_[i].ikSolver;null===n?(s?.warn(`Binding failed: IK solver for bone ${t} not found`),p[e]=null):p[e]=n}}return new ac(e,o,l,c,d,t.mesh,p)}static InduceMaterialRecompile=oc}ic.prototype.createRuntimeModelAnimation=function(e,t,i){return ac.Create(this,e,t,i)},Oi.prototype.enableDepthRenderer=function(e,t=!1,i=!1,s=3,n=!1){if(!(e=e||this.activeCamera))throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[e.id]){const r=!!this.getEngine().getCaps().textureFloatRender;let o=0;o=!this.getEngine().getCaps().textureHalfFloatRender||i&&r?r?1:0:2,this._depthRenderer[e.id]=new ds(this,o,e,t,s,n)}return this._depthRenderer[e.id]},Oi.prototype.disableDepthRenderer=function(e){(e=e||this.activeCamera)&&this._depthRenderer&&this._depthRenderer[e.id]&&this._depthRenderer[e.id].dispose()};class lc{constructor(e){this.name=li.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(li.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(li.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}ds._SceneComponentInitialization=e=>{let t=e._getComponent(li.NAME_DEPTHRENDERER);t||(t=new lc(e),e._addComponent(t))};F.ShadersStore.glowMapGenerationPixelShader="#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)\n#include<helperFunctions>\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;uniform sampler2D diffuseSampler;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;uniform sampler2D opacitySampler;uniform float opacityIntensity;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;uniform sampler2D emissiveSampler;\n#endif\n#ifdef VERTEXALPHA\nvarying vec4 vColor;\n#endif\nuniform vec4 glowColor;uniform float glowIntensity;\n#include<clipPlaneFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#include<clipPlaneFragment>\nvec4 finalColor=glowColor;\n#ifdef DIFFUSE\nvec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);\n#ifdef DIFFUSE_ISLINEAR\nalbedoTexture=toGammaSpace(albedoTexture);\n#endif\n#ifdef GLOW\nfinalColor.a*=albedoTexture.a;\n#endif\n#ifdef HIGHLIGHT\nfinalColor.a=albedoTexture.a;\n#endif\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vUVOpacity);\n#ifdef OPACITYRGB\nfinalColor.a*=getLuminance(opacityMap.rgb);\n#else\nfinalColor.a*=opacityMap.a;\n#endif\nfinalColor.a*=opacityIntensity;\n#endif\n#ifdef VERTEXALPHA\nfinalColor.a*=vColor.a;\n#endif\n#ifdef ALPHATEST\nif (finalColor.a<ALPHATESTVALUE)\ndiscard;\n#endif\n#ifdef EMISSIVE\nvec4 emissive=texture2D(emissiveSampler,vUVEmissive);\n#ifdef EMISSIVE_ISLINEAR\nemissive=toGammaSpace(emissive);\n#endif\ngl_FragColor=emissive*finalColor*glowIntensity;\n#else\ngl_FragColor=finalColor*glowIntensity;\n#endif\n#ifdef HIGHLIGHT\ngl_FragColor.a=glowColor.a;\n#endif\n}";F.ShadersStore.glowMapGenerationVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\n#include<instancesDeclaration>\nuniform mat4 viewProjection;varying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef DIFFUSE\nvarying vec2 vUVDiffuse;uniform mat4 diffuseMatrix;\n#endif\n#ifdef OPACITY\nvarying vec2 vUVOpacity;uniform mat4 opacityMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;uniform mat4 emissiveMatrix;\n#endif\n#ifdef VERTEXALPHA\nattribute vec4 color;varying vec4 vColor;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\n#ifdef CUBEMAP\nvPosition=worldPos;gl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*worldPos;gl_Position=vPosition;\n#endif\n#ifdef DIFFUSE\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef OPACITY\n#ifdef OPACITYUV1\nvUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef OPACITYUV2\nvUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef VERTEXALPHA\nvColor=color;\n#endif\n#include<clipPlaneVertex>\n}";class hc{get camera(){return this._effectLayerOptions.camera}get renderingGroupId(){return this._effectLayerOptions.renderingGroupId}set renderingGroupId(e){this._effectLayerOptions.renderingGroupId=e}get mainTexture(){return this._mainTexture}setMaterialForRendering(e,t){if(this._mainTexture.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){const s=e[i];t?this._materialForRendering[s.uniqueId]=[s,t]:delete this._materialForRendering[s.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}getEffectIntensity(e){var t;return null!==(t=this._effectIntensity[e.uniqueId])&&void 0!==t?t:1}setEffectIntensity(e,t){this._effectIntensity[e.uniqueId]=t}constructor(e,t){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new Ie},this._effectIntensity={},this.neutralColor=new Ie,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new s,this.onBeforeRenderMainTextureObservable=new s,this.onBeforeComposeObservable=new s,this.onBeforeRenderMeshToEffect=new s,this.onAfterRenderMeshToEffect=new s,this.onAfterComposeObservable=new s,this.onSizeChangedObservable=new s,this._materialForRendering={},this.name=e,this._scene=t||u.LastCreatedScene,hc._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}_numInternalDraws(){return 1}_init(e){this._effectLayerOptions=Object.assign({mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,generateStencilBuffer:!1},e),this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses()}_generateIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);const t=new Oe(this._engine,e,Oe.PositionKind,!1,!1,2);this._vertexBuffers[Oe.PositionKind]=t}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?te.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?te.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new Ji("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,this._effectLayerOptions.mainTextureType,!1,zi.TRILINEAR_SAMPLINGMODE,!0,this._effectLayerOptions.generateStencilBuffer),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=zi.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=zi.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(zi.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0;for(const e in this._materialForRendering){const[t,i]=this._materialForRendering[e];this._mainTexture.setMaterialForRendering(t,i)}if(this._mainTexture.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const i=e.subMeshes[t],s=i.getMaterial(),n=i.getRenderingMesh();if(!s)continue;const r=n._getInstancesRenderList(i._id,!!i.getReplacementMesh()).hardwareInstancedRendering[i._id]||n.hasThinInstances;if(this._setEmissiveTextureAndColor(n,i,s),!this._isReady(i,r,this._emissiveTextureAndColor.texture))return!1}return!0},this._mainTexture.customRenderFunction=(e,t,i,s)=>{let n;this.onBeforeRenderMainTextureObservable.notifyObservers(this);const r=this._scene.getEngine();if(s.length){for(r.setColorWrite(!1),n=0;n<s.length;n++)this._renderSubMesh(s.data[n]);r.setColorWrite(!0)}for(n=0;n<e.length;n++)this._renderSubMesh(e.data[n]);for(n=0;n<t.length;n++)this._renderSubMesh(t.data[n]);const o=r.getAlphaMode();for(n=0;n<i.length;n++)this._renderSubMesh(i.data[n],!0);r.setAlphaMode(o)},this._mainTexture.onClearObservable.add((e=>{e.clear(this.neutralColor,!0,!0,!0)})),this._scene.getBoundingBoxRenderer){const e=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add((()=>{this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&e})),this._mainTexture.onAfterUnbindObservable.add((()=>{this._scene.getBoundingBoxRenderer().enabled=e}))}}_addCustomEffectDefines(e){}_isReady(e,t,i){var s;const n=this._scene.getEngine(),r=e.getMesh(),o=null===(s=r._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===s?void 0:s[n.currentRenderPassId];if(o)return o.isReadyForSubMesh(r,e,t);const a=e.getMaterial();if(!a)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return a.isReadyForSubMesh(e.getMesh(),e,t);const l=[],h=[Oe.PositionKind];let c=!1,d=!1;if(a){const e=a.needAlphaTesting(),t=a.getAlphaTestTexture(),i=t&&t.hasAlpha&&(a.useAlphaFromDiffuseTexture||a._useAlphaFromAlbedoTexture);t&&(e||i)&&(l.push("#define DIFFUSE"),r.isVerticesDataPresent(Oe.UV2Kind)&&1===t.coordinatesIndex?(l.push("#define DIFFUSEUV2"),d=!0):r.isVerticesDataPresent(Oe.UVKind)&&(l.push("#define DIFFUSEUV1"),c=!0),e&&(l.push("#define ALPHATEST"),l.push("#define ALPHATESTVALUE 0.4")),t.gammaSpace||l.push("#define DIFFUSE_ISLINEAR"));const s=a.opacityTexture;s&&(l.push("#define OPACITY"),r.isVerticesDataPresent(Oe.UV2Kind)&&1===s.coordinatesIndex?(l.push("#define OPACITYUV2"),d=!0):r.isVerticesDataPresent(Oe.UVKind)&&(l.push("#define OPACITYUV1"),c=!0))}i&&(l.push("#define EMISSIVE"),r.isVerticesDataPresent(Oe.UV2Kind)&&1===i.coordinatesIndex?(l.push("#define EMISSIVEUV2"),d=!0):r.isVerticesDataPresent(Oe.UVKind)&&(l.push("#define EMISSIVEUV1"),c=!0),i.gammaSpace||l.push("#define EMISSIVE_ISLINEAR")),r.useVertexColors&&r.isVerticesDataPresent(Oe.ColorKind)&&r.hasVertexAlpha&&a.transparencyMode!==Ps.MATERIAL_OPAQUE&&(h.push(Oe.ColorKind),l.push("#define VERTEXALPHA")),c&&(h.push(Oe.UVKind),l.push("#define UV1")),d&&(h.push(Oe.UV2Kind),l.push("#define UV2"));const u=new is;if(r.useBones&&r.computeBonesUsingShaders){h.push(Oe.MatricesIndicesKind),h.push(Oe.MatricesWeightsKind),r.numBoneInfluencers>4&&(h.push(Oe.MatricesIndicesExtraKind),h.push(Oe.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers);const e=r.skeleton;e&&e.isUsingTextureForMatrices?l.push("#define BONETEXTURE"):l.push("#define BonesPerMesh "+(e?e.bones.length+1:0)),r.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,r)}else l.push("#define NUM_BONE_INFLUENCERS 0");const _=r.morphTargetManager;let f=0;_&&_.numInfluencers>0&&(l.push("#define MORPHTARGETS"),f=_.numInfluencers,l.push("#define NUM_MORPH_INFLUENCERS "+f),_.isUsingTextureForTargets&&l.push("#define MORPHTARGETS_TEXTURE"),wi.PrepareAttributesForMorphTargetsInfluencers(h,r,f)),t&&(l.push("#define INSTANCES"),wi.PushAttributesForInstances(h),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),Ni(a,this._scene,l),this._addCustomEffectDefines(l);const p=e._getDrawWrapper(void 0,!0),m=p.defines,g=l.join("\n");if(m!==g){const e=["world","mBones","viewProjection","glowColor","morphTargetInfluences","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","glowIntensity"];Di(e),p.setEffect(this._engine.createEffect("glowMapGeneration",h,e,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],g,u,void 0,void 0,{maxSimultaneousMorphTargets:f}),g)}return p.effect.isReady()}render(){for(let e=0;e<this._postProcesses.length;e++)if(!this._postProcesses[e].isReady())return;const e=this._scene.getEngine(),t=this._numInternalDraws();let i=!0;for(let e=0;e<t;++e){let t=this._mergeDrawWrapper[e];t||(t=this._mergeDrawWrapper[e]=new Y(this._engine),t.setEffect(this._createMergeEffect())),i=i&&t.effect.isReady()}if(!i)return;this.onBeforeComposeObservable.notifyObservers(this);const s=e.getAlphaMode();for(let i=0;i<t;++i){const t=this._mergeDrawWrapper[i];e.enableEffect(t),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t.effect),e.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(t.effect,i)}e.setAlphaMode(s),this.onAfterComposeObservable.notifyObservers(this);const n=this._mainTexture.getSize();this._setMainTextureSize(),n.width===this._mainTextureDesiredSize.width&&n.height===this._mainTextureDesiredSize.height||0===this._mainTextureDesiredSize.width||0===this._mainTextureDesiredSize.height||(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}hasMesh(e){return-1===this.renderingGroupId||e.renderingGroupId===this.renderingGroupId}shouldRender(){return this.isEnabled&&this._shouldRender}_shouldRenderMesh(e){return!0}_canRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_shouldRenderEmissiveTextureForMesh(){return!0}_renderSubMesh(e,t=!1){var i,s;if(!this.shouldRender())return;const n=e.getMaterial(),r=e.getMesh(),o=e.getReplacementMesh(),a=e.getRenderingMesh(),l=e.getEffectiveMesh(),h=this._scene,c=h.getEngine();if(l._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!n)return;if(!this._canRenderMesh(a,n))return;let d=null!==(i=a.overrideMaterialSideOrientation)&&void 0!==i?i:n.sideOrientation;l._getWorldMatrixDeterminant()<0&&(d=d===Ps.ClockWiseSideOrientation?Ps.CounterClockWiseSideOrientation:Ps.ClockWiseSideOrientation);const u=d===Ps.ClockWiseSideOrientation;c.setState(n.backFaceCulling,n.zOffset,void 0,u,n.cullBackFaces,void 0,n.zOffsetUnits);const _=a._getInstancesRenderList(e._id,!!o);if(_.mustReturn)return;if(!this._shouldRenderMesh(a))return;const f=_.hardwareInstancedRendering[e._id]||a.hasThinInstances;if(this._setEmissiveTextureAndColor(a,e,n),this.onBeforeRenderMeshToEffect.notifyObservers(r),this._useMeshMaterial(a))a.render(e,t,o||void 0);else if(this._isReady(e,f,this._emissiveTextureAndColor.texture)){const i=null===(s=l._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===s?void 0:s[c.currentRenderPassId];let r=e._getDrawWrapper();if(!r&&i&&(r=i._getDrawWrapper()),!r)return;const o=r.effect;if(c.enableEffect(r),f||a._bind(e,o,n.fillMode),i?i.bindForSubMesh(l.getWorldMatrix(),l,e):(o.setMatrix("viewProjection",h.getTransformMatrix()),o.setMatrix("world",l.getWorldMatrix()),o.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!i){const e=n.needAlphaTesting(),i=n.getAlphaTestTexture(),s=i&&i.hasAlpha&&(n.useAlphaFromDiffuseTexture||n._useAlphaFromAlbedoTexture);if(i&&(e||s)){o.setTexture("diffuseSampler",i);const e=i.getTextureMatrix();e&&o.setMatrix("diffuseMatrix",e)}const r=n.opacityTexture;if(r){o.setTexture("opacitySampler",r),o.setFloat("opacityIntensity",r.level);const e=r.getTextureMatrix();e&&o.setMatrix("opacityMatrix",e)}if(this._emissiveTextureAndColor.texture&&(o.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),o.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),a.useBones&&a.computeBonesUsingShaders&&a.skeleton){const e=a.skeleton;if(e.isUsingTextureForMatrices){const t=e.getTransformMatrixTexture(a);if(!t)return;o.setTexture("boneSampler",t),o.setFloat("boneTextureWidth",4*(e.bones.length+1))}else o.setMatrices("mBones",e.getTransformMatrices(a))}wi.BindMorphTargetParameters(a,o),a.morphTargetManager&&a.morphTargetManager.isUsingTextureForTargets&&a.morphTargetManager._bind(o),t&&c.setAlphaMode(n.alphaMode),o.setFloat("glowIntensity",this.getEffectIntensity(a)),Fi(o,n,h)}a._processRendering(l,e,o,n.fillMode,_,f,((e,t)=>o.setMatrix("world",t)))}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(r)}_useMeshMaterial(e){return!1}_rebuild(){const e=this._vertexBuffers[Oe.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){const e=this._vertexBuffers[Oe.PositionKind];e&&(e.dispose(),this._vertexBuffers[Oe.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(const e of this._mergeDrawWrapper)e.dispose();this._mergeDrawWrapper=[],this._disposeTextureAndPostProcesses();const t=this._scene.effectLayers.indexOf(this,0);t>-1&&this._scene.effectLayers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return Ot.Instantiate(e.customType).Parse(e,t,i)}}hc._SceneComponentInitialization=e=>{throw f("EffectLayerSceneComponent")},De([Ge()],hc.prototype,"name",void 0),De([Ke()],hc.prototype,"neutralColor",void 0),De([Ge()],hc.prototype,"isEnabled",void 0),De([ke(11,void 0)],hc.prototype,"camera",null),De([Ge()],hc.prototype,"renderingGroupId",null),De([Ge()],hc.prototype,"disableBoundingBoxesFromEffectLayer",void 0),Ht.AddParser(li.NAME_EFFECTLAYER,((e,t,i,s)=>{if(e.effectLayers){i.effectLayers||(i.effectLayers=[]);for(let n=0;n<e.effectLayers.length;n++){const r=hc.Parse(e.effectLayers[n],t,s);i.effectLayers.push(r)}}})),Ht.prototype.removeEffectLayer=function(e){const t=this.effectLayers.indexOf(e);return-1!==t&&this.effectLayers.splice(t,1),t},Ht.prototype.addEffectLayer=function(e){this.effectLayers.push(e)};class cc{constructor(e){this.name=li.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||u.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.effectLayers=[])}register(){this.scene._isReadyForMeshStage.registerStep(li.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(li.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(li.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(li.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(li.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(li.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.addEffectLayer(e)}))}removeFromContainer(e,t){e.effectLayers&&e.effectLayers.forEach((e=>{this.scene.removeEffectLayer(e),t&&e.dispose()}))}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,s=this.scene.effectLayers;for(const n of s){if(!n.hasMesh(e))continue;const s=n._mainTexture;this._engine.currentRenderPassId=s.renderPassId;for(const s of e.subMeshes)if(!n.isReady(s,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const s of i)if(s.shouldRender()&&(!s.camera||s.camera.cameraRigMode===Gt.RIG_MODE_NONE&&e===s.camera||s.camera.cameraRigMode!==Gt.RIG_MODE_NONE&&s.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||s.needStencil();const e=s._mainTexture;e._shouldRender()&&(this.scene.incrementRenderId(),e.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const s=t[i];s.renderingGroupId===e&&s.shouldRender()&&s.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}hc._SceneComponentInitialization=e=>{let t=e._getComponent(li.NAME_EFFECTLAYER);t||(t=new cc(e),e._addComponent(t))};F.ShadersStore.glowMapMergePixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#ifdef EMISSIVE\nuniform sampler2D textureSampler2;\n#endif\nuniform float offset;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef EMISSIVE\nbaseColor+=texture2D(textureSampler2,vUV);baseColor*=offset;\n#else\nbaseColor.a=abs(offset-baseColor.a);\n#ifdef STROKE\nfloat alpha=smoothstep(.0,.1,baseColor.a);baseColor.a=alpha;baseColor.rgb=baseColor.rgb*alpha;\n#endif\n#endif\n#if LDR\nbaseColor=clamp(baseColor,0.,1.0);\n#endif\ngl_FragColor=baseColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";F.ShadersStore.glowMapMergeVertexShader="attribute vec2 position;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}",Ht.prototype.getGlowLayerByName=function(e){var t;for(let i=0;i<(null===(t=this.effectLayers)||void 0===t?void 0:t.length);i++)if(this.effectLayers[i].name===e&&this.effectLayers[i].getEffectName()===dc.EffectName)return this.effectLayers[i];return null};class dc extends hc{set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;const t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}constructor(e,t,i){super(e,t),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this.neutralColor=new Ie(0,0,0,1),this._options=Object.assign({mainTextureRatio:dc.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,generateStencilBuffer:!1},i),this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType,generateStencilBuffer:this._options.generateStencilBuffer})}getEffectName(){return dc.EffectName}_createMergeEffect(){let e="#define EMISSIVE \n";return this._options.ldrMerge&&(e+="#define LDR \n"),this._engine.createEffect("glowMapMerge",[Oe.PositionKind],["offset"],["textureSampler","textureSampler2"],e)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?te.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?te.GetExponentOfTwo(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture1=new Ji("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=zi.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=zi.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(zi.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;const s=Math.floor(e/2),n=Math.floor(t/2);this._blurTexture2=new Ji("GlowLayerBlurRTT2",{width:s,height:n},this._scene,!1,!0,i),this._blurTexture2.wrapU=zi.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=zi.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(zi.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2];const r=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new ts("GlowLayerHBP1",new pe(1,0),r,{width:e,height:t},null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._verticalBlurPostprocess1=new ts("GlowLayerVBP1",new pe(0,1),r,{width:e,height:t},null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2=new ts("GlowLayerHBP2",new pe(1,0),r,{width:s,height:n},null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2.width=s,this._horizontalBlurPostprocess2.height=n,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._blurTexture1)})),this._verticalBlurPostprocess2=new ts("GlowLayerVBP2",new pe(0,1),r,{width:s,height:n},null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add((()=>{const e=this._blurTexture1.renderTarget;if(e){this._scene.postProcessManager.directRender(this._postProcesses1,e,!0);const t=this._blurTexture2.renderTarget;t&&this._scene.postProcessManager.directRender(this._postProcesses2,t,!0),this._engine.unBindFramebuffer(null!=t?t:e,!0)}})),this._postProcesses.map((e=>{e.autoClear=!1}))}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();if(!i||!s)return!1;const n=i.emissiveTexture;return super._isReady(e,t,n)}needStencil(){return!1}_canRenderMesh(e,t){return!0}_internalRender(e){e.setTexture("textureSampler",this._blurTexture1),e.setTexture("textureSampler2",this._blurTexture2),e.setFloat("offset",this._intensity);const t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(Ps.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){var s;let n=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(n=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector?this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color):i.emissiveColor?(n*=null!==(s=i.emissiveIntensity)&&void 0!==s?s:1,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*n,i.emissiveColor.g*n,i.emissiveColor.b*n,i.alpha)):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){-1===this._includedOnlyMeshes.indexOf(e.uniqueId)&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){const t=this._includedOnlyMeshes.indexOf(e.uniqueId);-1!==t&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return!!super.hasMesh(e)&&(this._includedOnlyMeshes.length?-1!==this._includedOnlyMeshes.indexOf(e.uniqueId):!this._excludedMeshes.length||-1===this._excludedMeshes.indexOf(e.uniqueId))}_useMeshMaterial(e){return 0!=this._meshesUsingTheirOwnMaterials.length&&this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._mainTexture.renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))}unReferenceMeshFromUsingItsOwnMaterial(e){let t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;t>=0;)this._meshesUsingTheirOwnMaterials.splice(t,1),t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(this._mainTexture.renderPassId)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}getClassName(){return"GlowLayer"}serialize(){const e=qe.Serialize(this);let t;if(e.customType="BABYLON.GlowLayer",e.includedMeshes=[],this._includedOnlyMeshes.length)for(t=0;t<this._includedOnlyMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._includedOnlyMeshes[t]);i&&e.includedMeshes.push(i.id)}if(e.excludedMeshes=[],this._excludedMeshes.length)for(t=0;t<this._excludedMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._excludedMeshes[t]);i&&e.excludedMeshes.push(i.id)}return e}static Parse(e,t,i){const s=qe.Parse((()=>new dc(e.name,t,e.options)),e,t,i);let n;for(n=0;n<e.excludedMeshes.length;n++){const i=t.getMeshById(e.excludedMeshes[n]);i&&s.addExcludedMesh(i)}for(n=0;n<e.includedMeshes.length;n++){const i=t.getMeshById(e.includedMeshes[n]);i&&s.addIncludedOnlyMesh(i)}return s}}dc.EffectName="GlowLayer",dc.DefaultBlurKernelSize=32,dc.DefaultTextureRatio=.5,De([Ge()],dc.prototype,"blurKernelSize",null),De([Ge()],dc.prototype,"intensity",null),De([Ge("options")],dc.prototype,"_options",void 0),ue("BABYLON.GlowLayer",dc);F.ShadersStore.glowBlurPostProcessPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 direction;uniform float blurWidth;float getLuminance(vec3 color)\n{return dot(color,vec3(0.2126,0.7152,0.0722));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float weights[7];weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);vec2 texelStep=texelSize*direction*blurWidth;vec2 start=vUV-3.0*texelStep;vec4 baseColor=vec4(0.,0.,0.,0.);vec2 texelOffset=vec2(0.,0.);for (int i=0; i<7; i++)\n{vec4 texel=texture2D(textureSampler,start+texelOffset);baseColor.a+=texel.a*weights[i];float luminance=getLuminance(baseColor.rgb);float luminanceTexel=getLuminance(texel.rgb);float choice=step(luminanceTexel,luminance);baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;texelOffset+=texelStep;}\ngl_FragColor=baseColor;}",Ht.prototype.getHighlightLayerByName=function(e){var t;for(let i=0;i<(null===(t=this.effectLayers)||void 0===t?void 0:t.length);i++)if(this.effectLayers[i].name===e&&this.effectLayers[i].getEffectName()===_c.EffectName)return this.effectLayers[i];return null};class uc extends es{constructor(e,t,i,s,n,r=zi.BILINEAR_SAMPLINGMODE,o,a){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,s,n,r,o,a),this.direction=t,this.kernel=i,this.onApplyObservable.add((e=>{e.setFloat2("screenSize",this.width,this.height),e.setVector2("direction",this.direction),e.setFloat("blurWidth",this.kernel)}))}}class _c extends hc{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i){super(e,t),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new s,this.onAfterBlurObservable=new s,this._instanceGlowingMeshStencilReference=_c.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=_c.NeutralColor,this._engine.isStencilEnable||p.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options=Object.assign({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0},i),this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType}),this._shouldRender=!1}getEffectName(){return _c.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[Oe.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":void 0)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?te.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?te.GetExponentOfTwo(t,this._maxSize):t;let i=0;i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture=new Ji("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=zi.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=zi.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(zi.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],2===this._options.alphaBlendingMode?(this._downSamplePostprocess=new Hs("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._horizontalBlurPostprocess=new uc("HighlightLayerHBP",new pe(1,0),this._options.blurHorizontalSize,1,null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._verticalBlurPostprocess=new uc("HighlightLayerVBP",new pe(0,1),this._options.blurVerticalSize,1,null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add((i=>{i.setFloat2("screenSize",e,t)})),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new ts("HighlightLayerHBP",new pe(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess.width=e,this._horizontalBlurPostprocess.height=t,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add((e=>{e.setTexture("textureSampler",this._mainTexture)})),this._verticalBlurPostprocess=new ts("HighlightLayerVBP",new pe(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add((()=>{this.onBeforeBlurObservable.notifyObservers(this);const e=this._blurTexture.renderTarget;e&&(this._scene.postProcessManager.directRender(this._postProcesses,e,!0),this._engine.unBindFramebuffer(e,!0)),this.onAfterBlurObservable.notifyObservers(this)})),this._postProcesses.map((e=>{e.autoClear=!1}))}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();if(!i||!s||!this._meshes)return!1;let n=null;const r=this._meshes[s.uniqueId];return r&&r.glowEmissiveOnly&&i&&(n=i.emissiveTexture),super._isReady(e,t,n)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&0===t&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(Ps.TriangleFillMode,0,6)),this.innerGlow&&1===t&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(Ps.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return!!super.shouldRender()&&!!this._meshes}_shouldRenderMesh(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!super.hasMesh(e))}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){const s=this._meshes[e.uniqueId];s?this._emissiveTextureAndColor.color.set(s.color.r,s.color.g,s.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),s&&s.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){if(this._excludedMeshes&&!this._excludedMeshes[e.uniqueId]){const t={mesh:e,beforeBind:null,afterRender:null,stencilState:!1};t.beforeBind=e.onBeforeBindObservable.add((e=>{t.stencilState=e.getEngine().getStencilBuffer(),e.getEngine().setStencilBuffer(!1)})),t.afterRender=e.onAfterRenderObservable.add((e=>{e.getEngine().setStencilBuffer(t.stencilState)})),this._excludedMeshes[e.uniqueId]=t}}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!!this._meshes&&!!super.hasMesh(e)&&void 0!==this._meshes[e.uniqueId]&&null!==this._meshes[e.uniqueId]}addMesh(e,t,i=!1){if(!this._meshes)return;const s=this._meshes[e.uniqueId];s?s.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add((e=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]?this._defaultStencilReference(e):e.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))})),observerDefault:e.onAfterRenderObservable.add((e=>{this.isEnabled&&this._defaultStencilReference(e)})),glowEmissiveOnly:i},e.onDisposeObservable.add((()=>{this._disposeMesh(e)}))),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const e in this._meshes)if(this._meshes[e]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes)for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(_c.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){const e=qe.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(const t in this._meshes){const i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(const t in this._excludedMeshes){const i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){const s=qe.Parse((()=>new _c(e.name,t,e.options)),e,t,i);let n;for(n=0;n<e.excludedMeshes.length;n++){const i=t.getMeshById(e.excludedMeshes[n]);i&&s.addExcludedMesh(i)}for(n=0;n<e.meshes.length;n++){const i=e.meshes[n],r=t.getMeshById(i.meshId);r&&s.addMesh(r,Re.FromArray(i.color),i.glowEmissiveOnly)}return s}}_c.EffectName="HighlightLayer",_c.NeutralColor=new Ie(0,0,0,0),_c.GlowingMeshStencilReference=2,_c.NormalMeshStencilReference=1,De([Ge()],_c.prototype,"innerGlow",void 0),De([Ge()],_c.prototype,"outerGlow",void 0),De([Ge()],_c.prototype,"blurHorizontalSize",null),De([Ge()],_c.prototype,"blurVerticalSize",null),De([Ge("options")],_c.prototype,"_options",void 0),ue("BABYLON.HighlightLayer",_c);class fc{constructor(e){this.name=li.NAME_LAYER,this.scene=e||u.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.layers=[])}register(){this.scene._beforeCameraDrawStage.registerStep(li.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(li.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForegroundWithPostProcessing),this.scene._afterCameraPostProcessStage.registerStep(li.STEP_AFTERCAMERAPOSTPROCESS_LAYER,this,this._drawCameraForegroundWithoutPostProcessing),this.scene._beforeRenderTargetDrawStage.registerStep(li.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(li.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForegroundWithPostProcessing),this.scene._afterRenderTargetPostProcessStage.registerStep(li.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER,this,this._drawRenderTargetForegroundWithoutPostProcessing)}rebuild(){const e=this.scene.layers;for(const t of e)t._rebuild()}dispose(){const e=this.scene.layers;for(;e.length;)e[0].dispose()}_draw(e){const t=this.scene.layers;if(t.length){this._engine.setDepthBuffer(!1);for(const i of t)e(i)&&i.render();this._engine.setDepthBuffer(!0)}}_drawCameraPredicate(e,t,i,s){return!e.renderOnlyInRenderTargetTextures&&e.isBackground===t&&e.applyPostProcess===i&&0!=(e.layerMask&s)}_drawCameraBackground(e){this._draw((t=>this._drawCameraPredicate(t,!0,!0,e.layerMask)))}_drawCameraForegroundWithPostProcessing(e){this._draw((t=>this._drawCameraPredicate(t,!1,!0,e.layerMask)))}_drawCameraForegroundWithoutPostProcessing(e){this._draw((t=>this._drawCameraPredicate(t,!1,!1,e.layerMask)))}_drawRenderTargetPredicate(e,t,i,s,n){return e.renderTargetTextures.length>0&&e.isBackground===t&&e.applyPostProcess===i&&e.renderTargetTextures.indexOf(n)>-1&&0!=(e.layerMask&s)}_drawRenderTargetBackground(e){this._draw((t=>this._drawRenderTargetPredicate(t,!0,!0,this.scene.activeCamera.layerMask,e)))}_drawRenderTargetForegroundWithPostProcessing(e){this._draw((t=>this._drawRenderTargetPredicate(t,!1,!0,this.scene.activeCamera.layerMask,e)))}_drawRenderTargetForegroundWithoutPostProcessing(e){this._draw((t=>this._drawRenderTargetPredicate(t,!1,!1,this.scene.activeCamera.layerMask,e)))}addFromContainer(e){e.layers&&e.layers.forEach((e=>{this.scene.layers.push(e)}))}removeFromContainer(e,t=!1){e.layers&&e.layers.forEach((e=>{const i=this.scene.layers.indexOf(e);-1!==i&&this.scene.layers.splice(i,1),t&&e.dispose()}))}}F.ShadersStore.layerPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;\n#include<helperFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef LINEAR\nbaseColor.rgb=toGammaSpace(baseColor.rgb);\n#endif\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}";F.ShadersStore.layerVertexShader="attribute vec2 position;uniform vec2 scale;uniform vec2 offset;uniform mat4 textureMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec2 shiftedPosition=position*scale+offset;vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));gl_Position=vec4(shiftedPosition,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class pc{set applyPostProcess(e){this._applyPostProcess=e}get applyPostProcess(){return this.isBackground||this._applyPostProcess}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}constructor(e,t,i,n,r){this.name=e,this._applyPostProcess=!0,this.scale=new pe(1,1),this.offset=new pe(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this.isEnabled=!0,this._vertexBuffers={},this.onDisposeObservable=new s,this.onBeforeRenderObservable=new s,this.onAfterRenderObservable=new s,this.texture=t?new zi(t,i,!0):null,this.isBackground=void 0===n||n,this.color=void 0===r?new Ie(1,1,1,1):r,this._scene=i||u.LastCreatedScene;let o=this._scene._getComponent(li.NAME_LAYER);o||(o=new fc(this._scene),this._scene._addComponent(o)),this._scene.layers.push(this);const a=this._scene.getEngine();this._drawWrapper=new Y(a);const l=[];l.push(1,1),l.push(-1,1),l.push(-1,-1),l.push(1,-1);const h=new Oe(a,l,Oe.PositionKind,!1,!1,2);this._vertexBuffers[Oe.PositionKind]=h,this._createIndexBuffer()}_createIndexBuffer(){const e=this._scene.getEngine(),t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[Oe.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}isReady(){var e;const t=this._scene.getEngine();let i="";this.alphaTest&&(i="#define ALPHATEST"),this.texture&&!this.texture.gammaSpace&&(i+="\n#define LINEAR"),this._previousDefines!==i&&(this._previousDefines=i,this._drawWrapper.effect=t.createEffect("layer",[Oe.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],i));const s=this._drawWrapper.effect;return(null==s?void 0:s.isReady())&&(null===(e=this.texture)||void 0===e?void 0:e.isReady())}render(){if(!this.isEnabled)return;const e=this._scene.getEngine();if(!this.isReady())return;const t=this._drawWrapper.effect;this.onBeforeRenderObservable.notifyObservers(this),e.enableEffect(this._drawWrapper),e.setState(!1),t.setTexture("textureSampler",this.texture),t.setMatrix("textureMatrix",this.texture.getTextureMatrix()),t.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),t.setVector2("offset",this.offset),t.setVector2("scale",this.scale),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t),this.alphaTest?e.drawElementsType(Ps.TriangleFillMode,0,6):(e.setAlphaMode(this.alphaBlendingMode),e.drawElementsType(Ps.TriangleFillMode,0,6),e.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this)}dispose(){const e=this._vertexBuffers[Oe.PositionKind];e&&(e.dispose(),this._vertexBuffers[Oe.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];const t=this._scene.layers.indexOf(this);this._scene.layers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()}}et.AddNodeConstructor("Light_Type_1",((e,t)=>()=>new mc(e,me.Zero(),t)));class mc extends Ul{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return Lt.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&Te.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const e=me.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let s=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let r=0;r<i.length;r++){const o=i[r];if(!o)continue;const a=o.getBoundingInfo().boundingBox;for(let i=0;i<a.vectorsWorld.length;i++)me.TransformCoordinatesToRef(a.vectorsWorld[i],t,e),e.x<this._orthoLeft&&(this._orthoLeft=e.x),e.y<this._orthoBottom&&(this._orthoBottom=e.y),e.x>this._orthoRight&&(this._orthoRight=e.x),e.y>this._orthoTop&&(this._orthoTop=e.y),this.autoCalcShadowZBounds&&(e.z<s&&(s=e.z),e.z>n&&(n=e.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=s,this._shadowMaxZ=n)}const n=this._orthoRight-this._orthoLeft,r=this._orthoTop-this._orthoBottom,o=void 0!==this.shadowMinZ?this.shadowMinZ:s.minZ,a=void 0!==this.shadowMaxZ?this.shadowMaxZ:s.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;Te.OrthoOffCenterLHToRef(this._orthoLeft-n*this.shadowOrthoScale,this._orthoRight+n*this.shadowOrthoScale,this._orthoBottom-r*this.shadowOrthoScale,this._orthoTop+r*this.shadowOrthoScale,l?a:o,l?o:a,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}var gc,vc,Tc,bc,Ec,Sc,xc,Cc,yc,Ac,Rc;De([Ge()],mc.prototype,"shadowFrustumSize",null),De([Ge()],mc.prototype,"shadowOrthoScale",null),De([Ge()],mc.prototype,"autoUpdateExtends",void 0),De([Ge()],mc.prototype,"autoCalcShadowZBounds",void 0),De([Ge("orthoLeft")],mc.prototype,"_orthoLeft",void 0),De([Ge("orthoRight")],mc.prototype,"_orthoRight",void 0),De([Ge("orthoTop")],mc.prototype,"_orthoTop",void 0),De([Ge("orthoBottom")],mc.prototype,"_orthoBottom",void 0),function(e){e[e.FREE=0]="FREE",e[e.LIMITED=1]="LIMITED",e[e.LOCKED=2]="LOCKED"}(gc||(gc={})),(Rc=vc||(vc={}))[Rc.LINEAR_X=0]="LINEAR_X",Rc[Rc.LINEAR_Y=1]="LINEAR_Y",Rc[Rc.LINEAR_Z=2]="LINEAR_Z",Rc[Rc.ANGULAR_X=3]="ANGULAR_X",Rc[Rc.ANGULAR_Y=4]="ANGULAR_Y",Rc[Rc.ANGULAR_Z=5]="ANGULAR_Z",Rc[Rc.LINEAR_DISTANCE=6]="LINEAR_DISTANCE",(Ac=Tc||(Tc={}))[Ac.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",Ac[Ac.DISTANCE=2]="DISTANCE",Ac[Ac.HINGE=3]="HINGE",Ac[Ac.SLIDER=4]="SLIDER",Ac[Ac.LOCK=5]="LOCK",Ac[Ac.PRISMATIC=6]="PRISMATIC",Ac[Ac.SIX_DOF=7]="SIX_DOF",(yc=bc||(bc={}))[yc.SPHERE=0]="SPHERE",yc[yc.CAPSULE=1]="CAPSULE",yc[yc.CYLINDER=2]="CYLINDER",yc[yc.BOX=3]="BOX",yc[yc.CONVEX_HULL=4]="CONVEX_HULL",yc[yc.CONTAINER=5]="CONTAINER",yc[yc.MESH=6]="MESH",yc[yc.HEIGHTFIELD=7]="HEIGHTFIELD",function(e){e[e.NONE=0]="NONE",e[e.VELOCITY=1]="VELOCITY",e[e.POSITION=2]="POSITION"}(Ec||(Ec={})),function(e){e.COLLISION_STARTED="COLLISION_STARTED",e.COLLISION_CONTINUED="COLLISION_CONTINUED",e.COLLISION_FINISHED="COLLISION_FINISHED",e.TRIGGER_ENTERED="TRIGGER_ENTERED",e.TRIGGER_EXITED="TRIGGER_EXITED"}(Sc||(Sc={})),function(e){e[e.STATIC=0]="STATIC",e[e.ANIMATED=1]="ANIMATED",e[e.DYNAMIC=2]="DYNAMIC"}(xc||(xc={})),function(e){e[e.GEOMETRIC_MEAN=0]="GEOMETRIC_MEAN",e[e.MINIMUM=1]="MINIMUM",e[e.MAXIMUM=2]="MAXIMUM",e[e.ARITHMETIC_MEAN=3]="ARITHMETIC_MEAN",e[e.MULTIPLY=4]="MULTIPLY"}(Cc||(Cc={}));class Ic{constructor(e,t){var i;if(this._pluginData=void 0,this._isTrigger=!1,this._isDisposed=!1,!t)return;const s=t.getPhysicsEngine();if(!s)throw new Error("No Physics Engine available.");if(2!=s.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const n=s.getPhysicsPlugin();if(!n)throw new Error("No Physics Plugin available.");if(this._physicsPlugin=n,void 0!==e.pluginData&&null!==e.pluginData)this._pluginData=e.pluginData,this._type=this._physicsPlugin.getShapeType(this);else if(void 0!==e.type&&null!==e.type){this._type=e.type;const t=null!==(i=e.parameters)&&void 0!==i?i:{};this._physicsPlugin.initShape(this,e.type,t)}}getClassName(){return"PhysicsShape"}get type(){return this._type}set filterMembershipMask(e){this._physicsPlugin.setShapeFilterMembershipMask(this,e)}get filterMembershipMask(){return this._physicsPlugin.getShapeFilterMembershipMask(this)}set filterCollideMask(e){this._physicsPlugin.setShapeFilterCollideMask(this,e)}get filterCollideMask(){return this._physicsPlugin.getShapeFilterCollideMask(this)}set material(e){this._physicsPlugin.setMaterial(this,e),this._material=e}get material(){return this._material}set density(e){this._physicsPlugin.setDensity(this,e)}get density(){return this._physicsPlugin.getDensity(this)}addChildFromParent(e,t,i){const s=i.computeWorldMatrix(!0),n=e.computeWorldMatrix(!0),r=Ee.Matrix[0];s.multiplyToRef(Te.Invert(n),r);const o=Ee.Vector3[0],a=Ee.Quaternion[0],l=Ee.Vector3[1];r.decompose(l,a,o),this._physicsPlugin.addChild(this,t,o,a,l)}addChild(e,t,i,s){this._physicsPlugin.addChild(this,e,t,i,s)}removeChild(e){this._physicsPlugin.removeChild(this,e)}getNumChildren(){return this._physicsPlugin.getNumChildren(this)}getBoundingBox(){return this._physicsPlugin.getBoundingBox(this)}set isTrigger(e){this._isTrigger!==e&&(this._isTrigger=e,this._physicsPlugin.setTrigger(this,e))}get isTrigger(){return this._isTrigger}dispose(){this._isDisposed||(this._physicsPlugin.disposeShape(this),this._isDisposed=!0)}}class Pc extends Ic{constructor(e,t,i){super({type:bc.SPHERE,parameters:{center:e,radius:t}},i)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingSphere.center,s=t.boundingBox.extendSize,n=Math.max(s.x,s.y,s.z);return new Pc(i,n,e.getScene())}}class Mc extends Ic{constructor(e,t,i,s){super({type:bc.CAPSULE,parameters:{pointA:e,pointB:t,radius:i}},s)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingBox.extendSize.x,s=new me(0,t.boundingBox.extendSize.y-i,0),n=t.boundingBox.center.add(s),r=t.boundingBox.center.subtract(s);return new Mc(n,r,i,e.getScene())}}class Oc extends Ic{constructor(e,t,i,s){super({type:bc.BOX,parameters:{center:e,rotation:t,extents:i}},s)}static FromMesh(e){const t=e.getBoundingInfo(),i=t.boundingBox.center,s=t.boundingBox.extendSize.scale(2);return new Oc(i,ve.Identity(),s,e.getScene())}}class Dc{constructor(e,t,i){this._vertices=[],this._indices=[],this._isRightHanded=i.useRightHandedSystem,this._collectIndices=t}addNodeMeshes(e,t){e.computeWorldMatrix(!0);const i=Ee.Matrix[0];if(Te.ScalingToRef(e.absoluteScaling.x,e.absoluteScaling.y,e.absoluteScaling.z,i),e instanceof jn?this._addMesh(e,i):e instanceof Cl&&this._addMesh(e.sourceMesh,i),t){const t=Ee.Matrix[1];e.computeWorldMatrix().invertToRef(t);const s=Ee.Matrix[2];t.multiplyToRef(i,s),e.getChildMeshes(!1).filter((e=>!e.physicsBody)).forEach((e=>{const t=e.computeWorldMatrix(),i=Ee.Matrix[3];t.multiplyToRef(s,i),e instanceof jn?this._addMesh(e,i):e instanceof Cl&&this._addMesh(e.sourceMesh,i)}))}}_addMesh(e,t){const i=e.getVerticesData(Oe.PositionKind)||[],s=i.length/3,n=this._vertices.length;for(let e=0;e<s;e++){const s=new me(i[3*e+0],i[3*e+1],i[3*e+2]);this._vertices.push(me.TransformCoordinates(s,t))}if(this._collectIndices){const t=e.getIndices();if(t)for(let e=0;e<t.length;e+=3)this._isRightHanded?(this._indices.push(t[e+0]+n),this._indices.push(t[e+1]+n),this._indices.push(t[e+2]+n)):(this._indices.push(t[e+2]+n),this._indices.push(t[e+1]+n),this._indices.push(t[e+0]+n))}}getVertices(e){const t=3*this._vertices.length,i=4*t,s=e._malloc(i),n=new Float32Array(e.HEAPU8.buffer,s,t);for(let e=0;e<this._vertices.length;e++)n[3*e+0]=this._vertices[e].x,n[3*e+1]=this._vertices[e].y,n[3*e+2]=this._vertices[e].z;return{offset:s,numObjects:t}}freeBuffer(e,t){e._free(t.offset)}getTriangles(e){const t=4*this._indices.length,i=e._malloc(t),s=new Int32Array(e.HEAPU8.buffer,i,this._indices.length);for(let e=0;e<this._indices.length;e++)s[e]=this._indices[e];return{offset:i,numObjects:this._indices.length}}}class Nc{constructor(e){this.hpBodyId=e,this.userMassProps={centerOfMass:void 0,mass:void 0,inertia:void 0,inertiaOrientation:void 0}}}class Fc{constructor(){this.bodyId=BigInt(0),this.position=new me,this.normal=new me}}class Lc{constructor(){this.contactOnA=new Fc,this.contactOnB=new Fc,this.impulseApplied=0,this.type=0}static readToRef(e,t,i){const s=new Int32Array(e,t),n=new Float32Array(e,t);i.contactOnA.bodyId=BigInt(s[2]),i.contactOnA.position.set(n[10],n[11],n[12]),i.contactOnA.normal.set(n[13],n[14],n[15]),i.contactOnB.bodyId=BigInt(s[18]),i.contactOnB.position.set(n[26],n[27],n[28]),i.contactOnB.normal.set(n[29],n[30],n[31]),i.impulseApplied=n[34],i.type=s[0]}}class wc{constructor(){this.bodyIdA=BigInt(0),this.bodyIdB=BigInt(0),this.type=0}static readToRef(e,t,i){const s=new Int32Array(e,t);i.type=s[0],i.bodyIdA=BigInt(s[2]),i.bodyIdB=BigInt(s[6])}}class Bc{constructor(e=!0,t=HK){this._useDeltaForWorldStep=e,this._hknp={},this.name="HavokPlugin",this._fixedTimeStep=1/60,this._timeStep=1/60,this._tmpVec3=le.BuildArray(3,me.Zero),this._bodies=new Map,this._bodyCollisionObservable=new Map,this._constraintToBodyIdPair=new Map,this._bodyCollisionEndedObservable=new Map,this.onCollisionObservable=new s,this.onCollisionEndedObservable=new s,this.onTriggerCollisionObservable=new s,"function"!=typeof t?(this._hknp=t,this.isSupported()?(this.world=this._hknp.HP_World_Create()[1],this._queryCollector=this._hknp.HP_QueryCollector_Create(1)[1]):p.Error("Havok is not available. Please make sure you included the js file.")):p.Error("Havok is not ready. Please make sure you await HK() before using the plugin.")}isSupported(){return void 0!==this._hknp}setGravity(e){this._hknp.HP_World_SetGravity(this.world,this._bVecToV3(e))}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){for(const e of t)e.disablePreStep||this.setPhysicsBodyTransformation(e,e.transformNode);this._hknp.HP_World_Step(this.world,this._useDeltaForWorldStep?e:this._timeStep),this._bodyBuffer=this._hknp.HP_World_GetBodyBuffer(this.world)[1];for(const e of t)this.sync(e);this._notifyCollisions(),this._notifyTriggers()}getPluginVersion(){return 2}initBody(e,t,i,s){e._pluginData=new Nc(this._hknp.HP_Body_Create()[1]),this._internalSetMotionType(e._pluginData,t);const n=[this._bVecToV3(i),this._bQuatToV4(s)];this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,n),this._hknp.HP_World_AddBody(this.world,e._pluginData.hpBodyId,e.startAsleep),this._bodies.set(e._pluginData.hpBodyId[0],{body:e,index:0})}removeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(const t of e._pluginDataInstances)this._bodyCollisionObservable.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._bodies.delete(t.hpBodyId[0]);e._pluginData&&(this._bodyCollisionObservable.delete(e._pluginData.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,e._pluginData.hpBodyId),this._bodies.delete(e._pluginData.hpBodyId[0]))}initBodyInstances(e,t,i){var s,n;const r=null!==(n=null===(s=i._thinInstanceDataStorage)||void 0===s?void 0:s.instancesCount)&&void 0!==n?n:0,o=i._thinInstanceDataStorage.matrixData;o&&(this._createOrUpdateBodyInstances(e,t,o,0,r,!1),e._pluginDataInstances.forEach(((t,i)=>{this._bodies.set(t.hpBodyId[0],{body:e,index:i})})))}_createOrUpdateBodyInstances(e,t,i,s,n,r){const o=Ee.Quaternion[0],a=Te.Identity();for(let l=s;l<n;l++){const s=[i[16*l+12],i[16*l+13],i[16*l+14]];let n;n=r?e._pluginDataInstances[l].hpBodyId:this._hknp.HP_Body_Create()[1],a.setRowFromFloats(0,i[16*l+0],i[16*l+1],i[16*l+2],0),a.setRowFromFloats(1,i[16*l+4],i[16*l+5],i[16*l+6],0),a.setRowFromFloats(2,i[16*l+8],i[16*l+9],i[16*l+10],0),ve.FromRotationMatrixToRef(a,o);const h=[s,[o.x,o.y,o.z,o.w]];if(this._hknp.HP_Body_SetQTransform(n,h),!r){const i=new Nc(n);e._pluginDataInstances.length&&(i.userMassProps=e._pluginDataInstances[0].userMassProps),this._internalSetMotionType(i,t),this._internalUpdateMassProperties(i),e._pluginDataInstances.push(i),this._hknp.HP_World_AddBody(this.world,n,e.startAsleep),i.worldTransformOffset=this._hknp.HP_Body_GetWorldTransformOffset(n)[1]}}}updateBodyInstances(e,t){var i,s;const n=null!==(s=null===(i=t._thinInstanceDataStorage)||void 0===i?void 0:i.instancesCount)&&void 0!==s?s:0,r=t._thinInstanceDataStorage.matrixData;if(!r)return;const o=e._pluginDataInstances.length,a=this.getMotionType(e);if(n>o){this._createOrUpdateBodyInstances(e,a,r,o,n,!1);const t=this._hknp.HP_Body_GetShape(e._pluginDataInstances[0].hpBodyId)[1];for(let i=o;i<n;i++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[i].hpBodyId,t),this._internalUpdateMassProperties(e._pluginDataInstances[i]),this._bodies.set(e._pluginDataInstances[i].hpBodyId[0],{body:e,index:i})}else if(n<o){const t=o-n;for(let i=0;i<t;i++){const t=e._pluginDataInstances.pop();this._bodies.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._hknp.HP_Body_Release(t.hpBodyId)}this._createOrUpdateBodyInstances(e,a,r,0,n,!0)}}sync(e){this.syncTransform(e,e.transformNode)}syncTransform(e,t){var i;if(e._pluginDataInstances.length){const i=t,s=i._thinInstanceDataStorage.matrixData;if(!s)return;const n=e._pluginDataInstances.length;for(let t=0;t<n;t++){const i=e._pluginDataInstances[t].worldTransformOffset,n=new Float32Array(this._hknp.HEAPU8.buffer,this._bodyBuffer+i,16),r=16*t;for(let e=0;e<15;e++)3!=(3&e)&&(s[r+e]=n[e]);s[r+15]=1}i.thinInstanceBufferUpdated("matrix")}else try{const s=this._hknp.HP_Body_GetQTransform(e._pluginData.hpBodyId)[1],n=s[0],r=s[1],o=Ee.Quaternion[0];o.set(r[0],r[1],r[2],r[3]);const a=t.parent;if(a&&!a.getWorldMatrix().isIdentity()){a.computeWorldMatrix(!0),o.normalize();const e=Ee.Matrix[0],s=Ee.Vector3[0];s.copyFromFloats(n[0],n[1],n[2]),Te.ComposeToRef(t.absoluteScaling,o,s,e);const r=Ee.Matrix[1];a.getWorldMatrix().invertToRef(r);const l=Ee.Matrix[2];e.multiplyToRef(r,l),l.decomposeToTransformNode(t),null===(i=t.rotationQuaternion)||void 0===i||i.normalize()}else t.position.set(n[0],n[1],n[2]),t.rotationQuaternion?t.rotationQuaternion.copyFrom(o):o.toEulerAnglesToRef(t.rotation)}catch(e){p.Error(`Syncing transform failed for node ${t.name}: ${e.message}...`)}}setShape(e,t){var i,s,n;const r=t&&t._pluginData?t._pluginData:BigInt(0);if(!(e.transformNode instanceof jn&&(null===(i=e.transformNode._thinInstanceDataStorage)||void 0===i?void 0:i.matrixData)))return this._hknp.HP_Body_SetShape(e._pluginData.hpBodyId,r),void this._internalUpdateMassProperties(e._pluginData);const o=null!==(n=null===(s=e.transformNode._thinInstanceDataStorage)||void 0===s?void 0:s.instancesCount)&&void 0!==n?n:0;for(let t=0;t<o;t++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[t].hpBodyId,r),this._internalUpdateMassProperties(e._pluginDataInstances[t])}_getPluginReference(e,t){var i;return(null===(i=e._pluginDataInstances)||void 0===i?void 0:i.length)?e._pluginDataInstances[null!=t?t:0]:e._pluginData}getShape(e){const t=this._getPluginReference(e),i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1];if(0!=i){const t=e.transformNode.getScene();return new Ic({pluginData:i},t)}return null}getShapeType(e){return e.type?e.type:this._hknp.HP_Shape_GetType(e._pluginData)}setEventMask(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,t)}),i)}getEventMask(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1]}_fromMassPropertiesTuple(e){return{centerOfMass:me.FromArray(e[0]),mass:e[1],inertia:me.FromArray(e[2]),inertiaOrientation:ve.FromArray(e[3])}}_internalUpdateMassProperties(e){const t=this._internalComputeMassProperties(e),i=e.userMassProps;i.centerOfMass&&(t[0]=i.centerOfMass.asArray()),null!=i.mass&&(t[1]=i.mass),i.inertia&&(t[2]=i.inertia.asArray()),i.inertiaOrientation&&(t[3]=i.inertiaOrientation.asArray()),this._hknp.HP_Body_SetMassProperties(e.hpBodyId,t)}_internalSetMotionType(e,t){switch(t){case xc.STATIC:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.STATIC);break;case xc.ANIMATED:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.KINEMATIC);break;case xc.DYNAMIC:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.DYNAMIC)}}setMotionType(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._internalSetMotionType(e,t)}),i)}getMotionType(e,t){const i=this._getPluginReference(e,t),s=this._hknp.HP_Body_GetMotionType(i.hpBodyId)[1];switch(s){case this._hknp.MotionType.STATIC:return xc.STATIC;case this._hknp.MotionType.KINEMATIC:return xc.ANIMATED;case this._hknp.MotionType.DYNAMIC:return xc.DYNAMIC}throw new Error("Unknown motion type: "+s)}_internalComputeMassProperties(e){const t=this._hknp.HP_Body_GetShape(e.hpBodyId);if(t[0]==this._hknp.Result.RESULT_OK){const e=this._hknp.HP_Shape_BuildMassProperties(t[1]);if(e[0]==this._hknp.Result.RESULT_OK)return e[1]}return[[0,0,0],1,[1,1,1],[0,0,0,1]]}computeMassProperties(e,t){const i=this._getPluginReference(e,t),s=this._internalComputeMassProperties(i);return this._fromMassPropertiesTuple(s)}setMassProperties(e,t,i){this._applyToBodyOrInstances(e,(e=>{e.userMassProps=t,this._internalUpdateMassProperties(e)}),i)}getMassProperties(e,t){const i=this._getPluginReference(e,t),s=this._hknp.HP_Body_GetMassProperties(i.hpBodyId)[1];return this._fromMassPropertiesTuple(s)}setLinearDamping(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetLinearDamping(e.hpBodyId,t)}),i)}getLinearDamping(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetLinearDamping(i.hpBodyId)[1]}setAngularDamping(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetAngularDamping(e.hpBodyId,t)}),i)}getAngularDamping(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetAngularDamping(i.hpBodyId)[1]}setLinearVelocity(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetLinearVelocity(e.hpBodyId,this._bVecToV3(t))}),i)}getLinearVelocityToRef(e,t,i){const s=this._getPluginReference(e,i),n=this._hknp.HP_Body_GetLinearVelocity(s.hpBodyId)[1];this._v3ToBvecRef(n,t)}_applyToBodyOrInstances(e,t,i){var s;if((null===(s=e._pluginDataInstances)||void 0===s?void 0:s.length)>0&&void 0===i)for(let i=0;i<e._pluginDataInstances.length;i++)t(e._pluginDataInstances[i]);else t(this._getPluginReference(e,i))}applyImpulse(e,t,i,s){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_ApplyImpulse(e.hpBodyId,this._bVecToV3(i),this._bVecToV3(t))}),s)}applyForce(e,t,i,s){t.scaleToRef(this.getTimeStep(),this._tmpVec3[0]),this.applyImpulse(e,this._tmpVec3[0],i,s)}setAngularVelocity(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetAngularVelocity(e.hpBodyId,this._bVecToV3(t))}),i)}getAngularVelocityToRef(e,t,i){const s=this._getPluginReference(e,i),n=this._hknp.HP_Body_GetAngularVelocity(s.hpBodyId)[1];this._v3ToBvecRef(n,t)}setPhysicsBodyTransformation(e,t){const i=e.transformNode;if(e.numInstances>0){const t=i._thinInstanceDataStorage.matrixData;if(!t)return;const s=e.numInstances;this._createOrUpdateBodyInstances(e,e.getMotionType(),t,0,s,!0)}else this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,this._getTransformInfos(t))}setTargetTransform(e,t,i,s){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetTargetQTransform(e.hpBodyId,[this._bVecToV3(t),this._bQuatToV4(i)])}),s)}setGravityFactor(e,t,i){this._applyToBodyOrInstances(e,(e=>{this._hknp.HP_Body_SetGravityFactor(e.hpBodyId,t)}),i)}getGravityFactor(e,t){const i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetGravityFactor(i.hpBodyId)[1]}disposeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(const t of e._pluginDataInstances)this._hknp.HP_Body_Release(t.hpBodyId),t.hpBodyId=void 0;e._pluginData&&(this._hknp.HP_Body_Release(e._pluginData.hpBodyId),e._pluginData.hpBodyId=void 0)}initShape(e,t,i){switch(t){case bc.SPHERE:{const t=i.radius||1,s=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateSphere(s,t)[1]}break;case bc.BOX:{const t=i.rotation?this._bQuatToV4(i.rotation):[0,0,0,1],s=i.extents?this._bVecToV3(i.extents):[1,1,1],n=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateBox(n,t,s)[1]}break;case bc.CAPSULE:{const t=i.pointA?this._bVecToV3(i.pointA):[0,0,0],s=i.pointB?this._bVecToV3(i.pointB):[0,1,0],n=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCapsule(t,s,n)[1]}break;case bc.CONTAINER:e._pluginData=this._hknp.HP_Shape_CreateContainer()[1];break;case bc.CYLINDER:{const t=i.pointA?this._bVecToV3(i.pointA):[0,0,0],s=i.pointB?this._bVecToV3(i.pointB):[0,1,0],n=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCylinder(t,s,n)[1]}break;case bc.CONVEX_HULL:case bc.MESH:{const s=i.mesh;if(!s)throw new Error("No mesh provided to create physics shape.");{const n=!!i.includeChildMeshes,r=t!=bc.CONVEX_HULL,o=new Dc(s,r,null==s?void 0:s.getScene());o.addNodeMeshes(s,n);const a=o.getVertices(this._hknp),l=a.numObjects/3;if(t==bc.CONVEX_HULL)e._pluginData=this._hknp.HP_Shape_CreateConvexHull(a.offset,l)[1];else{const t=o.getTriangles(this._hknp),i=t.numObjects/3;e._pluginData=this._hknp.HP_Shape_CreateMesh(a.offset,l,t.offset,i)[1],o.freeBuffer(this._hknp,t)}o.freeBuffer(this._hknp,a)}}break;default:throw new Error("Unsupported Shape Type.")}}setShapeFilterMembershipMask(e,t){const i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[t,i])}getShapeFilterMembershipMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0]}setShapeFilterCollideMask(e,t){const i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[i,t])}getShapeFilterCollideMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1]}setMaterial(e,t){var i,s,n,r,o;const a=null!==(i=t.friction)&&void 0!==i?i:.5,l=null!==(s=t.staticFriction)&&void 0!==s?s:a,h=null!==(n=t.restitution)&&void 0!==n?n:0,c=null!==(r=t.frictionCombine)&&void 0!==r?r:Cc.MINIMUM,d=null!==(o=t.restitutionCombine)&&void 0!==o?o:Cc.MAXIMUM,u=[l,a,h,this._materialCombineToNative(c),this._materialCombineToNative(d)];this._hknp.HP_Shape_SetMaterial(e._pluginData,u)}setDensity(e,t){this._hknp.HP_Shape_SetDensity(e._pluginData,t)}getDensity(e){return this._hknp.HP_Shape_GetDensity(e._pluginData)[1]}_getTransformInfos(e){if(e.parent)return e.computeWorldMatrix(!0),[this._bVecToV3(e.absolutePosition),this._bQuatToV4(e.absoluteRotationQuaternion)];let t=Ee.Quaternion[0];if(e.rotationQuaternion)t=e.rotationQuaternion;else{const i=e.rotation;ve.FromEulerAnglesToRef(i.x,i.y,i.z,t)}return[this._bVecToV3(e.position),this._bQuatToV4(t)]}addChild(e,t,i,s,n){const r=[i?this._bVecToV3(i):[0,0,0],s?this._bQuatToV4(s):[0,0,0,1],n?this._bVecToV3(n):[1,1,1]];this._hknp.HP_Shape_AddChild(e._pluginData,t._pluginData,r)}removeChild(e,t){this._hknp.HP_Shape_RemoveChild(e._pluginData,t)}getNumChildren(e){return this._hknp.HP_Shape_GetNumChildren(e._pluginData)[1]}setTrigger(e,t){this._hknp.HP_Shape_SetTrigger(e._pluginData,t)}getBoundingBox(e){return{}}getBodyGeometry(e){var t;const i=(null===(t=e._pluginDataInstances)||void 0===t?void 0:t.length)>0?e._pluginDataInstances[0]:e._pluginData,s=this._hknp.HP_Body_GetShape(i.hpBodyId)[1],n=this._hknp.HP_Shape_CreateDebugDisplayGeometry(s);if(n[0]!=this._hknp.Result.RESULT_OK)return{positions:[],indices:[]};const r=this._hknp.HP_DebugGeometry_GetInfo(n[1])[1],o=new Float32Array(this._hknp.HEAPU8.buffer,r[0],3*r[1]),a=new Uint32Array(this._hknp.HEAPU8.buffer,r[2],3*r[3]),l=o.slice(0),h=a.slice(0);return this._hknp.HP_DebugGeometry_Release(n[1]),{positions:l,indices:h}}disposeShape(e){this._hknp.HP_Shape_Release(e._pluginData),e._pluginData=void 0}initConstraint(e,t,i,s,n){var r,o,a,l,h;const c=e.type,d=e.options;if(!c||!d)return void p.Warn("No constraint type or options. Constraint is invalid.");if(t._pluginDataInstances.length>0&&void 0===s||i._pluginDataInstances.length>0&&void 0===n)return void p.Warn("Body is instanced but no instance index was specified. Constraint will not be applied.");e._pluginData=null!==(r=e._pluginData)&&void 0!==r?r:[];const u=this._hknp.HP_Constraint_Create()[1];e._pluginData.push(u);const _=this._getPluginReference(t,s).hpBodyId,f=this._getPluginReference(i,n).hpBodyId;this._hknp.HP_Constraint_SetParentBody(u,_),this._hknp.HP_Constraint_SetChildBody(u,f),this._constraintToBodyIdPair.set(u[0],[_[0],f[0]]);const m=d.pivotA?this._bVecToV3(d.pivotA):this._bVecToV3(me.Zero()),g=null!==(o=d.axisA)&&void 0!==o?o:new me(1,0,0),v=this._tmpVec3[0];d.perpAxisA?v.copyFrom(d.perpAxisA):g.getNormalToRef(v),this._hknp.HP_Constraint_SetAnchorInParent(u,m,this._bVecToV3(g),this._bVecToV3(v));const T=d.pivotB?this._bVecToV3(d.pivotB):this._bVecToV3(me.Zero()),b=null!==(a=d.axisB)&&void 0!==a?a:new me(1,0,0),E=this._tmpVec3[0];if(d.perpAxisB?E.copyFrom(d.perpAxisB):b.getNormalToRef(E),this._hknp.HP_Constraint_SetAnchorInChild(u,T,this._bVecToV3(b),this._bVecToV3(E)),e._initOptions||(e._initOptions={axisA:g.clone(),axisB:b.clone(),perpAxisA:v.clone(),perpAxisB:E.clone(),pivotA:new me(m[0],m[1],m[2]),pivotB:new me(T[0],T[1],T[2])}),c==Tc.LOCK)this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(c==Tc.DISTANCE){const e=d.maxDistance||0,t=this._hknp.ConstraintAxis.LINEAR_DISTANCE;this._hknp.HP_Constraint_SetAxisMode(u,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(u,t,e),this._hknp.HP_Constraint_SetAxisMaxLimit(u,t,e)}else if(c==Tc.HINGE)this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(c==Tc.PRISMATIC)this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(c==Tc.SLIDER)this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(c==Tc.BALL_AND_SOCKET)this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(u,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else{if(c!=Tc.SIX_DOF)throw new Error("Unsupported Constraint Type.");{const t=e;for(const e of t.limits){const t=this._constraintAxisToNative(e.axis);0==(null!==(l=e.minLimit)&&void 0!==l?l:-1)&&0==(null!==(h=e.maxLimit)&&void 0!==h?h:-1)?this._hknp.HP_Constraint_SetAxisMode(u,t,this._hknp.ConstraintAxisLimitMode.LOCKED):(null!=e.minLimit&&(this._hknp.HP_Constraint_SetAxisMode(u,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(u,t,e.minLimit)),null!=e.maxLimit&&(this._hknp.HP_Constraint_SetAxisMode(u,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMaxLimit(u,t,e.maxLimit))),e.stiffness&&this._hknp.HP_Constraint_SetAxisStiffness(u,t,e.stiffness),e.damping&&this._hknp.HP_Constraint_SetAxisDamping(u,t,e.damping)}}}const S=!!d.collision;this._hknp.HP_Constraint_SetCollisionsEnabled(u,S),this._hknp.HP_Constraint_SetEnabled(u,!0)}getBodiesUsingConstraint(e){const t=[];for(const i of e._pluginData){const e=this._constraintToBodyIdPair.get(i[0]);if(e){const i=this._bodies.get(e[0]),s=this._bodies.get(e[1]);i&&s&&t.push({parentBody:i.body,parentBodyIndex:i.index,childBody:s.body,childBodyIndex:s.index})}}return t}addConstraint(e,t,i,s,n){this.initConstraint(i,e,t,s,n)}setEnabled(e,t){for(const i of e._pluginData)this._hknp.HP_Constraint_SetEnabled(i,t)}getEnabled(e){const t=e._pluginData&&e._pluginData[0];return!!t&&this._hknp.HP_Constraint_GetEnabled(t)[1]}setCollisionsEnabled(e,t){for(const i of e._pluginData)this._hknp.HP_Constraint_SetCollisionsEnabled(i,t)}getCollisionsEnabled(e){const t=e._pluginData&&e._pluginData[0];return!!t&&this._hknp.HP_Constraint_GetCollisionsEnabled(t)[1]}setAxisFriction(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisFriction(s,this._constraintAxisToNative(t),i)}getAxisFriction(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisFriction(i,this._constraintAxisToNative(t))[1]:null}setAxisMode(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMode(s,this._constraintAxisToNative(t),this._limitModeToNative(i))}getAxisMode(e,t){const i=e._pluginData&&e._pluginData[0];if(i){const e=this._hknp.HP_Constraint_GetAxisMode(i,this._constraintAxisToNative(t))[1];return this._nativeToLimitMode(e)}return null}setAxisMinLimit(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMinLimit(s,this._constraintAxisToNative(t),i)}getAxisMinLimit(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMinLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMaxLimit(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMaxLimit(s,this._constraintAxisToNative(t),i)}getAxisMaxLimit(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMaxLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMotorType(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorType(s,this._constraintAxisToNative(t),this._constraintMotorTypeToNative(i))}getAxisMotorType(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._nativeToMotorType(this._hknp.HP_Constraint_GetAxisMotorType(i,this._constraintAxisToNative(t))[1]):null}setAxisMotorTarget(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorTarget(s,this._constraintAxisToNative(t),i)}getAxisMotorTarget(e,t){return e._pluginData&&e._pluginData[0]?this._hknp.HP_Constraint_GetAxisMotorTarget(e._pluginData,this._constraintAxisToNative(t))[1]:null}setAxisMotorMaxForce(e,t,i){for(const s of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorMaxForce(s,this._constraintAxisToNative(t),i)}getAxisMotorMaxForce(e,t){const i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMotorMaxForce(i,this._constraintAxisToNative(t))[1]:null}disposeConstraint(e){for(const t of e._pluginData)this._hknp.HP_Constraint_SetEnabled(t,!1),this._hknp.HP_Constraint_Release(t);e._pluginData.length=0}raycast(e,t,i,s){var n,r;const o=null!==(n=null==s?void 0:s.membership)&&void 0!==n?n:-1,a=null!==(r=null==s?void 0:s.collideWith)&&void 0!==r?r:-1;i.reset(e,t);const l=[BigInt(0)],h=[this._bVecToV3(e),this._bVecToV3(t),[o,a],!1,l];if(this._hknp.HP_World_CastRayWithCollector(this.world,this._queryCollector,h),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){const e=this._hknp.HP_QueryCollector_GetCastRayResult(this._queryCollector,0)[1],t=e[1][3],s=e[1][4],n=e[1][5];i.setHitData({x:s[0],y:s[1],z:s[2]},{x:t[0],y:t[1],z:t[2]},n),i.calculateHitDistance();const r=this._bodies.get(e[1][0][0]);i.body=null==r?void 0:r.body,i.bodyIndex=null==r?void 0:r.index}}getCollisionObservable(e){const t=e._pluginData.hpBodyId[0];let i=this._bodyCollisionObservable.get(t);return i||(i=new s,this._bodyCollisionObservable.set(t,i)),i}getCollisionEndedObservable(e){const t=e._pluginData.hpBodyId[0];let i=this._bodyCollisionEndedObservable.get(t);return i||(i=new s,this._bodyCollisionEndedObservable.set(t,i)),i}setCollisionCallbackEnabled(e,t){const i=this._hknp.EventType.COLLISION_STARTED.value|this._hknp.EventType.COLLISION_CONTINUED.value|this._hknp.EventType.COLLISION_FINISHED.value;e._pluginDataInstances&&e._pluginDataInstances.length?e._pluginDataInstances.forEach((e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,t?i:0)})):e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,t?i:0)}setCollisionEndedCallbackEnabled(e,t){const i=this._getPluginReference(e);let s=this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1];s=t?s|this._hknp.EventType.COLLISION_FINISHED.value:s&~this._hknp.EventType.COLLISION_FINISHED.value,e._pluginDataInstances&&e._pluginDataInstances.length?e._pluginDataInstances.forEach((e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,s)})):e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,s)}_notifyTriggers(){let e=this._hknp.HP_World_GetTriggerEvents(this.world)[1];const t=new wc;for(;e;){wc.readToRef(this._hknp.HEAPU8.buffer,e,t);const i=this._bodies.get(t.bodyIdA),s=this._bodies.get(t.bodyIdB);if(i&&s){const e={collider:i.body,colliderIndex:i.index,collidedAgainst:s.body,collidedAgainstIndex:s.index,type:this._nativeTriggerCollisionValueToCollisionType(t.type)};this.onTriggerCollisionObservable.notifyObservers(e)}e=this._hknp.HP_World_GetNextTriggerEvent(this.world,e)}}_notifyCollisions(){let e=this._hknp.HP_World_GetCollisionEvents(this.world)[1];const t=new Lc,i=Number(this.world);for(;e;){Lc.readToRef(this._hknp.HEAPU8.buffer,e,t);const s=this._bodies.get(t.contactOnA.bodyId),n=this._bodies.get(t.contactOnB.bodyId);if(s&&n){const e={collider:s.body,colliderIndex:s.index,collidedAgainst:n.body,collidedAgainstIndex:n.index,type:this._nativeCollisionValueToCollisionType(t.type)};if(e.type===Sc.COLLISION_FINISHED)this.onCollisionEndedObservable.notifyObservers(e);else{t.contactOnB.position.subtractToRef(t.contactOnA.position,this._tmpVec3[0]);const i=me.Dot(this._tmpVec3[0],t.contactOnA.normal);e.point=t.contactOnA.position,e.distance=i,e.impulse=t.impulseApplied,e.normal=t.contactOnA.normal,this.onCollisionObservable.notifyObservers(e)}if(this._bodyCollisionObservable.size&&e.type!==Sc.COLLISION_FINISHED){const i=this._bodyCollisionObservable.get(t.contactOnA.bodyId),r=this._bodyCollisionObservable.get(t.contactOnB.bodyId);i?i.notifyObservers(e):r&&(e.collider=n.body,e.colliderIndex=n.index,e.collidedAgainst=s.body,e.collidedAgainstIndex=s.index,e.normal=t.contactOnB.normal,r.notifyObservers(e))}else if(this._bodyCollisionEndedObservable.size){const i=this._bodyCollisionEndedObservable.get(t.contactOnA.bodyId),r=this._bodyCollisionEndedObservable.get(t.contactOnB.bodyId);i?i.notifyObservers(e):r&&(e.collider=n.body,e.colliderIndex=n.index,e.collidedAgainst=s.body,e.collidedAgainstIndex=s.index,e.normal=t.contactOnB.normal,r.notifyObservers(e))}}e=this._hknp.HP_World_GetNextCollisionEvent(i,e)}}get numBodies(){return this._hknp.HP_World_GetNumBodies(this.world)[1]}dispose(){this._hknp.HP_QueryCollector_Release(this._queryCollector),this._queryCollector=BigInt(0),this._hknp.HP_World_Release(this.world),this.world=void 0}_v3ToBvecRef(e,t){t.set(e[0],e[1],e[2])}_bVecToV3(e){return[e._x,e._y,e._z]}_bQuatToV4(e){return[e._x,e._y,e._z,e._w]}_constraintMotorTypeToNative(e){switch(e){case Ec.POSITION:return this._hknp.ConstraintMotorType.POSITION;case Ec.VELOCITY:return this._hknp.ConstraintMotorType.VELOCITY}return this._hknp.ConstraintMotorType.NONE}_nativeToMotorType(e){switch(e){case this._hknp.ConstraintMotorType.POSITION:return Ec.POSITION;case this._hknp.ConstraintMotorType.VELOCITY:return Ec.VELOCITY}return Ec.NONE}_materialCombineToNative(e){switch(e){case Cc.GEOMETRIC_MEAN:return this._hknp.MaterialCombine.GEOMETRIC_MEAN;case Cc.MINIMUM:return this._hknp.MaterialCombine.MINIMUM;case Cc.MAXIMUM:return this._hknp.MaterialCombine.MAXIMUM;case Cc.ARITHMETIC_MEAN:return this._hknp.MaterialCombine.ARITHMETIC_MEAN;case Cc.MULTIPLY:return this._hknp.MaterialCombine.MULTIPLY}}_constraintAxisToNative(e){switch(e){case vc.LINEAR_X:return this._hknp.ConstraintAxis.LINEAR_X;case vc.LINEAR_Y:return this._hknp.ConstraintAxis.LINEAR_Y;case vc.LINEAR_Z:return this._hknp.ConstraintAxis.LINEAR_Z;case vc.ANGULAR_X:return this._hknp.ConstraintAxis.ANGULAR_X;case vc.ANGULAR_Y:return this._hknp.ConstraintAxis.ANGULAR_Y;case vc.ANGULAR_Z:return this._hknp.ConstraintAxis.ANGULAR_Z;case vc.LINEAR_DISTANCE:return this._hknp.ConstraintAxis.LINEAR_DISTANCE}}_nativeToLimitMode(e){switch(e){case this._hknp.ConstraintAxisLimitMode.FREE:return gc.FREE;case this._hknp.ConstraintAxisLimitMode.LIMITED:return gc.LIMITED;case this._hknp.ConstraintAxisLimitMode.LOCKED:return gc.LOCKED}return gc.FREE}_limitModeToNative(e){switch(e){case gc.FREE:return this._hknp.ConstraintAxisLimitMode.FREE;case gc.LIMITED:return this._hknp.ConstraintAxisLimitMode.LIMITED;case gc.LOCKED:return this._hknp.ConstraintAxisLimitMode.LOCKED}}_nativeCollisionValueToCollisionType(e){switch(e){case this._hknp.EventType.COLLISION_STARTED.value:return Sc.COLLISION_STARTED;case this._hknp.EventType.COLLISION_FINISHED.value:return Sc.COLLISION_FINISHED;case this._hknp.EventType.COLLISION_CONTINUED.value:return Sc.COLLISION_CONTINUED}return Sc.COLLISION_STARTED}_nativeTriggerCollisionValueToCollisionType(e){switch(e){case 8:return Sc.TRIGGER_ENTERED;case 16:return Sc.TRIGGER_EXITED}return Sc.TRIGGER_ENTERED}}F.ShadersStore.anaglyphPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D leftSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 leftFrag=texture2D(leftSampler,vUV);leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);vec4 rightFrag=texture2D(textureSampler,vUV);rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);}",ue("BABYLON.AnaglyphPostProcess",class extends es{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,s,n,r){super(e,"anaglyph",null,["leftSampler"],t,i[1],s,n,r),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("leftSampler",this._passedProcess)}))}});F.ShadersStore.blackAndWhitePixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform float degree;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec3 color=texture2D(textureSampler,vUV).rgb;float luminance=dot(color,vec3(0.3,0.59,0.11)); \nvec3 blackAndWhite=vec3(luminance,luminance,luminance);gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);}";class Uc extends es{getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i,s,n,r){super(e,"blackAndWhite",["degree"],null,t,i,s,n,r),this.degree=1,this.onApplyObservable.add((e=>{e.setFloat("degree",this.degree)}))}static _Parse(e,t,i,s){return qe.Parse((()=>new Uc(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}De([Ge()],Uc.prototype,"degree",void 0),ue("BABYLON.BlackAndWhitePostProcess",Uc);class kc{constructor(e,t,i,s){this._name=t,this._singleInstance=s||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let e=0;e<t.length;e++)if(!t[e].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const i=Ot.MakeArray(e||this._cameras);if(i)for(let e=0;e<i.length;e++){const s=i[e];if(!s)continue;const n=s.name;if(t=this._singleInstance?0:n,!this._postProcesses[t]){const e=this._getPostProcesses();e&&(this._postProcesses[t]=Array.isArray(e)?e:[e])}this._indicesForCamera[n]||(this._indicesForCamera[n]=[]),this._postProcesses[t].forEach((e=>{const t=s.attachPostProcess(e);this._indicesForCamera[n].push(t)})),this._cameras[n]||(this._cameras[n]=s)}}_detachCameras(e){const t=Ot.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],s=i.name,n=this._postProcesses[this._singleInstance?0:s];n&&n.forEach((e=>{i.detachPostProcess(e)})),this._cameras[s]&&(this._cameras[s]=null),delete this._indicesForCamera[s]}}_enable(e){const t=Ot.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],s=i.name,n=this._singleInstance?0:s;for(let r=0;r<this._indicesForCamera[s].length;r++){const o=this._indicesForCamera[s][r];null==i._postProcesses[o]&&t[e].attachPostProcess(this._postProcesses[n][r],o)}}}_disable(e){const t=Ot.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){const i=t[e],s=i.name;this._postProcesses[this._singleInstance?0:s].forEach((e=>{i.detachPostProcess(e)}))}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}F.ShadersStore.extractHighlightsPixelShader="#include<helperFunctions>\nvarying vec2 vUV;uniform sampler2D textureSampler;uniform float threshold;uniform float exposure;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{gl_FragColor=texture2D(textureSampler,vUV);float luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;}";class Vc extends es{getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,i,s,n,r,o=0,a=!1){super(e,"extractHighlights",["threshold","exposure"],null,t,i,s,n,r,null,o,void 0,null,a),this.threshold=.9,this._exposure=1,this._inputPostProcess=null,this.onApplyObservable.add((e=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&e.setTextureFromPostProcess("textureSampler",this._inputPostProcess),e.setFloat("threshold",Math.pow(this.threshold,re)),e.setFloat("exposure",this._exposure)}))}}De([Ge()],Vc.prototype,"threshold",void 0),ue("BABYLON.ExtractHighlightsPostProcess",Vc);F.ShadersStore.bloomMergePixelShader="uniform sampler2D textureSampler;uniform sampler2D bloomBlur;varying vec2 vUV;uniform float bloomWeight;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(textureSampler,vUV);vec3 blurred=texture2D(bloomBlur,vUV).rgb;gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); }\n";class Gc extends es{getClassName(){return"BloomMergePostProcess"}constructor(e,t,i,s,n,r,o,a,l,h=0,c=!1){super(e,"bloomMerge",["bloomWeight"],["bloomBlur"],n,r,o,a,l,null,h,void 0,null,!0),this.weight=1,this.weight=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("bloomBlur",i),e.setFloat("bloomWeight",this.weight)})),c||this.updateEffect()}}De([Ge()],Gc.prototype,"weight",void 0),ue("BABYLON.BloomMergePostProcess",Gc);class zc extends kc{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this._bloomScale}set kernel(e){this._blurX.kernel=e*this._bloomScale,this._blurY.kernel=e*this._bloomScale}constructor(e,t,i,s,n=0,r=!1){super(e.getEngine(),"bloom",(()=>this._effects),!0),this._bloomScale=t,this._effects=[],this._downscale=new Vc("highlights",1,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,r),this._blurX=new ts("horizontal blur",new pe(1,0),10,t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,void 0,r),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new ts("vertical blur",new pe(0,1),10,t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,void 0,r),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=s,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new Gc("bloomMerge",this._downscale,this._blurY,i,t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,r),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}F.ShadersStore.chromaticAberrationPixelShader="uniform sampler2D textureSampler; \nuniform float chromatic_aberration;uniform float radialIntensity;uniform vec2 direction;uniform vec2 centerPosition;uniform float screen_width;uniform float screen_height;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);vec2 directionOfEffect=direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+ centered_screen_pos.y*centered_screen_pos.y;float radius=sqrt(radius2);vec4 original=texture2D(textureSampler,vUV);vec3 ref_indices=vec3(-0.3,0.0,0.3);float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);original.r=texture2D(textureSampler,ref_coords_r).r;original.g=texture2D(textureSampler,ref_coords_g).g;original.b=texture2D(textureSampler,ref_coords_b).b;original.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);gl_FragColor=original;}";class Hc extends es{getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,i,s,n,r,o,a,l=0,h=!1){super(e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],s,n,r,o,a,null,l,void 0,null,h),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new pe(.707,.707),this.centerPosition=new pe(.5,.5),this.screenWidth=t,this.screenHeight=i,this.onApplyObservable.add((e=>{e.setFloat("chromatic_aberration",this.aberrationAmount),e.setFloat("screen_width",t),e.setFloat("screen_height",i),e.setFloat("radialIntensity",this.radialIntensity),e.setFloat2("direction",this.direction.x,this.direction.y),e.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)}))}static _Parse(e,t,i,s){return qe.Parse((()=>new Hc(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1)),e,i,s)}}De([Ge()],Hc.prototype,"aberrationAmount",void 0),De([Ge()],Hc.prototype,"radialIntensity",void 0),De([Ge()],Hc.prototype,"direction",void 0),De([Ge()],Hc.prototype,"centerPosition",void 0),De([Ge()],Hc.prototype,"screenWidth",void 0),De([Ge()],Hc.prototype,"screenHeight",void 0),ue("BABYLON.ChromaticAberrationPostProcess",Hc);F.ShadersStore.circleOfConfusionPixelShader="uniform sampler2D depthSampler;varying vec2 vUV;uniform vec2 cameraMinMaxZ;uniform float focusDistance;uniform float cocPrecalculation;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float depth=texture2D(depthSampler,vUV).r;\n#define CUSTOM_COC_DEPTH\nfloat pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; \n#define CUSTOM_COC_PIXELDISTANCE\nfloat coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);gl_FragColor=vec4(coc,coc,coc,1.0);}\n";class Wc extends es{getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,i,s,n,r,o,a=0,l=!1){super(e,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],i,s,n,r,o,null,a,void 0,null,l),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50,this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add((e=>{if(!this._depthTexture)return void p.Warn("No depth texture set on CircleOfConfusionPostProcess");e.setTexture("depthSampler",this._depthTexture);const t=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);e.setFloat("focusDistance",this.focusDistance),e.setFloat("cocPrecalculation",t);const i=this._depthTexture.activeCamera;e.setFloat2("cameraMinMaxZ",i.minZ,i.maxZ-i.minZ)}))}set depthTexture(e){this._depthTexture=e}}De([Ge()],Wc.prototype,"lensSize",void 0),De([Ge()],Wc.prototype,"fStop",void 0),De([Ge()],Wc.prototype,"focusDistance",void 0),De([Ge()],Wc.prototype,"focalLength",void 0),ue("BABYLON.CircleOfConfusionPostProcess",Wc);F.ShadersStore.colorCorrectionPixelShader="uniform sampler2D textureSampler; \nuniform sampler2D colorTable; \nvarying vec2 vUV;const float SLICE_COUNT=16.0; \nvec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {float sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);float zSlice1=min(zSlice0+1.0,width-1.0);float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;float s0=xOffset+(zSlice0*sliceSize);float s1=xOffset+(zSlice1*sliceSize);vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));float zOffset=mod(uv.z*width,1.0);vec4 result=mix(slice0Color,slice1Color,zOffset);return result;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 screen_color=texture2D(textureSampler,vUV);gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);}";class Xc extends es{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,s,n,r,o){super(e,"colorCorrection",null,["colorTable"],i,s,n,r,o);const a=(null==s?void 0:s.getScene())||null;this._colorTableTexture=new zi(t,a,!0,!1,zi.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=zi.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=zi.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=e=>{e.setTexture("colorTable",this._colorTableTexture)}}static _Parse(e,t,i,s){return qe.Parse((()=>new Xc(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}De([Ge()],Xc.prototype,"colorTableUrl",void 0),ue("BABYLON.ColorCorrectionPostProcess",Xc);F.ShadersStore.convolutionPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform float kernel[9];\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];float kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);}";class Qc extends es{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,s,n,r,o,a=0){super(e,"convolution",["kernel","screenSize"],null,i,s,n,r,o,null,a),this.kernel=t,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setArray("kernel",this.kernel)}}static _Parse(e,t,i,s){return qe.Parse((()=>new Qc(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType)),e,i,s)}}Qc.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],Qc.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],Qc.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],Qc.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],Qc.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],Qc.GaussianKernel=[0,1,0,1,1,1,0,1,0],De([Ge()],Qc.prototype,"kernel",void 0),ue("BABYLON.ConvolutionPostProcess",Qc);class Yc extends ts{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,i,s,n,r,o,a=null,l=zi.BILINEAR_SAMPLINGMODE,h,c,d=0,u=!1,_=5){super(e,i,s,n,r,2,h,c,d,"#define DOF 1\n",u,_),this.direction=i,this.externalTextureSamplerBinding=!!a,this.onApplyObservable.add((e=>{null!=a&&e.setTextureFromPostProcess("textureSampler",a),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",o)}))}}De([Ge()],Yc.prototype,"direction",void 0),ue("BABYLON.DepthOfFieldBlurPostProcess",Yc);F.ShadersStore.depthOfFieldMergePixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;uniform sampler2D circleOfConfusionSampler;uniform sampler2D blurStep0;\n#if BLUR_LEVEL>0\nuniform sampler2D blurStep1;\n#endif\n#if BLUR_LEVEL>1\nuniform sampler2D blurStep2;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{float coc=TEXTUREFUNC(circleOfConfusionSampler,vUV,0.0).r;\n#if BLUR_LEVEL==0\nvec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);gl_FragColor=mix(original,blurred0,coc);\n#endif\n#if BLUR_LEVEL==1\nif(coc<0.5){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(original,blurred1,coc/0.5);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);}\n#endif\n#if BLUR_LEVEL==2\nif(coc<0.33){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(original,blurred2,coc/0.33);}else if(coc<0.66){vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);}\n#endif\n}\n";class Kc extends es{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,i,s,n,r,o,a,l,h=0,c=!1){super(e,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],n,r,o,a,l,null,h,void 0,null,!0),this._blurSteps=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add((e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",i),s.forEach(((t,i)=>{e.setTextureFromPostProcessOutput("blurStep"+(s.length-i-1),t)}))})),c||this.updateEffect()}updateEffect(e=null,t=null,i=null,s,n,r){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+"\n"),super.updateEffect(e,t,i,s,n,r)}}var jc;!function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(jc||(jc={}));class $c extends kc{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,i=jc.Low,s=0,n=!1){super(e.getEngine(),"depth of field",(()=>this._effects),!0),this._effects=[];const r=e.getEngine(),o=r.isWebGPU||r.webGLVersion>1?6:5;this._circleOfConfusion=new Wc("circleOfConfusion",t,1,null,zi.BILINEAR_SAMPLINGMODE,r,!1,s,n),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];let a=1,l=15;switch(i){case jc.High:a=3,l=51;break;case jc.Medium:a=2,l=31;break;default:l=15,a=1}const h=l/Math.pow(2,a-1);let c=1;for(let t=0;t<a;t++){const i=new Yc("vertical blur",e,new pe(0,1),h,c,null,this._circleOfConfusion,0==t?this._circleOfConfusion:null,zi.BILINEAR_SAMPLINGMODE,r,!1,s,n,0==t?o:5);i.autoClear=!1,c=.75/Math.pow(2,t);const a=new Yc("horizontal blur",e,new pe(1,0),h,c,null,this._circleOfConfusion,null,zi.BILINEAR_SAMPLINGMODE,r,!1,s,n);a.autoClear=!1,this._depthOfFieldBlurY.push(i),this._depthOfFieldBlurX.push(a)}this._effects=[this._circleOfConfusion];for(let e=0;e<this._depthOfFieldBlurX.length;e++)this._effects.push(this._depthOfFieldBlurY[e]),this._effects.push(this._depthOfFieldBlurX[e]);this._dofMerge=new Kc("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,c,null,zi.BILINEAR_SAMPLINGMODE,r,!1,s,n),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}F.ShadersStore.displayPassPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D passSampler;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(passSampler,vUV);}";class qc extends es{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,s,n,r){super(e,"displayPass",["passSampler"],["passSampler"],t,i,s,n,r)}static _Parse(e,t,i,s){return qe.Parse((()=>new qc(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}ue("BABYLON.DisplayPassPostProcess",qc);F.ShadersStore.filterPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform mat4 kernelMatrix;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec3 baseColor=texture2D(textureSampler,vUV).rgb;vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;gl_FragColor=vec4(updatedColor,1.0);}";class Zc extends es{getClassName(){return"FilterPostProcess"}constructor(e,t,i,s,n,r,o){super(e,"filter",["kernelMatrix"],null,i,s,n,r,o),this.kernelMatrix=t,this.onApply=e=>{e.setMatrix("kernelMatrix",this.kernelMatrix)}}static _Parse(e,t,i,s){return qe.Parse((()=>new Zc(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}De([$e()],Zc.prototype,"kernelMatrix",void 0),ue("BABYLON.FilterPostProcess",Zc);F.ShadersStore.fxaaPixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)\n#else\n#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)\n#endif\nuniform sampler2D textureSampler;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const float fxaaQualitySubpix=1.0;const float fxaaQualityEdgeThreshold=0.166;const float fxaaQualityEdgeThresholdMin=0.0833;const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);\n#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)\nvoid main(){vec2 posM;posM.x=vUV.x;posM.y=vUV.y;vec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);float lumaM=FxaaLuma(rgbyM);float lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));float lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));float lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));float lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));float maxSM=max(lumaS,lumaM);float minSM=min(lumaS,lumaM);float maxESM=max(lumaE,maxSM);float minESM=min(lumaE,minSM);float maxWN=max(lumaN,lumaW);float minWN=min(lumaN,lumaW);float rangeMax=max(maxWN,maxESM);float rangeMin=min(minWN,minESM);float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;float range=rangeMax-rangeMin;float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);\n#ifndef MALI\nif(range<rangeMaxClamped) \n{gl_FragColor=rgbyM;return;}\n#endif\nfloat lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));float lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));float lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));float lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));float lumaNS=lumaN+lumaS;float lumaWE=lumaW+lumaE;float subpixRcpRange=1.0/range;float subpixNSWE=lumaNS+lumaWE;float edgeHorz1=(-2.0*lumaM)+lumaNS;float edgeVert1=(-2.0*lumaM)+lumaWE;float lumaNESE=lumaNE+lumaSE;float lumaNWNE=lumaNW+lumaNE;float edgeHorz2=(-2.0*lumaE)+lumaNESE;float edgeVert2=(-2.0*lumaN)+lumaNWNE;float lumaNWSW=lumaNW+lumaSW;float lumaSWSE=lumaSW+lumaSE;float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);float edgeHorz3=(-2.0*lumaW)+lumaNWSW;float edgeVert3=(-2.0*lumaS)+lumaSWSE;float edgeHorz=abs(edgeHorz3)+edgeHorz4;float edgeVert=abs(edgeVert3)+edgeVert4;float subpixNWSWNESE=lumaNWSW+lumaNESE;float lengthSign=texelSize.x;bool horzSpan=edgeHorz>=edgeVert;float subpixA=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)\n{lumaN=lumaW;}\nif (!horzSpan) \n{lumaS=lumaE;}\nif (horzSpan) \n{lengthSign=texelSize.y;}\nfloat subpixB=(subpixA*(1.0/12.0))-lumaM;float gradientN=lumaN-lumaM;float gradientS=lumaS-lumaM;float lumaNN=lumaN+lumaM;float lumaSS=lumaS+lumaM;bool pairN=abs(gradientN)>=abs(gradientS);float gradient=max(abs(gradientN),abs(gradientS));if (pairN)\n{lengthSign=-lengthSign;}\nfloat subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);vec2 posB;posB.x=posM.x;posB.y=posM.y;vec2 offNP;offNP.x=(!horzSpan) ? 0.0 : texelSize.x;offNP.y=(horzSpan) ? 0.0 : texelSize.y;if (!horzSpan) \n{posB.x+=lengthSign*0.5;}\nif (horzSpan)\n{posB.y+=lengthSign*0.5;}\nvec2 posN;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;vec2 posP;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;float subpixD=((-2.0)*subpixC)+3.0;float lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));float subpixE=subpixC*subpixC;float lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));if (!pairN) \n{lumaNN=lumaSS;}\nfloat gradientScaled=gradient*1.0/4.0;float lumaMM=lumaM-lumaNN*0.5;float subpixF=subpixD*subpixE;bool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;bool doneN=abs(lumaEndN)>=gradientScaled;bool doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) \n{posN.x-=offNP.x*3.0;}\nif (!doneN) \n{posN.y-=offNP.y*3.0;}\nbool doneNP=(!doneN) || (!doneP);if (!doneP) \n{posP.x+=offNP.x*3.0;}\nif (!doneP)\n{posP.y+=offNP.y*3.0;}\nif (doneNP)\n{if (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));if (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) posN.x-=offNP.x*12.0;if (!doneN) posN.y-=offNP.y*12.0;doneNP=(!doneN) || (!doneP);if (!doneP) posP.x+=offNP.x*12.0;if (!doneP) posP.y+=offNP.y*12.0;}\nfloat dstN=posM.x-posN.x;float dstP=posP.x-posM.x;if (!horzSpan)\n{dstN=posM.y-posN.y;}\nif (!horzSpan) \n{dstP=posP.y-posM.y;}\nbool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;float spanLength=(dstP+dstN);bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;float spanLengthRcp=1.0/spanLength;bool directionN=dstN<dstP;float dst=min(dstN,dstP);bool goodSpan=directionN ? goodSpanN : goodSpanP;float subpixG=subpixF*subpixF;float pixelOffset=(dst*(-spanLengthRcp))+0.5;float subpixH=subpixG*fxaaQualitySubpix;float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if (!horzSpan)\n{posM.x+=pixelOffsetSubpix*lengthSign;}\nif (horzSpan)\n{posM.y+=pixelOffsetSubpix*lengthSign;}\n#ifdef MALI\nif(range<rangeMaxClamped) \n{gl_FragColor=rgbyM;}\nelse\n{gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);}\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);\n#endif\n}";F.ShadersStore.fxaaVertexShader="attribute vec2 position;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd);sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";class Jc extends es{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,s,n,r,o=0){super(e,"fxaa",["texelSize"],null,t,i,s||zi.BILINEAR_SAMPLINGMODE,n,r,null,o,"fxaa",void 0,!0);const a=this._getDefines();this.updateEffect(a),this.onApplyObservable.add((e=>{const t=this.texelSize;e.setFloat2("texelSize",t.x,t.y)}))}_getDefines(){const e=this.getEngine();if(!e)return null;const t=e.getGlInfo();return t&&t.renderer&&t.renderer.toLowerCase().indexOf("mali")>-1?"#define MALI 1\n":null}static _Parse(e,t,i,s){return qe.Parse((()=>new Jc(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}ue("BABYLON.FxaaPostProcess",Jc);F.ShadersStore.grainPixelShader="#include<helperFunctions>\nuniform sampler2D textureSampler; \nuniform float intensity;uniform float animatedSeed;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{gl_FragColor=texture2D(textureSampler,vUV);vec2 seed=vUV*(animatedSeed);float grain=dither(seed,intensity);float lum=getLuminance(gl_FragColor.rgb);float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;gl_FragColor.rgb+=grain*grainAmount;gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);}";class ed extends es{getClassName(){return"GrainPostProcess"}constructor(e,t,i,s,n,r,o=0,a=!1){super(e,"grain",["intensity","animatedSeed"],[],t,i,s,n,r,null,o,void 0,null,a),this.intensity=30,this.animated=!1,this.onApplyObservable.add((e=>{e.setFloat("intensity",this.intensity),e.setFloat("animatedSeed",this.animated?Math.random()+1:1)}))}static _Parse(e,t,i,s){return qe.Parse((()=>new ed(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}De([Ge()],ed.prototype,"intensity",void 0),De([Ge()],ed.prototype,"animated",void 0),ue("BABYLON.GrainPostProcess",ed);F.ShadersStore.highlightsPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec4 tex=texture2D(textureSampler,vUV);vec3 c=tex.rgb;float luma=dot(c.rgb,RGBLuminanceCoefficients);gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); }";F.ShadersStore.imageProcessingPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;\n#include<imageProcessingDeclaration>\n#include<helperFunctions>\n#include<imageProcessingFunctions>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 result=texture2D(textureSampler,vUV);\n#ifdef IMAGEPROCESSING\n#ifndef FROMLINEARSPACE\nresult.rgb=toLinearSpace(result.rgb);\n#endif\nresult=applyImageProcessing(result);\n#else\n#ifdef FROMLINEARSPACE\nresult=applyImageProcessing(result);\n#endif\n#endif\ngl_FragColor=result;}";class td extends es{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let e=null;const t=this.getEngine(),i=this.getCamera();if(i)e=i.getScene();else if(t&&t.scenes){const i=t.scenes;e=i[i.length-1]}else e=u.LastCreatedScene;this._imageProcessingConfiguration=e?e.imageProcessingConfiguration:new Yt}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((()=>{this._updateParameters()}))),t||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,i=null,s,n,r,o=0,a){super(e,"imageProcessing",[],[],t,i,s,n,r,null,o,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},a?(a.applyByPostProcess=!0,this._attachImageProcessingConfiguration(a,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=e=>{this.imageProcessingConfiguration.bind(e,this.aspectRatio)}}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const t in this._defines)this._defines[t]&&(e+=`#define ${t};\n`);const t=["textureSampler"],i=["scale"];Yt&&(Yt.PrepareSamplers(t,this._defines),Yt.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}De([Ge()],td.prototype,"_fromLinearSpace",void 0),q.prototype.restoreSingleAttachment=function(){const e=this._gl;this.bindAttachments([e.BACK])},q.prototype.restoreSingleAttachmentForRenderTarget=function(){const e=this._gl;this.bindAttachments([e.COLOR_ATTACHMENT0])},q.prototype.buildTextureLayout=function(e){const t=this._gl,i=[];for(let s=0;s<e.length;s++)e[s]?i.push(t["COLOR_ATTACHMENT"+s]):i.push(t.NONE);return i},q.prototype.bindAttachments=function(e){this._gl.drawBuffers(e)},q.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){this._currentRenderTarget=null;const s=this._gl,n=e._attachments,r=n.length;if(e._MSAAFramebuffer){s.bindFramebuffer(s.READ_FRAMEBUFFER,e._MSAAFramebuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,e._framebuffer);for(let t=0;t<r;t++){const i=e.textures[t];for(let e=0;e<r;e++)n[e]=s.NONE;n[t]=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"],s.readBuffer(n[t]),s.drawBuffers(n),s.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,s.COLOR_BUFFER_BIT,s.NEAREST)}for(let e=0;e<r;e++)n[e]=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];s.drawBuffers(n)}for(let i=0;i<r;i++){const n=e.textures[i];!(null==n?void 0:n.generateMipMaps)||t||n.isCube||(this._bindTextureDirectly(s.TEXTURE_2D,n,!0),s.generateMipmap(s.TEXTURE_2D),this._bindTextureDirectly(s.TEXTURE_2D,null))}i&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),i()),this._bindUnboundFramebuffer(null)},q.prototype.createMultipleRenderTarget=function(e,t,i=!0){var s,n;let o=!1,l=!0,h=!1,c=!1,d=15,u=1,_=[],f=[],m=[],g=[],v=[],T=[],b=[],E=[];const S=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(o=void 0!==t.generateMipMaps&&t.generateMipMaps,l=void 0===t.generateDepthBuffer||t.generateDepthBuffer,h=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,c=void 0!==t.generateDepthTexture&&t.generateDepthTexture,u=t.textureCount||1,t.types&&(_=t.types),t.samplingModes&&(f=t.samplingModes),t.useSRGBBuffers&&(m=t.useSRGBBuffers),t.formats&&(g=t.formats),t.targetTypes&&(v=t.targetTypes),t.faceIndex&&(T=t.faceIndex),t.layerIndex&&(b=t.layerIndex),t.layerCounts&&(E=t.layerCounts),this.webGLVersion>1&&(13===t.depthTextureFormat||17===t.depthTextureFormat||16===t.depthTextureFormat||14===t.depthTextureFormat||18===t.depthTextureFormat)&&(d=t.depthTextureFormat)),S.label=null!==(s=null==t?void 0:t.label)&&void 0!==s?s:"MultiRenderTargetWrapper";const x=this._gl,C=x.createFramebuffer();this._bindUnboundFramebuffer(C);const y=e.width||e,A=e.height||e,R=[],I=[],P=this.webGLVersion>1&&c&&(13===t.depthTextureFormat||17===t.depthTextureFormat||18===t.depthTextureFormat),M=this._setupFramebufferDepthAttachments(!P&&h,!c&&l,y,A);S._framebuffer=C,S._depthStencilBuffer=M,S._generateDepthBuffer=!c&&l,S._generateStencilBuffer=!P&&h,S._attachments=I;for(let e=0;e<u;e++){let t=f[e]||3,i=_[e]||0,s=m[e]||!1;const l=g[e]||5,h=v[e]||3553,c=null!==(n=E[e])&&void 0!==n?n:1;(1!==i||this._caps.textureFloatLinearFiltering)&&(2!==i||this._caps.textureHalfFloatLinearFiltering)||(t=1);const d=this._getSamplingParameters(t,o);1!==i||this._caps.textureFloat||(i=0,p.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),s=s&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const u=this.webGLVersion>1,T=x[u?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];if(I.push(T),-1===h)continue;const b=new a(this,r.MultiRenderTarget);R[e]=b,x.activeTexture(x["TEXTURE"+e]),x.bindTexture(h,b._hardwareTexture.underlyingResource),x.texParameteri(h,x.TEXTURE_MAG_FILTER,d.mag),x.texParameteri(h,x.TEXTURE_MIN_FILTER,d.min),x.texParameteri(h,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(h,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE);const S=this._getRGBABufferInternalSizedFormat(i,l,s),C=this._getInternalFormat(l),P=this._getWebGLTextureType(i);if(!u||35866!==h&&32879!==h)if(34067===h){for(let e=0;e<6;e++)x.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,S,y,A,0,C,P,null);b.isCube=!0}else x.texImage2D(x.TEXTURE_2D,0,S,y,A,0,C,P,null);else 35866===h?b.is2DArray=!0:b.is3D=!0,b.baseDepth=b.depth=c,x.texImage3D(h,0,S,y,A,c,0,C,P,null);o&&x.generateMipmap(h),this._bindTextureDirectly(h,null),b.baseWidth=y,b.baseHeight=A,b.width=y,b.height=A,b.isReady=!0,b.samples=1,b.generateMipMaps=o,b.samplingMode=t,b.type=i,b._useSRGBBuffer=s,b.format=l,this._internalTexturesCache.push(b)}if(c&&this._caps.depthTextureExtension){const e=new a(this,r.Depth);let t=5,i=x.DEPTH_COMPONENT16,s=x.DEPTH_COMPONENT,n=x.UNSIGNED_SHORT,l=x.DEPTH_ATTACHMENT;this.webGLVersion<2?i=x.DEPTH_COMPONENT:14===d?(t=1,n=x.FLOAT,i=x.DEPTH_COMPONENT32F):18===d?(t=0,n=x.FLOAT_32_UNSIGNED_INT_24_8_REV,i=x.DEPTH32F_STENCIL8,s=x.DEPTH_STENCIL,l=x.DEPTH_STENCIL_ATTACHMENT):16===d?(t=0,n=x.UNSIGNED_INT,i=x.DEPTH_COMPONENT24,l=x.DEPTH_ATTACHMENT):13!==d&&17!==d||(t=12,n=x.UNSIGNED_INT_24_8,i=x.DEPTH24_STENCIL8,s=x.DEPTH_STENCIL,l=x.DEPTH_STENCIL_ATTACHMENT),x.activeTexture(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,e._hardwareTexture.underlyingResource),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texImage2D(x.TEXTURE_2D,0,i,y,A,0,s,n,null),x.framebufferTexture2D(x.FRAMEBUFFER,l,x.TEXTURE_2D,e._hardwareTexture.underlyingResource,0),e.baseWidth=y,e.baseHeight=A,e.width=y,e.height=A,e.isReady=!0,e.samples=1,e.generateMipMaps=o,e.samplingMode=1,e.format=d,e.type=t,R[u]=e,this._internalTexturesCache.push(e)}return S.setTextures(R),i&&x.drawBuffers(I),this._bindUnboundFramebuffer(null),S.setLayerAndFaceIndices(b,T),this.resetTextureCache(),S},q.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t,i=!0){if(this.webGLVersion<2||!e||!e.texture)return 1;if(e.samples===t)return t;const s=e._attachments.length;if(0===s)return 1;const n=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples);const r=!!e._depthStencilBuffer;if(r&&(n.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(n.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null),t>1&&"function"==typeof n.renderbufferStorageMultisample){const r=n.createFramebuffer();if(!r)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=r,this._bindUnboundFramebuffer(r);const o=[];for(let t=0;t<s;t++)e.textures[t]._hardwareTexture.releaseMSAARenderBuffers();for(let i=0;i<s;i++){const s=e.textures[i],r=s._hardwareTexture,a=n[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],l=this._createRenderBuffer(s.width,s.height,t,-1,this._getRGBABufferInternalSizedFormat(s.type,s.format,s._useSRGBBuffer),a);if(!l)throw new Error("Unable to create multi sampled framebuffer");r.addMSAARenderBuffer(l),s.samples=t,o.push(a)}i&&n.drawBuffers(o)}else this._bindUnboundFramebuffer(e._framebuffer);return r&&(e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.texture.width,e.texture.height,t)),this._bindUnboundFramebuffer(null),t};class id extends Ji{get isSupported(){var e,t;return null!==(t=null===(e=this._engine)||void 0===e?void 0:e.getCaps().drawBuffersExtension)&&void 0!==t&&t}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,s,n,r){const o=!(!n||!n.generateMipMaps)&&n.generateMipMaps,a=!(!n||!n.generateDepthTexture)&&n.generateDepthTexture,l=n&&n.depthTextureFormat?n.depthTextureFormat:15,h=!n||void 0===n.doNotChangeAspectRatio||n.doNotChangeAspectRatio,c=!(!n||!n.drawOnlyOnFirstAttachmentByDefault)&&n.drawOnlyOnFirstAttachmentByDefault;if(super(e,t,s,o,h,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported)return void this.dispose();this._textureNames=r;const d=[],u=[],_=[],f=[],p=[],m=[],g=[],v=[];this._initTypes(i,d,u,_,f,p,m,g,v,n);const T=!n||void 0===n.generateDepthBuffer||n.generateDepthBuffer,b=!(!n||void 0===n.generateStencilBuffer)&&n.generateStencilBuffer;this._multiRenderTargetOptions={samplingModes:u,generateMipMaps:o,generateDepthBuffer:T,generateStencilBuffer:b,generateDepthTexture:a,depthTextureFormat:l,types:d,textureCount:i,useSRGBBuffers:_,formats:f,targetTypes:p,faceIndex:m,layerIndex:g,layerCounts:v,labels:r,label:e},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=c,i>0&&(this._createInternalTextures(),this._createTextures(r))}_initTypes(e,t,i,s,n,r,o,a,l,h){for(let c=0;c<e;c++)h&&h.types&&void 0!==h.types[c]?t.push(h.types[c]):t.push(h&&h.defaultType?h.defaultType:0),h&&h.samplingModes&&void 0!==h.samplingModes[c]?i.push(h.samplingModes[c]):i.push(zi.BILINEAR_SAMPLINGMODE),h&&h.useSRGBBuffers&&void 0!==h.useSRGBBuffers[c]?s.push(h.useSRGBBuffers[c]):s.push(!1),h&&h.formats&&void 0!==h.formats[c]?n.push(h.formats[c]):n.push(5),h&&h.targetTypes&&void 0!==h.targetTypes[c]?r.push(h.targetTypes[c]):r.push(3553),h&&h.faceIndex&&void 0!==h.faceIndex[c]?o.push(h.faceIndex[c]):o.push(0),h&&h.layerIndex&&void 0!==h.layerIndex[c]?a.push(h.layerIndex[c]):a.push(0),h&&h.layerCounts&&void 0!==h.layerCounts[c]?l.push(h.layerCounts[c]):l.push(1)}_createInternaTextureIndexMapping(){const e={},t=[];if(!this._renderTarget)return t;const i=this._renderTarget.textures;for(let s=0;s<i.length;s++){const n=i[s];if(!n)continue;const r=e[n.uniqueId];void 0!==r?t[s]=r:e[n.uniqueId]=s}return t}_rebuild(e=!1,t){if(this._count<1)return;const i=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),e&&(this._releaseTextures(),this._createTextures(t));const s=this._renderTarget.textures;for(let e=0;e<s.length;e++){const t=this._textures[e];void 0!==i[e]&&this._renderTarget.setTexture(s[i[e]],e),t._texture=s[e],t._texture&&(t._noMipmap=!t._texture.useMipMaps,t._useSRGBBuffer=t._texture._useSRGBBuffer)}1!==this.samples&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){const s=new zi(null,this.getScene());(null==e?void 0:e[i])&&(s.name=e[i]),s._texture=t[i],s._texture&&(s._noMipmap=!s._texture.useMipMaps,s._useSRGBBuffer=s._texture._useSRGBBuffer),this._textures.push(s)}}setInternalTexture(e,t,i=!0){var s,n;if(this.renderTarget&&(0===t&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new zi(null,this.getScene()),this.textures[t].name=null!==(n=null===(s=this._textureNames)||void 0===s?void 0:s[t])&&void 0!==n?n:this.textures[t].name),this.textures[t]._texture=e,this.textures[t]._noMipmap=!e.useMipMaps,this.textures[t]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&-1!==this._multiRenderTargetOptions.targetTypes[t])){let i=0;i=e.is2DArray?35866:e.isCube?34067:e.is3D?32879:3553,this._multiRenderTargetOptions.targetTypes[t]=i}}setLayerAndFaceIndex(e,t=-1,i=-1){this.textures[e]&&this.renderTarget&&(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i))}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._processSizeParameter(e,!1),this._rebuild(void 0,this._textureNames)}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const s=[],n=[],r=[],o=[],a=[],l=[],h=[],c=[];this._textureNames=i,this._initTypes(e,s,n,r,o,a,l,h,c,t),this._multiRenderTargetOptions.types=s,this._multiRenderTargetOptions.samplingModes=n,this._multiRenderTargetOptions.useSRGBBuffers=r,this._multiRenderTargetOptions.formats=o,this._multiRenderTargetOptions.targetTypes=a,this._multiRenderTargetOptions.faceIndex=l,this._multiRenderTargetOptions.layerIndex=h,this._multiRenderTargetOptions.layerCounts=c,this._multiRenderTargetOptions.labels=i,this._rebuild(!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,(()=>{this.onAfterRenderObservable.notifyObservers(t)}))}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){var e,t;const i=null===(e=this._renderTarget)||void 0===e?void 0:e.textures;if(i){for(let e=i.length-1;e>=0;e--)this._textures[e]._texture=null;null===(t=this._renderTarget)||void 0===t||t.dispose(),this._renderTarget=null}}}F.IncludesShadersStore.mrtFragmentDeclaration="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\nlayout(location=0) out vec4 glFragData[{X}];\n#endif\n";F.ShadersStore.geometryPixelShader="#extension GL_EXT_draw_buffers : require\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n#ifdef BUMP\nvarying mat4 vWorldView;varying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#ifdef VELOCITY\nvarying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#ifdef NEED_UV\nvarying vec2 vUV;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIVITY)\n#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nuniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;\n#endif\n#ifdef ALBEDOTEXTURE\nvarying vec2 vAlbedoUV;uniform sampler2D albedoSampler;\n#endif\n#ifdef REFLECTIVITYCOLOR\nuniform vec3 reflectivityColor;\n#endif\n#ifdef ALBEDOCOLOR\nuniform vec3 albedoColor;\n#endif\n#ifdef METALLIC\nuniform float metallic;\n#endif\n#if defined(ROUGHNESS) || defined(GLOSSINESS)\nuniform float glossiness;\n#endif\n#endif\n#if defined(ALPHATEST) && defined(NEED_UV)\nuniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<mrtFragmentDeclaration>[RENDER_TARGET_COUNT]\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#include<helperFunctions>\nvoid main() {\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nvec3 normalOutput;\n#ifdef BUMP\nvec3 normalW=normalize(vNormalW);\n#include<bumpFragment>\n#ifdef NORMAL_WORLDSPACE\nnormalOutput=normalW;\n#else\nnormalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));\n#endif\n#else\nnormalOutput=normalize(vNormalV);\n#endif\n#ifdef PREPASS\n#ifdef PREPASS_DEPTH\ngl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);\n#endif\n#ifdef PREPASS_NORMAL\ngl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);\n#endif\n#else\ngl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);gl_FragData[1]=vec4(normalOutput,1.0);\n#endif\n#ifdef POSITION\ngl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);\n#endif\n#ifdef VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef REFLECTIVITY\nvec4 reflectivity=vec4(0.0,0.0,0.0,1.0);\n#ifdef METALLICWORKFLOW\nfloat metal=1.0;float roughness=1.0;\n#ifdef ORMTEXTURE\nmetal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;\n#endif\n#ifdef METALLIC\nmetal*=metallic;\n#endif\n#ifdef ROUGHNESS\nroughness*=(1.0-glossiness); \n#endif\nreflectivity.a-=roughness;vec3 color=vec3(1.0);\n#ifdef ALBEDOTEXTURE\ncolor=texture2D(albedoSampler,vAlbedoUV).rgb;\n#ifdef GAMMAALBEDO\ncolor=toLinearSpace(color);\n#endif\n#endif\n#ifdef ALBEDOCOLOR\ncolor*=albedoColor.xyz;\n#endif\nreflectivity.rgb=mix(vec3(0.04),color,metal);\n#else\n#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)\nreflectivity=texture2D(reflectivitySampler,vReflectivityUV);\n#ifdef GAMMAREFLECTIVITYTEXTURE\nreflectivity.rgb=toLinearSpace(reflectivity.rgb);\n#endif\n#else \n#ifdef REFLECTIVITYCOLOR\nreflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;\n#endif\n#endif\n#ifdef GLOSSINESSS\nreflectivity.a*=glossiness; \n#endif\n#endif\ngl_FragData[REFLECTIVITY_INDEX]=reflectivity;\n#endif\n}\n";F.IncludesShadersStore.geometryVertexDeclaration="uniform mat4 viewProjection;uniform mat4 view;";F.IncludesShadersStore.geometryUboDeclaration="#include<sceneUboDeclaration>\n";F.ShadersStore.geometryVertexShader="precision highp float;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\n#include<__decl__geometryVertex>\n#include<clipPlaneVertexDeclaration>\nattribute vec3 position;attribute vec3 normal;\n#ifdef NEED_UV\nvarying vec2 vUV;\n#ifdef ALPHATEST\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef BUMP\nuniform mat4 bumpMatrix;varying vec2 vBumpUV;\n#endif\n#ifdef REFLECTIVITY\nuniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#ifdef BUMP\nvarying mat4 vWorldView;\n#endif\n#ifdef BUMP\nvarying vec3 vNormalW;\n#else\nvarying vec3 vNormalV;\n#endif\nvarying vec4 vViewPos;\n#if defined(POSITION) || defined(BUMP)\nvarying vec3 vPositionW;\n#endif\n#ifdef VELOCITY\nuniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));\n#ifdef BUMP\nvWorldView=view*finalWorld;vNormalW=normalUpdated;\n#else\n#ifdef NORMAL_WORLDSPACE\nvNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));\n#else\nvNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));\n#endif\n#endif\nvViewPos=view*worldPos;\n#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if NUM_BONE_INFLUENCERS>0\nmat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\npreviousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif\n#if NUM_BONE_INFLUENCERS>2\npreviousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif\n#if NUM_BONE_INFLUENCERS>3\npreviousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif\n#if NUM_BONE_INFLUENCERS>4\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif\n#if NUM_BONE_INFLUENCERS>5\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif\n#if NUM_BONE_INFLUENCERS>6\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif\n#if NUM_BONE_INFLUENCERS>7\npreviousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif\nvPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);\n#else\nvPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);\n#endif\n#endif\n#if defined(POSITION) || defined(BUMP)\nvPositionW=worldPos.xyz/worldPos.w;\n#endif\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#include<clipPlaneVertex>\n#ifdef NEED_UV\n#ifdef UV1\n#if defined(ALPHATEST) && defined(ALPHATEST_UV1)\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#else\nvUV=uv;\n#endif\n#ifdef BUMP_UV1\nvBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV1\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV1\nvAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#endif\n#ifdef UV2\n#if defined(ALPHATEST) && defined(ALPHATEST_UV2)\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#else\nvUV=uv2;\n#endif\n#ifdef BUMP_UV2\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef REFLECTIVITY_UV2\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n#endif\n#ifdef ALBEDO_UV2\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#endif\n#include<bumpVertex>\n}\n";const sd=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];Di(sd);class nd{_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add((()=>{})))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._attachmentsFromPrePass=[]}_forceTextureType(e,t){e===nd.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===nd.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===nd.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===nd.DEPTH_TEXTURE_TYPE?this._depthIndex=t:e===nd.NORMAL_TEXTURE_TYPE&&(this._normalIndex=t)}_setAttachments(e){this._attachmentsFromPrePass=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case nd.POSITION_TEXTURE_TYPE:return this._positionIndex;case nd.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case nd.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case nd.DEPTH_TEXTURE_TYPE:return this._linkedWithPrePass?this._depthIndex:0;case nd.NORMAL_TEXTURE_TYPE:return this._linkedWithPrePass?this._normalIndex:1;default:return-1}}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return"object"==typeof this._ratioOrDimensions?1:this._ratioOrDimensions}constructor(e,t=1,i=15){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._resizeObserver=null,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._clearColor=new Ie(0,0,0,0),this._clearDepthColor=new Ie(1e8,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._scene=e,this._ratioOrDimensions=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,nd._SceneComponentInitialization(this._scene),this._createRenderTargets()}isReady(e,t){const i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;const s=[],n=[Oe.PositionKind,Oe.NormalKind],r=e.getMesh();if(i){let e=!1;if(i.needAlphaTesting()&&i.getAlphaTestTexture()&&(s.push("#define ALPHATEST"),s.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),e=!0),i.bumpTexture&&Os.BumpTextureEnabled&&(s.push("#define BUMP"),s.push(`#define BUMP_UV${i.bumpTexture.coordinatesIndex+1}`),e=!0),this._enableReflectivity){let t=!1;"PBRMetallicRoughnessMaterial"===i.getClassName()?(null!==i.metallicRoughnessTexture&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!==i.metallic&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),t=!0),null!==i.roughness&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),t=!0),t&&(null!==i.baseTexture&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),e=!0),null!==i.baseColor&&s.push("#define ALBEDOCOLOR"))):"PBRSpecularGlossinessMaterial"===i.getClassName()?(null!==i.specularGlossinessTexture?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),e=!0,i.specularGlossinessTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE")):null!==i.specularColor&&s.push("#define REFLECTIVITYCOLOR"),null!==i.glossiness&&s.push("#define GLOSSINESS")):"PBRMaterial"===i.getClassName()?(null!==i.metallicTexture&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!==i.metallic&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),t=!0),null!==i.roughness&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),t=!0),t?(null!==i.albedoTexture&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),e=!0),null!==i.albedoColor&&s.push("#define ALBEDOCOLOR")):(null!==i.reflectivityTexture?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0):null!==i.reflectivityColor&&s.push("#define REFLECTIVITYCOLOR"),null!==i.microSurface&&s.push("#define GLOSSINESS"))):"StandardMaterial"===i.getClassName()&&(null!==i.specularTexture&&(s.push("#define REFLECTIVITYTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0),null!==i.specularColor&&s.push("#define REFLECTIVITYCOLOR"))}e&&(s.push("#define NEED_UV"),r.isVerticesDataPresent(Oe.UVKind)&&(n.push(Oe.UVKind),s.push("#define UV1")),r.isVerticesDataPresent(Oe.UV2Kind)&&(n.push(Oe.UV2Kind),s.push("#define UV2")))}this._linkedWithPrePass&&(s.push("#define PREPASS"),-1!==this._depthIndex&&(s.push("#define DEPTH_INDEX "+this._depthIndex),s.push("#define PREPASS_DEPTH")),-1!==this._normalIndex&&(s.push("#define NORMAL_INDEX "+this._normalIndex),s.push("#define PREPASS_NORMAL"))),this._enablePosition&&(s.push("#define POSITION"),s.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(s.push("#define VELOCITY"),s.push("#define VELOCITY_INDEX "+this._velocityIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(r)&&s.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(s.push("#define REFLECTIVITY"),s.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this.generateNormalsInWorldSpace&&s.push("#define NORMAL_WORLDSPACE"),r.useBones&&r.computeBonesUsingShaders&&r.skeleton?(n.push(Oe.MatricesIndicesKind),n.push(Oe.MatricesWeightsKind),r.numBoneInfluencers>4&&(n.push(Oe.MatricesIndicesExtraKind),n.push(Oe.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),s.push("#define BONETEXTURE "+r.skeleton.isUsingTextureForMatrices),s.push("#define BonesPerMesh "+(r.skeleton.bones.length+1))):(s.push("#define NUM_BONE_INFLUENCERS 0"),s.push("#define BONETEXTURE false"),s.push("#define BonesPerMesh 0"));const o=r.morphTargetManager;let a=0;o&&o.numInfluencers>0&&(a=o.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+a),o.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),wi.PrepareAttributesForMorphTargetsInfluencers(n,r,a)),t&&(s.push("#define INSTANCES"),wi.PushAttributesForInstances(n,this._enableVelocity),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),this._linkedWithPrePass?s.push("#define RENDER_TARGET_COUNT "+this._attachmentsFromPrePass.length):s.push("#define RENDER_TARGET_COUNT "+this._multiRenderTarget.textures.length),Ni(i,this._scene,s);const l=this._scene.getEngine(),h=e._getDrawWrapper(void 0,!0),c=h.defines,d=s.join("\n");return c!==d&&h.setEffect(l.createEffect("geometry",{attributes:n,uniformsNames:sd,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:d,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:a}},l),d),h.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){const e=[];let t=2;return e.push("gBuffer_Depth","gBuffer_Normal"),this._enablePosition&&(this._positionIndex=t,t++,e.push("gBuffer_Position")),this._enableVelocity&&(this._velocityIndex=t,t++,e.push("gBuffer_Velocity")),this._enableReflectivity&&(this._reflectivityIndex=t,t++,e.push("gBuffer_Reflectivity")),[t,e]}_createRenderTargets(){const e=this._scene.getEngine(),[t,i]=this._assignRenderTargetIndices();let s=0;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?s=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(s=2);const n=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};if(this._multiRenderTarget=new id("gBuffer",n,t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,defaultType:s,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=zi.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=zi.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;const r=[!0],o=[!1],a=[!0];for(let e=1;e<t;++e)r.push(!0),a.push(!1),o.push(!0);const l=e.buildTextureLayout(r),h=e.buildTextureLayout(o),c=e.buildTextureLayout(a);this._multiRenderTarget.onClearObservable.add((e=>{e.bindAttachments(this.useSpecificClearForDepthTexture?h:l),e.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(e.bindAttachments(c),e.clear(this._clearDepthColor,!0,!0,!0)),e.bindAttachments(l)})),this._resizeObserver=e.onResizeObservable.add((()=>{if(this._multiRenderTarget){const t=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(t)}}));const d=e=>{const t=e.getRenderingMesh(),i=e.getEffectiveMesh(),s=this._scene,n=s.getEngine(),r=e.getMaterial();if(!r)return;if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,this._enableVelocity&&!this._previousTransformationMatrices[i.uniqueId]&&(this._previousTransformationMatrices[i.uniqueId]={world:Te.Identity(),viewProjection:s.getTransformMatrix()},t.skeleton)){const e=t.skeleton.getTransformMatrices(t);this._previousBonesTransformationMatrices[t.uniqueId]=this._copyBonesTransformationMatrices(e,new Float32Array(e.length))}const o=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(o.mustReturn)return;const a=n.getCaps().instancedArrays&&(null!==o.visibleInstances[e._id]||t.hasThinInstances),l=i.getWorldMatrix();if(this.isReady(e,a)){const h=e._getDrawWrapper();if(!h)return;const c=h.effect;let d;n.enableEffect(h),a||t._bind(e,c,r.fillMode),this._useUbo?(wi.BindSceneUniformBuffer(c,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(c.setMatrix("viewProjection",s.getTransformMatrix()),c.setMatrix("view",s.getViewMatrix()));const u=t._instanceDataStorage;if(u.isFrozen||!r.backFaceCulling&&null===t.overrideMaterialSideOrientation)d=u.sideOrientation;else{const e=i._getWorldMatrixDeterminant();d=t.overrideMaterialSideOrientation,null===d&&(d=r.sideOrientation),e<0&&(d=d===Ps.ClockWiseSideOrientation?Ps.CounterClockWiseSideOrientation:Ps.ClockWiseSideOrientation)}if(r._preBind(h,d),r.needAlphaTesting()){const e=r.getAlphaTestTexture();e&&(c.setTexture("diffuseSampler",e),c.setMatrix("diffuseMatrix",e.getTextureMatrix()))}if(r.bumpTexture&&s.getEngine().getCaps().standardDerivatives&&Os.BumpTextureEnabled&&(c.setFloat3("vBumpInfos",r.bumpTexture.coordinatesIndex,1/r.bumpTexture.level,r.parallaxScaleBias),c.setMatrix("bumpMatrix",r.bumpTexture.getTextureMatrix()),c.setTexture("bumpSampler",r.bumpTexture),c.setFloat2("vTangentSpaceParams",r.invertNormalMapX?-1:1,r.invertNormalMapY?-1:1)),this._enableReflectivity&&("PBRMetallicRoughnessMaterial"===r.getClassName()?(null!==r.metallicRoughnessTexture&&(c.setTexture("reflectivitySampler",r.metallicRoughnessTexture),c.setMatrix("reflectivityMatrix",r.metallicRoughnessTexture.getTextureMatrix())),null!==r.metallic&&c.setFloat("metallic",r.metallic),null!==r.roughness&&c.setFloat("glossiness",1-r.roughness),null!==r.baseTexture&&(c.setTexture("albedoSampler",r.baseTexture),c.setMatrix("albedoMatrix",r.baseTexture.getTextureMatrix())),null!==r.baseColor&&c.setColor3("albedoColor",r.baseColor)):"PBRSpecularGlossinessMaterial"===r.getClassName()?(null!==r.specularGlossinessTexture?(c.setTexture("reflectivitySampler",r.specularGlossinessTexture),c.setMatrix("reflectivityMatrix",r.specularGlossinessTexture.getTextureMatrix())):null!==r.specularColor&&c.setColor3("reflectivityColor",r.specularColor),null!==r.glossiness&&c.setFloat("glossiness",r.glossiness)):"PBRMaterial"===r.getClassName()?(null!==r.metallicTexture&&(c.setTexture("reflectivitySampler",r.metallicTexture),c.setMatrix("reflectivityMatrix",r.metallicTexture.getTextureMatrix())),null!==r.metallic&&c.setFloat("metallic",r.metallic),null!==r.roughness&&c.setFloat("glossiness",1-r.roughness),null!==r.roughness||null!==r.metallic||null!==r.metallicTexture?(null!==r.albedoTexture&&(c.setTexture("albedoSampler",r.albedoTexture),c.setMatrix("albedoMatrix",r.albedoTexture.getTextureMatrix())),null!==r.albedoColor&&c.setColor3("albedoColor",r.albedoColor)):(null!==r.reflectivityTexture?(c.setTexture("reflectivitySampler",r.reflectivityTexture),c.setMatrix("reflectivityMatrix",r.reflectivityTexture.getTextureMatrix())):null!==r.reflectivityColor&&c.setColor3("reflectivityColor",r.reflectivityColor),null!==r.microSurface&&c.setFloat("glossiness",r.microSurface))):"StandardMaterial"===r.getClassName()&&(null!==r.specularTexture&&(c.setTexture("reflectivitySampler",r.specularTexture),c.setMatrix("reflectivityMatrix",r.specularTexture.getTextureMatrix())),null!==r.specularColor&&c.setColor3("reflectivityColor",r.specularColor))),Fi(c,r,this._scene),t.useBones&&t.computeBonesUsingShaders&&t.skeleton){const e=t.skeleton;if(e.isUsingTextureForMatrices&&c.getUniformIndex("boneTextureWidth")>-1){const i=e.getTransformMatrixTexture(t);c.setTexture("boneSampler",i),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",t.skeleton.getTransformMatrices(t));this._enableVelocity&&c.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[t.uniqueId])}wi.BindMorphTargetParameters(t,c),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(c),this._enableVelocity&&(c.setMatrix("previousWorld",this._previousTransformationMatrices[i.uniqueId].world),c.setMatrix("previousViewProjection",this._previousTransformationMatrices[i.uniqueId].viewProjection)),a&&t.hasThinInstances&&c.setMatrix("world",l),t._processRendering(i,e,c,r.fillMode,o,a,((e,t)=>{e||c.setMatrix("world",t)}))}this._enableVelocity&&(this._previousTransformationMatrices[i.uniqueId].world=l.clone(),this._previousTransformationMatrices[i.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),t.skeleton&&this._copyBonesTransformationMatrices(t.skeleton.getTransformMatrices(t),this._previousBonesTransformationMatrices[i.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(t,i,s)=>{if((s||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){const s=t.subMeshes[i],n=s.getMaterial(),r=s.getRenderingMesh();if(!n)continue;const o=r._getInstancesRenderList(s._id,!!s.getReplacementMesh()),a=e.getCaps().instancedArrays&&(null!==o.visibleInstances[s._id]||r.hasThinInstances);if(!this.isReady(s,a))return!1}return!0},this._multiRenderTarget.customRenderFunction=(t,i,s,n)=>{let r;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(n.length){for(e.setColorWrite(!1),r=0;r<n.length;r++)d(n.data[r]);e.setColorWrite(!0)}for(r=0;r<t.length;r++)d(t.data[r]);for(e.setDepthWrite(!1),r=0;r<i.length;r++)d(i.data[r]);if(this.renderTransparentMeshes)for(r=0;r<s.length;r++)d(s.data[r]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}nd.DEPTH_TEXTURE_TYPE=0,nd.NORMAL_TEXTURE_TYPE=1,nd.POSITION_TEXTURE_TYPE=2,nd.VELOCITY_TEXTURE_TYPE=3,nd.REFLECTIVITY_TEXTURE_TYPE=4,nd._SceneComponentInitialization=e=>{throw f("GeometryBufferRendererSceneComponent")};class rd{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(Oi.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){e&&e.isSupported&&(this._geometryBufferRenderer=e)},enumerable:!0,configurable:!0}),Oi.prototype.enableGeometryBufferRenderer=function(e=1,t=15){return this._geometryBufferRenderer||(this._geometryBufferRenderer=new nd(this,e,t),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null)),this._geometryBufferRenderer},Oi.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class od{constructor(e){this.name=li.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(li.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}nd._SceneComponentInitialization=e=>{let t=e._getComponent(li.NAME_GEOMETRYBUFFERRENDERER);t||(t=new od(e),e._addComponent(t))};F.ShadersStore.motionBlurPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform float motionStrength;uniform float motionScale;uniform vec2 screenSize;\n#ifdef OBJECT_BASED\nuniform sampler2D velocitySampler;\n#else\nuniform sampler2D depthSampler;uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform mat4 projection;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#ifdef GEOMETRY_SUPPORTED\n#ifdef OBJECT_BASED\nvec2 texelSize=1.0/screenSize;vec4 velocityColor=texture2D(velocitySampler,vUV);velocityColor.rg=velocityColor.rg*2.0-vec2(1.0);vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=motionScale*motionStrength;float speed=length(velocity/texelSize);int samplesCount=int(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;float hlim=float(-samplesCount)*0.5+0.5;vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i)\n{if (i>=samplesCount)\nbreak;vec2 offset=vUV+velocity*(hlim+float(i));\n#if defined(WEBGPU)\nresult+=texture2DLodEXT(textureSampler,offset,0.0);\n#else\nresult+=texture2D(textureSampler,offset);\n#endif\n}\ngl_FragColor=result/float(samplesCount);gl_FragColor.a=1.0;\n#else\nvec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;depth=projection[2].z+projection[3].z/depth; \nvec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=inverseViewProjection*cpos;cpos/=cpos.w;vec4 ppos=prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i) {if (i>=nSamples)\nbreak;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);\n#if defined(WEBGPU)\nresult+=texture2DLodEXT(textureSampler,offset1,0.0);\n#else\nresult+=texture2D(textureSampler,offset1);\n#endif\n}\ngl_FragColor=result/float(nSamples);\n#endif\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";class ad extends es{get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,i,s,n,r,o,a=0,l=!1,h=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],i,s,n,r,o,"#define GEOMETRY_SUPPORTED\n#define SAMPLES 64.0\n#define OBJECT_BASED",a,void 0,null,l),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=h,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new rd)),this._applyMode()}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}const i=t.indexOf(e);-1!==i&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return p.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased),this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=Te.Identity(),this._previousViewProjection=this._scene.getTransformMatrix().clone(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new pe(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(nd.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){const t=Ee.Matrix[0];if(t.copyFrom(this._scene.getTransformMatrix()),t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(t),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setVector2("screenSize",new pe(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(nd.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[t])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){const e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join("\n"))}}static _Parse(e,t,i,s){return qe.Parse((()=>new ad(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1)),e,i,s)}}De([Ge()],ad.prototype,"motionStrength",void 0),De([Ge()],ad.prototype,"motionBlurSamples",null),De([Ge()],ad.prototype,"isObjectBased",null),ue("BABYLON.MotionBlurPostProcess",ad);F.ShadersStore.refractionPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D refractionSampler;uniform vec3 baseColor;uniform float depth;uniform float colorLevel;void main() {float ref=1.0-texture2D(refractionSampler,vUV).r;vec2 uv=vUV-vec2(0.5);vec2 offset=uv*depth*ref;vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);}";class ld extends es{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,s,n,r,o,a,l,h){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],r,o,a,l,h),this._ownRefractionTexture=!0,this.color=i,this.depth=s,this.colorLevel=n,this.refractionTextureUrl=t,this.onActivateObservable.add((e=>{this._refTexture=this._refTexture||new zi(t,e.getScene())})),this.onApplyObservable.add((e=>{e.setColor3("baseColor",this.color),e.setFloat("depth",this.depth),e.setFloat("colorLevel",this.colorLevel),e.setTexture("refractionSampler",this._refTexture)}))}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,s){return qe.Parse((()=>new ld(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable)),e,i,s)}}De([Ge()],ld.prototype,"color",void 0),De([Ge()],ld.prototype,"depth",void 0),De([Ge()],ld.prototype,"colorLevel",void 0),De([Ge()],ld.prototype,"refractionTextureUrl",void 0),ue("BABYLON.RefractionPostProcess",ld);F.ShadersStore.sharpenPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 sharpnessAmounts;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 color=texture2D(textureSampler,vUV);vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0)) +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1)) -\ncolor*4.0;gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);}";class hd extends es{getClassName(){return"SharpenPostProcess"}constructor(e,t,i,s,n,r,o=0,a=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,i,s,n,r,null,o,void 0,null,a),this.colorAmount=1,this.edgeAmount=.3,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}static _Parse(e,t,i,s){return qe.Parse((()=>new hd(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,s)}}De([Ge()],hd.prototype,"colorAmount",void 0),De([Ge()],hd.prototype,"edgeAmount",void 0),ue("BABYLON.SharpenPostProcess",hd);class cd{get name(){return this._name}get cameras(){return this._cameras}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const i=this._renderEffects[e];i&&i._enable(Ot.MakeArray(t||this._cameras))}_disableEffect(e,t){const i=this._renderEffects[e];i&&i._disable(Ot.MakeArray(t||this._cameras))}_attachCameras(e,t){const i=Ot.MakeArray(e||this._cameras);if(!i)return;const s=[];let n;for(n=0;n<i.length;n++){const e=i[n];e&&(-1===this._cameras.indexOf(e)?this._cameras.push(e):t&&s.push(n))}for(n=0;n<s.length;n++)i.splice(s[n],1);for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._attachCameras(i)}_detachCameras(e){const t=Ot.MakeArray(e||this._cameras);if(t){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._detachCameras(t);for(let e=0;e<t.length;e++)this._cameras.splice(this._cameras.indexOf(t[e]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}_adaptPostProcessesToViewPort(){const e=Object.keys(this._renderEffects);for(const t of e){const e=this._renderEffects[t].getPostProcesses();if(e)for(const t of e)t.adaptScaleToCurrentViewport=!0}}setPrePassRenderer(e){return!1}dispose(){}}De([Ge()],cd.prototype,"_name",void 0);class dd{constructor(){this._renderPipelines={}}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}removePipeline(e){delete this._renderPipelines[e]}attachCamerasToRenderPipeline(e,t,i=!1){const s=this._renderPipelines[e];s&&s._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){const i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];s&&s._enableEffect(t,i)}disableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];s&&s._disableEffect(t,i)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}Object.defineProperty(Oi.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let e=this._getComponent(li.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new ud(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new dd}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class ud{constructor(e){this.name=li.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(li.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class _d extends cd{get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new zc(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new $c(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let e=0;e<this._cameras.length;e++)t.disposeEffects(this._cameras[e]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new dc("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return null!=this._glowLayer}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,i=u.LastCreatedScene,n,r=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=jc.Low,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new s,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=n||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=r,this._scene=i;const o=this._scene.getEngine().getCaps();this._hdr=t&&(o.textureHalfFloatRender||o.textureFloatRender),this._hdr?o.textureHalfFloatRender?this._defaultPipelineTextureType=2:o.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);const a=this._scene.getEngine();this.sharpen=new hd("sharpen",1,null,zi.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new kc(a,this.SharpenPostProcessId,(()=>this.sharpen),!0),this.depthOfField=new $c(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=a.getHardwareScalingLevel(),this._resizeObserver=a.onResizeObservable.add((()=>{this._hardwareScaleLevel=a.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel})),this.bloom=new zc(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new Hc("ChromaticAberration",a.getRenderWidth(),a.getRenderHeight(),1,null,zi.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new kc(a,this.ChromaticAberrationPostProcessId,(()=>this.chromaticAberration),!0),this.grain=new ed("Grain",1,null,zi.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new kc(a,this.GrainPostProcessId,(()=>this.grain),!0);let l=!0;this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add((()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,l?Ot.SetImmediate((()=>{this._buildPipeline()})):this._buildPipeline())})),this._buildPipeline(),l=!1}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const e of this._cameras)this._scene.enableDepthRenderer(e).useOnlyInActiveCamera=!0;this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add((e=>{this._cameras.indexOf(e.activeCamera)>-1&&(this.depthOfField.depthTexture=e.enableDepthRenderer(e.activeCamera).getDepthMap())}))}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const e=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=e.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new td("imageProcessing",1,null,zi.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new kc(e,this.ImageProcessingPostProcessId,(()=>this.imageProcessing),!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._cameras&&0!==this._cameras.length||(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new Jc("fxaa",1,null,zi.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new kc(e,this.FxaaPostProcessId,(()=>this.fxaa),!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera))&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add((()=>{this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera)&&(this._scene.autoClear=!0)}))),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add((()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)}))),this._adaptPostProcessesToViewPort(),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&p.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene._postProcessRenderPipelineManager.removePipeline(this.name),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=qe.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return qe.Parse((()=>new _d(e._name,e._name._hdr,t)),e,t,i)}}De([Ge()],_d.prototype,"sharpenEnabled",null),De([Ge()],_d.prototype,"bloomKernel",null),De([Ge()],_d.prototype,"_bloomWeight",void 0),De([Ge()],_d.prototype,"_bloomThreshold",void 0),De([Ge()],_d.prototype,"_hdr",void 0),De([Ge()],_d.prototype,"bloomWeight",null),De([Ge()],_d.prototype,"bloomThreshold",null),De([Ge()],_d.prototype,"bloomScale",null),De([Ge()],_d.prototype,"bloomEnabled",null),De([Ge()],_d.prototype,"depthOfFieldEnabled",null),De([Ge()],_d.prototype,"depthOfFieldBlurLevel",null),De([Ge()],_d.prototype,"fxaaEnabled",null),De([Ge()],_d.prototype,"samples",null),De([Ge()],_d.prototype,"imageProcessingEnabled",null),De([Ge()],_d.prototype,"glowLayerEnabled",null),De([Ge()],_d.prototype,"chromaticAberrationEnabled",null),De([Ge()],_d.prototype,"grainEnabled",null),ue("BABYLON.DefaultRenderingPipeline",_d);F.ShadersStore.lensHighlightsPixelShader="uniform sampler2D textureSampler; \nuniform float gain;uniform float threshold;uniform float screen_width;uniform float screen_height;varying vec2 vUV;vec4 highlightColor(vec4 color) {vec4 highlight=color;float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));float lum_threshold;if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);highlight*=luminance*gain;highlight.a=1.0;return highlight;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{vec4 original=texture2D(textureSampler,vUV);if (gain==-1.0) {gl_FragColor=vec4(0.0,0.0,0.0,1.0);return;}\nfloat w=2.0/screen_width;float h=2.0/screen_height;float weight=1.0;vec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;gl_FragColor=blurred;}";F.ShadersStore.depthOfFieldPixelShader="uniform sampler2D textureSampler;uniform sampler2D highlightsSampler;uniform sampler2D depthSampler;uniform sampler2D grainSampler;uniform float grain_amount;uniform bool blur_noise;uniform float screen_width;uniform float screen_height;uniform float distortion;uniform bool dof_enabled;uniform float screen_distance; \nuniform float aperture;uniform float darken;uniform float edge_blur;uniform bool highlights;uniform float near;uniform float far;varying vec2 vUV;\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \nvec2 centered_screen_pos;vec2 distorted_coords;float radius2;float radius;vec2 rand(vec2 co)\n{float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));return clamp(vec2(noise1,noise2),0.0,1.0);}\nvec2 getDistortedCoords(vec2 coords) {if (distortion==0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);vec2 dist_coords=vec2(0.5,0.5);dist_coords.x=0.5+direction.x*radius2*1.0;dist_coords.y=0.5+direction.y*radius2*1.0;float dist_amount=clamp(distortion*0.23,0.0,1.0);dist_coords=mix(coords,dist_coords,dist_amount);return dist_coords;}\nfloat sampleScreen(inout vec4 color,in vec2 offset,in float weight) {vec2 coords=distorted_coords;float angle=rand(coords*100.0).x*TWOPI;coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));color+=texture2D(textureSampler,coords)*weight;return weight;}\nfloat getBlurLevel(float size) {return min(3.0,ceil(size/1.0));}\nvec4 getBlurColor(float size) {vec4 col=texture2D(textureSampler,distorted_coords);float blur_level=getBlurLevel(size);float w=(size/screen_width);float h=(size/screen_height);float total_weight=1.0;vec2 sample_coords;total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);if (blur_level>1.0) {total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);}\nif (blur_level>2.0) {total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);}\ncol/=total_weight; \nif (darken>0.0) {col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);}\nreturn col;}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;radius=sqrt(radius2);distorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));if (dof_enabled==false || coc<0.07) { coc=0.0; }\nfloat edge_blur_amount=0.0;if (edge_blur>0.0) {edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;}\nfloat blur_amount=max(edge_blur_amount,coc);if (blur_amount==0.0) {gl_FragColor=texture2D(textureSampler,distorted_coords);}\nelse {gl_FragColor=getBlurColor(blur_amount*1.7);if (highlights) {gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;}\nif (blur_noise) {vec2 noise=rand(distorted_coords)*0.01*blur_amount;vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;}}\nif (grain_amount>0.0) {vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;}}\n";class fd{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}F.ShadersStore.ssao2PixelShader="precision highp float;uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nfloat scales[16]=float[16](\n0.1,\n0.11406250000000001,\n0.131640625,\n0.15625,\n0.187890625,\n0.2265625,\n0.272265625,\n0.325,\n0.384765625,\n0.4515625,\n0.525390625,\n0.60625,\n0.694140625,\n0.7890625,\n0.891015625,\n1.0\n);uniform float near;uniform float radius;uniform sampler2D depthSampler;uniform sampler2D randomSampler;uniform sampler2D normalSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float base;uniform float xViewport;uniform float yViewport;uniform mat3 depthProjection;uniform float maxZ;uniform float minZAspect;uniform vec2 texelSize;uniform mat4 projection;void main()\n{vec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;float depth=textureLod(depthSampler,vUV,0.0).r;float depthSign=depth/abs(depth);depth=depth*depthSign;vec3 normal=textureLod(normalSampler,vUV,0.0).rgb;float occlusion=0.0;float correctedRadius=min(radius,minZAspect*depth/near);vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);vec3 origin=vViewRay*vDepthFactor;vec3 rvec=random*2.0-1.0;rvec.z=0.0;float dotProduct=dot(rvec,normal);rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);vec3 tangent=normalize(rvec-normal*dot(rvec,normal));vec3 bitangent=cross(normal,tangent);mat3 tbn=mat3(tangent,bitangent,normal);float difference;for (int i=0; i<SAMPLES; ++i) {vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;vec4 offset=vec4(samplePosition,1.0);offset=projection*offset;offset.xyz/=offset.w;offset.xy=offset.xy*0.5+0.5;if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}\nfloat sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}\nocclusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor=vec4(vec3(result),1.0);}\n#endif\n#ifdef BLUR\nuniform float outSize;uniform float soften;uniform float tolerance;uniform int samples;\n#ifndef BLUR_BYPASS\nuniform sampler2D depthSampler;\n#ifdef BLUR_LEGACY\n#define inline\nfloat blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {float result=0.0;vec2 off1=vec2(1.411764705882353)*step;vec2 off2=vec2(3.2941176470588234)*step;vec2 off3=vec2(5.176470588235294)*step;float compareDepth=abs(textureLod(depthSampler,uv,0.0).r);float sampleDepth;float weight;float weightSum=30.0;result+=textureLod(image,uv,0.0).r*30.0;sampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv+off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv-off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off3,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off3,0.0).r*weight;return result/weightSum;}\n#endif\n#endif\nvoid main()\n{float result=0.0;\n#ifdef BLUR_BYPASS\nresult=textureLod(textureSampler,vUV,0.0).r;\n#else\n#ifdef BLUR_H\nvec2 step=vec2(1.0/outSize,0.0);\n#else\nvec2 step=vec2(0.0,1.0/outSize);\n#endif\n#ifdef BLUR_LEGACY\nresult=blur13Bilateral(textureSampler,vUV,step);\n#else\nfloat compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);float weightSum=0.0;for (int i=-samples; i<samples; i+=2)\n{vec2 samplePos=vUV+step*(float(i)+0.5);float sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);float falloff=smoothstep(0.0,\nfloat(samples),\nfloat(samples)-abs(float(i))*soften);float minDivider=tolerance*0.5+0.003;float weight=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureLod(textureSampler,samplePos,0.0).r*weight;weightSum+=weight;}\nresult/=weightSum;\n#endif\n#endif\ngl_FragColor.rgb=vec3(result);gl_FragColor.a=1.0;}\n#endif\n";F.ShadersStore.ssaoCombinePixelShader="uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);vec4 sceneColor=texture2D(originalColor,vUV);gl_FragColor=sceneColor*ssaoColor;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";class pd extends cd{set epsilon(e){this._epsilon=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set bypassBlur(e){const t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this._blurHPostProcess.updateEffect(t.h,null,i),this._blurVPostProcess.updateEffect(t.v,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){const t=this._getDefinesForBlur(e,this._bypassBlur);this._blurHPostProcess.updateEffect(t.h),this._blurVPostProcess.updateEffect(t.v),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=u.LastCreatedEngine;return!!e&&e._features.supportSSAO2}get scene(){return this._scene}constructor(e,t,i,s,n=!1,r=0){var o,a;if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._epsilon=.02,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this.radius=2,this.base=0,this._bypassBlur=!1,this._expensiveBlur=!0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._textureType=r,this._forceGeometryBuffer=n,!this.isSupported)return void p.Error("The current engine does not support SSAO 2.");const l=this._ratio.ssaoRatio||i,h=this._ratio.blurRatio||i;this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),(null===(o=t.geometryBufferRenderer)||void 0===o?void 0:o.generateNormalsInWorldSpace)&&p.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!")):(t.enablePrePassRenderer(),(null===(a=t.prePassRenderer)||void 0===a?void 0:a.generateNormalsInWorldSpace)&&p.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!")),this._createRandomTexture(),this._originalColorPostProcess=new Hs("SSAOOriginalSceneColor",1,null,zi.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,r),this._createBlurPostProcess(l,h,this._textureType),this._createSSAOCombinePostProcess(h,this._textureType),this.addEffect(new kc(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new kc(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new kc(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new kc(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new kc(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_rebuild(){super._rebuild()}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i="#define BLUR\n";return t&&(i+="#define BLUR_BYPASS\n"),e||(i+="#define BLUR_LEGACY\n"),{h:i+"#define BLUR_H\n",v:i}}_createBlurPostProcess(e,t,i){const s=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),n=this._getSamplersForBlur(this.bypassBlur);this._blurHPostProcess=this._createBlurFilter("BlurH",n,e,s.h,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",n,t,s.v,i,!1)}_createBlurFilter(e,t,i,s,n,r){const o=new es(e,"ssao2",["outSize","samples","soften","tolerance"],t,i,null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s,n);return o.onApply=e=>{if(!this._scene.activeCamera)return;const t=r?this._ssaoCombinePostProcess.width:this._ssaoCombinePostProcess.height,i=r?this._originalColorPostProcess.width:this._originalColorPostProcess.height;e.setFloat("outSize",t>0?t:i),e.setInt("samples",this.bilateralSamples),e.setFloat("soften",this.bilateralSoften),e.setFloat("tolerance",this.bilateralTolerance),this._geometryBufferRenderer?e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},o.samples=this.textureSamples,o}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,2.3283064365386963e-10*this._bits[0]}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const i=2*t*Math.PI,s=1-.85*e,n=Math.sqrt(1-s*s);return new me(Math.cos(i)*n,Math.sin(i)*n,s)}_generateHemisphere(){const e=this.samples,t=[];let i,s=0;for(;s<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{const t=this._hammersley(s,e);i=this._hemisphereSample_uniform(t[0],t[1])}t.push(i.x,i.y,i.z),s++}return t}_getDefinesForSSAO(){return`#define SSAO\n#define SAMPLES ${this.samples}\n#define EPSILON ${this.epsilon.toFixed(4)}`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const i=this._getDefinesForSSAO();this._ssaoPostProcess=new es("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],["randomSampler","depthSampler","normalSampler"],e,null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i,t),this._ssaoPostProcess.onApply=e=>{var t,i,s,n;if(this._scene.activeCamera){if(e.setArray3("sampleSphere",this._sampleSphere),e.setFloat("randTextureTiles",32),e.setFloat("samplesFactor",1/this.samples),e.setFloat("totalStrength",this.totalStrength),e.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),e.setFloat("radius",this.radius),e.setFloat("maxZ",this.maxZ),e.setFloat("minZAspect",this.minZAspect),e.setFloat("base",this.base),e.setFloat("near",this._scene.activeCamera.minZ),this._scene.activeCamera.mode===Gt.PERSPECTIVE_CAMERA)e.setMatrix3x3("depthProjection",pd.PERSPECTIVE_DEPTH_PROJECTION),e.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),e.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const r=this._scene.getEngine().getRenderWidth()/2,o=this._scene.getEngine().getRenderHeight()/2,a=null!==(t=this._scene.activeCamera.orthoLeft)&&void 0!==t?t:-r,l=null!==(i=this._scene.activeCamera.orthoRight)&&void 0!==i?i:r,h=null!==(s=this._scene.activeCamera.orthoBottom)&&void 0!==s?s:-o,c=null!==(n=this._scene.activeCamera.orthoTop)&&void 0!==n?n:o;e.setMatrix3x3("depthProjection",pd.ORTHO_DEPTH_PROJECTION),e.setFloat("xViewport",.5*(l-a)),e.setFloat("yViewport",.5*(c-h))}e.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),e.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),e.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new fd)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new es("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t),this._ssaoCombinePostProcess.onApply=e=>{const t=this._scene.activeCamera.viewport;e.setVector4("viewport",Ee.Vector4[0].copyFromFloats(t.x,t.y,t.width,t.height)),e.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){const e=new Uint8Array(65536),t=pe.Zero();for(let i=0;i<e.length;)t.set(ne.RandomRange(0,1),ne.RandomRange(0,1)).normalize().scaleInPlace(255),e[i++]=Math.floor(t.x),e[i++]=Math.floor(t.y),e[i++]=0,e[i++]=255;const i=yh.CreateRGBATexture(e,128,128,this._scene,!1,!1,2);i.name="SSAORandomTexture",i.wrapU=zi.WRAP_ADDRESSMODE,i.wrapV=zi.WRAP_ADDRESSMODE,this._randomTexture=i}serialize(){const e=qe.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return qe.Parse((()=>new pd(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType)),e,t,i)}}pd.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],pd.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],De([Ge()],pd.prototype,"totalStrength",void 0),De([Ge()],pd.prototype,"maxZ",void 0),De([Ge()],pd.prototype,"minZAspect",void 0),De([Ge("epsilon")],pd.prototype,"_epsilon",void 0),De([Ge("samples")],pd.prototype,"_samples",void 0),De([Ge("textureSamples")],pd.prototype,"_textureSamples",void 0),De([Ge()],pd.prototype,"_forceGeometryBuffer",void 0),De([Ge()],pd.prototype,"_ratio",void 0),De([Ge()],pd.prototype,"_textureType",void 0),De([Ge()],pd.prototype,"radius",void 0),De([Ge()],pd.prototype,"base",void 0),De([Ge("bypassBlur")],pd.prototype,"_bypassBlur",void 0),De([Ge("expensiveBlur")],pd.prototype,"_expensiveBlur",void 0),De([Ge()],pd.prototype,"bilateralSamples",void 0),De([Ge()],pd.prototype,"bilateralSoften",void 0),De([Ge()],pd.prototype,"bilateralTolerance",void 0),ue("BABYLON.SSAO2RenderingPipeline",pd);F.ShadersStore.ssaoPixelShader="uniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float radius;uniform float area;uniform float fallOff;uniform float base;vec3 normalFromDepth(float depth,vec2 coords)\n{vec2 offset1=vec2(0.0,radius);vec2 offset2=vec2(radius,0.0);float depth1=texture2D(textureSampler,coords+offset1).r;float depth2=texture2D(textureSampler,coords+offset2).r;vec3 p1=vec3(offset1,depth1-depth);vec3 p2=vec3(offset2,depth2-depth);vec3 normal=cross(p1,p2);normal.z=-normal.z;return normalize(normal);}\nvoid main()\n{vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);float depth=texture2D(textureSampler,vUV).r;vec3 position=vec3(vUV,depth);vec3 normal=normalFromDepth(depth,vUV);float radiusDepth=radius/depth;float occlusion=0.0;vec3 ray;vec3 hemiRay;float occlusionDepth;float difference;for (int i=0; i<SAMPLES; i++)\n{ray=radiusDepth*reflect(sampleSphere[i],random);hemiRay=position+sign(dot(ray,normal))*ray;occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;difference=depth-occlusionDepth;occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor.r=result;gl_FragColor.g=result;gl_FragColor.b=result;gl_FragColor.a=1.0;}\n#endif\n";class md extends cd{get scene(){return this._scene}constructor(e,t,i,s){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const n=i.ssaoRatio||i,r=i.combineRatio||i;this._originalColorPostProcess=new Hs("SSAOOriginalSceneColor",r,null,zi.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(n),this._createBlurPostProcess(n),this._createSSAOCombinePostProcess(r),this.addEffect(new kc(t.getEngine(),this.SSAOOriginalSceneColorEffect,(()=>this._originalColorPostProcess),!0)),this.addEffect(new kc(t.getEngine(),this.SSAORenderEffect,(()=>this._ssaoPostProcess),!0)),this.addEffect(new kc(t.getEngine(),this.SSAOBlurHRenderEffect,(()=>this._blurHPostProcess),!0)),this.addEffect(new kc(t.getEngine(),this.SSAOBlurVRenderEffect,(()=>this._blurVPostProcess),!0)),this.addEffect(new kc(t.getEngine(),this.SSAOCombineRenderEffect,(()=>this._ssaoCombinePostProcess),!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}_attachCameras(e,t){super._attachCameras(e,t);for(const e of this._cameras)this._scene.enableDepthRenderer(e).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){const t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new ts("BlurH",new pe(1,0),16,e,null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new ts("BlurV",new pe(0,1),16,e,null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add((()=>{const e=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*e})),this._blurVPostProcess.onActivateObservable.add((()=>{const e=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*e}))}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const t=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new es("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=e=>{this._firstUpdate&&(e.setArray3("sampleSphere",t),e.setFloat("samplesFactor",.0625),e.setFloat("randTextureTiles",4)),e.setFloat("totalStrength",this.totalStrength),e.setFloat("radius",this.radius),e.setFloat("area",this.area),e.setFloat("fallOff",this.fallOff),e.setFloat("base",this.base),e.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),e.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new es("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,zi.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=e=>{e.setVector4("viewport",Ee.Vector4[0].copyFromFloats(0,0,1,1)),e.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){const e=new Uint8Array(1048576);for(let t=0;t<e.length;)e[t++]=Math.floor(255*Math.max(0,ne.RandomRange(-1,1))),e[t++]=Math.floor(255*Math.max(0,ne.RandomRange(-1,1))),e[t++]=Math.floor(255*Math.max(0,ne.RandomRange(-1,1))),e[t++]=255;const t=yh.CreateRGBATexture(e,512,512,this._scene,!1,!1,2);t.name="SSAORandomTexture",t.wrapU=zi.WRAP_ADDRESSMODE,t.wrapV=zi.WRAP_ADDRESSMODE,this._randomTexture=t}}De([Ge()],md.prototype,"totalStrength",void 0),De([Ge()],md.prototype,"radius",void 0),De([Ge()],md.prototype,"area",void 0),De([Ge()],md.prototype,"fallOff",void 0),De([Ge()],md.prototype,"base",void 0);class gd{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}F.ShadersStore.screenSpaceReflectionPixelShader="uniform sampler2D textureSampler;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;\n#endif\nuniform mat4 view;uniform mat4 projection;uniform float stepSize;uniform float strength;uniform float threshold;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;varying vec2 vUV;\n#ifdef SSR_SUPPORTED\nstruct ReflectionInfo {vec3 color;vec4 coords;};/**\n* According to specular,see https:\n*/\nvec3 fresnelSchlick(float cosTheta,vec3 F0)\n{return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);}\n/**\n* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit\n* by sampling multiple reflection pixels.\n*/\nReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)\n{ReflectionInfo info;info.color=vec3(0.0);vec4 projectedCoord;float sampledDepth;for(int i=0; i<SMOOTH_STEPS; i++)\n{projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;dir*=0.5;if(depth>0.0)\nhitCoord-=dir;else\nhitCoord+=dir;info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;}\nprojectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;info.color/=float(SMOOTH_STEPS+1);return info;}\n/**\n* Tests the given world position (hitCoord) according to the given reflection vector (dir)\n* until it finds a collision (means that depth is enough close to say \"it's the pixel to sample!\").\n*/\nReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)\n{ReflectionInfo info;vec4 projectedCoord;float sampledDepth;dir*=stepSize;for(int i=0; i<REFLECTION_SAMPLES; i++)\n{hitCoord+=dir;projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;\n#ifdef RIGHT_HANDED_SCENE\ndepth*=-1.0;\n#endif\nif(((depth-dir.z)<threshold) && depth<=0.0)\n{\n#ifdef ENABLE_SMOOTH_REFLECTIONS\nreturn smoothReflectionInfo(dir,hitCoord);\n#else\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;\n#endif\n}}\ninfo.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;}\nvec3 hash(vec3 a)\n{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 albedoFull=texture2D(textureSampler,vUV);vec3 albedo=albedoFull.rgb;float spec=texture2D(reflectivitySampler,vUV).r;if (spec==0.0) {gl_FragColor=albedoFull;return;}\nvec3 normal=(texture2D(normalSampler,vUV)).xyz;vec3 position=(view*texture2D(positionSampler,vUV)).xyz;vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));float roughness=1.0-texture2D(reflectivitySampler,vUV).a;vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;ReflectionInfo info=getReflectionInfo(jitt+reflected,position);vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);vec3 F0=vec3(0.04);F0 =mix(F0,albedo,spec);vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);\n#ifdef RIGHT_HANDED_SCENE\nreflected.z*=-1.0;\n#endif\nfloat reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);float albedoMultiplier=1.0-reflectionMultiplier;vec3 SSR=info.color*fresnel;gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);\n#else\ngl_FragColor=texture2D(textureSampler,vUV);\n#endif\n}\n";class vd extends es{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,i,s,n,r,o,a=0,l=!1,h=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,s,n,r,o,"#define SSR_SUPPORTED\n#define REFLECTION_SAMPLES 64\n#define SMOOTH_STEPS 5\n",a,void 0,null,l),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=h,this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&e.isSupported&&(e.enablePosition=!0,e.enableReflectivity=!0,e.generateNormalsInWorldSpace&&p.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"))}else{const e=t.enablePrePassRenderer();null==e||e.markAsDirty(),(null==e?void 0:e.generateNormalsInWorldSpace)&&p.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the prepass renderer!"),this._prePassEffectConfiguration=new gd}this._updateEffectDefines(),this.onApply=e=>{const i=this._geometryBufferRenderer,s=this._prePassRenderer;if(!s&&!i)return;if(i){const t=i.getTextureIndex(nd.POSITION_TEXTURE_TYPE),s=i.getTextureIndex(nd.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",i.getGBuffer().textures[1]),e.setTexture("positionSampler",i.getGBuffer().textures[t]),e.setTexture("reflectivitySampler",i.getGBuffer().textures[s])}else if(s){const t=s.getIndex(1),i=s.getIndex(3),n=s.getIndex(6);e.setTexture("normalSampler",s.getRenderTarget().textures[n]),e.setTexture("positionSampler",s.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",s.getRenderTarget().textures[i])}const n=t.activeCamera;if(!n)return;const r=n.getViewMatrix(!0),o=n.getProjectionMatrix(!0);e.setMatrix("projection",o),e.setMatrix("view",r),e.setFloat("threshold",this.threshold),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),e.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(e.join("\n"))}static _Parse(e,t,i,s){return qe.Parse((()=>new vd(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,s)}}De([Ge()],vd.prototype,"threshold",void 0),De([Ge()],vd.prototype,"strength",void 0),De([Ge()],vd.prototype,"reflectionSpecularFalloffExponent",void 0),De([Ge()],vd.prototype,"step",void 0),De([Ge()],vd.prototype,"roughnessFactor",void 0),De([Ge()],vd.prototype,"enableSmoothReflections",null),De([Ge()],vd.prototype,"reflectionSamples",null),De([Ge()],vd.prototype,"smoothSteps",null),ue("BABYLON.ScreenSpaceReflectionPostProcess",vd);F.ShadersStore.standardPixelShader="uniform sampler2D textureSampler;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{vec4 color=texture2D(textureSampler,vUV);gl_FragColor=color;}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];void main(void)\n{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+dsOffsets[0]);average+=texture2D(textureSampler,vUV+dsOffsets[1]);average+=texture2D(textureSampler,vUV+dsOffsets[2]);average+=texture2D(textureSampler,vUV+dsOffsets[3]);average+=texture2D(textureSampler,vUV+dsOffsets[4]);average+=texture2D(textureSampler,vUV+dsOffsets[5]);average+=texture2D(textureSampler,vUV+dsOffsets[6]);average+=texture2D(textureSampler,vUV+dsOffsets[7]);average+=texture2D(textureSampler,vUV+dsOffsets[8]);average+=texture2D(textureSampler,vUV+dsOffsets[9]);average+=texture2D(textureSampler,vUV+dsOffsets[10]);average+=texture2D(textureSampler,vUV+dsOffsets[11]);average+=texture2D(textureSampler,vUV+dsOffsets[12]);average+=texture2D(textureSampler,vUV+dsOffsets[13]);average+=texture2D(textureSampler,vUV+dsOffsets[14]);average+=texture2D(textureSampler,vUV+dsOffsets[15]);average/=16.0;gl_FragColor=average;}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];uniform float brightThreshold;void main(void)\n{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));average*=0.25;float luminance=length(average.rgb);if (luminance<brightThreshold) {average=vec4(0.0,0.0,0.0,1.0);}\ngl_FragColor=average;}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;uniform sampler2D lensSampler;uniform float exposure;void main(void)\n{vec3 colour=texture2D(textureSampler,vUV).rgb;colour*=exposure;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;colour+=colour*texture2D(lensSampler,vUV).rgb;vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);gl_FragColor=finalColor;}\n#endif\n#if defined(VLS)\n#define PI 3.1415926535897932384626433832795\nuniform mat4 shadowViewProjection;uniform mat4 lightWorld;uniform vec3 cameraPosition;uniform vec3 sunDirection;uniform vec3 sunColor;uniform vec2 depthValues;uniform float scatteringCoefficient;uniform float scatteringPower;uniform sampler2D shadowMapSampler;uniform sampler2D positionSampler;float computeScattering(float lightDotView)\n{float result=1.0-scatteringCoefficient*scatteringCoefficient;result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));return result;}\nvoid main(void)\n{vec3 worldPos=texture2D(positionSampler,vUV).rgb;vec3 startPosition=cameraPosition;vec3 rayVector=worldPos-startPosition;float rayLength=length(rayVector);vec3 rayDirection=rayVector/rayLength;float stepLength=rayLength/NB_STEPS;vec3 stepL=rayDirection*stepLength;vec3 currentPosition=startPosition;vec3 accumFog=vec3(0.0);for (int i=0; i<int(NB_STEPS); i++)\n{vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depthMetric,0.0,1.0);worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;if (shadowMapValue>shadowPixelDepth)\naccumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));currentPosition+=stepL;}\naccumFog/=NB_STEPS;vec3 color=accumFog*scatteringPower;gl_FragColor=vec4(color*exp(color) ,1.0);}\n#endif\n#if defined(VLSMERGE)\nuniform sampler2D originalSampler;void main(void)\n{gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);}\n#endif\n#if defined(LUMINANCE)\nuniform vec2 lumOffsets[4];void main()\n{float average=0.0;vec4 color=vec4(0.0);float maximum=-1e20;vec3 weight=vec3(0.299,0.587,0.114);for (int i=0; i<4; i++)\n{color=texture2D(textureSampler,vUV+ lumOffsets[i]);float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));\n#ifdef WEIGHTED_AVERAGE\nfloat GreyValue=dot(color.rgb,weight);\n#endif\n#ifdef BRIGHTNESS\nfloat GreyValue=max(color.r,max(color.g,color.b));\n#endif\n#ifdef HSL_COMPONENT\nfloat GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));\n#endif\n#ifdef MAGNITUDE\nfloat GreyValue=length(color.rgb);\n#endif\nmaximum=max(maximum,GreyValue);average+=(0.25*log(1e-5+GreyValue));}\naverage=exp(average);gl_FragColor=vec4(average,maximum,0.0,1.0);}\n#endif\n#if defined(LUMINANCE_DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];uniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLER\n#include<packingFunctions>\n#endif\nvoid main()\n{vec4 color=vec4(0.0);float average=0.0;for (int i=0; i<9; i++)\n{color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);average+=color.r;}\naverage/=9.0;\n#ifdef FINAL_DOWN_SAMPLER\ngl_FragColor=pack(average);\n#else\ngl_FragColor=vec4(average,average,0.0,1.0);\n#endif\n}\n#endif\n#if defined(HDR)\nuniform sampler2D textureAdderSampler;uniform float averageLuminance;void main()\n{vec4 color=texture2D(textureAdderSampler,vUV);\n#ifndef AUTO_EXPOSURE\nvec4 adjustedColor=color/averageLuminance;color=adjustedColor;color.a=1.0;\n#endif\ngl_FragColor=color;}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;uniform float strength;uniform float ghostDispersal;uniform float haloWidth;uniform vec2 resolution;uniform float distortionStrength;float hash(vec2 p)\n{float h=dot(p,vec2(127.1,311.7));return -1.0+2.0*fract(sin(h)*43758.5453123);}\nfloat noise(in vec2 p)\n{vec2 i=floor(p);vec2 f=fract(p);vec2 u=f*f*(3.0-2.0*f);return mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);}\nfloat fbm(vec2 p)\n{float f=0.0;f+=0.5000*noise(p); p*=2.02;f+=0.2500*noise(p); p*=2.03;f+=0.1250*noise(p); p*=2.01;f+=0.0625*noise(p); p*=2.04;f/=0.9375;return f;}\nvec3 pattern(vec2 uv)\n{vec2 p=-1.0+2.0*uv;float p2=dot(p,p);float f=fbm(vec2(15.0*p2))/2.0;float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));return (1.0-f)*vec3(r,g,b);}\nfloat luminance(vec3 color)\n{return dot(color.rgb,vec3(0.2126,0.7152,0.0722));}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{return vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);}\nvoid main(void)\n{vec2 uv=-vUV+vec2(1.0);vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;vec2 texelSize=1.0/resolution;vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);vec4 result=vec4(0.0);float ghostIndice=1.0;for (int i=0; i<GHOSTS; ++i)\n{vec2 offset=fract(uv+ghostDir*ghostIndice);float weight=length(vec2(0.5)-offset)/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;ghostIndice+=1.0;}\nvec2 haloVec=normalize(ghostDir)*haloWidth;float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));gl_FragColor=result;}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;uniform sampler2D lensDirtSampler;uniform sampler2D lensStarSampler;uniform mat4 lensStarMatrix;void main(void)\n{vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;vec4 lensMod=texture2D(lensDirtSampler,vUV);lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);vec4 result=texture2D(textureSampler,vUV)*lensMod;gl_FragColor=texture2D(otherSampler,vUV)+result;}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;uniform sampler2D depthSampler;uniform float distance;void main(void)\n{vec4 sharp=texture2D(otherSampler,vUV);vec4 blur=texture2D(textureSampler,vUV);float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);float factor=0.0;if (dist<0.05)\nfactor=1.0;else if (dist<0.1)\nfactor=20.0*(0.1-dist);else if (dist<0.5)\nfactor=0.0;else\nfactor=2.0*(dist-0.5);factor=clamp(factor,0.0,0.90);gl_FragColor=mix(sharp,blur,factor);}\n#endif\n#if defined(MOTION_BLUR)\nuniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform vec2 screenSize;uniform float motionScale;uniform float motionStrength;uniform sampler2D depthSampler;void main(void)\n{vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=cpos*inverseViewProjection;vec4 ppos=cpos*prevViewProjection;ppos.xyz/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {if (i>=nSamples)\nbreak;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);result+=texture2D(textureSampler,offset1);}\ngl_FragColor=result/float(nSamples);}\n#endif\n";class Td extends cd{get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join("\n"))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer())return void p.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,s=null,n){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=n||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=s,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new vd("HDRPass",t,e,null,zi.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess})),this.addEffect(new kc(t.getEngine(),"HDRScreenSpaceReflections",(()=>this.screenSpaceReflectionPostProcess),!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new es("HDRPass","standard",[],[],e,null,zi.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add((()=>{this._currentDepthOfFieldSource=this.originalPostProcess})),this.addEffect(new kc(t.getEngine(),"HDRPassPostProcess",(()=>this.originalPostProcess),!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new es("HDRDepthOfFieldSource","standard",[],[],e,null,zi.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new kc(t.getEngine(),"HDRBaseDepthOfFieldSource",(()=>this.textureAdderFinalPostProcess),!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new es("HDRVLSFinal","standard",[],[],e,null,zi.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new kc(t.getEngine(),"HDRVLSFinal",(()=>this.volumetricLightFinalPostProcess),!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new es("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,zi.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new kc(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",(()=>this.lensFlareFinalPostProcess),!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new es("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,zi.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new kc(t.getEngine(),"HDRPostHDReDepthOfFieldSource",(()=>this.hdrFinalPostProcess),!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new Jc("fxaa",1,null,zi.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new kc(t.getEngine(),"HDRFxaa",(()=>this.fxaaPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&p.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const i=new Array(32);this.downSampleX4PostProcess=new es("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=e=>{let t=0;const s=this.downSampleX4PostProcess.width,n=this.downSampleX4PostProcess.height;for(let e=-2;e<2;e++)for(let r=-2;r<2;r++)i[t]=(e+.5)*(1/s),i[t+1]=(r+.5)*(1/n),t+=2;e.setArray2("dsOffsets",i)},this.addEffect(new kc(e.getEngine(),"HDRDownSampleX4",(()=>this.downSampleX4PostProcess),!0))}_createBrightPassPostProcess(e,t){const i=new Array(8);this.brightPassPostProcess=new es("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=e=>{const t=1/this.brightPassPostProcess.width,s=1/this.brightPassPostProcess.height;i[0]=-.5*t,i[1]=.5*s,i[2]=.5*t,i[3]=.5*s,i[4]=-.5*t,i[5]=-.5*s,i[6]=.5*t,i[7]=-.5*s,e.setArray2("dsOffsets",i),e.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new kc(e.getEngine(),"HDRBrightPass",(()=>this.brightPassPostProcess),!0))}_createBlurPostProcesses(e,t,i,s="blurWidth"){const n=e.getEngine(),r=new ts("HDRBlurH_"+i,new pe(1,0),this[s],t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),o=new ts("HDRBlurV_"+i,new pe(0,1),this[s],t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);r.onActivateObservable.add((()=>{const e=r.width/n.getRenderWidth();r.kernel=this[s]*e})),o.onActivateObservable.add((()=>{const e=o.height/n.getRenderHeight();o.kernel=this.horizontalBlur?64*e:this[s]*e})),this.addEffect(new kc(e.getEngine(),"HDRBlurH"+i,(()=>r),!0)),this.addEffect(new kc(e.getEngine(),"HDRBlurV"+i,(()=>o),!0)),this.blurHPostProcesses.push(r),this.blurVPostProcesses.push(o)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new es("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),e.setTexture("lensSampler",this.lensTexture),e.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new kc(e.getEngine(),"HDRTextureAdder",(()=>this.textureAdderPostProcess),!0))}_createVolumetricLightPostProcess(e,t){const i=e.enableGeometryBufferRenderer();i.enablePosition=!0;const s=i.getGBuffer();this.volumetricLightPostProcess=new es("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));const n=pe.Zero();this.volumetricLightPostProcess.onApply=e=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const t=this.sourceLight.getShadowGenerator();e.setTexture("shadowMapSampler",t.getShadowMap()),e.setTexture("positionSampler",s.textures[2]),e.setColor3("sunColor",this.sourceLight.diffuse),e.setVector3("sunDirection",this.sourceLight.getShadowDirection()),e.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),e.setMatrix("shadowViewProjection",t.getTransformMatrix()),e.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),e.setFloat("scatteringPower",this.volumetricLightPower),n.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),n.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),e.setVector2("depthValues",n)}},this.addEffect(new kc(e.getEngine(),"HDRVLS",(()=>this.volumetricLightPostProcess),!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new es("HDRVLSMerge","standard",[],["originalSampler"],t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=e=>{e.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new kc(e.getEngine(),"HDRVLSMerge",(()=>this.volumetricLightMergePostProces),!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,Td.LuminanceSteps);this.luminancePostProcess=new es("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const s=[];this.luminancePostProcess.onApply=e=>{const t=1/this.luminancePostProcess.width,i=1/this.luminancePostProcess.height;s[0]=-.5*t,s[1]=.5*i,s[2]=.5*t,s[3]=.5*i,s[4]=-.5*t,s[5]=-.5*i,s[6]=.5*t,s[7]=-.5*i,e.setArray2("lumOffsets",s)},this.addEffect(new kc(e.getEngine(),"HDRLuminance",(()=>this.luminancePostProcess),!0));for(let s=Td.LuminanceSteps-1;s>=0;s--){i=Math.pow(3,s);let n="#define LUMINANCE_DOWN_SAMPLE\n";0===s&&(n+="#define FINAL_DOWN_SAMPLER");const r=new es("HDRLuminanceDownSample"+s,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,t);this.luminanceDownSamplePostProcesses.push(r)}let n=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach(((t,i)=>{const s=new Array(18);t.onApply=e=>{if(!n)return;let r=0;for(let e=-1;e<2;e++)for(let t=-1;t<2;t++)s[r]=e/n.width,s[r+1]=t/n.height,r+=2;e.setArray2("dsOffsets",s),e.setFloat("halfDestPixelSize",.5/n.width),n=i===this.luminanceDownSamplePostProcesses.length-1?this.luminancePostProcess:t},i===this.luminanceDownSamplePostProcesses.length-1&&(t.onAfterRender=()=>{const t=e.getEngine().readPixels(0,0,1,1),i=new ge(1/16581375,1/65025,1/255,1);t.then((e=>{const t=new Uint8Array(e.buffer);this._hdrCurrentLuminance=(t[0]*i.x+t[1]*i.y+t[2]*i.z+t[3]*i.w)/100}))}),this.addEffect(new kc(e.getEngine(),"HDRLuminanceDownSample"+i,(()=>t),!0))}))}_createHdrPostProcess(e,t){const i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new es("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join("\n"),0);let s=1,n=0,r=0;this.hdrPostProcess.onApply=t=>{if(t.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),n+=e.getEngine().getDeltaTime(),s<0)s=this._hdrCurrentLuminance;else{const e=(r-n)/1e3;this._hdrCurrentLuminance<s+this.hdrDecreaseRate*e?s+=this.hdrDecreaseRate*e:this._hdrCurrentLuminance>s-this.hdrIncreaseRate*e?s-=this.hdrIncreaseRate*e:s=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/s:(s=ne.Clamp(s,this.hdrMinimumLuminance,1e20),t.setFloat("averageLuminance",s)),r=n,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new kc(e.getEngine(),"HDR",(()=>this.hdrPostProcess),!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new es("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new kc(e.getEngine(),"HDRLensFlare",(()=>this.lensFlarePostProcess),!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new es("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new kc(e.getEngine(),"HDRLensFlareCompose",(()=>this.lensFlareComposePostProcess),!0));const i=new pe(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=e=>{e.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),e.setTexture("lensColorSampler",this.lensColorTexture),e.setFloat("strength",this.lensFlareStrength),e.setFloat("ghostDispersal",this.lensFlareGhostDispersal),e.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,e.setVector2("resolution",i),e.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const s=Te.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),n=Te.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=e=>{if(!this._scene.activeCamera)return;e.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),e.setTexture("lensDirtSampler",this.lensFlareDirtTexture),e.setTexture("lensStarSampler",this.lensStarTexture);const t=this._scene.activeCamera.getViewMatrix().getRow(0),i=this._scene.activeCamera.getViewMatrix().getRow(2);let r=me.Dot(t.toVector3(),new me(1,0,0))+me.Dot(i.toVector3(),new me(0,0,1));r*=4;const o=Te.FromValues(.5*Math.cos(r),-Math.sin(r),0,0,Math.sin(r),.5*Math.cos(r),0,0,0,0,1,0,0,0,0,1),a=n.multiply(o).multiply(s);e.setMatrix("lensStarMatrix",a),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new es("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),e.setTexture("depthSampler",this._getDepthTexture()),e.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new kc(e.getEngine(),"HDRDepthOfField",(()=>this.depthOfFieldPostProcess),!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const i=new ad("HDRMotionBlur",e,t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new es("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,zi.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),0);let i=0,s=Te.Identity();const n=Te.Identity();let r=Te.Identity();const o=pe.Zero();this.motionBlurPostProcess.onApply=t=>{r=e.getProjectionMatrix().multiply(e.getViewMatrix()),r.invertToRef(n),t.setMatrix("inverseViewProjection",n),t.setMatrix("prevViewProjection",s),s=r,o.x=this.motionBlurPostProcess.width,o.y=this.motionBlurPostProcess.height,t.setVector2("screenSize",o),i=e.getEngine().getFps()/60,t.setFloat("motionScale",i),t.setFloat("motionStrength",this.motionStrength),t.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new kc(e.getEngine(),"HDRMotionBlur",(()=>this.motionBlurPostProcess),!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let e=0;e<this.luminanceDownSamplePostProcesses.length;e++)this.luminanceDownSamplePostProcesses[e].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let e=0;e<this.blurHPostProcesses.length;e++)this.blurHPostProcesses[e].dispose(t);for(let e=0;e<this.blurVPostProcesses.length;e++)this.blurVPostProcesses[e].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){const e=qe.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=qe.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){const s=qe.Parse((()=>new Td(e._name,t,e._ratio)),e,t,i);return e.sourceLightId&&(s.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&qe.Parse((()=>s.screenSpaceReflectionPostProcess),e.screenSpaceReflectionPostProcess,t,i),s}}Td.LuminanceSteps=6,De([Ge()],Td.prototype,"brightThreshold",void 0),De([Ge()],Td.prototype,"blurWidth",void 0),De([Ge()],Td.prototype,"horizontalBlur",void 0),De([Ge()],Td.prototype,"exposure",null),De([ze("lensTexture")],Td.prototype,"lensTexture",void 0),De([Ge()],Td.prototype,"volumetricLightCoefficient",void 0),De([Ge()],Td.prototype,"volumetricLightPower",void 0),De([Ge()],Td.prototype,"volumetricLightBlurScale",void 0),De([Ge()],Td.prototype,"hdrMinimumLuminance",void 0),De([Ge()],Td.prototype,"hdrDecreaseRate",void 0),De([Ge()],Td.prototype,"hdrIncreaseRate",void 0),De([Ge()],Td.prototype,"hdrAutoExposure",null),De([ze("lensColorTexture")],Td.prototype,"lensColorTexture",void 0),De([Ge()],Td.prototype,"lensFlareStrength",void 0),De([Ge()],Td.prototype,"lensFlareGhostDispersal",void 0),De([Ge()],Td.prototype,"lensFlareHaloWidth",void 0),De([Ge()],Td.prototype,"lensFlareDistortionStrength",void 0),De([Ge()],Td.prototype,"lensFlareBlurWidth",void 0),De([ze("lensStarTexture")],Td.prototype,"lensStarTexture",void 0),De([ze("lensFlareDirtTexture")],Td.prototype,"lensFlareDirtTexture",void 0),De([Ge()],Td.prototype,"depthOfFieldDistance",void 0),De([Ge()],Td.prototype,"depthOfFieldBlurWidth",void 0),De([Ge()],Td.prototype,"motionStrength",null),De([Ge()],Td.prototype,"objectBasedMotionBlur",null),De([Ge()],Td.prototype,"_ratio",void 0),De([Ge()],Td.prototype,"BloomEnabled",null),De([Ge()],Td.prototype,"DepthOfFieldEnabled",null),De([Ge()],Td.prototype,"LensFlareEnabled",null),De([Ge()],Td.prototype,"HDREnabled",null),De([Ge()],Td.prototype,"VLSEnabled",null),De([Ge()],Td.prototype,"MotionBlurEnabled",null),De([Ge()],Td.prototype,"fxaaEnabled",null),De([Ge()],Td.prototype,"screenSpaceReflectionsEnabled",null),De([Ge()],Td.prototype,"volumetricLightStepsCount",null),De([Ge()],Td.prototype,"motionBlurSamples",null),De([Ge()],Td.prototype,"samples",null),ue("BABYLON.StandardRenderingPipeline",Td);class bd{constructor(){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3,5]}}F.IncludesShadersStore.screenSpaceRayTrace="float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }\n/**\nparam csOrigin Camera-space ray origin,which must be \nwithin the view volume and must have z>0.01 and project within the valid screen rectangle\nparam csDirection Unit length camera-space ray direction\nparam projectToPixelMatrix A projection matrix that maps to **pixel** coordinates \n(**not** [-1,+1] normalized device coordinates).\nparam csZBuffer The camera-space Z buffer\nparam csZBufferSize Dimensions of csZBuffer\nparam csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer\nparam nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value\nfor clipping rays headed towards the camera\nparam stride Step in horizontal or vertical pixels between samples. This is a float\nbecause integer math is slow on GPUs,but should be set to an integer>=1\nparam jitterFraction Number between 0 and 1 for how far to bump the ray in stride units\nto conceal banding artifacts,plus the stride ray offset.\nparam maxSteps Maximum number of iterations. Higher gives better images but may be slow\nparam maxRayTraceDistance Maximum camera-space distance to trace before returning a miss\nparam selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.\n1 is a reasonable value,depending on the scene you may need to set this value to 2\nparam hitPixel Pixel coordinates of the first intersection with the scene\nparam numIterations number of iterations performed\nparam csHitPoint Camera space location of the ray hit\n*/\n#define inline\nbool traceScreenSpaceRay1(\nvec3 csOrigin,\nvec3 csDirection,\nmat4 projectToPixelMatrix,\nsampler2D csZBuffer,\nvec2 csZBufferSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nsampler2D csZBackBuffer,\nfloat csZBackSizeFactor,\n#endif\nfloat csZThickness,\nfloat nearPlaneZ,\nfloat stride,\nfloat jitterFraction,\nfloat maxSteps,\nfloat maxRayTraceDistance,\nfloat selfCollisionNumSkip,\nout vec2 startPixel,\nout vec2 hitPixel,\nout vec3 csHitPoint,\nout float numIterations\n#ifdef SSRAYTRACE_DEBUG\n,out vec3 debugColor\n#endif\n)\n{\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#else\nfloat rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;\n#endif\nvec3 csEndPoint=csOrigin+csDirection*rayLength;hitPixel=vec2(-1.0,-1.0);vec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);vec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);float k0=1.0/H0.w;float k1=1.0/H1.w;vec3 Q0=csOrigin*k0;vec3 Q1=csEndPoint*k1;vec2 P0=H0.xy*k0;vec2 P1=H1.xy*k1;\n#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM\nfloat xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;float alpha=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);}\nif ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));}\nP1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);\n#endif\nP1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) { \npermute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }\nfloat stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=vec2(stepDirection,delta.y*invdx);vec3 dQ=(Q1-Q0)*invdx;float dk=(k1-k0)*invdx;float zMin=min(csEndPoint.z,csOrigin.z);float zMax=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;vec4 pqk=vec4(P0,Q0.z,k0);vec4 dPQK=vec4(dP,dQ.z,dk);startPixel=permute ? P0.yx : P0.xy;float prevZMaxEstimate=csOrigin.z;float rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;float sceneZMax=rayZMax+1e4;float end=P1.x*stepDirection;bool hit=false;float stepCount;for (stepCount=0.0;stepCount<=selfCollisionNumSkip ||\n(pqk.x*stepDirection)<=end &&\nstepCount<maxSteps &&\n!hit &&\nsceneZMax != 0.0; \npqk+=dPQK,++stepCount)\n{hitPixel=permute ? pqk.yx : pqk.xy;rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { \nfloat t=rayZMin; rayZMin=rayZMax; rayZMax=t;}\nsceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;hit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);\n#else\nhit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);\n#endif\n#else\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nfloat sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;hit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);\n#else\nhit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);\n#endif\n#endif\n}\npqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}\n#ifdef SSRAYTRACE_ENABLE_REFINEMENT\nif (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;float invStride=1.0/stride;dPQK*=invStride;float refinementStepCount=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||\n(refinementStepCount<=stride*1.4) &&\n(rayZMax<sceneZMax) && (sceneZMax != 0.0);pqk+=dPQK,refinementStepCount+=1.0)\n{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);hitPixel=permute ? pqk.yx : pqk.xy;sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;}\npqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}\n#endif\nQ0.xy+=dQ.xy*stepCount;Q0.z=pqk.z;csHitPoint=Q0/pqk.w;numIterations=stepCount+1.0;\n#ifdef SSRAYTRACE_DEBUG\nif (((pqk.x+dPQK.x)*stepDirection)>end) {debugColor=vec3(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {debugColor=vec3(1,0,0);} else if (sceneZMax==0.0) {debugColor=vec3(1,1,0);} else {debugColor=vec3(0,stepCount/maxSteps,0);}\n#endif\nreturn hit;}\n/**\ntexCoord: in the [0,1] range\ndepth: depth in view space (range [znear,zfar]])\n*/\nvec3 computeViewPosFromUVDepth(vec2 texCoord,float depth,mat4 projection,mat4 invProjectionMatrix) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nndc.z=-projection[2].z-projection[3].z/depth;\n#else\nndc.z=projection[2].z+projection[3].z/depth;\n#endif\nndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}\n";F.ShadersStore.screenSpaceReflection2PixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#define TEXTURECUBEFUNC(s,c,lod) textureLod(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#define TEXTURECUBEFUNC(s,c,bias) textureCube(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;\n#ifdef SSR_SUPPORTED\nuniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D depthSampler;\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nuniform sampler2D backDepthSampler;uniform float backSizeFactor;\n#endif\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nuniform samplerCube envCubeSampler;\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nuniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;\n#endif\n#endif\nuniform mat4 view;uniform mat4 invView;uniform mat4 projection;uniform mat4 invProjectionMatrix;uniform mat4 projectionPixel;uniform float nearPlaneZ;uniform float stepSize;uniform float maxSteps;uniform float strength;uniform float thickness;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;uniform float maxDistance;uniform float selfCollisionNumSkip;uniform float reflectivityThreshold;\n#include<helperFunctions>\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nvec3 hash(vec3 a)\n{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}\nfloat computeAttenuationForIntersection(ivec2 hitPixel,vec2 hitUV,vec3 vsRayOrigin,vec3 vsHitPoint,vec3 reflectionVector,float maxRayDistance,float numIterations) {float attenuation=1.0;\n#ifdef SSR_ATTENUATE_SCREEN_BORDERS\nvec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE\nattenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);\n#endif\n#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS\nattenuation*=1.0-(numIterations/maxSteps);\n#endif\n#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION\nvec3 reflectionNormal=texelFetch(normalSampler,hitPixel,0).xyz;float directionBasedAttenuation=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;\n#endif\nreturn attenuation;}\n#endif\nvoid main()\n{\n#ifdef SSR_SUPPORTED\nvec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);vec3 color=colorFull.rgb;vec4 reflectivity=TEXTUREFUNC(reflectivitySampler,vUV,0.0);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {\n#ifdef SSR_USE_BLUR\ngl_FragColor=vec4(0.);\n#else\ngl_FragColor=colorFull;\n#endif\nreturn;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\nvec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz; \nfloat depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;vec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);vec3 csViewDirection=normalize(csPosition);vec3 csReflectedVector=reflect(csViewDirection,csNormal);\n#ifdef SSR_USE_ENVIRONMENT_CUBE\nvec3 wReflectedVector=vec3(invView*vec4(csReflectedVector,0.0));\n#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC\nvec4 worldPos=invView*vec4(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),vReflectionSize,vReflectionPosition);\n#endif\n#ifdef SSR_INVERTCUBICMAP\nwReflectedVector.y*=-1.0;\n#endif\n#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE\nwReflectedVector.z*=-1.0;\n#endif\nvec3 envColor=TEXTURECUBEFUNC(envCubeSampler,wReflectedVector,0.0).xyz;\n#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE\nenvColor=toLinearSpace(envColor);\n#endif\n#else\nvec3 envColor=color;\n#endif\nfloat reflectionAttenuation=1.0;bool rayHasHit=false;vec2 startPixel;vec2 hitPixel;vec3 hitPoint;float numIterations;\n#ifdef SSRAYTRACE_DEBUG\nvec3 debugColor;\n#endif\n#ifdef SSR_ATTENUATE_FACING_CAMERA\nreflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));\n#endif\nif (reflectionAttenuation>0.0) {\n#ifdef SSR_USE_BLUR\nvec3 jitt=vec3(0.);\n#else\nfloat roughness=1.0-reflectivity.a;vec3 jitt=mix(vec3(0.0),hash(csPosition)-vec3(0.5),roughness)*roughnessFactor; \n#endif\nvec2 uv2=vUV*texSize;float c=(uv2.x+uv2.y)*0.25;float jitter=mod(c,1.0); \nrayHasHit=traceScreenSpaceRay1(\ncsPosition,\nnormalize(csReflectedVector+jitt),\nprojectionPixel,\ndepthSampler,\ntexSize,\n#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER\nbackDepthSampler,\nbackSizeFactor,\n#endif\nthickness,\nnearPlaneZ,\nstepSize,\njitter,\nmaxSteps,\nmaxDistance,\nselfCollisionNumSkip,\nstartPixel,\nhitPixel,\nhitPoint,\nnumIterations\n#ifdef SSRAYTRACE_DEBUG\n,debugColor\n#endif\n);}\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=vec4(debugColor,1.);return;\n#endif\nvec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 SSR=envColor;if (rayHasHit) {vec3 reflectedColor=texelFetch(textureSampler,ivec2(hitPixel),0).rgb;\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\nreflectedColor=toLinearSpace(reflectedColor);\n#endif\nreflectionAttenuation*=computeAttenuationForIntersection(ivec2(hitPixel),hitPixel/texSize,csPosition,hitPoint,csReflectedVector,maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}\n#ifndef SSR_BLEND_WITH_FRESNEL\nSSR*=fresnel;\n#endif\n#ifdef SSR_USE_BLUR\nfloat blur_radius=0.0;float roughness=1.0-reflectivity.a*(1.0-roughnessFactor);if (roughness>0.001) {float cone_angle=min(roughness,0.999)*3.14159265*0.5;float cone_len=distance(startPixel,hitPixel);float op_len=2.0*tan(cone_angle)*cone_len; \nfloat a=op_len;float h=cone_len;float a2=a*a;float fh2=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}\ngl_FragColor=vec4(SSR,blur_radius/255.0); \n#else\n#ifdef SSR_BLEND_WITH_FRESNEL\nvec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#endif\nvec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,colorFull.a);\n#endif\n#else\ngl_FragColor=TEXTUREFUNC(textureSampler,vUV,0.0);\n#endif\n}\n";F.ShadersStore.screenSpaceReflection2BlurPixelShader="#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)\n#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)\n#else\n#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)\n#endif\nuniform sampler2D textureSampler;varying vec2 vUV;uniform vec2 texelOffsetScale;const float weights[8]=float[8] (0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);void processSample(vec2 uv,float i,vec2 stepSize,inout vec4 accumulator,inout float denominator)\n{vec2 offsetUV=stepSize*i+uv;float coefficient=weights[int(2.0-abs(i))];accumulator+=TEXTUREFUNC(textureSampler,offsetUV,0.0)*coefficient;denominator+=coefficient;}\nvoid main()\n{vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);if (dot(colorFull,vec4(1.0))==0.0) {gl_FragColor=colorFull;return;}\nfloat blurRadius=colorFull.a*255.0; \nvec2 stepSize=texelOffsetScale.xy*blurRadius;vec4 accumulator=TEXTUREFUNC(textureSampler,vUV,0.0)*0.214607;float denominator=0.214607;processSample(vUV,1.0,stepSize,accumulator,denominator);processSample(vUV,1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,1.0*2.0,stepSize,accumulator,denominator);processSample(vUV,-1.0,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*2.0,stepSize,accumulator,denominator);gl_FragColor=vec4(accumulator.rgb/denominator,colorFull.a);}\n";F.ShadersStore.screenSpaceReflection2BlurCombinerPixelShader="uniform sampler2D textureSampler; \nuniform sampler2D mainSampler;uniform sampler2D reflectivitySampler;uniform float strength;uniform float reflectionSpecularFalloffExponent;uniform float reflectivityThreshold;varying vec2 vUV;\n#include<helperFunctions>\n#ifdef SSR_BLEND_WITH_FRESNEL\n#include<pbrBRDFFunctions>\n#include<screenSpaceRayTrace>\nuniform mat4 projection;uniform mat4 invProjectionMatrix;uniform sampler2D normalSampler;uniform sampler2D depthSampler;\n#endif\nvoid main()\n{\n#ifdef SSRAYTRACE_DEBUG\ngl_FragColor=texture2D(textureSampler,vUV);\n#else\nvec3 SSR=texture2D(textureSampler,vUV).rgb;vec4 color=texture2D(mainSampler,vUV);vec4 reflectivity=texture2D(reflectivitySampler,vUV);\n#ifndef SSR_DISABLE_REFLECTIVITY_TEST\nif (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {gl_FragColor=color;return;}\n#endif\n#ifdef SSR_INPUT_IS_GAMMA_SPACE\ncolor=toLinearSpace(color);\n#endif\n#ifdef SSR_BLEND_WITH_FRESNEL\nvec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz;float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;vec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);vec3 csViewDirection=normalize(csPosition);vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#else\nvec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);\n#endif\nvec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);\n#ifdef SSR_OUTPUT_IS_GAMMA_SPACE\nfinalColor=toGammaSpace(finalColor);\n#endif\ngl_FragColor=vec4(finalColor,color.a);\n#endif\n}\n";const Ed=Te.Compose(new me(.5,.5,.5),ve.Identity(),new me(.5,.5,.5)),Sd=Te.Compose(new me(.5,.5,1),ve.Identity(),new me(.5,.5,0));class xd extends cd{set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(0===e&&0!==this._reflectivityThreshold||0!==e&&0===this._reflectivityThreshold?(this._reflectivityThreshold=e,this._buildPipeline()):this._reflectivityThreshold=e)}get ssrDownsample(){return this._ssrDownsample}set ssrDownsample(e){e!==this._ssrDownsample&&(this._ssrDownsample=e,this._buildPipeline())}get blurDispersionStrength(){return this._blurDispersionStrength}set blurDispersionStrength(e){if(e===this._blurDispersionStrength)return;const t=0===e&&0!==this._blurDispersionStrength||0!==e&&0===this._blurDispersionStrength;this._blurDispersionStrength=e,t&&this._buildPipeline()}_useBlur(){return this._blurDispersionStrength>0}get blurDownsample(){return this._blurDownsample}set blurDownsample(e){e!==this._blurDownsample&&(this._blurDownsample=e,this._buildPipeline())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._buildPipeline())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._buildPipeline())}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureDownsample(){return this._backfaceDepthTextureDownsample}set backfaceDepthTextureDownsample(e){this._backfaceDepthTextureDownsample!==e&&(this._backfaceDepthTextureDownsample=e,this._resizeDepthRenderer())}get backfaceForceDepthWriteTransparentMeshes(){return this._backfaceForceDepthWriteTransparentMeshes}set backfaceForceDepthWriteTransparentMeshes(e){this._backfaceForceDepthWriteTransparentMeshes!==e&&(this._backfaceForceDepthWriteTransparentMeshes=e,this._depthRenderer&&(this._depthRenderer.forceDepthWriteTransparentMeshes=e))}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._buildPipeline())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._buildPipeline())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._buildPipeline())}getScene(){return this._scene}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}get isSupported(){const e=this._scene.getEngine().getCaps();return e.drawBuffersExtension&&e.texelFetch}constructor(e,t,i,s=!1,n=0){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._reflectivityThreshold=.04,this._ssrDownsample=0,this._blurDispersionStrength=.03,this._blurDownsample=0,this._enableSmoothReflections=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._useFresnel=!1,this._enableAutomaticThicknessComputation=!1,this._backfaceDepthTextureDownsample=0,this._backfaceForceDepthWriteTransparentMeshes=!0,this._isEnabled=!0,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=n,this._forceGeometryBuffer=s,this.isSupported){if(t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){const e=t.enableGeometryBufferRenderer();e&&(e.enableReflectivity=!0,e.useSpecificClearForDepthTexture=!0,e.generateNormalsInWorldSpace&&p.Error("SSRRenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"))}else{const e=t.enablePrePassRenderer();e&&(e.useSpecificClearForDepthTexture=!0,e.markAsDirty(),e.generateNormalsInWorldSpace&&p.Error("SSRRenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!"))}this._buildPipeline()}}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposePostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}_getTextureSize(){var e,t;const i=this._scene.getEngine(),s=this._prePassRenderer;let n={width:i.getRenderWidth(),height:i.getRenderHeight()};if(s&&(null===(e=this._scene.activeCamera)||void 0===e?void 0:e._getFirstPostProcess())===this._ssrPostProcess){const e=s.getRenderTarget();e&&e.textures&&(n=e.textures[s.getIndex(4)].getSize())}else(null===(t=this._ssrPostProcess)||void 0===t?void 0:t.inputTexture)&&(n.width=this._ssrPostProcess.inputTexture.width,n.height=this._ssrPostProcess.inputTexture.height);return n}_updateEffectDefines(){var e;const t=[];(this._geometryBufferRenderer||this._prePassRenderer)&&t.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&t.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&t.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._environmentTexture&&(t.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&t.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&t.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&t.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&t.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&t.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&t.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&t.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&t.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&t.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&t.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this._useBlur()&&t.push("#define SSR_USE_BLUR"),this._debug&&t.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&t.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&t.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),this._useFresnel&&t.push("#define SSR_BLEND_WITH_FRESNEL"),0===this._reflectivityThreshold&&t.push("#define SSR_DISABLE_REFLECTIVITY_TEST"),null===(e=this._ssrPostProcess)||void 0===e||e.updateEffect(t.join("\n"))}_buildPipeline(){var e;if(!this.isSupported)return;if(!this._isEnabled)return void(this._isDirty=!0);this._isDirty=!1;const t=this._scene.getEngine();if(this._disposeDepthRenderer(),this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._enableAutomaticThicknessComputation){const t=null===(e=this._cameras)||void 0===e?void 0:e[0];t&&(this._depthRendererCamera=t,this._depthRenderer=new ds(this._scene,void 0,void 0,void 0,1,!0,"SSRBackDepth"),this._depthRenderer.clearColor.r=1e8,this._depthRenderer.reverseCulling=!0,this._depthRenderer.forceDepthWriteTransparentMeshes=this._backfaceForceDepthWriteTransparentMeshes,this._resizeDepthRenderer(),t.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this._createSSRPostProcess(),this.addEffect(new kc(t,this.SSRRenderEffect,(()=>this._ssrPostProcess),!0)),this._useBlur()&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new kc(t,this.SSRBlurRenderEffect,(()=>[this._blurPostProcessX,this._blurPostProcessY]),!0)),this.addEffect(new kc(t,this.SSRCombineRenderEffect,(()=>this._blurCombinerPostProcess),!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;const e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/(this._backfaceDepthTextureDownsample+1)),s=Math.floor(e.height/(this._backfaceDepthTextureDownsample+1));t.width===i&&t.height===s||this._depthRenderer.getDepthMap().resize({width:i,height:s})}_disposeDepthRenderer(){var e;if(this._depthRenderer){if(this._depthRendererCamera){const t=null!==(e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap()))&&void 0!==e?e:-1;-1!==t&&this._depthRendererCamera.customRenderTargets.splice(t,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposePostProcesses(){var e,t,i,s;for(let n=0;n<this._cameras.length;n++){const r=this._cameras[n];null===(e=this._ssrPostProcess)||void 0===e||e.dispose(r),null===(t=this._blurPostProcessX)||void 0===t||t.dispose(r),null===(i=this._blurPostProcessY)||void 0===i||i.dispose(r),null===(s=this._blurCombinerPostProcess)||void 0===s||s.dispose(r)}this._ssrPostProcess=null,this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new es("ssr","screenSpaceReflection2",["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"],["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"],1,null,this._textureType,this._scene.getEngine(),!1,"",this._textureType),this._updateEffectDefines(),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();const t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){const i=t.getTextureIndex(nd.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",t.getGBuffer().textures[1]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),e.setTexture("depthSampler",t.getGBuffer().textures[0])}else if(i){const t=i.getIndex(5),s=i.getIndex(3),n=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[n]),e.setTexture("depthSampler",i.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[s])}this._enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this._backfaceDepthTextureDownsample+1));const s=this._scene.activeCamera;if(!s)return;const n=s.getViewMatrix(),r=s.getProjectionMatrix();r.invertToRef(Ee.Matrix[0]),n.invertToRef(Ee.Matrix[1]),e.setMatrix("projection",r),e.setMatrix("view",n),e.setMatrix("invView",Ee.Matrix[1]),e.setMatrix("invProjectionMatrix",Ee.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",s.minZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),e.setFloat("reflectivityThreshold",this._reflectivityThreshold);const o=this._getTextureSize();Te.ScalingToRef(o.width,o.height,1,Ee.Matrix[2]),r.multiplyToRef(this._scene.getEngine().isWebGPU?Sd:Ed,Ee.Matrix[3]),Ee.Matrix[3].multiplyToRef(Ee.Matrix[2],Ee.Matrix[4]),e.setMatrix("projectionPixel",Ee.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new bd)}_createBlurAndCombinerPostProcesses(){const e=this._scene.getEngine();this._blurPostProcessX=new es("SSRblurX","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._ssrDownsample+1):1,null,2,e,!1,"",this._textureType),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add((e=>{var t,i;const s=null!==(i=null===(t=this._blurPostProcessX)||void 0===t?void 0:t.inputTexture.width)&&void 0!==i?i:this._scene.getEngine().getRenderWidth();e.setFloat2("texelOffsetScale",this._blurDispersionStrength/s,0)})),this._blurPostProcessY=new es("SSRblurY","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._blurDownsample+1):1,null,2,e,!1,"",this._textureType),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add((e=>{var t,i;const s=null!==(i=null===(t=this._blurPostProcessY)||void 0===t?void 0:t.inputTexture.height)&&void 0!==i?i:this._scene.getEngine().getRenderHeight();e.setFloat2("texelOffsetScale",0,this._blurDispersionStrength/s)}));const t=["strength","reflectionSpecularFalloffExponent","reflectivityThreshold"],i=["textureSampler","mainSampler","reflectivitySampler"];let s="";this._debug&&(s+="#define SSRAYTRACE_DEBUG\n"),this._inputTextureColorIsInGammaSpace&&(s+="#define SSR_INPUT_IS_GAMMA_SPACE\n"),this._generateOutputInGammaSpace&&(s+="#define SSR_OUTPUT_IS_GAMMA_SPACE\n"),this.useFresnel&&(s+="#define SSR_BLEND_WITH_FRESNEL\n",t.push("projection","invProjectionMatrix"),i.push("depthSampler","normalSampler")),0===this._reflectivityThreshold&&(s+="#define SSR_DISABLE_REFLECTIVITY_TEST"),this._blurCombinerPostProcess=new es("SSRblurCombiner","screenSpaceReflection2BlurCombiner",t,i,this._useBlur()?1/(this._blurDownsample+1):1,null,1,e,!1,s,this._textureType),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add((e=>{var t;const i=this._geometryBufferRenderer,s=this._prePassRenderer;if(s||i){if(s&&(null===(t=this._scene.activeCamera)||void 0===t?void 0:t._getFirstPostProcess())===this._ssrPostProcess){const t=s.getRenderTarget();t&&t.textures&&e.setTexture("mainSampler",t.textures[s.getIndex(4)])}else e.setTextureFromPostProcess("mainSampler",this._ssrPostProcess);if(i){const t=i.getTextureIndex(nd.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("reflectivitySampler",i.getGBuffer().textures[t]),this.useFresnel&&(e.setTexture("normalSampler",i.getGBuffer().textures[1]),e.setTexture("depthSampler",i.getGBuffer().textures[0]))}else if(s){const t=s.getIndex(3);if(e.setTexture("reflectivitySampler",s.getRenderTarget().textures[t]),this.useFresnel){const t=s.getIndex(5),i=s.getIndex(6);e.setTexture("normalSampler",s.getRenderTarget().textures[i]),e.setTexture("depthSampler",s.getRenderTarget().textures[t])}}if(e.setFloat("strength",this.strength),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("reflectivityThreshold",this._reflectivityThreshold),this.useFresnel){const t=this._scene.activeCamera;if(t){const i=t.getProjectionMatrix();i.invertToRef(Ee.Matrix[0]),e.setMatrix("projection",i),e.setMatrix("invProjectionMatrix",Ee.Matrix[0])}}}}))}serialize(){const e=qe.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return qe.Parse((()=>new xd(e._name,t,e._ratio)),e,t,i)}}De([Ge()],xd.prototype,"samples",null),De([Ge()],xd.prototype,"maxDistance",void 0),De([Ge()],xd.prototype,"step",void 0),De([Ge()],xd.prototype,"thickness",void 0),De([Ge()],xd.prototype,"strength",void 0),De([Ge()],xd.prototype,"reflectionSpecularFalloffExponent",void 0),De([Ge()],xd.prototype,"maxSteps",void 0),De([Ge()],xd.prototype,"roughnessFactor",void 0),De([Ge()],xd.prototype,"selfCollisionNumSkip",void 0),De([Ge()],xd.prototype,"_reflectivityThreshold",void 0),De([Ge("_ssrDownsample")],xd.prototype,"_ssrDownsample",void 0),De([Ge()],xd.prototype,"ssrDownsample",null),De([Ge("blurDispersionStrength")],xd.prototype,"_blurDispersionStrength",void 0),De([Ge("blurDownsample")],xd.prototype,"_blurDownsample",void 0),De([Ge("enableSmoothReflections")],xd.prototype,"_enableSmoothReflections",void 0),De([Ge("environmentTexture")],xd.prototype,"_environmentTexture",void 0),De([Ge("environmentTextureIsProbe")],xd.prototype,"_environmentTextureIsProbe",void 0),De([Ge("attenuateScreenBorders")],xd.prototype,"_attenuateScreenBorders",void 0),De([Ge("attenuateIntersectionDistance")],xd.prototype,"_attenuateIntersectionDistance",void 0),De([Ge("attenuateIntersectionIterations")],xd.prototype,"_attenuateIntersectionIterations",void 0),De([Ge("attenuateFacingCamera")],xd.prototype,"_attenuateFacingCamera",void 0),De([Ge("attenuateBackfaceReflection")],xd.prototype,"_attenuateBackfaceReflection",void 0),De([Ge("clipToFrustum")],xd.prototype,"_clipToFrustum",void 0),De([Ge("useFresnel")],xd.prototype,"_useFresnel",void 0),De([Ge("enableAutomaticThicknessComputation")],xd.prototype,"_enableAutomaticThicknessComputation",void 0),De([Ge("backfaceDepthTextureDownsample")],xd.prototype,"_backfaceDepthTextureDownsample",void 0),De([Ge("backfaceForceDepthWriteTransparentMeshes")],xd.prototype,"_backfaceForceDepthWriteTransparentMeshes",void 0),De([Ge("isEnabled")],xd.prototype,"_isEnabled",void 0),De([Ge("inputTextureColorIsInGammaSpace")],xd.prototype,"_inputTextureColorIsInGammaSpace",void 0),De([Ge("generateOutputInGammaSpace")],xd.prototype,"_generateOutputInGammaSpace",void 0),De([Ge("debug")],xd.prototype,"_debug",void 0),ue("BABYLON.SSRRenderingPipeline",xd);F.ShadersStore.stereoscopicInterlacePixelShader="const vec3 TWO=vec3(2.0,2.0,2.0);varying vec2 vUV;uniform sampler2D camASampler;uniform sampler2D textureSampler;uniform vec2 stepSize;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{bool useCamA;bool useCamB;vec2 texCoord1;vec2 texCoord2;vec3 frag1;vec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;useCamA=!useCamB;texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\n#ifdef IS_STEREOSCOPIC_INTERLACED\nfloat rowNum=floor(vUV.y/stepSize.y);useCamA=mod(rowNum,2.0)==1.0;useCamB=mod(rowNum,2.0)==0.0;texCoord1=vec2(vUV.x,vUV.y);texCoord2=vec2(vUV.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;useCamA=!useCamB;texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n#endif\nif (useCamB){frag1=texture2D(textureSampler,texCoord1).rgb;frag2=texture2D(textureSampler,texCoord2).rgb;}else if (useCamA){frag1=texture2D(camASampler ,texCoord1).rgb;frag2=texture2D(camASampler ,texCoord2).rgb;}else {discard;}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);}\n";var Cd;F.ShadersStore.tonemapPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;const float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{return dot(c,vec3(0.22,0.707,0.071));}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{vec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;float scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;const float ExposureBias=2.0;vec3 x=ExposureBias*colour;vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x=vec3(W,W,W);vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);}",function(e){e[e.Hable=0]="Hable",e[e.Reinhard=1]="Reinhard",e[e.HejiDawson=2]="HejiDawson",e[e.Photographic=3]="Photographic"}(Cd||(Cd={}));F.ShadersStore.volumetricLightScatteringPixelShader="uniform sampler2D textureSampler;uniform sampler2D lightScatteringSampler;uniform float decay;uniform float exposure;uniform float weight;uniform float density;uniform vec2 meshPositionOnScreen;varying vec2 vUV;\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\nvec2 tc=vUV;vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;float illuminationDecay=1.0;vec4 color=texture2D(lightScatteringSampler,tc)*0.4;for(int i=0; i<NUM_SAMPLES; i++) {tc-=deltaTexCoord;vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;dataSample*=illuminationDecay*weight;color+=dataSample;illuminationDecay*=decay;}\nvec4 realColor=texture2D(textureSampler,vUV);gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";F.ShadersStore.volumetricLightScatteringPassVertexShader="attribute vec3 position;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<instancesDeclaration>\nuniform mat4 viewProjection;uniform vec2 depthValues;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;\n#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n";F.ShadersStore.volumetricLightScatteringPassPixelShader="#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);if (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);}\n";class yd extends es{get useDiffuseColor(){return p.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){p.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,s,n=100,r=zi.BILINEAR_SAMPLINGMODE,o,a,l){var h,c;super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,r,o,a,"#define NUM_SAMPLES "+n),this._screenCoordinates=pe.Zero(),this.customMeshPosition=me.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=[],this.includedMeshes=[],this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,o=(l=null!==(c=null!==(h=null==i?void 0:i.getScene())&&void 0!==h?h:l)&&void 0!==c?c:this._scene).getEngine(),this._viewPort=new Ut(0,0,1,1).toGlobal(o.getRenderWidth(),o.getRenderHeight()),this.mesh=null!=s?s:yd.CreateDefaultMesh("VolumetricLightScatteringMesh",l),this._createPass(l,t.passRatio||t),this.onActivate=e=>{this.isSupported||this.dispose(e),this.onActivate=null},this.onApplyObservable.add((e=>{this._updateMeshScreenCoordinates(l),e.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),e.setFloat("exposure",this.exposure),e.setFloat("decay",this.decay),e.setFloat("weight",this.weight),e.setFloat("density",this.density),e.setVector2("meshPositionOnScreen",this._screenCoordinates)}))}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){var i;const s=e.getMesh();if(s===this.mesh&&s.material)return s.material.isReady(s);const n=null===(i=s._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===i?void 0:i[this._scene.getEngine().currentRenderPassId];if(n)return n.isReadyForSubMesh(s,e,t);const r=[],o=[Oe.PositionKind],a=e.getMaterial();a&&(a.needAlphaTesting()&&r.push("#define ALPHATEST"),s.isVerticesDataPresent(Oe.UVKind)&&(o.push(Oe.UVKind),r.push("#define UV1")),s.isVerticesDataPresent(Oe.UV2Kind)&&(o.push(Oe.UV2Kind),r.push("#define UV2"))),s.useBones&&s.computeBonesUsingShaders?(o.push(Oe.MatricesIndicesKind),o.push(Oe.MatricesWeightsKind),r.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),r.push("#define BonesPerMesh "+(s.skeleton?s.skeleton.bones.length+1:0))):r.push("#define NUM_BONE_INFLUENCERS 0"),t&&(r.push("#define INSTANCES"),wi.PushAttributesForInstances(o),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES"));const l=e._getDrawWrapper(void 0,!0),h=l.defines,c=r.join("\n");return h!==c&&l.setEffect(s.getScene().getEngine().createEffect("volumetricLightScatteringPass",o,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],c,void 0,void 0,void 0,{maxSimultaneousMorphTargets:s.numBoneInfluencers}),c),l.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==t&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&-1===this.includedMeshes.indexOf(e)||this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new Ji("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=zi.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=zi.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const s=this.getCamera();s?s.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const n=e=>{var t;const i=e.getRenderingMesh(),s=e.getEffectiveMesh();if(this._meshExcluded(i))return;s._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const n=e.getMaterial();if(!n)return;const r=i.getScene(),o=r.getEngine();o.setState(n.backFaceCulling,void 0,void 0,void 0,n.cullBackFaces);const a=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(a.mustReturn)return;const l=o.getCaps().instancedArrays&&(null!==a.visibleInstances[e._id]||i.hasThinInstances);if(this._isReady(e,l)){const h=null===(t=s._internalAbstractMeshDataInfo._materialForRenderPass)||void 0===t?void 0:t[o.currentRenderPassId];let c=e._getDrawWrapper();if(i!==this.mesh||c||(c=n._getDrawWrapper()),!c)return;const d=c.effect;if(o.enableEffect(c),l||i._bind(e,d,n.fillMode),i===this.mesh)n.bind(s.getWorldMatrix(),i);else if(h)h.bindForSubMesh(s.getWorldMatrix(),s,e);else{if(d.setMatrix("viewProjection",r.getTransformMatrix()),n&&n.needAlphaTesting()){const e=n.getAlphaTestTexture();d.setTexture("diffuseSampler",e),e&&d.setMatrix("diffuseMatrix",e.getTextureMatrix())}i.useBones&&i.computeBonesUsingShaders&&i.skeleton&&d.setMatrices("mBones",i.skeleton.getTransformMatrices(i))}l&&i.hasThinInstances&&d.setMatrix("world",s.getWorldMatrix()),i._processRendering(s,e,d,Ps.TriangleFillMode,a,l,((e,t)=>{e||d.setMatrix("world",t)}))}};let r;const o=new Ie(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add((()=>{r=e.clearColor,e.clearColor=o})),this._volumetricLightScatteringRTT.onAfterRenderObservable.add((()=>{e.clearColor=r})),this._volumetricLightScatteringRTT.customIsReadyFunction=(e,t,s)=>{if((s||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){const s=e.subMeshes[t],n=s.getMaterial(),r=s.getRenderingMesh();if(!n)continue;const o=r._getInstancesRenderList(s._id,!!s.getReplacementMesh()),a=i.getCaps().instancedArrays&&(null!==o.visibleInstances[s._id]||r.hasThinInstances);if(!this._isReady(s,a))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(t,i,s,r)=>{const o=e.getEngine();let a;if(r.length){for(o.setColorWrite(!1),a=0;a<r.length;a++)n(r.data[a]);o.setColorWrite(!0)}for(a=0;a<t.length;a++)n(t.data[a]);for(a=0;a<i.length;a++)n(i.data[a]);if(s.length){for(a=0;a<s.length;a++){const t=s.data[a],i=t.getBoundingInfo();i&&e.activeCamera&&(t._alphaIndex=t.getMesh().alphaIndex,t._distanceToCamera=i.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const t=s.data.slice(0,s.length);for(t.sort(((e,t)=>e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0)),o.setAlphaMode(2),a=0;a<t.length;a++)n(t[a]);o.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;i=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const s=me.Project(i,Te.Identity(),t,this._viewPort);this._screenCoordinates.x=s.x/this._viewPort.width,this._screenCoordinates.y=s.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=Rr(e,{size:1},t);i.billboardMode=Gn.BILLBOARDMODE_ALL;const s=new zs(e+"Material",t);return s.emissiveColor=new Re(1,1,1),i.material=s,i}}De([Qe()],yd.prototype,"customMeshPosition",void 0),De([Ge()],yd.prototype,"useCustomMeshPosition",void 0),De([Ge()],yd.prototype,"invert",void 0),De([Ye()],yd.prototype,"mesh",void 0),De([Ge()],yd.prototype,"excludedMeshes",void 0),De([Ge()],yd.prototype,"includedMeshes",void 0),De([Ge()],yd.prototype,"exposure",void 0),De([Ge()],yd.prototype,"decay",void 0),De([Ge()],yd.prototype,"weight",void 0),De([Ge()],yd.prototype,"density",void 0),ue("BABYLON.VolumetricLightScatteringPostProcess",yd);F.ShadersStore.screenSpaceCurvaturePixelShader="precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform float curvature_ridge;uniform float curvature_valley;\n#ifndef CURVATURE_OFFSET\n#define CURVATURE_OFFSET 1\n#endif\nfloat curvature_soft_clamp(float curvature,float control)\n{if (curvature<0.5/control)\nreturn curvature*(1.0-curvature*control);return 0.25/control;}\nfloat calculate_curvature(ivec2 texel,float ridge,float valley)\n{vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));if (normal_diff<0.0)\nreturn -2.0*curvature_soft_clamp(-normal_diff,valley);return 2.0*curvature_soft_clamp(normal_diff,ridge);}\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) \n{ivec2 texel=ivec2(gl_FragCoord.xy);vec4 baseColor=texture2D(textureSampler,vUV);float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);baseColor.rgb*=curvature+1.0;gl_FragColor=baseColor;}";class Ad extends es{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,s,n,r,o,a=0,l=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,s,n,r,o,void 0,a,void 0,null,l),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?(this._geometryBufferRenderer.generateNormalsInWorldSpace&&p.Error("ScreenSpaceCurvaturePostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"),this.onApply=e=>{e.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),e.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const t=this._geometryBufferRenderer.getGBuffer().textures[1];e.setTexture("normalSampler",t)}):p.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){const e=u.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension}static _Parse(e,t,i,s){return qe.Parse((()=>new Ad(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable)),e,i,s)}}De([Ge()],Ad.prototype,"ridge",void 0),De([Ge()],Ad.prototype,"valley",void 0),ue("BABYLON.ScreenSpaceCurvaturePostProcess",Ad);class Rd{constructor(e,t=Rd.UNITMODE_PIXEL,i=!0){this.negativeValueAllowed=i,this._value=1,this._unit=Rd.UNITMODE_PIXEL,this.ignoreAdaptiveScaling=!1,this.onChangedObservable=new s,this._value=e,this._unit=t,this._originalUnit=t}get isPercentage(){return this._unit===Rd.UNITMODE_PERCENTAGE}get isPixel(){return this._unit===Rd.UNITMODE_PIXEL}get internalValue(){return this._value}get value(){return this._value}set value(e){e!==this._value&&(this._value=e,this.onChangedObservable.notifyObservers())}get unit(){return this._unit}set unit(e){e!==this._unit&&(this._unit=e,this.onChangedObservable.notifyObservers())}getValueInPixel(e,t){return this.isPixel?this.getValue(e):this.getValue(e)*t}updateInPlace(e,t=Rd.UNITMODE_PIXEL){return this.value===e&&this.unit===t||(this._value=e,this._unit=t,this.onChangedObservable.notifyObservers()),this}getValue(e){if(e&&!this.ignoreAdaptiveScaling&&this.unit!==Rd.UNITMODE_PERCENTAGE){let t=0,i=0;if(e.idealWidth&&(t=Math.ceil(this._value*e.getSize().width/e.idealWidth)),e.idealHeight&&(i=Math.ceil(this._value*e.getSize().height/e.idealHeight)),e.useSmallestIdeal&&e.idealWidth&&e.idealHeight)return window.innerWidth<window.innerHeight?t:i;if(e.idealWidth)return t;if(e.idealHeight)return i}return this._value}toString(e,t){switch(this._unit){case Rd.UNITMODE_PERCENTAGE:{const i=100*this.getValue(e);return(t?i.toFixed(t):i)+"%"}case Rd.UNITMODE_PIXEL:{const i=this.getValue(e);return(t?i.toFixed(t):i)+"px"}}return this._unit.toString()}fromString(e){const t=Rd._Regex.exec(e.toString());if(!t||0===t.length)return!1;let i=parseFloat(t[1]),s=this._originalUnit;if(this.negativeValueAllowed||i<0&&(i=0),4===t.length)switch(t[3]){case"px":s=Rd.UNITMODE_PIXEL;break;case"%":s=Rd.UNITMODE_PERCENTAGE,i/=100}return(i!==this._value||s!==this._unit)&&(this._value=i,this._unit=s,this.onChangedObservable.notifyObservers(),!0)}static get UNITMODE_PERCENTAGE(){return Rd._UNITMODE_PERCENTAGE}static get UNITMODE_PIXEL(){return Rd._UNITMODE_PIXEL}}Rd._Regex=/(^-?\d*(\.\d+)?)(%|px)?/,Rd._UNITMODE_PERCENTAGE=0,Rd._UNITMODE_PIXEL=1;const Id=[new pe(0,0),new pe(0,0),new pe(0,0),new pe(0,0)],Pd=[new pe(0,0),new pe(0,0),new pe(0,0),new pe(0,0)],Md=new pe(0,0),Od=new pe(0,0);class Dd{constructor(e,t,i,s){this.left=e,this.top=t,this.width=i,this.height=s}copyFrom(e){this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height}copyFromFloats(e,t,i,s){this.left=e,this.top=t,this.width=i,this.height=s}static CombineToRef(e,t,i){const s=Math.min(e.left,t.left),n=Math.min(e.top,t.top),r=Math.max(e.left+e.width,t.left+t.width),o=Math.max(e.top+e.height,t.top+t.height);i.left=s,i.top=n,i.width=r-s,i.height=o-n}addAndTransformToRef(e,t,i,s,n,r){const o=this.left+t,a=this.top+i,l=this.width+s,h=this.height+n;Id[0].copyFromFloats(o,a),Id[1].copyFromFloats(o+l,a),Id[2].copyFromFloats(o+l,a+h),Id[3].copyFromFloats(o,a+h),Md.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE),Od.copyFromFloats(0,0);for(let t=0;t<4;t++)e.transformCoordinates(Id[t].x,Id[t].y,Pd[t]),Md.x=Math.floor(Math.min(Md.x,Pd[t].x)),Md.y=Math.floor(Math.min(Md.y,Pd[t].y)),Od.x=Math.ceil(Math.max(Od.x,Pd[t].x)),Od.y=Math.ceil(Math.max(Od.y,Pd[t].y));r.left=Md.x,r.top=Md.y,r.width=Od.x-Md.x,r.height=Od.y-Md.y}transformToRef(e,t){this.addAndTransformToRef(e,0,0,0,0,t)}isEqualsTo(e){return this.left===e.left&&this.top===e.top&&this.width===e.width&&this.height===e.height}static Empty(){return new Dd(0,0,0,0)}}class Nd extends pe{constructor(e,t=0){super(e.x,e.y),this.buttonIndex=t}}class Fd{constructor(e,t,i,s,n,r){this.m=new Float32Array(6),this.fromValues(e,t,i,s,n,r)}fromValues(e,t,i,s,n,r){return this.m[0]=e,this.m[1]=t,this.m[2]=i,this.m[3]=s,this.m[4]=n,this.m[5]=r,this}determinant(){return this.m[0]*this.m[3]-this.m[1]*this.m[2]}invertToRef(e){const t=this.m[0],i=this.m[1],s=this.m[2],n=this.m[3],r=this.m[4],o=this.m[5],a=this.determinant();if(a<ae*ae)return e.m[0]=0,e.m[1]=0,e.m[2]=0,e.m[3]=0,e.m[4]=0,e.m[5]=0,this;const l=1/a,h=s*o-n*r,c=i*r-t*o;return e.m[0]=n*l,e.m[1]=-i*l,e.m[2]=-s*l,e.m[3]=t*l,e.m[4]=h*l,e.m[5]=c*l,this}multiplyToRef(e,t){const i=this.m[0],s=this.m[1],n=this.m[2],r=this.m[3],o=this.m[4],a=this.m[5],l=e.m[0],h=e.m[1],c=e.m[2],d=e.m[3],u=e.m[4],_=e.m[5];return t.m[0]=i*l+s*c,t.m[1]=i*h+s*d,t.m[2]=n*l+r*c,t.m[3]=n*h+r*d,t.m[4]=o*l+a*c+u,t.m[5]=o*h+a*d+_,this}transformCoordinates(e,t,i){return i.x=e*this.m[0]+t*this.m[2]+this.m[4],i.y=e*this.m[1]+t*this.m[3]+this.m[5],this}static Identity(){return new Fd(1,0,0,1,0,0)}static IdentityToRef(e){e.m[0]=1,e.m[1]=0,e.m[2]=0,e.m[3]=1,e.m[4]=0,e.m[5]=0}static TranslationToRef(e,t,i){i.fromValues(1,0,0,1,e,t)}static ScalingToRef(e,t,i){i.fromValues(e,0,0,t,0,0)}static RotationToRef(e,t){const i=Math.sin(e),s=Math.cos(e);t.fromValues(s,i,-i,s,0,0)}static ComposeToRef(e,t,i,s,n,r,o){Fd.TranslationToRef(e,t,Fd._TempPreTranslationMatrix),Fd.ScalingToRef(s,n,Fd._TempScalingMatrix),Fd.RotationToRef(i,Fd._TempRotationMatrix),Fd.TranslationToRef(-e,-t,Fd._TempPostTranslationMatrix),Fd._TempPreTranslationMatrix.multiplyToRef(Fd._TempScalingMatrix,Fd._TempCompose0),Fd._TempCompose0.multiplyToRef(Fd._TempRotationMatrix,Fd._TempCompose1),r?(Fd._TempCompose1.multiplyToRef(Fd._TempPostTranslationMatrix,Fd._TempCompose2),Fd._TempCompose2.multiplyToRef(r,o)):Fd._TempCompose1.multiplyToRef(Fd._TempPostTranslationMatrix,o)}}Fd._TempPreTranslationMatrix=Fd.Identity(),Fd._TempPostTranslationMatrix=Fd.Identity(),Fd._TempRotationMatrix=Fd.Identity(),Fd._TempScalingMatrix=Fd.Identity(),Fd._TempCompose0=Fd.Identity(),Fd._TempCompose1=Fd.Identity(),Fd._TempCompose2=Fd.Identity();class Ld{static Round(e,t=Ld.DefaultRoundingPrecision){return Math.round(e*t)/t}}Ld.DefaultRoundingPrecision=100;class wd{get isReadOnly(){return this._isReadOnly}set isReadOnly(e){this._isReadOnly=e}get transformedMeasure(){return this._evaluatedMeasure}set clipChildren(e){this._clipChildren=e}get clipChildren(){return this._clipChildren}set clipContent(e){this._clipContent=e}get clipContent(){return this._clipContent}get shadowOffsetX(){return this._shadowOffsetX}set shadowOffsetX(e){this._shadowOffsetX!==e&&(this._shadowOffsetX=e,this._markAsDirty())}get shadowOffsetY(){return this._shadowOffsetY}set shadowOffsetY(e){this._shadowOffsetY!==e&&(this._shadowOffsetY=e,this._markAsDirty())}get shadowBlur(){return this._shadowBlur}set shadowBlur(e){this._shadowBlur!==e&&(this._previousShadowBlur=this._shadowBlur,this._shadowBlur=e,this._markAsDirty())}get shadowColor(){return this._shadowColor}set shadowColor(e){this._shadowColor!==e&&(this._shadowColor=e,this._markAsDirty())}get typeName(){return this._getTypeName()}getClassName(){return this._getTypeName()}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get host(){return this._host}get fontOffset(){return this._fontOffset}set fontOffset(e){this._fontOffset=e}get alpha(){return this._alpha}set alpha(e){this._alpha!==e&&(this._alphaSet=!0,this._alpha=e,this._markAsDirty())}get highlightLineWidth(){return this._highlightLineWidth}set highlightLineWidth(e){this._highlightLineWidth!==e&&(this._highlightLineWidth=e,this._markAsDirty())}get isHighlighted(){return this._isHighlighted}set isHighlighted(e){this._isHighlighted!==e&&(this._isHighlighted=e,this._markAsDirty())}get highlightColor(){return this._highlightColor}set highlightColor(e){this._highlightColor!==e&&(this._highlightColor=e,this._markAsDirty())}get scaleX(){return this._scaleX}set scaleX(e){this._scaleX!==e&&(this._scaleX=e,this._markAsDirty(),this._markMatrixAsDirty())}get scaleY(){return this._scaleY}set scaleY(e){this._scaleY!==e&&(this._scaleY=e,this._markAsDirty(),this._markMatrixAsDirty())}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._markAsDirty(),this._markMatrixAsDirty())}get transformCenterY(){return this._transformCenterY}set transformCenterY(e){this._transformCenterY!==e&&(this._transformCenterY=e,this._markAsDirty(),this._markMatrixAsDirty())}get transformCenterX(){return this._transformCenterX}set transformCenterX(e){this._transformCenterX!==e&&(this._transformCenterX=e,this._markAsDirty(),this._markMatrixAsDirty())}get horizontalAlignment(){return this._horizontalAlignment}set horizontalAlignment(e){this._horizontalAlignment!==e&&(this._horizontalAlignment=e,this._markAsDirty())}get verticalAlignment(){return this._verticalAlignment}set verticalAlignment(e){this._verticalAlignment!==e&&(this._verticalAlignment=e,this._markAsDirty())}set fixedRatio(e){this._fixedRatio!==e&&(this._fixedRatio=e,this._markAsDirty())}get fixedRatio(){return this._fixedRatio}set fixedRatioMasterIsWidth(e){this._fixedRatioMasterIsWidth!==e&&(this._fixedRatioMasterIsWidth=e,this._markAsDirty())}get fixedRatioMasterIsWidth(){return this._fixedRatioMasterIsWidth}get width(){return this._width.toString(this._host)}set width(e){this._fixedRatioMasterIsWidth=!0,this._width.toString(this._host)!==e&&this._width.fromString(e)&&this._markAsDirty()}get widthInPixels(){return this._width.getValueInPixel(this._host,this._cachedParentMeasure.width)}set widthInPixels(e){isNaN(e)||(this._fixedRatioMasterIsWidth=!0,this.width=e+"px")}get height(){return this._height.toString(this._host)}set height(e){this._fixedRatioMasterIsWidth=!1,this._height.toString(this._host)!==e&&this._height.fromString(e)&&this._markAsDirty()}get heightInPixels(){return this._height.getValueInPixel(this._host,this._cachedParentMeasure.height)}set heightInPixels(e){isNaN(e)||(this._fixedRatioMasterIsWidth=!1,this.height=e+"px")}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this._resetFontCache())}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle!==e&&(this._fontStyle=e,this._resetFontCache())}get fontWeight(){return this._fontWeight}set fontWeight(e){this._fontWeight!==e&&(this._fontWeight=e,this._resetFontCache())}get style(){return this._style}set style(e){this._style&&(this._style.onChangedObservable.remove(this._styleObserver),this._styleObserver=null),this._style=e,this._style&&(this._styleObserver=this._style.onChangedObservable.add((()=>{this._markAsDirty(),this._resetFontCache()}))),this._markAsDirty(),this._resetFontCache()}get _isFontSizeInPercentage(){return this._fontSize.isPercentage}get fontSizeInPixels(){const e=this._style?this._style._fontSize:this._fontSize;return e.isPixel?e.getValue(this._host):e.getValueInPixel(this._host,this._tempParentMeasure.height||this._cachedParentMeasure.height)}set fontSizeInPixels(e){isNaN(e)||(this.fontSize=e+"px")}get fontSize(){return this._fontSize.toString(this._host)}set fontSize(e){this._fontSize.toString(this._host)!==e&&this._fontSize.fromString(e)&&(this._markAsDirty(),this._resetFontCache())}get color(){return this._color}set color(e){this._color!==e&&(this._color=e,this._markAsDirty())}get gradient(){return this._gradient}set gradient(e){this._gradient!==e&&(this._gradient=e,this._markAsDirty())}get zIndex(){return this._zIndex}set zIndex(e){this.zIndex!==e&&(this._zIndex=e,this.parent&&this.parent._reOrderControl(this))}get notRenderable(){return this._doNotRender}set notRenderable(e){this._doNotRender!==e&&(this._doNotRender=e,this._markAsDirty())}get isVisible(){return this._isVisible}set isVisible(e){this._isVisible!==e&&(this._isVisible=e,this._markAsDirty(!0),this.onIsVisibleChangedObservable.notifyObservers(e))}get isDirty(){return this._isDirty}get linkedMesh(){return this._linkedMesh}get descendantsOnlyPadding(){return this._descendantsOnlyPadding}set descendantsOnlyPadding(e){this._descendantsOnlyPadding!==e&&(this._descendantsOnlyPadding=e,this._markAsDirty())}get paddingLeft(){return this._paddingLeft.toString(this._host)}set paddingLeft(e){this._paddingLeft.fromString(e)&&this._markAsDirty()}get paddingLeftInPixels(){return this._paddingLeft.getValueInPixel(this._host,this._cachedParentMeasure.width)}set paddingLeftInPixels(e){isNaN(e)||(this.paddingLeft=e+"px")}get _paddingLeftInPixels(){return this._descendantsOnlyPadding?0:this.paddingLeftInPixels}get paddingRight(){return this._paddingRight.toString(this._host)}set paddingRight(e){this._paddingRight.fromString(e)&&this._markAsDirty()}get paddingRightInPixels(){return this._paddingRight.getValueInPixel(this._host,this._cachedParentMeasure.width)}set paddingRightInPixels(e){isNaN(e)||(this.paddingRight=e+"px")}get _paddingRightInPixels(){return this._descendantsOnlyPadding?0:this.paddingRightInPixels}get paddingTop(){return this._paddingTop.toString(this._host)}set paddingTop(e){this._paddingTop.fromString(e)&&this._markAsDirty()}get paddingTopInPixels(){return this._paddingTop.getValueInPixel(this._host,this._cachedParentMeasure.height)}set paddingTopInPixels(e){isNaN(e)||(this.paddingTop=e+"px")}get _paddingTopInPixels(){return this._descendantsOnlyPadding?0:this.paddingTopInPixels}get paddingBottom(){return this._paddingBottom.toString(this._host)}set paddingBottom(e){this._paddingBottom.fromString(e)&&this._markAsDirty()}get paddingBottomInPixels(){return this._paddingBottom.getValueInPixel(this._host,this._cachedParentMeasure.height)}set paddingBottomInPixels(e){isNaN(e)||(this.paddingBottom=e+"px")}get _paddingBottomInPixels(){return this._descendantsOnlyPadding?0:this.paddingBottomInPixels}get left(){return this._left.toString(this._host)}set left(e){this._left.fromString(e)&&this._markAsDirty()}get leftInPixels(){return this._left.getValueInPixel(this._host,this._cachedParentMeasure.width)}set leftInPixels(e){isNaN(e)||(this.left=e+"px")}get top(){return this._top.toString(this._host)}set top(e){this._top.fromString(e)&&this._markAsDirty()}get topInPixels(){return this._top.getValueInPixel(this._host,this._cachedParentMeasure.height)}set topInPixels(e){isNaN(e)||(this.top=e+"px")}get linkOffsetX(){return this._linkOffsetX.toString(this._host)}set linkOffsetX(e){this._linkOffsetX.fromString(e)&&this._markAsDirty()}get linkOffsetXInPixels(){return this._linkOffsetX.getValueInPixel(this._host,this._cachedParentMeasure.width)}set linkOffsetXInPixels(e){isNaN(e)||(this.linkOffsetX=e+"px")}get linkOffsetY(){return this._linkOffsetY.toString(this._host)}set linkOffsetY(e){this._linkOffsetY.fromString(e)&&this._markAsDirty()}get linkOffsetYInPixels(){return this._linkOffsetY.getValueInPixel(this._host,this._cachedParentMeasure.height)}set linkOffsetYInPixels(e){isNaN(e)||(this.linkOffsetY=e+"px")}get centerX(){return this._currentMeasure.left+this._currentMeasure.width/2}get centerY(){return this._currentMeasure.top+this._currentMeasure.height/2}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled===e)return;this._isEnabled=e,this._markAsDirty();const t=e=>{if(e.host){for(const t in e.host._lastControlOver)e===this.host._lastControlOver[t]&&(e._onPointerOut(e,null,!0),delete e.host._lastControlOver[t]);void 0!==e.children&&e.children.forEach(t)}};t(this),this.onEnabledStateChangedObservable.notifyObservers(e)}get disabledColor(){return this._disabledColor}set disabledColor(e){this._disabledColor!==e&&(this._disabledColor=e,this._markAsDirty())}get disabledColorItem(){return this._disabledColorItem}set disabledColorItem(e){this._disabledColorItem!==e&&(this._disabledColorItem=e,this._markAsDirty())}constructor(e){this.name=e,this._alpha=1,this._alphaSet=!1,this._zIndex=0,this._currentMeasure=Dd.Empty(),this._tempPaddingMeasure=Dd.Empty(),this._fontFamily="",this._fontStyle="",this._fontWeight="",this._fontSize=new Rd(18,Rd.UNITMODE_PIXEL,!1),this._width=new Rd(1,Rd.UNITMODE_PERCENTAGE,!1),this._height=new Rd(1,Rd.UNITMODE_PERCENTAGE,!1),this._color="",this._style=null,this._horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_CENTER,this._verticalAlignment=wd.VERTICAL_ALIGNMENT_CENTER,this._isDirty=!0,this._wasDirty=!1,this._tempParentMeasure=Dd.Empty(),this._prevCurrentMeasureTransformedIntoGlobalSpace=Dd.Empty(),this._cachedParentMeasure=Dd.Empty(),this._descendantsOnlyPadding=!1,this._paddingLeft=new Rd(0),this._paddingRight=new Rd(0),this._paddingTop=new Rd(0),this._paddingBottom=new Rd(0),this._left=new Rd(0),this._top=new Rd(0),this._scaleX=1,this._scaleY=1,this._rotation=0,this._transformCenterX=.5,this._transformCenterY=.5,this._transformMatrix=Fd.Identity(),this._invertTransformMatrix=Fd.Identity(),this._transformedPosition=pe.Zero(),this._isMatrixDirty=!0,this._isVisible=!0,this._isHighlighted=!1,this._highlightColor="#4affff",this._highlightLineWidth=2,this._fontSet=!1,this._dummyVector2=pe.Zero(),this._downCount=0,this._enterCount=-1,this._doNotRender=!1,this._downPointerIds={},this._evaluatedMeasure=new Dd(0,0,0,0),this._evaluatedParentMeasure=new Dd(0,0,0,0),this._isEnabled=!0,this._disabledColor="#9a9a9a",this._disabledColorItem="#6a6a6a",this._isReadOnly=!1,this._gradient=null,this._rebuildLayout=!1,this.onEnabledStateChangedObservable=new s,this._customData={},this._isClipped=!1,this._automaticSize=!1,this.metadata=null,this.isHitTestVisible=!0,this.isPointerBlocker=!1,this.isFocusInvisible=!1,this._clipChildren=!0,this._clipContent=!0,this.useBitmapCache=!1,this._shadowOffsetX=0,this._shadowOffsetY=0,this._shadowBlur=0,this._previousShadowBlur=0,this._shadowColor="black",this.hoverCursor="",this._linkOffsetX=new Rd(0),this._linkOffsetY=new Rd(0),this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new s,this.onWheelObservable=new s,this.onPointerMoveObservable=new s,this.onPointerOutObservable=new s,this.onPointerDownObservable=new s,this.onPointerUpObservable=new s,this.onPointerClickObservable=new s,this.onPointerEnterObservable=new s,this.onDirtyObservable=new s,this.onBeforeDrawObservable=new s,this.onAfterDrawObservable=new s,this.onDisposeObservable=new s,this.onIsVisibleChangedObservable=new s,this._fixedRatio=0,this._fixedRatioMasterIsWidth=!0,this.animations=null,this._tmpMeasureA=new Dd(0,0,0,0)}_getTypeName(){return"Control"}getAscendantOfClass(e){return this.parent?this.parent.getClassName()===e?this.parent:this.parent.getAscendantOfClass(e):null}markAsDirty(e=!1){this._markAsDirty(e)}markAllAsDirty(){this._markAllAsDirty()}_resetFontCache(){this._fontSet=!0,this._markAsDirty()}isAscendant(e){return!!this.parent&&(this.parent===e||this.parent.isAscendant(e))}getLocalCoordinates(e){const t=pe.Zero();return this.getLocalCoordinatesToRef(e,t),t}getLocalCoordinatesToRef(e,t){return t.x=e.x-this._currentMeasure.left,t.y=e.y-this._currentMeasure.top,this}getParentLocalCoordinates(e){const t=pe.Zero();return t.x=e.x-this._cachedParentMeasure.left,t.y=e.y-this._cachedParentMeasure.top,t}moveToVector3(e,t){if(!this._host||this.parent!==this._host._rootContainer)return void Ot.Error("Cannot move a control to a vector3 if the control is not at root level");this.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,this.verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP;const i=this._host._getGlobalViewport(),s=me.Project(e,Te.IdentityReadOnly,t.getTransformMatrix(),i);this._moveToProjectedPosition(s),s.z<0||s.z>1?this.notRenderable=!0:this.notRenderable=!1}getDescendantsToRef(e,t=!1,i){}getDescendants(e,t){const i=[];return this.getDescendantsToRef(i,e,t),i}linkWithMesh(e){if(!this._host||this.parent&&this.parent!==this._host._rootContainer)return void(e&&Ot.Error("Cannot link a control to a mesh if the control is not at root level"));const t=this._host._linkedControls.indexOf(this);if(-1!==t)return this._linkedMesh=e,void(e||this._host._linkedControls.splice(t,1));e&&(this.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,this.verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP,this._linkedMesh=e,this._host._linkedControls.push(this))}setPadding(e,t,i,s){const n=e,r=null!=t?t:n,o=null!=i?i:n,a=null!=s?s:r;this.paddingTop=n,this.paddingRight=r,this.paddingBottom=o,this.paddingLeft=a}setPaddingInPixels(e,t,i,s){const n=e,r=null!=t?t:n,o=null!=i?i:n,a=null!=s?s:r;this.paddingTopInPixels=n,this.paddingRightInPixels=r,this.paddingBottomInPixels=o,this.paddingLeftInPixels=a}_moveToProjectedPosition(e){var t;const i=this._left.getValue(this._host),s=this._top.getValue(this._host),n=null===(t=this.parent)||void 0===t?void 0:t._currentMeasure;n&&this._processMeasures(n,this._host.getContext());let r=e.x+this._linkOffsetX.getValue(this._host)-this._currentMeasure.width/2,o=e.y+this._linkOffsetY.getValue(this._host)-this._currentMeasure.height/2;const a=this._left.ignoreAdaptiveScaling&&this._top.ignoreAdaptiveScaling;a&&(Math.abs(r-i)<.5&&(r=i),Math.abs(o-s)<.5&&(o=s)),(a||i!==r||s!==o)&&(this.left=r+"px",this.top=o+"px",this._left.ignoreAdaptiveScaling=!0,this._top.ignoreAdaptiveScaling=!0,this._markAsDirty())}_offsetLeft(e){this._isDirty=!0,this._currentMeasure.left+=e}_offsetTop(e){this._isDirty=!0,this._currentMeasure.top+=e}_markMatrixAsDirty(){this._isMatrixDirty=!0,this._flagDescendantsAsMatrixDirty()}_flagDescendantsAsMatrixDirty(){}_intersectsRect(e,t){return this._transform(t),!(this._evaluatedMeasure.left>=e.left+e.width||this._evaluatedMeasure.top>=e.top+e.height||this._evaluatedMeasure.left+this._evaluatedMeasure.width<=e.left||this._evaluatedMeasure.top+this._evaluatedMeasure.height<=e.top)}_computeAdditionalOffsetX(){return 0}_computeAdditionalOffsetY(){return 0}invalidateRect(){if(this._transform(),this.host&&this.host.useInvalidateRectOptimization){this._currentMeasure.transformToRef(this._transformMatrix,this._tmpMeasureA),Dd.CombineToRef(this._tmpMeasureA,this._prevCurrentMeasureTransformedIntoGlobalSpace,this._tmpMeasureA);const e=this.shadowOffsetX,t=this.shadowOffsetY,i=Math.max(this._previousShadowBlur,this.shadowBlur),s=Math.min(Math.min(e,0)-2*i,0),n=Math.max(Math.max(e,0)+2*i,0),r=Math.min(Math.min(t,0)-2*i,0),o=Math.max(Math.max(t,0)+2*i,0),a=this._computeAdditionalOffsetX(),l=this._computeAdditionalOffsetY();this.host.invalidateRect(Math.floor(this._tmpMeasureA.left+s-a),Math.floor(this._tmpMeasureA.top+r-l),Math.ceil(this._tmpMeasureA.left+this._tmpMeasureA.width+n+a),Math.ceil(this._tmpMeasureA.top+this._tmpMeasureA.height+o+l))}}_markAsDirty(e=!1){(this._isVisible||e)&&(this._isDirty=!0,this._markMatrixAsDirty(),this._host&&this._host.markAsDirty())}_markAllAsDirty(){this._markAsDirty(),this._font&&this._prepareFont()}_link(e){this._host=e,this._host&&(this.uniqueId=this._host.getScene().getUniqueId())}_transform(e){if(!this._isMatrixDirty&&1===this._scaleX&&1===this._scaleY&&0===this._rotation)return;const t=this._currentMeasure.width*this._transformCenterX+this._currentMeasure.left,i=this._currentMeasure.height*this._transformCenterY+this._currentMeasure.top;e&&(e.translate(t,i),e.rotate(this._rotation),e.scale(this._scaleX,this._scaleY),e.translate(-t,-i)),(this._isMatrixDirty||this._cachedOffsetX!==t||this._cachedOffsetY!==i)&&(this._cachedOffsetX=t,this._cachedOffsetY=i,this._isMatrixDirty=!1,this._flagDescendantsAsMatrixDirty(),Fd.ComposeToRef(-t,-i,this._rotation,this._scaleX,this._scaleY,this.parent?this.parent._transformMatrix:null,this._transformMatrix),this._transformMatrix.invertToRef(this._invertTransformMatrix),this._currentMeasure.transformToRef(this._transformMatrix,this._evaluatedMeasure))}_renderHighlight(e){this.isHighlighted&&(e.save(),e.strokeStyle=this._highlightColor,e.lineWidth=this._highlightLineWidth,this._renderHighlightSpecific(e),e.restore())}_renderHighlightSpecific(e){e.strokeRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)}_getColor(e){return this.gradient?this.gradient.getCanvasGradient(e):this.color}_applyStates(e){this._isFontSizeInPercentage&&(this._fontSet=!0),this._host&&this._host.useSmallestIdeal&&!this._font&&(this._fontSet=!0),this._fontSet&&(this._prepareFont(),this._fontSet=!1),this._font&&(e.font=this._font),(this._color||this.gradient)&&(e.fillStyle=this._getColor(e)),wd.AllowAlphaInheritance?e.globalAlpha*=this._alpha:this._alphaSet&&(e.globalAlpha=this.parent&&!this.parent.renderToIntermediateTexture?this.parent.alpha*this._alpha:this._alpha)}_layout(e,t){if(!this.isDirty&&(!this.isVisible||this.notRenderable))return!1;if(this._isDirty||!this._cachedParentMeasure.isEqualsTo(e)){this.host._numLayoutCalls++,this._currentMeasure.addAndTransformToRef(this._transformMatrix,0|-this._paddingLeftInPixels,0|-this._paddingTopInPixels,0|this._paddingRightInPixels,0|this._paddingBottomInPixels,this._prevCurrentMeasureTransformedIntoGlobalSpace),t.save(),this._applyStates(t);let i=0;do{this._rebuildLayout=!1,this._processMeasures(e,t),i++}while(this._rebuildLayout&&i<3);i>=3&&p.Error(`Layout cycle detected in GUI (Control name=${this.name}, uniqueId=${this.uniqueId})`),t.restore(),this.invalidateRect(),this._evaluateClippingState(e)}return this._wasDirty=this._isDirty,this._isDirty=!1,!0}_processMeasures(e,t){this._tempPaddingMeasure.copyFrom(e),this.parent&&this.parent.descendantsOnlyPadding&&(this._tempPaddingMeasure.left+=this.parent.paddingLeftInPixels,this._tempPaddingMeasure.top+=this.parent.paddingTopInPixels,this._tempPaddingMeasure.width-=this.parent.paddingLeftInPixels+this.parent.paddingRightInPixels,this._tempPaddingMeasure.height-=this.parent.paddingTopInPixels+this.parent.paddingBottomInPixels),this._currentMeasure.copyFrom(this._tempPaddingMeasure),this._preMeasure(this._tempPaddingMeasure,t),this._measure(),this._postMeasure(this._tempPaddingMeasure,t),this._computeAlignment(this._tempPaddingMeasure,t),this._currentMeasure.left=0|this._currentMeasure.left,this._currentMeasure.top=0|this._currentMeasure.top,this._currentMeasure.width=0|this._currentMeasure.width,this._currentMeasure.height=0|this._currentMeasure.height,this._additionalProcessing(this._tempPaddingMeasure,t),this._cachedParentMeasure.copyFrom(this._tempPaddingMeasure),this._currentMeasure.transformToRef(this._transformMatrix,this._evaluatedMeasure),this.onDirtyObservable.hasObservers()&&this.onDirtyObservable.notifyObservers(this)}_evaluateClippingState(e){if(this._transform(),this._currentMeasure.transformToRef(this._transformMatrix,this._evaluatedMeasure),this.parent&&this.parent.clipChildren){if(e.transformToRef(this.parent._transformMatrix,this._evaluatedParentMeasure),this._evaluatedMeasure.left>this._evaluatedParentMeasure.left+this._evaluatedParentMeasure.width)return void(this._isClipped=!0);if(this._evaluatedMeasure.left+this._evaluatedMeasure.width<this._evaluatedParentMeasure.left)return void(this._isClipped=!0);if(this._evaluatedMeasure.top>this._evaluatedParentMeasure.top+this._evaluatedParentMeasure.height)return void(this._isClipped=!0);if(this._evaluatedMeasure.top+this._evaluatedMeasure.height<this._evaluatedParentMeasure.top)return void(this._isClipped=!0)}this._isClipped=!1}_measure(){this._width.isPixel?this._currentMeasure.width=this._width.getValue(this._host):this._currentMeasure.width*=this._width.getValue(this._host),this._height.isPixel?this._currentMeasure.height=this._height.getValue(this._host):this._currentMeasure.height*=this._height.getValue(this._host),0!==this._fixedRatio&&(this._fixedRatioMasterIsWidth?this._currentMeasure.height=this._currentMeasure.width*this._fixedRatio:this._currentMeasure.width=this._currentMeasure.height*this._fixedRatio)}_computeAlignment(e,t){const i=this._currentMeasure.width,s=this._currentMeasure.height,n=e.width,r=e.height;let o=0,a=0;switch(this.horizontalAlignment){case wd.HORIZONTAL_ALIGNMENT_LEFT:o=0;break;case wd.HORIZONTAL_ALIGNMENT_RIGHT:o=n-i;break;case wd.HORIZONTAL_ALIGNMENT_CENTER:o=(n-i)/2}switch(this.verticalAlignment){case wd.VERTICAL_ALIGNMENT_TOP:a=0;break;case wd.VERTICAL_ALIGNMENT_BOTTOM:a=r-s;break;case wd.VERTICAL_ALIGNMENT_CENTER:a=(r-s)/2}this.descendantsOnlyPadding||(this._paddingLeft.isPixel?(this._currentMeasure.left+=this._paddingLeft.getValue(this._host),this._currentMeasure.width-=this._paddingLeft.getValue(this._host)):(this._currentMeasure.left+=n*this._paddingLeft.getValue(this._host),this._currentMeasure.width-=n*this._paddingLeft.getValue(this._host)),this._paddingRight.isPixel?this._currentMeasure.width-=this._paddingRight.getValue(this._host):this._currentMeasure.width-=n*this._paddingRight.getValue(this._host),this._paddingTop.isPixel?(this._currentMeasure.top+=this._paddingTop.getValue(this._host),this._currentMeasure.height-=this._paddingTop.getValue(this._host)):(this._currentMeasure.top+=r*this._paddingTop.getValue(this._host),this._currentMeasure.height-=r*this._paddingTop.getValue(this._host)),this._paddingBottom.isPixel?this._currentMeasure.height-=this._paddingBottom.getValue(this._host):this._currentMeasure.height-=r*this._paddingBottom.getValue(this._host)),this._left.isPixel?this._currentMeasure.left+=this._left.getValue(this._host):this._currentMeasure.left+=n*this._left.getValue(this._host),this._top.isPixel?this._currentMeasure.top+=this._top.getValue(this._host):this._currentMeasure.top+=r*this._top.getValue(this._host),this._currentMeasure.left+=o,this._currentMeasure.top+=a}_preMeasure(e,t){}_postMeasure(e,t){}_additionalProcessing(e,t){}_clipForChildren(e){}_clip(e,t){if(e.beginPath(),wd._ClipMeasure.copyFrom(this._currentMeasure),t){t.transformToRef(this._invertTransformMatrix,this._tmpMeasureA);const e=new Dd(0,0,0,0);e.left=Math.max(this._tmpMeasureA.left,this._currentMeasure.left),e.top=Math.max(this._tmpMeasureA.top,this._currentMeasure.top),e.width=Math.min(this._tmpMeasureA.left+this._tmpMeasureA.width,this._currentMeasure.left+this._currentMeasure.width)-e.left,e.height=Math.min(this._tmpMeasureA.top+this._tmpMeasureA.height,this._currentMeasure.top+this._currentMeasure.height)-e.top,wd._ClipMeasure.copyFrom(e)}if(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY){const t=this.shadowOffsetX,i=this.shadowOffsetY,s=this.shadowBlur,n=Math.min(Math.min(t,0)-2*s,0),r=Math.max(Math.max(t,0)+2*s,0),o=Math.min(Math.min(i,0)-2*s,0),a=Math.max(Math.max(i,0)+2*s,0);e.rect(wd._ClipMeasure.left+n,wd._ClipMeasure.top+o,wd._ClipMeasure.width+r-n,wd._ClipMeasure.height+a-o)}else e.rect(wd._ClipMeasure.left,wd._ClipMeasure.top,wd._ClipMeasure.width,wd._ClipMeasure.height);e.clip()}_render(e,t){return!this.isVisible||this.notRenderable||this._isClipped?(this._isDirty=!1,!1):(this.host._numRenderCalls++,e.save(),this._applyStates(e),this._transform(e),this.clipContent&&this._clip(e,t),this.onBeforeDrawObservable.hasObservers()&&this.onBeforeDrawObservable.notifyObservers(this),this.useBitmapCache&&!this._wasDirty&&this._cacheData?e.putImageData(this._cacheData,this._currentMeasure.left,this._currentMeasure.top):this._draw(e,t),this.useBitmapCache&&this._wasDirty&&(this._cacheData=e.getImageData(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),this._renderHighlight(e),this.onAfterDrawObservable.hasObservers()&&this.onAfterDrawObservable.notifyObservers(this),e.restore(),!0)}_draw(e,t){}contains(e,t){return this._invertTransformMatrix.transformCoordinates(e,t,this._transformedPosition),e=this._transformedPosition.x,t=this._transformedPosition.y,!(e<this._currentMeasure.left||e>this._currentMeasure.left+this._currentMeasure.width||t<this._currentMeasure.top||t>this._currentMeasure.top+this._currentMeasure.height||(this.isPointerBlocker&&(this._host._shouldBlockPointer=!0),0))}_processPicking(e,t,i,s,n,r,o,a){return!(!this._isEnabled||!this.isHitTestVisible||!this.isVisible||this._doNotRender||!this.contains(e,t)||(this._processObservables(s,e,t,i,n,r,o,a),0))}_onPointerMove(e,t,i,s){this.onPointerMoveObservable.notifyObservers(t,-1,e,this,s)&&null!=this.parent&&!this.isPointerBlocker&&this.parent._onPointerMove(e,t,i,s)}_onPointerEnter(e,t){return!!this._isEnabled&&(!(this._enterCount>0)&&(-1===this._enterCount&&(this._enterCount=0),this._enterCount++,this.onPointerEnterObservable.notifyObservers(this,-1,e,this,t)&&null!=this.parent&&!this.isPointerBlocker&&this.parent._onPointerEnter(e,t),!0))}_onPointerOut(e,t,i=!1){if(!(i||this._isEnabled&&e!==this))return;this._enterCount=0;let s=!0;e.isAscendant(this)||(s=this.onPointerOutObservable.notifyObservers(this,-1,e,this,t)),s&&null!=this.parent&&!this.isPointerBlocker&&this.parent._onPointerOut(e,t,i)}_onPointerDown(e,t,i,s,n){return this._onPointerEnter(this,n),0===this._downCount&&(this._downCount++,this._downPointerIds[i]=!0,this.onPointerDownObservable.notifyObservers(new Nd(t,s),-1,e,this,n)&&null!=this.parent&&!this.isPointerBlocker&&this.parent._onPointerDown(e,t,i,s,n),n&&this.uniqueId!==this._host.rootContainer.uniqueId&&this._host._capturedPointerIds.add(n.event.pointerId),!0)}_onPointerUp(e,t,i,s,n,r){if(!this._isEnabled)return;this._downCount=0,delete this._downPointerIds[i];let o=n;n&&(this._enterCount>0||-1===this._enterCount)&&(o=this.onPointerClickObservable.notifyObservers(new Nd(t,s),-1,e,this,r)),this.onPointerUpObservable.notifyObservers(new Nd(t,s),-1,e,this,r)&&null!=this.parent&&!this.isPointerBlocker&&this.parent._onPointerUp(e,t,i,s,o,r),r&&this.uniqueId!==this._host.rootContainer.uniqueId&&this._host._capturedPointerIds.delete(r.event.pointerId)}_forcePointerUp(e=null){if(null!==e)this._onPointerUp(this,pe.Zero(),e,0,!0);else for(const e in this._downPointerIds)this._onPointerUp(this,pe.Zero(),+e,0,!0)}_onWheelScroll(e,t){this._isEnabled&&this.onWheelObservable.notifyObservers(new pe(e,t))&&null!=this.parent&&this.parent._onWheelScroll(e,t)}_onCanvasBlur(){}_processObservables(e,t,i,s,n,r,o,a){if(!this._isEnabled)return!1;if(this._dummyVector2.copyFromFloats(t,i),e===ci.POINTERMOVE){this._onPointerMove(this,this._dummyVector2,n,s);const e=this._host._lastControlOver[n];return e&&e!==this&&e._onPointerOut(this,s),e!==this&&this._onPointerEnter(this,s),this._host._lastControlOver[n]=this,!0}return e===ci.POINTERDOWN?(this._onPointerDown(this,this._dummyVector2,n,r,s),this._host._registerLastControlDown(this,n),this._host._lastPickedControl=this,!0):e===ci.POINTERUP?(this._host._lastControlDown[n]&&this._host._lastControlDown[n]._onPointerUp(this,this._dummyVector2,n,r,!0,s),delete this._host._lastControlDown[n],!0):!(e!==ci.POINTERWHEEL||!this._host._lastControlOver[n]||(this._host._lastControlOver[n]._onWheelScroll(o,a),0))}_getStyleProperty(e,t){var i;const s=null!==(i=this._style&&this._style[e])&&void 0!==i?i:this[e];return!s&&this.parent?this.parent._getStyleProperty(e,t):this.parent?s:t}_prepareFont(){(this._font||this._fontSet)&&(this._font=this._getStyleProperty("fontStyle","")+" "+this._getStyleProperty("fontWeight","")+" "+this.fontSizeInPixels+"px "+this._getStyleProperty("fontFamily","Arial"),this._fontOffset=wd._GetFontOffset(this._font),this.getDescendants().forEach((e=>e._markAllAsDirty())))}isDimensionFullyDefined(e){return this.getDimension(e).isPixel}getDimension(e){return"width"===e?this._width:this._height}clone(e){const t={};this.serialize(t);const i=new(Ot.Instantiate("BABYLON.GUI."+t.className));return i.parse(t,e),i}parse(e,t){return qe.Parse((()=>this),e,null),this.name=e.name,this._parseFromContent(e,null!=t?t:this._host),this}serialize(e){qe.Serialize(this,e),e.name=this.name,e.className=this.getClassName(),this._prepareFont(),this._font&&(e.fontFamily=this._fontFamily,e.fontSize=this.fontSize,e.fontWeight=this.fontWeight,e.fontStyle=this.fontStyle),this._gradient&&(e.gradient={},this._gradient.serialize(e.gradient)),qe.AppendSerializedAnimations(this,e)}_parseFromContent(e,t){var i,s;if(e.fontFamily&&(this.fontFamily=e.fontFamily),e.fontSize&&(this.fontSize=e.fontSize),e.fontWeight&&(this.fontWeight=e.fontWeight),e.fontStyle&&(this.fontStyle=e.fontStyle),e.gradient){const t=Ot.Instantiate("BABYLON.GUI."+e.gradient.className);this._gradient=new t,null===(i=this._gradient)||void 0===i||i.parse(e.gradient)}if(e.animations){this.animations=[];for(let t=0;t<e.animations.length;t++){const i=e.animations[t],s=_e("BABYLON.Animation");s&&this.animations.push(s.Parse(i))}e.autoAnimate&&this._host&&this._host.getScene()&&this._host.getScene().beginAnimation(this,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}this.fixedRatioMasterIsWidth=null!==(s=e.fixedRatioMasterIsWidth)&&void 0!==s?s:this.fixedRatioMasterIsWidth}dispose(){this.onDirtyObservable.clear(),this.onBeforeDrawObservable.clear(),this.onAfterDrawObservable.clear(),this.onPointerDownObservable.clear(),this.onPointerEnterObservable.clear(),this.onPointerMoveObservable.clear(),this.onPointerOutObservable.clear(),this.onPointerUpObservable.clear(),this.onPointerClickObservable.clear(),this.onWheelObservable.clear(),this._styleObserver&&this._style&&(this._style.onChangedObservable.remove(this._styleObserver),this._styleObserver=null),this.parent&&(this.parent.removeControl(this),this.parent=null),this._host&&this._host._linkedControls.indexOf(this)>-1&&this.linkWithMesh(null),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}static get HORIZONTAL_ALIGNMENT_LEFT(){return wd._HORIZONTAL_ALIGNMENT_LEFT}static get HORIZONTAL_ALIGNMENT_RIGHT(){return wd._HORIZONTAL_ALIGNMENT_RIGHT}static get HORIZONTAL_ALIGNMENT_CENTER(){return wd._HORIZONTAL_ALIGNMENT_CENTER}static get VERTICAL_ALIGNMENT_TOP(){return wd._VERTICAL_ALIGNMENT_TOP}static get VERTICAL_ALIGNMENT_BOTTOM(){return wd._VERTICAL_ALIGNMENT_BOTTOM}static get VERTICAL_ALIGNMENT_CENTER(){return wd._VERTICAL_ALIGNMENT_CENTER}static _GetFontOffset(e){if(wd._FontHeightSizes[e])return wd._FontHeightSizes[e];const t=u.LastCreatedEngine;if(!t)throw new Error("Invalid engine. Unable to create a canvas.");const i=t.getFontOffset(e);return wd._FontHeightSizes[e]=i,i}static Parse(e,t){const i=Ot.Instantiate("BABYLON.GUI."+e.className),s=qe.Parse((()=>new i),e,null);return s.name=e.name,s._parseFromContent(e,t),s}static drawEllipse(e,t,i,s,n){n.translate(e,t),n.scale(i,s),n.beginPath(),n.arc(0,0,1,0,2*Math.PI),n.closePath(),n.scale(1/i,1/s),n.translate(-e,-t)}isReady(){return!0}}wd.AllowAlphaInheritance=!1,wd._ClipMeasure=new Dd(0,0,0,0),wd._HORIZONTAL_ALIGNMENT_LEFT=0,wd._HORIZONTAL_ALIGNMENT_RIGHT=1,wd._HORIZONTAL_ALIGNMENT_CENTER=2,wd._VERTICAL_ALIGNMENT_TOP=0,wd._VERTICAL_ALIGNMENT_BOTTOM=1,wd._VERTICAL_ALIGNMENT_CENTER=2,wd._FontHeightSizes={},wd.AddHeader=()=>{},De([Ge()],wd.prototype,"metadata",void 0),De([Ge()],wd.prototype,"isHitTestVisible",void 0),De([Ge()],wd.prototype,"isPointerBlocker",void 0),De([Ge()],wd.prototype,"isFocusInvisible",void 0),De([Ge()],wd.prototype,"clipChildren",null),De([Ge()],wd.prototype,"clipContent",null),De([Ge()],wd.prototype,"useBitmapCache",void 0),De([Ge()],wd.prototype,"shadowOffsetX",null),De([Ge()],wd.prototype,"shadowOffsetY",null),De([Ge()],wd.prototype,"shadowBlur",null),De([Ge()],wd.prototype,"shadowColor",null),De([Ge()],wd.prototype,"hoverCursor",void 0),De([Ge()],wd.prototype,"fontOffset",null),De([Ge()],wd.prototype,"alpha",null),De([Ge()],wd.prototype,"scaleX",null),De([Ge()],wd.prototype,"scaleY",null),De([Ge()],wd.prototype,"rotation",null),De([Ge()],wd.prototype,"transformCenterY",null),De([Ge()],wd.prototype,"transformCenterX",null),De([Ge()],wd.prototype,"horizontalAlignment",null),De([Ge()],wd.prototype,"verticalAlignment",null),De([Ge()],wd.prototype,"fixedRatio",null),De([Ge()],wd.prototype,"fixedRatioMasterIsWidth",null),De([Ge()],wd.prototype,"width",null),De([Ge()],wd.prototype,"height",null),De([Ge()],wd.prototype,"style",null),De([Ge()],wd.prototype,"color",null),De([Ge()],wd.prototype,"gradient",null),De([Ge()],wd.prototype,"zIndex",null),De([Ge()],wd.prototype,"notRenderable",null),De([Ge()],wd.prototype,"isVisible",null),De([Ge()],wd.prototype,"descendantsOnlyPadding",null),De([Ge()],wd.prototype,"paddingLeft",null),De([Ge()],wd.prototype,"paddingRight",null),De([Ge()],wd.prototype,"paddingTop",null),De([Ge()],wd.prototype,"paddingBottom",null),De([Ge()],wd.prototype,"left",null),De([Ge()],wd.prototype,"top",null),De([Ge()],wd.prototype,"linkOffsetX",null),De([Ge()],wd.prototype,"linkOffsetY",null),De([Ge()],wd.prototype,"isEnabled",null),De([Ge()],wd.prototype,"disabledColor",null),De([Ge()],wd.prototype,"disabledColorItem",null),De([Ge()],wd.prototype,"overlapGroup",void 0),De([Ge()],wd.prototype,"overlapDeltaMultiplier",void 0),ue("BABYLON.GUI.Control",wd);class Bd extends wd{get renderToIntermediateTexture(){return this._renderToIntermediateTexture}set renderToIntermediateTexture(e){this._renderToIntermediateTexture!==e&&(this._renderToIntermediateTexture=e,this._markAsDirty())}get adaptHeightToChildren(){return this._adaptHeightToChildren}set adaptHeightToChildren(e){this._adaptHeightToChildren!==e&&(this._adaptHeightToChildren=e,e&&(this.height="100%"),this._markAsDirty())}get adaptWidthToChildren(){return this._adaptWidthToChildren}set adaptWidthToChildren(e){this._adaptWidthToChildren!==e&&(this._adaptWidthToChildren=e,e&&(this.width="100%"),this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get backgroundGradient(){return this._backgroundGradient}set backgroundGradient(e){this._backgroundGradient!==e&&(this._backgroundGradient=e,this._markAsDirty())}get children(){return this._children}get isReadOnly(){return this._isReadOnly}set isReadOnly(e){this._isReadOnly=e;for(const t of this._children)t.isReadOnly=e}constructor(e){super(e),this.name=e,this._children=new Array,this._measureForChildren=Dd.Empty(),this._background="",this._backgroundGradient=null,this._adaptWidthToChildren=!1,this._adaptHeightToChildren=!1,this._renderToIntermediateTexture=!1,this._intermediateTexture=null,this.logLayoutCycleErrors=!1,this.maxLayoutCycle=3,this.onControlAddedObservable=new s,this.onControlRemovedObservable=new s,this._inverseTransformMatrix=Fd.Identity(),this._inverseMeasure=new Dd(0,0,0,0)}_getTypeName(){return"Container"}_flagDescendantsAsMatrixDirty(){for(const e of this.children)e._isClipped=!1,e._markMatrixAsDirty()}getChildByName(e){for(const t of this.children)if(t.name===e)return t;return null}getChildByType(e,t){for(const e of this.children)if(e.typeName===t)return e;return null}containsControl(e){return-1!==this.children.indexOf(e)}addControl(e){return e?(-1!==this._children.indexOf(e)||(e._link(this._host),e._markAllAsDirty(),this._reOrderControl(e),this._markAsDirty(),this.onControlAddedObservable.notifyObservers(e)),this):this}clearControls(){const e=this.children.slice();for(const t of e)this.removeControl(t);return this}removeControl(e){const t=this._children.indexOf(e);return-1!==t&&(this._children.splice(t,1),e.parent=null),e.linkWithMesh(null),this._host&&this._host._cleanControlAfterRemoval(e),this._markAsDirty(),this.onControlRemovedObservable.notifyObservers(e),this}_reOrderControl(e){const t=e.linkedMesh;this.removeControl(e);let i=!1;for(let t=0;t<this._children.length;t++)if(this._children[t].zIndex>e.zIndex){this._children.splice(t,0,e),i=!0;break}i||this._children.push(e),e.parent=this,t&&e.linkWithMesh(t),this._markAsDirty()}_offsetLeft(e){super._offsetLeft(e);for(const t of this._children)t._offsetLeft(e)}_offsetTop(e){super._offsetTop(e);for(const t of this._children)t._offsetTop(e)}_markAllAsDirty(){super._markAllAsDirty();for(let e=0;e<this._children.length;e++)this._children[e]._markAllAsDirty()}_getBackgroundColor(e){return this._backgroundGradient?this._backgroundGradient.getCanvasGradient(e):this._background}_localDraw(e){(this._background||this._backgroundGradient)&&(e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),e.fillStyle=this._getBackgroundColor(e),e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height),e.restore())}_link(e){super._link(e);for(const t of this._children)t._link(e)}_beforeLayout(){}_processMeasures(e,t){!this._isDirty&&this._cachedParentMeasure.isEqualsTo(e)||(super._processMeasures(e,t),this._evaluateClippingState(e),this._renderToIntermediateTexture&&(this._intermediateTexture&&this._host.getScene()!=this._intermediateTexture.getScene()&&(this._intermediateTexture.dispose(),this._intermediateTexture=null),this._intermediateTexture?this._intermediateTexture.scaleTo(this._currentMeasure.width,this._currentMeasure.height):(this._intermediateTexture=new ho("",{width:this._currentMeasure.width,height:this._currentMeasure.height},this._host.getScene(),!1,zi.NEAREST_SAMPLINGMODE,Dh.TEXTUREFORMAT_RGBA,!1),this._intermediateTexture.hasAlpha=!0)))}_layout(e,t){var i,s;if(!this.isDirty&&(!this.isVisible||this.notRenderable))return!1;this.host._numLayoutCalls++,this._isDirty&&this._currentMeasure.transformToRef(this._transformMatrix,this._prevCurrentMeasureTransformedIntoGlobalSpace);let n=0;t.save(),this._applyStates(t),this._beforeLayout();do{let r=-1,o=-1;if(this._rebuildLayout=!1,this._processMeasures(e,t),!this._isClipped){for(const e of this._children)e._tempParentMeasure.copyFrom(this._measureForChildren),e._layout(this._measureForChildren,t)&&e.isVisible&&!e.notRenderable&&(this.adaptWidthToChildren&&e._width.isPixel&&(r=Math.max(r,e._currentMeasure.width+e._paddingLeftInPixels+e._paddingRightInPixels)),this.adaptHeightToChildren&&e._height.isPixel&&(o=Math.max(o,e._currentMeasure.height+e._paddingTopInPixels+e._paddingBottomInPixels)));this.adaptWidthToChildren&&r>=0&&(r+=this.paddingLeftInPixels+this.paddingRightInPixels,this.width!==r+"px"&&(null===(i=this.parent)||void 0===i||i._markAsDirty(),this.width=r+"px",this._width.ignoreAdaptiveScaling=!0,this._rebuildLayout=!0)),this.adaptHeightToChildren&&o>=0&&(o+=this.paddingTopInPixels+this.paddingBottomInPixels,this.height!==o+"px"&&(null===(s=this.parent)||void 0===s||s._markAsDirty(),this.height=o+"px",this._height.ignoreAdaptiveScaling=!0,this._rebuildLayout=!0)),this._postMeasure()}n++}while(this._rebuildLayout&&n<this.maxLayoutCycle);return n>=3&&this.logLayoutCycleErrors&&p.Error(`Layout cycle detected in GUI (Container name=${this.name}, uniqueId=${this.uniqueId})`),t.restore(),this._isDirty&&(this.invalidateRect(),this._isDirty=!1),!0}_postMeasure(){}_draw(e,t){const i=this._renderToIntermediateTexture&&this._intermediateTexture,s=i?this._intermediateTexture.getContext():e;i&&(s.save(),s.translate(-this._currentMeasure.left,-this._currentMeasure.top),t?(this._transformMatrix.invertToRef(this._inverseTransformMatrix),t.transformToRef(this._inverseTransformMatrix,this._inverseMeasure),s.clearRect(this._inverseMeasure.left,this._inverseMeasure.top,this._inverseMeasure.width,this._inverseMeasure.height)):s.clearRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),this._localDraw(s),e.save(),this.clipChildren&&this._clipForChildren(s);for(const e of this._children)t&&!e._intersectsRect(t)||e._render(s,t);i&&(s.restore(),e.save(),e.globalAlpha=this.alpha,e.drawImage(s.canvas,this._currentMeasure.left,this._currentMeasure.top),e.restore()),e.restore()}getDescendantsToRef(e,t=!1,i){if(this.children)for(let s=0;s<this.children.length;s++){const n=this.children[s];i&&!i(n)||e.push(n),t||n.getDescendantsToRef(e,!1,i)}}_processPicking(e,t,i,s,n,r,o,a){if(!this._isEnabled||!this.isVisible||this.notRenderable)return!1;const l=super.contains(e,t);if(!l&&this.clipChildren)return!1;for(let l=this._children.length-1;l>=0;l--){const h=this._children[l];if(h._processPicking(e,t,i,s,n,r,o,a))return h.hoverCursor&&this._host._changeCursor(h.hoverCursor),!0}return!!l&&!!this.isHitTestVisible&&this._processObservables(s,e,t,i,n,r,o,a)}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.copyFrom(this._currentMeasure)}_getAdaptDimTo(e){return"width"===e?this.adaptWidthToChildren:this.adaptHeightToChildren}isDimensionFullyDefined(e){if(this._getAdaptDimTo(e)){for(const t of this.children)if(!t.isDimensionFullyDefined(e))return!1;return!0}return super.isDimensionFullyDefined(e)}serialize(e){if(super.serialize(e),this.backgroundGradient&&(e.backgroundGradient={},this.backgroundGradient.serialize(e.backgroundGradient)),this.children.length){e.children=[];for(const t of this.children){const i={};t.serialize(i),e.children.push(i)}}}dispose(){var e;super.dispose();for(let e=this.children.length-1;e>=0;e--)this.children[e].dispose();null===(e=this._intermediateTexture)||void 0===e||e.dispose()}_parseFromContent(e,t){var i;if(super._parseFromContent(e,t),this._link(t),e.backgroundGradient){const t=Ot.Instantiate("BABYLON.GUI."+e.backgroundGradient.className);this._backgroundGradient=new t,null===(i=this._backgroundGradient)||void 0===i||i.parse(e.backgroundGradient)}if(e.children)for(const i of e.children)this.addControl(wd.Parse(i,t))}isReady(){for(const e of this.children)if(!e.isReady())return!1;return!0}}De([Ge()],Bd.prototype,"renderToIntermediateTexture",null),De([Ge()],Bd.prototype,"maxLayoutCycle",void 0),De([Ge()],Bd.prototype,"adaptHeightToChildren",null),De([Ge()],Bd.prototype,"adaptWidthToChildren",null),De([Ge()],Bd.prototype,"background",null),De([Ge()],Bd.prototype,"backgroundGradient",null),ue("BABYLON.GUI.Container",Bd);class Ud extends Bd{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get cornerRadius(){return this._cornerRadius[0]}set cornerRadius(e){e<0&&(e=0),this._cornerRadius[0]===e&&this._cornerRadius[1]===e&&this._cornerRadius[2]===e&&this._cornerRadius[3]===e||(this._cornerRadius[0]=this._cornerRadius[1]=this._cornerRadius[2]=this._cornerRadius[3]=e,this._markAsDirty())}get cornerRadiusX(){return this._cornerRadius[0]}set cornerRadiusX(e){this._cornerRadius[0]!==e&&(this._cornerRadius[0]=e)}get cornerRadiusY(){return this._cornerRadius[1]}set cornerRadiusY(e){this._cornerRadius[1]!==e&&(this._cornerRadius[1]=e)}get cornerRadiusZ(){return this._cornerRadius[2]}set cornerRadiusZ(e){this._cornerRadius[2]!==e&&(this._cornerRadius[2]=e)}get cornerRadiusW(){return this._cornerRadius[3]}set cornerRadiusW(e){this._cornerRadius[3]!==e&&(this._cornerRadius[3]=e)}constructor(e){super(e),this.name=e,this._thickness=1,this._cornerRadius=[0,0,0,0],this._cachedRadius=[0,0,0,0]}_getTypeName(){return"Rectangle"}_computeAdditionalOffsetX(){let e=0;return 0===this._cornerRadius[0]&&0===this._cornerRadius[1]&&0===this._cornerRadius[2]&&0===this._cornerRadius[3]||(e+=1),this.thickness&&(e+=this.thickness/2),e}_computeAdditionalOffsetY(){let e=0;return 0===this._cornerRadius[0]&&0===this._cornerRadius[1]&&0===this._cornerRadius[2]&&0===this._cornerRadius[3]||(e+=1),this.thickness&&(e+=this.thickness/2),e}_getRectangleFill(e){return this._getBackgroundColor(e)}_localDraw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),(this._background||this._backgroundGradient)&&(e.fillStyle=this._getRectangleFill(e),0!==this._cornerRadius[0]||0!==this._cornerRadius[1]||0!==this._cornerRadius[2]||0!==this._cornerRadius[3]?(this._drawRoundedRect(e,this._thickness/2),e.fill()):e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),this._thickness&&((this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),(this.color||this.gradient)&&(e.strokeStyle=this.gradient?this.gradient.getCanvasGradient(e):this.color),e.lineWidth=this._thickness,0!==this._cornerRadius[0]||0!==this._cornerRadius[1]||0!==this._cornerRadius[2]||0!==this._cornerRadius[3]?(this._drawRoundedRect(e,this._thickness/2),e.stroke()):e.strokeRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,this._currentMeasure.width-this._thickness,this._currentMeasure.height-this._thickness)),e.restore()}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.width-=2*this._thickness,this._measureForChildren.height-=2*this._thickness,this._measureForChildren.left+=this._thickness,this._measureForChildren.top+=this._thickness}_drawRoundedRect(e,t=0){const i=this._currentMeasure.left+t,s=this._currentMeasure.top+t,n=this._currentMeasure.width-2*t,r=this._currentMeasure.height-2*t;for(let e=0;e<this._cornerRadius.length;e++)this._cachedRadius[e]=Math.abs(Math.min(r/2,Math.min(n/2,this._cornerRadius[e])));e.beginPath(),e.moveTo(i+this._cachedRadius[0],s),e.lineTo(i+n-this._cachedRadius[1],s),e.arc(i+n-this._cachedRadius[1],s+this._cachedRadius[1],this._cachedRadius[1],3*Math.PI/2,2*Math.PI),e.lineTo(i+n,s+r-this._cachedRadius[2]),e.arc(i+n-this._cachedRadius[2],s+r-this._cachedRadius[2],this._cachedRadius[2],0,Math.PI/2),e.lineTo(i+this._cachedRadius[3],s+r),e.arc(i+this._cachedRadius[3],s+r-this._cachedRadius[3],this._cachedRadius[3],Math.PI/2,Math.PI),e.lineTo(i,s+this._cachedRadius[0]),e.arc(i+this._cachedRadius[0],s+this._cachedRadius[0],this._cachedRadius[0],Math.PI,3*Math.PI/2),e.closePath()}_clipForChildren(e){0===this._cornerRadius[0]&&0===this._cornerRadius[1]&&0===this._cornerRadius[2]&&0===this._cornerRadius[3]||(this._drawRoundedRect(e,this._thickness),e.clip())}}var kd;De([Ge()],Ud.prototype,"thickness",null),De([Ge()],Ud.prototype,"cornerRadius",null),De([Ge()],Ud.prototype,"cornerRadiusX",null),De([Ge()],Ud.prototype,"cornerRadiusY",null),De([Ge()],Ud.prototype,"cornerRadiusZ",null),De([Ge()],Ud.prototype,"cornerRadiusW",null),ue("BABYLON.GUI.Rectangle",Ud),function(e){e[e.Clip=0]="Clip",e[e.WordWrap=1]="WordWrap",e[e.Ellipsis=2]="Ellipsis",e[e.WordWrapEllipsis=3]="WordWrapEllipsis"}(kd||(kd={}));class Vd extends wd{get lines(){return this._lines}get resizeToFit(){return this._resizeToFit}set resizeToFit(e){this._resizeToFit!==e&&(this._resizeToFit=e,this._resizeToFit&&(this._width.ignoreAdaptiveScaling=!0,this._height.ignoreAdaptiveScaling=!0),this._markAsDirty())}get textWrapping(){return this._textWrapping}set textWrapping(e){this._textWrapping!==e&&(this._textWrapping=+e,this._markAsDirty())}get text(){return this._text}set text(e){this._text!==e&&(this._text=e+"",this._markAsDirty(),this.onTextChangedObservable.notifyObservers(this))}get textHorizontalAlignment(){return this._textHorizontalAlignment}set textHorizontalAlignment(e){this._textHorizontalAlignment!==e&&(this._textHorizontalAlignment=e,this._markAsDirty())}get textVerticalAlignment(){return this._textVerticalAlignment}set textVerticalAlignment(e){this._textVerticalAlignment!==e&&(this._textVerticalAlignment=e,this._markAsDirty())}set lineSpacing(e){this._lineSpacing.fromString(e)&&this._markAsDirty()}get lineSpacing(){return this._lineSpacing.toString(this._host)}get outlineWidth(){return this._outlineWidth}set outlineWidth(e){this._outlineWidth!==e&&(this._outlineWidth=e,this._markAsDirty())}get underline(){return this._underline}set underline(e){this._underline!==e&&(this._underline=e,this._markAsDirty())}get lineThrough(){return this._lineThrough}set lineThrough(e){this._lineThrough!==e&&(this._lineThrough=e,this._markAsDirty())}get applyOutlineToUnderline(){return this._applyOutlineToUnderline}set applyOutlineToUnderline(e){this._applyOutlineToUnderline!==e&&(this._applyOutlineToUnderline=e,this._markAsDirty())}get outlineColor(){return this._outlineColor}set outlineColor(e){this._outlineColor!==e&&(this._outlineColor=e,this._markAsDirty())}get wordDivider(){return this._wordDivider}set wordDivider(e){this._wordDivider!==e&&(this._wordDivider=e,this._markAsDirty())}get forceResizeWidth(){return this._forceResizeWidth}set forceResizeWidth(e){this._forceResizeWidth!==e&&(this._forceResizeWidth=e,this._markAsDirty())}constructor(e,t=""){super(e),this.name=e,this._text="",this._textWrapping=kd.Clip,this._textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_CENTER,this._textVerticalAlignment=wd.VERTICAL_ALIGNMENT_CENTER,this._resizeToFit=!1,this._lineSpacing=new Rd(0),this._outlineWidth=0,this._outlineColor="white",this._underline=!1,this._lineThrough=!1,this._wordDivider=" ",this._forceResizeWidth=!1,this._applyOutlineToUnderline=!1,this.onTextChangedObservable=new s,this.onLinesReadyObservable=new s,this._linesTemp=[],this.text=t}_getTypeName(){return"TextBlock"}_processMeasures(e,t){this._fontOffset&&!this.isDirty||(this._fontOffset=wd._GetFontOffset(t.font)),super._processMeasures(e,t),this._lines=this._breakLines(this._currentMeasure.width,this._currentMeasure.height,t),this.onLinesReadyObservable.notifyObservers(this);let i=0;for(let e=0;e<this._lines.length;e++){const t=this._lines[e];t.width>i&&(i=t.width)}if(this._resizeToFit){if(this._textWrapping===kd.Clip||this._forceResizeWidth){const e=Math.ceil(this._paddingLeftInPixels)+Math.ceil(this._paddingRightInPixels)+Math.ceil(i);e!==this._width.getValueInPixel(this._host,this._tempParentMeasure.width)&&(this._width.updateInPlace(e,Rd.UNITMODE_PIXEL),this._rebuildLayout=!0)}let e=this._paddingTopInPixels+this._paddingBottomInPixels+this._fontOffset.height*this._lines.length|0;if(this._lines.length>0&&0!==this._lineSpacing.internalValue){let t=0;t=this._lineSpacing.isPixel?this._lineSpacing.getValue(this._host):this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height),e+=(this._lines.length-1)*t}e!==this._height.internalValue&&(this._height.updateInPlace(e,Rd.UNITMODE_PIXEL),this._rebuildLayout=!0)}}_drawText(e,t,i,s){const n=this._currentMeasure.width;let r=0;switch(this._textHorizontalAlignment){case wd.HORIZONTAL_ALIGNMENT_LEFT:r=0;break;case wd.HORIZONTAL_ALIGNMENT_RIGHT:r=n-t;break;case wd.HORIZONTAL_ALIGNMENT_CENTER:r=(n-t)/2}(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(s.shadowColor=this.shadowColor,s.shadowBlur=this.shadowBlur,s.shadowOffsetX=this.shadowOffsetX,s.shadowOffsetY=this.shadowOffsetY),this.outlineWidth&&s.strokeText(e,this._currentMeasure.left+r,i),s.fillText(e,this._currentMeasure.left+r,i),this._underline&&this._drawLine(this._currentMeasure.left+r,i+3,this._currentMeasure.left+r+t,i+3,s),this._lineThrough&&this._drawLine(this._currentMeasure.left+r,i-this.fontSizeInPixels/3,this._currentMeasure.left+r+t,i-this.fontSizeInPixels/3,s)}_drawLine(e,t,i,s,n){if(n.beginPath(),n.lineWidth=Math.round(.05*this.fontSizeInPixels),n.moveTo(e,t),n.lineTo(i,s),this.outlineWidth&&this.applyOutlineToUnderline)n.stroke(),n.fill();else{const e=n.strokeStyle;n.strokeStyle=n.fillStyle,n.stroke(),n.strokeStyle=e}n.closePath()}_draw(e){e.save(),this._applyStates(e),this._renderLines(e),e.restore()}_applyStates(e){super._applyStates(e),this.outlineWidth&&(e.lineWidth=this.outlineWidth,e.strokeStyle=this.outlineColor,e.lineJoin="miter",e.miterLimit=2)}_breakLines(e,t,i){this._linesTemp.length=0;const s=this.text.split("\n");if(this._textWrapping===kd.Ellipsis)for(const t of s)this._linesTemp.push(this._parseLineEllipsis(t,e,i));else if(this._textWrapping===kd.WordWrap)for(const t of s)this._linesTemp.push(...this._parseLineWordWrap(t,e,i));else if(this._textWrapping===kd.WordWrapEllipsis)for(const n of s)this._linesTemp.push(...this._parseLineWordWrapEllipsis(n,e,t,i));else for(const e of s)this._linesTemp.push(this._parseLine(e,i));return this._linesTemp}_parseLine(e="",t){return{text:e,width:this._getTextMetricsWidth(t.measureText(e))}}_getCharsToRemove(e,t,i){const s=e>t?e-t:0,n=e/i;return Math.max(Math.floor(s/n),1)}_parseLineEllipsis(e="",t,i){let s=this._getTextMetricsWidth(i.measureText(e)),n=this._getCharsToRemove(s,t,e.length);const r=Array.from&&Array.from(e);if(r)for(;r.length&&s>t;)r.splice(r.length-n,n),e=`${r.join("")}`,s=this._getTextMetricsWidth(i.measureText(e)),n=this._getCharsToRemove(s,t,e.length);else{for(;e.length>2&&s>t;)e=e.slice(0,-n),s=this._getTextMetricsWidth(i.measureText(e+"")),n=this._getCharsToRemove(s,t,e.length);e+=""}return{text:e,width:s}}_getTextMetricsWidth(e){return void 0!==e.actualBoundingBoxLeft?Math.abs(e.actualBoundingBoxLeft)+Math.abs(e.actualBoundingBoxRight):e.width}_parseLineWordWrap(e="",t,i){const s=[],n=this.wordSplittingFunction?this.wordSplittingFunction(e):e.split(this._wordDivider);let r=this._getTextMetricsWidth(i.measureText(e));for(let o=0;o<n.length;o++){const a=o>0?e+this._wordDivider+n[o]:n[0],l=this._getTextMetricsWidth(i.measureText(a));l>t&&o>0?(s.push({text:e,width:r}),e=n[o],r=this._getTextMetricsWidth(i.measureText(e))):(r=l,e=a)}return s.push({text:e,width:r}),s}_parseLineWordWrapEllipsis(e="",t,i,s){const n=this._parseLineWordWrap(e,t,s);for(let e=1;e<=n.length;e++)if(this._computeHeightForLinesOf(e)>i&&e>1){const i=n[e-2],r=n[e-1];n[e-2]=this._parseLineEllipsis(i.text+this._wordDivider+r.text,t,s);const o=n.length-e+1;for(let e=0;e<o;e++)n.pop();return n}return n}_renderLines(e){if(!this._fontOffset||!this._lines)return;const t=this._currentMeasure.height;let i=0;switch(this._textVerticalAlignment){case wd.VERTICAL_ALIGNMENT_TOP:i=this._fontOffset.ascent;break;case wd.VERTICAL_ALIGNMENT_BOTTOM:i=t-this._fontOffset.height*(this._lines.length-1)-this._fontOffset.descent;break;case wd.VERTICAL_ALIGNMENT_CENTER:i=this._fontOffset.ascent+(t-this._fontOffset.height*this._lines.length)/2}i+=this._currentMeasure.top;for(let t=0;t<this._lines.length;t++){const s=this._lines[t];0!==t&&0!==this._lineSpacing.internalValue&&(this._lineSpacing.isPixel?i+=this._lineSpacing.getValue(this._host):i+=this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height)),this._drawText(s.text,s.width,i,e),i+=this._fontOffset.height}}_computeHeightForLinesOf(e){let t=this._paddingTopInPixels+this._paddingBottomInPixels+this._fontOffset.height*e;if(e>0&&0!==this._lineSpacing.internalValue){let i=0;i=this._lineSpacing.isPixel?this._lineSpacing.getValue(this._host):this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height),t+=(e-1)*i}return t}isDimensionFullyDefined(e){return!!this.resizeToFit||super.isDimensionFullyDefined(e)}computeExpectedHeight(){var e;if(this.text&&this.widthInPixels){const t=null===(e=u.LastCreatedEngine)||void 0===e?void 0:e.createCanvas(0,0).getContext("2d");if(t){this._applyStates(t),this._fontOffset||(this._fontOffset=wd._GetFontOffset(t.font));const e=this._lines?this._lines:this._breakLines(this.widthInPixels-this._paddingLeftInPixels-this._paddingRightInPixels,this.heightInPixels-this._paddingTopInPixels-this._paddingBottomInPixels,t);return this._computeHeightForLinesOf(e.length)}}return 0}dispose(){super.dispose(),this.onTextChangedObservable.clear()}}De([Ge()],Vd.prototype,"resizeToFit",null),De([Ge()],Vd.prototype,"textWrapping",null),De([Ge()],Vd.prototype,"text",null),De([Ge()],Vd.prototype,"textHorizontalAlignment",null),De([Ge()],Vd.prototype,"textVerticalAlignment",null),De([Ge()],Vd.prototype,"lineSpacing",null),De([Ge()],Vd.prototype,"outlineWidth",null),De([Ge()],Vd.prototype,"underline",null),De([Ge()],Vd.prototype,"lineThrough",null),De([Ge()],Vd.prototype,"applyOutlineToUnderline",null),De([Ge()],Vd.prototype,"outlineColor",null),De([Ge()],Vd.prototype,"wordDivider",null),De([Ge()],Vd.prototype,"forceResizeWidth",null),ue("BABYLON.GUI.TextBlock",Vd);class Gd extends wd{get isLoaded(){return this._loaded}isReady(){return this.isLoaded}get detectPointerOnOpaqueOnly(){return this._detectPointerOnOpaqueOnly}set detectPointerOnOpaqueOnly(e){this._detectPointerOnOpaqueOnly!==e&&(this._detectPointerOnOpaqueOnly=e)}get sliceLeft(){return this._sliceLeft}set sliceLeft(e){this._sliceLeft!==e&&(this._sliceLeft=e,this._markAsDirty())}get sliceRight(){return this._sliceRight}set sliceRight(e){this._sliceRight!==e&&(this._sliceRight=e,this._markAsDirty())}get sliceTop(){return this._sliceTop}set sliceTop(e){this._sliceTop!==e&&(this._sliceTop=e,this._markAsDirty())}get sliceBottom(){return this._sliceBottom}set sliceBottom(e){this._sliceBottom!==e&&(this._sliceBottom=e,this._markAsDirty())}get sourceLeft(){return this._sourceLeft}set sourceLeft(e){this._sourceLeft!==e&&(this._sourceLeft=e,this._markAsDirty())}get sourceTop(){return this._sourceTop}set sourceTop(e){this._sourceTop!==e&&(this._sourceTop=e,this._markAsDirty())}get sourceWidth(){return this._sourceWidth}set sourceWidth(e){this._sourceWidth!==e&&(this._sourceWidth=e,this._markAsDirty())}get sourceHeight(){return this._sourceHeight}set sourceHeight(e){this._sourceHeight!==e&&(this._sourceHeight=e,this._markAsDirty())}get imageWidth(){return this._imageWidth}get imageHeight(){return this._imageHeight}get populateNinePatchSlicesFromImage(){return this._populateNinePatchSlicesFromImage}set populateNinePatchSlicesFromImage(e){this._populateNinePatchSlicesFromImage!==e&&(this._populateNinePatchSlicesFromImage=e,this._populateNinePatchSlicesFromImage&&this._loaded&&this._extractNinePatchSliceDataFromImage())}get isSVG(){return this._isSVG}get svgAttributesComputationCompleted(){return this._svgAttributesComputationCompleted}get autoScale(){return this._autoScale}set autoScale(e){this._autoScale!==e&&(this._autoScale=e,e&&this._loaded&&this.synchronizeSizeWithContent())}get stretch(){return this._stretch}set stretch(e){this._stretch!==e&&(this._stretch=e,this._markAsDirty())}_rotate90(e,t=!1){var i,s;const n=this._domImage.width,r=this._domImage.height,o=(null===(s=null===(i=this._host)||void 0===i?void 0:i.getScene())||void 0===s?void 0:s.getEngine())||u.LastCreatedEngine;if(!o)throw new Error("Invalid engine. Unable to create a canvas.");const a=o.createCanvas(r,n),l=a.getContext("2d");l.translate(a.width/2,a.height/2),l.rotate(e*Math.PI/2),l.drawImage(this._domImage,0,0,n,r,-n/2,-r/2,n,r);const h=a.toDataURL("image/jpg"),c=new Gd(this.name+"rotated",h);return t&&(c._stretch=this._stretch,c._autoScale=this._autoScale,c._cellId=this._cellId,c._cellWidth=e%1?this._cellHeight:this._cellWidth,c._cellHeight=e%1?this._cellWidth:this._cellHeight),this._handleRotationForSVGImage(this,c,e),this._imageDataCache.data=null,c}_handleRotationForSVGImage(e,t,i){e._isSVG&&(e._svgAttributesComputationCompleted?(this._rotate90SourceProperties(e,t,i),this._markAsDirty()):e.onSVGAttributesComputedObservable.addOnce((()=>{this._rotate90SourceProperties(e,t,i),this._markAsDirty()})))}_rotate90SourceProperties(e,t,i){let s=e.sourceLeft,n=e.sourceTop,r=e.domImage.width,o=e.domImage.height,a=s,l=n,h=e.sourceWidth,c=e.sourceHeight;if(0!=i){const e=i<0?-1:1;i%=4;for(let t=0;t<Math.abs(i);++t)a=-(n-o/2)*e+o/2,l=(s-r/2)*e+r/2,[h,c]=[c,h],i<0?l-=c:a-=h,s=a,n=l,[r,o]=[o,r]}t.sourceLeft=a,t.sourceTop=l,t.sourceWidth=h,t.sourceHeight=c}_extractNinePatchSliceDataFromImage(){var e,t;const i=this._domImage.width,s=this._domImage.height;if(!this._workingCanvas){const n=(null===(t=null===(e=this._host)||void 0===e?void 0:e.getScene())||void 0===t?void 0:t.getEngine())||u.LastCreatedEngine;if(!n)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=n.createCanvas(i,s)}const n=this._workingCanvas.getContext("2d");n.drawImage(this._domImage,0,0,i,s);const r=n.getImageData(0,0,i,s);this._sliceLeft=-1,this._sliceRight=-1;for(let e=0;e<i;e++){const t=r.data[4*e+3];if(t>127&&-1===this._sliceLeft)this._sliceLeft=e;else if(t<127&&this._sliceLeft>-1){this._sliceRight=e;break}}this._sliceTop=-1,this._sliceBottom=-1;for(let e=0;e<s;e++){const t=r.data[e*i*4+3];if(t>127&&-1===this._sliceTop)this._sliceTop=e;else if(t<127&&this._sliceTop>-1){this._sliceBottom=e;break}}}set domImage(e){this._domImage=e,this._loaded=!1,this._imageDataCache.data=null,this._domImage.width?this._onImageLoaded():this._domImage.onload=()=>{this._onImageLoaded()}}get domImage(){return this._domImage}_onImageLoaded(){this._imageDataCache.data=null,this._imageWidth=this._domImage.width,this._imageHeight=this._domImage.height,this._loaded=!0,this._populateNinePatchSlicesFromImage&&this._extractNinePatchSliceDataFromImage(),this._autoScale&&this.synchronizeSizeWithContent(),this.onImageLoadedObservable.notifyObservers(this),this._markAsDirty()}get source(){return this._source}static ResetImageCache(){Gd.SourceImgCache.clear()}_removeCacheUsage(e){const t=e&&Gd.SourceImgCache.get(e);t&&(t.timesUsed-=1,0===t.timesUsed&&Gd.SourceImgCache.delete(e))}set source(e){var t,i;if(this._source===e)return;this._removeCacheUsage(this._source),this._loaded=!1,this._source=e,this._imageDataCache.data=null,e&&(e=this._svgCheck(e));const s=(null===(i=null===(t=this._host)||void 0===t?void 0:t.getScene())||void 0===i?void 0:i.getEngine())||u.LastCreatedEngine;if(!s)throw new Error("Invalid engine. Unable to create a canvas.");if(e&&Gd.SourceImgCache.has(e)){const t=Gd.SourceImgCache.get(e);return this._domImage=t.img,t.timesUsed+=1,void(t.loaded?this._onImageLoaded():t.waitingForLoadCallback.push(this._onImageLoaded.bind(this)))}this._domImage=s.createCanvasImage(),e&&Gd.SourceImgCache.set(e,{img:this._domImage,timesUsed:1,loaded:!1,waitingForLoadCallback:[this._onImageLoaded.bind(this)]}),this._domImage.onload=()=>{if(e){const t=Gd.SourceImgCache.get(e);if(t){t.loaded=!0;for(const e of t.waitingForLoadCallback)e();return void(t.waitingForLoadCallback.length=0)}}this._onImageLoaded()},e&&(Ot.SetCorsBehavior(e,this._domImage),Ot.SetReferrerPolicyBehavior(this.referrerPolicy,this._domImage),this._domImage.src=e)}_svgCheck(e){if(window.SVGSVGElement&&-1!==e.search(/.svg#/gi)&&e.indexOf("#")===e.lastIndexOf("#")){this._isSVG=!0;const t=e.split("#")[0],i=e.split("#")[1],s=document.body.querySelector('object[data="'+t+'"]');if(s){const t=s.contentDocument;if(t&&t.documentElement){const n=t.documentElement.getAttribute("viewBox"),r=Number(t.documentElement.getAttribute("width")),o=Number(t.documentElement.getAttribute("height"));if(t.getElementById(i)&&n&&r&&o)return this._getSVGAttribs(s,i),e}s.addEventListener("load",(()=>{this._getSVGAttribs(s,i)}))}else{const e=document.createElement("object");e.data=t,e.type="image/svg+xml",e.width="0%",e.height="0%",document.body.appendChild(e),e.onload=()=>{const e=document.body.querySelector('object[data="'+t+'"]');e&&this._getSVGAttribs(e,i)}}return t}return e}_getSVGAttribs(e,t){const i=e.contentDocument;if(i&&i.documentElement){const e=i.documentElement.getAttribute("viewBox"),s=Number(i.documentElement.getAttribute("width")),n=Number(i.documentElement.getAttribute("height")),r=i.getElementById(t);if(e&&s&&n&&r){const t=Number(e.split(" ")[2]),i=Number(e.split(" ")[3]),o=r.getBBox();let a=1,l=1,h=0,c=0;const d=r.transform.baseVal.consolidate().matrix;r.transform&&r.transform.baseVal.consolidate()&&(a=d.a,l=d.d,h=d.e,c=d.f),this.sourceLeft=(a*o.x+h)*s/t,this.sourceTop=(l*o.y+c)*n/i,this.sourceWidth=o.width*a*(s/t),this.sourceHeight=o.height*l*(n/i),this._svgAttributesComputationCompleted=!0,this.onSVGAttributesComputedObservable.notifyObservers(this)}}}get cellWidth(){return this._cellWidth}set cellWidth(e){this._cellWidth!==e&&(this._cellWidth=e,this._markAsDirty())}get cellHeight(){return this._cellHeight}set cellHeight(e){this._cellHeight!==e&&(this._cellHeight=e,this._markAsDirty())}get cellId(){return this._cellId}set cellId(e){this._cellId!==e&&(this._cellId=e,this._markAsDirty())}constructor(e,t=null){super(e),this.name=e,this._workingCanvas=null,this._loaded=!1,this._stretch=Gd.STRETCH_FILL,this._autoScale=!1,this._sourceLeft=0,this._sourceTop=0,this._sourceWidth=0,this._sourceHeight=0,this._svgAttributesComputationCompleted=!1,this._isSVG=!1,this._cellWidth=0,this._cellHeight=0,this._cellId=-1,this._populateNinePatchSlicesFromImage=!1,this._imageDataCache={data:null,key:""},this.onImageLoadedObservable=new s,this.onSVGAttributesComputedObservable=new s,this.source=t}contains(e,t){if(!super.contains(e,t))return!1;if(!this._detectPointerOnOpaqueOnly||!this._workingCanvas)return!0;const i=0|this._currentMeasure.width,s=0|this._currentMeasure.height,n=i+"_"+s;let r=this._imageDataCache.data;if(!r||this._imageDataCache.key!==n){const e=this._workingCanvas.getContext("2d");this._imageDataCache.data=r=e.getImageData(0,0,i,s).data,this._imageDataCache.key=n}return r[4*((e=e-this._currentMeasure.left|0)+(t=t-this._currentMeasure.top|0)*i)+3]>0}_getTypeName(){return"Image"}synchronizeSizeWithContent(){this._loaded&&(this.width=this._domImage.width+"px",this.height=this._domImage.height+"px")}_processMeasures(e,t){if(this._loaded)switch(this._stretch){case Gd.STRETCH_NONE:case Gd.STRETCH_FILL:case Gd.STRETCH_UNIFORM:case Gd.STRETCH_NINE_PATCH:break;case Gd.STRETCH_EXTEND:this._autoScale&&this.synchronizeSizeWithContent(),this.parent&&this.parent.parent&&(this.parent.adaptWidthToChildren=!0,this.parent.adaptHeightToChildren=!0)}super._processMeasures(e,t)}_prepareWorkingCanvasForOpaqueDetection(){var e,t;if(!this._detectPointerOnOpaqueOnly)return;const i=this._currentMeasure.width,s=this._currentMeasure.height;if(!this._workingCanvas){const n=(null===(t=null===(e=this._host)||void 0===e?void 0:e.getScene())||void 0===t?void 0:t.getEngine())||u.LastCreatedEngine;if(!n)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=n.createCanvas(i,s)}this._workingCanvas.getContext("2d").clearRect(0,0,i,s)}_drawImage(e,t,i,s,n,r,o,a,l){if(e.drawImage(this._domImage,t,i,s,n,r,o,a,l),!this._detectPointerOnOpaqueOnly)return;const h=e.getTransform(),c=this._workingCanvas.getContext("2d");c.save();const d=r-this._currentMeasure.left,u=o-this._currentMeasure.top;c.setTransform(h.a,h.b,h.c,h.d,(d+a)/2,(u+l)/2),c.translate(-(d+a)/2,-(u+l)/2),c.drawImage(this._domImage,t,i,s,n,d,u,a,l),c.restore()}_draw(e){let t,i,s,n;if(e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),-1==this.cellId)t=this._sourceLeft,i=this._sourceTop,s=this._sourceWidth?this._sourceWidth:this._imageWidth,n=this._sourceHeight?this._sourceHeight:this._imageHeight;else{const e=this._domImage.naturalWidth/this.cellWidth,r=this.cellId/e>>0,o=this.cellId%e;t=this.cellWidth*o,i=this.cellHeight*r,s=this.cellWidth,n=this.cellHeight}if(this._prepareWorkingCanvasForOpaqueDetection(),this._applyStates(e),this._loaded)switch(this._stretch){case Gd.STRETCH_NONE:case Gd.STRETCH_FILL:this._drawImage(e,t,i,s,n,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height);break;case Gd.STRETCH_UNIFORM:{const r=this._currentMeasure.width/s,o=this._currentMeasure.height/n,a=Math.min(r,o),l=(this._currentMeasure.width-s*a)/2,h=(this._currentMeasure.height-n*a)/2;this._drawImage(e,t,i,s,n,this._currentMeasure.left+l,this._currentMeasure.top+h,s*a,n*a);break}case Gd.STRETCH_EXTEND:this._drawImage(e,t,i,s,n,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height);break;case Gd.STRETCH_NINE_PATCH:this._renderNinePatch(e,t,i,s,n)}e.restore()}_renderNinePatch(e,t,i,s,n){const r=this._sliceLeft,o=this._sliceTop,a=n-this._sliceBottom,l=s-this._sliceRight,h=this._sliceRight-this._sliceLeft,c=this._sliceBottom-this._sliceTop,d=this._currentMeasure.width-l-r+2,u=this._currentMeasure.height-a-o+2,_=this._currentMeasure.left+r-1,f=this._currentMeasure.top+o-1,p=this._currentMeasure.left+this._currentMeasure.width-l,m=this._currentMeasure.top+this._currentMeasure.height-a;this._drawImage(e,t,i,r,o,this._currentMeasure.left,this._currentMeasure.top,r,o),this._drawImage(e,t+this._sliceLeft,i,h,o,_+1,this._currentMeasure.top,d-2,o),this._drawImage(e,t+this._sliceRight,i,l,o,p,this._currentMeasure.top,l,o),this._drawImage(e,t,i+this._sliceTop,r,c,this._currentMeasure.left,f+1,r,u-2),this._drawImage(e,t+this._sliceLeft,i+this._sliceTop,h,c,_,f,d,u),this._drawImage(e,t+this._sliceRight,i+this._sliceTop,l,c,p,f+1,l,u-2),this._drawImage(e,t,i+this._sliceBottom,r,a,this._currentMeasure.left,m,r,a),this._drawImage(e,t+this.sliceLeft,i+this._sliceBottom,h,a,_+1,m,d-2,a),this._drawImage(e,t+this._sliceRight,i+this._sliceBottom,l,a,p,m,l,a)}dispose(){super.dispose(),this.onImageLoadedObservable.clear(),this.onSVGAttributesComputedObservable.clear(),this._removeCacheUsage(this._source)}}Gd.SourceImgCache=new Map,Gd.STRETCH_NONE=0,Gd.STRETCH_FILL=1,Gd.STRETCH_UNIFORM=2,Gd.STRETCH_EXTEND=3,Gd.STRETCH_NINE_PATCH=4,De([Ge()],Gd.prototype,"detectPointerOnOpaqueOnly",null),De([Ge()],Gd.prototype,"sliceLeft",null),De([Ge()],Gd.prototype,"sliceRight",null),De([Ge()],Gd.prototype,"sliceTop",null),De([Ge()],Gd.prototype,"sliceBottom",null),De([Ge()],Gd.prototype,"sourceLeft",null),De([Ge()],Gd.prototype,"sourceTop",null),De([Ge()],Gd.prototype,"sourceWidth",null),De([Ge()],Gd.prototype,"sourceHeight",null),De([Ge()],Gd.prototype,"populateNinePatchSlicesFromImage",null),De([Ge()],Gd.prototype,"autoScale",null),De([Ge()],Gd.prototype,"stretch",null),De([Ge()],Gd.prototype,"source",null),De([Ge()],Gd.prototype,"cellWidth",null),De([Ge()],Gd.prototype,"cellHeight",null),De([Ge()],Gd.prototype,"cellId",null),ue("BABYLON.GUI.Image",Gd);class zd extends Ud{get image(){return this._image}get textBlock(){return this._textBlock}constructor(e){super(e),this.name=e,this.delegatePickingToChildren=!1,this.thickness=1,this.isPointerBlocker=!0;let t=null;this.pointerEnterAnimation=()=>{t=this.alpha,this.alpha-=.1},this.pointerOutAnimation=()=>{null!==t&&(this.alpha=t)},this.pointerDownAnimation=()=>{this.scaleX-=.05,this.scaleY-=.05},this.pointerUpAnimation=()=>{this.scaleX+=.05,this.scaleY+=.05}}_getTypeName(){return"Button"}_processPicking(e,t,i,s,n,r,o,a){if(!this._isEnabled||!this.isHitTestVisible||!this.isVisible||this.notRenderable)return!1;if(!super.contains(e,t))return!1;if(this.delegatePickingToChildren){let i=!1;for(let s=this._children.length-1;s>=0;s--){const n=this._children[s];if(n.isEnabled&&n.isHitTestVisible&&n.isVisible&&!n.notRenderable&&n.contains(e,t)){i=!0;break}}if(!i)return!1}return this._processObservables(s,e,t,i,n,r,o,a),!0}_onPointerEnter(e,t){return!!super._onPointerEnter(e,t)&&(!this.isReadOnly&&this.pointerEnterAnimation&&this.pointerEnterAnimation(),!0)}_onPointerOut(e,t,i=!1){!this.isReadOnly&&this.pointerOutAnimation&&this.pointerOutAnimation(),super._onPointerOut(e,t,i)}_onPointerDown(e,t,i,s,n){return!!super._onPointerDown(e,t,i,s,n)&&(!this.isReadOnly&&this.pointerDownAnimation&&this.pointerDownAnimation(),!0)}_getRectangleFill(e){return this.isEnabled?this._getBackgroundColor(e):this._disabledColor}_onPointerUp(e,t,i,s,n,r){!this.isReadOnly&&this.pointerUpAnimation&&this.pointerUpAnimation(),super._onPointerUp(e,t,i,s,n,r)}serialize(e){super.serialize(e),this._textBlock&&(e.textBlockName=this._textBlock.name),this._image&&(e.imageName=this._image.name)}_parseFromContent(e,t){super._parseFromContent(e,t),e.textBlockName&&(this._textBlock=this.getChildByName(e.textBlockName)),e.imageName&&(this._image=this.getChildByName(e.imageName))}static CreateImageButton(e,t,i){const s=new this(e),n=new Vd(e+"_button",t);n.textWrapping=!0,n.textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_CENTER,n.paddingLeft="20%",s.addControl(n);const r=new Gd(e+"_icon",i);return r.width="20%",r.stretch=Gd.STRETCH_UNIFORM,r.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,s.addControl(r),s._image=r,s._textBlock=n,s}static CreateImageOnlyButton(e,t){const i=new this(e),s=new Gd(e+"_icon",t);return s.stretch=Gd.STRETCH_FILL,s.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,i.addControl(s),i._image=s,i}static CreateSimpleButton(e,t){const i=new this(e),s=new Vd(e+"_button",t);return s.textWrapping=!0,s.textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_CENTER,i.addControl(s),i._textBlock=s,i}static CreateImageWithCenterTextButton(e,t,i){const s=new this(e),n=new Gd(e+"_icon",i);n.stretch=Gd.STRETCH_FILL,s.addControl(n);const r=new Vd(e+"_button",t);return r.textWrapping=!0,r.textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_CENTER,s.addControl(r),s._image=n,s._textBlock=r,s}}ue("BABYLON.GUI.Button",zd);class Hd extends Bd{get isVertical(){return this._isVertical}set isVertical(e){this._isVertical!==e&&(this._isVertical=e,this._markAsDirty())}get spacing(){return this._spacing}set spacing(e){this._spacing!==e&&(this._spacing=e,this._markAsDirty())}set width(e){this._doNotTrackManualChanges||(this._manualWidth=!0),this._width.toString(this._host)!==e&&this._width.fromString(e)&&this._markAsDirty()}get width(){return this._width.toString(this._host)}set height(e){this._doNotTrackManualChanges||(this._manualHeight=!0),this._height.toString(this._host)!==e&&this._height.fromString(e)&&this._markAsDirty()}get height(){return this._height.toString(this._host)}constructor(e){super(e),this.name=e,this._isVertical=!0,this._manualWidth=!1,this._manualHeight=!1,this._doNotTrackManualChanges=!1,this._spacing=0,this.ignoreLayoutWarnings=!1}_getTypeName(){return"StackPanel"}_preMeasure(e,t){for(const e of this._children)this._isVertical?e.verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP:e.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT;super._preMeasure(e,t)}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.copyFrom(e),this._measureForChildren.left=this._currentMeasure.left,this._measureForChildren.top=this._currentMeasure.top,this.isVertical&&!this._manualWidth||(this._measureForChildren.width=this._currentMeasure.width),(this.isVertical||this._manualHeight)&&(this._measureForChildren.height=this._currentMeasure.height)}_postMeasure(){let e=0,t=0;const i=this._children.length;for(let s=0;s<i;s++){const n=this._children[s];n.isVisible&&!n.notRenderable&&(this._isVertical?(n.top!==t+"px"&&(n.top=t+"px",this._rebuildLayout=!0,n._top.ignoreAdaptiveScaling=!0),this.ignoreLayoutWarnings||n.isDimensionFullyDefined("height")?t+=n._currentMeasure.height+n._paddingTopInPixels+n._paddingBottomInPixels+(s<i-1?this._spacing:0):p.Warn(`Control (Name:${n.name}, UniqueId:${n.uniqueId}) is using height in percentage mode inside a vertical StackPanel`,1)):(n.left!==e+"px"&&(n.left=e+"px",this._rebuildLayout=!0,n._left.ignoreAdaptiveScaling=!0),this.ignoreLayoutWarnings||n.isDimensionFullyDefined("width")?e+=n._currentMeasure.width+n._paddingLeftInPixels+n._paddingRightInPixels+(s<i-1?this._spacing:0):p.Warn(`Control (Name:${n.name}, UniqueId:${n.uniqueId}) is using width in percentage mode inside a horizontal StackPanel`,1)))}e+=this._paddingLeftInPixels+this._paddingRightInPixels,t+=this._paddingTopInPixels+this._paddingBottomInPixels,this._doNotTrackManualChanges=!0;let s=!1,n=!1;if((!this._manualHeight||this.adaptHeightToChildren)&&this._isVertical){const e=this.height;this.height=t+"px",n=e!==this.height||!this._height.ignoreAdaptiveScaling}if((!this._manualWidth||this.adaptWidthToChildren)&&!this._isVertical){const t=this.width;this.width=e+"px",s=t!==this.width||!this._width.ignoreAdaptiveScaling}n&&(this._height.ignoreAdaptiveScaling=!0),s&&(this._width.ignoreAdaptiveScaling=!0),this._doNotTrackManualChanges=!1,(s||n)&&(this._rebuildLayout=!0),super._postMeasure()}_getManualDim(e){return"width"===e?this._manualWidth:this._manualHeight}isDimensionFullyDefined(e){if("height"===e?this.isVertical:!this.isVertical&&!this._getManualDim(e)){for(const t of this._children)if(!t.isDimensionFullyDefined(e))return!1;return!0}return this.getDimension(e).isPixel||this._getAdaptDimTo(e)}serialize(e){super.serialize(e),e.manualWidth=this._manualWidth,e.manualHeight=this._manualHeight}_parseFromContent(e,t){this._manualWidth=e.manualWidth,this._manualHeight=e.manualHeight,super._parseFromContent(e,t)}}De([Ge()],Hd.prototype,"ignoreLayoutWarnings",void 0),De([Ge()],Hd.prototype,"isVertical",null),De([Ge()],Hd.prototype,"spacing",null),De([Ge()],Hd.prototype,"width",null),De([Ge()],Hd.prototype,"height",null),ue("BABYLON.GUI.StackPanel",Hd);class Wd extends wd{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get checkSizeRatio(){return this._checkSizeRatio}set checkSizeRatio(e){e=Math.max(Math.min(1,e),0),this._checkSizeRatio!==e&&(this._checkSizeRatio=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get isChecked(){return this._isChecked}set isChecked(e){this._isChecked!==e&&(this._isChecked=e,this._markAsDirty(),this.onIsCheckedChangedObservable.notifyObservers(e))}constructor(e){super(e),this.name=e,this._isChecked=!1,this._background="black",this._checkSizeRatio=.8,this._thickness=1,this.onIsCheckedChangedObservable=new s,this.isPointerBlocker=!0}_getTypeName(){return"Checkbox"}_draw(e){e.save(),this._applyStates(e);const t=this._currentMeasure.width-this._thickness,i=this._currentMeasure.height-this._thickness;if((this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),e.fillStyle=this._isEnabled?this._background:this._disabledColor,e.fillRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,t,i),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this._isChecked){e.fillStyle=this._isEnabled?this.color:this._disabledColorItem;const s=t*this._checkSizeRatio,n=i*this._checkSizeRatio;e.fillRect(this._currentMeasure.left+this._thickness/2+(t-s)/2,this._currentMeasure.top+this._thickness/2+(i-n)/2,s,n)}e.strokeStyle=this.color,e.lineWidth=this._thickness,e.strokeRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,t,i),e.restore()}_onPointerDown(e,t,i,s,n){return!!super._onPointerDown(e,t,i,s,n)&&(this.isReadOnly||(this.isChecked=!this.isChecked),!0)}static AddCheckBoxWithHeader(e,t){const i=new Hd;i.isVertical=!1,i.height="30px";const s=new Wd;s.width="20px",s.height="20px",s.isChecked=!0,s.color="green",s.onIsCheckedChangedObservable.add(t),i.addControl(s);const n=new Vd;return n.text=e,n.width="180px",n.paddingLeft="5px",n.textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,n.color="white",i.addControl(n),i}}De([Ge()],Wd.prototype,"thickness",null),De([Ge()],Wd.prototype,"checkSizeRatio",null),De([Ge()],Wd.prototype,"background",null),De([Ge()],Wd.prototype,"isChecked",null),ue("BABYLON.GUI.Checkbox",Wd);class Xd{}Xd.COPY=1,Xd.CUT=2,Xd.PASTE=3;class Qd{constructor(e,t){this.type=e,this.event=t}static GetTypeFromCharacter(e){switch(e){case 67:return Xd.COPY;case 86:return Xd.PASTE;case 88:return Xd.CUT;default:return-1}}}class Yd{get text(){return this._characters?this._characters.join(""):this._text}set text(e){this._text=e,this._characters=Array.from&&Array.from(e)}get length(){return this._characters?this._characters.length:this._text.length}removePart(e,t,i){if(this._text=this._text.slice(0,e)+(i||"")+this._text.slice(t),this._characters){const s=i?Array.from(i):[];this._characters.splice(e,t-e,...s)}}charAt(e){return this._characters?this._characters[e]:this._text.charAt(e)}substr(e,t){if(this._characters){e=isNaN(e)?0:e>=0?Math.min(e,this._characters.length):this._characters.length+Math.max(e,-this._characters.length),void 0===t?t=this._characters.length-e:(isNaN(t)||t<0)&&(t=0);const i=[];for(;--t>=0;)i[t]=this._characters[e+t];return i.join("")}return this._text.substr(e,t)}substring(e,t){if(this._characters){isNaN(e)?e=0:e>this._characters.length?e=this._characters.length:e<0&&(e=0),void 0===t?t=this._characters.length:isNaN(t)?t=0:t>this._characters.length?t=this._characters.length:t<0&&(t=0);const i=[];let s=0;for(;e<t;)i[s++]=this._characters[e++];return i.join("")}return this._text.substring(e,t)}isWord(e){const t=/\w/g;return this._characters?-1!==this._characters[e].search(t):-1!==this._text.search(t)}}class Kd extends wd{get maxWidth(){return this._maxWidth.toString(this._host)}get maxWidthInPixels(){return this._maxWidth.getValueInPixel(this._host,this._cachedParentMeasure.width)}set maxWidth(e){this._maxWidth.toString(this._host)!==e&&this._maxWidth.fromString(e)&&this._markAsDirty()}get highligherOpacity(){return this._highligherOpacity}set highligherOpacity(e){this._highligherOpacity!==e&&(this._highligherOpacity=e,this._markAsDirty())}get onFocusSelectAll(){return this._onFocusSelectAll}set onFocusSelectAll(e){this._onFocusSelectAll!==e&&(this._onFocusSelectAll=e,this._markAsDirty())}get textHighlightColor(){return this._textHighlightColor}set textHighlightColor(e){this._textHighlightColor!==e&&(this._textHighlightColor=e,this._markAsDirty())}get margin(){return this._margin.toString(this._host)}get marginInPixels(){return this._margin.getValueInPixel(this._host,this._cachedParentMeasure.width)}set margin(e){this._margin.toString(this._host)!==e&&this._margin.fromString(e)&&this._markAsDirty()}get autoStretchWidth(){return this._autoStretchWidth}set autoStretchWidth(e){this._autoStretchWidth!==e&&(this._autoStretchWidth=e,this._markAsDirty())}get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get focusedBackground(){return this._focusedBackground}set focusedBackground(e){this._focusedBackground!==e&&(this._focusedBackground=e,this._markAsDirty())}get focusedColor(){return this._focusedColor}set focusedColor(e){this._focusedColor!==e&&(this._focusedColor=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get placeholderColor(){return this._placeholderColor}set placeholderColor(e){this._placeholderColor!==e&&(this._placeholderColor=e,this._markAsDirty())}get placeholderText(){return this._placeholderText}set placeholderText(e){this._placeholderText!==e&&(this._placeholderText=e,this._markAsDirty())}get deadKey(){return this._deadKey}set deadKey(e){this._deadKey=e}get highlightedText(){return this._highlightedText}set highlightedText(e){this._highlightedText!==e&&(this._highlightedText=e,this._markAsDirty())}get addKey(){return this._addKey}set addKey(e){this._addKey=e}get currentKey(){return this._currentKey}set currentKey(e){this._currentKey=e}get text(){return this._textWrapper.text}set text(e){const t=e.toString();this._textWrapper||(this._textWrapper=new Yd),this._textWrapper.text!==t&&(this._textWrapper.text=t,this._textHasChanged())}_textHasChanged(){this._markAsDirty(),this.onTextChangedObservable.notifyObservers(this)}get width(){return this._width.toString(this._host)}set width(e){this._width.toString(this._host)!==e&&(this._width.fromString(e)&&this._markAsDirty(),this.autoStretchWidth=!1)}constructor(e,t=""){super(e),this.name=e,this._placeholderText="",this._background="#222222",this._focusedBackground="#000000",this._focusedColor="white",this._placeholderColor="gray",this._thickness=1,this._margin=new Rd(10,Rd.UNITMODE_PIXEL),this._autoStretchWidth=!0,this._maxWidth=new Rd(1,Rd.UNITMODE_PERCENTAGE,!1),this._isFocused=!1,this._blinkIsEven=!1,this._cursorOffset=0,this._deadKey=!1,this._addKey=!0,this._currentKey="",this._isTextHighlightOn=!1,this._textHighlightColor="#d5e0ff",this._highligherOpacity=.4,this._highlightedText="",this._startHighlightIndex=0,this._endHighlightIndex=0,this._cursorIndex=-1,this._onFocusSelectAll=!1,this._isPointerDown=!1,this.promptMessage="Please enter text:",this.disableMobilePrompt=!1,this.onTextChangedObservable=new s,this.onBeforeKeyAddObservable=new s,this.onFocusObservable=new s,this.onBlurObservable=new s,this.onTextHighlightObservable=new s,this.onTextCopyObservable=new s,this.onTextCutObservable=new s,this.onTextPasteObservable=new s,this.onKeyboardEventProcessedObservable=new s,this.text=t,this.isPointerBlocker=!0}onBlur(){this._isFocused=!1,this._scrollLeft=null,this._cursorOffset=0,clearTimeout(this._blinkTimeout),this._markAsDirty(),this.onBlurObservable.notifyObservers(this),this._host.unRegisterClipboardEvents(),this._onClipboardObserver&&this._host.onClipboardObservable.remove(this._onClipboardObserver);const e=this._host.getScene();this._onPointerDblTapObserver&&e&&e.onPointerObservable.remove(this._onPointerDblTapObserver)}onFocus(){if(!this._isEnabled)return;if(this._scrollLeft=null,this._isFocused=!0,this._blinkIsEven=!1,this._cursorOffset=0,this._markAsDirty(),this.onFocusObservable.notifyObservers(this),"touch"===this._focusedBy&&!this.disableMobilePrompt){const e=prompt(this.promptMessage);return null!==e&&(this.text=e),void(this._host.focusedControl=null)}this._host.registerClipboardEvents(),this._onClipboardObserver=this._host.onClipboardObservable.add((e=>{switch(e.type){case Xd.COPY:this._onCopyText(e.event),this.onTextCopyObservable.notifyObservers(this);break;case Xd.CUT:this._onCutText(e.event),this.onTextCutObservable.notifyObservers(this);break;case Xd.PASTE:this._onPasteText(e.event),this.onTextPasteObservable.notifyObservers(this);break;default:return}}));const e=this._host.getScene();e&&(this._onPointerDblTapObserver=e.onPointerObservable.add((e=>{this._isFocused&&e.type===ci.POINTERDOUBLETAP&&this._processDblClick(e)}))),this._onFocusSelectAll&&this._selectAllText()}focus(){this._host.moveFocusToControl(this)}blur(){this._host.focusedControl=null}_getTypeName(){return"InputText"}keepsFocusWith(){return this._connectedVirtualKeyboard?[this._connectedVirtualKeyboard]:null}processKey(e,t,i){var s;if(!this.isReadOnly&&(!i||!i.ctrlKey&&!i.metaKey||67!==e&&86!==e&&88!==e)){if(i&&(i.ctrlKey||i.metaKey)&&65===e)return this._selectAllText(),void i.preventDefault();switch(e){case 32:t=" ";break;case 191:i&&i.preventDefault();break;case 8:if(this._textWrapper.text&&this._textWrapper.length>0){if(this.isTextHighlightOn)return this._textWrapper.removePart(this._startHighlightIndex,this._endHighlightIndex),this._textHasChanged(),this.isTextHighlightOn=!1,this._cursorOffset=this._textWrapper.length-this._startHighlightIndex,this._blinkIsEven=!1,void(i&&i.preventDefault());if(0===this._cursorOffset)this.text=this._textWrapper.substr(0,this._textWrapper.length-1);else{const e=this._textWrapper.length-this._cursorOffset;e>0&&(this._textWrapper.removePart(e-1,e),this._textHasChanged())}}return void(i&&i.preventDefault());case 46:if(this.isTextHighlightOn)return this._textWrapper.removePart(this._startHighlightIndex,this._endHighlightIndex),this._textHasChanged(),this.isTextHighlightOn=!1,this._cursorOffset=this._textWrapper.length-this._startHighlightIndex,void(i&&i.preventDefault());if(this._textWrapper.text&&this._textWrapper.length>0&&this._cursorOffset>0){const e=this._textWrapper.length-this._cursorOffset;this._textWrapper.removePart(e,e+1),this._textHasChanged(),this._cursorOffset--}return void(i&&i.preventDefault());case 13:return this._host.focusedControl=null,void(this.isTextHighlightOn=!1);case 35:return this._cursorOffset=0,this._blinkIsEven=!1,this.isTextHighlightOn=!1,void this._markAsDirty();case 36:return this._cursorOffset=this._textWrapper.length,this._blinkIsEven=!1,this.isTextHighlightOn=!1,void this._markAsDirty();case 37:if(this._cursorOffset++,this._cursorOffset>this._textWrapper.length&&(this._cursorOffset=this._textWrapper.length),i&&i.shiftKey){if(this._blinkIsEven=!1,i.ctrlKey||i.metaKey){if(!this.isTextHighlightOn){if(this._textWrapper.length===this._cursorOffset)return;this._endHighlightIndex=this._textWrapper.length-this._cursorOffset+1}return this._startHighlightIndex=0,this._cursorIndex=this._textWrapper.length-this._endHighlightIndex,this._cursorOffset=this._textWrapper.length,this.isTextHighlightOn=!0,void this._markAsDirty()}return this.isTextHighlightOn?-1===this._cursorIndex&&(this._cursorIndex=this._textWrapper.length-this._endHighlightIndex,this._cursorOffset=0===this._startHighlightIndex?this._textWrapper.length:this._textWrapper.length-this._startHighlightIndex+1):(this.isTextHighlightOn=!0,this._cursorIndex=this._cursorOffset>=this._textWrapper.length?this._textWrapper.length:this._cursorOffset-1),this._cursorIndex<this._cursorOffset?(this._endHighlightIndex=this._textWrapper.length-this._cursorIndex,this._startHighlightIndex=this._textWrapper.length-this._cursorOffset):this._cursorIndex>this._cursorOffset?(this._endHighlightIndex=this._textWrapper.length-this._cursorOffset,this._startHighlightIndex=this._textWrapper.length-this._cursorIndex):this.isTextHighlightOn=!1,void this._markAsDirty()}return this.isTextHighlightOn&&(this._cursorOffset=this._textWrapper.length-this._startHighlightIndex,this.isTextHighlightOn=!1),i&&(i.ctrlKey||i.metaKey)&&(this._cursorOffset=this._textWrapper.length,i.preventDefault()),this._blinkIsEven=!1,this.isTextHighlightOn=!1,this._cursorIndex=-1,void this._markAsDirty();case 39:if(this._cursorOffset--,this._cursorOffset<0&&(this._cursorOffset=0),i&&i.shiftKey){if(this._blinkIsEven=!1,i.ctrlKey||i.metaKey){if(!this.isTextHighlightOn){if(0===this._cursorOffset)return;this._startHighlightIndex=this._textWrapper.length-this._cursorOffset-1}return this._endHighlightIndex=this._textWrapper.length,this.isTextHighlightOn=!0,this._cursorIndex=this._textWrapper.length-this._startHighlightIndex,this._cursorOffset=0,void this._markAsDirty()}return this.isTextHighlightOn?-1===this._cursorIndex&&(this._cursorIndex=this._textWrapper.length-this._startHighlightIndex,this._cursorOffset=this._textWrapper.length===this._endHighlightIndex?0:this._textWrapper.length-this._endHighlightIndex-1):(this.isTextHighlightOn=!0,this._cursorIndex=this._cursorOffset<=0?0:this._cursorOffset+1),this._cursorIndex<this._cursorOffset?(this._endHighlightIndex=this._textWrapper.length-this._cursorIndex,this._startHighlightIndex=this._textWrapper.length-this._cursorOffset):this._cursorIndex>this._cursorOffset?(this._endHighlightIndex=this._textWrapper.length-this._cursorOffset,this._startHighlightIndex=this._textWrapper.length-this._cursorIndex):this.isTextHighlightOn=!1,void this._markAsDirty()}return this.isTextHighlightOn&&(this._cursorOffset=this._textWrapper.length-this._endHighlightIndex,this.isTextHighlightOn=!1),i&&(i.ctrlKey||i.metaKey)&&(this._cursorOffset=0,i.preventDefault()),this._blinkIsEven=!1,this.isTextHighlightOn=!1,this._cursorIndex=-1,void this._markAsDirty()}if(32===e&&(t=null!==(s=null==i?void 0:i.key)&&void 0!==s?s:" "),this._deadKey="Dead"===t,t&&(-1===e||32===e||34===e||39===e||e>47&&e<64||e>64&&e<91||e>159&&e<193||e>218&&e<223||e>95&&e<112)&&(this._currentKey=t,this.onBeforeKeyAddObservable.notifyObservers(this),t=this._currentKey,this._addKey&&!this._deadKey))if(this.isTextHighlightOn)this._textWrapper.removePart(this._startHighlightIndex,this._endHighlightIndex,t),this._textHasChanged(),this._cursorOffset=this._textWrapper.length-(this._startHighlightIndex+1),this.isTextHighlightOn=!1,this._blinkIsEven=!1,this._markAsDirty();else if(0===this._cursorOffset)this.text+=this._deadKey&&(null==i?void 0:i.key)?i.key:t;else{const e=this._textWrapper.length-this._cursorOffset;this._textWrapper.removePart(e,e,t),this._textHasChanged()}}}_updateValueFromCursorIndex(e){if(this._blinkIsEven=!1,-1===this._cursorIndex)this._cursorIndex=e;else if(this._cursorIndex<this._cursorOffset)this._endHighlightIndex=this._textWrapper.length-this._cursorIndex,this._startHighlightIndex=this._textWrapper.length-this._cursorOffset;else{if(!(this._cursorIndex>this._cursorOffset))return this.isTextHighlightOn=!1,void this._markAsDirty();this._endHighlightIndex=this._textWrapper.length-this._cursorOffset,this._startHighlightIndex=this._textWrapper.length-this._cursorIndex}this.isTextHighlightOn=!0,this._markAsDirty()}_processDblClick(e){let t,i;this._startHighlightIndex=this._textWrapper.length-this._cursorOffset,this._endHighlightIndex=this._startHighlightIndex;do{i=this._endHighlightIndex<this._textWrapper.length&&this._textWrapper.isWord(this._endHighlightIndex)?++this._endHighlightIndex:0,t=this._startHighlightIndex>0&&this._textWrapper.isWord(this._startHighlightIndex-1)?--this._startHighlightIndex:0}while(t||i);this._cursorOffset=this._textWrapper.length-this._startHighlightIndex,this.isTextHighlightOn=!0,this._clickedCoordinate=null,this._blinkIsEven=!0,this._cursorIndex=-1,this._markAsDirty()}_selectAllText(){this._blinkIsEven=!0,this.isTextHighlightOn=!0,this._startHighlightIndex=0,this._endHighlightIndex=this._textWrapper.length,this._cursorOffset=this._textWrapper.length,this._cursorIndex=-1,this._markAsDirty()}processKeyboard(e){this.processKey(e.keyCode,e.key,e),this.onKeyboardEventProcessedObservable.notifyObservers(e)}_onCopyText(e){this.isTextHighlightOn=!1;try{e.clipboardData&&e.clipboardData.setData("text/plain",this._highlightedText)}catch(e){}this._host.clipboardData=this._highlightedText}_onCutText(e){if(this._highlightedText){this._textWrapper.removePart(this._startHighlightIndex,this._endHighlightIndex),this._textHasChanged(),this.isTextHighlightOn=!1,this._cursorOffset=this._textWrapper.length-this._startHighlightIndex;try{e.clipboardData&&e.clipboardData.setData("text/plain",this._highlightedText)}catch(e){}this._host.clipboardData=this._highlightedText,this._highlightedText=""}}_onPasteText(e){let t="";t=e.clipboardData&&-1!==e.clipboardData.types.indexOf("text/plain")?e.clipboardData.getData("text/plain"):this._host.clipboardData;const i=this._textWrapper.length-this._cursorOffset;this._textWrapper.removePart(i,i,t),this._textHasChanged()}_draw(e){e.save(),this._applyStates(e),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._isFocused?this._focusedBackground&&(e.fillStyle=this._isEnabled?this._focusedBackground:this._disabledColor,e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)):this._background&&(e.fillStyle=this._isEnabled?this._background:this._disabledColor,e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this._fontOffset&&!this._wasDirty||(this._fontOffset=wd._GetFontOffset(e.font));const t=this._currentMeasure.left+this._margin.getValueInPixel(this._host,this._tempParentMeasure.width);this.color&&(e.fillStyle=this.color);let i=this._beforeRenderText(this._textWrapper);this._isFocused||this._textWrapper.text||!this._placeholderText||(i=new Yd,i.text=this._placeholderText,this._placeholderColor&&(e.fillStyle=this._placeholderColor)),this._textWidth=e.measureText(i.text).width;const s=2*this._margin.getValueInPixel(this._host,this._tempParentMeasure.width);this._autoStretchWidth&&(this.width=Math.min(this._maxWidth.getValueInPixel(this._host,this._tempParentMeasure.width),this._textWidth+s)+"px",this._autoStretchWidth=!0);const n=this._fontOffset.ascent+(this._currentMeasure.height-this._fontOffset.height)/2,r=this._width.getValueInPixel(this._host,this._tempParentMeasure.width)-s;if(e.save(),e.beginPath(),e.rect(t,this._currentMeasure.top+(this._currentMeasure.height-this._fontOffset.height)/2,r+2,this._currentMeasure.height),e.clip(),this._isFocused&&this._textWidth>r){const e=t-this._textWidth+r;this._scrollLeft||(this._scrollLeft=e)}else this._scrollLeft=t;if(e.fillText(i.text,this._scrollLeft,this._currentMeasure.top+n),this._isFocused){if(this._clickedCoordinate){const t=this._scrollLeft+this._textWidth-this._clickedCoordinate;let s=0;this._cursorOffset=0;let n=0;do{this._cursorOffset&&(n=Math.abs(t-s)),this._cursorOffset++,s=e.measureText(i.substr(i.length-this._cursorOffset,this._cursorOffset)).width}while(s<t&&i.length>=this._cursorOffset);Math.abs(t-s)>n&&this._cursorOffset--,this._blinkIsEven=!1,this._clickedCoordinate=null}if(!this._blinkIsEven){const s=i.substr(i.length-this._cursorOffset),n=e.measureText(s).width;let o=this._scrollLeft+this._textWidth-n;o<t?(this._scrollLeft+=t-o,o=t,this._markAsDirty()):o>t+r&&(this._scrollLeft+=t+r-o,o=t+r,this._markAsDirty()),this.isTextHighlightOn||e.fillRect(o,this._currentMeasure.top+(this._currentMeasure.height-this._fontOffset.height)/2,2,this._fontOffset.height)}if(clearTimeout(this._blinkTimeout),this._blinkTimeout=setTimeout((()=>{this._blinkIsEven=!this._blinkIsEven,this._markAsDirty()}),500),this.isTextHighlightOn){clearTimeout(this._blinkTimeout);const s=e.measureText(i.substring(this._startHighlightIndex)).width;let n=this._scrollLeft+this._textWidth-s;this._highlightedText=i.substring(this._startHighlightIndex,this._endHighlightIndex);let r=e.measureText(i.substring(this._startHighlightIndex,this._endHighlightIndex)).width;n<t&&(r-=t-n,r||(r=e.measureText(i.charAt(i.length-this._cursorOffset)).width),n=t),e.globalAlpha=this._highligherOpacity,e.fillStyle=this._textHighlightColor,e.fillRect(n,this._currentMeasure.top+(this._currentMeasure.height-this._fontOffset.height)/2,r,this._fontOffset.height),e.globalAlpha=1}}e.restore(),this._thickness&&(this._isFocused?this.focusedColor&&(e.strokeStyle=this.focusedColor):this.color&&(e.strokeStyle=this.color),e.lineWidth=this._thickness,e.strokeRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,this._currentMeasure.width-this._thickness,this._currentMeasure.height-this._thickness)),e.restore()}_onPointerDown(e,t,i,s,n){return!(!super._onPointerDown(e,t,i,s,n)||!this.isReadOnly&&(this._clickedCoordinate=t.x,this.isTextHighlightOn=!1,this._highlightedText="",this._cursorIndex=-1,this._isPointerDown=!0,this._host._capturingControl[i]=this,this._focusedBy=n.event.pointerType,this._host.focusedControl===this?(clearTimeout(this._blinkTimeout),this._markAsDirty(),0):!this._isEnabled||(this._host.focusedControl=this,0)))}_onPointerMove(e,t,i,s){this._host.focusedControl===this&&this._isPointerDown&&!this.isReadOnly&&(this._clickedCoordinate=t.x,this._markAsDirty(),this._updateValueFromCursorIndex(this._cursorOffset)),super._onPointerMove(e,t,i,s)}_onPointerUp(e,t,i,s,n){this._isPointerDown=!1,delete this._host._capturingControl[i],super._onPointerUp(e,t,i,s,n)}_beforeRenderText(e){return e}set isTextHighlightOn(e){this._isTextHighlightOn!==e&&(e&&this.onTextHighlightObservable.notifyObservers(this),this._isTextHighlightOn=e)}get isTextHighlightOn(){return this._isTextHighlightOn}dispose(){super.dispose(),this.onBlurObservable.clear(),this.onFocusObservable.clear(),this.onTextChangedObservable.clear(),this.onTextCopyObservable.clear(),this.onTextCutObservable.clear(),this.onTextPasteObservable.clear(),this.onTextHighlightObservable.clear(),this.onKeyboardEventProcessedObservable.clear()}}De([Ge()],Kd.prototype,"promptMessage",void 0),De([Ge()],Kd.prototype,"disableMobilePrompt",void 0),De([Ge()],Kd.prototype,"maxWidth",null),De([Ge()],Kd.prototype,"highligherOpacity",null),De([Ge()],Kd.prototype,"onFocusSelectAll",null),De([Ge()],Kd.prototype,"textHighlightColor",null),De([Ge()],Kd.prototype,"margin",null),De([Ge()],Kd.prototype,"autoStretchWidth",null),De([Ge()],Kd.prototype,"thickness",null),De([Ge()],Kd.prototype,"focusedBackground",null),De([Ge()],Kd.prototype,"focusedColor",null),De([Ge()],Kd.prototype,"background",null),De([Ge()],Kd.prototype,"placeholderColor",null),De([Ge()],Kd.prototype,"placeholderText",null),De([Ge()],Kd.prototype,"deadKey",null),De([Ge()],Kd.prototype,"text",null),De([Ge()],Kd.prototype,"width",null),ue("BABYLON.GUI.InputText",Kd);class jd extends Bd{set clipContent(e){this._clipContent=e;for(const t in this._cells)this._cells[t].clipContent=e}get clipContent(){return this._clipContent}set clipChildren(e){this._clipChildren=e;for(const t in this._cells)this._cells[t].clipChildren=e}get clipChildren(){return this._clipChildren}get columnCount(){return this._columnDefinitions.length}get rowCount(){return this._rowDefinitions.length}get children(){return this._childControls}get cells(){return this._cells}getRowDefinition(e){return e<0||e>=this._rowDefinitions.length?null:this._rowDefinitions[e]}getColumnDefinition(e){return e<0||e>=this._columnDefinitions.length?null:this._columnDefinitions[e]}addRowDefinition(e,t=!1){return this._rowDefinitions.push(new Rd(e,t?Rd.UNITMODE_PIXEL:Rd.UNITMODE_PERCENTAGE)),this._rowDefinitionObservers.push(this._rowDefinitions[this.rowCount-1].onChangedObservable.add((()=>this._markAsDirty()))),this._markAsDirty(),this}addColumnDefinition(e,t=!1){return this._columnDefinitions.push(new Rd(e,t?Rd.UNITMODE_PIXEL:Rd.UNITMODE_PERCENTAGE)),this._columnDefinitionObservers.push(this._columnDefinitions[this.columnCount-1].onChangedObservable.add((()=>this._markAsDirty()))),this._markAsDirty(),this}setRowDefinition(e,t,i=!1){if(e<0||e>=this._rowDefinitions.length)return this;const s=this._rowDefinitions[e];return s&&s.isPixel===i&&s.value===t||(this._rowDefinitions[e].onChangedObservable.remove(this._rowDefinitionObservers[e]),this._rowDefinitions[e]=new Rd(t,i?Rd.UNITMODE_PIXEL:Rd.UNITMODE_PERCENTAGE),this._rowDefinitionObservers[e]=this._rowDefinitions[e].onChangedObservable.add((()=>this._markAsDirty())),this._markAsDirty()),this}setColumnDefinition(e,t,i=!1){if(e<0||e>=this._columnDefinitions.length)return this;const s=this._columnDefinitions[e];return s&&s.isPixel===i&&s.value===t||(this._columnDefinitions[e].onChangedObservable.remove(this._columnDefinitionObservers[e]),this._columnDefinitions[e]=new Rd(t,i?Rd.UNITMODE_PIXEL:Rd.UNITMODE_PERCENTAGE),this._columnDefinitionObservers[e]=this._columnDefinitions[e].onChangedObservable.add((()=>this._markAsDirty())),this._markAsDirty()),this}getChildrenAt(e,t){const i=this._cells[`${e}:${t}`];return i?i.children:null}getChildCellInfo(e){return e._tag}_removeCell(e,t){if(e){super.removeControl(e);for(const t of e.children){const e=this._childControls.indexOf(t);-1!==e&&this._childControls.splice(e,1)}delete this._cells[t]}}_offsetCell(e,t){if(this._cells[t]){this._cells[e]=this._cells[t];for(const t of this._cells[e].children)t._tag=e;delete this._cells[t]}}removeColumnDefinition(e){if(e<0||e>=this._columnDefinitions.length)return this;for(let t=0;t<this._rowDefinitions.length;t++){const i=`${t}:${e}`,s=this._cells[i];this._removeCell(s,i)}for(let t=0;t<this._rowDefinitions.length;t++)for(let i=e+1;i<this._columnDefinitions.length;i++){const e=`${t}:${i-1}`,s=`${t}:${i}`;this._offsetCell(e,s)}return this._columnDefinitions[e].onChangedObservable.remove(this._columnDefinitionObservers[e]),this._columnDefinitions.splice(e,1),this._columnDefinitionObservers.splice(e,1),this._markAsDirty(),this}removeRowDefinition(e){if(e<0||e>=this._rowDefinitions.length)return this;for(let t=0;t<this._columnDefinitions.length;t++){const i=`${e}:${t}`,s=this._cells[i];this._removeCell(s,i)}for(let t=0;t<this._columnDefinitions.length;t++)for(let i=e+1;i<this._rowDefinitions.length;i++){const e=`${i-1}:${t}`,s=`${i}:${t}`;this._offsetCell(e,s)}return this._rowDefinitions[e].onChangedObservable.remove(this._rowDefinitionObservers[e]),this._rowDefinitions.splice(e,1),this._rowDefinitionObservers.splice(e,1),this._markAsDirty(),this}addControl(e,t=0,i=0){if(0===this._rowDefinitions.length&&this.addRowDefinition(1,!1),0===this._columnDefinitions.length&&this.addColumnDefinition(1,!1),-1!==this._childControls.indexOf(e))return Ot.Warn(`Control (Name:${e.name}, UniqueId:${e.uniqueId}) is already associated with this grid. You must remove it before reattaching it`),this;const s=`${Math.min(t,this._rowDefinitions.length-1)}:${Math.min(i,this._columnDefinitions.length-1)}`;let n=this._cells[s];return n||(n=new Bd(s),this._cells[s]=n,n.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,n.verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP,n.clipContent=this.clipContent,n.clipChildren=this.clipChildren,super.addControl(n)),n.addControl(e),this._childControls.push(e),e._tag=s,e.parent=this,this._markAsDirty(),this}removeControl(e){const t=this._childControls.indexOf(e);-1!==t&&this._childControls.splice(t,1);const i=this._cells[e._tag];return i&&(i.removeControl(e),e._tag=null),this._markAsDirty(),this}constructor(e){super(e),this.name=e,this._rowDefinitions=new Array,this._rowDefinitionObservers=[],this._columnDefinitions=new Array,this._columnDefinitionObservers=[],this._cells={},this._childControls=new Array}_getTypeName(){return"Grid"}_getGridDefinitions(e){const t=[],i=[],s=[],n=[];let r=this._currentMeasure.width,o=0,a=this._currentMeasure.height,l=0,h=0;for(const e of this._rowDefinitions){if(e.isPixel){const t=e.getValue(this._host);a-=t,i[h]=t}else l+=e.value;h++}let c=0;h=0;for(const e of this._rowDefinitions){if(n.push(c),e.isPixel)c+=e.getValue(this._host);else{const t=Math.round(e.value/l*a);c+=t,i[h]=t}h++}h=0;for(const e of this._columnDefinitions){if(e.isPixel){const i=e.getValue(this._host);r-=i,t[h]=i}else o+=e.value;h++}let d=0;h=0;for(const e of this._columnDefinitions){if(s.push(d),e.isPixel)d+=e.getValue(this._host);else{const i=Math.round(e.value/o*r);d+=i,t[h]=i}h++}e(s,n,t,i)}_additionalProcessing(e,t){this._getGridDefinitions(((e,t,i,s)=>{for(const n in this._cells){if(!Object.prototype.hasOwnProperty.call(this._cells,n))continue;const r=n.split(":"),o=parseInt(r[0]),a=parseInt(r[1]),l=this._cells[n];l.leftInPixels=e[a],l.topInPixels=t[o],l.widthInPixels=i[a],l.heightInPixels=s[o],l._left.ignoreAdaptiveScaling=!0,l._top.ignoreAdaptiveScaling=!0,l._width.ignoreAdaptiveScaling=!0,l._height.ignoreAdaptiveScaling=!0}})),super._additionalProcessing(e,t)}_flagDescendantsAsMatrixDirty(){for(const e in this._cells)Object.prototype.hasOwnProperty.call(this._cells,e)&&this._cells[e]._markMatrixAsDirty()}_renderHighlightSpecific(e){super._renderHighlightSpecific(e),this._getGridDefinitions(((t,i,s,n)=>{for(let i=0;i<t.length;i++){const n=this._currentMeasure.left+t[i]+s[i];e.beginPath(),e.moveTo(n,this._currentMeasure.top),e.lineTo(n,this._currentMeasure.top+this._currentMeasure.height),e.stroke()}for(let t=0;t<i.length;t++){const s=this._currentMeasure.top+i[t]+n[t];e.beginPath(),e.moveTo(this._currentMeasure.left,s),e.lineTo(this._currentMeasure.left+this._currentMeasure.width,s),e.stroke()}})),e.restore()}dispose(){super.dispose();for(const e of this._childControls)e.dispose();for(let e=0;e<this._rowDefinitions.length;e++)this._rowDefinitions[e].onChangedObservable.remove(this._rowDefinitionObservers[e]);for(let e=0;e<this._columnDefinitions.length;e++)this._columnDefinitions[e].onChangedObservable.remove(this._columnDefinitionObservers[e]);this._rowDefinitionObservers.length=0,this._rowDefinitions.length=0,this._columnDefinitionObservers.length=0,this._columnDefinitions.length=0,this._cells={},this._childControls.length=0}serialize(e){super.serialize(e),e.columnCount=this.columnCount,e.rowCount=this.rowCount,e.columns=[],e.rows=[],e.tags=[];for(let t=0;t<this.columnCount;++t){const i=this.getColumnDefinition(t),s={value:null==i?void 0:i.getValue(this.host),unit:null==i?void 0:i.unit};e.columns.push(s)}for(let t=0;t<this.rowCount;++t){const i=this.getRowDefinition(t),s={value:null==i?void 0:i.getValue(this.host),unit:null==i?void 0:i.unit};e.rows.push(s)}this.children.forEach((t=>{e.tags.push(t._tag)}))}_parseFromContent(e,t){super._parseFromContent(e,t);const i=[];this.children.forEach((e=>{i.push(e)})),this.removeRowDefinition(0),this.removeColumnDefinition(0);for(let t=0;t<e.columnCount;++t){const i=e.columns[t].value,s=e.columns[t].unit;this.addColumnDefinition(i,1===s)}for(let t=0;t<e.rowCount;++t){const i=e.rows[t].value,s=e.rows[t].unit;this.addRowDefinition(i,1===s)}for(let t=0;t<i.length;++t){const s=e.tags[t];let n=parseInt(s.substring(0,s.search(":")));isNaN(n)&&(n=0);let r=parseInt(s.substring(s.search(":")+1));isNaN(r)&&(r=0),this.addControl(i[t],n,r)}}}De([Ge()],jd.prototype,"clipContent",null),ue("BABYLON.GUI.Grid",jd);class $d extends wd{get value(){return this._value}set value(e){this._value.equals(e)||(this._value.copyFrom(e),this._value.toHSVToRef(this._tmpColor),this._h=this._tmpColor.r,this._s=Math.max(this._tmpColor.g,1e-5),this._v=Math.max(this._tmpColor.b,1e-5),this._markAsDirty(),this._value.r<=$d._Epsilon&&(this._value.r=0),this._value.g<=$d._Epsilon&&(this._value.g=0),this._value.b<=$d._Epsilon&&(this._value.b=0),this._value.r>=1-$d._Epsilon&&(this._value.r=1),this._value.g>=1-$d._Epsilon&&(this._value.g=1),this._value.b>=1-$d._Epsilon&&(this._value.b=1),this.onValueChangedObservable.notifyObservers(this._value))}get width(){return this._width.toString(this._host)}set width(e){this._width.toString(this._host)!==e&&this._width.fromString(e)&&(0===this._width.getValue(this._host)&&(e="1px",this._width.fromString(e)),this._height.fromString(e),this._markAsDirty())}get height(){return this._height.toString(this._host)}set height(e){this._height.toString(this._host)!==e&&this._height.fromString(e)&&(0===this._height.getValue(this._host)&&(e="1px",this._height.fromString(e)),this._width.fromString(e),this._markAsDirty())}get size(){return this.width}set size(e){this.width=e}constructor(e){super(e),this.name=e,this._value=Re.Red(),this._tmpColor=new Re,this._pointerStartedOnSquare=!1,this._pointerStartedOnWheel=!1,this._squareLeft=0,this._squareTop=0,this._squareSize=0,this._h=360,this._s=1,this._v=1,this._lastPointerDownId=-1,this.onValueChangedObservable=new s,this._pointerIsDown=!1,this.value=new Re(.88,.1,.1),this.size="200px",this.isPointerBlocker=!0}_getTypeName(){return"ColorPicker"}_preMeasure(e){e.width<e.height?this._currentMeasure.height=e.width:this._currentMeasure.width=e.height}_updateSquareProps(){const e=.5*Math.min(this._currentMeasure.width,this._currentMeasure.height),t=2*(e-.2*e)/Math.sqrt(2),i=e-.5*t;this._squareLeft=this._currentMeasure.left+i,this._squareTop=this._currentMeasure.top+i,this._squareSize=t}_drawGradientSquare(e,t,i,s,n,r){const o=r.createLinearGradient(t,i,s+t,i);o.addColorStop(0,"#fff"),o.addColorStop(1,"hsl("+e+", 100%, 50%)"),r.fillStyle=o,r.fillRect(t,i,s,n);const a=r.createLinearGradient(t,i,t,n+i);a.addColorStop(0,"rgba(0,0,0,0)"),a.addColorStop(1,"#000"),r.fillStyle=a,r.fillRect(t,i,s,n)}_drawCircle(e,t,i,s){s.beginPath(),s.arc(e,t,i+1,0,2*Math.PI,!1),s.lineWidth=3,s.strokeStyle="#333333",s.stroke(),s.beginPath(),s.arc(e,t,i,0,2*Math.PI,!1),s.lineWidth=3,s.strokeStyle="#ffffff",s.stroke()}_createColorWheelCanvas(e,t){const i=u.LastCreatedEngine;if(!i)throw new Error("Invalid engine. Unable to create a canvas.");const s=i.createCanvas(2*e,2*e),n=s.getContext("2d"),r=n.getImageData(0,0,2*e,2*e),o=r.data,a=this._tmpColor,l=e*e,h=e-t,c=h*h;for(let t=-e;t<e;t++)for(let i=-e;i<e;i++){const s=t*t+i*i;if(s>l||s<c)continue;const n=Math.sqrt(s),r=Math.atan2(i,t);Re.HSVtoRGBToRef(180*r/Math.PI+180,n/e,1,a);const d=4*(t+e+2*(i+e)*e);o[d]=255*a.r,o[d+1]=255*a.g,o[d+2]=255*a.b;let u=(n-h)/(e-h),_=.2;const f=.2,p=.04,m=50,g=150;_=e<m?f:e>g?p:(p-f)*(e-m)/(g-m)+f,u=(n-h)/(e-h),o[d+3]=u<_?u/_*255:u>1-_?255*(1-(u-(1-_))/_):255}return n.putImageData(r,0,0),s}_draw(e){e.save(),this._applyStates(e);const t=.5*Math.min(this._currentMeasure.width,this._currentMeasure.height),i=.2*t,s=this._currentMeasure.left,n=this._currentMeasure.top;this._colorWheelCanvas&&this._colorWheelCanvas.width==2*t||(this._colorWheelCanvas=this._createColorWheelCanvas(t,i)),this._updateSquareProps(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY,e.fillRect(this._squareLeft,this._squareTop,this._squareSize,this._squareSize)),e.drawImage(this._colorWheelCanvas,s,n),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this._drawGradientSquare(this._h,this._squareLeft,this._squareTop,this._squareSize,this._squareSize,e);let r=this._squareLeft+this._squareSize*this._s,o=this._squareTop+this._squareSize*(1-this._v);this._drawCircle(r,o,.04*t,e);const a=t-.5*i;r=s+t+Math.cos((this._h-180)*Math.PI/180)*a,o=n+t+Math.sin((this._h-180)*Math.PI/180)*a,this._drawCircle(r,o,.35*i,e),e.restore()}_updateValueFromPointer(e,t){if(this._pointerStartedOnWheel){const i=.5*Math.min(this._currentMeasure.width,this._currentMeasure.height),s=i+this._currentMeasure.left,n=i+this._currentMeasure.top;this._h=180*Math.atan2(t-n,e-s)/Math.PI+180}else this._pointerStartedOnSquare&&(this._updateSquareProps(),this._s=(e-this._squareLeft)/this._squareSize,this._v=1-(t-this._squareTop)/this._squareSize,this._s=Math.min(this._s,1),this._s=Math.max(this._s,$d._Epsilon),this._v=Math.min(this._v,1),this._v=Math.max(this._v,$d._Epsilon));Re.HSVtoRGBToRef(this._h,this._s,this._v,this._tmpColor),this.value=this._tmpColor}_isPointOnSquare(e,t){this._updateSquareProps();const i=this._squareLeft,s=this._squareTop,n=this._squareSize;return e>=i&&e<=i+n&&t>=s&&t<=s+n}_isPointOnWheel(e,t){const i=.5*Math.min(this._currentMeasure.width,this._currentMeasure.height),s=i-.2*i,n=e-(i+this._currentMeasure.left),r=t-(i+this._currentMeasure.top),o=n*n+r*r;return o<=i*i&&o>=s*s}_onPointerDown(e,t,i,s,n){if(!super._onPointerDown(e,t,i,s,n))return!1;if(this.isReadOnly)return!0;this._pointerIsDown=!0,this._pointerStartedOnSquare=!1,this._pointerStartedOnWheel=!1,this._invertTransformMatrix.transformCoordinates(t.x,t.y,this._transformedPosition);const r=this._transformedPosition.x,o=this._transformedPosition.y;return this._isPointOnSquare(r,o)?this._pointerStartedOnSquare=!0:this._isPointOnWheel(r,o)&&(this._pointerStartedOnWheel=!0),this._updateValueFromPointer(r,o),this._host._capturingControl[i]=this,this._lastPointerDownId=i,!0}_onPointerMove(e,t,i,s){if(i==this._lastPointerDownId){if(!this.isReadOnly){this._invertTransformMatrix.transformCoordinates(t.x,t.y,this._transformedPosition);const e=this._transformedPosition.x,i=this._transformedPosition.y;this._pointerIsDown&&this._updateValueFromPointer(e,i)}super._onPointerMove(e,t,i,s)}}_onPointerUp(e,t,i,s,n,r){this._pointerIsDown=!1,delete this._host._capturingControl[i],super._onPointerUp(e,t,i,s,n,r)}_onCanvasBlur(){this._forcePointerUp(),super._onCanvasBlur()}static ShowPickerDialogAsync(e,t){return new Promise((i=>{t.pickerWidth=t.pickerWidth||"640px",t.pickerHeight=t.pickerHeight||"400px",t.headerHeight=t.headerHeight||"35px",t.lastColor=t.lastColor||"#000000",t.swatchLimit=t.swatchLimit||20,t.numSwatchesPerLine=t.numSwatchesPerLine||10;const s=t.swatchLimit/t.numSwatchesPerLine,n=parseFloat(t.pickerWidth)/t.numSwatchesPerLine,r=Math.floor(.25*n),o=r*(t.numSwatchesPerLine+1),a=Math.floor((parseFloat(t.pickerWidth)-o)/t.numSwatchesPerLine),l=a*s+r*(s+1),h=(parseInt(t.pickerHeight)+l+Math.floor(.25*a)).toString()+"px",c="#c0c0c0",d="#535353",u="#414141",_="515151",f="#555555",p="#454545",m=Re.FromHexString("#dddddd"),g=m.r+m.g+m.b,v="#aaaaaa",T="#ffffff";let b,E;const S=["R","G","B"],x="#454545",C="#f0f0f0";let y,A,R,I,P,M=!1;const O=new jd;if(O.name="Dialog Container",O.width=t.pickerWidth,t.savedColors){O.height=h;const e=parseInt(t.pickerHeight)/parseInt(h);O.addRowDefinition(e,!1),O.addRowDefinition(1-e,!1)}else O.height=t.pickerHeight,O.addRowDefinition(1,!1);if(e.addControl(O),t.savedColors){A=new jd,A.name="Swatch Drawer",A.verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP,A.background=d,A.width=t.pickerWidth;const e=t.savedColors.length/t.numSwatchesPerLine;let i;i=0==e?0:e+1,A.height=(a*e+i*r).toString()+"px",A.top=Math.floor(.25*a).toString()+"px";for(let e=0;e<2*Math.ceil(t.savedColors.length/t.numSwatchesPerLine)+1;e++)e%2!=0?A.addRowDefinition(a,!0):A.addRowDefinition(r,!0);for(let e=0;e<2*t.numSwatchesPerLine+1;e++)e%2!=0?A.addColumnDefinition(a,!0):A.addColumnDefinition(r,!0);O.addControl(A,1,0)}const D=new jd;D.name="Picker Panel",D.height=t.pickerHeight;const N=parseInt(t.headerHeight)/parseInt(t.pickerHeight),F=[N,1-N];D.addRowDefinition(F[0],!1),D.addRowDefinition(F[1],!1),O.addControl(D,0,0);const L=new Ud;L.name="Dialogue Header Bar",L.background="#cccccc",L.thickness=0,D.addControl(L,0,0);const w=zd.CreateSimpleButton("closeButton","a");w.fontFamily="coreglyphs";const B=Re.FromHexString(L.background),U=new Re(1-B.r,1-B.g,1-B.b);w.color=U.toHexString(),w.fontSize=Math.floor(.6*parseInt(t.headerHeight)),w.textBlock.textVerticalAlignment=wd.VERTICAL_ALIGNMENT_CENTER,w.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_RIGHT,w.height=w.width=t.headerHeight,w.background=L.background,w.thickness=0,w.pointerDownAnimation=()=>{},w.pointerUpAnimation=()=>{w.background=L.background},w.pointerEnterAnimation=()=>{w.color=L.background,w.background="red"},w.pointerOutAnimation=()=>{w.color=U.toHexString(),w.background=L.background},w.onPointerClickObservable.add((()=>{De(te.background)})),D.addControl(w,0,0);const k=new jd;k.name="Dialogue Body",k.background=d;const V=[.4375,.5625];k.addRowDefinition(1,!1),k.addColumnDefinition(V[0],!1),k.addColumnDefinition(V[1],!1),D.addControl(k,1,0);const G=new jd;G.name="Picker Grid",G.addRowDefinition(.85,!1),G.addRowDefinition(.15,!1),k.addControl(G,0,0);const z=new $d;z.name="GUI Color Picker",t.pickerHeight<t.pickerWidth?z.width=.89:z.height=.89,z.value=Re.FromHexString(t.lastColor),z.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_CENTER,z.verticalAlignment=wd.VERTICAL_ALIGNMENT_CENTER,z.onPointerDownObservable.add((()=>{P=z.name,I="",Ie(!1)})),z.onValueChangedObservable.add((function(e){P==z.name&&xe(e,z.name)})),G.addControl(z,0,0);const H=new jd;H.name="Dialogue Right Half",H.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT;const W=[.514,.486];H.addRowDefinition(W[0],!1),H.addRowDefinition(W[1],!1),k.addControl(H,1,1);const X=new jd;X.name="Swatches and Buttons";const Q=[.417,.583];X.addRowDefinition(1,!1),X.addColumnDefinition(Q[0],!1),X.addColumnDefinition(Q[1],!1),H.addControl(X,0,0);const Y=new jd;Y.name="New and Current Swatches";const K=[.04,.16,.64,.16];Y.addRowDefinition(K[0],!1),Y.addRowDefinition(K[1],!1),Y.addRowDefinition(K[2],!1),Y.addRowDefinition(K[3],!1),X.addControl(Y,0,0);const j=new jd;j.name="Active Swatches",j.width=.67,j.addRowDefinition(.5,!1),j.addRowDefinition(.5,!1),Y.addControl(j,2,0);const $=Math.floor(parseInt(t.pickerWidth)*V[1]*Q[0]*.11),q=Math.floor(parseInt(t.pickerHeight)*F[1]*W[0]*K[1]*.5);let Z;Z=t.pickerWidth>t.pickerHeight?q:$;const J=new Vd;J.text="new",J.name="New Color Label",J.color=c,J.fontSize=Z,Y.addControl(J,1,0);const ee=new Ud;ee.name="New Color Swatch",ee.background=t.lastColor,ee.thickness=0,j.addControl(ee,0,0);const te=zd.CreateSimpleButton("currentSwatch","");te.background=t.lastColor,te.thickness=0,te.onPointerClickObservable.add((()=>{xe(Re.FromHexString(te.background),te.name),Ie(!1)})),te.pointerDownAnimation=()=>{},te.pointerUpAnimation=()=>{},te.pointerEnterAnimation=()=>{},te.pointerOutAnimation=()=>{},j.addControl(te,1,0);const ie=new Ud;ie.name="Swatch Outline",ie.width=.67,ie.thickness=2,ie.color="#404040",ie.isHitTestVisible=!1,Y.addControl(ie,2,0);const se=new Vd;se.name="Current Color Label",se.text="current",se.color=c,se.fontSize=Z,Y.addControl(se,3,0);const ne=new jd;ne.name="Button Grid",ne.height=.8;const re=1/3;ne.addRowDefinition(re,!1),ne.addRowDefinition(re,!1),ne.addRowDefinition(re,!1),X.addControl(ne,0,1);const oe=Math.floor(parseInt(t.pickerWidth)*V[1]*Q[1]*.67).toString()+"px",ae=Math.floor(parseInt(t.pickerHeight)*F[1]*W[0]*(parseFloat(ne.height.toString())/100)*re*.7).toString()+"px";b=parseFloat(oe)>parseFloat(ae)?Math.floor(.45*parseFloat(ae)):Math.floor(.11*parseFloat(oe));const le=zd.CreateSimpleButton("butOK","OK");le.width=oe,le.height=ae,le.verticalAlignment=wd.VERTICAL_ALIGNMENT_CENTER,le.thickness=2,le.color=c,le.fontSize=b,le.background=d,le.onPointerEnterObservable.add((()=>{le.background=u})),le.onPointerOutObservable.add((()=>{le.background=d})),le.pointerDownAnimation=()=>{le.background=_},le.pointerUpAnimation=()=>{le.background=u},le.onPointerClickObservable.add((()=>{Ie(!1),De(ee.background)})),ne.addControl(le,0,0);const he=zd.CreateSimpleButton("butCancel","Cancel");he.width=oe,he.height=ae,he.verticalAlignment=wd.VERTICAL_ALIGNMENT_CENTER,he.thickness=2,he.color=c,he.fontSize=b,he.background=d,he.onPointerEnterObservable.add((()=>{he.background=u})),he.onPointerOutObservable.add((()=>{he.background=d})),he.pointerDownAnimation=()=>{he.background=_},he.pointerUpAnimation=()=>{he.background=u},he.onPointerClickObservable.add((()=>{Ie(!1),De(te.background)})),ne.addControl(he,1,0),t.savedColors&&(R=zd.CreateSimpleButton("butSave","Save"),R.width=oe,R.height=ae,R.verticalAlignment=wd.VERTICAL_ALIGNMENT_CENTER,R.thickness=2,R.fontSize=b,t.savedColors.length<t.swatchLimit?(R.color=c,R.background=d):Oe(R,!0),R.onPointerEnterObservable.add((()=>{t.savedColors&&t.savedColors.length<t.swatchLimit&&(R.background=u)})),R.onPointerOutObservable.add((()=>{t.savedColors&&t.savedColors.length<t.swatchLimit&&(R.background=d)})),R.pointerDownAnimation=()=>{t.savedColors&&t.savedColors.length<t.swatchLimit&&(R.background=_)},R.pointerUpAnimation=()=>{t.savedColors&&t.savedColors.length<t.swatchLimit&&(R.background=u)},R.onPointerClickObservable.add((()=>{t.savedColors&&(0==t.savedColors.length&&Me(!0),t.savedColors.length<t.swatchLimit&&Pe(ee.background,R),Ie(!1))})),t.savedColors.length>0&&Me(!0),ne.addControl(R,2,0));const ce=new jd;ce.name="Dialog Lower Right",ce.addRowDefinition(.02,!1),ce.addRowDefinition(.63,!1),ce.addRowDefinition(.21,!1),ce.addRowDefinition(.14,!1),H.addControl(ce,1,0);const de=Re.FromHexString(t.lastColor),ue=new jd;ue.name="RGB Values",ue.width=.82,ue.verticalAlignment=wd.VERTICAL_ALIGNMENT_CENTER,ue.addRowDefinition(1/3,!1),ue.addRowDefinition(1/3,!1),ue.addRowDefinition(1/3,!1),ue.addColumnDefinition(.1,!1),ue.addColumnDefinition(.2,!1),ue.addColumnDefinition(.7,!1),ce.addControl(ue,1,0);for(let e=0;e<S.length;e++){const t=new Vd;t.text=S[e],t.color=c,t.fontSize=b,ue.addControl(t,e,0)}const _e=new Kd;_e.width=.83,_e.height=.72,_e.name="rIntField",_e.fontSize=b,_e.text=(255*de.r).toString(),_e.color=C,_e.background=x,_e.onFocusObservable.add((()=>{P=_e.name,I=_e.text,Ie(!1)})),_e.onBlurObservable.add((()=>{""==_e.text&&(_e.text="0"),Ce(_e,"r"),P==_e.name&&(P="")})),_e.onTextChangedObservable.add((()=>{P==_e.name&&Ce(_e,"r")})),ue.addControl(_e,0,1);const fe=new Kd;fe.width=.83,fe.height=.72,fe.name="gIntField",fe.fontSize=b,fe.text=(255*de.g).toString(),fe.color=C,fe.background=x,fe.onFocusObservable.add((()=>{P=fe.name,I=fe.text,Ie(!1)})),fe.onBlurObservable.add((()=>{""==fe.text&&(fe.text="0"),Ce(fe,"g"),P==fe.name&&(P="")})),fe.onTextChangedObservable.add((()=>{P==fe.name&&Ce(fe,"g")})),ue.addControl(fe,1,1);const pe=new Kd;pe.width=.83,pe.height=.72,pe.name="bIntField",pe.fontSize=b,pe.text=(255*de.b).toString(),pe.color=C,pe.background=x,pe.onFocusObservable.add((()=>{P=pe.name,I=pe.text,Ie(!1)})),pe.onBlurObservable.add((()=>{""==pe.text&&(pe.text="0"),Ce(pe,"b"),P==pe.name&&(P="")})),pe.onTextChangedObservable.add((()=>{P==pe.name&&Ce(pe,"b")})),ue.addControl(pe,2,1);const me=new Kd;me.width=.95,me.height=.72,me.name="rDecField",me.fontSize=b,me.text=de.r.toString(),me.color=C,me.background=x,me.onFocusObservable.add((()=>{P=me.name,I=me.text,Ie(!1)})),me.onBlurObservable.add((()=>{0!=parseFloat(me.text)&&""!=me.text||(me.text="0",ye(me,"r")),P==me.name&&(P="")})),me.onTextChangedObservable.add((()=>{P==me.name&&ye(me,"r")})),ue.addControl(me,0,2);const ge=new Kd;ge.width=.95,ge.height=.72,ge.name="gDecField",ge.fontSize=b,ge.text=de.g.toString(),ge.color=C,ge.background=x,ge.onFocusObservable.add((()=>{P=ge.name,I=ge.text,Ie(!1)})),ge.onBlurObservable.add((()=>{0!=parseFloat(ge.text)&&""!=ge.text||(ge.text="0",ye(ge,"g")),P==ge.name&&(P="")})),ge.onTextChangedObservable.add((()=>{P==ge.name&&ye(ge,"g")})),ue.addControl(ge,1,2);const ve=new Kd;ve.width=.95,ve.height=.72,ve.name="bDecField",ve.fontSize=b,ve.text=de.b.toString(),ve.color=C,ve.background=x,ve.onFocusObservable.add((()=>{P=ve.name,I=ve.text,Ie(!1)})),ve.onBlurObservable.add((()=>{0!=parseFloat(ve.text)&&""!=ve.text||(ve.text="0",ye(ve,"b")),P==ve.name&&(P="")})),ve.onTextChangedObservable.add((()=>{P==ve.name&&ye(ve,"b")})),ue.addControl(ve,2,2);const Te=new jd;Te.name="Hex Value",Te.width=.82,Te.addRowDefinition(1,!1),Te.addColumnDefinition(.1,!1),Te.addColumnDefinition(.9,!1),ce.addControl(Te,2,0);const be=new Vd;be.text="#",be.color=c,be.fontSize=b,Te.addControl(be,0,0);const Ee=new Kd;Ee.width=.96,Ee.height=.72,Ee.name="hexField",Ee.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_CENTER,Ee.fontSize=b;const Se=t.lastColor.split("#");function xe(e,t){P=t;const i=e.toHexString();if(ee.background=i,_e.name!=P&&(_e.text=Math.floor(255*e.r).toString()),fe.name!=P&&(fe.text=Math.floor(255*e.g).toString()),pe.name!=P&&(pe.text=Math.floor(255*e.b).toString()),me.name!=P&&(me.text=e.r.toString()),ge.name!=P&&(ge.text=e.g.toString()),ve.name!=P&&(ve.text=e.b.toString()),Ee.name!=P){const e=i.split("#");Ee.text=e[1]}z.name!=P&&(z.value=e)}function Ce(e,t){let i=e.text;if(/[^0-9]/g.test(i))e.text=I;else if(""!=i&&(Math.floor(parseInt(i))<0?i="0":Math.floor(parseInt(i))>255?i="255":isNaN(parseInt(i))&&(i="0")),P==e.name&&(I=i),""!=i){i=parseInt(i).toString(),e.text=i;const s=Re.FromHexString(ee.background);P==e.name&&xe("r"==t?new Re(parseInt(i)/255,s.g,s.b):"g"==t?new Re(s.r,parseInt(i)/255,s.b):new Re(s.r,s.g,parseInt(i)/255),e.name)}}function ye(e,t){let i=e.text;if(/[^0-9.]/g.test(i))return void(e.text=I);""!=i&&"."!=i&&0!=parseFloat(i)&&(parseFloat(i)<0?i="0.0":parseFloat(i)>1?i="1.0":isNaN(parseFloat(i))&&(i="0.0")),P==e.name&&(I=i),""!=i&&"."!=i&&0!=parseFloat(i)?(i=parseFloat(i).toString(),e.text=i):i="0.0";const s=Re.FromHexString(ee.background);P==e.name&&xe("r"==t?new Re(parseFloat(i),s.g,s.b):"g"==t?new Re(s.r,parseFloat(i),s.b):new Re(s.r,s.g,parseFloat(i)),e.name)}function Ae(){if(t.savedColors&&t.savedColors[y]){let e;e=M?"b":"";const i=zd.CreateSimpleButton("Swatch_"+y,e);i.fontFamily="coreglyphs";const s=Re.FromHexString(t.savedColors[y]),n=s.r+s.g+s.b;i.color=n>g?v:T,i.fontSize=Math.floor(.7*a),i.textBlock.verticalAlignment=wd.VERTICAL_ALIGNMENT_CENTER,i.height=i.width=a.toString()+"px",i.background=t.savedColors[y],i.thickness=2;const r=y;return i.pointerDownAnimation=()=>{i.thickness=4},i.pointerUpAnimation=()=>{i.thickness=3},i.pointerEnterAnimation=()=>{i.thickness=3},i.pointerOutAnimation=()=>{i.thickness=2},i.onPointerClickObservable.add((()=>{var e;M?(e=r,t.savedColors&&t.savedColors.splice(e,1),t.savedColors&&0==t.savedColors.length&&(Me(!1),M=!1),Pe("",R)):t.savedColors&&xe(Re.FromHexString(t.savedColors[r]),i.name)})),i}return null}function Ie(e){let t;if(void 0!==e&&(M=e),M){for(let e=0;e<A.children.length;e++)t=A.children[e],t.textBlock.text="b";void 0!==E&&(E.textBlock.text="Done")}else{for(let e=0;e<A.children.length;e++)t=A.children[e],t.textBlock.text="";void 0!==E&&(E.textBlock.text="Edit")}}function Pe(e,i){if(t.savedColors){""!=e&&t.savedColors.push(e),y=0,A.clearControls();const s=Math.ceil(t.savedColors.length/t.numSwatchesPerLine);let n;if(n=0==s?0:s+1,A.rowCount!=s+n){const e=A.rowCount;for(let t=0;t<e;t++)A.removeRowDefinition(0);for(let e=0;e<s+n;e++)e%2?A.addRowDefinition(a,!0):A.addRowDefinition(r,!0)}A.height=(a*s+n*r).toString()+"px";for(let e=1,i=1;e<s+n;e+=2,i++){let s;s=t.savedColors.length>i*t.numSwatchesPerLine?t.numSwatchesPerLine:t.savedColors.length-(i-1)*t.numSwatchesPerLine;const n=Math.min(Math.max(s,0),t.numSwatchesPerLine);for(let i=0,s=1;i<n;i++){if(i>t.numSwatchesPerLine)continue;const n=Ae();null!=n&&(A.addControl(n,e,s),s+=2,y++)}}t.savedColors.length>=t.swatchLimit?Oe(i,!0):Oe(i,!1)}}function Me(e){e?(E=zd.CreateSimpleButton("butEdit","Edit"),E.width=oe,E.height=ae,E.left=Math.floor(.1*parseInt(oe)).toString()+"px",E.top=(-1*parseFloat(E.left)).toString()+"px",E.verticalAlignment=wd.VERTICAL_ALIGNMENT_BOTTOM,E.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,E.thickness=2,E.color=c,E.fontSize=b,E.background=d,E.onPointerEnterObservable.add((()=>{E.background=u})),E.onPointerOutObservable.add((()=>{E.background=d})),E.pointerDownAnimation=()=>{E.background=_},E.pointerUpAnimation=()=>{E.background=u},E.onPointerClickObservable.add((()=>{M=!M,Ie()})),G.addControl(E,1,0)):G.removeControl(E)}function Oe(e,t){t?(e.color=f,e.background=p):(e.color=c,e.background=d)}function De(s){t.savedColors&&t.savedColors.length>0?i({savedColors:t.savedColors,pickedColor:s}):i({pickedColor:s}),e.removeControl(O)}Ee.text=Se[1],Ee.color=C,Ee.background=x,Ee.onFocusObservable.add((()=>{P=Ee.name,I=Ee.text,Ie(!1)})),Ee.onBlurObservable.add((()=>{if(3==Ee.text.length){const e=Ee.text.split("");Ee.text=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]}""==Ee.text&&(Ee.text="000000",xe(Re.FromHexString(Ee.text),"b")),P==Ee.name&&(P="")})),Ee.onTextChangedObservable.add((()=>{let e=Ee.text;const t=/[^0-9A-F]/i.test(e);if((Ee.text.length>6||t)&&P==Ee.name)Ee.text=I;else{if(Ee.text.length<6){const t=6-Ee.text.length;for(let i=0;i<t;i++)e="0"+e}if(3==Ee.text.length){const t=Ee.text.split("");e=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]}e="#"+e,P==Ee.name&&(I=Ee.text,xe(Re.FromHexString(e),Ee.name))}})),Te.addControl(Ee,0,1),t.savedColors&&t.savedColors.length>0&&Pe("",R)}))}}$d._Epsilon=1e-6,De([Ge()],$d.prototype,"value",null),De([Ge()],$d.prototype,"width",null),De([Ge()],$d.prototype,"height",null),De([Ge()],$d.prototype,"size",null),ue("BABYLON.GUI.ColorPicker",$d);class qd extends Bd{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}constructor(e){super(e),this.name=e,this._thickness=1}_getTypeName(){return"Ellipse"}_localDraw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),wd.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2-this._thickness/2,this._currentMeasure.height/2-this._thickness/2,e),(this._backgroundGradient||this._background)&&(e.fillStyle=this._getBackgroundColor(e),e.fill()),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this._thickness&&(this.color&&(e.strokeStyle=this.color),e.lineWidth=this._thickness,e.stroke()),e.restore()}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.width-=2*this._thickness,this._measureForChildren.height-=2*this._thickness,this._measureForChildren.left+=this._thickness,this._measureForChildren.top+=this._thickness}_clipForChildren(e){wd.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2,this._currentMeasure.height/2,e),e.clip()}_renderHighlightSpecific(e){wd.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2-this._highlightLineWidth/2,this._currentMeasure.height/2-this._highlightLineWidth/2,e),e.stroke()}}De([Ge()],qd.prototype,"thickness",null),ue("BABYLON.GUI.Ellipse",qd),ue("BABYLON.GUI.FocusableButton",class extends zd{constructor(e){super(e),this.name=e,this.focusedColor=null,this._isFocused=!1,this._unfocusedColor=null,this.onFocusObservable=new s,this.onBlurObservable=new s,this.onKeyboardEventProcessedObservable=new s,this._unfocusedColor=this.color}onBlur(){this._isFocused&&(this._isFocused=!1,this.focusedColor&&null!=this._unfocusedColor&&(this.color=this._unfocusedColor),this.onBlurObservable.notifyObservers(this))}onFocus(){this._isFocused=!0,this.focusedColor&&(this._unfocusedColor=this.color,this.color=this.focusedColor),this.onFocusObservable.notifyObservers(this)}keepsFocusWith(){return null}focus(){this._host.moveFocusToControl(this)}blur(){this._host.focusedControl=null}processKeyboard(e){this.onKeyboardEventProcessedObservable.notifyObservers(e,-1,this)}_onPointerDown(e,t,i,s,n){return this.isReadOnly||this.focus(),super._onPointerDown(e,t,i,s,n)}displose(){super.dispose(),this.onBlurObservable.clear(),this.onFocusObservable.clear(),this.onKeyboardEventProcessedObservable.clear()}});class Zd extends Kd{get outlineWidth(){return this._outlineWidth}set outlineWidth(e){this._outlineWidth!==e&&(this._outlineWidth=e,this._markAsDirty())}get outlineColor(){return this._outlineColor}set outlineColor(e){this._outlineColor!==e&&(this._outlineColor=e,this._markAsDirty())}get autoStretchHeight(){return this._autoStretchHeight}set autoStretchHeight(e){this._autoStretchHeight!==e&&(this._autoStretchHeight=e,this._markAsDirty())}set height(e){this.fixedRatioMasterIsWidth=!1,this._height.toString(this._host)!==e&&(this._height.fromString(e)&&this._markAsDirty(),this._autoStretchHeight=!1)}get maxHeight(){return this._maxHeight.toString(this._host)}get maxHeightInPixels(){return this._maxHeight.getValueInPixel(this._host,this._cachedParentMeasure.height)}set maxHeight(e){this._maxHeight.toString(this._host)!==e&&this._maxHeight.fromString(e)&&this._markAsDirty()}constructor(e,t=""){super(e),this.name=e,this._textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,this._textVerticalAlignment=wd.VERTICAL_ALIGNMENT_TOP,this._prevText=this.text,this._lineSpacing=new Rd(0),this._outlineWidth=0,this._outlineColor="white",this._maxHeight=new Rd(1,Rd.UNITMODE_PERCENTAGE,!1),this.onLinesReadyObservable=new s,this.text=t,this.isPointerBlocker=!0,this.onLinesReadyObservable.add((()=>this._updateCursorPosition())),this._highlightCursorInfo={initialStartIndex:-1,initialRelativeStartIndex:-1,initialLineIndex:-1},this._cursorInfo={globalStartIndex:0,globalEndIndex:0,relativeEndIndex:0,relativeStartIndex:0,currentLineIndex:0}}_getTypeName(){return"InputTextArea"}processKeyboard(e){this.isReadOnly||(this.alternativeProcessKey(e.code,e.key,e),this.onKeyboardEventProcessedObservable.notifyObservers(e))}alternativeProcessKey(e,t,i){if(!i||!i.ctrlKey&&!i.metaKey||"KeyC"!==e&&"KeyV"!==e&&"KeyX"!==e){switch(e){case"KeyA":if(i&&(i.ctrlKey||i.metaKey))return this._selectAllText(),void i.preventDefault();break;case"Period":i&&i.shiftKey&&i.preventDefault();break;case"Backspace":!this._isTextHighlightOn&&this._cursorInfo.globalStartIndex>0&&(this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._cursorInfo.globalStartIndex--),this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex),this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,i&&i.preventDefault(),this._blinkIsEven=!1,this._isTextHighlightOn=!1,this._textHasChanged();break;case"Delete":!this._isTextHighlightOn&&this._cursorInfo.globalEndIndex<this.text.length&&(this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex+1),this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex),this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,i&&i.preventDefault(),this._blinkIsEven=!1,this._isTextHighlightOn=!1,this._textHasChanged();break;case"Enter":return this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex,"\n"),this._cursorInfo.globalStartIndex++,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._blinkIsEven=!1,this._isTextHighlightOn=!1,void this._textHasChanged();case"End":return this._cursorInfo.globalStartIndex=this.text.length,this._blinkIsEven=!1,this._isTextHighlightOn=!1,void this._markAsDirty();case"Home":return this._cursorInfo.globalStartIndex=0,this._blinkIsEven=!1,this._isTextHighlightOn=!1,void this._markAsDirty();case"ArrowLeft":return this._markAsDirty(),i&&i.shiftKey?((i.ctrlKey||i.metaKey)&&(this._cursorInfo.globalStartIndex-=this._cursorInfo.relativeStartIndex,this._cursorInfo.globalEndIndex=this._highlightCursorInfo.initialStartIndex),this._isTextHighlightOn?this._cursorInfo.globalEndIndex>this._highlightCursorInfo.initialStartIndex?this._cursorInfo.globalEndIndex--:this._cursorInfo.globalStartIndex--:(this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this._highlightCursorInfo.initialRelativeStartIndex=this._cursorInfo.relativeStartIndex,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._cursorInfo.globalStartIndex--,this._isTextHighlightOn=!0),this._blinkIsEven=!0,void i.preventDefault()):(this._isTextHighlightOn?this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex:i&&(i.ctrlKey||i.metaKey)?(this._cursorInfo.globalStartIndex-=this._cursorInfo.relativeStartIndex,i.preventDefault()):this._cursorInfo.globalStartIndex>0&&this._cursorInfo.globalStartIndex--,this._blinkIsEven=!1,void(this._isTextHighlightOn=!1));case"ArrowRight":if(this._markAsDirty(),i&&i.shiftKey){if(i.ctrlKey||i.metaKey){const e=this._lines[this._cursorInfo.currentLineIndex].text.length-this._cursorInfo.relativeEndIndex-1;this._cursorInfo.globalEndIndex+=e,this._cursorInfo.globalStartIndex=this._highlightCursorInfo.initialStartIndex}return this._isTextHighlightOn?this._cursorInfo.globalStartIndex<this._highlightCursorInfo.initialStartIndex?this._cursorInfo.globalStartIndex++:this._cursorInfo.globalEndIndex++:(this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this._highlightCursorInfo.initialRelativeStartIndex=this._cursorInfo.relativeStartIndex,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex++,this._isTextHighlightOn=!0),this._blinkIsEven=!0,void i.preventDefault()}if(this._isTextHighlightOn)this._cursorInfo.globalStartIndex=this._cursorInfo.globalEndIndex;else if(i&&(i.ctrlKey||i.metaKey)){const e=this._lines[this._cursorInfo.currentLineIndex].text.length-this._cursorInfo.relativeEndIndex;this._cursorInfo.globalStartIndex+=e}else this._cursorInfo.globalStartIndex<this.text.length&&this._cursorInfo.globalStartIndex++;return this._blinkIsEven=!1,void(this._isTextHighlightOn=!1);case"ArrowUp":if(this._blinkIsEven=!1,i&&(i.shiftKey?(this._isTextHighlightOn||(this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this._highlightCursorInfo.initialRelativeStartIndex=this._cursorInfo.relativeStartIndex),this._isTextHighlightOn=!0,this._blinkIsEven=!0):this._isTextHighlightOn=!1,i.preventDefault()),0===this._cursorInfo.currentLineIndex)this._cursorInfo.globalStartIndex=0;else{const e=this._lines[this._cursorInfo.currentLineIndex],t=this._lines[this._cursorInfo.currentLineIndex-1];let i=0,s=0;!this._isTextHighlightOn||this._cursorInfo.currentLineIndex<this._highlightCursorInfo.initialLineIndex?(i=this._cursorInfo.globalStartIndex,s=this._cursorInfo.relativeStartIndex):(i=this._cursorInfo.globalEndIndex,s=this._cursorInfo.relativeEndIndex);const n=e.text.substr(0,s),r=this._contextForBreakLines.measureText(n).width;let o=0,a=0;i-=s,i-=t.text.length+t.lineEnding.length;let l=0;for(;o<r&&l<t.text.length;)i++,l++,a=Math.abs(r-o),o=this._contextForBreakLines.measureText(t.text.substr(0,l)).width;Math.abs(r-o)>a&&l>0&&i--,this._isTextHighlightOn?this._cursorInfo.currentLineIndex<=this._highlightCursorInfo.initialLineIndex?(this._cursorInfo.globalStartIndex=i,this._cursorInfo.globalEndIndex=this._highlightCursorInfo.initialStartIndex,this._cursorInfo.relativeEndIndex=this._highlightCursorInfo.initialRelativeStartIndex):this._cursorInfo.globalEndIndex=i:this._cursorInfo.globalStartIndex=i}return void this._markAsDirty();case"ArrowDown":if(this._blinkIsEven=!1,i&&(i.shiftKey?(this._isTextHighlightOn||(this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this._highlightCursorInfo.initialRelativeStartIndex=this._cursorInfo.relativeStartIndex),this._isTextHighlightOn=!0,this._blinkIsEven=!0):this._isTextHighlightOn=!1,i.preventDefault()),this._cursorInfo.currentLineIndex===this._lines.length-1)this._cursorInfo.globalStartIndex=this.text.length;else{const e=this._lines[this._cursorInfo.currentLineIndex],t=this._lines[this._cursorInfo.currentLineIndex+1];let i=0,s=0;!this._isTextHighlightOn||this._cursorInfo.currentLineIndex<this._highlightCursorInfo.initialLineIndex?(i=this._cursorInfo.globalStartIndex,s=this._cursorInfo.relativeStartIndex):(i=this._cursorInfo.globalEndIndex,s=this._cursorInfo.relativeEndIndex);const n=e.text.substr(0,s),r=this._contextForBreakLines.measureText(n).width;let o=0,a=0;i+=e.text.length-s+e.lineEnding.length;let l=0;for(;o<r&&l<t.text.length;)i++,l++,a=Math.abs(r-o),o=this._contextForBreakLines.measureText(t.text.substr(0,l)).width;Math.abs(r-o)>a&&l>0&&i--,this._isTextHighlightOn?this._cursorInfo.currentLineIndex<this._highlightCursorInfo.initialLineIndex?(this._cursorInfo.globalStartIndex=i,this._cursorInfo.globalStartIndex>this._cursorInfo.globalEndIndex&&(this._cursorInfo.globalEndIndex+=this._cursorInfo.globalStartIndex,this._cursorInfo.globalStartIndex=this._cursorInfo.globalEndIndex-this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex-=this._cursorInfo.globalStartIndex)):(this._cursorInfo.globalEndIndex=i,this._cursorInfo.globalStartIndex=this._highlightCursorInfo.initialStartIndex):this._cursorInfo.globalStartIndex=i}return void this._markAsDirty()}1===(null==t?void 0:t.length)&&(null==i||i.preventDefault(),this._currentKey=t,this.onBeforeKeyAddObservable.notifyObservers(this),t=this._currentKey,this._addKey&&(this._isTextHighlightOn=!1,this._blinkIsEven=!1,this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex,t),this._cursorInfo.globalStartIndex+=t.length,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._textHasChanged()))}}_parseLineWordWrap(e="",t,i){const s=[],n=e.split(" ");let r=0;for(let o=0;o<n.length;o++){const a=o>0?e+" "+n[o]:n[0],l=i.measureText(a).width;if(l>t){o>0&&(r=i.measureText(e).width,s.push({text:e,width:r,lineEnding:" "})),e=n[o];let a="";e.split("").map((e=>{i.measureText(a+e).width>t&&(s.push({text:a,width:i.measureText(a).width,lineEnding:""}),a=""),a+=e})),e=a,r=i.measureText(e).width}else r=l,e=a}return s.push({text:e,width:r,lineEnding:" "}),s}_breakLines(e,t){const i=[],s=(this.text||this.placeholderText).split("\n");if(this.clipContent)for(const n of s)i.push(...this._parseLineWordWrap(n,e,t));else for(const e of s)i.push(this._parseLine(e,t));return i[i.length-1].lineEnding="\n",i}_parseLine(e="",t){return{text:e,width:t.measureText(e).width,lineEnding:" "}}_preMeasure(e,t){this._fontOffset&&!this._wasDirty||(this._fontOffset=wd._GetFontOffset(t.font));let i=this._beforeRenderText(this._textWrapper).text;!this.text&&this._placeholderText&&(i=this._placeholderText),this._textWidth=t.measureText(i).width;const s=2*this._margin.getValueInPixel(this._host,e.width);if(this._autoStretchWidth){const n=i.split("\n").reduce(((e,i)=>t.measureText(i).width>t.measureText(e).width?i:e),""),r=t.measureText(n).width;this.width=Math.min(this._maxWidth.getValueInPixel(this._host,e.width),r+s)+"px",this.autoStretchWidth=!0}if(this._availableWidth=this._width.getValueInPixel(this._host,e.width)-s,this._lines=this._breakLines(this._availableWidth,t),this._contextForBreakLines=t,this._autoStretchHeight){const t=this._lines.length*this._fontOffset.height+2*this._margin.getValueInPixel(this._host,e.height);this.height=Math.min(this._maxHeight.getValueInPixel(this._host,e.height),t)+"px",this._autoStretchHeight=!0}if(this._availableHeight=this._height.getValueInPixel(this._host,e.height)-s,this._isFocused){this._cursorInfo.currentLineIndex=0;let e=this._lines[this._cursorInfo.currentLineIndex].text.length+this._lines[this._cursorInfo.currentLineIndex].lineEnding.length,t=0;for(;t+e<=this._cursorInfo.globalStartIndex;)t+=e,this._cursorInfo.currentLineIndex<this._lines.length-1&&(this._cursorInfo.currentLineIndex++,e=this._lines[this._cursorInfo.currentLineIndex].text.length+this._lines[this._cursorInfo.currentLineIndex].lineEnding.length)}}_textHasChanged(){!this._prevText&&this._textWrapper.text&&this.placeholderText&&(this._cursorInfo.currentLineIndex=0,this._cursorInfo.globalStartIndex=1,this._cursorInfo.globalEndIndex=1,this._cursorInfo.relativeStartIndex=1,this._cursorInfo.relativeEndIndex=1),super._textHasChanged()}_computeScroll(){if(this._clipTextLeft=this._currentMeasure.left+this._margin.getValueInPixel(this._host,this._cachedParentMeasure.width),this._clipTextTop=this._currentMeasure.top+this._margin.getValueInPixel(this._host,this._cachedParentMeasure.height),this._isFocused&&this._lines[this._cursorInfo.currentLineIndex].width>this._availableWidth){const e=this._clipTextLeft-this._lines[this._cursorInfo.currentLineIndex].width+this._availableWidth;this._scrollLeft||(this._scrollLeft=e)}else this._scrollLeft=this._clipTextLeft;if(this._isFocused&&!this._autoStretchHeight){const e=(this._cursorInfo.currentLineIndex+1)*this._fontOffset.height,t=this._clipTextTop-e;this._scrollTop||(this._scrollTop=t)}else this._scrollTop=this._clipTextTop}_additionalProcessing(){this.highlightedText="",this.onLinesReadyObservable.notifyObservers(this)}_drawText(e,t,i,s){const n=this._currentMeasure.width;let r=this._scrollLeft;switch(this._textHorizontalAlignment){case wd.HORIZONTAL_ALIGNMENT_LEFT:r+=0;break;case wd.HORIZONTAL_ALIGNMENT_RIGHT:r+=n-t;break;case wd.HORIZONTAL_ALIGNMENT_CENTER:r+=(n-t)/2}(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(s.shadowColor=this.shadowColor,s.shadowBlur=this.shadowBlur,s.shadowOffsetX=this.shadowOffsetX,s.shadowOffsetY=this.shadowOffsetY),this.outlineWidth&&s.strokeText(e,this._currentMeasure.left+r,i),s.fillText(e,r,i)}_onCopyText(e){this._isTextHighlightOn=!1;try{e.clipboardData&&e.clipboardData.setData("text/plain",this._highlightedText)}catch(e){}this._host.clipboardData=this._highlightedText}_onCutText(e){if(this._highlightedText){try{e.clipboardData&&e.clipboardData.setData("text/plain",this._highlightedText)}catch(e){}this._host.clipboardData=this._highlightedText,this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex),this._textHasChanged()}}_onPasteText(e){let t="";t=e.clipboardData&&-1!==e.clipboardData.types.indexOf("text/plain")?e.clipboardData.getData("text/plain"):this._host.clipboardData,this._isTextHighlightOn=!1,this._prevText=this._textWrapper.text,this._textWrapper.removePart(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex,t);const i=t.length-(this._cursorInfo.globalEndIndex-this._cursorInfo.globalStartIndex);this._cursorInfo.globalStartIndex+=i,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._textHasChanged()}_draw(e){var t,i;this._computeScroll(),this._scrollLeft=null!==(t=this._scrollLeft)&&void 0!==t?t:0,this._scrollTop=null!==(i=this._scrollTop)&&void 0!==i?i:0,e.save(),this._applyStates(e),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._isFocused?this._focusedBackground&&(e.fillStyle=this._isEnabled?this._focusedBackground:this._disabledColor,e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)):this._background&&(e.fillStyle=this._isEnabled?this._background:this._disabledColor,e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),this.color&&(e.fillStyle=this.color);const s=this._currentMeasure.height,n=this._currentMeasure.width;let r=0;switch(this._textVerticalAlignment){case wd.VERTICAL_ALIGNMENT_TOP:r=this._fontOffset.ascent;break;case wd.VERTICAL_ALIGNMENT_BOTTOM:r=s-this._fontOffset.height*(this._lines.length-1)-this._fontOffset.descent;break;case wd.VERTICAL_ALIGNMENT_CENTER:r=this._fontOffset.ascent+(s-this._fontOffset.height*this._lines.length)/2}e.save(),e.beginPath(),e.fillStyle=this.fontStyle,!this._textWrapper.text&&this.placeholderText&&(e.fillStyle=this._placeholderColor),e.rect(this._clipTextLeft,this._clipTextTop,this._availableWidth+2,this._availableHeight+2),e.clip(),r+=this._scrollTop;for(let t=0;t<this._lines.length;t++){const i=this._lines[t];0!==t&&0!==this._lineSpacing.internalValue&&(this._lineSpacing.isPixel?r+=this._lineSpacing.getValue(this._host):r+=this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height)),this._drawText(i.text,i.width,r,e),r+=this._fontOffset.height}if(e.restore(),this._isFocused){if(!this._blinkIsEven||this._isTextHighlightOn){let t=this._scrollLeft+e.measureText(this._lines[this._cursorInfo.currentLineIndex].text.substr(0,this._cursorInfo.relativeStartIndex)).width;t<this._clipTextLeft?(this._scrollLeft+=this._clipTextLeft-t,t=this._clipTextLeft,this._markAsDirty()):t>this._clipTextLeft+this._availableWidth&&(this._scrollLeft+=this._clipTextLeft+this._availableWidth-t,t=this._clipTextLeft+this._availableWidth,this._markAsDirty());let i=this._scrollTop+this._cursorInfo.currentLineIndex*this._fontOffset.height;i<this._clipTextTop?(this._scrollTop+=this._clipTextTop-i,i=this._clipTextTop,this._markAsDirty()):i+this._fontOffset.height>this._clipTextTop+this._availableHeight&&(this._scrollTop+=this._clipTextTop+this._availableHeight-i-this._fontOffset.height,i=this._clipTextTop+this._availableHeight-this._fontOffset.height,this._markAsDirty()),this._isTextHighlightOn||e.fillRect(t,i,2,this._fontOffset.height)}if(this._resetBlinking(),this._isTextHighlightOn){clearTimeout(this._blinkTimeout),this._highlightedText=this.text.substring(this._cursorInfo.globalStartIndex,this._cursorInfo.globalEndIndex),e.globalAlpha=this._highligherOpacity,e.fillStyle=this._textHighlightColor;const t=Math.min(this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialLineIndex),i=Math.max(this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialLineIndex);let s=this._scrollTop+t*this._fontOffset.height;for(let r=t;r<=i;r++){const o=this._lines[r];let a=this._scrollLeft;switch(this._textHorizontalAlignment){case wd.HORIZONTAL_ALIGNMENT_LEFT:a+=0;break;case wd.HORIZONTAL_ALIGNMENT_RIGHT:a+=n-o.width;break;case wd.HORIZONTAL_ALIGNMENT_CENTER:a+=(n-o.width)/2}const l=r===t?this._cursorInfo.relativeStartIndex:0,h=r===i?this._cursorInfo.relativeEndIndex:o.text.length,c=e.measureText(o.text.substr(0,l)).width,d=o.text.substring(l,h),u=e.measureText(d).width;e.fillRect(a+c,s,u,this._fontOffset.height),s+=this._fontOffset.height}this._cursorInfo.globalEndIndex===this._cursorInfo.globalStartIndex&&this._resetBlinking()}}e.restore(),this._thickness&&(this._isFocused?this.focusedColor&&(e.strokeStyle=this.focusedColor):this.color&&(e.strokeStyle=this.color),e.lineWidth=this._thickness,e.strokeRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,this._currentMeasure.width-this._thickness,this._currentMeasure.height-this._thickness))}_resetBlinking(){clearTimeout(this._blinkTimeout),this._blinkTimeout=setTimeout((()=>{this._blinkIsEven=!this._blinkIsEven,this._markAsDirty()}),500)}_applyStates(e){super._applyStates(e),this.outlineWidth&&(e.lineWidth=this.outlineWidth,e.strokeStyle=this.outlineColor)}_onPointerDown(e,t,i,s,n){return!(!super._onPointerDown(e,t,i,s,n)||!this.isReadOnly&&(this._clickedCoordinateX=t.x,this._clickedCoordinateY=t.y,this._isTextHighlightOn=!1,this._highlightedText="",this._isPointerDown=!0,this._host._capturingControl[i]=this,this._host.focusedControl===this?(clearTimeout(this._blinkTimeout),this._markAsDirty(),0):!this._isEnabled||(this._host.focusedControl=this,0)))}_onPointerMove(e,t,i,s){0===s.event.movementX&&0===s.event.movementY||(this._host.focusedControl===this&&this._isPointerDown&&!this.isReadOnly&&(this._clickedCoordinateX=t.x,this._clickedCoordinateY=t.y,this._isTextHighlightOn||(this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this._highlightCursorInfo.initialRelativeStartIndex=this._cursorInfo.relativeStartIndex,this._isTextHighlightOn=!0),this._markAsDirty()),super._onPointerMove(e,t,i,s))}_updateCursorPosition(){var e;if(this._isFocused)if(!this._textWrapper.text&&this.placeholderText)this._cursorInfo.currentLineIndex=0,this._cursorInfo.globalStartIndex=0,this._cursorInfo.globalEndIndex=0,this._cursorInfo.relativeStartIndex=0,this._cursorInfo.relativeEndIndex=0;else if(this._clickedCoordinateX&&this._clickedCoordinateY){this._isTextHighlightOn||(this._cursorInfo={globalStartIndex:0,globalEndIndex:0,relativeStartIndex:0,relativeEndIndex:0,currentLineIndex:0});let t=0,i=0;const s=this._clickedCoordinateY-this._scrollTop,n=Math.floor(s/this._fontOffset.height);this._cursorInfo.currentLineIndex=Math.min(Math.max(n,0),this._lines.length-1);let r=0;const o=this._clickedCoordinateX-(null!==(e=this._scrollLeft)&&void 0!==e?e:0);let a=0;for(let e=0;e<this._cursorInfo.currentLineIndex;e++){const i=this._lines[e];t+=i.text.length+i.lineEnding.length}for(;r<o&&this._lines[this._cursorInfo.currentLineIndex].text.length>i;)i++,a=Math.abs(o-r),r=this._contextForBreakLines.measureText(this._lines[this._cursorInfo.currentLineIndex].text.substr(0,i)).width;Math.abs(o-r)>a&&i>0&&i--,t+=i,this._isTextHighlightOn?t<this._highlightCursorInfo.initialStartIndex?(this._cursorInfo.globalStartIndex=t,this._cursorInfo.relativeStartIndex=i,this._cursorInfo.globalEndIndex=this._highlightCursorInfo.initialStartIndex,this._cursorInfo.relativeEndIndex=this._highlightCursorInfo.initialRelativeStartIndex):(this._cursorInfo.globalStartIndex=this._highlightCursorInfo.initialStartIndex,this._cursorInfo.relativeStartIndex=this._highlightCursorInfo.initialRelativeStartIndex,this._cursorInfo.globalEndIndex=t,this._cursorInfo.relativeEndIndex=i):(this._cursorInfo.globalStartIndex=t,this._cursorInfo.relativeStartIndex=i,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex,this._cursorInfo.relativeEndIndex=this._cursorInfo.relativeStartIndex),this._blinkIsEven=this._isTextHighlightOn,this._clickedCoordinateX=null,this._clickedCoordinateY=null}else{this._cursorInfo.relativeStartIndex=0,this._cursorInfo.currentLineIndex=0;let e=this._lines[this._cursorInfo.currentLineIndex].text.length+this._lines[this._cursorInfo.currentLineIndex].lineEnding.length,t=0;for(;t+e<=this._cursorInfo.globalStartIndex;)t+=e,this._cursorInfo.currentLineIndex<this._lines.length-1&&(this._cursorInfo.currentLineIndex++,e=this._lines[this._cursorInfo.currentLineIndex].text.length+this._lines[this._cursorInfo.currentLineIndex].lineEnding.length);if(this._cursorInfo.relativeStartIndex=this._cursorInfo.globalStartIndex-t,-1!==this._highlightCursorInfo.initialStartIndex&&this._cursorInfo.globalStartIndex>=this._highlightCursorInfo.initialStartIndex){for(;t+e<=this._cursorInfo.globalEndIndex;)t+=e,this._cursorInfo.currentLineIndex<this._lines.length-1&&(this._cursorInfo.currentLineIndex++,e=this._lines[this._cursorInfo.currentLineIndex].text.length+this._lines[this._cursorInfo.currentLineIndex].lineEnding.length);this._cursorInfo.relativeEndIndex=this._cursorInfo.globalEndIndex-t}else this._isTextHighlightOn||(this._cursorInfo.relativeEndIndex=this._cursorInfo.relativeStartIndex,this._cursorInfo.globalEndIndex=this._cursorInfo.globalStartIndex)}}_updateValueFromCursorIndex(e){}_processDblClick(e){let t,i;do{t=this._cursorInfo.globalStartIndex>0&&this._textWrapper.isWord(this._cursorInfo.globalStartIndex-1)?--this._cursorInfo.globalStartIndex:0,i=this._cursorInfo.globalEndIndex<this._textWrapper.length&&this._textWrapper.isWord(this._cursorInfo.globalEndIndex)?++this._cursorInfo.globalEndIndex:0}while(t||i);this._highlightCursorInfo.initialLineIndex=this._cursorInfo.currentLineIndex,this._highlightCursorInfo.initialStartIndex=this._cursorInfo.globalStartIndex,this.onTextHighlightObservable.notifyObservers(this),this._isTextHighlightOn=!0,this._blinkIsEven=!0,this._markAsDirty()}_selectAllText(){this._isTextHighlightOn=!0,this._blinkIsEven=!0,this._highlightCursorInfo={initialStartIndex:0,initialRelativeStartIndex:0,initialLineIndex:0},this._cursorInfo={globalStartIndex:0,globalEndIndex:this._textWrapper.length,relativeEndIndex:this._lines[this._lines.length-1].text.length,relativeStartIndex:0,currentLineIndex:this._lines.length-1},this._markAsDirty()}dispose(){super.dispose(),this.onLinesReadyObservable.clear()}}De([Ge()],Zd.prototype,"autoStretchHeight",null),De([Ge()],Zd.prototype,"maxHeight",null),ue("BABYLON.GUI.InputTextArea",Zd),ue("BABYLON.GUI.InputPassword",class extends Kd{_getTypeName(){return"InputPassword"}_beforeRenderText(e){const t=new Yd;let i="";for(let t=0;t<e.length;t++)i+="";return t.text=i,t}});class Jd extends wd{get dash(){return this._dash}set dash(e){this._dash!==e&&(this._dash=e,this._markAsDirty())}get connectedControl(){return this._connectedControl}set connectedControl(e){this._connectedControl!==e&&(this._connectedControlDirtyObserver&&this._connectedControl&&(this._connectedControl.onDirtyObservable.remove(this._connectedControlDirtyObserver),this._connectedControlDirtyObserver=null),e&&(this._connectedControlDirtyObserver=e.onDirtyObservable.add((()=>this._markAsDirty()))),this._connectedControl=e,this._markAsDirty())}get x1(){return this._x1.toString(this._host)}set x1(e){this._x1.toString(this._host)!==e&&this._x1.fromString(e)&&this._markAsDirty()}get y1(){return this._y1.toString(this._host)}set y1(e){this._y1.toString(this._host)!==e&&this._y1.fromString(e)&&this._markAsDirty()}get x2(){return this._x2.toString(this._host)}set x2(e){this._x2.toString(this._host)!==e&&this._x2.fromString(e)&&this._markAsDirty()}get y2(){return this._y2.toString(this._host)}set y2(e){this._y2.toString(this._host)!==e&&this._y2.fromString(e)&&this._markAsDirty()}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth!==e&&(this._lineWidth=e,this._markAsDirty())}set horizontalAlignment(e){}set verticalAlignment(e){}get _effectiveX2(){return(this._connectedControl?this._connectedControl.centerX:0)+this._x2.getValue(this._host)}get _effectiveY2(){return(this._connectedControl?this._connectedControl.centerY:0)+this._y2.getValue(this._host)}constructor(e){super(e),this.name=e,this._lineWidth=1,this._x1=new Rd(0),this._y1=new Rd(0),this._x2=new Rd(0),this._y2=new Rd(0),this._dash=new Array,this._automaticSize=!0,this.isHitTestVisible=!1,this._horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,this._verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP}_getTypeName(){return"Line"}_draw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._applyStates(e),e.strokeStyle=this._getColor(e),e.lineWidth=this._lineWidth,e.setLineDash(this._dash),e.beginPath(),e.moveTo(this._cachedParentMeasure.left+this._x1.getValue(this._host),this._cachedParentMeasure.top+this._y1.getValue(this._host)),e.lineTo(this._cachedParentMeasure.left+this._effectiveX2,this._cachedParentMeasure.top+this._effectiveY2),e.stroke(),e.restore()}_measure(){this._currentMeasure.width=Math.abs(this._x1.getValue(this._host)-this._effectiveX2)+this._lineWidth,this._currentMeasure.height=Math.abs(this._y1.getValue(this._host)-this._effectiveY2)+this._lineWidth}_computeAlignment(e){this._currentMeasure.left=e.left+Math.min(this._x1.getValue(this._host),this._effectiveX2)-this._lineWidth/2,this._currentMeasure.top=e.top+Math.min(this._y1.getValue(this._host),this._effectiveY2)-this._lineWidth/2}moveToVector3(e,t,i=!1){if(!this._host||this.parent!==this._host._rootContainer)return void Ot.Error("Cannot move a control to a vector3 if the control is not at root level");const s=this._host._getGlobalViewport(),n=me.Project(e,Te.IdentityReadOnly,t.getTransformMatrix(),s);this._moveToProjectedPosition(n,i),n.z<0||n.z>1?this.notRenderable=!0:this.notRenderable=!1}_moveToProjectedPosition(e,t=!1){const i=e.x+this._linkOffsetX.getValue(this._host)+"px",s=e.y+this._linkOffsetY.getValue(this._host)+"px";t?(this.x2=i,this.y2=s,this._x2.ignoreAdaptiveScaling=!0,this._y2.ignoreAdaptiveScaling=!0):(this.x1=i,this.y1=s,this._x1.ignoreAdaptiveScaling=!0,this._y1.ignoreAdaptiveScaling=!0)}}De([Ge()],Jd.prototype,"dash",null),De([Ge()],Jd.prototype,"x1",null),De([Ge()],Jd.prototype,"y1",null),De([Ge()],Jd.prototype,"x2",null),De([Ge()],Jd.prototype,"y2",null),De([Ge()],Jd.prototype,"lineWidth",null),ue("BABYLON.GUI.Line",Jd);class eu{constructor(e){this._multiLine=e,this._x=new Rd(0),this._y=new Rd(0),this._point=new me(0,0,0)}get x(){return this._x.toString(this._multiLine._host)}set x(e){this._x.toString(this._multiLine._host)!==e&&this._x.fromString(e)&&this._multiLine._markAsDirty()}get y(){return this._y.toString(this._multiLine._host)}set y(e){this._y.toString(this._multiLine._host)!==e&&this._y.fromString(e)&&this._multiLine._markAsDirty()}get control(){return this._control}set control(e){this._control!==e&&(this._control&&this._controlObserver&&(this._control.onDirtyObservable.remove(this._controlObserver),this._controlObserver=null),this._control=e,this._control&&(this._controlObserver=this._control.onDirtyObservable.add(this._multiLine.onPointUpdate)),this._multiLine._markAsDirty())}get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh&&this._meshObserver&&this._mesh.getScene().onAfterCameraRenderObservable.remove(this._meshObserver),this._mesh=e,this._mesh&&(this._meshObserver=this._mesh.getScene().onAfterCameraRenderObservable.add(this._multiLine.onPointUpdate)),this._multiLine._markAsDirty())}resetLinks(){this.control=null,this.mesh=null}translate(){return this._point=this._translatePoint(),this._point}_translatePoint(){if(null!=this._mesh)return this._multiLine._host.getProjectedPositionWithZ(this._mesh.getBoundingInfo().boundingSphere.center,this._mesh.getWorldMatrix());if(null!=this._control)return new me(this._control.centerX,this._control.centerY,1-ae);{const e=this._multiLine._host,t=this._x.getValueInPixel(e,Number(e._canvas.width)),i=this._y.getValueInPixel(e,Number(e._canvas.height));return new me(t,i,1-ae)}}dispose(){this.resetLinks()}}class tu extends wd{constructor(e){super(e),this.name=e,this._lineWidth=1,this.onPointUpdate=()=>{this._markAsDirty()},this._automaticSize=!0,this.isHitTestVisible=!1,this._horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,this._verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP,this._dash=[],this._points=[]}get dash(){return this._dash}set dash(e){this._dash!==e&&(this._dash=e,this._markAsDirty())}getAt(e){return this._points[e]||(this._points[e]=new eu(this)),this._points[e]}add(...e){return e.map((e=>this.push(e)))}push(e){const t=this.getAt(this._points.length);return null==e||(e instanceof Gn?t.mesh=e:e instanceof wd?t.control=e:null!=e.x&&null!=e.y&&(t.x=e.x,t.y=e.y)),t}remove(e){let t;if(e instanceof eu){if(t=this._points.indexOf(e),-1===t)return}else t=e;const i=this._points[t];i&&(i.dispose(),this._points.splice(t,1))}reset(){for(;this._points.length>0;)this.remove(this._points.length-1)}resetLinks(){this._points.forEach((e=>{null!=e&&e.resetLinks()}))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth!==e&&(this._lineWidth=e,this._markAsDirty())}set horizontalAlignment(e){}set verticalAlignment(e){}_getTypeName(){return"MultiLine"}_draw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._applyStates(e),e.strokeStyle=this.color,e.lineWidth=this._lineWidth,e.setLineDash(this._dash),e.beginPath();let t,i=!0;this._points.forEach((s=>{s&&(i?(e.moveTo(s._point.x,s._point.y),i=!1):s._point.z<1&&t.z<1?e.lineTo(s._point.x,s._point.y):e.moveTo(s._point.x,s._point.y),t=s._point)})),e.stroke(),e.restore()}_additionalProcessing(){this._minX=null,this._minY=null,this._maxX=null,this._maxY=null,this._points.forEach((e=>{e&&(e.translate(),(null==this._minX||e._point.x<this._minX)&&(this._minX=e._point.x),(null==this._minY||e._point.y<this._minY)&&(this._minY=e._point.y),(null==this._maxX||e._point.x>this._maxX)&&(this._maxX=e._point.x),(null==this._maxY||e._point.y>this._maxY)&&(this._maxY=e._point.y))})),null==this._minX&&(this._minX=0),null==this._minY&&(this._minY=0),null==this._maxX&&(this._maxX=0),null==this._maxY&&(this._maxY=0)}_measure(){null!=this._minX&&null!=this._maxX&&null!=this._minY&&null!=this._maxY&&(this._currentMeasure.width=Math.abs(this._maxX-this._minX)+this._lineWidth,this._currentMeasure.height=Math.abs(this._maxY-this._minY)+this._lineWidth)}_computeAlignment(){null!=this._minX&&null!=this._minY&&(this._currentMeasure.left=this._minX-this._lineWidth/2,this._currentMeasure.top=this._minY-this._lineWidth/2)}dispose(){this.reset(),super.dispose()}}De([Ge()],tu.prototype,"dash",null),ue("BABYLON.GUI.MultiLine",tu);class iu extends wd{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get checkSizeRatio(){return this._checkSizeRatio}set checkSizeRatio(e){e=Math.max(Math.min(1,e),0),this._checkSizeRatio!==e&&(this._checkSizeRatio=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get isChecked(){return this._isChecked}set isChecked(e){this._isChecked!==e&&(this._isChecked=e,this._markAsDirty(),this.onIsCheckedChangedObservable.notifyObservers(e),this._isChecked&&this._host&&this._host.executeOnAllControls((e=>{if(e===this)return;if(void 0===e.group)return;const t=e;t.group===this.group&&(t.isChecked=!1)})))}constructor(e){super(e),this.name=e,this._isChecked=!1,this._background="black",this._checkSizeRatio=.8,this._thickness=1,this.group="",this.onIsCheckedChangedObservable=new s,this.isPointerBlocker=!0}_getTypeName(){return"RadioButton"}_draw(e){e.save(),this._applyStates(e);const t=this._currentMeasure.width-this._thickness,i=this._currentMeasure.height-this._thickness;if((this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),wd.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,this._currentMeasure.width/2-this._thickness/2,this._currentMeasure.height/2-this._thickness/2,e),e.fillStyle=this._isEnabled?this._background:this._disabledColor,e.fill(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),e.strokeStyle=this.color,e.lineWidth=this._thickness,e.stroke(),this._isChecked){e.fillStyle=this._isEnabled?this.color:this._disabledColor;const s=t*this._checkSizeRatio,n=i*this._checkSizeRatio;wd.drawEllipse(this._currentMeasure.left+this._currentMeasure.width/2,this._currentMeasure.top+this._currentMeasure.height/2,s/2-this._thickness/2,n/2-this._thickness/2,e),e.fill()}e.restore()}_onPointerDown(e,t,i,s,n){return!!super._onPointerDown(e,t,i,s,n)&&(this.isReadOnly||this.isChecked||(this.isChecked=!0),!0)}static AddRadioButtonWithHeader(e,t,i,s){const n=new Hd;n.isVertical=!1,n.height="30px";const r=new iu;r.width="20px",r.height="20px",r.isChecked=i,r.color="green",r.group=t,r.onIsCheckedChangedObservable.add((e=>s(r,e))),n.addControl(r);const o=new Vd;return o.text=e,o.width="180px",o.paddingLeft="5px",o.textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,o.color="white",n.addControl(o),n}}De([Ge()],iu.prototype,"thickness",null),De([Ge()],iu.prototype,"group",void 0),De([Ge()],iu.prototype,"checkSizeRatio",null),De([Ge()],iu.prototype,"background",null),De([Ge()],iu.prototype,"isChecked",null),ue("BABYLON.GUI.RadioButton",iu);class su extends wd{get displayThumb(){return this._displayThumb}set displayThumb(e){this._displayThumb!==e&&(this._displayThumb=e,this._markAsDirty())}get step(){return this._step}set step(e){this._step!==e&&(this._step=e,this._markAsDirty())}get barOffset(){return this._barOffset.toString(this._host)}get barOffsetInPixels(){return this._barOffset.getValueInPixel(this._host,this._cachedParentMeasure.width)}set barOffset(e){this._barOffset.toString(this._host)!==e&&this._barOffset.fromString(e)&&this._markAsDirty()}get thumbWidth(){return this._thumbWidth.toString(this._host)}get thumbWidthInPixels(){return this._thumbWidth.getValueInPixel(this._host,this._cachedParentMeasure.width)}set thumbWidth(e){this._thumbWidth.toString(this._host)!==e&&this._thumbWidth.fromString(e)&&this._markAsDirty()}get minimum(){return this._minimum}set minimum(e){this._minimum!==e&&(this._minimum=e,this._markAsDirty(),this.value=Math.max(Math.min(this.value,this._maximum),this._minimum))}get maximum(){return this._maximum}set maximum(e){this._maximum!==e&&(this._maximum=e,this._markAsDirty(),this.value=Math.max(Math.min(this.value,this._maximum),this._minimum))}get value(){return this._value}set value(e){e=Math.max(Math.min(e,this._maximum),this._minimum),this._value!==e&&(this._value=e,this._markAsDirty(),this.onValueChangedObservable.notifyObservers(this._value))}get isVertical(){return this._isVertical}set isVertical(e){this._isVertical!==e&&(this._isVertical=e,this._markAsDirty())}get isThumbClamped(){return this._isThumbClamped}set isThumbClamped(e){this._isThumbClamped!==e&&(this._isThumbClamped=e,this._markAsDirty())}constructor(e){super(e),this.name=e,this._thumbWidth=new Rd(20,Rd.UNITMODE_PIXEL,!1),this._minimum=0,this._maximum=100,this._value=50,this._isVertical=!1,this._barOffset=new Rd(5,Rd.UNITMODE_PIXEL,!1),this._isThumbClamped=!1,this._displayThumb=!0,this._step=0,this._lastPointerDownId=-1,this._effectiveBarOffset=0,this.onValueChangedObservable=new s,this._pointerIsDown=!1,this.isPointerBlocker=!0}_getTypeName(){return"BaseSlider"}_getThumbPosition(){return this.isVertical?(this.maximum-this.value)/(this.maximum-this.minimum)*this._backgroundBoxLength:(this.value-this.minimum)/(this.maximum-this.minimum)*this._backgroundBoxLength}_getThumbThickness(e){let t=0;switch(e){case"circle":t=this._thumbWidth.isPixel?Math.max(this._thumbWidth.getValue(this._host),this._backgroundBoxThickness):this._backgroundBoxThickness*this._thumbWidth.getValue(this._host);break;case"rectangle":t=this._thumbWidth.isPixel?Math.min(this._thumbWidth.getValue(this._host),this._backgroundBoxThickness):this._backgroundBoxThickness*this._thumbWidth.getValue(this._host)}return t}_prepareRenderingData(e){this._effectiveBarOffset=0,this._renderLeft=this._currentMeasure.left,this._renderTop=this._currentMeasure.top,this._renderWidth=this._currentMeasure.width,this._renderHeight=this._currentMeasure.height,this._backgroundBoxLength=Math.max(this._currentMeasure.width,this._currentMeasure.height),this._backgroundBoxThickness=Math.min(this._currentMeasure.width,this._currentMeasure.height),this._effectiveThumbThickness=this._getThumbThickness(e),this.displayThumb&&(this._backgroundBoxLength-=this._effectiveThumbThickness),this.isVertical&&this._currentMeasure.height<this._currentMeasure.width?p.Error("Height should be greater than width"):(this._barOffset.isPixel?this._effectiveBarOffset=Math.min(this._barOffset.getValue(this._host),this._backgroundBoxThickness):this._effectiveBarOffset=this._backgroundBoxThickness*this._barOffset.getValue(this._host),this._backgroundBoxThickness-=2*this._effectiveBarOffset,this.isVertical?(this._renderLeft+=this._effectiveBarOffset,!this.isThumbClamped&&this.displayThumb&&(this._renderTop+=this._effectiveThumbThickness/2),this._renderHeight=this._backgroundBoxLength,this._renderWidth=this._backgroundBoxThickness):(this._renderTop+=this._effectiveBarOffset,!this.isThumbClamped&&this.displayThumb&&(this._renderLeft+=this._effectiveThumbThickness/2),this._renderHeight=this._backgroundBoxThickness,this._renderWidth=this._backgroundBoxLength))}_updateValueFromPointer(e,t){let i;0!=this.rotation&&(this._invertTransformMatrix.transformCoordinates(e,t,this._transformedPosition),e=this._transformedPosition.x,t=this._transformedPosition.y),i=this._isVertical?this._minimum+(1-(t-this._currentMeasure.top)/this._currentMeasure.height)*(this._maximum-this._minimum):this._minimum+(e-this._currentMeasure.left)/this._currentMeasure.width*(this._maximum-this._minimum),this.value=this._step?Math.round(i/this._step)*this._step:i}_onPointerDown(e,t,i,s,n){return!!super._onPointerDown(e,t,i,s,n)&&(this.isReadOnly||(this._pointerIsDown=!0,this._updateValueFromPointer(t.x,t.y),this._host._capturingControl[i]=this,this._lastPointerDownId=i),!0)}_onPointerMove(e,t,i,s){i==this._lastPointerDownId&&(this._pointerIsDown&&!this.isReadOnly&&this._updateValueFromPointer(t.x,t.y),super._onPointerMove(e,t,i,s))}_onPointerUp(e,t,i,s,n){this._pointerIsDown=!1,delete this._host._capturingControl[i],super._onPointerUp(e,t,i,s,n)}_onCanvasBlur(){this._forcePointerUp(),super._onCanvasBlur()}}De([Ge()],su.prototype,"displayThumb",null),De([Ge()],su.prototype,"step",null),De([Ge()],su.prototype,"barOffset",null),De([Ge()],su.prototype,"thumbWidth",null),De([Ge()],su.prototype,"minimum",null),De([Ge()],su.prototype,"maximum",null),De([Ge()],su.prototype,"value",null),De([Ge()],su.prototype,"isVertical",null),De([Ge()],su.prototype,"isThumbClamped",null);class nu extends su{get displayValueBar(){return this._displayValueBar}set displayValueBar(e){this._displayValueBar!==e&&(this._displayValueBar=e,this._markAsDirty())}get borderColor(){return this._borderColor}set borderColor(e){this._borderColor!==e&&(this._borderColor=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get backgroundGradient(){return this._backgroundGradient}set backgroundGradient(e){this._backgroundGradient!==e&&(this._backgroundGradient=e,this._markAsDirty())}get thumbColor(){return this._thumbColor}set thumbColor(e){this._thumbColor!==e&&(this._thumbColor=e,this._markAsDirty())}get isThumbCircle(){return this._isThumbCircle}set isThumbCircle(e){this._isThumbCircle!==e&&(this._isThumbCircle=e,this._markAsDirty())}constructor(e){super(e),this.name=e,this._background="black",this._borderColor="white",this._thumbColor="",this._isThumbCircle=!1,this._displayValueBar=!0,this._backgroundGradient=null}_getTypeName(){return"Slider"}_getBackgroundColor(e){return this._backgroundGradient?this._backgroundGradient.getCanvasGradient(e):this._background}_draw(e){e.save(),this._applyStates(e),this._prepareRenderingData(this.isThumbCircle?"circle":"rectangle");let t=this._renderLeft,i=this._renderTop;const s=this._renderWidth,n=this._renderHeight;let r=0;this.isThumbClamped&&this.isThumbCircle?(this.isVertical?i+=this._effectiveThumbThickness/2:t+=this._effectiveThumbThickness/2,r=this._backgroundBoxThickness/2):r=(this._effectiveThumbThickness-this._effectiveBarOffset)/2,(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY);const o=this._getThumbPosition();e.fillStyle=this._getBackgroundColor(e),this.isVertical?this.isThumbClamped?this.isThumbCircle?(e.beginPath(),e.arc(t+this._backgroundBoxThickness/2,i,r,Math.PI,2*Math.PI),e.fill(),e.fillRect(t,i,s,n)):e.fillRect(t,i,s,n+this._effectiveThumbThickness):e.fillRect(t,i,s,n):this.isThumbClamped?this.isThumbCircle?(e.beginPath(),e.arc(t+this._backgroundBoxLength,i+this._backgroundBoxThickness/2,r,0,2*Math.PI),e.fill(),e.fillRect(t,i,s,n)):e.fillRect(t,i,s+this._effectiveThumbThickness,n):e.fillRect(t,i,s,n),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),e.fillStyle=this._getColor(e),this._displayValueBar&&(this.isVertical?this.isThumbClamped?this.isThumbCircle?(e.beginPath(),e.arc(t+this._backgroundBoxThickness/2,i+this._backgroundBoxLength,r,0,2*Math.PI),e.fill(),e.fillRect(t,i+o,s,n-o)):e.fillRect(t,i+o,s,n-o+this._effectiveThumbThickness):e.fillRect(t,i+o,s,n-o):this.isThumbClamped&&this.isThumbCircle?(e.beginPath(),e.arc(t,i+this._backgroundBoxThickness/2,r,0,2*Math.PI),e.fill(),e.fillRect(t,i,o,n)):e.fillRect(t,i,o,n)),e.fillStyle=this._thumbColor||this._getColor(e),this.displayThumb&&((this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),this._isThumbCircle?(e.beginPath(),this.isVertical?e.arc(t+this._backgroundBoxThickness/2,i+o,r,0,2*Math.PI):e.arc(t+o,i+this._backgroundBoxThickness/2,r,0,2*Math.PI),e.fill(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),e.strokeStyle=this._borderColor,e.stroke()):(this.isVertical?e.fillRect(t-this._effectiveBarOffset,this._currentMeasure.top+o,this._currentMeasure.width,this._effectiveThumbThickness):e.fillRect(this._currentMeasure.left+o,this._currentMeasure.top,this._effectiveThumbThickness,this._currentMeasure.height),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),e.strokeStyle=this._borderColor,this.isVertical?e.strokeRect(t-this._effectiveBarOffset,this._currentMeasure.top+o,this._currentMeasure.width,this._effectiveThumbThickness):e.strokeRect(this._currentMeasure.left+o,this._currentMeasure.top,this._effectiveThumbThickness,this._currentMeasure.height))),e.restore()}serialize(e){super.serialize(e),this.backgroundGradient&&(e.backgroundGradient={},this.backgroundGradient.serialize(e.backgroundGradient))}_parseFromContent(e,t){if(super._parseFromContent(e,t),e.backgroundGradient){const t=Ot.Instantiate("BABYLON.GUI."+e.backgroundGradient.className);this.backgroundGradient=new t,this.backgroundGradient.parse(e.backgroundGradient)}}}De([Ge()],nu.prototype,"displayValueBar",null),De([Ge()],nu.prototype,"borderColor",null),De([Ge()],nu.prototype,"background",null),De([Ge()],nu.prototype,"thumbColor",null),De([Ge()],nu.prototype,"isThumbCircle",null),ue("BABYLON.GUI.Slider",nu);class ru extends Bd{get freezeControls(){return this._freezeControls}set freezeControls(e){if(this._freezeControls===e)return;e||this._restoreMeasures(),this._freezeControls=!1;const t=this.host.getSize(),i=t.width,s=t.height,n=this.host.getContext(),r=new Dd(0,0,i,s);this.host._numLayoutCalls=0,this.host._rootContainer._layout(r,n),e&&(this._updateMeasures(),this._useBuckets()&&this._makeBuckets()),this._freezeControls=e,this.host.markAsDirty()}get bucketWidth(){return this._bucketWidth}get bucketHeight(){return this._bucketHeight}setBucketSizes(e,t){this._bucketWidth=e,this._bucketHeight=t,this._useBuckets()?this._freezeControls&&this._makeBuckets():this._buckets={}}_useBuckets(){return this._bucketWidth>0&&this._bucketHeight>0}_makeBuckets(){this._buckets={},this._bucketLen=Math.ceil(this.widthInPixels/this._bucketWidth),this._dispatchInBuckets(this._children),this._oldLeft=null,this._oldTop=null}_dispatchInBuckets(e){for(let t=0;t<e.length;++t){const i=e[t],s=Math.max(0,Math.floor((i._customData._origLeft-this._customData.origLeft)/this._bucketWidth)),n=Math.floor((i._customData._origLeft-this._customData.origLeft+i._currentMeasure.width-1)/this._bucketWidth),r=Math.floor((i._customData._origTop-this._customData.origTop+i._currentMeasure.height-1)/this._bucketHeight);let o=Math.max(0,Math.floor((i._customData._origTop-this._customData.origTop)/this._bucketHeight));for(;o<=r;){for(let e=s;e<=n;++e){const t=o*this._bucketLen+e;let s=this._buckets[t];s||(s=[],this._buckets[t]=s),s.push(i)}o++}i instanceof Bd&&i._children.length>0&&this._dispatchInBuckets(i._children)}}_updateMeasures(){const e=0|this.leftInPixels,t=0|this.topInPixels;this._measureForChildren.left-=e,this._measureForChildren.top-=t,this._currentMeasure.left-=e,this._currentMeasure.top-=t,this._customData.origLeftForChildren=this._measureForChildren.left,this._customData.origTopForChildren=this._measureForChildren.top,this._customData.origLeft=this._currentMeasure.left,this._customData.origTop=this._currentMeasure.top,this._updateChildrenMeasures(this._children,e,t)}_updateChildrenMeasures(e,t,i){for(let s=0;s<e.length;++s){const n=e[s];n._currentMeasure.left-=t,n._currentMeasure.top-=i,n._customData._origLeft=n._currentMeasure.left,n._customData._origTop=n._currentMeasure.top,n instanceof Bd&&n._children.length>0&&this._updateChildrenMeasures(n._children,t,i)}}_restoreMeasures(){const e=0|this.leftInPixels,t=0|this.topInPixels;this._measureForChildren.left=this._customData.origLeftForChildren+e,this._measureForChildren.top=this._customData.origTopForChildren+t,this._currentMeasure.left=this._customData.origLeft+e,this._currentMeasure.top=this._customData.origTop+t}constructor(e){super(e),this._freezeControls=!1,this._bucketWidth=0,this._bucketHeight=0,this._buckets={}}_getTypeName(){return"ScrollViewerWindow"}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._parentMeasure=e,this._measureForChildren.left=this._currentMeasure.left,this._measureForChildren.top=this._currentMeasure.top,this._measureForChildren.width=e.width,this._measureForChildren.height=e.height}_layout(e,t){return this._freezeControls?(this.invalidateRect(),!1):super._layout(e,t)}_scrollChildren(e,t,i){for(let s=0;s<e.length;++s){const n=e[s];n._currentMeasure.left=n._customData._origLeft+t,n._currentMeasure.top=n._customData._origTop+i,n._isClipped=!1,n instanceof Bd&&n._children.length>0&&this._scrollChildren(n._children,t,i)}}_scrollChildrenWithBuckets(e,t,i,s){const n=Math.max(0,Math.floor(-e/this._bucketWidth)),r=Math.floor((-e+this._parentMeasure.width-1)/this._bucketWidth),o=Math.floor((-t+this._parentMeasure.height-1)/this._bucketHeight);let a=Math.max(0,Math.floor(-t/this._bucketHeight));for(;a<=o;){for(let e=n;e<=r;++e){const t=a*this._bucketLen+e,n=this._buckets[t];if(n)for(let e=0;e<n.length;++e){const t=n[e];t._currentMeasure.left=t._customData._origLeft+i,t._currentMeasure.top=t._customData._origTop+s,t._isClipped=!1}}a++}}_draw(e,t){if(!this._freezeControls)return void super._draw(e,t);this._localDraw(e),this.clipChildren&&this._clipForChildren(e);const i=0|this.leftInPixels,s=0|this.topInPixels;this._useBuckets()&&null!==this._oldLeft&&null!==this._oldTop?(this._scrollChildrenWithBuckets(this._oldLeft,this._oldTop,i,s),this._scrollChildrenWithBuckets(i,s,i,s)):this._scrollChildren(this._children,i,s),this._oldLeft=i,this._oldTop=s;for(const t of this._children)t._intersectsRect(this._parentMeasure)&&t._render(e,this._parentMeasure)}_postMeasure(){if(this._freezeControls)return void super._postMeasure();let e=this.parentClientWidth,t=this.parentClientHeight;for(const i of this.children)i.isVisible&&!i.notRenderable&&(i.horizontalAlignment===wd.HORIZONTAL_ALIGNMENT_CENTER&&i._offsetLeft(this._currentMeasure.left-i._currentMeasure.left),i.verticalAlignment===wd.VERTICAL_ALIGNMENT_CENTER&&i._offsetTop(this._currentMeasure.top-i._currentMeasure.top),e=Math.max(e,i._currentMeasure.left-this._currentMeasure.left+i._currentMeasure.width+i.paddingRightInPixels),t=Math.max(t,i._currentMeasure.top-this._currentMeasure.top+i._currentMeasure.height+i.paddingBottomInPixels));this._currentMeasure.width!==e&&(this._width.updateInPlace(e,Rd.UNITMODE_PIXEL),this._currentMeasure.width=e,this._rebuildLayout=!0,this._isDirty=!0),this._currentMeasure.height!==t&&(this._height.updateInPlace(t,Rd.UNITMODE_PIXEL),this._currentMeasure.height=t,this._rebuildLayout=!0,this._isDirty=!0),super._postMeasure()}}class ou extends su{get borderColor(){return this._borderColor}set borderColor(e){this._borderColor!==e&&(this._borderColor=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get backgroundGradient(){return this._backgroundGradient}set backgroundGradient(e){this._backgroundGradient!==e&&(this._backgroundGradient=e,this._markAsDirty())}get invertScrollDirection(){return this._invertScrollDirection}set invertScrollDirection(e){this._invertScrollDirection=e}constructor(e){super(e),this.name=e,this._background="black",this._borderColor="white",this._tempMeasure=new Dd(0,0,0,0),this._invertScrollDirection=!1,this._backgroundGradient=null}_getTypeName(){return"Scrollbar"}_getThumbThickness(){let e=0;return e=this._thumbWidth.isPixel?this._thumbWidth.getValue(this._host):this._backgroundBoxThickness*this._thumbWidth.getValue(this._host),e}_getBackgroundColor(e){return this._backgroundGradient?this._backgroundGradient.getCanvasGradient(e):this._background}_draw(e){e.save(),this._applyStates(e),this._prepareRenderingData("rectangle");const t=this._renderLeft,i=this._getThumbPosition();e.fillStyle=this._getBackgroundColor(e),e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height),e.fillStyle=this._getColor(e),this.isVertical?(this._tempMeasure.left=t-this._effectiveBarOffset,this._tempMeasure.top=this._currentMeasure.top+i,this._tempMeasure.width=this._currentMeasure.width,this._tempMeasure.height=this._effectiveThumbThickness):(this._tempMeasure.left=this._currentMeasure.left+i,this._tempMeasure.top=this._currentMeasure.top,this._tempMeasure.width=this._effectiveThumbThickness,this._tempMeasure.height=this._currentMeasure.height),e.fillRect(this._tempMeasure.left,this._tempMeasure.top,this._tempMeasure.width,this._tempMeasure.height),e.restore()}_updateValueFromPointer(e,t){0!=this.rotation&&(this._invertTransformMatrix.transformCoordinates(e,t,this._transformedPosition),e=this._transformedPosition.x,t=this._transformedPosition.y);const i=this._invertScrollDirection?-1:1;this._first&&(this._first=!1,this._originX=e,this._originY=t,(e<this._tempMeasure.left||e>this._tempMeasure.left+this._tempMeasure.width||t<this._tempMeasure.top||t>this._tempMeasure.top+this._tempMeasure.height)&&(this.isVertical?this.value=this.minimum+(1-(t-this._currentMeasure.top)/this._currentMeasure.height)*(this.maximum-this.minimum):this.value=this.minimum+(e-this._currentMeasure.left)/this._currentMeasure.width*(this.maximum-this.minimum)));let s=0;s=this.isVertical?-(t-this._originY)/(this._currentMeasure.height-this._effectiveThumbThickness):(e-this._originX)/(this._currentMeasure.width-this._effectiveThumbThickness),this.value+=i*s*(this.maximum-this.minimum),this._originX=e,this._originY=t}_onPointerDown(e,t,i,s,n){return this._first=!0,super._onPointerDown(e,t,i,s,n)}serialize(e){super.serialize(e),this.backgroundGradient&&(e.backgroundGradient={},this.backgroundGradient.serialize(e.backgroundGradient))}_parseFromContent(e,t){if(super._parseFromContent(e,t),e.backgroundGradient){const t=Ot.Instantiate("BABYLON.GUI."+e.backgroundGradient.className);this.backgroundGradient=new t,this.backgroundGradient.parse(e.backgroundGradient)}}}De([Ge()],ou.prototype,"borderColor",null),De([Ge()],ou.prototype,"background",null),De([Ge()],ou.prototype,"invertScrollDirection",null),ue("BABYLON.GUI.Scrollbar",ou);class au extends su{get invertScrollDirection(){return this._invertScrollDirection}set invertScrollDirection(e){this._invertScrollDirection=e}get backgroundImage(){return this._backgroundBaseImage}set backgroundImage(e){this._backgroundBaseImage!==e&&(this._backgroundBaseImage=e,this.isVertical&&0!==this.num90RotationInVerticalMode?e.isLoaded?(this._backgroundImage=e._rotate90(this.num90RotationInVerticalMode,!0),this._markAsDirty()):e.onImageLoadedObservable.addOnce((()=>{const t=e._rotate90(this.num90RotationInVerticalMode,!0);this._backgroundImage=t,t.isLoaded||t.onImageLoadedObservable.addOnce((()=>{this._markAsDirty()})),this._markAsDirty()})):(this._backgroundImage=e,e&&!e.isLoaded&&e.onImageLoadedObservable.addOnce((()=>{this._markAsDirty()})),this._markAsDirty()))}get thumbImage(){return this._thumbBaseImage}set thumbImage(e){this._thumbBaseImage!==e&&(this._thumbBaseImage=e,this.isVertical&&0!==this.num90RotationInVerticalMode?e.isLoaded?(this._thumbImage=e._rotate90(-this.num90RotationInVerticalMode,!0),this._markAsDirty()):e.onImageLoadedObservable.addOnce((()=>{const t=e._rotate90(-this.num90RotationInVerticalMode,!0);this._thumbImage=t,t.isLoaded||t.onImageLoadedObservable.addOnce((()=>{this._markAsDirty()})),this._markAsDirty()})):(this._thumbImage=e,e&&!e.isLoaded&&e.onImageLoadedObservable.addOnce((()=>{this._markAsDirty()})),this._markAsDirty()))}get thumbLength(){return this._thumbLength}set thumbLength(e){this._thumbLength!==e&&(this._thumbLength=e,this._markAsDirty())}get thumbHeight(){return this._thumbHeight}set thumbHeight(e){this._thumbLength!==e&&(this._thumbHeight=e,this._markAsDirty())}get barImageHeight(){return this._barImageHeight}set barImageHeight(e){this._barImageHeight!==e&&(this._barImageHeight=e,this._markAsDirty())}constructor(e){super(e),this.name=e,this._thumbLength=.5,this._thumbHeight=1,this._barImageHeight=1,this._tempMeasure=new Dd(0,0,0,0),this._invertScrollDirection=!1,this.num90RotationInVerticalMode=1}_getTypeName(){return"ImageScrollBar"}_getThumbThickness(){let e=0;return e=this._thumbWidth.isPixel?this._thumbWidth.getValue(this._host):this._backgroundBoxThickness*this._thumbWidth.getValue(this._host),e}_draw(e){e.save(),this._applyStates(e),this._prepareRenderingData("rectangle");const t=this._getThumbPosition(),i=this._renderLeft,s=this._renderTop,n=this._renderWidth,r=this._renderHeight;this._backgroundImage&&(this._tempMeasure.copyFromFloats(i,s,n,r),this.isVertical?(this._tempMeasure.copyFromFloats(i+n*(1-this._barImageHeight)*.5,this._currentMeasure.top,n*this._barImageHeight,r),this._tempMeasure.height+=this._effectiveThumbThickness,this._backgroundImage._currentMeasure.copyFrom(this._tempMeasure)):(this._tempMeasure.copyFromFloats(this._currentMeasure.left,s+r*(1-this._barImageHeight)*.5,n,r*this._barImageHeight),this._tempMeasure.width+=this._effectiveThumbThickness,this._backgroundImage._currentMeasure.copyFrom(this._tempMeasure)),this._backgroundImage._draw(e)),this.isVertical?this._tempMeasure.copyFromFloats(i-this._effectiveBarOffset+this._currentMeasure.width*(1-this._thumbHeight)*.5,this._currentMeasure.top+t,this._currentMeasure.width*this._thumbHeight,this._effectiveThumbThickness):this._tempMeasure.copyFromFloats(this._currentMeasure.left+t,this._currentMeasure.top+this._currentMeasure.height*(1-this._thumbHeight)*.5,this._effectiveThumbThickness,this._currentMeasure.height*this._thumbHeight),this._thumbImage&&(this._thumbImage._currentMeasure.copyFrom(this._tempMeasure),this._thumbImage._draw(e)),e.restore()}_updateValueFromPointer(e,t){0!=this.rotation&&(this._invertTransformMatrix.transformCoordinates(e,t,this._transformedPosition),e=this._transformedPosition.x,t=this._transformedPosition.y);const i=this._invertScrollDirection?-1:1;this._first&&(this._first=!1,this._originX=e,this._originY=t,(e<this._tempMeasure.left||e>this._tempMeasure.left+this._tempMeasure.width||t<this._tempMeasure.top||t>this._tempMeasure.top+this._tempMeasure.height)&&(this.isVertical?this.value=this.minimum+(1-(t-this._currentMeasure.top)/this._currentMeasure.height)*(this.maximum-this.minimum):this.value=this.minimum+(e-this._currentMeasure.left)/this._currentMeasure.width*(this.maximum-this.minimum)));let s=0;s=this.isVertical?-(t-this._originY)/(this._currentMeasure.height-this._effectiveThumbThickness):(e-this._originX)/(this._currentMeasure.width-this._effectiveThumbThickness),this.value+=i*s*(this.maximum-this.minimum),this._originX=e,this._originY=t}_onPointerDown(e,t,i,s,n){return this._first=!0,super._onPointerDown(e,t,i,s,n)}}De([Ge()],au.prototype,"num90RotationInVerticalMode",void 0),De([Ge()],au.prototype,"invertScrollDirection",null);class lu extends Ud{get horizontalBar(){return this._horizontalBar}get verticalBar(){return this._verticalBar}addControl(e){return e?(this._window.addControl(e),this):this}removeControl(e){return this._window.removeControl(e),this}get children(){return this._window.children}_flagDescendantsAsMatrixDirty(){for(const e of this._children)e._markMatrixAsDirty()}get freezeControls(){return this._window.freezeControls}set freezeControls(e){this._window.freezeControls=e}get bucketWidth(){return this._window.bucketWidth}get bucketHeight(){return this._window.bucketHeight}setBucketSizes(e,t){this._window.setBucketSizes(e,t)}get forceHorizontalBar(){return this._forceHorizontalBar}set forceHorizontalBar(e){this._grid.setRowDefinition(1,e?this._barSize:0,!0),this._horizontalBar.isVisible=e,this._forceHorizontalBar=e}get forceVerticalBar(){return this._forceVerticalBar}set forceVerticalBar(e){this._grid.setColumnDefinition(1,e?this._barSize:0,!0),this._verticalBar.isVisible=e,this._forceVerticalBar=e}constructor(e,t){super(e),this._barSize=20,this._pointerIsOver=!1,this._wheelPrecision=.05,this._thumbLength=.5,this._thumbHeight=1,this._barImageHeight=1,this._horizontalBarImageHeight=1,this._verticalBarImageHeight=1,this._oldWindowContentsWidth=0,this._oldWindowContentsHeight=0,this._forceHorizontalBar=!1,this._forceVerticalBar=!1,this._useImageBar=t||!1,this.onDirtyObservable.add((()=>{this._horizontalBarSpace.color=this.color,this._verticalBarSpace.color=this.color,this._dragSpace.color=this.color})),this.onPointerEnterObservable.add((()=>{this._pointerIsOver=!0})),this.onPointerOutObservable.add((()=>{this._pointerIsOver=!1})),this._grid=new jd,this._useImageBar?(this._horizontalBar=new au,this._verticalBar=new au):(this._horizontalBar=new ou,this._verticalBar=new ou),this._window=new ru("scrollViewer_window"),this._window.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,this._window.verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP,this._grid.addColumnDefinition(1),this._grid.addColumnDefinition(0,!0),this._grid.addRowDefinition(1),this._grid.addRowDefinition(0,!0),super.addControl(this._grid),this._grid.addControl(this._window,0,0),this._verticalBarSpace=new Ud,this._verticalBarSpace.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,this._verticalBarSpace.verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP,this._verticalBarSpace.thickness=1,this._grid.addControl(this._verticalBarSpace,0,1),this._addBar(this._verticalBar,this._verticalBarSpace,!0,Math.PI),this._horizontalBarSpace=new Ud,this._horizontalBarSpace.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,this._horizontalBarSpace.verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP,this._horizontalBarSpace.thickness=1,this._grid.addControl(this._horizontalBarSpace,1,0),this._addBar(this._horizontalBar,this._horizontalBarSpace,!1,0),this._dragSpace=new Ud,this._dragSpace.thickness=1,this._grid.addControl(this._dragSpace,1,1),this._useImageBar||(this.barColor="grey",this.barBackground="transparent")}resetWindow(){this._window.width="100%",this._window.height="100%"}_getTypeName(){return"ScrollViewer"}_buildClientSizes(){const e=this.host.idealRatio;this._window.parentClientWidth=this._currentMeasure.width-(this._verticalBar.isVisible||this.forceVerticalBar?this._barSize*e:0)-2*this.thickness,this._window.parentClientHeight=this._currentMeasure.height-(this._horizontalBar.isVisible||this.forceHorizontalBar?this._barSize*e:0)-2*this.thickness,this._clientWidth=this._window.parentClientWidth,this._clientHeight=this._window.parentClientHeight}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._buildClientSizes()}_postMeasure(){super._postMeasure(),this._updateScroller(),this._setWindowPosition(!1)}get wheelPrecision(){return this._wheelPrecision}set wheelPrecision(e){this._wheelPrecision!==e&&(e<0&&(e=0),e>1&&(e=1),this._wheelPrecision=e)}get scrollBackground(){return this._horizontalBarSpace.background}set scrollBackground(e){this._horizontalBarSpace.background!==e&&(this._horizontalBarSpace.background=e,this._verticalBarSpace.background=e)}get barColor(){return this._barColor}set barColor(e){this._barColor!==e&&(this._barColor=e,this._horizontalBar.color=e,this._verticalBar.color=e)}get thumbImage(){return this._barImage}set thumbImage(e){if(this._barImage===e)return;this._barImage=e;const t=this._horizontalBar,i=this._verticalBar;t.thumbImage=e,i.thumbImage=e}get horizontalThumbImage(){return this._horizontalBarImage}set horizontalThumbImage(e){this._horizontalBarImage!==e&&(this._horizontalBarImage=e,this._horizontalBar.thumbImage=e)}get verticalThumbImage(){return this._verticalBarImage}set verticalThumbImage(e){this._verticalBarImage!==e&&(this._verticalBarImage=e,this._verticalBar.thumbImage=e)}get barSize(){return this._barSize}set barSize(e){this._barSize!==e&&(this._barSize=e,this._markAsDirty(),this._horizontalBar.isVisible&&this._grid.setRowDefinition(1,this._barSize,!0),this._verticalBar.isVisible&&this._grid.setColumnDefinition(1,this._barSize,!0))}get thumbLength(){return this._thumbLength}set thumbLength(e){if(this._thumbLength===e)return;e<=0&&(e=.1),e>1&&(e=1),this._thumbLength=e;const t=this._horizontalBar,i=this._verticalBar;t.thumbLength=e,i.thumbLength=e,this._markAsDirty()}get thumbHeight(){return this._thumbHeight}set thumbHeight(e){if(this._thumbHeight===e)return;e<=0&&(e=.1),e>1&&(e=1),this._thumbHeight=e;const t=this._horizontalBar,i=this._verticalBar;t.thumbHeight=e,i.thumbHeight=e,this._markAsDirty()}get barImageHeight(){return this._barImageHeight}set barImageHeight(e){if(this._barImageHeight===e)return;e<=0&&(e=.1),e>1&&(e=1),this._barImageHeight=e;const t=this._horizontalBar,i=this._verticalBar;t.barImageHeight=e,i.barImageHeight=e,this._markAsDirty()}get horizontalBarImageHeight(){return this._horizontalBarImageHeight}set horizontalBarImageHeight(e){this._horizontalBarImageHeight!==e&&(e<=0&&(e=.1),e>1&&(e=1),this._horizontalBarImageHeight=e,this._horizontalBar.barImageHeight=e,this._markAsDirty())}get verticalBarImageHeight(){return this._verticalBarImageHeight}set verticalBarImageHeight(e){this._verticalBarImageHeight!==e&&(e<=0&&(e=.1),e>1&&(e=1),this._verticalBarImageHeight=e,this._verticalBar.barImageHeight=e,this._markAsDirty())}get barBackground(){return this._barBackground}set barBackground(e){if(this._barBackground===e)return;this._barBackground=e;const t=this._horizontalBar,i=this._verticalBar;t.background=e,i.background=e,this._dragSpace.background=e}get barImage(){return this._barBackgroundImage}set barImage(e){this._barBackgroundImage=e;const t=this._horizontalBar,i=this._verticalBar;t.backgroundImage=e,i.backgroundImage=e}get horizontalBarImage(){return this._horizontalBarBackgroundImage}set horizontalBarImage(e){this._horizontalBarBackgroundImage=e,this._horizontalBar.backgroundImage=e}get verticalBarImage(){return this._verticalBarBackgroundImage}set verticalBarImage(e){this._verticalBarBackgroundImage=e,this._verticalBar.backgroundImage=e}_setWindowPosition(e=!0){const t=this.host.idealRatio,i=this._window._currentMeasure.width,s=this._window._currentMeasure.height;if(!e&&this._oldWindowContentsWidth===i&&this._oldWindowContentsHeight===s)return;this._oldWindowContentsWidth=i,this._oldWindowContentsHeight=s;const n=this._clientWidth-i,r=this._clientHeight-s,o=this._horizontalBar.value/t*n+"px",a=this._verticalBar.value/t*r+"px";o!==this._window.left&&(this._window.left=o,this.freezeControls||(this._rebuildLayout=!0)),a!==this._window.top&&(this._window.top=a,this.freezeControls||(this._rebuildLayout=!0))}_updateScroller(){const e=this._window._currentMeasure.width,t=this._window._currentMeasure.height;this._horizontalBar.isVisible&&e<=this._clientWidth&&!this.forceHorizontalBar?(this._grid.setRowDefinition(1,0,!0),this._horizontalBar.isVisible=!1,this._horizontalBar.value=0,this._rebuildLayout=!0):!this._horizontalBar.isVisible&&(e>this._clientWidth||this.forceHorizontalBar)&&(this._grid.setRowDefinition(1,this._barSize,!0),this._horizontalBar.isVisible=!0,this._rebuildLayout=!0),this._verticalBar.isVisible&&t<=this._clientHeight&&!this.forceVerticalBar?(this._grid.setColumnDefinition(1,0,!0),this._verticalBar.isVisible=!1,this._verticalBar.value=0,this._rebuildLayout=!0):!this._verticalBar.isVisible&&(t>this._clientHeight||this.forceVerticalBar)&&(this._grid.setColumnDefinition(1,this._barSize,!0),this._verticalBar.isVisible=!0,this._rebuildLayout=!0),this._buildClientSizes();const i=this.host.idealRatio;this._horizontalBar.thumbWidth=.9*this._thumbLength*(this._clientWidth/i)+"px",this._verticalBar.thumbWidth=.9*this._thumbLength*(this._clientHeight/i)+"px"}_link(e){super._link(e),this._attachWheel()}_addBar(e,t,i,s){e.paddingLeft=0,e.width="100%",e.height="100%",e.barOffset=0,e.value=0,e.maximum=1,e.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_CENTER,e.verticalAlignment=wd.VERTICAL_ALIGNMENT_CENTER,e.isVertical=i,e.rotation=s,e.isVisible=!1,t.addControl(e),e.onValueChangedObservable.add((()=>{this._setWindowPosition()}))}_attachWheel(){this._host&&!this._onWheelObserver&&(this._onWheelObserver=this.onWheelObservable.add((e=>{this._pointerIsOver&&!this.isReadOnly&&(1==this._verticalBar.isVisible&&(e.y<0&&this._verticalBar.value>0?this._verticalBar.value-=this._wheelPrecision:e.y>0&&this._verticalBar.value<this._verticalBar.maximum&&(this._verticalBar.value+=this._wheelPrecision)),1==this._horizontalBar.isVisible&&(e.x<0&&this._horizontalBar.value<this._horizontalBar.maximum?this._horizontalBar.value+=this._wheelPrecision:e.x>0&&this._horizontalBar.value>0&&(this._horizontalBar.value-=this._wheelPrecision)))})))}_renderHighlightSpecific(e){this.isHighlighted&&(super._renderHighlightSpecific(e),this._grid._renderHighlightSpecific(e),e.restore())}dispose(){this.onWheelObservable.remove(this._onWheelObserver),this._onWheelObserver=null,super.dispose()}}De([Ge()],lu.prototype,"wheelPrecision",null),De([Ge()],lu.prototype,"scrollBackground",null),De([Ge()],lu.prototype,"barColor",null),De([Ge()],lu.prototype,"barSize",null),De([Ge()],lu.prototype,"barBackground",null),ue("BABYLON.GUI.ScrollViewer",lu),ue("BABYLON.GUI.ToggleButton",class extends Ud{get group(){return this._group}set group(e){this._group!==e&&(this._group=e)}get isActive(){return this._isActive}set isActive(e){var t,i;this._isActive!==e&&(this._isActive=e,this._isActive?null===(t=this.toActiveAnimation)||void 0===t||t.call(this):null===(i=this.toInactiveAnimation)||void 0===i||i.call(this),this._markAsDirty(),this.onIsActiveChangedObservable.notifyObservers(e),this._isActive&&this._host&&this._group&&this._host.executeOnAllControls((e=>{if("ToggleButton"===e.typeName){if(e===this)return;const t=e;t.group===this.group&&(t.isActive=!1)}})))}constructor(e,t){super(e),this.name=e,this.onIsActiveChangedObservable=new s,this.delegatePickingToChildren=!1,this._isActive=!1,this.group=null!=t?t:"",this.thickness=0,this.isPointerBlocker=!0;let i=null;this.toActiveAnimation=()=>{this.thickness=1},this.toInactiveAnimation=()=>{this.thickness=0},this.pointerEnterActiveAnimation=()=>{i=this.alpha,this.alpha-=.1},this.pointerOutActiveAnimation=()=>{null!==i&&(this.alpha=i)},this.pointerDownActiveAnimation=()=>{this.scaleX-=.05,this.scaleY-=.05},this.pointerUpActiveAnimation=()=>{this.scaleX+=.05,this.scaleY+=.05},this.pointerEnterInactiveAnimation=()=>{i=this.alpha,this.alpha-=.1},this.pointerOutInactiveAnimation=()=>{null!==i&&(this.alpha=i)},this.pointerDownInactiveAnimation=()=>{this.scaleX-=.05,this.scaleY-=.05},this.pointerUpInactiveAnimation=()=>{this.scaleX+=.05,this.scaleY+=.05}}_getTypeName(){return"ToggleButton"}_processPicking(e,t,i,s,n,r,o,a){if(!this._isEnabled||!this.isHitTestVisible||!this.isVisible||this.notRenderable)return!1;if(!super.contains(e,t))return!1;if(this.delegatePickingToChildren){let i=!1;for(let s=this._children.length-1;s>=0;s--){const n=this._children[s];if(n.isEnabled&&n.isHitTestVisible&&n.isVisible&&!n.notRenderable&&n.contains(e,t)){i=!0;break}}if(!i)return!1}return this._processObservables(s,e,t,i,n,r,o,a),!0}_onPointerEnter(e,t){return!!super._onPointerEnter(e,t)&&(this.isReadOnly||(this._isActive?this.pointerEnterActiveAnimation&&this.pointerEnterActiveAnimation():this.pointerEnterInactiveAnimation&&this.pointerEnterInactiveAnimation()),!0)}_onPointerOut(e,t,i=!1){this.isReadOnly||(this._isActive?this.pointerOutActiveAnimation&&this.pointerOutActiveAnimation():this.pointerOutInactiveAnimation&&this.pointerOutInactiveAnimation()),super._onPointerOut(e,t,i)}_onPointerDown(e,t,i,s,n){return!!super._onPointerDown(e,t,i,s,n)&&(this.isReadOnly||(this._isActive?this.pointerDownActiveAnimation&&this.pointerDownActiveAnimation():this.pointerDownInactiveAnimation&&this.pointerDownInactiveAnimation()),!0)}_onPointerUp(e,t,i,s,n,r){this.isReadOnly||(this._isActive?this.pointerUpActiveAnimation&&this.pointerUpActiveAnimation():this.pointerUpInactiveAnimation&&this.pointerUpInactiveAnimation()),super._onPointerUp(e,t,i,s,n,r)}});class hu extends Hd{constructor(){super(...arguments),this.onKeyPressObservable=new s,this.defaultButtonWidth="40px",this.defaultButtonHeight="40px",this.defaultButtonPaddingLeft="2px",this.defaultButtonPaddingRight="2px",this.defaultButtonPaddingTop="2px",this.defaultButtonPaddingBottom="2px",this.defaultButtonColor="#DDD",this.defaultButtonBackground="#070707",this.shiftButtonColor="#7799FF",this.selectedShiftThickness=1,this.shiftState=0,this._currentlyConnectedInputText=null,this._connectedInputTexts=[],this._onKeyPressObserver=null}_getTypeName(){return"VirtualKeyboard"}_createKey(e,t){const i=zd.CreateSimpleButton(e,e);return i.width=t&&t.width?t.width:this.defaultButtonWidth,i.height=t&&t.height?t.height:this.defaultButtonHeight,i.color=t&&t.color?t.color:this.defaultButtonColor,i.background=t&&t.background?t.background:this.defaultButtonBackground,i.paddingLeft=t&&t.paddingLeft?t.paddingLeft:this.defaultButtonPaddingLeft,i.paddingRight=t&&t.paddingRight?t.paddingRight:this.defaultButtonPaddingRight,i.paddingTop=t&&t.paddingTop?t.paddingTop:this.defaultButtonPaddingTop,i.paddingBottom=t&&t.paddingBottom?t.paddingBottom:this.defaultButtonPaddingBottom,i.thickness=0,i.isFocusInvisible=!0,i.shadowColor=this.shadowColor,i.shadowBlur=this.shadowBlur,i.shadowOffsetX=this.shadowOffsetX,i.shadowOffsetY=this.shadowOffsetY,i.onPointerUpObservable.add((()=>{this.onKeyPressObservable.notifyObservers(e)})),i}addKeysRow(e,t){const i=new Hd;i.isVertical=!1,i.isFocusInvisible=!0;let s=null;for(let n=0;n<e.length;n++){let r=null;t&&t.length===e.length&&(r=t[n]);const o=this._createKey(e[n],r);(!s||o.heightInPixels>s.heightInPixels)&&(s=o),i.addControl(o)}i.height=s?s.height:this.defaultButtonHeight,this.addControl(i)}applyShiftState(e){if(this.children)for(let t=0;t<this.children.length;t++){const i=this.children[t];if(!i||!i.children)continue;const s=i;for(let t=0;t<s.children.length;t++){const i=s.children[t];if(!i||!i.children[0])continue;const n=i.children[0];""===n.text&&(i.color=e?this.shiftButtonColor:this.defaultButtonColor,i.thickness=e>1?this.selectedShiftThickness:0),n.text=e>0?n.text.toUpperCase():n.text.toLowerCase()}}}get connectedInputText(){return this._currentlyConnectedInputText}connect(e){if(this._connectedInputTexts.some((t=>t.input===e)))return;null===this._onKeyPressObserver&&(this._onKeyPressObserver=this.onKeyPressObservable.add((e=>{if(this._currentlyConnectedInputText){switch(this._currentlyConnectedInputText._host.focusedControl=this._currentlyConnectedInputText,e){case"":return this.shiftState++,this.shiftState>2&&(this.shiftState=0),void this.applyShiftState(this.shiftState);case"":return void(this._currentlyConnectedInputText instanceof Zd?this._currentlyConnectedInputText.alternativeProcessKey("Backspace"):this._currentlyConnectedInputText.processKey(8));case"":return void(this._currentlyConnectedInputText instanceof Zd?this._currentlyConnectedInputText.alternativeProcessKey("Enter"):this._currentlyConnectedInputText.processKey(13))}this._currentlyConnectedInputText instanceof Zd?this._currentlyConnectedInputText.alternativeProcessKey("",this.shiftState?e.toUpperCase():e):this._currentlyConnectedInputText.processKey(-1,this.shiftState?e.toUpperCase():e),1===this.shiftState&&(this.shiftState=0,this.applyShiftState(this.shiftState))}}))),this.isVisible=!1,this._currentlyConnectedInputText=e,e._connectedVirtualKeyboard=this;const t=e.onFocusObservable.add((()=>{this._currentlyConnectedInputText=e,e._connectedVirtualKeyboard=this,this.isVisible=!0})),i=e.onBlurObservable.add((()=>{e._connectedVirtualKeyboard=null,this._currentlyConnectedInputText=null,this.isVisible=!1}));this._connectedInputTexts.push({input:e,onBlurObserver:i,onFocusObserver:t})}disconnect(e){if(e){const t=this._connectedInputTexts.filter((t=>t.input===e));1===t.length&&(this._removeConnectedInputObservables(t[0]),this._connectedInputTexts=this._connectedInputTexts.filter((t=>t.input!==e)),this._currentlyConnectedInputText===e&&(this._currentlyConnectedInputText=null))}else this._connectedInputTexts.forEach((e=>{this._removeConnectedInputObservables(e)})),this._connectedInputTexts.length=0;0===this._connectedInputTexts.length&&(this._currentlyConnectedInputText=null,this.onKeyPressObservable.remove(this._onKeyPressObserver),this._onKeyPressObserver=null)}_removeConnectedInputObservables(e){e.input._connectedVirtualKeyboard=null,e.input.onFocusObservable.remove(e.onFocusObserver),e.input.onBlurObservable.remove(e.onBlurObserver)}dispose(){super.dispose(),this.disconnect()}static CreateDefaultLayout(e){const t=new hu(e);return t.addKeysRow(["1","2","3","4","5","6","7","8","9","0",""]),t.addKeysRow(["q","w","e","r","t","y","u","i","o","p"]),t.addKeysRow(["a","s","d","f","g","h","j","k","l",";","'",""]),t.addKeysRow(["","z","x","c","v","b","n","m",",",".","/"]),t.addKeysRow([" "],[{width:"200px"}]),t}_parseFromContent(e,t){super._parseFromContent(e,t);for(const e of this.children)if("StackPanel"===e.getClassName()){const t=e;for(const e of t.children)"Button"===e.getClassName()&&e.name&&e.onPointerUpObservable.add((()=>{this.onKeyPressObservable.notifyObservers(e.name)}))}}}ue("BABYLON.GUI.VirtualKeyboard",hu);class cu extends wd{get displayMinorLines(){return this._displayMinorLines}set displayMinorLines(e){this._displayMinorLines!==e&&(this._displayMinorLines=e,this._markAsDirty())}get displayMajorLines(){return this._displayMajorLines}set displayMajorLines(e){this._displayMajorLines!==e&&(this._displayMajorLines=e,this._markAsDirty())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this._markAsDirty())}get cellWidth(){return this._cellWidth}set cellWidth(e){this._cellWidth=e,this._markAsDirty()}get cellHeight(){return this._cellHeight}set cellHeight(e){this._cellHeight=e,this._markAsDirty()}get minorLineTickness(){return this._minorLineTickness}set minorLineTickness(e){this._minorLineTickness=e,this._markAsDirty()}get minorLineColor(){return this._minorLineColor}set minorLineColor(e){this._minorLineColor=e,this._markAsDirty()}get majorLineTickness(){return this._majorLineTickness}set majorLineTickness(e){this._majorLineTickness=e,this._markAsDirty()}get majorLineColor(){return this._majorLineColor}set majorLineColor(e){this._majorLineColor=e,this._markAsDirty()}get majorLineFrequency(){return this._majorLineFrequency}set majorLineFrequency(e){this._majorLineFrequency=e,this._markAsDirty()}constructor(e){super(e),this.name=e,this._cellWidth=20,this._cellHeight=20,this._minorLineTickness=1,this._minorLineColor="DarkGray",this._majorLineTickness=2,this._majorLineColor="White",this._majorLineFrequency=5,this._background="Black",this._displayMajorLines=!0,this._displayMinorLines=!0}_draw(e){if(e.save(),this._applyStates(e),this._isEnabled){this._background&&(e.fillStyle=this._background,e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height));const t=this._currentMeasure.width/this._cellWidth,i=this._currentMeasure.height/this._cellHeight,s=this._currentMeasure.left+this._currentMeasure.width/2,n=this._currentMeasure.top+this._currentMeasure.height/2;if(this._displayMinorLines){e.strokeStyle=this._minorLineColor,e.lineWidth=this._minorLineTickness;for(let i=-t/2+1;i<t/2;i++){const t=s+i*this.cellWidth;e.beginPath(),e.moveTo(t,this._currentMeasure.top),e.lineTo(t,this._currentMeasure.top+this._currentMeasure.height),e.stroke()}for(let t=-i/2+1;t<i/2;t++){const i=n+t*this.cellHeight;e.beginPath(),e.moveTo(this._currentMeasure.left,i),e.lineTo(this._currentMeasure.left+this._currentMeasure.width,i),e.stroke()}}if(this._displayMajorLines){e.strokeStyle=this._majorLineColor,e.lineWidth=this._majorLineTickness;for(let i=-t/2+this._majorLineFrequency;i<t/2;i+=this._majorLineFrequency){const t=s+i*this.cellWidth;e.beginPath(),e.moveTo(t,this._currentMeasure.top),e.lineTo(t,this._currentMeasure.top+this._currentMeasure.height),e.stroke()}for(let t=-i/2+this._majorLineFrequency;t<i/2;t+=this._majorLineFrequency){const i=n+t*this.cellHeight;e.moveTo(this._currentMeasure.left,i),e.lineTo(this._currentMeasure.left+this._currentMeasure.width,i),e.closePath(),e.stroke()}}}e.restore()}_getTypeName(){return"DisplayGrid"}}De([Ge()],cu.prototype,"displayMinorLines",null),De([Ge()],cu.prototype,"displayMajorLines",null),De([Ge()],cu.prototype,"background",null),De([Ge()],cu.prototype,"cellWidth",null),De([Ge()],cu.prototype,"cellHeight",null),De([Ge()],cu.prototype,"minorLineTickness",null),De([Ge()],cu.prototype,"minorLineColor",null),De([Ge()],cu.prototype,"majorLineTickness",null),De([Ge()],cu.prototype,"majorLineColor",null),De([Ge()],cu.prototype,"majorLineFrequency",null),ue("BABYLON.GUI.DisplayGrid",cu);class du extends su{get displayThumb(){return this._displayThumb&&null!=this.thumbImage}set displayThumb(e){this._displayThumb!==e&&(this._displayThumb=e,this._markAsDirty())}get backgroundImage(){return this._backgroundImage}set backgroundImage(e){this._backgroundImage!==e&&(this._backgroundImage=e,e&&!e.isLoaded&&e.onImageLoadedObservable.addOnce((()=>this._markAsDirty())),this._markAsDirty())}get valueBarImage(){return this._valueBarImage}set valueBarImage(e){this._valueBarImage!==e&&(this._valueBarImage=e,e&&!e.isLoaded&&e.onImageLoadedObservable.addOnce((()=>this._markAsDirty())),this._markAsDirty())}get thumbImage(){return this._thumbImage}set thumbImage(e){this._thumbImage!==e&&(this._thumbImage=e,e&&!e.isLoaded&&e.onImageLoadedObservable.addOnce((()=>this._markAsDirty())),this._markAsDirty())}constructor(e){super(e),this.name=e,this._tempMeasure=new Dd(0,0,0,0)}_getTypeName(){return"ImageBasedSlider"}_draw(e){e.save(),this._applyStates(e),this._prepareRenderingData("rectangle");const t=this._getThumbPosition(),i=this._renderLeft,s=this._renderTop,n=this._renderWidth,r=this._renderHeight;this._backgroundImage&&(this._tempMeasure.copyFromFloats(i,s,n,r),this.isThumbClamped&&this.displayThumb&&(this.isVertical?this._tempMeasure.height+=this._effectiveThumbThickness:this._tempMeasure.width+=this._effectiveThumbThickness),this._backgroundImage._currentMeasure.copyFrom(this._tempMeasure),this._backgroundImage._draw(e)),this._valueBarImage&&(this.isVertical?this.isThumbClamped&&this.displayThumb?this._tempMeasure.copyFromFloats(i,s+t,n,r-t+this._effectiveThumbThickness):this._tempMeasure.copyFromFloats(i,s+t,n,r-t):this.isThumbClamped&&this.displayThumb?this._tempMeasure.copyFromFloats(i,s,t+this._effectiveThumbThickness/2,r):this._tempMeasure.copyFromFloats(i,s,t,r),this._valueBarImage._currentMeasure.copyFrom(this._tempMeasure),this._valueBarImage._draw(e)),this.displayThumb&&(this.isVertical?this._tempMeasure.copyFromFloats(i-this._effectiveBarOffset,this._currentMeasure.top+t,this._currentMeasure.width,this._effectiveThumbThickness):this._tempMeasure.copyFromFloats(this._currentMeasure.left+t,this._currentMeasure.top,this._effectiveThumbThickness,this._currentMeasure.height),this._thumbImage._currentMeasure.copyFrom(this._tempMeasure),this._thumbImage._draw(e)),e.restore()}serialize(e){super.serialize(e);const t={},i={},s={};this.backgroundImage.serialize(t),this.thumbImage.serialize(i),this.valueBarImage.serialize(s),e.backgroundImage=t,e.thumbImage=i,e.valueBarImage=s}_parseFromContent(e,t){super._parseFromContent(e,t),this.backgroundImage=Gd.Parse(e.backgroundImage,t),this.thumbImage=Gd.Parse(e.thumbImage,t),this.valueBarImage=Gd.Parse(e.valueBarImage,t)}}De([Ge()],du.prototype,"displayThumb",null),ue("BABYLON.GUI.ImageBasedSlider",du),wd.AddHeader=function(e,t,i,s){const n=new Hd("panel"),r=!s||s.isHorizontal,o=!s||s.controlFirst;n.isVertical=!r;const a=new Vd("header");return a.text=t,a.textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,r?a.width=i:a.height=i,o?(n.addControl(e),n.addControl(a),a.paddingLeft="5px"):(n.addControl(a),n.addControl(e),a.paddingRight="5px"),a.shadowBlur=e.shadowBlur,a.shadowColor=e.shadowColor,a.shadowOffsetX=e.shadowOffsetX,a.shadowOffsetY=e.shadowOffsetY,n};class uu{constructor(){this._colorStops=[],this._gradientDirty=!0}_addColorStopsToCanvasGradient(){for(const e of this._colorStops)this._canvasGradient.addColorStop(e.offset,e.color)}getCanvasGradient(e){return(this._gradientDirty||this._context!==e)&&(this._context=e,this._canvasGradient=this._createCanvasGradient(e),this._addColorStopsToCanvasGradient(),this._gradientDirty=!1),this._canvasGradient}addColorStop(e,t){this._colorStops.push({offset:e,color:t}),this._gradientDirty=!0}removeColorStop(e){this._colorStops=this._colorStops.filter((t=>t.offset!==e)),this._gradientDirty=!0}clearColorStops(){this._colorStops=[],this._gradientDirty=!0}get colorStops(){return this._colorStops}getClassName(){return"BaseGradient"}serialize(e){e.colorStops=this._colorStops,e.className=this.getClassName()}parse(e){this._colorStops=e.colorStops}}ue("BABYLON.GUI.LinearGradient",class extends uu{constructor(e,t,i,s){super(),this._x0=null!=e?e:0,this._y0=null!=t?t:0,this._x1=null!=i?i:0,this._y1=null!=s?s:0}_createCanvasGradient(e){return e.createLinearGradient(this._x0,this._y0,this._x1,this._y1)}get x0(){return this._x0}get x1(){return this._x1}get y0(){return this._y0}get y1(){return this._y1}getClassName(){return"LinearGradient"}serialize(e){super.serialize(e),e.x0=this._x0,e.y0=this._y0,e.x1=this._x1,e.y1=this._y1}parse(e){super.parse(e),this._x0=e.x0,this._y0=e.y0,this._x1=e.x1,this._y1=e.y1}}),ue("BABYLON.GUI.RadialGradient",class extends uu{constructor(e,t,i,s,n,r){super(),this._x0=null!=e?e:0,this._y0=null!=t?t:0,this._r0=null!=i?i:0,this._x1=null!=s?s:0,this._y1=null!=n?n:0,this._r1=null!=r?r:0}_createCanvasGradient(e){return e.createRadialGradient(this._x0,this._y0,this._r0,this._x1,this._y1,this._r1)}get x0(){return this._x0}get x1(){return this._x1}get y0(){return this._y0}get y1(){return this._y1}get r0(){return this._r0}get r1(){return this._r1}getClassName(){return"RadialGradient"}serialize(e){super.serialize(e),e.x0=this._x0,e.y0=this._y0,e.r0=this._r0,e.x1=this._x1,e.y1=this._y1,e.r1=this._r1}parse(e){super.parse(e),this._x0=e.x0,this._y0=e.y0,this._r0=e.r0,this._x1=e.x1,this._y1=e.y1,this._r1=e.r1}});class _u{constructor(e){this._fontFamily="Arial",this._fontStyle="",this._fontWeight="",this._fontSize=new Rd(18,Rd.UNITMODE_PIXEL,!1),this.onChangedObservable=new s,this._host=e}get fontSize(){return this._fontSize.toString(this._host)}set fontSize(e){this._fontSize.toString(this._host)!==e&&this._fontSize.fromString(e)&&this.onChangedObservable.notifyObservers(this)}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this.onChangedObservable.notifyObservers(this))}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle!==e&&(this._fontStyle=e,this.onChangedObservable.notifyObservers(this))}get fontWeight(){return this._fontWeight}set fontWeight(e){this._fontWeight!==e&&(this._fontWeight=e,this.onChangedObservable.notifyObservers(this))}dispose(){this.onChangedObservable.clear()}}class fu extends ho{get numLayoutCalls(){return this._numLayoutCalls}get numRenderCalls(){return this._numRenderCalls}get renderScale(){return this._renderScale}set renderScale(e){e!==this._renderScale&&(this._renderScale=e,this._onResize())}get background(){return this._background}set background(e){this._background!==e&&(this._background=e,this.markAsDirty())}get idealWidth(){return this._idealWidth}set idealWidth(e){this._idealWidth!==e&&(this._idealWidth=e,this.markAsDirty(),this._rootContainer._markAllAsDirty())}get idealHeight(){return this._idealHeight}set idealHeight(e){this._idealHeight!==e&&(this._idealHeight=e,this.markAsDirty(),this._rootContainer._markAllAsDirty())}get useSmallestIdeal(){return this._useSmallestIdeal}set useSmallestIdeal(e){this._useSmallestIdeal!==e&&(this._useSmallestIdeal=e,this.markAsDirty(),this._rootContainer._markAllAsDirty())}get renderAtIdealSize(){return this._renderAtIdealSize}set renderAtIdealSize(e){this._renderAtIdealSize!==e&&(this._renderAtIdealSize=e,this._onResize())}get idealRatio(){let e=0,t=0;return this._idealWidth&&(e=this.getSize().width/this._idealWidth),this._idealHeight&&(t=this.getSize().height/this._idealHeight),this._useSmallestIdeal&&this._idealWidth&&this._idealHeight?window.innerWidth<window.innerHeight?e:t:this._idealWidth?e:this._idealHeight?t:1}get layer(){return this._layerToDispose}get rootContainer(){return this._rootContainer}getChildren(){return[this._rootContainer]}getDescendants(e,t){return this._rootContainer.getDescendants(e,t)}getControlsByType(e){return this._rootContainer.getDescendants(!1,(t=>t.typeName===e))}getControlByName(e){return this._getControlByKey("name",e)}_getControlByKey(e,t){return this._rootContainer.getDescendants().find((i=>i[e]===t))||null}get focusedControl(){return this._focusedControl}set focusedControl(e){this._focusedControl!=e&&(this._focusedControl&&this._focusedControl.onBlur(),e&&e.onFocus(),this._focusedControl=e)}get isForeground(){return!this.layer||!this.layer.isBackground}set isForeground(e){this.layer&&this.layer.isBackground!==!e&&(this.layer.isBackground=!e)}get clipboardData(){return this._clipboardData}set clipboardData(e){this._clipboardData=e}constructor(e,t=0,i=0,n,r=!1,o=zi.NEAREST_SAMPLINGMODE,a=!0){super(e,{width:t,height:i},n,r,o,Dh.TEXTUREFORMAT_RGBA,a),this.onGuiReadyObservable=new s,this._isDirty=!1,this._rootContainer=new Bd("root"),this._lastControlOver={},this._lastControlDown={},this._capturingControl={},this._linkedControls=new Array,this._isFullscreen=!1,this._fullscreenViewport=new Ut(0,0,1,1),this._idealWidth=0,this._idealHeight=0,this._useSmallestIdeal=!1,this._renderAtIdealSize=!1,this._blockNextFocusCheck=!1,this._renderScale=1,this._cursorChanged=!1,this._defaultMousePointerId=0,this._rootChildrenHaveChanged=!1,this._capturedPointerIds=new Set,this._numLayoutCalls=0,this._numRenderCalls=0,this._clipboardData="",this.onClipboardObservable=new s,this.onControlPickedObservable=new s,this.onBeginLayoutObservable=new s,this.onEndLayoutObservable=new s,this.onBeginRenderObservable=new s,this.onEndRenderObservable=new s,this.premulAlpha=!1,this.applyYInversionOnUpdate=!0,this.skipBlockEvents=0,this.checkPointerEveryFrame=!1,this._useInvalidateRectOptimization=!0,this._invalidatedRectangle=null,this._clearMeasure=new Dd(0,0,0,0),this._onClipboardCopy=e=>{const t=e,i=new Qd(Xd.COPY,t);this.onClipboardObservable.notifyObservers(i),t.preventDefault()},this._onClipboardCut=e=>{const t=e,i=new Qd(Xd.CUT,t);this.onClipboardObservable.notifyObservers(i),t.preventDefault()},this._onClipboardPaste=e=>{const t=e,i=new Qd(Xd.PASTE,t);this.onClipboardObservable.notifyObservers(i),t.preventDefault()},this.parseContent=this.parseSerializedObject,(n=this.getScene())&&this._texture&&(this.applyYInversionOnUpdate=a,this._rootElement=n.getEngine().getInputElement(),this._renderObserver=n.onBeforeCameraRenderObservable.add((e=>this._checkUpdate(e))),this._controlAddedObserver=this._rootContainer.onControlAddedObservable.add((e=>{e&&(this._rootChildrenHaveChanged=!0)})),this._controlRemovedObserver=this._rootContainer.onControlRemovedObservable.add((e=>{e&&(this._rootChildrenHaveChanged=!0)})),this._preKeyboardObserver=n.onPreKeyboardObservable.add((e=>{this._focusedControl&&(e.type===pi.KEYDOWN&&this._focusedControl.processKeyboard(e.event),e.skipOnPointerObservable=!0)})),this._rootContainer._link(this),this.hasAlpha=!0,t&&i||(this._resizeObserver=n.getEngine().onResizeObservable.add((()=>this._onResize())),this._onResize()),this._texture.isReady=!0)}getClassName(){return"AdvancedDynamicTexture"}executeOnAllControls(e,t){t||(t=this._rootContainer),e(t);for(const i of t.children)i.children?this.executeOnAllControls(e,i):e(i)}get useInvalidateRectOptimization(){return this._useInvalidateRectOptimization}set useInvalidateRectOptimization(e){this._useInvalidateRectOptimization=e}invalidateRect(e,t,i,s){if(this._useInvalidateRectOptimization)if(this._invalidatedRectangle){const n=Math.ceil(Math.max(this._invalidatedRectangle.left+this._invalidatedRectangle.width-1,i)),r=Math.ceil(Math.max(this._invalidatedRectangle.top+this._invalidatedRectangle.height-1,s));this._invalidatedRectangle.left=Math.floor(Math.min(this._invalidatedRectangle.left,e)),this._invalidatedRectangle.top=Math.floor(Math.min(this._invalidatedRectangle.top,t)),this._invalidatedRectangle.width=n-this._invalidatedRectangle.left+1,this._invalidatedRectangle.height=r-this._invalidatedRectangle.top+1}else this._invalidatedRectangle=new Dd(e,t,i-e+1,s-t+1)}markAsDirty(){this._isDirty=!0}createStyle(){return new _u(this)}addControl(e){return this._rootContainer.addControl(e),this}removeControl(e){return this._rootContainer.removeControl(e),this}moveToNonOverlappedPosition(e,t=1,i=1){let s;if(Array.isArray(e))s=e;else{const t=this.getDescendants(!0);s=void 0===e?t.filter((e=>void 0!==e.overlapGroup)):t.filter((t=>t.overlapGroup===e))}s.forEach((e=>{var n;let r=pe.Zero();const o=new pe(e.centerX,e.centerY);s.forEach((t=>{if(e!==t&&fu._Overlaps(e,t)){const e=o.subtract(new pe(t.centerX,t.centerY)),s=e.length();s>0&&(r=r.add(e.normalize().scale(i/s)))}})),r.length()>0&&(r=r.normalize().scale(t*(null!==(n=e.overlapDeltaMultiplier)&&void 0!==n?n:1)),e.linkOffsetXInPixels+=r.x,e.linkOffsetYInPixels+=r.y)}))}dispose(){const e=this.getScene();e&&(this._rootElement=null,e.onBeforeCameraRenderObservable.remove(this._renderObserver),this._resizeObserver&&e.getEngine().onResizeObservable.remove(this._resizeObserver),this._prePointerObserver&&e.onPrePointerObservable.remove(this._prePointerObserver),this._sceneRenderObserver&&e.onBeforeRenderObservable.remove(this._sceneRenderObserver),this._pointerObserver&&e.onPointerObservable.remove(this._pointerObserver),this._preKeyboardObserver&&e.onPreKeyboardObservable.remove(this._preKeyboardObserver),this._canvasPointerOutObserver&&e.getEngine().onCanvasPointerOutObservable.remove(this._canvasPointerOutObserver),this._canvasBlurObserver&&e.getEngine().onCanvasBlurObservable.remove(this._canvasBlurObserver),this._controlAddedObserver&&this._rootContainer.onControlAddedObservable.remove(this._controlAddedObserver),this._controlRemovedObserver&&this._rootContainer.onControlRemovedObservable.remove(this._controlRemovedObserver),this._layerToDispose&&(this._layerToDispose.texture=null,this._layerToDispose.dispose(),this._layerToDispose=null),this._rootContainer.dispose(),this.onClipboardObservable.clear(),this.onControlPickedObservable.clear(),this.onBeginRenderObservable.clear(),this.onEndRenderObservable.clear(),this.onBeginLayoutObservable.clear(),this.onEndLayoutObservable.clear(),this.onGuiReadyObservable.clear(),super.dispose())}_onResize(){const e=this.getScene();if(!e)return;const t=e.getEngine(),i=this.getSize();let s=t.getRenderWidth()*this._renderScale,n=t.getRenderHeight()*this._renderScale;this._renderAtIdealSize&&(this._idealWidth?(n=n*this._idealWidth/s,s=this._idealWidth):this._idealHeight&&(s=s*this._idealHeight/n,n=this._idealHeight)),i.width===s&&i.height===n||(this.scaleTo(s,n),this.markAsDirty(),(this._idealWidth||this._idealHeight)&&this._rootContainer._markAllAsDirty()),this.invalidateRect(0,0,i.width-1,i.height-1)}_getGlobalViewport(){const e=this.getSize(),t=this._fullscreenViewport.toGlobal(e.width,e.height),i=Math.round(t.width*(1/this.rootContainer.scaleX)),s=Math.round(t.height*(1/this.rootContainer.scaleY));return t.x+=(t.width-i)/2,t.y+=(t.height-s)/2,t.width=i,t.height=s,t}getProjectedPosition(e,t){const i=this.getProjectedPositionWithZ(e,t);return new pe(i.x,i.y)}getProjectedPositionWithZ(e,t){const i=this.getScene();if(!i)return me.Zero();const s=this._getGlobalViewport(),n=me.Project(e,t,i.getTransformMatrix(),s);return new me(n.x,n.y,n.z)}_checkUpdate(e,t){if(!this._layerToDispose||0!=(e.layerMask&this._layerToDispose.layerMask)){if(this._isFullscreen&&this._linkedControls.length){const e=this.getScene();if(!e)return;const t=this._getGlobalViewport();for(const i of this._linkedControls){if(!i.isVisible)continue;const s=i._linkedMesh;if(!s||s.isDisposed()){Ot.SetImmediate((()=>{i.linkWithMesh(null)}));continue}const n=s.getBoundingInfo?s.getBoundingInfo().boundingSphere.center:me.ZeroReadOnly,r=me.Project(n,s.getWorldMatrix(),e.getTransformMatrix(),t);r.z<0||r.z>1?i.notRenderable=!0:(i.notRenderable=!1,this.useInvalidateRectOptimization&&i.invalidateRect(),i._moveToProjectedPosition(r))}}(this._isDirty||this._rootContainer.isDirty)&&(this._isDirty=!1,this._render(t),t||this.update(this.applyYInversionOnUpdate,this.premulAlpha,fu.AllowGPUOptimizations))}}_render(e){var t;const i=this.getSize(),s=i.width,n=i.height,r=this.getContext();if(r.font="18px Arial",r.strokeStyle="white",this.onGuiReadyObservable.hasObservers()&&this._checkGuiIsReady(),this._rootChildrenHaveChanged){const e=null===(t=this.getScene())||void 0===t?void 0:t.activeCamera;e&&(this._rootChildrenHaveChanged=!1,this._checkUpdate(e,!0))}this.onBeginLayoutObservable.notifyObservers(this);const o=new Dd(0,0,s,n);this._numLayoutCalls=0,this._rootContainer._layout(o,r),this.onEndLayoutObservable.notifyObservers(this),this._isDirty=!1,e||(this._invalidatedRectangle?this._clearMeasure.copyFrom(this._invalidatedRectangle):this._clearMeasure.copyFromFloats(0,0,s,n),r.clearRect(this._clearMeasure.left,this._clearMeasure.top,this._clearMeasure.width,this._clearMeasure.height),this._background&&(r.save(),r.fillStyle=this._background,r.fillRect(this._clearMeasure.left,this._clearMeasure.top,this._clearMeasure.width,this._clearMeasure.height),r.restore()),this.onBeginRenderObservable.notifyObservers(this),this._numRenderCalls=0,this._rootContainer._render(r,this._invalidatedRectangle),this.onEndRenderObservable.notifyObservers(this),this._invalidatedRectangle=null)}_changeCursor(e){this._rootElement&&(this._rootElement.style.cursor=e,this._cursorChanged=!0)}_registerLastControlDown(e,t){this._lastControlDown[t]=e,this.onControlPickedObservable.notifyObservers(e)}_doPicking(e,t,i,s,n,r,o,a){const l=this.getScene();if(!l)return;const h=l.getEngine(),c=this.getSize();if(this._isFullscreen){const i=l.cameraToUseForPointers||l.activeCamera;if(!i)return;const s=i.viewport;e*=c.width/(h.getRenderWidth()*s.width),t*=c.height/(h.getRenderHeight()*s.height)}if(this._capturingControl[n])return this._capturingControl[n].isPointerBlocker&&(this._shouldBlockPointer=!0),void this._capturingControl[n]._processObservables(s,e,t,i,n,r);this._cursorChanged=!1,this._rootContainer._processPicking(e,t,i,s,n,r,o,a)||(l.doNotHandleCursors||this._changeCursor(""),s===ci.POINTERMOVE&&this._lastControlOver[n]&&(this._lastControlOver[n]._onPointerOut(this._lastControlOver[n],i),delete this._lastControlOver[n])),this._cursorChanged||l.doNotHandleCursors||this._changeCursor(""),this._manageFocus()}_cleanControlAfterRemovalFromList(e,t){for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&e[i]===t&&delete e[i]}_cleanControlAfterRemoval(e){this._cleanControlAfterRemovalFromList(this._lastControlDown,e),this._cleanControlAfterRemovalFromList(this._lastControlOver,e)}pick(e,t,i=null){this._isFullscreen&&this._scene&&this._translateToPicking(this._scene,new Ut(0,0,0,0),i,e,t)}_translateToPicking(e,t,i,s=e.pointerX,n=e.pointerY){const r=e.cameraToUseForPointers||e.activeCamera,o=e.getEngine(),a=e.cameraToUseForPointers;if(r)if(r.rigCameras.length){const i=new Ut(0,0,1,1);r.rigCameras.forEach((r=>{r.viewport.toGlobalToRef(o.getRenderWidth(),o.getRenderHeight(),i);const a=s/o.getHardwareScalingLevel()-i.x,l=n/o.getHardwareScalingLevel()-(o.getRenderHeight()-i.y-i.height);a<0||l<0||s>i.width||n>i.height||(e.cameraToUseForPointers=r,t.x=i.x,t.y=i.y,t.width=i.width,t.height=i.height)}))}else r.viewport.toGlobalToRef(o.getRenderWidth(),o.getRenderHeight(),t);else t.x=0,t.y=0,t.width=o.getRenderWidth(),t.height=o.getRenderHeight();const l=s/o.getHardwareScalingLevel()-t.x,h=n/o.getHardwareScalingLevel()-(o.getRenderHeight()-t.y-t.height);if(this._shouldBlockPointer=!1,i){const e=i.event.pointerId||this._defaultMousePointerId;this._doPicking(l,h,i,i.type,e,i.event.button,i.event.deltaX,i.event.deltaY),(this._shouldBlockPointer&&!(i.type&this.skipBlockEvents)||this._capturingControl[e])&&(i.skipOnPointerObservable=!0)}else this._doPicking(l,h,null,ci.POINTERMOVE,this._defaultMousePointerId,0);e.cameraToUseForPointers=a}attach(){const e=this.getScene();if(!e)return;const t=new Ut(0,0,0,0);this._prePointerObserver=e.onPrePointerObservable.add((i=>{if((!e.isPointerCaptured(i.event.pointerId)||i.type!==ci.POINTERUP||this._capturedPointerIds.has(i.event.pointerId))&&(i.type===ci.POINTERMOVE||i.type===ci.POINTERUP||i.type===ci.POINTERDOWN||i.type===ci.POINTERWHEEL)){if(i.type===ci.POINTERMOVE){if(e.isPointerCaptured(i.event.pointerId))return;i.event.pointerId&&(this._defaultMousePointerId=i.event.pointerId)}this._translateToPicking(e,t,i)}})),this._attachPickingToSceneRender(e,(()=>this._translateToPicking(e,t,null)),!1),this._attachToOnPointerOut(e),this._attachToOnBlur(e)}registerClipboardEvents(){self.addEventListener("copy",this._onClipboardCopy,!1),self.addEventListener("cut",this._onClipboardCut,!1),self.addEventListener("paste",this._onClipboardPaste,!1)}unRegisterClipboardEvents(){self.removeEventListener("copy",this._onClipboardCopy),self.removeEventListener("cut",this._onClipboardCut),self.removeEventListener("paste",this._onClipboardPaste)}_transformUvs(e){const t=this.getTextureMatrix();let i;if(t.isIdentityAs3x2())i=e;else{const s=Ee.Matrix[0];t.getRowToRef(0,Ee.Vector4[0]),t.getRowToRef(1,Ee.Vector4[1]),t.getRowToRef(2,Ee.Vector4[2]);const n=Ee.Vector4[0],r=Ee.Vector4[1],o=Ee.Vector4[2];s.setRowFromFloats(0,n.x,n.y,0,0),s.setRowFromFloats(1,r.x,r.y,0,0),s.setRowFromFloats(2,0,0,1,0),s.setRowFromFloats(3,o.x,o.y,0,1),i=Ee.Vector2[0],pe.TransformToRef(e,s,i)}if((this.wrapU===zi.WRAP_ADDRESSMODE||this.wrapU===zi.MIRROR_ADDRESSMODE)&&i.x>1){let e=i.x-Math.trunc(i.x);this.wrapU===zi.MIRROR_ADDRESSMODE&&Math.trunc(i.x)%2==1&&(e=1-e),i.x=e}if((this.wrapV===zi.WRAP_ADDRESSMODE||this.wrapV===zi.MIRROR_ADDRESSMODE)&&i.y>1){let e=i.y-Math.trunc(i.y);this.wrapV===zi.MIRROR_ADDRESSMODE&&Math.trunc(i.x)%2==1&&(e=1-e),i.y=e}return i}attachToMesh(e,t=!0){const i=this.getScene();i&&(this._pointerObserver&&i.onPointerObservable.remove(this._pointerObserver),this._pointerObserver=i.onPointerObservable.add((t=>{if(t.type!==ci.POINTERMOVE&&t.type!==ci.POINTERUP&&t.type!==ci.POINTERDOWN&&t.type!==ci.POINTERWHEEL)return;t.type===ci.POINTERMOVE&&t.event.pointerId&&(this._defaultMousePointerId=t.event.pointerId);const i=t.event.pointerId||this._defaultMousePointerId;if(t.pickInfo&&t.pickInfo.hit&&t.pickInfo.pickedMesh===e){let e=t.pickInfo.getTextureCoordinates();if(e){e=this._transformUvs(e);const s=this.getSize();this._doPicking(e.x*s.width,(this.applyYInversionOnUpdate?1-e.y:e.y)*s.height,t,t.type,i,t.event.button,t.event.deltaX,t.event.deltaY)}}else if(t.type===ci.POINTERUP){if(this._lastControlDown[i]&&this._lastControlDown[i]._forcePointerUp(i),delete this._lastControlDown[i],this.focusedControl){const e=this.focusedControl.keepsFocusWith();let t=!0;if(e)for(const s of e){if(this===s._host)continue;const e=s._host;if(e._lastControlOver[i]&&e._lastControlOver[i].isAscendant(s)){t=!1;break}}t&&(this.focusedControl=null)}}else t.type===ci.POINTERMOVE&&(this._lastControlOver[i]&&this._lastControlOver[i]._onPointerOut(this._lastControlOver[i],t,!0),delete this._lastControlOver[i])})),e.enablePointerMoveEvents=t,this._attachPickingToSceneRender(i,(()=>{const t=this._defaultMousePointerId,s=null==i?void 0:i.pick(i.pointerX,i.pointerY);if(s&&s.hit&&s.pickedMesh===e){let e=s.getTextureCoordinates();if(e){e=this._transformUvs(e);const i=this.getSize();this._doPicking(e.x*i.width,(this.applyYInversionOnUpdate?1-e.y:e.y)*i.height,null,ci.POINTERMOVE,t,0)}}else this._lastControlOver[t]&&this._lastControlOver[t]._onPointerOut(this._lastControlOver[t],null,!0),delete this._lastControlOver[t]}),!0),this._attachToOnPointerOut(i),this._attachToOnBlur(i))}moveFocusToControl(e){this.focusedControl=e,this._lastPickedControl=e,this._blockNextFocusCheck=!0}_manageFocus(){if(this._blockNextFocusCheck)return this._blockNextFocusCheck=!1,void(this._lastPickedControl=this._focusedControl);if(this._focusedControl&&this._focusedControl!==this._lastPickedControl){if(this._lastPickedControl.isFocusInvisible)return;this.focusedControl=null}}_attachPickingToSceneRender(e,t,i){this._sceneRenderObserver=e.onBeforeRenderObservable.add((()=>{this.checkPointerEveryFrame&&(this._linkedControls.length>0||i)&&t()}))}_attachToOnPointerOut(e){this._canvasPointerOutObserver=e.getEngine().onCanvasPointerOutObservable.add((e=>{this._lastControlOver[e.pointerId]&&this._lastControlOver[e.pointerId]._onPointerOut(this._lastControlOver[e.pointerId],null),delete this._lastControlOver[e.pointerId],this._lastControlDown[e.pointerId]&&this._lastControlDown[e.pointerId]!==this._capturingControl[e.pointerId]&&(this._lastControlDown[e.pointerId]._forcePointerUp(e.pointerId),delete this._lastControlDown[e.pointerId])}))}_attachToOnBlur(e){this._canvasBlurObserver=e.getEngine().onCanvasBlurObservable.add((()=>{Object.entries(this._lastControlDown).forEach((([,e])=>{e._onCanvasBlur()})),this.focusedControl=null,this._lastControlDown={}}))}serializeContent(){const e=this.getSize(),t={root:{},width:e.width,height:e.height};return this._rootContainer.serialize(t.root),t}parseSerializedObject(e,t){if(this._rootContainer=wd.Parse(e.root,this),t){const t=e.width,i=e.height;"number"==typeof t&&"number"==typeof i&&t>=0&&i>=0?this.scaleTo(t,i):this.scaleTo(1920,1080)}}clone(e){const t=this.getScene();if(!t)return this;const i=this.getSize(),s=this.serializeContent(),n=new fu(null!=e?e:"Clone of "+this.name,i.width,i.height,t,!this.noMipmap,this.samplingMode);return n.parseSerializedObject(s),n}static async ParseFromSnippetAsync(e,t,i){const s=null!=i?i:fu.CreateFullscreenUI("ADT from snippet");if("_BLANK"===e)return s;const n=await fu._LoadURLContentAsync(fu.SnippetUrl+"/"+e.replace(/#/g,"/"),!0);return s.parseSerializedObject(n,t),s}parseFromSnippetAsync(e,t){return fu.ParseFromSnippetAsync(e,t,this)}static async ParseFromFileAsync(e,t,i){const s=null!=i?i:fu.CreateFullscreenUI("ADT from URL"),n=await fu._LoadURLContentAsync(e);return s.parseSerializedObject(n,t),s}parseFromURLAsync(e,t){return fu.ParseFromFileAsync(e,t,this)}static _LoadURLContentAsync(e,t=!1){return""===e?Promise.reject("No URL provided"):new Promise(((i,s)=>{const n=new st;n.addEventListener("readystatechange",(()=>{if(4==n.readyState)if(200==n.status){let e;if(t){const t=JSON.parse(JSON.parse(n.responseText).jsonPayload);e=t.encodedGui?new TextDecoder("utf-8").decode(ct(t.encodedGui)):t.gui}else e=n.responseText;const s=JSON.parse(e);i(s)}else s("Unable to load")})),n.open("GET",e),n.send()}))}static _Overlaps(e,t){return!(e.centerX>t.centerX+t.widthInPixels||e.centerX+e.widthInPixels<t.centerX||e.centerY+e.heightInPixels<t.centerY||e.centerY>t.centerY+t.heightInPixels)}static CreateForMesh(e,t=1024,i=1024,s=!0,n=!1,r,o=this._CreateMaterial){const a=Mt(),l=new fu(`AdvancedDynamicTexture for ${e.name} [${a}]`,t,i,e.getScene(),!0,zi.TRILINEAR_SAMPLINGMODE,r);return o(e,a,l,n),l.attachToMesh(e,s),l}static _CreateMaterial(e,t,i,s){const n=_e("BABYLON.StandardMaterial");if(!n)throw"StandardMaterial needs to be imported before as it contains a side-effect required by your code.";const r=new n(`AdvancedDynamicTextureMaterial for ${e.name} [${t}]`,e.getScene());r.backFaceCulling=!1,r.diffuseColor=Re.Black(),r.specularColor=Re.Black(),s?(r.diffuseTexture=i,r.emissiveTexture=i,i.hasAlpha=!0):(r.emissiveTexture=i,r.opacityTexture=i),e.material=r}static CreateForMeshTexture(e,t=1024,i=1024,s=!0,n){const r=new fu(e.name+" AdvancedDynamicTexture",t,i,e.getScene(),!0,zi.TRILINEAR_SAMPLINGMODE,n);return r.attachToMesh(e,s),r}static CreateFullscreenUI(e,t=!0,i=null,s=zi.BILINEAR_SAMPLINGMODE,n=!1){const r=new fu(e,0,0,i,!1,s),o=r.getScene(),a=new pc(e+"_layer",null,o,!t);if(a.texture=r,r._layerToDispose=a,r._isFullscreen=!0,n&&o){const e=1/o.getEngine().getHardwareScalingLevel();r._rootContainer.scaleX=e,r._rootContainer.scaleY=e}return r.attach(),r}scale(e){super.scale(e),this.markAsDirty()}scaleTo(e,t){super.scaleTo(e,t),this.markAsDirty()}_checkGuiIsReady(){this.guiIsReady()&&(this.onGuiReadyObservable.notifyObservers(this),this.onGuiReadyObservable.clear())}guiIsReady(){return this._rootContainer.isReady()}}fu.SnippetUrl=Dh.SnippetUrl,fu.AllowGPUOptimizations=!0;class pu extends me{constructor(e,t=0){super(e.x,e.y,e.z),this.buttonIndex=t}}class mu{get position(){return this._node?this._node.position:me.Zero()}set position(e){this._node&&(this._node.position=e)}get scaling(){return this._node?this._node.scaling:new me(1,1,1)}set scaling(e){this._node&&(this._isScaledByManager=!1,this._node.scaling=e)}get behaviors(){return this._behaviors}addBehavior(e){if(-1!==this._behaviors.indexOf(e))return this;e.init();const t=this._host.scene;return t.isLoading?t.onDataLoadedObservable.addOnce((()=>{e.attach(this)})):e.attach(this),this._behaviors.push(e),this}removeBehavior(e){const t=this._behaviors.indexOf(e);return-1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}get isVisible(){return this._isVisible}set isVisible(e){if(this._isVisible===e)return;this._isVisible=e;const t=this.mesh;t&&t.setEnabled(e)}constructor(e){this.name=e,this._downCount=0,this._enterCount=-1,this._downPointerIds={},this._isVisible=!0,this._isScaledByManager=!1,this.onPointerMoveObservable=new s,this.onPointerOutObservable=new s,this.onPointerDownObservable=new s,this.onPointerUpObservable=new s,this.onPointerClickObservable=new s,this.onPointerEnterObservable=new s,this._behaviors=new Array}get typeName(){return this._getTypeName()}getClassName(){return this._getTypeName()}_getTypeName(){return"Control3D"}get node(){return this._node}get mesh(){return this._node instanceof Gn?this._node:null}linkToTransformNode(e){return this._node&&(this._node.parent=e),this}_prepareNode(e){if(!this._node){if(this._node=this._createNode(e),!this.node)return;this._injectGUI3DReservedDataStore(this.node).control=this;const t=this.mesh;t&&(t.isPickable=!0,this._affectMaterial(t))}}_injectGUI3DReservedDataStore(e){var t,i;return e.reservedDataStore=null!==(t=e.reservedDataStore)&&void 0!==t?t:{},e.reservedDataStore.GUI3D=null!==(i=e.reservedDataStore.GUI3D)&&void 0!==i?i:{},e.reservedDataStore.GUI3D}_createNode(e){return null}_affectMaterial(e){e.material=null}_isTouchButton3D(e){return void 0!==e._generatePointerEventType}_onPointerMove(e,t){this.onPointerMoveObservable.notifyObservers(t,-1,e,this)}_onPointerEnter(e){return-1===this._enterCount&&(this._enterCount=0),this._enterCount++,!(this._enterCount>1||(this.onPointerEnterObservable.notifyObservers(this,-1,e,this),this.pointerEnterAnimation&&this.pointerEnterAnimation(),0))}_onPointerOut(e){this._enterCount--,this._enterCount>0||(this._enterCount=0,this.onPointerOutObservable.notifyObservers(this,-1,e,this),this.pointerOutAnimation&&this.pointerOutAnimation())}_onPointerDown(e,t,i,s){return this._downCount++,this._downPointerIds[i]=this._downPointerIds[i]+1||1,1===this._downCount&&(this.onPointerDownObservable.notifyObservers(new pu(t,s),-1,e,this),this.pointerDownAnimation&&this.pointerDownAnimation(),!0)}_onPointerUp(e,t,i,s,n){this._downCount--,this._downPointerIds[i]--,this._downPointerIds[i]<=0&&delete this._downPointerIds[i],this._downCount<0?this._downCount=0:0==this._downCount&&(n&&(this._enterCount>0||-1===this._enterCount)&&this.onPointerClickObservable.notifyObservers(new pu(t,s),-1,e,this),this.onPointerUpObservable.notifyObservers(new pu(t,s),-1,e,this),this.pointerUpAnimation&&this.pointerUpAnimation())}forcePointerUp(e=null){if(null!==e)this._onPointerUp(this,me.Zero(),e,0,!0);else{for(const e in this._downPointerIds)this._onPointerUp(this,me.Zero(),+e,0,!0);this._downCount>0&&(this._downCount=1,this._onPointerUp(this,me.Zero(),0,0,!0))}}_processObservables(e,t,i,s,n){if(this._isTouchButton3D(this)&&i&&(e=this._generatePointerEventType(e,i,this._downCount)),e===ci.POINTERMOVE){this._onPointerMove(this,t);const e=this._host._lastControlOver[s];return e&&e!==this&&e._onPointerOut(this),e!==this&&this._onPointerEnter(this),this._host._lastControlOver[s]=this,!0}return e===ci.POINTERDOWN?(this._onPointerDown(this,t,s,n),this._host._lastControlDown[s]=this,this._host._lastPickedControl=this,!0):(e===ci.POINTERUP||e===ci.POINTERDOUBLETAP)&&(this._host._lastControlDown[s]&&this._host._lastControlDown[s]._onPointerUp(this,t,s,n,!0),delete this._host._lastControlDown[s],!0)}_disposeNode(){this._node&&(this._node.dispose(),this._node=null)}dispose(){this.onPointerDownObservable.clear(),this.onPointerEnterObservable.clear(),this.onPointerMoveObservable.clear(),this.onPointerOutObservable.clear(),this.onPointerUpObservable.clear(),this.onPointerClickObservable.clear(),this._disposeNode();for(const e of this._behaviors)e.detach()}}class gu extends mu{constructor(){super(...arguments),this._contentResolution=512,this._contentScaleRatio=2}get content(){return this._content}set content(e){this._content=e,e&&this._host&&this._host.utilityLayer&&(this._facadeTexture?this._facadeTexture.rootContainer.clearControls():(this._facadeTexture=new fu("Facade",this._contentResolution,this._contentResolution,this._host.utilityLayer.utilityLayerScene,!0,zi.TRILINEAR_SAMPLINGMODE),this._setFacadeTextureScaling(),this._facadeTexture.premulAlpha=!0),this._facadeTexture.addControl(e),this._applyFacade(this._facadeTexture))}_setFacadeTextureScaling(){var e;this._facadeTexture&&(this._facadeTexture.rootContainer.scaleX=this._contentScaleRatio,this._facadeTexture.rootContainer.scaleY=null!==(e=this._contentScaleRatioY)&&void 0!==e?e:this._contentScaleRatio)}get contentResolution(){return this._contentResolution}set contentResolution(e){this._contentResolution!==e&&(this._contentResolution=e,this._resetContent())}_disposeFacadeTexture(){this._facadeTexture&&(this._facadeTexture.dispose(),this._facadeTexture=null)}_resetContent(){this._disposeFacadeTexture(),this.content=this._content}_applyFacade(e){}}class vu extends gu{constructor(e){super(e)}_getTypeName(){return"AbstractButton3D"}_createNode(e){return new Bn("button"+this.name,e)}}class Tu extends vu{constructor(e,t){super(e),this._options={width:1,height:1,depth:.08,...t},this.pointerEnterAnimation=()=>{this.mesh&&(this._currentMaterial.emissiveColor=Re.Red())},this.pointerOutAnimation=()=>{this._currentMaterial.emissiveColor=Re.Black()},this.pointerDownAnimation=()=>{this.mesh&&this.mesh.scaling.scaleInPlace(.95)},this.pointerUpAnimation=()=>{this.mesh&&this.mesh.scaling.scaleInPlace(1/.95)}}_applyFacade(e){this._currentMaterial.emissiveTexture=e}_getTypeName(){return"Button3D"}_createNode(e){const t=new Array(6);for(let e=0;e<6;e++)t[e]=new ge(0,0,0,0);e.useRightHandedSystem?t[0].copyFromFloats(1,0,0,1):t[1].copyFromFloats(0,0,1,1);const i=Fr(this.name+"_rootMesh",{width:this._options.width,height:this._options.height,depth:this._options.depth,faceUV:t,wrap:!0},e);return this._contentScaleRatioY=this._contentScaleRatio*this._options.width/this._options.height,this._setFacadeTextureScaling(),i}_affectMaterial(e){const t=new zs(this.name+"Material",e.getScene());t.specularColor=Re.Black(),e.material=t,this._currentMaterial=t,this._resetContent()}dispose(){super.dispose(),this._disposeFacadeTexture(),this._currentMaterial&&this._currentMaterial.dispose()}}class bu extends mu{get children(){return this._children}get blockLayout(){return this._blockLayout}set blockLayout(e){this._blockLayout!==e&&(this._blockLayout=e,this._blockLayout||this._arrangeChildren())}constructor(e){super(e),this._blockLayout=!1,this._children=new Array}updateLayout(){return this._arrangeChildren(),this}containsControl(e){return-1!==this._children.indexOf(e)}addControl(e){return-1!==this._children.indexOf(e)||(e.parent=this,e._host=this._host,this._children.push(e),this._host.utilityLayer&&(e._prepareNode(this._host.utilityLayer.utilityLayerScene),e.node&&(e.node.parent=this.node),this.blockLayout||this._arrangeChildren())),this}_arrangeChildren(){}_createNode(e){return new Bn("ContainerNode",e)}removeControl(e){const t=this._children.indexOf(e);return-1!==t&&(this._children.splice(t,1),e.parent=null,e._disposeNode()),this}_getTypeName(){return"Container3D"}dispose(){for(const e of this._children)e.dispose();this._children.length=0,super.dispose()}}bu.UNSET_ORIENTATION=0,bu.FACEORIGIN_ORIENTATION=1,bu.FACEORIGINREVERSED_ORIENTATION=2,bu.FACEFORWARD_ORIENTATION=3,bu.FACEFORWARDREVERSED_ORIENTATION=4;class Eu extends bu{get orientation(){return this._orientation}set orientation(e){this._orientation!==e&&(this._orientation=e,Ot.SetImmediate((()=>{this._arrangeChildren()})))}get columns(){return this._columns}set columns(e){this._columns!==e&&(this._columns=e,this._rowThenColum=!0,Ot.SetImmediate((()=>{this._arrangeChildren()})))}get rows(){return this._rows}set rows(e){this._rows!==e&&(this._rows=e,this._rowThenColum=!1,Ot.SetImmediate((()=>{this._arrangeChildren()})))}constructor(e){super(e),this._columns=10,this._rows=0,this._rowThenColum=!0,this._orientation=bu.FACEORIGIN_ORIENTATION,this.margin=0}_arrangeChildren(){this._cellWidth=0,this._cellHeight=0;let e=0,t=0,i=0;const s=Te.Invert(this.node.computeWorldMatrix(!0));for(const e of this._children){if(!e.mesh)continue;i++,e.mesh.computeWorldMatrix(!0);const t=e.mesh.getHierarchyBoundingVectors(),n=Ee.Vector3[0],r=Ee.Vector3[1];t.max.subtractToRef(t.min,r),r.scaleInPlace(.5),me.TransformNormalToRef(r,s,n),this._cellWidth=Math.max(this._cellWidth,2*n.x),this._cellHeight=Math.max(this._cellHeight,2*n.y)}this._cellWidth+=2*this.margin,this._cellHeight+=2*this.margin,this._rowThenColum?(t=this._columns,e=Math.ceil(i/this._columns)):(e=this._rows,t=Math.ceil(i/this._rows));const n=.5*t*this._cellWidth,r=.5*e*this._cellHeight,o=[];let a=0;if(this._rowThenColum)for(let s=0;s<e;s++)for(let e=0;e<t&&(o.push(new me(e*this._cellWidth-n+this._cellWidth/2,s*this._cellHeight-r+this._cellHeight/2,0)),a++,!(a>i));e++);else for(let s=0;s<t;s++)for(let t=0;t<e&&(o.push(new me(s*this._cellWidth-n+this._cellWidth/2,t*this._cellHeight-r+this._cellHeight/2,0)),a++,!(a>i));t++);a=0;for(const e of this._children)e.mesh&&(this._mapGridNode(e,o[a]),a++);this._finalProcessing()}_finalProcessing(){}}F.ShadersStore.fluentVertexShader="precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;uniform mat4 world;uniform mat4 viewProjection;varying vec2 vUV;\n#ifdef BORDER\nvarying vec2 scaleInfo;uniform float borderWidth;uniform vec3 scaleFactor;\n#endif\n#ifdef HOVERLIGHT\nvarying vec3 worldPosition;\n#endif\nvoid main(void) {vUV=uv;\n#ifdef BORDER\nvec3 scale=scaleFactor;float minScale=min(min(scale.x,scale.y),scale.z);float maxScale=max(max(scale.x,scale.y),scale.z);float minOverMiddleScale=minScale/(scale.x+scale.y+scale.z-minScale-maxScale);float areaYZ=scale.y*scale.z;float areaXZ=scale.x*scale.z;float areaXY=scale.x*scale.y;float scaledBorderWidth=borderWidth; \nif (abs(normal.x)==1.0) \n{scale.x=scale.y;scale.y=scale.z;if (areaYZ>areaXZ && areaYZ>areaXY)\n{scaledBorderWidth*=minOverMiddleScale;}}\nelse if (abs(normal.y)==1.0) \n{scale.x=scale.z;if (areaXZ>areaXY && areaXZ>areaYZ)\n{scaledBorderWidth*=minOverMiddleScale;}}\nelse \n{if (areaXY>areaYZ && areaXY>areaXZ)\n{scaledBorderWidth*=minOverMiddleScale;}}\nfloat scaleRatio=min(scale.x,scale.y)/max(scale.x,scale.y);if (scale.x>scale.y)\n{scaleInfo.x=1.0-(scaledBorderWidth*scaleRatio);scaleInfo.y=1.0-scaledBorderWidth;}\nelse\n{scaleInfo.x=1.0-scaledBorderWidth;scaleInfo.y=1.0-(scaledBorderWidth*scaleRatio);} \n#endif \nvec4 worldPos=world*vec4(position,1.0);\n#ifdef HOVERLIGHT\nworldPosition=worldPos.xyz;\n#endif\ngl_Position=viewProjection*worldPos;}\n";F.ShadersStore.fluentPixelShader="precision highp float;varying vec2 vUV;uniform vec4 albedoColor;\n#ifdef INNERGLOW\nuniform vec4 innerGlowColor;\n#endif\n#ifdef BORDER\nvarying vec2 scaleInfo;uniform float edgeSmoothingValue;uniform float borderMinValue;\n#endif\n#ifdef HOVERLIGHT\nvarying vec3 worldPosition;uniform vec3 hoverPosition;uniform vec4 hoverColor;uniform float hoverRadius;\n#endif\n#ifdef TEXTURE\nuniform sampler2D albedoSampler;uniform mat4 textureMatrix;vec2 finalUV;\n#endif\nvoid main(void) {vec3 albedo=albedoColor.rgb;float alpha=albedoColor.a;\n#ifdef TEXTURE\nfinalUV=vec2(textureMatrix*vec4(vUV,1.0,0.0));albedo=texture2D(albedoSampler,finalUV).rgb;\n#endif\n#ifdef HOVERLIGHT\nfloat pointToHover=(1.0-clamp(length(hoverPosition-worldPosition)/hoverRadius,0.,1.))*hoverColor.a;albedo=clamp(albedo+hoverColor.rgb*pointToHover,0.,1.);\n#else\nfloat pointToHover=1.0;\n#endif\n#ifdef BORDER \nfloat borderPower=10.0;float inverseBorderPower=1.0/borderPower;vec3 borderColor=albedo*borderPower;vec2 distanceToEdge;distanceToEdge.x=abs(vUV.x-0.5)*2.0;distanceToEdge.y=abs(vUV.y-0.5)*2.0;float borderValue=max(smoothstep(scaleInfo.x-edgeSmoothingValue,scaleInfo.x+edgeSmoothingValue,distanceToEdge.x),\nsmoothstep(scaleInfo.y-edgeSmoothingValue,scaleInfo.y+edgeSmoothingValue,distanceToEdge.y));borderColor=borderColor*borderValue*max(borderMinValue*inverseBorderPower,pointToHover); \nalbedo+=borderColor;alpha=max(alpha,borderValue);\n#endif\n#ifdef INNERGLOW\nvec2 uvGlow=(vUV-vec2(0.5,0.5))*(innerGlowColor.a*2.0);uvGlow=uvGlow*uvGlow;uvGlow=uvGlow*uvGlow;albedo+=mix(vec3(0.0,0.0,0.0),innerGlowColor.rgb,uvGlow.x+uvGlow.y); \n#endif\ngl_FragColor=vec4(albedo,alpha);}";class Su extends Wt{constructor(){super(),this.INNERGLOW=!1,this.BORDER=!1,this.HOVERLIGHT=!1,this.TEXTURE=!1,this.rebuild()}}class xu extends Ms{constructor(e,t){super(e,t),this.innerGlowColorIntensity=.5,this.innerGlowColor=new Re(1,1,1),this.albedoColor=new Re(.3,.35,.4),this.renderBorders=!1,this.borderWidth=.5,this.edgeSmoothingValue=.02,this.borderMinValue=.1,this.renderHoverLight=!1,this.hoverRadius=.01,this.hoverColor=new Ie(.3,.3,.3,1),this.hoverPosition=me.Zero()}needAlphaBlending(){return 1!==this.alpha}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new Su);const i=this.getScene(),s=t.materialDefines;if(!this.checkReadyOnEveryCall&&t.effect&&s._renderId===i.getRenderId())return!0;if(s._areTexturesDirty)if(s.INNERGLOW=this.innerGlowColorIntensity>0,s.BORDER=this.renderBorders,s.HOVERLIGHT=this.renderHoverLight,this._albedoTexture){if(!this._albedoTexture.isReadyOrNotBlocking())return!1;s.TEXTURE=!0}else s.TEXTURE=!1;const n=i.getEngine();if(s.isDirty){s.markAsProcessed(),i.resetCachedMaterial();const e=[Oe.PositionKind];e.push(Oe.NormalKind),e.push(Oe.UVKind);const r="fluent",o=["world","viewProjection","innerGlowColor","albedoColor","borderWidth","edgeSmoothingValue","scaleFactor","borderMinValue","hoverColor","hoverPosition","hoverRadius","textureMatrix"],a=["albedoSampler"],l=[];wi.PrepareUniformsAndSamplersList({uniformsNames:o,uniformBuffersNames:l,samplers:a,defines:s,maxSimultaneousLights:4});const h=s.toString();t.setEffect(i.getEngine().createEffect(r,{attributes:e,uniformsNames:o,uniformBuffersNames:l,samplers:a,defines:h,fallbacks:null,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),s,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(s._renderId=i.getRenderId(),t.effect._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){const s=this.getScene(),n=i.materialDefines;if(!n)return;const r=i.effect;if(r){if(this._activeEffect=r,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),this._mustRebind(s,r)&&(this._activeEffect.setColor4("albedoColor",this.albedoColor,this.alpha),n.INNERGLOW&&this._activeEffect.setColor4("innerGlowColor",this.innerGlowColor,this.innerGlowColorIntensity),n.BORDER&&(this._activeEffect.setFloat("borderWidth",this.borderWidth),this._activeEffect.setFloat("edgeSmoothingValue",this.edgeSmoothingValue),this._activeEffect.setFloat("borderMinValue",this.borderMinValue),t.getBoundingInfo().boundingBox.extendSize.multiplyToRef(t.scaling,Ee.Vector3[0]),this._activeEffect.setVector3("scaleFactor",Ee.Vector3[0])),n.HOVERLIGHT&&(this._activeEffect.setDirectColor4("hoverColor",this.hoverColor),this._activeEffect.setFloat("hoverRadius",this.hoverRadius),this._activeEffect.setVector3("hoverPosition",this.hoverPosition)),n.TEXTURE&&this._albedoTexture)){this._activeEffect.setTexture("albedoSampler",this._albedoTexture);const e=this._albedoTexture.getTextureMatrix();this._activeEffect.setMatrix("textureMatrix",e)}this._afterBind(t,this._activeEffect)}}getActiveTextures(){return super.getActiveTextures()}hasTexture(e){return!!super.hasTexture(e)}dispose(e){super.dispose(e)}clone(e){return qe.Clone((()=>new xu(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.GUI.FluentMaterial",e}getClassName(){return"FluentMaterial"}static Parse(e,t,i){return qe.Parse((()=>new xu(e.name,t)),e,t,i)}}De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xu.prototype,"innerGlowColorIntensity",void 0),De([He()],xu.prototype,"innerGlowColor",void 0),De([He()],xu.prototype,"albedoColor",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xu.prototype,"renderBorders",void 0),De([Ge()],xu.prototype,"borderWidth",void 0),De([Ge()],xu.prototype,"edgeSmoothingValue",void 0),De([Ge()],xu.prototype,"borderMinValue",void 0),De([Ge(),Ve("_markAllSubMeshesAsTexturesDirty")],xu.prototype,"renderHoverLight",void 0),De([Ge()],xu.prototype,"hoverRadius",void 0),De([Ke()],xu.prototype,"hoverColor",void 0),De([Qe()],xu.prototype,"hoverPosition",void 0),De([ze("albedoTexture")],xu.prototype,"_albedoTexture",void 0),De([Ve("_markAllSubMeshesAsTexturesAndMiscDirty")],xu.prototype,"albedoTexture",void 0),ue("BABYLON.GUI.FluentMaterial",xu);class Cu extends Eu{get backPlateMargin(){return this._backPlateMargin}set backPlateMargin(e){this._backPlateMargin=e,this._children.length>=1&&(this.children.forEach((e=>{this._updateCurrentMinMax(e.position)})),this._updateMargins())}_createNode(e){const t=new jn(`menu_${this.name}`,e);return this._backPlate=Fr("backPlate"+this.name,{size:1},e),this._backPlate.parent=t,t}_affectMaterial(e){this._backPlateMaterial=new xu(this.name+"backPlateMaterial",e.getScene()),this._backPlateMaterial.albedoColor=new Re(.08,.15,.55),this._backPlateMaterial.renderBorders=!0,this._backPlateMaterial.renderHoverLight=!0,this._pickedPointObserver=this._host.onPickedPointChangedObservable.add((e=>{e?(this._backPlateMaterial.hoverPosition=e,this._backPlateMaterial.hoverColor.a=1):this._backPlateMaterial.hoverColor.a=0})),this._backPlate.material=this._backPlateMaterial}_mapGridNode(e,t){e.mesh&&(e.position=t.clone(),this._updateCurrentMinMax(t))}_finalProcessing(){this._updateMargins()}_updateCurrentMinMax(e){this._currentMin||(this._currentMin=e.clone(),this._currentMax=e.clone()),this._currentMin.minimizeInPlace(e),this._currentMax.maximizeInPlace(e)}_updateMargins(){if(this._children.length>0){this._currentMin.addInPlaceFromFloats(-this._cellWidth/2,-this._cellHeight/2,0),this._currentMax.addInPlaceFromFloats(this._cellWidth/2,this._cellHeight/2,0);const e=this._currentMax.subtract(this._currentMin);this._backPlate.scaling.x=e.x+this._cellWidth*this.backPlateMargin,this._backPlate.scaling.y=e.y+this._cellHeight*this.backPlateMargin,this._backPlate.scaling.z=.001;for(let t=0;t<this._children.length;t++)this._children[t].position.subtractInPlace(this._currentMin).subtractInPlace(e.scale(.5)),this._children[t].position.z-=.01}this._currentMin=null,this._currentMax=null}constructor(e){super(e),this._backPlateMargin=1.25}addButton(e){const t=this.blockLayout;return t||(this.blockLayout=!0),super.addControl(e),e.isBackplateVisible=!1,e.scaling.scaleInPlace(Cu.MENU_BUTTON_SCALE),t||(this.blockLayout=!1),this}addControl(e){return p.Warn("TouchHolographicMenu can only contain buttons. Please use the method `addButton` instead."),this}dispose(){super.dispose(),this._host.onPickedPointChangedObservable.remove(this._pickedPointObserver)}}Cu.MENU_BUTTON_SCALE=1;class yu{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint,this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}yu.DistanceJoint=0,yu.HingeJoint=1,yu.BallAndSocketJoint=2,yu.WheelJoint=3,yu.SliderJoint=4,yu.PrismaticJoint=5,yu.UniversalJoint=6,yu.Hinge2Joint=yu.WheelJoint,yu.PointToPointJoint=8,yu.SpringJoint=9,yu.LockJoint=10,jn._PhysicsImpostorParser=function(e,t,i){return new Au(t,i.physicsImpostor,{mass:i.physicsMass,friction:i.physicsFriction,restitution:i.physicsRestitution},e)};class Au{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},s){this.object=e,this.type=t,this._options=i,this._scene=s,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=me.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new ve,this._tmpQuat2=new ve,this.beforeStep=()=>{this._physicsEngine&&(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new ve),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach((e=>{e(this)})))},this.afterStep=()=>{this._physicsEngine&&(this._onAfterPhysicsStepCallbacks.forEach((e=>{e(this)})),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,Au._TmpVecs[0]),this.object.translate(Au._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=e=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent)return;if(!this._physicsEngine)return;const t=this._physicsEngine.getImpostorWithPhysicsBody(e.body);t&&(this.onCollideEvent&&this.onCollideEvent(this,t),this._onPhysicsCollideCallbacks.filter((e=>-1!==e.otherImpostors.indexOf(t))).forEach((i=>{i.callback(this,t,e.point,e.distance,e.impulse,e.normal)})))},this.object?(this.object.parent&&0!==i.mass&&p.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=ve.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new ve),this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=void 0===i.pressure?200:i.pressure,this._options.stiffness=void 0===i.stiffness?1:i.stiffness,this._options.velocityIterations=void 0===i.velocityIterations?20:i.velocityIterations,this._options.positionIterations=void 0===i.positionIterations?20:i.positionIterations,this._options.fixedPoints=void 0===i.fixedPoints?0:i.fixedPoints,this._options.margin=void 0===i.margin?0:i.margin,this._options.damping=void 0===i.damping?0:i.damping,this._options.path=void 0===i.path?null:i.path,this._options.shape=void 0===i.shape?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&p.Warn("You must affect impostors to children before affecting impostor to parent.")):p.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))):p.Error("No object was provided. A physics object is obligatory")}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),this._isDisposed||this.parent&&!this._options.ignoreParent||this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof Gn?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=Au.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const s=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return s.x=Math.abs(s.x),s.y=Math.abs(s.y),s.z=Math.abs(s.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),s}return Au.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):me.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):me.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):p.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):p.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let s=-1;this._onPhysicsCollideCallbacks.some(((e,n)=>{if(e.callback===t&&e.otherImpostors.length===i.length){const t=e.otherImpostors.every((e=>i.indexOf(e)>-1));return t&&(s=n),t}return!1}))?this._onPhysicsCollideCallbacks.splice(s,1):p.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):ve.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const s=new yu(t,i);return this.addJoint(e,s),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,s,n){if(!this._physicsEngine)return this;const r=this._physicsEngine.getPhysicsPlugin();return r.appendAnchor?(this._physicsEngine&&r.appendAnchor(this,e,t,i,s,n),this):this}addHook(e,t,i,s){if(!this._physicsEngine)return this;const n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor?(this._physicsEngine&&n.appendHook(this,e,t,i,s),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new Au(e,this.type,this._options,this._scene):null}dispose(){this._physicsEngine&&(this._joints.forEach((e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)})),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new ve),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,s,n){const r=Au._TmpVecs[0],o=this.object;if(o.rotationQuaternion)if(n){const i=Au._TmpQuat;o.rotationQuaternion.multiplyToRef(n,i),e.setRotationQuaternion(i,Js.WORLD,t)}else e.setRotationQuaternion(o.rotationQuaternion,Js.WORLD,t);r.x=0,r.y=0,r.z=0,i&&(r.x=i.x,r.y=i.y,r.z=i.z,e.getDirectionToRef(r,t,r),null==s&&(s=i.length()),r.x*=s,r.y*=s,r.z*=s),e.getParent()?(r.addInPlace(o.getAbsolutePosition()),e.setAbsolutePosition(r,t)):(t.setAbsolutePosition(o.getAbsolutePosition()),t.position.x-=r.x,t.position.y-=r.y,t.position.z-=r.z)}syncImpostorWithBone(e,t,i,s,n,r){const o=this.object;if(o.rotationQuaternion)if(n){const i=Au._TmpQuat;e.getRotationQuaternionToRef(Js.WORLD,t,i),i.multiplyToRef(n,o.rotationQuaternion)}else e.getRotationQuaternionToRef(Js.WORLD,t,o.rotationQuaternion);const a=Au._TmpVecs[0],l=Au._TmpVecs[1];r||((r=Au._TmpVecs[2]).x=0,r.y=1,r.z=0),e.getDirectionToRef(r,t,l),e.getAbsolutePositionToRef(t,a),null==s&&i&&(s=i.length()),null!=s&&(a.x+=l.x*s,a.y+=l.y*s,a.z+=l.z*s),o.setAbsolutePosition(a)}}function Ru(e){const t=e.sideOrientation||Nn.DEFAULTSIDE,i=e.radius||1,s=void 0===e.flat||e.flat,n=0|(e.subdivisions||4),r=e.radiusX||i,o=e.radiusY||i,a=e.radiusZ||i,l=(1+Math.sqrt(5))/2,h=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],c=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],d=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],u=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],_=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],f=[],p=[],m=[],g=[];let v=0;const T=new Array(3),b=new Array(3);let E;for(E=0;E<3;E++)T[E]=me.Zero(),b[E]=pe.Zero();for(let e=0;e<20;e++){for(E=0;E<3;E++){const t=c[3*e+E];T[E].copyFromFloats(h[3*d[t]],h[3*d[t]+1],h[3*d[t]+2]),T[E].normalize(),b[E].copyFromFloats(.134765625*u[2*t]+.05859375+-.0390625*_[e],.2333984375*u[2*t+1]+.025390625+.01953125*_[e])}const t=(e,t,i,l)=>{const h=me.Lerp(T[0],T[2],t/n),c=me.Lerp(T[1],T[2],t/n),d=n===t?T[2]:me.Lerp(h,c,e/(n-t));let u;if(d.normalize(),s){const e=me.Lerp(T[0],T[2],l/n),t=me.Lerp(T[1],T[2],l/n);u=me.Lerp(e,t,i/(n-l))}else u=new me(d.x,d.y,d.z);u.x/=r,u.y/=o,u.z/=a,u.normalize();const _=pe.Lerp(b[0],b[2],t/n),E=pe.Lerp(b[1],b[2],t/n),S=n===t?b[2]:pe.Lerp(_,E,e/(n-t));p.push(d.x*r,d.y*o,d.z*a),m.push(u.x,u.y,u.z),g.push(S.x,Gi.UseOpenGLOrientationForUV?1-S.y:S.y),f.push(v),v++};for(let e=0;e<n;e++)for(let i=0;i+e<n;i++)t(i,e,i+1/3,e+1/3),t(i+1,e,i+1/3,e+1/3),t(i,e+1,i+1/3,e+1/3),i+e+1<n&&(t(i+1,e,i+2/3,e+2/3),t(i+1,e+1,i+2/3,e+2/3),t(i,e+1,i+2/3,e+2/3))}Nn._ComputeSides(t,p,f,m,g,e.frontUVs,e.backUVs);const S=new Nn;return S.indices=f,S.positions=p,S.normals=m,S.uvs=g,S}function Iu(e,t={},i=null){const s=new jn(e,i);return t.sideOrientation=jn._GetDefaultSideOrientation(t.sideOrientation),s._originalBuilderSideOrientation=t.sideOrientation,Ru(t).applyToMesh(s,t.updatable),s}var Pu,Mu,Ou;Au.DEFAULT_OBJECT_SIZE=new me(1,1,1),Au.IDENTITY_QUATERNION=ve.Identity(),Au._TmpVecs=le.BuildArray(3,me.Zero),Au._TmpQuat=ve.Identity(),Au.NoImpostor=0,Au.SphereImpostor=1,Au.BoxImpostor=2,Au.PlaneImpostor=3,Au.MeshImpostor=4,Au.CapsuleImpostor=6,Au.CylinderImpostor=7,Au.ParticleImpostor=8,Au.HeightmapImpostor=9,Au.ConvexHullImpostor=10,Au.CustomImpostor=100,Au.RopeImpostor=101,Au.ClothImpostor=102,Au.SoftbodyImpostor=103,Nn.CreateIcoSphere=Ru,jn.CreateIcoSphere=(e,t,i)=>Iu(e,t,i),function(e){e.WRIST="wrist",e.THUMB="thumb",e.INDEX="index",e.MIDDLE="middle",e.RING="ring",e.LITTLE="little"}(Pu||(Pu={})),(Ou=Mu||(Mu={})).WRIST="wrist",Ou.THUMB_METACARPAL="thumb-metacarpal",Ou.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",Ou.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",Ou.THUMB_TIP="thumb-tip",Ou.INDEX_FINGER_METACARPAL="index-finger-metacarpal",Ou.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",Ou.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",Ou.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",Ou.INDEX_FINGER_TIP="index-finger-tip",Ou.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",Ou.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",Ou.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",Ou.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",Ou.MIDDLE_FINGER_TIP="middle-finger-tip",Ou.RING_FINGER_METACARPAL="ring-finger-metacarpal",Ou.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",Ou.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",Ou.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",Ou.RING_FINGER_TIP="ring-finger-tip",Ou.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",Ou.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",Ou.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",Ou.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",Ou.PINKY_FINGER_TIP="pinky-finger-tip";const Du=[Mu.WRIST,Mu.THUMB_METACARPAL,Mu.THUMB_PHALANX_PROXIMAL,Mu.THUMB_PHALANX_DISTAL,Mu.THUMB_TIP,Mu.INDEX_FINGER_METACARPAL,Mu.INDEX_FINGER_PHALANX_PROXIMAL,Mu.INDEX_FINGER_PHALANX_INTERMEDIATE,Mu.INDEX_FINGER_PHALANX_DISTAL,Mu.INDEX_FINGER_TIP,Mu.MIDDLE_FINGER_METACARPAL,Mu.MIDDLE_FINGER_PHALANX_PROXIMAL,Mu.MIDDLE_FINGER_PHALANX_INTERMEDIATE,Mu.MIDDLE_FINGER_PHALANX_DISTAL,Mu.MIDDLE_FINGER_TIP,Mu.RING_FINGER_METACARPAL,Mu.RING_FINGER_PHALANX_PROXIMAL,Mu.RING_FINGER_PHALANX_INTERMEDIATE,Mu.RING_FINGER_PHALANX_DISTAL,Mu.RING_FINGER_TIP,Mu.PINKY_FINGER_METACARPAL,Mu.PINKY_FINGER_PHALANX_PROXIMAL,Mu.PINKY_FINGER_PHALANX_INTERMEDIATE,Mu.PINKY_FINGER_PHALANX_DISTAL,Mu.PINKY_FINGER_TIP],Nu={[Pu.WRIST]:[Mu.WRIST],[Pu.THUMB]:[Mu.THUMB_METACARPAL,Mu.THUMB_PHALANX_PROXIMAL,Mu.THUMB_PHALANX_DISTAL,Mu.THUMB_TIP],[Pu.INDEX]:[Mu.INDEX_FINGER_METACARPAL,Mu.INDEX_FINGER_PHALANX_PROXIMAL,Mu.INDEX_FINGER_PHALANX_INTERMEDIATE,Mu.INDEX_FINGER_PHALANX_DISTAL,Mu.INDEX_FINGER_TIP],[Pu.MIDDLE]:[Mu.MIDDLE_FINGER_METACARPAL,Mu.MIDDLE_FINGER_PHALANX_PROXIMAL,Mu.MIDDLE_FINGER_PHALANX_INTERMEDIATE,Mu.MIDDLE_FINGER_PHALANX_DISTAL,Mu.MIDDLE_FINGER_TIP],[Pu.RING]:[Mu.RING_FINGER_METACARPAL,Mu.RING_FINGER_PHALANX_PROXIMAL,Mu.RING_FINGER_PHALANX_INTERMEDIATE,Mu.RING_FINGER_PHALANX_DISTAL,Mu.RING_FINGER_TIP],[Pu.LITTLE]:[Mu.PINKY_FINGER_METACARPAL,Mu.PINKY_FINGER_PHALANX_PROXIMAL,Mu.PINKY_FINGER_PHALANX_INTERMEDIATE,Mu.PINKY_FINGER_PHALANX_DISTAL,Mu.PINKY_FINGER_TIP]};class Fu{get handMesh(){return this._handMesh}getHandPartMeshes(e){return Nu[e].map((e=>this._jointMeshes[Du.indexOf(e)]))}getJointMesh(e){return this._jointMeshes[Du.indexOf(e)]}constructor(e,t,i,s,n=!1,r=!1,o=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=s,this._leftHandedMeshes=n,this._jointsInvisible=r,this._jointScaleFactor=o,this._jointTransforms=new Array(Du.length),this._jointTransformMatrices=new Float32Array(16*Du.length),this._tempJointMatrix=new Te,this._jointRadii=new Float32Array(Du.length),this._scene=t[0].getScene();for(let e=0;e<this._jointTransforms.length;e++)(this._jointTransforms[e]=new Bn(Du[e],this._scene)).rotationQuaternion=new ve,t[e].rotationQuaternion=new ve;i&&this.setHandMesh(i,s),this.xrController.motionController&&(this.xrController.motionController.rootMesh?this.xrController.motionController.rootMesh.setEnabled(!1):this.xrController.motionController.onModelLoadedObservable.add((e=>{e.rootMesh&&e.rootMesh.setEnabled(!1)}))),this.xrController.onMotionControllerInitObservable.add((e=>{e.onModelLoadedObservable.add((e=>{e.rootMesh&&e.rootMesh.setEnabled(!1)})),e.rootMesh&&e.rootMesh.setEnabled(!1)}))}setHandMesh(e,t){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach((e=>e.alwaysSelectAsActiveMesh=!0)),this._handMesh.skeleton){const e=this._handMesh.skeleton;Du.forEach(((i,s)=>{const n=e.getBoneIndexByName(t?t[i]:i);-1!==n&&e.bones[n].linkTransformNode(this._jointTransforms[s])}))}}updateFromXRFrame(e,t){const i=this.xrController.inputSource.hand;if(!i)return;const s=i,n=Du.map((e=>s[e]||i.get(e)));let r=!1;if(e.fillPoses&&e.fillJointRadii)r=e.fillPoses(n,t,this._jointTransformMatrices)&&e.fillJointRadii(n,this._jointRadii);else if(e.getJointPose){r=!0;for(let i=0;i<n.length;i++){const s=e.getJointPose(n[i],t);if(!s){r=!1;break}this._jointTransformMatrices.set(s.transform.matrix,16*i),this._jointRadii[i]=s.radius||.008}}r&&(Du.forEach(((e,t)=>{const i=this._jointTransforms[t];Te.FromArrayToRef(this._jointTransformMatrices,16*t,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,i.rotationQuaternion,i.position);const s=this._jointRadii[t]*this._jointScaleFactor,n=this._jointMeshes[t];n.isVisible=!this._handMesh&&!this._jointsInvisible,n.position.copyFrom(i.position),n.rotationQuaternion.copyFrom(i.rotationQuaternion),n.scaling.setAll(s),this._scene.useRightHandedSystem||(n.position.z*=-1,n.rotationQuaternion.z*=-1,n.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1))})),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(){this._handMesh&&(this._handMesh.isVisible=!1)}}class Lu extends ya{static _GenerateTrackedJointMeshes(e){const t={};return["left","right"].map((i=>{var s,n,r,o,a;const l=[],h=(null===(s=e.jointMeshes)||void 0===s?void 0:s.sourceMesh)||Iu("jointParent",Lu._ICOSPHERE_PARAMS);h.isVisible=!!(null===(n=e.jointMeshes)||void 0===n?void 0:n.keepOriginalVisible);for(let t=0;t<Du.length;++t){let s=h.createInstance(`${i}-handJoint-${t}`);if(null===(r=e.jointMeshes)||void 0===r?void 0:r.onHandJointMeshGenerated){const n=e.jointMeshes.onHandJointMeshGenerated(s,t,i);n&&n!==s&&(s.dispose(),s=n)}if(s.isPickable=!1,null===(o=e.jointMeshes)||void 0===o?void 0:o.enablePhysics){const t=(null===(a=e.jointMeshes)||void 0===a?void 0:a.physicsProps)||{};s.scaling.setAll(.02);const i=void 0!==t.impostorType?t.impostorType:Au.SphereImpostor;s.physicsImpostor=new Au(s,i,Object.assign({mass:0},t))}s.rotationQuaternion=new ve,s.isVisible=!1,l.push(s)}t[i]=l})),{left:t.left,right:t.right}}static _GenerateDefaultHandMeshesAsync(e,t){return new Promise((async i=>{var s,n,r,o,a;const l={};(null===(n=null===(s=Lu._RightHandGLB)||void 0===s?void 0:s.meshes[1])||void 0===n?void 0:n.isDisposed())&&(Lu._RightHandGLB=null),(null===(o=null===(r=Lu._LeftHandGLB)||void 0===r?void 0:r.meshes[1])||void 0===o?void 0:o.isDisposed())&&(Lu._LeftHandGLB=null);const h=!(!Lu._RightHandGLB||!Lu._LeftHandGLB),c=await Promise.all([Lu._RightHandGLB||da.ImportMeshAsync("",Lu.DEFAULT_HAND_MODEL_BASE_URL,Lu.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),Lu._LeftHandGLB||da.ImportMeshAsync("",Lu.DEFAULT_HAND_MODEL_BASE_URL,Lu.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);Lu._RightHandGLB=c[0],Lu._LeftHandGLB=c[1];const d=new vl("handShader",e,{emitComments:!1});await d.loadAsync(Lu.DEFAULT_HAND_MODEL_SHADER_URL),d.needDepthPrePass=!0,d.transparencyMode=Ps.MATERIAL_ALPHABLEND,d.alphaMode=2,d.build(!1);const u=Object.assign({base:Re.FromInts(116,63,203),fresnel:Re.FromInts(149,102,229),fingerColor:Re.FromInts(177,130,255),tipFresnel:Re.FromInts(220,200,255)},null===(a=null==t?void 0:t.handMeshes)||void 0===a?void 0:a.customColors),_={base:d.getBlockByName("baseColor"),fresnel:d.getBlockByName("fresnelColor"),fingerColor:d.getBlockByName("fingerColor"),tipFresnel:d.getBlockByName("tipFresnelColor")};_.base.value=u.base,_.fresnel.value=u.fresnel,_.fingerColor.value=u.fingerColor,_.tipFresnel.value=u.tipFresnel,["left","right"].forEach((t=>{const i="left"==t?Lu._LeftHandGLB:Lu._RightHandGLB;if(!i)throw new Error("Could not load hand model");const s=i.meshes[1];s._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,s.material=d.clone(`${t}HandShaderClone`,!0),s.isVisible=!1,l[t]=s,h||e.useRightHandedSystem||i.meshes[1].rotate(nn.Y,Math.PI)})),d.dispose(),i({left:l.left,right:l.right})}))}static _GenerateDefaultHandMeshRigMapping(e){const t="right"==e?"R":"L";return{[Mu.WRIST]:`wrist_${t}`,[Mu.THUMB_METACARPAL]:`thumb_metacarpal_${t}`,[Mu.THUMB_PHALANX_PROXIMAL]:`thumb_proxPhalanx_${t}`,[Mu.THUMB_PHALANX_DISTAL]:`thumb_distPhalanx_${t}`,[Mu.THUMB_TIP]:`thumb_tip_${t}`,[Mu.INDEX_FINGER_METACARPAL]:`index_metacarpal_${t}`,[Mu.INDEX_FINGER_PHALANX_PROXIMAL]:`index_proxPhalanx_${t}`,[Mu.INDEX_FINGER_PHALANX_INTERMEDIATE]:`index_intPhalanx_${t}`,[Mu.INDEX_FINGER_PHALANX_DISTAL]:`index_distPhalanx_${t}`,[Mu.INDEX_FINGER_TIP]:`index_tip_${t}`,[Mu.MIDDLE_FINGER_METACARPAL]:`middle_metacarpal_${t}`,[Mu.MIDDLE_FINGER_PHALANX_PROXIMAL]:`middle_proxPhalanx_${t}`,[Mu.MIDDLE_FINGER_PHALANX_INTERMEDIATE]:`middle_intPhalanx_${t}`,[Mu.MIDDLE_FINGER_PHALANX_DISTAL]:`middle_distPhalanx_${t}`,[Mu.MIDDLE_FINGER_TIP]:`middle_tip_${t}`,[Mu.RING_FINGER_METACARPAL]:`ring_metacarpal_${t}`,[Mu.RING_FINGER_PHALANX_PROXIMAL]:`ring_proxPhalanx_${t}`,[Mu.RING_FINGER_PHALANX_INTERMEDIATE]:`ring_intPhalanx_${t}`,[Mu.RING_FINGER_PHALANX_DISTAL]:`ring_distPhalanx_${t}`,[Mu.RING_FINGER_TIP]:`ring_tip_${t}`,[Mu.PINKY_FINGER_METACARPAL]:`little_metacarpal_${t}`,[Mu.PINKY_FINGER_PHALANX_PROXIMAL]:`little_proxPhalanx_${t}`,[Mu.PINKY_FINGER_PHALANX_INTERMEDIATE]:`little_intPhalanx_${t}`,[Mu.PINKY_FINGER_PHALANX_DISTAL]:`little_distPhalanx_${t}`,[Mu.PINKY_FINGER_TIP]:`little_tip_${t}`}}isCompatible(){return"undefined"!=typeof XRHand}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return"none"==e?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this.onHandAddedObservable=new s,this.onHandRemovedObservable=new s,this._attachHand=e=>{var t,i,s;if(!e.inputSource.hand||"none"==e.inputSource.handedness||!this._handResources.jointMeshes)return;const n=e.inputSource.handedness,r=new Fu(e,this._handResources.jointMeshes[n],this._handResources.handMeshes&&this._handResources.handMeshes[n],this._handResources.rigMappings&&this._handResources.rigMappings[n],null===(t=this.options.handMeshes)||void 0===t?void 0:t.meshesUseLeftHandedCoordinates,null===(i=this.options.jointMeshes)||void 0===i?void 0:i.invisible,null===(s=this.options.jointMeshes)||void 0===s?void 0:s.scaleFactor);this._attachedHands[e.uniqueId]=r,this._trackingHands[n]=r,this.onHandAddedObservable.notifyObservers(r)},this._detachHand=e=>{this._detachHandById(e.uniqueId)},this.xrNativeFeatureName="hand-tracking";const i=t.jointMeshes;if(i&&(void 0!==i.disableDefaultHandMesh&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=i.disableDefaultHandMesh),void 0!==i.handMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=i.handMeshes),void 0!==i.leftHandedSystemMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=i.leftHandedSystemMeshes),void 0!==i.rigMapping)){t.handMeshes=t.handMeshes||{};const e={},s={};[[i.rigMapping.left,e],[i.rigMapping.right,s]].forEach((e=>{const t=e[0],i=e[1];t.forEach(((e,t)=>{i[Du[t]]=e}))})),t.handMeshes.customRigMappings={left:e,right:s}}}attach(){var e,t,i,s;return!!super.attach()&&(this._handResources={jointMeshes:Lu._GenerateTrackedJointMeshes(this.options),handMeshes:(null===(e=this.options.handMeshes)||void 0===e?void 0:e.customMeshes)||null,rigMappings:(null===(t=this.options.handMeshes)||void 0===t?void 0:t.customRigMappings)||null},(null===(i=this.options.handMeshes)||void 0===i?void 0:i.customMeshes)||(null===(s=this.options.handMeshes)||void 0===s?void 0:s.disableDefaultMeshes)||Lu._GenerateDefaultHandMeshesAsync(u.LastCreatedScene,this.options).then((e=>{var t,i;this._handResources.handMeshes=e,this._handResources.rigMappings={left:Lu._GenerateDefaultHandMeshRigMapping("left"),right:Lu._GenerateDefaultHandMeshRigMapping("right")},null===(t=this._trackingHands.left)||void 0===t||t.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left),null===(i=this._trackingHands.right)||void 0===i||i.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right)})),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0)}_onXRFrame(e){var t,i;null===(t=this._trackingHands.left)||void 0===t||t.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),null===(i=this._trackingHands.right)||void 0===i||i.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e){var t;const i=this.getHandByControllerId(e);if(i){const s="left"==i.xrController.inputSource.handedness?"left":"right";(null===(t=this._trackingHands[s])||void 0===t?void 0:t.xrController.uniqueId)===e&&(this._trackingHands[s]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(),delete this._attachedHands[e]}}detach(){return!!super.detach()&&(Object.keys(this._attachedHands).forEach((e=>this._detachHandById(e))),!0)}dispose(){var e;super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!(null===(e=this.options.handMeshes)||void 0===e?void 0:e.customMeshes)&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),Lu._RightHandGLB=null,Lu._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach((e=>e.dispose())),this._handResources.jointMeshes.right.forEach((e=>e.dispose())))}}var wu,Bu,Uu;Lu.Name=ra.HAND_TRACKING,Lu.Version=1,Lu.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/",Lu.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb",Lu.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb",Lu.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json",Lu._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2},Lu._RightHandGLB=null,Lu._LeftHandGLB=null,oa.AddWebXRFeature(Lu.Name,((e,t)=>()=>new Lu(e,t)),Lu.Version,!1),function(e){e[e.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",e[e.RADIAL_SIDE=1]="RADIAL_SIDE",e[e.ULNAR_SIDE=2]="ULNAR_SIDE",e[e.BELOW_WRIST=3]="BELOW_WRIST"}(wu||(wu={})),function(e){e[e.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",e[e.HAND_ROTATION=1]="HAND_ROTATION"}(Bu||(Bu={})),function(e){e[e.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",e[e.PALM_UP=1]="PALM_UP",e[e.GAZE_FOCUS=2]="GAZE_FOCUS",e[e.PALM_AND_GAZE=3]="PALM_AND_GAZE"}(Uu||(Uu={}));F.ShadersStore.fluentBackplatePixelShader="uniform vec3 cameraPosition;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;uniform float _Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Filter_Width_;uniform vec4 _Base_Color_;uniform vec4 _Line_Color_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform float _Rate_;uniform vec4 _Highlight_Color_;uniform float _Highlight_Width_;uniform vec4 _Highlight_Transform_;uniform float _Highlight_;uniform float _Iridescence_Intensity_;uniform float _Iridescence_Edge_Intensity_;uniform float _Angle_;uniform float _Fade_Out_;uniform bool _Reflected_;uniform float _Frequency_;uniform float _Vertical_Offset_;uniform sampler2D _Iridescent_Map_;uniform bool _Use_Global_Left_Index_;uniform bool _Use_Global_Right_Index_;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;void Round_Rect_Fragment_B31(\nfloat Radius,\nfloat Line_Width,\nvec4 Line_Color,\nfloat Filter_Width,\nvec2 UV,\nfloat Line_Visibility,\nvec4 Rect_Parms,\nvec4 Fill_Color,\nout vec4 Color)\n{float d=length(max(abs(UV)-Rect_Parms.xy,0.0));float dx=max(fwidth(d)*Filter_Width,0.00001);float g=min(Rect_Parms.z,Rect_Parms.w);float dgrad=max(fwidth(g)*Filter_Width,0.00001);float Inside_Rect=clamp(g/dgrad,0.0,1.0);float inner=clamp((d+dx*0.5-max(Radius-Line_Width,d-dx*0.5))/dx,0.0,1.0);Color=clamp(mix(Fill_Color,Line_Color,inner),0.0,1.0)*Inside_Rect;}\nvoid Blob_Fragment_B71(\nsampler2D Blob_Texture,\nvec4 Blob_Info1,\nvec4 Blob_Info2,\nout vec4 Blob_Color)\n{float k1=dot(Blob_Info1.xy,Blob_Info1.xy);float k2=dot(Blob_Info2.xy,Blob_Info2.xy);vec3 closer=k1<k2 ? vec3(k1,Blob_Info1.z,Blob_Info1.w) : vec3(k2,Blob_Info2.z,Blob_Info2.w);Blob_Color=closer.z*texture(Blob_Texture,vec2(vec2(sqrt(closer.x),closer.y).x,1.0-vec2(sqrt(closer.x),closer.y).y))*clamp(1.0-closer.x,0.0,1.0);}\nvoid Line_Fragment_B48(\nvec4 Base_Color,\nvec4 Highlight_Color,\nfloat Highlight_Width,\nvec3 Line_Vertex,\nfloat Highlight,\nout vec4 Line_Color)\n{float k2=1.0-clamp(abs(Line_Vertex.y/Highlight_Width),0.0,1.0);Line_Color=mix(Base_Color,Highlight_Color,Highlight*k2);}\nvoid Scale_RGB_B54(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Conditional_Float_B38(\nbool Which,\nfloat If_True,\nfloat If_False,\nout float Result)\n{Result=Which ? If_True : If_False;}\nvoid main()\n{float R_Q72;float G_Q72;float B_Q72;float A_Q72;R_Q72=vColor.r; G_Q72=vColor.g; B_Q72=vColor.b; A_Q72=vColor.a;vec4 Blob_Color_Q71;\n#if BLOB_ENABLE\nfloat k1=dot(vExtra2.xy,vExtra2.xy);float k2=dot(vExtra3.xy,vExtra3.xy);vec3 closer=k1<k2 ? vec3(k1,vExtra2.z,vExtra2.w) : vec3(k2,vExtra3.z,vExtra3.w);Blob_Color_Q71=closer.z*texture(_Blob_Texture_,vec2(vec2(sqrt(closer.x),closer.y).x,1.0-vec2(sqrt(closer.x),closer.y).y))*clamp(1.0-closer.x,0.0,1.0);\n#else\nBlob_Color_Q71=vec4(0,0,0,0);\n#endif\nvec4 Line_Color_Q48;Line_Fragment_B48(_Line_Color_,_Highlight_Color_,_Highlight_Width_,vTangent,_Highlight_,Line_Color_Q48);float X_Q67;float Y_Q67;X_Q67=vUV.x;Y_Q67=vUV.y;vec3 Incident_Q66=normalize(vPosition-cameraPosition);vec3 Reflected_Q60=reflect(Incident_Q66,vBinormal);float Product_Q63=Y_Q67*_Vertical_Offset_;float Dot_Q68=dot(Incident_Q66, Reflected_Q60);float Dot_Q57=dot(vNormal, Incident_Q66);float Result_Q38;Conditional_Float_B38(_Reflected_,Dot_Q68,Dot_Q57,Result_Q38);float Product_Q64=Result_Q38*_Frequency_;float Sum_Q69=Product_Q64+1.0;float Product_Q70=Sum_Q69*0.5;float Sum_Q62=Product_Q63+Product_Q70;float FractF_Q59=fract(Sum_Q62);vec2 Vec2_Q65=vec2(FractF_Q59,0.5);vec4 Color_Q58;\n#if IRIDESCENT_MAP_ENABLE\nColor_Q58=texture(_Iridescent_Map_,Vec2_Q65);\n#else\nColor_Q58=vec4(0,0,0,0);\n#endif\nvec4 Result_Q54;Scale_RGB_B54(Color_Q58,_Iridescence_Edge_Intensity_,Result_Q54);vec4 Result_Q55;Scale_RGB_B54(Color_Q58,_Iridescence_Intensity_,Result_Q55);vec4 Base_And_Iridescent_Q53;Base_And_Iridescent_Q53=Line_Color_Q48+vec4(Result_Q54.rgb,0.0);vec4 Base_And_Iridescent_Q56;Base_And_Iridescent_Q56=_Base_Color_+vec4(Result_Q55.rgb,0.0);vec4 Result_Q52=Base_And_Iridescent_Q53; Result_Q52.a=1.0;vec4 Result_Q35=Blob_Color_Q71+(1.0-Blob_Color_Q71.a)*Base_And_Iridescent_Q56;vec4 Color_Q31;Round_Rect_Fragment_B31(R_Q72,G_Q72,Result_Q52,_Filter_Width_,vUV,1.0,vExtra1,Result_Q35,Color_Q31);vec4 Result_Q47=_Fade_Out_*Color_Q31;vec4 Out_Color=Result_Q47;float Clip_Threshold=0.001;bool To_sRGB=false;gl_FragColor=Out_Color;}";F.ShadersStore.fluentBackplateVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;\n#ifdef TANGENT\nattribute vec3 tangent;\n#else\nconst vec3 tangent=vec3(0.);\n#endif\nuniform float _Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Filter_Width_;uniform vec4 _Base_Color_;uniform vec4 _Line_Color_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform float _Rate_;uniform vec4 _Highlight_Color_;uniform float _Highlight_Width_;uniform vec4 _Highlight_Transform_;uniform float _Highlight_;uniform float _Iridescence_Intensity_;uniform float _Iridescence_Edge_Intensity_;uniform float _Angle_;uniform float _Fade_Out_;uniform bool _Reflected_;uniform float _Frequency_;uniform float _Vertical_Offset_;uniform sampler2D _Iridescent_Map_;uniform bool _Use_Global_Left_Index_;uniform bool _Use_Global_Right_Index_;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;void Object_To_World_Pos_B115(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid PickDir_B140(\nfloat Degrees,\nvec3 DirX,\nvec3 DirY,\nout vec3 Dir)\n{float a=Degrees*3.14159/180.0;Dir=cos(a)*DirX+sin(a)*DirY;}\nvoid Round_Rect_Vertex_B139(\nvec2 UV,\nfloat Radius,\nfloat Margin,\nfloat Anisotropy,\nfloat Gradient1,\nfloat Gradient2,\nout vec2 Rect_UV,\nout vec4 Rect_Parms,\nout vec2 Scale_XY,\nout vec2 Line_UV)\n{Scale_XY=vec2(Anisotropy,1.0);Line_UV=(UV-vec2(0.5,0.5));Rect_UV=Line_UV*Scale_XY;Rect_Parms.xy=Scale_XY*0.5-vec2(Radius,Radius)-vec2(Margin,Margin);Rect_Parms.z=Gradient1; \nRect_Parms.w=Gradient2;}\nvoid Line_Vertex_B135(\nvec2 Scale_XY,\nvec2 UV,\nfloat Time,\nfloat Rate,\nvec4 Highlight_Transform,\nout vec3 Line_Vertex)\n{float angle2=(Rate*Time)*2.0*3.1416;float sinAngle2=sin(angle2);float cosAngle2=cos(angle2);vec2 xformUV=UV*Highlight_Transform.xy+Highlight_Transform.zw;Line_Vertex.x=0.0;Line_Vertex.y=cosAngle2*xformUV.x-sinAngle2*xformUV.y;Line_Vertex.z=0.0; }\nvoid Blob_Vertex_B180(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nfloat Blob_Fade_Length,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nout vec4 Blob_Info)\n{vec3 blob=Blob_Position;vec3 delta=blob-Position;float dist=dot(Normal,delta);float lerpValue=clamp((abs(dist)-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);float fadeValue=1.0-clamp((abs(dist)-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float size=Blob_Near_Size+(Blob_Far_Size-Blob_Near_Size)*lerpValue;vec2 blobXY=vec2(dot(delta,Tangent),dot(delta,Bitangent))/(0.0001+size);float Fade=fadeValue*Intensity*Blob_Fade;float Distance=(lerpValue*0.5+0.5)*(1.0-Blob_Pulse);Blob_Info=vec4(blobXY.x,blobXY.y,Distance,Fade);}\nvoid Move_Verts_B129(\nfloat Anisotropy,\nvec3 P,\nfloat Radius,\nout vec3 New_P,\nout vec2 New_UV,\nout float Radial_Gradient,\nout vec3 Radial_Dir)\n{vec2 UV=P.xy*2.0+0.5;vec2 center=clamp(UV,0.0,1.0);vec2 delta=UV-center;vec2 r2=2.0*vec2(Radius/Anisotropy,Radius);New_UV=center+r2*(UV-2.0*center+0.5);New_P=vec3(New_UV-0.5,P.z);Radial_Gradient=1.0-length(delta)*2.0;Radial_Dir=vec3(delta*r2,0.0);}\nvoid Object_To_World_Dir_B132(\nvec3 Dir_Object,\nout vec3 Binormal_World,\nout vec3 Binormal_World_N,\nout float Binormal_Length)\n{Binormal_World=(world*vec4(Dir_Object,0.0)).xyz;Binormal_Length=length(Binormal_World);Binormal_World_N=Binormal_World/Binormal_Length;}\nvoid RelativeOrAbsoluteDetail_B147(\nfloat Nominal_Radius,\nfloat Nominal_LineWidth,\nbool Absolute_Measurements,\nfloat Height,\nout float Radius,\nout float Line_Width)\n{float scale=Absolute_Measurements ? 1.0/Height : 1.0;Radius=Nominal_Radius*scale;Line_Width=Nominal_LineWidth*scale;}\nvoid Edge_AA_Vertex_B130(\nvec3 Position_World,\nvec3 Position_Object,\nvec3 Normal_Object,\nvec3 Eye,\nfloat Radial_Gradient,\nvec3 Radial_Dir,\nvec3 Tangent,\nout float Gradient1,\nout float Gradient2)\n{vec3 I=(Eye-Position_World);vec3 T=(world* vec4(Tangent,0.0)).xyz;float g=(dot(T,I)<0.0) ? 0.0 : 1.0;if (Normal_Object.z==0.0) { \nGradient1=Position_Object.z>0.0 ? g : 1.0;Gradient2=Position_Object.z>0.0 ? 1.0 : g;} else {Gradient1=g+(1.0-g)*(Radial_Gradient);Gradient2=1.0;}}\nvoid Pick_Radius_B144(\nfloat Radius,\nfloat Radius_Top_Left,\nfloat Radius_Top_Right,\nfloat Radius_Bottom_Left,\nfloat Radius_Bottom_Right,\nvec3 Position,\nout float Result)\n{bool whichY=Position.y>0.0;Result=Position.x<0.0 ? (whichY ? Radius_Top_Left : Radius_Bottom_Left) : (whichY ? Radius_Top_Right : Radius_Bottom_Right);Result*=Radius;}\nvoid main()\n{vec3 Nrm_World_Q128;Nrm_World_Q128=normalize((world*vec4(normal,0.0)).xyz);vec3 Tangent_World_Q131;vec3 Tangent_World_N_Q131;float Tangent_Length_Q131;Tangent_World_Q131=(world*vec4(vec3(1,0,0),0.0)).xyz;Tangent_Length_Q131=length(Tangent_World_Q131);Tangent_World_N_Q131=Tangent_World_Q131/Tangent_Length_Q131;vec3 Binormal_World_Q132;vec3 Binormal_World_N_Q132;float Binormal_Length_Q132;Object_To_World_Dir_B132(vec3(0,1,0),Binormal_World_Q132,Binormal_World_N_Q132,Binormal_Length_Q132);float Anisotropy_Q133=Tangent_Length_Q131/Binormal_Length_Q132;vec3 Result_Q177;Result_Q177=mix(_Blob_Position_,Global_Left_Index_Tip_Position.xyz,float(_Use_Global_Left_Index_));vec3 Result_Q178;Result_Q178=mix(_Blob_Position_2_,Global_Right_Index_Tip_Position.xyz,float(_Use_Global_Right_Index_));float Result_Q144;Pick_Radius_B144(_Radius_,_Radius_Top_Left_,_Radius_Top_Right_,_Radius_Bottom_Left_,_Radius_Bottom_Right_,position,Result_Q144);vec3 Dir_Q140;PickDir_B140(_Angle_,Tangent_World_N_Q131,Binormal_World_N_Q132,Dir_Q140);float Radius_Q147;float Line_Width_Q147;RelativeOrAbsoluteDetail_B147(Result_Q144,_Line_Width_,_Absolute_Sizes_,Binormal_Length_Q132,Radius_Q147,Line_Width_Q147);vec4 Out_Color_Q145=vec4(Radius_Q147,Line_Width_Q147,0,1);vec3 New_P_Q129;vec2 New_UV_Q129;float Radial_Gradient_Q129;vec3 Radial_Dir_Q129;Move_Verts_B129(Anisotropy_Q133,position,Radius_Q147,New_P_Q129,New_UV_Q129,Radial_Gradient_Q129,Radial_Dir_Q129);vec3 Pos_World_Q115;Object_To_World_Pos_B115(New_P_Q129,Pos_World_Q115);vec4 Blob_Info_Q180;\n#if BLOB_ENABLE\nBlob_Vertex_B180(Pos_World_Q115,Nrm_World_Q128,Tangent_World_N_Q131,Binormal_World_N_Q132,Result_Q177,_Blob_Intensity_,_Blob_Near_Size_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_,_Blob_Fade_,Blob_Info_Q180);\n#else\nBlob_Info_Q180=vec4(0,0,0,0);\n#endif\nvec4 Blob_Info_Q181;\n#if BLOB_ENABLE_2\nBlob_Vertex_B180(Pos_World_Q115,Nrm_World_Q128,Tangent_World_N_Q131,Binormal_World_N_Q132,Result_Q178,_Blob_Intensity_,_Blob_Near_Size_2_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_2_,_Blob_Fade_2_,Blob_Info_Q181);\n#else\nBlob_Info_Q181=vec4(0,0,0,0);\n#endif\nfloat Gradient1_Q130;float Gradient2_Q130;\n#if SMOOTH_EDGES\nEdge_AA_Vertex_B130(Pos_World_Q115,position,normal,cameraPosition,Radial_Gradient_Q129,Radial_Dir_Q129,tangent,Gradient1_Q130,Gradient2_Q130);\n#else\nGradient1_Q130=1.0;Gradient2_Q130=1.0;\n#endif\nvec2 Rect_UV_Q139;vec4 Rect_Parms_Q139;vec2 Scale_XY_Q139;vec2 Line_UV_Q139;Round_Rect_Vertex_B139(New_UV_Q129,Radius_Q147,0.0,Anisotropy_Q133,Gradient1_Q130,Gradient2_Q130,Rect_UV_Q139,Rect_Parms_Q139,Scale_XY_Q139,Line_UV_Q139);vec3 Line_Vertex_Q135;Line_Vertex_B135(Scale_XY_Q139,Line_UV_Q139,0.0,_Rate_,_Highlight_Transform_,Line_Vertex_Q135);vec3 Position=Pos_World_Q115;vec3 Normal=Dir_Q140;vec2 UV=Rect_UV_Q139;vec3 Tangent=Line_Vertex_Q135;vec3 Binormal=Nrm_World_Q128;vec4 Color=Out_Color_Q145;vec4 Extra1=Rect_Parms_Q139;vec4 Extra2=Blob_Info_Q180;vec4 Extra3=Blob_Info_Q181;gl_Position=viewProjection*vec4(Position,1);vPosition=Position;vNormal=Normal;vUV=UV;vTangent=Tangent;vBinormal=Binormal;vColor=Color;vExtra1=Extra1;vExtra2=Extra2;vExtra3=Extra3;}";class ku extends Wt{constructor(){super(),this.BLOB_ENABLE=!0,this.BLOB_ENABLE_2=!0,this.SMOOTH_EDGES=!0,this.IRIDESCENT_MAP_ENABLE=!0,this._needNormals=!0,this.rebuild()}}class Vu extends Ms{constructor(e,t){super(e,t),this.radius=.03,this.lineWidth=.01,this.absoluteSizes=!1,this._filterWidth=1,this.baseColor=new Ie(.0392157,.0666667,.207843,1),this.lineColor=new Ie(.14902,.133333,.384314,1),this.blobIntensity=.98,this.blobFarSize=.04,this.blobNearDistance=0,this.blobFarDistance=.08,this.blobFadeLength=.08,this.blobNearSize=.22,this.blobPulse=0,this.blobFade=0,this.blobNearSize2=.22,this.blobPulse2=0,this.blobFade2=0,this._rate=.135,this.highlightColor=new Ie(.98,.98,.98,1),this.highlightWidth=.25,this._highlightTransform=new ge(1,1,0,0),this._highlight=1,this.iridescenceIntensity=0,this.iridescenceEdgeIntensity=1,this._angle=-45,this.fadeOut=1,this._reflected=!0,this._frequency=1,this._verticalOffset=0,this.globalLeftIndexTipPosition=me.Zero(),this._globalLeftIndexTipPosition4=ge.Zero(),this.globalRightIndexTipPosition=me.Zero(),this._globalRightIndexTipPosition4=ge.Zero(),this.alphaMode=Dh.ALPHA_DISABLE,this.backFaceCulling=!1,this._blobTexture=new zi(Vu.BLOB_TEXTURE_URL,this.getScene(),!0,!1,zi.NEAREST_SAMPLINGMODE),this._iridescentMap=new zi(Vu.IM_TEXTURE_URL,this.getScene(),!0,!1,zi.NEAREST_SAMPLINGMODE)}needAlphaBlending(){return!1}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new ku);const i=t.materialDefines,s=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(wi.PrepareDefinesForAttributes(e,i,!1,!1),i.isDirty){i.markAsProcessed(),s.resetCachedMaterial();const e=new is;i.FOG&&e.addFallback(1,"FOG"),wi.HandleFallbacksForShadows(i,e),i.IMAGEPROCESSINGPOSTPROCESS=s.imageProcessingConfiguration.applyByPostProcess;const r=[Oe.PositionKind];i.NORMAL&&r.push(Oe.NormalKind),i.UV1&&r.push(Oe.UVKind),i.UV2&&r.push(Oe.UV2Kind),i.VERTEXCOLOR&&r.push(Oe.ColorKind),i.TANGENT&&r.push(Oe.TangentKind),wi.PrepareAttributesForInstances(r,i);const o="fluentBackplate",a=i.toString(),l=["world","viewProjection","cameraPosition","_Radius_","_Line_Width_","_Absolute_Sizes_","_Filter_Width_","_Base_Color_","_Line_Color_","_Radius_Top_Left_","_Radius_Top_Right_","_Radius_Bottom_Left_","_Radius_Bottom_Right_","_Blob_Position_","_Blob_Intensity_","_Blob_Near_Size_","_Blob_Far_Size_","_Blob_Near_Distance_","_Blob_Far_Distance_","_Blob_Fade_Length_","_Blob_Pulse_","_Blob_Fade_","_Blob_Texture_","_Blob_Position_2_","_Blob_Near_Size_2_","_Blob_Pulse_2_","_Blob_Fade_2_","_Rate_","_Highlight_Color_","_Highlight_Width_","_Highlight_Transform_","_Highlight_","_Iridescence_Intensity_","_Iridescence_Edge_Intensity_","_Angle_","_Fade_Out_","_Reflected_","_Frequency_","_Vertical_Offset_","_Iridescent_Map_","_Use_Global_Left_Index_","_Use_Global_Right_Index_","Global_Left_Index_Tip_Position","Global_Right_Index_Tip_Position"],h=["_Blob_Texture_","_Iridescent_Map_"],c=[];wi.PrepareUniformsAndSamplersList({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:i,maxSimultaneousLights:4}),t.setEffect(s.getEngine().createEffect(o,{attributes:r,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:a,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),i,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(i._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){var s,n;if(!i.materialDefines)return;const r=i.effect;r&&(this._activeEffect=r,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",null!==(n=null===(s=this.getScene().activeCamera)||void 0===s?void 0:s.position)&&void 0!==n?n:me.ZeroReadOnly),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Line_Width_",this.lineWidth),this._activeEffect.setFloat("_Absolute_Sizes_",this.absoluteSizes?1:0),this._activeEffect.setFloat("_Filter_Width_",this._filterWidth),this._activeEffect.setDirectColor4("_Base_Color_",this.baseColor),this._activeEffect.setDirectColor4("_Line_Color_",this.lineColor),this._activeEffect.setFloat("_Radius_Top_Left_",1),this._activeEffect.setFloat("_Radius_Top_Right_",1),this._activeEffect.setFloat("_Radius_Bottom_Left_",1),this._activeEffect.setFloat("_Radius_Bottom_Right_",1),this._activeEffect.setFloat("_Blob_Intensity_",this.blobIntensity),this._activeEffect.setFloat("_Blob_Near_Size_",this.blobNearSize),this._activeEffect.setFloat("_Blob_Far_Size_",this.blobFarSize),this._activeEffect.setFloat("_Blob_Near_Distance_",this.blobNearDistance),this._activeEffect.setFloat("_Blob_Far_Distance_",this.blobFarDistance),this._activeEffect.setFloat("_Blob_Fade_Length_",this.blobFadeLength),this._activeEffect.setFloat("_Blob_Pulse_",this.blobPulse),this._activeEffect.setFloat("_Blob_Fade_",this.blobFade),this._activeEffect.setTexture("_Blob_Texture_",this._blobTexture),this._activeEffect.setFloat("_Blob_Near_Size_2_",this.blobNearSize2),this._activeEffect.setFloat("_Blob_Pulse_2_",this.blobPulse2),this._activeEffect.setFloat("_Blob_Fade_2_",this.blobFade2),this._activeEffect.setFloat("_Rate_",this._rate),this._activeEffect.setDirectColor4("_Highlight_Color_",this.highlightColor),this._activeEffect.setFloat("_Highlight_Width_",this.highlightWidth),this._activeEffect.setVector4("_Highlight_Transform_",this._highlightTransform),this._activeEffect.setFloat("_Highlight_",this._highlight),this._activeEffect.setFloat("_Iridescence_Intensity_",this.iridescenceIntensity),this._activeEffect.setFloat("_Iridescence_Edge_Intensity_",this.iridescenceEdgeIntensity),this._activeEffect.setFloat("_Angle_",this._angle),this._activeEffect.setFloat("_Fade_Out_",this.fadeOut),this._activeEffect.setFloat("_Reflected_",this._reflected?1:0),this._activeEffect.setFloat("_Frequency_",this._frequency),this._activeEffect.setFloat("_Vertical_Offset_",this._verticalOffset),this._activeEffect.setTexture("_Iridescent_Map_",this._iridescentMap),this._activeEffect.setFloat("_Use_Global_Left_Index_",1),this._activeEffect.setFloat("_Use_Global_Right_Index_",1),this._globalLeftIndexTipPosition4.set(this.globalLeftIndexTipPosition.x,this.globalLeftIndexTipPosition.y,this.globalLeftIndexTipPosition.z,1),this._activeEffect.setVector4("Global_Left_Index_Tip_Position",this._globalLeftIndexTipPosition4),this._globalRightIndexTipPosition4.set(this.globalRightIndexTipPosition.x,this.globalRightIndexTipPosition.y,this.globalRightIndexTipPosition.z,1),this._activeEffect.setVector4("Global_Right_Index_Tip_Position",this._globalRightIndexTipPosition4),this._afterBind(t,this._activeEffect))}getAnimatables(){return[]}dispose(e){super.dispose(e),this._blobTexture.dispose(),this._iridescentMap.dispose()}clone(e){return qe.Clone((()=>new Vu(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.FluentBackplateMaterial",e}getClassName(){return"FluentBackplateMaterial"}static Parse(e,t,i){return qe.Parse((()=>new Vu(e.name,t)),e,t,i)}}Vu.BLOB_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/mrtk-fluent-backplate-blob.png",Vu.IM_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/mrtk-fluent-backplate-iridescence.png",De([Ge()],Vu.prototype,"radius",void 0),De([Ge()],Vu.prototype,"lineWidth",void 0),De([Ge()],Vu.prototype,"absoluteSizes",void 0),De([Ge()],Vu.prototype,"baseColor",void 0),De([Ge()],Vu.prototype,"lineColor",void 0),De([Ge()],Vu.prototype,"blobIntensity",void 0),De([Ge()],Vu.prototype,"blobFarSize",void 0),De([Ge()],Vu.prototype,"blobNearDistance",void 0),De([Ge()],Vu.prototype,"blobFarDistance",void 0),De([Ge()],Vu.prototype,"blobFadeLength",void 0),De([Ge()],Vu.prototype,"blobNearSize",void 0),De([Ge()],Vu.prototype,"blobPulse",void 0),De([Ge()],Vu.prototype,"blobFade",void 0),De([Ge()],Vu.prototype,"blobNearSize2",void 0),De([Ge()],Vu.prototype,"blobPulse2",void 0),De([Ge()],Vu.prototype,"blobFade2",void 0),De([Ge()],Vu.prototype,"highlightColor",void 0),De([Ge()],Vu.prototype,"highlightWidth",void 0),De([Ge()],Vu.prototype,"iridescenceIntensity",void 0),De([Ge()],Vu.prototype,"iridescenceEdgeIntensity",void 0),De([Ge()],Vu.prototype,"fadeOut",void 0),De([Qe()],Vu.prototype,"globalLeftIndexTipPosition",void 0),De([Qe()],Vu.prototype,"globalRightIndexTipPosition",void 0),ue("BABYLON.GUI.FluentBackplateMaterial",Vu);class Gu extends mu{set renderingGroupId(e){this._model.renderingGroupId=e}get renderingGroupId(){return this._model.renderingGroupId}get material(){return this._material}get shareMaterials(){return this._shareMaterials}constructor(e,t=!0){super(e),this._shareMaterials=t}_getTypeName(){return"HolographicBackplate"}_createNode(e){var t;const i=Fr((null!==(t=this.name)&&void 0!==t?t:"HolographicBackplate")+"_CollisionMesh",{width:1,height:1,depth:1},e);return i.isPickable=!0,i.visibility=0,da.ImportMeshAsync(void 0,Gu.MODEL_BASE_URL,Gu.MODEL_FILENAME,e).then((e=>{const t=e.meshes[1];t.name=`${this.name}_frontPlate`,t.isPickable=!1,t.parent=i,this._material&&(t.material=this._material),this._model=t})),i}_createMaterial(e){this._material=new Vu(this.name+" Material",e.getScene())}_affectMaterial(e){this._shareMaterials?this._host._touchSharedMaterials.fluentBackplateMaterial?this._material=this._host._touchSharedMaterials.fluentBackplateMaterial:(this._createMaterial(e),this._host._touchSharedMaterials.fluentBackplateMaterial=this._material):this._createMaterial(e)}dispose(){super.dispose(),this.shareMaterials||this._material.dispose(),this._model.dispose()}}Gu.MODEL_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",Gu.MODEL_FILENAME="mrtk-fluent-backplate.glb";class zu{get delay(){return this.fadeInDelay}set delay(e){this.fadeInDelay=e,this.fadeOutDelay=e}constructor(){this.fadeInDelay=0,this.fadeOutDelay=0,this.fadeInTime=300,this.fadeOutTime=300,this._millisecondsPerFrame=1e3/60,this._hovered=!1,this._hoverValue=0,this._ownerNode=null,this._delay=0,this._time=300,this._update=()=>{if(this._ownerNode){if(this._hoverValue+=this._hovered?this._millisecondsPerFrame:-this._millisecondsPerFrame,this._setAllVisibility(this._ownerNode,(this._hoverValue-this._delay)/this._time),this._ownerNode.visibility>1){if(this._setAllVisibility(this._ownerNode,1),this._hoverValue>this._time)return this._hoverValue=this._time,void this._detachObserver()}else if(this._ownerNode.visibility<0&&(this._setAllVisibility(this._ownerNode,0),this._hoverValue<0))return this._hoverValue=0,void this._detachObserver();this._attachObserver()}}}get name(){return"FadeInOut"}init(){}attach(e){this._ownerNode=e,this._setAllVisibility(this._ownerNode,0)}detach(){this._ownerNode=null}fadeIn(e=!0){this._delay=e?this.fadeInDelay:this.fadeOutDelay,this._time=e?this.fadeInTime:this.fadeOutTime,this._detachObserver(),this._ownerNode&&(e&&this._ownerNode.visibility>=1||!e&&this._ownerNode.visibility<=0)||(this._hovered=e,this._hovered||(this._delay*=-1),this._ownerNode.visibility>=1?this._hoverValue=this._time:this._ownerNode.visibility<=0&&(this._hoverValue=0),this._update())}fadeOut(){this.fadeIn(!1)}_setAllVisibility(e,t){e.visibility=t,e.getChildMeshes().forEach((e=>{this._setAllVisibility(e,t)}))}_attachObserver(){var e;this._onBeforeRenderObserver||(this._onBeforeRenderObserver=null===(e=this._ownerNode)||void 0===e?void 0:e.getScene().onBeforeRenderObservable.add(this._update))}_detachObserver(){var e;this._onBeforeRenderObserver&&(null===(e=this._ownerNode)||void 0===e||e.getScene().onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=null)}}F.ShadersStore.fluentButtonPixelShader="uniform vec3 cameraPosition;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;uniform float _Edge_Width_;uniform vec4 _Edge_Color_;uniform bool _Relative_Width_;uniform float _Proximity_Max_Intensity_;uniform float _Proximity_Far_Distance_;uniform float _Proximity_Near_Radius_;uniform float _Proximity_Anisotropy_;uniform float _Selection_Fuzz_;uniform float _Selected_;uniform float _Selection_Fade_;uniform float _Selection_Fade_Size_;uniform float _Selected_Distance_;uniform float _Selected_Fade_Length_;uniform bool _Blob_Enable_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Inner_Fade_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform bool _Blob_Enable_2_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Inner_Fade_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Active_Face_Dir_;uniform vec3 _Active_Face_Up_;uniform bool Enable_Fade;uniform float _Fade_Width_;uniform bool _Smooth_Active_Face_;uniform bool _Show_Frame_;uniform bool _Use_Blob_Texture_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;void Holo_Edge_Fragment_B35(\nvec4 Edges,\nfloat Edge_Width,\nout float NotEdge)\n{vec2 c=vec2(min(Edges.r,Edges.g),min(Edges.b,Edges.a));vec2 df=fwidth(c)*Edge_Width;vec2 g=clamp(c/df,0.0,1.0);NotEdge=g.x*g.y;}\nvoid Blob_Fragment_B39(\nvec2 UV,\nvec3 Blob_Info,\nsampler2D Blob_Texture,\nout vec4 Blob_Color)\n{float k=dot(UV,UV);Blob_Color=Blob_Info.y*texture(Blob_Texture,vec2(vec2(sqrt(k),Blob_Info.x).x,1.0-vec2(sqrt(k),Blob_Info.x).y))*(1.0-clamp(k,0.0,1.0));}\nvec2 FilterStep(vec2 Edge,vec2 X)\n{vec2 dX=max(fwidth(X),vec2(0.00001,0.00001));return clamp( (X+dX-max(Edge,X-dX))/(dX*2.0),0.0,1.0);}\nvoid Wireframe_Fragment_B59(\nvec3 Widths,\nvec2 UV,\nfloat Proximity,\nvec4 Edge_Color,\nout vec4 Wireframe)\n{vec2 c=min(UV,vec2(1.0,1.0)-UV);vec2 g=FilterStep(Widths.xy*0.5,c); \nWireframe=(1.0-min(g.x,g.y))*Proximity*Edge_Color;}\nvoid Proximity_B53(\nvec3 Proximity_Center,\nvec3 Proximity_Center_2,\nfloat Proximity_Max_Intensity,\nfloat Proximity_Near_Radius,\nvec3 Position,\nvec3 Show_Selection,\nvec4 Extra1,\nfloat Dist_To_Face,\nfloat Intensity,\nout float Proximity)\n{vec2 delta1=Extra1.xy;vec2 delta2=Extra1.zw;float d2=sqrt(min(dot(delta1,delta1),dot(delta2,delta2))+Dist_To_Face*Dist_To_Face);Proximity=Intensity*Proximity_Max_Intensity*(1.0-clamp(d2/Proximity_Near_Radius,0.0,1.0))*(1.0-Show_Selection.x)+Show_Selection.x;}\nvoid To_XYZ_B46(\nvec3 Vec3,\nout float X,\nout float Y,\nout float Z)\n{X=Vec3.x;Y=Vec3.y;Z=Vec3.z;}\nvoid main()\n{float NotEdge_Q35;\n#if ENABLE_FADE\nHolo_Edge_Fragment_B35(vColor,_Fade_Width_,NotEdge_Q35);\n#else\nNotEdge_Q35=1.0;\n#endif\nvec4 Blob_Color_Q39;float k=dot(vUV,vUV);vec2 blobTextureCoord=vec2(vec2(sqrt(k),vTangent.x).x,1.0-vec2(sqrt(k),vTangent.x).y);vec4 blobColor=mix(vec4(1.0,1.0,1.0,1.0)*step(1.0-vTangent.x,clamp(sqrt(k)+0.1,0.0,1.0)),texture(_Blob_Texture_,blobTextureCoord),float(_Use_Blob_Texture_));Blob_Color_Q39=vTangent.y*blobColor*(1.0-clamp(k,0.0,1.0));float Is_Quad_Q24;Is_Quad_Q24=vNormal.z;vec3 Blob_Position_Q41= mix(_Blob_Position_,Global_Left_Index_Tip_Position.xyz,float(Use_Global_Left_Index));vec3 Blob_Position_Q42= mix(_Blob_Position_2_,Global_Right_Index_Tip_Position.xyz,float(Use_Global_Right_Index));float X_Q46;float Y_Q46;float Z_Q46;To_XYZ_B46(vBinormal,X_Q46,Y_Q46,Z_Q46);float Proximity_Q53;Proximity_B53(Blob_Position_Q41,Blob_Position_Q42,_Proximity_Max_Intensity_,_Proximity_Near_Radius_,vPosition,vBinormal,vExtra1,Y_Q46,Z_Q46,Proximity_Q53);vec4 Wireframe_Q59;Wireframe_Fragment_B59(vNormal,vUV,Proximity_Q53,_Edge_Color_,Wireframe_Q59);vec4 Wire_Or_Blob_Q23=mix(Wireframe_Q59,Blob_Color_Q39,Is_Quad_Q24);vec4 Result_Q22;Result_Q22=mix(Wire_Or_Blob_Q23,vec4(0.3,0.3,0.3,0.3),float(_Show_Frame_));vec4 Final_Color_Q37=NotEdge_Q35*Result_Q22;vec4 Out_Color=Final_Color_Q37;float Clip_Threshold=0.0;bool To_sRGB=false;gl_FragColor=Out_Color;}";F.ShadersStore.fluentButtonVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute vec3 tangent;attribute vec4 color;uniform float _Edge_Width_;uniform vec4 _Edge_Color_;uniform float _Proximity_Max_Intensity_;uniform float _Proximity_Far_Distance_;uniform float _Proximity_Near_Radius_;uniform float _Proximity_Anisotropy_;uniform float _Selection_Fuzz_;uniform float _Selected_;uniform float _Selection_Fade_;uniform float _Selection_Fade_Size_;uniform float _Selected_Distance_;uniform float _Selected_Fade_Length_;uniform bool _Blob_Enable_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Inner_Fade_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform bool _Blob_Enable_2_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Inner_Fade_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Active_Face_Dir_;uniform vec3 _Active_Face_Up_;uniform bool _Enable_Fade_;uniform float _Fade_Width_;uniform bool _Smooth_Active_Face_;uniform bool _Show_Frame_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;void Blob_Vertex_B47(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nvec4 Vx_Color,\nvec2 UV,\nvec3 Face_Center,\nvec2 Face_Size,\nvec2 In_UV,\nfloat Blob_Fade_Length,\nfloat Selection_Fade,\nfloat Selection_Fade_Size,\nfloat Inner_Fade,\nvec3 Active_Face_Center,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nfloat Blob_Enabled,\nout vec3 Out_Position,\nout vec2 Out_UV,\nout vec3 Blob_Info)\n{float blobSize,fadeIn;vec3 Hit_Position;Blob_Info=vec3(0.0,0.0,0.0);float Hit_Distance=dot(Blob_Position-Face_Center,Normal);Hit_Position=Blob_Position-Hit_Distance*Normal;float absD=abs(Hit_Distance);float lerpVal=clamp((absD-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);fadeIn=1.0-clamp((absD-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float innerFade=1.0-clamp(-Hit_Distance/Inner_Fade,0.0,1.0);float farClip=clamp(1.0-step(Blob_Far_Distance+Blob_Fade_Length,absD),0.0,1.0);float size=mix(Blob_Near_Size,Blob_Far_Size,lerpVal)*farClip;blobSize=mix(size,Selection_Fade_Size,Selection_Fade)*innerFade*Blob_Enabled;Blob_Info.x=lerpVal*0.5+0.5;Blob_Info.y=fadeIn*Intensity*(1.0-Selection_Fade)*Blob_Fade;Blob_Info.x*=(1.0-Blob_Pulse);vec3 delta=Hit_Position-Face_Center;vec2 blobCenterXY=vec2(dot(delta,Tangent),dot(delta,Bitangent));vec2 quadUVin=2.0*UV-1.0; \nvec2 blobXY=blobCenterXY+quadUVin*blobSize;vec2 blobClipped=clamp(blobXY,-Face_Size*0.5,Face_Size*0.5);vec2 blobUV=(blobClipped-blobCenterXY)/max(blobSize,0.0001)*2.0;vec3 blobCorner=Face_Center+blobClipped.x*Tangent+blobClipped.y*Bitangent;Out_Position=mix(Position,blobCorner,Vx_Color.rrr);Out_UV=mix(In_UV,blobUV,Vx_Color.rr);}\nvec2 ProjectProximity(\nvec3 blobPosition,\nvec3 position,\nvec3 center,\nvec3 dir,\nvec3 xdir,\nvec3 ydir,\nout float vdistance\n)\n{vec3 delta=blobPosition-position;vec2 xy=vec2(dot(delta,xdir),dot(delta,ydir));vdistance=abs(dot(delta,dir));return xy;}\nvoid Proximity_Vertex_B66(\nvec3 Blob_Position,\nvec3 Blob_Position_2,\nvec3 Active_Face_Center,\nvec3 Active_Face_Dir,\nvec3 Position,\nfloat Proximity_Far_Distance,\nfloat Relative_Scale,\nfloat Proximity_Anisotropy,\nvec3 Up,\nout vec4 Extra1,\nout float Distance_To_Face,\nout float Intensity)\n{vec3 Active_Face_Dir_X=normalize(cross(Active_Face_Dir,Up));vec3 Active_Face_Dir_Y=cross(Active_Face_Dir,Active_Face_Dir_X);float distz1,distz2;Extra1.xy=ProjectProximity(Blob_Position,Position,Active_Face_Center,Active_Face_Dir,Active_Face_Dir_X*Proximity_Anisotropy,Active_Face_Dir_Y,distz1)/Relative_Scale;Extra1.zw=ProjectProximity(Blob_Position_2,Position,Active_Face_Center,Active_Face_Dir,Active_Face_Dir_X*Proximity_Anisotropy,Active_Face_Dir_Y,distz2)/Relative_Scale;Distance_To_Face=dot(Active_Face_Dir,Position-Active_Face_Center);Intensity=1.0-clamp(min(distz1,distz2)/Proximity_Far_Distance,0.0,1.0);}\nvoid Holo_Edge_Vertex_B44(\nvec3 Incident,\nvec3 Normal,\nvec2 UV,\nvec3 Tangent,\nvec3 Bitangent,\nbool Smooth_Active_Face,\nfloat Active,\nout vec4 Holo_Edges)\n{float NdotI=dot(Incident,Normal);vec2 flip=(UV-vec2(0.5,0.5));float udot=dot(Incident,Tangent)*flip.x*NdotI;float uval=1.0-float(udot>0.0);float vdot=-dot(Incident,Bitangent)*flip.y*NdotI;float vval=1.0-float(vdot>0.0);float Smooth_And_Active=step(1.0,float(Smooth_Active_Face && Active>0.0));uval=mix(uval,max(1.0,uval),Smooth_And_Active); \nvval=mix(vval,max(1.0,vval),Smooth_And_Active);Holo_Edges=vec4(1.0,1.0,1.0,1.0)-vec4(uval*UV.x,uval*(1.0-UV.x),vval*UV.y,vval*(1.0-UV.y));}\nvoid Object_To_World_Pos_B13(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid Choose_Blob_B38(\nvec4 Vx_Color,\nvec3 Position1,\nvec3 Position2,\nbool Blob_Enable_1,\nbool Blob_Enable_2,\nfloat Near_Size_1,\nfloat Near_Size_2,\nfloat Blob_Inner_Fade_1,\nfloat Blob_Inner_Fade_2,\nfloat Blob_Pulse_1,\nfloat Blob_Pulse_2,\nfloat Blob_Fade_1,\nfloat Blob_Fade_2,\nout vec3 Position,\nout float Near_Size,\nout float Inner_Fade,\nout float Blob_Enable,\nout float Fade,\nout float Pulse)\n{Position=Position1*(1.0-Vx_Color.g)+Vx_Color.g*Position2;float b1=float(Blob_Enable_1);float b2=float(Blob_Enable_2);Blob_Enable=b1+(b2-b1)*Vx_Color.g;Pulse=Blob_Pulse_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Pulse_2;Fade=Blob_Fade_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Fade_2;Near_Size=Near_Size_1*(1.0-Vx_Color.g)+Vx_Color.g*Near_Size_2;Inner_Fade=Blob_Inner_Fade_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Inner_Fade_2;}\nvoid Wireframe_Vertex_B51(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nfloat Edge_Width,\nvec2 Face_Size,\nout vec3 Wire_Vx_Pos,\nout vec2 UV,\nout vec2 Widths)\n{Widths.xy=Edge_Width/Face_Size;float x=dot(Position,Tangent);float y=dot(Position,Bitangent);float dx=0.5-abs(x);float newx=(0.5-dx*Widths.x*2.0)*sign(x);float dy=0.5-abs(y);float newy=(0.5-dy*Widths.y*2.0)*sign(y);Wire_Vx_Pos=Normal*0.5+newx*Tangent+newy*Bitangent;UV.x=dot(Wire_Vx_Pos,Tangent)+0.5;UV.y=dot(Wire_Vx_Pos,Bitangent)+0.5;}\nvec2 ramp2(vec2 start,vec2 end,vec2 x)\n{return clamp((x-start)/(end-start),vec2(0.0,0.0),vec2(1.0,1.0));}\nfloat computeSelection(\nvec3 blobPosition,\nvec3 normal,\nvec3 tangent,\nvec3 bitangent,\nvec3 faceCenter,\nvec2 faceSize,\nfloat selectionFuzz,\nfloat farDistance,\nfloat fadeLength\n)\n{vec3 delta=blobPosition-faceCenter;float absD=abs(dot(delta,normal));float fadeIn=1.0-clamp((absD-farDistance)/fadeLength,0.0,1.0);vec2 blobCenterXY=vec2(dot(delta,tangent),dot(delta,bitangent));vec2 innerFace=faceSize*(1.0-selectionFuzz)*0.5;vec2 selectPulse=ramp2(-faceSize*0.5,-innerFace,blobCenterXY)-ramp2(innerFace,faceSize*0.5,blobCenterXY);return selectPulse.x*selectPulse.y*fadeIn;}\nvoid Selection_Vertex_B48(\nvec3 Blob_Position,\nvec3 Blob_Position_2,\nvec3 Face_Center,\nvec2 Face_Size,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nfloat Selection_Fuzz,\nfloat Selected,\nfloat Far_Distance,\nfloat Fade_Length,\nvec3 Active_Face_Dir,\nout float Show_Selection)\n{float select1=computeSelection(Blob_Position,Normal,Tangent,Bitangent,Face_Center,Face_Size,Selection_Fuzz,Far_Distance,Fade_Length);float select2=computeSelection(Blob_Position_2,Normal,Tangent,Bitangent,Face_Center,Face_Size,Selection_Fuzz,Far_Distance,Fade_Length);float Active=max(0.0,dot(Active_Face_Dir,Normal));Show_Selection=mix(max(select1,select2),1.0,Selected)*Active;}\nvoid Proximity_Visibility_B54(\nfloat Selection,\nvec3 Proximity_Center,\nvec3 Proximity_Center_2,\nfloat Input_Width,\nfloat Proximity_Far_Distance,\nfloat Proximity_Radius,\nvec3 Active_Face_Center,\nvec3 Active_Face_Dir,\nout float Width)\n{vec3 boxEdges=(world*vec4(vec3(0.5,0.5,0.5),0.0)).xyz;float boxMaxSize=length(boxEdges);float d1=dot(Proximity_Center-Active_Face_Center,Active_Face_Dir);vec3 blob1=Proximity_Center-d1*Active_Face_Dir;float d2=dot(Proximity_Center_2-Active_Face_Center,Active_Face_Dir);vec3 blob2=Proximity_Center_2-d2*Active_Face_Dir;vec3 delta1=blob1-Active_Face_Center;vec3 delta2=blob2-Active_Face_Center;float dist1=dot(delta1,delta1);float dist2=dot(delta2,delta2);float nearestProxDist=sqrt(min(dist1,dist2));Width=Input_Width*(1.0-step(boxMaxSize+Proximity_Radius,nearestProxDist))*(1.0-step(Proximity_Far_Distance,min(d1,d2))*(1.0-step(0.0001,Selection)));}\nvoid Object_To_World_Dir_B67(\nvec3 Dir_Object,\nout vec3 Dir_World)\n{Dir_World=(world*vec4(Dir_Object,0.0)).xyz;}\nvoid main()\n{vec3 Active_Face_Center_Q49;Active_Face_Center_Q49=(world*vec4(_Active_Face_Dir_*0.5,1.0)).xyz;vec3 Blob_Position_Q41= mix(_Blob_Position_,Global_Left_Index_Tip_Position.xyz,float(Use_Global_Left_Index));vec3 Blob_Position_Q42= mix(_Blob_Position_2_,Global_Right_Index_Tip_Position.xyz,float(Use_Global_Right_Index));vec3 Active_Face_Dir_Q64=normalize((world*vec4(_Active_Face_Dir_,0.0)).xyz);float Relative_Scale_Q57;\n#if RELATIVE_WIDTH\nRelative_Scale_Q57=length((world*vec4(vec3(0,1,0),0.0)).xyz);\n#else\nRelative_Scale_Q57=1.0;\n#endif\nvec3 Tangent_World_Q30;Tangent_World_Q30=(world*vec4(tangent,0.0)).xyz;vec3 Binormal_World_Q31;Binormal_World_Q31=(world*vec4((cross(normal,tangent)),0.0)).xyz;vec3 Normal_World_Q60;Normal_World_Q60=(world*vec4(normal,0.0)).xyz;vec3 Result_Q18=0.5*normal;vec3 Dir_World_Q67;Object_To_World_Dir_B67(_Active_Face_Up_,Dir_World_Q67);float Product_Q56=_Edge_Width_*Relative_Scale_Q57;vec3 Normal_World_N_Q29=normalize(Normal_World_Q60);vec3 Tangent_World_N_Q28=normalize(Tangent_World_Q30);vec3 Binormal_World_N_Q32=normalize(Binormal_World_Q31);vec3 Position_Q38;float Near_Size_Q38;float Inner_Fade_Q38;float Blob_Enable_Q38;float Fade_Q38;float Pulse_Q38;Choose_Blob_B38(color,Blob_Position_Q41,Blob_Position_Q42,_Blob_Enable_,_Blob_Enable_2_,_Blob_Near_Size_,_Blob_Near_Size_2_,_Blob_Inner_Fade_,_Blob_Inner_Fade_2_,_Blob_Pulse_,_Blob_Pulse_2_,_Blob_Fade_,_Blob_Fade_2_,Position_Q38,Near_Size_Q38,Inner_Fade_Q38,Blob_Enable_Q38,Fade_Q38,Pulse_Q38);vec3 Face_Center_Q33;Face_Center_Q33=(world*vec4(Result_Q18,1.0)).xyz;vec2 Face_Size_Q50=vec2(length(Tangent_World_Q30),length(Binormal_World_Q31));float Show_Selection_Q48;Selection_Vertex_B48(Blob_Position_Q41,Blob_Position_Q42,Face_Center_Q33,Face_Size_Q50,Normal_World_N_Q29,Tangent_World_N_Q28,Binormal_World_N_Q32,_Selection_Fuzz_,_Selected_,_Selected_Distance_,_Selected_Fade_Length_,Active_Face_Dir_Q64,Show_Selection_Q48);vec3 Normalized_Q72=normalize(Dir_World_Q67);float Active_Q34=max(0.0,dot(Active_Face_Dir_Q64,Normal_World_N_Q29));float Width_Q54;Proximity_Visibility_B54(Show_Selection_Q48,Blob_Position_Q41,Blob_Position_Q42,Product_Q56,_Proximity_Far_Distance_,_Proximity_Near_Radius_,Active_Face_Center_Q49,Active_Face_Dir_Q64,Width_Q54);vec3 Wire_Vx_Pos_Q51;vec2 UV_Q51;vec2 Widths_Q51;Wireframe_Vertex_B51(position,normal,tangent,(cross(normal,tangent)),Width_Q54,Face_Size_Q50,Wire_Vx_Pos_Q51,UV_Q51,Widths_Q51);vec3 Vec3_Q27=vec3(Widths_Q51.x,Widths_Q51.y,color.r);vec3 Pos_World_Q13;Object_To_World_Pos_B13(Wire_Vx_Pos_Q51,Pos_World_Q13);vec3 Incident_Q36=normalize(Pos_World_Q13-cameraPosition);vec3 Out_Position_Q47;vec2 Out_UV_Q47;vec3 Blob_Info_Q47;Blob_Vertex_B47(Pos_World_Q13,Normal_World_N_Q29,Tangent_World_N_Q28,Binormal_World_N_Q32,Position_Q38,_Blob_Intensity_,Near_Size_Q38,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,color,uv,Face_Center_Q33,Face_Size_Q50,UV_Q51,_Blob_Fade_Length_,_Selection_Fade_,_Selection_Fade_Size_,Inner_Fade_Q38,Active_Face_Center_Q49,Pulse_Q38,Fade_Q38,Blob_Enable_Q38,Out_Position_Q47,Out_UV_Q47,Blob_Info_Q47);vec4 Extra1_Q66;float Distance_To_Face_Q66;float Intensity_Q66;Proximity_Vertex_B66(Blob_Position_Q41,Blob_Position_Q42,Active_Face_Center_Q49,Active_Face_Dir_Q64,Pos_World_Q13,_Proximity_Far_Distance_,Relative_Scale_Q57,_Proximity_Anisotropy_,Normalized_Q72,Extra1_Q66,Distance_To_Face_Q66,Intensity_Q66);vec4 Holo_Edges_Q44;Holo_Edge_Vertex_B44(Incident_Q36,Normal_World_N_Q29,uv,Tangent_World_Q30,Binormal_World_Q31,_Smooth_Active_Face_,Active_Q34,Holo_Edges_Q44);vec3 Vec3_Q19=vec3(Show_Selection_Q48,Distance_To_Face_Q66,Intensity_Q66);vec3 Position=Out_Position_Q47;vec2 UV=Out_UV_Q47;vec3 Tangent=Blob_Info_Q47;vec3 Binormal=Vec3_Q19;vec3 Normal=Vec3_Q27;vec4 Extra1=Extra1_Q66;vec4 Color=Holo_Edges_Q44;gl_Position=viewProjection*vec4(Position,1);vPosition=Position;vNormal=Normal;vUV=UV;vTangent=Tangent;vBinormal=Binormal;vColor=Color;vExtra1=Extra1;}";class Hu extends Wt{constructor(){super(),this.RELATIVE_WIDTH=!0,this.ENABLE_FADE=!0,this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class Wu extends Ms{constructor(e,t){super(e,t),this.edgeWidth=.04,this.edgeColor=new Ie(.592157,.592157,.592157,1),this.proximityMaxIntensity=.45,this.proximityFarDistance=.16,this.proximityNearRadius=1.5,this.proximityAnisotropy=1,this.selectionFuzz=.5,this.selected=0,this.selectionFade=0,this.selectionFadeSize=.3,this.selectedDistance=.08,this.selectedFadeLength=.08,this.blobIntensity=.5,this.blobFarSize=.05,this.blobNearDistance=0,this.blobFarDistance=.08,this.blobFadeLength=.08,this.leftBlobEnable=!0,this.leftBlobNearSize=.025,this.leftBlobPulse=0,this.leftBlobFade=1,this.leftBlobInnerFade=.01,this.rightBlobEnable=!0,this.rightBlobNearSize=.025,this.rightBlobPulse=0,this.rightBlobFade=1,this.rightBlobInnerFade=.01,this.activeFaceDir=new me(0,0,-1),this.activeFaceUp=new me(0,1,0),this.enableFade=!0,this.fadeWidth=1.5,this.smoothActiveFace=!0,this.showFrame=!1,this.useBlobTexture=!0,this.globalLeftIndexTipPosition=me.Zero(),this.globalRightIndexTipPosition=me.Zero(),this.alphaMode=Dh.ALPHA_ADD,this.disableDepthWrite=!0,this.backFaceCulling=!1,this._blobTexture=new zi(Wu.BLOB_TEXTURE_URL,this.getScene(),!0,!1,zi.NEAREST_SAMPLINGMODE)}needAlphaBlending(){return!0}needAlphaTesting(){return!0}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new Hu);const i=t.materialDefines,s=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(wi.PrepareDefinesForAttributes(e,i,!0,!1),i.isDirty){i.markAsProcessed(),s.resetCachedMaterial();const e=new is;i.FOG&&e.addFallback(1,"FOG"),wi.HandleFallbacksForShadows(i,e),i.IMAGEPROCESSINGPOSTPROCESS=s.imageProcessingConfiguration.applyByPostProcess;const r=[Oe.PositionKind];i.NORMAL&&r.push(Oe.NormalKind),i.UV1&&r.push(Oe.UVKind),i.UV2&&r.push(Oe.UV2Kind),i.VERTEXCOLOR&&r.push(Oe.ColorKind),i.TANGENT&&r.push(Oe.TangentKind),wi.PrepareAttributesForInstances(r,i);const o="fluentButton",a=i.toString(),l=["world","viewProjection","cameraPosition","_Edge_Width_","_Edge_Color_","_Relative_Width_","_Proximity_Max_Intensity_","_Proximity_Far_Distance_","_Proximity_Near_Radius_","_Proximity_Anisotropy_","_Selection_Fuzz_","_Selected_","_Selection_Fade_","_Selection_Fade_Size_","_Selected_Distance_","_Selected_Fade_Length_","_Blob_Enable_","_Blob_Position_","_Blob_Intensity_","_Blob_Near_Size_","_Blob_Far_Size_","_Blob_Near_Distance_","_Blob_Far_Distance_","_Blob_Fade_Length_","_Blob_Inner_Fade_","_Blob_Pulse_","_Blob_Fade_","_Blob_Texture_","_Blob_Enable_2_","_Blob_Position_2_","_Blob_Near_Size_2_","_Blob_Inner_Fade_2_","_Blob_Pulse_2_","_Blob_Fade_2_","_Active_Face_Dir_","_Active_Face_Up_","_Enable_Fade_","_Fade_Width_","_Smooth_Active_Face_","_Show_Frame_","_Use_Blob_Texture_","Use_Global_Left_Index","Use_Global_Right_Index","Global_Left_Index_Tip_Position","Global_Right_Index_Tip_Position","Global_Left_Thumb_Tip_Position","Global_Right_Thumb_Tip_Position","Global_Left_Index_Tip_Proximity","Global_Right_Index_Tip_Proximity"],h=["_Blob_Texture_"],c=[];wi.PrepareUniformsAndSamplersList({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:i,maxSimultaneousLights:4}),t.setEffect(s.getEngine().createEffect(o,{attributes:r,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:a,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),i,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(i._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){const s=this.getScene();if(!i.materialDefines)return;const n=i.effect;n&&(this._activeEffect=n,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",s.activeCamera.position),this._activeEffect.setTexture("_Blob_Texture_",this._blobTexture),this._activeEffect.setFloat("_Edge_Width_",this.edgeWidth),this._activeEffect.setColor4("_Edge_Color_",new Re(this.edgeColor.r,this.edgeColor.g,this.edgeColor.b),this.edgeColor.a),this._activeEffect.setFloat("_Proximity_Max_Intensity_",this.proximityMaxIntensity),this._activeEffect.setFloat("_Proximity_Far_Distance_",this.proximityFarDistance),this._activeEffect.setFloat("_Proximity_Near_Radius_",this.proximityNearRadius),this._activeEffect.setFloat("_Proximity_Anisotropy_",this.proximityAnisotropy),this._activeEffect.setFloat("_Selection_Fuzz_",this.selectionFuzz),this._activeEffect.setFloat("_Selected_",this.selected),this._activeEffect.setFloat("_Selection_Fade_",this.selectionFade),this._activeEffect.setFloat("_Selection_Fade_Size_",this.selectionFadeSize),this._activeEffect.setFloat("_Selected_Distance_",this.selectedDistance),this._activeEffect.setFloat("_Selected_Fade_Length_",this.selectedFadeLength),this._activeEffect.setFloat("_Blob_Enable_",this.leftBlobEnable?1:0),this._activeEffect.setFloat("_Blob_Intensity_",this.blobIntensity),this._activeEffect.setFloat("_Blob_Near_Size_",this.leftBlobNearSize),this._activeEffect.setFloat("_Blob_Far_Size_",this.blobFarSize),this._activeEffect.setFloat("_Blob_Near_Distance_",this.blobNearDistance),this._activeEffect.setFloat("_Blob_Far_Distance_",this.blobFarDistance),this._activeEffect.setFloat("_Blob_Fade_Length_",this.blobFadeLength),this._activeEffect.setFloat("_Blob_Inner_Fade_",this.leftBlobInnerFade),this._activeEffect.setFloat("_Blob_Pulse_",this.leftBlobPulse),this._activeEffect.setFloat("_Blob_Fade_",this.leftBlobFade),this._activeEffect.setFloat("_Blob_Enable_2_",this.rightBlobEnable?1:0),this._activeEffect.setFloat("_Blob_Near_Size_2_",this.rightBlobNearSize),this._activeEffect.setFloat("_Blob_Inner_Fade_2_",this.rightBlobInnerFade),this._activeEffect.setFloat("_Blob_Pulse_2_",this.rightBlobPulse),this._activeEffect.setFloat("_Blob_Fade_2_",this.rightBlobFade),this._activeEffect.setVector3("_Active_Face_Dir_",this.activeFaceDir),this._activeEffect.setVector3("_Active_Face_Up_",this.activeFaceUp),this._activeEffect.setFloat("_Fade_Width_",this.fadeWidth),this._activeEffect.setFloat("_Smooth_Active_Face_",this.smoothActiveFace?1:0),this._activeEffect.setFloat("_Show_Frame_",this.showFrame?1:0),this._activeEffect.setFloat("_Use_Blob_Texture_",this.useBlobTexture?1:0),this._activeEffect.setFloat("Use_Global_Left_Index",1),this._activeEffect.setFloat("Use_Global_Right_Index",1),this._activeEffect.setVector4("Global_Left_Index_Tip_Position",new ge(this.globalLeftIndexTipPosition.x,this.globalLeftIndexTipPosition.y,this.globalLeftIndexTipPosition.z,1)),this._activeEffect.setVector4("Global_Right_Index_Tip_Position",new ge(this.globalRightIndexTipPosition.x,this.globalRightIndexTipPosition.y,this.globalRightIndexTipPosition.z,1)),this._afterBind(t,this._activeEffect))}getAnimatables(){return[]}dispose(e){super.dispose(e)}clone(e){return qe.Clone((()=>new Wu(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.FluentButtonMaterial",e}getClassName(){return"FluentButtonMaterial"}static Parse(e,t,i){return qe.Parse((()=>new Wu(e.name,t)),e,t,i)}}Wu.BLOB_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/mrtk-fluent-button-blob.png",De([Ge()],Wu.prototype,"edgeWidth",void 0),De([Ke()],Wu.prototype,"edgeColor",void 0),De([Ge()],Wu.prototype,"proximityMaxIntensity",void 0),De([Ge()],Wu.prototype,"proximityFarDistance",void 0),De([Ge()],Wu.prototype,"proximityNearRadius",void 0),De([Ge()],Wu.prototype,"proximityAnisotropy",void 0),De([Ge()],Wu.prototype,"selectionFuzz",void 0),De([Ge()],Wu.prototype,"selected",void 0),De([Ge()],Wu.prototype,"selectionFade",void 0),De([Ge()],Wu.prototype,"selectionFadeSize",void 0),De([Ge()],Wu.prototype,"selectedDistance",void 0),De([Ge()],Wu.prototype,"selectedFadeLength",void 0),De([Ge()],Wu.prototype,"blobIntensity",void 0),De([Ge()],Wu.prototype,"blobFarSize",void 0),De([Ge()],Wu.prototype,"blobNearDistance",void 0),De([Ge()],Wu.prototype,"blobFarDistance",void 0),De([Ge()],Wu.prototype,"blobFadeLength",void 0),De([Ge()],Wu.prototype,"leftBlobEnable",void 0),De([Ge()],Wu.prototype,"leftBlobNearSize",void 0),De([Ge()],Wu.prototype,"leftBlobPulse",void 0),De([Ge()],Wu.prototype,"leftBlobFade",void 0),De([Ge()],Wu.prototype,"leftBlobInnerFade",void 0),De([Ge()],Wu.prototype,"rightBlobEnable",void 0),De([Ge()],Wu.prototype,"rightBlobNearSize",void 0),De([Ge()],Wu.prototype,"rightBlobPulse",void 0),De([Ge()],Wu.prototype,"rightBlobFade",void 0),De([Ge()],Wu.prototype,"rightBlobInnerFade",void 0),De([Qe()],Wu.prototype,"activeFaceDir",void 0),De([Qe()],Wu.prototype,"activeFaceUp",void 0),De([Ge()],Wu.prototype,"enableFade",void 0),De([Ge()],Wu.prototype,"fadeWidth",void 0),De([Ge()],Wu.prototype,"smoothActiveFace",void 0),De([Ge()],Wu.prototype,"showFrame",void 0),De([Ge()],Wu.prototype,"useBlobTexture",void 0),De([Qe()],Wu.prototype,"globalLeftIndexTipPosition",void 0),De([Qe()],Wu.prototype,"globalRightIndexTipPosition",void 0),ue("BABYLON.GUI.FluentButtonMaterial",Wu);class Xu extends Tu{constructor(e,t){super(e),this._isNearPressed=!1,this._interactionSurfaceHeight=0,this._isToggleButton=!1,this._toggleState=!1,this._toggleButtonCallback=()=>{this._onToggle(!this._toggleState)},this.onToggleObservable=new s,this.collidableFrontDirection=me.Zero(),t&&(this.collisionMesh=t)}get isActiveNearInteraction(){return this._isNearPressed}set collidableFrontDirection(e){if(this._collidableFrontDirection=e.normalize(),this._collisionMesh){const e=Ee.Matrix[0];e.copyFrom(this._collisionMesh.getWorldMatrix()),e.invert(),me.TransformNormalToRef(this._collidableFrontDirection,e,this._collidableFrontDirection),this._collidableFrontDirection.normalize()}}get collidableFrontDirection(){if(this._collisionMesh){const e=Ee.Vector3[0];return me.TransformNormalToRef(this._collidableFrontDirection,this._collisionMesh.getWorldMatrix(),e),e.normalize()}return this._collidableFrontDirection}set collisionMesh(e){var t;this._collisionMesh&&(this._collisionMesh.isNearPickable=!1,(null===(t=this._collisionMesh.reservedDataStore)||void 0===t?void 0:t.GUI3D)&&(this._collisionMesh.reservedDataStore.GUI3D={}),this._collisionMesh.getChildMeshes().forEach((e=>{var t;e.isNearPickable=!1,(null===(t=e.reservedDataStore)||void 0===t?void 0:t.GUI3D)&&(e.reservedDataStore.GUI3D={})}))),this._collisionMesh=e,this._injectGUI3DReservedDataStore(this._collisionMesh).control=this,this._collisionMesh.isNearPickable=!0,this._collisionMesh.getChildMeshes().forEach((e=>{this._injectGUI3DReservedDataStore(e).control=this,e.isNearPickable=!0})),this.collidableFrontDirection=e.forward}set isToggleButton(e){e!==this._isToggleButton&&(this._isToggleButton=e,e?this.onPointerUpObservable.add(this._toggleButtonCallback):(this.onPointerUpObservable.removeCallback(this._toggleButtonCallback),this._toggleState&&this._onToggle(!1)))}get isToggleButton(){return this._isToggleButton}set isToggled(e){this._isToggleButton&&this._toggleState!==e&&this._onToggle(e)}get isToggled(){return this._toggleState}_onToggle(e){this._toggleState=e,this.onToggleObservable.notifyObservers(e)}_isInteractionInFrontOfButton(e){return this._getInteractionHeight(e,this._collisionMesh.getAbsolutePosition())>0}getPressDepth(e){if(!this._isNearPressed)return 0;const t=this._getInteractionHeight(e,this._collisionMesh.getAbsolutePosition());return this._interactionSurfaceHeight-t}_getInteractionHeight(e,t){const i=this.collidableFrontDirection;if(0===i.length())return me.Distance(e,t);const s=me.Dot(t,i);return me.Dot(e,i)-s}_generatePointerEventType(e,t,i){if(e===ci.POINTERDOWN||e===ci.POINTERMOVE){if(!this._isInteractionInFrontOfButton(t))return ci.POINTERMOVE;this._isNearPressed=!0,this._interactionSurfaceHeight=this._getInteractionHeight(t,this._collisionMesh.getAbsolutePosition())}if(e===ci.POINTERUP){if(0==i)return ci.POINTERMOVE;this._isNearPressed=!1}return e}_getTypeName(){return"TouchButton3D"}_createNode(e){return super._createNode(e)}dispose(){super.dispose(),this.onPointerUpObservable.removeCallback(this._toggleButtonCallback),this.onToggleObservable.clear(),this._collisionMesh&&this._collisionMesh.dispose()}}class Qu extends Xu{_disposeTooltip(){this._tooltipFade=null,this._tooltipTextBlock&&this._tooltipTextBlock.dispose(),this._tooltipTexture&&this._tooltipTexture.dispose(),this._tooltipMesh&&this._tooltipMesh.dispose(),this.onPointerEnterObservable.remove(this._tooltipHoverObserver),this.onPointerOutObservable.remove(this._tooltipOutObserver)}set renderingGroupId(e){this._backPlate.renderingGroupId=e,this._textPlate.renderingGroupId=e,this._frontPlate.renderingGroupId=e,this._tooltipMesh&&(this._tooltipMesh.renderingGroupId=e)}get renderingGroupId(){return this._backPlate.renderingGroupId}get mesh(){return this._backPlate}set tooltipText(e){if(e){if(!this._tooltipFade){const e=this._backPlate._scene.useRightHandedSystem;this._tooltipMesh=Rr("",{size:1},this._backPlate._scene);const t=Rr("",{size:1,sideOrientation:jn.DOUBLESIDE},this._backPlate._scene),i=new zs("",this._backPlate._scene);i.diffuseColor=Re.FromHexString("#212121"),t.material=i,t.isPickable=!1,this._tooltipMesh.addChild(t),t.position=me.Forward(e).scale(.05),this._tooltipMesh.scaling.y=1/3,this._tooltipMesh.position=me.Up().scale(.7).add(me.Forward(e).scale(-.15)),this._tooltipMesh.isPickable=!1,this._tooltipMesh.parent=this._backPlate,this._tooltipTexture=fu.CreateForMesh(this._tooltipMesh),this._tooltipTextBlock=new Vd,this._tooltipTextBlock.scaleY=3,this._tooltipTextBlock.color="white",this._tooltipTextBlock.fontSize=130,this._tooltipTexture.addControl(this._tooltipTextBlock),this._tooltipFade=new zu,this._tooltipFade.delay=500,this._tooltipMesh.addBehavior(this._tooltipFade),this._tooltipHoverObserver=this.onPointerEnterObservable.add((()=>{this._tooltipFade&&this._tooltipFade.fadeIn(!0)})),this._tooltipOutObserver=this.onPointerOutObservable.add((()=>{this._tooltipFade&&this._tooltipFade.fadeIn(!1)}))}this._tooltipTextBlock&&(this._tooltipTextBlock.text=e)}else this._disposeTooltip()}get tooltipText(){return this._tooltipTextBlock?this._tooltipTextBlock.text:null}get text(){return this._text}set text(e){this._text!==e&&(this._text=e,this._rebuildContent())}get imageUrl(){return this._imageUrl}set imageUrl(e){this._imageUrl!==e&&(this._imageUrl=e,this._rebuildContent())}get backMaterial(){return this._backMaterial}get frontMaterial(){return this._frontMaterial}get plateMaterial(){return this._plateMaterial}get shareMaterials(){return this._shareMaterials}set isBackplateVisible(e){this.mesh&&this._backMaterial&&(e&&!this._isBackplateVisible?this._backPlate.visibility=1:!e&&this._isBackplateVisible&&(this._backPlate.visibility=0)),this._isBackplateVisible=e}constructor(e,t=!0){super(e),this._shareMaterials=!0,this._isBackplateVisible=!0,this._frontPlateDepth=.5,this._backPlateDepth=.04,this._backplateColor=new Re(.08,.15,.55),this._backplateToggledColor=new Re(.25,.4,.95),this._shareMaterials=t,this.pointerEnterAnimation=()=>{this._frontMaterial.leftBlobEnable=!0,this._frontMaterial.rightBlobEnable=!0},this.pointerOutAnimation=()=>{this._frontMaterial.leftBlobEnable=!1,this._frontMaterial.rightBlobEnable=!1},this.pointerDownAnimation=()=>{this._frontPlate&&!this.isActiveNearInteraction&&(this._frontPlate.scaling.z=.2*this._frontPlateDepth,this._frontPlate.position=me.Forward(this._frontPlate._scene.useRightHandedSystem).scale((this._frontPlateDepth-.2*this._frontPlateDepth)/2),this._textPlate.position=me.Forward(this._textPlate._scene.useRightHandedSystem).scale(-(this._backPlateDepth+.2*this._frontPlateDepth)/2))},this.pointerUpAnimation=()=>{this._frontPlate&&(this._frontPlate.scaling.z=this._frontPlateDepth,this._frontPlate.position=me.Forward(this._frontPlate._scene.useRightHandedSystem).scale((this._frontPlateDepth-this._frontPlateDepth)/2),this._textPlate.position=me.Forward(this._textPlate._scene.useRightHandedSystem).scale(-(this._backPlateDepth+this._frontPlateDepth)/2))},this.onPointerMoveObservable.add((e=>{if(this._frontPlate&&this.isActiveNearInteraction){const t=me.Zero();if(this._backPlate.getWorldMatrix().decompose(t,void 0,void 0)){let i=this._getInteractionHeight(e,this._backPlate.getAbsolutePosition())/t.z;i=ne.Clamp(i-this._backPlateDepth/2,.2*this._frontPlateDepth,this._frontPlateDepth),this._frontPlate.scaling.z=i,this._frontPlate.position=me.Forward(this._frontPlate._scene.useRightHandedSystem).scale((this._frontPlateDepth-i)/2),this._textPlate.position=me.Forward(this._textPlate._scene.useRightHandedSystem).scale(-(this._backPlateDepth+i)/2)}}})),this._pointerHoverObserver=this.onPointerMoveObservable.add((e=>{this._frontMaterial.globalLeftIndexTipPosition=e}))}_getTypeName(){return"TouchHolographicButton"}_rebuildContent(){this._disposeFacadeTexture();const e=new Hd;if(e.isVertical=!0,c()&&document.createElement&&this._imageUrl){const t=new Gd;t.source=this._imageUrl,t.paddingTop="40px",t.height="180px",t.width="100px",t.paddingBottom="40px",e.addControl(t)}if(this._text){const t=new Vd;t.text=this._text,t.color="white",t.height="30px",t.fontSize=24,e.addControl(t)}this.content=e}_createNode(e){var t;this.name=null!==(t=this.name)&&void 0!==t?t:"TouchHolographicButton";const i=Fr(`${this.name}_collisionMesh`,{width:1,height:1,depth:this._frontPlateDepth},e);i.isPickable=!0,i.isNearPickable=!0,i.visibility=0,i.position=me.Forward(e.useRightHandedSystem).scale(-this._frontPlateDepth/2),da.ImportMeshAsync(void 0,Qu.MODEL_BASE_URL,Qu.MODEL_FILENAME,e).then((t=>{const s=Fr("${this.name}_alphaMesh",{width:1,height:1,depth:1},e);s.isPickable=!1,s.material=new zs("${this.name}_alphaMesh_material",e),s.material.alpha=.15;const n=t.meshes[1];n.name=`${this.name}_frontPlate`,n.isPickable=!1,n.scaling.z=this._frontPlateDepth,s.parent=n,n.parent=i,this._frontMaterial&&(n.material=this._frontMaterial),this._frontPlate=n})),this._backPlate=Fr(`${this.name}_backPlate`,{width:1,height:1,depth:this._backPlateDepth},e),this._backPlate.position=me.Forward(e.useRightHandedSystem).scale(this._backPlateDepth/2),this._backPlate.isPickable=!1,this._textPlate=super._createNode(e),this._textPlate.name=`${this.name}_textPlate`,this._textPlate.isPickable=!1,this._textPlate.position=me.Forward(e.useRightHandedSystem).scale(-this._frontPlateDepth/2),this._backPlate.addChild(i),this._backPlate.addChild(this._textPlate);const s=new Bn("{this.name}_root",e);return this._backPlate.setParent(s),this.collisionMesh=i,this.collidableFrontDirection=this._backPlate.forward.negate(),s}_applyFacade(e){this._plateMaterial.emissiveTexture=e,this._plateMaterial.opacityTexture=e,this._plateMaterial.diffuseColor=new Re(.4,.4,.4)}_createBackMaterial(e){this._backMaterial=new xu(this.name+"backPlateMaterial",e.getScene()),this._backMaterial.albedoColor=this._backplateColor,this._backMaterial.renderBorders=!0,this._backMaterial.renderHoverLight=!1}_createFrontMaterial(e){this._frontMaterial=new Wu(this.name+"Front Material",e.getScene())}_createPlateMaterial(e){this._plateMaterial=new zs(this.name+"Plate Material",e.getScene()),this._plateMaterial.specularColor=Re.Black()}_onToggle(e){this._backMaterial&&(this._backMaterial.albedoColor=e?this._backplateToggledColor:this._backplateColor),super._onToggle(e)}_affectMaterial(e){this._shareMaterials?(this._host._touchSharedMaterials.backFluentMaterial?this._backMaterial=this._host._touchSharedMaterials.backFluentMaterial:(this._createBackMaterial(e),this._host._touchSharedMaterials.backFluentMaterial=this._backMaterial),this._host._touchSharedMaterials.frontFluentMaterial?this._frontMaterial=this._host._touchSharedMaterials.frontFluentMaterial:(this._createFrontMaterial(e),this._host._touchSharedMaterials.frontFluentMaterial=this._frontMaterial)):(this._createBackMaterial(e),this._createFrontMaterial(e)),this._createPlateMaterial(e),this._backPlate.material=this._backMaterial,this._textPlate.material=this._plateMaterial,this._isBackplateVisible||(this._backPlate.visibility=0),this._frontPlate&&(this._frontPlate.material=this._frontMaterial),this._rebuildContent()}dispose(){super.dispose(),this._disposeTooltip(),this.onPointerMoveObservable.remove(this._pointerHoverObserver),this.shareMaterials||(this._backMaterial.dispose(),this._frontMaterial.dispose(),this._plateMaterial.dispose(),this._pickedPointObserver&&(this._host.onPickedPointChangedObservable.remove(this._pickedPointObserver),this._pickedPointObserver=null))}}Qu.MODEL_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",Qu.MODEL_FILENAME="mrtk-fluent-button.glb";class Yu{constructor(){this._tmpQuaternion=new ve,this._tmpVectors=[new me,new me,new me,new me,new me,new me,new me],this._tmpMatrix=new Te,this._tmpInvertView=new Te,this._tmpForward=new me,this._tmpNodeForward=new me,this._tmpPosition=new me,this._workingPosition=new me,this._workingQuaternion=new ve,this._lastTick=-1,this._recenterNextUpdate=!0,this.interpolatePose=!0,this.lerpTime=500,this.ignoreCameraPitchAndRoll=!1,this.pitchOffset=15,this.maxViewVerticalDegrees=30,this.maxViewHorizontalDegrees=30,this.orientToCameraDeadzoneDegrees=60,this.ignoreDistanceClamp=!1,this.ignoreAngleClamp=!1,this.verticalMaxDistance=0,this.defaultDistance=.8,this.maximumDistance=2,this.minimumDistance=.3,this.useFixedVerticalOffset=!1,this.fixedVerticalOffset=0,this._enabled=!0}get followedCamera(){return this._followedCamera||this._scene.activeCamera}set followedCamera(e){this._followedCamera=e}get name(){return"Follow"}init(){}attach(e,t){this._scene=e.getScene(),this.attachedNode=e,t&&(this.followedCamera=t),this._addObservables()}detach(){this.attachedNode=null,this._removeObservables()}recenter(){this._recenterNextUpdate=!0}_angleBetweenVectorAndPlane(e,t){return this._tmpVectors[0].copyFrom(e),e=this._tmpVectors[0],this._tmpVectors[1].copyFrom(t),t=this._tmpVectors[1],e.normalize(),t.normalize(),Math.PI/2-Math.acos(me.Dot(e,t))}_length2D(e){return Math.sqrt(e.x*e.x+e.z*e.z)}_distanceClamp(e,t=!1){let i=this.minimumDistance,s=this.maximumDistance;const n=this.defaultDistance,r=this._tmpVectors[0];r.copyFrom(e);let o=r.length();if(r.normalizeFromLength(o),this.ignoreCameraPitchAndRoll){i=this._length2D(r)*i,s=this._length2D(r)*s;const t=this._length2D(e);r.scaleInPlace(o/t),o=t}let a=o;return a=t?n:ne.Clamp(o,i,s),e.copyFrom(r).scaleInPlace(a),o!==a}_applyVerticalClamp(e){0!==this.verticalMaxDistance&&(e.y=ne.Clamp(e.y,-this.verticalMaxDistance,this.verticalMaxDistance))}_toOrientationQuatToRef(e,t){ve.RotationYawPitchRollToRef(Math.atan2(e.x,e.z),Math.atan2(e.y,Math.sqrt(e.z*e.z+e.x*e.x)),0,t)}_applyPitchOffset(e){const t=this._tmpVectors[0],i=this._tmpVectors[1];t.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),i.copyFromFloats(1,0,0),me.TransformNormalToRef(t,e,t),t.y=0,t.normalize(),me.TransformNormalToRef(i,e,i),ve.RotationAxisToRef(i,this.pitchOffset*Math.PI/180,this._tmpQuaternion),t.rotateByQuaternionToRef(this._tmpQuaternion,t),this._toOrientationQuatToRef(t,this._tmpQuaternion),this._tmpQuaternion.toRotationMatrix(this._tmpMatrix),e.copyFrom(this._tmpMatrix)}_angularClamp(e,t){const i=this._tmpVectors[5];i.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1);const s=this._tmpVectors[6];s.copyFromFloats(1,0,0),me.TransformNormalToRef(i,e,i),me.TransformNormalToRef(s,e,s);const n=me.UpReadOnly;if(t.length()<ae)return!1;let r=!1;const o=this._tmpQuaternion;if(this.ignoreCameraPitchAndRoll){const e=me.GetAngleBetweenVectorsOnPlane(t,i,s);ve.RotationAxisToRef(s,e,o),t.rotateByQuaternionToRef(o,t)}else{const e=-me.GetAngleBetweenVectorsOnPlane(t,i,s),n=this.maxViewVerticalDegrees*Math.PI/180*.5;e<-n?(ve.RotationAxisToRef(s,-e-n,o),t.rotateByQuaternionToRef(o,t),r=!0):e>n&&(ve.RotationAxisToRef(s,-e+n,o),t.rotateByQuaternionToRef(o,t),r=!0)}const a=this._angleBetweenVectorAndPlane(t,s)*(this._scene.useRightHandedSystem?-1:1),l=this.maxViewHorizontalDegrees*Math.PI/180*.5;return a<-l?(ve.RotationAxisToRef(n,-a-l,o),t.rotateByQuaternionToRef(o,t),r=!0):a>l&&(ve.RotationAxisToRef(n,-a+l,o),t.rotateByQuaternionToRef(o,t),r=!0),r}_orientationClamp(e,t){var i;const s=this._tmpVectors[0];s.copyFrom(e).scaleInPlace(-1).normalize();const n=this._tmpVectors[1],r=this._tmpVectors[2];n.copyFromFloats(0,1,0),me.CrossToRef(s,n,r);const o=r.length();o<ae||(r.normalizeFromLength(o),me.CrossToRef(r,s,n),(null===(i=this.attachedNode)||void 0===i?void 0:i.getScene().useRightHandedSystem)?ve.FromLookDirectionRHToRef(s,n,t):ve.FromLookDirectionLHToRef(s,n,t))}_passedOrientationDeadzone(e,t){const i=this._tmpVectors[5];return i.copyFrom(e),i.normalize(),180*Math.abs(me.GetAngleBetweenVectorsOnPlane(t,i,me.UpReadOnly))/Math.PI>this.orientToCameraDeadzoneDegrees}_updateLeashing(e){if(this.attachedNode&&this._enabled){const t=this.attachedNode.parent;this.attachedNode.setParent(null);const i=this.attachedNode.getWorldMatrix(),s=this._workingPosition,n=this._workingQuaternion,r=this.attachedNode.getPivotPoint(),o=this._tmpInvertView;o.copyFrom(e.getViewMatrix()),o.invert(),me.TransformCoordinatesToRef(r,i,s);const a=this._tmpPosition;a.copyFromFloats(0,0,0),me.TransformCoordinatesToRef(a,i,a),a.scaleInPlace(-1).subtractInPlace(r),s.subtractInPlace(e.globalPosition),this.ignoreCameraPitchAndRoll&&this._applyPitchOffset(o);let l=!1;const h=this._tmpForward;h.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),me.TransformNormalToRef(h,o,h);const c=this._tmpNodeForward;if(c.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),me.TransformNormalToRef(c,i,c),this._recenterNextUpdate)s.copyFrom(h).scaleInPlace(this.defaultDistance);else if(this.ignoreAngleClamp){const e=s.length();s.copyFrom(h).scaleInPlace(e)}else l=this._angularClamp(o,s);let d=!1;this.ignoreDistanceClamp||(d=this._distanceClamp(s,l),this._applyVerticalClamp(s)),this.useFixedVerticalOffset&&(s.y=a.y-e.globalPosition.y+this.fixedVerticalOffset),(l||d||this._passedOrientationDeadzone(s,c)||this._recenterNextUpdate)&&this._orientationClamp(s,n),this._workingPosition.subtractInPlace(r),this._recenterNextUpdate=!1,this.attachedNode.setParent(t)}}_updateTransformToGoal(e){if(!this.attachedNode||!this.followedCamera||!this._enabled)return;this.attachedNode.rotationQuaternion||(this.attachedNode.rotationQuaternion=ve.Identity());const t=this.attachedNode.parent;if(this.attachedNode.setParent(null),!this.interpolatePose)return this.attachedNode.position.copyFrom(this.followedCamera.globalPosition).addInPlace(this._workingPosition),void this.attachedNode.rotationQuaternion.copyFrom(this._workingQuaternion);const i=new me;i.copyFrom(this.attachedNode.position).subtractInPlace(this.followedCamera.globalPosition),me.SmoothToRef(i,this._workingPosition,e,this.lerpTime,i),i.addInPlace(this.followedCamera.globalPosition),this.attachedNode.position.copyFrom(i);const s=new ve;s.copyFrom(this.attachedNode.rotationQuaternion),ve.SmoothToRef(s,this._workingQuaternion,e,this.lerpTime,this.attachedNode.rotationQuaternion),this.attachedNode.setParent(t)}_addObservables(){this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add((()=>{if(!this.followedCamera)return;const e=Date.now();this._updateLeashing(this.followedCamera),this._updateTransformToGoal(e-this._lastTick),this._lastTick=e}))}_removeObservables(){this._onBeforeRender&&this._scene.onBeforeRenderObservable.remove(this._onBeforeRender)}}class Ku{constructor(){this._attachedToElement=!1,this._virtualMeshesInfo={},this._tmpVector=new me,this._tmpQuaternion=new ve,this._dragType={NONE:0,DRAG:1,DRAG_WITH_CONTROLLER:2,NEAR_DRAG:3},this._moving=!1,this._dragging=this._dragType.NONE,this.draggableMeshes=null,this.zDragFactor=3,this.currentDraggingPointerIds=[],this.detachCameraControls=!0,this.onDragStartObservable=new s,this.onDragObservable=new s,this.onDragEndObservable=new s,this.allowMultiPointer=!0}get currentDraggingPointerId(){return void 0!==this.currentDraggingPointerIds[0]?this.currentDraggingPointerIds[0]:-1}set currentDraggingPointerId(e){this.currentDraggingPointerIds[0]=e}get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}get name(){return"BaseSixDofDrag"}get isMoving(){return this._moving}init(){}get _pointerCamera(){return this._scene.cameraToUseForPointers?this._scene.cameraToUseForPointers:this._scene.activeCamera}_createVirtualMeshInfo(){const e=new Gn("",Ku._virtualScene);e.rotationQuaternion=new ve;const t=new Gn("",Ku._virtualScene);t.rotationQuaternion=new ve;const i=new Gn("",Ku._virtualScene);return i.rotationQuaternion=new ve,{dragging:!1,moving:!1,dragMesh:e,originMesh:t,pivotMesh:i,startingPivotPosition:new me,startingPivotOrientation:new ve,startingPosition:new me,startingOrientation:new ve,lastOriginPosition:new me,lastDragPosition:new me}}_resetVirtualMeshesPosition(){for(let e=0;e<this.currentDraggingPointerIds.length;e++)this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.rotationQuaternion)}_pointerUpdate2D(e,t,i){!this._pointerCamera||this._pointerCamera.cameraRigMode!=Gt.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||(e.origin.copyFrom(this._pointerCamera.globalPosition),i=0);const s=this._virtualMeshesInfo[t],n=Ee.Vector3[0];e.origin.subtractToRef(s.lastOriginPosition,n),s.lastOriginPosition.copyFrom(e.origin);const r=-me.Dot(n,e.direction);s.originMesh.addChild(s.dragMesh),s.originMesh.addChild(s.pivotMesh),this._applyZOffset(s.dragMesh,r,i),this._applyZOffset(s.pivotMesh,r,i),s.originMesh.position.copyFrom(e.origin);const o=Ee.Vector3[0];e.origin.addToRef(e.direction,o),s.originMesh.lookAt(o),s.originMesh.removeChild(s.dragMesh),s.originMesh.removeChild(s.pivotMesh)}_pointerUpdateXR(e,t,i,s){const n=this._virtualMeshesInfo[i];if(n.originMesh.position.copyFrom(e.position),this._dragging===this._dragType.NEAR_DRAG&&t?n.originMesh.rotationQuaternion.copyFrom(t.rotationQuaternion):n.originMesh.rotationQuaternion.copyFrom(e.rotationQuaternion),n.pivotMesh.computeWorldMatrix(!0),n.dragMesh.computeWorldMatrix(!0),0!==s){const e=Ee.Vector3[0],t=Ee.Vector3[1];e.copyFrom(this._pointerCamera.getForwardRay().direction),n.originMesh.position.subtractToRef(n.lastOriginPosition,t),n.lastOriginPosition.copyFrom(n.originMesh.position);const i=t.length();t.normalize();const r=Ee.Vector3[2],o=Ee.Vector3[3];n.dragMesh.absolutePosition.subtractToRef(this._pointerCamera.globalPosition,r),n.dragMesh.absolutePosition.subtractToRef(n.originMesh.position,o);const a=o.length();r.normalize(),o.normalize();let l=Math.abs(me.Dot(t,o))*me.Dot(t,e)*s*i*a;const h=.01;l<0&&h-a>l&&(l=Math.min(h-a,0)),o.scaleInPlace(l),o.addToRef(n.pivotMesh.absolutePosition,this._tmpVector),n.pivotMesh.setAbsolutePosition(this._tmpVector),o.addToRef(n.dragMesh.absolutePosition,this._tmpVector),n.dragMesh.setAbsolutePosition(this._tmpVector)}}attach(e){this._ownerNode=e,this._scene=this._ownerNode.getScene(),Ku._virtualScene||(Ku._virtualScene=new Oi(this._scene.getEngine(),{virtual:!0}),Ku._virtualScene.detachControl());const t=e=>this._ownerNode===e||e.isDescendantOf(this._ownerNode)&&(!this.draggableMeshes||-1!==this.draggableMeshes.indexOf(e));this._pointerObserver=this._scene.onPointerObservable.add((e=>{const i=e.event.pointerId;this._virtualMeshesInfo[i]||(this._virtualMeshesInfo[i]=this._createVirtualMeshInfo());const s=this._virtualMeshesInfo[i],n="xr-near"===e.event.pointerType;if(e.type==ci.POINTERDOWN){if(!s.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&(!n||e.pickInfo.aimTransform)&&t(e.pickInfo.pickedMesh)){if(!this.allowMultiPointer&&this.currentDraggingPointerIds.length>0)return;!this._pointerCamera||this._pointerCamera.cameraRigMode!==Gt.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||e.pickInfo.ray.origin.copyFrom(this._pointerCamera.globalPosition),this._ownerNode.computeWorldMatrix(!0);const t=this._virtualMeshesInfo[i];n?(this._dragging=e.pickInfo.originMesh?this._dragType.NEAR_DRAG:this._dragType.DRAG_WITH_CONTROLLER,t.originMesh.position.copyFrom(e.pickInfo.aimTransform.position),this._dragging===this._dragType.NEAR_DRAG&&e.pickInfo.gripTransform?t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.gripTransform.rotationQuaternion):t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.aimTransform.rotationQuaternion)):(this._dragging=this._dragType.DRAG,t.originMesh.position.copyFrom(e.pickInfo.ray.origin)),t.lastOriginPosition.copyFrom(t.originMesh.position),t.dragMesh.position.copyFrom(e.pickInfo.pickedPoint),t.lastDragPosition.copyFrom(e.pickInfo.pickedPoint),t.pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),t.pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.absoluteRotationQuaternion),t.startingPosition.copyFrom(t.dragMesh.position),t.startingPivotPosition.copyFrom(t.pivotMesh.position),t.startingOrientation.copyFrom(t.dragMesh.rotationQuaternion),t.startingPivotOrientation.copyFrom(t.pivotMesh.rotationQuaternion),n?(t.originMesh.addChild(t.dragMesh),t.originMesh.addChild(t.pivotMesh)):t.originMesh.lookAt(t.dragMesh.position),t.dragging=!0,-1===this.currentDraggingPointerIds.indexOf(i)&&this.currentDraggingPointerIds.push(i),this.detachCameraControls&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._pointerCamera.inputs&&this._pointerCamera.inputs.attachedToElement?(this._pointerCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1),this._targetDragStart(t.pivotMesh.position,t.pivotMesh.rotationQuaternion,i),this.onDragStartObservable.notifyObservers({position:t.pivotMesh.position})}}else if(e.type==ci.POINTERUP||e.type==ci.POINTERDOUBLETAP){const e=this.currentDraggingPointerIds.indexOf(i);s.dragging=!1,-1!==e&&(this.currentDraggingPointerIds.splice(e,1),0===this.currentDraggingPointerIds.length&&(this._moving=!1,this._dragging=this._dragType.NONE,this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1)),s.originMesh.removeChild(s.dragMesh),s.originMesh.removeChild(s.pivotMesh),this._targetDragEnd(i),this.onDragEndObservable.notifyObservers({}))}else if(e.type==ci.POINTERMOVE&&-1!==this.currentDraggingPointerIds.indexOf(i)&&s.dragging&&e.pickInfo&&(e.pickInfo.ray||e.pickInfo.aimTransform)){let t=this.zDragFactor;(this.currentDraggingPointerIds.length>1||e.pickInfo.originMesh)&&(t=0),this._ownerNode.computeWorldMatrix(!0),n?this._pointerUpdateXR(e.pickInfo.aimTransform,e.pickInfo.gripTransform,i,t):this._pointerUpdate2D(e.pickInfo.ray,i,t),this._tmpQuaternion.copyFrom(s.startingPivotOrientation),this._tmpQuaternion.x=-this._tmpQuaternion.x,this._tmpQuaternion.y=-this._tmpQuaternion.y,this._tmpQuaternion.z=-this._tmpQuaternion.z,s.pivotMesh.absoluteRotationQuaternion.multiplyToRef(this._tmpQuaternion,this._tmpQuaternion),s.pivotMesh.absolutePosition.subtractToRef(s.startingPivotPosition,this._tmpVector),this.onDragObservable.notifyObservers({delta:this._tmpVector,position:s.pivotMesh.position,pickInfo:e.pickInfo}),this._targetDrag(this._tmpVector,this._tmpQuaternion,i),s.lastDragPosition.copyFrom(s.dragMesh.absolutePosition),this._moving=!0}}))}_applyZOffset(e,t,i){e.position.z-=e.position.z<1?t*i:t*i*e.position.z,e.position.z<0&&(e.position.z=0)}_targetDragStart(e,t,i){}_targetDrag(e,t,i){}_targetDragEnd(e){}_reattachCameraControls(){if(this._pointerCamera)if("ArcRotateCamera"===this._pointerCamera.getClassName()){const e=this._pointerCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._pointerCamera.attachControl(!this._pointerCamera.inputs||this._pointerCamera.inputs.noPreventDefault)}detach(){this._scene&&(this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1),this._scene.onPointerObservable.remove(this._pointerObserver));for(const e in this._virtualMeshesInfo)this._virtualMeshesInfo[e].originMesh.dispose(),this._virtualMeshesInfo[e].dragMesh.dispose();this.onDragEndObservable.clear(),this.onDragObservable.clear(),this.onDragStartObservable.clear()}}class ju extends Ku{constructor(){super(...arguments),this._sceneRenderObserver=null,this._targetPosition=new me(0,0,0),this._targetOrientation=new ve,this._targetScaling=new me(1,1,1),this._startingPosition=new me(0,0,0),this._startingOrientation=new ve,this._startingScaling=new me(1,1,1),this.onPositionChangedObservable=new s,this.dragDeltaRatio=.2,this.rotateDraggedObject=!0,this.rotateAroundYOnly=!1,this.rotateWithMotionController=!0,this.disableMovement=!1,this.faceCameraOnDragStart=!1}get name(){return"SixDofDrag"}attach(e){super.attach(e),e.isNearGrabbable=!0,this._virtualTransformNode=new Bn("virtual_sixDof",Ku._virtualScene),this._virtualTransformNode.rotationQuaternion=ve.Identity(),this._sceneRenderObserver=e.getScene().onBeforeRenderObservable.add((()=>{if(1===this.currentDraggingPointerIds.length&&this._moving&&!this.disableMovement){const t=e.parent;e.setParent(null),e.position.addInPlace(this._targetPosition.subtract(e.position).scale(this.dragDeltaRatio)),this.onPositionChangedObservable.notifyObservers({position:e.absolutePosition}),(!t||t.scaling&&!t.scaling.isNonUniformWithinEpsilon(.001))&&ve.SlerpToRef(e.rotationQuaternion,this._targetOrientation,this.dragDeltaRatio,e.rotationQuaternion),e.setParent(t)}}))}_getPositionOffsetAround(e,t,i){const s=Ee.Matrix[0],n=Ee.Matrix[1],r=Ee.Matrix[2],o=Ee.Matrix[3],a=Ee.Matrix[4];return Te.TranslationToRef(e.x,e.y,e.z,s),Te.TranslationToRef(-e.x,-e.y,-e.z,n),Te.FromQuaternionToRef(i,r),Te.ScalingToRef(t,t,t,o),n.multiplyToRef(r,a),a.multiplyToRef(o,a),a.multiplyToRef(s,a),a.getTranslation()}_onePointerPositionUpdated(e,t){Ee.Vector3[0].setAll(0),this._dragging===this._dragType.DRAG?this.rotateDraggedObject&&(this.rotateAroundYOnly?ve.RotationYawPitchRollToRef(t.toEulerAngles().y,0,0,Ee.Quaternion[0]):Ee.Quaternion[0].copyFrom(t),Ee.Quaternion[0].multiplyToRef(this._startingOrientation,this._targetOrientation)):(this._dragging===this._dragType.NEAR_DRAG||this._dragging===this._dragType.DRAG_WITH_CONTROLLER&&this.rotateWithMotionController)&&t.multiplyToRef(this._startingOrientation,this._targetOrientation),this._targetPosition.copyFrom(this._startingPosition).addInPlace(e)}_twoPointersPositionUpdated(){const e=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].startingPosition,t=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].startingPosition,i=Ee.Vector3[0];e.addToRef(t,i),i.scaleInPlace(.5);const s=Ee.Vector3[1];t.subtractToRef(e,s);const n=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].dragMesh.absolutePosition,r=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].dragMesh.absolutePosition,o=Ee.Vector3[2];n.addToRef(r,o),o.scaleInPlace(.5);const a=Ee.Vector3[3];r.subtractToRef(n,a);const l=a.length()/s.length(),h=o.subtract(i),c=ve.FromEulerAngles(0,me.GetAngleBetweenVectorsOnPlane(s.normalize(),a.normalize(),me.UpReadOnly),0),d=this._ownerNode.parent;this._ownerNode.setParent(null);const u=this._getPositionOffsetAround(i.subtract(this._virtualTransformNode.getAbsolutePivotPoint()),l,c);this._virtualTransformNode.rotationQuaternion.multiplyToRef(c,this._ownerNode.rotationQuaternion),this._virtualTransformNode.scaling.scaleToRef(l,this._ownerNode.scaling),this._virtualTransformNode.position.addToRef(h.addInPlace(u),this._ownerNode.position),this.onPositionChangedObservable.notifyObservers({position:this._ownerNode.position}),this._ownerNode.setParent(d)}_targetDragStart(){const e=this.currentDraggingPointerIds.length,t=this._ownerNode.parent;this._ownerNode.rotationQuaternion||(this._ownerNode.rotationQuaternion=ve.RotationYawPitchRoll(this._ownerNode.rotation.y,this._ownerNode.rotation.x,this._ownerNode.rotation.z));const i=this._ownerNode.getAbsolutePivotPoint();if(this._ownerNode.setParent(null),1===e){if(this._targetPosition.copyFrom(this._ownerNode.position),this._targetOrientation.copyFrom(this._ownerNode.rotationQuaternion),this._targetScaling.copyFrom(this._ownerNode.scaling),this.faceCameraOnDragStart&&this._scene.activeCamera){const e=Ee.Vector3[0];this._scene.activeCamera.position.subtractToRef(i,e),e.normalize();const t=Ee.Quaternion[0];this._scene.useRightHandedSystem?ve.FromLookDirectionRHToRef(e,new me(0,1,0),t):ve.FromLookDirectionLHToRef(e,new me(0,1,0),t),t.normalize(),ve.RotationYawPitchRollToRef(t.toEulerAngles().y,0,0,Ee.Quaternion[0]),this._targetOrientation.copyFrom(Ee.Quaternion[0])}this._startingPosition.copyFrom(this._targetPosition),this._startingOrientation.copyFrom(this._targetOrientation),this._startingScaling.copyFrom(this._targetScaling)}else 2===e&&(this._virtualTransformNode.setPivotPoint(new me(0,0,0),Js.LOCAL),this._virtualTransformNode.position.copyFrom(this._ownerNode.position),this._virtualTransformNode.scaling.copyFrom(this._ownerNode.scaling),this._virtualTransformNode.rotationQuaternion.copyFrom(this._ownerNode.rotationQuaternion),this._virtualTransformNode.setPivotPoint(i,Js.WORLD),this._resetVirtualMeshesPosition());this._ownerNode.setParent(t)}_targetDrag(e,t){1===this.currentDraggingPointerIds.length?this._onePointerPositionUpdated(e,t):2===this.currentDraggingPointerIds.length&&this._twoPointersPositionUpdated()}_targetDragEnd(){if(1===this.currentDraggingPointerIds.length){this._resetVirtualMeshesPosition();const e=this.faceCameraOnDragStart;this.faceCameraOnDragStart=!1,this._targetDragStart(),this.faceCameraOnDragStart=e}}detach(){super.detach(),this._ownerNode&&(this._ownerNode.isNearGrabbable=!1,this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver)),this._virtualTransformNode&&this._virtualTransformNode.dispose()}}class $u{constructor(){this._attachPointLocalOffset=new me,this._workingPosition=new me,this._workingQuaternion=new ve,this._lastTick=-1,this._hit=!1,this.hitNormalOffset=.05,this.meshes=[],this.interpolatePose=!0,this.lerpTime=250,this.keepOrientationVertical=!0,this.enabled=!0,this.maxStickingDistance=.8}get name(){return"SurfaceMagnetism"}init(){}attach(e,t){this._attachedMesh=e,this._scene=t||e.getScene(),this._attachedMesh.rotationQuaternion||(this._attachedMesh.rotationQuaternion=ve.RotationYawPitchRoll(this._attachedMesh.rotation.y,this._attachedMesh.rotation.x,this._attachedMesh.rotation.z)),this.updateAttachPoint(),this._workingPosition.copyFrom(this._attachedMesh.position),this._workingQuaternion.copyFrom(this._attachedMesh.rotationQuaternion),this._addObservables()}detach(){this._attachedMesh=null,this._removeObservables()}_getTargetPose(e){if(!this._attachedMesh)return null;if(e&&e.hit){const t=e.getNormal(!0,!0),i=e.pickedPoint;if(!t||!i)return null;t.normalize();const s=Ee.Vector3[0];return s.copyFrom(t),s.scaleInPlace(this.hitNormalOffset),s.addInPlace(i),this._attachedMesh.parent&&(Ee.Matrix[0].copyFrom(this._attachedMesh.parent.getWorldMatrix()).invert(),me.TransformNormalToRef(s,Ee.Matrix[0],s)),{position:s,quaternion:ve.RotationYawPitchRoll(-Math.atan2(t.x,-t.z),this.keepOrientationVertical?0:Math.atan2(t.y,Math.sqrt(t.z*t.z+t.x*t.x)),0)}}return null}updateAttachPoint(){this._getAttachPointOffsetToRef(this._attachPointLocalOffset)}findAndUpdateTarget(e){if(this._hit=!1,!e.ray)return!1;const t=e.ray.intersectsMeshes(this.meshes)[0];if(this._attachedMesh&&t&&t.hit&&t.pickedMesh){const e=this._getTargetPose(t);e&&me.Distance(this._attachedMesh.position,e.position)<this.maxStickingDistance&&(this._workingPosition.copyFrom(e.position),this._workingQuaternion.copyFrom(e.quaternion),this._hit=!0)}return this._hit}_getAttachPointOffsetToRef(e){if(!this._attachedMesh)return void e.setAll(0);const t=Ee.Quaternion[0];t.copyFrom(this._attachedMesh.rotationQuaternion),this._attachedMesh.rotationQuaternion.copyFromFloats(0,0,0,1),this._attachedMesh.computeWorldMatrix();const i=this._attachedMesh.getHierarchyBoundingVectors(),s=Ee.Vector3[0];i.max.addToRef(i.min,s),s.scaleInPlace(.5),s.z=i.max.z;const n=Ee.Matrix[0];this._attachedMesh.getWorldMatrix().invertToRef(n),me.TransformCoordinatesToRef(s,n,e),this._attachedMesh.rotationQuaternion.copyFrom(t)}_updateTransformToGoal(e){if(!this._attachedMesh||!this._hit)return;const t=this._attachedMesh.parent;this._attachedMesh.setParent(null);const i=Ee.Vector3[0];if(me.TransformNormalToRef(this._attachPointLocalOffset,this._attachedMesh.getWorldMatrix(),i),!this.interpolatePose)return this._attachedMesh.position.copyFrom(this._workingPosition).subtractInPlace(i),void this._attachedMesh.rotationQuaternion.copyFrom(this._workingQuaternion);const s=new me;me.SmoothToRef(this._attachedMesh.position,this._workingPosition,e,this.lerpTime,s),this._attachedMesh.position.copyFrom(s);const n=new ve;n.copyFrom(this._attachedMesh.rotationQuaternion),ve.SmoothToRef(n,this._workingQuaternion,e,this.lerpTime,this._attachedMesh.rotationQuaternion),this._attachedMesh.setParent(t)}_addObservables(){this._pointerObserver=this._scene.onPointerObservable.add((e=>{this.enabled&&e.type==ci.POINTERMOVE&&e.pickInfo&&this.findAndUpdateTarget(e.pickInfo)})),this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add((()=>{const e=Date.now();this._updateTransformToGoal(e-this._lastTick),this._lastTick=e}))}_removeObservables(){this._scene.onPointerObservable.remove(this._pointerObserver),this._scene.onBeforeRenderObservable.remove(this._onBeforeRender),this._pointerObserver=null,this._onBeforeRender=null}}class qu{constructor(){this.followBehaviorEnabled=!1,this.sixDofDragBehaviorEnabled=!0,this.surfaceMagnetismBehaviorEnabled=!0,this._followBehavior=new Yu,this._sixDofDragBehavior=new ju,this._surfaceMagnetismBehavior=new $u}get name(){return"Default"}get followBehavior(){return this._followBehavior}get sixDofDragBehavior(){return this._sixDofDragBehavior}get surfaceMagnetismBehavior(){return this._surfaceMagnetismBehavior}init(){}attach(e,t,i){this._scene=e.getScene(),this.attachedNode=e,this._addObservables(),this._followBehavior.attach(e),this._sixDofDragBehavior.attach(e),this._sixDofDragBehavior.draggableMeshes=t||null,this._sixDofDragBehavior.faceCameraOnDragStart=!0,this._surfaceMagnetismBehavior.attach(e,this._scene),i&&(this._surfaceMagnetismBehavior.meshes=i),this._surfaceMagnetismBehavior.enabled=!1}detach(){this.attachedNode=null,this._removeObservables(),this._followBehavior.detach(),this._sixDofDragBehavior.detach(),this._surfaceMagnetismBehavior.detach()}_addObservables(){this._onBeforeRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{this._followBehavior._enabled=!this._sixDofDragBehavior.isMoving&&this.followBehaviorEnabled})),this._onDragObserver=this._sixDofDragBehavior.onDragObservable.add((e=>{this._sixDofDragBehavior.disableMovement=this._surfaceMagnetismBehavior.findAndUpdateTarget(e.pickInfo)}))}_removeObservables(){this._scene.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._sixDofDragBehavior.onDragObservable.remove(this._onDragObserver)}}var Zu,Ju;!function(e){e[e.Origin=0]="Origin",e[e.Pivot=1]="Pivot"}(Zu||(Zu={})),function(e){e[e.World=0]="World",e[e.Local=1]="Local"}(Ju||(Ju={}));class e_{set scaleRatio(e){this._scaleRatio=e}get scaleRatio(){return this._scaleRatio}get isHovered(){return this._isHovered}get attachedMesh(){return this._attachedMesh}set attachedMesh(e){this._attachedMesh=e,e&&(this._attachedNode=e),this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}get attachedNode(){return this._attachedNode}set attachedNode(e){this._attachedNode=e,this._attachedMesh=null,this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach((e=>{e.dispose()})),e.parent=this._rootMesh,this._customMeshSet=!0}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){this._coordinatesMode=e;const t=e==Ju.Local;this.updateGizmoRotationToMatchAttachedMesh=t,this.updateGizmoPositionToMatchAttachedMesh=!0}get coordinatesMode(){return this._coordinatesMode}set updateScale(e){this._updateScale=e}get updateScale(){return this._updateScale}_attachedNodeChanged(e){}constructor(e=Aa.DefaultUtilityLayer){this.gizmoLayer=e,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this._updateGizmoPositionToMatchAttachedMesh=!0,this._anchorPoint=Zu.Origin,this._updateScale=!0,this._coordinatesMode=Ju.Local,this._interactionsEnabled=!0,this._rightHandtoLeftHandMatrix=Te.RotationY(Math.PI),this._rootMesh=new jn("gizmoRootNode",e.utilityLayerScene),this._rootMesh.rotationQuaternion=ve.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add((()=>{this._update()}))}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e}_update(){if(this.attachedNode){let e=this.attachedNode;if(this.attachedMesh&&(e=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh)if(this.anchorPoint==Zu.Pivot&&e.getAbsolutePivotPoint){const t=e.getAbsolutePivotPoint();this._rootMesh.position.copyFrom(t)}else{const t=e.getWorldMatrix().getRow(3),i=t?t.toVector3():new me(0,0,0);this._rootMesh.position.copyFrom(i)}if(this.updateGizmoRotationToMatchAttachedMesh){const t=e._isMesh||"AbstractMesh"===e.getClassName()||"TransformNode"===e.getClassName()||"InstancedMesh"===e.getClassName()?e:void 0;e.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,e_.PreserveScaling?t:void 0),this._rootMesh.rotationQuaternion.normalize()}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){const t=this.gizmoLayer.utilityLayerScene.activeCamera,i=t.globalPosition;this._rootMesh.position.subtractToRef(i,Ee.Vector3[0]);let s=this.scaleRatio;if(t.mode==Gt.ORTHOGRAPHIC_CAMERA)t.orthoTop&&t.orthoBottom&&(s*=t.orthoTop-t.orthoBottom);else{const e=t.getScene().useRightHandedSystem?me.RightHandedForwardReadOnly:me.LeftHandedForwardReadOnly,i=t.getDirection(e);s*=me.Dot(Ee.Vector3[0],i)}this._rootMesh.scaling.setAll(s),e._getWorldMatrixDeterminant()<0&&!e_.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}}_handlePivotMatrixInverse(e,t,i){if(e.isUsingPivotMatrix()&&!e.isUsingPostMultiplyPivotMatrix())return e.getPivotMatrix().invertToRef(Ee.Matrix[5]),void Ee.Matrix[5].multiplyToRef(t,i);i.copyFrom(t)}_matrixChanged(){if(this._attachedNode)if(this._attachedNode._isCamera){const e=this._attachedNode;let t,i;if(e.parent){const i=Ee.Matrix[1];e.parent._worldMatrix.invertToRef(i),this._attachedNode._worldMatrix.multiplyToRef(i,Ee.Matrix[0]),t=Ee.Matrix[0]}else t=this._attachedNode._worldMatrix;if(e.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(t,Ee.Matrix[1]),i=Ee.Matrix[1]):i=t,i.decompose(Ee.Vector3[1],Ee.Quaternion[0],Ee.Vector3[0]),"FreeCamera"===this._attachedNode.getClassName()||"FlyCamera"===this._attachedNode.getClassName()||"ArcFollowCamera"===this._attachedNode.getClassName()||"TargetCamera"===this._attachedNode.getClassName()||"TouchCamera"===this._attachedNode.getClassName()||"UniversalCamera"===this._attachedNode.getClassName()){const e=this._attachedNode;e.rotation=Ee.Quaternion[0].toEulerAngles(),e.rotationQuaternion&&(e.rotationQuaternion.copyFrom(Ee.Quaternion[0]),e.rotationQuaternion.normalize())}e.position.copyFrom(Ee.Vector3[0])}else if(this._attachedNode._isMesh||"AbstractMesh"===this._attachedNode.getClassName()||"TransformNode"===this._attachedNode.getClassName()||"InstancedMesh"===this._attachedNode.getClassName()){const e=this._attachedNode;if(e.parent){const t=Ee.Matrix[0],i=Ee.Matrix[1];e.parent.getWorldMatrix().invertToRef(t),this._attachedNode.getWorldMatrix().multiplyToRef(t,i);const s=Ee.Matrix[4];if(this._handlePivotMatrixInverse(e,i,s),s.decompose(Ee.Vector3[0],Ee.Quaternion[0],e.position,e_.PreserveScaling?e:void 0,e_.UseAbsoluteScaling),Ee.Quaternion[0].normalize(),e.isUsingPivotMatrix()){const t=Ee.Quaternion[1];ve.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,t);const i=Ee.Matrix[2];Te.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,i);const s=Ee.Matrix[2];t.toRotationMatrix(s);const n=e.getPivotMatrix(),r=Ee.Matrix[3];n.invertToRef(r),n.multiplyToRef(i,Ee.Matrix[4]),Ee.Matrix[4].multiplyToRef(s,Ee.Matrix[5]),Ee.Matrix[5].multiplyToRef(r,Ee.Matrix[6]),Ee.Matrix[6].getTranslationToRef(Ee.Vector3[1]),e.position.subtractInPlace(Ee.Vector3[1])}}else{const t=Ee.Matrix[4];this._handlePivotMatrixInverse(e,this._attachedNode._worldMatrix,t),t.decompose(Ee.Vector3[0],Ee.Quaternion[0],e.position,e_.PreserveScaling?e:void 0,e_.UseAbsoluteScaling)}Ee.Vector3[0].scaleInPlace(1/e.scalingDeterminant),e.scaling.copyFrom(Ee.Vector3[0]),e.billboardMode||(e.rotationQuaternion?(e.rotationQuaternion.copyFrom(Ee.Quaternion[0]),e.rotationQuaternion.normalize()):e.rotation=Ee.Quaternion[0].toEulerAngles())}else if("Bone"===this._attachedNode.getClassName()){const e=this._attachedNode,t=e.getParent();if(t){const i=Ee.Matrix[0],s=Ee.Matrix[1];t.getFinalMatrix().invertToRef(i),e.getFinalMatrix().multiplyToRef(i,s),e.getLocalMatrix().copyFrom(s)}else e.getLocalMatrix().copyFrom(e.getFinalMatrix());e.markAsDirty()}else{const e=this._attachedNode;if(e.getTypeID){const t=e.getTypeID();if(t===Lt.LIGHTTYPEID_DIRECTIONALLIGHT||t===Lt.LIGHTTYPEID_SPOTLIGHT||t===Lt.LIGHTTYPEID_POINTLIGHT){const t=e.parent;if(t){const i=Ee.Matrix[0],s=Ee.Matrix[1];t.getWorldMatrix().invertToRef(i),e.getWorldMatrix().multiplyToRef(i,s),s.decompose(void 0,Ee.Quaternion[0],Ee.Vector3[0])}else this._attachedNode._worldMatrix.decompose(void 0,Ee.Quaternion[0],Ee.Vector3[0]);e.position=new me(Ee.Vector3[0].x,Ee.Vector3[0].y,Ee.Vector3[0].z),e.direction&&(e.direction=new me(e.direction.x,e.direction.y,e.direction.z))}}}}_setGizmoMeshMaterial(e,t){e&&e.forEach((e=>{e.material=t,e.color&&(e.color=t.diffuseColor)}))}static GizmoAxisPointerObserver(e,t){let i=!1;return e.utilityLayerScene.onPointerObservable.add((e=>{var s,n;if(e.pickInfo){if(e.type===ci.POINTERMOVE){if(i)return;t.forEach((t=>{var i,s;if(t.colliderMeshes&&t.gizmoMeshes){const n=-1!=(null===(i=t.colliderMeshes)||void 0===i?void 0:i.indexOf(null===(s=null==e?void 0:e.pickInfo)||void 0===s?void 0:s.pickedMesh)),r=t.dragBehavior.enabled?n||t.active?t.hoverMaterial:t.material:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=r,e.color&&(e.color=r.diffuseColor)}))}}))}e.type===ci.POINTERDOWN&&t.has(null===(s=e.pickInfo.pickedMesh)||void 0===s?void 0:s.parent)&&(i=!0,t.get(null===(n=e.pickInfo.pickedMesh)||void 0===n?void 0:n.parent).active=!0,t.forEach((t=>{var i,s;const n=(-1!=(null===(i=t.colliderMeshes)||void 0===i?void 0:i.indexOf(null===(s=null==e?void 0:e.pickInfo)||void 0===s?void 0:s.pickedMesh))||t.active)&&t.dragBehavior.enabled?t.hoverMaterial:t.disableMaterial;t.gizmoMeshes.forEach((e=>{e.material=n,e.color&&(e.color=n.diffuseColor)}))}))),e.type===ci.POINTERUP&&t.forEach((e=>{e.active=!1,i=!1,e.gizmoMeshes.forEach((t=>{t.material=e.dragBehavior.enabled?e.material:e.disableMaterial,t.color&&(t.color=e.material.diffuseColor)}))}))}}))}dispose(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)}}e_.PreserveScaling=!1,e_.UseAbsoluteScaling=!0;class t_{static _RemoveAndStorePivotPoint(e){e&&0===t_._PivotCached&&(e.getPivotPointToRef(t_._OldPivotPoint),t_._PivotPostMultiplyPivotMatrix=e._postMultiplyPivotMatrix,t_._OldPivotPoint.equalsToFloats(0,0,0)||(e.setPivotMatrix(Te.IdentityReadOnly),t_._OldPivotPoint.subtractToRef(e.getPivotPoint(),t_._PivotTranslation),t_._PivotTmpVector.copyFromFloats(1,1,1),t_._PivotTmpVector.subtractInPlace(e.scaling),t_._PivotTmpVector.multiplyInPlace(t_._PivotTranslation),e.position.addInPlace(t_._PivotTmpVector))),t_._PivotCached++}static _RestorePivotPoint(e){e&&!t_._OldPivotPoint.equalsToFloats(0,0,0)&&1===t_._PivotCached&&(e.setPivotPoint(t_._OldPivotPoint),e._postMultiplyPivotMatrix=t_._PivotPostMultiplyPivotMatrix,t_._PivotTmpVector.copyFromFloats(1,1,1),t_._PivotTmpVector.subtractInPlace(e.scaling),t_._PivotTmpVector.multiplyInPlace(t_._PivotTranslation),e.position.subtractInPlace(t_._PivotTmpVector)),this._PivotCached--}}t_._PivotCached=0,t_._OldPivotPoint=new me,t_._PivotTranslation=new me,t_._PivotTmpVector=new me,t_._PivotPostMultiplyPivotMatrix=!1;F.ShadersStore.handleVertexShader="precision highp float;attribute vec3 position;uniform vec3 positionOffset;uniform mat4 worldViewProjection;uniform float scale;void main(void) {vec4 vPos=vec4((vec3(position)+positionOffset)*scale,1.0);gl_Position=worldViewProjection*vPos;}";F.ShadersStore.handlePixelShader="uniform vec3 color;void main(void) {gl_FragColor=vec4(color,1.0);}";class i_ extends Al{get hover(){return this._hover}set hover(e){this._hover=e,this._updateInterpolationTarget()}get drag(){return this._drag}set drag(e){this._drag=e,this._updateInterpolationTarget()}constructor(e,t){super(e,t,"handle",{attributes:["position"],uniforms:["worldViewProjection","color","scale","positionOffset"],needAlphaBlending:!1,needAlphaTesting:!1}),this._hover=!1,this._drag=!1,this._color=new Re,this._scale=1,this._lastTick=-1,this.animationLength=100,this.hoverColor=new Re(0,.467,.84),this.baseColor=new Re(1,1,1),this.hoverScale=.75,this.baseScale=.35,this.dragScale=.55,this._positionOffset=me.Zero(),this._updateInterpolationTarget(),this._lastTick=Date.now(),this._onBeforeRender=this.getScene().onBeforeRenderObservable.add((()=>{const e=Date.now(),t=e-this._lastTick,i=this._targetScale-this._scale,s=Pe.Color3[0].copyFrom(this._targetColor).subtractToRef(this._color,Pe.Color3[0]);this._scale=this._scale+i*t/this.animationLength,s.scaleToRef(t/this.animationLength,s),this._color.addToRef(s,this._color),this.setColor3("color",this._color),this.setFloat("scale",this._scale),this.setVector3("positionOffset",this._positionOffset),this._lastTick=e}))}_updateInterpolationTarget(){this.drag?(this._targetColor=this.hoverColor,this._targetScale=this.dragScale):this.hover?(this._targetColor=this.hoverColor,this._targetScale=this.hoverScale):(this._targetColor=this.baseColor,this._targetScale=this.baseScale)}dispose(){super.dispose(),this.getScene().onBeforeRenderObservable.remove(this._onBeforeRender)}}var s_;!function(e){e[e.IDLE=0]="IDLE",e[e.HOVER=1]="HOVER",e[e.DRAG=2]="DRAG"}(s_||(s_={}));class n_{get state(){return this._state}get gizmo(){return this._gizmo}set hover(e){e?this._state|=s_.HOVER:this._state&=~s_.HOVER,this._updateMaterial()}set drag(e){e?this._state|=s_.DRAG:this._state&=~s_.DRAG,this._updateMaterial()}constructor(e,t){this._state=s_.IDLE,this._materials=[],this._scene=t,this._gizmo=e,this.node=this.createNode(),this.node.reservedDataStore={handle:this}}_createMaterial(e){const t=new i_("handle",this._scene);return e&&(t._positionOffset=e),t}_updateMaterial(){const e=this._state;for(const e of this._materials)e.hover=!1,e.drag=!1;if(e&s_.DRAG)for(const e of this._materials)e.drag=!0;else if(e&s_.HOVER)for(const e of this._materials)e.hover=!0}setDragBehavior(e,t,i){const s=new Ku;this._dragBehavior=s,this._dragStartObserver=s.onDragStartObservable.add(e),this._draggingObserver=s.onDragObservable.add(t),this._dragEndObserver=s.onDragEndObservable.add(i),this._dragBehavior.attach(this.node)}dispose(){this._dragBehavior.onDragStartObservable.remove(this._dragStartObserver),this._dragBehavior.onDragObservable.remove(this._draggingObserver),this._dragBehavior.onDragEndObservable.remove(this._dragEndObserver),this._dragBehavior.detach();for(const e of this._materials)e.dispose();this.node.dispose()}}class r_ extends n_{createNode(){const e=Fr("sideVert",{width:1,height:10,depth:.1},this._scene),t=new Bn("side",this._scene);e.parent=t;const i=this._createMaterial();return e.material=i,e.isNearGrabbable=!0,this._materials.push(i),t}}class o_ extends n_{createNode(){const e=Fr("angleHor",{width:3,height:1,depth:.1},this._scene),t=Fr("angleVert",{width:1,height:3,depth:.1},this._scene),i=new Bn("angle",this._scene);return e.parent=i,t.parent=i,e.material=this._createMaterial(new me(1,0,0)),t.material=this._createMaterial(new me(0,1,0)),t.isNearGrabbable=!0,e.isNearGrabbable=!0,this._materials.push(e.material),this._materials.push(t.material),i}}class a_ extends e_{set attachedSlate(e){e?(this.attachedMesh=e.mesh,this.updateBoundingBox(),this._pickedPointObserver=e._host.onPickingObservable.add((e=>{if(!this._handleHovered||e&&e.parent===this._handleHovered.node||(this._handleHovered.hover=!1,this._handleHovered=null),e&&e.parent&&e.parent.reservedDataStore&&e.parent.reservedDataStore.handle){const t=e.parent.reservedDataStore.handle;t.gizmo===this&&(this._handleHovered=t,this._handleHovered.hover=!0)}}))):this._attachedSlate&&this._attachedSlate._host.onPickingObservable.remove(this._pickedPointObserver),this._attachedSlate=e}get attachedSlate(){return this._attachedSlate}constructor(e){super(e),this._boundingDimensions=new me(0,0,0),this._renderObserver=null,this._tmpQuaternion=new ve,this._tmpVector=new me(0,0,0),this._corners=[],this._sides=[],this._boundingBoxGizmo={min:new me,max:new me},this._margin=.35,this._handleSize=.075,this._attachedSlate=null,this._existingSlateScale=new me,this.fixedScreenSize=!1,this.fixedScreenSizeDistanceFactor=10,this._createNode(),this.updateScale=!1,this._renderObserver=this.gizmoLayer.originalScene.onBeforeRenderObservable.add((()=>{this.attachedMesh&&!this._existingSlateScale.equals(this.attachedMesh.scaling)&&this.updateBoundingBox()}))}_createNode(){this._handlesParent=new Bn("handlesParent",this.gizmoLayer.utilityLayerScene),this._handlesParent.rotationQuaternion=ve.Identity();const e=[{dimensions:new me(-1,-1,0),origin:new me(1,0,0)},{dimensions:new me(1,-1,0),origin:new me(0,0,0)},{dimensions:new me(1,1,0),origin:new me(0,1,0)},{dimensions:new me(-1,1,0),origin:new me(1,1,0)}];for(let t=0;t<4;t++){const i=new o_(this,this.gizmoLayer.utilityLayerScene);this._corners.push(i),i.node.rotation.z=Math.PI/2*t,i.node.parent=this._handlesParent,this._assignDragBehaviorCorners(i,((e,t,i,s)=>this._moveHandle(e,t,i,s,!0)),e[t])}for(let e=0;e<4;e++){const t=new r_(this,this.gizmoLayer.utilityLayerScene);this._sides.push(t),t.node.rotation.z=Math.PI/2*e,t.node.parent=this._handlesParent,this._assignDragBehaviorSides(t,e%2==0?new me(0,1,0):new me(1,0,0))}this._handlesParent.parent=this._rootMesh}_keepAspectRatio(e,t,i=!1){const s=Ee.Vector3[0];s.copyFromFloats(t,1,0).normalize(),i&&(s.y*=-1);const n=me.Dot(e,s);e.copyFrom(s).scaleInPlace(n)}_clampDimensions(e,t,i,s=!1){const n=Ee.Vector3[0];n.copyFrom(e).multiplyInPlace(i);const r=Ee.Vector3[1];if(r.copyFromFloats(Math.max(this._attachedSlate.minDimensions.x,n.x+t.x),Math.max(this._attachedSlate.minDimensions.y,n.y+t.y),0),s){const e=t.x/t.y;r.x=Math.max(r.x,r.y*e),r.y=Math.max(r.y,r.x/e)}n.copyFrom(r).subtractInPlace(t),e.x=Math.sign(e.x)*Math.abs(n.x),e.y=Math.sign(e.y)*Math.abs(n.y)}_moveHandle(e,t,i,s,n){if(!this._attachedSlate)return;if(n){const e=t.x/t.y;this._keepAspectRatio(i,e,s.dimensions.x*s.dimensions.y<0)}this._clampDimensions(i,t,s.dimensions,n);const r=Ee.Vector3[0],o=Ee.Vector3[1];r.copyFrom(i).multiplyInPlace(s.origin),o.copyFrom(i).multiplyInPlace(s.dimensions),this._attachedSlate.origin.copyFrom(e).addInPlace(r),this._attachedSlate.dimensions.set(t.x+o.x,t.y+o.y)}_assignDragBehaviorCorners(e,t,i){const s=new me,n=new me,r=new me,o=new Te,a=new me;e.setDragBehavior((e=>{this.attachedSlate&&this.attachedMesh&&(s.set(this.attachedSlate.dimensions.x,this.attachedSlate.dimensions.y,ae),n.copyFrom(this.attachedSlate.origin),r.copyFrom(e.position),o.copyFrom(this.attachedMesh.computeWorldMatrix(!0)),o.invert(),this.attachedSlate._followButton.isToggled=!1,me.TransformNormalToRef(me.Forward(),this.attachedMesh.getWorldMatrix(),a),a.normalize(),this._handleHovered&&(this._handleDragged=this._handleHovered,this._handleDragged.drag=!0))}),(e=>{this.attachedSlate&&this.attachedMesh&&(((e,t,i,s)=>{e.subtractToRef(i,Ee.Vector3[0]);const n=me.Dot(Ee.Vector3[0],t);Ee.Vector3[1].copyFrom(t).scaleInPlace(n),Ee.Vector3[0].subtractInPlace(Ee.Vector3[1]),Ee.Vector3[0].addToRef(i,s)})(e.position,a,r,this._tmpVector),this._tmpVector.subtractInPlace(r),me.TransformNormalToRef(this._tmpVector,o,this._tmpVector),t(n,s,this._tmpVector,i),this.attachedSlate._positionElements(),this.updateBoundingBox())}),(()=>{this.attachedSlate&&this.attachedNode&&(this.attachedSlate._updatePivot(),this._handleDragged&&(this._handleDragged.drag=!1,this._handleDragged=null))}))}_assignDragBehaviorSides(e,t){const i=new ve,s=new me,n=new me,r=new me,o=new me;e.setDragBehavior((e=>{this.attachedSlate&&this.attachedMesh&&(i.copyFrom(this.attachedMesh.rotationQuaternion),s.copyFrom(e.position),r.copyFrom(this.attachedMesh.getAbsolutePivotPoint()),n.copyFrom(s).subtractInPlace(r).normalize(),this.attachedSlate._followButton.isToggled=!1,me.TransformNormalToRef(t,this.attachedMesh.getWorldMatrix(),o),o.normalize(),this._handleHovered&&(this._handleDragged=this._handleHovered,this._handleDragged.drag=!0))}),(e=>{if(this.attachedSlate&&this.attachedMesh){this._tmpVector.copyFrom(e.position),this._tmpVector.subtractInPlace(r),this._tmpVector.normalize();const s=-me.GetAngleBetweenVectorsOnPlane(this._tmpVector,n,o);ve.RotationAxisToRef(t,s,this._tmpQuaternion),i.multiplyToRef(this._tmpQuaternion,this.attachedMesh.rotationQuaternion)}}),(()=>{this.attachedSlate&&this.attachedNode&&(this.attachedSlate._updatePivot(),this._handleDragged&&(this._handleDragged.drag=!1,this._handleDragged=null))}))}_attachedNodeChanged(e){e&&this.updateBoundingBox()}updateBoundingBox(){if(this.attachedMesh){t_._RemoveAndStorePivotPoint(this.attachedMesh);const e=this.attachedMesh.parent;this.attachedMesh.setParent(null),this._update(),this.attachedMesh.rotationQuaternion||(this.attachedMesh.rotationQuaternion=ve.RotationYawPitchRoll(this.attachedMesh.rotation.y,this.attachedMesh.rotation.x,this.attachedMesh.rotation.z)),this._tmpQuaternion.copyFrom(this.attachedMesh.rotationQuaternion),this._tmpVector.copyFrom(this.attachedMesh.position),this.attachedMesh.rotationQuaternion.set(0,0,0,1),this.attachedMesh.position.set(0,0,0);const t=this.attachedMesh.getHierarchyBoundingVectors();t.max.subtractToRef(t.min,this._boundingDimensions),this._boundingBoxGizmo.min=t.min,this._boundingBoxGizmo.max=t.max,this._updateHandlesPosition(),this._updateHandlesScaling(),this.attachedMesh.rotationQuaternion.copyFrom(this._tmpQuaternion),this.attachedMesh.position.copyFrom(this._tmpVector),t_._RestorePivotPoint(this.attachedMesh),this.attachedMesh.setParent(e),this.attachedMesh.computeWorldMatrix(!0),this._existingSlateScale.copyFrom(this.attachedMesh.scaling)}}_updateHandlesPosition(){const e=this._boundingBoxGizmo.min.clone(),t=this._boundingBoxGizmo.max.clone(),i=this._corners[0].node.scaling.length();e.x-=this._margin*i,e.y-=this._margin*i,t.x+=this._margin*i,t.y+=this._margin*i;const s=e.add(t).scaleInPlace(.5);this._corners[0].node.position.copyFromFloats(e.x,e.y,0),this._corners[1].node.position.copyFromFloats(t.x,e.y,0),this._corners[2].node.position.copyFromFloats(t.x,t.y,0),this._corners[3].node.position.copyFromFloats(e.x,t.y,0),this._sides[0].node.position.copyFromFloats(e.x,s.y,0),this._sides[1].node.position.copyFromFloats(s.x,e.y,0),this._sides[2].node.position.copyFromFloats(t.x,s.y,0),this._sides[3].node.position.copyFromFloats(s.x,t.y,0)}_updateHandlesScaling(){if(this._attachedSlate&&this._attachedSlate.mesh){const e=this._attachedSlate.mesh.scaling.x*this._attachedSlate.dimensions.x,t=this._attachedSlate.mesh.scaling.y*this._attachedSlate.dimensions.y,i=Math.min(e,t)*this._handleSize;for(let e=0;e<this._corners.length;e++)this._corners[e].node.scaling.setAll(i);for(let e=0;e<this._sides.length;e++)this._sides[e].node.scaling.setAll(i)}}_update(){if(super._update(),this.gizmoLayer.utilityLayerScene.activeCamera&&this._attachedSlate&&this._attachedSlate.mesh){if(this.fixedScreenSize){this._attachedSlate.mesh.absolutePosition.subtractToRef(this.gizmoLayer.utilityLayerScene.activeCamera.position,this._tmpVector);const e=this._handleSize*this._tmpVector.length()/this.fixedScreenSizeDistanceFactor;for(let t=0;t<this._corners.length;t++)this._corners[t].node.scaling.set(e,e,e);for(let t=0;t<this._sides.length;t++)this._sides[t].node.scaling.set(e,e,e)}this._updateHandlesPosition()}}dispose(){this.gizmoLayer.originalScene.onBeforeRenderObservable.remove(this._renderObserver),super.dispose();for(const e of this._corners)e.dispose();for(const e of this._sides)e.dispose()}}class l_{get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}set enabled(e){e!=this._enabled&&this.onEnabledObservable.notifyObservers(e),this._enabled=e}get enabled(){return this._enabled}get options(){return this._options}set options(e){this._options=e}constructor(e){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this._activeDragButton=-1,this.maxDragAngle=0,this.dragButtons=[0,1,2],this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new s,this.onDragStartObservable=new s,this.onDragEndObservable=new s,this.onEnabledObservable=new s,this.moveAttached=!0,this._enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=e=>!0,this._tmpVector=new me(0,0,0),this._alternatePickedPoint=new me(0,0,0),this._worldDragAxis=new me(0,0,0),this._targetPosition=new me(0,0,0),this._attachedToElement=!1,this._startDragRay=new lo(new me,new me),this._lastPointerRay={},this._dragDelta=new me,this._pointA=new me(0,0,0),this._pointC=new me(0,0,0),this._localAxis=new me(0,0,0),this._lookAt=new me(0,0,0),this._options=e||{};let t=0;if(this._options.dragAxis&&t++,this._options.dragPlaneNormal&&t++,t>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}get name(){return"PointerDrag"}init(){}attach(e,t){this._scene=e.getScene(),e.isNearGrabbable=!0,this.attachedNode=e,l_._PlaneScene||(this._debugMode?l_._PlaneScene=this._scene:(l_._PlaneScene=new Oi(this._scene.getEngine(),{virtual:!0}),l_._PlaneScene.detachControl(),this._scene.onDisposeObservable.addOnce((()=>{l_._PlaneScene.dispose(),l_._PlaneScene=null})))),this._dragPlane=Rr("pointerDragPlane",{size:this._debugMode?1:1e4,updatable:!1,sideOrientation:jn.DOUBLESIDE},l_._PlaneScene),this.lastDragPosition=new me(0,0,0);const i=t||(e=>this.attachedNode==e||e.isDescendantOf(this.attachedNode));this._pointerObserver=this._scene.onPointerObservable.add((e=>{if(this.enabled){if(e.type==ci.POINTERDOWN)this.startAndReleaseDragOnPointerEvents&&!this.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&i(e.pickInfo.pickedMesh)&&-1===this._activeDragButton&&-1!==this.dragButtons.indexOf(e.event.button)&&(this._activeDragButton=e.event.button,this._activePointerInfo=e,this._startDrag(e.event.pointerId,e.pickInfo.ray,e.pickInfo.pickedPoint));else if(e.type==ci.POINTERUP)!this.startAndReleaseDragOnPointerEvents||this.currentDraggingPointerId!=e.event.pointerId||this._activeDragButton!==e.event.button&&-1!==this._activeDragButton||this.releaseDrag();else if(e.type==ci.POINTERMOVE){const t=e.event.pointerId;if(this.currentDraggingPointerId===l_._AnyMouseId&&t!==l_._AnyMouseId){const i=e.event;("mouse"===i.pointerType||!this._scene.getEngine().hostInformation.isMobile&&i instanceof MouseEvent)&&(this._lastPointerRay[this.currentDraggingPointerId]&&(this._lastPointerRay[t]=this._lastPointerRay[this.currentDraggingPointerId],delete this._lastPointerRay[this.currentDraggingPointerId]),this.currentDraggingPointerId=t)}this._lastPointerRay[t]||(this._lastPointerRay[t]=new lo(new me,new me)),e.pickInfo&&e.pickInfo.ray&&(this._lastPointerRay[t].origin.copyFrom(e.pickInfo.ray.origin),this._lastPointerRay[t].direction.copyFrom(e.pickInfo.ray.direction),this.currentDraggingPointerId==t&&this.dragging&&this._moveDrag(e.pickInfo.ray))}}else this._attachedToElement&&this.releaseDrag()})),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add((()=>{if(this._moving&&this.moveAttached){let e=!1;t_._RemoveAndStorePivotPoint(this.attachedNode),this._targetPosition.subtractToRef(this.attachedNode.absolutePosition,this._tmpVector),this._tmpVector.scaleInPlace(this.dragDeltaRatio),this.attachedNode.getAbsolutePosition().addToRef(this._tmpVector,this._tmpVector),this.validateDrag(this._tmpVector)&&(this.attachedNode.setAbsolutePosition(this._tmpVector),e=!0),t_._RestorePivotPoint(this.attachedNode),e&&this.attachedNode.computeWorldMatrix()}}))}releaseDrag(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo})),this.currentDraggingPointerId=-1,this._activeDragButton=-1,this._activePointerInfo=null,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if("ArcRotateCamera"===this._scene.activeCamera.getClassName()){const e=this._scene.activeCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._scene.activeCamera.attachControl(!this._scene.activeCamera.inputs||this._scene.activeCamera.inputs.noPreventDefault);this._attachedToElement=!1}}startDrag(e=l_._AnyMouseId,t,i){this._startDrag(e,t,i);let s=this._lastPointerRay[e];e===l_._AnyMouseId&&(s=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),s&&this._moveDrag(s)}_startDrag(e,t,i){if(!this._scene.activeCamera||this.dragging||!this.attachedNode)return;t_._RemoveAndStorePivotPoint(this.attachedNode),t?(this._startDragRay.direction.copyFrom(t.direction),this._startDragRay.origin.copyFrom(t.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,i||this._tmpVector);const s=this._pickWithRayOnDragPlane(this._startDragRay);s?(this.dragging=!0,this.currentDraggingPointerId=e,this.lastDragPosition.copyFrom(s),this.onDragStartObservable.notifyObservers({dragPlanePoint:s,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)):this.releaseDrag(),t_._RestorePivotPoint(this.attachedNode)}_moveDrag(e){this._moving=!0;const t=this._pickWithRayOnDragPlane(e);if(t){t_._RemoveAndStorePivotPoint(this.attachedNode),this.updateDragPlane&&this._updateDragPlanePosition(e,t);let i=0;this._options.dragAxis?(this.useObjectOrientationForDragging?me.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),t.subtractToRef(this.lastDragPosition,this._tmpVector),i=me.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(i,this._dragDelta)):(i=this._dragDelta.length(),t.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:i,delta:this._dragDelta,dragPlanePoint:t,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this.lastDragPosition.copyFrom(t),t_._RestorePivotPoint(this.attachedNode)}}_pickWithRayOnDragPlane(e){if(!e)return null;let t=Math.acos(me.Dot(this._dragPlane.forward,e.direction));if(t>Math.PI/2&&(t=Math.PI-t),this.maxDragAngle>0&&t>this.maxDragAngle){if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(e.direction),this.attachedNode.absolutePosition.subtractToRef(e.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*me.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);const t=me.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-t,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}return null}const i=this._dragPlane.forward,s=this._dragPlane.position,n=e.direction.dot(i);if(Math.abs(n)<ae)return null;s.subtractToRef(e.origin,Ee.Vector3[0]);const r=Ee.Vector3[0].dot(i)/n;return r<0?null:(e.direction.scaleToRef(r,Ee.Vector3[0]),e.origin.add(Ee.Vector3[0]))}_updateDragPlanePosition(e,t){this._pointA.copyFrom(t),this._options.dragAxis?(this.useObjectOrientationForDragging?me.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),e.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(me.Dot(this._localAxis,this._pointC))>.999?Math.abs(me.Dot(me.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(me.Right()):this._lookAt.copyFrom(me.UpReadOnly):(me.CrossToRef(this._localAxis,this._pointC,this._lookAt),me.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?me.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(e.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)}detach(){this._lastPointerRay={},this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._dragPlane&&this._dragPlane.dispose(),this.releaseDrag()}}l_._AnyMouseId=-2;class h_ extends gu{get defaultBehavior(){return this._defaultBehavior}get dimensions(){return this._dimensions}set dimensions(e){let t=1;if(e.x<this.minDimensions.x||e.y<this.minDimensions.y){const i=e.x/e.y;t=this.minDimensions.x/this.minDimensions.y>i?this.minDimensions.x/e.x:this.minDimensions.y/e.y}this._dimensions.copyFrom(e).scaleInPlace(t),this._updatePivot(),this._positionElements()}get titleBarHeight(){return this._titleBarHeight}set titleBarHeight(e){this._titleBarHeight=e}set renderingGroupId(e){this._titleBar.renderingGroupId=e,this._titleBarTitle.renderingGroupId=e,this._contentPlate.renderingGroupId=e,this._backPlate.renderingGroupId=e}get renderingGroupId(){return this._titleBar.renderingGroupId}set title(e){this._titleText=e,this._titleTextComponent&&(this._titleTextComponent.text=e)}get title(){return this._titleText}constructor(e){super(e),this.titleBarMargin=.005,this.origin=new me(0,0,0),this._dimensions=new pe(21.875,12.5),this._titleBarHeight=.625,this._titleText="",this._contentScaleRatio=1,this.minDimensions=new pe(15.625,6.25),this.defaultDimensions=this._dimensions.clone(),this._followButton=new Qu("followButton"+this.name),this._followButton.isToggleButton=!0,this._closeButton=new Qu("closeButton"+this.name),this._contentViewport=new Ut(0,0,1,1),this._contentDragBehavior=new l_({dragPlaneNormal:new me(0,0,-1)})}_applyFacade(e){this._contentMaterial.albedoTexture=e,this._resetContentPositionAndZoom(),this._applyContentViewport(),e.attachToMesh(this._contentPlate,!0)}_addControl(e){e._host=this._host,this._host.utilityLayer&&e._prepareNode(this._host.utilityLayer.utilityLayerScene)}_getTypeName(){return"HolographicSlate"}_positionElements(){const e=this._followButton,t=this._closeButton,i=this._titleBar,s=this._titleBarTitle,n=this._contentPlate,r=this._backPlate;if(e&&t&&i){t.scaling.setAll(this.titleBarHeight),e.scaling.setAll(this.titleBarHeight),t.position.copyFromFloats(this.dimensions.x-this.titleBarHeight/2,-this.titleBarHeight/2,0).addInPlace(this.origin),e.position.copyFromFloats(this.dimensions.x-3*this.titleBarHeight/2,-this.titleBarHeight/2,0).addInPlace(this.origin);const o=this.dimensions.y-this.titleBarHeight-this.titleBarMargin,a=n.getScene().useRightHandedSystem;i.scaling.set(this.dimensions.x,this.titleBarHeight,ae),s.scaling.set(this.dimensions.x-2*this.titleBarHeight,this.titleBarHeight,ae),n.scaling.copyFromFloats(this.dimensions.x,o,ae),r.scaling.copyFromFloats(this.dimensions.x,o,ae),i.position.copyFromFloats(this.dimensions.x/2,-this.titleBarHeight/2,0).addInPlace(this.origin),s.position.copyFromFloats(this.dimensions.x/2-this.titleBarHeight,-this.titleBarHeight/2,a?ae:-ae).addInPlace(this.origin),n.position.copyFromFloats(this.dimensions.x/2,-(this.titleBarHeight+this.titleBarMargin+o/2),0).addInPlace(this.origin),r.position.copyFromFloats(this.dimensions.x/2,-(this.titleBarHeight+this.titleBarMargin+o/2),a?-ae:ae).addInPlace(this.origin),this._titleTextComponent.host.scaleTo(h_._DEFAULT_TEXT_RESOLUTION_Y*s.scaling.x/s.scaling.y,h_._DEFAULT_TEXT_RESOLUTION_Y);const l=this.dimensions.x/o;this._contentViewport.width=this._contentScaleRatio,this._contentViewport.height=this._contentScaleRatio/l,this._applyContentViewport(),this._gizmo&&this._gizmo.updateBoundingBox()}}_applyContentViewport(){var e;if((null===(e=this._contentPlate)||void 0===e?void 0:e.material)&&this._contentPlate.material.albedoTexture){const e=this._contentPlate.material.albedoTexture;e.uScale=this._contentScaleRatio,e.vScale=this._contentScaleRatio/this._contentViewport.width*this._contentViewport.height,e.uOffset=this._contentViewport.x,e.vOffset=this._contentViewport.y}}_resetContentPositionAndZoom(){this._contentViewport.x=0,this._contentViewport.y=1-this._contentViewport.height/this._contentViewport.width,this._contentScaleRatio=1}_updatePivot(){if(!this.mesh)return;const e=new me(.5*this.dimensions.x,.5*-this.dimensions.y,ae);e.addInPlace(this.origin),e.z=0;const t=new me(0,0,0);me.TransformCoordinatesToRef(t,this.mesh.computeWorldMatrix(!0),t),this.mesh.setPivotPoint(e);const i=new me(0,0,0);me.TransformCoordinatesToRef(i,this.mesh.computeWorldMatrix(!0),i),this.mesh.position.addInPlace(t).subtractInPlace(i)}_createNode(e){const t=new jn("slate_"+this.name,e);this._titleBar=Fr("titleBar_"+this.name,{size:1},e),this._titleBarTitle=Rr("titleText_"+this.name,{size:1},e),this._titleBarTitle.parent=t,this._titleBarTitle.isPickable=!1;const i=fu.CreateForMesh(this._titleBarTitle);if(this._titleTextComponent=new Vd("titleText_"+this.name,this._titleText),this._titleTextComponent.textWrapping=kd.Ellipsis,this._titleTextComponent.textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,this._titleTextComponent.color="white",this._titleTextComponent.fontSize=h_._DEFAULT_TEXT_RESOLUTION_Y/2,this._titleTextComponent.paddingLeft=h_._DEFAULT_TEXT_RESOLUTION_Y/4,i.addControl(this._titleTextComponent),e.useRightHandedSystem){const t=new ge(0,0,1,1);this._contentPlate=Rr("contentPlate_"+this.name,{size:1,sideOrientation:Nn.BACKSIDE,frontUVs:t},e),this._backPlate=Rr("backPlate_"+this.name,{size:1,sideOrientation:Nn.FRONTSIDE},e)}else{const t=new ge(0,0,1,1);this._contentPlate=Rr("contentPlate_"+this.name,{size:1,sideOrientation:Nn.FRONTSIDE,frontUVs:t},e),this._backPlate=Rr("backPlate_"+this.name,{size:1,sideOrientation:Nn.BACKSIDE},e)}this._titleBar.parent=t,this._titleBar.isNearGrabbable=!0,this._contentPlate.parent=t,this._backPlate.parent=t,this._attachContentPlateBehavior(),this._addControl(this._followButton),this._addControl(this._closeButton);const s=this._followButton,n=this._closeButton;return s.node.parent=t,n.node.parent=t,this._positionElements(),this._followButton.imageUrl=h_.ASSETS_BASE_URL+h_.FOLLOW_ICON_FILENAME,this._closeButton.imageUrl=h_.ASSETS_BASE_URL+h_.CLOSE_ICON_FILENAME,this._followButton.isBackplateVisible=!1,this._closeButton.isBackplateVisible=!1,this._followButton.onToggleObservable.add((e=>{this._defaultBehavior.followBehaviorEnabled=e,this._defaultBehavior.followBehaviorEnabled&&this._defaultBehavior.followBehavior.recenter()})),this._closeButton.onPointerClickObservable.add((()=>{this.dispose()})),t.rotationQuaternion=ve.Identity(),t.isVisible=!1,t}_attachContentPlateBehavior(){this._contentDragBehavior.attach(this._contentPlate),this._contentDragBehavior.moveAttached=!1,this._contentDragBehavior.useObjectOrientationForDragging=!0,this._contentDragBehavior.updateDragPlane=!1;const e=new me,t=new me,i=new me,s=new me,n=new pe;let r,o;this._contentDragBehavior.onDragStartObservable.add((n=>{this.node&&(r=this._contentViewport.clone(),o=this.node.computeWorldMatrix(!0),e.copyFrom(n.dragPlanePoint),t.set(this.dimensions.x,this.dimensions.y,ae),t.y-=this.titleBarHeight+this.titleBarMargin,me.TransformNormalToRef(t,o,t),i.copyFromFloats(0,1,0),me.TransformNormalToRef(i,o,i),s.copyFromFloats(1,0,0),me.TransformNormalToRef(s,o,s),i.normalize(),i.scaleInPlace(1/me.Dot(i,t)),s.normalize(),s.scaleInPlace(1/me.Dot(s,t)))}));const a=new me;this._contentDragBehavior.onDragObservable.add((t=>{a.copyFrom(t.dragPlanePoint),a.subtractInPlace(e),n.copyFromFloats(me.Dot(a,s),me.Dot(a,i)),this._contentViewport.x=ne.Clamp(r.x-a.x,0,1-this._contentViewport.width*this._contentScaleRatio),this._contentViewport.y=ne.Clamp(r.y-a.y,0,1-this._contentViewport.height*this._contentScaleRatio),this._applyContentViewport()}))}_affectMaterial(e){this._titleBarMaterial=new Vu(`${this.name} plateMaterial`,e.getScene()),this._contentMaterial=new xu(`${this.name} contentMaterial`,e.getScene()),this._contentMaterial.renderBorders=!0,this._backMaterial=new Vu(`${this.name} backPlate`,e.getScene()),this._backMaterial.lineWidth=ae,this._backMaterial.radius=.005,this._backMaterial.backFaceCulling=!0,this._titleBar.material=this._titleBarMaterial,this._contentPlate.material=this._contentMaterial,this._backPlate.material=this._backMaterial,this._resetContent(),this._applyContentViewport()}_prepareNode(e){super._prepareNode(e),this._gizmo=new a_(this._host.utilityLayer),this._gizmo.attachedSlate=this,this._defaultBehavior=new qu,this._defaultBehavior.attach(this.node,[this._titleBar]),this._defaultBehavior.sixDofDragBehavior.onDragStartObservable.add((()=>{this._followButton.isToggled=!1})),this._positionChangedObserver=this._defaultBehavior.sixDofDragBehavior.onPositionChangedObservable.add((()=>{this._gizmo.updateBoundingBox()})),this._updatePivot(),this.resetDefaultAspectAndPose(!1)}resetDefaultAspectAndPose(e=!0){if(!this._host||!this._host.utilityLayer||!this.node)return;const t=this._host.utilityLayer.utilityLayerScene,i=t.activeCamera;if(i){const s=i.getWorldMatrix(),n=me.TransformNormal(me.Backward(t.useRightHandedSystem),s);this.origin.setAll(0),this._gizmo.updateBoundingBox();const r=this.node.getAbsolutePivotPoint();this.node.position.copyFrom(i.position).subtractInPlace(n).subtractInPlace(r),this.node.rotationQuaternion=ve.FromLookDirectionLH(n,new me(0,1,0)),e&&(this.dimensions=this.defaultDimensions)}}dispose(){super.dispose(),this._titleBarMaterial.dispose(),this._contentMaterial.dispose(),this._titleBar.dispose(),this._titleBarTitle.dispose(),this._contentPlate.dispose(),this._backPlate.dispose(),this._followButton.dispose(),this._closeButton.dispose(),this._host.onPickedPointChangedObservable.remove(this._pickedPointObserver),this._defaultBehavior.sixDofDragBehavior.onPositionChangedObservable.remove(this._positionChangedObserver),this._defaultBehavior.detach(),this._gizmo.dispose(),this._contentDragBehavior.detach()}}h_.ASSETS_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",h_.CLOSE_ICON_FILENAME="IconClose.png",h_.FOLLOW_ICON_FILENAME="IconFollowMe.png",h_._DEFAULT_TEXT_RESOLUTION_Y=102.4;class c_ extends Cu{get defaultBehavior(){return this._defaultBehavior}get isPinned(){return this._isPinned}set isPinned(e){this._pinButton.isToggled===e?(this._isPinned=e,this._defaultBehavior.followBehaviorEnabled=!e):this._pinButton.isToggled=e}_createPinButton(e){const t=new Qu("pin"+this.name,!1);return t.imageUrl=c_._ASSETS_BASE_URL+c_._PIN_ICON_FILENAME,t.parent=this,t._host=this._host,t.isToggleButton=!0,t.onToggleObservable.add((e=>{this.isPinned=e})),this._host.utilityLayer&&(t._prepareNode(this._host.utilityLayer.utilityLayerScene),t.scaling.scaleInPlace(Cu.MENU_BUTTON_SCALE),t.node&&(t.node.parent=e)),t}_createNode(e){const t=super._createNode(e);return this._pinButton=this._createPinButton(t),this.isPinned=!1,this._defaultBehavior.attach(t,[this._backPlate]),this._defaultBehavior.followBehavior.ignoreCameraPitchAndRoll=!0,this._defaultBehavior.followBehavior.pitchOffset=-15,this._defaultBehavior.followBehavior.minimumDistance=.3,this._defaultBehavior.followBehavior.defaultDistance=.4,this._defaultBehavior.followBehavior.maximumDistance=.6,this._backPlate.isNearGrabbable=!0,t.isVisible=!1,t}_finalProcessing(){super._finalProcessing(),this._pinButton.position.copyFromFloats((this._backPlate.scaling.x+Cu.MENU_BUTTON_SCALE)/2,this._backPlate.scaling.y/2,0)}constructor(e){super(e),this._isPinned=!1,this._defaultBehavior=new qu,this._dragObserver=this._defaultBehavior.sixDofDragBehavior.onDragObservable.add((()=>{this.isPinned=!0})),this.backPlateMargin=1}dispose(){super.dispose(),this._defaultBehavior.sixDofDragBehavior.onDragObservable.remove(this._dragObserver),this._defaultBehavior.detach()}}c_._ASSETS_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",c_._PIN_ICON_FILENAME="IconPin.png";F.ShadersStore.mrdlSliderBarPixelShader="uniform vec3 cameraPosition;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;uniform float _Radius_;uniform float _Bevel_Front_;uniform float _Bevel_Front_Stretch_;uniform float _Bevel_Back_;uniform float _Bevel_Back_Stretch_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform bool _Bulge_Enabled_;uniform float _Bulge_Height_;uniform float _Bulge_Radius_;uniform float _Sun_Intensity_;uniform float _Sun_Theta_;uniform float _Sun_Phi_;uniform float _Indirect_Diffuse_;uniform vec4 _Albedo_;uniform float _Specular_;uniform float _Shininess_;uniform float _Sharpness_;uniform float _Subsurface_;uniform vec4 _Left_Color_;uniform vec4 _Right_Color_;uniform float _Reflection_;uniform float _Front_Reflect_;uniform float _Edge_Reflect_;uniform float _Power_;uniform vec4 _Sky_Color_;uniform vec4 _Horizon_Color_;uniform vec4 _Ground_Color_;uniform float _Horizon_Power_;uniform sampler2D _Reflection_Map_;uniform sampler2D _Indirect_Environment_;uniform float _Width_;uniform float _Fuzz_;uniform float _Min_Fuzz_;uniform float _Clip_Fade_;uniform float _Hue_Shift_;uniform float _Saturation_Shift_;uniform float _Value_Shift_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Left_Index_Pos_;uniform vec3 _Right_Index_Pos_;uniform vec3 _Left_Index_Middle_Pos_;uniform vec3 _Right_Index_Middle_Pos_;uniform sampler2D _Decal_;uniform vec2 _Decal_Scale_XY_;uniform bool _Decal_Front_Only_;uniform float _Rim_Intensity_;uniform sampler2D _Rim_Texture_;uniform float _Rim_Hue_Shift_;uniform float _Rim_Saturation_Shift_;uniform float _Rim_Value_Shift_;uniform float _Iridescence_Intensity_;uniform sampler2D _Iridescence_Texture_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform vec4 Global_Left_Index_Middle_Position;uniform vec4 Global_Right_Index_Middle_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;void Blob_Fragment_B30(\nsampler2D Blob_Texture,\nvec4 Blob_Info1,\nvec4 Blob_Info2,\nout vec4 Blob_Color)\n{float k1=dot(Blob_Info1.xy,Blob_Info1.xy);float k2=dot(Blob_Info2.xy,Blob_Info2.xy);vec3 closer=k1<k2 ? vec3(k1,Blob_Info1.z,Blob_Info1.w) : vec3(k2,Blob_Info2.z,Blob_Info2.w);Blob_Color=closer.z*texture(Blob_Texture,vec2(vec2(sqrt(closer.x),closer.y).x,1.0-vec2(sqrt(closer.x),closer.y).y))*clamp(1.0-closer.x,0.0,1.0);}\nvoid FastLinearTosRGB_B42(\nvec4 Linear,\nout vec4 sRGB)\n{sRGB.rgb=sqrt(clamp(Linear.rgb,0.0,1.0));sRGB.a=Linear.a;}\nvoid Scale_RGB_B59(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Fragment_Main_B121(\nfloat Sun_Intensity,\nfloat Sun_Theta,\nfloat Sun_Phi,\nvec3 Normal,\nvec4 Albedo,\nfloat Fresnel_Reflect,\nfloat Shininess,\nvec3 Incident,\nvec4 Horizon_Color,\nvec4 Sky_Color,\nvec4 Ground_Color,\nfloat Indirect_Diffuse,\nfloat Specular,\nfloat Horizon_Power,\nfloat Reflection,\nvec4 Reflection_Sample,\nvec4 Indirect_Sample,\nfloat Sharpness,\nfloat SSS,\nfloat Subsurface,\nvec4 Translucence,\nvec4 Rim_Light,\nvec4 Iridescence,\nout vec4 Result)\n{float theta=Sun_Theta*2.0*3.14159;float phi=Sun_Phi*3.14159;vec3 lightDir= vec3(cos(phi)*cos(theta),sin(phi),cos(phi)*sin(theta));float NdotL=max(dot(lightDir,Normal),0.0);vec3 R=reflect(Incident,Normal);float RdotL=max(0.0,dot(R,lightDir));float specular=pow(RdotL,Shininess);specular=mix(specular,smoothstep(0.495*Sharpness,1.0-0.495*Sharpness,specular),Sharpness);vec4 gi=mix(Ground_Color,Sky_Color,Normal.y*0.5+0.5);Result=((Sun_Intensity*NdotL+Indirect_Sample*Indirect_Diffuse+Translucence)*(1.0+SSS*Subsurface))*Albedo*(1.0-Fresnel_Reflect)+(Sun_Intensity*specular*Specular+Fresnel_Reflect*Reflection*Reflection_Sample)+Fresnel_Reflect*Rim_Light+Iridescence;}\nvoid Bulge_B79(\nbool Enabled,\nvec3 Normal,\nvec3 Tangent,\nfloat Bulge_Height,\nvec4 UV,\nfloat Bulge_Radius,\nvec3 ButtonN,\nout vec3 New_Normal)\n{vec2 xy=clamp(UV.xy*2.0,vec2(-1,-1),vec2(1,1));vec3 B=(cross(Normal,Tangent));float k=-clamp(1.0-length(xy)/Bulge_Radius,0.0,1.0)*Bulge_Height;k=sin(k*3.14159*0.5);k*=smoothstep(0.9998,0.9999,abs(dot(ButtonN,Normal)));New_Normal=Normal*sqrt(1.0-k*k)+(xy.x*Tangent+xy.y*B)*k;New_Normal=Enabled ? New_Normal : Normal;}\nvoid SSS_B77(\nvec3 ButtonN,\nvec3 Normal,\nvec3 Incident,\nout float Result)\n{float NdotI=abs(dot(Normal,Incident));float BdotI=abs(dot(ButtonN,Incident));Result=(abs(NdotI-BdotI)); }\nvoid FingerOcclusion_B67(\nfloat Width,\nfloat DistToCenter,\nfloat Fuzz,\nfloat Min_Fuzz,\nvec3 Position,\nvec3 Forward,\nvec3 Nearest,\nfloat Fade_Out,\nout float NotInShadow)\n{float d=dot((Nearest-Position),Forward);float sh=smoothstep(Width*0.5,Width*0.5+Fuzz*max(d,0.0)+Min_Fuzz,DistToCenter);NotInShadow=1.0-(1.0-sh)*smoothstep(-Fade_Out,0.0,d);}\nvoid FingerOcclusion_B68(\nfloat Width,\nfloat DistToCenter,\nfloat Fuzz,\nfloat Min_Fuzz,\nvec3 Position,\nvec3 Forward,\nvec3 Nearest,\nfloat Fade_Out,\nout float NotInShadow)\n{float d=dot((Nearest-Position),Forward);float sh=smoothstep(Width*0.5,Width*0.5+Fuzz*max(d,0.0)+Min_Fuzz,DistToCenter);NotInShadow=1.0-(1.0-sh)*smoothstep(-Fade_Out,0.0,d);}\nvoid Scale_Color_B91(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=Scalar*Color;}\nvoid From_HSV_B73(\nfloat Hue,\nfloat Saturation,\nfloat Value,\nfloat Alpha,\nout vec4 Color)\n{vec4 K=vec4(1.0,2.0/3.0,1.0/3.0,3.0);vec3 p=abs(fract(vec3(Hue,Hue,Hue)+K.xyz)*6.0-K.www);Color.rgb=Value*mix(K.xxx,clamp(p-K.xxx,0.0,1.0),Saturation);Color.a=Alpha;}\nvoid Fast_Fresnel_B122(\nfloat Front_Reflect,\nfloat Edge_Reflect,\nfloat Power,\nvec3 Normal,\nvec3 Incident,\nout float Transmit,\nout float Reflect)\n{float d=max(-dot(Incident,Normal),0.0);Reflect=Front_Reflect+(Edge_Reflect-Front_Reflect)*pow(.01-d,Power);Transmit=1.0-Reflect;}\nvoid Mapped_Environment_B51(\nsampler2D Reflected_Environment,\nsampler2D Indirect_Environment,\nvec3 Dir,\nout vec4 Reflected_Color,\nout vec4 Indirect_Diffuse)\n{Reflected_Color=texture(Reflected_Environment,vec2(atan(Dir.z,Dir.x)/3.14159*0.5,asin(Dir.y)/3.14159+0.5));Indirect_Diffuse=texture(Indirect_Environment,vec2(atan(Dir.z,Dir.x)/3.14159*0.5,asin(Dir.y)/3.14159+0.5));}\nvec4 SampleEnv_Bid50(vec3 D,vec4 S,vec4 H,vec4 G,float exponent)\n{float k=pow(abs(D.y),exponent);vec4 C;if (D.y>0.0) {C=mix(H,S,k);} else {C=mix(H,G,k); }\nreturn C;}\nvoid Sky_Environment_B50(\nvec3 Normal,\nvec3 Reflected,\nvec4 Sky_Color,\nvec4 Horizon_Color,\nvec4 Ground_Color,\nfloat Horizon_Power,\nout vec4 Reflected_Color,\nout vec4 Indirect_Color)\n{Reflected_Color=SampleEnv_Bid50(Reflected,Sky_Color,Horizon_Color,Ground_Color,Horizon_Power);Indirect_Color=mix(Ground_Color,Sky_Color,Normal.y*0.5+0.5);}\nvoid Min_Segment_Distance_B65(\nvec3 P0,\nvec3 P1,\nvec3 Q0,\nvec3 Q1,\nout vec3 NearP,\nout vec3 NearQ,\nout float Distance)\n{vec3 u=P1-P0;vec3 v=Q1-Q0;vec3 w=P0-Q0;float a=dot(u,u);float b=dot(u,v);float c=dot(v,v);float d=dot(u,w);float e=dot(v,w);float D=a*c-b*b;float sD=D;float tD=D;float sc,sN,tc,tN;if (D<0.00001) {sN=0.0;sD=1.0;tN=e;tD=c;} else {sN=(b*e-c*d);tN=(a*e-b*d);if (sN<0.0) {sN=0.0;tN=e;tD=c;} else if (sN>sD) {sN=sD;tN=e+b;tD=c;}}\nif (tN<0.0) {tN=0.0;if (-d<0.0) {sN=0.0;} else if (-d>a) {sN=sD;} else {sN=-d;sD=a;}} else if (tN>tD) {tN=tD;if ((-d+b)<0.0) {sN=0.0;} else if ((-d+b)>a) {sN=sD;} else {sN=(-d+b);sD=a;}}\nsc=abs(sN)<0.000001 ? 0.0 : sN/sD;tc=abs(tN)<0.000001 ? 0.0 : tN/tD;NearP=P0+sc*u;NearQ=Q0+tc*v;Distance=distance(NearP,NearQ);}\nvoid To_XYZ_B74(\nvec3 Vec3,\nout float X,\nout float Y,\nout float Z)\n{X=Vec3.x;Y=Vec3.y;Z=Vec3.z;}\nvoid Finger_Positions_B64(\nvec3 Left_Index_Pos,\nvec3 Right_Index_Pos,\nvec3 Left_Index_Middle_Pos,\nvec3 Right_Index_Middle_Pos,\nout vec3 Left_Index,\nout vec3 Right_Index,\nout vec3 Left_Index_Middle,\nout vec3 Right_Index_Middle)\n{Left_Index= (Use_Global_Left_Index ? Global_Left_Index_Tip_Position.xyz : Left_Index_Pos);Right_Index= (Use_Global_Right_Index ? Global_Right_Index_Tip_Position.xyz : Right_Index_Pos);Left_Index_Middle= (Use_Global_Left_Index ? Global_Left_Index_Middle_Position.xyz : Left_Index_Middle_Pos);Right_Index_Middle= (Use_Global_Right_Index ? Global_Right_Index_Middle_Position.xyz : Right_Index_Middle_Pos);}\nvoid VaryHSV_B108(\nvec3 HSV_In,\nfloat Hue_Shift,\nfloat Saturation_Shift,\nfloat Value_Shift,\nout vec3 HSV_Out)\n{HSV_Out=vec3(fract(HSV_In.x+Hue_Shift),clamp(HSV_In.y+Saturation_Shift,0.0,1.0),clamp(HSV_In.z+Value_Shift,0.0,1.0));}\nvoid Remap_Range_B114(\nfloat In_Min,\nfloat In_Max,\nfloat Out_Min,\nfloat Out_Max,\nfloat In,\nout float Out)\n{Out=mix(Out_Min,Out_Max,clamp((In-In_Min)/(In_Max-In_Min),0.0,1.0));}\nvoid To_HSV_B75(\nvec4 Color,\nout float Hue,\nout float Saturation,\nout float Value,\nout float Alpha,\nout vec3 HSV)\n{vec4 K=vec4(0.0,-1.0/3.0,2.0/3.0,-1.0);vec4 p=Color.g<Color.b ? vec4(Color.bg,K.wz) : vec4(Color.gb,K.xy);vec4 q=Color.r<p.x ? vec4(p.xyw,Color.r) : vec4(Color.r,p.yzx);float d=q.x-min(q.w,q.y);float e=1.0e-10;Hue=abs(q.z+(q.w-q.y)/(6.0*d+e));Saturation=d/(q.x+e);Value=q.x;Alpha=Color.a;HSV=vec3(Hue,Saturation,Value);}\nvoid Code_B110(\nfloat X,\nout float Result)\n{Result=(acos(X)/3.14159-0.5)*2.0;}\nvoid Rim_Light_B132(\nvec3 Front,\nvec3 Normal,\nvec3 Incident,\nfloat Rim_Intensity,\nsampler2D Texture,\nout vec4 Result)\n{vec3 R=reflect(Incident,Normal);float RdotF=dot(R,Front);float RdotL=sqrt(1.0-RdotF*RdotF);vec2 UV=vec2(R.y*0.5+0.5,0.5);vec4 Color=texture(Texture,UV);Result=Color;}\nvoid main()\n{vec4 Blob_Color_Q30;\n#if BLOB_ENABLE\nBlob_Fragment_B30(_Blob_Texture_,vExtra2,vExtra3,Blob_Color_Q30);\n#else\nBlob_Color_Q30=vec4(0,0,0,0);\n#endif\nvec3 Incident_Q39=normalize(vPosition-cameraPosition);vec3 Normalized_Q38=normalize(vNormal);vec3 Normalized_Q71=normalize(vTangent);vec4 Color_Q83;\n#if DECAL_ENABLE\nColor_Q83=texture(_Decal_,vUV);\n#else\nColor_Q83=vec4(0,0,0,0);\n#endif\nfloat X_Q90;float Y_Q90;float Z_Q90;float W_Q90;X_Q90=vExtra1.x;Y_Q90=vExtra1.y;Z_Q90=vExtra1.z;W_Q90=vExtra1.w;vec4 Linear_Q43;Linear_Q43.rgb=clamp(_Sky_Color_.rgb*_Sky_Color_.rgb,0.0,1.0);Linear_Q43.a=_Sky_Color_.a;vec4 Linear_Q44;Linear_Q44.rgb=clamp(_Horizon_Color_.rgb*_Horizon_Color_.rgb,0.0,1.0);Linear_Q44.a=_Horizon_Color_.a;vec4 Linear_Q45;Linear_Q45.rgb=clamp(_Ground_Color_.rgb*_Ground_Color_.rgb,0.0,1.0);Linear_Q45.a=_Ground_Color_.a;vec3 Left_Index_Q64;vec3 Right_Index_Q64;vec3 Left_Index_Middle_Q64;vec3 Right_Index_Middle_Q64;Finger_Positions_B64(_Left_Index_Pos_,_Right_Index_Pos_,_Left_Index_Middle_Pos_,_Right_Index_Middle_Pos_,Left_Index_Q64,Right_Index_Q64,Left_Index_Middle_Q64,Right_Index_Middle_Q64);vec4 Linear_Q46;Linear_Q46.rgb=clamp(_Albedo_.rgb*_Albedo_.rgb,0.0,1.0);Linear_Q46.a=_Albedo_.a;vec3 Normalized_Q107=normalize(vBinormal);vec3 Incident_Q70=normalize(vPosition-cameraPosition);vec3 New_Normal_Q79;Bulge_B79(_Bulge_Enabled_,Normalized_Q38,Normalized_Q71,_Bulge_Height_,vColor,_Bulge_Radius_,vBinormal,New_Normal_Q79);float Result_Q77;SSS_B77(vBinormal,New_Normal_Q79,Incident_Q39,Result_Q77);vec4 Result_Q91;Scale_Color_B91(Color_Q83,X_Q90,Result_Q91);float Transmit_Q122;float Reflect_Q122;Fast_Fresnel_B122(_Front_Reflect_,_Edge_Reflect_,_Power_,New_Normal_Q79,Incident_Q39,Transmit_Q122,Reflect_Q122);float Product_Q125=Y_Q90*Y_Q90;vec3 NearP_Q65;vec3 NearQ_Q65;float Distance_Q65;Min_Segment_Distance_B65(Left_Index_Q64,Left_Index_Middle_Q64,vPosition,cameraPosition,NearP_Q65,NearQ_Q65,Distance_Q65);vec3 NearP_Q63;vec3 NearQ_Q63;float Distance_Q63;Min_Segment_Distance_B65(Right_Index_Q64,Right_Index_Middle_Q64,vPosition,cameraPosition,NearP_Q63,NearQ_Q63,Distance_Q63);vec3 Reflected_Q47=reflect(Incident_Q39,New_Normal_Q79);vec4 Product_Q103=Linear_Q46*vec4(1,1,1,1);vec4 Result_Q132;Rim_Light_B132(Normalized_Q107,Normalized_Q38,Incident_Q70,_Rim_Intensity_,_Rim_Texture_,Result_Q132);float Dot_Q72=dot(Incident_Q70, Normalized_Q71);float MaxAB_Q123=max(Reflect_Q122,Product_Q125);float NotInShadow_Q67;\n#if OCCLUSION_ENABLED\nFingerOcclusion_B67(_Width_,Distance_Q65,_Fuzz_,_Min_Fuzz_,vPosition,vBinormal,NearP_Q65,_Clip_Fade_,NotInShadow_Q67);\n#else\nNotInShadow_Q67=1.0;\n#endif\nfloat NotInShadow_Q68;\n#if OCCLUSION_ENABLED\nFingerOcclusion_B68(_Width_,Distance_Q63,_Fuzz_,_Min_Fuzz_,vPosition,vBinormal,NearP_Q63,_Clip_Fade_,NotInShadow_Q68);\n#else\nNotInShadow_Q68=1.0;\n#endif\nvec4 Reflected_Color_Q51;vec4 Indirect_Diffuse_Q51;\n#if ENV_ENABLE\nMapped_Environment_B51(_Reflection_Map_,_Indirect_Environment_,Reflected_Q47,Reflected_Color_Q51,Indirect_Diffuse_Q51);\n#else\nReflected_Color_Q51=vec4(0,0,0,1);Indirect_Diffuse_Q51=vec4(0,0,0,1);\n#endif\nvec4 Reflected_Color_Q50;vec4 Indirect_Color_Q50;\n#if SKY_ENABLED\nSky_Environment_B50(New_Normal_Q79,Reflected_Q47,Linear_Q43,Linear_Q44,Linear_Q45,_Horizon_Power_,Reflected_Color_Q50,Indirect_Color_Q50);\n#else\nReflected_Color_Q50=vec4(0,0,0,1);Indirect_Color_Q50=vec4(0,0,0,1);\n#endif\nfloat Hue_Q75;float Saturation_Q75;float Value_Q75;float Alpha_Q75;vec3 HSV_Q75;To_HSV_B75(Product_Q103,Hue_Q75,Saturation_Q75,Value_Q75,Alpha_Q75,HSV_Q75);float Hue_Q127;float Saturation_Q127;float Value_Q127;float Alpha_Q127;vec3 HSV_Q127;To_HSV_B75(Result_Q132,Hue_Q127,Saturation_Q127,Value_Q127,Alpha_Q127,HSV_Q127);float Result_Q110;Code_B110(Dot_Q72,Result_Q110);float AbsA_Q76=abs(Result_Q110);float MinAB_Q58=min(NotInShadow_Q67,NotInShadow_Q68);vec4 Sum_Q48=Reflected_Color_Q51+Reflected_Color_Q50;vec4 Sum_Q49=Indirect_Diffuse_Q51+Indirect_Color_Q50;vec3 HSV_Out_Q126;VaryHSV_B108(HSV_Q127,_Rim_Hue_Shift_,_Rim_Saturation_Shift_,_Rim_Value_Shift_,HSV_Out_Q126);float Out_Q114;Remap_Range_B114(-1.0,1.0,0.0,1.0,Result_Q110,Out_Q114);float Product_Q106;Product_Q106=AbsA_Q76*_Hue_Shift_;float X_Q128;float Y_Q128;float Z_Q128;To_XYZ_B74(HSV_Out_Q126,X_Q128,Y_Q128,Z_Q128);vec2 Vec2_Q112=vec2(Out_Q114,0.5);vec3 HSV_Out_Q108;VaryHSV_B108(HSV_Q75,Product_Q106,_Saturation_Shift_,_Value_Shift_,HSV_Out_Q108);vec4 Color_Q129;From_HSV_B73(X_Q128,Y_Q128,Z_Q128,0.0,Color_Q129);vec4 Color_Q111;\n#if IRIDESCENCE_ENABLED\nColor_Q111=texture(_Iridescence_Texture_,Vec2_Q112);\n#else\nColor_Q111=vec4(0,0,0,0);\n#endif\nfloat X_Q74;float Y_Q74;float Z_Q74;To_XYZ_B74(HSV_Out_Q108,X_Q74,Y_Q74,Z_Q74);vec4 Result_Q131=_Rim_Intensity_*Color_Q129;vec4 Result_Q113=_Iridescence_Intensity_*Color_Q111;vec4 Color_Q73;From_HSV_B73(X_Q74,Y_Q74,Z_Q74,0.0,Color_Q73);vec4 Result_Q84=Result_Q91+(1.0-Result_Q91.a)*Color_Q73;vec4 Result_Q121;Fragment_Main_B121(_Sun_Intensity_,_Sun_Theta_,_Sun_Phi_,New_Normal_Q79,Result_Q84,MaxAB_Q123,_Shininess_,Incident_Q39,_Horizon_Color_,_Sky_Color_,_Ground_Color_,_Indirect_Diffuse_,_Specular_,_Horizon_Power_,_Reflection_,Sum_Q48,Sum_Q49,_Sharpness_,Result_Q77,_Subsurface_,vec4(0,0,0,0),Result_Q131,Result_Q113,Result_Q121);vec4 Result_Q59;Scale_RGB_B59(Result_Q121,MinAB_Q58,Result_Q59);vec4 sRGB_Q42;FastLinearTosRGB_B42(Result_Q59,sRGB_Q42);vec4 Result_Q31=Blob_Color_Q30+(1.0-Blob_Color_Q30.a)*sRGB_Q42;vec4 Result_Q40=Result_Q31; Result_Q40.a=1.0;vec4 Out_Color=Result_Q40;float Clip_Threshold=0.001;bool To_sRGB=false;gl_FragColor=Out_Color;}";F.ShadersStore.mrdlSliderBarVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;\n#ifdef TANGENT\nattribute vec3 tangent;\n#else\nconst vec3 tangent=vec3(0.);\n#endif\nuniform float _Radius_;uniform float _Bevel_Front_;uniform float _Bevel_Front_Stretch_;uniform float _Bevel_Back_;uniform float _Bevel_Back_Stretch_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform bool _Bulge_Enabled_;uniform float _Bulge_Height_;uniform float _Bulge_Radius_;uniform float _Sun_Intensity_;uniform float _Sun_Theta_;uniform float _Sun_Phi_;uniform float _Indirect_Diffuse_;uniform vec4 _Albedo_;uniform float _Specular_;uniform float _Shininess_;uniform float _Sharpness_;uniform float _Subsurface_;uniform vec4 _Left_Color_;uniform vec4 _Right_Color_;uniform float _Reflection_;uniform float _Front_Reflect_;uniform float _Edge_Reflect_;uniform float _Power_;uniform vec4 _Sky_Color_;uniform vec4 _Horizon_Color_;uniform vec4 _Ground_Color_;uniform float _Horizon_Power_;uniform sampler2D _Reflection_Map_;uniform sampler2D _Indirect_Environment_;uniform float _Width_;uniform float _Fuzz_;uniform float _Min_Fuzz_;uniform float _Clip_Fade_;uniform float _Hue_Shift_;uniform float _Saturation_Shift_;uniform float _Value_Shift_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Left_Index_Pos_;uniform vec3 _Right_Index_Pos_;uniform vec3 _Left_Index_Middle_Pos_;uniform vec3 _Right_Index_Middle_Pos_;uniform sampler2D _Decal_;uniform vec2 _Decal_Scale_XY_;uniform bool _Decal_Front_Only_;uniform float _Rim_Intensity_;uniform sampler2D _Rim_Texture_;uniform float _Rim_Hue_Shift_;uniform float _Rim_Saturation_Shift_;uniform float _Rim_Value_Shift_;uniform float _Iridescence_Intensity_;uniform sampler2D _Iridescence_Texture_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;void Object_To_World_Pos_B12(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid Object_To_World_Normal_B32(\nvec3 Nrm_Object,\nout vec3 Nrm_World)\n{Nrm_World=(vec4(Nrm_Object,0.0)).xyz;}\nvoid Blob_Vertex_B23(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nfloat Blob_Fade_Length,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nout vec4 Blob_Info)\n{vec3 blob= (Use_Global_Left_Index ? Global_Left_Index_Tip_Position.xyz : Blob_Position);vec3 delta=blob-Position;float dist=dot(Normal,delta);float lerpValue=clamp((abs(dist)-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);float fadeValue=1.0-clamp((abs(dist)-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float size=Blob_Near_Size+(Blob_Far_Size-Blob_Near_Size)*lerpValue;vec2 blobXY=vec2(dot(delta,Tangent),dot(delta,Bitangent))/(0.0001+size);float Fade=fadeValue*Intensity*Blob_Fade;float Distance=(lerpValue*0.5+0.5)*(1.0-Blob_Pulse);Blob_Info=vec4(blobXY.x,blobXY.y,Distance,Fade);}\nvoid Blob_Vertex_B24(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nfloat Blob_Fade_Length,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nout vec4 Blob_Info)\n{vec3 blob= (Use_Global_Right_Index ? Global_Right_Index_Tip_Position.xyz : Blob_Position);vec3 delta=blob-Position;float dist=dot(Normal,delta);float lerpValue=clamp((abs(dist)-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);float fadeValue=1.0-clamp((abs(dist)-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float size=Blob_Near_Size+(Blob_Far_Size-Blob_Near_Size)*lerpValue;vec2 blobXY=vec2(dot(delta,Tangent),dot(delta,Bitangent))/(0.0001+size);float Fade=fadeValue*Intensity*Blob_Fade;float Distance=(lerpValue*0.5+0.5)*(1.0-Blob_Pulse);Blob_Info=vec4(blobXY.x,blobXY.y,Distance,Fade);}\nvoid Move_Verts_B130(\nfloat Anisotropy,\nvec3 P,\nfloat Radius,\nfloat Bevel,\nvec3 Normal_Object,\nfloat ScaleZ,\nfloat Stretch,\nout vec3 New_P,\nout vec2 New_UV,\nout float Radial_Gradient,\nout vec3 Radial_Dir,\nout vec3 New_Normal)\n{vec2 UV=P.xy*2.0+0.5;vec2 center=clamp(UV,0.0,1.0);vec2 delta=UV-center;float deltad=(length(delta)*2.0);float f=(Bevel+(Radius-Bevel)*Stretch)/Radius;float innerd=clamp(deltad*2.0,0.0,1.0);float outerd=clamp(deltad*2.0-1.0,0.0,1.0);float bevelAngle=outerd*3.14159*0.5;float sinb=sin(bevelAngle);float cosb=cos(bevelAngle);float beveld=(1.0-f)*innerd+f*sinb;float br=outerd;vec2 r2=2.0*vec2(Radius/Anisotropy,Radius);float dir=P.z<0.0001 ? 1.0 : -1.0;New_UV=center+r2*((0.5-center)+normalize(delta+vec2(0.0,0.000001))*beveld*0.5);New_P=vec3(New_UV-0.5,P.z+dir*(1.0-cosb)*Bevel*ScaleZ);Radial_Gradient=clamp((deltad-0.5)*2.0,0.0,1.0);Radial_Dir=vec3(delta*r2,0.0);vec3 beveledNormal=cosb*Normal_Object+sinb*vec3(delta.x,delta.y,0.0);New_Normal=Normal_Object.z==0.0 ? Normal_Object : beveledNormal;}\nvoid Object_To_World_Dir_B60(\nvec3 Dir_Object,\nout vec3 Normal_World,\nout vec3 Normal_World_N,\nout float Normal_Length)\n{Normal_World=(world*vec4(Dir_Object,0.0)).xyz;Normal_Length=length(Normal_World);Normal_World_N=Normal_World/Normal_Length;}\nvoid To_XYZ_B78(\nvec3 Vec3,\nout float X,\nout float Y,\nout float Z)\n{X=Vec3.x;Y=Vec3.y;Z=Vec3.z;}\nvoid Conditional_Float_B93(\nbool Which,\nfloat If_True,\nfloat If_False,\nout float Result)\n{Result=Which ? If_True : If_False;}\nvoid Object_To_World_Dir_B28(\nvec3 Dir_Object,\nout vec3 Binormal_World,\nout vec3 Binormal_World_N,\nout float Binormal_Length)\n{Binormal_World=(world*vec4(Dir_Object,0.0)).xyz;Binormal_Length=length(Binormal_World);Binormal_World_N=Binormal_World/Binormal_Length;}\nvoid Pick_Radius_B69(\nfloat Radius,\nfloat Radius_Top_Left,\nfloat Radius_Top_Right,\nfloat Radius_Bottom_Left,\nfloat Radius_Bottom_Right,\nvec3 Position,\nout float Result)\n{bool whichY=Position.y>0.0;Result=Position.x<0.0 ? (whichY ? Radius_Top_Left : Radius_Bottom_Left) : (whichY ? Radius_Top_Right : Radius_Bottom_Right);Result*=Radius;}\nvoid Conditional_Float_B36(\nbool Which,\nfloat If_True,\nfloat If_False,\nout float Result)\n{Result=Which ? If_True : If_False;}\nvoid Greater_Than_B37(\nfloat Left,\nfloat Right,\nout bool Not_Greater_Than,\nout bool Greater_Than)\n{Greater_Than=Left>Right;Not_Greater_Than=!Greater_Than;}\nvoid Remap_Range_B105(\nfloat In_Min,\nfloat In_Max,\nfloat Out_Min,\nfloat Out_Max,\nfloat In,\nout float Out)\n{Out=mix(Out_Min,Out_Max,clamp((In-In_Min)/(In_Max-In_Min),0.0,1.0));}\nvoid main()\n{vec2 XY_Q85;XY_Q85=(uv-vec2(0.5,0.5))*_Decal_Scale_XY_+vec2(0.5,0.5);vec3 Tangent_World_Q27;vec3 Tangent_World_N_Q27;float Tangent_Length_Q27;Tangent_World_Q27=(world*vec4(vec3(1,0,0),0.0)).xyz;Tangent_Length_Q27=length(Tangent_World_Q27);Tangent_World_N_Q27=Tangent_World_Q27/Tangent_Length_Q27;vec3 Normal_World_Q60;vec3 Normal_World_N_Q60;float Normal_Length_Q60;Object_To_World_Dir_B60(vec3(0,0,1),Normal_World_Q60,Normal_World_N_Q60,Normal_Length_Q60);float X_Q78;float Y_Q78;float Z_Q78;To_XYZ_B78(position,X_Q78,Y_Q78,Z_Q78);vec3 Nrm_World_Q26;Nrm_World_Q26=normalize((world*vec4(normal,0.0)).xyz);vec3 Binormal_World_Q28;vec3 Binormal_World_N_Q28;float Binormal_Length_Q28;Object_To_World_Dir_B28(vec3(0,1,0),Binormal_World_Q28,Binormal_World_N_Q28,Binormal_Length_Q28);float Anisotropy_Q29=Tangent_Length_Q27/Binormal_Length_Q28;float Result_Q69;Pick_Radius_B69(_Radius_,_Radius_Top_Left_,_Radius_Top_Right_,_Radius_Bottom_Left_,_Radius_Bottom_Right_,position,Result_Q69);float Anisotropy_Q53=Binormal_Length_Q28/Normal_Length_Q60;bool Not_Greater_Than_Q37;bool Greater_Than_Q37;Greater_Than_B37(Z_Q78,0.0,Not_Greater_Than_Q37,Greater_Than_Q37);vec4 Linear_Q101;Linear_Q101.rgb=clamp(_Left_Color_.rgb*_Left_Color_.rgb,0.0,1.0);Linear_Q101.a=_Left_Color_.a;vec4 Linear_Q102;Linear_Q102.rgb=clamp(_Right_Color_.rgb*_Right_Color_.rgb,0.0,1.0);Linear_Q102.a=_Right_Color_.a;vec3 Difference_Q61=vec3(0,0,0)-Normal_World_N_Q60;vec4 Out_Color_Q34=vec4(X_Q78,Y_Q78,Z_Q78,1);float Result_Q36;Conditional_Float_B36(Greater_Than_Q37,_Bevel_Back_,_Bevel_Front_,Result_Q36);float Result_Q94;Conditional_Float_B36(Greater_Than_Q37,_Bevel_Back_Stretch_,_Bevel_Front_Stretch_,Result_Q94);vec3 New_P_Q130;vec2 New_UV_Q130;float Radial_Gradient_Q130;vec3 Radial_Dir_Q130;vec3 New_Normal_Q130;Move_Verts_B130(Anisotropy_Q29,position,Result_Q69,Result_Q36,normal,Anisotropy_Q53,Result_Q94,New_P_Q130,New_UV_Q130,Radial_Gradient_Q130,Radial_Dir_Q130,New_Normal_Q130);float X_Q98;float Y_Q98;X_Q98=New_UV_Q130.x;Y_Q98=New_UV_Q130.y;vec3 Pos_World_Q12;Object_To_World_Pos_B12(New_P_Q130,Pos_World_Q12);vec3 Nrm_World_Q32;Object_To_World_Normal_B32(New_Normal_Q130,Nrm_World_Q32);vec4 Blob_Info_Q23;\n#if BLOB_ENABLE\nBlob_Vertex_B23(Pos_World_Q12,Nrm_World_Q26,Tangent_World_N_Q27,Binormal_World_N_Q28,_Blob_Position_,_Blob_Intensity_,_Blob_Near_Size_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_,_Blob_Fade_,Blob_Info_Q23);\n#else\nBlob_Info_Q23=vec4(0,0,0,0);\n#endif\nvec4 Blob_Info_Q24;\n#if BLOB_ENABLE_2\nBlob_Vertex_B24(Pos_World_Q12,Nrm_World_Q26,Tangent_World_N_Q27,Binormal_World_N_Q28,_Blob_Position_2_,_Blob_Intensity_,_Blob_Near_Size_2_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_2_,_Blob_Fade_2_,Blob_Info_Q24);\n#else\nBlob_Info_Q24=vec4(0,0,0,0);\n#endif\nfloat Out_Q105;Remap_Range_B105(0.0,1.0,0.0,1.0,X_Q98,Out_Q105);float X_Q86;float Y_Q86;float Z_Q86;To_XYZ_B78(Nrm_World_Q32,X_Q86,Y_Q86,Z_Q86);vec4 Color_At_T_Q97=mix(Linear_Q101,Linear_Q102,Out_Q105);float Minus_F_Q87=-Z_Q86;float R_Q99;float G_Q99;float B_Q99;float A_Q99;R_Q99=Color_At_T_Q97.r; G_Q99=Color_At_T_Q97.g; B_Q99=Color_At_T_Q97.b; A_Q99=Color_At_T_Q97.a;float ClampF_Q88=clamp(0.0,Minus_F_Q87,1.0);float Result_Q93;Conditional_Float_B93(_Decal_Front_Only_,ClampF_Q88,1.0,Result_Q93);vec4 Vec4_Q89=vec4(Result_Q93,Radial_Gradient_Q130,G_Q99,B_Q99);vec3 Position=Pos_World_Q12;vec3 Normal=Nrm_World_Q32;vec2 UV=XY_Q85;vec3 Tangent=Tangent_World_N_Q27;vec3 Binormal=Difference_Q61;vec4 Color=Out_Color_Q34;vec4 Extra1=Vec4_Q89;vec4 Extra2=Blob_Info_Q23;vec4 Extra3=Blob_Info_Q24;gl_Position=viewProjection*vec4(Position,1);vPosition=Position;vNormal=Normal;vUV=UV;vTangent=Tangent;vBinormal=Binormal;vColor=Color;vExtra1=Extra1;vExtra2=Extra2;vExtra3=Extra3;}";class d_ extends Wt{constructor(){super(),this.SKY_ENABLED=!0,this.BLOB_ENABLE_2=!0,this.IRIDESCENCE_ENABLED=!0,this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class u_ extends Ms{constructor(e,t){super(e,t),this.radius=.6,this.bevelFront=.6,this.bevelFrontStretch=.077,this.bevelBack=0,this.bevelBackStretch=0,this.radiusTopLeft=1,this.radiusTopRight=1,this.radiusBottomLeft=1,this.radiusBottomRight=1,this.bulgeEnabled=!1,this.bulgeHeight=-.323,this.bulgeRadius=.73,this.sunIntensity=1.102,this.sunTheta=.76,this.sunPhi=.526,this.indirectDiffuse=.658,this.albedo=new Ie(.0117647,.505882,.996078,1),this.specular=0,this.shininess=10,this.sharpness=0,this.subsurface=0,this.leftGradientColor=new Ie(.0117647,.505882,.996078,1),this.rightGradientColor=new Ie(.0117647,.505882,.996078,1),this.reflection=.749,this.frontReflect=0,this.edgeReflect=.09,this.power=8.13,this.skyColor=new Ie(.0117647,.964706,.996078,1),this.horizonColor=new Ie(.0117647,.333333,.996078,1),this.groundColor=new Ie(0,.254902,.996078,1),this.horizonPower=1,this.width=.02,this.fuzz=.5,this.minFuzz=.001,this.clipFade=.01,this.hueShift=0,this.saturationShift=0,this.valueShift=0,this.blobPosition=new me(0,0,.1),this.blobIntensity=.5,this.blobNearSize=.01,this.blobFarSize=.03,this.blobNearDistance=0,this.blobFarDistance=.08,this.blobFadeLength=.576,this.blobPulse=0,this.blobFade=1,this.blobPosition2=new me(.2,0,.1),this.blobNearSize2=.01,this.blobPulse2=0,this.blobFade2=1,this.blobTexture=new zi("",this.getScene()),this.leftIndexPosition=new me(0,0,1),this.rightIndexPosition=new me(-1,-1,-1),this.leftIndexMiddlePosition=new me(0,0,0),this.rightIndexMiddlePosition=new me(0,0,0),this.decalScaleXY=new pe(1.5,1.5),this.decalFrontOnly=!0,this.rimIntensity=.287,this.rimHueShift=0,this.rimSaturationShift=0,this.rimValueShift=-1,this.iridescenceIntensity=0,this.useGlobalLeftIndex=1,this.useGlobalRightIndex=1,this.globalLeftIndexTipProximity=0,this.globalRightIndexTipProximity=0,this.globalLeftIndexTipPosition=new ge(.5,0,-.55,1),this.globaRightIndexTipPosition=new ge(0,0,0,1),this.globalLeftThumbTipPosition=new ge(.5,0,-.55,1),this.globalRightThumbTipPosition=new ge(0,0,0,1),this.globalLeftIndexMiddlePosition=new ge(.5,0,-.55,1),this.globalRightIndexMiddlePosition=new ge(0,0,0,1),this.alphaMode=Dh.ALPHA_DISABLE,this.backFaceCulling=!1,this._blueGradientTexture=new zi(u_.BLUE_GRADIENT_TEXTURE_URL,this.getScene(),!0,!1,zi.NEAREST_SAMPLINGMODE),this._decalTexture=new zi("",this.getScene()),this._reflectionMapTexture=new zi("",this.getScene()),this._indirectEnvTexture=new zi("",this.getScene())}needAlphaBlending(){return!1}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new d_);const i=t.materialDefines,s=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(wi.PrepareDefinesForAttributes(e,i,!1,!1),i.isDirty){i.markAsProcessed(),s.resetCachedMaterial();const e=new is;i.FOG&&e.addFallback(1,"FOG"),wi.HandleFallbacksForShadows(i,e),i.IMAGEPROCESSINGPOSTPROCESS=s.imageProcessingConfiguration.applyByPostProcess;const r=[Oe.PositionKind];i.NORMAL&&r.push(Oe.NormalKind),i.UV1&&r.push(Oe.UVKind),i.UV2&&r.push(Oe.UV2Kind),i.VERTEXCOLOR&&r.push(Oe.ColorKind),i.TANGENT&&r.push(Oe.TangentKind),wi.PrepareAttributesForInstances(r,i);const o="mrdlSliderBar",a=i.toString(),l=["world","viewProjection","cameraPosition","_Radius_","_Bevel_Front_","_Bevel_Front_Stretch_","_Bevel_Back_","_Bevel_Back_Stretch_","_Radius_Top_Left_","_Radius_Top_Right_","_Radius_Bottom_Left_","_Radius_Bottom_Right_","_Bulge_Enabled_","_Bulge_Height_","_Bulge_Radius_","_Sun_Intensity_","_Sun_Theta_","_Sun_Phi_","_Indirect_Diffuse_","_Albedo_","_Specular_","_Shininess_","_Sharpness_","_Subsurface_","_Left_Color_","_Right_Color_","_Reflection_","_Front_Reflect_","_Edge_Reflect_","_Power_","_Sky_Color_","_Horizon_Color_","_Ground_Color_","_Horizon_Power_","_Reflection_Map_","_Indirect_Environment_","_Width_","_Fuzz_","_Min_Fuzz_","_Clip_Fade_","_Hue_Shift_","_Saturation_Shift_","_Value_Shift_","_Blob_Position_","_Blob_Intensity_","_Blob_Near_Size_","_Blob_Far_Size_","_Blob_Near_Distance_","_Blob_Far_Distance_","_Blob_Fade_Length_","_Blob_Pulse_","_Blob_Fade_","_Blob_Texture_","_Blob_Position_2_","_Blob_Near_Size_2_","_Blob_Pulse_2_","_Blob_Fade_2_","_Left_Index_Pos_","_Right_Index_Pos_","_Left_Index_Middle_Pos_","_Right_Index_Middle_Pos_","_Decal_","_Decal_Scale_XY_","_Decal_Front_Only_","_Rim_Intensity_","_Rim_Texture_","_Rim_Hue_Shift_","_Rim_Saturation_Shift_","_Rim_Value_Shift_","_Iridescence_Intensity_","_Iridescence_Texture_","Use_Global_Left_Index","Use_Global_Right_Index","Global_Left_Index_Tip_Position","Global_Right_Index_Tip_Position","Global_Left_Thumb_Tip_Position","Global_Right_Thumb_Tip_Position","Global_Left_Index_Middle_Position;","Global_Right_Index_Middle_Position","Global_Left_Index_Tip_Proximity","Global_Right_Index_Tip_Proximity"],h=["_Rim_Texture_","_Iridescence_Texture_"],c=[];wi.PrepareUniformsAndSamplersList({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:i,maxSimultaneousLights:4}),t.setEffect(s.getEngine().createEffect(o,{attributes:r,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:a,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),i,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(i._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){if(!i.materialDefines)return;const s=i.effect;s&&(this._activeEffect=s,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",this.getScene().activeCamera.position),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Bevel_Front_",this.bevelFront),this._activeEffect.setFloat("_Bevel_Front_Stretch_",this.bevelFrontStretch),this._activeEffect.setFloat("_Bevel_Back_",this.bevelBack),this._activeEffect.setFloat("_Bevel_Back_Stretch_",this.bevelBackStretch),this._activeEffect.setFloat("_Radius_Top_Left_",this.radiusTopLeft),this._activeEffect.setFloat("_Radius_Top_Right_",this.radiusTopRight),this._activeEffect.setFloat("_Radius_Bottom_Left_",this.radiusBottomLeft),this._activeEffect.setFloat("_Radius_Bottom_Right_",this.radiusBottomRight),this._activeEffect.setFloat("_Bulge_Enabled_",this.bulgeEnabled?1:0),this._activeEffect.setFloat("_Bulge_Height_",this.bulgeHeight),this._activeEffect.setFloat("_Bulge_Radius_",this.bulgeRadius),this._activeEffect.setFloat("_Sun_Intensity_",this.sunIntensity),this._activeEffect.setFloat("_Sun_Theta_",this.sunTheta),this._activeEffect.setFloat("_Sun_Phi_",this.sunPhi),this._activeEffect.setFloat("_Indirect_Diffuse_",this.indirectDiffuse),this._activeEffect.setDirectColor4("_Albedo_",this.albedo),this._activeEffect.setFloat("_Specular_",this.specular),this._activeEffect.setFloat("_Shininess_",this.shininess),this._activeEffect.setFloat("_Sharpness_",this.sharpness),this._activeEffect.setFloat("_Subsurface_",this.subsurface),this._activeEffect.setDirectColor4("_Left_Color_",this.leftGradientColor),this._activeEffect.setDirectColor4("_Right_Color_",this.rightGradientColor),this._activeEffect.setFloat("_Reflection_",this.reflection),this._activeEffect.setFloat("_Front_Reflect_",this.frontReflect),this._activeEffect.setFloat("_Edge_Reflect_",this.edgeReflect),this._activeEffect.setFloat("_Power_",this.power),this._activeEffect.setDirectColor4("_Sky_Color_",this.skyColor),this._activeEffect.setDirectColor4("_Horizon_Color_",this.horizonColor),this._activeEffect.setDirectColor4("_Ground_Color_",this.groundColor),this._activeEffect.setFloat("_Horizon_Power_",this.horizonPower),this._activeEffect.setTexture("_Reflection_Map_",this._reflectionMapTexture),this._activeEffect.setTexture("_Indirect_Environment_",this._indirectEnvTexture),this._activeEffect.setFloat("_Width_",this.width),this._activeEffect.setFloat("_Fuzz_",this.fuzz),this._activeEffect.setFloat("_Min_Fuzz_",this.minFuzz),this._activeEffect.setFloat("_Clip_Fade_",this.clipFade),this._activeEffect.setFloat("_Hue_Shift_",this.hueShift),this._activeEffect.setFloat("_Saturation_Shift_",this.saturationShift),this._activeEffect.setFloat("_Value_Shift_",this.valueShift),this._activeEffect.setVector3("_Blob_Position_",this.blobPosition),this._activeEffect.setFloat("_Blob_Intensity_",this.blobIntensity),this._activeEffect.setFloat("_Blob_Near_Size_",this.blobNearSize),this._activeEffect.setFloat("_Blob_Far_Size_",this.blobFarSize),this._activeEffect.setFloat("_Blob_Near_Distance_",this.blobNearDistance),this._activeEffect.setFloat("_Blob_Far_Distance_",this.blobFarDistance),this._activeEffect.setFloat("_Blob_Fade_Length_",this.blobFadeLength),this._activeEffect.setFloat("_Blob_Pulse_",this.blobPulse),this._activeEffect.setFloat("_Blob_Fade_",this.blobFade),this._activeEffect.setTexture("_Blob_Texture_",this.blobTexture),this._activeEffect.setVector3("_Blob_Position_2_",this.blobPosition2),this._activeEffect.setFloat("_Blob_Near_Size_2_",this.blobNearSize2),this._activeEffect.setFloat("_Blob_Pulse_2_",this.blobPulse2),this._activeEffect.setFloat("_Blob_Fade_2_",this.blobFade2),this._activeEffect.setVector3("_Left_Index_Pos_",this.leftIndexPosition),this._activeEffect.setVector3("_Right_Index_Pos_",this.rightIndexPosition),this._activeEffect.setVector3("_Left_Index_Middle_Pos_",this.leftIndexMiddlePosition),this._activeEffect.setVector3("_Right_Index_Middle_Pos_",this.rightIndexMiddlePosition),this._activeEffect.setTexture("_Decal_",this._decalTexture),this._activeEffect.setVector2("_Decal_Scale_XY_",this.decalScaleXY),this._activeEffect.setFloat("_Decal_Front_Only_",this.decalFrontOnly?1:0),this._activeEffect.setFloat("_Rim_Intensity_",this.rimIntensity),this._activeEffect.setTexture("_Rim_Texture_",this._blueGradientTexture),this._activeEffect.setFloat("_Rim_Hue_Shift_",this.rimHueShift),this._activeEffect.setFloat("_Rim_Saturation_Shift_",this.rimSaturationShift),this._activeEffect.setFloat("_Rim_Value_Shift_",this.rimValueShift),this._activeEffect.setFloat("_Iridescence_Intensity_",this.iridescenceIntensity),this._activeEffect.setTexture("_Iridescence_Texture_",this._blueGradientTexture),this._activeEffect.setFloat("Use_Global_Left_Index",this.useGlobalLeftIndex),this._activeEffect.setFloat("Use_Global_Right_Index",this.useGlobalRightIndex),this._activeEffect.setVector4("Global_Left_Index_Tip_Position",this.globalLeftIndexTipPosition),this._activeEffect.setVector4("Global_Right_Index_Tip_Position",this.globaRightIndexTipPosition),this._activeEffect.setVector4("Global_Left_Thumb_Tip_Position",this.globalLeftThumbTipPosition),this._activeEffect.setVector4("Global_Right_Thumb_Tip_Position",this.globalRightThumbTipPosition),this._activeEffect.setVector4("Global_Left_Index_Middle_Position",this.globalLeftIndexMiddlePosition),this._activeEffect.setVector4("Global_Right_Index_Middle_Position",this.globalRightIndexMiddlePosition),this._activeEffect.setFloat("Global_Left_Index_Tip_Proximity",this.globalLeftIndexTipProximity),this._activeEffect.setFloat("Global_Right_Index_Tip_Proximity",this.globalRightIndexTipProximity),this._afterBind(t,this._activeEffect))}getAnimatables(){return[]}dispose(e){super.dispose(e),this._reflectionMapTexture.dispose(),this._indirectEnvTexture.dispose(),this._blueGradientTexture.dispose(),this._decalTexture.dispose()}clone(e){return qe.Clone((()=>new u_(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.MRDLSliderBarMaterial",e}getClassName(){return"MRDLSliderBarMaterial"}static Parse(e,t,i){return qe.Parse((()=>new u_(e.name,t)),e,t,i)}}u_.BLUE_GRADIENT_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/MRDL/mrtk-mrdl-blue-gradient.png",De([Ge()],u_.prototype,"radius",void 0),De([Ge()],u_.prototype,"bevelFront",void 0),De([Ge()],u_.prototype,"bevelFrontStretch",void 0),De([Ge()],u_.prototype,"bevelBack",void 0),De([Ge()],u_.prototype,"bevelBackStretch",void 0),De([Ge()],u_.prototype,"radiusTopLeft",void 0),De([Ge()],u_.prototype,"radiusTopRight",void 0),De([Ge()],u_.prototype,"radiusBottomLeft",void 0),De([Ge()],u_.prototype,"radiusBottomRight",void 0),De([Ge()],u_.prototype,"bulgeEnabled",void 0),De([Ge()],u_.prototype,"bulgeHeight",void 0),De([Ge()],u_.prototype,"bulgeRadius",void 0),De([Ge()],u_.prototype,"sunIntensity",void 0),De([Ge()],u_.prototype,"sunTheta",void 0),De([Ge()],u_.prototype,"sunPhi",void 0),De([Ge()],u_.prototype,"indirectDiffuse",void 0),De([Ge()],u_.prototype,"albedo",void 0),De([Ge()],u_.prototype,"specular",void 0),De([Ge()],u_.prototype,"shininess",void 0),De([Ge()],u_.prototype,"sharpness",void 0),De([Ge()],u_.prototype,"subsurface",void 0),De([Ge()],u_.prototype,"leftGradientColor",void 0),De([Ge()],u_.prototype,"rightGradientColor",void 0),De([Ge()],u_.prototype,"reflection",void 0),De([Ge()],u_.prototype,"frontReflect",void 0),De([Ge()],u_.prototype,"edgeReflect",void 0),De([Ge()],u_.prototype,"power",void 0),De([Ge()],u_.prototype,"skyColor",void 0),De([Ge()],u_.prototype,"horizonColor",void 0),De([Ge()],u_.prototype,"groundColor",void 0),De([Ge()],u_.prototype,"horizonPower",void 0),De([Ge()],u_.prototype,"width",void 0),De([Ge()],u_.prototype,"fuzz",void 0),De([Ge()],u_.prototype,"minFuzz",void 0),De([Ge()],u_.prototype,"clipFade",void 0),De([Ge()],u_.prototype,"hueShift",void 0),De([Ge()],u_.prototype,"saturationShift",void 0),De([Ge()],u_.prototype,"valueShift",void 0),De([Ge()],u_.prototype,"blobPosition",void 0),De([Ge()],u_.prototype,"blobIntensity",void 0),De([Ge()],u_.prototype,"blobNearSize",void 0),De([Ge()],u_.prototype,"blobFarSize",void 0),De([Ge()],u_.prototype,"blobNearDistance",void 0),De([Ge()],u_.prototype,"blobFarDistance",void 0),De([Ge()],u_.prototype,"blobFadeLength",void 0),De([Ge()],u_.prototype,"blobPulse",void 0),De([Ge()],u_.prototype,"blobFade",void 0),De([Ge()],u_.prototype,"blobPosition2",void 0),De([Ge()],u_.prototype,"blobNearSize2",void 0),De([Ge()],u_.prototype,"blobPulse2",void 0),De([Ge()],u_.prototype,"blobFade2",void 0),De([Ge()],u_.prototype,"blobTexture",void 0),De([Ge()],u_.prototype,"leftIndexPosition",void 0),De([Ge()],u_.prototype,"rightIndexPosition",void 0),De([Ge()],u_.prototype,"leftIndexMiddlePosition",void 0),De([Ge()],u_.prototype,"rightIndexMiddlePosition",void 0),De([Ge()],u_.prototype,"decalScaleXY",void 0),De([Ge()],u_.prototype,"decalFrontOnly",void 0),De([Ge()],u_.prototype,"rimIntensity",void 0),De([Ge()],u_.prototype,"rimHueShift",void 0),De([Ge()],u_.prototype,"rimSaturationShift",void 0),De([Ge()],u_.prototype,"rimValueShift",void 0),De([Ge()],u_.prototype,"iridescenceIntensity",void 0),ue("BABYLON.GUI.MRDLSliderBarMaterial",u_);F.ShadersStore.mrdlSliderThumbPixelShader="uniform vec3 cameraPosition;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;uniform float _Radius_;uniform float _Bevel_Front_;uniform float _Bevel_Front_Stretch_;uniform float _Bevel_Back_;uniform float _Bevel_Back_Stretch_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform bool _Bulge_Enabled_;uniform float _Bulge_Height_;uniform float _Bulge_Radius_;uniform float _Sun_Intensity_;uniform float _Sun_Theta_;uniform float _Sun_Phi_;uniform float _Indirect_Diffuse_;uniform vec4 _Albedo_;uniform float _Specular_;uniform float _Shininess_;uniform float _Sharpness_;uniform float _Subsurface_;uniform vec4 _Left_Color_;uniform vec4 _Right_Color_;uniform float _Reflection_;uniform float _Front_Reflect_;uniform float _Edge_Reflect_;uniform float _Power_;uniform vec4 _Sky_Color_;uniform vec4 _Horizon_Color_;uniform vec4 _Ground_Color_;uniform float _Horizon_Power_;uniform sampler2D _Reflection_Map_;uniform sampler2D _Indirect_Environment_;uniform float _Width_;uniform float _Fuzz_;uniform float _Min_Fuzz_;uniform float _Clip_Fade_;uniform float _Hue_Shift_;uniform float _Saturation_Shift_;uniform float _Value_Shift_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Left_Index_Pos_;uniform vec3 _Right_Index_Pos_;uniform vec3 _Left_Index_Middle_Pos_;uniform vec3 _Right_Index_Middle_Pos_;uniform sampler2D _Decal_;uniform vec2 _Decal_Scale_XY_;uniform bool _Decal_Front_Only_;uniform float _Rim_Intensity_;uniform sampler2D _Rim_Texture_;uniform float _Rim_Hue_Shift_;uniform float _Rim_Saturation_Shift_;uniform float _Rim_Value_Shift_;uniform float _Iridescence_Intensity_;uniform sampler2D _Iridescence_Texture_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform vec4 Global_Left_Index_Middle_Position;uniform vec4 Global_Right_Index_Middle_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;void Blob_Fragment_B180(\nsampler2D Blob_Texture,\nvec4 Blob_Info1,\nvec4 Blob_Info2,\nout vec4 Blob_Color)\n{float k1=dot(Blob_Info1.xy,Blob_Info1.xy);float k2=dot(Blob_Info2.xy,Blob_Info2.xy);vec3 closer=k1<k2 ? vec3(k1,Blob_Info1.z,Blob_Info1.w) : vec3(k2,Blob_Info2.z,Blob_Info2.w);Blob_Color=closer.z*texture(Blob_Texture,vec2(vec2(sqrt(closer.x),closer.y).x,1.0-vec2(sqrt(closer.x),closer.y).y))*clamp(1.0-closer.x,0.0,1.0);}\nvoid FastLinearTosRGB_B192(\nvec4 Linear,\nout vec4 sRGB)\n{sRGB.rgb=sqrt(clamp(Linear.rgb,0.0,1.0));sRGB.a=Linear.a;}\nvoid Scale_RGB_B209(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Fragment_Main_B271(\nfloat Sun_Intensity,\nfloat Sun_Theta,\nfloat Sun_Phi,\nvec3 Normal,\nvec4 Albedo,\nfloat Fresnel_Reflect,\nfloat Shininess,\nvec3 Incident,\nvec4 Horizon_Color,\nvec4 Sky_Color,\nvec4 Ground_Color,\nfloat Indirect_Diffuse,\nfloat Specular,\nfloat Horizon_Power,\nfloat Reflection,\nvec4 Reflection_Sample,\nvec4 Indirect_Sample,\nfloat Sharpness,\nfloat SSS,\nfloat Subsurface,\nvec4 Translucence,\nvec4 Rim_Light,\nvec4 Iridescence,\nout vec4 Result)\n{float theta=Sun_Theta*2.0*3.14159;float phi=Sun_Phi*3.14159;vec3 lightDir= vec3(cos(phi)*cos(theta),sin(phi),cos(phi)*sin(theta));float NdotL=max(dot(lightDir,Normal),0.0);vec3 R=reflect(Incident,Normal);float RdotL=max(0.0,dot(R,lightDir));float specular=pow(RdotL,Shininess);specular=mix(specular,smoothstep(0.495*Sharpness,1.0-0.495*Sharpness,specular),Sharpness);vec4 gi=mix(Ground_Color,Sky_Color,Normal.y*0.5+0.5);Result=((Sun_Intensity*NdotL+Indirect_Sample*Indirect_Diffuse+Translucence)*(1.0+SSS*Subsurface))*Albedo*(1.0-Fresnel_Reflect)+(Sun_Intensity*specular*Specular+Fresnel_Reflect*Reflection*Reflection_Sample)+Fresnel_Reflect*Rim_Light+Iridescence;}\nvoid Bulge_B229(\nbool Enabled,\nvec3 Normal,\nvec3 Tangent,\nfloat Bulge_Height,\nvec4 UV,\nfloat Bulge_Radius,\nvec3 ButtonN,\nout vec3 New_Normal)\n{vec2 xy=clamp(UV.xy*2.0,vec2(-1,-1),vec2(1,1));vec3 B=(cross(Normal,Tangent));float k=-clamp(1.0-length(xy)/Bulge_Radius,0.0,1.0)*Bulge_Height;k=sin(k*3.14159*0.5);k*=smoothstep(0.9998,0.9999,abs(dot(ButtonN,Normal)));New_Normal=Normal*sqrt(1.0-k*k)+(xy.x*Tangent+xy.y*B)*k;New_Normal=Enabled ? New_Normal : Normal;}\nvoid SSS_B227(\nvec3 ButtonN,\nvec3 Normal,\nvec3 Incident,\nout float Result)\n{float NdotI=abs(dot(Normal,Incident));float BdotI=abs(dot(ButtonN,Incident));Result=(abs(NdotI-BdotI)); }\nvoid FingerOcclusion_B217(\nfloat Width,\nfloat DistToCenter,\nfloat Fuzz,\nfloat Min_Fuzz,\nvec3 Position,\nvec3 Forward,\nvec3 Nearest,\nfloat Fade_Out,\nout float NotInShadow)\n{float d=dot((Nearest-Position),Forward);float sh=smoothstep(Width*0.5,Width*0.5+Fuzz*max(d,0.0)+Min_Fuzz,DistToCenter);NotInShadow=1.0-(1.0-sh)*smoothstep(-Fade_Out,0.0,d);}\nvoid FingerOcclusion_B218(\nfloat Width,\nfloat DistToCenter,\nfloat Fuzz,\nfloat Min_Fuzz,\nvec3 Position,\nvec3 Forward,\nvec3 Nearest,\nfloat Fade_Out,\nout float NotInShadow)\n{float d=dot((Nearest-Position),Forward);float sh=smoothstep(Width*0.5,Width*0.5+Fuzz*max(d,0.0)+Min_Fuzz,DistToCenter);NotInShadow=1.0-(1.0-sh)*smoothstep(-Fade_Out,0.0,d);}\nvoid Scale_Color_B241(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=Scalar*Color;}\nvoid From_HSV_B223(\nfloat Hue,\nfloat Saturation,\nfloat Value,\nfloat Alpha,\nout vec4 Color)\n{vec4 K=vec4(1.0,2.0/3.0,1.0/3.0,3.0);vec3 p=abs(fract(vec3(Hue,Hue,Hue)+K.xyz)*6.0-K.www);Color.rgb=Value*mix(K.xxx,clamp(p-K.xxx,0.0,1.0),Saturation);Color.a=Alpha;}\nvoid Fast_Fresnel_B272(\nfloat Front_Reflect,\nfloat Edge_Reflect,\nfloat Power,\nvec3 Normal,\nvec3 Incident,\nout float Transmit,\nout float Reflect)\n{float d=max(-dot(Incident,Normal),0.0);Reflect=Front_Reflect+(Edge_Reflect-Front_Reflect)*pow(1.0-d,Power);Transmit=1.0-Reflect;}\nvoid Mapped_Environment_B201(\nsampler2D Reflected_Environment,\nsampler2D Indirect_Environment,\nvec3 Dir,\nout vec4 Reflected_Color,\nout vec4 Indirect_Diffuse)\n{Reflected_Color=texture(Reflected_Environment,vec2(atan(Dir.z,Dir.x)/3.14159*0.5,asin(Dir.y)/3.14159+0.5));Indirect_Diffuse=texture(Indirect_Environment,vec2(atan(Dir.z,Dir.x)/3.14159*0.5,asin(Dir.y)/3.14159+0.5));}\nvec4 SampleEnv_Bid200(vec3 D,vec4 S,vec4 H,vec4 G,float exponent)\n{float k=pow(abs(D.y),exponent);vec4 C;if (D.y>0.0) {C=mix(H,S,k);} else {C=mix(H,G,k); }\nreturn C;}\nvoid Sky_Environment_B200(\nvec3 Normal,\nvec3 Reflected,\nvec4 Sky_Color,\nvec4 Horizon_Color,\nvec4 Ground_Color,\nfloat Horizon_Power,\nout vec4 Reflected_Color,\nout vec4 Indirect_Color)\n{Reflected_Color=SampleEnv_Bid200(Reflected,Sky_Color,Horizon_Color,Ground_Color,Horizon_Power);Indirect_Color=mix(Ground_Color,Sky_Color,Normal.y*0.5+0.5);}\nvoid Min_Segment_Distance_B215(\nvec3 P0,\nvec3 P1,\nvec3 Q0,\nvec3 Q1,\nout vec3 NearP,\nout vec3 NearQ,\nout float Distance)\n{vec3 u=P1-P0;vec3 v=Q1-Q0;vec3 w=P0-Q0;float a=dot(u,u);float b=dot(u,v);float c=dot(v,v);float d=dot(u,w);float e=dot(v,w);float D=a*c-b*b;float sD=D;float tD=D;float sc,sN,tc,tN;if (D<0.00001) {sN=0.0;sD=1.0;tN=e;tD=c;} else {sN=(b*e-c*d);tN=(a*e-b*d);if (sN<0.0) {sN=0.0;tN=e;tD=c;} else if (sN>sD) {sN=sD;tN=e+b;tD=c;}}\nif (tN<0.0) {tN=0.0;if (-d<0.0) {sN=0.0;} else if (-d>a) {sN=sD;} else {sN=-d;sD=a;}} else if (tN>tD) {tN=tD;if ((-d+b)<0.0) {sN=0.0;} else if ((-d+b)>a) {sN=sD;} else {sN=(-d+b);sD=a;}}\nsc=abs(sN)<0.000001 ? 0.0 : sN/sD;tc=abs(tN)<0.000001 ? 0.0 : tN/tD;NearP=P0+sc*u;NearQ=Q0+tc*v;Distance=distance(NearP,NearQ);}\nvoid To_XYZ_B224(\nvec3 Vec3,\nout float X,\nout float Y,\nout float Z)\n{X=Vec3.x;Y=Vec3.y;Z=Vec3.z;}\nvoid Finger_Positions_B214(\nvec3 Left_Index_Pos,\nvec3 Right_Index_Pos,\nvec3 Left_Index_Middle_Pos,\nvec3 Right_Index_Middle_Pos,\nout vec3 Left_Index,\nout vec3 Right_Index,\nout vec3 Left_Index_Middle,\nout vec3 Right_Index_Middle)\n{Left_Index= (Use_Global_Left_Index ? Global_Left_Index_Tip_Position.xyz : Left_Index_Pos);Right_Index= (Use_Global_Right_Index ? Global_Right_Index_Tip_Position.xyz : Right_Index_Pos);Left_Index_Middle= (Use_Global_Left_Index ? Global_Left_Index_Middle_Position.xyz : Left_Index_Middle_Pos);Right_Index_Middle= (Use_Global_Right_Index ? Global_Right_Index_Middle_Position.xyz : Right_Index_Middle_Pos);}\nvoid VaryHSV_B258(\nvec3 HSV_In,\nfloat Hue_Shift,\nfloat Saturation_Shift,\nfloat Value_Shift,\nout vec3 HSV_Out)\n{HSV_Out=vec3(fract(HSV_In.x+Hue_Shift),clamp(HSV_In.y+Saturation_Shift,0.0,1.0),clamp(HSV_In.z+Value_Shift,0.0,1.0));}\nvoid Remap_Range_B264(\nfloat In_Min,\nfloat In_Max,\nfloat Out_Min,\nfloat Out_Max,\nfloat In,\nout float Out)\n{Out=mix(Out_Min,Out_Max,clamp((In-In_Min)/(In_Max-In_Min),0.0,1.0));}\nvoid To_HSV_B225(\nvec4 Color,\nout float Hue,\nout float Saturation,\nout float Value,\nout float Alpha,\nout vec3 HSV)\n{vec4 K=vec4(0.0,-1.0/3.0,2.0/3.0,-1.0);vec4 p=Color.g<Color.b ? vec4(Color.bg,K.wz) : vec4(Color.gb,K.xy);vec4 q=Color.r<p.x ? vec4(p.xyw,Color.r) : vec4(Color.r,p.yzx);float d=q.x-min(q.w,q.y);float e=1.0e-10;Hue=abs(q.z+(q.w-q.y)/(6.0*d+e));Saturation=d/(q.x+e);Value=q.x;Alpha=Color.a;HSV=vec3(Hue,Saturation,Value);}\nvoid Code_B260(\nfloat X,\nout float Result)\n{Result=(acos(X)/3.14159-0.5)*2.0;}\nvoid Rim_Light_B282(\nvec3 Front,\nvec3 Normal,\nvec3 Incident,\nfloat Rim_Intensity,\nsampler2D Texture,\nout vec4 Result)\n{vec3 R=reflect(Incident,Normal);float RdotF=dot(R,Front);float RdotL=sqrt(1.0-RdotF*RdotF);vec2 UV=vec2(R.y*0.5+0.5,0.5);vec4 Color=texture(Texture,UV);Result=Color;}\nvoid main()\n{vec4 Blob_Color_Q180;\n#if BLOB_ENABLE\nBlob_Fragment_B180(_Blob_Texture_,vExtra2,vExtra3,Blob_Color_Q180);\n#else\nBlob_Color_Q180=vec4(0,0,0,0);\n#endif\nvec3 Incident_Q189=normalize(vPosition-cameraPosition);vec3 Normalized_Q188=normalize(vNormal);vec3 Normalized_Q221=normalize(vTangent);vec4 Color_Q233;\n#if DECAL_ENABLE\nColor_Q233=texture(_Decal_,vUV);\n#else\nColor_Q233=vec4(0,0,0,0);\n#endif\nfloat X_Q240;float Y_Q240;float Z_Q240;float W_Q240;X_Q240=vExtra1.x;Y_Q240=vExtra1.y;Z_Q240=vExtra1.z;W_Q240=vExtra1.w;vec4 Linear_Q193;Linear_Q193.rgb=clamp(_Sky_Color_.rgb*_Sky_Color_.rgb,0.0,1.0);Linear_Q193.a=_Sky_Color_.a;vec4 Linear_Q194;Linear_Q194.rgb=clamp(_Horizon_Color_.rgb*_Horizon_Color_.rgb,0.0,1.0);Linear_Q194.a=_Horizon_Color_.a;vec4 Linear_Q195;Linear_Q195.rgb=clamp(_Ground_Color_.rgb*_Ground_Color_.rgb,0.0,1.0);Linear_Q195.a=_Ground_Color_.a;vec3 Left_Index_Q214;vec3 Right_Index_Q214;vec3 Left_Index_Middle_Q214;vec3 Right_Index_Middle_Q214;Finger_Positions_B214(_Left_Index_Pos_,_Right_Index_Pos_,_Left_Index_Middle_Pos_,_Right_Index_Middle_Pos_,Left_Index_Q214,Right_Index_Q214,Left_Index_Middle_Q214,Right_Index_Middle_Q214);vec4 Linear_Q196;Linear_Q196.rgb=clamp(_Albedo_.rgb*_Albedo_.rgb,0.0,1.0);Linear_Q196.a=_Albedo_.a;vec3 Normalized_Q257=normalize(vBinormal);vec3 Incident_Q220=normalize(vPosition-cameraPosition);vec3 New_Normal_Q229;Bulge_B229(_Bulge_Enabled_,Normalized_Q188,Normalized_Q221,_Bulge_Height_,vColor,_Bulge_Radius_,vBinormal,New_Normal_Q229);float Result_Q227;SSS_B227(vBinormal,New_Normal_Q229,Incident_Q189,Result_Q227);vec4 Result_Q241;Scale_Color_B241(Color_Q233,X_Q240,Result_Q241);float Transmit_Q272;float Reflect_Q272;Fast_Fresnel_B272(_Front_Reflect_,_Edge_Reflect_,_Power_,New_Normal_Q229,Incident_Q189,Transmit_Q272,Reflect_Q272);float Product_Q275=Y_Q240*Y_Q240;vec3 NearP_Q215;vec3 NearQ_Q215;float Distance_Q215;Min_Segment_Distance_B215(Left_Index_Q214,Left_Index_Middle_Q214,vPosition,cameraPosition,NearP_Q215,NearQ_Q215,Distance_Q215);vec3 NearP_Q213;vec3 NearQ_Q213;float Distance_Q213;Min_Segment_Distance_B215(Right_Index_Q214,Right_Index_Middle_Q214,vPosition,cameraPosition,NearP_Q213,NearQ_Q213,Distance_Q213);vec3 Reflected_Q197=reflect(Incident_Q189,New_Normal_Q229);vec4 Product_Q253=Linear_Q196*vec4(1,1,1,1);vec4 Result_Q282;Rim_Light_B282(Normalized_Q257,Normalized_Q188,Incident_Q220,_Rim_Intensity_,_Rim_Texture_,Result_Q282);float Dot_Q222=dot(Incident_Q220, Normalized_Q221);float MaxAB_Q273=max(Reflect_Q272,Product_Q275);float NotInShadow_Q217;\n#if OCCLUSION_ENABLED\nFingerOcclusion_B217(_Width_,Distance_Q215,_Fuzz_,_Min_Fuzz_,vPosition,vBinormal,NearP_Q215,_Clip_Fade_,NotInShadow_Q217);\n#else\nNotInShadow_Q217=1.0;\n#endif\nfloat NotInShadow_Q218;\n#if OCCLUSION_ENABLED\nFingerOcclusion_B218(_Width_,Distance_Q213,_Fuzz_,_Min_Fuzz_,vPosition,vBinormal,NearP_Q213,_Clip_Fade_,NotInShadow_Q218);\n#else\nNotInShadow_Q218=1.0;\n#endif\nvec4 Reflected_Color_Q201;vec4 Indirect_Diffuse_Q201;\n#if ENV_ENABLE\nMapped_Environment_B201(_Reflection_Map_,_Indirect_Environment_,Reflected_Q197,Reflected_Color_Q201,Indirect_Diffuse_Q201);\n#else\nReflected_Color_Q201=vec4(0,0,0,1);Indirect_Diffuse_Q201=vec4(0,0,0,1);\n#endif\nvec4 Reflected_Color_Q200;vec4 Indirect_Color_Q200;\n#if SKY_ENABLED\nSky_Environment_B200(New_Normal_Q229,Reflected_Q197,Linear_Q193,Linear_Q194,Linear_Q195,_Horizon_Power_,Reflected_Color_Q200,Indirect_Color_Q200);\n#else\nReflected_Color_Q200=vec4(0,0,0,1);Indirect_Color_Q200=vec4(0,0,0,1);\n#endif\nfloat Hue_Q225;float Saturation_Q225;float Value_Q225;float Alpha_Q225;vec3 HSV_Q225;To_HSV_B225(Product_Q253,Hue_Q225,Saturation_Q225,Value_Q225,Alpha_Q225,HSV_Q225);float Hue_Q277;float Saturation_Q277;float Value_Q277;float Alpha_Q277;vec3 HSV_Q277;To_HSV_B225(Result_Q282,Hue_Q277,Saturation_Q277,Value_Q277,Alpha_Q277,HSV_Q277);float Result_Q260;Code_B260(Dot_Q222,Result_Q260);float AbsA_Q226=abs(Result_Q260);float MinAB_Q208=min(NotInShadow_Q217,NotInShadow_Q218);vec4 Sum_Q198=Reflected_Color_Q201+Reflected_Color_Q200;vec4 Sum_Q199=Indirect_Diffuse_Q201+Indirect_Color_Q200;vec3 HSV_Out_Q276;VaryHSV_B258(HSV_Q277,_Rim_Hue_Shift_,_Rim_Saturation_Shift_,_Rim_Value_Shift_,HSV_Out_Q276);float Out_Q264;Remap_Range_B264(-1.0,1.0,0.0,1.0,Result_Q260,Out_Q264);float Product_Q256;Product_Q256=AbsA_Q226*_Hue_Shift_;float X_Q278;float Y_Q278;float Z_Q278;To_XYZ_B224(HSV_Out_Q276,X_Q278,Y_Q278,Z_Q278);vec2 Vec2_Q262=vec2(Out_Q264,0.5);vec3 HSV_Out_Q258;VaryHSV_B258(HSV_Q225,Product_Q256,_Saturation_Shift_,_Value_Shift_,HSV_Out_Q258);vec4 Color_Q279;From_HSV_B223(X_Q278,Y_Q278,Z_Q278,0.0,Color_Q279);vec4 Color_Q261;\n#if IRIDESCENCE_ENABLED\nColor_Q261=texture(_Iridescence_Texture_,Vec2_Q262);\n#else\nColor_Q261=vec4(0,0,0,0);\n#endif\nfloat X_Q224;float Y_Q224;float Z_Q224;To_XYZ_B224(HSV_Out_Q258,X_Q224,Y_Q224,Z_Q224);vec4 Result_Q281=_Rim_Intensity_*Color_Q279;vec4 Result_Q263=_Iridescence_Intensity_*Color_Q261;vec4 Color_Q223;From_HSV_B223(X_Q224,Y_Q224,Z_Q224,0.0,Color_Q223);vec4 Result_Q234=Result_Q241+(1.0-Result_Q241.a)*Color_Q223;vec4 Result_Q271;Fragment_Main_B271(_Sun_Intensity_,_Sun_Theta_,_Sun_Phi_,New_Normal_Q229,Result_Q234,MaxAB_Q273,_Shininess_,Incident_Q189,_Horizon_Color_,_Sky_Color_,_Ground_Color_,_Indirect_Diffuse_,_Specular_,_Horizon_Power_,_Reflection_,Sum_Q198,Sum_Q199,_Sharpness_,Result_Q227,_Subsurface_,vec4(0,0,0,0),Result_Q281,Result_Q263,Result_Q271);vec4 Result_Q209;Scale_RGB_B209(Result_Q271,MinAB_Q208,Result_Q209);vec4 sRGB_Q192;FastLinearTosRGB_B192(Result_Q209,sRGB_Q192);vec4 Result_Q181=Blob_Color_Q180+(1.0-Blob_Color_Q180.a)*sRGB_Q192;vec4 Result_Q190=Result_Q181; Result_Q190.a=1.0;vec4 Out_Color=Result_Q190;float Clip_Threshold=0.001;bool To_sRGB=false;gl_FragColor=Out_Color;}";F.ShadersStore.mrdlSliderThumbVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;\n#ifdef TANGENT\nattribute vec3 tangent;\n#else\nconst vec3 tangent=vec3(0.);\n#endif\nuniform float _Radius_;uniform float _Bevel_Front_;uniform float _Bevel_Front_Stretch_;uniform float _Bevel_Back_;uniform float _Bevel_Back_Stretch_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform bool _Bulge_Enabled_;uniform float _Bulge_Height_;uniform float _Bulge_Radius_;uniform float _Sun_Intensity_;uniform float _Sun_Theta_;uniform float _Sun_Phi_;uniform float _Indirect_Diffuse_;uniform vec4 _Albedo_;uniform float _Specular_;uniform float _Shininess_;uniform float _Sharpness_;uniform float _Subsurface_;uniform vec4 _Left_Color_;uniform vec4 _Right_Color_;uniform float _Reflection_;uniform float _Front_Reflect_;uniform float _Edge_Reflect_;uniform float _Power_;uniform vec4 _Sky_Color_;uniform vec4 _Horizon_Color_;uniform vec4 _Ground_Color_;uniform float _Horizon_Power_;uniform sampler2D _Reflection_Map_;uniform sampler2D _Indirect_Environment_;uniform float _Width_;uniform float _Fuzz_;uniform float _Min_Fuzz_;uniform float _Clip_Fade_;uniform float _Hue_Shift_;uniform float _Saturation_Shift_;uniform float _Value_Shift_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform sampler2D _Blob_Texture_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform vec3 _Left_Index_Pos_;uniform vec3 _Right_Index_Pos_;uniform vec3 _Left_Index_Middle_Pos_;uniform vec3 _Right_Index_Middle_Pos_;uniform sampler2D _Decal_;uniform vec2 _Decal_Scale_XY_;uniform bool _Decal_Front_Only_;uniform float _Rim_Intensity_;uniform sampler2D _Rim_Texture_;uniform float _Rim_Hue_Shift_;uniform float _Rim_Saturation_Shift_;uniform float _Rim_Value_Shift_;uniform float _Iridescence_Intensity_;uniform sampler2D _Iridescence_Texture_;uniform bool Use_Global_Left_Index;uniform bool Use_Global_Right_Index;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;uniform vec4 Global_Left_Thumb_Tip_Position;uniform vec4 Global_Right_Thumb_Tip_Position;uniform float Global_Left_Index_Tip_Proximity;uniform float Global_Right_Index_Tip_Proximity;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vColor;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;void Object_To_World_Pos_B162(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid Object_To_World_Normal_B182(\nvec3 Nrm_Object,\nout vec3 Nrm_World)\n{Nrm_World=(vec4(Nrm_Object,0.0)).xyz;}\nvoid Blob_Vertex_B173(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nfloat Blob_Fade_Length,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nout vec4 Blob_Info)\n{vec3 blob= (Use_Global_Left_Index ? Global_Left_Index_Tip_Position.xyz : Blob_Position);vec3 delta=blob-Position;float dist=dot(Normal,delta);float lerpValue=clamp((abs(dist)-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);float fadeValue=1.0-clamp((abs(dist)-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float size=Blob_Near_Size+(Blob_Far_Size-Blob_Near_Size)*lerpValue;vec2 blobXY=vec2(dot(delta,Tangent),dot(delta,Bitangent))/(0.0001+size);float Fade=fadeValue*Intensity*Blob_Fade;float Distance=(lerpValue*0.5+0.5)*(1.0-Blob_Pulse);Blob_Info=vec4(blobXY.x,blobXY.y,Distance,Fade);}\nvoid Blob_Vertex_B174(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nfloat Blob_Fade_Length,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nout vec4 Blob_Info)\n{vec3 blob= (Use_Global_Right_Index ? Global_Right_Index_Tip_Position.xyz : Blob_Position);vec3 delta=blob-Position;float dist=dot(Normal,delta);float lerpValue=clamp((abs(dist)-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);float fadeValue=1.0-clamp((abs(dist)-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float size=Blob_Near_Size+(Blob_Far_Size-Blob_Near_Size)*lerpValue;vec2 blobXY=vec2(dot(delta,Tangent),dot(delta,Bitangent))/(0.0001+size);float Fade=fadeValue*Intensity*Blob_Fade;float Distance=(lerpValue*0.5+0.5)*(1.0-Blob_Pulse);Blob_Info=vec4(blobXY.x,blobXY.y,Distance,Fade);}\nvoid Move_Verts_B280(\nfloat Anisotropy,\nvec3 P,\nfloat Radius,\nfloat Bevel,\nvec3 Normal_Object,\nfloat ScaleZ,\nfloat Stretch,\nout vec3 New_P,\nout vec2 New_UV,\nout float Radial_Gradient,\nout vec3 Radial_Dir,\nout vec3 New_Normal)\n{vec2 UV=P.xy*2.0+0.5;vec2 center=clamp(UV,0.0,1.0);vec2 delta=UV-center;float deltad=(length(delta)*2.0);float f=(Bevel+(Radius-Bevel)*Stretch)/Radius;float innerd=clamp(deltad*2.0,0.0,1.0);float outerd=clamp(deltad*2.0-1.0,0.0,1.0);float bevelAngle=outerd*3.14159*0.5;float sinb=sin(bevelAngle);float cosb=cos(bevelAngle);float beveld=(1.0-f)*innerd+f*sinb;float br=outerd;vec2 r2=2.0*vec2(Radius/Anisotropy,Radius);float dir=P.z<0.0001 ? 1.0 : -1.0;New_UV=center+r2*((0.5-center)+normalize(delta+vec2(0.0,0.000001))*beveld*0.5);New_P=vec3(New_UV-0.5,P.z+dir*(1.0-cosb)*Bevel*ScaleZ);Radial_Gradient=clamp((deltad-0.5)*2.0,0.0,1.0);Radial_Dir=vec3(delta*r2,0.0);vec3 beveledNormal=cosb*Normal_Object+sinb*vec3(delta.x,delta.y,0.0);New_Normal=Normal_Object.z==0.0 ? Normal_Object : beveledNormal;}\nvoid Object_To_World_Dir_B210(\nvec3 Dir_Object,\nout vec3 Normal_World,\nout vec3 Normal_World_N,\nout float Normal_Length)\n{Normal_World=(world*vec4(Dir_Object,0.0)).xyz;Normal_Length=length(Normal_World);Normal_World_N=Normal_World/Normal_Length;}\nvoid To_XYZ_B228(\nvec3 Vec3,\nout float X,\nout float Y,\nout float Z)\n{X=Vec3.x;Y=Vec3.y;Z=Vec3.z;}\nvoid Conditional_Float_B243(\nbool Which,\nfloat If_True,\nfloat If_False,\nout float Result)\n{Result=Which ? If_True : If_False;}\nvoid Object_To_World_Dir_B178(\nvec3 Dir_Object,\nout vec3 Binormal_World,\nout vec3 Binormal_World_N,\nout float Binormal_Length)\n{Binormal_World=(world*vec4(Dir_Object,0.0)).xyz;Binormal_Length=length(Binormal_World);Binormal_World_N=Binormal_World/Binormal_Length;}\nvoid Pick_Radius_B219(\nfloat Radius,\nfloat Radius_Top_Left,\nfloat Radius_Top_Right,\nfloat Radius_Bottom_Left,\nfloat Radius_Bottom_Right,\nvec3 Position,\nout float Result)\n{bool whichY=Position.y>0.0;Result=Position.x<0.0 ? (whichY ? Radius_Top_Left : Radius_Bottom_Left) : (whichY ? Radius_Top_Right : Radius_Bottom_Right);Result*=Radius;}\nvoid Conditional_Float_B186(\nbool Which,\nfloat If_True,\nfloat If_False,\nout float Result)\n{Result=Which ? If_True : If_False;}\nvoid Greater_Than_B187(\nfloat Left,\nfloat Right,\nout bool Not_Greater_Than,\nout bool Greater_Than)\n{Greater_Than=Left>Right;Not_Greater_Than=!Greater_Than;}\nvoid Remap_Range_B255(\nfloat In_Min,\nfloat In_Max,\nfloat Out_Min,\nfloat Out_Max,\nfloat In,\nout float Out)\n{Out=mix(Out_Min,Out_Max,clamp((In-In_Min)/(In_Max-In_Min),0.0,1.0));}\nvoid main()\n{vec2 XY_Q235;XY_Q235=(uv-vec2(0.5,0.5))*_Decal_Scale_XY_+vec2(0.5,0.5);vec3 Tangent_World_Q177;vec3 Tangent_World_N_Q177;float Tangent_Length_Q177;Tangent_World_Q177=(world*vec4(vec3(1,0,0),0.0)).xyz;Tangent_Length_Q177=length(Tangent_World_Q177);Tangent_World_N_Q177=Tangent_World_Q177/Tangent_Length_Q177;vec3 Normal_World_Q210;vec3 Normal_World_N_Q210;float Normal_Length_Q210;Object_To_World_Dir_B210(vec3(0,0,1),Normal_World_Q210,Normal_World_N_Q210,Normal_Length_Q210);float X_Q228;float Y_Q228;float Z_Q228;To_XYZ_B228(position,X_Q228,Y_Q228,Z_Q228);vec3 Nrm_World_Q176;Nrm_World_Q176=normalize((world*vec4(normal,0.0)).xyz);vec3 Binormal_World_Q178;vec3 Binormal_World_N_Q178;float Binormal_Length_Q178;Object_To_World_Dir_B178(vec3(0,1,0),Binormal_World_Q178,Binormal_World_N_Q178,Binormal_Length_Q178);float Anisotropy_Q179=Tangent_Length_Q177/Binormal_Length_Q178;float Result_Q219;Pick_Radius_B219(_Radius_,_Radius_Top_Left_,_Radius_Top_Right_,_Radius_Bottom_Left_,_Radius_Bottom_Right_,position,Result_Q219);float Anisotropy_Q203=Binormal_Length_Q178/Normal_Length_Q210;bool Not_Greater_Than_Q187;bool Greater_Than_Q187;Greater_Than_B187(Z_Q228,0.0,Not_Greater_Than_Q187,Greater_Than_Q187);vec4 Linear_Q251;Linear_Q251.rgb=clamp(_Left_Color_.rgb*_Left_Color_.rgb,0.0,1.0);Linear_Q251.a=_Left_Color_.a;vec4 Linear_Q252;Linear_Q252.rgb=clamp(_Right_Color_.rgb*_Right_Color_.rgb,0.0,1.0);Linear_Q252.a=_Right_Color_.a;vec3 Difference_Q211=vec3(0,0,0)-Normal_World_N_Q210;vec4 Out_Color_Q184=vec4(X_Q228,Y_Q228,Z_Q228,1);float Result_Q186;Conditional_Float_B186(Greater_Than_Q187,_Bevel_Back_,_Bevel_Front_,Result_Q186);float Result_Q244;Conditional_Float_B186(Greater_Than_Q187,_Bevel_Back_Stretch_,_Bevel_Front_Stretch_,Result_Q244);vec3 New_P_Q280;vec2 New_UV_Q280;float Radial_Gradient_Q280;vec3 Radial_Dir_Q280;vec3 New_Normal_Q280;Move_Verts_B280(Anisotropy_Q179,position,Result_Q219,Result_Q186,normal,Anisotropy_Q203,Result_Q244,New_P_Q280,New_UV_Q280,Radial_Gradient_Q280,Radial_Dir_Q280,New_Normal_Q280);float X_Q248;float Y_Q248;X_Q248=New_UV_Q280.x;Y_Q248=New_UV_Q280.y;vec3 Pos_World_Q162;Object_To_World_Pos_B162(New_P_Q280,Pos_World_Q162);vec3 Nrm_World_Q182;Object_To_World_Normal_B182(New_Normal_Q280,Nrm_World_Q182);vec4 Blob_Info_Q173;\n#if BLOB_ENABLE\nBlob_Vertex_B173(Pos_World_Q162,Nrm_World_Q176,Tangent_World_N_Q177,Binormal_World_N_Q178,_Blob_Position_,_Blob_Intensity_,_Blob_Near_Size_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_,_Blob_Fade_,Blob_Info_Q173);\n#else\nBlob_Info_Q173=vec4(0,0,0,0);\n#endif\nvec4 Blob_Info_Q174;\n#if BLOB_ENABLE_2\nBlob_Vertex_B174(Pos_World_Q162,Nrm_World_Q176,Tangent_World_N_Q177,Binormal_World_N_Q178,_Blob_Position_2_,_Blob_Intensity_,_Blob_Near_Size_2_,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,_Blob_Fade_Length_,_Blob_Pulse_2_,_Blob_Fade_2_,Blob_Info_Q174);\n#else\nBlob_Info_Q174=vec4(0,0,0,0);\n#endif\nfloat Out_Q255;Remap_Range_B255(0.0,1.0,0.0,1.0,X_Q248,Out_Q255);float X_Q236;float Y_Q236;float Z_Q236;To_XYZ_B228(Nrm_World_Q182,X_Q236,Y_Q236,Z_Q236);vec4 Color_At_T_Q247=mix(Linear_Q251,Linear_Q252,Out_Q255);float Minus_F_Q237=-Z_Q236;float R_Q249;float G_Q249;float B_Q249;float A_Q249;R_Q249=Color_At_T_Q247.r; G_Q249=Color_At_T_Q247.g; B_Q249=Color_At_T_Q247.b; A_Q249=Color_At_T_Q247.a;float ClampF_Q238=clamp(0.0,Minus_F_Q237,1.0);float Result_Q243;Conditional_Float_B243(_Decal_Front_Only_,ClampF_Q238,1.0,Result_Q243);vec4 Vec4_Q239=vec4(Result_Q243,Radial_Gradient_Q280,G_Q249,B_Q249);vec3 Position=Pos_World_Q162;vec3 Normal=Nrm_World_Q182;vec2 UV=XY_Q235;vec3 Tangent=Tangent_World_N_Q177;vec3 Binormal=Difference_Q211;vec4 Color=Out_Color_Q184;vec4 Extra1=Vec4_Q239;vec4 Extra2=Blob_Info_Q173;vec4 Extra3=Blob_Info_Q174;gl_Position=viewProjection*vec4(Position,1);vPosition=Position;vNormal=Normal;vUV=UV;vTangent=Tangent;vBinormal=Binormal;vColor=Color;vExtra1=Extra1;vExtra2=Extra2;vExtra3=Extra3;}";class __ extends Wt{constructor(){super(),this.SKY_ENABLED=!0,this.BLOB_ENABLE_2=!0,this.IRIDESCENCE_ENABLED=!0,this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class f_ extends Ms{constructor(e,t){super(e,t),this.radius=.157,this.bevelFront=.065,this.bevelFrontStretch=.077,this.bevelBack=.031,this.bevelBackStretch=0,this.radiusTopLeft=1,this.radiusTopRight=1,this.radiusBottomLeft=1,this.radiusBottomRight=1,this.bulgeEnabled=!1,this.bulgeHeight=-.323,this.bulgeRadius=.73,this.sunIntensity=2,this.sunTheta=.937,this.sunPhi=.555,this.indirectDiffuse=1,this.albedo=new Ie(.0117647,.505882,.996078,1),this.specular=0,this.shininess=10,this.sharpness=0,this.subsurface=.31,this.leftGradientColor=new Ie(.0117647,.505882,.996078,1),this.rightGradientColor=new Ie(.0117647,.505882,.996078,1),this.reflection=.749,this.frontReflect=0,this.edgeReflect=.09,this.power=8.1,this.skyColor=new Ie(.0117647,.960784,.996078,1),this.horizonColor=new Ie(.0117647,.333333,.996078,1),this.groundColor=new Ie(0,.254902,.996078,1),this.horizonPower=1,this.width=.02,this.fuzz=.5,this.minFuzz=.001,this.clipFade=.01,this.hueShift=0,this.saturationShift=0,this.valueShift=0,this.blobPosition=new me(0,0,.1),this.blobIntensity=.5,this.blobNearSize=.01,this.blobFarSize=.03,this.blobNearDistance=0,this.blobFarDistance=.08,this.blobFadeLength=.576,this.blobPulse=0,this.blobFade=1,this.blobPosition2=new me(.2,0,.1),this.blobNearSize2=.01,this.blobPulse2=0,this.blobFade2=1,this.blobTexture=new zi("",this.getScene()),this.leftIndexPosition=new me(0,0,1),this.rightIndexPosition=new me(-1,-1,-1),this.leftIndexMiddlePosition=new me(0,0,0),this.rightIndexMiddlePosition=new me(0,0,0),this.decalScaleXY=new pe(1.5,1.5),this.decalFrontOnly=!0,this.rimIntensity=.287,this.rimHueShift=0,this.rimSaturationShift=0,this.rimValueShift=-1,this.iridescenceIntensity=0,this.useGlobalLeftIndex=1,this.useGlobalRightIndex=1,this.globalLeftIndexTipProximity=0,this.globalRightIndexTipProximity=0,this.globalLeftIndexTipPosition=new ge(.5,0,-.55,1),this.globaRightIndexTipPosition=new ge(0,0,0,1),this.globalLeftThumbTipPosition=new ge(.5,0,-.55,1),this.globalRightThumbTipPosition=new ge(0,0,0,1),this.globalLeftIndexMiddlePosition=new ge(.5,0,-.55,1),this.globalRightIndexMiddlePosition=new ge(0,0,0,1),this.alphaMode=Dh.ALPHA_DISABLE,this.backFaceCulling=!1,this._blueGradientTexture=new zi(f_.BLUE_GRADIENT_TEXTURE_URL,t,!0,!1,zi.NEAREST_SAMPLINGMODE),this._decalTexture=new zi("",this.getScene()),this._reflectionMapTexture=new zi("",this.getScene()),this._indirectEnvTexture=new zi("",this.getScene())}needAlphaBlending(){return!1}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new __);const i=t.materialDefines,s=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(wi.PrepareDefinesForAttributes(e,i,!1,!1),i.isDirty){i.markAsProcessed(),s.resetCachedMaterial();const e=new is;i.FOG&&e.addFallback(1,"FOG"),wi.HandleFallbacksForShadows(i,e),i.IMAGEPROCESSINGPOSTPROCESS=s.imageProcessingConfiguration.applyByPostProcess;const r=[Oe.PositionKind];i.NORMAL&&r.push(Oe.NormalKind),i.UV1&&r.push(Oe.UVKind),i.UV2&&r.push(Oe.UV2Kind),i.VERTEXCOLOR&&r.push(Oe.ColorKind),i.TANGENT&&r.push(Oe.TangentKind),wi.PrepareAttributesForInstances(r,i);const o="mrdlSliderThumb",a=i.toString(),l=["world","viewProjection","cameraPosition","_Radius_","_Bevel_Front_","_Bevel_Front_Stretch_","_Bevel_Back_","_Bevel_Back_Stretch_","_Radius_Top_Left_","_Radius_Top_Right_","_Radius_Bottom_Left_","_Radius_Bottom_Right_","_Bulge_Enabled_","_Bulge_Height_","_Bulge_Radius_","_Sun_Intensity_","_Sun_Theta_","_Sun_Phi_","_Indirect_Diffuse_","_Albedo_","_Specular_","_Shininess_","_Sharpness_","_Subsurface_","_Left_Color_","_Right_Color_","_Reflection_","_Front_Reflect_","_Edge_Reflect_","_Power_","_Sky_Color_","_Horizon_Color_","_Ground_Color_","_Horizon_Power_","_Reflection_Map_","_Indirect_Environment_","_Width_","_Fuzz_","_Min_Fuzz_","_Clip_Fade_","_Hue_Shift_","_Saturation_Shift_","_Value_Shift_","_Blob_Position_","_Blob_Intensity_","_Blob_Near_Size_","_Blob_Far_Size_","_Blob_Near_Distance_","_Blob_Far_Distance_","_Blob_Fade_Length_","_Blob_Pulse_","_Blob_Fade_","_Blob_Texture_","_Blob_Position_2_","_Blob_Near_Size_2_","_Blob_Pulse_2_","_Blob_Fade_2_","_Left_Index_Pos_","_Right_Index_Pos_","_Left_Index_Middle_Pos_","_Right_Index_Middle_Pos_","_Decal_","_Decal_Scale_XY_","_Decal_Front_Only_","_Rim_Intensity_","_Rim_Texture_","_Rim_Hue_Shift_","_Rim_Saturation_Shift_","_Rim_Value_Shift_","_Iridescence_Intensity_","_Iridescence_Texture_","Use_Global_Left_Index","Use_Global_Right_Index","Global_Left_Index_Tip_Position","Global_Right_Index_Tip_Position","Global_Left_Thumb_Tip_Position","Global_Right_Thumb_Tip_Position","Global_Left_Index_Middle_Position;","Global_Right_Index_Middle_Position","Global_Left_Index_Tip_Proximity","Global_Right_Index_Tip_Proximity"],h=["_Rim_Texture_","_Iridescence_Texture_"],c=[];wi.PrepareUniformsAndSamplersList({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:i,maxSimultaneousLights:4}),t.setEffect(s.getEngine().createEffect(o,{attributes:r,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:a,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),i)}return!(!t.effect||!t.effect.isReady()||(i._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){if(!i.materialDefines)return;const s=i.effect;s&&(this._activeEffect=s,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",this.getScene().activeCamera.position),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Bevel_Front_",this.bevelFront),this._activeEffect.setFloat("_Bevel_Front_Stretch_",this.bevelFrontStretch),this._activeEffect.setFloat("_Bevel_Back_",this.bevelBack),this._activeEffect.setFloat("_Bevel_Back_Stretch_",this.bevelBackStretch),this._activeEffect.setFloat("_Radius_Top_Left_",this.radiusTopLeft),this._activeEffect.setFloat("_Radius_Top_Right_",this.radiusTopRight),this._activeEffect.setFloat("_Radius_Bottom_Left_",this.radiusBottomLeft),this._activeEffect.setFloat("_Radius_Bottom_Right_",this.radiusBottomRight),this._activeEffect.setFloat("_Bulge_Enabled_",this.bulgeEnabled?1:0),this._activeEffect.setFloat("_Bulge_Height_",this.bulgeHeight),this._activeEffect.setFloat("_Bulge_Radius_",this.bulgeRadius),this._activeEffect.setFloat("_Sun_Intensity_",this.sunIntensity),this._activeEffect.setFloat("_Sun_Theta_",this.sunTheta),this._activeEffect.setFloat("_Sun_Phi_",this.sunPhi),this._activeEffect.setFloat("_Indirect_Diffuse_",this.indirectDiffuse),this._activeEffect.setDirectColor4("_Albedo_",this.albedo),this._activeEffect.setFloat("_Specular_",this.specular),this._activeEffect.setFloat("_Shininess_",this.shininess),this._activeEffect.setFloat("_Sharpness_",this.sharpness),this._activeEffect.setFloat("_Subsurface_",this.subsurface),this._activeEffect.setDirectColor4("_Left_Color_",this.leftGradientColor),this._activeEffect.setDirectColor4("_Right_Color_",this.rightGradientColor),this._activeEffect.setFloat("_Reflection_",this.reflection),this._activeEffect.setFloat("_Front_Reflect_",this.frontReflect),this._activeEffect.setFloat("_Edge_Reflect_",this.edgeReflect),this._activeEffect.setFloat("_Power_",this.power),this._activeEffect.setDirectColor4("_Sky_Color_",this.skyColor),this._activeEffect.setDirectColor4("_Horizon_Color_",this.horizonColor),this._activeEffect.setDirectColor4("_Ground_Color_",this.groundColor),this._activeEffect.setFloat("_Horizon_Power_",this.horizonPower),this._activeEffect.setTexture("_Reflection_Map_",this._reflectionMapTexture),this._activeEffect.setTexture("_Indirect_Environment_",this._indirectEnvTexture),this._activeEffect.setFloat("_Width_",this.width),this._activeEffect.setFloat("_Fuzz_",this.fuzz),this._activeEffect.setFloat("_Min_Fuzz_",this.minFuzz),this._activeEffect.setFloat("_Clip_Fade_",this.clipFade),this._activeEffect.setFloat("_Hue_Shift_",this.hueShift),this._activeEffect.setFloat("_Saturation_Shift_",this.saturationShift),this._activeEffect.setFloat("_Value_Shift_",this.valueShift),this._activeEffect.setVector3("_Blob_Position_",this.blobPosition),this._activeEffect.setFloat("_Blob_Intensity_",this.blobIntensity),this._activeEffect.setFloat("_Blob_Near_Size_",this.blobNearSize),this._activeEffect.setFloat("_Blob_Far_Size_",this.blobFarSize),this._activeEffect.setFloat("_Blob_Near_Distance_",this.blobNearDistance),this._activeEffect.setFloat("_Blob_Far_Distance_",this.blobFarDistance),this._activeEffect.setFloat("_Blob_Fade_Length_",this.blobFadeLength),this._activeEffect.setFloat("_Blob_Pulse_",this.blobPulse),this._activeEffect.setFloat("_Blob_Fade_",this.blobFade),this._activeEffect.setTexture("_Blob_Texture_",this.blobTexture),this._activeEffect.setVector3("_Blob_Position_2_",this.blobPosition2),this._activeEffect.setFloat("_Blob_Near_Size_2_",this.blobNearSize2),this._activeEffect.setFloat("_Blob_Pulse_2_",this.blobPulse2),this._activeEffect.setFloat("_Blob_Fade_2_",this.blobFade2),this._activeEffect.setVector3("_Left_Index_Pos_",this.leftIndexPosition),this._activeEffect.setVector3("_Right_Index_Pos_",this.rightIndexPosition),this._activeEffect.setVector3("_Left_Index_Middle_Pos_",this.leftIndexMiddlePosition),this._activeEffect.setVector3("_Right_Index_Middle_Pos_",this.rightIndexMiddlePosition),this._activeEffect.setTexture("_Decal_",this._decalTexture),this._activeEffect.setVector2("_Decal_Scale_XY_",this.decalScaleXY),this._activeEffect.setFloat("_Decal_Front_Only_",this.decalFrontOnly?1:0),this._activeEffect.setFloat("_Rim_Intensity_",this.rimIntensity),this._activeEffect.setTexture("_Rim_Texture_",this._blueGradientTexture),this._activeEffect.setFloat("_Rim_Hue_Shift_",this.rimHueShift),this._activeEffect.setFloat("_Rim_Saturation_Shift_",this.rimSaturationShift),this._activeEffect.setFloat("_Rim_Value_Shift_",this.rimValueShift),this._activeEffect.setFloat("_Iridescence_Intensity_",this.iridescenceIntensity),this._activeEffect.setTexture("_Iridescence_Texture_",this._blueGradientTexture),this._activeEffect.setFloat("Use_Global_Left_Index",this.useGlobalLeftIndex),this._activeEffect.setFloat("Use_Global_Right_Index",this.useGlobalRightIndex),this._activeEffect.setVector4("Global_Left_Index_Tip_Position",this.globalLeftIndexTipPosition),this._activeEffect.setVector4("Global_Right_Index_Tip_Position",this.globaRightIndexTipPosition),this._activeEffect.setVector4("Global_Left_Thumb_Tip_Position",this.globalLeftThumbTipPosition),this._activeEffect.setVector4("Global_Right_Thumb_Tip_Position",this.globalRightThumbTipPosition),this._activeEffect.setVector4("Global_Left_Index_Middle_Position",this.globalLeftIndexMiddlePosition),this._activeEffect.setVector4("Global_Right_Index_Middle_Position",this.globalRightIndexMiddlePosition),this._activeEffect.setFloat("Global_Left_Index_Tip_Proximity",this.globalLeftIndexTipProximity),this._activeEffect.setFloat("Global_Right_Index_Tip_Proximity",this.globalRightIndexTipProximity),this._afterBind(t,this._activeEffect))}getAnimatables(){return[]}dispose(e){super.dispose(e),this._reflectionMapTexture.dispose(),this._indirectEnvTexture.dispose(),this._blueGradientTexture.dispose(),this._decalTexture.dispose()}clone(e){return qe.Clone((()=>new f_(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.MRDLSliderThumbMaterial",e}getClassName(){return"MRDLSliderThumbMaterial"}static Parse(e,t,i){return qe.Parse((()=>new f_(e.name,t)),e,t,i)}}f_.BLUE_GRADIENT_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/MRDL/mrtk-mrdl-blue-gradient.png",De([Ge()],f_.prototype,"radius",void 0),De([Ge()],f_.prototype,"bevelFront",void 0),De([Ge()],f_.prototype,"bevelFrontStretch",void 0),De([Ge()],f_.prototype,"bevelBack",void 0),De([Ge()],f_.prototype,"bevelBackStretch",void 0),De([Ge()],f_.prototype,"radiusTopLeft",void 0),De([Ge()],f_.prototype,"radiusTopRight",void 0),De([Ge()],f_.prototype,"radiusBottomLeft",void 0),De([Ge()],f_.prototype,"radiusBottomRight",void 0),De([Ge()],f_.prototype,"bulgeEnabled",void 0),De([Ge()],f_.prototype,"bulgeHeight",void 0),De([Ge()],f_.prototype,"bulgeRadius",void 0),De([Ge()],f_.prototype,"sunIntensity",void 0),De([Ge()],f_.prototype,"sunTheta",void 0),De([Ge()],f_.prototype,"sunPhi",void 0),De([Ge()],f_.prototype,"indirectDiffuse",void 0),De([Ge()],f_.prototype,"albedo",void 0),De([Ge()],f_.prototype,"specular",void 0),De([Ge()],f_.prototype,"shininess",void 0),De([Ge()],f_.prototype,"sharpness",void 0),De([Ge()],f_.prototype,"subsurface",void 0),De([Ge()],f_.prototype,"leftGradientColor",void 0),De([Ge()],f_.prototype,"rightGradientColor",void 0),De([Ge()],f_.prototype,"reflection",void 0),De([Ge()],f_.prototype,"frontReflect",void 0),De([Ge()],f_.prototype,"edgeReflect",void 0),De([Ge()],f_.prototype,"power",void 0),De([Ge()],f_.prototype,"skyColor",void 0),De([Ge()],f_.prototype,"horizonColor",void 0),De([Ge()],f_.prototype,"groundColor",void 0),De([Ge()],f_.prototype,"horizonPower",void 0),De([Ge()],f_.prototype,"width",void 0),De([Ge()],f_.prototype,"fuzz",void 0),De([Ge()],f_.prototype,"minFuzz",void 0),De([Ge()],f_.prototype,"clipFade",void 0),De([Ge()],f_.prototype,"hueShift",void 0),De([Ge()],f_.prototype,"saturationShift",void 0),De([Ge()],f_.prototype,"valueShift",void 0),De([Ge()],f_.prototype,"blobPosition",void 0),De([Ge()],f_.prototype,"blobIntensity",void 0),De([Ge()],f_.prototype,"blobNearSize",void 0),De([Ge()],f_.prototype,"blobFarSize",void 0),De([Ge()],f_.prototype,"blobNearDistance",void 0),De([Ge()],f_.prototype,"blobFarDistance",void 0),De([Ge()],f_.prototype,"blobFadeLength",void 0),De([Ge()],f_.prototype,"blobPulse",void 0),De([Ge()],f_.prototype,"blobFade",void 0),De([Ge()],f_.prototype,"blobPosition2",void 0),De([Ge()],f_.prototype,"blobNearSize2",void 0),De([Ge()],f_.prototype,"blobPulse2",void 0),De([Ge()],f_.prototype,"blobFade2",void 0),De([Ge()],f_.prototype,"blobTexture",void 0),De([Ge()],f_.prototype,"leftIndexPosition",void 0),De([Ge()],f_.prototype,"rightIndexPosition",void 0),De([Ge()],f_.prototype,"leftIndexMiddlePosition",void 0),De([Ge()],f_.prototype,"rightIndexMiddlePosition",void 0),De([Ge()],f_.prototype,"decalScaleXY",void 0),De([Ge()],f_.prototype,"decalFrontOnly",void 0),De([Ge()],f_.prototype,"rimIntensity",void 0),De([Ge()],f_.prototype,"rimHueShift",void 0),De([Ge()],f_.prototype,"rimSaturationShift",void 0),De([Ge()],f_.prototype,"rimValueShift",void 0),De([Ge()],f_.prototype,"iridescenceIntensity",void 0),ue("BABYLON.GUI.MRDLSliderThumbMaterial",f_);F.ShadersStore.mrdlBackplatePixelShader="uniform vec3 cameraPosition;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vExtra1;varying vec4 vExtra2;uniform float _Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Filter_Width_;uniform vec4 _Base_Color_;uniform vec4 _Line_Color_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform float _Rate_;uniform vec4 _Highlight_Color_;uniform float _Highlight_Width_;uniform vec4 _Highlight_Transform_;uniform float _Highlight_;uniform float _Iridescence_Intensity_;uniform float _Iridescence_Edge_Intensity_;uniform vec4 _Iridescence_Tint_;uniform sampler2D _Iridescent_Map_;uniform float _Angle_;uniform bool _Reflected_;uniform float _Frequency_;uniform float _Vertical_Offset_;uniform vec4 _Gradient_Color_;uniform vec4 _Top_Left_;uniform vec4 _Top_Right_;uniform vec4 _Bottom_Left_;uniform vec4 _Bottom_Right_;uniform float _Edge_Width_;uniform float _Edge_Power_;uniform float _Line_Gradient_Blend_;uniform float _Fade_Out_;void FastLinearTosRGB_B353(\nvec4 Linear,\nout vec4 sRGB)\n{sRGB.rgb=sqrt(clamp(Linear.rgb,0.0,1.0));sRGB.a=Linear.a;}\nvoid Round_Rect_Fragment_B332(\nfloat Radius,\nfloat Line_Width,\nvec4 Line_Color,\nfloat Filter_Width,\nvec2 UV,\nfloat Line_Visibility,\nvec4 Rect_Parms,\nvec4 Fill_Color,\nout vec4 Color)\n{float d=length(max(abs(UV)-Rect_Parms.xy,0.0));float dx=max(fwidth(d)*Filter_Width,0.00001);float g=min(Rect_Parms.z,Rect_Parms.w);float dgrad=max(fwidth(g)*Filter_Width,0.00001);float Inside_Rect=clamp(g/dgrad,0.0,1.0);float inner=clamp((d+dx*0.5-max(Radius-Line_Width,d-dx*0.5))/dx,0.0,1.0);Color=clamp(mix(Fill_Color,Line_Color,inner),0.0,1.0)*Inside_Rect;}\nvoid Iridescence_B343(\nvec3 Position,\nvec3 Normal,\nvec2 UV,\nvec3 Axis,\nvec3 Eye,\nvec4 Tint,\nsampler2D Texture,\nbool Reflected,\nfloat Frequency,\nfloat Vertical_Offset,\nout vec4 Color)\n{vec3 i=normalize(Position-Eye);vec3 r=reflect(i,Normal);float idota=dot(i,Axis);float idotr=dot(i,r);float x=Reflected ? idotr : idota;vec2 xy;xy.x=fract((x*Frequency+1.0)*0.5+UV.y*Vertical_Offset);xy.y=0.5;Color=texture(Texture,xy);Color.rgb*=Tint.rgb;}\nvoid Scale_RGB_B346(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Scale_RGB_B344(\nfloat Scalar,\nvec4 Color,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Line_Fragment_B362(\nvec4 Base_Color,\nvec4 Highlight_Color,\nfloat Highlight_Width,\nvec3 Line_Vertex,\nfloat Highlight,\nout vec4 Line_Color)\n{float k2=1.0-clamp(abs(Line_Vertex.y/Highlight_Width),0.0,1.0);Line_Color=mix(Base_Color,Highlight_Color,Highlight*k2);}\nvoid Edge_B356(\nvec4 RectParms,\nfloat Radius,\nfloat Line_Width,\nvec2 UV,\nfloat Edge_Width,\nfloat Edge_Power,\nout float Result)\n{float d=length(max(abs(UV)-RectParms.xy,0.0));float edge=1.0-clamp((1.0-d/(Radius-Line_Width))/Edge_Width,0.0,1.0);Result=pow(edge,Edge_Power);}\nvoid Gradient_B355(\nvec4 Gradient_Color,\nvec4 Top_Left,\nvec4 Top_Right,\nvec4 Bottom_Left,\nvec4 Bottom_Right,\nvec2 UV,\nout vec4 Result)\n{vec3 top=Top_Left.rgb+(Top_Right.rgb-Top_Left.rgb)*UV.x;vec3 bottom=Bottom_Left.rgb+(Bottom_Right.rgb-Bottom_Left.rgb)*UV.x;Result.rgb=Gradient_Color.rgb*(bottom+(top-bottom)*UV.y);Result.a=1.0;}\nvoid main()\n{float X_Q338;float Y_Q338;float Z_Q338;float W_Q338;X_Q338=vExtra2.x;Y_Q338=vExtra2.y;Z_Q338=vExtra2.z;W_Q338=vExtra2.w;vec4 Color_Q343;\n#if IRIDESCENCE_ENABLE\nIridescence_B343(vPosition,vNormal,vUV,vBinormal,cameraPosition,_Iridescence_Tint_,_Iridescent_Map_,_Reflected_,_Frequency_,_Vertical_Offset_,Color_Q343);\n#else\nColor_Q343=vec4(0,0,0,0);\n#endif\nvec4 Result_Q344;Scale_RGB_B344(_Iridescence_Intensity_,Color_Q343,Result_Q344);vec4 Line_Color_Q362;Line_Fragment_B362(_Line_Color_,_Highlight_Color_,_Highlight_Width_,vTangent,_Highlight_,Line_Color_Q362);float Result_Q356;\n#if EDGE_ONLY\nEdge_B356(vExtra1,Z_Q338,W_Q338,vUV,_Edge_Width_,_Edge_Power_,Result_Q356);\n#else\nResult_Q356=1.0;\n#endif\nvec2 Vec2_Q339=vec2(X_Q338,Y_Q338);vec4 Result_Q355;Gradient_B355(_Gradient_Color_,_Top_Left_,_Top_Right_,_Bottom_Left_,_Bottom_Right_,Vec2_Q339,Result_Q355);vec4 Linear_Q348;Linear_Q348.rgb=clamp(Result_Q355.rgb*Result_Q355.rgb,0.0,1.0);Linear_Q348.a=Result_Q355.a;vec4 Result_Q346;Scale_RGB_B346(Linear_Q348,Result_Q356,Result_Q346);vec4 Sum_Q345=Result_Q346+Result_Q344;vec4 Color_At_T_Q347=mix(Line_Color_Q362,Result_Q346,_Line_Gradient_Blend_);vec4 Base_And_Iridescent_Q350;Base_And_Iridescent_Q350=_Base_Color_+vec4(Sum_Q345.rgb,0.0);vec4 Sum_Q349=Color_At_T_Q347+_Iridescence_Edge_Intensity_*Color_Q343;vec4 Result_Q351=Sum_Q349; Result_Q351.a=1.0;vec4 Color_Q332;Round_Rect_Fragment_B332(Z_Q338,W_Q338,Result_Q351,_Filter_Width_,vUV,1.0,vExtra1,Base_And_Iridescent_Q350,Color_Q332);vec4 Result_Q354=_Fade_Out_*Color_Q332;vec4 sRGB_Q353;FastLinearTosRGB_B353(Result_Q354,sRGB_Q353);vec4 Out_Color=sRGB_Q353;float Clip_Threshold=0.001;bool To_sRGB=false;gl_FragColor=Out_Color;}";F.ShadersStore.mrdlBackplateVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec3 tangent;uniform float _Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Filter_Width_;uniform vec4 _Base_Color_;uniform vec4 _Line_Color_;uniform float _Radius_Top_Left_;uniform float _Radius_Top_Right_;uniform float _Radius_Bottom_Left_;uniform float _Radius_Bottom_Right_;uniform float _Rate_;uniform vec4 _Highlight_Color_;uniform float _Highlight_Width_;uniform vec4 _Highlight_Transform_;uniform float _Highlight_;uniform float _Iridescence_Intensity_;uniform float _Iridescence_Edge_Intensity_;uniform vec4 _Iridescence_Tint_;uniform sampler2D _Iridescent_Map_;uniform float _Angle_;uniform bool _Reflected_;uniform float _Frequency_;uniform float _Vertical_Offset_;uniform vec4 _Gradient_Color_;uniform vec4 _Top_Left_;uniform vec4 _Top_Right_;uniform vec4 _Bottom_Left_;uniform vec4 _Bottom_Right_;uniform float _Edge_Width_;uniform float _Edge_Power_;uniform float _Line_Gradient_Blend_;uniform float _Fade_Out_;varying vec3 vPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec3 vBinormal;varying vec4 vExtra1;varying vec4 vExtra2;void Object_To_World_Pos_B314(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid Round_Rect_Vertex_B357(\nvec2 UV,\nfloat Radius,\nfloat Margin,\nfloat Anisotropy,\nfloat Gradient1,\nfloat Gradient2,\nvec3 Normal,\nvec4 Color_Scale_Translate,\nout vec2 Rect_UV,\nout vec4 Rect_Parms,\nout vec2 Scale_XY,\nout vec2 Line_UV,\nout vec2 Color_UV_Info)\n{Scale_XY=vec2(Anisotropy,1.0);Line_UV=(UV-vec2(0.5,0.5));Rect_UV=Line_UV*Scale_XY;Rect_Parms.xy=Scale_XY*0.5-vec2(Radius,Radius)-vec2(Margin,Margin);Rect_Parms.z=Gradient1; \nRect_Parms.w=Gradient2;Color_UV_Info=(Line_UV+vec2(0.5,0.5))*Color_Scale_Translate.xy+Color_Scale_Translate.zw;}\nvoid Line_Vertex_B333(\nvec2 Scale_XY,\nvec2 UV,\nfloat Time,\nfloat Rate,\nvec4 Highlight_Transform,\nout vec3 Line_Vertex)\n{float angle2=(Rate*Time)*2.0*3.1416;float sinAngle2=sin(angle2);float cosAngle2=cos(angle2);vec2 xformUV=UV*Highlight_Transform.xy+Highlight_Transform.zw;Line_Vertex.x=0.0;Line_Vertex.y=cosAngle2*xformUV.x-sinAngle2*xformUV.y;Line_Vertex.z=0.0; }\nvoid PickDir_B334(\nfloat Degrees,\nvec3 DirX,\nvec3 DirY,\nout vec3 Dir)\n{float a=Degrees*3.14159/180.0;Dir=cos(a)*DirX+sin(a)*DirY;}\nvoid Move_Verts_B327(\nfloat Anisotropy,\nvec3 P,\nfloat Radius,\nout vec3 New_P,\nout vec2 New_UV,\nout float Radial_Gradient,\nout vec3 Radial_Dir)\n{vec2 UV=P.xy*2.0+0.5;vec2 center=clamp(UV,0.0,1.0);vec2 delta=UV-center;vec2 r2=2.0*vec2(Radius/Anisotropy,Radius);New_UV=center+r2*(UV-2.0*center+0.5);New_P=vec3(New_UV-0.5,P.z);Radial_Gradient=1.0-length(delta)*2.0;Radial_Dir=vec3(delta*r2,0.0);}\nvoid Pick_Radius_B336(\nfloat Radius,\nfloat Radius_Top_Left,\nfloat Radius_Top_Right,\nfloat Radius_Bottom_Left,\nfloat Radius_Bottom_Right,\nvec3 Position,\nout float Result)\n{bool whichY=Position.y>0.0;Result=Position.x<0.0 ? (whichY ? Radius_Top_Left : Radius_Bottom_Left) : (whichY ? Radius_Top_Right : Radius_Bottom_Right);Result*=Radius;}\nvoid Edge_AA_Vertex_B328(\nvec3 Position_World,\nvec3 Position_Object,\nvec3 Normal_Object,\nvec3 Eye,\nfloat Radial_Gradient,\nvec3 Radial_Dir,\nvec3 Tangent,\nout float Gradient1,\nout float Gradient2)\n{vec3 I=(Eye-Position_World);vec3 T=(vec4(Tangent,0.0)).xyz;float g=(dot(T,I)<0.0) ? 0.0 : 1.0;if (Normal_Object.z==0.0) { \nGradient1=Position_Object.z>0.0 ? g : 1.0;Gradient2=Position_Object.z>0.0 ? 1.0 : g;} else {Gradient1=g+(1.0-g)*(Radial_Gradient);Gradient2=1.0;}}\nvoid Object_To_World_Dir_B330(\nvec3 Dir_Object,\nout vec3 Binormal_World,\nout vec3 Binormal_World_N,\nout float Binormal_Length)\n{Binormal_World=(world*vec4(Dir_Object,0.0)).xyz;Binormal_Length=length(Binormal_World);Binormal_World_N=Binormal_World/Binormal_Length;}\nvoid RelativeOrAbsoluteDetail_B341(\nfloat Nominal_Radius,\nfloat Nominal_LineWidth,\nbool Absolute_Measurements,\nfloat Height,\nout float Radius,\nout float Line_Width)\n{float scale=Absolute_Measurements ? 1.0/Height : 1.0;Radius=Nominal_Radius*scale;Line_Width=Nominal_LineWidth*scale;}\nvoid main()\n{vec3 Nrm_World_Q326;Nrm_World_Q326=normalize((world*vec4(normal,0.0)).xyz);vec3 Tangent_World_Q329;vec3 Tangent_World_N_Q329;float Tangent_Length_Q329;Tangent_World_Q329=(world*vec4(vec3(1,0,0),0.0)).xyz;Tangent_Length_Q329=length(Tangent_World_Q329);Tangent_World_N_Q329=Tangent_World_Q329/Tangent_Length_Q329;vec3 Binormal_World_Q330;vec3 Binormal_World_N_Q330;float Binormal_Length_Q330;Object_To_World_Dir_B330(vec3(0,1,0),Binormal_World_Q330,Binormal_World_N_Q330,Binormal_Length_Q330);float Radius_Q341;float Line_Width_Q341;RelativeOrAbsoluteDetail_B341(_Radius_,_Line_Width_,_Absolute_Sizes_,Binormal_Length_Q330,Radius_Q341,Line_Width_Q341);vec3 Dir_Q334;PickDir_B334(_Angle_,Tangent_World_N_Q329,Binormal_World_N_Q330,Dir_Q334);float Result_Q336;Pick_Radius_B336(Radius_Q341,_Radius_Top_Left_,_Radius_Top_Right_,_Radius_Bottom_Left_,_Radius_Bottom_Right_,position,Result_Q336);float Anisotropy_Q331=Tangent_Length_Q329/Binormal_Length_Q330;vec4 Out_Color_Q337=vec4(Result_Q336,Line_Width_Q341,0,1);vec3 New_P_Q327;vec2 New_UV_Q327;float Radial_Gradient_Q327;vec3 Radial_Dir_Q327;Move_Verts_B327(Anisotropy_Q331,position,Result_Q336,New_P_Q327,New_UV_Q327,Radial_Gradient_Q327,Radial_Dir_Q327);vec3 Pos_World_Q314;Object_To_World_Pos_B314(New_P_Q327,Pos_World_Q314);float Gradient1_Q328;float Gradient2_Q328;\n#if SMOOTH_EDGES\nEdge_AA_Vertex_B328(Pos_World_Q314,position,normal,cameraPosition,Radial_Gradient_Q327,Radial_Dir_Q327,tangent,Gradient1_Q328,Gradient2_Q328);\n#else\nGradient1_Q328=1.0;Gradient2_Q328=1.0;\n#endif\nvec2 Rect_UV_Q357;vec4 Rect_Parms_Q357;vec2 Scale_XY_Q357;vec2 Line_UV_Q357;vec2 Color_UV_Info_Q357;Round_Rect_Vertex_B357(New_UV_Q327,Result_Q336,0.0,Anisotropy_Q331,Gradient1_Q328,Gradient2_Q328,normal,vec4(1,1,0,0),Rect_UV_Q357,Rect_Parms_Q357,Scale_XY_Q357,Line_UV_Q357,Color_UV_Info_Q357);vec3 Line_Vertex_Q333;Line_Vertex_B333(Scale_XY_Q357,Line_UV_Q357,(20.0),_Rate_,_Highlight_Transform_,Line_Vertex_Q333);float X_Q359;float Y_Q359;X_Q359=Color_UV_Info_Q357.x;Y_Q359=Color_UV_Info_Q357.y;vec4 Vec4_Q358=vec4(X_Q359,Y_Q359,Result_Q336,Line_Width_Q341);vec3 Position=Pos_World_Q314;vec3 Normal=Nrm_World_Q326;vec2 UV=Rect_UV_Q357;vec3 Tangent=Line_Vertex_Q333;vec3 Binormal=Dir_Q334;vec4 Color=Out_Color_Q337;vec4 Extra1=Rect_Parms_Q357;vec4 Extra2=Vec4_Q358;vec4 Extra3=vec4(0,0,0,0);gl_Position=viewProjection*vec4(Position,1);vPosition=Position;vNormal=Normal;vUV=UV;vTangent=Tangent;vBinormal=Binormal;vExtra1=Extra1;vExtra2=Extra2;}";class p_ extends Wt{constructor(){super(),this.IRIDESCENCE_ENABLE=!0,this.SMOOTH_EDGES=!0,this._needNormals=!0,this.rebuild()}}class m_ extends Ms{constructor(e,t){super(e,t),this.radius=.3,this.lineWidth=.003,this.absoluteSizes=!1,this._filterWidth=1,this.baseColor=new Ie(0,0,0,1),this.lineColor=new Ie(.2,.262745,.4,1),this.radiusTopLeft=1,this.radiusTopRight=1,this.radiusBottomLeft=1,this.radiusBottomRight=1,this._rate=0,this.highlightColor=new Ie(.239216,.435294,.827451,1),this.highlightWidth=0,this._highlightTransform=new ge(1,1,0,0),this._highlight=1,this.iridescenceIntensity=.45,this.iridescenceEdgeIntensity=1,this.iridescenceTint=new Ie(1,1,1,1),this._angle=-45,this.fadeOut=1,this._reflected=!0,this._frequency=1,this._verticalOffset=0,this.gradientColor=new Ie(.74902,.74902,.74902,1),this.topLeftGradientColor=new Ie(.00784314,.294118,.580392,1),this.topRightGradientColor=new Ie(.305882,0,1,1),this.bottomLeftGradientColor=new Ie(.133333,.258824,.992157,1),this.bottomRightGradientColor=new Ie(.176471,.176471,.619608,1),this.edgeWidth=.5,this.edgePower=1,this.edgeLineGradientBlend=.5,this.alphaMode=Dh.ALPHA_DISABLE,this.backFaceCulling=!1,this._iridescentMapTexture=new zi(m_.IRIDESCENT_MAP_TEXTURE_URL,this.getScene(),!0,!1,zi.NEAREST_SAMPLINGMODE)}needAlphaBlending(){return!1}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new p_);const i=t.materialDefines,s=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(wi.PrepareDefinesForAttributes(e,i,!1,!1),i.isDirty){i.markAsProcessed(),s.resetCachedMaterial();const e=new is;i.FOG&&e.addFallback(1,"FOG"),wi.HandleFallbacksForShadows(i,e),i.IMAGEPROCESSINGPOSTPROCESS=s.imageProcessingConfiguration.applyByPostProcess;const r=[Oe.PositionKind];i.NORMAL&&r.push(Oe.NormalKind),i.UV1&&r.push(Oe.UVKind),i.UV2&&r.push(Oe.UV2Kind),i.VERTEXCOLOR&&r.push(Oe.ColorKind),i.TANGENT&&r.push(Oe.TangentKind),wi.PrepareAttributesForInstances(r,i);const o="mrdlBackplate",a=i.toString(),l=["world","viewProjection","cameraPosition","_Radius_","_Line_Width_","_Absolute_Sizes_","_Filter_Width_","_Base_Color_","_Line_Color_","_Radius_Top_Left_","_Radius_Top_Right_","_Radius_Bottom_Left_","_Radius_Bottom_Right_","_Rate_","_Highlight_Color_","_Highlight_Width_","_Highlight_Transform_","_Highlight_","_Iridescence_Intensity_","_Iridescence_Edge_Intensity_","_Iridescence_Tint_","_Iridescent_Map_","_Angle_","_Reflected_","_Frequency_","_Vertical_Offset_","_Gradient_Color_","_Top_Left_","_Top_Right_","_Bottom_Left_","_Bottom_Right_","_Edge_Width_","_Edge_Power_","_Line_Gradient_Blend_","_Fade_Out_"],h=["_Iridescent_Map_"],c=[];wi.PrepareUniformsAndSamplersList({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:i,maxSimultaneousLights:4}),t.setEffect(s.getEngine().createEffect(o,{attributes:r,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:a,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),i)}return!(!t.effect||!t.effect.isReady()||(i._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){if(!i.materialDefines)return;const s=i.effect;s&&(this._activeEffect=s,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",this.getScene().activeCamera.position),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Line_Width_",this.lineWidth),this._activeEffect.setFloat("_Absolute_Sizes_",this.absoluteSizes?1:0),this._activeEffect.setFloat("_Filter_Width_",this._filterWidth),this._activeEffect.setDirectColor4("_Base_Color_",this.baseColor),this._activeEffect.setDirectColor4("_Line_Color_",this.lineColor),this._activeEffect.setFloat("_Radius_Top_Left_",this.radiusTopLeft),this._activeEffect.setFloat("_Radius_Top_Right_",this.radiusTopRight),this._activeEffect.setFloat("_Radius_Bottom_Left_",this.radiusBottomLeft),this._activeEffect.setFloat("_Radius_Bottom_Right_",this.radiusBottomRight),this._activeEffect.setFloat("_Rate_",this._rate),this._activeEffect.setDirectColor4("_Highlight_Color_",this.highlightColor),this._activeEffect.setFloat("_Highlight_Width_",this.highlightWidth),this._activeEffect.setVector4("_Highlight_Transform_",this._highlightTransform),this._activeEffect.setFloat("_Highlight_",this._highlight),this._activeEffect.setFloat("_Iridescence_Intensity_",this.iridescenceIntensity),this._activeEffect.setFloat("_Iridescence_Edge_Intensity_",this.iridescenceEdgeIntensity),this._activeEffect.setDirectColor4("_Iridescence_Tint_",this.iridescenceTint),this._activeEffect.setTexture("_Iridescent_Map_",this._iridescentMapTexture),this._activeEffect.setFloat("_Angle_",this._angle),this._activeEffect.setFloat("_Reflected_",this._reflected?1:0),this._activeEffect.setFloat("_Frequency_",this._frequency),this._activeEffect.setFloat("_Vertical_Offset_",this._verticalOffset),this._activeEffect.setDirectColor4("_Gradient_Color_",this.gradientColor),this._activeEffect.setDirectColor4("_Top_Left_",this.topLeftGradientColor),this._activeEffect.setDirectColor4("_Top_Right_",this.topRightGradientColor),this._activeEffect.setDirectColor4("_Bottom_Left_",this.bottomLeftGradientColor),this._activeEffect.setDirectColor4("_Bottom_Right_",this.bottomRightGradientColor),this._activeEffect.setFloat("_Edge_Width_",this.edgeWidth),this._activeEffect.setFloat("_Edge_Power_",this.edgePower),this._activeEffect.setFloat("_Line_Gradient_Blend_",this.edgeLineGradientBlend),this._activeEffect.setFloat("_Fade_Out_",this.fadeOut),this._afterBind(t,this._activeEffect))}getAnimatables(){return[]}dispose(e){super.dispose(e)}clone(e){return qe.Clone((()=>new m_(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.MRDLBackplateMaterial",e}getClassName(){return"MRDLBackplateMaterial"}static Parse(e,t,i){return qe.Parse((()=>new m_(e.name,t)),e,t,i)}}m_.IRIDESCENT_MAP_TEXTURE_URL="https://assets.babylonjs.com/meshes/MRTK/MRDL/mrtk-mrdl-backplate-iridescence.png",De([Ge()],m_.prototype,"radius",void 0),De([Ge()],m_.prototype,"lineWidth",void 0),De([Ge()],m_.prototype,"absoluteSizes",void 0),De([Ge()],m_.prototype,"baseColor",void 0),De([Ge()],m_.prototype,"lineColor",void 0),De([Ge()],m_.prototype,"radiusTopLeft",void 0),De([Ge()],m_.prototype,"radiusTopRight",void 0),De([Ge()],m_.prototype,"radiusBottomLeft",void 0),De([Ge()],m_.prototype,"radiusBottomRight",void 0),De([Ge()],m_.prototype,"highlightColor",void 0),De([Ge()],m_.prototype,"highlightWidth",void 0),De([Ge()],m_.prototype,"iridescenceIntensity",void 0),De([Ge()],m_.prototype,"iridescenceEdgeIntensity",void 0),De([Ge()],m_.prototype,"iridescenceTint",void 0),De([Ge()],m_.prototype,"fadeOut",void 0),De([Ge()],m_.prototype,"gradientColor",void 0),De([Ge()],m_.prototype,"topLeftGradientColor",void 0),De([Ge()],m_.prototype,"topRightGradientColor",void 0),De([Ge()],m_.prototype,"bottomLeftGradientColor",void 0),De([Ge()],m_.prototype,"bottomRightGradientColor",void 0),De([Ge()],m_.prototype,"edgeWidth",void 0),De([Ge()],m_.prototype,"edgePower",void 0),De([Ge()],m_.prototype,"edgeLineGradientBlend",void 0),ue("BABYLON.GUI.MRDLBackplateMaterial",m_);class g_ extends mu{constructor(e,t){super(e),this.onValueChangedObservable=new s,this._sliderBackplateVisible=t||!1,this._minimum=0,this._maximum=100,this._step=0,this._value=50}get mesh(){return this.node?this._sliderThumb:null}get minimum(){return this._minimum}set minimum(e){this._minimum!==e&&(this._minimum=Math.max(e,0),this._value=Math.max(Math.min(this._value,this._maximum),this._minimum))}get maximum(){return this._maximum}set maximum(e){this._maximum!==e&&(this._maximum=Math.max(e,this._minimum),this._value=Math.max(Math.min(this._value,this._maximum),this._minimum))}get step(){return this._step}set step(e){this._step!==e&&(this._step=Math.max(Math.min(e,this._maximum-this._minimum),0))}get value(){return this._value}set value(e){this._value!==e&&(this._value=Math.max(Math.min(e,this._maximum),this._minimum),this._sliderThumb&&(this._sliderThumb.position.x=this._convertToPosition(this.value)),this.onValueChangedObservable.notifyObservers(this._value))}get start(){return this.node?this._sliderBar.position.x-this._sliderBar.scaling.x/2:-.5}get end(){return this.node?this._sliderBar.position.x+this._sliderBar.scaling.x/2:.5}get sliderBarMaterial(){return this._sliderBarMaterial}get sliderThumbMaterial(){return this._sliderThumbMaterial}get sliderBackplateMaterial(){return this._sliderBackplateMaterial}set isVisible(e){var t;this._isVisible!==e&&(this._isVisible=e,null===(t=this.node)||void 0===t||t.setEnabled(e))}_createNode(e){const t=Fr(`${this.name}_sliderbackplate`,{width:1,height:1,depth:1},e);return t.isPickable=!1,t.visibility=0,t.scaling=new me(1,.5,.8),da.ImportMeshAsync(void 0,g_.MODEL_BASE_URL,g_.MODEL_FILENAME,e).then((e=>{e.meshes.forEach((e=>{e.isPickable=!1}));const i=e.meshes[1],s=e.meshes[1].clone(`${this.name}_sliderbar`,t),n=e.meshes[1].clone(`${this.name}_sliderthumb`,t);i.visibility=0,this._sliderBackplateVisible&&(i.visibility=1,i.name=`${this.name}_sliderbackplate`,i.scaling.x=1,i.scaling.z=.2,i.parent=t,this._sliderBackplateMaterial&&(i.material=this._sliderBackplateMaterial),this._sliderBackplate=i),s&&(s.parent=t,s.position.z=-.1,s.scaling=new me(.8,.04,.3),this._sliderBarMaterial&&(s.material=this._sliderBarMaterial),this._sliderBar=s),n&&(n.parent=t,n.isPickable=!0,n.position.z=-.115,n.scaling=new me(.025,.3,.6),n.position.x=this._convertToPosition(this.value),n.addBehavior(this._createBehavior()),this._sliderThumbMaterial&&(n.material=this._sliderThumbMaterial),this._sliderThumb=n),this._injectGUI3DReservedDataStore(t).control=this,t.getChildMeshes().forEach((e=>{this._injectGUI3DReservedDataStore(e).control=this}))})),this._affectMaterial(t),t}_affectMaterial(e){var t,i,s;this._sliderBackplateMaterial=null!==(t=this._sliderBackplateMaterial)&&void 0!==t?t:new m_(`${this.name}_sliderbackplate_material`,e.getScene()),this._sliderBarMaterial=null!==(i=this._sliderBarMaterial)&&void 0!==i?i:new u_(`${this.name}_sliderbar_material`,e.getScene()),this._sliderThumbMaterial=null!==(s=this._sliderThumbMaterial)&&void 0!==s?s:new f_(`${this.name}_sliderthumb_material`,e.getScene())}_createBehavior(){const e=new l_({dragAxis:me.Right()});return e.moveAttached=!1,e.onDragStartObservable.add((()=>{this._draggedPosition=this._sliderThumb.position.x})),e.onDragObservable.add((e=>{this._draggedPosition+=e.dragDistance/this.scaling.x,this.value=this._convertToValue(this._draggedPosition)})),e}_convertToPosition(e){const t=(e-this.minimum)/(this.maximum-this.minimum)*(this.end-this.start)+this.start;return Math.min(Math.max(t,this.start),this.end)}_convertToValue(e){let t=(e-this.start)/(this.end-this.start)*(this.maximum-this.minimum);return t=this.step?Math.round(t/this.step)*this.step:t,Math.max(Math.min(this.minimum+t,this._maximum),this._minimum)}dispose(){var e,t,i,s,n,r;super.dispose(),null===(e=this._sliderBar)||void 0===e||e.dispose(),null===(t=this._sliderThumb)||void 0===t||t.dispose(),null===(i=this._sliderBarMaterial)||void 0===i||i.dispose(),null===(s=this._sliderThumbMaterial)||void 0===s||s.dispose(),null===(n=this._sliderBackplate)||void 0===n||n.dispose(),null===(r=this._sliderBackplateMaterial)||void 0===r||r.dispose()}}g_.MODEL_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",g_.MODEL_FILENAME="mrtk-fluent-backplate.glb";class v_{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class T_{syncWithMask(){if(this.mask){this._numActiveAnimatables=0;for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.disabled||this.mask.retainsTarget(t.target.name)?(this._numActiveAnimatables++,t.paused&&t.restart()):t.paused||t.pause()}}else this._numActiveAnimatables=this._targetedAnimations.length}removeUnmaskedAnimations(){if(this.mask&&!this.mask.disabled){for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){const t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}get to(){return this._to}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].speedRatio=this._speedRatio}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].loopAnimation=this._loopAnimation}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].isAdditive=this._isAdditive}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let e=0;e<this._animatables.length;e++)this._animatables[e].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){return e=null!=e?e:this._from,((t=null!=t?t:this._to)-e)/(this.targetedAnimations[0].animation.framePerSecond*this._speedRatio)}static MergeAnimationGroups(e,t=!0,i=!1,s){if(0===e.length)return null;s=null!=s?s:e[0].weight;let n=Number.MAX_VALUE,r=-Number.MAX_VALUE;if(i)for(const t of e)t.from<n&&(n=t.from),t.to>r&&(r=t.to);const o=new T_(e[0].name+"_merged",e[0]._scene,s);for(const s of e){i&&s.normalize(n,r);for(const e of s.targetedAnimations)o.addTargetedAnimation(e.animation,e.target);t&&s.dispose()}return o}constructor(e,t=null,i=-1,n=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._parentContainer=null,this.onAnimationEndObservable=new s,this.onAnimationLoopObservable=new s,this.onAnimationGroupLoopObservable=new s,this.onAnimationGroupEndObservable=new s,this.onAnimationGroupPauseObservable=new s,this.onAnimationGroupPlayObservable=new s,this.metadata=null,this._animationLoopFlags=[],this._scene=t||u.LastCreatedScene,this._weight=i,this._playOrder=n,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new v_;i.animation=e,i.target=t;const s=e.getKeys();return this._from>s[0].frame&&(this._from=s[0].frame),this._to<s[s.length-1].frame&&(this._to=s[s.length-1].frame),null!==this._enableBlending&&(e.enableBlending=this._enableBlending),null!==this._blendingSpeed&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){null==e&&(e=this._from),null==t&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const s=this._targetedAnimations[i].animation.getKeys(),n=s[0],r=s[s.length-1];if(n.frame>e){const t={frame:e,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};s.splice(0,0,t)}if(r.frame<t){const e={frame:t,value:r.value,inTangent:r.inTangent,outTangent:r.outTangent,interpolation:r.interpolation};s.push(e)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),this._animationLoopFlags[i]||(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,s,n){if(this._isStarted||0===this._targetedAnimations.length)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let r=0;r<this._targetedAnimations.length;r++){const o=this._targetedAnimations[r],a=this._scene.beginDirectAnimation(o.target,[o.animation],void 0!==i?i:this._from,void 0!==s?s:this._to,e,t,void 0,void 0,void 0!==n?n:this._isAdditive);a.weight=this._weight,a.playOrder=this._playOrder,a.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(a)},this._processLoop(a,o,r),this._animatables.push(a)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(void 0!==e&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;const e=this._animatables.slice();for(let t=0;t<e.length;t++)e[t].stop(void 0,void 0,!0);let t=0;for(let e=0;e<this._scene._activeAnimatables.length;e++){const i=this._scene._activeAnimatables[e];i._runtimeAnimations.length>0&&(this._scene._activeAnimatables[t++]=i)}return this._scene._activeAnimatables.length=t,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].weight=e;return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const e=this._parentContainer.animationGroups.indexOf(this);e>-1&&this._parentContainer.animationGroups.splice(e,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){const t=this._animatables.indexOf(e);t>-1&&this._animatables.splice(t,1),0===this._animatables.length&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const s=new T_(e||this.name,this._scene,this._weight,this._playOrder);s._from=this.from,s._to=this.to,s._speedRatio=this.speedRatio,s._loopAnimation=this.loopAnimation,s._isAdditive=this.isAdditive,s._enableBlending=this.enableBlending,s._blendingSpeed=this.blendingSpeed,s.metadata=this.metadata,s.mask=this.mask;for(const e of this._targetedAnimations)s.addTargetedAnimation(i?e.animation.clone():e.animation,t?t(e.target):e.target);return s}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return Fe&&Fe.HasTags(this)&&(e.tags=Fe.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new T_(e.name,t,e.weight,e.playOrder);for(let s=0;s<e.targetedAnimations.length;s++){const n=e.targetedAnimations[s],r=cr.Parse(n.animation),o=n.targetId;if("influence"===n.animation.property){const e=t.getMorphTargetById(o);e&&i.addTargetedAnimation(r,e)}else{const e=t.getNodeById(o);null!=e&&i.addTargetedAnimation(r,e)}}return Fe&&Fe.AddTagsTo(i,e.tags),null!==e.from&&null!==e.to&&i.normalize(e.from,e.to),void 0!==e.speedRatio&&(i._speedRatio=e.speedRatio),void 0!==e.loopAnimation&&(i._loopAnimation=e.loopAnimation),void 0!==e.isAdditive&&(i._isAdditive=e.isAdditive),void 0!==e.weight&&(i._weight=e.weight),void 0!==e.playOrder&&(i._playOrder=e.playOrder),void 0!==e.enableBlending&&(i._enableBlending=e.enableBlending),void 0!==e.blendingSpeed&&(i._blendingSpeed=e.blendingSpeed),void 0!==e.metadata&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t,i,s=!1,n){let r;r="object"==typeof t?t:{referenceFrame:t,range:i,cloneOriginalAnimationGroup:s,clonedAnimationName:n};let o=e;r.cloneOriginalAnimationGroup&&(o=e.clone(r.clonedAnimationGroupName||o.name));const a=o.targetedAnimations;for(let e=0;e<a.length;e++){const t=a[e];t.animation=cr.MakeAnimationAdditive(t.animation,r)}if(o.isAdditive=!0,r.clipKeys){let e=Number.MAX_VALUE,t=-Number.MAX_VALUE;const i=o.targetedAnimations;for(let s=0;s<i.length;s++){const n=i[s].animation.getKeys();e>n[0].frame&&(e=n[0].frame),t<n[n.length-1].frame&&(t=n[n.length-1].frame)}o._from=e,o._to=t}return o}static ClipKeys(e,t,i,s,n){const r=e.clone(s||e.name);return T_.ClipKeysInPlace(r,t,i,n)}static ClipKeysInPlace(e,t,i,s){return T_.ClipInPlace(e,t,i,s,!1)}static ClipFrames(e,t,i,s,n){const r=e.clone(s||e.name);return T_.ClipFramesInPlace(r,t,i,n)}static ClipFramesInPlace(e,t,i,s){return T_.ClipInPlace(e,t,i,s,!0)}static ClipInPlace(e,t,i,s,n=!1){let r=Number.MAX_VALUE,o=-Number.MAX_VALUE;const a=e.targetedAnimations;for(let e=0;e<a.length;e++){const l=a[e],h=s?l.animation:l.animation.clone();n&&(h.createKeyForFrame(t),h.createKeyForFrame(i));const c=h.getKeys(),d=[];let u=Number.MAX_VALUE;for(let e=0;e<c.length;e++){const s=c[e];if(!n&&e>=t&&e<=i||n&&s.frame>=t&&s.frame<=i){const e={frame:s.frame,value:s.value.clone?s.value.clone():s.value,inTangent:s.inTangent,outTangent:s.outTangent,interpolation:s.interpolation,lockedTangent:s.lockedTangent};u===Number.MAX_VALUE&&(u=e.frame),e.frame-=u,d.push(e)}}0!==d.length?(r>d[0].frame&&(r=d[0].frame),o<d[d.length-1].frame&&(o=d[d.length-1].frame),h.setKeys(d,!0),l.animation=h):(a.splice(e,1),e--)}return e._from=r,e._to=o,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}F.ShadersStore.mrdlBackglowPixelShader="uniform vec3 cameraPosition;varying vec3 vNormal;varying vec2 vUV;uniform float _Bevel_Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Tuning_Motion_;uniform float _Motion_;uniform float _Max_Intensity_;uniform float _Intensity_Fade_In_Exponent_;uniform float _Outer_Fuzz_Start_;uniform float _Outer_Fuzz_End_;uniform vec4 _Color_;uniform vec4 _Inner_Color_;uniform float _Blend_Exponent_;uniform float _Falloff_;uniform float _Bias_;float BiasFunc(float b,float v) {return pow(v,log(clamp(b,0.001,0.999))/log(0.5));}\nvoid Fuzzy_Round_Rect_B33(\nfloat Size_X,\nfloat Size_Y,\nfloat Radius_X,\nfloat Radius_Y,\nfloat Line_Width,\nvec2 UV,\nfloat Outer_Fuzz,\nfloat Max_Outer_Fuzz,\nout float Rect_Distance,\nout float Inner_Distance)\n{vec2 halfSize=vec2(Size_X,Size_Y)*0.5;vec2 r=max(min(vec2(Radius_X,Radius_Y),halfSize),vec2(0.001,0.001));float radius=min(r.x,r.y)-Max_Outer_Fuzz;vec2 v=abs(UV);vec2 nearestp=min(v,halfSize-r);float d=distance(nearestp,v);Inner_Distance=clamp(1.0-(radius-d)/Line_Width,0.0,1.0);Rect_Distance=clamp(1.0-(d-radius)/Outer_Fuzz,0.0,1.0)*Inner_Distance;}\nvoid main()\n{float X_Q42;float Y_Q42;X_Q42=vNormal.x;Y_Q42=vNormal.y;float MaxAB_Q24=max(_Tuning_Motion_,_Motion_);float Sqrt_F_Q27=sqrt(MaxAB_Q24);float Power_Q43=pow(MaxAB_Q24,_Intensity_Fade_In_Exponent_);float Value_At_T_Q26=mix(_Outer_Fuzz_Start_,_Outer_Fuzz_End_,Sqrt_F_Q27);float Product_Q23=_Max_Intensity_*Power_Q43;float Rect_Distance_Q33;float Inner_Distance_Q33;Fuzzy_Round_Rect_B33(X_Q42,Y_Q42,_Bevel_Radius_,_Bevel_Radius_,_Line_Width_,vUV,Value_At_T_Q26,_Outer_Fuzz_Start_,Rect_Distance_Q33,Inner_Distance_Q33);float Power_Q44=pow(Inner_Distance_Q33,_Blend_Exponent_);float Result_Q45=pow(BiasFunc(_Bias_,Rect_Distance_Q33),_Falloff_);vec4 Color_At_T_Q25=mix(_Inner_Color_,_Color_,Power_Q44);float Product_Q22=Result_Q45*Product_Q23;vec4 Result_Q28=Product_Q22*Color_At_T_Q25;vec4 Out_Color=Result_Q28;float Clip_Threshold=0.0;gl_FragColor=Out_Color;}";F.ShadersStore.mrdlBackglowVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute vec3 tangent;uniform float _Bevel_Radius_;uniform float _Line_Width_;uniform bool _Absolute_Sizes_;uniform float _Tuning_Motion_;uniform float _Motion_;uniform float _Max_Intensity_;uniform float _Intensity_Fade_In_Exponent_;uniform float _Outer_Fuzz_Start_;uniform float _Outer_Fuzz_End_;uniform vec4 _Color_;uniform vec4 _Inner_Color_;uniform float _Blend_Exponent_;uniform float _Falloff_;uniform float _Bias_;varying vec3 vNormal;varying vec2 vUV;void main()\n{vec3 Dir_World_Q41=(world*vec4(tangent,0.0)).xyz;vec3 Dir_World_Q40=(world*vec4((cross(normal,tangent)),0.0)).xyz;float MaxAB_Q24=max(_Tuning_Motion_,_Motion_);float Length_Q16=length(Dir_World_Q41);float Length_Q17=length(Dir_World_Q40);bool Greater_Than_Q37=MaxAB_Q24>0.0;vec3 Sizes_Q35;vec2 XY_Q35;Sizes_Q35=(_Absolute_Sizes_ ? vec3(Length_Q16,Length_Q17,0) : vec3(Length_Q16/Length_Q17,1,0));XY_Q35=(uv-vec2(0.5,0.5))*Sizes_Q35.xy;vec3 Result_Q38=Greater_Than_Q37 ? position : vec3(0,0,0);vec3 Pos_World_Q39=(world*vec4(Result_Q38,1.0)).xyz;vec3 Position=Pos_World_Q39;vec3 Normal=Sizes_Q35;vec2 UV=XY_Q35;vec3 Tangent=vec3(0,0,0);vec3 Binormal=vec3(0,0,0);vec4 Color=vec4(1,1,1,1);gl_Position=viewProjection*vec4(Position,1);vNormal=Normal;vUV=UV;}";class b_ extends Wt{constructor(){super(),this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class E_ extends Ms{constructor(e,t){super(e,t),this.bevelRadius=.16,this.lineWidth=.16,this.absoluteSizes=!1,this.tuningMotion=0,this.motion=1,this.maxIntensity=.7,this.intensityFadeInExponent=2,this.outerFuzzStart=.04,this.outerFuzzEnd=.04,this.color=new Ie(.682353,.698039,1,1),this.innerColor=new Ie(.356863,.392157,.796078,1),this.blendExponent=1.5,this.falloff=2,this.bias=.5,this.alphaMode=Dh.ALPHA_ADD,this.disableDepthWrite=!0,this.backFaceCulling=!1}needAlphaBlending(){return!0}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new b_);const i=t.materialDefines,s=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(wi.PrepareDefinesForAttributes(e,i,!1,!1),i.isDirty){i.markAsProcessed(),s.resetCachedMaterial();const e=new is;i.FOG&&e.addFallback(1,"FOG"),wi.HandleFallbacksForShadows(i,e),i.IMAGEPROCESSINGPOSTPROCESS=s.imageProcessingConfiguration.applyByPostProcess;const r=[Oe.PositionKind];i.NORMAL&&r.push(Oe.NormalKind),i.UV1&&r.push(Oe.UVKind),i.UV2&&r.push(Oe.UV2Kind),i.VERTEXCOLOR&&r.push(Oe.ColorKind),i.TANGENT&&r.push(Oe.TangentKind),wi.PrepareAttributesForInstances(r,i);const o="mrdlBackglow",a=i.toString(),l=["world","worldView","worldViewProjection","view","projection","viewProjection","cameraPosition","_Bevel_Radius_","_Line_Width_","_Absolute_Sizes_","_Tuning_Motion_","_Motion_","_Max_Intensity_","_Intensity_Fade_In_Exponent_","_Outer_Fuzz_Start_","_Outer_Fuzz_End_","_Color_","_Inner_Color_","_Blend_Exponent_","_Falloff_","_Bias_"],h=[],c=[];wi.PrepareUniformsAndSamplersList({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:i,maxSimultaneousLights:4}),t.setEffect(s.getEngine().createEffect(o,{attributes:r,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:a,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),i)}return!(!t.effect||!t.effect.isReady()||(i._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){const s=this.getScene();if(!i.materialDefines)return;const n=i.effect;n&&(this._activeEffect=n,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",s.activeCamera.position),this._activeEffect.setFloat("_Bevel_Radius_",this.bevelRadius),this._activeEffect.setFloat("_Line_Width_",this.lineWidth),this._activeEffect.setFloat("_Absolute_Sizes_",this.absoluteSizes?1:0),this._activeEffect.setFloat("_Tuning_Motion_",this.tuningMotion),this._activeEffect.setFloat("_Motion_",this.motion),this._activeEffect.setFloat("_Max_Intensity_",this.maxIntensity),this._activeEffect.setFloat("_Intensity_Fade_In_Exponent_",this.intensityFadeInExponent),this._activeEffect.setFloat("_Outer_Fuzz_Start_",this.outerFuzzStart),this._activeEffect.setFloat("_Outer_Fuzz_End_",this.outerFuzzEnd),this._activeEffect.setDirectColor4("_Color_",this.color),this._activeEffect.setDirectColor4("_Inner_Color_",this.innerColor),this._activeEffect.setFloat("_Blend_Exponent_",this.blendExponent),this._activeEffect.setFloat("_Falloff_",this.falloff),this._activeEffect.setFloat("_Bias_",this.bias),this._afterBind(t,this._activeEffect))}getAnimatables(){return[]}dispose(e){super.dispose(e)}clone(e){return qe.Clone((()=>new E_(e,this.getScene())),this)}serialize(){const e=qe.Serialize(this);return e.customType="BABYLON.MRDLBackglowMaterial",e}getClassName(){return"MRDLBackglowMaterial"}static Parse(e,t,i){return qe.Parse((()=>new E_(e.name,t)),e,t,i)}}De([Ge()],E_.prototype,"bevelRadius",void 0),De([Ge()],E_.prototype,"lineWidth",void 0),De([Ge()],E_.prototype,"absoluteSizes",void 0),De([Ge()],E_.prototype,"tuningMotion",void 0),De([Ge()],E_.prototype,"motion",void 0),De([Ge()],E_.prototype,"maxIntensity",void 0),De([Ge()],E_.prototype,"intensityFadeInExponent",void 0),De([Ge()],E_.prototype,"outerFuzzStart",void 0),De([Ge()],E_.prototype,"outerFuzzEnd",void 0),De([Ge()],E_.prototype,"color",void 0),De([Ge()],E_.prototype,"innerColor",void 0),De([Ge()],E_.prototype,"blendExponent",void 0),De([Ge()],E_.prototype,"falloff",void 0),De([Ge()],E_.prototype,"bias",void 0),ue("BABYLON.GUI.MRDLBackglowMaterial",E_);F.ShadersStore.mrdlFrontplatePixelShader="uniform vec3 cameraPosition;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;uniform float _Radius_;uniform float _Line_Width_;uniform bool _Relative_To_Height_;uniform float _Filter_Width_;uniform vec4 _Edge_Color_;uniform float _Fade_Out_;uniform bool _Smooth_Edges_;uniform bool _Blob_Enable_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Inner_Fade_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform float _Blob_Pulse_Max_Size_;uniform bool _Blob_Enable_2_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Inner_Fade_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform float _Gaze_Intensity_;uniform float _Gaze_Focus_;uniform sampler2D _Blob_Texture_;uniform float _Selection_Fuzz_;uniform float _Selected_;uniform float _Selection_Fade_;uniform float _Selection_Fade_Size_;uniform float _Selected_Distance_;uniform float _Selected_Fade_Length_;uniform float _Proximity_Max_Intensity_;uniform float _Proximity_Far_Distance_;uniform float _Proximity_Near_Radius_;uniform float _Proximity_Anisotropy_;uniform bool _Use_Global_Left_Index_;uniform bool _Use_Global_Right_Index_;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;void Scale_Color_B54(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=Scalar*Color;}\nvoid Scale_RGB_B50(\nvec4 Color,\nfloat Scalar,\nout vec4 Result)\n{Result=vec4(Scalar,Scalar,Scalar,1)*Color;}\nvoid Proximity_Fragment_B51(\nfloat Proximity_Max_Intensity,\nfloat Proximity_Near_Radius,\nvec4 Deltas,\nfloat Show_Selection,\nfloat Distance_Fade1,\nfloat Distance_Fade2,\nfloat Strength,\nout float Proximity)\n{float proximity1=(1.0-clamp(length(Deltas.xy)/Proximity_Near_Radius,0.0,1.0))*Distance_Fade1;float proximity2=(1.0-clamp(length(Deltas.zw)/Proximity_Near_Radius,0.0,1.0))*Distance_Fade2;Proximity=Strength*(Proximity_Max_Intensity*max(proximity1,proximity2) *(1.0-Show_Selection)+Show_Selection);}\nvoid Blob_Fragment_B56(\nvec2 UV,\nvec3 Blob_Info,\nsampler2D Blob_Texture,\nout vec4 Blob_Color)\n{float k=dot(UV,UV);Blob_Color=Blob_Info.y*texture(Blob_Texture,vec2(vec2(sqrt(k),Blob_Info.x).x,1.0-vec2(sqrt(k),Blob_Info.x).y))*(1.0-clamp(k,0.0,1.0));}\nvoid Round_Rect_Fragment_B61(\nfloat Radius,\nvec4 Line_Color,\nfloat Filter_Width,\nfloat Line_Visibility,\nvec4 Fill_Color,\nbool Smooth_Edges,\nvec4 Rect_Parms,\nout float Inside_Rect)\n{float d=length(max(abs(Rect_Parms.zw)-Rect_Parms.xy,0.0));float dx=max(fwidth(d)*Filter_Width,0.00001);Inside_Rect=Smooth_Edges ? clamp((Radius-d)/dx,0.0,1.0) : 1.0-step(Radius,d);}\nvoid main()\n{float Is_Quad_Q53;Is_Quad_Q53=vNormal.z;vec4 Blob_Color_Q56;Blob_Fragment_B56(vUV,vTangent,_Blob_Texture_,Blob_Color_Q56);float X_Q52;float Y_Q52;float Z_Q52;float W_Q52;X_Q52=vExtra3.x;Y_Q52=vExtra3.y;Z_Q52=vExtra3.z;W_Q52=vExtra3.w;float Proximity_Q51;Proximity_Fragment_B51(_Proximity_Max_Intensity_,_Proximity_Near_Radius_,vExtra2,X_Q52,Y_Q52,Z_Q52,1.0,Proximity_Q51);float Inside_Rect_Q61;Round_Rect_Fragment_B61(W_Q52,vec4(1,1,1,1),_Filter_Width_,1.0,vec4(0,0,0,0),_Smooth_Edges_,vExtra1,Inside_Rect_Q61);vec4 Result_Q50;Scale_RGB_B50(_Edge_Color_,Proximity_Q51,Result_Q50);vec4 Result_Q47=Inside_Rect_Q61*Blob_Color_Q56;vec4 Color_At_T_Q48=mix(Result_Q50,Result_Q47,Is_Quad_Q53);vec4 Result_Q54;Scale_Color_B54(Color_At_T_Q48,_Fade_Out_,Result_Q54);vec4 Out_Color=Result_Q54;float Clip_Threshold=0.001;bool To_sRGB=false;gl_FragColor=Out_Color;}";F.ShadersStore.mrdlFrontplateVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute vec3 tangent;attribute vec4 color;uniform float _Radius_;uniform float _Line_Width_;uniform bool _Relative_To_Height_;uniform float _Filter_Width_;uniform vec4 _Edge_Color_;uniform float _Fade_Out_;uniform bool _Smooth_Edges_;uniform bool _Blob_Enable_;uniform vec3 _Blob_Position_;uniform float _Blob_Intensity_;uniform float _Blob_Near_Size_;uniform float _Blob_Far_Size_;uniform float _Blob_Near_Distance_;uniform float _Blob_Far_Distance_;uniform float _Blob_Fade_Length_;uniform float _Blob_Inner_Fade_;uniform float _Blob_Pulse_;uniform float _Blob_Fade_;uniform float _Blob_Pulse_Max_Size_;uniform bool _Blob_Enable_2_;uniform vec3 _Blob_Position_2_;uniform float _Blob_Near_Size_2_;uniform float _Blob_Inner_Fade_2_;uniform float _Blob_Pulse_2_;uniform float _Blob_Fade_2_;uniform float _Gaze_Intensity_;uniform float _Gaze_Focus_;uniform sampler2D _Blob_Texture_;uniform float _Selection_Fuzz_;uniform float _Selected_;uniform float _Selection_Fade_;uniform float _Selection_Fade_Size_;uniform float _Selected_Distance_;uniform float _Selected_Fade_Length_;uniform float _Proximity_Max_Intensity_;uniform float _Proximity_Far_Distance_;uniform float _Proximity_Near_Radius_;uniform float _Proximity_Anisotropy_;uniform bool _Use_Global_Left_Index_;uniform bool _Use_Global_Right_Index_;uniform vec4 Global_Left_Index_Tip_Position;uniform vec4 Global_Right_Index_Tip_Position;varying vec3 vNormal;varying vec2 vUV;varying vec3 vTangent;varying vec4 vExtra1;varying vec4 vExtra2;varying vec4 vExtra3;void Blob_Vertex_B40(\nvec3 Position,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nvec3 Blob_Position,\nfloat Intensity,\nfloat Blob_Near_Size,\nfloat Blob_Far_Size,\nfloat Blob_Near_Distance,\nfloat Blob_Far_Distance,\nvec4 Vx_Color,\nvec2 UV,\nvec3 Face_Center,\nvec2 Face_Size,\nvec2 In_UV,\nfloat Blob_Fade_Length,\nfloat Selection_Fade,\nfloat Selection_Fade_Size,\nfloat Inner_Fade,\nfloat Blob_Pulse,\nfloat Blob_Fade,\nfloat Blob_Enabled,\nfloat DistanceOffset,\nout vec3 Out_Position,\nout vec2 Out_UV,\nout vec3 Blob_Info,\nout vec2 Blob_Relative_UV)\n{float blobSize,fadeIn;vec3 Hit_Position;Blob_Info=vec3(0.0,0.0,0.0);float Hit_Distance=dot(Blob_Position-Face_Center,Normal)+DistanceOffset*Blob_Far_Distance;Hit_Position=Blob_Position-Hit_Distance*Normal;float absD=abs(Hit_Distance);float lerpVal=clamp((absD-Blob_Near_Distance)/(Blob_Far_Distance-Blob_Near_Distance),0.0,1.0);fadeIn=1.0-clamp((absD-Blob_Far_Distance)/Blob_Fade_Length,0.0,1.0);float innerFade=1.0-clamp(-Hit_Distance/Inner_Fade,0.0,1.0);float farClip=clamp(1.0-step(Blob_Far_Distance+Blob_Fade_Length,absD),0.0,1.0);float size=mix(Blob_Near_Size,Blob_Far_Size,lerpVal)*farClip;blobSize=mix(size,Selection_Fade_Size,Selection_Fade)*innerFade*Blob_Enabled;Blob_Info.x=lerpVal*0.5+0.5;Blob_Info.y=fadeIn*Intensity*(1.0-Selection_Fade)*Blob_Fade;Blob_Info.x*=(1.0-Blob_Pulse);vec3 delta=Hit_Position-Face_Center;vec2 blobCenterXY=vec2(dot(delta,Tangent),dot(delta,Bitangent));vec2 quadUVin=2.0*UV-1.0; \nvec2 blobXY=blobCenterXY+quadUVin*blobSize;vec2 blobClipped=clamp(blobXY,-Face_Size*0.5,Face_Size*0.5);vec2 blobUV=(blobClipped-blobCenterXY)/max(blobSize,0.0001)*2.0;vec3 blobCorner=Face_Center+blobClipped.x*Tangent+blobClipped.y*Bitangent;Out_Position=mix(Position,blobCorner,Vx_Color.rrr);Out_UV=mix(In_UV,blobUV,Vx_Color.rr);Blob_Relative_UV=blobClipped/Face_Size.y;}\nvoid Round_Rect_Vertex_B36(\nvec2 UV,\nvec3 Tangent,\nvec3 Binormal,\nfloat Radius,\nfloat Anisotropy,\nvec2 Blob_Center_UV,\nout vec2 Rect_UV,\nout vec2 Scale_XY,\nout vec4 Rect_Parms)\n{Scale_XY=vec2(Anisotropy,1.0);Rect_UV=(UV-vec2(0.5,0.5))*Scale_XY;Rect_Parms.xy=Scale_XY*0.5-vec2(Radius,Radius);Rect_Parms.zw=Blob_Center_UV;}\nvec2 ProjectProximity(\nvec3 blobPosition,\nvec3 position,\nvec3 center,\nvec3 dir,\nvec3 xdir,\nvec3 ydir,\nout float vdistance\n)\n{vec3 delta=blobPosition-position;vec2 xy=vec2(dot(delta,xdir),dot(delta,ydir));vdistance=abs(dot(delta,dir));return xy;}\nvoid Proximity_Vertex_B33(\nvec3 Blob_Position,\nvec3 Blob_Position_2,\nvec3 Face_Center,\nvec3 Position,\nfloat Proximity_Far_Distance,\nfloat Relative_Scale,\nfloat Proximity_Anisotropy,\nvec3 Normal,\nvec3 Tangent,\nvec3 Binormal,\nout vec4 Extra,\nout float Distance_To_Face,\nout float Distance_Fade1,\nout float Distance_Fade2)\n{float distz1,distz2;Extra.xy=ProjectProximity(Blob_Position,Position,Face_Center,Normal,Tangent*Proximity_Anisotropy,Binormal,distz1)/Relative_Scale;Extra.zw=ProjectProximity(Blob_Position_2,Position,Face_Center,Normal,Tangent*Proximity_Anisotropy,Binormal,distz2)/Relative_Scale;Distance_To_Face=dot(Normal,Position-Face_Center);Distance_Fade1=1.0-clamp(distz1/Proximity_Far_Distance,0.0,1.0);Distance_Fade2=1.0-clamp(distz2/Proximity_Far_Distance,0.0,1.0);}\nvoid Object_To_World_Pos_B12(\nvec3 Pos_Object,\nout vec3 Pos_World)\n{Pos_World=(world*vec4(Pos_Object,1.0)).xyz;}\nvoid Choose_Blob_B27(\nvec4 Vx_Color,\nvec3 Position1,\nvec3 Position2,\nbool Blob_Enable_1,\nbool Blob_Enable_2,\nfloat Near_Size_1,\nfloat Near_Size_2,\nfloat Blob_Inner_Fade_1,\nfloat Blob_Inner_Fade_2,\nfloat Blob_Pulse_1,\nfloat Blob_Pulse_2,\nfloat Blob_Fade_1,\nfloat Blob_Fade_2,\nout vec3 Position,\nout float Near_Size,\nout float Inner_Fade,\nout float Blob_Enable,\nout float Fade,\nout float Pulse)\n{Position=Position1*(1.0-Vx_Color.g)+Vx_Color.g*Position2;float b1=Blob_Enable_1 ? 1.0 : 0.0;float b2=Blob_Enable_2 ? 1.0 : 0.0;Blob_Enable=b1+(b2-b1)*Vx_Color.g;Pulse=Blob_Pulse_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Pulse_2;Fade=Blob_Fade_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Fade_2;Near_Size=Near_Size_1*(1.0-Vx_Color.g)+Vx_Color.g*Near_Size_2;Inner_Fade=Blob_Inner_Fade_1*(1.0-Vx_Color.g)+Vx_Color.g*Blob_Inner_Fade_2;}\nvoid Move_Verts_B32(\nvec2 UV,\nfloat Radius,\nfloat Anisotropy,\nfloat Line_Width,\nfloat Visible,\nout vec3 New_P,\nout vec2 New_UV)\n{vec2 xy=2.0*UV-vec2(0.5,0.5);vec2 center=clamp(xy,0.0,1.0);vec2 delta=2.0*(xy-center);float deltaLength=length(delta);vec2 aniso=vec2(1.0/Anisotropy,1.0);center=(center-vec2(0.5,0.5))*(1.0-2.0*Radius*aniso);New_UV=vec2((2.0-2.0*deltaLength)*Visible,0.0);float deltaRadius= (Radius-Line_Width*New_UV.x);New_P.xy=(center+deltaRadius/deltaLength *aniso*delta);New_P.z=0.0;}\nvoid Object_To_World_Dir_B14(\nvec3 Dir_Object,\nout vec3 Binormal_World)\n{Binormal_World=(world*vec4(Dir_Object,0.0)).xyz;}\nvoid Proximity_Visibility_B55(\nfloat Selection,\nvec3 Proximity_Center,\nvec3 Proximity_Center_2,\nfloat Proximity_Far_Distance,\nfloat Proximity_Radius,\nvec3 Face_Center,\nvec3 Normal,\nvec2 Face_Size,\nfloat Gaze,\nout float Width)\n{float boxMaxSize=length(Face_Size)*0.5;float d1=dot(Proximity_Center-Face_Center,Normal);vec3 blob1=Proximity_Center-d1*Normal;float d2=dot(Proximity_Center_2-Face_Center,Normal);vec3 blob2=Proximity_Center_2-d2*Normal;vec3 delta1=blob1-Face_Center;vec3 delta2=blob2-Face_Center;float dist1=dot(delta1,delta1);float dist2=dot(delta2,delta2);float nearestProxDist=sqrt(min(dist1,dist2));Width=(1.0-step(boxMaxSize+Proximity_Radius,nearestProxDist))*(1.0-step(Proximity_Far_Distance,min(d1,d2))*(1.0-step(0.0001,Selection)));Width=max(Gaze,Width);}\nvec2 ramp2(vec2 start,vec2 end,vec2 x)\n{return clamp((x-start)/(end-start),vec2(0.0,0.0),vec2(1.0,1.0));}\nfloat computeSelection(\nvec3 blobPosition,\nvec3 normal,\nvec3 tangent,\nvec3 bitangent,\nvec3 faceCenter,\nvec2 faceSize,\nfloat selectionFuzz,\nfloat farDistance,\nfloat fadeLength\n)\n{vec3 delta=blobPosition-faceCenter;float absD=abs(dot(delta,normal));float fadeIn=1.0-clamp((absD-farDistance)/fadeLength,0.0,1.0);vec2 blobCenterXY=vec2(dot(delta,tangent),dot(delta,bitangent));vec2 innerFace=faceSize*(1.0-selectionFuzz)*0.5;vec2 selectPulse=ramp2(-faceSize*0.5,-innerFace,blobCenterXY)-ramp2(innerFace,faceSize*0.5,blobCenterXY);return selectPulse.x*selectPulse.y*fadeIn;}\nvoid Selection_Vertex_B31(\nvec3 Blob_Position,\nvec3 Blob_Position_2,\nvec3 Face_Center,\nvec2 Face_Size,\nvec3 Normal,\nvec3 Tangent,\nvec3 Bitangent,\nfloat Selection_Fuzz,\nfloat Selected,\nfloat Far_Distance,\nfloat Fade_Length,\nvec3 Active_Face_Dir,\nout float Show_Selection)\n{float select1=computeSelection(Blob_Position,Normal,Tangent,Bitangent,Face_Center,Face_Size,Selection_Fuzz,Far_Distance,Fade_Length);float select2=computeSelection(Blob_Position_2,Normal,Tangent,Bitangent,Face_Center,Face_Size,Selection_Fuzz,Far_Distance,Fade_Length);Show_Selection=mix(max(select1,select2),1.0,Selected);}\nvoid main()\n{vec3 Vec3_Q29=vec3(vec2(0,0).x,vec2(0,0).y,color.r);vec3 Nrm_World_Q24;Nrm_World_Q24=normalize((world*vec4(normal,0.0)).xyz);vec3 Face_Center_Q30;Face_Center_Q30=(world*vec4(vec3(0,0,0),1.0)).xyz;vec3 Tangent_World_Q13;Tangent_World_Q13=(world*vec4(tangent,0.0)).xyz;vec3 Result_Q42;Result_Q42=_Use_Global_Left_Index_ ? Global_Left_Index_Tip_Position.xyz : _Blob_Position_;vec3 Result_Q43;Result_Q43=_Use_Global_Right_Index_ ? Global_Right_Index_Tip_Position.xyz : _Blob_Position_2_;float Value_At_T_Q58=mix(_Blob_Near_Size_,_Blob_Pulse_Max_Size_,_Blob_Pulse_);float Value_At_T_Q59=mix(_Blob_Near_Size_2_,_Blob_Pulse_Max_Size_,_Blob_Pulse_2_);vec3 Cross_Q70=cross(normal,tangent);float Product_Q45=_Gaze_Intensity_*_Gaze_Focus_;float Step_Q46=step(0.0001,Product_Q45);vec3 Tangent_World_N_Q15=normalize(Tangent_World_Q13);vec3 Position_Q27;float Near_Size_Q27;float Inner_Fade_Q27;float Blob_Enable_Q27;float Fade_Q27;float Pulse_Q27;Choose_Blob_B27(color,Result_Q42,Result_Q43,_Blob_Enable_,_Blob_Enable_2_,Value_At_T_Q58,Value_At_T_Q59,_Blob_Inner_Fade_,_Blob_Inner_Fade_2_,_Blob_Pulse_,_Blob_Pulse_2_,_Blob_Fade_,_Blob_Fade_2_,Position_Q27,Near_Size_Q27,Inner_Fade_Q27,Blob_Enable_Q27,Fade_Q27,Pulse_Q27);vec3 Binormal_World_Q14;Object_To_World_Dir_B14(Cross_Q70,Binormal_World_Q14);float Anisotropy_Q21=length(Tangent_World_Q13)/length(Binormal_World_Q14);vec3 Binormal_World_N_Q16=normalize(Binormal_World_Q14);vec2 Face_Size_Q35;float ScaleY_Q35;Face_Size_Q35=vec2(length(Tangent_World_Q13),length(Binormal_World_Q14));ScaleY_Q35=Face_Size_Q35.y;float Out_Radius_Q38;float Out_Line_Width_Q38;Out_Radius_Q38=_Relative_To_Height_ ? _Radius_ : _Radius_/ScaleY_Q35;Out_Line_Width_Q38=_Relative_To_Height_ ? _Line_Width_ : _Line_Width_/ScaleY_Q35;float Show_Selection_Q31;Selection_Vertex_B31(Result_Q42,Result_Q43,Face_Center_Q30,Face_Size_Q35,Nrm_World_Q24,Tangent_World_N_Q15,Binormal_World_N_Q16,_Selection_Fuzz_,_Selected_,_Selected_Distance_,_Selected_Fade_Length_,vec3(0,0,-1),Show_Selection_Q31);float MaxAB_Q41=max(Show_Selection_Q31,Product_Q45);float Width_Q55;Proximity_Visibility_B55(Show_Selection_Q31,Result_Q42,Result_Q43,_Proximity_Far_Distance_,_Proximity_Near_Radius_,Face_Center_Q30,Nrm_World_Q24,Face_Size_Q35,Step_Q46,Width_Q55);vec3 New_P_Q32;vec2 New_UV_Q32;Move_Verts_B32(uv,Out_Radius_Q38,Anisotropy_Q21,Out_Line_Width_Q38,Width_Q55,New_P_Q32,New_UV_Q32);vec3 Pos_World_Q12;Object_To_World_Pos_B12(New_P_Q32,Pos_World_Q12);vec3 Out_Position_Q40;vec2 Out_UV_Q40;vec3 Blob_Info_Q40;vec2 Blob_Relative_UV_Q40;Blob_Vertex_B40(Pos_World_Q12,Nrm_World_Q24,Tangent_World_N_Q15,Binormal_World_N_Q16,Position_Q27,_Blob_Intensity_,Near_Size_Q27,_Blob_Far_Size_,_Blob_Near_Distance_,_Blob_Far_Distance_,color,uv,Face_Center_Q30,Face_Size_Q35,New_UV_Q32,_Blob_Fade_Length_,_Selection_Fade_,_Selection_Fade_Size_,Inner_Fade_Q27,Pulse_Q27,Fade_Q27,Blob_Enable_Q27,0.0,Out_Position_Q40,Out_UV_Q40,Blob_Info_Q40,Blob_Relative_UV_Q40);vec2 Rect_UV_Q36;vec2 Scale_XY_Q36;vec4 Rect_Parms_Q36;Round_Rect_Vertex_B36(New_UV_Q32,Tangent_World_Q13,Binormal_World_Q14,Out_Radius_Q38,Anisotropy_Q21,Blob_Relative_UV_Q40,Rect_UV_Q36,Scale_XY_Q36,Rect_Parms_Q36);vec4 Extra_Q33;float Distance_To_Face_Q33;float Distance_Fade1_Q33;float Distance_Fade2_Q33;Proximity_Vertex_B33(Result_Q42,Result_Q43,Face_Center_Q30,Pos_World_Q12,_Proximity_Far_Distance_,1.0,_Proximity_Anisotropy_,Nrm_World_Q24,Tangent_World_N_Q15,Binormal_World_N_Q16,Extra_Q33,Distance_To_Face_Q33,Distance_Fade1_Q33,Distance_Fade2_Q33);vec4 Vec4_Q37=vec4(MaxAB_Q41,Distance_Fade1_Q33,Distance_Fade2_Q33,Out_Radius_Q38);vec3 Position=Out_Position_Q40;vec3 Normal=Vec3_Q29;vec2 UV=Out_UV_Q40;vec3 Tangent=Blob_Info_Q40;vec3 Binormal=vec3(0,0,0);vec4 Color=vec4(1,1,1,1);vec4 Extra1=Rect_Parms_Q36;vec4 Extra2=Extra_Q33;vec4 Extra3=Vec4_Q37;gl_Position=viewProjection*vec4(Position,1);vNormal=Normal;vUV=UV;vTangent=Tangent;vExtra1=Extra1;vExtra2=Extra2;vExtra3=Extra3;}";class S_ extends Wt{constructor(){super(),this.SMOOTH_EDGES=!0,this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class x_ extends Ms{constructor(e,t){super(e,t),this.radius=.12,this.lineWidth=.01,this.relativeToHeight=!1,this._filterWidth=1,this.edgeColor=new Ie(.53,.53,.53,1),this.blobEnable=!0,this.blobPosition=new me(100,100,100),this.blobIntensity=.5,this.blobNearSize=.032,this.blobFarSize=.048,this.blobNearDistance=.008,this.blobFarDistance=.064,this.blobFadeLength=.04,this.blobInnerFade=.01,this.blobPulse=0,this.blobFade=1,this.blobPulseMaxSize=.05,this.blobEnable2=!0,this.blobPosition2=new me(10,10.1,-.6),this.blobNearSize2=.008,this.blobInnerFade2=.1,this.blobPulse2=0,this.blobFade2=1,this.gazeIntensity=.8,this.gazeFocus=0,this.selectionFuzz=.5,this.selected=1,this.selectionFade=.2,this.selectionFadeSize=0,this.selectedDistance=.08,this.selectedFadeLength=.08,this.proximityMaxIntensity=.45,this.proximityFarDistance=.16,this.proximityNearRadius=.016,this.proximityAnisotropy=1,this.useGlobalLeftIndex=!0,this.useGlobalRightIndex=!0,this.fadeOut=1,this.alphaMode=Dh.ALPHA_ADD,this.disableDepthWrite=!0,this.backFaceCulling=!1,this._blobTexture=new zi(x_.BLOB_TEXTURE_URL,t,!0,!1,zi.NEAREST_SAMPLINGMODE)}needAlphaBlending(){return!0}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new S_);const i=t.materialDefines,s=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(wi.PrepareDefinesForAttributes(e,i,!1,!1),i.isDirty){i.markAsProcessed(),s.resetCachedMaterial();const e=new is;i.FOG&&e.addFallback(1,"FOG"),wi.HandleFallbacksForShadows(i,e),i.IMAGEPROCESSINGPOSTPROCESS=s.imageProcessingConfiguration.applyByPostProcess;const r=[Oe.PositionKind];i.NORMAL&&r.push(Oe.NormalKind),i.UV1&&r.push(Oe.UVKind),i.UV2&&r.push(Oe.UV2Kind),i.VERTEXCOLOR&&r.push(Oe.ColorKind),i.TANGENT&&r.push(Oe.TangentKind),wi.PrepareAttributesForInstances(r,i);const o="mrdlFrontplate",a=i.toString(),l=["world","worldView","worldViewProjection","view","projection","viewProjection","cameraPosition","_Radius_","_Line_Width_","_Relative_To_Height_","_Filter_Width_","_Edge_Color_","_Fade_Out_","_Smooth_Edges_","_Blob_Enable_","_Blob_Position_","_Blob_Intensity_","_Blob_Near_Size_","_Blob_Far_Size_","_Blob_Near_Distance_","_Blob_Far_Distance_","_Blob_Fade_Length_","_Blob_Inner_Fade_","_Blob_Pulse_","_Blob_Fade_","_Blob_Pulse_Max_Size_","_Blob_Enable_2_","_Blob_Position_2_","_Blob_Near_Size_2_","_Blob_Inner_Fade_2_","_Blob_Pulse_2_","_Blob_Fade_2_","_Gaze_Intensity_","_Gaze_Focus_","_Blob_Texture_","_Selection_Fuzz_","_Selected_","_Selection_Fade_","_Selection_Fade_Size_","_Selected_Distance_","_Selected_Fade_Length_","_Proximity_Max_Intensity_","_Proximity_Far_Distance_","_Proximity_Near_Radius_","_Proximity_Anisotropy_","Global_Left_Index_Tip_Position","Global_Right_Index_Tip_Position","_Use_Global_Left_Index_","_Use_Global_Right_Index_"],h=[],c=[];wi.PrepareUniformsAndSamplersList({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:i,maxSimultaneousLights:4}),t.setEffect(s.getEngine().createEffect(o,{attributes:r,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:a,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),i)}return!(!t.effect||!t.effect.isReady()||(i._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){const s=this.getScene();if(!i.materialDefines)return;const n=i.effect;n&&(this._activeEffect=n,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",s.activeCamera.position),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Line_Width_",this.lineWidth),this._activeEffect.setFloat("_Relative_To_Height_",this.relativeToHeight?1:0),this._activeEffect.setFloat("_Filter_Width_",this._filterWidth),this._activeEffect.setDirectColor4("_Edge_Color_",this.edgeColor),this._activeEffect.setFloat("_Fade_Out_",this.fadeOut),this._activeEffect.setFloat("_Blob_Enable_",this.blobEnable?1:0),this._activeEffect.setVector3("_Blob_Position_",this.blobPosition),this._activeEffect.setFloat("_Blob_Intensity_",this.blobIntensity),this._activeEffect.setFloat("_Blob_Near_Size_",this.blobNearSize),this._activeEffect.setFloat("_Blob_Far_Size_",this.blobFarSize),this._activeEffect.setFloat("_Blob_Near_Distance_",this.blobNearDistance),this._activeEffect.setFloat("_Blob_Far_Distance_",this.blobFarDistance),this._activeEffect.setFloat("_Blob_Fade_Length_",this.blobFadeLength),this._activeEffect.setFloat("_Blob_Inner_Fade_",this.blobInnerFade),this._activeEffect.setFloat("_Blob_Pulse_",this.blobPulse),this._activeEffect.setFloat("_Blob_Fade_",this.blobFade),this._activeEffect.setFloat("_Blob_Pulse_Max_Size_",this.blobPulseMaxSize),this._activeEffect.setFloat("_Blob_Enable_2_",this.blobEnable2?1:0),this._activeEffect.setVector3("_Blob_Position_2_",this.blobPosition2),this._activeEffect.setFloat("_Blob_Near_Size_2_",this.blobNearSize2),this._activeEffect.setFloat("_Blob_Inner_Fade_2_",this.blobInnerFade2),this._activeEffect.setFloat("_Blob_Pulse_2_",this.blobPulse2),this._activeEffect.setFloat("_Blob_Fade_2_",this.blobFade2),this._activeEffect.setFloat("_Gaze_Intensity_",this.gazeIntensity),this._activeEffect.setFloat("_Gaze_Focus_",this.gazeFocus),this._activeEffect.setTexture("_Blob_Texture_",this._blobTexture),this._activeEffect.setFloat("_Selection_Fuzz_",this.selectionFuzz),this._activeEffect.setFloat("_Selected_",this.selected),this._activeEffect.setFloat("_Selection_Fade_",this.selectionFade),this._activeEffect.setFloat("_Selection_Fade_Size_",this.selectionFadeSize),this._activeEffect.setFloat("_Selected_Distance_",this.selectedDistance),this._activeEffect.setFloat("_Selected_Fade_Length_",this.selectedFadeLength),this._activeEffect.setFloat("_Proximity_Max_Intensity_",this.proximityMaxIntensity),this._activeEffect.setFloat("_Proximity_Far_Distance_",this.proximityFarDistance),this._activeEffect.setFloat("_Proximity_Near_Radius_",this.proximityNearRadius),this._activeEffect.setFloat("_Proximity_Anisotropy_",this.proximityAnisotropy),this._activeEffect.setFloat("_Use_Global_Left_Index_",this.useGlobalLeftIndex?1:0),this._activeEffect.setFloat("_Use_Global_Right_Index_",this.useGlobalRightIndex?1:0),this._afterBind(t,this._activeEffect))}getAnimatables(){return[]}dispose(e){super.dispose(e)}clone(e){return qe.Clone((()=>new x_(e,this.getScene())),this)}serialize(){const e=qe.Serialize(this);return e.customType="BABYLON.MRDLFrontplateMaterial",e}getClassName(){return"MRDLFrontplateMaterial"}static Parse(e,t,i){return qe.Parse((()=>new x_(e.name,t)),e,t,i)}}x_.BLOB_TEXTURE_URL="",De([Ge()],x_.prototype,"radius",void 0),De([Ge()],x_.prototype,"lineWidth",void 0),De([Ge()],x_.prototype,"relativeToHeight",void 0),De([Ge()],x_.prototype,"edgeColor",void 0),De([Ge()],x_.prototype,"blobEnable",void 0),De([Ge()],x_.prototype,"blobPosition",void 0),De([Ge()],x_.prototype,"blobIntensity",void 0),De([Ge()],x_.prototype,"blobNearSize",void 0),De([Ge()],x_.prototype,"blobFarSize",void 0),De([Ge()],x_.prototype,"blobNearDistance",void 0),De([Ge()],x_.prototype,"blobFarDistance",void 0),De([Ge()],x_.prototype,"blobFadeLength",void 0),De([Ge()],x_.prototype,"blobInnerFade",void 0),De([Ge()],x_.prototype,"blobPulse",void 0),De([Ge()],x_.prototype,"blobFade",void 0),De([Ge()],x_.prototype,"blobPulseMaxSize",void 0),De([Ge()],x_.prototype,"blobEnable2",void 0),De([Ge()],x_.prototype,"blobPosition2",void 0),De([Ge()],x_.prototype,"blobNearSize2",void 0),De([Ge()],x_.prototype,"blobInnerFade2",void 0),De([Ge()],x_.prototype,"blobPulse2",void 0),De([Ge()],x_.prototype,"blobFade2",void 0),De([Ge()],x_.prototype,"gazeIntensity",void 0),De([Ge()],x_.prototype,"gazeFocus",void 0),De([Ge()],x_.prototype,"selectionFuzz",void 0),De([Ge()],x_.prototype,"selected",void 0),De([Ge()],x_.prototype,"selectionFade",void 0),De([Ge()],x_.prototype,"selectionFadeSize",void 0),De([Ge()],x_.prototype,"selectedDistance",void 0),De([Ge()],x_.prototype,"selectedFadeLength",void 0),De([Ge()],x_.prototype,"proximityMaxIntensity",void 0),De([Ge()],x_.prototype,"proximityFarDistance",void 0),De([Ge()],x_.prototype,"proximityNearRadius",void 0),De([Ge()],x_.prototype,"proximityAnisotropy",void 0),De([Ge()],x_.prototype,"useGlobalLeftIndex",void 0),De([Ge()],x_.prototype,"useGlobalRightIndex",void 0),ue("BABYLON.GUI.MRDLFrontplateMaterial",x_);F.ShadersStore.mrdlInnerquadPixelShader="uniform vec3 cameraPosition;varying vec2 vUV;varying vec3 vTangent;uniform vec4 _Color_;uniform float _Radius_;uniform bool _Fixed_Radius_;uniform float _Filter_Width_;uniform float _Glow_Fraction_;uniform float _Glow_Max_;uniform float _Glow_Falloff_;float FilterStep_Bid194(float edge,float x,float filterWidth)\n{float dx=max(1.0E-5,fwidth(x)*filterWidth);return max((x+dx*0.5-max(edge,x-dx*0.5))/dx,0.0);}\nvoid Round_Rect_B194(\nfloat Size_X,\nfloat Size_Y,\nfloat Radius,\nvec4 Rect_Color,\nfloat Filter_Width,\nvec2 UV,\nfloat Glow_Fraction,\nfloat Glow_Max,\nfloat Glow_Falloff,\nout vec4 Color)\n{vec2 halfSize=vec2(Size_X,Size_Y)*0.5;vec2 r=max(min(vec2(Radius,Radius),halfSize),vec2(0.01,0.01));vec2 v=abs(UV);vec2 nearestp=min(v,halfSize-r);vec2 delta=(v-nearestp)/max(vec2(0.01,0.01),r);float Distance=length(delta);float insideRect=1.0-FilterStep_Bid194(1.0-Glow_Fraction,Distance,Filter_Width);float glow=clamp((1.0-Distance)/Glow_Fraction,0.0,1.0);glow=pow(glow,Glow_Falloff);Color=Rect_Color*max(insideRect,glow*Glow_Max);}\nvoid main()\n{float X_Q192;float Y_Q192;float Z_Q192;X_Q192=vTangent.x;Y_Q192=vTangent.y;Z_Q192=vTangent.z;vec4 Color_Q194;Round_Rect_B194(X_Q192,1.0,Y_Q192,_Color_,_Filter_Width_,vUV,_Glow_Fraction_,_Glow_Max_,_Glow_Falloff_,Color_Q194);vec4 Out_Color=Color_Q194;float Clip_Threshold=0.0;gl_FragColor=Out_Color;}\n";F.ShadersStore.mrdlInnerquadVertexShader="uniform mat4 world;uniform mat4 viewProjection;uniform vec3 cameraPosition;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;attribute vec3 tangent;attribute vec4 color;uniform vec4 _Color_;uniform float _Radius_;uniform bool _Fixed_Radius_;uniform float _Filter_Width_;uniform float _Glow_Fraction_;uniform float _Glow_Max_;uniform float _Glow_Falloff_;varying vec2 vUV;varying vec3 vTangent;void main()\n{vec3 Pos_World_Q189;Pos_World_Q189=(world*vec4(position,1.0)).xyz;vec3 Dir_World_Q190;Dir_World_Q190=(world*vec4(tangent,0.0)).xyz;vec3 Dir_World_Q191;Dir_World_Q191=(world*vec4((cross(normal,tangent)),0.0)).xyz;float Length_Q180=length(Dir_World_Q190);float Length_Q181=length(Dir_World_Q191);float Quotient_Q184=Length_Q180/Length_Q181;float Quotient_Q195=_Radius_/Length_Q181;vec2 Result_Q193;Result_Q193=vec2((uv.x-0.5)*Length_Q180/Length_Q181,(uv.y-0.5));float Result_Q198=_Fixed_Radius_ ? Quotient_Q195 : _Radius_;vec3 Vec3_Q183=vec3(Quotient_Q184,Result_Q198,0);vec3 Position=Pos_World_Q189;vec3 Normal=vec3(0,0,0);vec2 UV=Result_Q193;vec3 Tangent=Vec3_Q183;vec3 Binormal=vec3(0,0,0);vec4 Color=color;gl_Position=viewProjection*vec4(Position,1);vUV=UV;vTangent=Tangent;}\n";class C_ extends Wt{constructor(){super(),this._needNormals=!0,this._needUVs=!0,this.rebuild()}}class y_ extends Ms{constructor(e,t){super(e,t),this.color=new Ie(1,1,1,.05),this.radius=.12,this.fixedRadius=!0,this._filterWidth=1,this.glowFraction=0,this.glowMax=.5,this.glowFalloff=2,this.alphaMode=Dh.ALPHA_COMBINE,this.backFaceCulling=!1}needAlphaBlending(){return!0}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}isReadyForSubMesh(e,t){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady)return!0;t.materialDefines||(t.materialDefines=new C_);const i=t.materialDefines,s=this.getScene();if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(wi.PrepareDefinesForAttributes(e,i,!0,!1),i.isDirty){i.markAsProcessed(),s.resetCachedMaterial();const e=new is;i.FOG&&e.addFallback(1,"FOG"),wi.HandleFallbacksForShadows(i,e),i.IMAGEPROCESSINGPOSTPROCESS=s.imageProcessingConfiguration.applyByPostProcess;const r=[Oe.PositionKind];i.NORMAL&&r.push(Oe.NormalKind),i.UV1&&r.push(Oe.UVKind),i.UV2&&r.push(Oe.UV2Kind),i.VERTEXCOLOR&&r.push(Oe.ColorKind),i.TANGENT&&r.push(Oe.TangentKind),wi.PrepareAttributesForInstances(r,i);const o="mrdlInnerquad",a=i.toString(),l=["world","worldView","worldViewProjection","view","projection","viewProjection","cameraPosition","_Color_","_Radius_","_Fixed_Radius_","_Filter_Width_","_Glow_Fraction_","_Glow_Max_","_Glow_Falloff_"],h=[],c=[];wi.PrepareUniformsAndSamplersList({uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:i,maxSimultaneousLights:4}),t.setEffect(s.getEngine().createEffect(o,{attributes:r,uniformsNames:l,uniformBuffersNames:c,samplers:h,defines:a,fallbacks:e,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:4}},n),i)}return!(!t.effect||!t.effect.isReady()||(i._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,0))}bindForSubMesh(e,t,i){const s=this.getScene();if(!i.materialDefines)return;const n=i.effect;n&&(this._activeEffect=n,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),this._activeEffect.setVector3("cameraPosition",s.activeCamera.position),this._activeEffect.setDirectColor4("_Color_",this.color),this._activeEffect.setFloat("_Radius_",this.radius),this._activeEffect.setFloat("_Fixed_Radius_",this.fixedRadius?1:0),this._activeEffect.setFloat("_Filter_Width_",this._filterWidth),this._activeEffect.setFloat("_Glow_Fraction_",this.glowFraction),this._activeEffect.setFloat("_Glow_Max_",this.glowMax),this._activeEffect.setFloat("_Glow_Falloff_",this.glowFalloff),this._afterBind(t,this._activeEffect))}getAnimatables(){return[]}dispose(e){super.dispose(e)}clone(e){return qe.Clone((()=>new y_(e,this.getScene())),this)}serialize(){const e=qe.Serialize(this);return e.customType="BABYLON.MRDLInnerquadMaterial",e}getClassName(){return"MRDLInnerquadMaterial"}static Parse(e,t,i){return qe.Parse((()=>new y_(e.name,t)),e,t,i)}}De([Ge()],y_.prototype,"color",void 0),De([Ge()],y_.prototype,"radius",void 0),De([Ge()],y_.prototype,"fixedRadius",void 0),De([Ge()],y_.prototype,"glowFraction",void 0),De([Ge()],y_.prototype,"glowMax",void 0),De([Ge()],y_.prototype,"glowFalloff",void 0),ue("BABYLON.GUI.MRDLInnerquadMaterial",y_);class A_ extends Xu{_disposeTooltip(){this._tooltipFade=null,this._tooltipTextBlock&&this._tooltipTextBlock.dispose(),this._tooltipTexture&&this._tooltipTexture.dispose(),this._tooltipMesh&&this._tooltipMesh.dispose(),this.onPointerEnterObservable.remove(this._tooltipHoverObserver),this.onPointerOutObservable.remove(this._tooltipOutObserver)}set renderingGroupId(e){this._backPlate.renderingGroupId=e,this._textPlate.renderingGroupId=e,this._frontPlate.renderingGroupId=e,this._backGlow.renderingGroupId=e,this._innerQuad.renderingGroupId=e,this._tooltipMesh&&(this._tooltipMesh.renderingGroupId=e)}get renderingGroupId(){return this._backPlate.renderingGroupId}get mesh(){return this._backPlate}set tooltipText(e){if(e){if(!this._tooltipFade){const e=this._backPlate._scene.useRightHandedSystem;this._tooltipMesh=Rr("",{size:1},this._backPlate._scene),this._tooltipMesh.position=me.Down().scale(.7).add(me.Forward(e).scale(-.15)),this._tooltipMesh.isPickable=!1,this._tooltipMesh.parent=this._frontPlateCollisionMesh,this._tooltipTexture=fu.CreateForMesh(this._tooltipMesh);const t=new Ud;t.height=.25,t.width=.8,t.cornerRadius=25,t.color="#ffffff",t.thickness=20,t.background="#060668",this._tooltipTexture.addControl(t),this._tooltipTextBlock=new Vd,this._tooltipTextBlock.color="white",this._tooltipTextBlock.fontSize=100,this._tooltipTexture.addControl(this._tooltipTextBlock),this._tooltipFade=new zu,this._tooltipFade.delay=500,this._tooltipMesh.addBehavior(this._tooltipFade),this._tooltipHoverObserver=this.onPointerEnterObservable.add((()=>{this._tooltipFade&&this._tooltipFade.fadeIn(!0)})),this._tooltipOutObserver=this.onPointerOutObservable.add((()=>{this._tooltipFade&&this._tooltipFade.fadeIn(!1)}))}this._tooltipTextBlock&&(this._tooltipTextBlock.text=e)}else this._disposeTooltip()}get tooltipText(){var e;return(null===(e=this._tooltipTextBlock)||void 0===e?void 0:e.text)||null}get text(){return this._text}set text(e){this._text!==e&&(this._text=e,this._rebuildContent())}get subtext(){return this._subtext}set subtext(e){this._subtext!==e&&(this._subtext=e,this._rebuildContent())}get imageUrl(){return this._imageUrl}set imageUrl(e){this._imageUrl!==e&&(this._imageUrl=e,this._rebuildContent())}get backMaterial(){return this._backMaterial}get frontMaterial(){return this._frontMaterial}get backGlowMaterial(){return this._backGlowMaterial}get innerQuadMaterial(){return this._innerQuadMaterial}get plateMaterial(){return this._plateMaterial}get shareMaterials(){return this._shareMaterials}set isBackplateVisible(e){this.mesh&&this._backMaterial&&(e&&!this._isBackplateVisible?this._backPlate.visibility=1:!e&&this._isBackplateVisible&&(this._backPlate.visibility=0)),this._isBackplateVisible=e}constructor(e,t=!0){super(e),this.width=1,this.height=1,this.radius=.14,this.textSizeInPixels=18,this.imageSizeInPixels=40,this.plateMaterialColor=new Re(.4,.4,.4),this.frontPlateDepth=.2,this.backPlateDepth=.04,this.backGlowOffset=.1,this.flatPlaneDepth=.001,this.innerQuadRadius=this.radius-.04,this.innerQuadColor=new Ie(0,0,0,0),this.innerQuadToggledColor=new Ie(.5197843,.6485234,.9607843,.6),this.innerQuadHoverColor=new Ie(1,1,1,.05),this.innerQuadToggledHoverColor=new Ie(.5197843,.6485234,.9607843,1),this._isBackplateVisible=!0,this._shareMaterials=!0,this._shareMaterials=t,this.pointerEnterAnimation=()=>{this._frontPlate&&this._textPlate&&!this.isToggleButton&&this._performEnterExitAnimation(1),this.isToggleButton&&this._innerQuadMaterial&&(this.isToggled?this._innerQuadMaterial.color=this.innerQuadToggledHoverColor:this._innerQuadMaterial.color=this.innerQuadHoverColor)},this.pointerOutAnimation=()=>{this._frontPlate&&this._textPlate&&!this.isToggleButton&&this._performEnterExitAnimation(-.8),this.isToggleButton&&this._innerQuadMaterial&&this._onToggle(this.isToggled)},this.pointerDownAnimation=()=>{},this.pointerUpAnimation=()=>{},this._pointerClickObserver=this.onPointerClickObservable.add((()=>{this._frontPlate&&this._backGlow&&!this.isActiveNearInteraction&&this._performClickAnimation(),this.isToggleButton&&this._innerQuadMaterial&&this._onToggle(this.isToggled)})),this._pointerEnterObserver=this.onPointerEnterObservable.add((()=>{this.pointerEnterAnimation()})),this._pointerOutObserver=this.onPointerOutObservable.add((()=>{this.pointerOutAnimation()})),this._toggleObserver=this.onToggleObservable.add((e=>{this._innerQuadMaterial.color=e?this.innerQuadToggledColor:this.innerQuadColor}))}_getTypeName(){return"TouchHolographicButton"}_rebuildContent(){let e;e=this._getAspectRatio()<=1?this._alignContentVertically():this._alignContentHorizontally(),this.content=e}_getAspectRatio(){return this.width/this.height}_alignContentVertically(){const e=new Hd;if(e.isVertical=!0,c()&&document.createElement&&this._imageUrl){const t=new Gd;t.source=this._imageUrl,t.heightInPixels=180,t.widthInPixels=100,t.paddingTopInPixels=40,t.paddingBottomInPixels=40,e.addControl(t)}if(this._text){const t=new Vd;t.text=this._text,t.color="white",t.heightInPixels=30,t.fontSize=24,e.addControl(t)}return e}_alignContentHorizontally(){let e=240;const t=15,i=new Ud;i.widthInPixels=e,i.heightInPixels=e,i.color="transparent",i.setPaddingInPixels(t,t,t,t),e-=30;const s=new Hd;if(s.isVertical=!1,s.scaleY=this._getAspectRatio(),c()&&document.createElement&&this._imageUrl){const t=new Ud(`${this.name}_image`);t.widthInPixels=this.imageSizeInPixels,t.heightInPixels=this.imageSizeInPixels,t.color="transparent",e-=this.imageSizeInPixels;const i=new Gd;i.source=this._imageUrl,t.addControl(i),s.addControl(t)}if(this._text){const i=new Vd(`${this.name}_text`);if(i.text=this._text,i.color="white",i.fontSize=this.textSizeInPixels,i.widthInPixels=e,this._imageUrl&&(i.textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,i.paddingLeftInPixels=t),this._subtext){const n=new jd;n.addColumnDefinition(1),n.addRowDefinition(.5),n.addRowDefinition(.5),n.widthInPixels=e,n.heightInPixels=45;const r=new Vd(`${this.name}_subtext`);r.text=this._subtext,r.color="#EEEEEEAB",r.fontSize=.75*this.textSizeInPixels,r.fontWeight="600",this._imageUrl&&(r.textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,r.paddingLeftInPixels=t),n.addControl(i,0),n.addControl(r,1),s.addControl(n)}else s.addControl(i)}return i.addControl(s),i}_createNode(e){var t;this.name=null!==(t=this.name)&&void 0!==t?t:"TouchHolographicButton";const i=this._createBackPlate(e),s=this._createFrontPlate(e),n=this._createInnerQuad(e),r=this._createBackGlow(e);this._frontPlateCollisionMesh=s,this._textPlate=super._createNode(e),this._textPlate.name=`${this.name}_textPlate`,this._textPlate.isPickable=!1,this._textPlate.scaling.x=this.width,this._textPlate.parent=s,this._backPlate=i,this._backPlate.position=me.Forward(e.useRightHandedSystem).scale(this.backPlateDepth/2),this._backPlate.isPickable=!1,this._backPlate.addChild(s),this._backPlate.addChild(n),r&&this._backPlate.addChild(r);const o=new Bn(`${this.name}_root`,e);return this._backPlate.setParent(o),this.collisionMesh=s,this.collidableFrontDirection=this._backPlate.forward.negate(),o}_createBackPlate(e){const t=Fr(`${this.name}_backPlate`,{},e);return t.isPickable=!1,t.visibility=0,t.scaling.z=.2,da.ImportMeshAsync(void 0,A_.MRTK_ASSET_BASE_URL,A_.BACKPLATE_MODEL_FILENAME,e).then((e=>{const i=e.meshes[1];i.visibility=0,this._isBackplateVisible&&(i.visibility=1,i.name=`${this.name}_backPlate`,i.isPickable=!1,i.scaling.x=this.width,i.scaling.y=this.height,i.parent=t),this._backMaterial&&(i.material=this._backMaterial),this._backPlate=i})),t}_createFrontPlate(e){const t=Fr(`${this.name}_frontPlate`,{width:this.width,height:this.height,depth:this.frontPlateDepth},e);return t.isPickable=!0,t.isNearPickable=!0,t.visibility=0,t.position=me.Forward(e.useRightHandedSystem).scale((this.backPlateDepth-this.frontPlateDepth)/2),da.ImportMeshAsync(void 0,A_.MRTK_ASSET_BASE_URL,A_.FRONTPLATE_MODEL_FILENAME,e).then((i=>{const s=Fr(`${this.name}_collisionPlate`,{width:this.width,height:this.height},e);s.isPickable=!1,s.scaling.z=this.frontPlateDepth,s.visibility=0,s.parent=t,this._collisionPlate=s;const n=i.meshes[1];n.name=`${this.name}_frontPlate`,n.isPickable=!1,n.scaling.x=this.width-this.backGlowOffset,n.scaling.y=this.height-this.backGlowOffset,n.position=me.Forward(e.useRightHandedSystem).scale(-.5),n.parent=s,this.isToggleButton&&(n.visibility=0),this._frontMaterial&&(n.material=this._frontMaterial),this._textPlate.scaling.x=1,this._textPlate.parent=n,this._frontPlate=n})),t}_createInnerQuad(e){const t=Fr(`${this.name}_innerQuad`,{},e);return t.isPickable=!1,t.visibility=0,t.scaling.z=this.flatPlaneDepth,t.position.z+=this.backPlateDepth/2-this.flatPlaneDepth,da.ImportMeshAsync(void 0,A_.MRTK_ASSET_BASE_URL,A_.INNERQUAD_MODEL_FILENAME,e).then((e=>{const i=e.meshes[1];i.name=`${this.name}_innerQuad`,i.isPickable=!1,i.scaling.x=this.width-this.backGlowOffset,i.scaling.y=this.height-this.backGlowOffset,i.parent=t,this._innerQuadMaterial&&(i.material=this._innerQuadMaterial),this._innerQuad=i})),t}_createBackGlow(e){if(this.isToggleButton)return;const t=Fr(`${this.name}_backGlow`,{},e);return t.isPickable=!1,t.visibility=0,t.scaling.z=this.flatPlaneDepth,t.position.z+=this.backPlateDepth/2-2*this.flatPlaneDepth,da.ImportMeshAsync(void 0,A_.MRTK_ASSET_BASE_URL,A_.BACKGLOW_MODEL_FILENAME,e).then((e=>{const i=e.meshes[1];i.name=`${this.name}_backGlow`,i.isPickable=!1,i.scaling.x=this.width-this.backGlowOffset,i.scaling.y=this.height-this.backGlowOffset,i.parent=t,this._backGlowMaterial&&(i.material=this._backGlowMaterial),this._backGlow=i})),t}_applyFacade(e){this._plateMaterial.emissiveTexture=e,this._plateMaterial.opacityTexture=e,this._plateMaterial.diffuseColor=this.plateMaterialColor}_performClickAnimation(){const e=new T_("Click Animation Group"),t=[{name:"backGlowMotion",mesh:this._backGlow,property:"material.motion",keys:[{frame:0,values:[0,0,0]},{frame:20,values:[1,.0144,.0144]},{frame:40,values:[.0027713229489760476,0,0]},{frame:45,values:[.0027713229489760476]}]},{name:"_collisionPlateZSlide",mesh:this._collisionPlate,property:"position.z",keys:[{frame:0,values:[0,0,0]},{frame:20,values:[me.Forward(this._collisionPlate._scene.useRightHandedSystem).scale(this.frontPlateDepth/2).z,0,0]},{frame:40,values:[0,.005403332496794331]},{frame:45,values:[0]}]},{name:"_collisionPlateZScale",mesh:this._collisionPlate,property:"scaling.z",keys:[{frame:0,values:[this.frontPlateDepth,0,0]},{frame:20,values:[this.backPlateDepth,0,0]},{frame:40,values:[this.frontPlateDepth,.0054]},{frame:45,values:[this.frontPlateDepth]}]}];for(const i of t){const t=new cr(i.name,i.property,60,cr.ANIMATIONTYPE_FLOAT,cr.ANIMATIONLOOPMODE_CYCLE),s=[];for(const e of i.keys)s.push({frame:e.frame,value:e.values[0],inTangent:e.values[1],outTangent:e.values[2],interpolation:e.values[3]});t.setKeys(s),i.mesh&&e.addTargetedAnimation(t,i.mesh)}e.normalize(0,45),e.speedRatio=1,e.play()}_performEnterExitAnimation(e){const t=new T_("Enter Exit Animation Group"),i=[{name:"frontPlateFadeOut",mesh:this._frontPlate,property:"material.fadeOut",keys:[{frame:0,values:[0,0,.025045314830017686,0]},{frame:40,values:[1.00205599570012,.025045314830017686,0,0]}]},{name:"textPlateZSlide",mesh:this._textPlate,property:"position.z",keys:[{frame:0,values:[0,0,0]},{frame:40,values:[me.Forward(this._textPlate._scene.useRightHandedSystem).scale(-.15).z,0,0]}]}];for(const e of i){const i=new cr(e.name,e.property,60,cr.ANIMATIONTYPE_FLOAT,cr.ANIMATIONLOOPMODE_CYCLE),s=[];for(const t of e.keys)s.push({frame:t.frame,value:t.values[0],inTangent:t.values[1],outTangent:t.values[2],interpolation:t.values[3]});i.setKeys(s),e.mesh&&t.addTargetedAnimation(i,e.mesh)}t.normalize(0,45),t.speedRatio=e,t.play()}_createBackMaterial(e){var t;this._backMaterial=null!==(t=this._backMaterial)&&void 0!==t?t:new m_(this.name+"backPlateMaterial",e.getScene()),this._backMaterial.absoluteSizes=!0,this._backMaterial.radius=this.radius,this._backMaterial.lineWidth=.02}_createFrontMaterial(e){var t;this._frontMaterial=null!==(t=this._frontMaterial)&&void 0!==t?t:new x_(this.name+"Front Material",e.getScene()),this.frontMaterial.radius=this.innerQuadRadius,this.frontMaterial.fadeOut=0}_createBackGlowMaterial(e){var t;const i=this.radius+.04;this._backGlowMaterial=null!==(t=this._backGlowMaterial)&&void 0!==t?t:new E_(this.name+"Back Glow Material",e.getScene()),this._backGlowMaterial.bevelRadius=i,this._backGlowMaterial.lineWidth=i,this._backGlowMaterial.motion=0}_createInnerQuadMaterial(e){var t;this._innerQuadMaterial=null!==(t=this._innerQuadMaterial)&&void 0!==t?t:new y_("inner_quad",e.getScene()),this._innerQuadMaterial.radius=this.innerQuadRadius,this.isToggleButton&&(this._innerQuadMaterial.color=this.innerQuadColor)}_createPlateMaterial(e){var t;this._plateMaterial=null!==(t=this._plateMaterial)&&void 0!==t?t:new zs(this.name+"Plate Material",e.getScene()),this._plateMaterial.specularColor=Re.Black()}_onToggle(e){super._onToggle(e)}_affectMaterial(e){this._shareMaterials?(this._host._touchSharedMaterials.mrdlBackplateMaterial?this._backMaterial=this._host._touchSharedMaterials.mrdlBackplateMaterial:(this._createBackMaterial(e),this._host._touchSharedMaterials.mrdlBackplateMaterial=this._backMaterial),this._host._touchSharedMaterials.mrdlFrontplateMaterial?this._frontMaterial=this._host._touchSharedMaterials.mrdlFrontplateMaterial:(this._createFrontMaterial(e),this._host._touchSharedMaterials.mrdlFrontplateMaterial=this._frontMaterial),this._host._touchSharedMaterials.mrdlBackglowMaterial?this._backGlowMaterial=this._host._touchSharedMaterials.mrdlBackglowMaterial:(this._createBackGlowMaterial(e),this._host._touchSharedMaterials.mrdlBackglowMaterial=this._backGlowMaterial),this._host._touchSharedMaterials.mrdlInnerQuadMaterial?this._innerQuadMaterial=this._host._touchSharedMaterials.mrdlInnerQuadMaterial:(this._createInnerQuadMaterial(e),this._host._touchSharedMaterials.mrdlInnerQuadMaterial=this._innerQuadMaterial)):(this._createBackMaterial(e),this._createFrontMaterial(e),this._createBackGlowMaterial(e),this._createInnerQuadMaterial(e)),this._createPlateMaterial(e),this._backPlate.material=this._backMaterial,this._textPlate.material=this._plateMaterial,this._isBackplateVisible||(this._backPlate.visibility=0),this._frontPlate&&(this._frontPlate.material=this._frontMaterial),this._backGlow&&(this._backGlow.material=this._backGlowMaterial),this._innerQuad&&(this._innerQuad.material=this._innerQuadMaterial),this._rebuildContent()}dispose(){super.dispose(),this._disposeTooltip(),this.onPointerClickObservable.remove(this._pointerClickObserver),this.onPointerEnterObservable.remove(this._pointerEnterObserver),this.onPointerOutObservable.remove(this._pointerOutObserver),this.onToggleObservable.remove(this._toggleObserver),this.shareMaterials||(this._backMaterial.dispose(),this._frontMaterial.dispose(),this._plateMaterial.dispose(),this._backGlowMaterial.dispose(),this._innerQuadMaterial.dispose(),this._pickedPointObserver&&(this._host.onPickedPointChangedObservable.remove(this._pickedPointObserver),this._pickedPointObserver=null))}}A_.MRTK_ASSET_BASE_URL="https://assets.babylonjs.com/meshes/MRTK/",A_.FRONTPLATE_MODEL_FILENAME="mrtk-fluent-frontplate.glb",A_.BACKPLATE_MODEL_FILENAME="mrtk-fluent-backplate.glb",A_.BACKGLOW_MODEL_FILENAME="mrtk-fluent-button.glb",A_.INNERQUAD_MODEL_FILENAME="SlateProximity.glb";class R_{get scene(){return this._scene}get utilityLayer(){return this._utilityLayer}get controlScaling(){return this._customControlScaling}set controlScaling(e){if(this._customControlScaling!==e&&e>0){const t=e/this._customControlScaling;this._customControlScaling=e,this._rootContainer.children.forEach((i=>{i.scaling.scaleInPlace(t),1!==e&&(i._isScaledByManager=!0)}))}}get useRealisticScaling(){return this.controlScaling===R_.MRTK_REALISTIC_SCALING}set useRealisticScaling(e){this.controlScaling=e?R_.MRTK_REALISTIC_SCALING:1}constructor(e){this._customControlScaling=1,this._lastControlOver={},this._lastControlDown={},this.onPickedPointChangedObservable=new s,this.onPickingObservable=new s,this._sharedMaterials={},this._touchSharedMaterials={},this._scene=e||u.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add((()=>{this._sceneDisposeObserver=null,this._utilityLayer=null,this.dispose()})),this._utilityLayer=Aa._CreateDefaultUtilityLayerFromScene(this._scene),this._utilityLayer.onlyCheckPointerDownEvents=!1,this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.mainSceneTrackerPredicate=e=>{var t,i,s;return e&&(null===(s=null===(i=null===(t=e.reservedDataStore)||void 0===t?void 0:t.GUI3D)||void 0===i?void 0:i.control)||void 0===s?void 0:s._node)},this._rootContainer=new bu("RootContainer"),this._rootContainer._host=this;const t=this._utilityLayer.utilityLayerScene;this._pointerOutObserver=this._utilityLayer.onPointerOutObservable.add((e=>{this._handlePointerOut(e,!0)})),this._pointerObserver=t.onPointerObservable.add((e=>{this._doPicking(e)})),this._utilityLayer.utilityLayerScene.autoClear=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,new In("hemi",me.Up(),this._utilityLayer.utilityLayerScene)}_handlePointerOut(e,t){const i=this._lastControlOver[e];i&&(i._onPointerOut(i),delete this._lastControlOver[e]),t&&this._lastControlDown[e]&&(this._lastControlDown[e].forcePointerUp(),delete this._lastControlDown[e]),this.onPickedPointChangedObservable.notifyObservers(null)}_doPicking(e){var t,i,s;if(!this._utilityLayer||!this._utilityLayer.shouldRender||!this._utilityLayer.utilityLayerScene.activeCamera)return!1;const n=e.event,r=n.pointerId||0,o=n.button,a=e.pickInfo;if(a&&this.onPickingObservable.notifyObservers(a.pickedMesh),!a||!a.hit)return this._handlePointerOut(r,e.type===ci.POINTERUP),!1;a.pickedPoint&&this.onPickedPointChangedObservable.notifyObservers(a.pickedPoint);const l=null===(i=null===(t=a.pickedMesh.reservedDataStore)||void 0===t?void 0:t.GUI3D)||void 0===i?void 0:i.control;return l&&!l._processObservables(e.type,a.pickedPoint,(null===(s=a.originMesh)||void 0===s?void 0:s.position)||null,r,o)&&e.type===ci.POINTERMOVE&&(this._lastControlOver[r]&&this._lastControlOver[r]._onPointerOut(this._lastControlOver[r]),delete this._lastControlOver[r]),e.type===ci.POINTERUP&&(this._lastControlDown[n.pointerId]&&(this._lastControlDown[n.pointerId].forcePointerUp(),delete this._lastControlDown[n.pointerId]),("touch"===n.pointerType||"xr"===n.pointerType&&this._scene.getEngine().hostInformation.isMobile)&&this._handlePointerOut(r,!1)),!0}get rootContainer(){return this._rootContainer}containsControl(e){return this._rootContainer.containsControl(e)}addControl(e){return this._rootContainer.addControl(e),1!==this._customControlScaling&&(e.scaling.scaleInPlace(this._customControlScaling),e._isScaledByManager=!0),this}removeControl(e){return this._rootContainer.removeControl(e),e._isScaledByManager&&(e.scaling.scaleInPlace(1/this._customControlScaling),e._isScaledByManager=!1),this}dispose(){this._rootContainer.dispose();for(const e in this._sharedMaterials)Object.prototype.hasOwnProperty.call(this._sharedMaterials,e)&&this._sharedMaterials[e].dispose();this._sharedMaterials={};for(const e in this._touchSharedMaterials)Object.prototype.hasOwnProperty.call(this._touchSharedMaterials,e)&&this._touchSharedMaterials[e].dispose();this._touchSharedMaterials={},this._pointerOutObserver&&this._utilityLayer&&(this._utilityLayer.onPointerOutObservable.remove(this._pointerOutObserver),this._pointerOutObserver=null),this.onPickedPointChangedObservable.clear(),this.onPickingObservable.clear();const e=this._utilityLayer?this._utilityLayer.utilityLayerScene:null;e&&this._pointerObserver&&(e.onPointerObservable.remove(this._pointerObserver),this._pointerObserver=null),this._scene&&this._sceneDisposeObserver&&(this._scene.onDisposeObservable.remove(this._sceneDisposeObserver),this._sceneDisposeObserver=null),this._utilityLayer&&this._utilityLayer.dispose()}}var I_;R_.MRTK_REALISTIC_SCALING=.032;const P_=(I_="file:///C:/Users/vinch/Documents/Vincent/Genshin/WebViewer/model-viewer/node_modules/@babylonjs/havok/lib/esm/HavokPhysics_es.js",function(e){var t,s,n=void 0!==(e=e||{})?e:{};n.ready=new Promise((function(e,i){t=e,s=i}));var r,o=Object.assign({},n),a=[],l=(e,t)=>{throw t},h="";"undefined"!=typeof document&&document.currentScript&&(h=document.currentScript.src),I_&&(h=I_),h=0!==h.indexOf("blob:")?h.substr(0,h.replace(/[?#].*/,"").lastIndexOf("/")+1):"";var c=n.print||console.log.bind(console),d=n.printErr||console.warn.bind(console);Object.assign(n,o),o=null,n.arguments&&(a=n.arguments),n.thisProgram&&n.thisProgram,n.quit&&(l=n.quit);var u;n.wasmBinary&&(u=n.wasmBinary);var _,f=n.noExitRuntime||!0;"object"!=typeof WebAssembly&&k("no native wasm support detected");var p,m,g,v,T,b,E,S,x,C,y,A,R=!1,I="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function P(e,t,i){for(var s=t+i,n=t;e[n]&&!(n>=s);)++n;if(n-t>16&&e.buffer&&I)return I.decode(e.subarray(t,n));for(var r="";t<n;){var o=e[t++];if(128&o){var a=63&e[t++];if(192!=(224&o)){var l=63&e[t++];if((o=224==(240&o)?(15&o)<<12|a<<6|l:(7&o)<<18|a<<12|l<<6|63&e[t++])<65536)r+=String.fromCharCode(o);else{var h=o-65536;r+=String.fromCharCode(55296|h>>10,56320|1023&h)}}else r+=String.fromCharCode((31&o)<<6|a)}else r+=String.fromCharCode(o)}return r}function M(e){m=e,n.HEAP8=g=new Int8Array(e),n.HEAP16=T=new Int16Array(e),n.HEAP32=E=new Int32Array(e),n.HEAPU8=v=new Uint8Array(e),n.HEAPU16=b=new Uint16Array(e),n.HEAPU32=S=new Uint32Array(e),n.HEAPF32=x=new Float32Array(e),n.HEAPF64=A=new Float64Array(e),n.HEAP64=C=new BigInt64Array(e),n.HEAPU64=y=new BigUint64Array(e)}n.INITIAL_MEMORY;var O,D=[],N=[],F=[],L=[],w=0,B=null,U=null;function k(e){n.onAbort&&n.onAbort(e),d(e="Aborted("+e+")"),R=!0,p=1,e+=". Build with -sASSERTIONS for more info.";var t=new WebAssembly.RuntimeError(e);throw s(t),t}var V,G;function z(e){return e.startsWith("data:application/octet-stream;base64,")}function H(e){try{if(e==V&&u)return new Uint8Array(u);if(r)return r(e);throw"both async and sync fetching of the wasm failed"}catch(e){k(e)}}function W(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function X(e){for(;e.length>0;)e.shift()(n)}n.locateFile?z(V="HavokPhysics.wasm")||(G=V,V=n.locateFile?n.locateFile(G,h):h+G):V=new URL(i(641),i.b).toString();var Q={};function Y(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function K(e){return this.fromWireType(E[e>>2])}var j={},$={},q={},Z=48,J=57;function ee(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=Z&&t<=J?"_"+e:e}function te(e,t){return e=ee(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function ie(e,t){var i=te(t,(function(e){this.name=t,this.message=e;var i=new Error(e).stack;void 0!==i&&(this.stack=this.toString()+"\n"+i.replace(/^Error(:[^\n]*)?\n/,""))}));return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},i}var se=void 0;function ne(e){throw new se(e)}function re(e,t,i){function s(t){var s=i(t);s.length!==e.length&&ne("Mismatched type converter count");for(var n=0;n<e.length;++n)de(e[n],s[n])}e.forEach((function(e){q[e]=t}));var n=new Array(t.length),r=[],o=0;t.forEach(((e,t)=>{$.hasOwnProperty(e)?n[t]=$[e]:(r.push(e),j.hasOwnProperty(e)||(j[e]=[]),j[e].push((()=>{n[t]=$[e],++o===r.length&&s(n)})))})),0===r.length&&s(n)}function oe(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}var ae=void 0;function le(e){for(var t="",i=e;v[i];)t+=ae[v[i++]];return t}var he=void 0;function ce(e){throw new he(e)}function de(e,t,i={}){if(!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var s=t.name;if(e||ce('type "'+s+'" must have a positive integer typeid pointer'),$.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;ce("Cannot register type '"+s+"' twice")}if($[e]=t,delete q[e],j.hasOwnProperty(e)){var n=j[e];delete j[e],n.forEach((e=>e()))}}function ue(e,t,i){switch(t){case 0:return i?function(e){return g[e]}:function(e){return v[e]};case 1:return i?function(e){return T[e>>1]}:function(e){return b[e>>1]};case 2:return i?function(e){return E[e>>2]}:function(e){return S[e>>2]};case 3:return i?function(e){return C[e>>3]}:function(e){return y[e>>3]};default:throw new TypeError("Unknown integer type: "+e)}}function _e(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var fe=[],pe=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function me(e){e>4&&0==--pe[e].refcount&&(pe[e]=void 0,fe.push(e))}var ge=e=>(e||ce("Cannot use deleted val. handle = "+e),pe[e].value);function ve(e,t,i){n.hasOwnProperty(e)?((void 0===i||void 0!==n[e].overloadTable&&void 0!==n[e].overloadTable[i])&&ce("Cannot register public name '"+e+"' twice"),function(e,t,i){if(void 0===e[t].overloadTable){var s=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||ce("Function '"+i+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[s.argCount]=s}}(n,e,e),n.hasOwnProperty(i)&&ce("Cannot register multiple overloads of a function with the same number of arguments ("+i+")!"),n[e].overloadTable[i]=t):(n[e]=t,void 0!==i&&(n[e].numArguments=i))}function Te(e,t,i){switch(t){case 0:return function(e){var t=i?g:v;return this.fromWireType(t[e])};case 1:return function(e){var t=i?T:b;return this.fromWireType(t[e>>1])};case 2:return function(e){var t=i?E:S;return this.fromWireType(t[e>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function be(e){var t=Xe(e),i=le(t);return We(t),i}function Ee(e,t){var i=$[e];return void 0===i&&ce(t+" has unknown type "+be(e)),i}function Se(e,t){switch(t){case 2:return function(e){return this.fromWireType(x[e>>2])};case 3:return function(e){return this.fromWireType(A[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function xe(e,t){if(!(e instanceof Function))throw new TypeError("new_ called with constructor type "+typeof e+" which is not a function");var i=te(e.name||"unknownFunctionName",(function(){}));i.prototype=e.prototype;var s=new i,n=e.apply(s,t);return n instanceof Object?n:s}var Ce=[];function ye(e,t){e=le(e);var i,s,n=((s=Ce[i=t])||(i>=Ce.length&&(Ce.length=i+1),Ce[i]=s=O.get(i)),s);return"function"!=typeof n&&ce("unknown function pointer with signature "+e+": "+t),n}var Ae=void 0,Re="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function Ie(e,t){for(var i=e,s=i>>1,n=s+t/2;!(s>=n)&&b[s];)++s;if((i=s<<1)-e>32&&Re)return Re.decode(v.subarray(e,i));for(var r="",o=0;!(o>=t/2);++o){var a=T[e+2*o>>1];if(0==a)break;r+=String.fromCharCode(a)}return r}function Pe(e,t,i){if(void 0===i&&(i=2147483647),i<2)return 0;for(var s=t,n=(i-=2)<2*e.length?i/2:e.length,r=0;r<n;++r){var o=e.charCodeAt(r);T[t>>1]=o,t+=2}return T[t>>1]=0,t-s}function Me(e){return 2*e.length}function Oe(e,t){for(var i=0,s="";!(i>=t/4);){var n=E[e+4*i>>2];if(0==n)break;if(++i,n>=65536){var r=n-65536;s+=String.fromCharCode(55296|r>>10,56320|1023&r)}else s+=String.fromCharCode(n)}return s}function De(e,t,i){if(void 0===i&&(i=2147483647),i<4)return 0;for(var s=t,n=s+i-4,r=0;r<e.length;++r){var o=e.charCodeAt(r);if(o>=55296&&o<=57343&&(o=65536+((1023&o)<<10)|1023&e.charCodeAt(++r)),E[t>>2]=o,(t+=4)+4>n)break}return E[t>>2]=0,t-s}function Ne(e){for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s>=55296&&s<=57343&&++i,t+=4}return t}var Fe,Le={},we=[],Be=[];function Ue(e){try{return _.grow(e-m.byteLength+65535>>>16),M(_.buffer),1}catch(e){}}Fe=()=>performance.now();var ke=[null,[],[]];function Ve(e,t){var i=ke[e];0===t||10===t?((1===e?c:d)(P(i,0)),i.length=0):i.push(t)}se=n.InternalError=ie(Error,"InternalError"),function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);ae=e}(),he=n.BindingError=ie(Error,"BindingError"),n.count_emval_handles=function(){for(var e=0,t=5;t<pe.length;++t)void 0!==pe[t]&&++e;return e},n.get_first_emval=function(){for(var e=5;e<pe.length;++e)if(void 0!==pe[e])return pe[e];return null},Ae=n.UnboundTypeError=ie(Error,"UnboundTypeError");var Ge,ze={_embind_finalize_value_array:function(e){var t=Q[e];delete Q[e];var i=t.elements,s=i.length,n=i.map((function(e){return e.getterReturnType})).concat(i.map((function(e){return e.setterArgumentType}))),r=t.rawConstructor,o=t.rawDestructor;re([e],n,(function(e){return i.forEach(((t,i)=>{var n=e[i],r=t.getter,o=t.getterContext,a=e[i+s],l=t.setter,h=t.setterContext;t.read=e=>n.fromWireType(r(o,e)),t.write=(e,t)=>{var i=[];l(h,e,a.toWireType(i,t)),Y(i)}})),[{name:t.name,fromWireType:function(e){for(var t=new Array(s),n=0;n<s;++n)t[n]=i[n].read(e);return o(e),t},toWireType:function(e,n){if(s!==n.length)throw new TypeError("Incorrect number of tuple elements for "+t.name+": expected="+s+", actual="+n.length);for(var a=r(),l=0;l<s;++l)i[l].write(a,n[l]);return null!==e&&e.push(o,a),a},argPackAdvance:8,readValueFromPointer:K,destructorFunction:o}]}))},_embind_register_bigint:function(e,t,i,s,n){t=le(t);var r=_e(i),o=-1!=t.indexOf("u");o&&(n=(1n<<64n)-1n),de(e,{name:t,fromWireType:function(e){return e},toWireType:function(e,i){if("bigint"!=typeof i&&"number"!=typeof i)throw new TypeError('Cannot convert "'+oe(i)+'" to '+this.name);if(i<s||i>n)throw new TypeError('Passing a number "'+oe(i)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+s+", "+n+"]!");return i},argPackAdvance:8,readValueFromPointer:ue(t,r,!o),destructorFunction:null})},_embind_register_bool:function(e,t,i,s,n){var r=_e(i);de(e,{name:t=le(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?s:n},argPackAdvance:8,readValueFromPointer:function(e){var s;if(1===i)s=g;else if(2===i)s=T;else{if(4!==i)throw new TypeError("Unknown boolean type size: "+t);s=E}return this.fromWireType(s[e>>r])},destructorFunction:null})},_embind_register_emval:function(e,t){de(e,{name:t=le(t),fromWireType:function(e){var t=ge(e);return me(e),t},toWireType:function(e,t){return(e=>{switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=fe.length?fe.pop():pe.length;return pe[t]={refcount:1,value:e},t}})(t)},argPackAdvance:8,readValueFromPointer:K,destructorFunction:null})},_embind_register_enum:function(e,t,i,s){var n=_e(i);function r(){}t=le(t),r.values={},de(e,{name:t,constructor:r,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:Te(t,n,s),destructorFunction:null}),ve(t,r)},_embind_register_enum_value:function(e,t,i){var s=Ee(e,"enum");t=le(t);var n=s.constructor,r=Object.create(s.constructor.prototype,{value:{value:i},constructor:{value:te(s.name+"_"+t,(function(){}))}});n.values[i]=r,n[t]=r},_embind_register_float:function(e,t,i){var s=_e(i);de(e,{name:t=le(t),fromWireType:function(e){return e},toWireType:function(e,t){return t},argPackAdvance:8,readValueFromPointer:Se(t,s),destructorFunction:null})},_embind_register_function:function(e,t,i,s,r,o){var a=function(e,t){for(var i=[],s=0;s<e;s++)i.push(S[t+4*s>>2]);return i}(t,i);e=le(e),r=ye(s,r),ve(e,(function(){!function(e,t){var i=[],s={};throw t.forEach((function e(t){s[t]||$[t]||(q[t]?q[t].forEach(e):(i.push(t),s[t]=!0))})),new Ae(e+": "+i.map(be).join([", "]))}("Cannot call "+e+" due to unbound types",a)}),t-1),re([],a,(function(i){var s=[i[0],null].concat(i.slice(1));return function(e,t,i){n.hasOwnProperty(e)||ne("Replacing nonexistant public symbol"),void 0!==n[e].overloadTable&&void 0!==i?n[e].overloadTable[i]=t:(n[e]=t,n[e].argCount=i)}(e,function(e,t,i,s,n){var r=t.length;r<2&&ce("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var o=null!==t[1]&&!1,a=!1,l=1;l<t.length;++l)if(null!==t[l]&&void 0===t[l].destructorFunction){a=!0;break}var h="void"!==t[0].name,c="",d="";for(l=0;l<r-2;++l)c+=(0!==l?", ":"")+"arg"+l,d+=(0!==l?", ":"")+"arg"+l+"Wired";var u="return function "+ee(e)+"("+c+") {\nif (arguments.length !== "+(r-2)+") {\nthrowBindingError('function "+e+" called with ' + arguments.length + ' arguments, expected "+(r-2)+" args!');\n}\n";a&&(u+="var destructors = [];\n");var _=a?"destructors":"null",f=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],p=[ce,s,n,Y,t[0],t[1]];for(o&&(u+="var thisWired = classParam.toWireType("+_+", this);\n"),l=0;l<r-2;++l)u+="var arg"+l+"Wired = argType"+l+".toWireType("+_+", arg"+l+"); // "+t[l+2].name+"\n",f.push("argType"+l),p.push(t[l+2]);if(o&&(d="thisWired"+(d.length>0?", ":"")+d),u+=(h?"var rv = ":"")+"invoker(fn"+(d.length>0?", ":"")+d+");\n",a)u+="runDestructors(destructors);\n";else for(l=o?1:2;l<t.length;++l){var m=1===l?"thisWired":"arg"+(l-2)+"Wired";null!==t[l].destructorFunction&&(u+=m+"_dtor("+m+"); // "+t[l].name+"\n",f.push(m+"_dtor"),p.push(t[l].destructorFunction))}return h&&(u+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),u+="}\n",f.push(u),xe(Function,f).apply(null,p)}(e,s,0,r,o),t-1),[]}))},_embind_register_integer:function(e,t,i,s,n){t=le(t),-1===n&&(n=4294967295);var r=_e(i),o=e=>e;if(0===s){var a=32-8*i;o=e=>e<<a>>>a}var l=t.includes("unsigned");de(e,{name:t,fromWireType:o,toWireType:l?function(e,t){return this.name,t>>>0}:function(e,t){return this.name,t},argPackAdvance:8,readValueFromPointer:ue(t,r,0!==s),destructorFunction:null})},_embind_register_memory_view:function(e,t,i){var s=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,BigInt64Array,BigUint64Array][t];function n(e){var t=S,i=t[e>>=2],n=t[e+1];return new s(m,n,i)}de(e,{name:i=le(i),fromWireType:n,argPackAdvance:8,readValueFromPointer:n},{ignoreDuplicateRegistrations:!0})},_embind_register_std_string:function(e,t){var i="std::string"===(t=le(t));de(e,{name:t,fromWireType:function(e){var t,s,n,r=S[e>>2],o=e+4;if(i)for(var a=o,l=0;l<=r;++l){var h=o+l;if(l==r||0==v[h]){var c=(n=h-a,(s=a)?P(v,s,n):"");void 0===t?t=c:(t+=String.fromCharCode(0),t+=c),a=h+1}}else{var d=new Array(r);for(l=0;l<r;++l)d[l]=String.fromCharCode(v[o+l]);t=d.join("")}return We(e),t},toWireType:function(e,t){var s;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var n="string"==typeof t;n||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||ce("Cannot pass non-string to std::string"),s=i&&n?function(e){for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s<=127?t++:s<=2047?t+=2:s>=55296&&s<=57343?(t+=4,++i):t+=3}return t}(t):t.length;var r=He(4+s+1),o=r+4;if(S[r>>2]=s,i&&n)!function(e,t,i,s){if(!(s>0))return 0;for(var n=i+s-1,r=0;r<e.length;++r){var o=e.charCodeAt(r);if(o>=55296&&o<=57343&&(o=65536+((1023&o)<<10)|1023&e.charCodeAt(++r)),o<=127){if(i>=n)break;t[i++]=o}else if(o<=2047){if(i+1>=n)break;t[i++]=192|o>>6,t[i++]=128|63&o}else if(o<=65535){if(i+2>=n)break;t[i++]=224|o>>12,t[i++]=128|o>>6&63,t[i++]=128|63&o}else{if(i+3>=n)break;t[i++]=240|o>>18,t[i++]=128|o>>12&63,t[i++]=128|o>>6&63,t[i++]=128|63&o}}t[i]=0}(t,v,o,s+1);else if(n)for(var a=0;a<s;++a){var l=t.charCodeAt(a);l>255&&(We(o),ce("String has UTF-16 code units that do not fit in 8 bits")),v[o+a]=l}else for(a=0;a<s;++a)v[o+a]=t[a];return null!==e&&e.push(We,r),r},argPackAdvance:8,readValueFromPointer:K,destructorFunction:function(e){We(e)}})},_embind_register_std_wstring:function(e,t,i){var s,n,r,o,a;i=le(i),2===t?(s=Ie,n=Pe,o=Me,r=()=>b,a=1):4===t&&(s=Oe,n=De,o=Ne,r=()=>S,a=2),de(e,{name:i,fromWireType:function(e){for(var i,n=S[e>>2],o=r(),l=e+4,h=0;h<=n;++h){var c=e+4+h*t;if(h==n||0==o[c>>a]){var d=s(l,c-l);void 0===i?i=d:(i+=String.fromCharCode(0),i+=d),l=c+t}}return We(e),i},toWireType:function(e,s){"string"!=typeof s&&ce("Cannot pass non-string to C++ string type "+i);var r=o(s),l=He(4+r+t);return S[l>>2]=r>>a,n(s,l+4,r+t),null!==e&&e.push(We,l),l},argPackAdvance:8,readValueFromPointer:K,destructorFunction:function(e){We(e)}})},_embind_register_value_array:function(e,t,i,s,n,r){Q[e]={name:le(t),rawConstructor:ye(i,s),rawDestructor:ye(n,r),elements:[]}},_embind_register_value_array_element:function(e,t,i,s,n,r,o,a,l){Q[e].elements.push({getterReturnType:t,getter:ye(i,s),getterContext:n,setterArgumentType:r,setter:ye(o,a),setterContext:l})},_embind_register_void:function(e,t){de(e,{isVoid:!0,name:t=le(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},_emscripten_get_now_is_monotonic:function(){return!0},_emval_call_void_method:function(e,t,i,s){var n,r;(e=we[e])(t=ge(t),i=void 0===(r=Le[n=i])?le(n):r,null,s)},_emval_decref:me,_emval_get_method_caller:function(e,t){var i=function(e,t){for(var i=new Array(e),s=0;s<e;++s)i[s]=Ee(S[t+4*s>>2],"parameter "+s);return i}(e,t),s=i[0],n=s.name+"_$"+i.slice(1).map((function(e){return e.name})).join("_")+"$",r=Be[n];if(void 0!==r)return r;for(var o=["retType"],a=[s],l="",h=0;h<e-1;++h)l+=(0!==h?", ":"")+"arg"+h,o.push("argType"+h),a.push(i[1+h]);var c,d,u="return function "+ee("methodCaller_"+n)+"(handle, name, destructors, args) {\n",_=0;for(h=0;h<e-1;++h)u+="    var arg"+h+" = argType"+h+".readValueFromPointer(args"+(_?"+"+_:"")+");\n",_+=i[h+1].argPackAdvance;for(u+="    var rv = handle[name]("+l+");\n",h=0;h<e-1;++h)i[h+1].deleteObject&&(u+="    argType"+h+".deleteObject(arg"+h+");\n");return s.isVoid||(u+="    return retType.toWireType(destructors, rv);\n"),u+="};\n",o.push(u),c=xe(Function,o).apply(null,a),d=we.length,we.push(c),r=d,Be[n]=r,r},abort:function(){k("")},emscripten_date_now:function(){return Date.now()},emscripten_get_heap_max:function(){return 2147483648},emscripten_get_now:Fe,emscripten_memcpy_big:function(e,t,i){v.copyWithin(e,t,t+i)},emscripten_resize_heap:function(e){var t,i=v.length,s=2147483648;if((e>>>=0)>s)return!1;for(var n=1;n<=4;n*=2){var r=i*(1+.2/n);if(r=Math.min(r,e+100663296),Ue(Math.min(s,(t=Math.max(e,r))+(65536-t%65536)%65536)))return!0}return!1},fd_write:function(e,t,i,s){for(var n=0,r=0;r<i;r++){var o=S[t>>2],a=S[t+4>>2];t+=8;for(var l=0;l<a;l++)Ve(e,v[o+l]);n+=a}return S[s>>2]=n,0}},He=(function(){var e={env:ze,wasi_snapshot_preview1:ze};function t(e,t){var i,s=e.exports;n.asm=s,M((_=n.asm.memory).buffer),O=n.asm.__indirect_function_table,i=n.asm.__wasm_call_ctors,N.unshift(i),function(e){if(w--,n.monitorRunDependencies&&n.monitorRunDependencies(w),0==w&&(null!==B&&(clearInterval(B),B=null),U)){var t=U;U=null,t()}}()}function i(e){t(e.instance)}function r(t){return(u||"function"!=typeof fetch?Promise.resolve().then((function(){return H(V)})):fetch(V,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+V+"'";return e.arrayBuffer()})).catch((function(){return H(V)}))).then((function(t){return WebAssembly.instantiate(t,e)})).then((function(e){return e})).then(t,(function(e){d("failed to asynchronously prepare wasm: "+e),k(e)}))}if(w++,n.monitorRunDependencies&&n.monitorRunDependencies(w),n.instantiateWasm)try{return n.instantiateWasm(e,t)}catch(e){d("Module.instantiateWasm callback failed with error: "+e),s(e)}(u||"function"!=typeof WebAssembly.instantiateStreaming||z(V)||"function"!=typeof fetch?r(i):fetch(V,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(i,(function(e){return d("wasm streaming compile failed: "+e),d("falling back to ArrayBuffer instantiation"),r(i)}))}))).catch(s)}(),n.___wasm_call_ctors=function(){return(n.___wasm_call_ctors=n.asm.__wasm_call_ctors).apply(null,arguments)},n._HP_GetStatistics=function(){return(n._HP_GetStatistics=n.asm.HP_GetStatistics).apply(null,arguments)},n._HP_Shape_CreateSphere=function(){return(n._HP_Shape_CreateSphere=n.asm.HP_Shape_CreateSphere).apply(null,arguments)},n._HP_Shape_CreateCapsule=function(){return(n._HP_Shape_CreateCapsule=n.asm.HP_Shape_CreateCapsule).apply(null,arguments)},n._HP_Shape_CreateCylinder=function(){return(n._HP_Shape_CreateCylinder=n.asm.HP_Shape_CreateCylinder).apply(null,arguments)},n._HP_Shape_CreateBox=function(){return(n._HP_Shape_CreateBox=n.asm.HP_Shape_CreateBox).apply(null,arguments)},n._HP_Shape_CreateConvexHull=function(){return(n._HP_Shape_CreateConvexHull=n.asm.HP_Shape_CreateConvexHull).apply(null,arguments)},n._HP_Shape_CreateMesh=function(){return(n._HP_Shape_CreateMesh=n.asm.HP_Shape_CreateMesh).apply(null,arguments)},n._HP_Shape_CreateHeightField=function(){return(n._HP_Shape_CreateHeightField=n.asm.HP_Shape_CreateHeightField).apply(null,arguments)},n._HP_Shape_CreateContainer=function(){return(n._HP_Shape_CreateContainer=n.asm.HP_Shape_CreateContainer).apply(null,arguments)},n._HP_Shape_Release=function(){return(n._HP_Shape_Release=n.asm.HP_Shape_Release).apply(null,arguments)},n._HP_Shape_GetType=function(){return(n._HP_Shape_GetType=n.asm.HP_Shape_GetType).apply(null,arguments)},n._HP_Shape_AddChild=function(){return(n._HP_Shape_AddChild=n.asm.HP_Shape_AddChild).apply(null,arguments)},n._HP_Shape_RemoveChild=function(){return(n._HP_Shape_RemoveChild=n.asm.HP_Shape_RemoveChild).apply(null,arguments)},n._HP_Shape_GetNumChildren=function(){return(n._HP_Shape_GetNumChildren=n.asm.HP_Shape_GetNumChildren).apply(null,arguments)},n._HP_Shape_SetChildQSTransform=function(){return(n._HP_Shape_SetChildQSTransform=n.asm.HP_Shape_SetChildQSTransform).apply(null,arguments)},n._HP_Shape_GetChildQSTransform=function(){return(n._HP_Shape_GetChildQSTransform=n.asm.HP_Shape_GetChildQSTransform).apply(null,arguments)},n._HP_Shape_SetFilterInfo=function(){return(n._HP_Shape_SetFilterInfo=n.asm.HP_Shape_SetFilterInfo).apply(null,arguments)},n._HP_Shape_GetFilterInfo=function(){return(n._HP_Shape_GetFilterInfo=n.asm.HP_Shape_GetFilterInfo).apply(null,arguments)},n._HP_Shape_SetMaterial=function(){return(n._HP_Shape_SetMaterial=n.asm.HP_Shape_SetMaterial).apply(null,arguments)},n._HP_Shape_GetMaterial=function(){return(n._HP_Shape_GetMaterial=n.asm.HP_Shape_GetMaterial).apply(null,arguments)},n._HP_Shape_SetDensity=function(){return(n._HP_Shape_SetDensity=n.asm.HP_Shape_SetDensity).apply(null,arguments)},n._HP_Shape_GetDensity=function(){return(n._HP_Shape_GetDensity=n.asm.HP_Shape_GetDensity).apply(null,arguments)},n._HP_Shape_CastRay=function(){return(n._HP_Shape_CastRay=n.asm.HP_Shape_CastRay).apply(null,arguments)},n._HP_Shape_BuildMassProperties=function(){return(n._HP_Shape_BuildMassProperties=n.asm.HP_Shape_BuildMassProperties).apply(null,arguments)},n._HP_ShapePathIterator_GetNext=function(){return(n._HP_ShapePathIterator_GetNext=n.asm.HP_ShapePathIterator_GetNext).apply(null,arguments)},n._HP_Shape_SetTrigger=function(){return(n._HP_Shape_SetTrigger=n.asm.HP_Shape_SetTrigger).apply(null,arguments)},n._HP_Shape_CreateDebugDisplayGeometry=function(){return(n._HP_Shape_CreateDebugDisplayGeometry=n.asm.HP_Shape_CreateDebugDisplayGeometry).apply(null,arguments)},n._HP_DebugGeometry_GetInfo=function(){return(n._HP_DebugGeometry_GetInfo=n.asm.HP_DebugGeometry_GetInfo).apply(null,arguments)},n._HP_DebugGeometry_Release=function(){return(n._HP_DebugGeometry_Release=n.asm.HP_DebugGeometry_Release).apply(null,arguments)},n._HP_Body_Create=function(){return(n._HP_Body_Create=n.asm.HP_Body_Create).apply(null,arguments)},n._HP_Body_Release=function(){return(n._HP_Body_Release=n.asm.HP_Body_Release).apply(null,arguments)},n._HP_Body_SetShape=function(){return(n._HP_Body_SetShape=n.asm.HP_Body_SetShape).apply(null,arguments)},n._HP_Body_GetShape=function(){return(n._HP_Body_GetShape=n.asm.HP_Body_GetShape).apply(null,arguments)},n._HP_Body_SetMotionType=function(){return(n._HP_Body_SetMotionType=n.asm.HP_Body_SetMotionType).apply(null,arguments)},n._HP_Body_GetMotionType=function(){return(n._HP_Body_GetMotionType=n.asm.HP_Body_GetMotionType).apply(null,arguments)},n._HP_Body_SetEventMask=function(){return(n._HP_Body_SetEventMask=n.asm.HP_Body_SetEventMask).apply(null,arguments)},n._HP_Body_GetEventMask=function(){return(n._HP_Body_GetEventMask=n.asm.HP_Body_GetEventMask).apply(null,arguments)},n._HP_Body_SetMassProperties=function(){return(n._HP_Body_SetMassProperties=n.asm.HP_Body_SetMassProperties).apply(null,arguments)},n._HP_Body_GetMassProperties=function(){return(n._HP_Body_GetMassProperties=n.asm.HP_Body_GetMassProperties).apply(null,arguments)},n._HP_Body_SetLinearDamping=function(){return(n._HP_Body_SetLinearDamping=n.asm.HP_Body_SetLinearDamping).apply(null,arguments)},n._HP_Body_GetLinearDamping=function(){return(n._HP_Body_GetLinearDamping=n.asm.HP_Body_GetLinearDamping).apply(null,arguments)},n._HP_Body_SetAngularDamping=function(){return(n._HP_Body_SetAngularDamping=n.asm.HP_Body_SetAngularDamping).apply(null,arguments)},n._HP_Body_GetAngularDamping=function(){return(n._HP_Body_GetAngularDamping=n.asm.HP_Body_GetAngularDamping).apply(null,arguments)},n._HP_Body_SetGravityFactor=function(){return(n._HP_Body_SetGravityFactor=n.asm.HP_Body_SetGravityFactor).apply(null,arguments)},n._HP_Body_GetGravityFactor=function(){return(n._HP_Body_GetGravityFactor=n.asm.HP_Body_GetGravityFactor).apply(null,arguments)},n._HP_Body_GetWorld=function(){return(n._HP_Body_GetWorld=n.asm.HP_Body_GetWorld).apply(null,arguments)},n._HP_Body_SetPosition=function(){return(n._HP_Body_SetPosition=n.asm.HP_Body_SetPosition).apply(null,arguments)},n._HP_Body_GetPosition=function(){return(n._HP_Body_GetPosition=n.asm.HP_Body_GetPosition).apply(null,arguments)},n._HP_Body_SetOrientation=function(){return(n._HP_Body_SetOrientation=n.asm.HP_Body_SetOrientation).apply(null,arguments)},n._HP_Body_GetOrientation=function(){return(n._HP_Body_GetOrientation=n.asm.HP_Body_GetOrientation).apply(null,arguments)},n._HP_Body_SetQTransform=function(){return(n._HP_Body_SetQTransform=n.asm.HP_Body_SetQTransform).apply(null,arguments)},n._HP_Body_GetWorldTransformOffset=function(){return(n._HP_Body_GetWorldTransformOffset=n.asm.HP_Body_GetWorldTransformOffset).apply(null,arguments)},n._HP_Body_GetQTransform=function(){return(n._HP_Body_GetQTransform=n.asm.HP_Body_GetQTransform).apply(null,arguments)},n._HP_Body_SetLinearVelocity=function(){return(n._HP_Body_SetLinearVelocity=n.asm.HP_Body_SetLinearVelocity).apply(null,arguments)},n._HP_Body_GetLinearVelocity=function(){return(n._HP_Body_GetLinearVelocity=n.asm.HP_Body_GetLinearVelocity).apply(null,arguments)},n._HP_Body_SetAngularVelocity=function(){return(n._HP_Body_SetAngularVelocity=n.asm.HP_Body_SetAngularVelocity).apply(null,arguments)},n._HP_Body_GetAngularVelocity=function(){return(n._HP_Body_GetAngularVelocity=n.asm.HP_Body_GetAngularVelocity).apply(null,arguments)},n._HP_Body_ApplyImpulse=function(){return(n._HP_Body_ApplyImpulse=n.asm.HP_Body_ApplyImpulse).apply(null,arguments)},n._HP_Body_SetTargetQTransform=function(){return(n._HP_Body_SetTargetQTransform=n.asm.HP_Body_SetTargetQTransform).apply(null,arguments)},n._HP_Body_SetActivationState=function(){return(n._HP_Body_SetActivationState=n.asm.HP_Body_SetActivationState).apply(null,arguments)},n._HP_Body_GetActivationState=function(){return(n._HP_Body_GetActivationState=n.asm.HP_Body_GetActivationState).apply(null,arguments)},n._HP_Body_SetActivationControl=function(){return(n._HP_Body_SetActivationControl=n.asm.HP_Body_SetActivationControl).apply(null,arguments)},n._HP_Body_SetActivationPriority=function(){return(n._HP_Body_SetActivationPriority=n.asm.HP_Body_SetActivationPriority).apply(null,arguments)},n._HP_Constraint_Create=function(){return(n._HP_Constraint_Create=n.asm.HP_Constraint_Create).apply(null,arguments)},n._HP_Constraint_Release=function(){return(n._HP_Constraint_Release=n.asm.HP_Constraint_Release).apply(null,arguments)},n._HP_Constraint_SetParentBody=function(){return(n._HP_Constraint_SetParentBody=n.asm.HP_Constraint_SetParentBody).apply(null,arguments)},n._HP_Constraint_GetParentBody=function(){return(n._HP_Constraint_GetParentBody=n.asm.HP_Constraint_GetParentBody).apply(null,arguments)},n._HP_Constraint_SetChildBody=function(){return(n._HP_Constraint_SetChildBody=n.asm.HP_Constraint_SetChildBody).apply(null,arguments)},n._HP_Constraint_GetChildBody=function(){return(n._HP_Constraint_GetChildBody=n.asm.HP_Constraint_GetChildBody).apply(null,arguments)},n._HP_Constraint_SetAnchorInParent=function(){return(n._HP_Constraint_SetAnchorInParent=n.asm.HP_Constraint_SetAnchorInParent).apply(null,arguments)},n._HP_Constraint_SetAnchorInChild=function(){return(n._HP_Constraint_SetAnchorInChild=n.asm.HP_Constraint_SetAnchorInChild).apply(null,arguments)},n._HP_Constraint_SetCollisionsEnabled=function(){return(n._HP_Constraint_SetCollisionsEnabled=n.asm.HP_Constraint_SetCollisionsEnabled).apply(null,arguments)},n._HP_Constraint_GetCollisionsEnabled=function(){return(n._HP_Constraint_GetCollisionsEnabled=n.asm.HP_Constraint_GetCollisionsEnabled).apply(null,arguments)},n._HP_Constraint_SetEnabled=function(){return(n._HP_Constraint_SetEnabled=n.asm.HP_Constraint_SetEnabled).apply(null,arguments)},n._HP_Constraint_GetEnabled=function(){return(n._HP_Constraint_GetEnabled=n.asm.HP_Constraint_GetEnabled).apply(null,arguments)},n._HP_Constraint_SetAxisMinLimit=function(){return(n._HP_Constraint_SetAxisMinLimit=n.asm.HP_Constraint_SetAxisMinLimit).apply(null,arguments)},n._HP_Constraint_GetAxisMinLimit=function(){return(n._HP_Constraint_GetAxisMinLimit=n.asm.HP_Constraint_GetAxisMinLimit).apply(null,arguments)},n._HP_Constraint_SetAxisMaxLimit=function(){return(n._HP_Constraint_SetAxisMaxLimit=n.asm.HP_Constraint_SetAxisMaxLimit).apply(null,arguments)},n._HP_Constraint_GetAxisMaxLimit=function(){return(n._HP_Constraint_GetAxisMaxLimit=n.asm.HP_Constraint_GetAxisMaxLimit).apply(null,arguments)},n._HP_Constraint_GetAxisMode=function(){return(n._HP_Constraint_GetAxisMode=n.asm.HP_Constraint_GetAxisMode).apply(null,arguments)},n._HP_Constraint_SetAxisMode=function(){return(n._HP_Constraint_SetAxisMode=n.asm.HP_Constraint_SetAxisMode).apply(null,arguments)},n._HP_Constraint_SetAxisFriction=function(){return(n._HP_Constraint_SetAxisFriction=n.asm.HP_Constraint_SetAxisFriction).apply(null,arguments)},n._HP_Constraint_GetAxisFriction=function(){return(n._HP_Constraint_GetAxisFriction=n.asm.HP_Constraint_GetAxisFriction).apply(null,arguments)},n._HP_Constraint_SetAxisMotorType=function(){return(n._HP_Constraint_SetAxisMotorType=n.asm.HP_Constraint_SetAxisMotorType).apply(null,arguments)},n._HP_Constraint_GetAxisMotorType=function(){return(n._HP_Constraint_GetAxisMotorType=n.asm.HP_Constraint_GetAxisMotorType).apply(null,arguments)},n._HP_Constraint_SetAxisMotorTarget=function(){return(n._HP_Constraint_SetAxisMotorTarget=n.asm.HP_Constraint_SetAxisMotorTarget).apply(null,arguments)},n._HP_Constraint_GetAxisMotorTarget=function(){return(n._HP_Constraint_GetAxisMotorTarget=n.asm.HP_Constraint_GetAxisMotorTarget).apply(null,arguments)},n._HP_Constraint_SetAxisMotorMaxForce=function(){return(n._HP_Constraint_SetAxisMotorMaxForce=n.asm.HP_Constraint_SetAxisMotorMaxForce).apply(null,arguments)},n._HP_Constraint_GetAxisMotorMaxForce=function(){return(n._HP_Constraint_GetAxisMotorMaxForce=n.asm.HP_Constraint_GetAxisMotorMaxForce).apply(null,arguments)},n._HP_Constraint_SetAxisStiffness=function(){return(n._HP_Constraint_SetAxisStiffness=n.asm.HP_Constraint_SetAxisStiffness).apply(null,arguments)},n._HP_Constraint_SetAxisDamping=function(){return(n._HP_Constraint_SetAxisDamping=n.asm.HP_Constraint_SetAxisDamping).apply(null,arguments)},n._HP_World_Create=function(){return(n._HP_World_Create=n.asm.HP_World_Create).apply(null,arguments)},n._HP_World_Release=function(){return(n._HP_World_Release=n.asm.HP_World_Release).apply(null,arguments)},n._HP_World_GetBodyBuffer=function(){return(n._HP_World_GetBodyBuffer=n.asm.HP_World_GetBodyBuffer).apply(null,arguments)},n._HP_World_SetGravity=function(){return(n._HP_World_SetGravity=n.asm.HP_World_SetGravity).apply(null,arguments)},n._HP_World_GetGravity=function(){return(n._HP_World_GetGravity=n.asm.HP_World_GetGravity).apply(null,arguments)},n._HP_World_AddBody=function(){return(n._HP_World_AddBody=n.asm.HP_World_AddBody).apply(null,arguments)},n._HP_World_RemoveBody=function(){return(n._HP_World_RemoveBody=n.asm.HP_World_RemoveBody).apply(null,arguments)},n._HP_World_GetNumBodies=function(){return(n._HP_World_GetNumBodies=n.asm.HP_World_GetNumBodies).apply(null,arguments)},n._HP_World_CastRayWithCollector=function(){return(n._HP_World_CastRayWithCollector=n.asm.HP_World_CastRayWithCollector).apply(null,arguments)},n._HP_World_Step=function(){return(n._HP_World_Step=n.asm.HP_World_Step).apply(null,arguments)},n._HP_World_SetIdealStepTime=function(){return(n._HP_World_SetIdealStepTime=n.asm.HP_World_SetIdealStepTime).apply(null,arguments)},n._HP_World_GetNextCollisionEvent=function(){return(n._HP_World_GetNextCollisionEvent=n.asm.HP_World_GetNextCollisionEvent).apply(null,arguments)},n._HP_World_GetNextTriggerEvent=function(){return(n._HP_World_GetNextTriggerEvent=n.asm.HP_World_GetNextTriggerEvent).apply(null,arguments)},n._HP_QueryCollector_Create=function(){return(n._HP_QueryCollector_Create=n.asm.HP_QueryCollector_Create).apply(null,arguments)},n._HP_QueryCollector_Release=function(){return(n._HP_QueryCollector_Release=n.asm.HP_QueryCollector_Release).apply(null,arguments)},n._HP_QueryCollector_GetNumHits=function(){return(n._HP_QueryCollector_GetNumHits=n.asm.HP_QueryCollector_GetNumHits).apply(null,arguments)},n._HP_QueryCollector_GetCastRayResult=function(){return(n._HP_QueryCollector_GetCastRayResult=n.asm.HP_QueryCollector_GetCastRayResult).apply(null,arguments)},n._main=function(){return(n._main=n.asm.main).apply(null,arguments)},n._malloc=function(){return(He=n._malloc=n.asm.malloc).apply(null,arguments)}),We=n._free=function(){return(We=n._free=n.asm.free).apply(null,arguments)},Xe=(n._HP_Debug_StartRecordingStats=function(){return(n._HP_Debug_StartRecordingStats=n.asm.HP_Debug_StartRecordingStats).apply(null,arguments)},n._HP_Debug_StopRecordingStats=function(){return(n._HP_Debug_StopRecordingStats=n.asm.HP_Debug_StopRecordingStats).apply(null,arguments)},n.___errno_location=function(){return(n.___errno_location=n.asm.__errno_location).apply(null,arguments)},n._htons=function(){return(n._htons=n.asm.htons).apply(null,arguments)},n._ntohs=function(){return(n._ntohs=n.asm.ntohs).apply(null,arguments)},n.___getTypeName=function(){return(Xe=n.___getTypeName=n.asm.__getTypeName).apply(null,arguments)});function Qe(e){var t,i,s=n._main;try{var r=s(0,0);return p=t=r,p=i=t,f||(n.onExit&&n.onExit(i),R=!0),l(i,new W(i)),r}catch(e){return function(e){if(e instanceof W||"unwind"==e)return p;l(1,e)}(e)}}function Ye(e){function i(){Ge||(Ge=!0,n.calledRun=!0,R||(X(N),X(F),t(n),n.onRuntimeInitialized&&n.onRuntimeInitialized(),Ke&&Qe(),function(){if(n.postRun)for("function"==typeof n.postRun&&(n.postRun=[n.postRun]);n.postRun.length;)e=n.postRun.shift(),L.unshift(e);var e;X(L)}()))}e=e||a,w>0||(function(){if(n.preRun)for("function"==typeof n.preRun&&(n.preRun=[n.preRun]);n.preRun.length;)e=n.preRun.shift(),D.unshift(e);var e;X(D)}(),w>0||(n.setStatus?(n.setStatus("Running..."),setTimeout((function(){setTimeout((function(){n.setStatus("")}),1),i()}),1)):i()))}if(n.__embind_initialize_bindings=function(){return(n.__embind_initialize_bindings=n.asm._embind_initialize_bindings).apply(null,arguments)},n._htonl=function(){return(n._htonl=n.asm.htonl).apply(null,arguments)},n._setThrew=function(){return(n._setThrew=n.asm.setThrew).apply(null,arguments)},n._saveSetjmp=function(){return(n._saveSetjmp=n.asm.saveSetjmp).apply(null,arguments)},n.stackSave=function(){return(n.stackSave=n.asm.stackSave).apply(null,arguments)},n.stackRestore=function(){return(n.stackRestore=n.asm.stackRestore).apply(null,arguments)},n.stackAlloc=function(){return(n.stackAlloc=n.asm.stackAlloc).apply(null,arguments)},U=function e(){Ge||Ye(),Ge||(U=e)},n.preInit)for("function"==typeof n.preInit&&(n.preInit=[n.preInit]);n.preInit.length>0;)n.preInit.pop()();var Ke=!0;return n.noInitialRun&&(Ke=!1),Ye(),e.ready});F.IncludesShadersStore.imageProcessingCompatibility="#ifdef IMAGEPROCESSINGPOSTPROCESS\ngl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));\n#endif\n";F.ShadersStore.shadowOnlyPixelShader="precision highp float;uniform vec4 vEyePosition;uniform float alpha;uniform vec3 shadowColor;varying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#include<helperFunctions>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(1.0,1.0,1.0);\n#endif\nvec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;float shadow=1.;float glossiness=0.;float aggShadow=0.;float numLights=0.;\n#include<lightFragment>[0..1]\nvec4 color=vec4(shadowColor,(1.0-clamp(shadow,0.,1.))*alpha);\n#include<logDepthFragment>\n#include<fogFragment>\ngl_FragColor=color;\n#include<imageProcessingCompatibility>\n#define CUSTOM_FRAGMENT_MAIN_END\n}";F.ShadersStore.shadowOnlyVertexShader="precision highp float;attribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<instancesDeclaration>\nuniform mat4 view;uniform mat4 viewProjection;\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<logDepthDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec4 worldPos=finalWorld*vec4(position,1.0);gl_Position=viewProjection*worldPos;vPositionW=vec3(worldPos);\n#ifdef NORMAL\nvNormalW=normalize(vec3(finalWorld*vec4(normal,0.0)));\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#if defined(POINTSIZE) && !defined(WEBGPU)\ngl_PointSize=pointSize;\n#endif\n#define CUSTOM_VERTEX_MAIN_END\n}\n";class M_ extends Wt{constructor(){super(),this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.LOGARITHMICDEPTH=!1,this.rebuild()}}class O_ extends Ms{constructor(e,t){super(e,t),this._needAlphaBlending=!0,this.shadowColor=Re.Black()}needAlphaBlending(){return this._needAlphaBlending}needAlphaTesting(){return!1}getAlphaTestTexture(){return null}get activeLight(){return this._activeLight}set activeLight(e){this._activeLight=e}_getFirstShadowLightForMesh(e){for(const t of e.lightSources)if(t.shadowEnabled)return t;return null}isReadyForSubMesh(e,t,i){var s;if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new M_);const n=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;const o=r.getEngine();if(this._activeLight)for(const t of e.lightSources)if(t.shadowEnabled){if(this._activeLight===t)break;const i=e.lightSources.indexOf(this._activeLight);-1!==i&&(e.lightSources.splice(i,1),e.lightSources.splice(0,0,this._activeLight));break}wi.PrepareDefinesForFrameBoundValues(r,o,this,n,!!i),wi.PrepareDefinesForMisc(e,r,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),n),n._needNormals=wi.PrepareDefinesForLights(r,e,n,!1,1);const a=null===(s=this._getFirstShadowLightForMesh(e))||void 0===s?void 0:s.getShadowGenerator();if(this._needAlphaBlending=!0,a&&a.getClassName&&"CascadedShadowGenerator"===a.getClassName()){const e=a;this._needAlphaBlending=!e.autoCalcDepthBounds}if(wi.PrepareDefinesForAttributes(e,n,!1,!0),n.isDirty){n.markAsProcessed(),r.resetCachedMaterial();const i=new is;n.FOG&&i.addFallback(1,"FOG"),wi.HandleFallbacksForShadows(n,i,1),n.NUM_BONE_INFLUENCERS>0&&i.addCPUSkinningFallback(0,e),n.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess;const s=[Oe.PositionKind];n.NORMAL&&s.push(Oe.NormalKind),wi.PrepareAttributesForBones(s,e,n,i),wi.PrepareAttributesForInstances(s,n);const a="shadowOnly",l=n.toString(),h=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","alpha","shadowColor","mBones","logarithmicDepthConstant"],c=[],d=[];Di(h),wi.PrepareUniformsAndSamplersList({uniformsNames:h,uniformBuffersNames:d,samplers:c,defines:n,maxSimultaneousLights:1}),t.setEffect(r.getEngine().createEffect(a,{attributes:s,uniformsNames:h,uniformBuffersNames:d,samplers:c,defines:l,fallbacks:i,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:1}},o),n,this._materialContext)}return!(!t.effect||!t.effect.isReady()||(n._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=!!i,0))}bindForSubMesh(e,t,i){const s=this.getScene(),n=i.materialDefines;if(!n)return;const r=i.effect;if(r){if(this._activeEffect=r,this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("viewProjection",s.getTransformMatrix()),wi.BindBonesParameters(t,this._activeEffect),this._mustRebind(s,r)&&(Fi(r,this,s),this.pointsCloud&&this._activeEffect.setFloat("pointSize",this.pointSize),this._activeEffect.setFloat("alpha",this.alpha),this._activeEffect.setColor3("shadowColor",this.shadowColor),this._useLogarithmicDepth&&wi.BindLogDepth(n,r,s),s.bindEyePosition(r)),s.lightsEnabled){wi.BindLights(s,t,this._activeEffect,n,1);const e=this._getFirstShadowLightForMesh(t);e&&(e._renderId=-1)}(s.fogEnabled&&t.applyFog&&s.fogMode!==Oi.FOGMODE_NONE||n.SHADOWCSM0)&&this._activeEffect.setMatrix("view",s.getViewMatrix()),wi.BindFogParameters(s,t,this._activeEffect),this._afterBind(t,this._activeEffect)}}clone(e){return qe.Clone((()=>new O_(e,this.getScene())),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.ShadowOnlyMaterial",e}getClassName(){return"ShadowOnlyMaterial"}static Parse(e,t,i){return qe.Parse((()=>new O_(e.name,t)),e,t,i)}}ue("BABYLON.ShadowOnlyMaterial",O_);class D_{trackType;name;frameNumbers;constructor(e,t,i,s,n){this.trackType=e,this.name=t,this.frameNumbers=void 0===s?new Uint32Array(i):new Uint32Array(s,n,i)}validate(){for(let e=1;e<this.frameNumbers.length;++e)if(this.frameNumbers[e-1]>=this.frameNumbers[e])return!1;return!0}get startFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[0]}get endFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[this.frameNumbers.length-1]}}class N_ extends D_{rotations;rotationInterpolations;constructor(e,t,i,s,n,r){super("bone",e,t,i,s),void 0===i?(this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)):(this.rotations=new Float32Array(i,n,4*t),this.rotationInterpolations=new Uint8Array(i,r,4*t))}}class F_ extends D_{positions;positionInterpolations;rotations;rotationInterpolations;constructor(e,t,i,s,n,r,o,a){super("moveableBone",e,t,i,s),void 0===i?(this.positions=new Float32Array(3*t),this.positionInterpolations=new Uint8Array(12*t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)):(this.positions=new Float32Array(i,n,3*t),this.positionInterpolations=new Uint8Array(i,r,12*t),this.rotations=new Float32Array(i,o,4*t),this.rotationInterpolations=new Uint8Array(i,a,4*t))}}class L_ extends D_{weights;constructor(e,t,i,s,n){super("morph",e,t,i,s),this.weights=void 0===i?new Float32Array(t):new Float32Array(i,n,t)}}class w_ extends D_{positions;positionInterpolations;rotations;rotationInterpolations;distances;distanceInterpolations;fovs;fovInterpolations;constructor(e,t,i,s,n,r,o,a,l,h,c){super("camera","cameraTrack",e,t,i),void 0===t?(this.positions=new Float32Array(3*e),this.positionInterpolations=new Uint8Array(12*e),this.rotations=new Float32Array(3*e),this.rotationInterpolations=new Uint8Array(4*e),this.distances=new Float32Array(e),this.distanceInterpolations=new Uint8Array(4*e),this.fovs=new Float32Array(e),this.fovInterpolations=new Uint8Array(4*e)):(this.positions=new Float32Array(t,s,3*e),this.positionInterpolations=new Uint8Array(t,n,12*e),this.rotations=new Float32Array(t,r,3*e),this.rotationInterpolations=new Uint8Array(t,o,4*e),this.distances=new Float32Array(t,a,e),this.distanceInterpolations=new Uint8Array(t,l,4*e),this.fovs=new Float32Array(t,h,e),this.fovInterpolations=new Uint8Array(t,c,4*e))}}class B_ extends D_{visibles;ikBoneNames;ikStates;constructor(e,t,i,s,n,r){if(super("property","propertyTrack",e,i,s),void 0===i){this.visibles=new Uint8Array(e),this.ikBoneNames=t,this.ikStates=new Array(t.length);for(let i=0;i<t.length;++i)this.ikStates[i]=new Uint8Array(e)}else{this.visibles=new Uint8Array(i,n,e),this.ikBoneNames=t,this.ikStates=new Array(t.length),void 0===r&&(r=new Array(t.length));for(let s=0;s<t.length;++s)this.ikStates[s]=new Uint8Array(i,r[s],e)}}}class U_{_scene;_loggingEnabled;log;warn;error;constructor(e){this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e}loadFromBuffer(e,t){const i=new qh(t);if(i.initializeTextDecoder("utf-8"),"BVMD"!==i.getDecoderString(4,!1))throw new _t("BVMD signature is not valid.");const s=[i.getInt8(),i.getInt8(),i.getInt8()];if(2!==s[0]||0!==s[1]||0!==s[2])throw new _t(`BVMD version ${s[0]}.${s[1]}.${s[2]} is not supported.`);const n=i.getUint32(),r=new Array(n);for(let e=0;e<n;++e){const s=i.getDecoderString(i.getUint32(),!0),n=i.getUint32(),o=i.getPaddedArrayOffset(4,n),a=i.getPaddedArrayOffset(4,4*n),l=i.getPaddedArrayOffset(1,4*n),h=r[e]=new N_(s,n,t,o,a,l);i.isDeviceLittleEndian||(i.swap32Array(h.frameNumbers),i.swap32Array(h.rotations))}const o=i.getUint32(),a=new Array(o);for(let e=0;e<o;++e){const s=i.getDecoderString(i.getUint32(),!0),n=i.getUint32(),r=i.getPaddedArrayOffset(4,n),o=i.getPaddedArrayOffset(4,3*n),l=i.getPaddedArrayOffset(1,12*n),h=i.getPaddedArrayOffset(4,4*n),c=i.getPaddedArrayOffset(1,4*n),d=a[e]=new F_(s,n,t,r,o,l,h,c);i.isDeviceLittleEndian||(i.swap32Array(d.frameNumbers),i.swap32Array(d.positions),i.swap32Array(d.rotations))}const l=i.getUint32(),h=new Array(l);for(let e=0;e<l;++e){const s=i.getDecoderString(i.getUint32(),!0),n=i.getUint32(),r=i.getPaddedArrayOffset(4,n),o=i.getPaddedArrayOffset(4,n),a=h[e]=new L_(s,n,t,r,o);i.isDeviceLittleEndian||(i.swap32Array(a.frameNumbers),i.swap32Array(a.weights))}const c=i.getUint32(),d=i.getUint32(),u=i.getPaddedArrayOffset(4,c),_=i.getPaddedArrayOffset(1,c),f=new Array(d),p=new Array(d);for(let e=0;e<d;++e)f[e]=i.getDecoderString(i.getUint32(),!0),p[e]=i.getPaddedArrayOffset(1,c);const m=new B_(c,f,t,u,_,p);i.isDeviceLittleEndian||i.swap32Array(m.frameNumbers);const g=i.getUint32(),v=i.getPaddedArrayOffset(4,g),T=i.getPaddedArrayOffset(4,3*g),b=i.getPaddedArrayOffset(1,12*g),E=i.getPaddedArrayOffset(4,3*g),S=i.getPaddedArrayOffset(1,4*g),x=i.getPaddedArrayOffset(4,g),C=i.getPaddedArrayOffset(1,4*g),y=i.getPaddedArrayOffset(4,g),A=i.getPaddedArrayOffset(1,4*g),R=new w_(g,t,v,T,b,E,S,x,C,y,A);return i.isDeviceLittleEndian||(i.swap32Array(R.frameNumbers),i.swap32Array(R.positions),i.swap32Array(R.rotations),i.swap32Array(R.distances),i.swap32Array(R.fovs)),new ic(e,r,a,h,m,R)}load(e,t,i,s,n){return this._scene._loadFile(t,((t,s)=>{i(this.loadFromBuffer(e,t))}),s,!0,!0,n)}loadAsync(e,t,i){return new Promise(((s,n)=>{this.load(e,t,s,i,((e,t)=>n({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){p.Log(e)}_logDisabled(){}_warnEnabled(e){p.Warn(e)}_warnDisabled(){}_errorEnabled(e){p.Error(e)}_errorDisabled(){}}class k_{static OverrideEngineCreateEffect(e){const t=e.createEffect.bind(e);e.createEffect=function(e,i,s,n,r,o,a,l,h,c=y.GLSL){let d;if(d=i.attributes?i:{attributes:i,uniformsNames:s,uniformBuffersNames:[],samplers:n??[],defines:r??"",fallbacks:o??null,onCompiled:a??null,onError:l??null,indexParameters:h??null,shaderLanguage:c},(d.shaderLanguage===y.GLSL||void 0===d.shaderLanguage)&&(d.uniformsNames.includes("mBones")||d.samplers.includes("boneSampler"))&&-1===d.defines.indexOf("#define SDEF")){d.attributes.push(Nh.MatricesSdefCKind),d.attributes.push(Nh.MatricesSdefR0Kind),d.attributes.push(Nh.MatricesSdefR1Kind),d.defines+="\n#define SDEF";const e=d.processCodeAfterIncludes;d.processCodeAfterIncludes=e?function(t,i){return i=e(t,i),k_.ProcessSdefCode(t,i)}:k_.ProcessSdefCode}return t(e,d,this)}}static ProcessSdefCode(e,t){if("vertex"!==e)return t;const i="#define CUSTOM_VERTEX_DEFINITIONS";t=t.replace(i,`${i}\n${Fh}`);const s=new RegExp("finalWorld=finalWorld\\*influence;","g");return t.replace(s,`${Lh}\nfinalWorld=finalWorld*influence;`)}}class V_{onLoadErrorObservable;onDurationChangedObservable;onPlaybackRateChangedObservable;onMuteStateChangedObservable;onPlayObservable;onPauseObservable;onSeekObservable;_audio;_duration;_playbackRate;_isVirtualPlay;_virtualStartTime;_virtualPaused;_virtualPauseCurrentTime;_metadataLoaded;_bindedDispose;_disposeObservableObject;constructor(e){this.onLoadErrorObservable=new s,this.onDurationChangedObservable=new s,this.onPlaybackRateChangedObservable=new s,this.onMuteStateChangedObservable=new s,this.onPlayObservable=new s,this.onPauseObservable=new s,this.onSeekObservable=new s;const t=this._audio=new Audio;t.loop=!1,t.autoplay=!1,this._duration=0,this._playbackRate=1,this._isVirtualPlay=!1,this._virtualStartTime=0,this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!1,t.ondurationchange=this._onDurationChanged,t.onerror=this._onLoadError,t.onplaying=this._onPlay,t.onpause=this._onPause,t.onseeked=this._onSeek,this._bindedDispose=this.dispose.bind(this),this._disposeObservableObject=e,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)}_onDurationChanged=()=>{this._duration=this._audio.duration,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!0,this.onDurationChangedObservable.notifyObservers()};_onLoadError=()=>{this._duration=0,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!1,this.onLoadErrorObservable.notifyObservers(),this.onDurationChangedObservable.notifyObservers()};_onPlay=()=>{this._isVirtualPlay||(this._audio.playbackRate=this._playbackRate),this.onPlayObservable.notifyObservers()};_onPause=()=>{this._isVirtualPlay?this._virtualPaused&&this.onPauseObservable.notifyObservers():this.onPauseObservable.notifyObservers()};_ignoreSeekedEventOnce=!1;_onSeek=()=>{this._ignoreSeekedEventOnce?this._ignoreSeekedEventOnce=!1:this.onSeekObservable.notifyObservers()};get duration(){return this._duration}get currentTime(){if(this._isVirtualPlay){if(this._virtualPaused)return this._virtualPauseCurrentTime;{const e=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate;return e>this._duration?(this._virtualPaused=!0,this._virtualPauseCurrentTime=this._duration,this._onPause(),this._virtualPauseCurrentTime):e}}return this._audio.currentTime}set currentTime(e){this._isVirtualPlay?(this._virtualPaused?this._virtualPauseCurrentTime=e:this._virtualStartTime=performance.now()/1e3-e/this._playbackRate,this._onSeek()):this._audio.currentTime=e}_setCurrentTimeWithoutNotify(e){this._isVirtualPlay?this._virtualPaused?this._virtualPauseCurrentTime=e:this._virtualStartTime=performance.now()/1e3-e/this._playbackRate:(this._ignoreSeekedEventOnce=!0,this._audio.currentTime=e)}get volume(){return this._audio.volume}set volume(e){this._audio.volume=e}get muted(){return this._isVirtualPlay}mute(){this._isVirtualPlay||(this._isVirtualPlay=!0,this._virtualStartTime=performance.now()/1e3-this._audio.currentTime/this._playbackRate,this._virtualPaused=this._audio.paused,this._virtualPauseCurrentTime=this._audio.currentTime,this._audio.pause(),this.onMuteStateChangedObservable.notifyObservers())}async unmute(){if(!this._isVirtualPlay)return!1;let e=!1;if(this._ignoreSeekedEventOnce=!0,this._virtualPaused)this._audio.currentTime=this._virtualPauseCurrentTime;else{this._audio.currentTime=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate;try{await this._audio.play(),this._audio.playbackRate=this._playbackRate}catch(t){if(!(t instanceof DOMException&&"NotAllowedError"===t.name))throw t;e=!0}}return!e&&(this._isVirtualPlay=!1,this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this.onMuteStateChangedObservable.notifyObservers(),!0)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._setPlaybackRateWithoutNotify(e),this.onPlaybackRateChangedObservable.notifyObservers()}_setPlaybackRateWithoutNotify(e){if(this._isVirtualPlay&&!this._virtualPaused){const t=performance.now()/1e3,i=(t-this._virtualStartTime)*this._playbackRate;this._virtualStartTime=t-i/e}this._playbackRate=e,this._audio.playbackRate=e}get preservesPitch(){return this._audio.preservesPitch}set preservesPitch(e){this._audio.preservesPitch=e}get paused(){return this._isVirtualPlay?this._virtualPaused:this._audio.paused}get source(){return this._audio.src}set source(e){e!==this._audio.src&&(this._audio.src=e,this._metadataLoaded=!1,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._audio.load())}get metadataLoaded(){return this._metadataLoaded}async _virtualPlay(){this._metadataLoaded?(this._virtualPaused&&(this._virtualStartTime=performance.now()/1e3-this._virtualPauseCurrentTime/this._playbackRate,this._virtualPaused=!1),this._isVirtualPlay||(this._isVirtualPlay=!0,this.onMuteStateChangedObservable.notifyObservers()),this._onPlay()):await new Promise(((e,t)=>{const i=()=>{this._virtualPaused&&(this._virtualStartTime=performance.now()/1e3-this._virtualPauseCurrentTime/this._playbackRate,this._virtualPaused=!1),this._isVirtualPlay||(this._isVirtualPlay=!0,this.onMuteStateChangedObservable.notifyObservers()),this._onPlay(),this.onLoadErrorObservable.removeCallback(s),e()},s=()=>{this.onDurationChangedObservable.removeCallback(i),t(new DOMException("The media resource indicated by the src attribute or assigned media provider object was not suitable.","NotSupportedError"))};this.onDurationChangedObservable.addOnce(i),this.onLoadErrorObservable.addOnce(s)}))}_playRequestBlocking=!1;async play(){if(!this._isVirtualPlay||this._virtualPaused)if(this._isVirtualPlay)await this._virtualPlay();else if(!this._playRequestBlocking){this._playRequestBlocking=!0;try{await this._audio.play()}catch(e){if(!(e instanceof DOMException&&"NotAllowedError"===e.name))throw e;await this._virtualPlay()}finally{this._playRequestBlocking=!1}}}pause(){if(this._isVirtualPlay){if(this._virtualPaused)return;this._virtualPaused=!0,this._virtualPauseCurrentTime=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate,this._onPause()}else this._audio.pause()}dispose(){const e=this._audio;e.pause(),e.ondurationchange=null,e.onerror=null,e.onplaying=null,e.onpause=null,e.onseeked=null,this._audio.remove(),this.onLoadErrorObservable.clear(),this.onDurationChangedObservable.clear(),this.onPlaybackRateChangedObservable.clear(),this.onMuteStateChangedObservable.clear(),this.onPlayObservable.clear(),this.onPauseObservable.clear(),this.onSeekObservable.clear(),null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose)}}class G_ extends Gt{ignoreParentScaling=!1;rotation=new me;distance=-45;_viewMatrix=Te.Zero();_tmpUpVector=me.Zero();_tmpTargetVector=me.Zero();onCurrentAnimationChangedObservable;_animations;_animationIndexMap;_currentAnimation;constructor(e,t=new me(0,10,0),i,n=!0){super(e,t,i,n),this.fov=Math.PI/180*30,this.onCurrentAnimationChangedObservable=new s,this._animations=[],this._animationIndexMap=new Map,this._currentAnimation=null}addAnimation(e){let t;if(!e.createRuntimeCameraAnimation)throw new Error('animation is not MmdAnimation or MmdCameraAnimationGroup or MmdCompositeAnimation. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimationGroup" or "babylon-mmd/esm/Runtime/Animation/mmdCompositeRuntimeCameraAnimation"?');t=e.createRuntimeCameraAnimation(this),this._animationIndexMap.set(e.name,this._animations.length),this._animations.push(t)}removeAnimation(e){const t=this._animations[e];this._currentAnimation===t&&(this._currentAnimation=null),this._animationIndexMap.delete(t.animation.name),this._animations.splice(e,1),t.dispose?.()}setAnimation(e){if(null===e)return void(null!==this._currentAnimation&&(this._currentAnimation=null,this.onCurrentAnimationChangedObservable.notifyObservers(null)));const t=this._animationIndexMap.get(e);if(void 0===t)throw new Error(`Animation ${e} is not found`);this._currentAnimation=this._animations[t],this.onCurrentAnimationChangedObservable.notifyObservers(this._currentAnimation)}get runtimeAnimations(){return this._animations}get currentAnimation(){return this._currentAnimation}animate(e){null!==this._currentAnimation&&this._currentAnimation.animate(e)}_storedPosition=null;_storedRotation=null;_storedDistance=0;storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this._storedDistance=this.distance,super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.distance=this._storedDistance,!0)}_initCache(){super._initCache(),this._cache.rotation=new me(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.distance=Number.MAX_VALUE}_updateCache(e){e||super._updateCache(),this._cache.rotation.copyFrom(this.rotation),this._cache.distance=this.distance}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache.rotation.equals(this.rotation)&&this._cache.distance===this.distance}static _RotationMatrix=new Te;static _CameraEyePosition=new me;static _UpVector=new me;static _TargetVector=new me;_getViewMatrix(){const e=Te.RotationYawPitchRollToRef(-this.rotation.y,-this.rotation.x,-this.rotation.z,G_._RotationMatrix),t=this.position.addToRef(me.TransformCoordinatesFromFloatsToRef(0,0,this.distance,e,G_._CameraEyePosition),G_._CameraEyePosition),i=me.TransformNormalFromFloatsToRef(0,0,1,e,G_._TargetVector).addInPlace(t),s=me.TransformNormalFromFloatsToRef(0,1,0,e,G_._UpVector);if(this.ignoreParentScaling){if(this.parent){const e=this.parent.getWorldMatrix();me.TransformCoordinatesToRef(t,e,this._globalPosition),me.TransformCoordinatesToRef(i,e,this._tmpTargetVector),me.TransformNormalToRef(s,e,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t),this._tmpTargetVector.copyFrom(i),this._tmpUpVector.copyFrom(s);return this.getScene().useRightHandedSystem?Te.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):Te.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix),this._viewMatrix}if(this.getScene().useRightHandedSystem?Te.LookAtRHToRef(t,i,s,this._viewMatrix):Te.LookAtLHToRef(t,i,s,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t);return this._viewMatrix}getClassName(){return"MmdCamera"}}class z_{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw f("CannonJSPlugin")}constructor(e,t=z_.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new me(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach((function(e){e.dispose()})),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){const s={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(s),this._physicsPlugin.generateJoint(s)}removeJoint(e,t,i){const s=this._joints.filter((function(s){return s.connectedImpostor===t&&s.joint===i&&s.mainImpostor===e}));s.length&&this._physicsPlugin.removeJoint(s[0])}_step(e){this._impostors.forEach((e=>{e.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(e)})),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}}class H_{constructor(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=me.Zero(),this._hitPointWorld=me.Zero(),this._rayFromWorld=me.Zero(),this._rayToWorld=me.Zero(),this._triangleIndex=-1}get hasHit(){return this._hasHit}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormalWorld}get hitPointWorld(){return this._hitPointWorld}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormalWorld.set(e.x,e.y,e.z),this._hitPointWorld.set(t.x,t.y,t.z),this._triangleIndex=null!=i?i:-1}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=me.Distance(this._rayFromWorld,this._hitPointWorld)}reset(e=me.Zero(),t=me.Zero()){this._rayFromWorld.copyFrom(e),this._rayToWorld.copyFrom(t),this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld.setAll(0),this._hitPointWorld.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0}}class W_{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw f("")}constructor(e,t=W_.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new me(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){const t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i,s){this._physicsPlugin.raycast(e,t,i,s)}raycast(e,t,i){const s=new H_;return this._physicsPlugin.raycast(e,t,s,i),s}}Oi.prototype.getPhysicsEngine=function(){return this._physicsEngine},Oi.prototype.enablePhysics=function(e=null,t){if(this._physicsEngine)return!0;let i=this._getComponent(li.NAME_PHYSICSENGINE);i||(i=new X_(this),this._addComponent(i));try{if(t&&1!==(null==t?void 0:t.getPluginVersion())){if(2!==(null==t?void 0:t.getPluginVersion()))throw new Error("Unsupported Physics plugin version.");this._physicsEngine=new W_(e,t)}else this._physicsEngine=new z_(e,t);return this._physicsTimeAccumulator=0,!0}catch(e){return p.Error(e.message),!1}},Oi.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},Oi.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},Oi.prototype.deleteCompoundImpostor=function(e){const t=e.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},Oi.prototype._advancePhysicsEngineStep=function(e){if(this._physicsEngine){const t=this._physicsEngine.getSubTimeStep();if(t>0)for(this._physicsTimeAccumulator+=e;this._physicsTimeAccumulator>t;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=t;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class X_{constructor(e){this.name=li.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new s,this.scene.onAfterPhysicsObservable=new s,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?1e3*this.scene._physicsEngine.getTimeStep():1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}Object.defineProperty(Bn.prototype,"physicsBody",{get:function(){return this._physicsBody},set:function(e){this._physicsBody!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsBody=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add((()=>{this.physicsBody&&(this.physicsBody.dispose(),this.physicsBody=null)}))))},enumerable:!0,configurable:!0}),Bn.prototype.getPhysicsBody=function(){return this.physicsBody},Bn.prototype.applyImpulse=function(e,t){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyImpulse(e,t),this};class Q_{constructor(e,t,i,s){if(this._pluginData=void 0,this._pluginDataInstances=[],this._collisionCBEnabled=!1,this._collisionEndedCBEnabled=!1,this.disablePreStep=!0,this._isDisposed=!1,!s)return;const n=s.getPhysicsEngine();if(!n)throw new Error("No Physics Engine available.");if(this._physicsEngine=n,2!=n.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const r=n.getPhysicsPlugin();if(!r)throw new Error("No Physics Plugin available.");this._physicsPlugin=r,e.rotationQuaternion||(e.rotationQuaternion=ve.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z)),this.startAsleep=i;const o=e;o.hasThinInstances?this._physicsPlugin.initBodyInstances(this,t,o):(e.parent&&e.computeWorldMatrix(!0),this._physicsPlugin.initBody(this,t,e.absolutePosition,e.absoluteRotationQuaternion)),this.transformNode=e,e.physicsBody=this,n.addBody(this),this._nodeDisposeObserver=e.onDisposeObservable.add((()=>{this.dispose()}))}getClassName(){return"PhysicsBody"}clone(e){const t=new Q_(e,this.getMotionType(),this.startAsleep,this.transformNode.getScene());return t.shape=this.shape,t.setMassProperties(this.getMassProperties()),t.setLinearDamping(this.getLinearDamping()),t.setAngularDamping(this.getAngularDamping()),t}updateBodyInstances(){const e=this.transformNode;e.hasThinInstances&&this._physicsPlugin.updateBodyInstances(this,e)}get numInstances(){return this._pluginDataInstances.length}set shape(e){this._physicsPlugin.setShape(this,e)}get shape(){return this._physicsPlugin.getShape(this)}setEventMask(e,t){this._physicsPlugin.setEventMask(this,e,t)}getEventMask(e){return this._physicsPlugin.getEventMask(this,e)}setMotionType(e,t){this._physicsPlugin.setMotionType(this,e,t)}getMotionType(e){return this._physicsPlugin.getMotionType(this,e)}computeMassProperties(e){return this._physicsPlugin.computeMassProperties(this,e)}setMassProperties(e,t){this._physicsPlugin.setMassProperties(this,e,t)}getMassProperties(e){return this._physicsPlugin.getMassProperties(this,e)}setLinearDamping(e,t){this._physicsPlugin.setLinearDamping(this,e,t)}getLinearDamping(e){return this._physicsPlugin.getLinearDamping(this,e)}setAngularDamping(e,t){this._physicsPlugin.setAngularDamping(this,e,t)}getAngularDamping(e){return this._physicsPlugin.getAngularDamping(this,e)}setLinearVelocity(e,t){this._physicsPlugin.setLinearVelocity(this,e,t)}getLinearVelocityToRef(e,t){return this._physicsPlugin.getLinearVelocityToRef(this,e,t)}getLinearVelocity(e){const t=new me;return this.getLinearVelocityToRef(t,e),t}setAngularVelocity(e,t){this._physicsPlugin.setAngularVelocity(this,e,t)}getAngularVelocityToRef(e,t){return this._physicsPlugin.getAngularVelocityToRef(this,e,t)}getAngularVelocity(e){const t=new me;return this.getAngularVelocityToRef(t,e),t}applyImpulse(e,t,i){this._physicsPlugin.applyImpulse(this,e,t,i)}applyForce(e,t,i){this._physicsPlugin.applyForce(this,e,t,i)}getGeometry(){return this._physicsPlugin.getBodyGeometry(this)}getCollisionObservable(){return this._physicsPlugin.getCollisionObservable(this)}getCollisionEndedObservable(){return this._physicsPlugin.getCollisionEndedObservable(this)}setCollisionCallbackEnabled(e){this._collisionCBEnabled=e,this._physicsPlugin.setCollisionCallbackEnabled(this,e)}setCollisionEndedCallbackEnabled(e){this._collisionEndedCBEnabled=e,this._physicsPlugin.setCollisionEndedCallbackEnabled(this,e)}getObjectCenterWorld(e){const t=new me;return this.getObjectCenterWorldToRef(t,e)}getObjectCenterWorldToRef(e,t){var i;if((null===(i=this._pluginDataInstances)||void 0===i?void 0:i.length)>0){const i=t||0,s=this.transformNode._thinInstanceDataStorage.matrixData;s&&e.set(s[16*i+12],s[16*i+13],s[16*i+14])}else e.copyFrom(this.transformNode.position);return e}addConstraint(e,t,i,s){this._physicsPlugin.addConstraint(this,e,t,i,s)}syncWithBone(e,t,i,s,n,r){const o=this.transformNode;if(o.rotationQuaternion)if(n){const i=Ee.Quaternion[0];e.getRotationQuaternionToRef(Js.WORLD,t,i),i.multiplyToRef(n,o.rotationQuaternion)}else e.getRotationQuaternionToRef(Js.WORLD,t,o.rotationQuaternion);const a=Ee.Vector3[0],l=Ee.Vector3[1];r||((r=Ee.Vector3[2]).x=0,r.y=1,r.z=0),e.getDirectionToRef(r,t,l),e.getAbsolutePositionToRef(t,a),null==s&&i&&(s=i.length()),null!=s&&(a.x+=l.x*s,a.y+=l.y*s,a.z+=l.z*s),o.setAbsolutePosition(a)}iterateOverAllInstances(e){var t;if((null===(t=this._pluginDataInstances)||void 0===t?void 0:t.length)>0)for(let t=0;t<this._pluginDataInstances.length;t++)e(this,t);else e(this,void 0)}setGravityFactor(e,t){this._physicsPlugin.setGravityFactor(this,e,t)}getGravityFactor(e){return this._physicsPlugin.getGravityFactor(this,e)}setTargetTransform(e,t,i){this._physicsPlugin.setTargetTransform(this,e,t,i)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._collisionCBEnabled&&this.setCollisionCallbackEnabled(!1),this._collisionEndedCBEnabled&&this.setCollisionEndedCallbackEnabled(!1),this._nodeDisposeObserver&&(this.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this._physicsEngine.removeBody(this),this._physicsPlugin.removeBody(this),this._physicsPlugin.disposeBody(this),this.transformNode.physicsBody=null,this._pluginData=null,this._pluginDataInstances.length=0,this._isDisposed=!0)}}class Y_{constructor(e,t,i){if(this._pluginData=void 0,!i)throw new Error("Missing scene parameter for constraint constructor.");const s=i.getPhysicsEngine();if(!s)throw new Error("No Physics Engine available.");if(2!=s.getPluginVersion())throw new Error("Plugin version is incorrect. Expected version 2.");const n=s.getPhysicsPlugin();if(!n)throw new Error("No Physics Plugin available.");this._physicsPlugin=n,this._options=t,this._type=e}get type(){return this._type}get options(){return this._options}set isEnabled(e){this._physicsPlugin.setEnabled(this,e)}get isEnabled(){return this._physicsPlugin.getEnabled(this)}set isCollisionsEnabled(e){this._physicsPlugin.setCollisionsEnabled(this,e)}get isCollisionsEnabled(){return this._physicsPlugin.getCollisionsEnabled(this)}getBodiesUsingConstraint(){return this._physicsPlugin.getBodiesUsingConstraint(this)}dispose(){this._physicsPlugin.disposeConstraint(this)}}class K_ extends Y_{constructor(e,t,i){super(Tc.SIX_DOF,e,i),this.limits=t}setAxisFriction(e,t){this._physicsPlugin.setAxisFriction(this,e,t)}getAxisFriction(e){return this._physicsPlugin.getAxisFriction(this,e)}setAxisMode(e,t){this._physicsPlugin.setAxisMode(this,e,t)}getAxisMode(e){return this._physicsPlugin.getAxisMode(this,e)}setAxisMinLimit(e,t){this._physicsPlugin.setAxisMinLimit(this,e,t)}getAxisMinLimit(e){return this._physicsPlugin.getAxisMinLimit(this,e)}setAxisMaxLimit(e,t){this._physicsPlugin.setAxisMaxLimit(this,e,t)}getAxisMaxLimit(e){return this._physicsPlugin.getAxisMaxLimit(this,e)}setAxisMotorType(e,t){this._physicsPlugin.setAxisMotorType(this,e,t)}getAxisMotorType(e){return this._physicsPlugin.getAxisMotorType(this,e)}setAxisMotorTarget(e,t){this._physicsPlugin.setAxisMotorTarget(this,e,t)}getAxisMotorTarget(e){return this._physicsPlugin.getAxisMotorTarget(this,e)}setAxisMotorMaxForce(e,t){this._physicsPlugin.setAxisMotorMaxForce(this,e,t)}getAxisMotorMaxForce(e){return this._physicsPlugin.getAxisMotorMaxForce(this,e)}}class j_ extends Bn{linkedBone;physicsMode;bodyOffsetMatrix;bodyOffsetInverseMatrix;constructor(e,t,i,s,n){super(e,t,n),this.linkedBone=i,this.physicsMode=s,this.bodyOffsetMatrix=Te.Identity(),this.bodyOffsetInverseMatrix=Te.Identity()}static _ParentWorldMatrixInverse=new Te;static _WorldMatrix=new Te;computeBodyOffsetMatrix(){const e=this.linkedBone.worldMatrix.invertToRef(j_._ParentWorldMatrixInverse);Te.ComposeToRef(this.scaling,this.rotationQuaternion,this.position,j_._WorldMatrix).multiplyToRef(e,this.bodyOffsetMatrix),this.bodyOffsetMatrix.invertToRef(this.bodyOffsetInverseMatrix)}}class $_{_mmdPhysics;_nodes;_bodies;_constraints;constructor(e,t,i,s){this._mmdPhysics=e,this._nodes=t,this._bodies=i,this._constraints=s}dispose(){const e=this._constraints;for(let t=0;t<e.length;++t)e[t]?.dispose();const t=this._bodies;for(let e=0;e<t.length;++e){const i=t[e];null!==i&&(i.shape?.dispose(),i.dispose())}const i=this._nodes;for(let e=0;e<i.length;++e)i[e]?.dispose()}static _NodeWorldMatrix=new Te;static _ZeroVector=me.Zero();initialize(){const e=this._mmdPhysics,t=this._nodes;for(let i=0;i<t.length;++i){const s=t[i];if(null===s)continue;s.bodyOffsetMatrix.multiplyToRef(s.linkedBone.worldMatrix,$_._NodeWorldMatrix).decompose(s.scaling,s.rotationQuaternion,s.position);const n=s.physicsBody;n.setAngularVelocity($_._ZeroVector),n.setLinearVelocity($_._ZeroVector),e._enablePreStepOnce(s.physicsBody)}}static _NodeWorldPosition=new me;static _NodeWorldRotation=new ve;syncBodies(){const e=this._nodes;for(let t=0;t<e.length;++t){const i=e[t];if(null!==i)switch(i.physicsMode){case Uh.RigidBody.PhysicsMode.FollowBone:i.bodyOffsetMatrix.multiplyToRef(i.linkedBone.worldMatrix,$_._NodeWorldMatrix).decompose(i.scaling,i.rotationQuaternion,i.position),i.computeWorldMatrix(!0),i.getWorldMatrix().decompose(void 0,$_._NodeWorldRotation,$_._NodeWorldPosition),i.physicsBody.setTargetTransform($_._NodeWorldPosition,$_._NodeWorldRotation);break;case Uh.RigidBody.PhysicsMode.Physics:case Uh.RigidBody.PhysicsMode.PhysicsWithBone:break;default:throw new Error(`Unknown physics mode: ${i.physicsMode}`)}}}static _BoneWorldPosition=new me;syncBones(){const e=this._nodes;for(let t=0;t<e.length;++t){const i=e[t];if(null!==i)switch(i.physicsMode){case Uh.RigidBody.PhysicsMode.FollowBone:break;case Uh.RigidBody.PhysicsMode.Physics:{i.bodyOffsetInverseMatrix.multiplyToRef(Te.ComposeToRef(i.scaling,i.rotationQuaternion,i.position,$_._NodeWorldMatrix),i.linkedBone.worldMatrix);const e=i.linkedBone.childBones;for(let t=0;t<e.length;++t)e[t].updateWorldMatrix()}break;case Uh.RigidBody.PhysicsMode.PhysicsWithBone:{i.linkedBone.worldMatrix.getTranslationToRef($_._BoneWorldPosition),i.bodyOffsetInverseMatrix.multiplyToRef(Te.ComposeToRef(i.scaling,i.rotationQuaternion,$_._ZeroVector,$_._NodeWorldMatrix),i.linkedBone.worldMatrix),i.linkedBone.worldMatrix.setTranslation($_._BoneWorldPosition);const e=i.linkedBone.childBones;for(let t=0;t<e.length;++t)e[t].updateWorldMatrix()}break;default:throw new Error(`Unknown physics mode: ${i.physicsMode}`)}}}}class q_{angularLimitClampThreshold;_scene;_enablePreStepOnces=[];constructor(e){this.angularLimitClampThreshold=5*Math.PI/180,this._scene=e}_convertParameter(e){const t=1/60;return(1-(1-e)**t)/t}_clampAngularLimit(e){return Math.abs(e)<this.angularLimitClampThreshold?0:e}buildPhysics(e,t,i,s,n){const r=this._scene;let o;{e.computeWorldMatrix(!0);const t=e.getWorldMatrix(),i=new me;t.decompose(i),Math.abs(i.x-i.y)<1e-4&&Math.abs(i.y-i.z)<1e-4?Math.abs(i.x-1)<1e-4&&Math.abs(i.y-1)<1e-4&&Math.abs(i.z-1)<1e-4?o=1:(o=i.x,n.warn("Mesh scaling is not 1, simulation may differ from the original")):(o=Math.max(i.x,i.y,i.z),n.warn("Mesh scaling is not uniform, physics may not work correctly"))}const a=new Array(i.length),l=new Array(i.length),h=new Array(s.length);for(let s=0;s<i.length;++s){const h=i[s];if(h.boneIndex<0||t.length<=h.boneIndex){n.warn(`Bone index out of range failed to create rigid body: ${h.name}`),a[s]=null,l[s]=null;continue}const c=t[h.boneIndex];let d,u=!1;switch(h.shapeType){case Uh.RigidBody.ShapeType.Sphere:d=new Pc(new me,h.shapeSize[0]*o,r),0===h.shapeSize[0]&&(u=!0);break;case Uh.RigidBody.ShapeType.Box:d=new Oc(new me,new ve,new me(2*h.shapeSize[0]*o,2*h.shapeSize[1]*o,2*h.shapeSize[2]*o),r),0!==h.shapeSize[0]&&0!==h.shapeSize[1]&&0!==h.shapeSize[2]||(u=!0);break;case Uh.RigidBody.ShapeType.Capsule:d=new Mc(new me(0,h.shapeSize[1]/2*o,0),new me(0,-h.shapeSize[1]/2*o,0),h.shapeSize[0]*o,r),0!==h.shapeSize[0]&&0!==h.shapeSize[1]||(u=!0);break;default:n.warn(`Unknown rigid body shape type: ${h.shapeType}`),a[s]=null,l[s]=null;continue}d.material={friction:h.friction,restitution:h.repulsion},d.filterCollideMask=u?0:h.collisionMask,d.filterMembershipMask=1<<h.collisionGroup;const _=new j_(h.name,r,c,h.physicsMode),f=h.shapePosition;_.position.copyFromFloats(f[0],f[1],f[2]);const p=h.shapeRotation;_.rotationQuaternion=ve.FromEulerAngles(p[0],p[1],p[2]),_.computeBodyOffsetMatrix(),_.setParent(e);const m=h.physicsMode===Uh.RigidBody.PhysicsMode.FollowBone?xc.ANIMATED:xc.DYNAMIC,g=new Q_(_,m,!1,r);g.shape=d,g.setMassProperties({mass:h.mass}),g.setLinearDamping(this._convertParameter(h.linearDamping)),g.setAngularDamping(this._convertParameter(h.angularDamping)),g.computeMassProperties(),a[s]=_,l[s]=g}const c=me.One(),d=new ve,u=new me,_=new Te,f=new ve,p=new me,m=new Te,g=new Te,v=new Te,T=new Te;for(let e=0;e<s.length;++e){const b=s[e];if(b.rigidbodyIndexA<0||i.length<=b.rigidbodyIndexA){n.warn(`Rigid body index out of range failed to create joint: ${b.name}`),h[e]=null;continue}if(b.rigidbodyIndexB<0||i.length<=b.rigidbodyIndexB){n.warn(`Rigid body index out of range failed to create joint: ${b.name}`),h[e]=null;continue}const E=l[b.rigidbodyIndexA],S=l[b.rigidbodyIndexB];if(null===E||null===S){n.warn(`Rigid body not found failed to create joint: ${b.name}`),h[e]=null;continue}Te.ComposeToRef(c,ve.FromEulerAnglesToRef(b.rotation[0],b.rotation[1],b.rotation[2],d),u.copyFromFloats(b.position[0]*o,b.position[1]*o,b.position[2]*o),_);const x=i[b.rigidbodyIndexA],C=i[b.rigidbodyIndexB];{const e=x.shapeRotation,t=x.shapePosition;Te.ComposeToRef(c,ve.FromEulerAnglesToRef(e[0],e[1],e[2],f),p.copyFromFloats(t[0]*o,t[1]*o,t[2]*o),m).invert()}{const e=C.shapeRotation,t=C.shapePosition;Te.ComposeToRef(c,ve.FromEulerAnglesToRef(e[0],e[1],e[2],f),p.copyFromFloats(t[0]*o,t[1]*o,t[2]*o),g).invert()}_.multiplyToRef(m,v),_.multiplyToRef(g,T);const y=this._convertParameter(1),A=[{axis:vc.LINEAR_X,minLimit:b.positionMin[0],maxLimit:b.positionMax[0],stiffness:this._convertParameter(b.springPosition[0]),damping:y},{axis:vc.LINEAR_Y,minLimit:b.positionMin[1],maxLimit:b.positionMax[1],stiffness:this._convertParameter(b.springPosition[1]),damping:y},{axis:vc.LINEAR_Z,minLimit:b.positionMin[2],maxLimit:b.positionMax[2],stiffness:this._convertParameter(b.springPosition[2]),damping:y},{axis:vc.ANGULAR_X,minLimit:this._clampAngularLimit(b.rotationMin[0]),maxLimit:this._clampAngularLimit(b.rotationMax[0]),stiffness:this._convertParameter(b.springRotation[0]),damping:y},{axis:vc.ANGULAR_Y,minLimit:this._clampAngularLimit(b.rotationMin[1]),maxLimit:this._clampAngularLimit(b.rotationMax[1]),stiffness:this._convertParameter(b.springRotation[1]),damping:y},{axis:vc.ANGULAR_Z,minLimit:this._clampAngularLimit(b.rotationMin[2]),maxLimit:this._clampAngularLimit(b.rotationMax[2]),stiffness:this._convertParameter(b.springRotation[2]),damping:y}];for(let e=0;e<A.length;++e){const t=A[e];0===t.stiffness&&(t.stiffness=void 0,t.damping=void 0)}const R=new K_({pivotA:v.getTranslation(),pivotB:T.getTranslation(),axisA:new me(v.m[0],v.m[1],v.m[2]).negateInPlace(),axisB:new me(T.m[0],T.m[1],T.m[2]).negateInPlace(),perpAxisA:new me(v.m[4],v.m[5],v.m[6]),perpAxisB:new me(T.m[4],T.m[5],T.m[6]),collision:!0},A,r);E.addConstraint(S,R),h[e]=R;const I=a[b.rigidbodyIndexA],P=a[b.rigidbodyIndexB];I.physicsMode!==Uh.RigidBody.PhysicsMode.FollowBone&&P.physicsMode===Uh.RigidBody.PhysicsMode.PhysicsWithBone?t[C.boneIndex].parentBone===t[x.boneIndex]&&(P.physicsMode=Uh.RigidBody.PhysicsMode.Physics):P.physicsMode!==Uh.RigidBody.PhysicsMode.FollowBone&&I.physicsMode===Uh.RigidBody.PhysicsMode.PhysicsWithBone&&t[x.boneIndex].parentBone===t[C.boneIndex]&&(I.physicsMode=Uh.RigidBody.PhysicsMode.Physics)}return new $_(this,a,l,h)}_onAfterPhysics=()=>{const e=this._enablePreStepOnces;for(let t=0;t<e.length;++t)e[t].disablePreStep=!0;e.length=0};_enablePreStepOnce(e){e.disablePreStep&&(0===this._enablePreStepOnces.length&&this._scene.onAfterPhysicsObservable.addOnce(this._onAfterPhysics),this._enablePreStepOnces.push(e),e.disablePreStep=!1)}}var Z_,J_,ef;!function(e){e.isMmdMesh=function(e){if(null===e.metadata||!e.metadata.isMmdModel)return!1;if(null===e.material||!e.material.subMaterials)return!1;for(const t of e.material.subMaterials)if(null===t)return!1;return null!==e.skeleton&&null!==e.morphTargetManager},e.isMmdStaticMesh=function(e){if(null===e.metadata||!e.metadata.isMmdModel)return!1;if(null===e.material||!e.material.subMaterials)return!1;for(const t of e.material.subMaterials)if(null===t)return!1;return!0}}(Z_||(Z_={})),function(e){e.isHumanoidMesh=function(e){return!(null===e.metadata||!e.metadata.isMmdModel)&&null!==e.material&&null!==e.skeleton}}(J_||(J_={}));class tf{isLocal;affectRotation;affectPosition;ratio;targetBone;appendPositionOffset=me.Zero();appendRotationOffset=ve.Identity();constructor(e,t,i){this.isLocal=0!=(e&Uh.Bone.Flag.LocalAppendTransform),this.affectRotation=0!=(e&Uh.Bone.Flag.HasAppendRotate),this.affectPosition=0!=(e&Uh.Bone.Flag.HasAppendMove),this.ratio=t.ratio,this.targetBone=i}static _IdentityQuaternion=ve.Identity();update(){const e=this.targetBone;if(this.affectRotation){const t=this.appendRotationOffset;this.isLocal?e.getAnimatedRotationToRef(t):null!==e.appendTransformSolver?t.copyFrom(e.appendTransformSolver.appendRotationOffset):e.getAnimatedRotationToRef(t),null!==e.ikRotation&&e.ikRotation.multiplyToRef(t,t),ve.SlerpToRef(tf._IdentityQuaternion,t,this.ratio,t)}if(this.affectPosition){const t=this.appendPositionOffset;this.isLocal?e.getAnimationPositionOffsetToRef(t):null!==e.appendTransformSolver?t.copyFrom(e.appendTransformSolver.appendPositionOffset):e.getAnimationPositionOffsetToRef(t),t.scaleInPlace(this.ratio)}}}class sf{bone;minimumAngle;maximumAngle;prevAngle;savedIkRotation;planeModeAngle;constructor(e,t,i){this.bone=e,this.minimumAngle=t,this.maximumAngle=i,this.prevAngle=me.Zero(),this.savedIkRotation=ve.Identity(),this.planeModeAngle=0}}class nf{enabled;iteration;limitAngle;ikBone;targetBone;_ikChains;constructor(e,t){this.enabled=!0,this.iteration=0,this.limitAngle=0,this.ikBone=e,this.targetBone=t,this._ikChains=[]}addIkChain(e,t,i){e.ikRotation=ve.Identity();const s=new sf(e,t,i);this._ikChains.push(s)}static _TargetPosition=new me;static _IkPosition=new me;solve(){if(!this.enabled)return;const e=this.ikBone,t=this.targetBone,i=this._ikChains;for(let e=0;e<i.length;++e){const t=i[e],s=t.bone;t.prevAngle.setAll(0),s.ikRotation.set(0,0,0,1),t.planeModeAngle=0,s.updateLocalMatrix(),s.updateWorldMatrix()}let s=Number.MAX_VALUE;for(let n=0;n<this.iteration;++n){this._solveCore(n);const r=t.worldMatrix.getTranslationToRef(nf._TargetPosition),o=e.worldMatrix.getTranslationToRef(nf._IkPosition),a=me.DistanceSquared(r,o);if(!(a<s)){for(let e=0;e<i.length;++e){const t=i[e];t.bone.ikRotation.copyFrom(t.savedIkRotation),t.bone.updateLocalMatrix(),t.bone.updateWorldMatrix()}break}s=a;for(let e=0;e<i.length;++e){const t=i[e];t.savedIkRotation.copyFrom(t.bone.ikRotation)}}}static _TargetPosition2=new me;static _IkPosition2=new me;static _InversedChain=new Te;static _ChainCross=new me;static _Rotation=new ve;static _ChainRotation=new ve;static _AnimatedRotation=new ve;static _ChainRotationMatrix=new Te;static _DecomposedRotation=new me;static _ClampedRotation=new me;static _FinalRotationA=new ve;static _FinalRotationB=new ve;static _Right=me.Right();static _Up=me.Up();static _Forward=me.Forward();static _InversedAnimatedRotation=new ve;static _RadToDeg=180/Math.PI;_solveCore(e){const t=this.ikBone.worldMatrix.getTranslationToRef(nf._IkPosition2),i=this._ikChains;for(let s=0;s<i.length;++s){const n=i[s],r=n.bone;if(r===this.targetBone)continue;if(null!==n.minimumAngle){if(!(0===n.minimumAngle.x&&0===n.maximumAngle.x||0!==n.minimumAngle.y&&0!==n.maximumAngle.y||0!==n.minimumAngle.z&&0!==n.maximumAngle.z)){this._solvePlane(e,n,0);continue}if(!(0===n.minimumAngle.y&&0===n.maximumAngle.y||0!==n.minimumAngle.x&&0!==n.maximumAngle.x||0!==n.minimumAngle.z&&0!==n.maximumAngle.z)){this._solvePlane(e,n,1);continue}if(!(0===n.minimumAngle.z&&0===n.maximumAngle.z||0!==n.minimumAngle.x&&0!==n.maximumAngle.x||0!==n.minimumAngle.y&&0!==n.maximumAngle.y)){this._solvePlane(e,n,2);continue}}const o=this.targetBone.worldMatrix.getTranslationToRef(nf._TargetPosition2),a=nf._InversedChain.copyFrom(r.worldMatrix).invert(),l=me.TransformCoordinatesToRef(t,a,nf._IkPosition),h=me.TransformCoordinatesToRef(o,a,nf._TargetPosition),c=l.normalize(),d=h.normalize();let u=me.Dot(d,c);u=Math.max(-1,Math.min(1,u));let _=Math.acos(u);if(_*nf._RadToDeg<.001)continue;_=Math.max(-this.limitAngle,Math.min(this.limitAngle,_));const f=me.CrossToRef(d,c,nf._ChainCross).normalize(),p=ve.RotationAxisToRef(f,_,nf._Rotation),m=nf._ChainRotation.copyFrom(r.ikRotation),g=r.getAnimatedRotationToRef(nf._AnimatedRotation);if(m.multiplyInPlace(g).multiplyInPlace(p),null!==n.minimumAngle){const e=m.toRotationMatrix(nf._ChainRotationMatrix),t=this._decomposeToRef(e,n.prevAngle,nf._DecomposedRotation),i=me.ClampToRef(t,n.minimumAngle,n.maximumAngle,nf._ClampedRotation).subtractInPlace(n.prevAngle);i.set(Math.max(-this.limitAngle,Math.min(this.limitAngle,i.x))+n.prevAngle.x,Math.max(-this.limitAngle,Math.min(this.limitAngle,i.y))+n.prevAngle.y,Math.max(-this.limitAngle,Math.min(this.limitAngle,i.z))+n.prevAngle.z);const s=ve.RotationAxisToRef(nf._Right,i.x,nf._FinalRotationA),r=nf._FinalRotationB;ve.RotationAxisToRef(nf._Up,i.y,r),s.multiplyInPlace(r),ve.RotationAxisToRef(nf._Forward,i.z,r),s.multiplyInPlace(r),Te.FromQuaternionToRef(s,e),n.prevAngle.copyFrom(i),ve.FromRotationMatrixToRef(e,m)}m.multiplyToRef(ve.InverseToRef(g,nf._InversedAnimatedRotation),r.ikRotation),r.updateLocalMatrix(),r.updateWorldMatrix()}}static _IkPosition3=new me;static _TargetPosition3=new me;static _InversedChain2=new Te;static _ChainIkPosition=new me;static _ChainTargetPosition=new me;static _Rotation2=new ve;static _TargetVector=new me;static _InversedAnimatedRotation2=new ve;_solvePlane(e,t,i){let s,n,r;switch(i){case 0:s=t.minimumAngle.x,n=t.maximumAngle.x,r=nf._Right;break;case 1:s=t.minimumAngle.y,n=t.maximumAngle.y,r=nf._Up;break;case 2:s=t.minimumAngle.z,n=t.maximumAngle.z,r=nf._Forward;break;default:throw new Error("Invalid solve axis")}const o=this.ikBone.worldMatrix.getTranslationToRef(nf._IkPosition3),a=this.targetBone.worldMatrix.getTranslationToRef(nf._TargetPosition3),l=nf._InversedChain2.copyFrom(t.bone.worldMatrix).invert(),h=me.TransformCoordinatesToRef(o,l,nf._ChainIkPosition),c=me.TransformCoordinatesToRef(a,l,nf._ChainTargetPosition),d=h.normalize(),u=c.normalize();let _=me.Dot(u,d);_=Math.max(-1,Math.min(1,_));let f=Math.acos(_);f=Math.max(-this.limitAngle,Math.min(this.limitAngle,f));const p=ve.RotationAxisToRef(r,f,nf._Rotation2),m=u.applyRotationQuaternionToRef(p,nf._TargetVector),g=me.Dot(m,d),v=ve.RotationAxisToRef(r,-f,nf._Rotation2),T=u.applyRotationQuaternionToRef(v,nf._TargetVector),b=me.Dot(T,d);let E=t.planeModeAngle;if(g>b?E+=f:E-=f,0===e&&(E<s||E>n))if(-E>s&&-E<n)E=-E;else{const e=.5*(s+n);Math.abs(e-E)>Math.abs(e+E)&&(E=-E)}E=Math.max(s,Math.min(n,E)),t.planeModeAngle=E;const S=ve.InverseToRef(t.bone.getAnimatedRotationToRef(nf._InversedAnimatedRotation2),nf._InversedAnimatedRotation2);ve.RotationAxisToRef(r,E,t.bone.ikRotation).multiplyInPlace(S),t.bone.updateLocalMatrix(),t.bone.updateWorldMatrix()}static _TwoPi=2*Math.PI;_normalizeAngle(e){for(;e>=nf._TwoPi;)e-=nf._TwoPi;for(;e<0;)e+=nf._TwoPi;return e}_diffAngle(e,t){const i=this._normalizeAngle(e)-this._normalizeAngle(t);return i>Math.PI?i-nf._TwoPi:i<-Math.PI?i+nf._TwoPi:i}static _Tests=[new me,new me,new me,new me,new me,new me,new me,new me];_decomposeToRef(e,t,i){const s=i,n=-e.m[2];if(Math.abs(1-Math.abs(n))<1e-6){s.y=Math.asin(n);const i=Math.sin(t.x),r=Math.sin(t.z);Math.abs(i)<Math.abs(r)?Math.cos(t.x)>0?(s.x=0,s.z=Math.asin(-e.m[4])):(s.x=Math.PI,s.z=Math.asin(e.m[4])):Math.cos(t.z)>0?(s.z=0,s.x=Math.asin(-e.m[9])):(s.z=Math.PI,s.x=Math.asin(e.m[9]))}else s.x=Math.atan2(e.m[6],e.m[10]),s.y=Math.asin(-e.m[2]),s.z=Math.atan2(e.m[1],e.m[0]);const r=Math.PI,o=nf._Tests;o[0].set(s.x+r,r-s.y,s.z+r),o[1].set(s.x+r,r-s.y,s.z-r),o[2].set(s.x+r,-r-s.y,s.z+r),o[3].set(s.x+r,-r-s.y,s.z-r),o[4].set(s.x-r,r-s.y,s.z+r),o[5].set(s.x-r,r-s.y,s.z-r),o[6].set(s.x-r,-r-s.y,s.z+r),o[7].set(s.x-r,-r-s.y,s.z-r);let a=Math.abs(this._diffAngle(s.x,t.x))+Math.abs(this._diffAngle(s.y,t.y))+Math.abs(this._diffAngle(s.z,t.z));for(let e=0;e<o.length;++e){const i=o[e],n=Math.abs(this._diffAngle(i.x,t.x))+Math.abs(this._diffAngle(i.y,t.y))+Math.abs(this._diffAngle(i.z,t.z));n<a&&(a=n,s.copyFrom(i))}return s}}class rf{_logger;_morphTargetManager;_runtimeBones;_materials;_morphs;_morphIndexMap;_morphWeights;_activeMorphs;constructor(e,t,i,s,n,r){if(this._logger=r,this._morphTargetManager=e,this._runtimeBones=t,null!==i&&null!==s){const e=i.subMaterials,t=this._materials=new Array(e.length);for(let i=0;i<e.length;++i){const n=e[i];t[i]=null!==n?new s(n):void 0}}else this._materials=[];const o=this._morphs=this._createRuntimeMorphData(n),a=this._morphIndexMap=new Map;for(let e=0;e<o.length;++e){const t=o[e];let i=a.get(t.name);void 0===i&&(i=[],a.set(t.name,i)),i.push(e)}this._morphWeights=new Float32Array(o.length),this._activeMorphs=new Set}setMorphWeight(e,t){const i=this._morphIndexMap.get(e);if(void 0===i)return;const s=this._morphWeights;for(let e=0;e<i.length;++e)s[i[e]]=t;0!==t&&this._activeMorphs.add(e)}getMorphWeight(e){const t=this._morphIndexMap.get(e);return void 0===t?0:this._morphWeights[t[0]]}getMorphIndices(e){const t=this._morphIndexMap.get(e);if(void 0!==t)return t}setMorphWeightFromIndex(e,t){this._morphWeights[e]=t,0!==t&&this._activeMorphs.add(this._morphs[e].name)}getMorphWeightFromIndex(e){return this._morphWeights[e]}resetMorphWeights(){this._morphWeights.fill(0)}_updatedMaterials=new Set;update(){const e=this._morphs,t=this._morphIndexMap,i=this._morphWeights,s=this._activeMorphs;for(const i of s){const s=t.get(i);for(let t=0;t<s.length;++t)this._resetMorph(e[s[t]])}for(const n of s){const r=t.get(n);for(let t=0;t<r.length;++t){const o=r[t],a=i[o];this._applyMorph(e[o],a),0===a&&s.delete(n)}}const n=this._updatedMaterials;for(const e of n)e.applyChanges();n.clear()}get morphs(){return this._morphs}_createRuntimeMorphData(e){const t=[];for(let i=0;i<e.length;++i){const s=e[i];let n=null,r=null,o=null,a=null;switch(s.type){case Uh.Morph.Type.GroupMorph:r=s.indices,o=s.ratios;break;case Uh.Morph.Type.BoneMorph:r=s.indices,o=s.positions,a=s.rotations;break;case Uh.Morph.Type.MaterialMorph:{const e=s.elements,t=new Array(e.length);for(let i=0;i<e.length;++i){const s=e[i];s.type===Uh.Morph.MaterialMorph.Type.Multiply?t[i]={index:s.index,type:s.type,diffuse:1!==s.diffuse[0]||1!==s.diffuse[1]||1!==s.diffuse[2]||1!==s.diffuse[3]?s.diffuse:null,specular:1!==s.specular[0]||1!==s.specular[1]||1!==s.specular[2]?s.specular:null,shininess:1!==s.shininess?s.shininess:null,ambient:1!==s.ambient[0]||1!==s.ambient[1]||1!==s.ambient[2]?s.ambient:null,edgeColor:1!==s.edgeColor[0]||1!==s.edgeColor[1]||1!==s.edgeColor[2]||1!==s.edgeColor[3]?s.edgeColor:null,edgeSize:1!==s.edgeSize?s.edgeSize:null,textureColor:1!==s.textureColor[0]||1!==s.textureColor[1]||1!==s.textureColor[2]||1!==s.textureColor[3]?s.textureColor:null,sphereTextureColor:1!==s.sphereTextureColor[0]||1!==s.sphereTextureColor[1]||1!==s.sphereTextureColor[2]||1!==s.sphereTextureColor[3]?s.sphereTextureColor:null,toonTextureColor:1!==s.toonTextureColor[0]||1!==s.toonTextureColor[1]||1!==s.toonTextureColor[2]||1!==s.toonTextureColor[3]?s.toonTextureColor:null}:t[i]={index:s.index,type:s.type,diffuse:0!==s.diffuse[0]||0!==s.diffuse[1]||0!==s.diffuse[2]||0!==s.diffuse[3]?s.diffuse:null,specular:0!==s.specular[0]||0!==s.specular[1]||0!==s.specular[2]?s.specular:null,shininess:0!==s.shininess?s.shininess:null,ambient:0!==s.ambient[0]||0!==s.ambient[1]||0!==s.ambient[2]?s.ambient:null,edgeColor:0!==s.edgeColor[0]||0!==s.edgeColor[1]||0!==s.edgeColor[2]||0!==s.edgeColor[3]?s.edgeColor:null,edgeSize:0!==s.edgeSize?s.edgeSize:null,textureColor:0!==s.textureColor[0]||0!==s.textureColor[1]||0!==s.textureColor[2]||0!==s.textureColor[3]?s.textureColor:null,sphereTextureColor:0!==s.sphereTextureColor[0]||0!==s.sphereTextureColor[1]||0!==s.sphereTextureColor[2]||0!==s.sphereTextureColor[3]?s.sphereTextureColor:null,toonTextureColor:0!==s.toonTextureColor[0]||0!==s.toonTextureColor[1]||0!==s.toonTextureColor[2]||0!==s.toonTextureColor[3]?s.toonTextureColor:null}}n=t}break;case Uh.Morph.Type.UvMorph:case Uh.Morph.Type.VertexMorph:r=s.index;break;default:throw new Error(`Unknown morph type: ${s.type}`)}const l={name:s.name,type:s.type,materialElements:n,elements:r,elements2:o,elements3:a};t.push(l)}{const e=[],i=s=>{const n=t[s];if(n.type!==Uh.Morph.Type.GroupMorph)return;const r=n.elements;for(let o=0;o<r.length;++o){const a=r[o];e.includes(a)?(this._logger.warn(`Looping group morph detected resolves to -1: ${n.name} -> ${t[a].name}`),r[o]=-1):0<=a&&a<t.length&&(e.push(s),i(a),e.pop())}};for(let s=0;s<t.length;++s)e.push(s),i(s),e.length=0}return t}_groupMorphFlatForeach(e,t,i=1){const s=this._morphs,n=e.elements,r=e.elements2;for(let e=0;e<n.length;++e){const o=n[e],a=r[e],l=s[o];l.type===Uh.Morph.Type.GroupMorph?this._groupMorphFlatForeach(l,t,a*i):t(o,a*i)}}_resetMorph(e){switch(e.type){case Uh.Morph.Type.GroupMorph:{const t=this._morphs;this._groupMorphFlatForeach(e,((e,i)=>{const s=t[e];void 0!==s&&this._resetMorph(s)}))}break;case Uh.Morph.Type.BoneMorph:{const t=this._runtimeBones,i=e.elements;for(let e=0;e<i.length;++e){const s=t[i[e]];void 0!==s&&(s.morphPositionOffset.set(0,0,0),s.morphRotationOffset.set(0,0,0,1),s.disableMorph())}}break;case Uh.Morph.Type.MaterialMorph:{const t=e.materialElements;for(let e=0;e<t.length;++e){const i=t[e],s=this._materials;if(-1===i.index)for(let e=0;e<s.length;++e)s[e]?.reset();else s[i.index]?.reset()}}break;case Uh.Morph.Type.VertexMorph:case Uh.Morph.Type.UvMorph:null!==this._morphTargetManager&&(this._morphTargetManager.getTarget(e.elements).influence=0)}}_tempQuaternion=new ve;_applyMorph(e,t){switch(e.type){case Uh.Morph.Type.GroupMorph:{const i=this._morphs;this._groupMorphFlatForeach(e,((e,s)=>{const n=i[e];void 0!==n&&this._applyMorph(n,t*s)}))}break;case Uh.Morph.Type.BoneMorph:{const i=this._runtimeBones,s=e.elements,n=e.elements2,r=e.elements3;for(let e=0;e<s.length;++e){const o=i[s[e]];void 0!==o&&(o.morphPositionOffset.addInPlaceFromFloats(n[3*e+0]*t,n[3*e+1]*t,n[3*e+2]*t),ve.SlerpToRef(o.morphRotationOffset,this._tempQuaternion.copyFromFloats(r[4*e+0],r[4*e+1],r[4*e+2],r[4*e+3]),t,o.morphRotationOffset),0!==t&&o.enableMorph())}}break;case Uh.Morph.Type.MaterialMorph:{const i=e.materialElements;for(let e=0;e<i.length;++e){const s=i[e],n=this._materials;if(-1===s.index)for(let e=0;e<n.length;++e){const i=n[e];void 0!==i&&this._applyMaterialMorph(s,i,t)}else{const e=n[s.index];void 0!==e&&this._applyMaterialMorph(s,e,t)}}}break;case Uh.Morph.Type.VertexMorph:case Uh.Morph.Type.UvMorph:null!==this._morphTargetManager&&(this._morphTargetManager.getTarget(e.elements).influence+=t)}}_applyMaterialMorph(e,t,i){if(e.type===Uh.Morph.MaterialMorph.Type.Multiply){if(null!==e.diffuse){const s=t.diffuse;for(let t=0;t<4;++t)s[t]=s[t]+(s[t]*e.diffuse[t]-s[t])*i}if(null!==e.specular){const s=t.specular;for(let t=0;t<3;++t)s[t]=s[t]+(s[t]*e.specular[t]-s[t])*i}if(null!==e.shininess&&(t.shininess=t.shininess+(t.shininess*e.shininess-t.shininess)*i),null!==e.ambient){const s=t.ambient;for(let t=0;t<3;++t)s[t]=s[t]+(s[t]*e.ambient[t]-s[t])*i}if(null!==e.edgeColor){const s=t.edgeColor;for(let t=0;t<4;++t)s[t]=s[t]+(s[t]*e.edgeColor[t]-s[t])*i}if(null!==e.edgeSize&&(t.edgeSize=t.edgeSize+(t.edgeSize*e.edgeSize-t.edgeSize)*i),null!==e.textureColor){const s=t.textureColor;for(let t=0;t<4;++t)s[t]=s[t]+(s[t]*e.textureColor[t]-s[t])*i}if(null!==e.sphereTextureColor){const s=t.sphereTextureColor;for(let t=0;t<4;++t)s[t]=s[t]+(s[t]*e.sphereTextureColor[t]-s[t])*i}if(null!==e.toonTextureColor){const s=t.toonTextureColor;for(let t=0;t<4;++t)s[t]=s[t]+(s[t]*e.toonTextureColor[t]-s[t])*i}}else{if(null!==e.diffuse){const s=t.diffuse;for(let t=0;t<4;++t)s[t]+=e.diffuse[t]*i}if(null!==e.specular){const s=t.specular;for(let t=0;t<3;++t)s[t]+=e.specular[t]*i}if(null!==e.shininess&&(t.shininess+=e.shininess*i),null!==e.ambient){const s=t.ambient;for(let t=0;t<3;++t)s[t]+=e.ambient[t]*i}if(null!==e.edgeColor){const s=t.edgeColor;for(let t=0;t<4;++t)s[t]+=e.edgeColor[t]*i}if(null!==e.edgeSize&&(t.edgeSize+=e.edgeSize*i),null!==e.textureColor){const s=t.textureColor;for(let t=0;t<4;++t)s[t]+=e.textureColor[t]*i}if(null!==e.sphereTextureColor){const s=t.sphereTextureColor;for(let t=0;t<4;++t)s[t]+=e.sphereTextureColor[t]*i}if(null!==e.toonTextureColor){const s=t.toonTextureColor;for(let t=0;t<4;++t)s[t]+=e.toonTextureColor[t]*i}}this._updatedMaterials.add(t)}}class of{linkedBone;name;parentBone;childBones;transformOrder;flag;transformAfterPhysics;appendTransformSolver;ikSolver;morphPositionOffset;morphRotationOffset;ikRotation;localMatrix;worldMatrix;getAnimatedPositionToRef;getAnimatedRotationToRef;getAnimationPositionOffsetToRef;constructor(e,t){this.linkedBone=e,this.name=t.name,this.parentBone=null,this.childBones=[],this.transformOrder=t.transformOrder,this.flag=t.flag,this.transformAfterPhysics=0!=(t.flag&Uh.Bone.Flag.TransformAfterPhysics),this.appendTransformSolver=null,this.ikSolver=null,this.morphPositionOffset=me.Zero(),this.morphRotationOffset=ve.Identity(),this.ikRotation=null,this.localMatrix=Te.Identity(),this.worldMatrix=e.getFinalMatrix(),this.getAnimatedPositionToRef=this._getAnimatedPositionToRef,this.getAnimatedRotationToRef=this._getAnimatedRotationToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetToRef}_getAnimatedPositionWithMorphToRef(e){return e.copyFrom(this.linkedBone.position),e.addInPlace(this.morphPositionOffset)}_getAnimatedPositionToRef(e){return e.copyFrom(this.linkedBone.position),e}_getAnimatedRotationToRef(e){return e.copyFrom(this.linkedBone.rotationQuaternion)}_getAnimatedRotationWithMorphToRef(e){return e.copyFrom(this.linkedBone.rotationQuaternion),e.multiplyInPlace(this.morphRotationOffset)}static _TempVector3=new me;_getAnimationPositionOffsetToRef(e){return e.copyFrom(this.linkedBone.position),this.linkedBone.getRestMatrix().getTranslationToRef(of._TempVector3),e.subtractInPlace(of._TempVector3)}_getAnimationPositionOffsetWithMorphToRef(e){return e.copyFrom(this.linkedBone.position),e.addInPlace(this.morphPositionOffset),this.linkedBone.getRestMatrix().getTranslationToRef(of._TempVector3),e.subtractInPlace(of._TempVector3)}enableMorph(){this.getAnimatedPositionToRef=this._getAnimatedPositionWithMorphToRef,this.getAnimatedRotationToRef=this._getAnimatedRotationWithMorphToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetWithMorphToRef}disableMorph(){this.getAnimatedPositionToRef=this._getAnimatedPositionToRef,this.getAnimatedRotationToRef=this._getAnimatedRotationToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetToRef}static _TempRotation=ve.Identity();static _TempPosition=me.Zero();updateLocalMatrix(){const e=this.getAnimatedRotationToRef(of._TempRotation);null!==this.ikRotation&&this.ikRotation.multiplyToRef(e,e);const t=this.getAnimatedPositionToRef(of._TempPosition);null!==this.appendTransformSolver&&(this.appendTransformSolver.affectRotation&&e.multiplyInPlace(this.appendTransformSolver.appendRotationOffset),this.appendTransformSolver.affectPosition&&t.addInPlace(this.appendTransformSolver.appendPositionOffset)),Te.ComposeToRef(this.linkedBone.scaling,e,t,this.localMatrix)}static _Stack=[];updateWorldMatrix(){const e=of._Stack;for(e.length=0,e.push(this);e.length>0;){const t=e.pop(),i=t.parentBone;null!==i?t.localMatrix.multiplyToRef(i.worldMatrix,t.worldMatrix):t.worldMatrix.copyFrom(t.localMatrix);const s=t.childBones;for(let t=0,i=s.length;t<i;++t)e.push(s[t])}}}class af{mesh;skeleton;morph;_physicsModel;_logger;_sortedRuntimeBones;_sortedRuntimeRootBones;onCurrentAnimationChangedObservable;_animations;_animationIndexMap;_currentAnimation;constructor(e,t,i,n,r){this._logger=r;const o=e.metadata,a=e;a.metadata={isRuntimeMmdModel:!0,header:e.metadata.header},this.mesh=a,this.skeleton=t,t.prepare(),this._disableSkeletonWorldMatrixUpdate(t);const l=this._buildRuntimeSkeleton(t.bones,o.bones),h=this._sortedRuntimeBones=[...l];h.sort(((e,t)=>e.transformOrder-t.transformOrder));const c=[];for(let e=0;e<h.length;++e){const t=h[e];null===t.parentBone&&c.push(t)}if(this._sortedRuntimeRootBones=c,this.morph=new rf(e.morphTargetManager,l,void 0!==e.material.subMaterials?e.material:null,i,o.morphs,r),null!==n){for(let e=0;e<h.length;++e)h[e].updateLocalMatrix();for(let e=0;e<c.length;++e)c[e].updateWorldMatrix();this._physicsModel=n.buildPhysics(e,l,o.rigidBodies,o.joints,r)}else this._physicsModel=null;this.onCurrentAnimationChangedObservable=new s,this._animations=[],this._animationIndexMap=new Map,this._currentAnimation=null}dispose(){this._enableSkeletonWorldMatrixUpdate(),this._physicsModel?.dispose(),this.onCurrentAnimationChangedObservable.clear(),this.mesh.metadata=null}get sortedRuntimeBones(){return this._sortedRuntimeBones}addAnimation(e,t){let i;if(void 0===e.createRuntimeModelAnimation)throw new Error('animation is not MmdAnimation or MmdModelAnimationGroup or MmdCompositeAnimation. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimationGroup" or "babylon-mmd/esm/Runtime/Animation/mmdCompositeRuntimeModelAnimation"?');i=e.createRuntimeModelAnimation(this,t,this._logger),this._animationIndexMap.set(e.name,this._animations.length),this._animations.push(i)}removeAnimation(e){const t=this._animations[e];this._currentAnimation===t&&(this._currentAnimation=null,this._resetPose(),this.onCurrentAnimationChangedObservable.notifyObservers(null)),this._animationIndexMap.delete(t.animation.name),this._animations.splice(e,1),t.dispose?.()}setAnimation(e){if(null===e)return void(null!==this._currentAnimation&&(this._currentAnimation=null,this._resetPose(),this.onCurrentAnimationChangedObservable.notifyObservers(null)));const t=this._animationIndexMap.get(e);if(void 0===t)throw new Error(`Animation '${e}' is not found.`);null!==this._currentAnimation&&this._resetPose();const i=this._currentAnimation=this._animations[t];i.induceMaterialRecompile(this._logger),this.onCurrentAnimationChangedObservable.notifyObservers(i)}get runtimeAnimations(){return this._animations}get currentAnimation(){return this._currentAnimation}resetState(){this.morph.resetMorphWeights();const e=this._sortedRuntimeBones;for(let t=0;t<e.length;++t){const i=e[t];null!==i.ikSolver&&(i.ikSolver.enabled=!0)}}initializePhysics(){this._physicsModel?.initialize()}beforePhysics(e){null!==e&&null!==this._currentAnimation&&this._currentAnimation.animate(e),this.morph.update(),this._update(!1),this._physicsModel?.syncBodies()}afterPhysics(){const e=this._physicsModel;null!==e&&e.syncBones(),this._update(!0),this.mesh.skeleton._markAsDirty()}_update(e){const t=this._sortedRuntimeBones;for(let i=0;i<t.length;++i){const s=t[i];s.transformAfterPhysics===e&&s.updateLocalMatrix()}const i=this._sortedRuntimeRootBones;for(let t=0;t<i.length;++t){const s=i[t];s.transformAfterPhysics===e&&s.updateWorldMatrix()}for(let i=0;i<t.length;++i){const s=t[i];s.transformAfterPhysics===e&&(null!==s.appendTransformSolver&&(s.appendTransformSolver.update(),s.updateLocalMatrix(),s.updateWorldMatrix()),null!==s.ikSolver&&(s.ikSolver.solve(),s.ikSolver.enabled&&s.updateWorldMatrix()))}for(let t=0;t<i.length;++t){const s=i[t];s.transformAfterPhysics===e&&s.updateWorldMatrix()}}_buildRuntimeSkeleton(e,t){const i=[];for(let s=0;s<t.length;++s){const n=t[s];i.push(new of(e[s],n))}for(let e=0;e<t.length;++e){const s=t[e],n=i[e],r=s.parentBoneIndex;if(0<=r&&r<i.length){const e=i[r];n.parentBone=e,e.childBones.push(n)}if(void 0!==s.appendTransform){const e=s.appendTransform.parentIndex;0<=e&&e<i.length?n.appendTransformSolver=new tf(s.flag,s.appendTransform,i[e]):this._logger.error(`Invalid append transform target bone index: ${e}`)}if(void 0!==s.ik){const e=s.ik,t=e.target;if(0<=t&&t<i.length){const s=n.ikSolver=new nf(n,i[t]);s.iteration=e.iteration,s.limitAngle=e.rotationConstraint;for(let t=0;t<e.links.length;++t){const n=e.links[t],r=n.target;if(0<=r&&r<i.length){const e=i[r];s.addIkChain(e,n.limitation?.minimumAngle?me.FromArray(n.limitation.minimumAngle):null,n.limitation?.maximumAngle?me.FromArray(n.limitation.maximumAngle):null)}else this._logger.error(`Invalid IK link bone index: ${r}`)}}else this._logger.error(`Invalid IK target bone index: ${t}`)}}return i}_originalComputeTransformMatrices=null;_disableSkeletonWorldMatrixUpdate(e){null===this._originalComputeTransformMatrices&&(this._originalComputeTransformMatrices=e._computeTransformMatrices,e._computeTransformMatrices=function(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let t=0;t<this.bones.length;t++){const i=this.bones[t];if(i._childUpdateId+=1,-1!==i._index){const s=null===i._index?t:i._index;i.getAbsoluteInverseBindMatrix().multiplyToArray(i.getFinalMatrix(),e,16*s)}}this._identity.copyToArray(e,16*this.bones.length)})}_enableSkeletonWorldMatrixUpdate(){null!==this._originalComputeTransformMatrices&&(this.skeleton._computeTransformMatrices=this._originalComputeTransformMatrices,this._originalComputeTransformMatrices=null)}_resetPose(){const e=this._sortedRuntimeBones,t=new me,i=ve.Identity();for(let s=0;s<e.length;++s){const n=e[s].linkedBone;n.getRestMatrix().getTranslationToRef(t),n.position=t,n.setRotationQuaternion(i,Js.LOCAL)}this.mesh.skeleton._markAsDirty()}}class lf{diffuse;specular;shininess;ambient;edgeColor;edgeSize;textureColor;sphereTextureColor;toonTextureColor;_material;_initialDiffuse;_initialSpecular;_initialShininess;_initialAmbient;_initialEdgeColor;_initialEdgeSize;_initialTextureColor;_initialSphereTextureColor;_initialToonTextureColor;_initialTransparencyMode;_initialBackFaceCulling;constructor(e){this._material=e;const t=e.diffuseColor;this.diffuse=[t.r,t.g,t.b,e.alpha];const i=e.specularColor;this.specular=[i.r,i.g,i.b],this.shininess=e.specularPower;const s=e.ambientColor;this.ambient=[s.r,s.g,s.b];const n=e.outlineColor;this.edgeColor=[n.r,n.g,n.b,e.outlineAlpha],this.edgeSize=e.outlineWidth/Xh.EdgeSizeScaleFactor,this.textureColor=[1,1,1,1],this.sphereTextureColor=[1,1,1,1],this.toonTextureColor=[1,1,1,1],this._initialDiffuse=[...this.diffuse],this._initialSpecular=[...this.specular],this._initialShininess=this.shininess,this._initialAmbient=[...this.ambient],this._initialEdgeColor=[...this.edgeColor],this._initialEdgeSize=this.edgeSize,this._initialTextureColor=[...this.textureColor],this._initialSphereTextureColor=[...this.sphereTextureColor],this._initialToonTextureColor=[...this.toonTextureColor],this._initialTransparencyMode=e.transparencyMode,this._initialBackFaceCulling=e.backFaceCulling}reset(){for(let e=0;e<4;++e)this.diffuse[e]=this._initialDiffuse[e],this.edgeColor[e]=this._initialEdgeColor[e],this.textureColor[e]=this._initialTextureColor[e],this.sphereTextureColor[e]=this._initialSphereTextureColor[e],this.toonTextureColor[e]=this._initialToonTextureColor[e];for(let e=0;e<3;++e)this.specular[e]=this._initialSpecular[e],this.ambient[e]=this._initialAmbient[e];this.shininess=this._initialShininess,this.edgeSize=this._initialEdgeSize}applyChanges(){const e=this._material;e.diffuseColor.set(this.diffuse[0],this.diffuse[1],this.diffuse[2]),e.alpha=this.diffuse[3],1===this.diffuse[3]?(e.transparencyMode=this._initialTransparencyMode,e.backFaceCulling=this._initialBackFaceCulling):(e.transparencyMode=Ps.MATERIAL_ALPHABLEND,e.backFaceCulling=!1),e.specularColor.set(this.specular[0],this.specular[1],this.specular[2]),e.specularPower=this.shininess,e.ambientColor.set(this.ambient[0],this.ambient[1],this.ambient[2]),e.outlineColor.set(this.edgeColor[0],this.edgeColor[1],this.edgeColor[2]),e.outlineAlpha=this.edgeColor[3],e.outlineWidth=this.edgeSize*Xh.EdgeSizeScaleFactor,e.textureColor.set(this.textureColor[0],this.textureColor[1],this.textureColor[2],this.textureColor[3]),e.sphereTextureColor.set(this.sphereTextureColor[0],this.sphereTextureColor[1],this.sphereTextureColor[2],this.sphereTextureColor[3]),e.toonTextureColor.set(this.toonTextureColor[0],this.toonTextureColor[1],this.toonTextureColor[2],this.toonTextureColor[3])}}class hf{_physics;_models;_camera;_audioPlayer;_loggingEnabled;log;warn;error;_isRegistered;onAnimationDurationChangedObservable;onPlayAnimationObservable;onPauseAnimationObservable;onSeekAnimationObservable;onAnimationTickObservable;_currentFrameTime;_animationTimeScale;_animationPaused;_animationFrameTimeDuration;_useManualAnimationDuration;_needToInitializePhysicsModels;_beforePhysicsBinded;_afterPhysicsBinded;constructor(e=null){this._physics=e,this._models=[],this._camera=null,this._audioPlayer=null,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._isRegistered=!1,this.onAnimationDurationChangedObservable=new s,this.onPlayAnimationObservable=new s,this.onPauseAnimationObservable=new s,this.onSeekAnimationObservable=new s,this.onAnimationTickObservable=new s,this._currentFrameTime=0,this._animationTimeScale=1,this._animationPaused=!0,this._animationFrameTimeDuration=0,this._useManualAnimationDuration=!1,this._needToInitializePhysicsModels=new Set,this._beforePhysicsBinded=null,this._afterPhysicsBinded=this.afterPhysics.bind(this)}createMmdModel(e,t={}){if(!Z_.isMmdMesh(e))throw new Error("Mesh validation failed.");void 0===t.materialProxyConstructor&&(t.materialProxyConstructor=lf),void 0===t.buildPhysics&&(t.buildPhysics=!0);const i=new af(e,e.skeleton,t.materialProxyConstructor,t.buildPhysics?this._physics:null,this);return this._models.push(i),this._needToInitializePhysicsModels.add(i),i.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),i}addMmdModelInternal(e){this._models.push(e),this._needToInitializePhysicsModels.add(e),e.onCurrentAnimationChangedObservable.add(this._onAnimationChanged)}destroyMmdModel(e){e.dispose();const t=this._models,i=t.indexOf(e);if(i<0)throw new Error("Model not found.");t.splice(i,1)}setCamera(e){null!==this._camera&&this._camera.onCurrentAnimationChangedObservable.removeCallback(this._onAnimationChanged),null!==e&&e.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),this._camera=e}_setAudioPlayerLastValue=null;async setAudioPlayer(e){if(this._audioPlayer!==e&&(this._setAudioPlayerLastValue=e,null!==this._audioPlayer&&(this._audioPlayer.onDurationChangedObservable.removeCallback(this._onAudioDurationChanged),this._audioPlayer.onPlaybackRateChangedObservable.removeCallback(this._onAudioPlaybackRateChanged),this._audioPlayer.onPlayObservable.removeCallback(this._onAudioPlay),this._audioPlayer.onPauseObservable.removeCallback(this._onAudioPause),this._audioPlayer.onSeekObservable.removeCallback(this._onAudioSeek),this._audioPlayer.pause()),this._audioPlayer=null,null!==e)){if(!this._animationPaused){const t=30*e.duration;if(this._currentFrameTime<t&&(e.currentTime=this._currentFrameTime/30,await e.play(),this._setAudioPlayerLastValue!==e))return void e.pause()}this._audioPlayer=e,this._onAudioDurationChanged(),e.onDurationChangedObservable.add(this._onAudioDurationChanged),e.onPlaybackRateChangedObservable.add(this._onAudioPlaybackRateChanged),e.onPlayObservable.add(this._onAudioPlay),e.onPauseObservable.add(this._onAudioPause),e.onSeekObservable.add(this._onAudioSeek),e._setPlaybackRateWithoutNotify(this._animationTimeScale)}}register(e){this._isRegistered||(this._isRegistered=!0,this._beforePhysicsBinded=()=>this.beforePhysics(e.getEngine().getDeltaTime()),e.onBeforeAnimationsObservable.add(this._beforePhysicsBinded),e.onBeforeRenderObservable.add(this._afterPhysicsBinded))}unregister(e){this._isRegistered&&(this._isRegistered=!1,e.onBeforeAnimationsObservable.removeCallback(this._beforePhysicsBinded),e.onBeforeRenderObservable.removeCallback(this._afterPhysicsBinded),this._beforePhysicsBinded=null)}beforePhysics(e){if(this._animationPaused){const e=this._models;for(let t=0;t<e.length;++t)e[t].beforePhysics(null)}else{if(null===this._audioPlayer||this._audioPlayer.paused)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else{const t=this._audioPlayer.currentTime,i=t-this._currentFrameTime/30,s=Math.abs(i);if(s<.05)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else if(s<.5)this._currentFrameTime+=i<0?e/1e3*30*this._animationTimeScale*.9:e/1e3*30*this._animationTimeScale*1.1;else{if(60<Math.abs(t-this._currentFrameTime)){const e=this._needToInitializePhysicsModels;for(let t=0;t<this._models.length;++t){const i=this._models[t];null!==i.currentAnimation&&e.add(i)}}this._currentFrameTime=30*t}}const t=this._currentFrameTime;this._animationFrameTimeDuration<=t&&(this._animationPaused=!0,this._currentFrameTime=this._animationFrameTimeDuration,null===this._audioPlayer||this._audioPlayer.paused?this.onPauseAnimationObservable.notifyObservers():this._audioPlayer.pause());const i=this._models;for(let e=0;e<i.length;++e)i[e].beforePhysics(t);null!==this._camera&&this._camera.animate(t),this.onAnimationTickObservable.notifyObservers()}const t=this._needToInitializePhysicsModels;for(const e of t)e.initializePhysics();t.clear()}afterPhysics(){const e=this._models;for(let t=0;t<e.length;++t)e[t].afterPhysics()}_onAnimationChanged=e=>{if(this._useManualAnimationDuration)return;const t=e?.animation.endFrame??0;this._animationFrameTimeDuration<t?this._animationFrameTimeDuration=t:t<this._animationFrameTimeDuration&&(this._animationFrameTimeDuration=this._computeAnimationDuration()),this.onAnimationDurationChangedObservable.notifyObservers()};_computeAnimationDuration(){if(0===this._models.length&&null===this._camera&&(null===this._audioPlayer||!this._audioPlayer.metadataLoaded))return 1/0;let e=0;const t=this._models;for(let i=0;i<t.length;++i){const s=t[i];null!==s.currentAnimation&&(e=Math.max(e,s.currentAnimation.animation.endFrame))}return null!==this._camera&&null!==this._camera.currentAnimation&&(e=Math.max(e,this._camera.currentAnimation.animation.endFrame)),null!==this._audioPlayer&&(e=Math.max(e,30*this._audioPlayer.duration)),e}_onAudioDurationChanged=()=>{if(!this._animationPaused){const e=this._audioPlayer,t=this._currentFrameTime/30;t<e.duration&&(e._setCurrentTimeWithoutNotify(t),e.play().then((()=>{this._setAudioPlayerLastValue===e||e.pause()})))}if(this._useManualAnimationDuration)return;const e=30*this._audioPlayer.duration;this._animationFrameTimeDuration<e?this._animationFrameTimeDuration=e:this._animationFrameTimeDuration=this._computeAnimationDuration(),this.onAnimationDurationChangedObservable.notifyObservers()};_onAudioPlaybackRateChanged=()=>{this._animationTimeScale=this._audioPlayer.playbackRate};_onAudioPlay=()=>{this._playAnimationInternal()};_onAudioPause=()=>{this._audioPlayer.currentTime!==this._audioPlayer.duration&&(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers())};_onAudioSeek=()=>{this._seekAnimationInternal(30*this._audioPlayer.currentTime,this._animationPaused)};_playAnimationInternal(){if(this._animationPaused){if(this._animationPaused=!1,!this._useManualAnimationDuration&&0===this._currentFrameTime){const e=this._models;for(let t=0;t<this._models.length;++t){const i=e[t];i.resetState(),this._needToInitializePhysicsModels.add(i)}this._animationFrameTimeDuration=this._computeAnimationDuration(),this.onAnimationDurationChangedObservable.notifyObservers()}this.onPlayAnimationObservable.notifyObservers()}}async playAnimation(){if(null!==this._audioPlayer&&this._currentFrameTime<30*this._audioPlayer.duration)try{const e=this._currentFrameTime/30;.05<Math.abs(this._audioPlayer.currentTime-e)&&this._audioPlayer._setCurrentTimeWithoutNotify(e),await this._audioPlayer.play()}catch(e){if(!(e instanceof DOMException&&"NotSupportedError"===e.name))throw e;this.error("Failed to play audio."),this._playAnimationInternal()}else this._playAnimationInternal()}pauseAnimation(){null===this._audioPlayer||this._audioPlayer.paused?(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers()):(this._audioPlayer.pause(),this._animationPaused=!0)}_seekAnimationInternal(e,t){if(60<Math.abs(e-this._currentFrameTime)){const e=this._needToInitializePhysicsModels;for(let t=0;t<this._models.length;++t){const i=this._models[t];null!==i.currentAnimation&&e.add(i)}}if(this._currentFrameTime=e,t){const t=this._models;for(let i=0;i<t.length;++i){const s=t[i];null!==s.currentAnimation&&s.currentAnimation.animate(e)}null!==this._camera&&null!==this._camera.currentAnimation&&this._camera.animate(e),this.onAnimationTickObservable.notifyObservers()}this.onSeekAnimationObservable.notifyObservers()}async seekAnimation(e,t=!1){if(e=Math.max(0,Math.min(e,this._animationFrameTimeDuration)),null!==this._audioPlayer)if(this._audioPlayer.paused)if(!this._animationPaused&&30*this._audioPlayer.currentTime<this._animationFrameTimeDuration&&e<30*this._audioPlayer.duration)try{this._audioPlayer._setCurrentTimeWithoutNotify(e/30),await this._audioPlayer.play()}catch(i){if(!(i instanceof DOMException&&"NotSupportedError"===i.name))throw i;this.error("Failed to play audio."),this._seekAnimationInternal(e,t)}else this._seekAnimationInternal(e,t),this._audioPlayer?._setCurrentTimeWithoutNotify(e/30);else this._audioPlayer.currentTime=e/30;else this._seekAnimationInternal(e,t)}get isAnimationPlaying(){return!this._animationPaused}get models(){return this._models}get camera(){return this._camera}get audioPlayer(){return this._audioPlayer}get timeScale(){return this._animationTimeScale}set timeScale(e){this._animationTimeScale=e,null!==this._audioPlayer&&this._audioPlayer._setPlaybackRateWithoutNotify(e)}get currentFrameTime(){return this._currentFrameTime}get currentTime(){return this._currentFrameTime/30}get animationFrameTimeDuration(){return this._animationFrameTimeDuration}get animationDuration(){return this._animationFrameTimeDuration/30}setManualAnimationDuration(e){(null!==e||this._useManualAnimationDuration)&&(null===e?(this._useManualAnimationDuration=!1,this._animationFrameTimeDuration=this._computeAnimationDuration()):(this._useManualAnimationDuration=!0,this._animationFrameTimeDuration=e),this.onAnimationDurationChangedObservable.notifyObservers())}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){p.Log(e)}_logDisabled(){}_warnEnabled(e){p.Warn(e)}_warnDisabled(){}_errorEnabled(e){p.Error(e)}_errorDisabled(){}}!function(e){e[e.Seconds=0]="Seconds",e[e.Frames=1]="Frames"}(ef||(ef={}));class cf{autoHidePlayerControl;hidePlayerControlTimeout;displayTimeFormat;_mmdRuntime;_audioPlayer;_newCanvasContainer;_playerContainer;_hidePlayerControlTimeoutId;_playButton;_timeSlider;_soundButton;_volumeSlider;_currentFrameNumberSpan;_endFrameNumberSpan;_speedSlider;_fullscreenButton;_bindedDispose;_scene;constructor(e,t,i){const s=e.getEngine().getInputElement();if(null===s)throw new Error("Failed to get root element.");this.autoHidePlayerControl=!0,this.hidePlayerControlTimeout=3e3,this.displayTimeFormat=ef.Seconds,this._mmdRuntime=t,this._audioPlayer=i??null;const n=this._newCanvasContainer=this._createCanvasContainer(s.parentElement);this._playerContainer=null,this._hidePlayerControlTimeoutId=void 0,this._playButton=null,this._timeSlider=null,this._soundButton=null,this._volumeSlider=null,this._currentFrameNumberSpan=null,this._endFrameNumberSpan=null,this._speedSlider=null,this._fullscreenButton=null,this._createPlayerControl(n,t,i),t.onPlayAnimationObservable.add(this._onAnimationPlay),t.onPauseAnimationObservable.add(this._onAnimationPause),t.onAnimationDurationChangedObservable.add(this._onAnimationDurationChanged),t.onAnimationTickObservable.add(this._onAnimationTick),i?.onMuteStateChangedObservable.add(this._onMuteStateChanged),this._bindedDispose=this.dispose.bind(this),this._scene=e,e.onDisposeObservable.add(this._bindedDispose)}_createCanvasContainer(e){const t=e.ownerDocument.createElement("div");for(t.style.display=e.style.display;e.childElementCount>0;){const i=e.childNodes[0];e.removeChild(i),t.appendChild(i)}return e.appendChild(t),t.style.width="100%",t.style.height="100%",t.style.overflow="hidden",t}_restoreCanvasContainer(e){const t=this._newCanvasContainer;for(;t.childElementCount>0;){const i=t.childNodes[0];t.removeChild(i),e.appendChild(i)}e.removeChild(t)}_createPlayerControl(e,t,i){const s=e.ownerDocument,n=this._playerContainer=s.createElement("div");n.style.position="relative",n.style.bottom="120px",n.style.left="0",n.style.width="100%",n.style.height="120px",n.style.transform="translateY(50%)",n.style.transition="transform 0.5s",e.appendChild(n),n.onmouseenter=this._onPlayerControlMouseEnter,n.onmouseleave=this._onPlayerControlMouseLeave;{const r=s.createElement("div");r.style.position="absolute",r.style.bottom="0",r.style.left="0",r.style.width="100%",r.style.height="50%",r.style.boxSizing="border-box",r.style.background="linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.6))",r.style.display="flex",r.style.flexDirection="column",n.appendChild(r);{const n=s.createElement("div");n.style.width="100%",n.style.boxSizing="border-box",n.style.display="flex",n.style.flexDirection="row",n.style.alignItems="center",r.appendChild(n);{const e=this._timeSlider=s.createElement("input");e.style.width="100%",e.style.height="4px",e.style.border="none",e.style.opacity="0.5",e.type="range",e.min="0",e.max=t.animationFrameTimeDuration.toString(),e.oninput=i=>{i.preventDefault(),t.seekAnimation(Number(e.value),!0)};{let i=!1;e.onmousedown=()=>{t.isAnimationPlaying&&(t.pauseAnimation(),i=!0)},e.onmouseup=()=>{i&&(t.playAnimation(),i=!1)}}n.appendChild(e)}const o=s.createElement("div");o.style.width="100%",o.style.flexGrow="1",o.style.padding="0 5px",o.style.boxSizing="border-box",o.style.display="flex",o.style.flexDirection="row",o.style.alignItems="space-between",r.appendChild(o);{const n=s.createElement("div");n.style.flex="1",n.style.display="flex",n.style.flexDirection="row",n.style.alignItems="center",o.appendChild(n);{const e=this._playButton=s.createElement("button");if(e.style.width="40px",e.style.border="none",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.color="white",e.style.fontSize="18px",e.innerText=t.isAnimationPlaying?"":"",e.onclick=()=>{t.isAnimationPlaying?t.pauseAnimation():t.playAnimation()},n.appendChild(e),void 0!==i){const e=this._soundButton=s.createElement("button");e.style.width="35px",e.style.border="none",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.color="white",e.style.fontSize="20px",e.innerText=i.muted?"":"",e.onclick=()=>{i.muted?i.unmute():i.mute()},n.appendChild(e);const t=this._volumeSlider=s.createElement("input");t.style.width="80px",t.style.height="4px",t.style.border="none",t.style.opacity="0.5",t.type="range",t.min="0",t.max="1",t.step="0.01",t.value=i.volume.toString(),t.oninput=()=>{i.volume=Number(t.value)},n.appendChild(t)}const r=this._currentFrameNumberSpan=s.createElement("span");r.style.width="40px",r.style.textAlign="right",r.style.color="white",r.innerText=this.displayTimeFormat===ef.Seconds?this._getFormattedTime(t.currentTime):Math.floor(t.currentFrameTime).toString(),n.appendChild(r);const o=this._endFrameNumberSpan=s.createElement("span");o.style.width="50px",o.style.textAlign="left",o.style.color="white",o.innerHTML="&nbsp;/&nbsp;"+(this.displayTimeFormat===ef.Seconds?this._getFormattedTime(t.animationDuration):Math.floor(t.animationFrameTimeDuration).toString()),n.appendChild(o)}const r=s.createElement("div");r.style.flex="1",r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",r.style.justifyContent="flex-end",o.appendChild(r);{const i=s.createElement("label");i.style.width="40px",i.style.textAlign="center",i.style.color="white",i.innerText="1.00x",r.appendChild(i);const n=this._speedSlider=s.createElement("input");n.style.width="80px",n.style.height="4px",n.style.border="none",n.style.opacity="0.5",n.type="range",n.min="0.07",n.max="1",n.step="0.01",n.value=t.timeScale.toString(),n.oninput=()=>{t.timeScale=Number(n.value),i.innerText=t.timeScale.toFixed(2)+"x"},r.appendChild(n);const o=this._fullscreenButton=s.createElement("button");o.style.width="40px",o.style.border="none",o.style.color="white",o.style.backgroundColor="rgba(0, 0, 0, 0)",o.style.fontSize="20px",o.innerText="",o.onclick=()=>{s.fullscreenElement?s.exitFullscreen():e.requestFullscreen()},r.appendChild(o)}}}}}_onPlayerControlMouseEnter=()=>{this.autoHidePlayerControl&&(window.clearTimeout(this._hidePlayerControlTimeoutId),this._hidePlayerControlTimeoutId=void 0,this.showPlayerControl())};_onPlayerControlMouseLeave=()=>{this.autoHidePlayerControl&&(this._hidePlayerControlTimeoutId=window.setTimeout(this.hidePlayerControl.bind(this),this.hidePlayerControlTimeout))};_onAnimationPlay=()=>{this._playButton.innerText=""};_onAnimationPause=()=>{this._playButton.innerText=""};_onAnimationDurationChanged=()=>{const e=this._mmdRuntime;this._timeSlider.max=e.animationFrameTimeDuration.toString(),this._endFrameNumberSpan.innerHTML="&nbsp;/&nbsp;"+(this.displayTimeFormat===ef.Seconds?this._getFormattedTime(e.animationDuration):Math.floor(e.animationFrameTimeDuration).toString())};_onAnimationTick=()=>{const e=this._mmdRuntime;if(this._timeSlider.value=e.currentFrameTime.toString(),this.displayTimeFormat===ef.Seconds){const t=this._getFormattedTime(e.currentTime);this._currentFrameNumberSpan.innerText!==t&&(this._currentFrameNumberSpan.innerText=t)}else this._currentFrameNumberSpan.innerText=Math.floor(e.currentFrameTime).toString()};_onMuteStateChanged=()=>{null!==this._soundButton&&(this._soundButton.innerText=this._audioPlayer.muted?"":"")};_formattedTimeCacheKey=NaN;_formatterTimeCacheValue="";_getFormattedTime(e){const t=Math.floor(e);if(t===this._formattedTimeCacheKey)return this._formatterTimeCacheValue;if(!isFinite(e))return this._formattedTimeCacheKey=t,this._formatterTimeCacheValue="-:--","-:--";const i=Math.floor(e/60),s=Math.floor(e%60),n=i.toString()+":"+(s<10?"0":"")+s.toString();return this._formattedTimeCacheKey=t,this._formatterTimeCacheValue=n,n}hidePlayerControl(){this._playerContainer.style.transform="translateY(50%)",this._hidePlayerControlTimeoutId=void 0}showPlayerControl(){this._playerContainer.style.transform="translateY(0)"}dispose(){null!==this._newCanvasContainer&&(this._restoreCanvasContainer(this._newCanvasContainer.parentElement),this._newCanvasContainer=null,this._playButton.onclick=null,this._timeSlider.oninput=null,this._timeSlider.onmousedown=null,this._timeSlider.onmouseup=null,null!==this._audioPlayer&&(this._soundButton.onclick=null,this._volumeSlider.oninput=null),this._speedSlider.oninput=null,this._fullscreenButton.onclick=null,this._playerContainer.onmouseenter=null,this._playerContainer.onmouseleave=null,this._playerContainer.remove(),this._mmdRuntime.onPlayAnimationObservable.removeCallback(this._onAnimationPlay),this._mmdRuntime.onPauseAnimationObservable.removeCallback(this._onAnimationPause),this._mmdRuntime.onAnimationDurationChangedObservable.removeCallback(this._onAnimationDurationChanged),this._mmdRuntime.onAnimationTickObservable.removeCallback(this._onAnimationTick),this._audioPlayer?.onMuteStateChangedObservable.removeCallback(this._onMuteStateChanged),this._scene.onDisposeObservable.removeCallback(this._bindedDispose))}}const df=JSON.parse('[{"_id":10000027,"name":"Albedo","weaponType":"Sword","element":"Geo","gender":"Male","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Albedo","image":"Genshin/Albedo.png","pmx":".pmx"},{"_id":10000062,"name":"Alhaitham","weaponType":"Sword","element":"Dendro","gender":"Male","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Alhaitham","image":"Genshin/Alhaitham.png","pmx":".pmx"},{"_id":10000002,"name":"Amber","weaponType":"Bow","element":"Pyro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Amber","image":"Genshin/Amber.png","pmx":".pmx"},{"_id":10000043,"name":"Arataki Itto","weaponType":"Claymore","element":"Geo","gender":"Male","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Arataki Itto","image":"Genshin/Arataki Itto.png","pmx":".pmx"},{"_id":10000066,"name":"Baizhu","weaponType":"Catalyst","element":"Dendro","gender":"Male","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Baizhu","image":"Genshin/Baizhu.png","pmx":".pmx"},{"_id":10000003,"name":"Barbara","weaponType":"Catalyst","element":"Hydro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Barbara","image":"Genshin/Barbara.png","pmx":".pmx"},{"_id":10000004,"name":"Beidou","weaponType":"Claymore","element":"Electro","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Beidou","image":"Genshin/Beidou.png","pmx":".pmx"},{"_id":10000005,"name":"Bennett","weaponType":"Sword","element":"Pyro","gender":"Male","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Bennett","image":"Genshin/Bennett.png","pmx":".pmx"},{"_id":10000054,"name":"Candace","weaponType":"Polearm","element":"Hydro","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Candace","image":"Genshin/Candace.png","pmx":".pmx"},{"_id":10000073,"name":"Charlotte","weaponType":"Catalyst","element":"Cryo","gender":"Female","region":"Fontaine","rarity":4,"directory":"res/chars/Genshin/Charlotte","image":"Genshin/Charlotte.png","pmx":".pmx"},{"_id":10000076,"name":"Chevreuse","weaponType":"Polearm","element":"Pyro","gender":"Female","region":"Fontaine","rarity":4,"directory":"res/chars/Genshin/Chevreuse","image":"Genshin/Chevreuse.png","pmx":".pmx"},{"_id":10000006,"name":"Chongyun","weaponType":"Claymore","element":"Cryo","gender":"Male","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Chongyun","image":"Genshin/Chongyun.png","pmx":".pmx"},{"_id":10000051,"name":"Collei","weaponType":"Bow","element":"Dendro","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Collei","image":"Genshin/Collei.png","pmx":".pmx"},{"_id":10000055,"name":"Cyno","weaponType":"Polearm","element":"Electro","gender":"Male","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Cyno","image":"Genshin/Cyno.png","pmx":".pmx"},{"_id":10000063,"name":"Dehya","weaponType":"Claymore","element":"Pyro","gender":"Female","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Dehya","image":"Genshin/Dehya.png","pmx":".pmx"},{"_id":10000016,"name":"Diluc","weaponType":"Claymore","element":"Pyro","gender":"Male","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Diluc","image":"Genshin/Diluc.png","pmx":".pmx"},{"_id":10000023,"name":"Diona","weaponType":"Bow","element":"Cryo","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Diona","image":"Genshin/Diona.png","pmx":".pmx"},{"_id":10000053,"name":"Dori","weaponType":"Claymore","element":"Electro","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Dori","image":"Genshin/Dori.png","pmx":".pmx"},{"_id":10000033,"name":"Eula","weaponType":"Claymore","element":"Cryo","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Eula","image":"Genshin/Eula.png","pmx":".pmx"},{"_id":10000059,"name":"Faruzan","weaponType":"Bow","element":"Anemo","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Faruzan","image":"Genshin/Faruzan.png","pmx":".pmx"},{"_id":10000007,"name":"Fischl","weaponType":"Bow","element":"Electro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Fischl","image":"Genshin/Fischl.png","pmx":".pmx"},{"_id":10000070,"name":"Freminet","weaponType":"Claymore","element":"Cryo","gender":"Male","region":"Fontaine","rarity":4,"directory":"res/chars/Genshin/Freminet","image":"Genshin/Freminet.png","pmx":".pmx"},{"_id":10000074,"name":"Furina","weaponType":"Sword","element":"Hydro","gender":"Female","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Furina","image":"Genshin/Furina.png","pmx":".pmx"},{"_id":10000028,"name":"Ganyu","weaponType":"Bow","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Ganyu","image":"Genshin/Ganyu.png","pmx":".pmx"},{"_id":10000042,"name":"Gorou","weaponType":"Bow","element":"Geo","gender":"Male","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Gorou","image":"Genshin/Gorou.png","pmx":".pmx"},{"_id":10000030,"name":"Hu Tao","weaponType":"Polearm","element":"Pyro","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Hu Tao","image":"Genshin/Hu Tao.png","pmx":".pmx"},{"_id":10000017,"name":"Jean","weaponType":"Sword","element":"Anemo","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Jean","image":"Genshin/Jean.png","pmx":".pmx"},{"_id":10000034,"name":"Kaedehara Kazuha","weaponType":"Sword","element":"Anemo","gender":"Male","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Kaedehara Kazuha","image":"Genshin/Kaedehara Kazuha.png","pmx":".pmx"},{"_id":10000008,"name":"Kaeya","weaponType":"Sword","element":"Cryo","gender":"Male","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Kaeya","image":"Genshin/Kaeya.png","pmx":".pmx"},{"_id":10000035,"name":"Kamisato Ayaka","weaponType":"Sword","element":"Cryo","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Kamisato Ayaka","image":"Genshin/Kamisato Ayaka.png","pmx":".pmx"},{"_id":10000047,"name":"Kamisato Ayato","weaponType":"Sword","element":"Hydro","gender":"Male","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Kamisato Ayato","image":"Genshin/Kamisato Ayato.png","pmx":".pmx"},{"_id":10000065,"name":"Kaveh","weaponType":"Claymore","element":"Dendro","gender":"Male","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Kaveh","image":"Genshin/Kaveh.png","pmx":".pmx"},{"_id":10000018,"name":"Keqing","weaponType":"Sword","element":"Electro","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Keqing","image":"Genshin/Keqing.png","pmx":".pmx"},{"_id":10000067,"name":"Kirara","weaponType":"Sword","element":"Dendro","gender":"Female","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Kirara","image":"Genshin/Kirara.png","pmx":".pmx"},{"_id":10000022,"name":"Klee","weaponType":"Catalyst","element":"Pyro","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Klee","image":"Genshin/Klee.png","pmx":".pmx"},{"_id":10000038,"name":"Kujou Sara","weaponType":"Bow","element":"Electro","gender":"Female","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Kujou Sara","image":"Genshin/Kujou Sara.png","pmx":".pmx"},{"_id":10000049,"name":"Kuki Shinobu","weaponType":"Sword","element":"Electro","gender":"Female","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Kuki Shinobu","image":"Genshin/Kuki Shinobu.png","pmx":".pmx"},{"_id":10000058,"name":"Layla","weaponType":"Sword","element":"Cryo","gender":"Female","region":"Sumeru","rarity":4,"directory":"res/chars/Genshin/Layla","image":"Genshin/Layla.png","pmx":".pmx"},{"_id":10000009,"name":"Lisa","weaponType":"Catalyst","element":"Electro","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Lisa","image":"Genshin/Lisa.png","pmx":".pmx"},{"_id":10000068,"name":"Lynette","weaponType":"Sword","element":"Anemo","gender":"Female","region":"Fontaine","rarity":4,"directory":"res/chars/Genshin/Lynette","image":"Genshin/Lynette.png","pmx":".pmx"},{"_id":10000069,"name":"Lyney","weaponType":"Bow","element":"Pyro","gender":"Male","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Lyney","image":"Genshin/Lyney.png","pmx":".pmx"},{"_id":10000064,"name":"Mika","weaponType":"Polearm","element":"Cryo","gender":"Male","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Mika","image":"Genshin/Mika.png","pmx":".pmx"},{"_id":10000019,"name":"Mona","weaponType":"Catalyst","element":"Hydro","gender":"Female","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Mona","image":"Genshin/Mona.png","pmx":".pmx"},{"_id":10000057,"name":"Nahida","weaponType":"Catalyst","element":"Dendro","gender":"Female","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Nahida","image":"Genshin/Nahida.png","pmx":".pmx"},{"_id":10000075,"name":"Navia","weaponType":"Claymore","element":"Geo","gender":"Female","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Navia","image":"Genshin/Navia.png","pmx":".bpmx"},{"_id":10000071,"name":"Neuvillette","weaponType":"Catalyst","element":"Hydro","gender":"Male","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Neuvillette","image":"Genshin/Neuvillette.png","pmx":".pmx"},{"_id":10000056,"name":"Nilou","weaponType":"Sword","element":"Hydro","gender":"Female","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Nilou","image":"Genshin/Nilou.png","pmx":".pmx"},{"_id":10000010,"name":"Ningguang","weaponType":"Catalyst","element":"Geo","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Ningguang","image":"Genshin/Ningguang.png","pmx":".pmx"},{"_id":10000011,"name":"Noelle","weaponType":"Claymore","element":"Geo","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Noelle","image":"Genshin/Noelle.png","pmx":".pmx"},{"_id":10000020,"name":"Qiqi","weaponType":"Sword","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Qiqi","image":"Genshin/Qiqi.png","pmx":".pmx"},{"_id":10000039,"name":"Raiden Shogun","weaponType":"Polearm","element":"Electro","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Raiden Shogun","image":"Genshin/Raiden Shogun.png","pmx":".pmx"},{"_id":10000012,"name":"Razor","weaponType":"Claymore","element":"Electro","gender":"Male","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Razor","image":"Genshin/Razor.png","pmx":".pmx"},{"_id":10000031,"name":"Rosaria","weaponType":"Polearm","element":"Cryo","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Rosaria","image":"Genshin/Rosaria.png","pmx":".pmx"},{"_id":10000040,"name":"Sangonomiya Kokomi","weaponType":"Catalyst","element":"Hydro","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Sangonomiya Kokomi","image":"Genshin/Sangonomiya Kokomi.png","pmx":".pmx"},{"_id":10000036,"name":"Sayu","weaponType":"Claymore","element":"Anemo","gender":"Female","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Sayu","image":"Genshin/Sayu.png","pmx":".pmx"},{"_id":10000045,"name":"Shenhe","weaponType":"Polearm","element":"Cryo","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Shenhe","image":"Genshin/Shenhe.png","pmx":".pmx"},{"_id":10000050,"name":"Shikanoin Heizou","weaponType":"Catalyst","element":"Anemo","gender":"Male","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Shikanoin Heizou","image":"Genshin/Shikanoin Heizou.png","pmx":".pmx"},{"_id":10000013,"name":"Sucrose","weaponType":"Catalyst","element":"Anemo","gender":"Female","region":"Mondstadt","rarity":4,"directory":"res/chars/Genshin/Sucrose","image":"Genshin/Sucrose.png","pmx":".pmx"},{"_id":10000024,"name":"Tartaglia","weaponType":"Bow","element":"Hydro","gender":"Male","region":"Fatui","rarity":5,"directory":"res/chars/Genshin/Tartaglia","image":"Genshin/Tartaglia.png","pmx":".pmx"},{"_id":10000041,"name":"Thoma","weaponType":"Polearm","element":"Pyro","gender":"Male","region":"Inazuma","rarity":4,"directory":"res/chars/Genshin/Thoma","image":"Genshin/Thoma.png","pmx":".pmx"},{"_id":10000052,"name":"Tighnari","weaponType":"Bow","element":"Dendro","gender":"Male","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Tighnari","image":"Genshin/Tighnari.png","pmx":".pmx"},{"_id":10000000,"name":"Aether","weaponType":"Sword","element":"Universal","gender":"Male","rarity":5,"directory":"res/chars/Genshin/Aether","image":"Genshin/Aether.png","pmx":".pmx"},{"_id":10000001,"name":"Lumine","weaponType":"Sword","element":"Universal","gender":"Female","rarity":5,"directory":"res/chars/Genshin/Lumine","image":"Genshin/Lumine.png","pmx":".pmx"},{"_id":10000021,"name":"Venti","weaponType":"Bow","element":"Anemo","gender":"Male","region":"Mondstadt","rarity":5,"directory":"res/chars/Genshin/Venti","image":"Genshin/Venti.png","pmx":".pmx"},{"_id":10000060,"name":"Wanderer","weaponType":"Catalyst","element":"Anemo","gender":"Male","region":"Sumeru","rarity":5,"directory":"res/chars/Genshin/Wanderer","image":"Genshin/Wanderer.png","pmx":".pmx"},{"_id":10000072,"name":"Wriothesley","weaponType":"Catalyst","element":"Cryo","gender":"Male","region":"Fontaine","rarity":5,"directory":"res/chars/Genshin/Wriothesley","image":"Genshin/Wriothesley.png","pmx":".pmx"},{"_id":10000014,"name":"Xiangling","weaponType":"Polearm","element":"Pyro","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Xiangling","image":"Genshin/Xiangling.png","pmx":".pmx"},{"_id":10000029,"name":"Xiao","weaponType":"Polearm","element":"Anemo","gender":"Male","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Xiao","image":"Genshin/Xiao.png","pmx":".pmx"},{"_id":10000015,"name":"Xingqiu","weaponType":"Sword","element":"Hydro","gender":"Male","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Xingqiu","image":"Genshin/Xingqiu.png","pmx":".pmx"},{"_id":10000025,"name":"Xinyan","weaponType":"Claymore","element":"Pyro","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Xinyan","image":"Genshin/Xinyan.png","pmx":".pmx"},{"_id":10000046,"name":"Yae Miko","weaponType":"Catalyst","element":"Electro","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Yae Miko","image":"Genshin/Yae Miko.png","pmx":".pmx"},{"_id":10000032,"name":"Yanfei","weaponType":"Catalyst","element":"Pyro","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Yanfei","image":"Genshin/Yanfei.png","pmx":".pmx"},{"_id":10000061,"name":"Yaoyao","weaponType":"Polearm","element":"Dendro","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Yaoyao","image":"Genshin/Yaoyao.png","pmx":".pmx"},{"_id":10000048,"name":"Yelan","weaponType":"Bow","element":"Hydro","gender":"Female","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Yelan","image":"Genshin/Yelan.png","pmx":".pmx"},{"_id":10000037,"name":"Yoimiya","weaponType":"Bow","element":"Pyro","gender":"Female","region":"Inazuma","rarity":5,"directory":"res/chars/Genshin/Yoimiya","image":"Genshin/Yoimiya.png","pmx":".pmx"},{"_id":10000044,"name":"Yun Jin","weaponType":"Polearm","element":"Geo","gender":"Female","region":"Liyue","rarity":4,"directory":"res/chars/Genshin/Yun Jin","image":"Genshin/Yun Jin.png","pmx":".pmx"},{"_id":10000026,"name":"Zhongli","weaponType":"Polearm","element":"Geo","gender":"Male","region":"Liyue","rarity":5,"directory":"res/chars/Genshin/Zhongli","image":"Genshin/Zhongli.png","pmx":".pmx"}]');class uf{async build(e,t){k_.OverrideEngineCreateEffect(t);const i=df;i.sort(((e,t)=>t._id-e._id));const s=(e,t)=>e.find((e=>e.name===t));function n(e,t){return e.filter((e=>t.every((t=>String(e[t.key]).includes(t.value)))))}function r(e,t,i=!0){return e.slice().sort(((e,s)=>{const n=String(e[t]),r=String(s[t]);return i?n.localeCompare(r):r.localeCompare(n)}))}const o=da.GetPluginForExtension(".bpmx");o.loggingEnabled=!0,o.materialBuilder.loadOutlineRenderingProperties=()=>{};const a=new Oi(t);a.clearColor=new Ie(1,1,1,1);const l=.09,h=new Bn("mmdRoot",a);h.scaling.scaleInPlace(l),h.position.z=1;const c=new Bn("mmdRoot",a);c.scaling.scaleInPlace(l),c.position.z=1;const d=new G_("mmdCamera",new me(0,10,0),a);d.maxZ=1e3,d.minZ=1,d.parent=h,d.layerMask=1;const u=new me(0,10,-20).scaleInPlace(l),_=new Er("arcRotateCamera",0,0,2.25,new me(0,10*l,1),a);_.maxZ=1e3,_.minZ=.1,_.setPosition(u),_.attachControl(e,!1),_.inertia=.8,_.speed=.36,_.zoomToMouseLocation=!0,_.wheelDeltaPercentage=.1,_.layerMask=1;const f=new Er("stillCamera",0,0,2.25,new me(0,10*l,1),a);f.maxZ=1e3,f.minZ=.1,f.setPosition(u),f.attachControl(e,!1),f.inertia=.8,f.speed=.36,f.zoomToMouseLocation=!0,f.wheelDeltaPercentage=.1,f.layerMask=1;const p=new Er("guiCamera",Math.PI/2+Math.PI/7,Math.PI/2,100,new me(0,20,0),a);p.layerMask=268435456;const m=new In("HemisphericLight",new me(0,1,0),a);m.intensity=.4,m.specular=new Re(0,0,0),m.groundColor=new Re(1,1,1);const g=new mc("DirectionalLight",new me(.5,-1,1),a);g.intensity=.8,g.autoCalcShadowZBounds=!1,g.autoUpdateExtends=!1,g.shadowMaxZ=20*l,g.shadowMinZ=-15*l,g.orthoTop=18*l,g.orthoBottom=-.27,g.orthoLeft=-10*l,g.orthoRight=10*l,g.shadowOrthoScale=0;const v=new ss(1024,g,!0);v.usePercentageCloserFiltering=!0,v.forceBackFacesOnly=!0,v.filteringQuality=ss.QUALITY_MEDIUM,v.frustumEdgeFalloff=.1;let T=new hf(new q_(a));T.loggingEnabled=!0,T.register(a);const b="res/cam_motion/Specialist (Never End ver.)/music001.mp3";let E=new V_(a);E.preservesPitch=!1,E.source=b,T.setAudioPlayer(E),T.playAnimation(),T.pauseAnimation();let S=new cf(a,T,E);S.showPlayerControl(),t.displayLoadingUI();let x=[];const C=(e,i)=>{x[e]=i,t.loadingUIText="<br/><br/><br/><br/>"+x.join("<br/><br/>")};let y=[];const A=new U_(a);A.loggingEnabled=!0,y.push(A.loadAsync("motion","res/cam_motion/Specialist (Never End ver.)/CameraMAIN2.bvmd",(e=>C(0,`Loading camera... ${e.loaded}/${e.total} (${Math.floor(100*e.loaded/e.total)}%)`)))),y.push(A.loadAsync("motion","res/cam_motion/Specialist (Never End ver.)/mmd_Specialist_motion.bvmd",(e=>C(1,`Loading motion... ${e.loaded}/${e.total} (${Math.floor(100*e.loaded/e.total)}%)`))));let R="Hu Tao",I=s(i,R);if(!(I&&I.directory&&I.pmx))throw new Error("Chosen character or its properties are undefined");y.push(da.ImportMeshAsync(void 0,I.directory+"/",I.pmx,a,(e=>C(2,`Loading model... ${e.loaded}/${e.total} (${Math.floor(100*e.loaded/e.total)}%)`)))),y.push((async()=>{C(2,"Loading physics engine...");const e=await P_(),t=new Bc(!0,e);a.enablePhysics(new me(0,-8.82,0),t),C(2,"Loading physics engine... Done")})());let P=await Promise.all(y);a.onAfterRenderObservable.addOnce((()=>t.hideLoadingUI())),a.activeCameras=[f,p];let M=1.66,O=69,D=new Te,N=P[2].meshes[0];N.parent=h,v.addShadowCaster(N),N.receiveShadows=!0;let F=T.createMmdModel(N);const L=P[1];F.addAnimation(L),F.setAnimation("motion");let w=N.skeleton.bones.find((e=>""===e.name));w.getFinalMatrix().multiplyToRef(N.getWorldMatrix(),D),D.getTranslationToRef(c.position),M-=c.position.y,O=c.position.y;let B=N.skeleton.bones.find((e=>""===e.name)),U=new Te;a.onBeforeRenderObservable.add((()=>{B.getFinalMatrix().multiplyToRef(N.getWorldMatrix(),U),U.getTranslationToRef(g.position),g.position.y-=10*l}));const k=Dr("ground1",{width:100,height:100,subdivisions:2,updatable:!1},a),V=k.material=new O_("shadowOnly",a);V.activeLight=g,V.alpha=.4,k.receiveShadows=!0,k.parent=h,d.addAnimation(P[0]),d.storeState(),T.setCamera(d),d.setAnimation("motion"),a.onAfterRenderObservable.addOnce((()=>{a.freezeMaterials();const e=a.meshes;for(let t=0,i=e.length;t<i;++t){const i=e[t];i.freezeWorldMatrix(),i.doNotSyncBoundingInfo=!0,i.isPickable=!1,i.doNotSyncBoundingInfo=!0,i.alwaysSelectAsActiveMesh=!0}a.skipPointerMovePicking=!0,a.skipPointerDownPicking=!0,a.skipPointerUpPicking=!0,a.skipFrustumClipping=!0,a.blockMaterialDirtyMechanism=!0,E.mute()}));const G=new _d("default",!0,a,[d,_,f]);G.samples=4,G.bloomEnabled=!0,G.bloomScale=10,G.chromaticAberrationEnabled=!0,G.chromaticAberration.aberrationAmount=1,G.fxaaEnabled=!0,G.imageProcessing.toneMappingEnabled=!1,G.imageProcessing.toneMappingType=Yt.TONEMAPPING_ACES,G.imageProcessing.vignetteWeight=.5,G.imageProcessing.vignetteStretch=.5,G.imageProcessing.vignetteColor=new Ie(0,0,0,0),G.imageProcessing.vignetteEnabled=!0,G.depthOfFieldEnabled=!1,G.depthOfFieldBlurLevel=jc.Medium,G.depthOfField.fStop=.05,G.depthOfField.focalLength=20;let z=69;new pc("","res/stages/hoyo.png",a,!0,new Ie(1,1,1,1)).render;const H=fu.CreateFullscreenUI("UI");H.layer.layerMask=268435456,H.idealWidth=1e3,H.idealHeight=1e3,H.useSmallestIdeal=!0;const W=new Vd;W.widthInPixels=100,W.heightInPixels=50,W.left=0,W.text=`${a.activeCameras[0].name}`,W.fontSize=16,W.textHorizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,W.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_RIGHT,W.verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP,W.color="black",H.addControl(W);const X=zd.CreateImageOnlyButton("but","https://cdn-icons-png.flaticon.com/512/10613/10613684.png");X.horizontalAlignment=wd.HORIZONTAL_ALIGNMENT_LEFT,X.left="10px",X.verticalAlignment=wd.VERTICAL_ALIGNMENT_TOP,X.top="10px",X.width="50px",X.height="50px",X.thickness=0,H.addControl(X),X.onPointerClickObservable.add((function(){Q.isVisible=!Q.isVisible}));const Q=new Ud;Q.width="720px",Q.height="920px",Q.background="rgb(44,48,50)",Q.cornerRadius=20,Q.thickness=3,Q.color="black",H.addControl(Q),Q.isVisible=!1;const Y=new Ud;Y.width="700px",Y.height="900px",Y.thickness=0,Y.cornerRadius=15,Y.background=Q.background,Q.addControl(Y);const K=new Hd;K.width="700px",K.height="900px",Y.addControl(K);const j=new Ud;j.width="700px",j.height="100px",j.thickness=0,K.addControl(j);const $=zd.CreateSimpleButton("but","Genshin Impact");$.width="233px",$.height="50px",$.color="white",$.background="rgb(64,68,70)",$.thickness=0,$.left=-233,$.top=-25,$.cornerRadiusX=$.cornerRadiusY=15,j.addControl($);const q=zd.CreateSimpleButton("but","Honkai: Star Rail");q.width="233px",q.height="50px",q.color="white",q.background=Q.background,q.thickness=0,q.left=0,q.top=-25,q.cornerRadiusX=q.cornerRadiusY=15,j.addControl(q);const Z=zd.CreateSimpleButton("but","Others");Z.width="233px",Z.height="50px",Z.color="white",Z.background=Q.background,Z.thickness=0,Z.left=233,Z.top=-25,Z.cornerRadiusX=Z.cornerRadiusY=15,j.addControl(Z);let J="Genshin",ee=!1,te="_id";const ie=[{key:"_id",value:"10000"}];let se=n(i,ie);$.onPointerClickObservable.add((function(){"Genshin"!=J&&($.background="rgb(64,68,70)",Ce(),"HSR"==J?q.background=Q.background:Z.background=Q.background,J="Genshin")})),q.onPointerClickObservable.add((function(){"HSR"!=J&&(q.background="rgb(64,68,70)","Genshin"==J?($.background=Q.background,Ce()):Z.background=Q.background,J="HSR")})),Z.onPointerClickObservable.add((function(){"Others"!=J&&(Z.background="rgb(64,68,70)","Genshin"==J?($.background=Q.background,Ce()):q.background=Q.background,J="Others")}));const ne=new Ud;ne.width="700px",ne.height="50px",ne.thickness=0,ne.top=25,ne.background="rgb(64,68,70)",j.addControl(ne);const re=zd.CreateImageOnlyButton("but","res/assets/descending.png");re.height="40px",re.width="40px",re.left=-328,re.thickness=0,ne.addControl(re),re.onPointerClickObservable.add((()=>{ee?(re.image.source="res/assets/descending.png",se=r(se,te,!1),Me(se)):(re.image.source="res/assets/ascending.png",se=r(se,te,!0),Me(se)),ee=!ee}));const oe=zd.CreateSimpleButton("but"," Release ");oe.height="40px",oe.width="90px",oe.left=-258,oe.background=Q.background,oe.color="white",oe.cornerRadius=15,oe.thickness=0,ne.addControl(oe),oe.onPointerClickObservable.add((()=>{null!=oe.textBlock&&("_id"==te?(te="name",oe.textBlock.text=" Name "):(te="_id",oe.textBlock.text=" Release "),se=r(se,te,ee),Me(se))}));const ae=zd.CreateImageOnlyButton("but","res/assets/Genshin/rarity_4.png");ae.height="40px",ae.width="40px",ae.left=-188,ae.thickness=0,ae.cornerRadius=5,ne.addControl(ae),ae.onPointerClickObservable.add((function(){const e=ie.findIndex((e=>"rarity"===e.key));if(-1!==e)"4"==ie[e].value?(ie.splice(e,1),ae.background="rgba(0,0,0,0)"):(ie[e].value="4",le.background="rgba(0,0,0,0)",ae.background=Q.background);else{const e={key:"rarity",value:"4"};ie.push(e),ae.background=Q.background}se=n(i,ie),se=r(se,te,ee),Me(se)}));const le=zd.CreateImageOnlyButton("but","res/assets/Genshin/rarity_5.png");function he(e,t,s){const o=ie.findIndex((e=>e.key===s));if(-1!==o)ie[o].value==t?(ie.splice(o,1),e.background="rgba(0,0,0,0)"):(ie[o].value=t,"element"==s.toString()?(ce.background="rgba(0,0,0,0)",de.background="rgba(0,0,0,0)",ue.background="rgba(0,0,0,0)",_e.background="rgba(0,0,0,0)",fe.background="rgba(0,0,0,0)",pe.background="rgba(0,0,0,0)",ge.background="rgba(0,0,0,0)"):(ve.background="rgba(0,0,0,0)",be.background="rgba(0,0,0,0)",Ee.background="rgba(0,0,0,0)",Se.background="rgba(0,0,0,0)",xe.background="rgba(0,0,0,0)"),e.background=Q.background);else{const i={key:s,value:t};ie.push(i),e.background=Q.background}se=n(i,ie),se=r(se,te,ee),Me(se)}le.height="40px",le.width="40px",le.left=-148,le.thickness=0,le.cornerRadius=5,ne.addControl(le),le.onPointerClickObservable.add((function(){const e=ie.findIndex((e=>"rarity"===e.key));if(-1!==e)"5"==ie[e].value?(ie.splice(e,1),le.background="rgba(0,0,0,0)"):(ie[e].value="5",ae.background="rgba(0,0,0,0)",le.background=Q.background);else{const e={key:"rarity",value:"5"};ie.push(e),le.background=Q.background}se=n(i,ie),se=r(se,te,ee),Me(se)}));const ce=zd.CreateImageOnlyButton("but","res/assets/Genshin/element_anemo.png");ce.height="40px",ce.width="40px",ce.left=-108,ce.thickness=0,ce.cornerRadius=5,ne.addControl(ce),ce.onPointerClickObservable.add((function(){he(ce,"Anemo","element")}));const de=zd.CreateImageOnlyButton("but","res/assets/Genshin/element_geo.png");de.height="40px",de.width="40px",de.left=-68,de.thickness=0,de.cornerRadius=5,ne.addControl(de),de.onPointerClickObservable.add((function(){he(de,"Geo","element")}));const ue=zd.CreateImageOnlyButton("but","res/assets/Genshin/element_electro.png");ue.height="40px",ue.width="40px",ue.left=-28,ue.thickness=0,ue.cornerRadius=5,ne.addControl(ue),ue.onPointerClickObservable.add((function(){he(ue,"Electro","element")}));const _e=zd.CreateImageOnlyButton("but","res/assets/Genshin/element_dendro.png");_e.height="40px",_e.width="40px",_e.left=12,_e.thickness=0,_e.cornerRadius=5,ne.addControl(_e),_e.onPointerClickObservable.add((function(){he(_e,"Dendro","element")}));const fe=zd.CreateImageOnlyButton("but","res/assets/Genshin/element_hydro.png");fe.height="40px",fe.width="40px",fe.left=52,fe.thickness=0,fe.cornerRadius=5,ne.addControl(fe),fe.onPointerClickObservable.add((function(){he(fe,"Hydro","element")}));const pe=zd.CreateImageOnlyButton("but","res/assets/Genshin/element_pyro.png");pe.height="40px",pe.width="40px",pe.left=92,pe.thickness=0,pe.cornerRadius=5,ne.addControl(pe),pe.onPointerClickObservable.add((function(){he(pe,"Pyro","element")}));const ge=zd.CreateImageOnlyButton("but","res/assets/Genshin/element_cryo.png");ge.height="40px",ge.width="40px",ge.left=132,ge.thickness=0,ge.cornerRadius=5,ne.addControl(ge),ge.onPointerClickObservable.add((function(){he(ge,"Cryo","element")}));const ve=zd.CreateImageOnlyButton("but","res/assets/Genshin/Sword.png");ve.height="40px",ve.width="40px",ve.left=172,ve.thickness=0,ve.cornerRadius=5,ne.addControl(ve),ve.onPointerClickObservable.add((function(){he(ve,"Sword","weaponType")}));const be=zd.CreateImageOnlyButton("but","res/assets/Genshin/Catalyst.png");be.height="40px",be.width="40px",be.left=212,be.thickness=0,be.cornerRadius=5,ne.addControl(be),be.onPointerClickObservable.add((function(){he(be,"Catalyst","weaponType")}));const Ee=zd.CreateImageOnlyButton("but","res/assets/Genshin/Bow.png");Ee.height="40px",Ee.width="40px",Ee.left=252,Ee.thickness=0,Ee.cornerRadius=5,ne.addControl(Ee),Ee.onPointerClickObservable.add((function(){he(Ee,"Bow","weaponType")}));const Se=zd.CreateImageOnlyButton("but","res/assets/Genshin/Claymore.png");Se.height="40px",Se.width="40px",Se.left=292,Se.thickness=0,Se.cornerRadius=5,ne.addControl(Se),Se.onPointerClickObservable.add((function(){he(Se,"Claymore","weaponType")}));const xe=zd.CreateImageOnlyButton("but","res/assets/Genshin/Pole.png");function Ce(){ae.isVisible=!ae.isVisible,le.isVisible=!le.isVisible,ce.isVisible=!ce.isVisible,de.isVisible=!de.isVisible,ue.isVisible=!ue.isVisible,_e.isVisible=!_e.isVisible,fe.isVisible=!fe.isVisible,pe.isVisible=!pe.isVisible,ge.isVisible=!ge.isVisible,ve.isVisible=!ve.isVisible,be.isVisible=!be.isVisible,Ee.isVisible=!Ee.isVisible,Se.isVisible=!Se.isVisible,xe.isVisible=!xe.isVisible}xe.height="40px",xe.width="40px",xe.left=332,xe.thickness=0,xe.cornerRadius=5,ne.addControl(xe),xe.onPointerClickObservable.add((function(){he(xe,"Polearm","weaponType")}));const ye=new lu("name");ye.thickness=0,K.addControl(ye);let Ae=new jd,Pe=10;function Me(e){Ae.dispose(),Ae=new jd,Pe=Math.ceil(e.length/5)+1,Ae.removeRowDefinition,Ae.color="black",Ae.width="680px",Ae.heightInPixels=Pe*Ae.widthInPixels/5,Ae.addColumnDefinition(.2),Ae.addColumnDefinition(.2),Ae.addColumnDefinition(.2),Ae.addColumnDefinition(.2),Ae.addColumnDefinition(.2);for(let e=0;e<Pe;e++)Ae.addRowDefinition(1/Pe);ye.addControl(Ae);let t=0;for(let i=0;i<Pe;i++)for(let s=0;s<5;s++)if(t>e.length-1){const e=zd.CreateImageOnlyButton("but","https://static.wikia.nocookie.net/gensin-impact/images/f/f8/Icon_Emoji_Paimon%27s_Paintings_02_Qiqi_1.png");e.thickness=0,Ae.addControl(e,i,s)}else{const n=e[t],r=new Ud;r.cornerRadius=10,r.thickness=0,r.paddingBottom=r.paddingTop=r.paddingRight=r.paddingLeft=4,r.background="rgb(123,92,144)",5==n.rarity&&(r.background="rgb(146,109,69)"),Ae.addControl(r,i,s);const o=zd.CreateImageOnlyButton("but",`res/charsPNG/${n.image}`);o.thickness=0,o.cornerRadius=10,o.paddingBottom=o.paddingTop=o.paddingRight=o.paddingLeft=4,Ae.addControl(o,i,s),o.onPointerClickObservable.add((async function(){Q.isVisible=!Q.isVisible,R!=n.name&&await Oe(n.name)})),t+=1}}async function Oe(e){if(e){if(T.pauseAnimation(),R=e,T.destroyMmdModel(F),N.dispose(!1,!0),S.dispose(),d.restoreState(),T.unregister(a),T=new hf(new q_(a)),T.loggingEnabled=!0,T.register(a),E=new V_(a),E.preservesPitch=!1,E.source=b,T.setAudioPlayer(E),T.playAnimation(),T.pauseAnimation(),S=new cf(a,T,E),S.showPlayerControl(),t.displayLoadingUI(),y=[],x=[],I=s(i,R),!(I&&I.directory&&I.pmx))throw new Error("Chosen character or its properties are undefined");y.push(da.ImportMeshAsync(void 0,I.directory+"/",I.pmx,a,(e=>C(0,`Loading model... ${e.loaded}/${e.total} (${Math.floor(100*e.loaded/e.total)}%)`)))),P=await Promise.all(y),a.onAfterRenderObservable.addOnce((()=>t.hideLoadingUI())),a.activeCameras=[f,p],M=1.66,O=69,D=new Te,N=P[0].meshes[0],N.parent=h,v.addShadowCaster(N),N.receiveShadows=!0,F=T.createMmdModel(N),F.addAnimation(L),F.setAnimation("motion"),w=N.skeleton.bones.find((e=>""===e.name)),w.getFinalMatrix().multiplyToRef(N.getWorldMatrix(),D),D.getTranslationToRef(c.position),M-=c.position.y,O=c.position.y,B=N.skeleton.bones.find((e=>""===e.name)),U=new Te,a.onBeforeRenderObservable.add((()=>{B.getFinalMatrix().multiplyToRef(N.getWorldMatrix(),U),U.getTranslationToRef(g.position),g.position.y-=10*l})),T.setCamera(d),d.setAnimation("motion"),a.onAfterRenderObservable.addOnce((()=>{a.freezeMaterials();const e=a.meshes;for(let t=0,i=e.length;t<i;++t){const i=e[t];i.freezeWorldMatrix(),i.doNotSyncBoundingInfo=!0,i.isPickable=!1,i.doNotSyncBoundingInfo=!0,i.alwaysSelectAsActiveMesh=!0}a.skipPointerMovePicking=!0,a.skipPointerDownPicking=!0,a.skipPointerUpPicking=!0,a.skipFrustumClipping=!0,a.blockMaterialDirtyMechanism=!0,E.mute()}))}}Me(se),c.position.x=h.position.x,c.position.z=h.position.z,a.onBeforeAnimationsObservable.add((()=>{z=d.position.y/10,W.text=`${a.activeCameras[0].name}`,c.position.y=z<O&&0<z?0-M*(z/O):z<=0?0:0-M,d.parent=c}));const De=new Te,Ne=new me,Fe=new me,Le=new me;a.onBeforeRenderObservable.add((()=>{const e=d.rotation;Te.RotationYawPitchRollToRef(-e.y,-e.x,-e.z,De),me.TransformNormalFromFloatsToRef(0,0,1,De,Ne),d.position.addToRef(me.TransformCoordinatesFromFloatsToRef(0,0,d.distance,De,Fe),Fe),w.getFinalMatrix().getTranslationToRef(Le).subtractToRef(Fe,Le),G.depthOfField.focusDistance=me.Dot(Le,Ne)/me.Dot(Ne,Ne)*1e3}));let we=-1/0;return e.onclick=()=>{const e=performance.now();300<e-we?we=e:(we=-1/0,a.activeCameras[0]===d?(G.depthOfFieldEnabled=!1,_.setTarget(new me(0,10*l,1)),_.setPosition(u),a.activeCameras[0]=_):(G.depthOfFieldEnabled=!1,a.activeCameras[0]=d),W.text=`${a.activeCameras[0].name}`)},document.body.addEventListener("keydown",(function(e){"Space"===e.code&&(e.preventDefault(),a.activeCameras[0]===f&&(G.depthOfFieldEnabled=!1,a.activeCameras[0]=d,W.text=`${a.activeCameras[0].name}`),T.isAnimationPlaying?T.pauseAnimation():T.playAnimation())})),await a.createDefaultXRExperienceAsync({uiOptions:{sessionMode:"immersive-ar",referenceSpaceType:"local-floor"}}),a}}window.onload=()=>{const e=document.createElement("canvas");e.style.width="100%",e.style.height="100%",e.style.display="block",document.body.appendChild(e);const t=new te(e,!1,{preserveDrawingBuffer:!1,stencil:!1,antialias:!1,alpha:!1,premultipliedAlpha:!1,powerPreference:"high-performance",doNotHandleTouchAction:!0,doNotHandleContextLost:!0,audioEngine:!1},!0);ie.Create({canvas:e,engine:t,sceneBuilder:new uf}).then((e=>e.run()))}})()})();